<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗣️ 🛵 🤱🏿 Configurer Debian, Nginx et Gunicorn pour un projet Django 🌟 👩🏿‍🌾 ⏹️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonne journée à tous. 
 
 Il y avait une tâche pour élever le serveur Debian sur Nginx pour les projets Django 3.x. Casser un tas d'informations sur I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Configurer Debian, Nginx et Gunicorn pour un projet Django</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501414/"><img src="https://habrastorage.org/webt/z9/fb/jx/z9fbjxytkq-jcp5yonlmrsdmxiy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bonne journée à tous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y avait une tâche pour élever le serveur Debian sur Nginx pour les projets Django 3.x. </font><font style="vertical-align: inherit;">Casser un tas d'informations sur Internet, j'ai réussi à le faire en combinant les recommandations de plusieurs sites différents. </font><font style="vertical-align: inherit;">Si vous êtes intéressé à lire comment configurer votre premier serveur pour un projet Django, alors bienvenue.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais vous parler un peu de vous pour que vous compreniez qui je suis. </font><font style="vertical-align: inherit;">Je ne suis ni développeur, ni programmeur, ni administrateur système, ni même diplômé en informatique. </font><font style="vertical-align: inherit;">Je suis professeur d'informatique. </font><font style="vertical-align: inherit;">Mais au travail, je dois expliquer aux étudiants certains points qui sont très éloignés du cursus scolaire en informatique, dont l'un est le développement de projets sur Django.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paramètres de base</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, nous avons déjà un serveur avec Debian 10 installé, il ne devrait pas y avoir de problème pour installer Debian. </font><font style="vertical-align: inherit;">J'ai eu une installation propre, sans paramètres supplémentaires, alors je suis allé sur mon serveur via </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">root</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font><font style="vertical-align: inherit;">j'ai </font><font style="vertical-align: inherit;">commencé à installer certains des principaux composants pour moi.</font></font><br>
<br>
<pre><code class="bash hljs">apt-get update<font></font>
apt-get install -y sudo htop git curl wget unzip zip gcc build-essential make<font></font>
apt-get install -y tree redis-server nginx  libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev llvm libncurses5-dev libncursesw5-dev xz-utils tk-dev libffi-dev liblzma-dev python3-dev python-pil ython3-pil <font></font>
apt-get install -y python3-lxml libxslt-dev python-libxml2 python-libxslt1 python-dev gnumeric libpq-dev libxml2-dev libxslt1-dev libjpeg-dev libfreetype6-dev libcurl4-openssl-dev supervisor libgdbm-dev libnss3-dev ufw<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez mettre tout cela dans une seule installation, mais j'ai eu une erreur, et dans cet ordre, tout s'est bien passé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, créez un nouvel utilisateur et ajoutez-le au groupe </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sudo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> afin qu'il puisse démarrer des processus au nom du superutilisateur.</font></font><br>
<br>
<pre><code class="bash hljs">adduser username <font></font>
usermod -aG sudo username<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
où </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nom d'utilisateur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le </font><b><font style="vertical-align: inherit;">nom d'utilisateur</font></b><font style="vertical-align: inherit;"> que vous utiliserez à l'avenir. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez la dernière version de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python à</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> partir des sources. </font><font style="vertical-align: inherit;">Au moment de la rédaction de ce rapport, c'était </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.8.2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /home/username<font></font>
curl -O https://www.python.org/ftp/python/3.8.2/Python-3.8.2.tar.xz<font></font>
tar -xf Python-3.8.2.tar.xz<font></font>
<span class="hljs-built_in">cd</span> Python-3.8.2
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Explication des actions</font></font></b>
                        <div class="spoiler_text">cd —      ,   <b>change directory</b>;<br>
curl —       URL.      ;<br>
tar —   .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir téléchargé la dernière version de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et être passé dans le répertoire source, nous exécutons:</font></font><br>
<br>
<pre><code class="bash hljs">./configure --<span class="hljs-built_in">enable</span>-optimizations<font></font>
make -j 2<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela nous permettra de préparer tout le nécessaire pour installer Python. </font><font style="vertical-align: inherit;">Ici, le nombre 2, c'est le nombre de cœurs de processeur. </font><font style="vertical-align: inherit;">Vous pouvez le découvrir avec la commande </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nproc</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous commençons l'installation.</font></font><br>
<pre><code class="bash hljs">make altinstall
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez vérifier que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> installé en utilisant la commande:</font></font><br>
<br>
<pre><code class="bash hljs">python3.8 -V
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il produira une version de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après cela, nous mettons à jour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pip</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et installons les packages les plus couramment utilisés pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<pre><code class="bash hljs">python3.8 -m pip install -U pip<font></font>
python3.8 -m pip install -U setuptools<font></font>
python3.8 -m pip install pillow<font></font>
python3.8 -m pip install virtualenv<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de Django</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous redémarrons le système et passons sous l'utilisateur que vous avez créé. </font><font style="vertical-align: inherit;">Allons dans le </font><font style="vertical-align: inherit;">répertoire </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ var / www</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et téléchargeons notre projet, qui est téléchargé sur </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /var/www<font></font>
sudo git <span class="hljs-built_in">clone</span> LINK_TO_PROJECT
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configurez les droits pour un fonctionnement normal avec le répertoire </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ var / www</font></font></b><br>
<pre><code class="bash hljs">sudo chown -R www-data:www-data /var/www<font></font>
sudo usermod -aG www-data username<font></font>
sudo chmod go-rwx /var/www<font></font>
sudo chmod go+x /var/www<font></font>
sudo chgrp -R www-data /var/www<font></font>
sudo chmod -R go-rwx /var/www<font></font>
sudo chmod -R g+rwx /var/www<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il peut sembler que nous effectuons certaines actions, puis les annulons, mais le fait est que nous supprimons d'abord toutes les autorisations pour tout le monde, puis les attribuons à un utilisateur ou un groupe spécifique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons à notre projet, créons un environnement virtuel et l'exécutons:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> djangoprojectname/<font></font>
virtualenv env<font></font>
<span class="hljs-built_in">source</span> ./env/bin/activate
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tout est activé, il y aura une ligne du formulaire: (env) username @ server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous livrerons / mettrons à jour les principaux packages dont nous avons besoin pour notre projet.</font></font><br>
<br>
<pre><code class="bash hljs">pip install -U pip<font></font>
pip install -U setuptools<font></font>
pip install -U pillow<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons mis Django, Gunicorn et un adaptateur pour PostgreSQL. </font></font><br>
<br>
<pre><code class="bash hljs">pip install django gunicorn psycopg2-binary
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez également mettre les packages nécessaires à votre projet, j'utilise summernote pour le texte:</font></font><br>
<br>
<pre><code class="bash hljs">pip install django-summernote</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons mis en place un pare-feu, nous devons donc créer une exception pour celui-ci sur le port 8000 (nous l'utilisons par défaut, si nous prévoyons d'en utiliser un autre, alors spécifiez-le):</font></font><br>
<br>
<pre><code class="bash hljs">sudo ufw allow 8000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'étape requise consiste à vérifier l'intégrité du serveur:</font></font><br>
<br>
<pre><code class="bash hljs">python3.8 manage.py runserver 0.0.0.0:8000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et accédez à votre site Web, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DOMAIN_NAME: 8000</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pour vous assurer que tout fonctionne! </font><font style="vertical-align: inherit;">Mais, pour le moment, nous n'avons pas encore beaucoup configuré, ce ne sont que des paramètres de base, nous devons configurer le fonctionnement normal du serveur, connecter la statique, etc. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si votre site ne démarre pas, alors vous devez vous plonger dans les paramètres (éventuellement les droits d'accès) et voir quel package n'a pas été installé, tout est très individuel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez terminer l'exécution en appuyant sur les touches: </font><font style="vertical-align: inherit;">
Vérifiez le fonctionnement de Gunicorn:</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> les touches CTRL + C du</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous ne continuons que si votre projet a commencé, je vous recommande fortement de ne pas poursuivre si quelque chose ne fonctionne pas. </font><font style="vertical-align: inherit;">Il vaut mieux résoudre le problème au stade initial que de démolir le serveur à la racine (j'ai démoli 3 fois, puis j'ai commencé à écrire cette instruction, en corrigeant chaque action).</font></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="bash hljs">gunicorn --<span class="hljs-built_in">bind</span> 0.0.0.0:8000 MAINAPPNAME.wsgi</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MAINAPPNAME</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le nom de l'application principale qui contient </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">settings.py</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si le serveur fonctionne, continuez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez terminer l'exécution en appuyant sur les touches: C</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TRL + le C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Définition de settings.py</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors du déploiement sur un serveur de production, vous devez désactiver le débogage du projet et modifier plusieurs paramètres, je l'ai fait comme suit dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">settings.py de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mon projet.</font></font><br>
<br>
<pre><code class="python hljs">DEBUG = <span class="hljs-literal">False</span>
<span class="hljs-keyword">if</span> DEBUG:<font></font>
    ALLOWED_HOSTS = [<span class="hljs-string">'*'</span>]
<span class="hljs-keyword">else</span>:<font></font>
    ALLOWED_HOSTS = [<span class="hljs-string">'HOST IP'</span>, <span class="hljs-string">'DOMAIN NAIM'</span>, <span class="hljs-string">'localhost'</span>]<font></font>
...<font></font>
STATIC_URL = <span class="hljs-string">'/static/'</span>
<span class="hljs-keyword">if</span> DEBUG:<font></font>
    STATIC_DIR = os.path.join(BASE_DIR, <span class="hljs-string">'static'</span>)<font></font>
    STATICFILES_DIRS = [<font></font>
        STATIC_DIR,<font></font>
        <span class="hljs-string">'/var/www/static/'</span>,<font></font>
    ]<font></font>
<span class="hljs-keyword">else</span>:<font></font>
    STATIC_ROOT = os.path.join(BASE_DIR, <span class="hljs-string">'static/'</span>)<font></font>
    STATICFILES_FINDERS = (<font></font>
        <span class="hljs-string">'django.contrib.staticfiles.finders.FileSystemFinder'</span>,
        <span class="hljs-string">'django.contrib.staticfiles.finders.AppDirectoriesFinder'</span>,<font></font>
    )<font></font>
MEDIA_URL = <span class="hljs-string">'/media/'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">urls.py,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j'ai changé les paramètres pour la statique et les médias.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">if</span> settings.DEBUG:<font></font>
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)<font></font>
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je ne sais pas dans quelle mesure c'est la bonne décision, et il y a peut-être des changements plus corrects à ces fichiers. </font><font style="vertical-align: inherit;">Mais dans ce cas, il me suffit de changer la valeur de DEBUG pour basculer entre développement et publication. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exécutez la commande:</font></font><br>
<br>
<pre><code class="bash hljs">python3.8 manage.py collectstatic
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour collecter des statiques et désactiver l'environnement virtuel:</font></font><br>
<br>
<pre><code class="bash hljs">deactivate</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurer Gunicorn</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ouvrons pour la personnalisation </font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /etc/systemd/system/gunicorn.socket</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Écrivons quelques paramètres dans le fichier:</font></font><br>
<br>
<pre><code class="nginx hljs">[Unit]<font></font>
Description=<span class="hljs-attribute">gunicorn</span> socket<font></font>
<font></font>
[Socket]<font></font>
ListenStream=/run/gunicorn.sock<font></font>
<font></font>
[Install]<font></font>
WantedBy=sockets.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons créé la section [Unit] pour décrire le socket, dans la section [Socket] nous avons déterminé l'emplacement du socket et dans la section [Install] nous devons installer le socket au bon moment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ouvrez le fichier utilitaire systemd pour configurer le service:</font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /etc/systemd/system/gunicorn.service</code></pre><br>
<pre><code class="nginx hljs">[Unit]<font></font>
Description=<span class="hljs-attribute">gunicorn</span> daemon<font></font>
Requires=gunicorn.socket<font></font>
After=network.target<font></font>
<font></font>
[Service]<font></font>
User=username<font></font>
Group=www-data<font></font>
WorkingDirectory=/var/www/djangoprojectname<font></font>
ExecStart=/var/www/djangoprojectname/env/bin/gunicorn \<font></font>
          --access-logfile - \<font></font>
          --workers <span class="hljs-number">5</span> \<font></font>
          --bind unix:/run/gunicorn.sock \<font></font>
          myproject.wsgi:application<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N'oubliez pas d'indiquer votre utilisateur, le nom de votre projet et votre environnement virtuel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme on m'a expliqué, les travailleurs sont calculés comme le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nombre de cœurs de processeur * 2 + 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous lançons et activons la prise Gunicorn.</font></font><br>
<br>
<pre><code class="bash hljs">sudo systemctl start gunicorn.socket<font></font>
sudo systemctl <span class="hljs-built_in">enable</span> gunicorn.socket</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et assurez-vous de tester que tout fonctionne!</font></font><br>
<br>
<pre><code class="bash hljs">sudo systemctl status gunicorn.socket</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Doit afficher des informations sur le service en cours d'exécution. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Appuyez sur la touche </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour quitter (requis dans la disposition en anglais).</font></font><br>
<br>
<pre><code class="bash hljs">file /run/gunicorn.sock</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La dernière commande devrait afficher un message sur le fichier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la première commande </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sudo systemctl status gunicorn.socket échoue</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou si la deuxième </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">commande filer //ungunicorn.sock</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> signale que le fichier gunicorn.sock ne se trouve pas dans le répertoire, le socket Gunicorn n'a pas pu être créé. </font><font style="vertical-align: inherit;">Vous devez vérifier les journaux de socket Gunicorn avec la commande suivante:</font></font><br>
<br>
<pre><code class="bash hljs">sudo journalctl -u gunicorn.socket</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyez quelle est l'erreur et corrigez-la. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons au test d'activation de socket.</font></font><br>
<br>
<pre><code class="bash hljs">sudo systemctl status gunicorn</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous aurez probablement un dossier:</font></font><br>
<br>
<pre><code class="bash hljs">Active: inactive (dead)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jusqu'à présent, tout se passe bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Établissez une connexion à la prise via curl.</font></font><br>
<br>
<pre><code class="bash hljs">curl --unix-socket /run/gunicorn.sock localhost</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut générer une erreur de requête incorrecte (400). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayez au lieu de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">localhost</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de spécifier l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP de votre serveur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , si tout va bien, cela est probablement dû aux paramètres nginx que nous n'avons pas encore effectués. </font><font style="vertical-align: inherit;">Continuez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et encore une fois, demandez la sortie d'état:</font></font><br>
<br>
<pre><code class="bash hljs">sudo systemctl status gunicorn</code></pre><br>
<pre><code class="bash hljs">Active: active (running)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si l'enregistrement est le suivant, il y a encore beaucoup d'informations, mais pas sur les erreurs, alors tout va bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sinon, nous regardons les erreurs dans le journal</font></font><br>
<br>
<pre><code class="bash hljs">sudo journalctl -u gunicorn</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et redémarrez les processus gunicorn</font></font><br>
<br>
<pre><code class="bash hljs">sudo systemctl daemon-reload<font></font>
sudo systemctl restart gunicorn</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de NGINX</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons créer un nouveau bloc serveur pour notre site et le configurer afin que lors de l'accès à notre site dans la barre d'adresse, le serveur comprenne quoi et où l'obtenir.</font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /etc/nginx/sites-available/djangoprojectname</code></pre><br>
<pre><code class="nginx hljs"><span class="hljs-section">server</span> {
    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span> server_domain_or_IP;<font></font>
<font></font>
    <span class="hljs-attribute">location</span> = /favicon.ico { <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>; <span class="hljs-attribute">log_not_found</span> <span class="hljs-literal">off</span>; }
    <span class="hljs-attribute">location</span> /static/ {
        <span class="hljs-attribute">alias</span> /var/www/djangoprojectname/static/;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-attribute">location</span> /media/ {
        <span class="hljs-attribute">alias</span> /var/www/djangoprojectname/media/;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-attribute">location</span> / {
        <span class="hljs-attribute">include</span> proxy_params;
        <span class="hljs-attribute">proxy_pass</span> http://unix:/run/gunicorn.sock;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la section sever_name, vous pouvez spécifier plusieurs adresses séparées par des espaces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Testez les erreurs de syntaxe:</font></font><br>
<br>
<pre><code class="bash hljs">sudo nginx -t</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'il n'y a pas d'erreur, redémarrez le serveur et donnez à notre pare-feu les droits nécessaires:</font></font><br>
<br>
<pre><code class="bash hljs">sudo systemctl restart nginx<font></font>
sudo ufw allow <span class="hljs-string">'Nginx Full'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez également supprimer l'accès au port 8000</font></font><br>
<br>
<pre><code class="bash hljs">sudo ufw delete allow 8000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À ce stade, tout devrait fonctionner, mais cela n'a pas fonctionné correctement jusqu'à ce que je configure https. </font><font style="vertical-align: inherit;">Malheureusement, je ne peux pas expliquer à quoi cela est lié, mais la statique n'a pas été chargée, bien que les fichiers multimédias aient été chargés normalement.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration HTTPS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utiliserons </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cerbot pour configurer</font></font></a><br>
<br>
<pre><code class="bash hljs">sudo apt-get install certbot python-certbot-nginx<font></font>
sudo certbot –nginx<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et suivez les invites à l'écran. </font><font style="vertical-align: inherit;">S'il y a des erreurs, éliminez-les et réessayez. </font><font style="vertical-align: inherit;">Par exemple, une erreur peut se produire si vous spécifiez un nom de domaine qui n'est pas lié à ce serveur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour renouveler automatiquement le certificat, entrez la commande.</font></font><br>
<br>
<pre><code class="bash hljs">sudo certbot renew --dry-run </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous testons maintenant le site et tout devrait fonctionner! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si les statistiques n'apparaissent toujours pas, essayez d'ouvrir un fichier css indiquant l'adresse complète avant, si vous obtenez une erreur 403, tout va bien, mais le problème des droits d'accès doit être expérimenté, essayez de réinitialiser tous les paramètres de droits pour </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www-data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à répertoire </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ var / www</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si l'erreur est 404, vous devez regarder vers les paramètres d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">emplacement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans les paramètres </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NGINX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de PostgreSQL</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configurez PostgreSQL et importez des données depuis SQLite. </font><font style="vertical-align: inherit;">Si vous n'en avez pas besoin, ignorez cette étape ou prenez uniquement les paramètres PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez une base de données et un utilisateur.</font></font><br>
<br>
<pre><code class="bash hljs">sudo -u postgres psql</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> dbforproject;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> projectdbuser <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">PASSWORD</span> <span class="hljs-string">'password'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous suivrons les recommandations du projet Django. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons défini le codage par défaut sur UTF-8, défini le schéma d'isolement des transactions par défaut sur «lecture validée», pour bloquer la lecture des transactions non confirmées. </font><font style="vertical-align: inherit;">Réglez le fuseau horaire sur GMT (UTC).</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">ROLE</span> projectdbuser <span class="hljs-keyword">SET</span> client_encoding <span class="hljs-keyword">TO</span> <span class="hljs-string">'utf8'</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">ROLE</span> projectdbuser <span class="hljs-keyword">SET</span> default_transaction_isolation <span class="hljs-keyword">TO</span> <span class="hljs-string">'read committed'</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">ROLE</span> projectdbuser <span class="hljs-keyword">SET</span> timezone <span class="hljs-keyword">TO</span> <span class="hljs-string">'UTC'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après cela, vous devez fournir à l'utilisateur que nous avons créé un accès pour administrer la nouvelle base de données:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DATABASE</span> dbforproject <span class="hljs-keyword">TO</span> projectdbuser;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois toutes les commandes terminées, vous pouvez fermer la boîte de dialogue PostgreSQL à l'aide de la commande:</font></font><br>
<br>
<pre><code class="pgsql hljs">\q</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant que la configuration PostgreSQL est terminée, nous allons maintenant configurer Django pour qu'il fonctionne correctement avec PostreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, copiez les anciennes données de SQLite (si nécessaire). </font><font style="vertical-align: inherit;">Pour ce faire, accédez à votre projet et lancez l'environnement virtuel:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /var/www/djangoprojectname
<span class="hljs-built_in">source</span> ./env/bin/activate
<span class="hljs-built_in">cd</span> mainappname/<font></font>
python3.8 manage.py dumpdata &gt; datadump.json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez les paramètres de connexion à la base de données:</font></font><br>
<br>
<pre><code class="python hljs">DATABASES = {
    <span class="hljs-string">'default'</span>: {
        <span class="hljs-string">'ENGINE'</span>: <span class="hljs-string">'django.db.backends.postgresql_psycopg2'</span>,
        <span class="hljs-string">'NAME'</span>: <span class="hljs-string">'dbforproject'</span>,
        <span class="hljs-string">'USER'</span>: <span class="hljs-string">'projectdbuser'</span>,
        <span class="hljs-string">'PASSWORD'</span>: <span class="hljs-string">'password'</span>,
        <span class="hljs-string">'HOST'</span>: <span class="hljs-string">'localhost'</span>,
        <span class="hljs-string">'PORT'</span>: <span class="hljs-string">''</span>,<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exécutez la migration pour la base de données:</font></font><br>
<br>
<pre><code class="bash hljs">python3.8 manage.py migrate --run-syncdb</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après cet obus:</font></font><br>
<br>
<pre><code class="bash hljs">python3 manage.py shell</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et écrivez-y:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> django.contrib.contenttypes.models <span class="hljs-keyword">import</span> ContentType
<span class="hljs-meta">&gt;&gt;&gt; </span>ContentType.objects.all().delete()
<span class="hljs-meta">&gt;&gt;&gt; </span>quit()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et chargez les données précédemment téléchargées depuis SQLite:</font></font><br>
<br>
<pre><code class="bash hljs">python3.8 manage.py loaddata datadump.json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est tout, tout a commencé et fonctionne pour moi, mais en cas d'erreurs, c'est très individuel, donc je recommande de ne pas ignorer les étapes du test de performance afin que vous puissiez comprendre à quel stade l'erreur s'est produite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'écriture, j'ai utilisé:</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.digitalocean.com/community/tutorials/how-to-set-up-django-with-postgres-nginx-and-gunicorn-on-ubuntu-18-04-ru</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vexxhost.com/resources/tutorials/how-to-deploy-django-on-nginx-gunicorn-with-postgres</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pythonworld.ru/web/django-ubuntu1604.html</font></font></a></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr501398/index.html">Hacking Sonic the Hedgehog classique pour Sega</a></li>
<li><a href="../fr501404/index.html">Apple TimeCapsule / AirPort Extreme. Accès root et évasion d'une région attachée</a></li>
<li><a href="../fr501406/index.html">LabVIEW NXG 5.0 - Bases et schéma fonctionnel</a></li>
<li><a href="../fr501408/index.html">L'équipe de développement propose de passer à l'UTF-8</a></li>
<li><a href="../fr501412/index.html">Eye-tracking mobile sur PyTorch</a></li>
<li><a href="../fr501416/index.html">Un peu sur WebRTC: quoi utiliser et le cas de la pratique</a></li>
<li><a href="../fr501418/index.html">Semaine 4 Marathon: Motivation</a></li>
<li><a href="../fr501420/index.html">Mitapas et émissions en ligne sur YouTube: semaine de diffusion du groupe JUG Ru</a></li>
<li><a href="../fr501424/index.html">De la vie avec Kubernetes: comment nous avons supprimé le SGBD (et pas seulement) des environnements de révision aux statiques</a></li>
<li><a href="../fr501426/index.html">Unison: configuration et automatisation de la synchronisation bidirectionnelle des répertoires sur deux serveurs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>