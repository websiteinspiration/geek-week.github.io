<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📞 🤸🏻 ⏬ C ++とVulkanで1週間でMinecraftを作成 🏦 🚪 🐒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="C ++とVulkanで自分のエンジンを使用して、1週間でMinecraftをゼロから再作成するタスクを設定しました。私は、C ++とOpenGLで同じことをしたHopsonに触発されました。次に、彼はMinecraftに触発されたShane Beckに触発され、そのインスピレーションの源はInfi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C ++とVulkanで1週間でMinecraftを作成</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487832/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++とVulkanで自分のエンジンを使用して、1週間でMinecraftをゼロから再作成するタスクを設定しました。</font><font style="vertical-align: inherit;">私は</font><font style="vertical-align: inherit;">、C ++とOpenGLで同じことをした</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hopson</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に触発されました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次に、彼は</font><font style="vertical-align: inherit;">Minecraftに触発</font><font style="vertical-align: inherit;">された</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shane Beck</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に触発され、そのインスピレーションの源はInfiniminerでした。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aa1/8b2/50c/aa18b250ce4120bd3a0dc94c01a63621.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロジェクトのGitHubリポジトリは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちら</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">毎日、独自のgitタグがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、Minecraftを文字通り再現するつもりはありませんでした。</font><font style="vertical-align: inherit;">このプロジェクトは教育的なものであるはずでした。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vulkan-tutorial.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">やSasha Willemのデモ</font><font style="vertical-align: inherit;">よりも複雑なものでVulkanを使用する方法について知りたいと思っていました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">したがって、主な重点はVulkanエンジンの設計であり、ゲームの設計ではありません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vulkanでの開発はOpenGLでの開発よりもはるかに遅いため、このMinecraftの機能の多くをゲームに組み込むことができませんでした。</font><font style="vertical-align: inherit;">モブ、クラフト、赤い石、ブロック物理などはありません。</font><font style="vertical-align: inherit;">当初から、プロジェクトの目的は次のとおりでした。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地形レンダリングシステムの作成</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マッシング</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">点灯</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地形ジェネレーターシステムの作成</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安心</font></font></li>
</ul><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">木</font></font></li>
</ul><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイオーム</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地形を変更してブロックを移動する機能を追加する</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームにGUIを追加せずに、これらすべてを実装する方法を見つける必要がありました。これは、Vulkanで動作し、統合が簡単なGUIライブラリが見つからなかったためです。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図書館</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、最初からVulkanアプリケーションを作成するつもりはありませんでした。</font><font style="vertical-align: inherit;">開発プロセスをスピードアップするために、可能な限り既製のライブラリを使用します。</font><font style="vertical-align: inherit;">つまり：</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VulkanWrapper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Vulkan APIの独自のC ++ラッパー</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLFW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Windowsおよびユーザー入力用</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VulkanMemoryAllocator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Vulkanメモリを割り当てるため</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLM-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数学ベクトルおよび行列用</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entt-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">信号/スロットおよびECSの場合</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stb-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像読み込みユーティリティ用</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FastNoise</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -3Dノイズを生成するため</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1日目</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初日は、バルカン定型文とエンジン骨格を用意しました。</font><font style="vertical-align: inherit;">ほとんどのコードは定型文であり、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vulkan-tutorial.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からコピーするだけで</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">済み</font></a><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">また、頂点シェーダーの一部として頂点データを保存するトリックも含まれていました。</font><font style="vertical-align: inherit;">つまり、メモリ割り当てを調整する必要さえありませんでした。</font><font style="vertical-align: inherit;">三角形を描くという1つのことしかできない単純なコンベヤです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エンジンは、三角形のレンダラーをサポートするのに十分単純です。</font><font style="vertical-align: inherit;">1つのウィンドウと、システムを接続できるゲームループがあります。</font><font style="vertical-align: inherit;">GUIは、ウィンドウタイトルに表示されるフレームレートによって制限されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトは</font></font><code>VoxelEngine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、およびの</font><font style="vertical-align: inherit;">2つの部分に分かれてい</font></font><code>VoxelGame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/875/3cd/190/8753cd190975239ad550e8c0c8b27d00.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2日目</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vulkan Memory Allocatorライブラリを統合しました。</font><font style="vertical-align: inherit;">このライブラリは、Vulkanメモリ割り当てボイラープレートのほとんどを処理します：メモリタイプ、デバイスメモリヒープ、およびセカンダリ割り当て。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリを割り当てたので、メッシュと頂点バッファーのクラスを作成しました。</font><font style="vertical-align: inherit;">三角形のレンダラーを変更して、シェーダーに組み込まれた配列ではなくメッシュのクラスを使用するようにしました。</font><font style="vertical-align: inherit;">現在、メッシュデータは、三角形を手動でレンダリングすることによってGPUに転送されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/627/28d/0fc/62728d0fce9015f2be4dad88f18c7b7a.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少し変わった</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3日目</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
グラフ描画システムを追加しました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この投稿は</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">このクラスを作成するための基礎として使用</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">さ</font></a><font style="vertical-align: inherit;">れました</font><font style="vertical-align: inherit;">が、クラスは非常に単純化されています。私のレンダリンググラフには、Vulkanとの同期を処理するための必須要素のみが含まれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レンダリンググラフでは、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノード</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><em><font style="vertical-align: inherit;">エッジ</font></em><font style="vertical-align: inherit;">を設定でき</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ノードは、GPUによって実行される作業です。リブはノード間のデータ依存関係です。各ノードは独自の命令バッファーを受け取り、そこに書き込みます。グラフは、コマンドバッファのダブルバッファリングと、前のフレームとの同期に従事しています。エッジは、ノードが各命令バッファに書き込む前後に、コンベヤバリアを自動的に挿入するために使用されます。パイプラインバリアは、すべてのリソースの使用を同期させ、キュー間で所有権を転送します。さらに、エッジはノード間にセマフォを挿入します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノードとエッジは</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有向非循環グラフを</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形成し</font><em><font style="vertical-align: inherit;">ます</font></em><font style="vertical-align: inherit;">。次に、レンダリンググラフは</font><em><font style="vertical-align: inherit;">トポロジソートを</font></em><font style="vertical-align: inherit;">実行し</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノード。各ノードが依存するすべてのノードの後に​​移動するようにソートされたノードのフラットリストの作成につながります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
エンジンには3種類のノードがあります。</font></font><code>AcquireNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッファーチェーン（スワップチェーン）から画像を受け取り、</font></font><code>TransferNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPUからGPUにデータを転送</font></font><code>PresentNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、表示するバッファーチェーンの画像を提供します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各ノードは実装することができ</font></font><code>preRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>render</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして</font></font><code>postRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各フレームで実行されます。</font></font><code>AcquireNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中にバッファのチェーンのイメージを取得し</font></font><code>preRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><code>PresentNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">時間通りにこの画像を提供します</font></font><code>postRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はすべてを自分で処理するのではなく、レンダリンググラフシステムを使用するように、三角形のレンダラーをリファクタリングしました。</font></font><code>AcquireNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">との</font><font style="vertical-align: inherit;">間にエッジが</font><font style="vertical-align: inherit;">あります</font></font><code>TriangleRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの間</font></font><code>TriangleRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>PresentNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これにより、バッファーチェーンのイメージがフレーム中の使用中に正しく同期されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/12b/d88/6ba/12bd886ba9b41891ae1e2d0ff47b9929.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンジン内部が変わったと誓います</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4日目</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カメラと3Dレンダリングシステムを作成しました。これまでのところ、カメラは独自の永続バッファーと記述子プールを受信して​​います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vulkanで3Dレンダリングに適した構成を見つけようとしていたため、その日は遅くなりました。ほとんどのオンラインマテリアルは、Vulkanとは少し異なる座標系を使用するOpenGLを使用したレンダリングに重点を置いています。 OpenGLでは、クリップスペースのZ軸はとして指定され</font></font><code>[-1, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、画面の上端はにあります</font></font><code>Y = 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 Vulkanでは、Z軸はとして指定され</font></font><code>[0, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、画面の上端はにあります</font></font><code>Y = -1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これらの小さな違いにより、標準のGLM射影行列はOpenGL用に設計されているため、正しく機能しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GLMにはオプションがあります</font></font><code>GLM_FORCE_DEPTH_ZERO_TO_ONE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Z軸の問題を解消します。その後</font></font><code>(1, 1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、射影行列</font><font style="vertical-align: inherit;">要素の符号を変更するだけでY軸の問題を解消できます</font><font style="vertical-align: inherit;">（GLMは0からのインデックスを使用します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y軸を反転する場合は、頂点データを反転する必要があります。これは、その前に、Y軸の負の方向が上を向いているためです。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8d9/05d/464/8d905d4643a189400471c7e8d4fbd3f6.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今3Dで！</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5日目</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザー入力と、マウスでカメラを移動する機能を追加しました。</font><font style="vertical-align: inherit;">入力システムは非常に洗練されていますが、GLFW入力の奇妙さを排除しています。</font><font style="vertical-align: inherit;">特に、マウスをブロックしているときにマウスの位置を変更するという問題がありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーボードとマウスの入力は、本質的にはシグナルハンドラーを介して開かれるGLFW上の薄いラッパー</font></font><code>entt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちょうど比較のために-ホプソンが彼のプロジェクトの初日でやった同じことについて。</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お使いのブラウザはHTML5ビデオをサポートしていません。</font></font><source src="https://vazgriz.com/wp-content/uploads/2020/01/voxels.webm" type="video/webm"></video></div></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6日目</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ボクセルブロックを生成してレンダリングするコードを追加し始めました。</font><font style="vertical-align: inherit;">以前にそれを行い、ミスを少なくできる抽象化を知っていたため、メッシュコードの記述は簡単でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
抽象化の1つは、</font><font style="vertical-align: inherit;">各辺の</font><font style="vertical-align: inherit;">サイズ</font><font style="vertical-align: inherit;">の</font></font><code>ChunkData&lt;T, chunkSize&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイプの立方体を定義</font><font style="vertical-align: inherit;">するテンプレートクラスでした</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このクラスは、データを1D配列に格納し、3D座標でデータのインデックスを処理します。</font><font style="vertical-align: inherit;">各ブロックのサイズは16 x 16 x 16なので、内部データは長さが4096の単純な配列です。</font><font style="vertical-align: inherit;">
もう1つの抽象化は、座標を生成する位置の反復子を作成する</font><font style="vertical-align: inherit;">ことです。</font></font><code>T</code><font style="vertical-align: inherit;"></font><code>chunkSize</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>(0, 0, 0)</code><font style="vertical-align: inherit;"></font><code>(15, 15, 15)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これらの2つのクラスにより、ブロックデータの反復が線形順序で実行され、キャッシュの局所性が向上します。</font><font style="vertical-align: inherit;">3D座標は、それを必要とする他の操作で引き続き使用できます。</font><font style="vertical-align: inherit;">例えば：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (glm::ivec3 pos : Chunk::Positions()) {
    <span class="hljs-keyword">auto</span>&amp; data = chunkData[pos];<font></font>
    glm::ivec3 offset = ...;<font></font>
    <span class="hljs-keyword">auto</span>&amp; neighborData = chunkData[pos + offset];<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームで一般的に使用されるオフセットを指定する静的配列がいくつかあります。</font><font style="vertical-align: inherit;">たとえば</font></font><code>Neighbors6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、立方体が共通の面を持つ6つの近傍を定義します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">array</span>&lt;glm::ivec3, 6&gt; Neighbors6 = {<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),    <span class="hljs-comment">//right</span>
        glm::ivec3(<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),   <span class="hljs-comment">//left</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),    <span class="hljs-comment">//top</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>),   <span class="hljs-comment">//bottom</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),    <span class="hljs-comment">//front</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>)    <span class="hljs-comment">//back</span>
    };</code></pre><br>
<code>Neighbors26</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-これらは、立方体が共通の面、エッジ、または頂点を持つすべての隣人です。</font><font style="vertical-align: inherit;">つまり、中央の立方体のない3x3x3グリッドです。</font><font style="vertical-align: inherit;">他のネイバーセットと2Dネイバーセットにも同様の配列があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キューブの1つの面を作成するために必要なデータを定義する配列があります。</font><font style="vertical-align: inherit;">この配列の各面の方向は、配列の方向に対応してい</font></font><code>Neighbors6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">array</span>&lt;FaceArray, 6&gt; NeighborFaces = {
    <span class="hljs-comment">//right face</span><font></font>
    FaceArray {<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<font></font>
    },<font></font>
    ...<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これのおかげで、メッシュ作成コードは非常に簡単です。それは単にブロックのデータをバイパスし、ブロックが固体であるときに面を追加しますが、その隣はそうではありません。コードは、ブロック内のすべてのキューブのすべての面をチェックするだけです。これは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">説明する「単純な」方法に似てい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (glm::ivec3 pos : Chunk::Positions()) {<font></font>
    Block block = chunk.blocks()[pos];<font></font>
    <span class="hljs-keyword">if</span> (block.type == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; Chunk::Neighbors6.size(); i++) {<font></font>
        glm::ivec3 offset = Chunk::Neighbors6[i];<font></font>
        glm::ivec3 neighborPos = pos + offset;<font></font>
<font></font>
        <span class="hljs-comment">//<span class="hljs-doctag">NOTE:</span> bounds checking omitted</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> (chunk.blocks()[neighborPos].type == <span class="hljs-number">0</span>) {<font></font>
            Chunk::FaceArray&amp; faceArray = Chunk::NeighborFaces[i];<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> j = <span class="hljs-number">0</span>; j &lt; faceArray.size(); j++) {<font></font>
                m_vertexData.push_back(pos + faceArray[j]);<font></font>
                m_colorData.push_back(glm::i8vec4(pos.x * <span class="hljs-number">16</span>, pos.y * <span class="hljs-number">16</span>, pos.z * <span class="hljs-number">16</span>, <span class="hljs-number">0</span>));<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
に置き換え</font></font><code>TriangleRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ました</font></font><code>ChunkRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ブロックメッシュが正しくレンダリングできるように、深度バッファーも追加しました。との間のレンダリンググラフにエッジをもう1つ追加する必要が</font></font><code>TransferNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ありました</font></font><code>ChunkRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このエッジは、転送キューとグラフィックスキューの間でキューファミリのリソースの所有権を転送します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ウィンドウ変更イベントを正しく処理できるようにエンジンを変更しました。 OpenGLでは、これは単純に行われますが、Vulkanでは混乱を招きます。バッファのチェーンは明示的に作成し、一定のサイズにする必要があるため、ウィンドウのサイズを変更する場合は、ウィンドウを再作成する必要があります。バッファチェーンに依存するすべてのリソースを再作成する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バッファチェーンに依存するすべてのコマンド（およびこれらはすべて描画コマンド）は、古いバッファチェーンを破棄する前に実行を完了する必要があります。</font><font style="vertical-align: inherit;">つまり、GPU全体がアイドル状態になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
動的なビューポートとサイズ変更を提供するには、グラフィックパイプラインを変更する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
XまたはY軸のウィンドウサイズが0の場合、バッファーチェーンを作成できません。ウィンドウが最小化されている場合も含みます。</font><font style="vertical-align: inherit;">つまり、これが発生すると、ゲーム全体が一時停止し、ウィンドウが開いたときにのみ続行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これでメッシュは単純な3次元のチェス盤になります。</font><font style="vertical-align: inherit;">メッシュのRGBカラーは、XYZ位置に16を掛けた値に従って設定されます。</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お使いのブラウザはHTML5ビデオをサポートしていません。</font></font><source src="https://vazgriz.com/wp-content/uploads/2020/01/voxels2.webm" type="video/webm"></video></div></div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7日目</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゲームプロセスを1つではなく、一度にいくつかのブロックにしました。複数のブロックとそのメッシュはECSライブラリによって管理されます</font></font><code>entt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。次に、ブロックレンダラーをリファクタリングして、ECSにあるすべてのブロックをレンダリングしました。まだ1つのブロックしかありません</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、必要に応じて新しい</font><font style="vertical-align: inherit;">ブロックを</font><font style="vertical-align: inherit;">追加</font><em><font style="vertical-align: inherit;">でき</font></em><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッシュをリファクタリングして、作成後にデータを更新できるようにしました。これにより、キューブを追加および削除する機能を追加したときに、将来ブロックメッシュを更新できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
立方体を追加または削除すると、メッシュ内の頂点の数が増減する可能性があります。以前に選択した頂点バッファーは、新しいメッシュが同じサイズ以下の場合にのみ使用できます。ただし、メッシュが大きい場合は、新しい頂点バッファーを作成する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以前の頂点バッファーはすぐに削除できません。特定のオブジェクトに固有の前のフレームから実行された命令バッファが存在する場合があります</font></font><code>VkBuffer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。エンジンは、これらのコマンドバッファが完了するまでバッファを保持する必要があります。つまり、フレーム</font></font><code>i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">メッシュを描画する場合</font><font style="vertical-align: inherit;">、GPUはフレームが始まる前にこのバッファーを使用できます</font></font><code>i + 2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 GPUが使用を終了するまで、バッファーをCPUから削除することはできません。そこで、リソースの寿命を追跡するようにレンダリンググラフを変更しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レンダリンググラフノードがリソース（バッファまたはイメージ）を使用する場合は、method </font></font><code>sync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内のメソッドを</font><font style="vertical-align: inherit;">呼び出す必要があります</font></font><code>preRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このメソッドは、</font></font><code>shared_ptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースへ</font><font style="vertical-align: inherit;">のポインター</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">取得します</font><font style="vertical-align: inherit;">。この</font></font><code>shared_ptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドバッファーの実行中にリソースが削除されないようにします。</font><font style="vertical-align: inherit;">（パフォーマンスに関しては、このソリューションはあまり良くありません。これについては後で詳しく説明します。）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、ブロックメッシュが各フレームで再生成されます。</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お使いのブラウザはHTML5ビデオをサポートしていません。</font></font><source src="https://vazgriz.com/wp-content/uploads/2020/01/voxels3.webm" type="video/webm"></video></div></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が1週間で行ったことはこれだけです。複数のボクセルブロックを使用して世界をレンダリングする基本を準備し、2週目も引き続き機能します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja487812/index.html">E27を導いたポーランドのLEDスペクトルのテスト</a></li>
<li><a href="../ja487814/index.html">速度と信頼性が高く、価格が低くなっています。新しいキングストンKC2000ソリッドステートドライブ</a></li>
<li><a href="../ja487822/index.html">AvitoTech On Tour：Nizhny NovgorodでのAndroid交流会</a></li>
<li><a href="../ja487824/index.html">LEDランプの概要ヨーロッパからのスペクトルLed GU10</a></li>
<li><a href="../ja487826/index.html">ポーランドのLEDランプの概要Spectrum Led E14</a></li>
<li><a href="../ja487834/index.html">セキュリティウィーク07：Android Bluetoothスタックの脆弱性</a></li>
<li><a href="../ja487836/index.html">RxJSを使用したサーバーへのファイルのインタラクティブなアップロード</a></li>
<li><a href="../ja487838/index.html">データの検証：別のアプローチ</a></li>
<li><a href="../ja487842/index.html">カントリールーター用の2つのSIM-それはたくさんですか、それとも少しですか？</a></li>
<li><a href="../ja487844/index.html">匂いが明らかに</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>