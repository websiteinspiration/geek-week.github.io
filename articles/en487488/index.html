<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôáüèø üë®üèΩ‚Äçüè´ ‚è™ Cases for applying network anomaly analysis tools: detecting the spread of malicious code üíº üéÑ üë©üèΩ‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I will continue to review cases related to the use of IS monitoring solutions using the NTA (Network Traffic Analysis) class solution. Last time I sho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cases for applying network anomaly analysis tools: detecting the spread of malicious code</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/cisco/blog/487488/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will continue to review cases related to the use of IS monitoring solutions using the NTA (Network Traffic Analysis) class solution. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Last time</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I showed how you can detect information leaks, but this time we‚Äôll talk about identifying malicious code inside a corporate or departmental network.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d_/5y/zy/d_5yzys5bncf4bq3_xft3ekqchw.png" alt="image"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What's so hard about detecting malicious code? They put an antivirus and it catches any malware. Alas! If it were all that simple, then you probably could have forgotten about this problem forever, but no ... The number of successful malware infections does not get smaller, and all because attackers constantly change their techniques and tactics, modify malware, they use incorporeal malware, they use legal utilities for administration (the same PowerShell) ... And this is if you do not consider situations where on individual nodes there is either no antivirus at all (IT specialists do not want to install it because it slows down), or for this platform it simply does not exist. And maybe there is a situation that I have had to deal with repeatedly in different companies.The top manager picks up malware on his home laptop or tablet and drags it into the company so that local IT specialists figure it out. The device connects to local Wi-Fi and this is how the internal epidemic begins; even in a network isolated from the Internet. In any case, the antivirus is far from always a salvation from modern malicious code, and we need other methods to detect bad guys on our network.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is characterized by modern malicious code? </font><font style="vertical-align: inherit;">Are there any signs that can tell us that something is going wrong in our network and that we still got some kind of infection? </font><font style="vertical-align: inherit;">If you do not take into account classical viruses that do not have the function of independent distribution over the network (and you have long seen classical viruses), then among the signs that can characterize the presence of malicious code on the network, I would name the following:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scanning internal nodes looking for vulnerabilities in operating systems or applications</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scanning internal nodes looking for open ports through which you can connect to the system</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interaction with well-known command servers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atypical traffic from the host (previously unmet protocols, exceeding the typical amount of traffic, server protocols at workstations, etc.).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These are network signs, which are almost independent of which malicious code is used. So, you can try to identify them and monitoring tools for anomalies and threats based on Netflow (or other flow protocols) are the best candidates for this. Let's see how this can be done using the Cisco Stealthwatch solution as an example.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is the difference between a conventional scan, for example, a security scanner, and a scan performed by malicious code? In the first case, in most situations, iterates through open ports on one computer, then on another, on the third and so on. Such attempts to identify quite easily. It is easy to determine when the scanner simply checks for only one open port in the address range. For malicious code, the principle of operation is different - it scans nodes, finds vulnerable ones, gets over to them, scans again, finds vulnerable ones again, and so on. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pm/hf/th/pmhfthynsrnygqtlv6gvir_8i0e.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is such a development that we can recognize with the help of special algorithms embedded in the NTA.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ob/oh/vz/obohvzsbaod2spmwmmz1leviudk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An additional hint to us is the role of computers from which the scan was recorded - in all cases, these are workstations of sales and marketing employees who scan entire subnets, which are also logically related to the sales division. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rt/4q/co/rt4qcocbyepsz3vlfb2f9dydiw0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having found one infection point with the subsequent spread of malicious code: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tx/hw/gj/txhwgjcmlbonfgosfqbjondeyo0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can try to find other potential victims of the malicious code: </font><font style="vertical-align: inherit;">Having </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rc/xv/z9/rcxvz9dxkrffxays3hou3zg1rr0.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
correctly configured the anomaly analysis system, next time we can no longer conduct separate investigations that answer the question of whether we have a network scan or not ? It will be enough just to see the corresponding alarm indicator (recon) on the main console:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/vu/gb/srvugbzem5sfprr-qlqn_zdga-g.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and clicking on it, to get a list of everyone who has been noticed in ‚Äúillegal‚Äù computer activities (by the way, the first illustration in this article shows another way of visualizing the scale of distribution of malicious code). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yw/hv/sh/ywhvshjiohdvtjjhpjjnf4y1vma.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth recalling that a seemingly simple scan may be the first signal for more serious problems. If phishing emails are one of the first steps by which attackers begin their activities, then by infecting one computer, they expand their bridgehead and the main way to do this starts with a scan. This is how WannaCry acted, so Shamoon acted, so hundreds of other malicious programs act, resulting in serious incidents.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/w6/-d/wc/w6-dwcrq1labj-rymczqy43o6na.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having recorded the fact of scanning and spreading malicious code, we are faced with the task of conducting a more detailed investigation and understanding whether a node was already infected, than it was infected, when, etc.? The NTA class solution alone cannot do this, since you cannot answer these questions by telemetry alone. But in the case of Cisco Stealthwatch, a free Cisco Threat Response solution will come to our aid, about which I already </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">talked</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about integration </font><font style="vertical-align: inherit;">. It is enough for us to click on the node of interest to us and in the drop-down context menu we will see the possibility of launching CTR, which in turn can collect information about the node of interest to us from various systems - Cisco AMP for Endpoints, Cisco Umbrella, Cisco Talos, etc.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gn/64/wo/gn64woga66tkwkd5vedz1gucauo.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's what the picture might look like that the free Cisco Threat Response displays based on its capabilities for enriching and visualizing security events: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ht/bp/zq/htbpzqxctri84ercsdvfpbj_ryq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CTR can show us malicious files associated with the site of interest to us, which we can check through the Cisco Threat Grid sandbox or the VirusTotal service. Having data on one node, we can see who he interacted with or is interacting with in the framework of the incident, where the attack started, what malicious code was involved in it, how the network penetrated, and answered many other questions that are of interest to security analysts.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tp/hu/mt/tphumth99yiy9qlefo59mxcrycw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And then we can already conduct additional verification of the received artifacts using external Threat Intelligence services, which can provide us with more indicators of compromise, more information about the attackers, more information about the techniques and tactics they use. </font><font style="vertical-align: inherit;">And it all started with a simple network scan detected by the solution for analyzing anomalies using Netflow (or another flow protocol).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3b/w3/qz/3bw3qzewibdfgyj8xwijzag10t8.png" alt="image"></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en487488/">https://habr.com/ru/post/en487488/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487454/index.html">Who are these people? Why do they need me? and other scrum master problems</a></li>
<li><a href="../en487460/index.html">Delta: Data Synchronization and Enrichment Platform</a></li>
<li><a href="../en487462/index.html">Webix JavaScript library through the eyes of a beginner. Part 4. Work with data. CRUD</a></li>
<li><a href="../en487470/index.html">Calibry: 3D Breakthrough Price Breakthrough</a></li>
<li><a href="../en487486/index.html">Sega Dreamcast Anatomy: Console Second Life</a></li>
<li><a href="../en487490/index.html">XSL transformation on MS SQL without CLR</a></li>
<li><a href="../en487498/index.html">Choosing a database for analytics</a></li>
<li><a href="../en487502/index.html">Polling print devices using SNMP while the printer is printing</a></li>
<li><a href="../en487504/index.html">By the Day of Russian Science, the best achievements of domestic scientists of 2019 are named</a></li>
<li><a href="../en487508/index.html">Measuring distance to objects using RealSense D435</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>