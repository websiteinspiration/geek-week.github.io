<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå•Ô∏è ü§∂üèæ üôãüèæ Realistic combat AI for 2D game üè¶ üôâ üçñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Although Close Quarters is predominantly a multiplayer game, complex AI bots must still be present in it to keep players playing when the Internet con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Realistic combat AI for 2D game</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496448/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cad/5e8/90a/cad5e890a02ede113b8ddfe17739e474.png" alt="image"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although Close Quarters is predominantly a multiplayer game, complex AI bots must still be present in it to keep players playing when the Internet connection is poor or if there are no other online players. </font><font style="vertical-align: inherit;">In addition, bots play an important supporting role in some game modes. </font><font style="vertical-align: inherit;">Therefore, they should behave believably and demonstrate a set of complex behaviors, including the use of shelters, the use of objects at the right time, bypassing the flanks, throwing grenades and running away from them.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Environment and restrictions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The gaming environment consists of polygons. </font><font style="vertical-align: inherit;">Most polygons block movement, visibility and shooting, but there are also ‚Äúlow‚Äù polygons that only block movement. </font><font style="vertical-align: inherit;">The environment is tightly covered with obstacles and shelters. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AI is also limited by several technical factors. </font><font style="vertical-align: inherit;">The most important of them: the server on which bots are executed, when there are few players online, should quickly work on an inexpensive VPS with at least ten bots. </font><font style="vertical-align: inherit;">In addition, the CPU load should remain low enough to allow multiple server instances on the same VPS without exceeding the CPU limit, and without causing sanctions by the VPS service provider.</font></font><br>
<a name="habracut"></a><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f36/30a/551/f3630a5516616d0eed4665a6ee2b013d.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 1: environments</font></font></i><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5f6/e4a/300/5f6e4a300229273d85836278d0d15d50.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2: view from the player‚Äôs face of obstacles blocking the view (gray areas are invisible to him)</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mesh of navigation and visibility, tactical search of a way</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bots use a dense navigation mesh consisting of discrete points. The mesh is generated as follows: first, the polygons that make up the environment are </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expanded and combined</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Additional nodes are added near the corners, because these places are most likely to be suitable shelter positions. The resulting movement space is then </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">triangulated</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to generate a mesh.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cad/5e8/90a/cad5e890a02ede113b8ddfe17739e474.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 3: navigation mesh</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Since bots must perform a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tactical search for the path</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the navigation mesh must contain visibility data that allows us to quickly check whether the node contains shelter from the selected enemy. </font><font style="vertical-align: inherit;">Therefore, each node contains an array of 24 bytes, each of which represents a pre-calculated approximate distance between the node and the nearest obstacle blocking the field of view in a certain direction.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/911/f24/b43/911f24b4392c8ec1a686a2117971674b.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 4: Visibility data stored in the node (blue lines). </font><font style="vertical-align: inherit;">Each line represents a single-byte value that defines visibility in a given direction. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to these data, you can </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">search the graphs using the A * algorithm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the navigation mesh, in which nodes that can be opened to known enemies receive lower priority without costly line of sight checks. To check whether a certain node is open to the enemy, we determine the direction and distance from the node to the enemy, and then check whether this distance is less than the distance stored in the array element that is closest to this direction. In addition, we can check if the enemy is looking at the node. Then we can apply the penalty factor to the cost of moving through nodes open to enemies, and the resulting path will tend to avoid such nodes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The same visibility data, in addition to finding the path between two given points, can be used for other ‚Äútactical‚Äù actions. For example, the bot seeks shelter by performing a breadth-first search and stops as soon as it finds a protected site. Line-of-sight tests are used to verify that the site actually provides shelter. Similarly, we can generate attack paths from the flanks by searching A * for the target; at the same time, high fines are imposed on open nodes within the target shooting cone. The search stops as soon as we reach an open knot outside this firing cone. (One of the problems with this approach is that bots that go out of scope constantly try to get closer to the goal, and therefore seem too aggressive; this can probably be fixed by setting the A * heuristic soso that the bot does not move directly to the target, but to any nodes located at a selected distance from the target).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Feelings and memory of bots</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order for bots to behave convincingly, they should not seem like cheaters. </font><font style="vertical-align: inherit;">In other words, the information that the bot works with should be similar to the information that the player possesses. </font><font style="vertical-align: inherit;">For example, the enemy behind the obstacle should be invisible to the bot just as it is not visible to the player.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/iU5duk5bG2s" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two ways in which a player can detect an enemy‚Äôs position: he can see the enemy or hear how he moves, shoots, or performs some other action. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each bot keeps a list of known "facts" about the positions and direction of the gaze of enemies. </font><font style="vertical-align: inherit;">Without updates, these facts are deleted after ten seconds. </font><font style="vertical-align: inherit;">A fact related to a specific enemy is updated when the bot can hear or see that enemy. </font><font style="vertical-align: inherit;">When a bot hears an enemy, to simulate uncertainty, the position of the corresponding fact is shifted from the true position of the enemy in a random direction and distance, depending on how close the bot was sound (see video, 1:28).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a37/977/739/a37977739b24dcf1c44d5ffba70571a1.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 5: facts (pink circles) in the bot‚Äôs memory</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Behavior tree</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In an earlier version of Close Quarters, AI used STRIPS, a solution </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">popularized by FEAR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in 2005. In STRIPS, the relationship between different AI behaviors is not predefined by the programmer. Instead, each behavior contains a list of binary preconditions and outcomes. Each bot has a state of the problem in the world and uses the search in the graph A * to find the sequence of behaviors to achieve it. This solution worked well, but I felt that it was too complex for my application and better suited for AI, which needed to develop complex plans involving many different behaviors. In most cases, I already knew the circumstances under which the bot had to perform this or that behavior, so using A * for this algorithm was an unnecessary waste of CPU resources.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, bots now use a simple decision tree and behavior. In each measure, the bot goes around the tree, starting from the root, until it reaches the behavior. If this behavior is the same as already performed, then the bot continues this behavior. If not, the bot initiates the behavior and begins to execute it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some behaviors can ‚Äúblock‚Äù, that is, prevent the bot from repeatedly traversing the tree until a certain condition is met. This is useful, for example, to ensure that bots get to cover before deciding to attack. Also, behaviors can ‚Äúnullify‚Äù each other, forcing the bot to re-walk the tree and re-initiate the behavior. This is useful, for example, when a bot escapes from a grenade, and another grenade appears that compromises selected escape positions.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ee/f25/e23/8eef25e23bf91b1071a9cb747fd45b07.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 6: The decision and behavior tree currently in use</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Some secondary behaviors are encoded within other, more general behaviors. </font><font style="vertical-align: inherit;">For example, if a bot tries to attack an enemy and discovers that the enemy is not in the expected position, then it assumes where the enemy can be now and calculates a new attack path without leaving the attack behavior.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Load distribution</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each bot does not have to be updated in every frame of physics, that is, 40 times per second. </font><font style="vertical-align: inherit;">To reduce CPU costs, each bot "thinks" only 20 times per second (this number can be reduced if necessary). </font><font style="vertical-align: inherit;">Therefore, only half of the bots are updated in each physics cycle.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work with grenades</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A serious problem was the meaningful use of grenades by bots. Working with grenades is much more difficult than shooting, because grenades can fly off walls, have a radius of destruction and time to throw. Fortunately, bots are not required to use grenades perfectly, enough persuasiveness. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The traditional solution to this problem is to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pre-calculate the paths of grenades in the navigation nodes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but when it is implemented, a few seconds are added to the load time of each map, which contradicts my goal: Close Quarters should throw players into the battle in a matter of seconds after starting the game.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, bots are looking for opportunities to use grenades, calculating the paths of grenades on the fly. In each measure, the attacking bot checks several possible trajectories in a given direction within 60 degrees from the direction of the selected target. If a grenade thrown along a proven path can kill the target and the target is out of scope, the bot throws a grenade. The checked direction is looped in each AI clock.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2c7/0db/9f3/2c70db9f33046c2064009f6251f7a0ba.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 7: directions checked by the bot for one second (pale pink lines) and tested trajectories (blue circles) along the direction selected in the current measure (bright pink line).</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
That is, bots use grenades whenever possible and do not move to a position specifically in order to throw a grenade. However, the path chosen by the bot to attack the enemy is often a sensible path from which to throw a grenade.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A significant drawback of such a system is that, due to the limited number of checked directions, bots miss the opportunity to throw grenades so that they bounce off small obstacles. </font><font style="vertical-align: inherit;">Most noticeably, this is next to the doorways, where bots usually do not recognize the possibility of using a grenade. </font><font style="vertical-align: inherit;">This problem can be solved by testing several directions in one frame and thus reducing the angle between the direction being checked and the next.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Movement to more human behavior</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such a problem quickly becomes apparent: the bots are too quick to pull the trigger, because it is very difficult to defeat them in a one-on-one battle. </font><font style="vertical-align: inherit;">The average human reaction time to visual stimuli is 250 milliseconds, but at 20 beats per second, the maximum bot reaction time is only 50 milliseconds! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve this problem, I deliberately added a delay between the moment when the bot gets the opportunity to shoot and the shot itself, so that its reaction time is comparable to the reaction time of a person.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further improvements</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The systems presented above provide a strong fundamental AI, but do not provide opportunities for major improvements. </font><font style="vertical-align: inherit;">For example, now the bot‚Äôs spatial thinking is limited by its immediate surroundings, therefore, although the bot usually tries to bypass the enemy from the flank, it often misses outflanking routes around large obstacles. </font><font style="vertical-align: inherit;">In addition, bots only roughly know about the presence of teammates, so sometimes they accumulate in one place, instead of being divided and bypassing the flanks.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496436/index.html">IPFS on the server. Host sites from a laptop</a></li>
<li><a href="../en496438/index.html">The obvious difference between a leader and a manager</a></li>
<li><a href="../en496442/index.html">Queue in the backend: what are we standing for and where to start our journey?</a></li>
<li><a href="../en496444/index.html">Microsoft Azure Virtual Training Day: Artificial Intelligence for Developers</a></li>
<li><a href="../en496446/index.html">Kanban Method Perception Evolution</a></li>
<li><a href="../en496452/index.html">QA - fire safety specialist for your project</a></li>
<li><a href="../en496456/index.html">Overview of domestic microchips complying with 719 regulation</a></li>
<li><a href="../en496458/index.html">Digitalization of drug turnover using the case of the Planet Health chain of pharmacies as an example</a></li>
<li><a href="../en496460/index.html">Unity Addressables: always enough memory</a></li>
<li><a href="../en496466/index.html">Any fast enough light source has a red Doppler shift</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>