<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™ ğŸ”‡ ğŸ’¾ åœ¨OpenVPNä¸Šç»„ç»‡è¿œç¨‹å·¥ä½œSMBç»„ç»‡ ğŸ•š ğŸ› ğŸ”</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="é—®é¢˜çš„ææ³•
 æœ¬æ–‡ä»‹ç»äº†å¼€æ”¾æºäº§å“ä¸Šå‘˜å·¥çš„è¿œç¨‹è®¿é—®ç»„ç»‡ï¼Œæ—¢å¯ä»¥ç”¨äºæ„å»ºå®Œå…¨è‡ªæ²»çš„ç³»ç»Ÿï¼Œåˆå¯ä»¥åœ¨ç°æœ‰å•†ä¸šç³»ç»Ÿä¸­ç¼ºå°‘è®¸å¯è¯æˆ–æ€§èƒ½ä¸è¶³æ—¶ç”¨äºæ‰©å±•ã€‚
 
 æœ¬æ–‡çš„ç›®çš„æ˜¯ä»‹ç»ä¸€ä¸ªç”¨äºæä¾›å¯¹ç»„ç»‡çš„è¿œç¨‹è®¿é—®çš„å®Œæ•´ç³»ç»Ÿï¼Œè¿™æ¯”â€œåœ¨10åˆ†é’Ÿå†…å®‰è£…OpenVPNâ€è¦ç•¥å¤šã€‚
 
 ç»“æœï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªç³»ç»Ÿï¼Œå…¶ä¸­è¯ä¹¦å’Œï¼ˆå¯é€‰ï¼‰...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>åœ¨OpenVPNä¸Šç»„ç»‡è¿œç¨‹å·¥ä½œSMBç»„ç»‡</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501048/"><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é—®é¢˜çš„ææ³•</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ¬æ–‡ä»‹ç»äº†å¼€æ”¾æºäº§å“ä¸Šå‘˜å·¥çš„è¿œç¨‹è®¿é—®ç»„ç»‡ï¼Œæ—¢å¯ä»¥ç”¨äºæ„å»ºå®Œå…¨è‡ªæ²»çš„ç³»ç»Ÿï¼Œåˆå¯ä»¥åœ¨ç°æœ‰å•†ä¸šç³»ç»Ÿä¸­ç¼ºå°‘è®¸å¯è¯æˆ–æ€§èƒ½ä¸è¶³æ—¶ç”¨äºæ‰©å±•ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ¬æ–‡çš„ç›®çš„æ˜¯ä»‹ç»ä¸€ä¸ªç”¨äºæä¾›å¯¹ç»„ç»‡çš„è¿œç¨‹è®¿é—®çš„å®Œæ•´ç³»ç»Ÿï¼Œè¿™æ¯”â€œåœ¨10åˆ†é’Ÿå†…å®‰è£…OpenVPNâ€è¦ç•¥å¤šã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç»“æœï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªç³»ç»Ÿï¼Œå…¶ä¸­è¯ä¹¦å’Œï¼ˆå¯é€‰ï¼‰Active Directoryå…¬å¸ç›®å½•å°†ç”¨äºç”¨æˆ·èº«ä»½éªŒè¯ã€‚è‡³ã€‚æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªéªŒè¯å› ç´ çš„ç³»ç»Ÿ-æˆ‘æ‹¥æœ‰çš„ï¼ˆè¯ä¹¦ï¼‰å’Œæˆ‘çŸ¥é“çš„ï¼ˆå¯†ç ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…è®¸ç”¨æˆ·è¿æ¥çš„æ ‡å¿—æ˜¯ä»–åœ¨myVPNUsrç»„ä¸­çš„æˆå‘˜èº«ä»½ã€‚è¯ä¹¦é¢å‘æœºæ„å°†ç‹¬ç«‹ä½¿ç”¨ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®æ–½è¯¥è§£å†³æ–¹æ¡ˆçš„æˆæœ¬åªæœ‰å¾ˆå°çš„ç¡¬ä»¶èµ„æºï¼Œå¹¶ä¸”éœ€è¦ç³»ç»Ÿç®¡ç†å‘˜èŠ±è´¹1ä¸ªå°æ—¶çš„æ—¶é—´ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å°†åœ¨CetntOS 7ä¸Šä½¿ç”¨å¸¦æœ‰OpenVPNå’ŒEasy-RSA 3rdç‰ˆæœ¬çš„è™šæ‹Ÿæœºï¼Œè¯¥è™šæ‹ŸæœºåŸºäº100ä¸ªè¿æ¥å‘å‡º4ä¸ªvCPUï¼Œ4ä¸ªGiB RAMã€‚</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ç»„ç»‡çš„ç½‘ç»œä¸º172.16.0.0/16ï¼Œå…¶ä¸­åœ°å€ä¸º172.16.19.123çš„VPNæœåŠ¡å™¨ä½äºç½‘æ®µ172.16.19.0/24ä¸­ï¼ŒDNSæœåŠ¡å™¨ä¸º172.16.16.16å’Œ172.16.17.17ï¼Œå¹¶ä¸”ä¸ºVPNå®¢æˆ·ç«¯åˆ†é…äº†å­ç½‘172.16.20.0/23ã€‚ ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¦ä»å¤–éƒ¨è¿›è¡Œè¿æ¥ï¼Œè¯·åœ¨ç«¯å£1194 / udpä¸Šä½¿ç”¨è¿æ¥ï¼Œå¹¶åœ¨æˆ‘ä»¬æœåŠ¡å™¨çš„DNSä¸­åˆ›å»ºä¸€ä¸ªAè®°å½•gw.abc.ruã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¼ºçƒˆå»ºè®®ä¸è¦ç¦ç”¨SELinuxï¼</font><font style="vertical-align: inherit;">OpenVPNå¯ä»¥åœ¨ä¸ç¦ç”¨å®‰å…¨ç­–ç•¥çš„æƒ…å†µä¸‹å·¥ä½œã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å†…å®¹</font></font></h3><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºè½¯ä»¶å®‰è£…</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯†ç å­¦è®¾ç½®</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é…ç½®OpenVPN</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ADä¸­çš„èº«ä»½éªŒè¯</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯åŠ¨å’Œè¯Šæ–­</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯ä¹¦çš„ç­¾å‘å’Œæ’¤é”€</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç½‘ç»œé…ç½®</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆ</font></font></a></li>
</ol><br>
<a name="setup"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºè½¯ä»¶å®‰è£…</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬ä½¿ç”¨åˆ†å‘å¥—ä»¶CentOS 7.8.2003ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬éœ€è¦ä»¥æœ€å°é…ç½®å®‰è£…æ“ä½œç³»ç»Ÿã€‚</font><font style="vertical-align: inherit;">ä½¿ç”¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kickstart</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå…‹éš†å…ˆå‰å®‰è£…çš„OSæ˜ åƒå’Œå…¶ä»–æ–¹æ³•</font><font style="vertical-align: inherit;">å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œæ­¤æ“ä½œ</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®‰è£…åï¼Œä¸ºç½‘ç»œæ¥å£åˆ†é…åœ°å€ï¼ˆæ ¹æ®ä»»åŠ¡172.16.19.123çš„æ¡ä»¶ï¼‰ï¼Œæˆ‘ä»¬æ›´æ–°æ“ä½œç³»ç»Ÿï¼š</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo yum update -y &amp;&amp; reboot
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿˜å¿…é¡»ç¡®ä¿åœ¨æˆ‘ä»¬çš„æœºå™¨ä¸Šæ‰§è¡Œäº†æ—¶é—´åŒæ­¥ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¦å®‰è£…åº”ç”¨ç¨‹åºè½¯ä»¶ï¼Œæ‚¨éœ€è¦openvpnï¼Œopenvpn-auth-ldapï¼Œeasy-rsaå’Œvimè½¯ä»¶åŒ…ä½œä¸ºä¸»ç¼–è¾‘å™¨ï¼ˆæ‚¨å°†éœ€è¦EPELå­˜å‚¨åº“ï¼‰ã€‚</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo yum install epel-release<font></font>
$ sudo yum install openvpn openvpn-auth-ldap easy-rsa vim<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºè™šæ‹Ÿæœºï¼Œå®‰è£…æ¥å®¾ä»£ç†å¾ˆæœ‰ç”¨ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo yum install open-vm-tools</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€‚ç”¨äºVMware ESXiä¸»æœºæˆ–oVirt</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo yum install ovirt-guest-agent</code></pre><br>
<a name="crypto"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯†ç å­¦è®¾ç½®</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿›å…¥easy-rsaç›®å½•ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">$ <span class="hljs-built_in">cd</span> /usr/share/easy-rsa/3/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ›å»ºä¸€ä¸ªå˜é‡æ–‡ä»¶ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo vim vars</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹å†…å®¹ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs">export KEY_COUNTRY="RU"<font></font>
export KEY_PROVINCE="MyRegion"<font></font>
export KEY_CITY="MyCity"<font></font>
export KEY_ORG="ABC LLC"<font></font>
export KEY_EMAIL="admin@abc.ru"<font></font>
export KEY_CN="allUsers"<font></font>
export KEY_OU="allUsers"<font></font>
export KEY_NAME="gw.abc.ru"<font></font>
export KEY_ALTNAMES="abc-openvpn-server"<font></font>
export EASYRSA_CERT_EXPIRE=3652<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™é‡Œæè¿°äº†ABC LLCçš„æ¡ä»¶ç»„ç»‡çš„å‚æ•°ï¼Œæ‚¨å¯ä»¥å¯¹å…¶è¿›è¡Œå®é™…æ›´æ­£æˆ–å°†å…¶ä½œä¸ºç¤ºä¾‹ã€‚</font><font style="vertical-align: inherit;">å‚æ•°ä¸­æœ€é‡è¦çš„æ˜¯æœ€åä¸€è¡Œï¼Œå®ƒç¡®å®šè¯ä¹¦çš„æœ‰æ•ˆæœŸé™ï¼ˆå¤©ï¼‰ã€‚</font><font style="vertical-align: inherit;">åœ¨ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨10å¹´çš„å€¼ï¼ˆ365 * 10 + 2 leapå¹´ï¼‰ã€‚</font><font style="vertical-align: inherit;">åœ¨é¢å‘ç”¨æˆ·è¯ä¹¦ä¹‹å‰ï¼Œéœ€è¦è°ƒæ•´æ­¤å€¼ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¥ä¸‹æ¥ï¼Œå»ºç«‹ä¸€ä¸ªç‹¬ç«‹çš„è¯ä¹¦é¢å‘æœºæ„ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é…ç½®åŒ…æ‹¬å¯¼å‡ºå˜é‡ï¼Œåˆå§‹åŒ–CAï¼Œé¢å‘æ ¹å¯†é’¥å’ŒCAè¯ä¹¦ï¼ŒDiffie-Hellmanå¯†é’¥ï¼ŒTLSå¯†é’¥ä»¥åŠæœåŠ¡å™¨å¯†é’¥å’Œè¯ä¹¦ã€‚</font><font style="vertical-align: inherit;">è¯ä¹¦é¢å‘æœºæ„å¯†é’¥å¿…é¡»å°å¿ƒä¿æŠ¤å¹¶ä¿å¯†ï¼</font><font style="vertical-align: inherit;">é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¿ç•™è¯·æ±‚ä¸­çš„æ‰€æœ‰å‚æ•°ã€‚</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /usr/share/easy-rsa/3/<font></font>
. ./vars<font></font>
./easyrsa init-pki<font></font>
./easyrsa build-ca nopass<font></font>
./easyrsa gen-dh<font></font>
./easyrsa gen-req myvpngw nopass<font></font>
./easyrsa sign-req server myvpngw<font></font>
./easyrsa gen-crl<font></font>
openvpn --genkey --secret pki/ta.key<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è‡³æ­¤ï¼Œå¯†ç æœºåˆ¶è®¾ç½®çš„ä¸»è¦éƒ¨åˆ†å®Œæˆã€‚</font></font><br>
<a name="ovpn"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é…ç½®OpenVPN</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è½¬åˆ°OpenVPNç›®å½•ï¼Œåˆ›å»ºæœåŠ¡ç›®å½•å¹¶æ·»åŠ ä¸€ä¸ªæŒ‡å‘easy-rsaçš„é“¾æ¥ï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /etc/openvpn/<font></font>
mkdir /var/<span class="hljs-built_in">log</span>/openvpn/ /etc/openvpn/ccd /usr/share/easy-rsa/3/client<font></font>
ln -s /usr/share/easy-rsa/3/pki/ /etc/openvpn/<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ›å»ºä¸»è¦çš„OpenVPNé…ç½®æ–‡ä»¶ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo vim server.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹å†…å®¹</font></font><br>
<br>
<pre><code class="plaintext hljs">port 1194<font></font>
proto udp<font></font>
dev tun<font></font>
ca /etc/openvpn/pki/ca.crt<font></font>
cert /etc/openvpn/pki/issued/myvpngw.crt<font></font>
key /etc/openvpn/pki/private/myvpngw.key<font></font>
crl-verify /etc/openvpn/pki/crl.pem<font></font>
dh /etc/openvpn/pki/dh.pem<font></font>
server 172.16.20.0 255.255.254.0<font></font>
ifconfig-pool-persist ipp.txt<font></font>
push "route 172.16.0.0 255.255.255.0"<font></font>
push "route 172.17.0.0 255.255.255.0"<font></font>
client-config-dir ccd<font></font>
push "dhcp-option DNS 172.16.16.16"<font></font>
push "dhcp-option DNS 172.16.17.17"<font></font>
keepalive 10 120<font></font>
cipher AES-256-CBC<font></font>
user nobody<font></font>
group nobody<font></font>
persist-key<font></font>
persist-tun<font></font>
status /var/log/openvpn/openvpn-status.log<font></font>
log-append  /var/log/openvpn/openvpn.log<font></font>
verb 3<font></font>
explicit-exit-notify 1<font></font>
username-as-common-name<font></font>
plugin /usr/lib64/openvpn/plugin/lib/openvpn-auth-ldap.so /etc/openvpn/ldap.conf<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ‰å…³å‚æ•°çš„ä¸€äº›è¯´æ˜ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœç­¾å‘è¯ä¹¦æ—¶æ³¨æ˜äº†ä¸åŒçš„åå­—ï¼Œè¯·æ³¨æ˜ï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŒ‡å®šä»»åŠ¡çš„åœ°å€æ± *;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è·¯ç”±å’ŒDNSæœåŠ¡å™¨å¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨AD **ä¸­å®æ–½èº«ä»½éªŒè¯éœ€è¦æœ€åä¸¤è¡Œã€‚</font></font></li>
</ul><br>
<i>*         127 , ..   /23,  OpenVPN        /30.<br>
        ,    ,        SELinux,    tcp   , ..   tcp-        .<br>
<br>
**   AD  ,  ,   â€” ,    <b>  auth-user-pass</b>.</i><br>
<a name="auth"></a><br>
<h4>  AD</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†æ”¯æŒç¬¬äºŒä¸ªå› ç´ ï¼Œæˆ‘ä»¬å°†åœ¨ADä¸­ä½¿ç”¨å¸æˆ·éªŒè¯ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬éœ€è¦åœ¨åŸŸä¸­æ‹¥æœ‰ä¸€ä¸ªæ™®é€šç”¨æˆ·å’Œä¸€ä¸ªç»„çš„æƒé™çš„å¸æˆ·ï¼Œè¯¥å¸æˆ·çš„æˆå‘˜èµ„æ ¼å°†å†³å®šè¿æ¥çš„èƒ½åŠ›ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">/etc/openvpn/ldap.conf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»¥ä¸‹å†…å®¹</font></font><br>
<br>
<pre><code class="plaintext hljs">&lt;LDAP&gt;<font></font>
        URL             "ldap://ldap.abc.ru"<font></font>
        BindDN          "CN=bindUsr,CN=Users,DC=abc,DC=ru"<font></font>
        Password        b1ndP@SS<font></font>
        Timeout         15<font></font>
        TLSEnable       no<font></font>
        FollowReferrals yes<font></font>
&lt;/LDAP&gt;<font></font>
&lt;Authorization&gt;<font></font>
        BaseDN          "OU=allUsr,DC=abc,DC=ru"<font></font>
        SearchFilter    "(sAMAccountName=%u)"<font></font>
        RequireGroup    true<font></font>
        &lt;Group&gt;<font></font>
                BaseDN          "OU=myGrp,DC=abc,DC=ru"<font></font>
                SearchFilter    "(cn=myVPNUsr)"<font></font>
                MemberAttribute "member"<font></font>
        &lt;/Group&gt;<font></font>
&lt;/Authorization&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸»è¦å‚æ•°ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URLâ€œ ldapï¼š//ldap.abc.ruâ€-åŸŸæ§åˆ¶å™¨çš„åœ°å€ï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BindDNâ€œ CN = bindUsrï¼ŒCN =ç”¨æˆ·ï¼ŒDC = abcï¼ŒDC = ruâ€-ç»‘å®šåˆ°LDAPçš„è§„èŒƒåç§°ï¼ˆUZ-å®¹å™¨abc.ru/Usersä¸­çš„bindUsrï¼‰ï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯†ç b1ndP @ SS-ç”¨äºç»‘å®šçš„ç”¨æˆ·å¯†ç ï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BaseDNâ€œ OU = allUsrï¼ŒDC = abcï¼ŒDC = ruâ€-ä»ä¸­å¼€å§‹ç”¨æˆ·æœç´¢çš„è·¯å¾„ï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BaseDNâ€œ OU = myGrpï¼ŒDC = abcï¼ŒDC = ruâ€-å…è®¸ç»„çš„å®¹å™¨ï¼ˆå®¹å™¨abc.ru \ myGrpä¸­çš„ç»„myVPNUsrï¼‰ï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SearchFilterâ€œï¼ˆcn = myVPNUsrï¼‰â€æ˜¯è§£æç»„çš„åç§°ã€‚</font></font></li>
</ul><br>
<a name="run"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯åŠ¨å’Œè¯Šæ–­</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•æ‰“å¼€å¹¶å¯åŠ¨æœåŠ¡å™¨ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo systemctl <span class="hljs-built_in">enable</span> openvpn@server.service<font></font>
$ sudo systemctl start openvpn@server.service<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯åŠ¨æ£€æŸ¥ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">systemctl status openvpn@server.service<font></font>
journalctl -xe<font></font>
cat /var/<span class="hljs-built_in">log</span>/messages<font></font>
cat /var/<span class="hljs-built_in">log</span>/openvpn/*<span class="hljs-built_in">log</span>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯ä¹¦çš„ç­¾å‘å’Œæ’¤é”€</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› ä¸º </font><font style="vertical-align: inherit;">é™¤äº†è¯ä¹¦æœ¬èº«ä¹‹å¤–ï¼Œæ‚¨è¿˜éœ€è¦å¯†é’¥å’Œå…¶ä»–è®¾ç½®ï¼Œå°†æ‰€æœ‰è¿™äº›æ–‡ä»¶åŒ…è£…åœ¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­éå¸¸æ–¹ä¾¿ã€‚</font><font style="vertical-align: inherit;">ç„¶åå°†è¯¥æ–‡ä»¶ä¼ è¾“ç»™ç”¨æˆ·ï¼Œå¹¶ä¸”é…ç½®æ–‡ä»¶å·²ç»å¯¼å…¥åˆ°OpenVPNå®¢æˆ·ç«¯ä¸Šã€‚</font><font style="vertical-align: inherit;">ä¸ºæ­¤ï¼Œè¯·åˆ›å»ºä¸€ä¸ªé…ç½®æ¨¡æ¿å’Œä¸€ä¸ªæ„æˆé…ç½®æ–‡ä»¶çš„è„šæœ¬ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‚¨éœ€è¦æ·»åŠ æ ¹è¯ä¹¦æ–‡ä»¶ï¼ˆca.crtï¼‰å’ŒTLSå¯†é’¥ï¼ˆta.keyï¼‰çš„å†…å®¹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨é¢å‘ç”¨æˆ·è¯ä¹¦ä¹‹å‰ï¼Œè¯·</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¡®ä¿</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨å‚æ•°æ–‡ä»¶ä¸­</font><u><font style="vertical-align: inherit;">è®¾ç½®æ‰€éœ€çš„è¯ä¹¦æœ‰æ•ˆæœŸ</font></u><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æ‚¨ä¸åº”å°†å…¶è®¾ç½®å¾—å¤ªå¤§ï¼Œæˆ‘å»ºè®®å°†å…¶é™åˆ¶ä¸ºæœ€å¤š180å¤©ã€‚</font></font><br>
<br>
<pre><code class="bash hljs">vim /usr/share/easy-rsa/3/vars</code></pre><br>
<pre><code class="plaintext hljs">...<font></font>
export EASYRSA_CERT_EXPIRE=180<font></font>
</code></pre><br>
<pre><code class="bash hljs">vim /usr/share/easy-rsa/3/client/template.ovpn</code></pre><br>
<pre><code class="plaintext hljs">client<font></font>
dev tun<font></font>
proto udp<font></font>
remote gw.abc.ru 1194<font></font>
resolv-retry infinite<font></font>
nobind<font></font>
persist-key<font></font>
persist-tun<font></font>
remote-cert-tls server<font></font>
cipher AES-256-CBC<font></font>
verb 3<font></font>
auth-user-pass<font></font>
<font></font>
&lt;ca&gt;<font></font>
-----BEGIN CERTIFICATE-----<font></font>
PUT YOUR CA CERT (ca.crt) HERE<font></font>
-----END CERTIFICATE-----<font></font>
&lt;/ca&gt;<font></font>
<font></font>
key-direction 1<font></font>
&lt;tls-auth&gt;<font></font>
-----BEGIN OpenVPN Static key V1-----<font></font>
PUT YOUR TA KEY (ta.key) HERE<font></font>
-----END OpenVPN Static key V1-----<font></font>
&lt;/tls-auth&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç¬”è®°ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å°†æ‚¨çš„...</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å­—ç¬¦ä¸²</font><font style="vertical-align: inherit;">æ›´æ”¹</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸ºå…¶</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯ä¹¦</font><font style="vertical-align: inherit;">çš„å†…å®¹</font><font style="vertical-align: inherit;">ï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨è¿œç¨‹æŒ‡ä»¤ä¸­æŒ‡å®šç½‘å…³çš„åç§°/åœ°å€ï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auth-user-passæŒ‡ä»¤ç”¨äºå…¶ä»–å¤–éƒ¨è®¤è¯ã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨ä¸»ç›®å½•ï¼ˆæˆ–å…¶ä»–æ–¹ä¾¿çš„ä½ç½®ï¼‰ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºç”¨äºè¯·æ±‚è¯ä¹¦å’Œåˆ›å»ºé…ç½®æ–‡ä»¶çš„è„šæœ¬ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">vim ~/make.profile.sh</code></pre><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> ] ; <span class="hljs-keyword">then</span>
 <span class="hljs-built_in">echo</span> Missing mandatory client name. Usage: <span class="hljs-variable">$0</span> vpn-username
 <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span><font></font>
<font></font>
<span class="hljs-comment">#Set variables</span><font></font>
basepath=/usr/share/easy-rsa/3<font></font>
clntpath=<span class="hljs-variable">$basepath</span>/client<font></font>
privpath=<span class="hljs-variable">$basepath</span>/pki/private<font></font>
certpath=<span class="hljs-variable">$basepath</span>/pki/issued<font></font>
profile=<span class="hljs-variable">$clntpath</span>/<span class="hljs-variable">$1</span>.ovpn<font></font>
<font></font>
<span class="hljs-comment">#Get current year and lowercase client name</span><font></font>
year=`date +%F`<font></font>
client=<span class="hljs-variable">${1,,}</span>
<span class="hljs-built_in">echo</span> Processing <span class="hljs-variable">$year</span> year cert <span class="hljs-keyword">for</span> user/device <span class="hljs-variable">$client</span><font></font>
<font></font>
<span class="hljs-built_in">cd</span> <span class="hljs-variable">$basepath</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> [  -f client/<span class="hljs-variable">$client</span>* ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"*** ERROR! ***"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Certificate <span class="hljs-variable">$client</span> already issued!"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"*** ERROR! ***"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span><font></font>
<font></font>
. ./vars<font></font>
./easyrsa --batch --req-cn=<span class="hljs-variable">$client</span> gen-req <span class="hljs-variable">$client</span> nopass<font></font>
./easyrsa --batch sign-req client <span class="hljs-variable">$client</span><font></font>
<font></font>
<span class="hljs-comment">#Make profile</span>
cp <span class="hljs-variable">$clntpath</span>/template.ovpn <span class="hljs-variable">$profile</span><font></font>
<font></font>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;key&gt;"</span> &gt;&gt; <span class="hljs-variable">$profile</span>
cat <span class="hljs-variable">$privpath</span>/<span class="hljs-variable">$1</span>.key &gt;&gt; <span class="hljs-variable">$profile</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;/key&gt;"</span> &gt;&gt; <span class="hljs-variable">$profile</span><font></font>
<font></font>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span> &gt;&gt; <span class="hljs-variable">$profile</span>
openssl x509 -<span class="hljs-keyword">in</span> <span class="hljs-variable">$certpath</span>/<span class="hljs-variable">$1</span>.crt -out <span class="hljs-variable">$basepath</span>/<span class="hljs-variable">$1</span>.crt<font></font>
<font></font>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;cert&gt;"</span> &gt;&gt; <span class="hljs-variable">$profile</span>
cat <span class="hljs-variable">$basepath</span>/<span class="hljs-variable">$1</span>.crt &gt;&gt; <span class="hljs-variable">$profile</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;/cert&gt;"</span> &gt;&gt; <span class="hljs-variable">$profile</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span> &gt;&gt; <span class="hljs-variable">$profile</span><font></font>
<font></font>
<span class="hljs-comment">#remove tmp file</span>
rm -f <span class="hljs-variable">$basepath</span>/<span class="hljs-variable">$1</span>.crt<font></font>
<font></font>
<span class="hljs-built_in">echo</span> Complete. See <span class="hljs-variable">$profile</span> file.<font></font>
<font></font>
<span class="hljs-built_in">cd</span> ~
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬ä½¿æ–‡ä»¶å¯æ‰§è¡Œï¼š</font></font><br>
<br>
<pre><code class="bash hljs">chmod a+x ~/make.profile.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨å¯ä»¥ç­¾å‘æˆ‘ä»¬çš„ç¬¬ä¸€ä»½è¯ä¹¦ã€‚</font></font><br>
<br>
<pre><code class="bash hljs">~/make.profile.sh my-first-user</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åé¦ˆ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœè¯ä¹¦è¢«ç›—ç”¨ï¼ˆä¸¢å¤±ï¼Œè¢«ç›—ï¼‰ï¼Œåˆ™å¿…é¡»åŠé”€æ­¤è¯ä¹¦ï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /usr/share/easy-rsa/3/<font></font>
./easyrsa revoke my-first-user<font></font>
./easyrsa gen-crl<font></font>
</code></pre><br>
<a name="cert"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŸ¥çœ‹å·²é¢å‘å’Œå·²æ’¤é”€çš„è¯ä¹¦</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¦æŸ¥çœ‹å·²é¢å‘å’Œæ’¤é”€çš„è¯ä¹¦ï¼Œåªéœ€æŸ¥çœ‹ç´¢å¼•æ–‡ä»¶ï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /usr/share/easy-rsa/3/<font></font>
cat pki/index.txt<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯´æ˜ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬ä¸€è¡Œæ˜¯æœåŠ¡å™¨è¯ä¹¦ï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬ä¸€ä¸ªå­—ç¬¦</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vï¼ˆæœ‰æ•ˆï¼‰-æœ‰æ•ˆï¼›</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rï¼ˆå·²æ’¤é”€ï¼‰-å¬å›ã€‚</font></font></li>
</ul></li>
</ul><br>
<a name="net"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç½‘ç»œé…ç½®</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€åä¸€æ­¥æ˜¯è®¾ç½®ä¼ è¾“ç½‘ç»œ-è·¯ç”±å’Œé˜²ç«å¢™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ¬åœ°é˜²ç«å¢™ä¸­çš„è¿æ¥æƒé™ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo firewall-cmd --add-service=openvpn<font></font>
$ sudo firewall-cmd --add-service=openvpn --permanent<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¥ä¸‹æ¥ï¼Œå¯ç”¨IPæµé‡è·¯ç”±ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo sysctl net.ipv4.ip_forward=1<font></font>
$ sudo <span class="hljs-built_in">echo</span> <span class="hljs-string">"net.ipv4.ip_forward=1"</span> &gt; /etc/sysctl.d/50-sysctl.conf
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨å…¬å¸ç¯å¢ƒä¸­ï¼Œå¯èƒ½ä¼šå°†å­ç½‘åˆ’åˆ†ä¸ºå¤šä¸ªå­ç½‘ï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰è·¯ç”±å™¨å¦‚ä½•å‘é€å¯»å€åˆ°VPNå®¢æˆ·ç«¯çš„æ•°æ®åŒ…ã€‚åœ¨å‘½ä»¤è¡Œä¸Šï¼ŒæŒ‰ç…§ä»¥ä¸‹æ–¹å¼æ‰§è¡Œå‘½ä»¤ï¼ˆå–å†³äºæ‰€ä½¿ç”¨çš„è®¾å¤‡ï¼‰ï¼š</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># ip route 172.16.20.0 255.255.254.0 172.16.19.123</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¹¶ä¿å­˜é…ç½®ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ­¤å¤–ï¼Œåœ¨è¾¹ç•Œè·¯ç”±å™¨çš„æ¥å£ä¸Šï¼ˆè¯¥æ¥å£æä¾›äº†å¤–éƒ¨åœ°å€gw.abc.ruï¼‰ï¼Œå¿…é¡»å¯ç”¨udp / 1194æ•°æ®åŒ…çš„ä¼ é€’ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœæ‚¨çš„ç»„ç»‡æœ‰ä¸¥æ ¼çš„å®‰å…¨è§„åˆ™ï¼Œåˆ™è¿˜å¿…é¡»åœ¨æˆ‘ä»¬çš„VPNæœåŠ¡å™¨ä¸Šé…ç½®é˜²ç«å¢™ã€‚</font><font style="vertical-align: inherit;">æˆ‘è®¤ä¸ºï¼Œè®¾ç½®iptables FORWARDé“¾å¯ä»¥æä¾›æœ€å¤§çš„çµæ´»æ€§ï¼Œå°½ç®¡è®¾ç½®èµ·æ¥è¾ƒä¸æ–¹ä¾¿ã€‚</font><font style="vertical-align: inherit;">æœ‰å…³è®¾ç½®å®ƒä»¬çš„æ›´å¤šä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">ä¸ºæ­¤ï¼Œä½¿ç”¨â€œç›´æ¥è§„åˆ™â€ï¼ˆå­˜å‚¨åœ¨</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/firewalld/direct.xml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–‡ä»¶ä¸­çš„ç›´æ¥è§„åˆ™ï¼‰æœ€æ–¹ä¾¿</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">å½“å‰è§„åˆ™é…ç½®å¯ä»¥å‘ç°å¦‚ä¸‹ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo firewall-cmd --direct --get-all-rule</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ›´æ”¹æ–‡ä»¶ä¹‹å‰ï¼Œè¯·å¯¹å…¶è¿›è¡Œå¤‡ä»½ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">cp /etc/firewalld/direct.xml /etc/firewalld/direct.xml.`date +%F.%T`.bak</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥æ–‡ä»¶çš„å¤§è‡´å†…å®¹å¦‚ä¸‹ï¼š</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">direct</span>&gt;</span>
 <span class="hljs-comment">&lt;!--Common Remote Services--&gt;</span>
  <span class="hljs-comment">&lt;!--DNS--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">priority</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"filter"</span> <span class="hljs-attr">ipv</span>=<span class="hljs-string">"ipv4"</span> <span class="hljs-attr">chain</span>=<span class="hljs-string">"FORWARD"</span>&gt;</span>-i tun0 -o ens192 -p udp --dport 53 -j ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span>
  <span class="hljs-comment">&lt;!--web--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">priority</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"filter"</span> <span class="hljs-attr">ipv</span>=<span class="hljs-string">"ipv4"</span> <span class="hljs-attr">chain</span>=<span class="hljs-string">"FORWARD"</span>&gt;</span>-i tun0 -o eth0 -p tcp -d 172.16.19.200 --dport 80 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">priority</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"filter"</span> <span class="hljs-attr">ipv</span>=<span class="hljs-string">"ipv4"</span> <span class="hljs-attr">chain</span>=<span class="hljs-string">"FORWARD"</span>&gt;</span>-i tun0 -o eth0 -p tcp -d 172.16.19.201 --dport 443 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span>
  <span class="hljs-comment">&lt;!--Some Other Systems--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">priority</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"filter"</span> <span class="hljs-attr">ipv</span>=<span class="hljs-string">"ipv4"</span> <span class="hljs-attr">chain</span>=<span class="hljs-string">"FORWARD"</span>&gt;</span>-i tun0 -o eth0 -p udp -d 172.16.19.100 --dport 7000 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span>
  <span class="hljs-comment">&lt;!--just logging--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rule</span> <span class="hljs-attr">priority</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">table</span>=<span class="hljs-string">"filter"</span> <span class="hljs-attr">ipv</span>=<span class="hljs-string">"ipv4"</span> <span class="hljs-attr">chain</span>=<span class="hljs-string">"FORWARD"</span>&gt;</span>-i tun0 -o eth0 -j LOG --log-prefix 'forward_fw '<span class="hljs-tag">&lt;/<span class="hljs-name">rule</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">direct</span>&gt;</span>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯´æ˜</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»æœ¬è´¨ä¸Šè®²ï¼Œè¿™äº›æ˜¯é€šå¸¸çš„iptablesè§„åˆ™ï¼Œå¦åˆ™åœ¨å‡ºç°firewalldä¹‹åæ‰“åŒ…ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é»˜è®¤è®¾ç½®ä¸‹çš„ç›®æ ‡æ¥å£æ˜¯tun0ï¼Œéš§é“çš„å¤–éƒ¨å¯èƒ½ä¸åŒï¼Œä¾‹å¦‚ens192ï¼Œå…·ä½“å–å†³äºæ‰€ä½¿ç”¨çš„å¹³å°ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€åä¸€è¡Œç”¨äºè®°å½•ä¸¢å¼ƒçš„æ•°æ®åŒ…ã€‚</font><font style="vertical-align: inherit;">ä¸ºäº†ä½¿æ—¥å¿—æ­£å¸¸å·¥ä½œï¼Œæ‚¨éœ€è¦åœ¨firewalldé…ç½®ä¸­æ›´æ”¹è°ƒè¯•çº§åˆ«ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">vim /etc/sysconfig/firewalld<font></font>
FIREWALLD_ARGS=--debug=2<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åº”ç”¨è®¾ç½®-å¸¸ç”¨çš„firewalldå‘½ä»¤é‡æ–°è¯»å–è®¾ç½®ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo firewall-cmd --reload</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸¢å¼ƒçš„æŠ¥æ–‡å¯ä»¥å¦‚ä¸‹æŸ¥çœ‹ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">grep forward_fw /var/<span class="hljs-built_in">log</span>/messages</code></pre><br>
<a name="next"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®¾ç½®å®Œæˆï¼</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®ƒä»ç„¶ä¿ç•™åœ¨å®¢æˆ·ç«¯ä¸Šï¼Œä»¥å®‰è£…å®¢æˆ·ç«¯è½¯ä»¶ï¼Œå¯¼å…¥é…ç½®æ–‡ä»¶å¹¶è¿›è¡Œè¿æ¥ã€‚</font><font style="vertical-align: inherit;">å¯¹äºWindowsä¹‹ç±»çš„æ“ä½œç³»ç»Ÿï¼Œå¯ä»¥åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¼€å‘äººå‘˜çš„ç«™ç‚¹</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸Šæ‰¾åˆ°è¯¥å‘è¡Œç‰ˆ</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ€»ä¹‹ï¼Œæˆ‘ä»¬å°†æ–°æœåŠ¡å™¨è¿æ¥åˆ°ç›‘è§†å’Œå½’æ¡£ç³»ç»Ÿï¼Œå¹¶ä¸”ä¸è¦å¿˜è®°å®šæœŸå®‰è£…æ›´æ–°ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿æ¥ç¨³å®šï¼</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN501034/index.html">IBMæ¯å‘¨ç ”è®¨ä¼š-2020å¹´5æœˆ</a></li>
<li><a href="../zh-CN501040/index.html">åº”ç”¨ç¨‹åºä¸­çš„å…¸å‹é”™è¯¯ä¼šå¯¼è‡´postgresqlè†¨èƒ€ã€‚å®‰å¾·çƒˆÂ·è¨å°”å°¼ç§‘å¤«ï¼ˆAndrey Salnikovï¼‰</a></li>
<li><a href="../zh-CN501042/index.html">Likbezå…³äºåˆè§„æ€§ï¼šæˆ‘ä»¬äº†è§£ç›‘ç®¡æœºæ„åœ¨ä¿¡æ¯å®‰å…¨é¢†åŸŸçš„è¦æ±‚</a></li>
<li><a href="../zh-CN501044/index.html">ĞĞµ Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚Ğµ Ğ»ÑĞ´ĞµĞ¹ Ğ·Ğ° Ğ¸Ğ´Ğ¸Ğ¾Ñ‚Ğ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº Ñ Ğ¸Ğ½Ğ¶ĞµĞ½ĞµÑ€Ğ½Ñ‹Ğ¼ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¶ĞµÑ‡ÑŒ Ğ²Ñ‹ÑˆĞºÑƒ ÑĞ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ ÑĞ²ÑĞ·Ğ¸ (Ğ²Ğ¸Ğ´ĞµĞ¾)</a></li>
<li><a href="../zh-CN501046/index.html">å›´ç»•ç¨³å›ºçš„ä¼˜åŠ¿ï¼šC ++ Russia 2019 Piterä¼šè®®çš„åå¤§æŠ¥å‘Š</a></li>
<li><a href="../zh-CN501050/index.html">å®‰è£…å¹¶æ¿€æ´»LabVIEWç¤¾åŒºç‰ˆ</a></li>
<li><a href="../zh-CN501052/index.html">ä¸­å›½å®‡å®™é£èˆ¹çš„å›å½’</a></li>
<li><a href="../zh-CN501056/index.html">ä¸ºä»€ä¹ˆï¼Œä½•æ—¶ä»¥åŠå¦‚ä½•åœ¨Pythonä¸­ä½¿ç”¨å¤šçº¿ç¨‹å’Œå¤šå¤„ç†</a></li>
<li><a href="../zh-CN501058/index.html">Teamcenterå¿«é€Ÿå¯åŠ¨è§£å†³æ–¹æ¡ˆå¯å¸®åŠ©å·¥ä¸šè®¾å¤‡åˆ¶é€ å•†å°†è®¾è®¡æ—¶é—´ç¼©çŸ­25ï¼…</a></li>
<li><a href="../zh-CN501060/index.html">5æœˆ13æ—¥è‡³14æ—¥ï¼ŒJetBrains .NETå¤©åœ¨çº¿</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>