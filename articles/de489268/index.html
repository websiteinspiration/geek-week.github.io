<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧜 👐🏿 🤛🏾 Implementierung des Prozesses zum Hochladen einer Datei aus einem Container mit einem Browser in ein Testframework ➰ 🧜🏿 👨🏿‍⚖️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Automatisierung von End-2-End-Tests eines integrierten Informationssystems 
 Teil 2-2. Implementieren des Prozesses zum Hochladen einer Datei aus eine...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Implementierung des Prozesses zum Hochladen einer Datei aus einem Container mit einem Browser in ein Testframework</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489268/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automatisierung von End-2-End-Tests eines integrierten Informationssystems </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Teil 2-2. </font><font style="vertical-align: inherit;">Implementieren des Prozesses zum Hochladen einer Datei aus einem Container mit einem Browser in ein Testframework. </font><font style="vertical-align: inherit;">Suchen Sie nach dem Namen der vom Browser heruntergeladenen Datei</font></font></h2><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autor: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/us/users/anrad</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hubs: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tags: #autotest, #selenium, #selenoid, #headlessbrowser, #download</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Als wir End-2-End-Autotests für die Benutzeroberfläche entwickelten, standen wir vor der Frage: „Wie erhalte ich den Namen des zuletzt geladenen </font><i><font style="vertical-align: inherit;">?</font></i><font style="vertical-align: inherit;"> Dateibrowser von WebDriver? ", Google hat nichts schnell erhalten. Deshalb habe ich diesen Artikel geschrieben, in dem gleichzeitig erklärt wurde, was genau wir ein Problem hatten und wie wir es gelöst haben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesem Artikel setzen wir eine Reihe von Veröffentlichungen darüber fort, wie wir den Prozess des manuellen Testens (im Folgenden als Autotests bezeichnet) eines großen Informationssystems (im Folgenden als Systeme bezeichnet) in einem der großen LANIT-Projekte automatisiert haben und was daraus entstanden ist. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/wz/lk/9wwzlkncoqwymqxqltqhcxatig0.jpeg" alt="Bild"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelle</font></font></i></a><br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Artikel selbst schließt den Zyklus ab. Unten finden Sie einen Link zu allen vorherigen Teilen: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Teil 1. Organisatorisch und verwaltungstechnisch. Warum brauchten wir Automatisierung? Organisation des Entwicklungs- und Managementprozesses. Nutzungsorganisation </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Teil 2. Technisch. Architektur und technischer Stack. Implementierungsdetails und technische Überraschungen </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Teil 2-1. Basisklassenimplementierung für alle Tests und JUnit RuleChain. </font></font><br>
<br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das war vor einem Jahr. Daher ist es heute möglicherweise nicht relevant. Schreiben Sie in die Kommentare, wenn Sie wissen, wie Sie Dateien mit mehreren Selenoid-Grid-Servern effizient verarbeiten können.</font></font></i></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Bei der Entwicklung von „Autotests“ hatten wir die Aufgabe, Dateien vom System herunterzuladen (herunterzuladen) und anschließend deren Inhalt zu analysieren. Um Dateien vom getesteten System hochzuladen, verwenden wir die folgenden Lösungen:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für den "lokalen" Startmodus (direkt auf dem Arbeits-PC starten) - Wenn der "lokale" Browser initialisiert wird, wird der Name des temporären lokalen Ordners als Parameter an ihn übergeben. </font><font style="vertical-align: inherit;">Als nächstes wird die Datei zur anschließenden Analyse direkt aus dem lokalen Ordner gelesen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">für "Remote" -Modus (über Bamboo) - Die Datei wurde mit dem Browser über die Solenoid-Serverfunktion aus dem Container "entnommen": </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selenoid-host.example.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 4444 / download / {SESSION_ID} / {FILE_NAME}</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Details sind in der Dokumentation beschrieben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für beide Modi musste der Name bekannt sein, um auf die Datei zugreifen zu können. </font><font style="vertical-align: inherit;">Das war eine Überraschung. </font><font style="vertical-align: inherit;">Das Problem des Mangels an Daten zum Namen der "Download" -Datei war wie folgt:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nach dem Klicken auf die Schaltfläche "Datei herunterladen" hat der Browser die Datei in den entsprechenden lokalen Ordner im Container heruntergeladen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In diesem Fall wurde der Dateiname dynamisch gebildet, und wie man ihn im Voraus bestimmt, konnten wir nicht finden. </font><font style="vertical-align: inherit;">Dies war ein Merkmal unseres Testsystems;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ferner sollte diese Datei aus dem Container „herausgezogen“ werden und eine geschäftliche Überprüfung ihres Inhalts durchgeführt werden.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um die Datei „herauszuziehen“, sollten Sie ihren Namen kennen, aber wir kannten den Namen nicht, da der Name dynamisch generiert wurde und der Link keinen Wert enthielt.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darüber hinaus wurde die Situation durch die Tatsache verschärft, dass aufgrund der großen Komplexität einiger Tests mehrere Dateien während des Tests als Teil verschiedener unabhängiger Testskripte aus der Zusammensetzung des Tests selbst entladen werden konnten. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die beste Lösung für uns war die Methode, mit der wir die zuletzt heruntergeladene Datei ermittelt haben. </font><font style="vertical-align: inherit;">Es gab verschiedene Möglichkeiten, dies zu tun:</font></font><br>
<ul>
<li>        .        .   ,    ;</li>
<li>    Google Chrome   javascript  chrome://downloads/,      html-.       .<br>
</li>
</ul><br>
<br>
<h3>      <br>
</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Analysieren der Zusammensetzung der vom Browser geladenen Dateien für den lokalen Modus ist eine triviale Aufgabe. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für den Remote-Modus müssen Sie die Funktion "undokumentiert" des Server-Selenoids verwenden: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selenoid-host.example.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 4444 / download / {SESSION_ID} zeigt eine Liste aller erfolgreich heruntergeladenen Dateien an, wobei SESSION_ID eine Selenoid-Sitzungs-ID ist. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen funktioniert das Schema mit einer Ausnahme: we Sie müssen eine Weile warten, bis die Datei heruntergeladen und in der Liste angezeigt wird. Die Wartezeit kann über einen Timeout-Zyklus eingestellt werden. Auf diese Weise können wir jedoch keine Informationen über einen möglichen Fehler beim Hochladen von Dateien erhalten. Wir können nur feststellen, dass die Datei in dieser Schaltung nicht geladen wurde. Daher haben wir uns am Ende für die Methode zur Bestimmung des Dateinamens über die Seite chrome: // downloads / entschieden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abrufen des Dateinamens über die chrome: // downloads / page</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Methode funktioniert sowohl im lokalen als auch im Remote-Modus gleich gut. </font><font style="vertical-align: inherit;">Das Arbeitsschema ist recht einfach:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Führen Sie das Java-Skript aus, um das Chrome-Fenster zu öffnen: // downloads /;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Daten im Fenster wie gewohnt verarbeiten. </font><font style="vertical-align: inherit;">Warten Sie, bis die erste Datei in der Liste geladen ist, und bestimmen Sie ihren Namen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schließen Sie das Fenster chrome: // downloads / und geben Sie den Namen der gesuchten Datei zurück.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben die Idee der Verwendung von chrome: // downloads / gegoogelt und leider kann ich keinen Link zur Quelle bereitstellen, da diese nicht kitschig erhalten wurde. </font><font style="vertical-align: inherit;">Die tatsächliche Implementierung der Klasse zum Abrufen des Dateinamens ist unten angegeben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Klasse, um den Namen der heruntergeladenen Datei über Chrome zu erhalten: // downloads /</font></font><br>
<pre><code class="java hljs">	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> DOWNLOADS_PAGE_LOAD_TIMEOUT = <span class="hljs-number">5_000</span>;
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> MAX_GET_FILE_NAME_ATTEMPT = <span class="hljs-number">5</span>;<font></font>
 <font></font>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getLastDownloadedFilename</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> DownloaderException </span>{<font></font>
        String[] filename = <span class="hljs-keyword">new</span> String[<span class="hljs-number">1</span>];<font></font>
        Exception[] ex = <span class="hljs-keyword">new</span> Exception[<span class="hljs-number">1</span>];<font></font>
        WebDriver driver = WebDriverRunner.getWebDriver();<font></font>
        JavascriptExecutor executor = (JavascriptExecutor) driver;<font></font>
        Utils.driver.openNewTabCheckAndClose(<font></font>
                () -&gt; {<font></font>
                    executor.executeScript(<span class="hljs-string">"window.open('','_blank');"</span>);<font></font>
                },<font></font>
                () -&gt; {<font></font>
                    driver.get(<span class="hljs-string">"chrome://downloads/"</span>);<font></font>
 <font></font>
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_GET_FILE_NAME_ATTEMPT; i++) {<font></font>
                    	ex[<span class="hljs-number">0</span>] = <span class="hljs-keyword">null</span>;<font></font>
                        sleep();<font></font>
                    	<span class="hljs-keyword">try</span> {<font></font>
                        	WebElement element = (WebElement) executor.executeScript(<font></font>
                                    <span class="hljs-string">"return document.querySelector('downloads-manager').shadowRoot.querySelector('downloads-item').shadowRoot.getElementById('file-link')"</span>);<font></font>
                        	filename[<span class="hljs-number">0</span>] = element.getText();<font></font>
                            LOGGER.info(<span class="hljs-string">"Attempt get file name "</span> + i + <span class="hljs-string">". Name = '"</span> + filename[<span class="hljs-number">0</span>] + <span class="hljs-string">"'"</span>);<font></font>
                    	} <span class="hljs-keyword">catch</span> (WebDriverException e) {<font></font>
                        	ex[<span class="hljs-number">0</span>] = e;<font></font>
                            LOGGER.info(<span class="hljs-string">"Failed attempt "</span>+ i + <span class="hljs-string">" to get filename text: "</span> + e.getMessage());
                        	<span class="hljs-keyword">continue</span>;<font></font>
                    	}<font></font>
                    	<span class="hljs-keyword">if</span> (filename[<span class="hljs-number">0</span>] != <span class="hljs-keyword">null</span> &amp;&amp; !filename[<span class="hljs-number">0</span>].isEmpty()) {
                        	 <span class="hljs-comment">//             </span><font></font>
                         	executor.executeScript(<font></font>
                                    <span class="hljs-string">"document.querySelector('downloads-manager').shadowRoot.querySelector('downloads-item').shadowRoot.getElementById('remove').click()"</span>);
                        	<span class="hljs-keyword">break</span>;<font></font>
                    	}<font></font>
                    }<font></font>
                }<font></font>
    	);<font></font>
 <font></font>
    	<span class="hljs-keyword">if</span> (filename[<span class="hljs-number">0</span>] != <span class="hljs-keyword">null</span> &amp;&amp; !filename[<span class="hljs-number">0</span>].isEmpty()) {
            <span class="hljs-keyword">return</span> filename[<span class="hljs-number">0</span>];<font></font>
    	}<font></font>
 <font></font>
    	String message = <span class="hljs-string">"Timeout. Can not get last downloaded file name from chrome://downloads/. File name is '"</span> + filename[<span class="hljs-number">0</span>] + <span class="hljs-string">"'. Exception: "</span> + ex[<span class="hljs-number">0</span>].getMessage();<font></font>
        LOGGER.warning(message);<font></font>
    	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> DownloaderException(message, ex[<span class="hljs-number">0</span>]);<font></font>
	}<font></font>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de489254/index.html">Hilft Yandex bei der Verbreitung von Malware?</a></li>
<li><a href="../de489256/index.html">Foundation Fieldbus Automation Systems</a></li>
<li><a href="../de489258/index.html">Wie werden sehr lange Ganzzahltypen in Python implementiert?</a></li>
<li><a href="../de489260/index.html">Entwerfen eines automatisierten Großsystems für ein großes Unternehmen in sieben Schritten</a></li>
<li><a href="../de489262/index.html">Warum es nicht einfach ist, Entwicklern Wahlfreiheit zu geben</a></li>
<li><a href="../de489270/index.html">WebAuthn im wirklichen Leben</a></li>
<li><a href="../de489272/index.html">Augen, Gehirn, Videoqualität: Reflexionen auf 120 fps, 8K, HDR, Zauberstäben, Zapfen und dem „Seifenoper-Effekt“</a></li>
<li><a href="../de489274/index.html">Bestätigen Sie Nachrichten in Tests</a></li>
<li><a href="../de489276/index.html">Bluttest auf Eisen - wie man den Spiegel kontrolliert, die Gründe diagnostiziert, warum es wichtig ist</a></li>
<li><a href="../de489280/index.html">Pingen Sie alle IPv6-Hosts auf dem Kanal an</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>