<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💛 👸 👊🏻 使用Spring Security和MongoDB进行REST API身份验证 🍮 💵 💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大家好！离开周末，我们将与您分享一篇文章，该文章在“ Spring Framework开发人员 ”课程开始之前进行了翻译。
 
 
 
 
 在之前的文章中，我们创建了RESTful网络服务，现在我们将讨论安全性
 
 介绍
 在上一篇文章中，我们研究了如何使用Java Spring Boot和Mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>使用Spring Security和MongoDB进行REST API身份验证</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/488418/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大家好！</font><font style="vertical-align: inherit;">离开周末，我们将与您分享一篇文章，该文章</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在“ Spring Framework开发人员</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”课程开始之前进行了翻译</font><font style="vertical-align: inherit;">。</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/gw/gb/2d/gwgb2dpgmnjnjyokarjzuleni3o.png"><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在之前的文章中，我们创建了RESTful网络服务，现在我们将讨论安全性</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在上一篇文章中，我们研究了如何使用Java Spring Boot和MongoDB框架创建REST API。</font><font style="vertical-align: inherit;">但是，该API不需要任何身份验证，这意味着它可能仍未准备好使用。</font><font style="vertical-align: inherit;">因此，本指南将向您展示如何使用Spring内置的安全性环境向此API添加身份验证级别。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么我们的API需要身份验证？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些API提供了一个用于与内部数据进行交互的简单接口，因此您不希望任何人有权访问此数据并进行更改是很有意义的。</font><font style="vertical-align: inherit;">身份验证可确保只有可信赖的用户才能访问API。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">怎么运行的</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本的HTTP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">身份验证，该身份验证使用用户名和密码。</font><font style="vertical-align: inherit;">用户名和密码以冒号分隔，格式如下</font></font><code>username:password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base64</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编码</font><font style="vertical-align: inherit;">对该行</font></font><code>admin:p@55w0Rd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行</font><font style="vertical-align: inherit;">编码</font><font style="vertical-align: inherit;">，因此该行将</font><font style="vertical-align: inherit;">在下一行进行编码</font></font><code>YWRtaW46cEA1NXcwUmQ=</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（尽管我建议使用比“ p @ 55w0Rd”更强的密码）。</font><font style="vertical-align: inherit;">我们可以通过添加标头将此身份验证附加到我们的请求</font></font><code>Authentication</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">上一个示例的标题如下所示（其中“基本”表示密码使用基本的HTTP身份验证）：</font></font><br>
<br>
<pre><code class="plaintext hljs">Authentication: Basic YWRtaW46cEA1NXcwUmQ=</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spring如何管理安全性</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring提供了一个名为</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Spring Security</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的加载项，该加载项</font><font style="vertical-align: inherit;">使身份验证高度可定制且非常简单。</font><font style="vertical-align: inherit;">设置时，我们甚至可以使用在上一篇文章中学到的一些技能！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们需要什么</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB实例中的一个新集合称为“用户”</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用户集合中的一个新文档，具有以下字段（任何其他字段都是可选的，但都是必需的）：用户名，密码（使用BCrypt算法散列，稍后再介绍）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上一篇文章的来源</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCrypt用于密码哈希</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
散列是一种单向加密算法。</font><font style="vertical-align: inherit;">实际上，经过哈希处理后，几乎不可能发现原始数据的样子。</font><font style="vertical-align: inherit;">BCrypt哈希算法首先将一段文本加盐，然后将其哈希为60个字符的字符串。</font><font style="vertical-align: inherit;">Java BCrypt编码器提供了一种</font></font><code>matches</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查字符串是否与哈希匹配的方法。</font><font style="vertical-align: inherit;">例如，</font></font><code>p@55w0Rd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用BCrypt散列</font><font style="vertical-align: inherit;">的密码</font><font style="vertical-align: inherit;">可能具有含义</font></font><code>$2b$10$Qrc6rGzIGaHpbgPM5kVXdeNZ9NiyRWC69Wk/17mttHKnDR2lW49KS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">当调用</font></font><code>matches</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCrypt </font><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">以获取未加密和散列的密码时，我们得到一个value </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">可以使用Spring Security内置的BCrypt编码器生成这些哈希。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么要对密码进行哈希处理？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们都听说过最近的网络攻击，这些攻击导致大公司的密码被盗。</font><font style="vertical-align: inherit;">那么，为什么只建议在黑客入侵后更改我们的密码？</font><font style="vertical-align: inherit;">因为这些大公司确保密码始终在其数据库中散列！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尽管在此类数据被黑客入​​侵后总是值得更改密码，但由于密码哈希是一种单向算法，因此很难找到用户的真实密码。</font><font style="vertical-align: inherit;">实际上，</font><font style="vertical-align: inherit;">破解散列正确的复杂密码</font><font style="vertical-align: inherit;">可能需要数</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">年时间</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这为防止密码被盗提供了更高级别的保护。</font><font style="vertical-align: inherit;">Spring Security简化了哈希处理，因此真正的问题应该是：“为什么不呢？”</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">向MongoDB添加用户</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我将添加集合所需的最少字段</font></font><code>users</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（用户），因此数据库中包含用户的文档将仅包含</font></font><code>username</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（用户名）和哈希BCrypt </font></font><code>password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（密码）。</font><font style="vertical-align: inherit;">在此示例中，我的用户名将为</font></font><code>admin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，密码将为</font></font><code>welcome1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但我建议在生产级API中使用更可靠的用户名和密码。</font></font><br>
<br>
<pre><code class="java hljs">db.users.insert({<font></font>
  “username” : “admin”,<font></font>
  “password” : “$<span class="hljs-number">2</span>a$<span class="hljs-number">10</span>$AjHGc4x3Nez/p4ZpvFDWeO6FGxee/cVqj5KHHnHfuLnIOzC5ag4fm”<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些是MongoDB中所需的所有设置！</font><font style="vertical-align: inherit;">其余的配置将在我们的Java代码中完成。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加用户模型和存储库</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上一篇文章详细介绍了Mongo的模型和存储库，因此在这里我不会详细介绍它们的工作方式-如果您想刷新自己的知识，请随时访问我的上一篇文章！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
缺点是Spring需要知道文档</font></font><code>user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（模型）的</font><font style="vertical-align: inherit;">外观</font><font style="vertical-align: inherit;">以及如何访问</font></font><code>user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据库（存储库）中</font><font style="vertical-align: inherit;">的集合</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我们可以将这些文件分别放在模型和存储库的同一文件夹中，就像在上一个练习中一样。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该模型将是Java基础类定制</font></font><code>_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>username</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该文件将被命名为</font></font><code>Users.java</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">看起来像这样：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">package</span> com.example.gtommee.rest_tutorial.models;<font></font>
<font></font>
<span class="hljs-keyword">import</span> org.bson.types.ObjectId;
<span class="hljs-keyword">import</span> org.springframework.data.annotation.Id;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Users</span> </span>{
  <span class="hljs-meta">@Id</span>
  <span class="hljs-keyword">public</span> ObjectId _id;<font></font>
<font></font>
  <span class="hljs-keyword">public</span> String username;
  <span class="hljs-keyword">public</span> String password;<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Users</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Users</span><span class="hljs-params">(ObjectId _id, String username, String password)</span> 
</span>{
    <span class="hljs-keyword">this</span>._id = _id;
    <span class="hljs-keyword">this</span>.username = username;
    <span class="hljs-keyword">this</span>.password = password;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set_id</span><span class="hljs-params">(ObjectId _id)</span> </span>{ <span class="hljs-keyword">this</span>._id = _id; }<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">get_id</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._id.toHexString(); }<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPassword</span><span class="hljs-params">(String password)</span> </span>{ <span class="hljs-keyword">this</span>.password = password; }<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPassword</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> password; }<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>{ <span class="hljs-keyword">this</span>.username = username; }<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> username; }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">资料库</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
系统将调用存储库，其</font></font><code>UsersRepository.java</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">外观将如下所示-记住，我们需要按用户查找用户</font></font><code>username</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因此我们需要</font></font><code>findByUsername</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在存储库接口中</font><font style="vertical-align: inherit;">包含方法</font><font style="vertical-align: inherit;">。</font></font><br>
 <br>
<pre><code class="java hljs"><span class="hljs-keyword">package</span> com.example.gtommee.rest_tutorial.repositories;<font></font>
<font></font>
<span class="hljs-keyword">import</span> com.example.gtommee.rest_tutorial.models.Users;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UsersRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MongoRepository</span>&lt;<span class="hljs-title">Users</span>, <span class="hljs-title">String</span>&gt; </span>{
  <span class="hljs-function">Users <span class="hljs-title">findByUsername</span><span class="hljs-params">(String username)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是模型和存储库！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加安全依赖性</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
项目的根目录中应该有一个带有名称的文件</font></font><code>pom.xml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我们尚未触及该文件，但是pom文件包含了我们项目的所有依赖关系，我们将添加其中的几个依赖关系，因此让我们从打开该文件并向下滚动到tag开始</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
我们需要的唯一新依赖关系是</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">spring-starter-security</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Spring有一个内置的版本管理器，因此我们必须添加到标签中的依赖项</font><font style="vertical-align: inherit;">如下：</font></font><code><code>&lt;</code>dependencies<code>&gt;</code></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code><code>&lt;</code>dependencies<code>&gt;</code></code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="java hljs">&lt;dependency&gt;<font></font>
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<font></font>
  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;<font></font>
&lt;/dependency&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
而且Maven将为我们下载源文件，因此我们的依赖项必须准备就绪！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建身份验证服务</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们需要告诉Spring我们的用户数据在哪里以及在哪里找到身份验证所需的信息。</font><font style="vertical-align: inherit;">为此，我们可以创建一个身份验证服务（Authentication Service）。</font><font style="vertical-align: inherit;">让我们从在</font></font><code>src/main/resources/java/[package name]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">称为services </font><font style="vertical-align: inherit;">的新文件夹开始</font><font style="vertical-align: inherit;">，然后我们可以在该配置文件夹中使用name创建一个新文件</font></font><code>MongoUserDetailsService.java</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoUserDetailsS​​ervice.java</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该课程有一个主要组成部分，因此我将在此处提供整个课程，然后在下面进行解释：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">package</span> com.example.gtommee.rest_tutorial.services;<font></font>
<font></font>
<span class="hljs-keyword">import</span> com.example.gtommee.rest_tutorial.models.Users;
<span class="hljs-keyword">import</span> com.example.gtommee.rest_tutorial.repositories.UsersRepository;<font></font>
<font></font>
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;
<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;
<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;
<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;
<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<font></font>
<font></font>
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.List;<font></font>
<font></font>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MongoUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span></span>{
  <span class="hljs-meta">@Autowired</span>
  <span class="hljs-keyword">private</span> UsersRepository repository;<font></font>
<font></font>
  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>{<font></font>
    Users user = repository.findByUsername(username);<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(user == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UsernameNotFoundException(“User not found”);<font></font>
    }<font></font>
<font></font>
    List&lt;SimpleGrantedAuthority&gt; authorities = Arrays.asList(<span class="hljs-keyword">new</span> SimpleGrantedAuthority(“user”));<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(user.getUsername(), user.getPassword(), authorities);<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此代码段从文件中所需的导入开始。此外，该部分</font></font><code>implements UserDetailsService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指示该类将创建用于搜索和验证用户的服务。然后，注释</font></font><code>@Component</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指示该类可以嵌入到另一个文件中（例如，SecurityConfiguration文件，我们将通过几个部分进行介绍）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注释</font></font><code>@Autowired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结束</font></font><code>private UsersRepository repository</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;是实现的示例，此属性为我们提供了</font></font><code>UsersRepository</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">工作</font><font style="vertical-align: inherit;">实例</font><font style="vertical-align: inherit;">。注释</font></font><code>@Override</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指示将使用此方法代替默认的UserDetailsS​​ervice方法。首先，此方法</font></font><code>Users</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font><code>findByUsername</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们在中声明</font><font style="vertical-align: inherit;">的方法从MongoDB数据源</font><font style="vertical-align: inherit;">获取对象</font></font><code>UsersRepository</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，该方法检查是否找到了用户。</font><font style="vertical-align: inherit;">然后，向用户授予权限/角色（这可以为访问级别添加其他身份验证级别，但是一个角色足以完成本课程）。</font><font style="vertical-align: inherit;">最后，该方法返回一个Spring对象</font></font><code>User</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有</font></font><code>username</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>password</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>role</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">身份验证的用户。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建安全配置</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将需要重新定义一些Spring的内置安全协议以使用我们的数据库和哈希算法，因此我们需要一个特殊的配置文件。</font><font style="vertical-align: inherit;">要创建它，我们必须创建一个新的文件夹</font></font><code>src/main/resources/java/[package name]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的名称</font></font><code>config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我们还需要在名为此配置文件夹中创建一个新的文件</font></font><code>SecurityConfiguration.java</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该文件包含几个重要部分，因此让我们从SecurityConfiguration基类开始：</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SecurityConfiguration.java</font></font></h4><br>
<pre><code class="java hljs"><span class="hljs-keyword">package</span> com.example.gtommee.rest_tutorial.config;<font></font>
<font></font>
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<font></font>
<font></font>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableConfigurationProperties</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>{
 <span class="hljs-meta">@Autowired</span><font></font>
 MongoUserDetailsService userDetailsService;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
已经有足够的东西要处理了，所以让我们从上面开始。</font><font style="vertical-align: inherit;">注释</font></font><code>@Configuration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指示该类将包含Java Bean，在此进行详细描述。</font><font style="vertical-align: inherit;">注释</font></font><code>@EnableConfigurationProperties</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指示该类将包含为特殊配置Bean的内容。</font><font style="vertical-align: inherit;">然后，该指令会将</font></font><code>extends WebSecurityConfigurerAdapter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">父类映射</font></font><code>WebSecurityConfigurerAdapter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到我们的</font><font style="vertical-align: inherit;">配置类</font><font style="vertical-align: inherit;">，为我们的类提供确保其安全性规则得到遵守的一切必要条件。</font><font style="vertical-align: inherit;">最后，该类将自动注入一个实例（</font></font><code>@Autowired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font><code>MongoUserDetailsService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我们稍后可以在该文件中使用它。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">认证步骤</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，我们需要告诉Spring Security我们要如何处理用户身份验证。默认情况下，Spring Security具有预定义的用户名和密码，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSRF保护</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">会话管理</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。但是，我们希望用户使用其用户名和密码来访问数据库。另外，由于将在每次请求时都对用户进行重新身份验证，而不是登录，因此我们不需要CSRF保护和会话管理，因此我们可以添加名称</font></font><code>configure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">覆盖默认身份验证方案的方法来确切地告诉Spring。我们要处理身份验证，如下所示：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
 http<font></font>
   .csrf().disable()<font></font>
   .authorizeRequests().anyRequest().authenticated()<font></font>
   .and().httpBasic()<font></font>
   .and().sessionManagement().disable();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同样，这里发生了很多事情，因此我们将分阶段进行整理。</font><font style="vertical-align: inherit;">注释</font></font><code>@Override</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">告诉Spring Boot使用该方法</font></font><code>configure (HttpSecurity http)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代替默认的Spring配置。</font><font style="vertical-align: inherit;">然后，我们为</font></font><code>http</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实际配置发生</font><font style="vertical-align: inherit;">的对象调用一系列方法</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些方法执行以下操作：</font></font><br>
<br>
<ul>
<li><code>csrf().disable()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：禁用CSRF保护，因为API不需要它</font></font></li>
<li><code>authorizeRequests().anyRequest().authenticated()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：声明对任何端点的所有请求都必须得到授权，否则必须被拒绝。</font></font></li>
<li><code>and().httpBasic():  Spring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，它需要基本的HTTP身份验证（如上所述）。</font></font></li>
<li><code>.and().sessionManagement().disable()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：告诉Spring不要为用户存储会话信息，因为API不需要这样做</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加一个Bcrypt编码器</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们需要告诉Spring使用BCrypt编码器来散列和比较密码-这听起来很困难，但实际上非常简单。</font><font style="vertical-align: inherit;">我们可以通过简单地将以下行添加到我们的类中来添加此编码器</font></font><code>SecurityConfiguration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Bean</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>{
   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
和所有的工作！</font><font style="vertical-align: inherit;">这个简单的bean告诉Spring我们要使用的PasswordEncoder是Spring Boot </font></font><code>BCryptPasswordEncoder()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来编码和比较密码哈希。</font><font style="vertical-align: inherit;">Spring Boot还包括其他几种密码编码器-如果您想尝试的话，建议您尝试使用它们！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定身份验证管理器</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最后，我们必须在我们的代码中</font></font><code>SecurityConfiguration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指出我们要使用</font></font><code>MongoUserDetailsService</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（在上一节中创建的）身份验证。</font><font style="vertical-align: inherit;">我们可以使用以下方法做到这一点：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> 
<span class="hljs-keyword">throws</span> Exception </span>{<font></font>
  builder.userDetailsService(userDetailsService);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此方法仅覆盖默认配置</font></font><code>AuthenticationManagerBuilder</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，而是替换我们自己的自定义数据传输服务。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最终的SecurityConfiguration.java文件</font></font></h3><br>
<pre><code class="java hljs"><span class="hljs-keyword">import</span> com.example.gtommee.rest_tutorial.services.MongoUserDetailsService;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;
<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
<span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
<span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;<font></font>
<font></font>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableConfigurationProperties</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>{
 <span class="hljs-meta">@Autowired</span><font></font>
 MongoUserDetailsService userDetailsService;<font></font>
<font></font>
 <span class="hljs-meta">@Override</span>
 <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>{<font></font>
   http<font></font>
     .csrf().disable()<font></font>
     .authorizeRequests().anyRequest().authenticated()<font></font>
     .and().httpBasic()<font></font>
     .and().sessionManagement().disable();<font></font>
 }<font></font>
<font></font>
 <span class="hljs-meta">@Bean</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>{
   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();<font></font>
 }<font></font>
<font></font>
 <span class="hljs-meta">@Override</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthenticationManagerBuilder builder)</span> 
<span class="hljs-keyword">throws</span> Exception </span>{<font></font>
   builder.userDetailsService(userDetailsService);<font></font>
 }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">验证检查</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我将</font></font><code>GET</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用有效和错误的身份验证来</font><font style="vertical-align: inherit;">测试快速</font><font style="vertical-align: inherit;">请求，以确保配置按计划进行。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不正确的用户名/密码</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
URL：</font></font><code>http://localhost:8080/pets/</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
方法：</font></font><code>GET</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
登录：</font></font><code>Basic YWRtaW46d2VsY29tZQ==</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回复：</font></font><br>
<br>
<pre><code class="plaintext hljs">401 Unauthorized</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有效的用户名/密码</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
URL：</font></font><code>http://localhost:8080/pets/</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
方法：</font></font><code>GET</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
登录：</font></font><code>Basic YWRtaW46d2VsY29tZTE=</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回复：</font></font><br>
<br>
<pre><code class="java hljs">[<font></font>
 {<font></font>
   “_id”: “<span class="hljs-number">5</span>aeccb0a18365ba07414356c”,<font></font>
   “name”: “Spot”,<font></font>
   “species”: “dog”,<font></font>
   “breed”: “pitbull”<font></font>
 },<font></font>
 {<font></font>
   “_id”: “<span class="hljs-number">5</span>aeccb0a18365ba07414356d”,<font></font>
   “name”: “Daisy”,<font></font>
   “species”: “cat”,<font></font>
   “breed”: “calico”<font></font>
 },<font></font>
 {<font></font>
   “_id”: “<span class="hljs-number">5</span>aeccb0a18365ba07414356e”,<font></font>
   “name”: “Bella”,<font></font>
   “species”: “dog”,<font></font>
   “breed”: “australian shepard”<font></font>
 }<font></font>
]</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它可以正常工作！</font><font style="vertical-align: inherit;">Spring Boot API的基本HTTP身份验证可能很棘手，但是希望本指南将有助于使其更加易懂。</font><font style="vertical-align: inherit;">在当今的网络环境中，身份验证是必须的，因此诸如Spring Security之类的工具对于确保数据的完整性和安全性至关重要。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">就这样！</font><font style="vertical-align: inherit;">在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">课程</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上与我见面</font><font style="vertical-align: inherit;">。</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN488406/index.html">IPv6-您做错了</a></li>
<li><a href="../zh-CN488408/index.html">STM32以太网-RS485 IoT网关</a></li>
<li><a href="../zh-CN488410/index.html">我在十年的发展中学到的7课</a></li>
<li><a href="../zh-CN488412/index.html">基于discord.js创建Discord机器人</a></li>
<li><a href="../zh-CN488416/index.html">SLAE-安全性Linux组装专家考试</a></li>
<li><a href="../zh-CN488422/index.html">10行代码可减轻您的Vue项目的痛苦</a></li>
<li><a href="../zh-CN488424/index.html">2020年ITSM将会发生什么？</a></li>
<li><a href="../zh-CN488426/index.html">如何进行代码审查？第2部分：查看导航，速度，评论，冲突</a></li>
<li><a href="../zh-CN488428/index.html">我们如何预测Yandex搜索的未来：从错误修复到发现查询</a></li>
<li><a href="../zh-CN488432/index.html">Snoop Project是Internet情报不可思议的工具，RuNet用户已经等待了很长时间-已提供</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>