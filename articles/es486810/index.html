<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòô üë®‚Äçüë¶ ‚õèÔ∏è Nueva interfaz de Odnoklassniki: lanzamiento de React en Java. Parte II üë©‚Äçüíº üë©‚Äçüè´ üôå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuamos la historia de c√≥mo, dentro de Odnoklassniki, con la ayuda de GraalVM, logramos hacer amigos con Java y JavaScript y comenzar a migrar a u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nueva interfaz de Odnoklassniki: lanzamiento de React en Java. Parte II</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/486810/"><img src="https://habrastorage.org/webt/sz/_g/7x/sz_g7xhw5t9siczpovdjhzzsgru.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Continuamos la historia de c√≥mo, dentro de Odnoklassniki, con la ayuda de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GraalVM,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> logramos hacer amigos con Java y JavaScript y comenzar a migrar a un gran sistema con mucho c√≥digo heredado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la segunda parte del art√≠culo, hablaremos en detalle sobre el lanzamiento, el ensamblaje y la integraci√≥n de aplicaciones en la nueva pila, profundizaremos en los detalles de su trabajo tanto en el cliente como en el servidor, as√≠ como discutiremos las dificultades encontradas en nuestro camino y describiremos soluciones para ayudarlos a superar . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si no has le√≠do la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primera parte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomiendo mucho hacer esto. </font><font style="vertical-align: inherit;">A partir de √©l, aprender√° sobre la historia de la interfaz en Odnoklassniki y se familiarizar√° con sus caracter√≠sticas hist√≥ricas, recorrer√° el camino para encontrar una soluci√≥n a los problemas que se han acumulado en nuestros 13 a√±os de proyecto, y al final se sumergir√° en las caracter√≠sticas t√©cnicas de la implementaci√≥n del servidor de la decisi√≥n que tomamos.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de la interfaz de usuario</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para escribir el c√≥digo de la interfaz de usuario, elegimos las herramientas m√°s avanzadas: reaccionar junto con MobX, m√≥dulos CSS, ESLint, TypeScript, Lerna. </font><font style="vertical-align: inherit;">Todo esto se recopila utilizando Webpack.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ed/tp/gx/edtpgxyuy6rxy4nvalwn_dhhkva.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitectura de la aplicaci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se escribi√≥ en la parte anterior de este art√≠culo, para implementar la migraci√≥n gradual, insertaremos nuevos componentes en el sitio en elementos DOM con nombres personalizados que funcionar√°n dentro de la nueva pila de interfaz de usuario, mientras que para el resto del sitio se ver√° como un elemento DOM con su API El contenido de estos elementos se puede representar en el servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© es? En el interior hay una aplicaci√≥n MVC moderna, moderna y moderna que se ejecuta en React y proporciona la API DOM externa est√°ndar: atributos, m√©todos en este elemento DOM y eventos.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/fg/um/dw/fgumdwotb43klsvwwtlvx4x1bd4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ejecutar dichos componentes, hemos desarrollado un mecanismo especial. ¬øQu√© est√° haciendo? En primer lugar, inicializa la aplicaci√≥n seg√∫n su descripci√≥n. En segundo lugar, vincula el componente al nodo DOM espec√≠fico en el que se inicia. Tambi√©n hay dos motores (para el cliente y para el servidor) que pueden encontrar y representar estos componentes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ln/dg/wz/lndgwzg5ggcfgsnnsfdnrdmue8u.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPor qu√© se necesita esto? El hecho es que cuando todo el sitio se crea en React, generalmente el componente del sitio se representa en el elemento ra√≠z de la p√°gina, y este componente no importa lo que est√° afuera, pero solo lo que est√° adentro es interesante.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En nuestro caso, todo es m√°s complicado: varias aplicaciones necesitan la oportunidad de decirle a nuestra p√°gina en el sitio "Estoy, y algo est√° cambiando en m√≠". Por ejemplo, el calendario necesita lanzar un evento en el que el usuario hizo clic en el bot√≥n, y la fecha ha cambiado, o afuera necesita la habilidad para que dentro del calendario pueda cambiar la fecha. Para esto, el motor de la aplicaci√≥n implementa fachadas en la funcionalidad b√°sica de la aplicaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al entregar un componente a un cliente, es necesario que el motor del sitio anterior pueda iniciar este componente. Para hacer esto, durante la compilaci√≥n, se recopila la informaci√≥n necesaria para su lanzamiento.</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"events-calendar"</span>: {
        <span class="hljs-attr">"bundleName"</span>: <span class="hljs-string">"events-calendar"</span>,
        <span class="hljs-attr">"js"</span>: <span class="hljs-string">"events-calendar-h4h5m.js"</span>,
        <span class="hljs-attr">"css"</span>: <span class="hljs-string">"events-calendar-h4h5m.css"</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se agregan marcadores especiales a los atributos de la etiqueta del componente, que dicen que esta aplicaci√≥n es de un nuevo tipo, su c√≥digo se puede tomar de un archivo JS espec√≠fico. </font><font style="vertical-align: inherit;">Al mismo tiempo, tiene sus propios atributos que son necesarios para inicializar este componente: forman el estado inicial del componente en la tienda.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">events-calendar</span>	<span class="hljs-attr">data-module</span>=<span class="hljs-string">"react-loader"</span>
			<span class="hljs-attr">data-bundle</span>=<span class="hljs-string">"events-calendar.js"</span>
			<span class="hljs-attr">date</span>=<span class="hljs-string">".."</span>
			<span class="hljs-attr">marks</span>=<span class="hljs-string">"[{..}]"</span>
			‚Ä¶
/&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para la rehidrataci√≥n, no se utiliza un reparto del estado de la aplicaci√≥n, sino atributos, lo que permite ahorrar en el tr√°fico. </font><font style="vertical-align: inherit;">Vienen en forma normalizada y, como regla, son m√°s peque√±os que la tienda que crea la aplicaci√≥n. </font><font style="vertical-align: inherit;">Al mismo tiempo, el tiempo para recrear la tienda a partir de los atributos en el cliente es corto, por lo que generalmente se pueden descuidar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, para el calendario, los atributos solo tienen una fecha resaltada, y la tienda ya tiene una matriz con informaci√≥n completa para el mes. </font><font style="vertical-align: inherit;">Obviamente, no tiene sentido transferirlo desde el servidor.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øC√≥mo ejecutar el c√≥digo?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El concepto se prob√≥ en funciones simples que dan una l√≠nea para el servidor o escriben innerHTML para el cliente. Pero en el c√≥digo real hay m√≥dulos y TypeScript. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existen soluciones est√°ndar para el cliente, por ejemplo, la recopilaci√≥n de c√≥digo mediante Webpack, que en s√≠ mismo lo tritura todo y se lo entrega al cliente en forma de un paquete de paquetes. ¬øY qu√© hacer para el servidor cuando se usa GraalVM?</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/sr/f7/yn/srf7ynd8airmxgybkgu4wnpe82c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consideremos dos opciones. El primero es escribir TypeScript en JavaScript, como lo hacen para Node.js. Desafortunadamente, esta opci√≥n no funciona en nuestra configuraci√≥n cuando JavaScript es el idioma invitado en GraalVM. En este caso, JavaScript no tiene un sistema modular, ni siquiera asincr√≥nico. Porque la modularidad y el trabajo con asincron√≠a proporciona un tiempo de ejecuci√≥n espec√≠fico: NodeJS o un navegador. Y en nuestro caso, el servidor tiene JavaScript que solo puede ejecutar c√≥digo sincr√≥nicamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La segunda opci√≥n: simplemente puede ejecutar el c√≥digo del servidor desde los mismos archivos que se recopilaron para el cliente. Y esta opci√≥n funciona. Pero existe el problema de que el servidor necesita otras implementaciones para varios m√©todos. Por ejemplo, la funci√≥n renderToString () se llamar√° en el servidor para representar el componente y ReactDOM.render () en el cliente. O otro ejemplo del art√≠culo anterior: para obtener textos y configuraciones en el servidor, se llamar√° a la funci√≥n que proporciona Java, y en el cliente ser√° una implementaci√≥n en JS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como soluci√≥n a este problema, puede usar alias de Webpack. Le permiten crear dos implementaciones de la clase que necesitamos: para el cliente y el servidor. Luego, en los archivos de configuraci√≥n para el cliente y el servidor, especifique la implementaci√≥n adecuada.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/rb/0o/carb0o0rvb1q0pw8eerxnsy4ova.jpeg"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero dos archivos de configuraci√≥n son dos ensamblajes. </font><font style="vertical-align: inherit;">Cada vez, recopilar todo por separado para el servidor y para el cliente es largo y dif√≠cil de soportar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debe crear dicha configuraci√≥n para que todo se recopile de una vez.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n del paquete web para ejecutar JS en el servidor y el cliente</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para encontrar una soluci√≥n a este problema, veamos en qu√© partes consiste el proyecto: </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/zh/mi/e9/zhmie9o6zghd5vgeyd10pjonffq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, el proyecto tiene tiempo de ejecuci√≥n de terceros (proveedores), lo mismo para el cliente y para el servidor. </font><font style="vertical-align: inherit;">Casi nunca cambia. </font><font style="vertical-align: inherit;">Rantime se puede dar al usuario, y se almacenar√° en cach√© en el cliente hasta que actualicemos la versi√≥n de la biblioteca de terceros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En segundo lugar, est√° nuestro tiempo de ejecuci√≥n (n√∫cleo), que garantiza el lanzamiento de la aplicaci√≥n. </font><font style="vertical-align: inherit;">Tiene m√©todos con diferentes implementaciones para el cliente y el servidor. </font><font style="vertical-align: inherit;">Por ejemplo, obtener textos de localizaci√≥n, configuraciones, etc. </font><font style="vertical-align: inherit;">Este tiempo de ejecuci√≥n tambi√©n cambia con poca frecuencia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En tercer lugar, hay un c√≥digo de componente. </font><font style="vertical-align: inherit;">Es lo mismo para el cliente y para el servidor, lo que le permite depurar el c√≥digo de la aplicaci√≥n en el navegador sin iniciar el servidor. </font><font style="vertical-align: inherit;">Si algo sali√≥ mal en el cliente, puede ver los errores en la consola del navegador, recordar todo y asegurarse de que no habr√° errores al iniciar en el servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En total, se obtienen tres partes que deben ensamblarse. </font><font style="vertical-align: inherit;">Queremos:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure por separado el ensamblaje de cada parte.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anote las dependencias entre ellos para que cada parte no caiga en lo que est√° en la otra.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recoge todo en una sola pasada.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo describir por separado las partes en que consistir√° el ensamblaje? </font><font style="vertical-align: inherit;">Hay una configuraci√≥n m√∫ltiple en el paquete web: simplemente regala una serie de exportaciones de los m√≥dulos incluidos en cada parte.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">module</span>.exports = [{
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./vendors.js'</span>,<font></font>
}, {<font></font>
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./core.js'</span><font></font>
}, {<font></font>
 <span class="hljs-attr">entry</span>: <span class="hljs-string">'./app.js'</span><font></font>
}];<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo estar√≠a bien, pero en cada una de estas partes se duplicar√° el c√≥digo de los m√≥dulos de los que depende esta parte: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ut/am/ax/utamaxl7z4op6x8iivfcmufn7ec.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afortunadamente, en el conjunto b√°sico de complementos de paquete web hay </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DllPlugin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que le permite obtener una lista de los m√≥dulos incluidos para cada parte ensamblada. Por ejemplo, para el proveedor, puede averiguar qu√© m√≥dulos espec√≠ficos se incluyen en esta parte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al construir otra parte, por ejemplo, bibliotecas centrales, podemos decir que dependen de la parte del proveedor. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/nv/lu/el/nvluelzxzvy_5oofujylu4wmufk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, durante el ensamblaje del paquete web, DllPlugin ver√° el n√∫cleo dependiendo de alguna biblioteca que ya est√© en el proveedor, y no lo agregar√° al n√∫cleo, sino que simplemente le pondr√° un enlace.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, se ensamblan tres piezas a la vez y dependen unas de otras. </font><font style="vertical-align: inherit;">Cuando la primera aplicaci√≥n se descarga al cliente, las bibliotecas principales y de tiempo de ejecuci√≥n se guardar√°n en la memoria cach√© del navegador. </font><font style="vertical-align: inherit;">Y dado que Odnoklassniki es un sitio, la pesta√±a con la que el usuario puede abrir "para siempre", el desplazamiento se producir√° muy raramente. </font><font style="vertical-align: inherit;">En la mayor√≠a de los casos, con lanzamientos de nuevas versiones del sitio, solo se actualizar√° el c√≥digo de la aplicaci√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entrega de recursos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere el problema con el ejemplo de trabajar con textos localizados que se almacenan en una base de datos separada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si anteriormente en alg√∫n lugar del servidor necesitaba texto en el componente, podr√≠a llamar a la funci√≥n para obtener el texto.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> pkg = l10n(<span class="hljs-string">'smiles'</span>);<font></font>
<font></font>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    : { pkg.getText('title') }
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obtener texto en el servidor no es dif√≠cil, porque la aplicaci√≥n del servidor puede realizar una solicitud r√°pida a la base de datos o incluso almacenar en cach√© todos los textos en la memoria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo obtener textos en componentes en una reacci√≥n que se representan en un servidor en GraalVM? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se discuti√≥ en la primera parte del art√≠culo, en el contexto JS, puede agregar m√©todos al objeto global al que desea acceder desde JavaScript. </font><font style="vertical-align: inherit;">Se decidi√≥ hacer una clase con todos los m√©todos disponibles para JavaScript.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ServerMethods</span> </span>{<font></font>
    ‚Ä¶<font></font>
    <font></font>
    <span class="hljs-comment">/**
     *     
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getText</span><span class="hljs-params">(String pkg, String key)</span> </span>{<font></font>
        ‚Ä¶<font></font>
    }<font></font>
    <font></font>
    ‚Ä¶<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego ponga una instancia de esta clase en el contexto global de JavaScript:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//     Java   </span>
js.putMember(<span class="hljs-string">"serverMethods"</span>, serverMethods);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, desde JavaScript en la implementaci√≥n del servidor, simplemente llamamos a la funci√≥n:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getText</span>(<span class="hljs-params">pkg: string, key: string</span>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-keyword">return</span> global.serverMethods.getText(pkg, key);<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, esta ser√° una llamada de funci√≥n en Java que devolver√° el texto solicitado. Interacci√≥n s√≠ncrona directa y sin llamadas HTTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desafortunadamente, en el cliente, lleva mucho tiempo revisar HTTP y recibir textos para cada llamada a la funci√≥n de inserci√≥n de texto en los componentes. Puede descargar previamente todos los textos al cliente, pero solo los textos pesan decenas de megabytes, y existen otros tipos de recursos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lg/6e/ij/lg6eijxb_rvzshqiyih2gyuvy5a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El usuario se cansar√° de esperar hasta que todo se descargue antes de iniciar la aplicaci√≥n. Por lo tanto, este m√©todo no es adecuado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me gustar√≠a recibir solo los textos que se necesitan en una aplicaci√≥n en particular. Nuestros textos se dividen en paquetes. Por lo tanto, puede recopilar los paquetes necesarios para la aplicaci√≥n y descargarlos junto con el paquete. Cuando se inicia la aplicaci√≥n, todos los textos ya estar√°n en la memoria cach√© del cliente.</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo saber qu√© textos necesita una aplicaci√≥n? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acordamos que los paquetes de textos en el c√≥digo se obtienen llamando a la funci√≥n l10n (), en la cual el nombre del paquete se transmite SOLAMENTE en forma de un literal de cadena:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> pkg = l10n(<span class="hljs-string">'smiles'</span>);<font></font>
<font></font>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    { pkg.getLMsg('title') }
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escribimos un complemento de paquete web que, al analizar el √°rbol AST del c√≥digo de componente, encuentra todas las llamadas a la funci√≥n l10n () y recopila nombres de paquetes de los argumentos. </font><font style="vertical-align: inherit;">Del mismo modo, el complemento recopila informaci√≥n sobre otros tipos de recursos que necesita la aplicaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la salida despu√©s del ensamblaje para cada aplicaci√≥n, obtenemos una configuraci√≥n con sus recursos:</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"events-calendar"</span>: {
       <span class="hljs-attr">"pkg"</span>:  [
           <span class="hljs-string">"calendar"</span>,
           <span class="hljs-string">"dates"</span><font></font>
       ],<font></font>
       <span class="hljs-attr">"cfg"</span>:  [
           <span class="hljs-string">"config1"</span>,
           <span class="hljs-string">"config2"</span><font></font>
       ],<font></font>
       <span class="hljs-attr">"bundleName"</span>:  <span class="hljs-string">"events-calendar"</span>,
       <span class="hljs-attr">"js"</span>:  <span class="hljs-string">"events-calendar.js"</span>,
       <span class="hljs-attr">"css"</span>:  <span class="hljs-string">"events-calendar.css"</span>,<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y, por supuesto, no debemos olvidarnos de actualizar los textos. </font><font style="vertical-align: inherit;">Debido a que en el servidor todos los textos est√°n siempre actualizados, y el cliente necesita un mecanismo de actualizaci√≥n de cach√© separado, por ejemplo, vigilante o inserci√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo antiguo en nuevo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con una transici√≥n suave, surge el problema de reutilizar el c√≥digo antiguo en componentes nuevos, porque hay componentes grandes y complejos (por ejemplo, un reproductor de video) que tomar√° mucho tiempo reescribir, y ahora debe usarlos en la nueva pila. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jz/pg/te/jzpgtesmq75odhrqyvbg2grbw9u.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øCu√°les son los problemas?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El sitio antiguo y las nuevas aplicaciones React tienen ciclos de vida completamente diferentes. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si pega el c√≥digo de la muestra anterior dentro de la aplicaci√≥n React, este c√≥digo no se iniciar√° porque React no sabe c√≥mo activarlo. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debido a los diferentes ciclos de vida, React y el motor antiguo pueden intentar simult√°neamente modificar el contenido del c√≥digo anterior, lo que puede causar efectos secundarios desagradables. </font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para resolver estos problemas, se asign√≥ una clase base com√∫n para componentes que contienen c√≥digo antiguo. </font><font style="vertical-align: inherit;">La clase permite a los herederos coordinar los ciclos de vida de React y las aplicaciones de estilo antiguo.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OldCodeBase</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-attr">ref</span>: React.RefObject&lt;HTMLElement&gt; = React.createRef();<font></font>
<font></font>
    componentDidMount() {<font></font>
        <span class="hljs-comment">//       DOM</span>
        <span class="hljs-keyword">this</span>.props.activate(<span class="hljs-keyword">this</span>.ref.current!); <font></font>
    }<font></font>
<font></font>
    componentWillUnmount() {<font></font>
        <span class="hljs-comment">//       DOM</span>
        <span class="hljs-keyword">this</span>.props.deactivate(<span class="hljs-keyword">this</span>.ref.current!); <font></font>
    }<font></font>
<font></font>
    shouldComponentUpdate() {<font></font>
        <span class="hljs-comment">// React     , </span>
        <span class="hljs-comment">//   React-. </span>
        <span class="hljs-comment">//     .</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
    }<font></font>
<font></font>
    render() {<font></font>
        <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.ref}</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><font></font>
        );<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La clase le permite crear fragmentos de c√≥digo que funcionan a la antigua usanza o destruirlos, mientras que no habr√° interacci√≥n simult√°nea con ellos. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pegue el c√≥digo antiguo en el servidor</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la pr√°ctica, existe la necesidad de componentes de envoltura (por ejemplo, ventanas emergentes), cuyo contenido puede ser cualquiera, incluidos los creados con tecnolog√≠as antiguas. </font><font style="vertical-align: inherit;">Debe descubrir c√≥mo incrustar cualquier c√≥digo en el servidor dentro de dichos componentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En un art√≠culo anterior, hablamos sobre el uso de atributos para pasar par√°metros a nuevos componentes en el cliente y el servidor.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span> <span class="hljs-attr">users</span>=<span class="hljs-string">"[1,2,3]"</span> /&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y ahora todav√≠a queremos insertar un trozo de marcado all√≠, que en sentido no es un atributo. </font><font style="vertical-align: inherit;">Para esto, se decidi√≥ utilizar un sistema de tragamonedas.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ui:part</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"old-code"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>old component<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ui:part</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cool-app</span>&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver en el ejemplo anterior, dentro del c√≥digo del componente cool-app, se describe una ranura de c√≥digo antiguo que contiene componentes antiguos. </font><font style="vertical-align: inherit;">Luego, dentro del componente de reacci√≥n, se indica el lugar donde desea pegar el contenido de esta ranura:</font></font><br>
<br>
<pre><code class="javascript hljs">render() {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">UiPart</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"old-code"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><font></font>
    );<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El motor del servidor procesa este componente de reacci√≥n y enmarca el contenido de la ranura en la etiqueta &lt;ui-part&gt;, asign√°ndole el atributo data-part-id = "old-code". </font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ui-part</span> <span class="hljs-attr">data-part-id</span>=<span class="hljs-string">"old-code"</span>&gt;</span><font></font>
            old code<font></font>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ui-part</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cool-app</span>&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la representaci√≥n del lado del servidor de JS en GraalVM no se ajusta al tiempo de espera, entonces recurrimos a la representaci√≥n del cliente. </font><font style="vertical-align: inherit;">Para hacer esto, el motor en el servidor solo proporciona ranuras, enmarcandolos en la etiqueta de la plantilla para que el navegador no interact√∫e con su c√≥digo.</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cool-app</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ui-part</span> <span class="hljs-attr">data-part-id</span>=<span class="hljs-string">"old-code"</span>&gt;</span><font></font>
            old code<font></font>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ui-part</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">cool-app</span>&gt;</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© est√° pasando en el cliente? </font><font style="vertical-align: inherit;">El motor del cliente simplemente escanea el c√≥digo del componente, recopila las etiquetas &lt;ui-part&gt;, recibe su contenido en forma de cadenas y las pasa a la funci√≥n de representaci√≥n junto con el resto de los par√°metros.</font></font><br>
 <br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> tagName = <span class="hljs-string">'cool-app'</span>;
<span class="hljs-keyword">var</span> reactComponent = components[tagName];<font></font>
reactComponent.render({<font></font>
       <span class="hljs-attr">tagName</span>: tagName,
       <span class="hljs-attr">attrs</span>: attrs,
       <span class="hljs-attr">parts</span>: parts,
       <span class="hljs-attr">node</span>: element<font></font>
});<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo del componente que inserta las ranuras en la ubicaci√≥n deseada es el siguiente: </font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UiPart</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OldCodeBase</span>&lt;<span class="hljs-title">IProps</span>&gt; </span>{<font></font>
<font></font>
	render() {<font></font>
		<span class="hljs-keyword">const</span> id = <span class="hljs-keyword">this</span>.props.id;
		<span class="hljs-keyword">const</span> parts = <span class="hljs-keyword">this</span>.props.parts;<font></font>
<font></font>
		<span class="hljs-keyword">if</span> (!parts.hasOwnProperty(id)) {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">return</span> React.createElement(<span class="hljs-string">'ui-part'</span>, {
			<span class="hljs-string">'data-part-id'</span>: id,
			<span class="hljs-attr">ref</span>: <span class="hljs-keyword">this</span>.ref,
			<span class="hljs-attr">dangerouslySetInnerHTML</span>: { <span class="hljs-attr">__html</span>: parts[id] }<font></font>
		});<font></font>
	}<font></font>
}<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al mismo tiempo, se hereda de la clase OldCodeBase, que resuelve los problemas de interacci√≥n entre la pila antigua y la nueva. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ge/cc/a3/gecca3dlxac9crp48u9pvoyc4vs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora puede escribir una ventana emergente y llenarla utilizando la nueva pila o solicitud del servidor utilizando el enfoque anterior. </font><font style="vertical-align: inherit;">En este caso, los componentes funcionar√°n correctamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto le permite migrar gradualmente los componentes del sitio a una nueva pila. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo este fue uno de los requisitos principales para la nueva interfaz.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resumen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos se preguntan qu√© tan r√°pido funciona GraalVM. </font><font style="vertical-align: inherit;">Los desarrolladores de Odnoklassniki realizaron varias pruebas con las aplicaciones React. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una funci√≥n simple que devuelve una cadena despu√©s del calentamiento tarda aproximadamente 1 microsegundo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Componentes (nuevamente despu√©s del calentamiento): de 0,5 a 6 milisegundos, seg√∫n su tama√±o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GraalVM acelera m√°s lentamente que V8. </font><font style="vertical-align: inherit;">Pero para el momento de su calentamiento, la situaci√≥n se ha suavizado gracias al respaldo para la representaci√≥n del cliente. </font><font style="vertical-align: inherit;">Como hay tantos usuarios, la m√°quina virtual se calienta r√°pidamente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© lograste hacer?</font></font></h3><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejecute JavaScript en el servidor en el mundo Java de Classmates.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crea un c√≥digo isomorfo para la interfaz de usuario.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use una pila moderna que todos los vendedores de front-end conozcan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cree una plataforma com√∫n y un enfoque √∫nico para escribir la interfaz de usuario.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comience una transici√≥n sin problemas sin complicar la operaci√≥n y sin ralentizar la representaci√≥n del servidor.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esperamos que las experiencias de Odnoklassniki y los ejemplos le sean √∫tiles y los encuentre para usar en su trabajo.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es486810/">https://habr.com/ru/post/es486810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es486798/index.html">¬øHay un GameDev en Sakhalin? Final</a></li>
<li><a href="../es486800/index.html">Cassandra C√≥mo no morir si solo conoces a Oracle</a></li>
<li><a href="../es486802/index.html">La gente conoce los sistemas de recomendaci√≥n. Factorizaci√≥n</a></li>
<li><a href="../es486804/index.html">Inform√°tica sanitaria mundial: tecnolog√≠as en la nube</a></li>
<li><a href="../es486808/index.html">Prueba de embarazo electr√≥nica de una farmacia: c√≥mo funciona</a></li>
<li><a href="../es486814/index.html">Zabbix: la topolog√≠a de red es clara y autom√°tica</a></li>
<li><a href="../es486818/index.html">Portar Quake a iPod Classic</a></li>
<li><a href="../es486820/index.html">70 preguntas de la entrevista de Javascript</a></li>
<li><a href="../es486822/index.html">[Por los muelles] Aleteo. Parte 4. Para desarrolladores web</a></li>
<li><a href="../es486824/index.html">Mal consejo al trabajar con ANTLR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>