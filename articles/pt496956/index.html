<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëπ üñ®Ô∏è üë®üèª‚Äçüç≥ Por que os servidores da Web ass√≠ncronos apareceram? üñ®Ô∏è ü¶Ñ ‚Ñ¢Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° a todos. Em contato com Vladislav Rodin. Atualmente, sou o chefe do curso de arquiteto de carga alta da OTUS e tamb√©m ensino cursos de arquitetura...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Por que os servidores da Web ass√≠ncronos apareceram?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/496956/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√° a todos. </font><font style="vertical-align: inherit;">Em contato com Vladislav Rodin. </font><font style="vertical-align: inherit;">Atualmente, sou o chefe do curso de arquiteto de carga alta da OTUS e tamb√©m ensino cursos de arquitetura de software. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m de ensinar, como voc√™ deve ter notado, tamb√©m estou escrevendo material com direitos autorais para o blog OTUS no Haber e quero coincidir com o artigo de hoje para iniciar o curso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux Administrator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , para o qual o conjunto est√° aberto agora.</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/mq/fl/9f/mqfl9f73j0kklcb2wikqonkd4rk.png"><br>
<hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que o aplicativo Web fica mais lento e n√£o ret√©m a carga? </font><font style="vertical-align: inherit;">Os desenvolvedores, que foram os primeiros a encontrar essa pergunta e conduziram pesquisas em alguns sistemas, chegaram √† conclus√£o decepcionante de que otimizar uma l√≥gica de neg√≥cios por si s√≥ n√£o seria suficiente. </font><font style="vertical-align: inherit;">A resposta para essa pergunta est√° em um n√≠vel inferior - no n√≠vel do sistema operacional. </font><font style="vertical-align: inherit;">Para que seu aplicativo retenha a carga, √© necess√°rio revisar seu conceito de arquitetura de forma que funcione efetivamente nesse n√≠vel. </font><font style="vertical-align: inherit;">Isso levou ao surgimento de servidores Web ass√≠ncronos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Infelizmente, n√£o consegui encontrar um √∫nico material que me permita restaurar todos os relacionamentos causais na evolu√ß√£o dos servidores da web de uma s√≥ vez. </font><font style="vertical-align: inherit;">Ent√£o surgiu a id√©ia de escrever este artigo, que, espero, se tornar√° esse material.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recursos do sistema operacional Linux</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de falar sobre os modelos de servidores web, permito-me relembrar alguns recursos dos processos e threads no Linux. </font><font style="vertical-align: inherit;">Precisamos disso ao analisar as vantagens e desvantagens dos modelos acima.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mudan√ßa de contexto</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Provavelmente, qualquer usu√°rio que saiba que apenas um programa pode ser executado em um n√∫cleo de processador de uma s√≥ vez perguntar√°: "Por que 20 programas podem ser lan√ßados no meu processador de quatro n√∫cleos de uma vez?". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De fato, isso se deve ao fato de que a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multitarefa preventiva</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ocorre </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O sistema operacional aloca um certo quantum de tempo (~ 50 Œºs) e coloca o programa para executar no kernel durante esse tempo. </font><font style="vertical-align: inherit;">Ap√≥s o tempo acabar, a </font><b><font style="vertical-align: inherit;">troca de contexto</font></b><font style="vertical-align: inherit;"> √© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interrompida</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alternada</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ou seja, o sistema operacional simplesmente coloca o pr√≥ximo programa para executar. </font><font style="vertical-align: inherit;">Como a troca ocorre com frequ√™ncia, temos a impress√£o de que todos os programas funcionam simultaneamente. </font><font style="vertical-align: inherit;">Preste aten√ß√£o √† alta frequ√™ncia de comuta√ß√£o, isso ser√° importante para a apresenta√ß√£o subsequente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A mudan√ßa de contexto foi mencionada acima. </font><font style="vertical-align: inherit;">O que inclui? </font><font style="vertical-align: inherit;">Ao alternar o contexto, √© necess√°rio salvar os registros do processador, limpar seu pipeline de instru√ß√µes, salvar as regi√µes de mem√≥ria alocadas ao processo. </font><font style="vertical-align: inherit;">Em geral, a opera√ß√£o √© bastante cara. </font><font style="vertical-align: inherit;">Demora ~ 0,5 Œºs, enquanto a execu√ß√£o de uma linha simples de c√≥digo √© ~ 1 ns. </font><font style="vertical-align: inherit;">Al√©m disso, com um aumento no n√∫mero de processos por n√∫cleo do processador, a sobrecarga para a altern√¢ncia de contexto aumentar√°.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelos de servidor Web</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atualmente, existem os seguintes modelos de servidor da web:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabalhador</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prefork</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ass√≠ncrono</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">combinado</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos discutir cada um deles separadamente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabalhador e prefork</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Historicamente, com esses modelos, tudo come√ßou. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A ess√™ncia √© muito simples</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : um cliente chega at√© n√≥s, selecionamos um manipulador separado para ele, que processa o cliente recebido do come√ßo ao fim. Um manipulador pode ser um processo (pr√©-fork) ou um encadeamento (trabalhador). Um exemplo desse servidor web √© o conhecido Apache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Farei uma reserva imediatamente: a cria√ß√£o de um novo manipulador para cada cliente √© cara. Primeiro, com um n√∫mero constante de n√∫cleos, um aumento no n√∫mero de processadores leva a um aumento na lat√™ncia (devido √†s altern√¢ncias de contexto). Em segundo lugar, a quantidade necess√°ria de mem√≥ria cresce linearmente com o aumento de clientes, porque, mesmo se voc√™ usar threads de compartilhamento de mem√≥ria, cada thread ter√° sua pr√≥pria pilha. Assim, o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√∫mero de clientes processados ‚Äã‚Äãsimultaneamente √© limitado.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o tamanho do pool, que, por sua vez, depende do n√∫mero de n√∫cleos do processador. </font><font style="vertical-align: inherit;">O problema √© resolvido usando m√©todos de escala vertical. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra desvantagem fundamental desses servidores √© o uso n√£o ideal de recursos. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os processos (ou threads) ficam ociosos a maior parte do tempo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Imagine a seguinte situa√ß√£o: durante o processamento do cliente, √© necess√°rio pegar alguns dados do disco r√≠gido, fazer uma solicita√ß√£o no banco de dados ou gravar algo na rede. </font><font style="vertical-align: inherit;">Como a leitura de um disco r√≠gido no Linux √© uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opera√ß√£o de bloqueio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o processo (ou o encadeamento) ficar√° parado aguardando uma resposta, mas ainda participar√° da aloca√ß√£o do tempo do processador.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worker vs prefork</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Worker e prefork t√™m algumas diferen√ßas fundamentais. </font><font style="vertical-align: inherit;">Os fluxos s√£o um pouco mais econ√¥micos na mem√≥ria porque eles s√£o compartilhados. </font><font style="vertical-align: inherit;">Pelo mesmo motivo, uma troca de contexto entre eles √© mais f√°cil do que entre processos. </font><font style="vertical-align: inherit;">No entanto, no caso de um trabalhador, o c√≥digo se torna multiencadeado, porque os encadeamentos devem ser sincronizados. </font><font style="vertical-align: inherit;">Como resultado, obtemos todos os "encantos" do c√≥digo multiencadeado: torna-se mais dif√≠cil escrever, ler, testar e depurar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelo ass√≠ncrono</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, worker e prefork n√£o permitem o processamento de um grande n√∫mero de clientes ao mesmo tempo devido ao tamanho limitado do pool e tamb√©m n√£o usam recursos de maneira ideal devido √† altern√¢ncia de contexto e ao bloqueio de chamadas do sistema. Como voc√™ pode ver, o problema √© multithreading e um agendador pesado do SO. Isso leva √† seguinte id√©ia: vamos processar os clientes em apenas um segmento, mas vamos carreg√°-lo em 100%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esses servidores s√£o baseados em um loop de eventos e em um modelo de reator ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√°quina de eventos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). O c√≥digo do cliente, iniciando uma opera√ß√£o de E / S, registra um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorno de chamada</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em uma fila de prioridade (prioridade √© tempo de prontid√£o). O loop de eventos pesquisa os descritores que aguardam E / S e atualiza a prioridade (se dispon√≠vel). Al√©m disso, o loop de eventos retira eventos da fila de prioridade, fazendo com que os retornos de chamada retornem o controle ao loop de eventos no final. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse modelo permite que voc√™ lide com um grande n√∫mero de clientes, evitando sobrecarga para alternar o contexto</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este modelo n√£o √© perfeito e tem v√°rias desvantagens. Em primeiro lugar, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o √© consumido mais de um n√∫cleo do processador</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , porque existe apenas um processo. Isso √© tratado usando um modelo combinado, que ser√° discutido abaixo. Em segundo lugar, os </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clientes est√£o conectados por esse processo.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O c√≥digo precisa ser escrito com cuidado. </font><font style="vertical-align: inherit;">Vazamentos de mem√≥ria, erros levam ao fato de que todos os clientes caem de uma s√≥ vez. </font><font style="vertical-align: inherit;">Al√©m disso, esse processo n√£o deve ser bloqueado por nada, o retorno de chamada n√£o deve consistir na solu√ß√£o de algumas tarefas dif√≠ceis, porque todos os clientes ser√£o bloqueados. </font><font style="vertical-align: inherit;">Em terceiro lugar, o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo ass√≠ncrono √© muito mais complicado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">√â necess√°rio registrar um retorno de chamada adicional para que os dados n√£o cheguem, para resolver o problema de como ramificar corretamente etc.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelo combinado</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este modelo √© usado em servidores reais. </font><font style="vertical-align: inherit;">Este modelo possui um conjunto de processos, cada um com um conjunto de encadeamentos, cada um dos quais, por sua vez, usa um modelo de processamento baseado na entrada-sa√≠da ass√≠ncrona. </font><font style="vertical-align: inherit;">O Nginx apresenta um modelo combinado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, voltando ao b√°sico do sistema operacional, examinamos as diferen√ßas conceituais entre os modelos de servidor da web usados ‚Äã‚Äãno Apache e no Nginx. </font><font style="vertical-align: inherit;">Cada um deles tem suas pr√≥prias vantagens e desvantagens, portanto sua combina√ß√£o √© frequentemente usada na produ√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A id√©ia de processamento ass√≠ncrono evoluiu ainda mais: no n√≠vel das plataformas de linguagem, surgiram os conceitos de fios / fibras / goroutines verdes, que permitem "esconder debaixo do cap√¥" a assincronia de entrada e sa√≠da, deixando o desenvolvedor feliz com o belo c√≥digo s√≠ncrono. </font><font style="vertical-align: inherit;">No entanto, esse conceito merece um artigo separado.</font></font><br>
<br>
<hr><br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Saiba mais sobre o curso.</font></font></a></b><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt496944/index.html">Eventos digitais em S√£o Petersburgo, de 13 a 19 de abril</a></li>
<li><a href="../pt496946/index.html">Mais uma vez sobre as chaves de hardware GPG por um centavo</a></li>
<li><a href="../pt496950/index.html">Design √© design, n√£o a beleza das imagens.</a></li>
<li><a href="../pt496952/index.html">Qualcomm QCC3020 - a ascens√£o dos fones de ouvido TWS chineses</a></li>
<li><a href="../pt496954/index.html">Desenvolvimento na Wargaming - encontro com Maxim Baryshnikov, chefe de plataforma (parte I)</a></li>
<li><a href="../pt496958/index.html">CSS interessante encontra no novo design do Facebook</a></li>
<li><a href="../pt496960/index.html">Acelerando gr√°ficos usando OffscreenCanvas</a></li>
<li><a href="../pt496962/index.html">Como arrumar um servidor sobrecarregado?</a></li>
<li><a href="../pt496964/index.html">Semin√°rios semanais da IBM - abril de 2020</a></li>
<li><a href="../pt496966/index.html">Cores CSS LCH</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>