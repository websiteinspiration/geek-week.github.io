<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛳️ ♈️ 🌈 Antipatterns pour travailler avec des bases de données 👵🏿 📐 🐞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Je vous présente la traduction de mon article «Database: Anti-Patterns» . 
 
 Si vous stockez des données, il s'agit d'un élément essen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Antipatterns pour travailler avec des bases de données</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487622/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font><font style="vertical-align: inherit;">Je vous présente la traduction de mon article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Database: Anti-Patterns»</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous stockez des données, il s'agit d'un élément essentiel de votre application. </font><font style="vertical-align: inherit;">Vous pouvez facilement et rapidement corriger un bug sur un nouveau site de rencontres afin que l'agriculteur Joe du nord du Texas puisse enfin lire le dernier message de son correspondant et découvrir qu'elle aime les hommes chauves. </font><font style="vertical-align: inherit;">Mais Dieu nous garde de perdre ou de ruiner les données des utilisateurs. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e2d/e07/3a3/e2de073a3ff6c38cf29617834cd2cd42.png" alt="image"><br>
<i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Silicon Valley, saison 2, épisode 8</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, de nombreux développeurs ne comprennent pas pleinement cette simple vérité. </font><font style="vertical-align: inherit;">Je ne suis pas programmeur professionnel depuis de nombreuses années, mais j'ai déjà vu beaucoup, beaucoup d'erreurs commises par des personnes travaillant avec la base de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici juste ceux qui me viennent immédiatement à l'esprit.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manque de sauvegardes</font></font></h2><br>
<img src="https://habrastorage.org/getpro/habr/post_images/727/d48/742/727d487423bf0fb28b5a497d58cb2169.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Faire des sauvegardes" est l'une de ces règles (comme "ne travaillez pas sous la racine" ou "attachez vos ceintures") que beaucoup d'entre nous approuvent mais ne les respectent pas, en espérant que de mauvaises choses arrivent aux autres et pas à nous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soit dit en passant, si vous ne testez pas la récupération à partir de sauvegardes, vous pouvez supposer que vous ne disposez d'aucune sauvegarde. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apprenez des erreurs des autres</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En d'autres termes, sur les cinq technologies de sauvegarde, personne ne fonctionne de manière fiable ou n'est pas configuré. </font><font style="vertical-align: inherit;">Au final, nous avons restauré les données de la sauvegarde effectuée il y a 6 heures.</font></font></blockquote><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons perdu les données de la base de données en 6 heures (problèmes, demandes de fusion, utilisateurs, commentaires, extraits, etc.) avec GitLab.com.</font></font></blockquote><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NoSQL</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il arrive que </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vos utilisateurs aient trop de contenu pour adultes et qu'ils le regardent trop souvent. Le</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> volume de données est trop important ou la charge est trop élevée pour être gérée par la base de données relationnelle. </font><font style="vertical-align: inherit;">C'est le cas lorsque les technologies NoSQL entrent en jeu. </font><font style="vertical-align: inherit;">Les géants du logiciel comme Google connaissent bien cette situation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous n'êtes pas Google</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Quelques centaines de gigaoctets ne sont pas des «mégadonnées», mais 1 000 commentaires par jour ne sont pas des «charges élevées». </font><font style="vertical-align: inherit;">PostgreSQL est probablement suffisant pour vos données. </font><font style="vertical-align: inherit;">Voir: il </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prend</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> même en </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">charge JSON et peut l'indexer</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Allez, voulez-vous sérieusement sacrifier une structure fiable pour des fonctionnalités dont vous n'avez pas besoin et - avouons-le - ne seront jamais nécessaires? </font><font style="vertical-align: inherit;">Vous ne deviendrez pas le nouveau Google - vous avez juste un gâchis dans la base de données.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schéma trop lâche</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est plus pertinent pour NoSQL, mais les utilisateurs de SGBD relationnels oublient souvent ou sont trop paresseux pour créer toutes les restrictions nécessaires. </font><font style="vertical-align: inherit;">En raison d'une erreur dans le code d'application, il </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut être enregistré là où une valeur significative est attendue, ou un lien vers une entrée manquante peut être créé. </font><font style="vertical-align: inherit;">Par la suite, vous remarquez cela et corrigez le code, mais vous ne savez pas comment corriger les données.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clés primaires naturelles</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginez que nous voulons stocker des utilisateurs, chacun d'eux devant avoir un e-mail unique. </font><font style="vertical-align: inherit;">La solution la plus évidente consiste à créer une table </font></font><code>user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec une colonne </font></font><code>email</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, qui sera également la clé primaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, la clé naturelle peut devenir inacceptable en tant que principale lorsque les exigences changent (et elles changent constamment). </font><font style="vertical-align: inherit;">Aujourd'hui, cela </font></font><code>PRIMARY KEY(email)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fonctionne, et demain, nous décidons d'ajouter l'inscription via Facebook et de rendre le courrier électronique facultatif. </font><font style="vertical-align: inherit;">Quoi de mieux: générer des adresses uniques et ajouter un indicateur indiquant un e-mail fictif, ou changer la clé primaire, toutes les clés étrangères qui se réfèrent à </font></font><code>user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, etc., etc.? </font><font style="vertical-align: inherit;">Nous n'aurions pas à choisir le moindre des maux si nous utilisions simplement une clé primaire de substitution.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logique dans le stockage</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'aime pas ça pour deux raisons:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code d'application est généralement beaucoup plus facile à mettre à jour qu'un schéma de base de données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous ces PL SQL me rappellent Pascal, et ils sont tout aussi moches.</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts de migration spécifiques à l'environnement</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je sais que parfois il n'y a pas de choix, mais en général, il vaut mieux essayer de s'assurer que tous les environnements (dev, test, prod, etc.) sont aussi similaires que possible. </font><font style="vertical-align: inherit;">Plus la différence entre les environnements est grande, plus il est probable de commettre une erreur et de la trouver uniquement sur la prod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, même les scripts DML peuvent être universels. </font><font style="vertical-align: inherit;">Différents schémas, le plus souvent, sont du mal pur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, lorsque je vois des étiquettes spécifiques à l'environnement dans les scripts de base de données, je veux tuer.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scripts de migration tolérants</font></font></h2><br>
<code>IF NOT EXISTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et des choses similaires dans DDL ne sont pas nécessaires si dans tous les environnements des schémas identiques, mais peuvent masquer les erreurs. </font><font style="vertical-align: inherit;">Si quelque chose d'inattendu se produit pendant la mise à jour de la base de données, je préfère en savoir plus et le réparer le plus tôt possible, plutôt que de me creuser la tête une semaine plus tard, comment réparer le désordre.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mises à jour non atomiques</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons que vous exécutiez l'ensemble de modifications sur une base de production et que la migration n'ait pas réussi. Vous corrigez quelque chose et souhaitez réessayer. Est-ce que ça marchera? Que faire si certaines opérations d'ensemble de modifications sont validées, tandis que d'autres ne le sont pas? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous remarquerez peut-être qu'il s'agit en fait d'une histoire dont les changements devraient être </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">idempotents</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et vous aurez raison. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, de nombreux développeurs pensent à l'idempotence, à l'utilisation </font></font><code>IF NOT EXISTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou à quelque chose comme ça. Dans la section précédente, j'ai expliqué pourquoi c'est mal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au lieu de cela, faites un ensemble de modifications </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atomique</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ensuite, en cas d'erreur, les modifications apportées seront annulées et vous n'aurez aucun problème avec l'application ultérieure de cet ensemble de modifications. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais soyez prudent lorsque vous comptez sur des transactions. Par exemple,</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la prise en charge des expressions DDL dans les transactions MySQL est sombre et pleine d'horreurs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , donc je crée toujours un ensemble de modifications distinct pour chaque expression DDL lorsque j'écris des scripts Liquibase pour MySQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quels antipatterns avez-vous vus?</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr487606/index.html">Visualisation des lignes de tension et des mouvements des charges électrostatiques, simulation du mouvement planétaire du système solaire</a></li>
<li><a href="../fr487610/index.html">RealWorld: aiohttp, Tortoise ORM</a></li>
<li><a href="../fr487612/index.html">Ajoutez, supprimez et renommez facilement des fichiers et des objectifs dans les projets CMake</a></li>
<li><a href="../fr487616/index.html">Création d'un élément personnalisé à l'aide d'un exemple de table en C # pour Windows Form</a></li>
<li><a href="../fr487620/index.html">Résolution de problèmes avec pwnable.kr 27 - tiny_easy. Comprendre la pulvérisation en pile</a></li>
<li><a href="../fr487626/index.html">Comment fonctionnent les capteurs de stationnement et comment le tromper</a></li>
<li><a href="../fr487628/index.html">Diagnostic du vieillissement basé sur 9 caractéristiques des signes du vieillissement</a></li>
<li><a href="../fr487630/index.html">L'algorithme le plus simple pour créer un puzzle de terrain (partie 1)</a></li>
<li><a href="../fr487632/index.html">«Chers collègues, respirez plus tranquillement»: pourquoi le bruit des bureaux nous rend fous - nous discutons de la recherche</a></li>
<li><a href="../fr487636/index.html">API pour lesquelles il vaut enfin la peine de passer de Java 8. Partie 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>