<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüíª üïò üë©‚Äçüîß Una vez en un pentest, o C√≥mo romper todo con la ayuda de un ur√≥logo y Roskomnadzor üë©üèø‚Äçüè´ üöï üë©üèΩ‚Äçü§ù‚Äçüë®üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo se basa en un pentest muy exitoso, realizado por especialistas del Grupo IB hace un par de a√±os: sucedi√≥ una historia que dice ser una a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Una vez en un pentest, o C√≥mo romper todo con la ayuda de un ur√≥logo y Roskomnadzor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/group-ib/blog/496712/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este art√≠culo se basa en un pentest muy exitoso, realizado por especialistas del Grupo IB hace un par de a√±os: sucedi√≥ una historia que dice ser una adaptaci√≥n cinematogr√°fica en Bollywood. Ahora, probablemente, la reacci√≥n del lector seguir√°: "Oh, otro art√≠culo de relaciones p√∫blicas, una vez m√°s estos est√°n dibujados, qu√© buenos son, no te olvides de comprar un pentest" Bueno, por un lado, lo es. Sin embargo, hay varias razones por las que apareci√≥ este art√≠culo. Quer√≠a mostrar qu√© est√°n haciendo exactamente los pentesters, cu√°n interesante y no trivial puede ser este trabajo, qu√© circunstancias divertidas pueden desarrollarse en los proyectos y, lo m√°s importante, mostrar material en vivo con ejemplos reales.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para restablecer el equilibrio de la modestia en el mundo, despu√©s de un tiempo escribiremos sobre el pentest, que no fue. </font><font style="vertical-align: inherit;">Mostramos c√≥mo los procesos bien establecidos en una empresa pueden proteger contra toda una gama de ataques, incluso los bien preparados, simplemente porque estos procesos existen y realmente funcionan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El cliente de este art√≠culo, tambi√©n, todo estaba bien en general, al menos mejor que el 95% del mercado en la Federaci√≥n de Rusia, seg√∫n nuestros sentimientos, pero hubo una serie de peque√±os matices que formaron una larga cadena de eventos, lo que condujo primero a un largo informe sobre el trabajo. , y luego a este art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, abastecerse de palomitas de ma√≠z, y bienvenido al detective. </font><font style="vertical-align: inherit;">Doy </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la palabra a Pavel Suprunyuk</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Director T√©cnico del Grupo de Auditor√≠a y Consultor√≠a-IB.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 1. Doctor Pochkin </font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A√±o 2018. Hay un cliente, una empresa de TI de alta tecnolog√≠a, que a su vez sirve a muchos clientes. Quiere obtener una respuesta a la pregunta: ¬øes posible, sin ning√∫n conocimiento inicial y acceso, trabajando a trav√©s de Internet, obtener derechos de administrador para un dominio de Active Directory? Ninguna ingenier√≠a social es de inter√©s ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eh, pero en vano</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), no van a interferir espec√≠ficamente con el trabajo, pero pueden recargar accidentalmente un servidor extra√±o que funciona, por ejemplo. Una tarea adicional es identificar tantos otros vectores de ataque como sea posible con respecto al per√≠metro externo. La compa√±√≠a realiza regularmente tales pruebas, y ahora la fecha l√≠mite para una nueva prueba. Las condiciones son casi t√≠picas, adecuadas, comprensibles. Bajando. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay un nombre de cliente: d√©jelo ser "Empresa", con el sitio principal </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.company.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Por supuesto, el cliente recibe una llamada diferente, pero en este art√≠culo todo se despersonalizar√°. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realizo inteligencia de red: averiguo qu√© direcciones y dominios est√°n listados por el cliente, dibujo un diagrama de red, c√≥mo se distribuyen los servicios a estas direcciones. Obtengo el resultado: m√°s de 4000 direcciones IP activas. Miro a trav√©s de los dominios en estas redes: afortunadamente, la gran mayor√≠a son redes destinadas a clientes clientes, y no nos interesan formalmente. El cliente cree lo mismo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sigue habiendo una red con 256 direcciones, para lo cual en este momento ya se comprende la distribuci√≥n de dominios y subdominios por direcciones IP, hay informaci√≥n sobre los puertos escaneados, lo que significa que puede mirar los servicios para ver los interesantes con sus ojos. Paralelamente, todos los tipos de esc√°neres se lanzan en direcciones IP accesibles y por separado, en sitios web.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay muchos servicios. Esto suele ser una alegr√≠a para el pentester y la anticipaci√≥n de una victoria r√°pida, ya que mientras m√°s servicios, mayor es el campo de ataque y m√°s f√°cil es encontrar un artefacto. Un vistazo r√°pido a los sitios web mostr√≥ que la mayor√≠a de ellos son interfaces web de los productos conocidos de grandes compa√±√≠as mundiales que dicen que no est√°n contentos con usted. Solicitan un nombre de usuario y una contrase√±a, desde el umbral sacuden el campo para ingresar el segundo factor, solicitan un certificado de cliente TLS o los env√≠an a Microsoft ADFS. Algunos simplemente no est√°n disponibles en Internet. Para algunos, obviamente necesita tener un cliente especial pagado por tres salarios o saber la URL exacta para ingresar. Omitiremos otra semana de des√°nimo gradual en el proceso de tratar de "romper" el software por versi√≥n para detectar vulnerabilidades conocidas, buscar contenido oculto en rutas web y cuentas filtradas de servicios de terceros como LinkedIn,intenta seleccionar contrase√±as para ellos, as√≠ como excavar vulnerabilidades en sitios web autodescritos, por cierto, seg√∫n las estad√≠sticas, este es el vector m√°s prometedor de un ataque externo hasta la fecha. Inmediatamente noto la pistola de cine, que posteriormente dispar√≥.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, hab√≠a dos sitios que se destacan de cientos de servicios. Estos sitios tienen una cosa en com√∫n: si no realiza un reconocimiento meticuloso de la red por dominio, pero busca "en el frente" puertos abiertos o envenena el esc√°ner de vulnerabilidades en un rango de IP conocido, entonces estos sitios desaparecer√°n de la verificaci√≥n, simplemente no ser√°n visibles sin conocer el nombre DNS. Tal vez se perdieron antes, al menos, y nuestras herramientas autom√°ticas no encontraron problemas en ellas, incluso si se configuraron directamente en el recurso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por cierto, sobre el hecho de que generalmente se encontraron esc√°neres previamente lanzados. Perm√≠tame recordarle: para algunas personas, "pentest" equivale a "escaneo automatizado". Y los esc√°neres de este proyecto no dijeron nada. Bueno, las vulnerabilidades medias mostraron el m√°ximo (3 de 5 en t√©rminos de peligro): algunos servicios tienen un certificado TLS incorrecto o algoritmos de cifrado obsoletos, y la mayor√≠a de los sitios tienen Clickjacking. Pero en esto no llegar√°s a la meta. Probablemente, los esc√°neres ser√≠an m√°s √∫tiles aqu√≠, pero perm√≠tame recordarle: el cliente mismo puede comprar dichos programas y probarse con ellos, y a juzgar por los aburridos resultados, ya lo comprob√≥.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Volver a los sitios "anormales". El primero es algo as√≠ como un Wiki local en una direcci√≥n no est√°ndar, pero deja que wiki.company [.] Ru est√© en este art√≠culo. Tambi√©n solicit√≥ inmediatamente un nombre de usuario y contrase√±a, pero ya a trav√©s de NTLM en el navegador. Para el usuario, esto parece una ventana asc√©tica que solicita un nombre de usuario y contrase√±a. Y esta es una mala pr√°ctica.</font></font><br>
<br>
<blockquote> . NTLM  -      .   ‚Äî    Active Directory.       company.ru,   ¬´¬ª DNS-.  ,    - ,        ,    - .  ‚Äî        NTLM (, ?),     ¬´¬ª ,         .    ,      .         ‚Äî  ,    .  ‚Äî       .         ‚Äî , ,  .  ‚Äî   pass-the-hash-. ADFS           .<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay una caracter√≠stica negativa de los productos de Microsoft: incluso si no ha publicado espec√≠ficamente tal NTLM, al menos estar√° en la instalaci√≥n predeterminada en OWA y Lync. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por cierto, el autor de este art√≠culo una vez de la misma manera bloque√≥ accidentalmente aproximadamente 1000 cuentas de empleados de un gran banco en solo una hora y luego tuvo una apariencia algo p√°lida. </font><font style="vertical-align: inherit;">Los servicios de TI del banco tambi√©n fueron p√°lidos, pero todo termin√≥ bien y de manera adecuada, incluso nos felicitaron por ser los primeros en encontrar este problema y provocar una correcci√≥n r√°pida y decisiva.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El segundo sitio ten√≠a la direcci√≥n "obviamente-alg√∫n-apellido.company.ru". </font><font style="vertical-align: inherit;">Encontrado a trav√©s de Google, algo as√≠ en la p√°gina 10. </font><font style="vertical-align: inherit;">El dise√±o comienza a mediados de 2000, y una persona respetable mir√≥ desde la p√°gina principal, algo como esto:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vn/0a/bo/vn0abo7bxrqzjjq0vgophwwr3rm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego tom√≥ un cuadro de "Dog‚Äôs Heart", pero cr√©anme, era remotamente similar, incluso el esquema de color en colores similares. Deje que el sitio se llame </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky.company.ru</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era un sitio personal ... de un ur√≥logo. Se volvi√≥ interesante lo que hace el sitio del ur√≥logo en el subdominio de una empresa de alta tecnolog√≠a. Una b√∫squeda r√°pida en Google mostr√≥ que este m√©dico era cofundador de una de las entidades legales de nuestro cliente e incluso contribuy√≥ con alrededor de 1000 rublos de capital registrado. El sitio probablemente se cre√≥ hace muchos a√±os, y los recursos del servidor del cliente se usaron como alojamiento. El sitio ha perdido relevancia durante mucho tiempo, pero por alguna raz√≥n se ha dejado funcionando durante mucho tiempo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En t√©rminos de vulnerabilidades, el sitio web en s√≠ era seguro. Mirando hacia el futuro, dir√© que fue un conjunto de estad√≠sticas: p√°ginas html simples con insertos de ilustraciones en forma de ri√±ones y vejigas. "Romper" tal sitio es in√∫til.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero el servidor web debajo era m√°s interesante. A juzgar por el encabezado del servidor HTTP, hab√≠a IIS 6.0, lo que significa que Windows 2003 se utiliz√≥ como sistema operativo. El esc√°ner revel√≥ previamente que este sitio web particular del ur√≥logo, a diferencia de otros hosts virtuales en el mismo servidor web, respondi√≥ al comando PROPFIND, es decir, WebDAV trabaj√≥ all√≠. Por cierto, el esc√°ner emiti√≥ esta informaci√≥n con la marca Informaci√≥n (en el idioma de los informes del esc√°ner, este es el peligro m√°s bajo); por lo general, estas cosas simplemente se omiten. En combinaci√≥n, esto dio un efecto interesante, que se revel√≥ solo despu√©s de otra excavaci√≥n en Google: una vulnerabilidad de desbordamiento de b√∫fer rara asociada con un conjunto de Shadow Brokers, a saber, CVE-2017-7269, que ya ten√≠a un exploit listo. En otras palabras, ser√° un desastre si tiene Windows 2003 y WebDAV se est√° ejecutando en IIS.Aunque trabaj√≥ en la producci√≥n de Windows 2003 en 2018, esto es en s√≠ mismo un desastre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El exploit termin√≥ en Metasploit y se prob√≥ inmediatamente con una carga que envi√≥ una consulta DNS a un servicio controlado: Burp Collaborator se usa tradicionalmente para atrapar consultas DNS. Sorprendentemente, funcion√≥ la primera vez: se recibi√≥ una sacudida en DNS. Luego hubo un intento de crear una conexi√≥n de fondo a trav√©s del puerto 80 (es decir, una conexi√≥n de red del servidor al atacante, con acceso a cmd.exe en el host v√≠ctima), pero luego ocurri√≥ un fiasco. La conexi√≥n no lleg√≥, y despu√©s del tercer intento de operaci√≥n, el sitio, junto con todas las fotos entretenidas, desapareci√≥ definitivamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo general, esto es seguido por una carta en el estilo de "cliente, despierta, hemos dejado todo". Pero nos dijeron que el sitio no tiene nada que ver con los procesos comerciales y funciona all√≠ en general, no est√° claro por qu√©, como todo el servidor, y que podemos usar este recurso como queramos.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de aproximadamente un d√≠a, el sitio de repente comenz√≥ a funcionar por s√≠ solo. Despu√©s de construir un soporte de WebDAV en IIS 6.0, descubr√≠ que la configuraci√≥n predeterminada es reiniciar los flujos de trabajo de IIS cada 30 horas. Es decir, cuando el control sali√≥ del c√≥digo de shell, el flujo de trabajo de IIS termin√≥, luego se reinici√≥ un par de veces y luego se detuvo durante 30 horas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde la primera vez que fall√≥ bekconnect en tcp, descart√© este problema en un puerto cerrado. </font><font style="vertical-align: inherit;">Es decir, sugiri√≥ la presencia de alg√∫n firewall que no permit√≠a la salida de las conexiones salientes. </font><font style="vertical-align: inherit;">Comenc√© a ejecutar c√≥digos de shell que clasifican muchos puertos tcp y udp, no hubo ning√∫n efecto. </font><font style="vertical-align: inherit;">La conexi√≥n inversa se carga a trav√©s de http (s) desde Metasploit - meterpreter / reverse_http (s) no funcion√≥. </font><font style="vertical-align: inherit;">De repente, se estableci√≥ la conexi√≥n con el mismo puerto 80, pero se interrumpi√≥ de inmediato. </font><font style="vertical-align: inherit;">√âl lo descart√≥ por la acci√≥n del todav√≠a imaginario IPS, al que no le gustaba el tr√°fico del metro metro. </font><font style="vertical-align: inherit;">En vista del hecho de que la conexi√≥n de tcp puro al puerto 80 fall√≥, pero http lo hizo, conclu√≠ que el proxy http estaba configurado de alguna manera en el sistema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intent√© incluso meterpreter a trav√©s de DNS (gracias</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d00kie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por sus esfuerzos, salv√≥ muchos proyectos), recordando el primer √©xito, pero ni siquiera trabaj√≥ en el stand: el c√≥digo de shell era demasiado voluminoso para esta vulnerabilidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En realidad, se ve√≠a as√≠: 3-4 intentos de ataque en 5 minutos, luego esperar 30 horas. Y as√≠ durante tres semanas seguidas. Incluso configur√© un recordatorio para no perder el tiempo. Adem√°s, hab√≠a una diferencia en el comportamiento de los entornos de prueba y combate: para esta vulnerabilidad hab√≠a dos exploits similares, uno de Metasploit, el segundo de Internet, rehecho de la versi√≥n de Shadow Brokers. Entonces, en el combate, solo Metasploit funcion√≥, en el estrado, solo el segundo, lo que complic√≥ a√∫n m√°s la depuraci√≥n y rompi√≥ el cerebro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final, el c√≥digo de shell demostr√≥ ser efectivo, que descarg√≥ un archivo exe de un servidor determinado a trav√©s de http y lo ejecut√≥ en el sistema de destino. El shellcode era lo suficientemente peque√±o como para caber, y al menos funcion√≥. Dado que al servidor TCP no le gustaba el tr√°fico y se inspeccion√≥ http (s) en busca de meterpreter, decid√≠ que la forma m√°s r√°pida es descargar el archivo exe que conten√≠a el DNS-meterpreter a trav√©s de este c√≥digo shell.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ nuevamente surgi√≥ el problema: al descargar el archivo exe y, como lo mostraron los intentos, no importa qu√©, la descarga se interrumpi√≥. </font><font style="vertical-align: inherit;">Una vez m√°s, a alg√∫n tipo de dispositivo de protecci√≥n entre mi servidor y el ur√≥logo no le gust√≥ el tr√°fico http con exe dentro. </font><font style="vertical-align: inherit;">Parec√≠a una soluci√≥n "r√°pida" para cambiar el c√≥digo shell para que ofuscara el tr√°fico http sobre la marcha, de modo que se transfirieran datos binarios abstractos en lugar de exe. </font><font style="vertical-align: inherit;">Finalmente, el ataque fue exitoso, el control lleg√≥ a trav√©s del delgado canal DNS:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ca/-h/da/ca-hdaxtehdtgxz-o1sypuvgo5u.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inmediatamente se hizo evidente que ten√≠a los derechos m√°s simples para el flujo de trabajo de IIS que me permit√≠an no hacer nada. </font><font style="vertical-align: inherit;">As√≠ es como se ve√≠a en la consola Metasploit:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/nc/cu/ck/nccucklqwhs5kpekejdz8vky3qc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas las metodolog√≠as m√°s recientes sugieren fuertemente que necesita aumentar los derechos al obtener acceso. Por lo general, no hago esto localmente, ya que el primer acceso se considera simplemente como un punto de entrada a la red, y comprometer otra m√°quina en la misma red suele ser m√°s f√°cil y r√°pido que aumentar los privilegios en un host existente. Pero este no es el caso, ya que el canal DNS es muy estrecho y no permitir√° que el tr√°fico circule. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponiendo que este servidor con Windows 2003 no se repar√≥ de la famosa vulnerabilidad MS17-010, estoy canalizando el tr√°fico al puerto 445 / TCP a trav√©s del t√∫nel DNS meterpreter a localhost (s√≠, esto tambi√©n es posible) e intento ejecutar un exe previamente descargado a trav√©s de la vulnerabilidad. El ataque funciona, obtengo una segunda conexi√≥n, pero con privilegios de SYSTEM.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bv/mq/em/bvmqempcbcjfwu7colpyjhiupju.png"></div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Curiosamente, el servidor todav√≠a estaba tratando de protegerse contra MS17-010: hab√≠a deshabilitado los servicios de red vulnerables en la interfaz externa. </font><font style="vertical-align: inherit;">Esto realmente protege contra ataques a trav√©s de la red, pero el ataque desde dentro del localhost funcion√≥, ya que no puede simplemente tomar y apagar r√°pidamente SMB en localhost.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A continuaci√≥n, se revelan nuevos detalles interesantes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al tener permisos de SISTEMA, puede instalar f√°cilmente la conexi√≥n a trav√©s de TCP. </font><font style="vertical-align: inherit;">Obviamente, la prohibici√≥n del TCP directo es exclusivamente un problema de usuario limitado de IIS. </font><font style="vertical-align: inherit;">Spoiler: el tr√°fico de usuarios de IIS estaba envuelto de alguna manera en el Proxy ISA local en ambas direcciones. </font><font style="vertical-align: inherit;">C√≥mo funciona exactamente esto no se reproduce.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estoy en un cierto "DMZ" (y esto no es un dominio de Active Directory, pero GRUPO DE TRABAJO) - suena l√≥gico. </font><font style="vertical-align: inherit;">Pero en lugar de la direcci√≥n IP privada ("gris") esperada, soy bastante "blanco", exactamente lo mismo que ataqu√© antes. </font><font style="vertical-align: inherit;">Esto significa que la compa√±√≠a es tan antigua para el mundo del direccionamiento IPv4 que puede permitirse mantener la zona DMZ en 128 direcciones "blancas" sin NAT seg√∫n el esquema, como se ilustra en los manuales de Cisco de 2005.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como el servidor es antiguo, Mimikatz est√° garantizado para trabajar directamente desde la memoria:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qn/bu/tk/qnbutkh_dfi7ngbtp1cguanlf5q.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recibo la contrase√±a del administrador local, hago un t√∫nel del tr√°fico RDP a trav√©s de TCP y entro en un escritorio acogedor. </font><font style="vertical-align: inherit;">Como puede hacer cualquier cosa con el servidor, elimino el antivirus, encuentro que solo se puede acceder al servidor desde Internet en los puertos TCP 80 y 443, y 443 no estaba ocupado. </font><font style="vertical-align: inherit;">Elevo el servidor OpenVPN a 443, agrego las funciones NAT para mi tr√°fico VPN y obtengo acceso directo a la red DMZ de forma ilimitada a trav√©s de mi OpenVPN. </font><font style="vertical-align: inherit;">Es de destacar que ISA, con algunas funciones de IPS no desactivadas, bloque√≥ mi tr√°fico con escaneo de puertos, por lo que tuvo que ser reemplazado por un RRAS m√°s simple y flexible. </font><font style="vertical-align: inherit;">Entonces los pentesters a veces todav√≠a tienen que administrar todo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y3/cs/rb/y3csrbtb7drx_oh7bcswhqf8apq.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un lector atento preguntar√°: "¬øY cu√°l es el segundo sitio: un wiki con autenticaci√≥n NTLM, sobre el que tanto se ha escrito?" </font><font style="vertical-align: inherit;">Sobre esto m√°s all√°.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 2. ¬øTodav√≠a no est√°s encriptando? </font><font style="vertical-align: inherit;">Entonces vamos </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a ti</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ya aqu√≠</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, hay acceso al segmento de red DMZ. </font><font style="vertical-align: inherit;">Debe ir al administrador del dominio. </font><font style="vertical-align: inherit;">Lo primero que viene a la mente es verificar autom√°ticamente la seguridad de los servicios dentro del segmento DMZ, m√°s a√∫n porque ahora est√°n mucho m√°s abiertos a la investigaci√≥n. </font><font style="vertical-align: inherit;">Una imagen t√≠pica en una prueba de penetraci√≥n: el per√≠metro externo est√° mejor protegido que los servicios internos, y cuando obtiene acceso a una infraestructura grande, es mucho m√°s f√°cil obtener derechos extendidos en un dominio solo porque este dominio comienza a ser accesible para las herramientas, y en segundo lugar, Siempre hay un par de problemas cr√≠ticos en la infraestructura para varios miles de hosts.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cargo esc√°neres en DMZ a trav√©s del t√∫nel OpenVPN, espero. Abro el informe; de ‚Äã‚Äãnuevo, nada serio, aparentemente alguien camin√≥ de la misma manera hacia m√≠. El siguiente paso es examinar c√≥mo se comunican los hosts dentro de la red DMZ. Para hacer esto, para empezar, se lanza un Wireshark regular con escucha de solicitudes de transmisi√≥n, principalmente ARP. Los paquetes ARP fueron recolectados todo el d√≠a. Resulta que se utilizan varias puertas de enlace en este segmento. Esto ser√° √∫til m√°s tarde. Al pegar datos en la solicitud de respuesta ARP y los datos de escaneo de puertos, encontr√© los puntos de salida del tr√°fico de usuarios desde dentro de la red local adem√°s de los servicios que se conoc√≠an anteriormente, como la web y el correo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como en este momento no ten√≠a acceso a otros sistemas y no hab√≠a una sola cuenta para servicios corporativos, se decidi√≥ obtener al menos alguna cuenta del tr√°fico utilizando ARP Spoofing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cain &amp; Abel se lanz√≥ en el servidor del ur√≥logo. </font><font style="vertical-align: inherit;">Teniendo en cuenta los flujos de tr√°fico identificados, se seleccionaron los pares m√°s prometedores para el ataque "hombre en el medio", luego, mediante un lanzamiento a corto plazo durante 5-10 minutos, con un temporizador para reiniciar el servidor en caso de "congelamiento", se recibi√≥ algo de tr√°fico de red. </font><font style="vertical-align: inherit;">Como en la broma, hab√≠a dos novedades:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bien: se tomaron muchas credenciales y el ataque en su conjunto funcion√≥.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Malo: todas las credenciales eran de clientes del propio cliente. </font><font style="vertical-align: inherit;">Al proporcionar servicios de soporte, los especialistas del cliente se conectaron a servicios al cliente que no siempre ten√≠an configurado el cifrado de tr√°fico.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtuve muchas credenciales que eran in√∫tiles en el contexto del proyecto, pero definitivamente interesantes como una demostraci√≥n del peligro de un ataque. Enrutadores fronterizos de grandes empresas con telnet, reenv√≠o de depuraci√≥n de puertos http a CRM interno con todos los datos, acceso directo a RDP desde Windows XP en la red local y otro oscurantismo. Result√≥ una especie de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compromiso de la cadena</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">suministro seg√∫n la matriz MITRE</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n encontr√© una oportunidad divertida para recopilar correos electr√≥nicos del tr√°fico, algo como esto. Este es un ejemplo de una carta terminada que pas√≥ de nuestro cliente al puerto SMTP de su cliente, nuevamente, sin encriptaci√≥n. Cierto Andrei le pide a su hom√≥nimo que reenv√≠e la documentaci√≥n, y se presenta en un disco en la nube con un nombre de usuario, contrase√±a y enlace en una carta de respuesta:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ec/mo/y1/ecmoy10hbidcsgl7809ldpkx1fu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es otro recordatorio de que necesita cifrar todos los servicios. No se sabe qui√©n y cu√°ndo leer√° y aplicar√° espec√≠ficamente sus datos: un proveedor, un administrador del sistema de otra compa√±√≠a o un pentestador. Estoy en silencio porque muchos simplemente pueden interceptar el tr√°fico no cifrado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pesar del aparente √©xito, esto no se acerc√≥ a la meta. Era posible, por supuesto, sentarse durante mucho tiempo y obtener informaci√≥n valiosa, pero no el hecho de que hubiera aparecido all√≠, y el ataque en s√≠ mismo es muy arriesgado en t√©rminos de integridad de la red.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de otra b√∫squeda en los servicios, se me ocurri√≥ una idea interesante. Existe una utilidad llamada Responder (es f√°cil encontrar ejemplos de aplicaciones con este nombre) que, al "envenenar" las solicitudes de difusi√≥n, provoca conexiones a trav√©s de una variedad de protocolos como SMB, HTTP, LDAP, etc. de diferentes maneras, a cada persona que se conecta se le pide que se autentique y se ajuste para que la autenticaci√≥n pase a trav√©s de NTLM y en un modo transparente para la v√≠ctima. Muy a menudo, un atacante recopila los apretones de manos NetNTLMv2 y de ellos, seg√∫n el diccionario, recupera r√°pidamente las contrase√±as de dominio del usuario. Quer√≠a algo similar aqu√≠, pero los usuarios estaban sentados "detr√°s de la pared", o mejor dicho, estaban separados por un firewall, y en la WEB pasaron por el cl√∫ster proxy de Blue Coat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recuerde, especifiqu√© que el nombre de dominio de Active Directory coincid√≠a con el dominio "externo", es decir, ¬øera company.ru? Entonces, Windows, m√°s precisamente Internet Explorer (y Edge, y Chrome), permiten al usuario autenticarse de forma transparente en HTTP a trav√©s de NTLM, si consideran que el sitio est√° en alguna "Zona de Intranet". Una de las se√±ales de "Intranet" es una llamada a una direcci√≥n IP "gris" o un nombre DNS corto, es decir, sin puntos. Como un servidor con una IP "blanca" y un nombre DNS preobrazhensky.company.ru estaba a su disposici√≥n, y las m√°quinas de dominio generalmente obtienen el sufijo de dominio de Active Directory a trav√©s de DHCP para simplificar la entrada de nombres, solo ten√≠an que escribir la URL </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">preobrazhensky</font></a><font style="vertical-align: inherit;"> en la barra de direcciones</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para que encuentren el camino correcto hacia un servidor de ur√≥logos comprometido, sin olvidar que ahora se llama "Intranet". </font><font style="vertical-align: inherit;">Es decir, al mismo tiempo que me da el usuario de apret√≥n de manos NTLM sin su conocimiento. </font><font style="vertical-align: inherit;">Queda por hacer que los navegadores de los clientes piensen en la urgente necesidad de acceder a este servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La maravillosa utilidad Intercepter-NG vino al rescate (gracias</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interceptor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Le permit√≠a cambiar el tr√°fico sobre la marcha y funcionaba perfectamente en Windows 2003. Incluso hab√≠a una funcionalidad separada para modificar solo archivos JavaScript en el flujo de tr√°fico. Se plane√≥ una especie de scripting masivo entre sitios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proxies de Blue Coat a trav√©s de los cuales los usuarios acced√≠an peri√≥dicamente al contenido est√°tico en cach√© de la WEB global. Al interceptar el tr√°fico, qued√≥ claro que trabajan las 24 horas del d√≠a, solicitando sin cesar estad√≠sticas de uso frecuente para acelerar la visualizaci√≥n del contenido durante las horas pico. Adem√°s, BlueCoat ten√≠a un User-Agent espec√≠fico, que lo distingu√≠a claramente de un usuario vivo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se prepar√≥ Javascript, que con la ayuda de Intercepter-NG por la noche pas√≥ una hora completa implementando cada respuesta con archivos JS para Blue Coat. El gui√≥n hizo lo siguiente:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detectado el navegador actual por User-Agent. </font><font style="vertical-align: inherit;">Si era Internet Explorer, Edge o Chrome, funcion√≥.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperado hasta que se forme el DOM de la p√°gina.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insert√© una imagen invisible con el atributo src del tipo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preobrazhensky en el DOM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 8080 / NNNNNNN.png, donde NNN son d√≠gitos arbitrarios para que BlueCoat no se almacene en cach√©.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establezca una variable de marca global que indique que se realiz√≥ la inyecci√≥n y que ya no necesita insertar im√°genes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El navegador intent√≥ cargar esta imagen, en el puerto 8080 del servidor comprometido, estaba esperando el t√∫nel TCP a mi computadora port√°til, donde se lanz√≥ el mismo Respondedor, que requiere el inicio de sesi√≥n NTLM desde el navegador.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ht/p8/d-/htp8d-9mcytkfs2ov2yuom9bm4i.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A juzgar por los registros del Respondedor, por la ma√±ana las personas vinieron a trabajar, encendieron sus estaciones de trabajo, luego comenzaron a visitar el servidor del ur√≥logo en masa e imperceptiblemente, sin olvidar "fusionar" los apretones de manos NTLM. </font><font style="vertical-align: inherit;">Los apretones de manos llovieron todo el d√≠a y claramente acumul√≥ material para un ataque de recuperaci√≥n de contrase√±a notoriamente exitoso. </font><font style="vertical-align: inherit;">As√≠ es como se ve√≠an los registros del Respondedor:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/aj/ba/yt/ajbaytlvh2okb4xknkzalcniqyc.png"></div><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visitas secretas masivas al servidor del ur√≥logo por parte de los usuarios</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Probablemente ya haya notado que toda esta historia se basa en el principio "todo estuvo bien, pero hubo un fastidio, luego hubo superaci√≥n y luego todo lleg√≥ al √©xito". </font><font style="vertical-align: inherit;">Entonces, hubo un fastidio. </font><font style="vertical-align: inherit;">De los quinientos apretones de manos √∫nicos, ninguno fue revelado. </font><font style="vertical-align: inherit;">Y esto tiene en cuenta el hecho de que incluso en una computadora port√°til con un procesador inactivo, estos apretones de manos NTLMv2 se superan a la velocidad de varios cientos de millones de intentos por segundo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tuve que armarme con t√©cnicas de mutaci√≥n de contrase√±a, una tarjeta gr√°fica, un diccionario m√°s grueso y esperar. </font><font style="vertical-align: inherit;">Despu√©s de mucho tiempo, se abrieron varias cuentas con contrase√±as de la forma "Q11111111 ... .1111111q", lo que sugiere que todos los usuarios se vieron obligados a encontrar una contrase√±a muy larga con un caso diferente de caracteres, lo que se supon√≠a que era complicado. </font><font style="vertical-align: inherit;">Pero no puede fallarle a un usuario experimentado, y de esta manera √©l lo hizo m√°s f√°cil de recordar. </font><font style="vertical-align: inherit;">En total, se abrieron alrededor de 5 piezas, y solo una de ellas ten√≠a derechos valiosos sobre los servicios.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 3. Roskomnadzor contraataca</font></font><br>
</h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, se recibieron las primeras cuentas de dominio. </font><font style="vertical-align: inherit;">Si en este punto no se qued√≥ dormido despu√©s de una lectura larga, probablemente recordar√° que mencion√© un servicio que no requer√≠a un segundo factor de autenticaci√≥n: este es un wiki con autenticaci√≥n NTLM. </font><font style="vertical-align: inherit;">Por supuesto, lo primero que hicieron fue entrar. </font><font style="vertical-align: inherit;">Profundizar en la base de conocimiento interna r√°pidamente trajo resultados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La compa√±√≠a tiene una red WiFi con autenticaci√≥n de cuenta de dominio con acceso a una red local. </font><font style="vertical-align: inherit;">Con el conjunto de datos actual, este ya es un vector de ataque funcional, pero debe ir a la oficina con los pies y ubicarse en alg√∫n lugar de la oficina del cliente.</font></font></li>
<li> ,    , ‚Ä¶    ¬´ ¬ª ,              .    ¬´¬ª  ¬´¬ª        .      ,       DMZ.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, el "segundo factor" se agreg√≥ inmediatamente a la cuenta comprometida como una aplicaci√≥n en mi tel√©fono. Hubo un programa que puede enviar en voz alta una solicitud de inserci√≥n al tel√©fono con los botones "aprobar" / "desaprobar", o mostrar silenciosamente el c√≥digo OTP en la pantalla para una entrada independiente adicional. Adem√°s, se supon√≠a que el primer m√©todo era la √∫nica instrucci√≥n correcta, pero no funcion√≥, a diferencia del m√©todo OTP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con el "segundo factor" roto, logr√© iniciar sesi√≥n en el correo de Outlook Web Access y acceder de forma remota a Citrix Netscaler Gateway. En Outlook, una sorpresa esperaba en el correo:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l8/3r/hr/l83rhrmhg4o8cn1ghrhhyjqagrg.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En esta rara toma se puede ver c√≥mo Roskomnadzor ayuda a los pentesters.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Estos fueron los primeros meses despu√©s del famoso bloqueo de fan de Telegram, cuando redes enteras a miles de direcciones desaparecieron inexorablemente del acceso. Qued√≥ claro por qu√© empujar no funcion√≥ de inmediato y por qu√© mi "v√≠ctima" no hizo sonar la alarma porque comenzaron a usar su cuenta en horario abierto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquellos que est√°n familiarizados con Citrix Netscaler imaginan que generalmente se implementa de tal manera que es posible transmitir al usuario solo una interfaz de imagen, tratando de no darle las herramientas para lanzar aplicaciones de terceros y transferir datos, restringiendo de todas las formas posibles las acciones a trav√©s de shells de control est√°ndar. Por mi ocupaci√≥n, solo obtuve 1C:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/jl/oy/wi/jloywi1o1ollk3__dpvedswgina.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de caminar un poco en la interfaz 1C, descubr√≠ que hay m√≥dulos de procesamiento externos all√≠. </font><font style="vertical-align: inherit;">Se pueden cargar desde la interfaz y se ejecutar√°n en el cliente o servidor, seg√∫n los derechos y la configuraci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le ped√≠ a mis amigos programadores de 1C que crearan un procesamiento que tomara una cadena y la ejecutara. </font><font style="vertical-align: inherit;">En 1C, el lanzamiento del proceso se parece a esto (tomado de Internet). </font><font style="vertical-align: inherit;">De acuerdo, ¬øla sintaxis del lenguaje 1C golpea a una persona de habla rusa con su inmediatez? </font></font><br>
<br>
<img width="600" src="https://habrastorage.org/webt/su/_m/ec/su_mecdfowq1wm2voklffkf4zeu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El procesamiento se ejecut√≥ perfectamente, result√≥ lo que los Pentesters llaman el "shell": Internet Explorer se lanz√≥ a trav√©s de √©l.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/5v/xd/kj/5vxdkjtdo7aowdfvpfgj0hdrfso.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anteriormente, la direcci√≥n del sistema se encontraba en el correo, lo que le permite ordenar pases al territorio. </font><font style="vertical-align: inherit;">Ped√≠ un pase en caso de que tenga que usar el vector de ataque a trav√©s de WiFi.</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/dc/xj/sg/dcxjsgmg53xnrzopu0j6_mlxx9s.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Internet, dicen que en la oficina del cliente todav√≠a hab√≠a un sabroso servicio de catering gratuito, pero todav√≠a prefer√≠a desarrollar un ataque a trav√©s de un sitio remoto, es m√°s tranquilo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AppLocker se activ√≥ en el servidor de aplicaciones con Citrix, pero se omiti√≥. </font><font style="vertical-align: inherit;">El mismo Meterpreter se carg√≥ e inici√≥ a trav√©s de DNS, porque las versiones http (s) no quer√≠an conectarse, y entonces no conoc√≠a la direcci√≥n proxy interna. </font><font style="vertical-align: inherit;">Por cierto, a partir de este momento, el pentest externo se convirti√≥ esencialmente en el interno.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 4. Derechos de administrador para los usuarios: esto es malo, p-nyatnenko?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo primero que hace un Pentester cuando toma el control de la sesi√≥n de un usuario de dominio es recopilar toda la informaci√≥n sobre los derechos en el dominio. </font><font style="vertical-align: inherit;">Existe tal utilidad BloodHound, que autom√°ticamente le permite descargar informaci√≥n sobre usuarios, computadoras, grupos de seguridad a trav√©s del protocolo LDAP desde el controlador de dominio, e informaci√≥n sobre qu√© usuario ha iniciado sesi√≥n recientemente y qui√©n es el administrador local a trav√©s de SMB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una t√©cnica t√≠pica para capturar privilegios de administrador de dominio parece simplificada como un ciclo de acciones mon√≥tonas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos a las computadoras de dominio, donde hay derechos de administrador local, basados ‚Äã‚Äãen cuentas de dominio ya capturadas.</font></font></li>
<li> Mimikatz    ,  Kerberos   NTLM  ,       .      lsass.exe        .     Windows  2012R2/Windows 8.1    .</li>
<li>,       .   .  -      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Fin del ciclo", como los programadores de 1C escribir√≠an aqu√≠. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, nuestro usuario result√≥ ser un administrador local en un solo host con Windows 7, cuyo nombre era la palabra "VDI", o "Infraestructura de escritorio virtual", m√°quinas virtuales personales. </font><font style="vertical-align: inherit;">Probablemente, el dise√±ador del servicio VDI dio a entender que dado que VDI es el sistema operativo personal del usuario, permita que el usuario cambie el entorno del software, como lo desee, de todos modos el host puede ser "recargado". </font><font style="vertical-align: inherit;">Tambi√©n pens√© que, en general, la idea es buena, fui a este host VDI personal e hice un socket all√≠:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instal√© el cliente OpenVPN all√≠, que hizo un t√∫nel a trav√©s de Internet a mi servidor. </font><font style="vertical-align: inherit;">El cliente tuvo que pasar por el mismo Blue Coat con autenticaci√≥n de dominio, pero OpenVPN se las arregl√≥, como dicen, fuera de la caja.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalado en VDI OpenSSH. </font><font style="vertical-align: inherit;">Bueno, realmente, ¬øqu√© es este Windows 7 sin SSH?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve√≠a vivo. </font><font style="vertical-align: inherit;">Les recuerdo que todo esto debe hacerse a trav√©s de Citrix y 1C:</font></font><br>
<br>
<div style="text-align:center;"><img width="600" src="https://habrastorage.org/webt/tc/4p/g8/tc4pg8otdktkxljex7oblfldjo0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una de las t√©cnicas para promover el acceso a las computadoras vecinas es verificar las contrase√±as de los administradores locales para encontrar una coincidencia. </font><font style="vertical-align: inherit;">Aqu√≠ la suerte estaba esperando de inmediato: el hash NTLM del administrador local predeterminado (que de repente se llam√≥ Administrador) se acerc√≥ a los hosts VDI vecinos, de los cuales hab√≠a varios cientos, a trav√©s del ataque de pasar el hash. </font><font style="vertical-align: inherit;">Por supuesto, el ataque fue inmediatamente sobre ellos.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luego, los administradores de VDI se dispararon dos veces en el pie:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La primera vez que LAPS no activ√≥ las m√°quinas VDI, esencialmente guard√≥ la misma contrase√±a de administrador local de una imagen que se implement√≥ masivamente en VDI.</font></font></li>
<li>   ‚Äî   ,    pass-the-hash .          ,         ,   ‚Äî .</li>
</ul></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© el servicio SSH en ese Windows? Muy simple: ahora el servidor OpenSSH no solo proporcion√≥ un conveniente shell de comandos interactivos sin interferir con el trabajo del usuario, sino tambi√©n un proxy socks5 en VDI. A trav√©s de estos calcetines, me conect√© a trav√©s de SMB y recopil√© cuentas en cach√© de todos estos cientos de m√°quinas VDI, luego busqu√© la ruta al administrador del dominio en los gr√°ficos de BloodHound. Con cientos de hosts a mi disposici√≥n, encontr√© este camino bastante r√°pido. Se han obtenido derechos de administrador de dominio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ hay una imagen de Internet, que muestra una b√∫squeda similar. Los enlaces muestran qui√©n es el administrador y qui√©n ingres√≥ d√≥nde.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hm/49/aa/hm49aasvb46cltksyxo-ugguwns.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por cierto, recuerde la condici√≥n desde el inicio del proyecto: "no aplique la ingenier√≠a social". </font><font style="vertical-align: inherit;">Por lo tanto, propongo reflexionar sobre cu√°nto se cortar√≠a todo este Bollywood con efectos especiales, si de todos modos se pudiera aplicar el phishing banal. </font><font style="vertical-align: inherit;">Pero personalmente estaba muy interesado en hacer todo esto. </font><font style="vertical-align: inherit;">Espero que te haya interesado leer esto. </font><font style="vertical-align: inherit;">Por supuesto, no todos los proyectos parecen tan intrigantes, pero el trabajo en su conjunto es muy desconcertante y no se estanca. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probablemente, alguien tendr√° una pregunta: ¬øc√≥mo protegerse? </font><font style="vertical-align: inherit;">Incluso en este art√≠culo, se describen muchas t√©cnicas, los administradores de Windows ni siquiera conocen muchas de ellas. </font><font style="vertical-align: inherit;">Sin embargo, propongo mirarlos desde la perspectiva de principios tristes y medidas de seguridad de la informaci√≥n:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no use software desactualizado (¬ørecuerda Windows 2003 al principio?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no mantenga los sistemas innecesarios encendidos (¬øpor qu√© estaba el sitio del ur√≥logo?)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verifique las contrase√±as de los usuarios para obtener fortaleza (de lo contrario, los </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soldados ... los</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pentesters </font><font style="vertical-align: inherit;">har√°n esto </font><font style="vertical-align: inherit;">)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No tiene las mismas contrase√±as para diferentes cuentas (compromiso de VDI)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y otra</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, es muy dif√≠cil de implementar, pero en el pr√≥ximo art√≠culo mostraremos en la pr√°ctica que esto es bastante posible.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es496702/index.html">PCI Express en los FPGA Intel de la serie V: funciones b√°sicas de interfaz y caracter√≠sticas principales del hardware</a></li>
<li><a href="../es496704/index.html">PCB del cohete Saturn-5: ingenier√≠a inversa con explicaciones</a></li>
<li><a href="../es496706/index.html">Lectura de fin de semana: una historia de formatos de audio: la era de los casetes y el desarrollo de tecnolog√≠as de s√≠ntesis de voz</a></li>
<li><a href="../es496708/index.html">Pistola espacial, cohete de vapor y espejo orbital</a></li>
<li><a href="../es496710/index.html">Informaci√≥n de la computadora: simple y r√°pida</a></li>
<li><a href="../es496714/index.html">Power Automate VS Logic Apps. Informaci√≥n general</a></li>
<li><a href="../es496716/index.html">Power Automate VS Logic Apps. Poder automatizar casos</a></li>
<li><a href="../es496720/index.html">Proyecto LLHD - Lenguaje de descripci√≥n de hardware universal</a></li>
<li><a href="../es496722/index.html">API de Tinkov, inversi√≥n. Primeros pasos</a></li>
<li><a href="../es496726/index.html">Gent hasta el fondo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>