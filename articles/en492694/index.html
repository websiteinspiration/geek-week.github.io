<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜñ üöç üï∞Ô∏è Recipes for ailing SQL queries üé∞ üêæ ‚ûó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few months ago, we announced explain.tensor.ru , a public service for parsing and visualizing PostgreSQL query plans . 
 
 Over the past time, you h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Recipes for ailing SQL queries</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492694/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A few months ago, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we announced </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">explain.tensor.ru</font></font></b></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a public </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service for parsing and visualizing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PostgreSQL </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">query plans</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Over the past time, you have already used it more than 6,000 times, but one of the convenient functions could go unnoticed - these are </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">structural hints</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that look something like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jp/66/1s/jp661svgeudxc0wvgnzqoyjffbc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listen to them and your requests will ‚Äúbecome smooth and silky.‚Äù :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But seriously, many of the situations that make the request slow and ‚Äúgluttonous‚Äù in terms of resources </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are typical and can be recognized by the structure and data of the plan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, each individual developer will not have to look for an optimization option on their own, relying solely on their experience - we can tell him what is happening here, what could be the reason, and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how to approach the solution</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Which we did. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/br/mr/upbrmra7tcpkdnygwg0abfhbqse.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take a closer look at these cases - how they are determined and what recommendations they lead to.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For a better insight into the topic, you can first listen to the corresponding block from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my report on PGConf.Russia 2020</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and only then go on to a detailed analysis of each example:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/jHqaLp040rY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1: index "undersorting"</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When arises</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Show the last invoice for the client "LLC Bell".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to recognize</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Limit<font></font>
   -&gt; Sort<font></font>
      -&gt; Index [Only] Scan [Backward] | Bitmap Heap Scan<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use the index used </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to sort fields</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk  <span class="hljs-comment">-- 100K ""</span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli); <span class="hljs-comment">--   foreign key</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_cli = <span class="hljs-number">1</span> <span class="hljs-comment">--    </span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  pk <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--    "" </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/nn/u1/wp/nnu1wpmpqryyy3rrpmhpofv1izk.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru] You</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
can immediately notice that the index subtracted more than 100 entries, which were then sorted, and then the only one was left. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We fix:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> tbl_fk_cli_idx;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli, pk <span class="hljs-keyword">DESC</span>); <span class="hljs-comment">--   </span>
</code></pre><br>
<img src="https://habrastorage.org/webt/gv/ny/ni/gvnyniyvlmcsfk-f2qk4voomvzo.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Even on such a primitive sample - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8.5 times faster and 33 times less readings</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The effect will be more visible the more ‚Äúfacts‚Äù you have for each value </font></font><code>fk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I note that such an index will work as "prefix" no worse than the previous one for other queries with </font></font><code>fk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, where </font></font><code>pk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there was no </font><font style="vertical-align: inherit;">sorting </font><font style="vertical-align: inherit;">and no </font><font style="vertical-align: inherit;">sorting </font><font style="vertical-align: inherit;">(more about this can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in my article about finding inefficient indexes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">In particular, it will provide normal </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support for an explicit foreign key</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in this field.</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2: index intersection (BitmapAnd)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When arises</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Show all the contracts for the client LLC Kolokolchik concluded on behalf of NAO Buttercup.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to recognize</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; BitmapAnd<font></font>
   -&gt; Bitmap Index Scan<font></font>
   -&gt; Bitmap Index Scan</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">composite index</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for the fields from both the source or expand one of the existing fields from the second. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk      <span class="hljs-comment">-- 100K ""</span>
, (random() *  <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> fk_org  <span class="hljs-comment">-- 100   </span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org); <span class="hljs-comment">--   foreign key</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli); <span class="hljs-comment">--   foreign key</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  (fk_org, fk_cli) = (<span class="hljs-number">1</span>, <span class="hljs-number">999</span>); <span class="hljs-comment">--    </span></code></pre><br>
<img src="https://habrastorage.org/webt/dh/y4/mz/dhy4mzknpsqyk3ejuetev5mlmiy.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correct:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">INDEX</span> tbl_fk_org_idx;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org, fk_cli);
</code></pre><br>
<img src="https://habrastorage.org/webt/vt/nm/2c/vtnm2csqildllccdfsffjgxu4ya.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Here the gain is less, because Bitmap Heap Scan is quite effective in itself. </font><font style="vertical-align: inherit;">But still </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 times faster and 2.5 times less readings</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3: index pooling (BitmapOr)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When arises</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Show the first 20 oldest ‚Äúown‚Äù or unassigned applications for processing, and their priority.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to recognize</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; BitmapOr<font></font>
   -&gt; Bitmap Index Scan<font></font>
   -&gt; Bitmap Index Scan</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UNION [ALL]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to combine subqueries for each of the OR blocks of conditions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk  <span class="hljs-comment">-- 100K ""</span>
, <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span> random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">16</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--   1:16  ""</span>
    <span class="hljs-keyword">ELSE</span> (random() * <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> <span class="hljs-comment">-- 100   </span>
  <span class="hljs-keyword">END</span> fk_own;<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_own, pk); <span class="hljs-comment">--   "  " </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_own = <span class="hljs-number">1</span> <span class="hljs-keyword">OR</span> <span class="hljs-comment">-- </span>
  fk_own <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">-- ...  ""</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk<font></font>
, (fk_own = <span class="hljs-number">1</span>) <span class="hljs-keyword">DESC</span> <span class="hljs-comment">--  ""</span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;
</code></pre><br>
<img src="https://habrastorage.org/webt/7k/n2/d1/7kn2d1ko1hrbobs44a69hasatcs.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correct:</font></font><br>
<br>
<pre><code class="sql hljs">(
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  <span class="hljs-keyword">WHERE</span>
    fk_own = <span class="hljs-number">1</span> <span class="hljs-comment">--  "" 20</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
    pk<font></font>
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span><font></font>
)<font></font>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><font></font>
(<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    tbl<font></font>
  <span class="hljs-keyword">WHERE</span>
    fk_own <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  "" 20</span>
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
    pk<font></font>
  <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span><font></font>
)<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>; <span class="hljs-comment">--   - 20,    </span></code></pre><br>
<img src="https://habrastorage.org/webt/pa/ej/2f/paej2f1lpkzhinvlz64tvf9n8ti.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We took advantage of the fact that all 20 necessary records were immediately received in the first block, so the second one, with the more ‚Äúexpensive‚Äù Bitmap Heap Scan, was not even performed - as a result </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, 22 times faster, in 44 times less readings</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A more detailed story about this optimization method </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using specific examples</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be found in the articles of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: harmful JOIN and OR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: a tale about iterative refinement of the search by name, or ‚ÄúOptimization there and back‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A generalized version of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ordered selection by several keys</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (and not just by a const / NULL pair) is considered in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SQL HowTo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> article </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">: we write a while-loop directly in the query, or ‚ÄúElementary three-way‚Äù</font></a><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4: read a lot of unnecessary</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When arises</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a rule, it arises if you want to ‚Äúfasten another filter‚Äù to an existing request.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúAnd you don‚Äôt have the same, but </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with pearl buttons</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?‚Äù </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">film "Diamond Hand"</font></font></i><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, modifying the task above, show the first 20 oldest ‚Äúcritical‚Äù applications for processing, regardless of their purpose.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to recognize</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; 5 √ó rows &lt; RRbF --  &gt;80% <font></font>
   &amp;&amp; loops √ó RRbF &gt; 100 --     100  <font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a [more] custom </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">index with a WHERE clause</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or include additional fields in the index.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the filtering condition is ‚Äústatic‚Äù for your tasks ‚Äî that is, it </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not involve expanding the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> list of values ‚Äã‚Äãin the future ‚Äî it is better to use a WHERE index. </font><font style="vertical-align: inherit;">Different boolean / enum statuses fit well into this category. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the filter condition </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can take different values</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then it is better to expand the index with these fields - as in the situation with BitmapAnd above.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk <span class="hljs-comment">-- 100K ""</span>
, <span class="hljs-keyword">CASE</span>
    <span class="hljs-keyword">WHEN</span> random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">16</span> <span class="hljs-keyword">THEN</span> <span class="hljs-literal">NULL</span>
    <span class="hljs-keyword">ELSE</span> (random() * <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> <span class="hljs-comment">-- 100   </span>
  <span class="hljs-keyword">END</span> fk_own<font></font>
, (random() &lt; <span class="hljs-number">1</span>::<span class="hljs-built_in">real</span>/<span class="hljs-number">50</span>) <span class="hljs-keyword">critical</span>; <span class="hljs-comment">-- 1:50,   ""</span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(pk);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_own, pk);<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  <span class="hljs-keyword">critical</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/ca/lg/hn/calghnldd9_313mns2a535sjwma.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correct:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(pk)
  <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">critical</span>; <span class="hljs-comment">--  ""  </span>
</code></pre><br>
<img src="https://habrastorage.org/webt/op/t2/u4/opt2u4yh2mzocmdot9qovn6pzgu.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As you can see, filtering has completely disappeared from the plan, and the request has become </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 times faster</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 5: sparse table</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When arises</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Various attempts to make their own queue of processing tasks when a large number of updates / deletes of records on the table lead to a situation of a large number of "dead" records.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to recognize</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; loops √ó (rows + RRbF) &lt; (shared hit + shared read) √ó 8<font></font>
      --   1KB   <font></font>
   &amp;&amp; shared hit + shared read &gt; 64<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Manually carry out </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM [FULL]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manually </font><font style="vertical-align: inherit;">or achieve adequate frequent </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autovacuum</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> testing </font><font style="vertical-align: inherit;">by fine-tuning its parameters, including </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for a specific table</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In most cases, these problems are caused by poorly structured queries when calling from business logic, such as those discussed in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: fighting hordes of the ‚Äúdead‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But you need to understand that even VACUUM FULL may not always help. </font><font style="vertical-align: inherit;">For such cases, you should familiarize yourself with the algorithm from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> article </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">: when VACUUM passes, we clean the table manually</font></a><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 6: reading from the middle of the index</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When arises</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that they didn‚Äôt read much, and everything was indexed, and they didn‚Äôt filter anyone else - but anyway, significantly more pages were read than we would like.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to recognize</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Index [Only] Scan [Backward]<font></font>
   &amp;&amp; loops √ó (rows + RRbF) &lt; (shared hit + shared read) √ó 8<font></font>
      --   1KB   <font></font>
   &amp;&amp; shared hit + shared read &gt; 64<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Closely look at the structure of the index used and the key fields specified in the request - most likely, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">part of the index is not specified</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Most likely, you will have to create a similar index, but without prefix fields or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">learn how to iterate over their values</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">100000</span>) pk      <span class="hljs-comment">-- 100K ""</span>
, (random() *  <span class="hljs-number">100</span>)::<span class="hljs-built_in">integer</span> fk_org  <span class="hljs-comment">-- 100   </span>
, (random() * <span class="hljs-number">1000</span>)::<span class="hljs-built_in">integer</span> fk_cli; <span class="hljs-comment">-- 1K   </span><font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_org, fk_cli); <span class="hljs-comment">--     #2</span>
<span class="hljs-comment">--      fk_cli      </span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tbl<font></font>
<span class="hljs-keyword">WHERE</span>
  fk_cli = <span class="hljs-number">999</span> <span class="hljs-comment">--  fk_org  ,     </span>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">20</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/tl/py/lb/tlpylbllwrea5ilsf-epratclha.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It seems that everything is fine, even by index, but somehow suspiciously - for each of the 20 read records I had to subtract 4 pages of data, 32KB per record - isn't it bold? </font><font style="vertical-align: inherit;">Yes, and the name of the index is </font><font style="vertical-align: inherit;">suggestive. </font><font style="vertical-align: inherit;">
We fix:</font></font><code>tbl_<b>fk_org</b>_fk_cli_idx</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> tbl(fk_cli);</code></pre><br>
<img src="https://habrastorage.org/webt/n9/5x/uz/n95xuzh7tcrmlv3eqg-bq2axhk4.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Suddenly - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 times faster and 4 times less read</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Other examples of situations of inefficient use of indexes can be seen in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DBA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> article </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">: Find Useless Indexes</font></a><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 7: CTE √ó CTE</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When arises</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the query we </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typed ‚Äúfat‚Äù CTEs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from different tables, and then decided to do between them </font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The case is relevant for versions below v12 or requests from </font></font><code>WITH MATERIALIZED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to recognize</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; CTE Scan<font></font>
   &amp;&amp; loops &gt; 10<font></font>
   &amp;&amp; loops √ó (rows + RRbF) &gt; 10000<font></font>
      --     CTE<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Carefully analyze the request - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is CTE needed here at all</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font><font style="vertical-align: inherit;">If all the same, then </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apply ‚Äútearing‚Äù in hstore / json</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> according to the model described in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: hit the dictionary with a heavy JOIN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 8: swap to disk (temp written)</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When arises</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A single processing (sorting or uniqueization) of a large number of records does not fit into the memory allocated for this.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to recognize</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; *<font></font>
   &amp;&amp; temp written &gt; 0</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the amount of memory used by the operation does not greatly exceed the set value of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work_mem</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">, it is worth adjusting it. </font><font style="vertical-align: inherit;">You can immediately in the config for everyone, but you can through </font></font><code>SET [LOCAL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for a specific request / transaction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SHOW</span> work_mem;
<span class="hljs-comment">-- "16MB"</span><font></font>
<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  random()<font></font>
<span class="hljs-keyword">FROM</span>
  generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">1000000</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
  <span class="hljs-number">1</span>;</code></pre><br>
<img src="https://habrastorage.org/webt/x-/mu/my/x-mumysko4noy3qy8qhdk0fecpq.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Correct:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SET</span> work_mem = <span class="hljs-string">'128MB'</span>; <span class="hljs-comment">--   </span></code></pre><br>
<img src="https://habrastorage.org/webt/h0/4z/kx/h04zkxsgcscgj8yxdasba8jdi2s.png"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[look at explain.tensor.ru]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
For obvious reasons, if only memory is used, not a disk, then the request will be executed much faster. </font><font style="vertical-align: inherit;">At the same time, part of the load from the HDD is also removed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But you need to understand that allocating a lot of memory always does not work either - it will not be enough for everyone.</font></font><br>
<br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 9: irrelevant statistics</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When arises</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They poured a lot at once into the database, but did not manage to drive them away </font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to recognize</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; Seq Scan | Bitmap Heap Scan | Index [Only] Scan [Backward]<font></font>
   &amp;&amp; ratio &gt;&gt; 10</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do the same </font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This situation is described in more detail in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL Antipatterns: statistics are all over the head</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><br>
<h2><font color="#c00000"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 10: ‚Äúsomething went wrong‚Äù</font></font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When arises</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There was an expectation of a lock imposed by a competing request, or there were not enough CPU / hypervisor hardware resources.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to recognize</font></font></h4><br>
<pre><code class="plaintext hljs">-&gt; *<font></font>
   &amp;&amp; (shared hit / 8K) + (shared read / 1K) &lt; time / 1000<font></font>
      -- RAM hit = 64MB/s, HDD read = 8MB/s<font></font>
   &amp;&amp; time &gt; 100ms --  ,   <font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recommendations</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use an external </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">system to monitor the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server for locks or abnormal resource consumption. </font><font style="vertical-align: inherit;">About our version of the organization of this process for hundreds of servers, we already talked </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ts/bi/9s/tsbi9svuilrqhgpgftjytkknpk4.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/h7/zm/6d/h7zm6d-va_yx8g0mtxbdkyevcwq.png"></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492676/index.html">Memory on magnetic cores in the Saturn 5 rocket</a></li>
<li><a href="../en492678/index.html">Development of the first project on the platform of Microsoft Dynamics 365 For Finance and Operations</a></li>
<li><a href="../en492682/index.html">Testosterone, why is it for men and how to maintain strength in old age</a></li>
<li><a href="../en492684/index.html">Free proxy server for enterprise with domain authentication</a></li>
<li><a href="../en492686/index.html">When Linux conntrack is no longer your friend</a></li>
<li><a href="../en492696/index.html">On what to test algorithms for the recognition and processing of identity documents?</a></li>
<li><a href="../en492700/index.html">Internet declarative shopping with Payment Request API and Angular</a></li>
<li><a href="../en492702/index.html">Machine translate. From the cold war to the present</a></li>
<li><a href="../en492704/index.html">To increase the effectiveness of implant survival by 5-7 times - how is this possible?</a></li>
<li><a href="../en492706/index.html">Memory archives: how the brain encodes and reproduces memories</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>