<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧛 🏜️ 🧝🏾 werfを使用した分散CI / CDの編成 🙋🏾 🚴🏽 👨🏿‍🤝‍👨🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="werfは、アプリケーションを構築およびデプロイするためのオープンソースユーティリティです。本日、werfがバージョンv1.1.10（チャネルv1.1 alpha、beta、ea、stableで利用可能）以降、分散モードで動作するようになったことをお知らせします。接続するには、最小限の労力が必要です...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>werfを使用した分散CI / CDの編成</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/504390/"><img src="https://habrastorage.org/webt/xl/bp/lc/xlbplc9y3qygzics6y0djfpwn3i.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、アプリケーションを構築およびデプロイするためのオープンソースユーティリティです。</font><font style="vertical-align: inherit;">本日、werfがバージョンv1.1.10（チャネルv1.1 alpha、beta、ea、stableで利用可能）以降、分散モードで動作するようになったことをお知らせします。</font><font style="vertical-align: inherit;">接続するには、最小限の労力が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいモードの注目すべき機能の一部を以下に示します。</font></font><a name="habracut"></a><br>
<br>
<ul>
<li>   - ()   Docker- (stages storage);</li>
<li>     - ()   stapel;</li>
<li>     runner' (  )   werf;</li>
<li>        ;</li>
<li>     Kubernetes —       (     werf,    ,     ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dockerfileコレクターは分散モードでも使用できますが、高度な分散層キャッシュはまだサポートされていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、分散モードとは何か、その実装に必要なコンポーネントについては、まず説明します。</font><font style="vertical-align: inherit;">次に、このモードを有効にする方法と、werfを使用して既存のプロジェクトを（ローカルモードから）転送する方法を示します。</font><font style="vertical-align: inherit;">最後に、</font><font style="vertical-align: inherit;">werf分散アセンブリメカニズムを完全に利用</font><font style="vertical-align: inherit;">する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモプロジェクト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">について</font><font style="vertical-align: inherit;">考え</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一般情報</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Werfには、ビルドプロセスに関連するいくつかの重要な概念があります。ステージ、イメージ、ステージストレージです。</font><font style="vertical-align: inherit;">では</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメント、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のようにステージや画像が定義されています。</font></font><br>
<br>
<blockquote>      ,       .     ,    Docker.  werf    ,          .       (stages storage).</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ステージストアとは？</font><font style="vertical-align: inherit;">v1.1.10より前のバージョンでは、この質問は「これは単なるローカルDockerサーバーです。</font><font style="vertical-align: inherit;">ただし、現時点から、werfではDockerイメージのレジストリにステージを保存できます。</font><font style="vertical-align: inherit;">さらに、</font><font style="vertical-align: inherit;">現在利用可能な</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ほとんどの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Docker Registry </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">実装を</font></a><font style="vertical-align: inherit;">サポートしてい</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dockerレジストリをステージリポジトリとして使用すると、複数のホストにイメージを分散してアセンブリできます。</font><font style="vertical-align: inherit;">多くの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">便利な機能を備え</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たDockerfileに代わるstapelコレクターでは</font><font style="vertical-align: inherit;">、高度なレイヤーキャッシュを利用できます。</font><font style="vertical-align: inherit;">彼のために、ステージの選択と組み立てのための効果的で最適化されたアルゴリズムが実装されています：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ステージストアで入手可能な組み立て済みのステージは、新しいステージのアセンブリで使用されます。</font></font></li>
<li>     ,       .</li>
<li> ,    ,     Docker- (      ).</li>
<li>      ,   ,   , Docker Registry (    )     .       .</li>
<li>           :   ,        ,         .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dockerfileコレクターを使用して複数のホストでイメージを構築することもできますが、現時点では、高度な分散レイヤーキャッシュは実装されていません（ただし、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは行われます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分散モードの登場により、werfはDockerイメージに2つのレベルのキャッシングを提供します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ステージストアに格納されているステージ（DockerレジストリのDockerイメージ）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 各アセンブリノードのローカルDockerサーバー上にあるローカルステージ（Dockerイメージ）。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、画像リポジトリに画像が公開されています-私たちはそれらを品種と呼びます（3）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キャッシュは定期的にクリーンアップする必要があります。 Werfには、このための組み込みコマンドが</font></font><code>werf cleanup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり、（2）番目および（3）番目のタイプのDockerイメージを削除します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカルのDockerイメージ（1）はまだ手動で削除する必要があります（分散モードを使用する場合のみ）。これらの画像は、任意のツール（など</font></font><code>docker rmi</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を使用して削除できます</font><font style="vertical-align: inherit;">。 werfの将来のバージョンでは、アセンブリ関連のコマンドを実行すると、これらのイメージを自動的に削除できるようになります（80％のアセンブリノードのファイルシステムスペースを自動的にサポートするLRUベースのアルゴリズムを使用）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、werf分散モードはステージリポジトリ（Dockerレジストリ）のステージを使用し、新しいレイヤーの構築に必要なイメージのみを抽出します（ベースイメージのみがダウンロードされます）。</font><font style="vertical-align: inherit;">同時に、アイドルアセンブリ中（画像が実際に収集されない場合）には、画像はまったく抽出されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コレクターのアルゴリズムとアーキテクチャーの詳細については、ドキュメントをご覧ください。</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ（ステージ）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップストレージ（ストレージステージ）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノードの要件</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分散モードで作業するには、werfにKubernetesクラスターへの接続が必要です。</font><font style="vertical-align: inherit;">Kubernetesは、次の場合に多くのwerfプロセスを調整するために使用されます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ステージリポジトリでのステージの選択と記録。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 画像をリポジトリに公開する。</font></font></li>
<li>      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このKubernetesクラスターを使用してアプリケーションをデプロイするかどうかは関係ありません。唯一の要件は、K8の同じインスタンスをプロジェクト全体で使用することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正確にどのように使用されていますか？ werfは、</font><font style="vertical-align: inherit;">各プロジェクト</font></font><code>cm/werf-PROJECT_NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の名前空間に</font><font style="vertical-align: inherit;">ConfigMap </font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">作成</font><font style="vertical-align: inherit;">します</font></font><code>werf-synchronization</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このConfigMapは、いわゆる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステージストレージキャッシュの保存</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分散ロックに使用され</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。 Kubernetesクラスターで分散ロックを実装するためにOpen Source-Library </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lockgateを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用する</font><font style="vertical-align: inherit;">ために、特にwerf用に作成しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じプロジェクトで動作する異なるwerfプロセスは、同じステージストレージと同じKubernetesクラスターインスタンスを使用する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同期の詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントを参照してください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいステージコマンド</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Werfは、ステージを操作するための新しいコマンドを実装しています。</font></font><br>
<br>
<ol>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>werf stages sync</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ストレージ間でステージをコピーします。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>werf stages switch-from-local</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-既存のプロジェクトを分散モードに移行するのに役立ちます</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（このプロセスの詳細については、以下を参照してください）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分散モードを有効にする方法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分散モードを使用するには</font></font><code>--stages-storage=DOCKER_REPO_ADDRESS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、すべてのwerfコマンドに</font><font style="vertical-align: inherit;">パラメーター</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">指定するだけ</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">このプロジェクトの</font><font style="vertical-align: inherit;">一意のDocker </font><i><font style="vertical-align: inherit;">リポジトリ</font></i><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">参照する必要が</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あることに注意してください</font><font style="vertical-align: inherit;">。このリポジトリは、複数のプロジェクトで同時に使用することはできません（もちろん、同じDockerレジストリを複数のプロジェクトで使用できます）。</font><font style="vertical-align: inherit;">
チームは</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">werfをCI / CDプロセス変数のエクスポート</font><font style="vertical-align: inherit;">に</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">統合し</font></a><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。これには、ステージの保存を目的としたDockerリポジトリのアドレスが含まれており、このデフォルトのストレージは、後続のすべてのwerf呼び出しに使用されます。これは、CI GitLab / CDの変数の例です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">定義されていない</font><font style="vertical-align: inherit;">
場合</font></font><code>DOCKER_REPO_ADDRESS</code><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>werf ci-env</code><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>WERF_STAGES_STORAGE</code><font style="vertical-align: inherit;"></font><code>WERF_STAGES_STORAGE=CI_REGISTRY_IMAGE/stages</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>--stages-storage</code><font style="vertical-align: inherit;"></font><code>:local</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Registry（</font></font><code>DOCKER_REPO_ADDRESS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">アドレスとして</font><font style="vertical-align: inherit;">、werfは</font></font><code>werf-synchronization</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デフォルトで</font><font style="vertical-align: inherit;">Kubernetes名前空間</font><font style="vertical-align: inherit;">とkubeconfigの現在のコンテキストを</font><font style="vertical-align: inherit;">自動的に使用</font><font style="vertical-align: inherit;">してクラスターに接続します。</font><font style="vertical-align: inherit;">この場合、ユーザーはオプションを使用して任意の名前空間を明示的に指定できます</font></font><code>--synchronization=kubernetes://NAMESPACE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご覧ください</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既存のプロジェクトの移行</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカルステージストレージですでにwerfを使用している場合、プロジェクトを分散モードに切り替えることができます。</font><font style="vertical-align: inherit;">新しいバージョンのwerfには、このプロセスを簡略化する特別なツールが付属しています。</font><font style="vertical-align: inherit;">これに関する詳細情報は、特別な</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移行ガイドにあり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモプロジェクト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、</font><font style="vertical-align: inherit;">werf分散モードを使用してパブリックGitLabでアプリケーションを構築する方法を示す</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デモプロジェクト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">準備しました</font><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">symfony-demo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、werf分散モードを使用する手順です</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。1.準備</font></font><code>werf.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その内容</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">project: symfony-demo<font></font>
configVersion: 1<font></font>
---<font></font>
<font></font>
image: ~<font></font>
from: ubuntu:16.04<font></font>
docker:<font></font>
  WORKDIR: /app<font></font>
  # Non-root user<font></font>
  USER: app<font></font>
  EXPOSE: "80"<font></font>
  ENV:<font></font>
    LC_ALL: en_US.UTF-8<font></font>
ansible:<font></font>
  beforeInstall:<font></font>
  - name: "Install additional packages"<font></font>
    apt:<font></font>
      state: present<font></font>
      update_cache: yes<font></font>
      pkg:<font></font>
      - locales<font></font>
      - ca-certificates<font></font>
  - name: "Generate en_US.UTF-8 default locale"<font></font>
    locale_gen:<font></font>
      name: en_US.UTF-8<font></font>
      state: present<font></font>
  - name: "Create non-root group for the main application"<font></font>
    group:<font></font>
      name: app<font></font>
      state: present<font></font>
      gid: 242<font></font>
  - name: "Create non-root user for the main application"<font></font>
    user:<font></font>
      name: app<font></font>
      comment: "Create non-root user for the main application"<font></font>
      uid: 242<font></font>
      group: app<font></font>
      shell: /bin/bash<font></font>
      home: /app<font></font>
  - name: Add repository key<font></font>
    apt_key:<font></font>
      keyserver: keyserver.ubuntu.com<font></font>
      id: E5267A6C<font></font>
  - name: "Add PHP apt repository"<font></font>
    apt_repository:<font></font>
      repo: 'deb http://ppa.launchpad.net/ondrej/php/ubuntu xenial main'<font></font>
      update_cache: yes<font></font>
  - name: "Install PHP and modules"<font></font>
    apt:<font></font>
      name: "{{`{{packages}}`}}"<font></font>
      state: present<font></font>
      update_cache: yes<font></font>
    vars:<font></font>
      packages:<font></font>
      - php7.2<font></font>
      - php7.2-sqlite3<font></font>
      - php7.2-xml<font></font>
      - php7.2-zip<font></font>
      - php7.2-mbstring<font></font>
      - php7.2-intl<font></font>
  - name: Install composer<font></font>
    get_url:<font></font>
      url: https://getcomposer.org/download/1.6.5/composer.phar<font></font>
      dest: /usr/local/bin/composer<font></font>
      mode: a+x<font></font>
  install:<font></font>
  - name: "Install app deps"<font></font>
    # NOTICE: Always use `composer install` command in real world environment!<font></font>
    shell: composer update<font></font>
    become: yes<font></font>
    become_user: app<font></font>
    args:<font></font>
      creates: /app/vendor/<font></font>
      chdir: /app/<font></font>
  setup:<font></font>
  - name: "Create start script"<font></font>
    copy:<font></font>
      content: |<font></font>
        #!/bin/bash<font></font>
        php -S 0.0.0.0:8000 -t public/<font></font>
      dest: /app/start.sh<font></font>
      owner: app<font></font>
      group: app<font></font>
      mode: 0755<font></font>
  - raw: echo `date` &gt; /app/version.txt<font></font>
  - raw: chown app:app /app/version.txt<font></font>
git:<font></font>
- add: /<font></font>
  to: /app<font></font>
  owner: app<font></font>
  group: app</code></pre><br>
<i>(<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>)</i></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.分散型werfモードの場合、Kubernetesクラスタのインスタンスが必要です-GKEを使用します。</font><font style="vertical-align: inherit;">クラスターのkube-configを準備し、シークレット変数を設定します</font></font><code>BASE64_KUBECONFIG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">cat .kube/config | base64 -w0 &gt; /tmp/base64_kubeconfig
<span class="hljs-comment"># copy /tmp/base64_kubeconfig content and set BASE64_KUBECONFIG variable in CI/CD</span></code></pre><br>
<img src="https://habrastorage.org/webt/k4/m3/dt/k4m3dtxrg9nd8arckgclxbftuew.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.で組み立てフェーズ（</font></font><code>build</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を準備</font><font style="vertical-align: inherit;">し</font></font><code>.gitlab-ci.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="plaintext hljs">stages:<font></font>
  - build<font></font>
<font></font>
Build:<font></font>
  stage: build<font></font>
  script:<font></font>
  - export KUBECONFIG=$(mktemp -d)/kubeconfig<font></font>
  - echo $BASE64_KUBECONFIG | base64 -d -w0 &gt; $KUBECONFIG<font></font>
  - type multiwerf &amp;&amp; source $(multiwerf use 1.1 ea --as-file)<font></font>
  - type werf &amp;&amp; source $(werf ci-env gitlab --as-file)<font></font>
  - werf build-and-publish<font></font>
  tags:<font></font>
  - werf-demo-runner</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リポジトリ内のファイル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
この例では、ビルドフェーズのみを実装しました。本格的なCI / CDの場合、展開（</font></font><code>deploy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、クリーニング（</font></font><code>cleanup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、および削除（</font></font><code>dismiss</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">の追加ステージ</font><font style="vertical-align: inherit;">が</font><font style="vertical-align: inherit;">さらに必要</font><font style="vertical-align: inherit;">になりますが、それらの実装はこの記事の範囲外です。完全な例については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab使用ガイドを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ご覧ください</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4.プロジェクトでパラメーターが明示的に設定されて</font></font><code>--stages-storage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">おらず、環境変数が登録</font><font style="vertical-align: inherit;">されていないことを確認します</font></font><code>WERF_STAGES_STORAGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。コマンドが</font></font><code>werf ci-env</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インストールさ</font></font><code>WERF_STAGES_STORAGE=CI_REGISTRY_IMAGE/stages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れます（この例ではthis </font></font><code>registry.gitlab.com/distorhead/symfony-demo/stages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5.適切なプロジェクトページでコンテナーレジストリを確認します：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">symfony-demo / container_registry</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 Docker Registryステージリポジトリで収集されたプロジェクトステージは次のとおりです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tv/ts/2v/tvts2ving3drloyeswek_ictv-i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6.これで、アプリケーションのソースに変更を加えて（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">merge_requests / 2</font></a></font><code>src/Kernel.php</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して</font><font style="vertical-align: inherit;">）、再構築できます。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ビルド</font></a><font style="vertical-align: inherit;">プロセス</font><font style="vertical-align: inherit;">は、Dockerレジストリ（ステージリポジトリ）から既存のステージを取得し、ステージのみを再構成します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
この結論は、すべてが正しく機能することを意味します！</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>gitLatestPatch</code><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/sp/ae/3j/spae3jdxpkjtohza0zfho2bq4is.png"><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分散モードは、werfプロジェクトの開発におけるもう1つの重要なマイルストーンです。</font><font style="vertical-align: inherit;">ユーザーの労力を最小限に抑えながら、拡張性をもたらします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
分散モードはwerf v1.1.10以降で使用できます。</font><font style="vertical-align: inherit;">この記事では、これを有効にする方法と、既存のプロジェクトをそれに転送する方法（すでにローカルwerfモードを使用している）について説明しました。</font><font style="vertical-align: inherit;">分散モードはCI / CDシステムに推奨され、デフォルトで有効になっています。</font><font style="vertical-align: inherit;">まだ行っていない場合は、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">werfを</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
試してください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">また、ご期待ください。間もなく、werfとGitHubアクションの完全な統合に関するガイドを公開します。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのブログも読んでください：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werfでの一般的なDockerレジストリ実装の完全サポート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werfビルダーのコンテンツベースのタグ付け：なぜ、どのように機能するのですか？</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">";</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> werf 1.1:        </a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">3-way merge  werf:   Kubernetes  Helm „ “</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> werf    Helm-</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja504376/index.html">アウトソーシングから開発まで（パート1）</a></li>
<li><a href="../ja504380/index.html">SSD。内部構造とその構築原理</a></li>
<li><a href="../ja504382/index.html">私（PhD Neurobiology）が6か月でデータサイエンティストになった経緯</a></li>
<li><a href="../ja504384/index.html">TypeScriptをReactプロジェクトに徐々に導入する</a></li>
<li><a href="../ja504386/index.html">Vassbotn H.クラス仮想変数</a></li>
<li><a href="../ja504392/index.html">手書きのパスポートを認識するために必要なプログラマと単語は何人ですか。</a></li>
<li><a href="../ja504400/index.html">キャッシング。パート2：リリースの60日前</a></li>
<li><a href="../ja504402/index.html">5月29日Javaダイジェスト</a></li>
<li><a href="../ja504408/index.html">UI自動テスト用のセレン化されたシンプルで便利なテストフレームワークテンプレート</a></li>
<li><a href="../ja504412/index.html">オンラインプログラミングチャンピオンシップ「モスクワトレーニングのオープンファイナル」</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>