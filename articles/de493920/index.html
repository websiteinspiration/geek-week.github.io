<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôèüèΩ ‚úçüèº ‚èØÔ∏è √úber eine Sicherheitsl√ºcke in ... ‚è™ üßó üòè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor einem Jahr, dem 21. M√§rz 2019, kam in einem Bug-Bounty-Programm Mail.ru auf HackerOne ein sehr guter Bug-Bericht von maxarr . Beim Einbetten eines...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>√úber eine Sicherheitsl√ºcke in ...</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/493920/"><img src="https://habrastorage.org/webt/du/k3/h5/duk3h5leha8sz3qinzb3g_8yfsk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor einem Jahr, dem 21. M√§rz 2019, kam in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einem Bug-Bounty-Programm Mail.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf HackerOne ein sehr guter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bug-Bericht</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maxarr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Beim Einbetten eines Null-Bytes (ASCII 0) in den POST-Parameter einer der Webmail-API-Anforderungen, die eine HTTP-Umleitung zur√ºckgegeben haben, wurden Teile des nicht initialisierten Speichers in den Umleitungsdaten angezeigt, in denen Fragmente aus GET-Parametern und Header anderer Anforderungen an der gleiche Server.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist eine kritische Sicherheitsl√ºcke, weil Anfragen beinhalten Sitzungscookies. Einige Stunden sp√§ter wurde eine vor√ºbergehende Korrektur durchgef√ºhrt, bei der ein Null-Byte gefiltert wurde (wie sich sp√§ter herausstellte, war dies nicht ausreichend, da die M√∂glichkeit bestand, CRLF / ASCII 13, 10 zu injizieren, mit dem Sie die Header und Daten der HTTP-Antwort bearbeiten k√∂nnen. Dies ist jedoch weniger kritisch immer noch unangenehm). Gleichzeitig wurde das Problem an Sicherheitsanalysten und Entwickler weitergeleitet, um die Ursachen des Fehlers zu finden und zu beseitigen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mail.ru Mail ist eine sehr komplizierte Anwendung. Eine gro√üe Anzahl verschiedener Front-End- / Back-End-Komponenten, sowohl Open Source (vielen Dank an alle Entwickler freier Software) als auch unsere eigene Entwicklung, k√∂nnen an der Antwort teilnehmen. Es war m√∂glich, alle Komponenten au√üer nginx und openresty auszuschlie√üen und das Problem zu lokalisieren, bevor </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ngx.req.set_uri () aufgerufen wurde.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in einem OpenResty-Skript, das sich nicht wie erwartet verhalten hat (stecken Sie einen Null-Byte- oder Zeilenvorschub durch die GET-Parameter von rewrite zu ngx_http_rewrite_module, das laut Dokumentation verwendet wird und anscheinend genauso funktionieren sollte). M√∂gliche Konsequenzen wurden eliminiert, die strengste Filterung wurde hinzugef√ºgt und es wurde √ºberpr√ºft, dass die Filterung alle m√∂glichen Vektoren eliminiert. Der Mechanismus, der zum Verlust von Speicherinhalten f√ºhrte, blieb jedoch ein R√§tsel. Einen Monat sp√§ter wurde der Fehlerbericht als autorisiert geschlossen und die Analyse der Fehlerursachen auf bessere Zeiten verschoben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenResty ist ein sehr beliebtes Plugin, mit dem Sie Lua-Skripte in nginx schreiben k√∂nnen. Es wird in mehreren Mail.ru-Projekten verwendet, sodass das Problem nicht als behoben angesehen wurde. Und nach einiger Zeit kehrten sie dennoch zu ihr zur√ºck, um die wahren Ursachen und m√∂glichen Konsequenzen zu verstehen und Empfehlungen f√ºr Entwickler abzugeben. Der Quellcode wurde von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Denis Denisov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nikolai Ermishkin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ausgegraben </font><font style="vertical-align: inherit;">. Es stellte sich heraus, dass:</font></font><br>
<br>
<ul>
<li> nginx   rewrite      directory traversal (  SSRF)   ,    ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nginx Amplify</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gixy</a>   (,    , ).   OpenResty    ,      .<br>
<br>
 :<br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /rewrite</span> {
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^.*$</span> <span class="hljs-variable">$arg_x</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span> html;
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
}</code></pre><br>
<br>
<br>
<br>
<code>curl localhost:8337/rewrite?x=/../../../../../../../etc/passwd<br>
root:x:0:0:root:/root:/bin/bash<br>
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin<br>
bin:x:2:2:bin:/bin:/usr/sbin/nologin<br>
...</code><br>
<br>
</li>
<li> nginx  ,     ,   rewrite   .    nginx    ,    ,       ,       ,       ,     .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>.<br>
<br>
  (^@  )<br>
<pre><code class="nginx hljs">
<span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /memleak</span> {
    <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^.*$</span> <span class="hljs-string">"^<span class="hljs-variable">@asdfasdfasdfasdfasdfasdfasdfasdfasdfasdfasdasdf</span>"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span> html;
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
}</code></pre><br>
<br>
<br>
<code>curl localhost:8337/secret -vv<br>
...<br>
curl localhost:8337/memleak -vv<br>
...<br>
Location: http://localhost:8337/secret<br>
...<br>
</code><br>
</li>
<li>Nginx  GET-          rewrite  GET-.         nginx  . POST     . OpenResty     GET   POST ,    POST   OpenResty     .<br>
<br>
 :<br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ /memleak</span> {
    <span class="hljs-section">rewrite_by_lua_block</span> {<font></font>
        ngx.req.read_body();<font></font>
        <span class="hljs-attribute">local</span> args, err = ngx.req.get_post_args();<font></font>
        ngx.req.set_uri( args["url"], <span class="hljs-attribute">true</span> );<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">root</span> html;
    <span class="hljs-attribute">index</span> index.html index.htm;<font></font>
}<font></font>
</code></pre><br>
<br>
:<br>
<br>
<code>curl localhost:8337 -d "url=secret" -vv<br>
...<br>
curl localhost:8337 -d "url=%00asdfasdfasdfasdfasdfasdfasdfasdf" -vv<br>
...<br>
Location: http://localhost:8337/{...  secret...}<br>
...<br>
</code><br>
</li>
</ul><br>
<h4> </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Problem wurde den Entwicklern von nginx und OpenResty gemeldet. Die Entwickler betrachten das Problem nicht als Sicherheitsfehler in nginx, da In Nginx selbst gibt es keine M√∂glichkeit, den Fehler durch Einf√ºgen von Sonderzeichen auszunutzen. Der Fix zum </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anzeigen des Speicherinhalts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wurde am 16. Dezember ver√∂ffentlicht. In den vier Monaten seit dem Bericht wurden keine √Ñnderungen an OpenResty vorgenommen, obwohl bekannt war, dass eine sichere Version der Funktion ngx.req.set_uri () erforderlich war. Am 18. M√§rz 2020 haben wir die Informationen ver√∂ffentlicht. Am 21. M√§rz ver√∂ffentlichte OpenResty die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version 1.15.8.3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die eine URI-Pr√ºfung hinzuf√ºgt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portswigger </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schrieb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ich habe einen guten Artikel von OpenResty und Nginx genommen (obwohl der Kommentar, dass nur ein kleines St√ºck Speicher enth√ºllt wird, falsch und irref√ºhrend ist, wird dies durch die L√§nge der Zeile nach dem Null-Byte bestimmt und kann ohne offensichtliche L√§ngenbeschr√§nkungen vom Angreifer kontrolliert werden).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was war der Fehler und was ist zu tun, um ihn zu verhindern?</font></font></h4><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gab es einen Fehler in Nginx?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ja, das war es, weil ein Speicherverlust sowieso ein Fehler ist. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gab es einen Fehler in OpenResty?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ja, zumindest das Problem der Sicherheit der von OpenResty angebotenen Funktionen wurde nicht untersucht und dokumentiert. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wurde ein OpenResty-Konfigurations- / Verwendungsfehler gemacht?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ja, da mangels expliziter Angabe eine nicht √ºberpr√ºfte Annahme √ºber die Sicherheit der verwendeten Funktionalit√§t getroffen wurde. </font></font><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Welcher dieser Fehler ist eine Sicherheitsl√ºcke in H√∂he von 10.000 US-Dollar?</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºr uns ist dies in der Regel nicht wichtig. </font><font style="vertical-align: inherit;">In jeder Software, insbesondere an der Schnittstelle mehrerer Komponenten, insbesondere derjenigen, die von verschiedenen Projekten und Entwicklern bereitgestellt werden, kann niemand garantieren, dass alle Funktionen ihrer Arbeit bekannt und dokumentiert sind und dass keine Fehler vorliegen. </font><font style="vertical-align: inherit;">Daher tritt jede Sicherheitsl√ºcke genau dort auf, wo sie die Sicherheit beeintr√§chtigt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In jedem Fall empfiehlt es sich, die Eingabedaten, die an ein externes Modul / eine externe API gesendet werden, zu normalisieren oder zu begrenzen / zu filtern, wenn keine expliziten Hinweise vorliegen und ein eindeutiges Verst√§ndnis daf√ºr besteht, dass dies nicht erforderlich ist.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Errata</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach den Erfahrungen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des vorigen Artikels</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um die Reinheit der Sprache zu bewahren: </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein Bug Bounty</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Jagd Wettbewerb f√ºr Fehler </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehlerbericht</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Fehlermeldung </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Umleitung</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Umleitung </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opensorsny</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Open - </font><font style="vertical-align: inherit;">Source </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">als errata bekannt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Arbeit auf der Bugs</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de493896/index.html">Intel Pohoiki Springs - ein neuromorpher Cluster in einer Mauskraft</a></li>
<li><a href="../de493898/index.html">"Woher wachsen die Beine" oder was geht der Programmierung voraus?</a></li>
<li><a href="../de493904/index.html">Wie man das Vertrauen in die KI verliert oder wie ich mit Gradient Photo Editor gemobbt habe</a></li>
<li><a href="../de493914/index.html">Web2Text: Tief strukturierte Extraktion von Webseiteninhalten</a></li>
<li><a href="../de493918/index.html">Wie sich die Pandemie auf VPN-Anbieter auswirkte</a></li>
<li><a href="../de493922/index.html">Brille der D√§mmerungssicht. Android Camera2 API aus dem Maker Part 5 Flash</a></li>
<li><a href="../de493924/index.html">Stoppen Sie das F√∂rderband! Sie geben Epson XGA-Projektoren zum Preis von SVGA</a></li>
<li><a href="../de493926/index.html">Tricks zum Testen von Laravel-Webanwendungen mithilfe von Modellfabriken</a></li>
<li><a href="../de493928/index.html">√úberpr√ºfen und testen Sie Huawei Dorado 5000V6</a></li>
<li><a href="../de493932/index.html">√úbersicht √ºber Google Surveys. Warum es nicht f√ºr ernsthafte Forschung geeignet ist</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>