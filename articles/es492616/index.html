<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¥üèæ üí´ üêøÔ∏è Packer, Terraform y Ansible: despliegue de cl√∫ster Kubernetes en una hora üé® üåé üåü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola, mi nombre es Andrey Schukin, ayudo a grandes empresas a migrar servicios y sistemas a la nube de CROC. Junto con colegas de Southbridge, que org...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Packer, Terraform y Ansible: despliegue de cl√∫ster Kubernetes en una hora</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/croccloudteam/blog/492616/"><img src="https://habrastorage.org/webt/0m/2c/zt/0m2cztx1saqv1v7e8a3mrliht_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hola, mi nombre es Andrey Schukin, ayudo a grandes empresas a migrar servicios y sistemas a la nube de CROC. Junto con colegas de Southbridge, que organiza cursos de Kubernetes en el centro de capacitaci√≥n de Slerm, recientemente realizamos un seminario web para nuestros clientes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decid√≠ tomar materiales de una excelente conferencia de Pavel Selivanov y escribir una publicaci√≥n para aquellos que reci√©n comienzan a trabajar con herramientas de aprovisionamiento en la nube y no saben por d√≥nde empezar. Por lo tanto, hablar√© sobre la pila de tecnolog√≠as que se utilizan en nuestra capacitaci√≥n y producci√≥n de CROC Cloud. Hablemos de los enfoques modernos para la gesti√≥n de la infraestructura, sobre un mont√≥n de componentes Packer, Terraform y Ansible, as√≠ como sobre la herramienta Kubeadm con la que instalaremos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debajo del corte habr√° mucho texto y configuraciones. </font><font style="vertical-align: inherit;">Hay mucho material, as√≠ que agregu√© navegaci√≥n posterior. </font><font style="vertical-align: inherit;">Tambi√©n preparamos un peque√±o repositorio donde colocamos todo lo que necesit√°bamos para nuestra implementaci√≥n de capacitaci√≥n. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No le d√© nombres a los pollos. Los </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pasteles horneados son m√°s saludables que los fritos. </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arrancamos el horno. </font><font style="vertical-align: inherit;">Packer </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform: infraestructura como c√≥digo </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicie Terraform </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster structure Kubernetes </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubeadm </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository con todos los archivos</font></font></a><br>
 <a name="habracut"></a><br>
<a name="1"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No dar nombres a las gallinas.</font></font></h2><br>
<img src="https://habrastorage.org/webt/j0/0w/v1/j00wv1h7pcevviakk2iocfleqjk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay muchos conceptos diferentes de gesti√≥n de infraestructura. Uno de ellos se llama Pets vs. Ganado, es decir, "mascotas contra el ganado". Este concepto describe dos enfoques opuestos a la infraestructura. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagina que tenemos un perro favorito. La cuidamos, lo llevamos al veterinario, le peinamos el pelaje y, en general, es √∫nico para nosotros entre muchos otros perros.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En otro caso, tenemos un gallinero. Tambi√©n cuidamos a los pollos, alimentamos, calentamos e intentamos crear las condiciones m√°s c√≥modas. Sin embargo, los pollos son un recurso sin rostro para nosotros, que cumple su funci√≥n de poner huevos, y en el mejor de los casos los designamos como "ese negro en polvo que siempre picotea el cemento". Si el pollo deja de poner huevos o se rompe la pata, lo m√°s probable es que simplemente nos proporcione un delicioso caldo para el almuerzo. De hecho, no nos importa el destino de un pollo individual, sino el gallinero en su conjunto como l√≠nea de producci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En TI, un enfoque similar comenz√≥ a aplicarse tan pronto como aparecieron las herramientas que redujeron el umbral de entrada para los ingenieros y permitieron implementar y mantener cl√∫steres complejos en un modo completamente autom√°tico.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anteriormente, ten√≠amos una peque√±a cantidad de servidores que eran monitoreados, ajustados manualmente y atendidos de todas las formas posibles. En el monitoreo, los registros de los servidores Cthulhu, Aylith y Dagon parpadearon. Tradiciones </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, la virtualizaci√≥n entr√≥ firmemente en nuestras vidas, y los nombres de las obras de Lovecraft y Star Trek dieron paso al m√°s utilitario "vlg-vlt-vault01.company.ru". Hay muchos servidores, pero a√∫n as√≠ aumentamos los servicios de forma m√°s o menos manual, eliminando los problemas en cada m√°quina si es necesario.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora el enfoque para mantener la infraestructura coincide completamente con la programaci√≥n. </font><font style="vertical-align: inherit;">Agregamos otro nivel de abstracci√≥n y dejamos de preocuparnos por los nodos individuales. </font><font style="vertical-align: inherit;">Cada uno tiene un √≠ndice sin rostro en lugar de un nombre, y en caso de problemas, la m√°quina virtual simplemente mata y se levanta de la instant√°nea de trabajo. </font><font style="vertical-align: inherit;">Existen herramientas que le permiten implementar este enfoque. </font><font style="vertical-align: inherit;">En nuestro caso, la primera herramienta es la nube CROC, la segunda es Terraform.</font></font><br>
<br>
<a name="2"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los pasteles horneados son m√°s saludables que los fritos.</font></font></h2><br>
<img src="https://habrastorage.org/webt/hs/pp/oa/hsppoaujv0lhrk0u3dt6ust0rry.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la gesti√≥n de infraestructura hay un contraste entre los dos enfoques de Fried vs. Al horno, es decir, "frito contra horneado". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El enfoque de Fried implica que tiene una imagen de sistema operativo est√°ndar, por ejemplo, CentOS 7. Luego, despu√©s de implementar el sistema operativo, usamos el sistema de gesti√≥n de configuraci√≥n para llevar el sistema al estado de destino. Por ejemplo, usando Ansible, Chef, Puppet o SaltStack.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo funciona bien, especialmente cuando no hay muchos servidores. Cuando existe la necesidad de una implementaci√≥n masiva, nos enfrentamos a problemas de rendimiento. Cientos de servidores comienzan a devorar sincr√≥nicamente recursos de red, CPU, RAM e IOPS en el proceso de lanzar muchos paquetes nuevos. Adem√°s, este proceso puede retrasarse por un tiempo bastante largo. En resumen, el circuito es absolutamente operativo, pero no tan interesante desde el punto de vista de minimizar el tiempo de inactividad durante los accidentes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El enfoque al horno implica que tiene im√°genes del sistema operativo "horneadas" listas para usar en las que ya ha instalado todos los paquetes necesarios, ha configurado la configuraci√≥n y todo lo dem√°s. </font><font style="vertical-align: inherit;">En la salida, tenemos una plantilla de instant√°nea abstracta, enfocada para el desempe√±o de alguna funci√≥n. </font><font style="vertical-align: inherit;">La implementaci√≥n de infraestructura a partir de tales im√°genes horneadas lleva mucho menos tiempo y reduce el tiempo de inactividad al m√≠nimo. </font><font style="vertical-align: inherit;">Se utiliza una ideolog√≠a muy similar en las im√°genes de Docker de varias capas, en las que nadie toca sus manos innecesariamente. </font><font style="vertical-align: inherit;">Clavado el contenedor - levant√≥ uno nuevo.</font></font><br>
<br>
<a name="3"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arrancamos el horno. </font><font style="vertical-align: inherit;">Envasador</font></font></h2><br>
<img src="https://habrastorage.org/webt/xw/mr/im/xwmrimtkl-6qvfcrae3xo4zdf7q.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En nuestra infraestructura, utilizamos varios productos de Hashicorp, algunos de los cuales resultaron ser extremadamente exitosos. Comencemos nuestra magia preparando y horneando una imagen usando la herramienta Packer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Packer utiliza una plantilla JSON, es decir, archivos de plantilla que contienen una descripci√≥n de lo que debe obtenerse como una m√°quina virtual (VM) "horneada". Despu√©s de crear la plantilla, el archivo se transfiere a Packer y se configuran los permisos necesarios para crear el servidor en la nube. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Packer le permite elevar m√°quinas virtuales localmente en KVM, VirtualBox, Vagrant, AWS, GCP, Alibaba Cloud, OpenStack, etc. Es conveniente trabajar con Packer en CROC Cloud, ya que implementa interfaces de AWS, es decir, todas las herramientas para las que est√° escrito AWS, trabaje con CROC Cloud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de configurar las plantillas necesarias, Packer levanta VM CROC en la nube, espera a que comience y luego el "proveedor" ingresa al aprovisionador de trabajo: una utilidad que debe completar la preparaci√≥n de la imagen. </font><font style="vertical-align: inherit;">En nuestro caso, esto es Ansible, aunque Packer puede trabajar con otras opciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando la VM est√° lista, Packer crea su imagen y la coloca en la Nube de CROC para que otras VM se puedan iniciar desde la misma imagen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estructura de base.json</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al principio del archivo hay una secci√≥n en la que se declaran las variables:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revelaci√≥n</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"variables" : {<font></font>
 "source_ami_name": "{{env SOURCE_AMI_NAME}}",<font></font>
 "ami_name": "{{env AMI_NAME}}",<font></font>
 "instance_type": "{{env INSTANCE_TYPE}}",<font></font>
 "kubernetes_version": "{{env KUBERNETES_VERSION}}",<font></font>
 "docker_version": "{{env DOCKER_VERSION}}",<font></font>
 "subnet_id": "",<font></font>
 "availability_zone": "",<font></font>
},</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El conjunto principal de estas variables se establecer√° desde el archivo settings.json. </font><font style="vertical-align: inherit;">Y las variables que cambian con frecuencia son m√°s convenientes para configurar desde la consola al iniciar Packer y construir una nueva imagen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La siguiente es la secci√≥n Constructores:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revelaci√≥n</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"builders" : [<font></font>
 {<font></font>
  "type": "amazon-ebs",<font></font>
  "region": "croc",<font></font>
  "skip_region_validation": true,<font></font>
  "custom_endpoint_ec2": "https://api.cloud.croc.ru",<font></font>
  "source_ami": "",<font></font>
  "source_ami_filter": {<font></font>
   "filters": {<font></font>
    "name": "{{user `source_ami_name`}}"<font></font>
    "state": "available",<font></font>
    "virtualization-type": "kvm-virtio"<font></font>
     },<font></font>
...</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las nubes de destino y el m√©todo de inicio de VM se describen aqu√≠. Tenga en cuenta que en este caso se declara el tipo amazon-ebs, pero para que Packer trabaje con CROC Cloud, se establece la direcci√≥n correspondiente en custom_endpoint_ec2. Nuestra infraestructura tiene una API que es casi completamente compatible con los servicios web de Amazon, por lo que si tiene desarrollos listos para esta plataforma, en su mayor parte solo tendr√° que especificar un punto de entrada API personalizado: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api.cloud.croc.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en nuestro ejemplo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale la pena se√±alar la secci√≥n source_ami_filter por separado. </font><font style="vertical-align: inherit;">Aqu√≠ se establece la imagen inicial de la VM, en la que se realizar√°n los cambios necesarios. </font><font style="vertical-align: inherit;">Sin embargo, Packer requiere un AMI para esta imagen, es decir, su identificador aleatorio. </font><font style="vertical-align: inherit;">Dado que este identificador rara vez se conoce de antemano y cambia con cada actualizaci√≥n, el AMI de origen no se establece como un valor espec√≠fico, sino como una variable source_ami_filter. </font><font style="vertical-align: inherit;">En este caso, el par√°metro determinante del filtro es el nombre de la imagen. </font><font style="vertical-align: inherit;">Este nombre se establece en las variables a trav√©s del archivo settings.json. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, se definen las configuraciones de VM: se especifican el tipo de instancia, procesador, tama√±o de memoria, espacio asignado, etc.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revelaci√≥n</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"instance_type": "{{user `instance_type`}}",<font></font>
"launch_block_device_mappings": [<font></font>
 {<font></font>
  "device_name": "disk1",<font></font>
  "volume_type": "io1",<font></font>
  "volume_size": "8",<font></font>
  "iops": "1000",<font></font>
  "delete_on_termination": "true"<font></font>
 }<font></font>
],</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n en base.json est√°n los par√°metros para conectarse a esta VM:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revelaci√≥n</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"availability_zone": "{{user `availability_zone`}}",<font></font>
"subnet_id": "{{user `subnet_id`}}",<font></font>
"associate_public_ip_address": true,<font></font>
"ssh_username": "ec2-user",<font></font>
"ami_name": "{{user `ami_name`}}"<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es importante tener en cuenta el par√°metro subnet_id aqu√≠. </font><font style="vertical-align: inherit;">Debe configurarse manualmente, ya que sin especificar la subred de VM en la nube CROC no puede crear. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otro par√°metro que requiere preparaci√≥n previa es associa_public_ip_address. </font><font style="vertical-align: inherit;">Debe seleccionar una direcci√≥n IP blanca, porque despu√©s de crear VM Packer comenzar√° a aplicar la configuraci√≥n necesaria a trav√©s de Ansible. </font><font style="vertical-align: inherit;">En este caso, Ansible se conecta a la VM a trav√©s de SSH, que requiere una direcci√≥n IP blanca o VPN. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La √∫ltima secci√≥n son los aprovisionadores:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revelaci√≥n</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">"provisioners": [<font></font>
 {<font></font>
  "type": "ansible",<font></font>
  "playbook_file": "playbook.yml",<font></font>
  "extra_arguments": [<font></font>
   "--extra-vars",<font></font>
   "kubernetes_version={{user `kubernetes_version`}}",<font></font>
   "--extra-vars",<font></font>
   "docker_version={{user `docker_version`}}"<font></font>
   ]<font></font>
  }<font></font>
]</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estos son los proveedores, es decir, las utilidades con las que Packer configura el servidor. </font><font style="vertical-align: inherit;">En este caso, se utiliza el proveedor de tipo ansible. </font><font style="vertical-align: inherit;">El siguiente es el par√°metro playbook_file, que define los roles Ansible y los hosts en los que se aplicar√°n los roles especificados. </font><font style="vertical-align: inherit;">A continuaci√≥n se presentan opciones adicionales extra_arguments que, al iniciar Ansible, transmiten versiones de Kubernetes y Docker.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preparaci√≥n de la nube CROC</font></font></h3><br>
 <img src="https://habrastorage.org/webt/23/_s/uo/23_suoef0us5ia6kjgn8xteomba.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de nuestros archivos de configuraci√≥n, necesitamos hacer algunas cosas desde el costado del panel de control de la nube para que toda la magia funcione. </font><font style="vertical-align: inherit;">Necesitamos seleccionar una IP blanca y crear una subred que funcione, que usaremos al implementar.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haga clic en Resaltar direcci√≥n. </font><font style="vertical-align: inherit;">Packer encontrar√° la direcci√≥n IP blanca deseada por s√≠ solo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haga clic en Crear subred y especifique una subred y una m√°scara. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copie la ID de subred. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inserte este valor en el par√°metro subnet_id del comando de inicio de Packer. </font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/24/0w/gp/240wgpvzi8oyy6ixwzdj8cougqk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego ejecuta Packer. </font><font style="vertical-align: inherit;">Encuentra la imagen de VM original, la implementa en la Nube de CROC y realiza el rol Ansible en ella. </font><font style="vertical-align: inherit;">La nueva VM se puede ver en la nube CROC en la secci√≥n "Instancias". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ol/aj/ui/olajuiprqljv50bi2opn4xlqcvs.png"> <br>
 <br>
<img src="https://habrastorage.org/webt/rq/0d/ri/rq0drint5cwvddjxbd7czcyfp9a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de terminar el trabajo, Packer elimina la VM de la nube y deja una imagen preparada en su lugar, que se puede encontrar en la secci√≥n "Plantillas". </font><font style="vertical-align: inherit;">Toda la infraestructura de Kubernetes se crear√° a partir de esta imagen.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansible</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se mencion√≥ anteriormente, el par√°metro del libro de jugadas se pasa en los par√°metros del proveedor Ansible. </font><font style="vertical-align: inherit;">El archivo playbook.yml en s√≠ se ve as√≠:</font></font><br>
<br>
<pre><code class="plaintext hljs">- hosts: all<font></font>
  become: true<font></font>
<font></font>
  roles:<font></font>
  | - base</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo transfiere a Ansible que en todos los hosts es necesario cumplir el rol de base. </font><font style="vertical-align: inherit;">Si hay otros roles, puede agregarlos al mismo archivo que una lista. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El rol base le permite obtener un cl√∫ster preparado con un solo comando. </font><font style="vertical-align: inherit;">El archivo main.yml muestra qu√© hace exactamente este rol:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agrega un repositorio de Docker a la plantilla del sistema. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agrega el repositorio de Kubernetes a la plantilla del sistema. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instala los paquetes necesarios. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crea un directorio para configurar el demonio Docker. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configura la m√°quina de acuerdo con el archivo de configuraci√≥n daemon.json.j2. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carga el n√∫cleo br_netfilter.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incluye las opciones necesarias para br_netfilter.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incluye componentes Docker y Kubelet.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejecuta Docker en VM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejecuta un comando que descarga las im√°genes de Docker necesarias para que Kubernetes funcione.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, los paquetes instalados se establecen en el archivo main.yml del directorio vars. </font><font style="vertical-align: inherit;">En nuestro caso, instalamos el paquete docker-ce, as√≠ como los tres paquetes necesarios para que Kubernetes funcione: kubelet, kubeadm y kubectl.</font></font><br>
<br>
<a name="4"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform - infraestructura como c√≥digo</font></font></h2><br>
<img src="https://habrastorage.org/webt/o4/um/wi/o4umwitq-qh_zpwr0thmcmejis0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraform es una herramienta muy funcional de HashiCorp para la orquestaci√≥n en la nube. Tiene su propio lenguaje HCL espec√≠fico, que a menudo se usa en otros productos de la compa√±√≠a, por ejemplo, en HashiCorp Vault y Consul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El principio b√°sico es similar a todos los sistemas de gesti√≥n de configuraci√≥n. Simplemente indica el estado objetivo en el formato deseado, y el sistema calcula el algoritmo de c√≥mo lograrlo. Otra cosa es que, a diferencia del mismo Ansible, que funciona como un recuadro negro en libros de jugadas complejos, Terraform puede emitir un plan de acciones futuras en una forma conveniente para el an√°lisis. Esto es importante al planificar cambios complejos de infraestructura. Despu√©s de planificar las acciones necesarias, ejecute el comando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terraform apply</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y Terraform desplegar√° la infraestructura descrita en los archivos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al igual que Packer, esta herramienta es compatible con AWS, GCP, Alibaba Cloud, Azure, OpenStack, VMware, etc.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Describimos el proyecto</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El directorio Terraform tiene un conjunto de archivos con la extensi√≥n .tf. </font><font style="vertical-align: inherit;">Estos archivos describen los componentes de la infraestructura con la que trabajaremos. </font><font style="vertical-align: inherit;">Divide el proyecto en m√≥dulos funcionales. </font><font style="vertical-align: inherit;">Dicha estructura facilita el control de versiones y el ensamblaje de cada proyecto a partir de bloques convenientes ya hechos. </font><font style="vertical-align: inherit;">Para nuestra opci√≥n, la siguiente estructura es adecuada:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">network.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">security_groups.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master.tf</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master.tpl</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estructura del archivo Main.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos con el archivo main.tf, en el que se configura el acceso a la nube. </font><font style="vertical-align: inherit;">En particular, se anuncian varios par√°metros que configuran Terraform para trabajar con la nube CROC:</font></font><br>
<br>
<pre><code class="plaintext hljs">provider "aws" {<font></font>
 endpoints {<font></font>
  ec2 = "https://api.cloud.croc.ru"<font></font>
 }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, el archivo describe que Terraform debe crear independientemente una clave privada y cargar su parte p√∫blica en todos los servidores. </font><font style="vertical-align: inherit;">La clave privada en s√≠ se emite al final de Terraform:</font></font><br>
<br>
<pre><code class="plaintext hljs">resource "tls_private_key" "ssh" {<font></font>
 algorithm = "RSA"<font></font>
}<font></font>
resource "aws_key_pair" "kube" {<font></font>
 key_name = "terraform"<font></font>
 public_key = "${tls_private_key.ssh.public_key_openssh}"<font></font>
}<font></font>
output "ssh" {<font></font>
value = "${tls_private_key.ssh.private_key_pem}"<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La estructura del archivo network.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este archivo describe los componentes de red necesarios para iniciar la VM:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revelaci√≥n</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">data "aws_availability_zones" "az" {<font></font>
 state = "available"<font></font>
}<font></font>
resource "aws_vpc" "kube" {<font></font>
 cidr_block = "${var.vpc_cidr}"<font></font>
}<font></font>
resource "aws_eip" "master" {<font></font>
 count = "1"<font></font>
 vpc = true<font></font>
}<font></font>
resource "aws_subnet" "private" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 count = "${length(data.aws_availability_zones.az.names)}"<font></font>
 cidr_block = "${var.private_subnet_cidr_list[count.index]}"<font></font>
 availability_zone = "${data.aws_availability_zones.az.names[count.index]}"<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraform utiliza dos tipos de componentes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recurso: lo que debe crearse;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">datos: lo que necesita obtener.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, el par√°metro de datos indica que Terraform debe recibir las zonas de disponibilidad de la nube especificada, que est√°n en el estado disponible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer recurso de par√°metro describe la creaci√≥n de una nube privada virtual, y el siguiente par√°metro describe la creaci√≥n de la direcci√≥n IP el√°stica. Para el cl√∫ster de Kubernetes, pedimos esta direcci√≥n IP a trav√©s de Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, en cada una de las zonas de accesibilidad, y en este momento CROC tiene dos servicios en la nube, se crea su propia subred. Se declara un recurso de tipo aws_subnet y el ID de aws_vpc generado se pasa como parte de este par√°metro. Pero, dado que la ID de este recurso a√∫n se desconoce, especificamos el par√°metro aws_vpc.kube.id, que se refiere al recurso creado y sustituye el valor del campo ID.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que el n√∫mero de subredes creadas est√° determinado por el n√∫mero de zonas de disponibilidad en la nube y este n√∫mero puede cambiar con el tiempo, este par√°metro se especifica a trav√©s de la variable de longitud (data.aws_availability_zones.az.names), es decir, la longitud de la lista de zonas de acceso recibidas a trav√©s del par√°metro de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los dos √∫ltimos par√°metros son cidr_block (la subred asignada) y la zona de disponibilidad en la que se crea esta subred. </font><font style="vertical-align: inherit;">El √∫ltimo par√°metro tambi√©n se establece a trav√©s de una variable que toma un valor de la lista de datos de acuerdo con el √≠ndice del bucle declarado por </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[count.index]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estructura de archivo Security_groups.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los grupos de seguridad son un tipo de cortafuegos para las nubes, que se pueden crear no dentro de la propia m√°quina virtual, sino por la nube. </font><font style="vertical-align: inherit;">En este caso, el firewall describe dos reglas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La primera regla crea un grupo de seguridad llamado kube. </font><font style="vertical-align: inherit;">Este grupo de seguridad es necesario para permitir todo el tr√°fico saliente de los nodos de Kubernetes, permitiendo que los nodos accedan libremente a Internet. </font><font style="vertical-align: inherit;">Tambi√©n se permite el tr√°fico entrante a los nodos de Kubernetes desde las subredes de los propios nodos. </font><font style="vertical-align: inherit;">Por lo tanto, los nodos de Kubernetes pueden trabajar entre ellos sin restricciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La segunda regla crea el grupo de seguridad ssh. </font><font style="vertical-align: inherit;">Permite la conexi√≥n SSH desde cualquier direcci√≥n IP al puerto 22 de la VM del cl√∫ster Kubernetes:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revelaci√≥n</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">resource "aws_security_group" "kube" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 name   = "kubernetes"<font></font>
 # Allow all outbound<font></font>
 egress {<font></font>
  from_port = 0<font></font>
  to_port = 0<font></font>
  protocol = "-1"<font></font>
  cidr_blocks = ["0.0.0.0/0"]<font></font>
 }<font></font>
 # Allow all internal<font></font>
 ingress {<font></font>
  from_port = 0<font></font>
  to_port = 0<font></font>
  protocol = "-1"<font></font>
  cidr_blocks = ["${var.vpc_cidr}"]<font></font>
 }<font></font>
}<font></font>
resource "aws_security_group" "ssh" {<font></font>
 vpc_id = "${aws_vpc.kube.id}"<font></font>
 name   = "ssh"<font></font>
<font></font>
 # Allow all inbound<font></font>
 ingress {<font></font>
  from_port = 22<font></font>
  to_port = 22<font></font>
  protocol = "tcp"<font></font>
  cidr_blocks = ["0.0.0.0/0"]<font></font>
 }<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nodo maestro </font><font style="vertical-align: inherit;">Estructura de archivo Master.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo master.tf describe la creaci√≥n de varias plantillas e instancias. </font><font style="vertical-align: inherit;">En particular, se est√° creando una instancia maestra de Kubernetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La variable ami establece el AMI de la imagen de origen para la VM. </font><font style="vertical-align: inherit;">A continuaci√≥n se describe el tipo de VM y la subred en la que se crea. </font><font style="vertical-align: inherit;">Al definir una subred, se utiliza nuevamente un ciclo para crear m√°quinas virtuales en cada zona de disponibilidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, se declaran los grupos de seguridad utilizados y la clave que se especific√≥ en el archivo main.tf. </font><font style="vertical-align: inherit;">El campo user_data contiene la ejecuci√≥n de un conjunto de scripts de inicio en la nube, cuyos resultados se implementar√°n en la VM:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revelaci√≥n</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">resource "aws_instance" "master" {<font></font>
 count = "1"<font></font>
 ami = "${var.kubernetes_ami}"<font></font>
 instance_type = "c3.large"<font></font>
 disable_api_termination = false<font></font>
 instance_initiated_shutdown_behavior = "terminate"<font></font>
 source_dest_check = false<font></font>
 subnet_id = "${aws_subnet.private.*.id[count.index % length(data.aws_availability_zones.az.names)]}"<font></font>
 associate_public_ip_address = true<font></font>
 vpc_security_group_ids = [<font></font>
  "${aws_security_group.ssh.id}",<font></font>
  "${aws_security_group.kube.id}",<font></font>
 ]<font></font>
 key_name = "${aws_key_pair.kube.key_name}"<font></font>
 user_data = "${data.template_cloudinit_config.master.rendered}"<font></font>
 monitoring = "true"<font></font>
}</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nodo maestro </font><font style="vertical-align: inherit;">Cloud init</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cloud-init</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una herramienta que Canonical est√° desarrollando. </font><font style="vertical-align: inherit;">Le permite ejecutar autom√°ticamente en una infraestructura en la nube un determinado conjunto de comandos despu√©s de iniciar una VM. </font><font style="vertical-align: inherit;">Terraform tiene mecanismos para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">integrarse usando plantillas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que es imposible "hornear" todo lo necesario en la VM, despu√©s de comenzar, dependiendo de su tipo, debe unirse al cl√∫ster de Kubernetes o inicializar el cl√∫ster de Kubernetes. </font><font style="vertical-align: inherit;">En la plantilla de archivo cloud-init llamada master.tpl, se realizan varias acciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Se registran los archivos de configuraci√≥n para Kubeadm:</font></font><br>
<br>
<pre><code class="plaintext hljs">#cloud-config<font></font>
<font></font>
    write_files:<font></font>
    - path: etc/kubernetes/kubeadm.conf<font></font>
      owner: root:root<font></font>
      content:<font></font>
    ...</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Se ejecuta un conjunto de comandos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la direcci√≥n IP del asistente se escribe en el archivo de configuraci√≥n generado;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el maestro en el cl√∫ster de Kubernetes se inicializa con el comando kubeadm init;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el cl√∫ster de Kubernetes, la red de superposici√≥n de Calico se instala con el comando kubectl apply.</font></font></li>
</ul><br>
 <pre><code class="plaintext hljs">runcmd:<font></font>
         - sed -i "s/CONTROL_PLANE_IP/$(curl http://169.254.169.254/latest/meta-data-local-ipv4)/g" /etc/kubernetes/kubeadm.conf<font></font>
         - kubeadm init --config /etc/kubernetes/kubeadm.conf<font></font>
         - mkdir -p $HOME/.kube<font></font>
         - sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<font></font>
         - sudo chown $(id -u):$(id -g) $HOME/.kube/config<font></font>
         - kubectl apply -f https://docs.projectcalico.org/v3.8/manifests/calico.yaml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de ejecutar los comandos al iniciar la VM, se obtiene un cl√∫ster de Kubernetes en funcionamiento de un nodo maestro. </font><font style="vertical-align: inherit;">Los nodos restantes se unir√°n a este nodo maestro.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nodos ordinarios. </font><font style="vertical-align: inherit;">node.tf</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo node.tf es similar al archivo master.tf. </font><font style="vertical-align: inherit;">Aqu√≠ tambi√©n se crean recursos, que en este caso se denominan nodo. </font><font style="vertical-align: inherit;">La √∫nica diferencia es que el nodo maestro se crea en una sola instancia, y el n√∫mero de nodos de trabajo creados se establece a trav√©s de la variable node_count:</font></font><br>
<br>
<pre><code class="plaintext hljs">resource "aws_instance" "node" {<font></font>
 count = "${var.nodes_count}"<font></font>
 ami = "${var.kubernetes_ami}"<font></font>
 instance_type = "c3.large"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo de inicio de la nube para los nodos de trabajo ejecuta solo un comando: kubeadm join. </font><font style="vertical-align: inherit;">Este comando conecta la m√°quina terminada al cl√∫ster de Kubernetes utilizando el token de autorizaci√≥n que enviamos.</font></font><br>
<br>
<a name="5"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lanzar Terraform</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se inicia, Terraform utiliza varios m√≥dulos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√≥dulo AWS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√≥dulo de plantilla;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√≥dulo TLS responsable de la generaci√≥n de claves. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estos m√≥dulos deben instalarse en la m√°quina local:</font></font><br>
<br>
<pre><code class="plaintext hljs">terraform init terraform/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Junto con este comando, se indica el directorio en el que se encuentran todos los archivos necesarios. </font><font style="vertical-align: inherit;">Al inicializar, Terraform descarga todos los m√≥dulos especificados, despu√©s de lo cual debe ejecutar el comando de plan terraform:</font></font><br>
<br>
<pre><code class="plaintext hljs">terraform plan -var-file terraform/vars/dev.tfvars terraform/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que, adem√°s del directorio con los archivos de Terraform, se indica el archivo var, que contiene los valores de las variables utilizadas en los archivos de Terraform. </font><font style="vertical-align: inherit;">El directorio vars puede contener m√∫ltiples archivos .tfvars, lo que le permite administrar diferentes tipos de infraestructuras con un conjunto de archivos Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo dev.tfvars contiene las siguientes variables importantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes_version (versi√≥n instalable de Kubernetes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes_ami (imagen AMI que cre√≥ Packer). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de establecer los valores necesarios de las variables, ejecute el comando de plan de terraform, despu√©s de lo cual Terraform presentar√° una lista de acciones necesarias para lograr el estado descrito en los archivos de Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de verificar esta lista, aplique los cambios propuestos: </font></font><br>
<br>
<code>terraform apply -auto-approve -var-file terraform/vars/dev.tfvars terraform/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
desde el comando de plan de terraformaci√≥n, se distingue por la presencia de una clave: aprobaci√≥n autom√°tica, que elimina la necesidad de confirmar los cambios realizados. </font><font style="vertical-align: inherit;">Puede omitir esta clave, pero cada acci√≥n deber√° confirmarse manualmente.</font></font><br>
<br>
<a name="6"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estructura de cl√∫ster de Kubernetes</font></font></h2><br>
<img src="https://habrastorage.org/webt/zs/i-/c3/zsi-c326-ips2acfurg_trunzhm.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El cl√∫ster de Kubernetes consta de un nodo maestro que realiza funciones de administraci√≥n y nodos de trabajo que ejecutan aplicaciones instaladas en el cl√∫ster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se instalan cuatro componentes en el nodo maestro que garantizan el funcionamiento de este sistema:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETCD, es decir, la base de datos de Kubernetes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servidor API, a trav√©s del cual almacenamos informaci√≥n en Kubernetes y obtenemos informaci√≥n de ella;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerente de controlador</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programador </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se instalan dos componentes adicionales en los nodos de trabajo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kube-proxy (responsable de generar reglas de red en el cl√∫ster de Kubernetes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubelet (responsable de enviar el comando al demonio Docker para ejecutar aplicaciones en el cl√∫ster de Kubernetes). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entre los nodos, el complemento de red Calico funciona.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagrama de flujo de trabajo del cl√∫ster</font></font></b><div class="spoiler_text"><img src="https://habrastorage.org/webt/oz/ew/f3/ozewf310dnhdmnx2gg4ozhzb1rc.png"><br>
,      Kubernetes    replicaset.<br>
<br>
<ol>
<li>     API-,     ETCD.        .</li>
<li>API-      .</li>
<li>Controller-manager   API-   ,    ¬´¬ª,    .</li>
<li>Scheduler       .       ETCD  API-.</li>
<li>Kubelet  API-  Docker    .</li>
<li>Docker   .</li>
<li>Kubelet   API-   ,     .</li>
</ol><br>
 ,    Kubernetes  ,      .       ,           ,     YAML-.  ,   ,    API-.       .<br>
</div></div><br>
<a name="7"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubeadm</font></font></h2><br>
<img src="https://habrastorage.org/webt/wd/sw/cu/wdswcujzvnx4ynnrbi_ec9c1gr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El √∫ltimo elemento que vale la pena mencionar es Kubeadm. </font><font style="vertical-align: inherit;">La implementaci√≥n de un nuevo cl√∫ster de Kubernetes siempre es un proceso minucioso. </font><font style="vertical-align: inherit;">En cada etapa, existen riesgos de errores debido al factor humano, y muchas tareas son simplemente muy rutinarias y largas. </font><font style="vertical-align: inherit;">Por ejemplo, verter certificados para el cifrado TLS entre nodos y mantenerlos actualizados. </font><font style="vertical-align: inherit;">Aqu√≠ es donde las utilidades para la automatizaci√≥n b√°sica de plantillas vienen al rescate. </font><font style="vertical-align: inherit;">El truco de Kubeadm es que est√° oficialmente certificado para trabajar con Kubernetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Te permite:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instale, configure y ejecute todos los componentes principales del cl√∫ster</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">administrar certificados, incluso rotarlos y escribir nuevos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">administrar versiones de componentes del cl√∫ster (actualizaci√≥n y degradaci√≥n). </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al mismo tiempo, Kubeadm no es un sistema completo de administraci√≥n de cl√∫steres de Kubernetes, pero es un tipo de bloque de construcci√≥n que le permite configurar Kubernetes en el nodo en el que se ejecuta la utilidad Kubeadm. </font><font style="vertical-align: inherit;">Esto significa que se necesita un sistema de orquestaci√≥n que ejecute todas las m√°quinas virtuales necesarias, las configure y ejecute Kubeadm en todos los nodos. </font><font style="vertical-align: inherit;">Es para estos fines que se utiliza Terraform.</font></font><br>
<br>
<a name="8"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repositorio con todos los archivos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ponemos todos los archivos y configuraciones</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en un solo lugar, para que sea m√°s conveniente para usted. </font><font style="vertical-align: inherit;">Si no tiene una nube privada a mano, pero desea seguir todos estos pasos y probar la implementaci√≥n en la pr√°ctica, escr√≠banos a cloud@croc.ru. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le daremos una versi√≥n demo para las pruebas y le asesoraremos sobre todos los problemas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y pronto habr√° un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nuevo Slurm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , donde puedes crear tu propio cl√∫ster. </font><font style="vertical-align: inherit;">El c√≥digo promocional CROC tiene un 10% de descuento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para aquellos que ya trabajan con Kubernetes, hay un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">curso avanzado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El descuento es igual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Colegas, Habraparser rompe el marcado del c√≥digo. </font><font style="vertical-align: inherit;">Tome la fuente de GitHub del enlace de arriba.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es492600/index.html">Gu√≠a semi-cient√≠fica para alojar un enrutador WiFi</a></li>
<li><a href="../es492604/index.html">Trabajando con View asincr√≥nicamente usando corutina</a></li>
<li><a href="../es492606/index.html">Problemas de herramientas en grandes proyectos</a></li>
<li><a href="../es492608/index.html">Caracter√≠sticas caracter√≠sticas de entrega en grandes proyectos</a></li>
<li><a href="../es492612/index.html">Plaf√≥n decorativo Leek Celebrity</a></li>
<li><a href="../es492628/index.html">Intervalo de confianza para el n√∫mero de pacientes con coronavirus (c√°lculo de mortalidad)</a></li>
<li><a href="../es492632/index.html">Peque√±as empresas en cuarentena: el p√°nico es enemigo de la raz√≥n</a></li>
<li><a href="../es492636/index.html">¬øQu√© significa ser efectivo?</a></li>
<li><a href="../es492638/index.html">Escalando una aplicaci√≥n Redux con patos</a></li>
<li><a href="../es492642/index.html">Cree una arquitectura escalable y resistente con microservicios din√°micos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>