<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëèüèæ üõ´ ‚õ≥Ô∏è DBA: Synchronisierung und Import kompetent organisieren üîÜ ü•ô üìû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bei der komplexen Verarbeitung gro√üer Datenmengen (verschiedene ETL-Prozesse : Importe, Konvertierungen und Synchronisation mit einer externen Quelle)...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA: Synchronisierung und Import kompetent organisieren</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492464/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bei der komplexen Verarbeitung gro√üer Datenmengen (verschiedene </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETL-Prozesse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Importe, Konvertierungen und Synchronisation mit einer externen Quelle) ist es h√§ufig erforderlich, sich </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vor√ºbergehend an</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> etwas Volumenreiches zu </font><b><font style="vertical-align: inherit;">erinnern und es sofort zu verarbeiten</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine typische Aufgabe dieser Art klingt normalerweise so: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄûHier hat die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buchhaltungsabteilung die</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zuletzt erhaltenen Zahlungen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">von der Kundenbank hochgeladen.</font></a><font style="vertical-align: inherit;"> Wir m√ºssen sie schnell auf die Website hochladen und mit den Konten verkn√ºpfen.‚Äú</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Wenn jedoch das Volumen dieses ‚ÄûEtwas‚Äú in Hunderten von Megabyte und des Dienstes gemessen wird Dies sollte weiterhin mit der Basis im 24x7-Modus funktionieren. Es gibt viele Nebenwirkungen, die Ihr Leben ruinieren werden.</font></font><br>
<img src="https://habrastorage.org/webt/tl/g3/ff/tlg3ffjptyayqlu-5k06oonr_vi.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um mit ihnen in PostgreSQL (und nicht nur darin) fertig zu werden, k√∂nnen Sie einige Optimierungsoptionen verwenden, mit denen Sie schneller und mit weniger Ressourcen verarbeiten k√∂nnen.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Wohin versenden?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns zun√§chst entscheiden, wo wir die Daten hochladen k√∂nnen, die wir ‚Äûverarbeiten‚Äú m√∂chten.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Tempor√§re Tabellen (VOR√úBERGEHENDE TABELLE)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Prinzip sind tempor√§re Tabellen f√ºr PostgreSQL dieselben wie alle anderen. </font><font style="vertical-align: inherit;">Aberglauben wie </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äûalles wird dort nur im Speicher gespeichert, aber es kann enden‚Äú</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sind falsch </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es gibt jedoch einige signifikante Unterschiede.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eigener Namespace f√ºr jede Verbindung zur Datenbank</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn zwei Verbindungen gleichzeitig hergestellt werden sollen </font></font><code>CREATE TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, wird definitiv jemand einen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehler mit nicht eindeutigen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DB-Objekten erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn jedoch beide versuchen, etwas auszuf√ºhren </font><font style="vertical-align: inherit;">, tun dies normalerweise beide und jeder erh√§lt </font><b><font style="vertical-align: inherit;">seine eigene Kopie der</font></b><font style="vertical-align: inherit;"> Tabelle. </font><font style="vertical-align: inherit;">Und es wird nichts gemeinsam zwischen ihnen geben.</font></font><code>CREATE <b>TEMPORARY</b> TABLE x</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Selbstzerst√∂rung" mit Unterbrechung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie die Verbindung schlie√üen, werden alle tempor√§ren Tabellen automatisch gel√∂scht, sodass </font></font><code>DROP TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es keinen Sinn macht, sie </font><font style="vertical-align: inherit;">manuell auszuf√ºhren </font><font style="vertical-align: inherit;">, au√üer ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer im Transaktionsmodus durcharbeiten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , geht die Datenbank weiterhin davon aus, dass diese Verbindung noch aktiv ist, und diese tempor√§re Die Tabelle existiert noch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher f√ºhrt ein Versuch, es von einer anderen Verbindung zu pgbouncer neu zu erstellen, zu einem Fehler. </font><font style="vertical-align: inherit;">Dies kann jedoch durch Ausnutzen umgangen werden </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Es ist zwar besser, dies nicht zu tun, da Sie dann "pl√∂tzlich" die Daten herausfinden k√∂nnen, die vom "Vorbesitzer" √ºbrig geblieben sind. </font><font style="vertical-align: inherit;">Stattdessen ist es viel besser, das Handbuch zu lesen und zu sehen, dass beim Erstellen der Tabelle die M√∂glichkeit besteht, diese hinzuzuf√ºgen</font></font><code>CREATE TEMPORARY TABLE <b>IF NOT EXISTS</b> x</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Das hei√üt, wenn die Transaktion abgeschlossen ist, wird die Tabelle automatisch gel√∂scht.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nichtreplikation</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da nur ein bestimmter Join geh√∂rt, werden tempor√§re Tabellen nicht repliziert. </font><font style="vertical-align: inherit;">Dadurch </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entf√§llt jedoch die Notwendigkeit, Daten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Heap + WAL </font><b><font style="vertical-align: inherit;">doppelt zu schreiben</font></b><font style="vertical-align: inherit;"> , sodass INSERT / UPDATE / DELETE viel schneller ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da die tempor√§re Tabelle jedoch immer noch eine ‚Äûfast normale‚Äú Tabelle ist, kann sie auch nicht auf dem Replikat erstellt werden. </font><font style="vertical-align: inherit;">Zumindest f√ºr den Moment, obwohl es den entsprechenden Patch schon lange gibt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2. </font><font style="vertical-align: inherit;">Nicht protokollierte Tabellen (UNLOGGED TABLE)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber was tun, wenn Sie beispielsweise einen umst√§ndlichen ETL-Prozess haben, der nicht innerhalb einer einzelnen Transaktion implementiert werden kann, und </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> immer noch </font><b><font style="vertical-align: inherit;">im Transaktionsmodus haben</font></b><font style="vertical-align: inherit;"> ? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oder der Datenstrom ist so gro√ü, dass </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht gen√ºgend Bandbreite pro Verbindung vorhanden ist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aus der Datenbank (gelesen, ein Prozess auf der CPU)? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oder ein Teil der Operationen </font><font style="vertical-align: inherit;">
l√§uft </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asynchron</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in verschiedenen Verbindungen? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es gibt nur eine Option - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vor√ºbergehend eine nicht tempor√§re Tabelle erstellen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wortspiel, ja. </font><font style="vertical-align: inherit;">Also:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erstellte "seine" Tabellen mit maximal zuf√§lligen Namen, um mit niemandem zu kreuzen</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extrahieren</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Daten von einer externen Quelle in sie gegossen</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transformieren</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : transformiert, ausgef√ºllt mit Schl√ºsselbindungsfeldern</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Fertige Daten in </font><b><font style="vertical-align: inherit;">Zieltabellen</font></b><font style="vertical-align: inherit;"> gegossen</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"meine" Tabellen gel√∂scht</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und jetzt - eine Fliege in der Salbe. </font><font style="vertical-align: inherit;">Tats√§chlich erfolgt das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gesamte Schreiben in PostgreSQL zweimal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zuerst in der WAL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dann im Hauptteil der Tabelle / des Index. </font><font style="vertical-align: inherit;">All dies geschieht, um ACID und die korrekte Sichtbarkeit von Daten zwischen </font></font><code>COMMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verschachtelten und </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verschachtelten Transaktionen zu unterst√ºtzen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das brauchen wir aber nicht! </font><font style="vertical-align: inherit;">Wir haben den gesamten Prozess </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oder erfolgreich bestanden oder nicht</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es spielt keine Rolle, wie viele Zwischentransaktionen darin enthalten sind - wir sind nicht daran interessiert, den Prozess von der Mitte aus fortzusetzen, insbesondere wenn nicht klar ist, wo er sich befand. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu diesem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zweck haben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> die PostgreSQL-Entwickler Version 9.1 eingef√ºhrt, z. B. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">nicht journalisierte (UNLOGGED) Tabellen</font></a><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote>      . ,    ,      (.  29),      <b>   </b>. ,     ;         <b> </b>.  ,    <b> </b>   .  ,    ,   .</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kurz gesagt, es </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird viel schneller sein</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber wenn der Datenbankserver "abst√ºrzt", wird es unangenehm sein. </font><font style="vertical-align: inherit;">Aber wie oft passiert dies und wei√ü Ihr ETL-Prozess, wie er nach der ‚ÄûRevitalisierung‚Äú der Datenbank ‚Äûvon der Mitte‚Äú korrekt ge√§ndert werden kann? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn nicht, und der obige Fall √§hnelt Ihrem - verwenden Sie </font><b><font style="vertical-align: inherit;">dieses Attribut</font></b><font style="vertical-align: inherit;"> , f√ºgen Sie es </font></font><code>UNLOGGED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jedoch niemals </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in reale Tabellen ein</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Daten, von denen Sie lieb sind.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3. </font><font style="vertical-align: inherit;">ON COMMIT {REIHEN L√ñSCHEN | </font><font style="vertical-align: inherit;">FALLEN}</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Design erm√∂glicht es beim Erstellen einer Tabelle, das automatische Verhalten beim Beenden der Transaktion festzulegen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√úber das </font><font style="vertical-align: inherit;">ich oben schon geschrieben habe, generiert es </font><font style="vertical-align: inherit;">, aber die </font><font style="vertical-align: inherit;">Situation ist interessanter - hier wird es generiert </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Da die gesamte Infrastruktur zum Speichern der Meta-Beschreibung der tempor√§ren Tabelle genau der √ºblichen entspricht, f√ºhrt das </font><b><font style="vertical-align: inherit;">st√§ndige Erstellen und L√∂schen tempor√§rer Tabellen zu einer starken "Schwellung" der</font></b><font style="vertical-align: inherit;"> Systemtabellen pg_class, pg_attribute, pg_attrdef, pg_depend, ... </font><font style="vertical-align: inherit;">
Stellen Sie sich nun vor, Sie haben einen Worker in der Zeile Durch das Herstellen einer Verbindung zur Datenbank, die jede Sekunde eine neue Transaktion √∂ffnet, wird die tempor√§re Tabelle erstellt, gef√ºllt, verarbeitet und gel√∂scht. Der M√ºll in den Systemtabellen sammelt sich √ºberm√§√üig an, und dies ist eine zus√§tzliche Bremse bei jedem Vorgang.</font></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"></font><code>DROP TABLE</code><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DELETE ROWS</b></code><font style="vertical-align: inherit;"></font><code>TRUNCATE TABLE</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen nicht! </font><font style="vertical-align: inherit;">In diesem Fall ist es viel effizienter </font></font><code>CREATE TEMPORARY TABLE x ... ON COMMIT DELETE ROWS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, es aus dem Transaktionszyklus herauszunehmen. Dann ist die Tabelle zu Beginn jeder neuen Transaktion bereits </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vorhanden</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Aufruf speichern </font></font><code>CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), aber </font><font style="vertical-align: inherit;">dank </font><font style="vertical-align: inherit;">(wir haben auch den Anruf gespeichert) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">als die vorherige Transaktion abgeschlossen wurde.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4. </font><font style="vertical-align: inherit;">WIE ... EINSCHLIESSLICH ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich erw√§hnte am Anfang, dass einer der typischen Anwendungsf√§lle f√ºr tempor√§re Tabellen verschiedene Arten von Importen sind - und der Entwickler kopiert m√ºde die Liste der Felder der Zieltabelle in die Deklaration seiner tempor√§ren Tabellen ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aber Faulheit ist der Motor des Fortschritts! </font><font style="vertical-align: inherit;">Daher kann das </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen einer neuen Tabelle ‚Äûam Modell‚Äú</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> viel einfacher sein:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> import_table(
  <span class="hljs-keyword">LIKE</span> target_table<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da Sie dieser Tabelle dann viele Daten hinzuf√ºgen k√∂nnen, wird die Suche in dieser Tabelle niemals schnell gehen. Aber dagegen gibt es eine traditionelle L√∂sung - Indizes! Und ja, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eine tempor√§re Tabelle kann auch Indizes enthalten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da die gew√ºnschten Indizes h√§ufig mit den Indizes der Zieltabelle √ºbereinstimmen, k√∂nnen Sie einfach schreiben </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Wenn Sie auch </font><font style="vertical-align: inherit;">-Werte </font><font style="vertical-align: inherit;">ben√∂tigen </font><font style="vertical-align: inherit;">(um beispielsweise die Prim√§rschl√ºsselwerte einzugeben), k√∂nnen Sie diese verwenden </font><font style="vertical-align: inherit;">. Nun, oder einfach - </font><font style="vertical-align: inherit;">- es werden Standardeinstellungen, Indizes, Einschr√§nkungen kopiert ... </font><font style="vertical-align: inherit;">
Aber hier m√ºssen Sie verstehen, dass </font><b><font style="vertical-align: inherit;">die Daten l√§nger ausgef√ºllt werden</font></b><font style="vertical-align: inherit;"> , wenn Sie </font><b><font style="vertical-align: inherit;">sofort eine Importtabelle mit Indizes erstellt haben</font></b></font><code>LIKE target_table <b>INCLUDING INDEXES</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>DEFAULT</code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING DEFAULTS</b></code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING ALL</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">als wenn Sie zuerst alles f√ºllen und dann die Indizes rollen - sehen Sie als Beispiel, wie </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump das</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> macht </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles in allem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Wie schreibe ich?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde einfach sagen - benutze </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">COPY</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-stream anstelle von "Packs" </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manchmal Beschleunigung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sie k√∂nnen sogar direkt aus einer vorgenerierten Datei.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Wie gehe ich damit um?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie unsere Einf√ºhrung also ungef√§hr so ‚Äã‚Äãaussehen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie haben in Ihrer Datenbank eine Platte mit Kundendaten f√ºr </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1M-Datens√§tze</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeden Tag sendet Ihnen der Kunde ein neues </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vollst√§ndiges ‚ÄûBild‚Äú.</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aus Erfahrung wissen Sie, dass </font><b><font style="vertical-align: inherit;">sich</font></b><font style="vertical-align: inherit;"> von Zeit zu Zeit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nicht mehr als 10.000 Datens√§tze √§ndern</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein klassisches Beispiel f√ºr eine solche Situation ist </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die KLADR-Datenbank</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - es gibt viele Adressen, aber bei jedem w√∂chentlichen Hochladen von √Ñnderungen (Umbenennung von Siedlungen, Stra√üenverb√§nden, Erscheinen neuer H√§user) gibt es landesweit nur sehr wenige.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1. </font><font style="vertical-align: inherit;">Vollst√§ndiger Synchronisationsalgorithmus</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nehmen wir zur Vereinfachung an, Sie m√ºssen die Daten nicht einmal umstrukturieren. Bringen Sie die Tabelle einfach in die richtige Form, dh:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l√∂sche</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alles was nicht mehr ist</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aktualisieren Sie</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alles, was bereits war, und Sie m√ºssen aktualisieren</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√ºge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alles ein, was nicht war</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warum lohnt es sich in dieser Reihenfolge, Operationen durchzuf√ºhren? </font><font style="vertical-align: inherit;">Denn so w√§chst die Gr√∂√üe der Tabelle minimal ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">denken Sie an MVCC!</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√ñSCHEN VON dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nein, nat√ºrlich k√∂nnen Sie nur zwei Operationen ausf√ºhren:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delete</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>DELETE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √ºberhaupt</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√ºge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alles aus einem neuen Bild ein</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gleichzeitig wird </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Tabelle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dank MVCC </font><b><font style="vertical-align: inherit;">genau doppelt so gro√ü</font></b><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Erhalten Sie + 1M Bilddatens√§tze in der Tabelle aufgrund eines 10K-Updates - mittelm√§√üige Redundanz ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRUNCATE dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein erfahrener Entwickler wei√ü, dass die gesamte Platte recht billig gereinigt werden kann:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clear</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) die ganze Tabelle</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√ºge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alles aus einem neuen Bild ein</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Methode ist effektiv, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manchmal durchaus anwendbar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , aber es gibt ein Problem ... Wir werden 1 Million Datens√§tze einf√ºgen, sodass wir es uns nicht leisten k√∂nnen, die Tabelle die ganze Zeit leer zu lassen (wie dies ohne das Umschlie√üen einer einzelnen Transaktion geschehen wird). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was bedeutet:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir starten eine </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lange Transaktion</font></font></b></li>
<li><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">legt </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Lock fest</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir machen die Einf√ºgung f√ºr eine lange Zeit, und alle anderen zu diesem Zeitpunkt </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k√∂nnen nicht einmal</font></font><code>SELECT</code></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Etwas ist schlecht ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER TABLE ... RENAME ... / DROP TABLE ...</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
F√ºllen Sie optional alles in eine separate neue Tabelle aus und benennen Sie sie dann einfach in die alte um. </font><font style="vertical-align: inherit;">Ein paar b√∂se kleine Dinge:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auch </font><font style="vertical-align: inherit;">, wenn auch wesentlich k√ºrzer</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alle Abfragepl√§ne / Statistiken dieser Tabelle werden zur√ºckgesetzt. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ANALYZE muss ausgef√ºhrt werden</font></font></a></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alle Fremdschl√ºssel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (FK) </font><b><font style="vertical-align: inherit;">brechen</font></b><font style="vertical-align: inherit;"> auf dem Tisch</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gab einen WIP-Patch von Simon Riggs, der vorschlug, eine </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operation zum Ersetzen des Tabellenk√∂rpers auf Dateiebene durchzuf√ºhren, ohne die Statistik und FK zu ber√ºhren, aber das Quorum nicht sammelte.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√ñSCHEN, AKTUALISIEREN, EINF√úGEN</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir stoppen also bei einer nicht blockierenden Version von drei Operationen. </font><font style="vertical-align: inherit;">Fast drei ... Wie geht das am effektivsten?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ,     "" </span>
<span class="hljs-keyword">BEGIN</span>;<font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> tmp(
  <span class="hljs-keyword">LIKE</span> dst <span class="hljs-keyword">INCLUDING</span> <span class="hljs-keyword">INDEXES</span> <span class="hljs-comment">--    ,   </span>
) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COMMIT</span> <span class="hljs-keyword">DROP</span>; <span class="hljs-comment">--       </span><font></font>
<font></font>
<span class="hljs-comment">-- -     COPY</span><font></font>
COPY tmp FROM STDIN;<font></font>
<span class="hljs-comment">-- ...</span>
<span class="hljs-comment">-- \.</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">USING</span><font></font>
  dst X<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  tmp Y<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2) <span class="hljs-comment">--   </span>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (X.pk1, X.pk2) <span class="hljs-keyword">AND</span>
  Y <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">-- ""</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">SET</span><font></font>
  (f1, f2, f3) = (T.f1, T.f2, T.f3)<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (T.pk1, T.pk2) <span class="hljs-keyword">AND</span>
  (D.f1, D.f2, D.f3) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (T.f1, T.f2, T.f3); <span class="hljs-comment">--   </span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span><font></font>
  dst<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  T.*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  dst D<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2)
<span class="hljs-keyword">WHERE</span>
  D <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2. </font><font style="vertical-align: inherit;">Nachbearbeitung importieren</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In demselben KLADER m√ºssen alle ge√§nderten Datens√§tze zus√§tzlich nachbearbeitet werden - normalisieren, Schl√ºsselw√∂rter hervorheben und zu den erforderlichen Strukturen bringen. </font><font style="vertical-align: inherit;">Aber woher wissen Sie, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">was sich genau ge√§ndert hat</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ohne den Synchronisationscode zu komplizieren, idealerweise ohne ihn √ºberhaupt zu ber√ºhren? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn zum Zeitpunkt der Synchronisierung nur Ihr Prozess Schreibzugriff hat, k√∂nnen Sie einen Trigger verwenden, der alle √Ñnderungen f√ºr uns erfasst:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--  </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr(...);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house(...);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr, <span class="hljs-comment">--      /</span><font></font>
  rn kladr<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr_house,<font></font>
  rn kladr_house<font></font>
);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> diff$<span class="hljs-keyword">log</span>() <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">trigger</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  dst <span class="hljs-built_in">varchar</span> = TG_TABLE_NAME || <span class="hljs-string">'$log'</span>;<font></font>
  stmt text = '';<font></font>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">--      </span>
  <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'UPDATE'</span> <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NEW</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">OLD</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NEW</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-comment">--   </span>
  stmt = '<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">' || dst::text || '</span>(ro,rn)<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">';
  CASE TG_OP
    WHEN '</span><span class="hljs-keyword">INSERT</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span><span class="hljs-literal">NULL</span>,$<span class="hljs-number">1</span>)<span class="hljs-string">' USING NEW;
    WHEN '</span><span class="hljs-keyword">UPDATE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>)<span class="hljs-string">' USING OLD, NEW;
    WHEN '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,<span class="hljs-literal">NULL</span>)<span class="hljs-string">' USING OLD;
  END CASE;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt k√∂nnen wir Trigger auferlegen (oder durch aktivieren </font></font><code>ALTER TABLE ... ENABLE TRIGGER ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), </font><font style="vertical-align: inherit;">bevor wir mit der Synchronisation beginnen </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr_house
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und dann extrahieren wir leise aus den Protokolltabellen alle erforderlichen √Ñnderungen und f√ºhren sie √ºber zus√§tzliche Handler aus.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3. </font><font style="vertical-align: inherit;">Verwandte Sets importieren</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oben haben wir F√§lle betrachtet, in denen die Datenstrukturen von Quelle und Empf√§nger √ºbereinstimmen. </font><font style="vertical-align: inherit;">Was aber, wenn das Entladen von einem externen System ein anderes Format hat als die Speicherstruktur in unserer Datenbank? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nehmen Sie als Beispiel die Speicherung von Kunden und deren Konten, die klassische Viele-zu-Eins-Option:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">client</span>(<font></font>
  client_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, inn<font></font>
    <span class="hljs-built_in">varchar</span>
      <span class="hljs-keyword">UNIQUE</span>
, <span class="hljs-keyword">name</span>
    <span class="hljs-built_in">varchar</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> invoice(<font></font>
  invoice_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, client_id<font></font>
    <span class="hljs-built_in">integer</span>
      <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">client</span>(client_id)<font></font>
, <span class="hljs-built_in">number</span>
    <span class="hljs-built_in">varchar</span><font></font>
, dt<font></font>
    <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">sum</span>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Entladen von einer externen Quelle erfolgt jedoch in Form von "All in One":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> invoice_import(<font></font>
  client_inn<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, client_name<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_number<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_dt<font></font>
    <span class="hljs-built_in">date</span><font></font>
, invoice_sum<font></font>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Offensichtlich k√∂nnen Kundendaten auf diese Weise dupliziert werden, und der Hauptdatensatz ist das ‚ÄûKonto‚Äú:</font></font><br>
<br>
<pre><code class="plaintext hljs">0123456789;;A-01;2020-03-16;1000.00<font></font>
9876543210;;A-02;2020-03-16;666.00<font></font>
0123456789;;B-03;2020-03-16;9999.00<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Geben Sie f√ºr das Modell einfach unsere Testdaten ein, aber denken Sie daran - </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">effizienter!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> invoice_import
<span class="hljs-keyword">VALUES</span>
  (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-01'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">1000.00</span>)<font></font>
, (<span class="hljs-string">'9876543210'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-02'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">666.00</span>)<font></font>
, (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'B-03'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">9999.00</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zuerst w√§hlen wir die ‚ÄûSchnitte‚Äú aus, auf die sich unsere ‚ÄûFakten‚Äú beziehen. </font><font style="vertical-align: inherit;">In unserem Fall beziehen sich Konten auf Kunden:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>(client_inn)
<span class="hljs-comment">--   SELECT DISTINCT,    </span><font></font>
  client_inn inn<font></font>
, client_name <span class="hljs-string">"name"</span>
<span class="hljs-keyword">FROM</span>
  invoice_import;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Konten korrekt mit Kunden-IDs zu verkn√ºpfen, m√ºssen wir diese Kennungen zuerst herausfinden oder generieren. </font><font style="vertical-align: inherit;">F√ºgen Sie Felder f√ºr sie hinzu:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> invoice_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden die Methode zum Synchronisieren von Tabellen mit der oben beschriebenen kleinen Korrektur verwenden - wir werden nichts in der Zieltabelle aktualisieren oder l√∂schen, da das Importieren von Clients "nur anh√§ngen" ist:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ID   </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span>
  <span class="hljs-keyword">client</span> D
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--       ID</span>
<span class="hljs-keyword">WITH</span> ins <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">client</span>(<font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span><font></font>
  )<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span>
  <span class="hljs-keyword">FROM</span><font></font>
    client_import<font></font>
  <span class="hljs-keyword">WHERE</span>
    client_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  ID  </span>
  <span class="hljs-keyword">RETURNING</span> *<font></font>
)<font></font>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  ins D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--  ID    </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  invoice_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  client_import D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.client_inn = D.inn; <span class="hljs-comment">--  </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eigentlich alles - </font></font><code>invoice_import</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jetzt haben wir das Kommunikationsfeld ausgef√ºllt, </font></font><code>client_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit dem wir das Konto einf√ºgen werden.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de492454/index.html">Wir verkaufen Architecture Refactoring an einen Kunden oder was ist das Problem der Entwickler</a></li>
<li><a href="../de492456/index.html">Visualisieren und Animieren von (geophysikalischen) Modellen. Rohdaten anzeigen</a></li>
<li><a href="../de492458/index.html">Einfache GUI f√ºr M5Stack (Arduino)</a></li>
<li><a href="../de492460/index.html">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —Ç–æ, —á—Ç–æ –≤–∞–º (–Ω–∞–≤–µ—Ä–Ω–æ) —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª–∏. –ï—Å–ª–∏ –≤—ã —Å–ª—É—à–∞–ª–∏</a></li>
<li><a href="../de492462/index.html">Quelle der Wahrheit: Wie ein Analyst einem Manager und einem Entwickler die Zusammenarbeit beibringt</a></li>
<li><a href="../de492466/index.html">So wechseln Sie in nur f√ºnf Schritten von einem Host-Anbieter mit cPanel zu Plesk in Rusonix</a></li>
<li><a href="../de492468/index.html">Lenovo Thinkserver SE350: ein Held aus der Peripherie</a></li>
<li><a href="../de492474/index.html">Wir strukturieren die Informationen auf Android-Boxen und analysieren, was ein normales Pr√§fix kann.</a></li>
<li><a href="../de492478/index.html">Ohne Wissensmanagement tut es weh: 5 Hauptfolgen eines Systemmangels</a></li>
<li><a href="../de492480/index.html">Wie wir zuvor mit Epidemien gek√§mpft haben und was wir gegen Coronavirus tun</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>