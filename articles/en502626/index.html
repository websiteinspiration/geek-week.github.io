<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìÄ üêõ üâê Automatic iOS screenshots using XCTestplan and Xcode 11 üèÄ üåº üèä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are several mobile applications in Raiffeisenbank that should work on a wide variety of devices and operating systems, so we try to automate the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Automatic iOS screenshots using XCTestplan and Xcode 11</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/raiffeisenbank/blog/502626/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are several mobile applications in Raiffeisenbank that should work on a wide variety of devices and operating systems, so we try to automate the routine processes in testing. This article seemed useful to us, and we decided to translate it. </font></font></i><font style="vertical-align: inherit;"><font color="grey"><font style="vertical-align: inherit;">foto source: unsplash.com</font></font><font style="vertical-align: inherit;"> 
If your application is multilingual, universal and designed for different devices, then you can spend a lot of time creating screenshots for each configuration. Imagine you have four languages, support for iPad and iPhone and you need to save 4 screens each - these are 32 screenshots. The process must be automated so as not to waste time every time the interfaces are updated.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/zh/ny/9i/zhny9ihqeamema_yinthkbx9cgg.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"></font></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The XCTestPlan tool, which appeared in Xcode 11, allows us to create several configurations for tests. </font><font style="vertical-align: inherit;">Nowadays, configurations are most often used to determine how tests will run, including the choice of language for the application. </font><font style="vertical-align: inherit;">In this article, you will learn how to use XCTestPlan to automate screenshots.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Launch XCTestplan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's set up a separate UITests target to automate the creation of screenshots, which is especially useful if you do not plan to run your main tests with these configurations. To create a new target, select </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File -&gt; New -&gt; Target</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and create a new </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UI Testing Bundle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . After that, you need to add a new </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XCTestplan to</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> this target. To do this, you can either use the menu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Product -&gt; Test Plan -&gt; New Test Plan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , or in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scheme Editor</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> select </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Convert to use Test Plans</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If you do this through the menu, you need to make sure that the new target is on the `Test` tab.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we want to configure only the language settings, we can leave the Shared Settings unchanged and simply add a new configuration for each language that we support. </font><font style="vertical-align: inherit;">This is what the settings for an application that supports English, German and French look like: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e73/6c7/f4b/e736c7f4b030915e123f137711f1a73f.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is all the necessary setup and launch of XCTestplan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Screenshot Automation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Your UI tests creating screenshots will practically not differ from your usual tests except that they will create attachments. You can also add XCTAssert checks so that the tests fail if something goes wrong. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another important point: you may need to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">waitForExpectations</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in case your UI is not ready by the time the screenshot </font><font style="vertical-align: inherit;">is taken ( </font><b><font style="vertical-align: inherit;">keyboard showing</font></b><font style="vertical-align: inherit;"> / hiding, animation completion). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below is an example with all the helper methods:</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testScreenshots</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">let</span> app = <span class="hljs-type">XCUIApplication</span>()
    <span class="hljs-keyword">let</span> searchButton = app.buttons[<span class="hljs-string">"search"</span>]<font></font>
    searchButton.tap()<font></font>
    <font></font>
    <span class="hljs-keyword">let</span> keyboard = app.keyboards.firstMatch<font></font>
    waitForExistence(of: keyboard)<font></font>
    app.typeText(<span class="hljs-string">"Cupertino"</span>)<font></font>
    add(takePromoShot(name: <span class="hljs-string">"Search"</span>))<font></font>
    <font></font>
    <span class="hljs-keyword">let</span> firstResult = app.cells.firstMatch<font></font>
    firstResult.tap()<font></font>
    waitForDisappearance(of: keyboard)<font></font>
    add(takePromoShot(name: <span class="hljs-string">"Result"</span>))<font></font>
}<font></font>
</code></pre><br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">waitForExistence</span><span class="hljs-params">(of element: XCUIElement)</span></span> {
    <span class="hljs-keyword">let</span> predicate = <span class="hljs-type">NSPredicate</span>(format: <span class="hljs-string">"exists == TRUE"</span>)<font></font>
    expectation(<span class="hljs-keyword">for</span>: predicate, evaluatedWith: element, handler: <span class="hljs-literal">nil</span>)<font></font>
    waitForExpectations(timeout: <span class="hljs-number">5.0</span>, handler: <span class="hljs-literal">nil</span>)<font></font>
}<font></font>
</code></pre><br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">waitForDisappearance</span><span class="hljs-params">(of element: XCUIElement)</span></span> {
    <span class="hljs-keyword">let</span> predicate = <span class="hljs-type">NSPredicate</span>(format: <span class="hljs-string">"exists == FALSE"</span>)<font></font>
    expectation(<span class="hljs-keyword">for</span>: predicate, evaluatedWith: element, handler: <span class="hljs-literal">nil</span>)<font></font>
    waitForExpectations(timeout: <span class="hljs-number">5.0</span>, handler: <span class="hljs-literal">nil</span>)<font></font>
}<font></font>
</code></pre><br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">takePromoShot</span><span class="hljs-params">(name: String)</span></span> -&gt; <span class="hljs-type">XCTAttachment</span> {
    <span class="hljs-keyword">let</span> lang = <span class="hljs-type">Locale</span>.preferredLanguages[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">let</span> screenshot = <span class="hljs-type">XCUIScreen</span>.main.screenshot()
    <span class="hljs-keyword">let</span> attachment = <span class="hljs-type">XCTAttachment</span>(screenshot: screenshot)<font></font>
    attachment.lifetime = .keepAlways<font></font>
    attachment.name = <span class="hljs-string">"\(lang)-\(name)"</span>
    <span class="hljs-keyword">return</span> attachment<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pay attention to the latest feature. </font><font style="vertical-align: inherit;">It takes the name of the snapshot, adds the language identifier, takes a screenshot and returns an XCTAttachment with the value of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.keepAlways</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This is important because by default, screenshots taken during tests are deleted if the tests succeed. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lifiteme is</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> an important parameter because it ensures that the screenshot is saved after the test is completed. </font><font style="vertical-align: inherit;">During UI tests, screenshots are constantly taken. </font><font style="vertical-align: inherit;">They are very useful when you need to determine why and when the test fell; </font><font style="vertical-align: inherit;">but by default the screenshots will be deleted if the tests were successful. </font><font style="vertical-align: inherit;">Thus, when </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">testScreenshots ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> succeeds, you will only have the necessary screenshots.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habitual status bar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most developers prefer to see on their screenshots a status bar with the right time, a complete network signal and other details. </font><font style="vertical-align: inherit;">In Xcode 11, this is made even easier. </font><font style="vertical-align: inherit;">There is a utility </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xcrun simctl status_bar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which allows you to specify these settings. </font><font style="vertical-align: inherit;">This can be added as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build Phase</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">xcrun simctl status_bar booted override --time 9:41 --operatorName <span class="hljs-string">' '</span> --cellularMode active --cellularBar 4 --wifiBars 3 --batteryState charged</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After this command, the status bar will look the same as in the marketing materials of Apple. </font><font style="vertical-align: inherit;">Unfortunately, the team will not work on a real device, only in a simulator. </font><font style="vertical-align: inherit;">It should also be noted that the simulator that you use must be running before you start the tests to collect screenshots.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collecting the resulting screenshots</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can run our UI tests. </font><font style="vertical-align: inherit;">When they pass, we will see the results in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Report Navigator</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Xcode. </font><font style="vertical-align: inherit;">There will also be tests containing procedures grouped by language configurations. </font><font style="vertical-align: inherit;">Procedures that have attachments are marked with a paper clip. </font><font style="vertical-align: inherit;">Images themselves can be opened in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QuickLook</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/4c8/412/fce/4c8412fce1f89e4da3cc3ceddc79d858.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Separately collecting all the resulting pictures can be very time-consuming, especially if your application supports many languages. </font><font style="vertical-align: inherit;">Unfortunately, these attachments do not appear as png or jpg among the test results (another change in Xcode 11). </font><font style="vertical-align: inherit;">But you can parse the test results and find the JSON that points to the real attachments and collects them. </font><font style="vertical-align: inherit;">This can be done </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the xcparse utility.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is installed using Homebrew and launched by the command:</font></font><br>
<br>
<pre><code class="bash hljs">xcparse screenshots /path/to/Test.xcresult /path/to/outputDirectory</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Additional flags will group files by device, OS, or configuration. </font><font style="vertical-align: inherit;">The names of our files contain a language identifier, so you can simply sort them by name.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The described approach has already allowed us to save enough time, especially in situations where there was a requirement to support the device with a new resolution or the interface was significantly updated. </font><font style="vertical-align: inherit;">At WWDC20, I would like to see the choice of devices as part of the XCTestplan configuration, but for now, you have to choose manually or use a script that collects the necessary screenshots in the AppStore.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502604/index.html">An Introduction to TLS for Patrik Patrick (Part 1)</a></li>
<li><a href="../en502608/index.html">How we started the marketplace of applications in the SaaS service</a></li>
<li><a href="../en502614/index.html">Kubernetes best practices. Setting Queries and Resource Limits</a></li>
<li><a href="../en502620/index.html">Money accounting</a></li>
<li><a href="../en502624/index.html">How do they work on Facebook? Values ‚Äã‚Äãand hiring in a company</a></li>
<li><a href="../en502628/index.html">The semantic web myth</a></li>
<li><a href="../en502630/index.html">Mail that you deleted a couple of years ago can still be stored on your smartphone</a></li>
<li><a href="../en502634/index.html">Telemedicine. Three technology startups. The product is one, but different fates</a></li>
<li><a href="../en502636/index.html">Business and cyberpunk: mix, sustain, use</a></li>
<li><a href="../en502638/index.html">How to develop a blog on Instagram in 2020: analysis of the case of Sasha Mitroshina</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>