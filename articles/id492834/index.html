<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👶🏿 🤭 🥟 Apa yang umum antara LVM dan matryoshka? 🧜 😜 🎣</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat siang. 
 Saya ingin berbagi dengan pengalaman praktis komunitas dalam membangun sistem penyimpanan untuk KVM menggunakan md RAID + LVM. 
 
 Pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Apa yang umum antara LVM dan matryoshka?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492834/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selamat siang. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya ingin berbagi dengan pengalaman praktis komunitas dalam membangun sistem penyimpanan untuk KVM menggunakan md RAID + LVM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Program ini akan:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bangun md RAID 1 dari NVMe SSD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bangun md RAID 6 dari SATA SSD dan drive biasa.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fitur TRIM / DISCARD pada SSD RAID 1/6.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat larik md RAID 1/6 yang dapat di-boot pada serangkaian disk yang umum.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menginstal sistem pada NVMe RAID 1 jika tidak ada dukungan NVMe di BIOS.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menggunakan LVM cache dan LVM thin.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menggunakan snapshot BTRFS dan kirim / terima untuk cadangan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menggunakan snapshot tipis LVM dan thin_delta untuk backup gaya BTRFS.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika tertarik, silakan, di bawah kucing.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pernyataan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penulis tidak bertanggung jawab atas konsekuensi penggunaan atau tidak menggunakan bahan / contoh / kode / tips / data dari artikel ini. </font><font style="vertical-align: inherit;">Dengan membaca atau menggunakan materi ini dengan cara apa pun, Anda bertanggung jawab atas semua konsekuensi dari tindakan ini. </font><font style="vertical-align: inherit;">Kemungkinan konsekuensi meliputi:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSD NVMe Goreng Renyah.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Benar-benar menghabiskan sumber daya perekaman dan kegagalan drive SSD.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kehilangan total semua data di semua drive, termasuk cadangan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perangkat keras komputer rusak.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menghabiskan waktu, gelisah, dan uang.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Efek lain apa pun yang tidak tercantum di atas.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Besi</font></font></h2><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stoknya adalah:</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Motherboard ini sekitar 2013 pada chipset Z87 lengkap dengan Intel Core i7 / Haswell.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CPU 4 core, 8 thread</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RAM DDR3 32 Gigabytes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 x 16 atau 2 x 8 PCIe 3.0</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1 x 4 + 1 x 1 PCIe 2.0</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Konektor SATA 3 6 x 6 GBps </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adaptor SAS LSI SAS9211-8I beralih ke mode IT / HBA. </font><font style="vertical-align: inherit;">Firmware yang mendukung RAID telah sengaja diganti dengan firmware HBA untuk:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setiap saat dimungkinkan untuk membuang adaptor ini dan menggantinya dengan adaptor pertama lainnya.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRIM / Buang berfungsi normal pada disk, seperti </font><font style="vertical-align: inherit;">dalam firmware RAID, perintah-perintah ini tidak didukung sama sekali, dan HBA, secara umum, tidak peduli perintah apa yang harus dikirim pada bus.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hard drive - 8 buah HGST Travelstar 7K1000 dengan volume 1 TB dalam form factor 2.5, seperti untuk laptop. </font><font style="vertical-align: inherit;">Drive ini sebelumnya dalam array RAID 6. </font><font style="vertical-align: inherit;">Dalam sistem baru, mereka juga akan menemukan aplikasi. </font><font style="vertical-align: inherit;">Untuk menyimpan cadangan lokal.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selain itu ditambahkan:</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6 buah model SATA SSD Samsung 860 QVO 2TB. </font><font style="vertical-align: inherit;">SSD ini membutuhkan jumlah besar, keberadaan cache SLC, keandalan yang diinginkan, dan harga yang murah. </font><font style="vertical-align: inherit;">Wajib adalah dukungan untuk membuang / nol yang diperiksa oleh garis di dmesg: </font></font><br>
<br>
<code>kernel: ata1.00: Enabling discard_zeroes_data</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 buah model NVMe SSD Samsung SSD 970 EVO 500GB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk SSD ini, kecepatan baca / tulis acak dan sumber daya untuk kebutuhan Anda adalah penting. </font><font style="vertical-align: inherit;">Radiator untuk mereka. </font><font style="vertical-align: inherit;">Wajib. </font><font style="vertical-align: inherit;">Benar-benar perlu. </font><font style="vertical-align: inherit;">Kalau tidak, goreng mereka sampai garing selama sinkronisasi RAIDa pertama.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adaptor StarTech PEX8M2E2 untuk 2 x NVMe SSD dengan PCIe 3.0 8x slot. Ini, sekali lagi, hanya HBA, tetapi untuk NVMe. Ini berbeda dari adaptor murah karena tidak adanya persyaratan untuk dukungan bifurkasi PCIe dari motherboard karena adanya sakelar PCIe terintegrasi. Ini akan bekerja bahkan dalam sistem tertua di mana ada PCIe, bahkan jika itu adalah slot x1 PCIe 1.0. Wajar, dengan kecepatan yang sesuai. Tidak ada RAID di sana. Tidak ada BIOS terintegrasi di papan. Jadi, sistem Anda tidak akan secara ajaib belajar melakukan booting dari NVMe, apalagi NVMe RAID berkat perangkat ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Komponen ini hanya disebabkan oleh kehadiran hanya satu 8x PCIe 3.0 gratis dalam sistem, dan, dengan adanya 2 slot gratis, komponen ini mudah diganti oleh dua PEX4M2E1 atau analog murah, yang dapat dibeli di mana saja dengan harga 600 rubel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penolakan terhadap semua jenis perangkat keras atau chipset / BIOS RAID terintegrasi dibuat dengan sengaja, agar dapat sepenuhnya menggantikan seluruh sistem, dengan pengecualian SSD / HDD itu sendiri, menyimpan semua data. </font><font style="vertical-align: inherit;">Idealnya, akan memungkinkan untuk menjaga bahkan sistem operasi yang terinstal ketika pindah ke perangkat keras yang sama sekali baru / berbeda. </font><font style="vertical-align: inherit;">Yang utama adalah bahwa ada port SATA dan PCIe. </font><font style="vertical-align: inherit;">Ini seperti live CD atau bootable flash drive, hanya sangat cepat dan sedikit kebesaran.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Humor</font></font></b><div class="spoiler_text"> ,   , —          .     .            5.25  .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yah, dan, tentu saja, untuk bereksperimen dengan berbagai metode caching SSD di Linux.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penggerebekan perangkat keras, itu membosankan. </font><font style="vertical-align: inherit;">Nyalakan. </font><font style="vertical-align: inherit;">Itu bekerja atau tidak. </font><font style="vertical-align: inherit;">Dan dengan mdadm selalu ada opsi.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lembut</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelumnya, Debian 8 Jessie diinstal pada perangkat keras, yang dekat dengan EOL. </font><font style="vertical-align: inherit;">RAID 6 dari HDD yang disebutkan di atas dipasangkan dengan LVM. </font><font style="vertical-align: inherit;">Itu menjalankan mesin virtual di kvm / libvirt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena </font><font style="vertical-align: inherit;">Penulis memiliki pengalaman yang tepat dalam membuat flash drive SATA / NVMe portabel yang dapat di-boot, dan juga, agar tidak merobek apt-template yang biasa, Ubuntu 18.04 dipilih sebagai sistem target, yang telah cukup stabil, tetapi masih memiliki dukungan 3 tahun di masa depan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam sistem yang disebutkan ada semua driver perangkat keras yang kita butuhkan di luar kotak. </font><font style="vertical-align: inherit;">Kami tidak memerlukan perangkat lunak dan driver pihak ketiga.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Persiapan untuk instalasi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menginstal sistem, kita perlu Ubuntu Desktop Image. </font><font style="vertical-align: inherit;">Sistem server memiliki semacam penginstal yang kuat yang menunjukkan kemandirian yang berlebihan dan tidak dapat dilepaskan, selalu mendorong partisi sistem UEFI ke salah satu disk yang merusak semua keindahan. </font><font style="vertical-align: inherit;">Karenanya, ini hanya diinstal dalam mode UEFI. </font><font style="vertical-align: inherit;">Itu tidak menawarkan opsi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini tidak cocok untuk kita.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa?</font></font></b><div class="spoiler_text"> , UEFI        RAID, ..   UEFI ESP     .    ,    ESP     USB , ,   .      mdadm RAID 1    0.9    UEFI BIOS   , ,       BIOS       -  ESP     .<br>
<br>
 ,  UEFI   NVRAM,         , ..    .<br>
<br>
 ,      .     ,       Legacy/BIOS boot,    CSM  UEFI- .      , ,      .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versi desktop Ubuntu juga tidak tahu cara menginstal secara normal dengan Legload bootloader, tetapi di sini, seperti yang mereka katakan, setidaknya ada opsi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maka, kumpulkan perangkat keras dan muat sistem dari flash drive Ubuntu Live yang dapat di-boot. </font><font style="vertical-align: inherit;">Kami perlu mengunduh paket, jadi kami menyiapkan jaringan, yang menghasilkan Anda. </font><font style="vertical-align: inherit;">Jika tidak berhasil, Anda dapat mengunduh paket yang diperlukan ke USB flash drive terlebih dahulu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita masuk ke lingkungan Desktop, menjalankan emulator terminal, dan mari kita pergi:</font></font><br>
<br>
<code>#sudo bash</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana...?</font></font></b><div class="spoiler_text">       sudo.  <b></b>    <b></b> .   ,       .     sudo   ,     . :<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/W-tPTmdnc7E" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br>
<code>#apt-get install mdadm lvm2 thin-provisioning-tools btrfs-tools util-linux lsscsi nvme-cli mc</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenapa tidak ZFS ...?</font></font></b><div class="spoiler_text">       , —  ,         . <br>
        , —        ,   -  .<br>
<br>
    ZFS —  ,  mdadm+lvm    .<br>
<br>
           .      .   .  .  .  .      ,       . <br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lalu mengapa BTRFS ...?</font></font></b><div class="spoiler_text">            Legacy/BIOS GRUB  , ,  ,   -.      /boot .  ,       / ()   ,           LVM     . <br>
<br>
   ,          .<br>
                       send/recieve.<br>
<br>
 ,                        GPU  PCI-USB Host-  KVM  IOMMU.<br>
<br>
    —  ,    .<br>
<br>
    ZFS, ,  ,     .<br>
<br>
  ,       / RAID      ZFS, BRTFS  LVM.<br>
<br>
   , BTRFS       ,         /    HDD.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Scan ulang semua perangkat: Mari kita lihat-lihat </font></font><br>
<br>
<code>#udevadm control --reload-rules &amp;&amp; udevadm trigger</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
:</font></font><br>
<br>
<code>#lsscsi &amp;&amp; nvme list<br>
[0:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sda <br>
[1:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sdb <br>
[2:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sdc <br>
[3:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sdd <br>
[4:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sde <br>
[5:0:0:0] disk ATA Samsung SSD 860 2B6Q /dev/sdf <br>
[6:0:0:0] disk ATA HGST HTS721010A9 A3J0 /dev/sdg <br>
[6:0:1:0] disk ATA HGST HTS721010A9 A3J0 /dev/sdh <br>
[6:0:2:0] disk ATA HGST HTS721010A9 A3J0 /dev/sdi <br>
[6:0:3:0] disk ATA HGST HTS721010A9 A3B0 /dev/sdj <br>
[6:0:4:0] disk ATA HGST HTS721010A9 A3B0 /dev/sdk <br>
[6:0:5:0] disk ATA HGST HTS721010A9 A3B0 /dev/sdl <br>
[6:0:6:0] disk ATA HGST HTS721010A9 A3J0 /dev/sdm <br>
[6:0:7:0] disk ATA HGST HTS721010A9 A3J0 /dev/sdn <br>
Node SN Model Namespace Usage Format FW Rev <br>
---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------<br>
/dev/nvme0n1 S466NXXXXXXX15L Samsung SSD 970 EVO 500GB 1 0,00 GB / 500,11 GB 512 B + 0 B 2B2QEXE7<br>
/dev/nvme1n1 S5H7NXXXXXXX48N Samsung SSD 970 EVO 500GB 1 0,00 GB / 500,11 GB 512 B + 0 B 2B2QEXE7<br>
</code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mempartisi "drive"</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSD NVMe</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi dengan cara apa pun kami tidak akan menandai mereka. </font><font style="vertical-align: inherit;">Semua sama, BIOS kami tidak melihat drive ini. </font><font style="vertical-align: inherit;">Jadi, mereka akan pergi sepenuhnya ke perangkat lunak RAID. </font><font style="vertical-align: inherit;">Kami bahkan tidak akan membuat partisi di sana. </font><font style="vertical-align: inherit;">Jika Anda ingin sesuai dengan "kanon" atau "prinsip" - buat satu partisi besar, seperti HDD.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HDD SATA</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak ada yang istimewa untuk ditemukan. </font><font style="vertical-align: inherit;">Kami akan membuat satu bagian untuk semuanya. </font><font style="vertical-align: inherit;">Kami akan membuat bagian karena BIOS melihat disk ini dan bahkan mungkin mencoba untuk boot dari mereka. </font><font style="vertical-align: inherit;">Kami bahkan akan menginstal GRUB nanti pada disk ini sehingga sistem tiba-tiba berhasil.</font></font><br>
<br>
<code>#cat &gt;hdd.part &lt;&lt; EOF<br>
label: dos<br>
label-id: 0x00000000<br>
device: /dev/sdg<br>
unit: sectors<br>
<br>
/dev/sdg1 : start= 2048, size= 1953523120, type=fd, bootable<br>
EOF<br>
#sfdisk /dev/sdg &lt; hdd.part<br>
#sfdisk /dev/sdh &lt; hdd.part<br>
#sfdisk /dev/sdi &lt; hdd.part<br>
#sfdisk /dev/sdj &lt; hdd.part<br>
#sfdisk /dev/sdk &lt; hdd.part<br>
#sfdisk /dev/sdl &lt; hdd.part<br>
#sfdisk /dev/sdm &lt; hdd.part<br>
#sfdisk /dev/sdn &lt; hdd.part<br>
</code><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSD SATA</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini kita memiliki yang paling menarik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, kami memiliki 2 drive TB. </font><font style="vertical-align: inherit;">Ini berada dalam batas yang diizinkan untuk MBR, yang akan kami gunakan. </font><font style="vertical-align: inherit;">Jika perlu, bisa diganti dengan GPT. </font><font style="vertical-align: inherit;">Disk GPT memiliki lapisan kompatibilitas yang memungkinkan sistem yang kompatibel dengan MBR untuk melihat 4 partisi pertama jika mereka berada dalam 2 terabyte pertama. </font><font style="vertical-align: inherit;">Yang utama adalah bahwa partisi boot dan partisi bios_grub pada disk ini harus berada di awal. </font><font style="vertical-align: inherit;">Ini memungkinkan Anda untuk melakukan booting dari drive GPT Legacy / BIOS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi, ini bukan kasus kami. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini kita akan membuat dua bagian. </font><font style="vertical-align: inherit;">Yang pertama berukuran 1 GB dan digunakan untuk RAID 1 / boot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yang kedua akan digunakan untuk RAID 6 dan mengambil semua ruang kosong yang tersisa dengan pengecualian area kecil yang tidak terisi pada akhir drive.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa area yang belum dialokasikan?</font></font></b><div class="spoiler_text">     SATA SSD      SLC    6  78 . 6    «»     «»  «»   .  72      . <br>
<br>
  ,     SLC,      4 bit MLC.     ,    4       1  SLC .<br>
<br>
 72   4   288 .           ,       SLC .<br>
<br>
 ,     312  SLC     .    2    RAID  .<br>
<br>
            ,      .        QLC , —          .      , ,       ,    SSD     TBW  .<br>
</div></div><br>
<code>#cat &gt;ssd.part &lt;&lt; EOF<br>
label: dos<br>
label-id: 0x00000000<br>
device: /dev/sda<br>
unit: sectors<br>
<br>
/dev/sda1 : start= 2048, size= 2097152, type=fd, bootable<br>
/dev/sda2 : start= 2099200, size= 3300950016, type=fd<br>
EOF<br>
#sfdisk /dev/sda &lt; ssd.part<br>
#sfdisk /dev/sdb &lt; ssd.part<br>
#sfdisk /dev/sdc &lt; ssd.part<br>
#sfdisk /dev/sdd &lt; ssd.part<br>
#sfdisk /dev/sde &lt; ssd.part<br>
#sfdisk /dev/sdf &lt; ssd.part<br>
</code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membuat Array</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama kita perlu mengganti nama mobil. </font><font style="vertical-align: inherit;">Ini diperlukan karena nama host adalah bagian dari nama array di suatu tempat di dalam mdadm dan memengaruhi sesuatu di suatu tempat. </font><font style="vertical-align: inherit;">Array, tentu saja, dapat diubah namanya nanti, tetapi, ini adalah tindakan yang tidak perlu.</font></font><br>
<br>
<code>#mcedit /etc/hostname <br>
#mcedit /etc/hosts<br>
#hostname<br>
vdesk0<br>
</code><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSD NVMe</font></font></h4><br>
<code>#mdadm --create --verbose --assume-clean /dev/md0 --level=1 --raid-devices=2 /dev/nvme[0-1]n1</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenapa - bersih-bersih ...?</font></font></b><div class="spoiler_text">   .    RAID 1  6  .      ,    .  ,   SSD   —     TBW.   TRIM/DISCARD      SSD   «».<br>
<br>
  SSD RAID 1 DISCARD   .<br>
<br>
  SSD RAID 6 DISCARD      . <br>
<br>
      ,    SSD     4/5/6       discard_zeroes_data.    ,       , , -,  ,     .       , ,       .     DISCARD -   RAID 6.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhatian, perintah berikut ini akan menghancurkan semua data pada drive NVMe dengan "menginisialisasi" array dengan "nol". </font></font><br>
<br>
<code>#blkdiscard /dev/md0</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika terjadi kesalahan, maka coba tentukan langkah.</font></font><br>
<br>
<code>#blkdiscard --step 65536 /dev/md0</code><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SSD SATA</font></font></h4><br>
<code>#mdadm --create --verbose --assume-clean /dev/md1 --level=1 --raid-devices=6 /dev/sd[a-f]1</code><br>
<code>#blkdiscard /dev/md1</code><br>
<code>#mdadm --create --verbose --assume-clean /dev/md2 --chunk-size=512 --level=6 --raid-devices=6 /dev/sd[a-f]2</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenapa begitu besar ...?</font></font></b><div class="spoiler_text"> chunk-size         chunk-size .   ,              . , IOPS    .   99% IO   512K.<br>
<br>
 RAID 6 IOPS   <b></b>    IOPS   .      IOPS          ,       . <br>
           RAID 6 by-design     ,   RAID 6   .<br>
   RAID 6      NVMe    thin-provisioning.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami belum mengaktifkan DISCARD untuk RAID 6. Jadi, kami belum akan "menginisialisasi" array ini. </font><font style="vertical-align: inherit;">Kami akan melakukannya nanti, setelah menginstal OS.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HDD SATA</font></font></h4><br>
<code>#mdadm --create --verbose --assume-clean /dev/md3 --chunk-size=512 --level=6 --raid-devices=8 /dev/sd[g-n]1</code><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LVM pada NVMe RAID</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk kecepatan, kami ingin menempatkan FS root pada NVMe RAID 1 yang merupakan / dev / md0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Namun demikian, kita masih memerlukan array cepat ini untuk kebutuhan lain, seperti swap, metadata dan LVM-cache dan metadata tipis-LVM, oleh karena itu, pada array ini kita akan membuat LVM VG. </font><font style="vertical-align: inherit;">
Buat partisi untuk root FS. </font><font style="vertical-align: inherit;">
Buat bagian untuk menukar ukuran RAM.</font></font><br>
<br>
<code>#pvcreate /dev/md0<br>
#vgcreate root /dev/md0</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -L 128G --name root root</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -L 32G --name swap root</code><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalasi OS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara total, kami memiliki semua yang diperlukan untuk menginstal sistem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buka wizard penginstalan dari lingkungan Ubuntu Live. </font><font style="vertical-align: inherit;">Instalasi normal. </font><font style="vertical-align: inherit;">Hanya pada tahap memilih drive untuk instalasi, Anda perlu menentukan yang berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / md1, - mount point / boot, FS - BTRFS </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / root / root (alias / dev / mapper / root-root), - mount point / (root), FS - BTRFS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / root / swap (alias / dev / mapper / root-swap), - gunakan sebagai partisi swap</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instal bootloader di / dev / sda</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda memilih BTRFS sebagai root FS, installer akan secara otomatis membuat dua volume BTRFS dengan nama "@" untuk / (root), dan "@home" untuk / home. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memulai instalasi ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instalasi akan berakhir dengan kotak dialog modal yang menginformasikan tentang kesalahan instalasi bootloader. </font><font style="vertical-align: inherit;">Sayangnya, keluar dari dialog ini dengan cara biasa dan melanjutkan instalasi akan gagal. </font><font style="vertical-align: inherit;">Kami keluar dari sistem dan masuk lagi, masuk ke desktop Ubuntu Live yang bersih. </font><font style="vertical-align: inherit;">Buka terminal, dan lagi: </font></font><br>
<br>
<code>#sudo bash</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat lingkungan chroot untuk melanjutkan instalasi: Mengatur </font><font style="vertical-align: inherit;">
jaringan dan nama host di chroot: </font><font style="vertical-align: inherit;">
Pergi ke lingkungan chroot: </font><font style="vertical-align: inherit;">
Pertama kami mengirimkan paket: </font><font style="vertical-align: inherit;">
Periksa dan perbaiki semua paket yang bengkok karena instalasi sistem yang tidak lengkap:</font></font><br>
<br>
<code>#mkdir /mnt/chroot<br>
#mount -o defaults,space_cache,noatime,nodiratime,discard,subvol=@ /dev/mapper/root-root /mnt/chroot<br>
#mount -o defaults,space_cache,noatime,nodiratime,discard,subvol=@home /dev/mapper/root-root /mnt/chroot/home<br>
#mount -o defaults,space_cache,noatime,nodiratime,discard /dev/md1 /mnt/chroot/boot<br>
#mount --bind /proc /mnt/chroot/proc <br>
#mount --bind /sys /mnt/chroot/sys<br>
#mount --bind /dev /mnt/chroot/dev<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#cat /etc/hostname &gt;/mnt/chroot/etc/hostname<br>
#cat /etc/hosts &gt;/mnt/chroot/etc/hosts<br>
#cat /etc/resolv.conf &gt;/mnt/chroot/etc/resolv.conf<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#chroot /mnt/chroot<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>apt-get install --reinstall mdadm lvm2 thin-provisioning-tools btrfs-tools util-linux lsscsi nvme-cli mc debsums hdparm</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#CORRUPTED_PACKAGES=$(debsums -s 2&gt;&amp;1 | awk '{print $6}' | uniq)<br>
#apt-get install --reinstall $CORRUPTED_PACKAGES<br>
</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika sesuatu tidak tumbuh bersama, Anda mungkin perlu </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mengedit </font><font style="vertical-align: inherit;">/etc/apt/sources.list sebelum itu. </font><font style="vertical-align: inherit;">Mari kita ubah parameter untuk modul RAID 6 untuk mengaktifkan TRIM / DISCARD: Kami akan </font><font style="vertical-align: inherit;">
sedikit menyesuaikan array kami:</font></font><br>
<br>
<code>#cat &gt;/etc/modprobe.d/raid456.conf &lt;&lt; EOF<br>
options raid456 devices_handle_discard_safely=1<br>
EOF<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#cat &gt;/etc/udev/rules.d/60-md.rules &lt;&lt; EOF<br>
SUBSYSTEM=="block", KERNEL=="md*", ACTION=="change", TEST=="md/stripe_cache_size", ATTR{md/stripe_cache_size}="32768"<br>
SUBSYSTEM=="block", KERNEL=="md*", ACTION=="change", TEST=="md/sync_speed_min", ATTR{md/sync_speed_min}="48000"<br>
SUBSYSTEM=="block", KERNEL=="md*", ACTION=="change", TEST=="md/sync_speed_max", ATTR{md/sync_speed_max}="300000"<br>
EOF<br>
#cat &gt;/etc/udev/rules.d/62-hdparm.rules &lt;&lt; EOF<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="1", RUN+="/sbin/hdparm -B 254 /dev/%k"<br>
EOF<br>
#cat &gt;/etc/udev/rules.d/63-blockdev.rules &lt;&lt; EOF<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="1", RUN+="/sbin/blockdev --setra 1024 /dev/%k"<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="sd[a-z]", ATTR{queue/rotational}=="0", RUN+="/sbin/blockdev --setra 0 /dev/%k"<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="nvme[0-9]n1", RUN+="/sbin/blockdev --setra 0 /dev/%k"<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="dm-*", ATTR{queue/rotational}=="0", RUN+="/sbin/blockdev --setra 0 /dev/%k"<br>
SUBSYSTEM=="block", ACTION=="add|change", KERNEL=="md*", RUN+="/sbin/blockdev --setra 0 /dev/%k"<br>
<br>
EOF<br>
</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa itu..?</font></font></b><div class="spoiler_text">   udev     :<br>
<br>
<ul>
<li>    2020-      RAID 6.  -, ,      Linux,     .</li>
<li>    /   IO.  ,           .</li>
<li>    /   IO.  ,  / SSD RAID-       .    NVMe. (   ?    . )</li>
<li>   APM     (HDD)         7 .    APM      (-B 255).   -      .      ,   , ,  -.       .    -        .     , , - «»,    -,    RAID-   mini-MAID-.</li>
<li> readahead   ()  1  —   /chunk RAID 6</li>
<li> readahead  SATA SSD</li>
<li> readahead  NVMe SSD</li>
<li> readahead   LVM    SSD.</li>
<li> readahead   RAID .</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edit / etc / fstab:</font></font><br>
<br>
<code>#cat &gt;/etc/fstab &lt;&lt; EOF<br>
# /etc/fstab: static file system information.<br>
#<br>
# Use 'blkid' to print the universally unique identifier for a<br>
# device; this may be used with UUID= as a more robust way to name devices<br>
# that works even if disks are added and removed. See fstab(5).<br>
# file-system mount-point type options dump pass<br>
/dev/mapper/root-root / btrfs defaults,space_cache,noatime,nodiratime,discard,subvol=@ 0 1<br>
UUID=$(blkid -o value -s UUID /dev/md1) /boot btrfs defaults,space_cache,noatime,nodiratime,discard 0 2<br>
/dev/mapper/root-root /home btrfs defaults,space_cache,noatime,nodiratime,discard,subvol=@home 0 2<br>
/dev/mapper/root-swap none swap sw 0 0<br>
EOF</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mengapa demikian..?</font></font></b><div class="spoiler_text"> /boot     UUID ..     .<br>
<br>
      LVM    /dev/mapper/vg-lv, ..     . <br>
<br>
  UUID  LVM .. UUID  LVM      .</div></div><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dua kali kita me-mount / dev / mapper / root-root ..?</font></font></b><div class="spoiler_text">.  .  BTRFS.         subvol.<br>
<br>
  -      LVM   BTRFS .     .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami membuat ulang konfigurasi mdadm: </font><font style="vertical-align: inherit;">
Memperbaiki pengaturan LVM:</font></font><br>
<br>
<code>#/usr/share/mdadm/mkconf | sed 's/#DEVICE/DEVICE/g' &gt;/etc/mdadm/mdadm.conf<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#cat &gt;&gt;/etc/lvm/lvmlocal.conf &lt;&lt; EOF<br>
<br>
activation {<br>
 thin_pool_autoextend_threshold=90<br>
 thin_pool_autoextend_percent=5<br>
}<br>
allocation {<br>
 cache_pool_max_chunks=2097152<br>
}<br>
devices {<br>
 global_filter=["r|^/dev/.*_corig$|","r|^/dev/.*_cdata$|","r|^/dev/.*_cmeta$|","r|^/dev/.*gpv$|","r|^/dev/images/.*$|","r|^/dev/mapper/images.*$|","r|^/dev/backup/.*$|","r|^/dev/mapper/backup.*$|"]<br>
 issue_discards=1<br>
}<br>
EOF<br>
</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa itu..?</font></font></b><div class="spoiler_text">     LVM thin   90%    5%  .<br>
<br>
       LVM cache.<br>
<br>
  LVM  LVM  (PV) :<br>
<br>
<ul>
<li>   LVM cache (cdata)</li>
<li>     LVM cache    (&lt;lv_name&gt;_corig).            ( &lt;lv_name&gt;).</li>
<li>    LVM cache (cmeta)</li>
<li>    VG   images.        , ,     LVM       .</li>
<li>    VG   backup.         .</li>
<li>       «gpv» ( guest physical volume )</li>
</ul><br>
   DISCARD      LVM VG.  .    LV  SSD  .     SSD RAID 6. ,  ,    thin provisioning,  ,     .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perbarui gambar initramfs: </font></font><br>
<br>
<code>#update-initramfs -u -k all</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instal dan konfigurasikan grub:</font></font><br>
<br>
<code>#apt-get install grub-pc<br>
#apt-get purge os-prober<br>
#dpkg-reconfigure grub-pc</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Drive apa yang harus dipilih?</font></font></b><div class="spoiler_text">  sd*.         SATA   SSD.<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenapa dipaku os-prober ..?</font></font></b><div class="spoiler_text">     . <br>
<br>
       RAID-    .      ,         .<br>
<br>
   ,   , ,    .         .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan ini, kami menyelesaikan instalasi awal. </font><font style="vertical-align: inherit;">Saatnya untuk reboot ke OS yang baru diinstal. </font><font style="vertical-align: inherit;">Ingatlah untuk menghapus Live CD / USB yang dapat di-boot. </font><font style="vertical-align: inherit;">
Saat perangkat melakukan boot, pilih salah satu SSD SATA.</font></font><br>
<br>
<code>#exit<br>
#reboot</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LVM ke SSD SATA</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada titik ini, kita sudah boot ke OS baru, mengkonfigurasi jaringan, apt, membuka terminal emulator, dan mulai: </font></font><br>
<br>
<code>#sudo bash</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lanjutkan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“Inisialisasi” sebuah array dari SATA SSD: </font></font><br>
<br>
<code>#blkdiscard /dev/md2</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika tidak, maka coba: </font></font><br>
<br>
<code>#blkdiscard --step 65536 /dev/md2</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat LVM VG pada SSD SATA:</font></font><br>
<br>
<code>#pvcreate /dev/md2<br>
#vgcreate data /dev/md2</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenapa lagi vg ..?</font></font></b><div class="spoiler_text">  ,     VG   root.        VG?<br>
<br>
  VG   PV,     VG  PV   (online).   LVM RAID,     .<br>
<br>
  ,    (  )    RAID 6           .<br>
<br>
 ,           «»   VG.<br>
<br>
 -,   RAID     « ».         ,    VG.<br>
<br>
 LVM  «»        RAID  -  . , —  <b></b> bcache + LVM thin, bcache + BTRFS, LVM cache + LVM thin,   ZFS       ,      .<br>
<br>
 «»   ,  - «» LVM-,   .    , ,     .<br>
<br>
,   ,     -   .<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LVM ke SATA HDD</font></font></h3><br>
<code>#pvcreate /dev/md3<br>
#vgcreate backup /dev/md3</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lagi-lagi VG baru ..?</font></font></b><div class="spoiler_text">  ,     ,        ,      , -     . , -   VG, —    VG.<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Konfigurasikan cache LVM</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat LV pada NVMe RAID 1 untuk menggunakannya sebagai perangkat caching.</font></font><br>
<br>
<code>#lvcreate -L 70871154688B --name cache root</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenapa kecil sekali ...?</font></font></b><div class="spoiler_text">  ,    NVMe SSD   SLC . 4  «»  18         3-bit MLC. -   NVMe SSD       SATA SSD  . ,        LVM cache      SLC  NVMe .   NVMe      32-64  . <br>
<br>
      64  ,       .<br>
<br>
 ,      LVM         .  ,       lvchange       . ,      .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita buat LV pada SATA RAID 6 untuk menggunakannya sebagai perangkat yang di-cache.</font></font><br>
<br>
<code>#lvcreate -L 3298543271936B --name cache data</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenapa hanya tiga terabyte ..?</font></font></b><div class="spoiler_text">,  ,    SATA SSD RAID 6  -  .      ,  ,    .         , ,   LVM-cache , , bcache,  ,      .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat VG baru untuk caching. </font><font style="vertical-align: inherit;">
Buat LV pada perangkat yang di-cache. </font><font style="vertical-align: inherit;">
Di sini kami segera mengambil semua ruang kosong di / dev / data / cache sehingga semua partisi lain yang diperlukan segera dibuat di / dev / root / cache. </font><font style="vertical-align: inherit;">Jika Anda memiliki sesuatu yang tidak dibuat di sana, Anda dapat memindahkannya menggunakan pvmove. </font><font style="vertical-align: inherit;">
Buat dan aktifkan cache:</font></font><br>
<br>
<code>#pvcreate /dev/root/cache<br>
#pvcreate /dev/data/cache<br>
#vgcreate cache /dev/root/cache /dev/data/cache</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -L 3298539077632B --name cachedata cache /dev/data/cache</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -y -L 64G -n cache cache /dev/root/cache<br>
#lvcreate -y -L 1G -n cachemeta cache /dev/root/cache<br>
#lvconvert -y --type cache-pool --cachemode writeback --chunksize 64k --poolmetadata cache/cachemeta cache/cache<br>
#lvconvert -y --type cache --cachepool cache/cache cache/cachedata<br>
</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenapa begitu bungkam ..?</font></font></b><div class="spoiler_text">     ,        LVM cache     LVM thin.  ,   ,        . <br>
<br>
64 —       LVM thin.<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perhatian penulisan kembali ..!</font></font></b><div class="spoiler_text">.         .    , ,    ,      .   ,  ,  NVMe RAID 1  ,    . <br>
<br>
    ,     RAID 6   .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita verifikasi bahwa kita berhasil: </font><font style="vertical-align: inherit;">
Hanya [cachedata_corig] yang berada di / dev / data / cache. </font><font style="vertical-align: inherit;">Jika ada sesuatu yang salah, maka gunakan pvmove. </font><font style="vertical-align: inherit;">
Jika perlu, Anda dapat menonaktifkan cache dengan satu perintah: </font><font style="vertical-align: inherit;">
Ini dilakukan secara online. </font><font style="vertical-align: inherit;">LVM hanya menyinkronkan cache ke disk, menghapusnya, dan mengganti nama cachedata_corig kembali ke cachedata.</font></font><br>
<br>
<code>#lvs -a -o lv_name,lv_size,devices --units B cache<br>
 LV LSize Devices <br>
 [cache] 68719476736B cache_cdata(0) <br>
 [cache_cdata] 68719476736B /dev/root/cache(0) <br>
 [cache_cmeta] 1073741824B /dev/root/cache(16384)<br>
 cachedata 3298539077632B cachedata_corig(0) <br>
 [cachedata_corig] 3298539077632B /dev/data/cache(0) <br>
 [lvol0_pmspare] 1073741824B /dev/root/cache(16640)<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvconvert -y --uncache cache/cachedata</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengaturan tipis LVM</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memperkirakan secara </font><font style="vertical-align: inherit;">
kasar </font><font style="vertical-align: inherit;">seberapa banyak ruang yang diperlukan untuk metadata tipis LVM </font><font style="vertical-align: inherit;">
: Membulatkan </font><font style="vertical-align: inherit;">hingga 4 gigabita: 4294967296B </font><font style="vertical-align: inherit;">Kalikan dengan dua dan tambahkan 4194304B untuk metadata LVM: 8594128896B </font><font style="vertical-align: inherit;">
Buat partisi terpisah di NVMe RAID 1 untuk menandai metadata tipis LVM di atasnya dan buat cadangan:</font></font><br>
<br>
<code>#thin_metadata_size --block-size=64k --pool-size=6terabytes --max-thins=100000 -u bytes<br>
thin_metadata_size - 3385794560 bytes estimated metadata area size for "--block-size=64kibibytes --pool-size=6terabytes --max-thins=100000"</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -L 8594128896B --name images root</code><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk apa..?</font></font></b><div class="spoiler_text">   ,    LVM thin ,        NVMe    .<br>
<br>
     ,     .    ,  ,   .    - , ,   LVM thin  ,      .         .<br>
<br>
-    -,  , ,          .             ,      .           .<br>
<br>
 ,        , ,  ,       , ,      LVM thin,        . <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat VG baru yang akan bertanggung jawab untuk penyediaan tipis: </font><font style="vertical-align: inherit;">
Buat kelompok:</font></font><br>
<br>
<code>#pvcreate /dev/root/images<br>
#pvcreate /dev/cache/cachedata<br>
#vgcreate images /dev/root/images /dev/cache/cachedata</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -L 274877906944B --poolmetadataspare y --poolmetadatasize 4294967296B --chunksize 64k -Z y -T images/thin-pool</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kenapa -Z y</font></font></b><div class="spoiler_text"> ,       , —               , — zeroing          64k.    64k           64K    .          .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari </font><font style="vertical-align: inherit;">
pindahkan LV ke PV yang sesuai: </font><font style="vertical-align: inherit;">Periksa: </font><font style="vertical-align: inherit;">
Buat volume tipis untuk pengujian: </font><font style="vertical-align: inherit;">
Pasang paket untuk pengujian dan pengamatan: </font><font style="vertical-align: inherit;">
Ini adalah bagaimana Anda dapat mengamati perilaku konfigurasi penyimpanan kami secara waktu nyata: </font><font style="vertical-align: inherit;">
Ini adalah cara Anda dapat menguji konfigurasi kami:</font></font><br>
<br>
<code>#pvmove -n images/thin-pool_tdata /dev/root/images /dev/cache/cachedata<br>
#pvmove -n images/lvol0_pmspare /dev/cache/cachedata /dev/root/images<br>
#pvmove -n images/thin-pool_tmeta /dev/cache/cachedata /dev/root/images <br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvs -a -o lv_name,lv_size,devices --units B images<br>
 LV LSize Devices <br>
 [lvol0_pmspare] 4294967296B /dev/root/images(0) <br>
 thin-pool 274877906944B thin-pool_tdata(0) <br>
 [thin-pool_tdata] 274877906944B /dev/cache/cachedata(0) <br>
 [thin-pool_tmeta] 4294967296B /dev/root/images(1024)<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#lvcreate -V 64G --thin-pool thin-pool --name test images</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#apt-get install sysstat fio</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#watch 'lvs --rows --reportformat basic --quiet -ocache_dirty_blocks,cache_settings cache/cachedata &amp;&amp; (lvdisplay cache/cachedata | grep Cache) &amp;&amp; (sar -p -d 2 1 | grep -E "sd|nvme|DEV|md1|md2|md3|md0" | grep -v Average | sort)'</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#fio --loops=1 --size=64G --runtime=4 --filename=/dev/images/test --stonewall --ioengine=libaio --direct=1 \<br>
--name=4kQD32read --bs=4k --iodepth=32 --rw=randread \<br>
--name=8kQD32read --bs=8k --iodepth=32 --rw=randread \<br>
--name=16kQD32read --bs=16k --iodepth=32 --rw=randread \<br>
--name=32KQD32read --bs=32k --iodepth=32 --rw=randread \<br>
--name=64KQD32read --bs=64k --iodepth=32 --rw=randread \<br>
--name=128KQD32read --bs=128k --iodepth=32 --rw=randread \<br>
--name=256KQD32read --bs=256k --iodepth=32 --rw=randread \<br>
--name=512KQD32read --bs=512k --iodepth=32 --rw=randread \<br>
--name=4Kread --bs=4k --rw=read \<br>
--name=8Kread --bs=8k --rw=read \<br>
--name=16Kread --bs=16k --rw=read \<br>
--name=32Kread --bs=32k --rw=read \<br>
--name=64Kread --bs=64k --rw=read \<br>
--name=128Kread --bs=128k --rw=read \<br>
--name=256Kread --bs=256k --rw=read \<br>
--name=512Kread --bs=512k --rw=read \<br>
--name=Seqread --bs=1m --rw=read \<br>
--name=Longread --bs=8m --rw=read \<br>
--name=Longwrite --bs=8m --rw=write \<br>
--name=Seqwrite --bs=1m --rw=write \<br>
--name=512Kwrite --bs=512k --rw=write \<br>
--name=256Kwrite --bs=256k --rw=write \<br>
--name=128Kwrite --bs=128k --rw=write \<br>
--name=64Kwrite --bs=64k --rw=write \<br>
--name=32Kwrite --bs=32k --rw=write \<br>
--name=16Kwrite --bs=16k --rw=write \<br>
--name=8Kwrite --bs=8k --rw=write \<br>
--name=4Kwrite --bs=4k --rw=write \<br>
--name=512KQD32write --bs=512k --iodepth=32 --rw=randwrite \<br>
--name=256KQD32write --bs=256k --iodepth=32 --rw=randwrite \<br>
--name=128KQD32write --bs=128k --iodepth=32 --rw=randwrite \<br>
--name=64KQD32write --bs=64k --iodepth=32 --rw=randwrite \<br>
--name=32KQD32write --bs=32k --iodepth=32 --rw=randwrite \<br>
--name=16KQD32write --bs=16k --iodepth=32 --rw=randwrite \<br>
--name=8KQD32write --bs=8k --iodepth=32 --rw=randwrite \<br>
--name=4kQD32write --bs=4k --iodepth=32 --rw=randwrite \<br>
 | grep -E 'read|write|test' | grep -v ioengine<br>
</code><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peringatan! </font><font style="vertical-align: inherit;">Sumber!</font></font></b><div class="spoiler_text">   36  ,       4 .     .  4   NVMe     .  3   .  ,           216   SSD.<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Membaca dan menulis acak?</font></font></b><div class="spoiler_text">.          .  ,   ,    ,        .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasilnya akan sangat bervariasi pada awal pertama dan selanjutnya sebagai cache dan volume tipis terisi, dan juga, tergantung pada apakah sistem berhasil menyinkronkan cache yang diisi pada awal terakhir.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di antara hal-hal lain, saya sarankan mengukur kecepatan pada volume tipis yang sudah terisi dari mana snapshot baru saja dibuat. </font><font style="vertical-align: inherit;">Penulis berkesempatan untuk mengamati bagaimana perekaman acak berakselerasi dengan tajam segera setelah pembuatan foto pertama, terutama ketika cache belum penuh. </font><font style="vertical-align: inherit;">Hal ini disebabkan oleh semantik penulisan-pada-tulis, penjajaran blok cache dan volume yang tipis, dan fakta bahwa penulisan acak ke RAID 6 berubah menjadi pembacaan acak dari RAID 6 dan kemudian menulis ke cache. </font><font style="vertical-align: inherit;">Dalam konfigurasi kami, pembacaan acak dari RAID 6 hingga 6 kali (jumlah SSD SATA dalam array) lebih cepat daripada menulis. </font><font style="vertical-align: inherit;">Karena </font><font style="vertical-align: inherit;">Karena blok KK dialokasikan secara berurutan dari kumpulan yang tipis, sebagian besar catatan juga berubah menjadi sekuensial. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kedua fitur ini dapat digunakan secara menguntungkan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Potret cache "koheren"</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengurangi risiko kehilangan data jika terjadi kerusakan / kehilangan cache, penulis menyarankan untuk memperkenalkan praktik memutar foto untuk menjamin integritasnya dalam kasus ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, karena fakta bahwa metadata volume tipis terletak pada perangkat yang tidak di-cache, metadata akan konsisten dan kemungkinan kerugian akan diisolasi di dalam blok data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Siklus rotasi snapshot berikut menjamin integritas data di dalam snapshot jika terjadi kehilangan cache:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk setiap volume tipis dengan nama &lt;nama&gt;, buat snapshot dengan nama &lt;nama&gt; .cached</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetapkan ambang migrasi ke nilai tinggi yang masuk akal: </font></font><code>#lvchange --quiet --cachesettings "migration_threshold=16384" cache/cachedata</code> </li>
<li>       : <code>#lvs --rows --reportformat basic --quiet -ocache_dirty_blocks cache/cachedata | awk '{print $2}'</code>    .     ,        writethrough . ,      SATA  NVMe SSD,  ,   TBW,            ,           . -          100%    .  NVMe SSD  100%        <b>3-4 </b>. SATA SSD  -    . ,   ,       ,     , —             .</li>
<li>   ( )  —  &lt;&gt;.cached  &lt;&gt;.committed.  &lt;&gt;.committed   .</li>
<li>,     100%,    ,   .         .</li>
<li> migration threshold  : <code>#lvchange --quiet --cachesettings "migration_threshold=0" cache/cachedata</code>        . </li>
<li>,        <code>#lvs --rows --reportformat basic --quiet -ocache_dirty_blocks cache/cachedata | awk '{print $2}'</code>   .</li>
<li> . </li>
</ol><br>
<div class="spoiler"><b class="spoiler_title">   migration threshold...?</b><div class="spoiler_text">   ,     «»       .    -    4 ,   ,         -     (+- 32K) .<br>
<br>
 migration threshold        SATA SSD       64K  .      SATA SSD.<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title">  ..?</b><div class="spoiler_text"> ,         bash     100%    «google»-driven development,  ,    ,      ,     .<br>
<br>
,               , ,  ,      systemd ,     .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Skema rotasi sederhana untuk snapshot akan memungkinkan kita tidak hanya untuk selalu memiliki satu snapshot yang sepenuhnya disinkronkan pada SATA SATA, tetapi juga dengan bantuan utilitas thin_delta untuk mengetahui blok mana yang diubah setelah pembuatannya, dan dengan demikian melokalisasi kerusakan pada volume utama, sehingga lebih mudah untuk mengembalikannya. .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TRIM / DISCARD di libvirt / KVM</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Karena </font><font style="vertical-align: inherit;">Karena data warehouse akan digunakan untuk menjalankan libvirt KVM, alangkah baiknya untuk mengajarkan para VM kami tidak hanya untuk mengambil ruang kosong, tetapi juga membebaskan apa yang tidak lagi diperlukan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini dilakukan dengan meniru dukungan TRIM / DISCARD pada disk virtual. </font><font style="vertical-align: inherit;">Untuk melakukan ini, ubah tipe controller ke virtio-scsi dan edit xml. </font><font style="vertical-align: inherit;">
DISCARD serupa dari OS tamu diproses dengan benar oleh LVM, dan blok-blok dibebaskan dengan benar baik di cache maupun di kumpulan tipis. </font><font style="vertical-align: inherit;">Dalam kasus kami, ini terjadi, terutama, ditunda, ketika Anda menghapus snapshot berikutnya.</font></font><br>
<br>
<code>#virsh edit vmname<br>
&lt;disk type='block' device='disk'&gt;<br>
 &lt;driver name='qemu' type='raw' cache='writethrough' io='threads' <b>discard='unmap'</b>/&gt;<br>
 &lt;source dev='/dev/images/vmname'/&gt;<br>
 &lt;backingStore/&gt;<br>
 &lt;target dev='sda' bus='scsi'/&gt;<br>
 &lt;alias name='scsi0-0-0-0'/&gt;<br>
 &lt;address type='drive' controller='0' bus='0' target='0' unit='0'/&gt;<br>
&lt;/disk&gt;<br>
<br>
&lt;controller type='scsi' index='0' <b>model='virtio-scsi'</b>&gt;<br>
 &lt;alias name='scsi0'/&gt;<br>
 &lt;address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/&gt;<br>
&lt;/controller&gt;<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cadangan BTRFS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gunakan skrip siap pakai dengan </font></font><u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sangat</font></font></b></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hati </font><u><b><font style="vertical-align: inherit;">-</font></b></u><font style="vertical-align: inherit;"> hati dan </font></font><u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan risiko dan risiko Anda sendiri</font></font></b></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Penulis menulis kode ini sendiri dan khusus untuk dirinya sendiri. </font><font style="vertical-align: inherit;">Saya yakin banyak pengguna Linux yang berpengalaman memiliki </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kruk</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pengalaman seperti itu, dan menyalin yang lain tidak perlu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat volume pada perangkat cadangan: </font></font><br>
<br>
<code>#lvcreate -L 256G --name backup backup</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Format dalam BTRFS: </font></font><br>
<br>
<code>#mkfs.btrfs /dev/backup/backup</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat poin mount dan mount subkunci root FS: </font><font style="vertical-align: inherit;">
Buat direktori untuk backup: </font><font style="vertical-align: inherit;">
Buat direktori untuk skrip cadangan: Salin </font><font style="vertical-align: inherit;">
skrip:</font></font><br>
<br>
<code>#mkdir /backup<br>
#mkdir /backup/btrfs<br>
#mkdir /backup/btrfs/root<br>
#mkdir /backup/btrfs/back<br>
#ln -s /boot /backup/btrfs<br>
# cat &gt;&gt;/etc/fstab &lt;&lt; EOF<br>
<br>
/dev/mapper/root-root /backup/btrfs/root btrfs defaults,space_cache,noatime,nodiratime 0 2<br>
/dev/mapper/backup-backup /backup/btrfs/back btrfs defaults,space_cache,noatime,nodiratime 0 2<br>
EOF<br>
#mount -a<br>
#update-initramfs -u<br>
#update-grub<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#mkdir /backup/btrfs/back/remote<br>
#mkdir /backup/btrfs/back/remote/root<br>
#mkdir /backup/btrfs/back/remote/boot<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#mkdir /root/btrfs-backup</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Banyak kode bash yang menakutkan. </font><font style="vertical-align: inherit;">Gunakan dengan risiko Anda sendiri. </font><font style="vertical-align: inherit;">Penulis tidak menulis surat kemarahan ...</font></font></b><div class="spoiler_text"><code>#cat &gt;/root/btrfs-backup/btrfs-backup.sh &lt;&lt; EOF<br>
#!/bin/bash<br>
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"<br>
<br>
SCRIPT_FILE="$(realpath $0)"<br>
SCRIPT_DIR="$(dirname $SCRIPT_FILE)"<br>
SCRIPT_NAME="$(basename -s .sh $SCRIPT_FILE)"<br>
<br>
LOCK_FILE="/dev/shm/$SCRIPT_NAME.lock"<br>
DATE_PREFIX='%Y-%m-%d'<br>
DATE_FORMAT=$DATE_PREFIX'-%H-%M-%S'<br>
DATE_REGEX='[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]'<br>
BASE_SUFFIX=".@base"<br>
PEND_SUFFIX=".@pend"<br>
SNAP_SUFFIX=".@snap"<br>
MOUNTS="/backup/btrfs/"<br>
BACKUPS="/backup/btrfs/back/remote/"<br>
<br>
function terminate ()<br>
{<br>
 echo "$1" &gt;&amp;2<br>
 exit 1<br>
}<br>
<br>
function wait_lock()<br>
{<br>
 flock 98<br>
}<br>
<br>
function wait_lock_or_terminate()<br>
{<br>
 echo "Wating for lock..."<br>
 wait_lock || terminate "Failed to get lock. Exiting..."<br>
 echo "Got lock..."<br>
}<br>
<br>
function suffix()<br>
{<br>
 FORMATTED_DATE=$(date +"$DATE_FORMAT")<br>
 echo "$SNAP_SUFFIX.$FORMATTED_DATE"<br>
}<br>
<br>
function filter()<br>
{<br>
 FORMATTED_DATE=$(date --date="$1" +"$DATE_PREFIX")<br>
 echo "$SNAP_SUFFIX.$FORMATTED_DATE"<br>
}<br>
<br>
function backup()<br>
{<br>
SOURCE_PATH="$MOUNTS$1"<br>
TARGET_PATH="$BACKUPS$1"<br>
SOURCE_BASE_PATH="$MOUNTS$1$BASE_SUFFIX"<br>
TARGET_BASE_PATH="$BACKUPS$1$BASE_SUFFIX"<br>
TARGET_BASE_DIR="$(dirname $TARGET_BASE_PATH)"<br>
SOURCE_PEND_PATH="$MOUNTS$1$PEND_SUFFIX"<br>
TARGET_PEND_PATH="$BACKUPS$1$PEND_SUFFIX"<br>
 if [ -d "$SOURCE_BASE_PATH" ]<br>
 then<br>
 echo "$SOURCE_BASE_PATH found"<br>
 else<br>
 echo "$SOURCE_BASE_PATH File not found creating snapshot of $SOURCE_PATH to $SOURCE_BASE_PATH"<br>
 btrfs subvolume snapshot -r $SOURCE_PATH $SOURCE_BASE_PATH<br>
 sync<br>
 if [ -d "$TARGET_BASE_PATH" ]<br>
 then<br>
 echo "$TARGET_BASE_PATH found out of sync with source... removing..."<br>
 btrfs subvolume delete -c $TARGET_BASE_PATH<br>
 sync<br>
 fi<br>
 fi<br>
 if [ -d "$TARGET_BASE_PATH" ]<br>
 then<br>
 echo "$TARGET_BASE_PATH found"<br>
 else<br>
 echo "$TARGET_BASE_PATH not found. Synching to $TARGET_BASE_DIR"<br>
 btrfs send $SOURCE_BASE_PATH | btrfs receive $TARGET_BASE_DIR<br>
 sync<br>
 fi<br>
 if [ -d "$SOURCE_PEND_PATH" ]<br>
 then<br>
 echo "$SOURCE_PEND_PATH found removing..."<br>
 btrfs subvolume delete -c $SOURCE_PEND_PATH<br>
 sync<br>
 fi<br>
 btrfs subvolume snapshot -r $SOURCE_PATH $SOURCE_PEND_PATH<br>
 sync<br>
 if [ -d "$TARGET_PEND_PATH" ]<br>
 then<br>
 echo "$TARGET_PEND_PATH found removing..."<br>
 btrfs subvolume delete -c $TARGET_PEND_PATH<br>
 sync<br>
 fi<br>
 echo "Sending $SOURCE_PEND_PATH to $TARGET_PEND_PATH"<br>
 btrfs send -p $SOURCE_BASE_PATH $SOURCE_PEND_PATH | btrfs receive $TARGET_BASE_DIR<br>
 sync<br>
 TARGET_DATE_SUFFIX=$(suffix)<br>
 btrfs subvolume snapshot -r $TARGET_PEND_PATH "$TARGET_PATH$TARGET_DATE_SUFFIX"<br>
 sync<br>
 btrfs subvolume delete -c $SOURCE_BASE_PATH<br>
 sync<br>
 btrfs subvolume delete -c $TARGET_BASE_PATH<br>
 sync<br>
 mv $SOURCE_PEND_PATH $SOURCE_BASE_PATH<br>
 mv $TARGET_PEND_PATH $TARGET_BASE_PATH<br>
 sync<br>
}<br>
<br>
function list()<br>
{<br>
LIST_TARGET_BASE_PATH="$BACKUPS$1$BASE_SUFFIX"<br>
LIST_TARGET_BASE_DIR="$(dirname $LIST_TARGET_BASE_PATH)"<br>
LIST_TARGET_BASE_NAME="$(basename -s .$BASE_SUFFIX $LIST_TARGET_BASE_PATH)"<br>
find "$LIST_TARGET_BASE_DIR" -maxdepth 1 -mindepth 1 -type d -printf "%f\n" | grep "${LIST_TARGET_BASE_NAME/$BASE_SUFFIX/$SNAP_SUFFIX}.$DATE_REGEX"<br>
}<br>
<br>
function remove()<br>
{<br>
REMOVE_TARGET_BASE_PATH="$BACKUPS$1$BASE_SUFFIX"<br>
REMOVE_TARGET_BASE_DIR="$(dirname $REMOVE_TARGET_BASE_PATH)"<br>
btrfs subvolume delete -c $REMOVE_TARGET_BASE_DIR/$2<br>
sync<br>
}<br>
<br>
function removeall()<br>
{<br>
DATE_OFFSET="$2"<br>
FILTER="$(filter "$DATE_OFFSET")"<br>
while read -r SNAPSHOT ; do<br>
 remove "$1" "$SNAPSHOT"<br>
done &lt; &lt;(list "$1" | grep "$FILTER")<br>
<br>
}<br>
<br>
(<br>
 COMMAND="$1"<br>
 shift<br>
 <br>
 case "$COMMAND" in<br>
 "--help") <br>
 echo "Help"<br>
 ;;<br>
 "suffix") <br>
 suffix<br>
 ;;<br>
 "filter") <br>
 filter "$1"<br>
 ;;<br>
 "backup") <br>
 wait_lock_or_terminate<br>
 backup "$1"<br>
 ;;<br>
 "list") <br>
 list "$1"<br>
 ;;<br>
 "remove") <br>
 wait_lock_or_terminate<br>
 remove "$1" "$2"<br>
 ;;<br>
 "removeall") <br>
 wait_lock_or_terminate<br>
 removeall "$1" "$2"<br>
 ;;<br>
 *)<br>
 echo "None.."<br>
 ;;<br>
 esac<br>
) 98&gt;$LOCK_FILE <br>
<br>
EOF<br>
</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang bahkan dilakukannya ..?</font></font></b><div class="spoiler_text">       BTRFS        BTRFS send/recieve.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peluncuran pertama bisa relatif lama, karena </font><font style="vertical-align: inherit;">di awal semua data akan disalin. </font><font style="vertical-align: inherit;">Peluncuran lebih lanjut akan sangat cepat, karena </font><font style="vertical-align: inherit;">hanya perubahan yang akan disalin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Script lain untuk menjejalkan ke cron:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beberapa kode bash lagi</font></font></b><div class="spoiler_text"><code>#cat &gt;/root/btrfs-backup/cron-daily.sh &lt;&lt; EOF<br>
#!/bin/bash<br>
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"<br>
<br>
SCRIPT_FILE="$(realpath $0)"<br>
SCRIPT_DIR="$(dirname $SCRIPT_FILE)"<br>
SCRIPT_NAME="$(basename -s .sh $SCRIPT_FILE)"<br>
<br>
BACKUP_SCRIPT="$SCRIPT_DIR/btrfs-backup.sh"<br>
RETENTION="-60 day"<br>
$BACKUP_SCRIPT backup root/@<br>
$BACKUP_SCRIPT removeall root/@ "$RETENTION"<br>
$BACKUP_SCRIPT backup root/@home<br>
$BACKUP_SCRIPT removeall root/@home "$RETENTION"<br>
$BACKUP_SCRIPT backup boot/<br>
$BACKUP_SCRIPT removeall boot/ "$RETENTION"<br>
EOF<br>
</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang sedang dilakukannya ..?</font></font></b><div class="spoiler_text">     backup     BTRFS-.       60  .     /backup/btrfs/back/remote/     . <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari berikan kode yang tepat untuk dieksekusi: </font><font style="vertical-align: inherit;">
Periksa dan masukkan ke dalam mahkota:</font></font><br>
<br>
<code>#chmod +x /root/btrfs-backup/cron-daily.sh<br>
#chmod +x /root/btrfs-backup/btrfs-backup.sh<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#/usr/bin/nice -n 19 /usr/bin/ionice -c 3 /root/btrfs-backup/cron-daily.sh 2&gt;&amp;1 | /usr/bin/logger -t btrfs-backup<br>
#cat /var/log/syslog | grep btrfs-backup<br>
#crontab -e<br>
0 2 * * * /usr/bin/nice -n 19 /usr/bin/ionice -c 3 /root/btrfs-backup/cron-daily.sh 2&gt;&amp;1 | /usr/bin/logger -t btrfs-backup<br>
</code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LVM thin backup</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat kumpulan tipis pada perangkat cadangan: </font></font><br>
<br>
<code>#lvcreate -L 274877906944B --poolmetadataspare y --poolmetadatasize 4294967296B --chunksize 64k -Z y -T backup/thin-pool</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instal ddrescue, karena </font><font style="vertical-align: inherit;">skrip akan menggunakan alat ini: </font></font><br>
<br>
<code>#apt-get install gddrescue</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buat direktori untuk skrip: </font></font><br>
<br>
<code>#mkdir /root/lvm-thin-backup</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salin skrip:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Banyak bash di dalam ...</font></font></b><div class="spoiler_text"><code>#cat &gt;/root/lvm-thin-backup/lvm-thin-backup.sh &lt;&lt; EOF<br>
#!/bin/bash<br>
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"<br>
<br>
SCRIPT_FILE="$(realpath $0)"<br>
SCRIPT_DIR="$(dirname $SCRIPT_FILE)"<br>
SCRIPT_NAME="$(basename -s .sh $SCRIPT_FILE)"<br>
<br>
LOCK_FILE="/dev/shm/$SCRIPT_NAME.lock"<br>
DATE_PREFIX='%Y-%m-%d'<br>
DATE_FORMAT=$DATE_PREFIX'-%H-%M-%S'<br>
DATE_REGEX='[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]-[0-9][0-9]'<br>
BASE_SUFFIX=".base"<br>
PEND_SUFFIX=".pend"<br>
SNAP_SUFFIX=".snap"<br>
BACKUPS="backup"<br>
BACKUPS_POOL="thin-pool"<br>
<br>
export LVM_SUPPRESS_FD_WARNINGS=1<br>
<br>
function terminate ()<br>
{<br>
 echo "$1" &gt;&amp;2<br>
 exit 1<br>
}<br>
<br>
function wait_lock()<br>
{<br>
 flock 98<br>
}<br>
<br>
function wait_lock_or_terminate()<br>
{<br>
 echo "Wating for lock..."<br>
 wait_lock || terminate "Failed to get lock. Exiting..."<br>
 echo "Got lock..."<br>
}<br>
<br>
function suffix()<br>
{<br>
 FORMATTED_DATE=$(date +"$DATE_FORMAT")<br>
 echo "$SNAP_SUFFIX.$FORMATTED_DATE"<br>
}<br>
<br>
function filter()<br>
{<br>
 FORMATTED_DATE=$(date --date="$1" +"$DATE_PREFIX")<br>
 echo "$SNAP_SUFFIX.$FORMATTED_DATE"<br>
}<br>
<br>
function read_thin_id {<br>
lvs --rows --reportformat basic --quiet -othin_id "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function read_pool_lv {<br>
lvs --rows --reportformat basic --quiet -opool_lv "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function read_lv_dm_path {<br>
lvs --rows --reportformat basic --quiet -olv_dm_path "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function read_lv_active {<br>
lvs --rows --reportformat basic --quiet -olv_active "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function read_lv_chunk_size {<br>
lvs --rows --reportformat basic --quiet --units b --nosuffix -ochunk_size "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function read_lv_size {<br>
lvs --rows --reportformat basic --quiet --units b --nosuffix -olv_size "$1/$2" | awk '{print $2}'<br>
}<br>
<br>
function activate_volume {<br>
lvchange -ay -Ky "$1/$2"<br>
}<br>
<br>
function deactivate_volume {<br>
lvchange -an "$1/$2"<br>
}<br>
<br>
function read_thin_metadata_snap {<br>
dmsetup status "$1" | awk '{print $7}'<br>
}<br>
<br>
function thindiff()<br>
{<br>
DIFF_VG="$1"<br>
DIFF_SOURCE="$2"<br>
DIFF_TARGET="$3"<br>
DIFF_SOURCE_POOL=$(read_pool_lv $DIFF_VG $DIFF_SOURCE)<br>
DIFF_TARGET_POOL=$(read_pool_lv $DIFF_VG $DIFF_TARGET)<br>
<br>
if [ "$DIFF_SOURCE_POOL" == "" ]<br>
then<br>
 (&gt;&amp;2 echo "Source LV is not thin.")<br>
 exit 1<br>
fi<br>
<br>
if [ "$DIFF_TARGET_POOL" == "" ]<br>
then<br>
 (&gt;&amp;2 echo "Target LV is not thin.")<br>
 exit 1<br>
fi<br>
<br>
if [ "$DIFF_SOURCE_POOL" != "$DIFF_TARGET_POOL" ]<br>
then<br>
 (&gt;&amp;2 echo "Source and target LVs belong to different thin pools.")<br>
 exit 1<br>
fi<br>
<br>
DIFF_POOL_PATH=$(read_lv_dm_path $DIFF_VG $DIFF_SOURCE_POOL)<br>
DIFF_SOURCE_ID=$(read_thin_id $DIFF_VG $DIFF_SOURCE)<br>
DIFF_TARGET_ID=$(read_thin_id $DIFF_VG $DIFF_TARGET)<br>
DIFF_POOL_PATH_TPOOL="$DIFF_POOL_PATH-tpool"<br>
DIFF_POOL_PATH_TMETA="$DIFF_POOL_PATH"_tmeta<br>
DIFF_POOL_METADATA_SNAP=$(read_thin_metadata_snap $DIFF_POOL_PATH_TPOOL)<br>
<br>
if [ "$DIFF_POOL_METADATA_SNAP" != "-" ]<br>
then<br>
 (&gt;&amp;2 echo "Thin pool metadata snapshot already exist. Assuming stale one. Will release metadata snapshot in 5 seconds.")<br>
 sleep 5<br>
 dmsetup message $DIFF_POOL_PATH_TPOOL 0 release_metadata_snap<br>
fi<br>
<br>
dmsetup message $DIFF_POOL_PATH_TPOOL 0 reserve_metadata_snap<br>
DIFF_POOL_METADATA_SNAP=$(read_thin_metadata_snap $DIFF_POOL_PATH_TPOOL)<br>
<br>
if [ "$DIFF_POOL_METADATA_SNAP" == "-" ]<br>
then<br>
 (&gt;&amp;2 echo "Failed to create thin pool metadata snapshot.")<br>
 exit 1<br>
fi<br>
<br>
#We keep output in variable because metadata snapshot need to be released early.<br>
DIFF_DATA=$(thin_delta -m$DIFF_POOL_METADATA_SNAP --snap1 $DIFF_SOURCE_ID --snap2 $DIFF_TARGET_ID $DIFF_POOL_PATH_TMETA)<br>
<br>
dmsetup message $DIFF_POOL_PATH_TPOOL 0 release_metadata_snap<br>
<br>
echo $"$DIFF_DATA" | grep -E 'different|left_only|right_only' | sed 's/&lt;/"/g' | sed 's/ /"/g' | awk -F'\"' '{print $6 "\t" $8 "\t" $11}' | sed 's/different/copy/g' | sed 's/left_only/copy/g' | sed 's/right_only/discard/g'<br>
<br>
}<br>
<br>
function thinsync()<br>
{<br>
SYNC_VG="$1"<br>
SYNC_PEND="$2"<br>
SYNC_BASE="$3"<br>
SYNC_TARGET="$4"<br>
SYNC_PEND_POOL=$(read_pool_lv $SYNC_VG $SYNC_PEND)<br>
SYNC_BLOCK_SIZE=$(read_lv_chunk_size $SYNC_VG $SYNC_PEND_POOL)<br>
SYNC_PEND_PATH=$(read_lv_dm_path $SYNC_VG $SYNC_PEND)<br>
<br>
activate_volume $SYNC_VG $SYNC_PEND<br>
<br>
while read -r SYNC_ACTION SYNC_OFFSET SYNC_LENGTH ; do<br>
 SYNC_OFFSET_BYTES=$((SYNC_OFFSET * SYNC_BLOCK_SIZE))<br>
 SYNC_LENGTH_BYTES=$((SYNC_LENGTH * SYNC_BLOCK_SIZE))<br>
 if [ "$SYNC_ACTION" == "copy" ]<br>
 then<br>
 ddrescue --quiet --force --input-position=$SYNC_OFFSET_BYTES --output-position=$SYNC_OFFSET_BYTES --size=$SYNC_LENGTH_BYTES "$SYNC_PEND_PATH" "$SYNC_TARGET"<br>
 fi<br>
<br>
if [ "$SYNC_ACTION" == "discard" ]<br>
 then<br>
 blkdiscard -o $SYNC_OFFSET_BYTES -l $SYNC_LENGTH_BYTES "$SYNC_TARGET"<br>
 fi<br>
done &lt; &lt;(thindiff "$SYNC_VG" "$SYNC_PEND" "$SYNC_BASE")<br>
}<br>
<br>
function discard_volume()<br>
{<br>
DISCARD_VG="$1"<br>
DISCARD_LV="$2"<br>
DISCARD_LV_PATH=$(read_lv_dm_path "$DISCARD_VG" "$DISCARD_LV")<br>
if [ "$DISCARD_LV_PATH" != "" ]<br>
then<br>
 echo "$DISCARD_LV_PATH found"<br>
else<br>
 echo "$DISCARD_LV not found in $DISCARD_VG"<br>
 exit 1<br>
fi<br>
DISCARD_LV_POOL=$(read_pool_lv $DISCARD_VG $DISCARD_LV)<br>
DISCARD_LV_SIZE=$(read_lv_size "$DISCARD_VG" "$DISCARD_LV")<br>
lvremove -y --quiet "$DISCARD_LV_PATH" || exit 1<br>
lvcreate --thin-pool "$DISCARD_LV_POOL" -V "$DISCARD_LV_SIZE"B --name "$DISCARD_LV" "$DISCARD_VG" || exit 1<br>
}<br>
<br>
function backup()<br>
{<br>
SOURCE_VG="$1"<br>
SOURCE_LV="$2"<br>
TARGET_VG="$BACKUPS"<br>
TARGET_LV="$SOURCE_VG-$SOURCE_LV"<br>
SOURCE_BASE_LV="$SOURCE_LV$BASE_SUFFIX"<br>
TARGET_BASE_LV="$TARGET_LV$BASE_SUFFIX"<br>
SOURCE_PEND_LV="$SOURCE_LV$PEND_SUFFIX"<br>
TARGET_PEND_LV="$TARGET_LV$PEND_SUFFIX"<br>
SOURCE_BASE_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_BASE_LV")<br>
SOURCE_PEND_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_PEND_LV")<br>
TARGET_BASE_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_BASE_LV")<br>
TARGET_PEND_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_PEND_LV")<br>
<br>
if [ "$SOURCE_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$SOURCE_BASE_LV_PATH found"<br>
 else<br>
 echo "Source base not found creating snapshot of $SOURCE_VG/$SOURCE_LV to $SOURCE_VG/$SOURCE_BASE_LV"<br>
 lvcreate --quiet --snapshot --name "$SOURCE_BASE_LV" "$SOURCE_VG/$SOURCE_LV" || exit 1<br>
 SOURCE_BASE_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_BASE_LV")<br>
 activate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 echo "Discarding $SOURCE_BASE_LV_PATH as we need to bootstrap."<br>
 SOURCE_BASE_POOL=$(read_pool_lv $SOURCE_VG $SOURCE_BASE_LV)<br>
 SOURCE_BASE_CHUNK_SIZE=$(read_lv_chunk_size $SOURCE_VG $SOURCE_BASE_POOL)<br>
 discard_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 sync<br>
 if [ "$TARGET_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$TARGET_BASE_LV_PATH found out of sync with source... removing..."<br>
 lvremove -y --quiet $TARGET_BASE_LV_PATH || exit 1<br>
 TARGET_BASE_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_BASE_LV")<br>
 sync<br>
 fi<br>
 fi<br>
SOURCE_BASE_SIZE=$(read_lv_size "$SOURCE_VG" "$SOURCE_BASE_LV")<br>
 if [ "$TARGET_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$TARGET_BASE_LV_PATH found"<br>
 else<br>
 echo "$TARGET_VG/$TARGET_LV not found. Creating empty volume."<br>
 lvcreate --thin-pool "$BACKUPS_POOL" -V "$SOURCE_BASE_SIZE"B --name "$TARGET_BASE_LV" "$TARGET_VG" || exit 1<br>
 echo "Have to rebootstrap. Discarding source at $SOURCE_BASE_LV_PATH"<br>
 activate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 SOURCE_BASE_POOL=$(read_pool_lv $SOURCE_VG $SOURCE_BASE_LV)<br>
 SOURCE_BASE_CHUNK_SIZE=$(read_lv_chunk_size $SOURCE_VG $SOURCE_BASE_POOL)<br>
 discard_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 TARGET_BASE_POOL=$(read_pool_lv $TARGET_VG $TARGET_BASE_LV)<br>
 TARGET_BASE_CHUNK_SIZE=$(read_lv_chunk_size $TARGET_VG $TARGET_BASE_POOL)<br>
 TARGET_BASE_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_BASE_LV")<br>
 echo "Discarding target at $TARGET_BASE_LV_PATH"<br>
 discard_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 sync<br>
 fi<br>
 if [ "$SOURCE_PEND_LV_PATH" != "" ]<br>
 then<br>
 echo "$SOURCE_PEND_LV_PATH found removing..."<br>
 lvremove -y --quiet "$SOURCE_PEND_LV_PATH" || exit 1<br>
 sync<br>
 fi<br>
 lvcreate --quiet --snapshot --name "$SOURCE_PEND_LV" "$SOURCE_VG/$SOURCE_LV" || exit 1<br>
SOURCE_PEND_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_PEND_LV")<br>
 sync<br>
 if [ "$TARGET_PEND_LV_PATH" != "" ]<br>
 then<br>
 echo "$TARGET_PEND_LV_PATH found removing..."<br>
 lvremove -y --quiet $TARGET_PEND_LV_PATH<br>
 sync<br>
 fi<br>
 lvcreate --quiet --snapshot --name "$TARGET_PEND_LV" "$TARGET_VG/$TARGET_BASE_LV" || exit 1<br>
TARGET_PEND_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_PEND_LV")<br>
SOURCE_PEND_LV_SIZE=$(read_lv_size "$SOURCE_VG" "$SOURCE_PEND_LV")<br>
 lvresize -L "$SOURCE_PEND_LV_SIZE"B "$TARGET_PEND_LV_PATH"<br>
 activate_volume "$TARGET_VG" "$TARGET_PEND_LV"<br>
 echo "Synching $SOURCE_PEND_LV_PATH to $TARGET_PEND_LV_PATH"<br>
 thinsync "$SOURCE_VG" "$SOURCE_PEND_LV" "$SOURCE_BASE_LV" "$TARGET_PEND_LV_PATH" || exit 1<br>
 sync<br>
<br>
TARGET_DATE_SUFFIX=$(suffix)<br>
 lvcreate --quiet --snapshot --name "$TARGET_LV$TARGET_DATE_SUFFIX" "$TARGET_VG/$TARGET_PEND_LV" || exit 1<br>
 sync<br>
 lvremove --quiet -y "$SOURCE_BASE_LV_PATH" || exit 1<br>
 sync<br>
 lvremove --quiet -y "$TARGET_BASE_LV_PATH" || exit 1<br>
 sync<br>
 lvrename -y "$SOURCE_VG/$SOURCE_PEND_LV" "$SOURCE_BASE_LV" || exit 1<br>
 lvrename -y "$TARGET_VG/$TARGET_PEND_LV" "$TARGET_BASE_LV" || exit 1<br>
 sync<br>
 deactivate_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 deactivate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
}<br>
<br>
function verify()<br>
{<br>
SOURCE_VG="$1"<br>
SOURCE_LV="$2"<br>
TARGET_VG="$BACKUPS"<br>
TARGET_LV="$SOURCE_VG-$SOURCE_LV"<br>
SOURCE_BASE_LV="$SOURCE_LV$BASE_SUFFIX"<br>
TARGET_BASE_LV="$TARGET_LV$BASE_SUFFIX"<br>
TARGET_BASE_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_BASE_LV")<br>
SOURCE_BASE_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_BASE_LV")<br>
<br>
if [ "$SOURCE_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$SOURCE_BASE_LV_PATH found"<br>
 else<br>
 echo "$SOURCE_BASE_LV_PATH not found"<br>
 exit 1<br>
 fi<br>
 if [ "$TARGET_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$TARGET_BASE_LV_PATH found"<br>
 else<br>
 echo "$TARGET_BASE_LV_PATH not found"<br>
 exit 1<br>
 fi<br>
 activate_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 activate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 echo Comparing "$SOURCE_BASE_LV_PATH" with "$TARGET_BASE_LV_PATH"<br>
 cmp "$SOURCE_BASE_LV_PATH" "$TARGET_BASE_LV_PATH"<br>
 echo Done...<br>
 deactivate_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 deactivate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
}<br>
<br>
function resync()<br>
{<br>
SOURCE_VG="$1"<br>
SOURCE_LV="$2"<br>
TARGET_VG="$BACKUPS"<br>
TARGET_LV="$SOURCE_VG-$SOURCE_LV"<br>
SOURCE_BASE_LV="$SOURCE_LV$BASE_SUFFIX"<br>
TARGET_BASE_LV="$TARGET_LV$BASE_SUFFIX"<br>
TARGET_BASE_LV_PATH=$(read_lv_dm_path "$TARGET_VG" "$TARGET_BASE_LV")<br>
SOURCE_BASE_LV_PATH=$(read_lv_dm_path "$SOURCE_VG" "$SOURCE_BASE_LV")<br>
<br>
if [ "$SOURCE_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$SOURCE_BASE_LV_PATH found"<br>
 else<br>
 echo "$SOURCE_BASE_LV_PATH not found"<br>
 exit 1<br>
 fi<br>
 if [ "$TARGET_BASE_LV_PATH" != "" ]<br>
 then<br>
 echo "$TARGET_BASE_LV_PATH found"<br>
 else<br>
 echo "$TARGET_BASE_LV_PATH not found"<br>
 exit 1<br>
 fi<br>
 activate_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 activate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
 SOURCE_BASE_POOL=$(read_pool_lv $SOURCE_VG $SOURCE_BASE_LV)<br>
 SYNC_BLOCK_SIZE=$(read_lv_chunk_size $SOURCE_VG $SOURCE_BASE_POOL)<br>
<br>
echo Syncronizing "$SOURCE_BASE_LV_PATH" to "$TARGET_BASE_LV_PATH"<br>
<br>
CMP_OFFSET=0<br>
 while [[ "$CMP_OFFSET" != "" ]] ; do<br>
 CMP_MISMATCH=$(cmp -i "$CMP_OFFSET" "$SOURCE_BASE_LV_PATH" "$TARGET_BASE_LV_PATH" | grep differ | awk '{print $5}' | sed 's/,//g' )<br>
 if [[ "$CMP_MISMATCH" != "" ]] ; then<br>
 CMP_OFFSET=$(( CMP_MISMATCH + CMP_OFFSET ))<br>
 SYNC_OFFSET_BYTES=$(( ( CMP_OFFSET / SYNC_BLOCK_SIZE ) * SYNC_BLOCK_SIZE ))<br>
 SYNC_LENGTH_BYTES=$(( SYNC_BLOCK_SIZE ))<br>
 echo "Synching $SYNC_LENGTH_BYTES bytes at $SYNC_OFFSET_BYTES from $SOURCE_BASE_LV_PATH to $TARGET_BASE_LV_PATH"<br>
 ddrescue --quiet --force --input-position=$SYNC_OFFSET_BYTES --output-position=$SYNC_OFFSET_BYTES --size=$SYNC_LENGTH_BYTES "$SOURCE_BASE_LV_PATH" "$TARGET_BASE_LV_PATH"<br>
 else<br>
 CMP_OFFSET=""<br>
 fi<br>
 done<br>
 echo Done...<br>
 deactivate_volume "$TARGET_VG" "$TARGET_BASE_LV"<br>
 deactivate_volume "$SOURCE_VG" "$SOURCE_BASE_LV"<br>
}<br>
<br>
function list()<br>
{<br>
LIST_SOURCE_VG="$1"<br>
LIST_SOURCE_LV="$2"<br>
LIST_TARGET_VG="$BACKUPS"<br>
LIST_TARGET_LV="$LIST_SOURCE_VG-$LIST_SOURCE_LV"<br>
LIST_TARGET_BASE_LV="$LIST_TARGET_LV$SNAP_SUFFIX"<br>
lvs -olv_name | grep "$LIST_TARGET_BASE_LV.$DATE_REGEX"<br>
}<br>
<br>
function remove()<br>
{<br>
REMOVE_TARGET_VG="$BACKUPS"<br>
REMOVE_TARGET_LV="$1"<br>
lvremove -y "$REMOVE_TARGET_VG/$REMOVE_TARGET_LV"<br>
sync<br>
}<br>
<br>
function removeall()<br>
{<br>
DATE_OFFSET="$3"<br>
FILTER="$(filter "$DATE_OFFSET")"<br>
while read -r SNAPSHOT ; do<br>
 remove "$SNAPSHOT"<br>
done &lt; &lt;(list "$1" "$2" | grep "$FILTER")<br>
<br>
}<br>
<br>
(<br>
 COMMAND="$1"<br>
 shift<br>
 <br>
 case "$COMMAND" in<br>
 "--help") <br>
 echo "Help"<br>
 ;;<br>
 "suffix") <br>
 suffix<br>
 ;;<br>
 "filter") <br>
 filter "$1"<br>
 ;;<br>
 "backup") <br>
 wait_lock_or_terminate<br>
 backup "$1" "$2"<br>
 ;;<br>
 "list") <br>
 list "$1" "$2"<br>
 ;;<br>
 "thindiff") <br>
 thindiff "$1" "$2" "$3"<br>
 ;;<br>
 "thinsync") <br>
 thinsync "$1" "$2" "$3" "$4"<br>
 ;;<br>
 "verify") <br>
 wait_lock_or_terminate<br>
 verify "$1" "$2"<br>
 ;;<br>
 "resync") <br>
 wait_lock_or_terminate<br>
 resync "$1" "$2"<br>
 ;;<br>
 "remove") <br>
 wait_lock_or_terminate<br>
 remove "$1"<br>
 ;;<br>
 "removeall") <br>
 wait_lock_or_terminate<br>
 removeall "$1" "$2" "$3"<br>
 ;;<br>
 *)<br>
 echo "None.."<br>
 ;;<br>
 esac<br>
) 98&gt;$LOCK_FILE <br>
<br>
EOF<br>
</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang dilakukannya ...?</font></font></b><div class="spoiler_text">             ,   thin_delta,       ddrescue  blkdiscard.<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Skrip lain yang akan kami jadikan mahkota:</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bash lagi</font></font></b><div class="spoiler_text"><code>#cat &gt;/root/lvm-thin-backup/cron-daily.sh &lt;&lt; EOF<br>
#!/bin/bash<br>
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"<br>
<br>
SCRIPT_FILE="$(realpath $0)"<br>
SCRIPT_DIR="$(dirname $SCRIPT_FILE)"<br>
SCRIPT_NAME="$(basename -s .sh $SCRIPT_FILE)"<br>
<br>
BACKUP_SCRIPT="$SCRIPT_DIR/lvm-thin-backup.sh"<br>
RETENTION="-60 days"<br>
<br>
$BACKUP_SCRIPT backup images linux-dev<br>
$BACKUP_SCRIPT backup images win8<br>
$BACKUP_SCRIPT backup images win8-data<br>
#etc<br>
<br>
$BACKUP_SCRIPT removeall images linux-dev "$RETENTION"<br>
$BACKUP_SCRIPT removeall images win8 "$RETENTION"<br>
$BACKUP_SCRIPT removeall images win8-data "$RETENTION"<br>
#etc<br>
<br>
EOF<br>
</code><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apa yang dilakukannya ...?</font></font></b><div class="spoiler_text">  ,         .      ,        .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Skrip ini perlu diedit, yang menunjukkan daftar volume tipis yang memerlukan cadangan. </font><font style="vertical-align: inherit;">Nama-nama yang diberikan hanya untuk tujuan ilustrasi. </font><font style="vertical-align: inherit;">Jika mau, Anda dapat menulis skrip yang akan menyinkronkan semua volume. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita beri hak: </font><font style="vertical-align: inherit;">
Periksa dan masukkan ke dalam mahkota: </font><font style="vertical-align: inherit;">
Peluncuran pertama akan lama, karena </font><font style="vertical-align: inherit;">volume tipis akan sepenuhnya disinkronkan dengan menyalin seluruh ruang yang digunakan. </font><font style="vertical-align: inherit;">Berkat metadata tipis LVM, kami tahu blok mana yang benar-benar digunakan, jadi hanya blok volume yang benar-benar digunakan yang akan disalin. </font><font style="vertical-align: inherit;">
Peluncuran selanjutnya akan menyalin data secara bertahap dengan melacak perubahan melalui metadata tipis LVM.</font></font><br>
<br>
<code>#chmod +x /root/lvm-thin-backup/cron-daily.sh<br>
#chmod +x /root/lvm-thin-backup/lvm-thin-backup.sh</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>#/usr/bin/nice -n 19 /usr/bin/ionice -c 3 /root/lvm-thin-backup/cron-daily.sh 2&gt;&amp;1 | /usr/bin/logger -t lvm-thin-backup<br>
#cat /var/log/syslog | grep lvm-thin-backup<br>
#crontab -e<br>
0 3 * * * /usr/bin/nice -n 19 /usr/bin/ionice -c 3 /root/lvm-thin-backup/cron-daily.sh 2&gt;&amp;1 | /usr/bin/logger -t lvm-thin-backup<br>
</code><br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mari kita lihat apa yang terjadi:</font></font></h3><br>
<code>#time /root/btrfs-backup/cron-daily.sh<br>
real 0m2,967s<br>
user 0m0,225s<br>
sys 0m0,353s<br>
<br>
#time /root/lvm-thin-backup/cron-daily.sh<br>
real 1m2,710s<br>
user 0m12,721s<br>
sys 0m6,671s<br>
<br>
#ls -al /backup/btrfs/back/remote/*<br>
/backup/btrfs/back/remote/boot:<br>
total 0<br>
drwxr-xr-x 1 root root 1260  26 09:11 .<br>
drwxr-xr-x 1 root root 16  6 09:30 ..<br>
drwxr-xr-x 1 root root 322  26 02:00 .@base<br>
drwxr-xr-x 1 root root 516  6 09:39 .@snap.2020-03-06-09-39-37<br>
drwxr-xr-x 1 root root 516  6 09:39 .@snap.2020-03-06-09-39-57<br>
...<br>
/backup/btrfs/back/remote/root:<br>
total 0<br>
drwxr-xr-x 1 root root 2820  26 09:11 .<br>
drwxr-xr-x 1 root root 16  6 09:30 ..<br>
drwxr-xr-x 1 root root 240  26 09:11 @.@base<br>
drwxr-xr-x 1 root root 22  26 09:11 @home.@base<br>
drwxr-xr-x 1 root root 22  6 09:39 @home.@snap.2020-03-06-09-39-35<br>
drwxr-xr-x 1 root root 22  6 09:39 @home.@snap.2020-03-06-09-39-57<br>
...<br>
drwxr-xr-x 1 root root 240  6 09:39 @.@snap.2020-03-06-09-39-26<br>
drwxr-xr-x 1 root root 240  6 09:39 @.@snap.2020-03-06-09-39-56<br>
...<br>
<br>
#lvs -olv_name,lv_size images &amp;&amp; lvs -olv_name,lv_size backup<br>
 LV LSize <br>
 linux-dev 128,00g<br>
 linux-dev.base 128,00g<br>
 thin-pool 1,38t<br>
 win8 128,00g<br>
 win8-data 2,00t<br>
 win8-data.base 2,00t<br>
 win8.base 128,00g<br>
 LV LSize <br>
 backup 256,00g<br>
 images-linux-dev.base 128,00g<br>
 images-linux-dev.snap.2020-03-08-10-09-11 128,00g<br>
 images-linux-dev.snap.2020-03-08-10-09-25 128,00g<br>
...<br>
 images-win8-data.base 2,00t<br>
 images-win8-data.snap.2020-03-16-14-11-55 2,00t<br>
 images-win8-data.snap.2020-03-16-14-19-50 2,00t<br>
...<br>
 images-win8.base 128,00g<br>
 images-win8.snap.2020-03-17-04-51-46 128,00g<br>
 images-win8.snap.2020-03-18-03-02-49 128,00g<br>
...<br>
 thin-pool &lt;2,09t<br>
</code><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan bagaimana dengan boneka bersarang?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemungkinan besar, meskipun volume logis LVM LV dapat volume LVM fisik untuk VG lainnya. </font><font style="vertical-align: inherit;">LVM bisa bersifat rekursif, seperti boneka bersarang. </font><font style="vertical-align: inherit;">Ini memberikan fleksibilitas ekstrim LVM.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada artikel berikutnya, kami akan mencoba menggunakan beberapa sistem penyimpanan seluler / KVM yang serupa sebagai dasar untuk membuat cluster penyimpanan / vm yang didistribusikan secara geo dengan redundansi di beberapa benua melalui desktop rumah, internet di rumah, dan jaringan P2P.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id492820/index.html">.Net Core Api: mendapatkan data dalam permintaan dari berbagai sumber</a></li>
<li><a href="../id492822/index.html">Pengembang CSS - mengapa dunia membutuhkannya?</a></li>
<li><a href="../id492828/index.html">Cara bertahan hidup di dunia yang terkunci</a></li>
<li><a href="../id492830/index.html">SameSite = Lax secara default - sudah ada di Chrome 80 stable (meskipun belum untuk semua orang)</a></li>
<li><a href="../id492832/index.html">IoT-gateway untuk protokol industri berdasarkan i.MX6 dan Linux</a></li>
<li><a href="../id492838/index.html">Hubungkan M5Stack ke TV</a></li>
<li><a href="../id492844/index.html">Cara memvisualisasikan dan menghidupkan model (geofisika). Animasi 3D dan visualisasi data 4D</a></li>
<li><a href="../id492850/index.html">Tidak semua orang ingin beralih ke pekerjaan jarak jauh</a></li>
<li><a href="../id492856/index.html">Covid19, Masyarakat Anda dan Anda dari sudut pandang Ilmu Data. Artikel yang diterjemahkan oleh Jeremy Howard dan Rachel Thomas (fast.ai)</a></li>
<li><a href="../id492862/index.html">15 tips penyempurnaan kinerja Oracle APEX terbaik untuk pengembang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>