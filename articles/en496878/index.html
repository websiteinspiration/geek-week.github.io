<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§üüèª üë©üèæ‚Äçüíª üíÇ Enemy AI: chasing a player without Navigation2D and finding the path A * ‚¨ÜÔ∏è ü§ûüèª üßòüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Creating a game in which enemies must chase a player? It all starts with a simple one - we make the enemy run to the player. But what happens if it is...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Enemy AI: chasing a player without Navigation2D and finding the path A *</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496878/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a game in which enemies must chase a player? </font><font style="vertical-align: inherit;">It all starts with a simple one - we make the enemy run to the player. </font><font style="vertical-align: inherit;">But what happens if it is behind a tree, or around the corner of a wall? </font><font style="vertical-align: inherit;">Well, now the enemy will look pretty stupid - he will run into an object, fingering in place. </font><font style="vertical-align: inherit;">Not very good! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve this problem, you can use the Navigation2D or AStar nodes built into Godot ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here is the GDQuest tutorial on both nodes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">But in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helms of Fury,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we used a different method that worked great for our game, and we want to share it in this tutorial. </font><font style="vertical-align: inherit;">Here's what it looks like:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2d/ub/ss/2dubss3iyd2rns37pn9pzrjjybk.gif"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getting to work</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We assume that you create enemies as KinematicBody2D objects and use a state machine to control their states. </font><font style="vertical-align: inherit;">Not sure what a state machine is? </font><font style="vertical-align: inherit;">I like </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article explaining state machines</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and how to use them. </font><font style="vertical-align: inherit;">Here is another </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article about implementing simple state machines in Godot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with a simple Chase state for a stupid enemy who just runs to his target and gets stuck somewhere along the way:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># ChaseState.gd</span><font></font>
<font></font>
func _init(enemy, params):<font></font>
  enemy.dir = (enemy.target.position - enemy.position).normalized()<font></font>
<font></font>
func _physics_process(delta):<font></font>
  var motion = enemy.dir * enemy.speed<font></font>
  enemy.move_and_slide(motion)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traces of smell</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To improve the state, we will force the player to leave a trace from his previous positions when moving. </font><font style="vertical-align: inherit;">Thanks to this, when the enemy does not see the player, he will check to see if any of his past positions can be seen, and then follow them to the player. </font><font style="vertical-align: inherit;">Since this is similar to how a dog takes a footprint, we will call it a smell footprint. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the smell trace to work, we need to add the Timer node to the player, enable it to automatically start and set wait_time (we used 0.1s), and then add the code so that the player leaves a smell when the countdown ends.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># Player.gd</span><font></font>
extends KinematicBody2D<font></font>
<font></font>
const scent_scene = preload(<span class="hljs-string">"res://Player/Scent.tscn"</span>)<font></font>
<font></font>
var scent_trail = []<font></font>
<font></font>
func _ready():<font></font>
  $ScentTimer.connect(<span class="hljs-string">"timeout"</span>, self, <span class="hljs-string">"add_scent"</span>)<font></font>
<font></font>
func add_scent():<font></font>
  var scent      = scent_scene.instance()<font></font>
  scent.player   = player<font></font>
  scent.position = player.position<font></font>
<font></font>
  Game.level.effects.add_child(scent)<font></font>
  scent_trail.push_front(scent)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then you need to add the abandoned Scent.tscn itself. </font><font style="vertical-align: inherit;">This is a simple Node2D scene containing a Timer so that the odor expires.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># Player.gd</span><font></font>
extends KinematicBody2D<font></font>
<font></font>
const scent_scene = preload(<span class="hljs-string">"res://Player/Scent.tscn"</span>)<font></font>
<font></font>
var scent_trail = []<font></font>
<font></font>
func _ready():<font></font>
  $ScentTimer.connect(<span class="hljs-string">"timeout"</span>, self, <span class="hljs-string">"add_scent"</span>)<font></font>
<font></font>
func add_scent():<font></font>
  var scent      = scent_scene.instance()<font></font>
  scent.player   = player<font></font>
  scent.position = player.position<font></font>
<font></font>
  Game.level.effects.add_child(scent)<font></font>
  scent_trail.push_front(scent)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want odors to be visible during debugging, you can add a ColorRect node to them, and then just hide it. </font><font style="vertical-align: inherit;">Having done this, you will see that when running after the player there is a trace of smell. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we need to awaken the enemies of the internal bloodhounds so that they follow these new smells when they do not see the player. </font><font style="vertical-align: inherit;">But for this we need to add RayCast2D nodes to the enemies, and set up Physics Layers in Godot so that the beam knows what it can do collisions with.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Physics Layers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To set up Physics Layers in Godot, you need to click on Project in the top menu and then on Project Settings, then go to the Layer Names section in the lower left corner, and then select 2D Physics.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://s3.amazonaws.com/manakeep/users/58991d6d3c545a24383fe280/2020-04-06/physics_layers.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Give them any suitable name. </font><font style="vertical-align: inherit;">After that, go to the objects in the game and expand Collision in the Property Inspector sidebar, and then click ¬∑¬∑ to assign them. </font><font style="vertical-align: inherit;">For objects, they must be assigned as Layers.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://s3.amazonaws.com/manakeep/users/58991d6d3c545a24383fe280/2020-04-06/picking_physics_layers.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After assigning the Physics Layers to objects, you need to change the RayCast2D of the enemies so that it checks those layers through which the enemies cannot move (in our case, this is solid, object, crate, hole, gate_closed). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After setting up Physics Layers, the final step is to change the state of the Chase.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># ChaseState.gd</span><font></font>
<font></font>
func _init(enemy, params):<font></font>
  chase_target()<font></font>
<font></font>
func chase_target():<font></font>
  var look     = enemy.get_node(<span class="hljs-string">"RayCast2D"</span>)<font></font>
  look.cast_to = (enemy.target.position - enemy.position)<font></font>
  look.force_raycast_update()<font></font>
<font></font>
  <span class="hljs-comment"># if we can see the target, chase it</span>
  <span class="hljs-keyword">if</span> !look.is_colliding():<font></font>
    enemy.dir = look.cast_to.normalized()<font></font>
<font></font>
  <span class="hljs-comment"># or chase first scent we can see</span>
  <span class="hljs-keyword">else</span>:
    <span class="hljs-keyword">for</span> scent <span class="hljs-keyword">in</span> enemy.target.scent_trail:<font></font>
      look.cast_to = (scent.position - enemy.position)<font></font>
      look.force_raycast_update()<font></font>
<font></font>
      <span class="hljs-keyword">if</span> !look.is_colliding():<font></font>
        enemy.dir = look.cast_to.normalized()<font></font>
        <span class="hljs-keyword">break</span><font></font>
<font></font>
func _physics_process(delta):<font></font>
  var motion = enemy.dir * enemy.speed<font></font>
  enemy.move_and_slide(motion)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, when the enemy enters the Chase state, he begins to try to re-cast the player, and if there is nothing in his way, he will follow him! </font><font style="vertical-align: inherit;">If there is something on the way, then he goes to the traces of smell and tries to re-cast each of them until he finds one of them, and then - pursues him!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://s3.amazonaws.com/manakeep/users/58991d6d3c545a24383fe280/2020-04-06/twitter-700x400.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now everything works, the enemies turned into bloodhounds. </font><font style="vertical-align: inherit;">To improve the system, it is possible to implement a system of avoiding collisions between enemies, but this is a topic for a separate article.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496868/index.html">Small Space Symphony</a></li>
<li><a href="../en496870/index.html">Android declarative programming of client-server applications</a></li>
<li><a href="../en496872/index.html">New Hyperledger Fabric: Go SDK Software Model</a></li>
<li><a href="../en496874/index.html">We study the Mediastreamer2 VoIP engine. Part 9</a></li>
<li><a href="../en496876/index.html">The digest of fresh materials from the world of the front-end for the last week No. 410 (April 6 - 12, 2020)</a></li>
<li><a href="../en496880/index.html">VDI Skala-R BPM. What is it and where did it come from</a></li>
<li><a href="../en496882/index.html">How to start using USB Type-C in your designs</a></li>
<li><a href="../en496884/index.html">Theory of ‚Äúg-groups‚Äù</a></li>
<li><a href="../en496886/index.html">Elon Musk revealed the purpose of the camera over the rearview mirror in Tesla Model 3</a></li>
<li><a href="../en496888/index.html">Startup uses AI to search for molecules that will help fight coronavirus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>