<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ô®Ô∏è üç© üëçüèΩ Routing in complex chatbots with the Hobot framework üò∏ üè° üï∫üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Having started developing bots for Telegram a few years ago, I discovered the performance, simplicity and flexibility of working with them as a specia...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Routing in complex chatbots with the Hobot framework</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/actualizebot/blog/489008/"><img src="https://habrastorage.org/webt/op/j7/ip/opj7ipookzxpfhtdfi1x_8cln2w.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having started developing bots for Telegram a few years ago, I discovered the performance, simplicity and flexibility of working with them as a special case of the command line interface. </font><font style="vertical-align: inherit;">These features, available to many today, are largely due to the popular framework telegraf.js and the like, which provide simplified methods for working with the Telegram API. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, the architecture of the project lies entirely on the shoulders of the developer, and judging by the modest number of complex and multifunctional bots, we still have room to grow in this regard. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article I want to talk about a small chatbot routing framework, without which the development of our project would be impossible.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some basic information</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In chatbots and CLIs, the execution of a single logical action often consists of several refinement steps or branching steps. This requires the program to store a certain coordinate in order to remember where in the flow the user is located and execute his command in accordance with this coordinate. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The simplest illustration is the execution of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">npm init</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><font style="vertical-align: inherit;">, during which the program asks you to specify one or another data for package.json in turn. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the first step, she tells the user that she is waiting for text input of the package name - and what the user sends her with the next command will be saved as the package name thanks to the variable in which this wait is written.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We call this variable path - the path to which this or that code is logically attached. </font><font style="vertical-align: inherit;">It is always needed if the bot has navigation or commands issued in a few steps.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Today's practice in bot architecture</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The approach that I initially looked at from other developers looked like this: for any update coming from the user, a list of checks for a particular value of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">path</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable is written </font><font style="vertical-align: inherit;">and business logic and further navigation are placed inside these checks in the most elementary form:</font></font><br>
<br>
<pre><code class="javascript hljs">onUserInput(ctx, input) {
    <span class="hljs-keyword">switch</span>(ctx.session.path) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'firstPath'</span>:
	    <span class="hljs-keyword">if</span> (input === <span class="hljs-string">'!'</span>) {
               <span class="hljs-comment">// -  </span>
	        ctx.reply(<span class="hljs-string">'!'</span>);<font></font>
	        ctx.session.path = <span class="hljs-string">'secondPath'</span>;<font></font>
	    } <span class="hljs-keyword">else</span> {<font></font>
	        ctx.reply(<span class="hljs-string">' "!"'</span>);<font></font>
	    }<font></font>
	    <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'...'</span>:
       	    <span class="hljs-comment">//   </span><font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have only a couple of teams and a couple of steps for each team, this solution is optimal. </font><font style="vertical-align: inherit;">Getting to the third team and the seventh if you start to think that something is going wrong. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In one of the bots that we had a chance to work with at a late stage, the core of the functional was a sheet of 4000 lines and ~ 70 conditions of only the top level that grew out of two ifs, with a check of what went to heart - sometimes paths, sometimes commands, sometimes paths and commands. </font><font style="vertical-align: inherit;">All these conditions were checked for each user action and accessed auxiliary functions from a neighboring sheet object, which also grew from several lines. </font><font style="vertical-align: inherit;">Needless to say, how slowly and waddily was this project going?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hobot framework</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Starting </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ActualizeBot,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we already imagined how big it would be, and our first task was to preserve the extensibility and speed of development. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we broke the client logic into controllers assigned to the paths and wrote a small abstraction to navigate between these controllers and process the messages received from the user in them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All this, based on large projects, was written in TypeScript and was given the elegant name of Hobot, alluding, of course, to navigation pipelines. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A controller is a simple object of three properties:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">path</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - string identifier of the path used to initialize and navigate the initialized paths</font></font></li>
<li><b>get</b> ‚Äî ,  ,           <i>hobot.gotoPath(ctx, path, data?)</i>.             ‚Äî   <i>data</i>   ,            </li>
<li><b>post</b> ‚Äî  .   ,      ,    .     updateType ‚Äî    ,    : <i>text</i>, <i>callback_query</i>   . updateType     <i>ctx</i>     </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Controller example:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> anotherController = {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'firstPath'</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">async</span> (ctx, data) =&gt; 
        <span class="hljs-keyword">await</span> ctx.reply(<span class="hljs-string">'Welcome to this path! Say "Hi"'</span>),
    <span class="hljs-attr">post</span>: <span class="hljs-keyword">async</span> (ctx, updateType) =&gt; {
        <span class="hljs-comment">//     : text / callback_query / etc...</span>
        <span class="hljs-keyword">if</span> (updateType === updateTypes.text &amp;&amp; ctx.update.message.text === <span class="hljs-string">'Hi'</span>) {
            <span class="hljs-keyword">await</span> ctx.reply(<span class="hljs-string">"Thank you!"</span>);
            <span class="hljs-comment">// hobot       this:</span>
            <span class="hljs-keyword">this</span>.hobot.gotoPath(ctx, <span class="hljs-string">'secondPath'</span>, { <span class="hljs-attr">userJustSaid</span>: <span class="hljs-string">"Hi"</span> });<font></font>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">//     ,       </span>
            <span class="hljs-keyword">await</span> ctx.reply(<span class="hljs-string">'We expect "Hi" text message here'</span>);<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks a bit more complicated than at the beginning, but the difficulty will remain the same when you have 100 or 200 paths. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The internal logic is trivial </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and it is surprising that no one has done this yet</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These controllers are added to an object whose keys are the values ‚Äã‚Äãof the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">path</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> property </font><font style="vertical-align: inherit;">and are called from it by these keys during user actions or when navigating using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hobot.gotoPath (ctx, path, data? )</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Navigation is allocated in a separate method in order not to touch the variable path and navigation logic, but to think only about business logic, although you can always change ctx.session.path with your hands, which, of course, is not recommended.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All you need to do to get your new boat with an indestructible structure working is to launch a regular telegraf bot and pass it and the config object to the Hobot constructor. </font><font style="vertical-align: inherit;">The config object consists of the controllers you want to initialize, the default path, and the command / controller pairs.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//   telegraf-</span>
<span class="hljs-keyword">const</span> bot = <span class="hljs-keyword">new</span> Telegraf(<span class="hljs-string">'_'</span>);<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> hobot = <span class="hljs-keyword">new</span> Hobot(bot, {
    <span class="hljs-attr">defaultPath</span>: <span class="hljs-string">'firstPath'</span>,
    <span class="hljs-attr">commands</span>: [
        <span class="hljs-comment">//  ,     </span>
        <span class="hljs-comment">// get    :</span>
        { <span class="hljs-attr">command</span>: <span class="hljs-string">'start'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'firstPath'</span> }<font></font>
    ],<font></font>
    <span class="hljs-attr">controllers</span>: [
        <span class="hljs-comment">// -,    </span><font></font>
        startController,<font></font>
        nextController<font></font>
    ]<font></font>
});<font></font>
<font></font>
<span class="hljs-comment">// C telegraf-,       </span><font></font>
bot.launch();<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In conclusion</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implicit advantages of dividing a sheet into controllers:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ability to put isolated functions, methods and interfaces that are locked to the logic of this controller in separate files next to the controllers</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Significantly reduced risk of accidentally breaking everything</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modularity: turning on / off / giving a certain segment of the audience this or that logic can be done simply by adding and removing controllers from the array, including by updating the config without programming - for this, of course, we need to write a couple of letters, since we have not yet reached</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ability to clearly tell the user what exactly is expected of him when he (which happens often) does something wrong - and do it where this is the place - at the end of the post method processing</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our plans</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article describes the basic script for working with text messaging Hobot. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the topic turns out to be relevant, we will share other technical subtleties of the framework and our observations from the practice of developing and using telegram bots in future articles. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Links</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installing the bot looks like this: </font></font><code>npm i -s hobot</code><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with walkthrough in README.MD and the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sandbox </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ready bot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> working in production based on Hobot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for your attention, I will be glad to hear your questions, suggestions or ideas for new bots!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488994/index.html">DDR5? Yes, we barely met DDR4</a></li>
<li><a href="../en488998/index.html">Why AI requirements can only make matters worse</a></li>
<li><a href="../en489000/index.html">How to assemble a cool mitap: 16 tips from three ‚Äúserial mitapers‚Äù. Leader-IT events # 1</a></li>
<li><a href="../en489002/index.html">Distributed wheelset registry: experience with Hyperledger Fabric</a></li>
<li><a href="../en489004/index.html">Cell Phone with Disc Dialer</a></li>
<li><a href="../en489010/index.html">We share the largest in Russia layer of data on online training with projects in linguistics, personalization, peddesign, ML</a></li>
<li><a href="../en489012/index.html">Google Cloud Spanner: good, bad, evil</a></li>
<li><a href="../en489014/index.html">The book ‚ÄúPerfect Algorithm. Greedy Algorithms and Dynamic Programming ¬ª</a></li>
<li><a href="../en489016/index.html">German Gref: ‚ÄúWe tried to organize a discussion about the AGI, and not a single self-respecting scientist came to it‚Äù</a></li>
<li><a href="../en489020/index.html">The study of one malicious</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>