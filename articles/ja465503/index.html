<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👭 👩🏿‍🏫 👨🏽 Tarantool Cartridge：Luaバックエンドを3行に細断 📀 🐁 💃🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mail.ru GroupにはTarantoolがあります。これはLuaのアプリケーションサーバーで、データベースも持っています（またはその逆ですか）。高速で優れていますが、1台のサーバーの機能に制限はありません。垂直スケーリングも万能薬ではないため、Tarantoolには水平スケーリング用のツール...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Tarantool Cartridge：Luaバックエンドを3行に細断</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/465503/"><img src="https://habrastorage.org/webt/zl/9w/og/zl9wogkzbdgwzzedtahlcg1f8ys.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mail.ru GroupにはTarantoolがあります。これはLuaのアプリケーションサーバーで、データベースも持っています（またはその逆ですか）。高速で優れていますが、1台のサーバーの機能に制限はありません。垂直スケーリングも万能薬ではないため、Tarantoolには水平スケーリング用のツール、vshardモジュール</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[1]があり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。複数のサーバー間でデータをシャーディングすることができますが、データを構成してビジネスロジックを固定するために、いじくる必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
良いニュース：コーン（たとえば</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[2]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[3]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を収集し、</font><font style="vertical-align: inherit;">この問題の解決策を大幅に簡略化する別のフレームワークを切り出しました。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タランツールカートリッジ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-これは、複雑な分散システムを開発するための新しいフレームワークです。</font><font style="vertical-align: inherit;">インフラストラクチャの問題を解決する代わりに、ビジネスロジックの作成に集中できます。</font><font style="vertical-align: inherit;">カットの下で、このフレームワークがどのように構成されているか、そしてそれを使用して分散サービスを作成する方法について説明します。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして実際、何が問題なのでしょうか？ </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タランチュラがあります、vshardがあります-これ以上何ができますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ポイントは利便性です。 Vshard構成はLuaテーブルを介して構成されます。複数のTarantoolプロセスの分散システムが正しく機能するためには、構成がどこでも同じである必要があります。誰もこれを手動で行うことを望んでいません。したがって、あらゆる種類のスクリプト、Ansible、デプロイメントシステムが使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カートリッジ自体がvshard構成を管理し、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">独自の分散構成に</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基づいてこれを行い</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">。本質的に、これは単純なYAMLファイルであり、そのコピーはTarantoolの各インスタンスに保存されます。単純化は、フレームワーク自体がその構成を監視するため、どこでも同じになるという事実にあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第二に、ポイントは再び便利です。構成はビジネスロジックの開発とは関係がなく、プログラマーの作業を妨げるだけです。プロジェクトのアーキテクチャについて説明する場合、ほとんどの場合、個々のコンポーネントとその相互作用について話します。クラスタを3つのデータセンターに展開することを考えるのは時期尚早です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはこれらの問題を何度も解決し、ある時点で、作成、開発、テスト、CI / CD、メンテナンスなど、アプリケーションのライフサイクル全体を通じてアプリケーションでの作業を簡素化するアプローチを開発することができました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カートリッジは、Tarantoolプロセスごとに役割の概念を導入しています。ロールは、開発者がコードの記述に集中できるようにする概念です。プロジェクトで使用可能なすべてのロールはTarantoolの1つのインスタンスで実行でき、テストにはこれで十分です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tarantoolカートリッジの主な機能：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動クラスターオーケストレーション。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい役割によるアプリケーション機能の拡張</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発および展開用のアプリケーションテンプレート。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">組み込みの自動シャーディング。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luatestテストフレームワークとの統合。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebUIとAPIを使用したクラスター管理。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッケージ化および展開ツール。</font></font><br>
</li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"こんにちは世界"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はフレームワーク自体を見せたいと思っているので、アーキテクチャについての話は後で残し、簡単なものから始めましょう。</font><font style="vertical-align: inherit;">Tarantool自体がすでにインストールされていると仮定すると、実行するだけです。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ tarantoolctl rocks install cartridge-cli<font></font>
$ export PATH=$PWD/.rocks/bin/:$PATH</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの2つのコマンドは、コマンドラインユーティリティをインストールし、テンプレートから最初のアプリケーションを作成できるようにします。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ cartridge create --name myapp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、これが私たちが得るものです：</font></font><br>
<br>
<pre><code class="plaintext hljs">myapp/<font></font>
├── .git/<font></font>
├── .gitignore<font></font>
├── app/roles/custom.lua<font></font>
├── deps.sh<font></font>
├── init.lua<font></font>
├── myapp-scm-1.rockspec<font></font>
├── test<font></font>
│   ├── helper<font></font>
│   │   ├── integration.lua<font></font>
│   │   └── unit.lua<font></font>
│   ├── helper.lua<font></font>
│   ├── integration/api_test.lua<font></font>
│   └── unit/sample_test.lua<font></font>
└── tmp/<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、「Hello、World！」が完成したgitリポジトリです。</font><font style="vertical-align: inherit;">応用。</font><font style="vertical-align: inherit;">すぐに実行して、依存関係（フレームワーク自体を含む）をプレインストールしてみましょう。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ tarantoolctl rocks make<font></font>
$ ./init.lua --http-port 8080</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこで、将来の分割アプリケーションの1つのノードを立ち上げました。</font><font style="vertical-align: inherit;">好奇心旺盛な素人はすぐにWebインターフェースを開き、マウスを使用して1つのノードからクラスターを構成し、その結果を楽しむことができますが、喜ばれるには早すぎます。</font><font style="vertical-align: inherit;">これまでのところ、アプリケーションは有用なことを行う方法を知りません。そのため、後でデプロイメントについて説明します。ここで、コードを作成します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーション開発</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
想像してみてください。データを受信して​​保存し、1日に1回レポートを作成するプロジェクトを設計します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/357/881/992/3578819921cd1788d44a85856c6aac45.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図を描き始め、その上にゲートウェイ、ストレージ、スケジューラの3つのコンポーネントを配置します。私たちはさらにアーキテクチャに取り組んでいます。ストレージとしてvshardを使用するため、vshard-routerとvshard-storageをスキームに追加します。ゲートウェイもスケジューラもリポジトリに直接アクセスしません。このためのルーターがあり、そのために作成されました。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2d4/65d/b72/2d465db72cc6c6db294c84748566513d.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンポーネントが抽象的に見えるため、このスキームは、プロジェクトで何を作成するかを正確に反映していません。これが実際のTarantoolにどのように投影されるかを確認する必要もあります。コンポーネントをプロセスごとにグループ化します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e88/314/779/e8831477921e9be63de6ada1e9385b86.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
vshard-routerとゲートウェイを別々のインスタンスに置いても意味がありません。これがすでにルーターの責任であるのに、なぜネットワークをもう一度経由する必要があるのですか？それらは同じプロセス内で実行されている必要があります。つまり、同じプロセスで、ゲートウェイとvshard.router.cfgが初期化され、それらがローカルで対話できるようになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設計段階では、3つのコンポーネントを扱うのは便利でしたが、開発者としてコードを書いている間、Tarnatoolの3つのインスタンスを起動することを考えたくありません。</font><font style="vertical-align: inherit;">テストを実行して、ゲートウェイが正しく記述されていることを確認する必要があります。</font><font style="vertical-align: inherit;">あるいは、同僚に機能を実演したいのかもしれません。</font><font style="vertical-align: inherit;">3つのコピーの展開に苦しむ必要があるのはなぜですか？</font><font style="vertical-align: inherit;">それが役割の概念が生まれた方法です。</font><font style="vertical-align: inherit;">ロールは、カートリッジによってライフサイクルが管理される通常のLoashモジュールです。</font><font style="vertical-align: inherit;">この例では、ゲートウェイ、ルーター、ストレージ、スケジューラーの4つがあります。</font><font style="vertical-align: inherit;">別のプロジェクトでは、もっとあるかもしれません。</font><font style="vertical-align: inherit;">すべての役割を1つのプロセスで起動でき、これで十分です。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/fdf/726/90c/fdf72690c30cc9b2b3ade8af667494dc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ステージングまたは試運転への展開に関しては、ハードウェアの機能に応じて、各ロールのセットを各Tarantoolプロセスに割り当てます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/a03/945/59f/a0394559f3f372e9de056ab4a080dff4.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トポロジー管理</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どのロールが起動されるかに関する情報は、どこかに保存する必要があります。そして、この「どこかに」は、私が前述した分散構成です。その中で最も重要なことは、クラスタトポロジです。 5つのTarantoolプロセスの3つのレプリケーショングループを次に示します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/140/04d/28a/14004d28a893832830ac61ad9c4207dd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを失わない</font><font style="vertical-align: inherit;">よう</font><font style="vertical-align: inherit;">にするため、実行中のプロセスに関する情報を慎重に扱います。カートリッジは、2フェーズコミットで構成を監視します。構成を更新するとすぐに、すべてのインスタンスの可用性と、新しい構成を受け入れる準備ができているかどうかが最初に確認されます。この後、2番目のフェーズで構成が適用されます。したがって、1つのインスタンスが一時的に利用できなくても、ひどいことは何も起こりません。構成は適用されず、前もってエラーが表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、トポロジセクションには、各レプリケーショングループのリーダーとして重要なパラメータが示されています。</font><font style="vertical-align: inherit;">通常、これは記録されているインスタンスです。</font><font style="vertical-align: inherit;">例外はあるかもしれませんが、残りはほとんどの場合読み取り専用です。</font><font style="vertical-align: inherit;">勇敢な開発者は、競合を恐れず、複数のレプリカに並行してデータを書き込むことができますが、すべてを実行しても、2回実行してはならない操作もあります。</font><font style="vertical-align: inherit;">これにはリーダーの気配がある。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/725/6db/376/7256db376d8fe207bbf57f5f82054c3f.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">役割生活</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなアーキテクチャに抽象的な役割が存在するためには、フレームワークがそれらを何らかの形で管理する必要があります。</font><font style="vertical-align: inherit;">当然、Tarantoolプロセスを再起動せずに制御が行われます。</font><font style="vertical-align: inherit;">ロールを管理するための4つのコールバックがあります。</font><font style="vertical-align: inherit;">カートリッジ自体は、分散構成での内容に応じてそれらを呼び出し、それによって構成を特定のロールに適用します。</font></font><br>
<br>
<pre><code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validate_config</span><span class="hljs-params">()</span></span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">apply_config</span><span class="hljs-params">()</span></span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各役割には機能があります</font></font><code>init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ロールが有効になったとき、またはTarantoolが再起動したときに1回呼び出されます。たとえば、box.space.createを初期化したり、スケジューラーがバックグラウンドファイバーを実行したりして、一定の間隔で作業を行うと便利です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つの機能で</font></font><code>init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は不十分な場合があります。カートリッジを使用すると、トポロジの保存に使用する分散構成をロールで利用できます。同じ構成で、新しいセクションを宣言して、ビジネス構成のフラグメントをそのセクションに格納できます。私の例では、これはデータスキーム、またはスケジューラロールのスケジュール設定です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスターが呼び出し</font></font><code>validate_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>apply_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分散構成が変更されるたび。 2フェーズコミットによって構成が適用されると、クラスターは、各役割がこの新しい構成を受け入れる準備ができていることを確認し、必要に応じてユーザーにエラーを報告します。構成が正常であることに全員が同意した場合、それは完了</font></font><code>apply_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
役割に</font></font><code>stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、役割のバイタルサインをクリアするために必要な</font><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">もあります。このサーバーのスケジューラが不要になった場合は、使用を開始したファイバーを停止でき</font></font><code>init</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロールは相互に対話できます。 Luaで関数呼び出しを作成することに慣れていますが、このプロセスで必要な役割がない場合もあります。ネットワークアクセスを容易にするために、Tarantoolに組み込まれた標準のネットボックスに基づいて構築された補助モジュールrpc（リモートプロシージャコール）を使用します。これは、たとえば、ゲートウェイが1日待つのではなく、スケジューラにジョブを今すぐ実行するように直接要求する場合に役立ちます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう1つの重要な点は、フォールトトレランスを確保することです。カートリッジはSWIMプロトコルを使用して正常性を監視します</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[4]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。つまり、プロセスはUDPを介して互いに「うわさ」を交換します。各プロセスはネイバーに最新のニュースを伝え、応答します。突然答えが来ない場合、タランツールは何かがおかしいと疑い始め、しばらくして彼は死を宣言し、このニュースについてみんなに伝え始めます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/dd6/612/8f8/dd66128f843008534c5bd2b7d3b3474d.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロトコルに基づいて、カートリッジは自動フェイルオーバーを構成します。各プロセスはその環境を監視し、リーダーが突然応答を停止した場合、レプリカはそれ自体で役割を引き受けることができ、カートリッジはそれに応じて実行中の役割を構成します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/23f/5b9/cc1/23f5b9cc17987df38ddddcf5000ab328.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
頻繁に切り替えを繰り返すと、レプリケーション中にデータの競合が発生する可能性があるため、ここでは注意が必要です。もちろん、自動フェイルオーバーをランダムにオンにすることは価値がありません。あなたは何が起こっているのかを明確に理解する必要があり、リーダーが回復して王冠が彼に返された後に複製が壊れないことを確認する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以上のことから、役割はマイクロサービスに似ているように見えるかもしれません。ある意味では、Tarantoolプロセス内のモジュールとしてのみ存在します。しかし、いくつかの根本的な違いがあります。まず、すべてのプロジェクトロールは同じコードベースに存在する必要があります。また、すべてのTarantoolプロセスは同じコードベースから起動する必要があるため、スケジューラーを初期化しようとするときのような驚きはありませんが、そうではありません。また、このような状況でのシステムの動作を予測してデバッグすることが非常に難しいため、コードのバージョンの違いを許可しないでください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dockerとは異なり、役割の「イメージ」を取り、それを別のマシンに移してそこで実行することはできません。</font><font style="vertical-align: inherit;">私たちの役割は、Dockerコンテナーほど分離されていません。</font><font style="vertical-align: inherit;">また、同じインスタンスで2つの同じロールを実行することはできません。</font><font style="vertical-align: inherit;">役割はあるかどうかにかかわらず、ある意味でシングルトンです。</font><font style="vertical-align: inherit;">そして、第3に、レプリケーショングループ全体でロールは同じである必要があります。それ以外の場合は、とんでもないことです。つまり、データは同じで、構成が異なります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">導入ツール</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cartridgeがアプリのデプロイにどのように役立つかを示すと約束しました。</font><font style="vertical-align: inherit;">他の人の生活を楽にするために、フレームワークはRPMパッケージをパックします：</font></font><br>
<br>
<pre><code class="plaintext hljs">$ cartridge pack rpm myapp #    ./myapp-0.1.0-1.rpm<font></font>
$ sudo yum install ./myapp-0.1.0-1.rpm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インストールされたパッケージには、必要なほぼすべてのものが含まれています。アプリケーションとインストールされた起動依存関係の両方です。 TarantoolもRPMパッケージの依存関係としてサーバーに送られ、サービスを開始する準備が整います。これはsystemdを介して行われますが、最初に少し設定を書く必要があります。少なくとも、各プロセスのURIを指定します。たとえば3つで十分です。</font></font><br>
<br>
<pre><code class="plaintext hljs">$ sudo tee /etc/tarantool/conf.d/demo.yml &lt;&lt;CONFIG<font></font>
myapp.router: {"advertise_uri": "localhost:3301", "http_port": 8080}<font></font>
myapp.storage_A: {"advertise_uri": "localhost:3302", "http_enabled": False}<font></font>
myapp.storage_B: {"advertise_uri": "localhost:3303", "http_enabled": False}<font></font>
CONFIG</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここには興味深いニュアンスがあります。バイナリプロトコルポートのみを指定する代わりに、ホスト名を含むプロセス全体のパブリックアドレスを指定します。これは、クラスターノードが相互に接続する方法を認識するために必要です。アドレス0.0.0.0をadvertise_uriとして使用することはお勧めできません。バインドソケットではなく、外部IPアドレスである必要があります。これがないと何も機能しないため、カートリッジは間違ったadvertise_uriを持つノードを起動させません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで構成の準備ができたので、プロセスを開始できます。通常のsystemdユニットでは複数のプロセスを開始できないため、カートリッジ上のアプリケーションは、いわゆるこのように機能するインスタンス化されたユニット：</font></font><br>
<br>
<pre><code class="plaintext hljs">$ sudo systemctl start myapp@router<font></font>
$ sudo systemctl start myapp@storage_A<font></font>
$ sudo systemctl start myapp@storage_B</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成では、CartridgeがWebインターフェースを提供するHTTPポート-8080を指定しました。それを見てみましょう：</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/d7c/1dd/64f/d7c1dd64fdca2fed35c71dca3caaf382.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロセスは実行されていますが、まだ構成されていないことがわかります。</font><font style="vertical-align: inherit;">カートリッジは、誰が誰と複製するかがまだわからず、自分で決定することもできないため、アクションを待機しています。</font><font style="vertical-align: inherit;">そして、私たちの選択は大きくありません。新しいクラスターの寿命は、最初のノードの構成から始まります。</font><font style="vertical-align: inherit;">次に、残りをクラスターに追加し、それらに役割を割り当てます。このデプロイメントでは、正常に完了したと見なすことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
お気に入りのドリンクを1杯注いで、1週間の長い仕事の後にリラックスしてください。</font><font style="vertical-align: inherit;">アプリケーションが悪用される可能性があります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/cf6/c86/e44/cf6c86e448cf42c9ce190a4d13307c3a.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概要</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、結果は何ですか？</font><font style="vertical-align: inherit;">試して、使用して、フィードバックを残して、githubでチケットを開始してください。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[1] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarantool»2.2»リファレンス»Rocksリファレンス»Module vshard</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
[2] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarantool</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
[3] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次世代請求アーキテクチャ：Tarantool</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
[4] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SWIM </font></font></a> <font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">への移行による変換</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">-クラスター構築プロトコルに</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">基づくアルファバンクの投資ビジネスのコアの実装方法</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
[5] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub-tarantool /カートリッジcli</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
[6] </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub-tarantool /カートリッジ</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja465493/index.html">Raspberry Pi上のSwiftプログラミング言語</a></li>
<li><a href="../ja465495/index.html">新しいドメインに移動するときにトラフィックを失わないようにする方法：ケース「Vse10」</a></li>
<li><a href="../ja465497/index.html">サーバーログを介した秘密のメッセージング</a></li>
<li><a href="../ja465499/index.html">量子コンピューターの開発の速度を説明する新しい法則？</a></li>
<li><a href="../ja465501/index.html">最初の「キラーアプリケーション」が離陸して急速に衰退してから40年後に学んだ教訓</a></li>
<li><a href="../ja465507/index.html">単一の責任原則：深い没入</a></li>
<li><a href="../ja465509/index.html">Asya Patrysheva：「インターネットはもはや単なるネットワークではありません。それが人生"</a></li>
<li><a href="../ja465511/index.html">最初と2番目のテクニカルサポートラインの間</a></li>
<li><a href="../ja465513/index.html">目にはログ：CCTVシステムにはどのような脆弱性がありますか</a></li>
<li><a href="../ja465515/index.html">Cisco 200-125 CCNA v3.0のトレーニング。27日目。ACLの概要。パート1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>