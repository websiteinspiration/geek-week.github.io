<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👲🏿 🧜 🤽 Kubernetes ConfigMaps: Nuansa untuk Tahu 👩🏻‍💼 👨🏾‍⚖️ 🌸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Catatan : ini bukan artikel panduan lengkap, melainkan pengingat / petunjuk bagi mereka yang sudah menggunakan ConfigMap di Kubernetes atau hanya meny...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kubernetes ConfigMaps: Nuansa untuk Tahu</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/498970/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Catatan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ini bukan artikel panduan lengkap, melainkan pengingat / petunjuk bagi mereka yang sudah menggunakan ConfigMap di Kubernetes atau hanya menyiapkan aplikasi mereka untuk bekerja di dalamnya.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_h/ly/ln/_hlylnaruzb2_b5zhbjpinrdphy.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Latar Belakang: Dari rsync ke ... Kubernetes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang terjadi sebelumnya? Di era "administrasi klasik", dalam versi yang paling sederhana, file konfigurasi ditempatkan tepat di sebelah aplikasi (atau di repositori, jika Anda mau). Sederhana: kami membuat pengiriman dasar (CD) untuk kode kami bersama dengan konfigurasi. Bahkan implementasi rsync bersyarat dapat disebut sebagai dasar CD.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika infrastruktur tumbuh, konfigurasi yang berbeda diperlukan untuk lingkungan yang berbeda (dev / stage / produksi). Aplikasi dilatih untuk memahami konfigurasi mana yang akan digunakan, meneruskannya sebagai argumen untuk memulai atau variabel lingkungan yang ditetapkan di lingkungan. Bahkan lebih banyak CD yang rumit dengan munculnya Chef / Wayang / Beraneka yang sangat berguna. Peran muncul di server, dan lingkungan tidak lagi dijelaskan di tempat yang berbeda - kita sampai pada IaC (Infrastruktur sebagai kode). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang terjadi selanjutnya? Jika memungkinkan untuk melihat manfaat penting Kubernet untuk dirinya sendiri dan bahkan dapat menyesuaikan diri dengan kebutuhan untuk memodifikasi aplikasi agar berfungsi di lingkungan ini, migrasi akan terjadi. Dalam perjalanan, saya mengharapkan banyak nuansa dan perbedaan dalam konstruksi arsitektur, tetapi ketika saya berhasil mengatasi bagian utama, saya menjalankan aplikasi yang telah lama ditunggu-tunggu berjalan di K8s.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah di sini, kita masih bisa menggunakan konfigurasi yang disiapkan dalam repositori di sebelah aplikasi atau meneruskan ENV ke wadah. </font><font style="vertical-align: inherit;">Namun, selain metode ini, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> juga tersedia </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Primitif K8 ini memungkinkan Anda untuk menggunakan templat Go di konfigurasi, mis. </font><font style="vertical-align: inherit;">membuat mereka seperti halaman HTML dan memuat ulang aplikasi saat mengubah konfigurasi tanpa restart. </font><font style="vertical-align: inherit;">Dengan ConfigMaps, tidak perlu lagi menyimpan 3+ konfigurasi untuk lingkungan yang berbeda dan melacak relevansi masing-masing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengantar umum untuk ConfigMaps dapat ditemukan, misalnya, di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dan dalam artikel ini saya akan fokus pada beberapa fitur bekerja dengan mereka.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMaps Sederhana</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti apa konfigurasi pada Kubernetes? </font><font style="vertical-align: inherit;">Apa yang mereka dapatkan dari templat go? </font><font style="vertical-align: inherit;">Misalnya, berikut adalah ConfigMap biasa untuk aplikasi yang digunakan dari grafik Helm:</font></font><br>
<br>
<pre><code class="plaintext hljs">apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
  name: app<font></font>
data:<font></font>
  config.json: |<font></font>
    {<font></font>
      "welcome": {{ pluck .Values.global.env .Values.welcome | quote }},<font></font>
      "name": {{ pluck .Values.global.env .Values.name | quote }}<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini nilai yang diganti </font></font><code>.Values.welcome</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>.Values.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan diambil dari file </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Kenapa tepatnya dari mana </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">Bagaimana cara kerja mesin templat Go? </font><font style="vertical-align: inherit;">Kami sudah membicarakan detail ini lebih terinci di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Panggilan </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">membantu untuk memilih jalur yang diperlukan dari peta:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ cat .helm/values.yaml <font></font>
welcome:<font></font>
  production: "Hello"<font></font>
  test: "Hey"<font></font>
name:<font></font>
  production: "Bob"<font></font>
  test: "Mike"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, Anda dapat mengambil kedua garis khusus dan seluruh fragmen konfigurasi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalnya, ConfigMap mungkin seperti ini:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {{ pluck .Values.global.env .Values.data | first | toJson | indent 4 }}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... dan di </font></font><code>values.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- isi berikut:</font></font><br>
<br>
<pre><code class="plaintext hljs">data:<font></font>
  production:<font></font>
    welcome: "Hello"<font></font>
    name: "Bob"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yang terlibat di sini </font></font><code>global.env</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adalah nama lingkungan. </font><font style="vertical-align: inherit;">Mengganti nilai ini selama penyebaran, Anda dapat merender ConfigMaps dengan konten yang berbeda. </font></font><code>first</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diperlukan di sini karena </font></font><code>pluck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mengembalikan daftar, elemen pertama yang berisi nilai yang diinginkan.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ketika ada banyak konfigurasi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Satu ConfigMap dapat berisi beberapa file konfigurasi:</font></font><br>
<br>
<pre><code class="json hljs">data:<font></font>
  config.json: |<font></font>
    {<font></font>
      <span class="hljs-attr">"welcome"</span>: {{ pluck .Values.global.env .Values.welcome | first | quote }},
      <span class="hljs-string">"name"</span>: {{ pluck .Values.global.env .Values.name | first | quote }}<font></font>
    }<font></font>
  database.yml: |<font></font>
    host: <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><font></font>
    db: app<font></font>
    user: app<font></font>
    password: app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda bahkan dapat memasang setiap konfigurasi secara terpisah:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/config.json<font></font>
          subPath: config.json<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles/database.yml<font></font>
          subPath: database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... atau ambil semua konfigurasi sekaligus dengan direktori:</font></font><br>
<br>
<pre><code class="plaintext hljs">        volumeMounts:<font></font>
        - name: app-conf<font></font>
          mountPath: /app/configfiles</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda mengubah deskripsi sumber daya Penempatan selama penyebaran, Kubernetes akan membuat ReplicaSet baru, mengurangi yang lama ke 0 dan meningkatkan yang baru ke jumlah replika yang ditentukan. </font><font style="vertical-align: inherit;">(Ini berlaku untuk strategi penyebaran </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>RollingUpdate</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tindakan semacam itu akan mengarah pada penciptaan kembali pod dengan deskripsi baru. </font><font style="vertical-align: inherit;">Misalnya: ada gambar </font></font><code>image:my-registry.example.com:v1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tetapi menjadi - </font></font><code>image:my-registry.example.com:v2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dan sama sekali tidak masalah apa yang sebenarnya kita ubah dalam deskripsi Penempatan kami: yang utama adalah hal ini menyebabkan replikaSet (dan, sebagai hasilnya, pod) diciptakan kembali. </font><font style="vertical-align: inherit;">Dalam hal ini, versi baru file konfigurasi di versi baru aplikasi secara otomatis dipasang dan tidak akan ada masalah.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMap Change Response</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam hal perubahan dalam ConfigMap, empat skenario acara dapat mengikuti. </font><font style="vertical-align: inherit;">Pertimbangkan mereka:</font></font><br>
<br>
<ol>
<li> <b></b>:  ConfigMap,    subPath.<br>
<b></b>:       .</li>
<li> <b></b>:  ConfigMap,          pod.<br>
<b></b>:  pod     .</li>
<li> <b></b>:  ConfigMap    Deployment     -.<br>
<b></b>:   ,      ConfigMap’,   Deployment,   pod  ,   —        .</li>
<li> <b></b>:  ConfigMap,   .<br>
<b></b>:    pod’   / pod’.</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan menganalisis lebih detail.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">skenario 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hanya</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memperbaiki ConfigMap? </font><font style="vertical-align: inherit;">Aplikasi tidak akan memulai ulang. </font><font style="vertical-align: inherit;">Dalam hal pemasangan oleh, </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak akan ada perubahan sampai pod dimulai ulang secara manual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya sederhana: Kubernet me-mount ConfigMap kami di pod versi sumber daya yang spesifik. </font><font style="vertical-align: inherit;">Karena sudah di-mount dengan </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tidak ada "pengaruh" tambahan pada konfigurasi tidak lagi disediakan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skenario 2</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak dapat memperbarui file tanpa membuat ulang pod? </font><font style="vertical-align: inherit;">Oke, kami memiliki 6 replika di Deployment, sehingga kami dapat bergantian melakukan semuanya secara manual </font></font><code>delete pod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Kemudian ketika membuat pod baru, mereka akan “mengambil” versi baru ConfigMap.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skenario 3</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bosan melakukan operasi seperti itu secara manual? </font><font style="vertical-align: inherit;">Solusi untuk masalah ini dijelaskan dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tips dan trik Helm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Deployment<font></font>
spec:<font></font>
  template:<font></font>
    metadata:<font></font>
      annotations:<font></font>
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}<font></font>
[...]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan demikian, </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hash dari konfigurasi anotasi yang diberikan hanya ditulis </font><font style="vertical-align: inherit;">ke template pod ( </font><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anotasi adalah bidang nilai kunci yang berubah-ubah tempat Anda dapat menyimpan nilai-nilai Anda. </font><font style="vertical-align: inherit;">Jika Anda mendaftarkannya di templat </font></font><code>spec.template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pod masa depan, bidang ini akan jatuh ke dalam ReplicaSet dan pod itu sendiri. </font><font style="vertical-align: inherit;">Kubernetes akan melihat bahwa template pod telah berubah (karena konfigurasi sha256 telah berubah) dan akan mulai </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, di mana tidak ada yang berubah kecuali penjelasan ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai hasilnya, kami menyimpan versi aplikasi dan uraian Deployment yang sama dan pada dasarnya hanya memicu pembuatan ulang pod oleh mesin - mirip dengan cara kami melakukannya secara manual </font></font><code>kubectl delete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tetapi sudah “benar”: secara otomatis dan dengan </font></font><code>RollingUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skenario 4</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mungkin aplikasi sudah tahu cara memantau perubahan dalam konfigurasi dan secara otomatis memuat ulang? </font><font style="vertical-align: inherit;">Di sinilah letak fitur penting dari ConfigMaps ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di Kubernetes, jika config di-mount dengannya </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, itu tidak akan diperbarui sampai pod dimulai ulang </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(lihat tiga skenario pertama yang dibahas di atas)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tetapi jika Anda memasang ConfigMap sebagai direktori, tanpa </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, maka di dalam wadah akan ada direktori dengan konfigurasi yang diperbarui tanpa memulai ulang pod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada fitur lain yang berguna untuk diingat:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File konfigurasi yang diperbarui di dalam wadah diperbarui dengan penundaan. </font><font style="vertical-align: inherit;">Ini karena fakta bahwa file tersebut tidak di-mount dengan tepat, tetapi objek Kubernetes.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File di dalamnya adalah symlink. </font><font style="vertical-align: inherit;">Contoh dengan </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-6b4cb86569-22vqv -- ls -lha /app/configfiles <font></font>
total 20K    <font></font>
drwxr-xr-x    1 root     root        4.0K Mar  3 19:34 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
-rw-r--r--    1 root     root          42 Mar  3 19:34 config.json<font></font>
-rw-r--r--    1 root     root          47 Mar  3 19:34 database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan apa yang akan terjadi tanpa </font></font><code>subPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ketika dipasang oleh direktori?</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:40 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:40 ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:40 ..data -&gt; ..2020_03_03_16_40_36.675612011<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perbarui konfigurasi (via deploy atau </font></font><code>kubectl edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), tunggu 2 menit (waktu caching apiserver) - dan voila:</font></font><br>
<br>
<pre><code class="bash hljs">$ kubectl -n production <span class="hljs-built_in">exec</span> go-conf-example-67c768c6fc-ccpwl -- ls -lha --color /app/configfiles <font></font>
total 12K    <font></font>
drwxrwxrwx    3 root     root        4.0K Mar  3 19:44 .<font></font>
drwxr-xr-x    1 app      app         4.0K Mar  3 19:34 ..<font></font>
drwxr-xr-x    2 root     root        4.0K Mar  3 19:44 ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          31 Mar  3 19:44 ..data -&gt; ..2020_03_03_16_44_38.763148336<font></font>
lrwxrwxrwx    1 root     root          18 Mar  3 19:40 config.json -&gt; ..data/config.json<font></font>
lrwxrwxrwx    1 root     root          19 Mar  3 19:40 database.yml -&gt; ..data/database.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhatikan cap waktu yang diubah di direktori yang dibuat oleh Kubernetes.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ubah pelacakan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan akhirnya - contoh sederhana tentang bagaimana Anda dapat memantau perubahan dalam konfigurasi.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami akan menggunakan aplikasi-Go semacam itu</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"encoding/json"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"time"</span><font></font>
<font></font>
	<span class="hljs-string">"github.com/fsnotify/fsnotify"</span><font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// Config fo our application</span>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
	Welcome <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"welcome"`</span>
	Name    <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"name"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">var</span> (<font></font>
	globalConfig *Config<font></font>
)<font></font>
<font></font>
<span class="hljs-comment">// LoadConfig - load our config!</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">LoadConfig</span><span class="hljs-params">(path <span class="hljs-keyword">string</span>)</span> <span class="hljs-params">(*Config, error)</span></span> {<font></font>
	configFile, err := os.Open(path)<font></font>
<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to read configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	config := <span class="hljs-built_in">new</span>(Config)<font></font>
<font></font>
	decoder := json.NewDecoder(configFile)<font></font>
	err = decoder.Decode(&amp;config)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"Unable to parse configuration file %s"</span>, path)<font></font>
	}<font></font>
<font></font>
	<span class="hljs-keyword">return</span> config, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ConfigWatcher - watches config.json for changes</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConfigWatcher</span><span class="hljs-params">()</span></span> {<font></font>
	watcher, err := fsnotify.NewWatcher()<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	<span class="hljs-keyword">defer</span> watcher.Close()<font></font>
<font></font>
	done := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">bool</span>)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		<span class="hljs-keyword">for</span> {
			<span class="hljs-keyword">select</span> {
			<span class="hljs-keyword">case</span> event, ok := &lt;-watcher.Events:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"event:"</span>, event)
				<span class="hljs-keyword">if</span> event.Op&amp;fsnotify.Write == fsnotify.Write {<font></font>
					log.Println(<span class="hljs-string">"modified file:"</span>, event.Name)<font></font>
				}<font></font>
				globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)<font></font>
				log.Println(<span class="hljs-string">"config:"</span>, globalConfig)
			<span class="hljs-keyword">case</span> err, ok := &lt;-watcher.Errors:
				<span class="hljs-keyword">if</span> !ok {
					<span class="hljs-keyword">return</span><font></font>
				}<font></font>
				log.Println(<span class="hljs-string">"error:"</span>, err)<font></font>
			}<font></font>
		}<font></font>
	}()<font></font>
<font></font>
	err = watcher.Add(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
		log.Fatal(err)<font></font>
	}<font></font>
	&lt;-done<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {<font></font>
	log.Println(<span class="hljs-string">"Start"</span>)<font></font>
	globalConfig, _ = LoadConfig(<span class="hljs-string">"./configfiles/config.json"</span>)
	<span class="hljs-keyword">go</span> ConfigWatcher()
	<span class="hljs-keyword">for</span> {<font></font>
		log.Println(<span class="hljs-string">"config:"</span>, globalConfig)<font></font>
		time.Sleep(<span class="hljs-number">30</span> * time.Second)<font></font>
	}<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... menambahkannya dengan konfigurasi seperti itu:</font></font><br>
<br>
<pre><code class="json hljs">$ cat configfiles/config.json <font></font>
{<font></font>
  <span class="hljs-attr">"welcome"</span>: <span class="hljs-string">"Hello"</span>,
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Alice"</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika dijalankan, lognya adalah:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:18:22 config: &amp;{Hello Alice}<font></font>
2020/03/03 22:18:52 config: &amp;{Hello Alice}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan sekarang kita akan menginstal aplikasi ini di Kubernetes, setelah memasang konfigurasi ConfigMap di pod alih-alih file dari gambar. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contoh grafik Helm telah</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> disiapkan di GitHub </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">helm install -n habr-configmap --namespace habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Alice'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan ubah hanya ConfigMap:</font></font><br>
<br>
<pre><code class="bash hljs">-  production: <span class="hljs-string">"Alice"</span>
+  production: <span class="hljs-string">"Bob"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perbarui grafik Helm di cluster, misalnya, seperti ini:</font></font><br>
<br>
<pre><code class="bash hljs">helm upgrade habr-configmap ./habr-configmap --<span class="hljs-built_in">set</span> <span class="hljs-string">'name.production=Bob'</span> --<span class="hljs-built_in">set</span> <span class="hljs-string">'global.env=production'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang akan terjadi?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplikasi v1 dan v2 tidak restart, karena </font><font style="vertical-align: inherit;">bagi mereka, tidak ada perubahan yang terjadi dalam Penempatan - mereka masih menyambut Alice.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aplikasi v3 restart, baca kembali konfigurasi, dan sambut Bob.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplikasi v4 tidak memulai ulang. </font><font style="vertical-align: inherit;">Karena ConfigMap di-mount sebagai direktori, perubahan dalam konfigurasi diketahui dan konfigurasi diubah dengan cepat, tanpa memulai ulang pod. </font><font style="vertical-align: inherit;">Ya, aplikasi memperhatikan perubahan dalam contoh sederhana kami - lihat pesan acara dari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fsnotify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">2020/03/03 22:19:15 event: "configfiles/config.json": CHMOD<font></font>
2020/03/03 22:19:15 config: &amp;{Hello Bob}<font></font>
2020/03/03 22:19:22 config: &amp;{Hello Bob}</code></pre></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat melihat bagaimana situasi serupa - melacak perubahan ConfigMap - diselesaikan dalam proyek yang lebih dewasa (dan hanya "nyata"), di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penting! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penting juga untuk mengingat bahwa semua hal di atas dalam artikel ini juga berlaku untuk Secret'ov di Kubernetes ( </font></font><code>kind: Secret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">): bukan tidak ada artinya mereka sangat mirip dengan ConfigMap ...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus! </font><font style="vertical-align: inherit;">Solusi Pihak Ketiga</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika Anda tertarik dengan topik pelacakan perubahan di konfigurasi, sudah ada utilitas siap pakai untuk ini:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jimmidyson / configmap-reload</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Mengirim permintaan HTTP jika file telah berubah. </font><font style="vertical-align: inherit;">Pengembang juga berencana untuk mengajarkan SIGHUP untuk mengirim, tetapi kurangnya komitmen sejak Oktober 2019 membuat rencana ini dipertanyakan;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stakater / Reloader</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - memonitor ConfigMap / Secrets dan melakukan upgrade bergulir (sebagaimana penulisnya menyebutnya) pada sumber daya yang terkait dengannya.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akan lebih mudah untuk meluncurkan aplikasi seperti itu dengan wadah sespan untuk aplikasi yang sudah ada. </font><font style="vertical-align: inherit;">Namun, jika Anda mengetahui fitur Kubernetes / ConfigMap dan konfigurasi untuk diedit tidak "langsung" (melalui </font></font><code>edit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), tetapi hanya sebagai bagian dari penyebaran ... maka kemampuan utilitas tersebut mungkin tampak berlebihan, mis. </font><font style="vertical-align: inherit;">menduplikasi fungsi dasar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan munculnya ConfigMap di Kubernetes, konfigurasi pindah ke babak pengembangan selanjutnya: penggunaan mesin template memberi mereka fleksibilitas yang sebanding dengan rendering halaman HTML. </font><font style="vertical-align: inherit;">Untungnya, komplikasi seperti itu tidak </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menggantikan</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solusi yang ada, tetapi menjadi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pelengkap</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mereka </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Oleh karena itu, untuk administrator (atau lebih tepatnya, bahkan pengembang) yang menganggap fitur baru berlebihan, file lama yang baik masih tersedia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagi mereka yang sudah menggunakan ConfigMaps atau hanya melihatnya, artikel ini memberikan gambaran singkat tentang esensi mereka dan nuansa penggunaan. </font><font style="vertical-align: inherit;">Jika Anda memiliki tips &amp; trik Anda sendiri pada topik - Saya akan senang melihat di komentar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baca juga di blog kami:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File lokal saat porting aplikasi ke Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">   Kubernetes  Helm:    </a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SSL-  Let's Encrypt  cert-manager  Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id498944/index.html">Telegram, Anjing, atau bagaimana tidak membuat cermin</a></li>
<li><a href="../id498948/index.html">Saatnya naga. Isolasi diri dengan teka-teki</a></li>
<li><a href="../id498952/index.html">Kami mengundang Anda ke DINS JS EVENING: kami berbicara tentang pemrograman berorientasi aspek dan API komposisi Vuejs 3</a></li>
<li><a href="../id498958/index.html">Kesalahan bukan UIAlertController</a></li>
<li><a href="../id498962/index.html">Tentang multitasking: windows di bawah kendali</a></li>
<li><a href="../id498976/index.html">Memperkenalkan .NET 5.0 Pratinjau 3</a></li>
<li><a href="../id498978/index.html">Menggunakan Graylog dan NLog untuk mengumpulkan log dari aplikasi C #. Pengalaman pribadi</a></li>
<li><a href="../id498982/index.html">Floppies untuk Dreamcast</a></li>
<li><a href="../id498984/index.html">Stealth School: 5 jenis gadget di game stealth</a></li>
<li><a href="../id498988/index.html">Pencarian pekerjaan di luar negeri dan imigrasi ke Kanada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>