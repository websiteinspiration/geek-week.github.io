<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∂Ô∏è üé≤ üë≤üèΩ ‚ÄúWhat marinas?‚Äù or we control the controller via bluetooth using a mobile application on Xamarin (Android) üë©üèæ‚Äçü§ù‚Äçüë®üèº üå¨Ô∏è üëî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In a previous article, I promised to talk about how to connect CANNY 3 tiny using UART to bluetooth. And since you don‚Äôt really take a walk on these M...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>‚ÄúWhat marinas?‚Äù or we control the controller via bluetooth using a mobile application on Xamarin (Android)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500454/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a previous </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I promised to talk about how to connect CANNY 3 tiny using UART to bluetooth. </font><font style="vertical-align: inherit;">And since you don‚Äôt really take a walk on these May holidays, it was decided to spend time with benefit and still keep the promise. </font><font style="vertical-align: inherit;">But just to connect the controller to the Bluetooth adapter HC-06, it would be too easy for Habr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we will not just connect everything, but also write for our scheme the most primitive Android application using C # and Xamarin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you like to monitor the ‚Äúlimit switches‚Äù and the reed switches, as I love it, you are welcome under cat.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a6/2t/ai/a62taim0dwnonrmzzjhicax8q-g.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's what we will talk about today: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part I: Introduction </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part II: Connecting the circuit and program for CANNY 3 tiny </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part III: We write an application on Xamarin for Android </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part IV: Conclusion</font></font></a><br>
<a name="I"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Part I: Introduction</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I'll start with the good one, except for the insertions of the program code in C #, then this time the article will be relatively small, because we examined the basic methods of working with the controller earlier. </font><font style="vertical-align: inherit;">In order not to repeat once again, here is a list of articles in which we have already examined the basic methods of working with the CANNY controller:</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúOne, two, three - burn the Christmas tree!‚Äù </font><font style="vertical-align: inherit;">or my first look at the CANNY 3 tiny controller</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - in this article we analyzed what the controller is, as well as the basics of working in the CannyLab development environment.</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúThe Destination has a lot of guises ...‚Äù or we automate the control of a lamp using CANNY 3 tiny and a photoresistor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - in this article we looked at working with USB Virtual COM-port, connecting sensors to the ADC, as well as high-frequency PWM at the controller outputs.</font></font><br>
</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">¬´  ...¬ª         (CANNY  Arduino)  Raspberry PI</a> ‚Äî        UART,     .<br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In preparing this article, I used the following hardware: CANNY 3 tiny controller, HC-06 bluetooth adapter, limit switch (Trema module), reed switch, old wired headphones, breadboard, wires, crocodiles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will build a system that, using a mobile application, monitors the status of two sensors and, if necessary, can manually sound an alarm. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything that will be presented in this article is invented purely for educational and demonstration purposes. I just wanted to show some tricks of working with the controller, as well as for the pieces of iron purchased at one time to somehow work out their value.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the nature of the problem being solved, which is far from reality, we will imagine that we are making a monitoring system behind the sliding door of the compartment. </font><font style="vertical-align: inherit;">When it starts moving, the reed switch will work, and at the end of the path it will give a signal to the trailer. </font><font style="vertical-align: inherit;">If we need to attract attention, for example, so that the door is closed back, we will give a "squeaky" signal through the speaker. </font><font style="vertical-align: inherit;">True, I do not have a speaker, but there are old headphones. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jq/wn/cn/jqwncnwbb_hvquu7qyfhlvhw10q.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well and, as always, a note. </font><font style="vertical-align: inherit;">I strongly do not recommend using the materials in this article as the ultimate truth. </font><font style="vertical-align: inherit;">I did many things for the first time myself, they can certainly be done better.</font></font><br>
</i><br>
<a name="II"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part II: Connecting the circuit and program for CANNY 3 tiny</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To get started, so as not to offend anyone in copyright, I borrowed from the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forum</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but by myself I adapted them for the </font><font style="vertical-align: inherit;">idea of ‚Äã‚Äãconnecting the controller to the HC-06, by controlling it through the ‚ÄúSerial bluetooth terminal‚Äù application and some tricks when developing the diagram </font><font style="vertical-align: inherit;">your task. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The connection diagram is as follows: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kt/lj/7c/ktlj7chkvqtuk-omahss0xxyxx4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
limit switch and the reed switch are connected to the terminals of controller No. 6 and No. 5, the headphones to terminal No. 4 (it has an RF PWM), UART RX is terminal No. 1, UART TX is terminal No. 2, terminal No. 3 It is used to supply ‚Äú+ 5V‚Äù, the output ‚Äú-‚Äù - for communication with the ‚Äúground‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's what it looks like in assembly:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/57/hy/du/57hydukatcvw7-mihshfkaykr20.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I developed the diagram (program) for CANNY 3 tiny in CannyLab version 1.42, perhaps in other versions of the development environment and with other controllers, it will be necessary to make changes to the diagram. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's what happened: The </font></font><br>
<br>
<img src="https://habrastorage.org/webt/l8/mb/yr/l8mbyr6rzisiqurje5vrboprrio.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
blocks associated with setting up the controller and sending messages via UART were disassembled in a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">previous article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let us examine in more detail the two remaining. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ‚Äú </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receive UART message</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù block </font><font style="vertical-align: inherit;">is responsible for turning on the siren (headphones). In principle, it is needed to parse an example of receiving a message via UART.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we check whether the received data is in the UART, if so, then we send one to the D-trigger input ‚ÄúE‚Äù, in which case the trigger copies the value from the ‚ÄúD‚Äù input into which we will write the first two characters from the message received via UART. I did not want to complicate everything, so we will use a simple scheme further. We assume that any number from 00 to 99 will come to us by UART, we will translate this number from a symbolic form to a numeric one (I recommend reading how </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the converter block works</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I had a little "plug" with it). Further, any value "&gt; 0" at the input of the leading edge detector causes a single signal, which turns on output 5 for 5 seconds, operating in the RF PWM mode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can play in the settings with the filling period of the RF PWM, the sound in the headphones will depend on this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's move on to the block</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Formation of the message</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><b><font style="vertical-align: inherit;">"</font></b><font style="vertical-align: inherit;"> Its implementation at first glance may seem unusual. This is explained by the fact that I did not really figure out how to work with the Serial bluetooth terminal program and with the same bluetooth protocol in Xamarin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I‚Äôll run a little ahead and say that I have not learned how to receive messages sent from the controller on my smartphone. If everything was obvious with the wired UART in the last article, then with Bluetooth, in practice, instead of the sent message, only its part can be read and the meaning of the transmitted command is violated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decided that the simplest solution is to transmit a single number, which is guaranteed to reach the recipient without loss.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, we monitor the discrete state of the reed switch and the limit switch. That is, we have only 4 possible combinations: the reed switch and the limit switch are off, only one is on, both are on. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the reed switch and the limit switch give a discrete signal (0/1), you need to somehow distinguish them. To do this, we multiply the value of the reed signal by 2. Now it turns out that the sum of the signals will give us values ‚Äã‚Äãfrom 0 to 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we will analyze a non-obvious option with fifty added to this value. The fact is that CannyLab sends a couple of characters to UART, that is, instead of 3, let's say 03, but as I said there is a risk of losing some of the information. For example, from the value 01, the program on the smartphone can read only the first ‚Äú0‚Äù, and this will already be an error.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would be possible to get confused and transform the data, replacing, for example, the ‚ÄúD1‚Äù character of the register with some letter or space, but I decided to make it easier. I converted the value 01 to 51 (02 to 52, etc.). The five does not carry a signal and I cut it out at the program level for a smartphone. Thus, we always guarantee that the useful part of the message remains. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We load the program into the controller, click ‚Äúrun‚Äù, if everything works as planned, then the HC-06 will periodically flash a red LED. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we pair the smartphone with the adapter. Now you can check the performance in the application ‚ÄúSerial Bluetooth terminal‚Äù or any other with similar functionality. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Write down the address of the Bluetooth adapter, it will be useful to us in the next chapter.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7q/9_/cj/7q9_cjavutr8evwh-bzcjo7lu_o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, the data comes, depending on the state of the sensors, and if you send "11", then a nasty squeak is heard in the headphones. </font><font style="vertical-align: inherit;">We could stop here, but let's sketch a primitive application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The program for the controller and the source code of the program for the smartphone can be downloaded from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
I would like to note that you do not have to implement everything in hardware specifically on CANNY controllers, you can write a program for Arduino or another controller you like. </font><font style="vertical-align: inherit;">Initially, I myself also planned to write an additional version of the sketch for Arduino, but since I killed almost all the May holidays, I simply did not have the strength to connect CANNY and the smartphone application.</font></font><br>
<a name="III"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part III: Writing an Xamarin Android Application </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I know that Xamarin, to put it mildly, is not the most popular solution for mobile development. And maybe you already have a question: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúWhy did I choose it?‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . I would like to answer him with words from the song of the same name by Psoya Korolenko: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ky/lq/bd/kylqbdcllbxokagsfxfjtasavrg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Honestly, there are no objective reasons. Just a couple of years ago I learned the basics of C # and everyone wanted to see what Xamarin is. And now, due to "self-isolation", hands have finally reached. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, let me remind you again. This is my first time meeting Xamarin and this is my first Android app. Do not blindly copy my curve code, if suddenly you can find a more beautiful solution, use it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When developing my program, I relied on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this material</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The article is not particularly chewed, and even in Spanish, so I still found it appropriate to share with you my variation on this topic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I built the program in the Visual studio 2019 community edition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, create a new empty Android project (Xamarin), as in the picture. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/ic/hz/gwichz5ldmq0k8wgpoedzpnt41u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I made changes only in three files, they can be viewed entirely on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and here we will analyze only the important parts: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AndroidManifest.xml</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
2 permissions are added to the standard template:</font></font><br>
<br>
<pre><code class="cs hljs">  &lt;uses-permission android:name=<span class="hljs-string">"android.permission.BLUETOOTH"</span>/&gt;<font></font>
  &lt;uses-permission android:name=<span class="hljs-string">"android.permission.BLUETOOTH_ADMIN"</span>/&gt;
</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activity_main.xml The</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
default container (RelativeLayout) has been removed. </font><font style="vertical-align: inherit;">Instead, the LinearLayout container was added simply because it is simpler. </font><font style="vertical-align: inherit;">In this container, all elements are aligned vertically, stretching across the entire width of the screen.</font></font><br>
<br>
<pre><code class="cs hljs">&lt;LinearLayout<font></font>
    xmlns:android=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    android:orientation=<span class="hljs-string">"vertical"</span>
    android:minWidth=<span class="hljs-string">"25px"</span>
    android:minHeight=<span class="hljs-string">"25px"</span>
    android:layout_width=<span class="hljs-string">"match_parent"</span>
    android:layout_height=<span class="hljs-string">"match_parent"</span>
    android:id=<span class="hljs-string">"@+id/linearLayout1"</span>&gt;<font></font>
    &lt;TextView<font></font>
        android:text=<span class="hljs-string">"Reed switch status - undefined"</span>
        android:layout_width=<span class="hljs-string">"match_parent"</span>
        android:layout_height=<span class="hljs-string">"wrap_content"</span>
        android:id=<span class="hljs-string">"@+id/rSwitch"</span>
        android:textSize=<span class="hljs-string">"12pt"</span> /&gt;<font></font>
    &lt;TextView<font></font>
        android:text=<span class="hljs-string">"End sensor status - undefined"</span>
        android:layout_width=<span class="hljs-string">"match_parent"</span>
        android:layout_height=<span class="hljs-string">"wrap_content"</span>
        android:id=<span class="hljs-string">"@+id/EndSensor"</span>
        android:textSize=<span class="hljs-string">"12pt"</span> /&gt;<font></font>
    &lt;Button<font></font>
        android:layout_width=<span class="hljs-string">"match_parent"</span>
        android:layout_height=<span class="hljs-string">"wrap_content"</span>
        android:id=<span class="hljs-string">"@+id/startSiren"</span>
        android:text=<span class="hljs-string">"Send signal to siren"</span> /&gt;<font></font>
    &lt;Switch<font></font>
        android:layout_width=<span class="hljs-string">"match_parent"</span>
        android:layout_height=<span class="hljs-string">"wrap_content"</span>
        android:id=<span class="hljs-string">"@+id/bltSwitch"</span>
        android:<span class="hljs-keyword">checked</span>=<span class="hljs-string">"false"</span>
        android:showText=<span class="hljs-string">"true"</span>
        android:text=<span class="hljs-string">"Connect bluetooth"</span> /&gt;<font></font>
    &lt;TextView<font></font>
        android:text=<span class="hljs-string">"status"</span>
        android:textAppearance=<span class="hljs-string">"?android:attr/textAppearanceSmall"</span>
        android:layout_width=<span class="hljs-string">"match_parent"</span>
        android:layout_height=<span class="hljs-string">"wrap_content"</span>
        android:id=<span class="hljs-string">"@+id/status"</span> /&gt;<font></font>
&lt;/LinearLayout&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anyone who is a little familiar with HTML layout or XML can easily understand the structure of the user interface. </font><font style="vertical-align: inherit;">We have three read-only text fields (TextView), one switch (Switch), which basically works like a checkbox and one ordinary button (Button). </font><font style="vertical-align: inherit;">Elements can be placed on the form by dragging and dropping from the constructor, and in the properties window or in the code to set them more convenient Id, text stubs and other parameters. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It remains to describe the logic of the program. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MainActivity.cs</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Below, under the spoiler, the entire code is for convenience</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full MainActivity.cs Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment">// based on http://alejandroruizvarela.blogspot.com/2014/01/bluetooth-arduino-xamarinandroid.html</span>
<span class="hljs-comment">// for this article https://habr.com/ru/post/500454/</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">// based on http://alejandroruizvarela.blogspot.com/2014/01/bluetooth-arduino-xamarinandroid.html</span>
<span class="hljs-comment">// for this article https://habr.com/ru/post/500454/</span><font></font>
<font></font>
<font></font>
<span class="hljs-keyword">using</span> Android.App;
<span class="hljs-keyword">using</span> Android.OS;
<span class="hljs-keyword">using</span> Android.Support.V7.App;
<span class="hljs-keyword">using</span> Android.Runtime;
<span class="hljs-keyword">using</span> Android.Widget;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.IO;
<span class="hljs-keyword">using</span> Java.Util;
<span class="hljs-keyword">using</span> Android.Bluetooth;
<span class="hljs-keyword">using</span> System.Threading.Tasks;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> _6.<span class="hljs-title">Canny_Xanarin_Bluetooth_Android</span><font></font>
{<font></font>
    [<span class="hljs-meta">Activity(Label = <span class="hljs-meta-string">"Control Canny 3 tiny via bluetooth"</span>, Theme = <span class="hljs-meta-string">"@style/AppTheme"</span>, MainLauncher = true)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> : <span class="hljs-title">AppCompatActivity</span><font></font>
    {<font></font>
<font></font>
        Button startSiren;<font></font>
        TextView rSwitch;<font></font>
        TextView EndSensor;<font></font>
        Switch bltSwitch;<font></font>
        TextView status;<font></font>
        <span class="hljs-keyword">private</span> Java.Lang.String dataToSend;
        <span class="hljs-keyword">private</span> BluetoothAdapter mBluetoothAdapter = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">private</span> BluetoothSocket btSocket = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">private</span> Stream outStream = <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// don't forget change addres to your device:</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">string</span> address = <span class="hljs-string">"98:D3:91:F9:6C:F6"</span>;
        <span class="hljs-comment">// MY_UUID can be saved as is</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UUID MY_UUID = UUID.FromString(<span class="hljs-string">"00001101-0000-1000-8000-00805F9B34FB"</span>);
        <span class="hljs-keyword">private</span> Stream inStream = <span class="hljs-literal">null</span>;<font></font>
<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnCreate</span>(<span class="hljs-params">Bundle savedInstanceState</span>)</span><font></font>
        {<font></font>
<font></font>
            <span class="hljs-keyword">base</span>.OnCreate(savedInstanceState);<font></font>
            Xamarin.Essentials.Platform.Init(<span class="hljs-keyword">this</span>, savedInstanceState);
            <span class="hljs-comment">// Set our view from the "main" layout resource</span><font></font>
            SetContentView(Resource.Layout.activity_main);<font></font>
<font></font>
            startSiren = FindViewById&lt;Button&gt;(Resource.Id.startSiren);<font></font>
            rSwitch = FindViewById&lt;TextView&gt;(Resource.Id.rSwitch);<font></font>
            EndSensor = FindViewById&lt;TextView&gt;(Resource.Id.EndSensor);<font></font>
            status = FindViewById&lt;TextView&gt;(Resource.Id.status);<font></font>
            bltSwitch = FindViewById&lt;Switch&gt;(Resource.Id.bltSwitch);<font></font>
<font></font>
<font></font>
            startSiren.Click += startSiren_ClickOnButtonClicked;<font></font>
            bltSwitch.CheckedChange += bltSwitch_HandleCheckedChange;<font></font>
            CheckBt();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CheckBt</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            mBluetoothAdapter = BluetoothAdapter.DefaultAdapter;<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!mBluetoothAdapter.Enable())<font></font>
            {<font></font>
                Toast.MakeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"Bluetooth Off"</span>,<font></font>
                    ToastLength.Short).Show();<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (mBluetoothAdapter == <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                Toast.MakeText(<span class="hljs-keyword">this</span>,
                    <span class="hljs-string">"Bluetooth does not exist or is busy"</span>, ToastLength.Short)<font></font>
                    .Show();<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">startSiren_ClickOnButtonClicked</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EventArgs e</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (bltSwitch.Checked)<font></font>
            {<font></font>
                <span class="hljs-keyword">try</span><font></font>
                {<font></font>
                    dataToSend = <span class="hljs-keyword">new</span> Java.Lang.String(<span class="hljs-string">"11"</span>);<font></font>
                    writeData(dataToSend);<font></font>
                    System.Console.WriteLine(<span class="hljs-string">"Send signal to siren"</span>);<font></font>
                }<font></font>
                <span class="hljs-keyword">catch</span> (System.Exception execept)<font></font>
                {<font></font>
                    System.Console.WriteLine(<span class="hljs-string">"Error when send data"</span> + execept.Message);<font></font>
                }<font></font>
<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span> status.Text = <span class="hljs-string">"bluetooth not connected"</span>;<font></font>
        }<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">bltSwitch_HandleCheckedChange</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, CompoundButton.CheckedChangeEventArgs e</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (e.IsChecked)<font></font>
            {<font></font>
                Connect();<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span><font></font>
            {<font></font>
                status.Text = <span class="hljs-string">"bluetooth not connected"</span>;
                <span class="hljs-keyword">if</span> (btSocket.IsConnected)<font></font>
                {<font></font>
                    <span class="hljs-keyword">try</span><font></font>
                    {<font></font>
                        btSocket.Close();<font></font>
                        System.Console.WriteLine(<span class="hljs-string">"Connection closed"</span>);<font></font>
                    }<font></font>
                    <span class="hljs-keyword">catch</span> (System.Exception ex)<font></font>
                    {<font></font>
                        Console.WriteLine(ex.Message);<font></font>
                    }<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Connect</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            BluetoothDevice device = mBluetoothAdapter.GetRemoteDevice(address);<font></font>
            System.Console.WriteLine(<span class="hljs-string">"Connection in progress"</span> + device);<font></font>
            mBluetoothAdapter.CancelDiscovery();<font></font>
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                btSocket = device.CreateRfcommSocketToServiceRecord(MY_UUID);<font></font>
                btSocket.Connect();<font></font>
                System.Console.WriteLine(<span class="hljs-string">"Correct Connection"</span>);<font></font>
                status.Text = <span class="hljs-string">"Correct Connection to bluetooth"</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span> (System.Exception e)<font></font>
            {<font></font>
                Console.WriteLine(e.Message);<font></font>
                <span class="hljs-keyword">try</span><font></font>
                {<font></font>
                    btSocket.Close();<font></font>
                    System.Console.WriteLine(<span class="hljs-string">"Connection closed"</span>);<font></font>
                }<font></font>
                <span class="hljs-keyword">catch</span> (System.Exception)<font></font>
                {<font></font>
                    System.Console.WriteLine(<span class="hljs-string">"Impossible to connect"</span>);<font></font>
                    status.Text = <span class="hljs-string">"Impossible to connect"</span>;<font></font>
                }<font></font>
                System.Console.WriteLine(<span class="hljs-string">"Socket Created"</span>);<font></font>
  <font></font>
            }<font></font>
            beginListenForData();<font></font>
<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beginListenForData</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                inStream = btSocket.InputStream;<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span> (System.IO.IOException ex)<font></font>
            {<font></font>
                Console.WriteLine(ex.Message);<font></font>
            }<font></font>
            Task.Factory.StartNew(() =&gt; {<font></font>
                <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];
                <span class="hljs-keyword">int</span> bytes;<font></font>
                <font></font>
                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<font></font>
                {<font></font>
<font></font>
                    <span class="hljs-keyword">try</span><font></font>
                    {<font></font>
                        bytes = inStream.Read(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">1024</span>);<font></font>
                        System.Console.WriteLine(<span class="hljs-string">"bytes "</span> + bytes.ToString());
                        <span class="hljs-keyword">if</span> (bytes &gt; <span class="hljs-number">0</span>)<font></font>
                        {<font></font>
                            <font></font>
                            RunOnUiThread(() =&gt; {<font></font>
                                <span class="hljs-keyword">string</span> valor = System.Text.Encoding.ASCII.GetString(buffer).Replace(<span class="hljs-string">"5"</span>,String.Empty);
                                <span class="hljs-comment">// transform string for deleate all symbols except 1-4(command from canny).</span>
                                <span class="hljs-keyword">string</span> command = <span class="hljs-keyword">new</span> <span class="hljs-keyword">string</span>(valor.Where(<span class="hljs-keyword">char</span>.IsDigit).ToArray());<font></font>
<font></font>
                                <span class="hljs-keyword">if</span> (command.Length &gt; <span class="hljs-number">0</span>)<font></font>
                                {<font></font>
                                     status.Text=<span class="hljs-string">"data successfully readed"</span>;<font></font>
                                    System.Console.WriteLine(<span class="hljs-string">"command  "</span> + command);
                                    <span class="hljs-keyword">switch</span> (Int32.Parse(command))<font></font>
                                    {<font></font>
                                        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<font></font>
                                            rSwitch.Text = <span class="hljs-string">"reed switch - disconnected "</span>;<font></font>
                                            EndSensor.Text = <span class="hljs-string">"end sensor - not pressed "</span>;
                                            <span class="hljs-keyword">break</span>;
                                        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<font></font>
                                            rSwitch.Text = <span class="hljs-string">"reed switch - disconnected "</span>;<font></font>
                                            EndSensor.Text = <span class="hljs-string">"end sensor - pressed "</span>;
                                            <span class="hljs-keyword">break</span>;
                                        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<font></font>
                                            rSwitch.Text = <span class="hljs-string">"reed switch - connected "</span>;<font></font>
                                            EndSensor.Text = <span class="hljs-string">"end sensor - not pressed "</span>;
                                            <span class="hljs-keyword">break</span>;
                                        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<font></font>
                                            rSwitch.Text = <span class="hljs-string">"reed switch - connected "</span>;<font></font>
                                            EndSensor.Text = <span class="hljs-string">"end sensor - pressed "</span>;
                                        <span class="hljs-keyword">break</span>;<font></font>
                                    }<font></font>
                                }<font></font>
                            });<font></font>
                        }<font></font>
                    }<font></font>
                    <span class="hljs-keyword">catch</span> (Java.IO.IOException)<font></font>
                    {<font></font>
                        RunOnUiThread(() =&gt; {<font></font>
                            EndSensor.Text = <span class="hljs-string">"End sensor status - undefined"</span>;<font></font>
                            rSwitch.Text = <span class="hljs-string">"Reed switch status - undefined "</span>;<font></font>
                        });<font></font>
                        <span class="hljs-keyword">break</span>;<font></font>
                    }<font></font>
                }<font></font>
            });<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeData</span>(<span class="hljs-params">Java.Lang.String data</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                outStream = btSocket.OutputStream;<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span> (System.Exception e)<font></font>
            {<font></font>
                System.Console.WriteLine(<span class="hljs-string">"Error with OutputStream when write to Serial port"</span> + e.Message);<font></font>
            }<font></font>
<font></font>
            Java.Lang.String message = data;<font></font>
<font></font>
            <span class="hljs-keyword">byte</span>[] msgBuffer = message.GetBytes();<font></font>
<font></font>
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                outStream.Write(msgBuffer, <span class="hljs-number">0</span>, msgBuffer.Length);<font></font>
                System.Console.WriteLine(<span class="hljs-string">"Message sent"</span>);<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span> (System.Exception e)<font></font>
            {<font></font>
                System.Console.WriteLine(<span class="hljs-string">"Error with  when write message to Serial port"</span> + e.Message);<font></font>
                status.Text = <span class="hljs-string">"Error with  when write message to Serial port"</span>;<font></font>
            }<font></font>
        }<font></font>
<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnRequestPermissionsResult</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> requestCode, <span class="hljs-keyword">string</span>[] permissions, [GeneratedEnum] Android.Content.PM.Permission[] grantResults</span>)</span><font></font>
        {<font></font>
            Xamarin.Essentials.Platform.OnRequestPermissionsResult(requestCode, permissions, grantResults);<font></font>
<font></font>
            <span class="hljs-keyword">base</span>.OnRequestPermissionsResult(requestCode, permissions, grantResults);<font></font>
        }<font></font>
    }<font></font>
 }<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now in parts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Blocks with connection of namespaces, class declaration, etc. </font><font style="vertical-align: inherit;">I'll miss. </font></font><br>
‚ÄÉ<br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We create variables with which we will later bind the user interface elements:</font></font><br>
<br>
<pre><code class="cs hljs">   Button startSiren;<font></font>
   TextView rSwitch;<font></font>
   TextView EndSensor;<font></font>
   Switch bltSwitch;<font></font>
   TextView status;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next comes the code from the example on which I relied. </font><font style="vertical-align: inherit;">Variables (fields) necessary for the operation of certain methods.</font></font><br>
<br>
<pre><code class="cs hljs">  <span class="hljs-keyword">private</span> Java.Lang.String dataToSend;
        <span class="hljs-keyword">private</span> BluetoothAdapter mBluetoothAdapter = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">private</span> BluetoothSocket btSocket = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">private</span> Stream outStream = <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// don't forget change addres to your device:</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">string</span> address = <span class="hljs-string">"98:D3:91:F9:6C:F6"</span>;
        <span class="hljs-comment">// MY_UUID can be saved as is</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UUID MY_UUID = UUID.FromString(<span class="hljs-string">"00001101-0000-1000-8000-00805F9B34FB"</span>);
        <span class="hljs-keyword">private</span> Stream inStream = <span class="hljs-literal">null</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is important for us here to drive the address of your HC-06 module into the address field. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since this is my first development experience for smartphones, including working with Xamarin, I decided not to complicate anything, so the device address, as in the original example, is fixed. </font><font style="vertical-align: inherit;">If you want, you can see </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it seems there is implemented an enumeration of available Bluetooth devices. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Move on.</font></font><br>
<br>
<pre><code class="cs hljs">
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnCreate</span>(<span class="hljs-params">Bundle savedInstanceState</span>)</span><font></font>
        {<font></font>
<font></font>
            <span class="hljs-keyword">base</span>.OnCreate(savedInstanceState);<font></font>
            Xamarin.Essentials.Platform.Init(<span class="hljs-keyword">this</span>, savedInstanceState);
            <span class="hljs-comment">// Set our view from the "main" layout resource</span><font></font>
            SetContentView(Resource.Layout.activity_main);<font></font>
<font></font>
            startSiren = FindViewById&lt;Button&gt;(Resource.Id.startSiren);<font></font>
            rSwitch = FindViewById&lt;TextView&gt;(Resource.Id.rSwitch);<font></font>
            EndSensor = FindViewById&lt;TextView&gt;(Resource.Id.EndSensor);<font></font>
            status = FindViewById&lt;TextView&gt;(Resource.Id.status);<font></font>
            bltSwitch = FindViewById&lt;Switch&gt;(Resource.Id.bltSwitch);<font></font>
<font></font>
<font></font>
            startSiren.Click += startSiren_ClickOnButtonClicked;<font></font>
            bltSwitch.CheckedChange += bltSwitch_HandleCheckedChange;<font></font>
            CheckBt();<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This method is created automatically, our task is to associate UI objects in it with the fields of the class, and also attach handlers for reactions to events ( </font></font><code>startSiren.Click  bltSwitch.CheckedChange</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Checking the connection via Bluetooth:</font></font><br>
<br>
<pre><code class="cs hljs">
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CheckBt</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            mBluetoothAdapter = BluetoothAdapter.DefaultAdapter;<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!mBluetoothAdapter.Enable())<font></font>
            {<font></font>
                Toast.MakeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"Bluetooth Off"</span>,<font></font>
                    ToastLength.Short).Show();<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (mBluetoothAdapter == <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                Toast.MakeText(<span class="hljs-keyword">this</span>,
                    <span class="hljs-string">"Bluetooth does not exist or is busy"</span>, ToastLength.Short)<font></font>
                    .Show();<font></font>
            }<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Turn on the siren. </font><font style="vertical-align: inherit;">Essentially just sending the characters ‚Äú11‚Äù to the controller:</font></font><br>
<br>
<pre><code class="cs hljs">
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">startSiren_ClickOnButtonClicked</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EventArgs e</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (bltSwitch.Checked)<font></font>
            {<font></font>
                <span class="hljs-keyword">try</span><font></font>
                {<font></font>
                    dataToSend = <span class="hljs-keyword">new</span> Java.Lang.String(<span class="hljs-string">"11"</span>);<font></font>
                    writeData(dataToSend);<font></font>
                    System.Console.WriteLine(<span class="hljs-string">"Send signal to siren"</span>);<font></font>
                }<font></font>
                <span class="hljs-keyword">catch</span> (System.Exception execept)<font></font>
                {<font></font>
                    System.Console.WriteLine(<span class="hljs-string">"Error when send data"</span> + execept.Message);<font></font>
                }<font></font>
<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span> status.Text = <span class="hljs-string">"bluetooth not connected"</span>;<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Checking the status of the switch (if shifted to the right, it means it is turned on): </font></font><br>
<br>
<pre><code class="cs hljs">   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">bltSwitch_HandleCheckedChange</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, CompoundButton.CheckedChangeEventArgs e</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (e.IsChecked)<font></font>
            {<font></font>
                Connect();<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span><font></font>
            {<font></font>
                <span class="hljs-keyword">if</span> (btSocket.IsConnected)<font></font>
                {<font></font>
                    <span class="hljs-keyword">try</span><font></font>
                    {<font></font>
                        btSocket.Close();<font></font>
                        System.Console.WriteLine(<span class="hljs-string">"Connection closed"</span>);<font></font>
                    }<font></font>
                    <span class="hljs-keyword">catch</span> (System.Exception ex)<font></font>
                    {<font></font>
                        Console.WriteLine(ex.Message);<font></font>
                    }<font></font>
                }<font></font>
            }<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you turn on, we begin the connection with Bluetooth. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The implementation of the connection itself:</font></font><br>
<br>
<pre><code class="cs hljs">   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Connect</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            BluetoothDevice device = mBluetoothAdapter.GetRemoteDevice(address);<font></font>
            System.Console.WriteLine(<span class="hljs-string">"Connection in progress"</span> + device);<font></font>
            mBluetoothAdapter.CancelDiscovery();<font></font>
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                btSocket = device.CreateRfcommSocketToServiceRecord(MY_UUID);<font></font>
                btSocket.Connect();<font></font>
                System.Console.WriteLine(<span class="hljs-string">"Correct Connection"</span>);<font></font>
                status.Text = <span class="hljs-string">"Correct Connection to bluetooth"</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span> (System.Exception e)<font></font>
            {<font></font>
                Console.WriteLine(e.Message);<font></font>
                <span class="hljs-keyword">try</span><font></font>
                {<font></font>
                    btSocket.Close();<font></font>
                    System.Console.WriteLine(<span class="hljs-string">"Connection closed"</span>);<font></font>
                }<font></font>
                <span class="hljs-keyword">catch</span> (System.Exception)<font></font>
                {<font></font>
                    System.Console.WriteLine(<span class="hljs-string">"Impossible to connect"</span>);<font></font>
                    status.Text = <span class="hljs-string">"Impossible to connect"</span>;<font></font>
                }<font></font>
                System.Console.WriteLine(<span class="hljs-string">"Socket Created"</span>);<font></font>
  <font></font>
            }<font></font>
            beginListenForData();<font></font>
<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is one of the most important methods - directly reading data:</font></font><br>
<br>
<pre><code class="cs hljs">
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beginListenForData</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                inStream = btSocket.InputStream;<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span> (System.IO.IOException ex)<font></font>
            {<font></font>
                Console.WriteLine(ex.Message);<font></font>
            }<font></font>
            Task.Factory.StartNew(() =&gt; {<font></font>
                <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];
                <span class="hljs-keyword">int</span> bytes;<font></font>
                <font></font>
                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<font></font>
                {<font></font>
<font></font>
                    <span class="hljs-keyword">try</span><font></font>
                    {<font></font>
                        bytes = inStream.Read(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">1024</span>);<font></font>
                        System.Console.WriteLine(<span class="hljs-string">"bytes "</span> + bytes.ToString());
                        <span class="hljs-keyword">if</span> (bytes &gt; <span class="hljs-number">0</span>)<font></font>
                        {<font></font>
                            <font></font>
                            RunOnUiThread(() =&gt; {<font></font>
                                <span class="hljs-keyword">string</span> valor = System.Text.Encoding.ASCII.GetString(buffer).Replace(<span class="hljs-string">"5"</span>,String.Empty);
                                <span class="hljs-comment">// transform string for deleate all symbols except 1-4(command from canny).</span>
                                <span class="hljs-keyword">string</span> command = <span class="hljs-keyword">new</span> <span class="hljs-keyword">string</span>(valor.Where(<span class="hljs-keyword">char</span>.IsDigit).ToArray());<font></font>
<font></font>
                                <span class="hljs-keyword">if</span> (command.Length &gt; <span class="hljs-number">0</span>)<font></font>
                                {<font></font>
                                     status.Text=<span class="hljs-string">"data successfully readed"</span>;<font></font>
                                    System.Console.WriteLine(<span class="hljs-string">"command  "</span> + command);
                                    <span class="hljs-keyword">switch</span> (Int32.Parse(command))<font></font>
                                    {<font></font>
                                        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<font></font>
                                            rSwitch.Text = <span class="hljs-string">"reed switch - disconnected "</span>;<font></font>
                                            EndSensor.Text = <span class="hljs-string">"end sensor - not pressed "</span>;
                                            <span class="hljs-keyword">break</span>;
                                        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<font></font>
                                            rSwitch.Text = <span class="hljs-string">"reed switch - disconnected "</span>;<font></font>
                                            EndSensor.Text = <span class="hljs-string">"end sensor - pressed "</span>;
                                            <span class="hljs-keyword">break</span>;
                                        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<font></font>
                                            rSwitch.Text = <span class="hljs-string">"reed switch - connected "</span>;<font></font>
                                            EndSensor.Text = <span class="hljs-string">"end sensor - not pressed "</span>;
                                            <span class="hljs-keyword">break</span>;
                                        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<font></font>
                                            rSwitch.Text = <span class="hljs-string">"reed switch - connected "</span>;<font></font>
                                            EndSensor.Text = <span class="hljs-string">"end sensor - pressed "</span>;
                                        <span class="hljs-keyword">break</span>;<font></font>
                                    }<font></font>
                                }<font></font>
                            });<font></font>
                        }<font></font>
                    }<font></font>
                    <span class="hljs-keyword">catch</span> (Java.IO.IOException)<font></font>
                    {<font></font>
                        RunOnUiThread(() =&gt; {<font></font>
                            EndSensor.Text = <span class="hljs-string">"End sensor status - undefined"</span>;<font></font>
                            rSwitch.Text = <span class="hljs-string">"Reed switch status - undefined "</span>;<font></font>
                        });<font></font>
                        <span class="hljs-keyword">break</span>;<font></font>
                    }<font></font>
                }<font></font>
            });<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I left many elements of the method as in the example, as I understand it, at first a connection to the data stream is created, if there is something in the buffer with the read data, then it is read into a variable </font></font><code>valor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Moreover, as I promised, we simply delete the number ‚Äú5‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, we remove all characters except the numbers from the read message. </font></font><code>string command = new string(valor.Where(char.IsDigit).ToArray());</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, after that everything is simple, depending on what number has come to us, we display this or that status in the UI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I did not fundamentally change these two methods:</font></font><br>
<br>
<pre><code class="cs hljs">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeData</span>(<span class="hljs-params">Java.Lang.String data</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                outStream = btSocket.OutputStream;<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span> (System.Exception e)<font></font>
            {<font></font>
                System.Console.WriteLine(<span class="hljs-string">"Error with OutputStream when write to Serial port"</span> + e.Message);<font></font>
            }<font></font>
<font></font>
            Java.Lang.String message = data;<font></font>
<font></font>
            <span class="hljs-keyword">byte</span>[] msgBuffer = message.GetBytes();<font></font>
<font></font>
            <span class="hljs-keyword">try</span><font></font>
            {<font></font>
                outStream.Write(msgBuffer, <span class="hljs-number">0</span>, msgBuffer.Length);<font></font>
                System.Console.WriteLine(<span class="hljs-string">"Message sent"</span>);<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span> (System.Exception e)<font></font>
            {<font></font>
                System.Console.WriteLine(<span class="hljs-string">"Error with  when write message to Serial port"</span> + e.Message);<font></font>
                status.Text = <span class="hljs-string">"Error with  when write message to Serial port"</span>;<font></font>
            }<font></font>
        }<font></font>
<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnRequestPermissionsResult</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> requestCode, <span class="hljs-keyword">string</span>[] permissions, [GeneratedEnum] Android.Content.PM.Permission[] grantResults</span>)</span><font></font>
        {<font></font>
            Xamarin.Essentials.Platform.OnRequestPermissionsResult(requestCode, permissions, grantResults);<font></font>
<font></font>
            <span class="hljs-keyword">base</span>.OnRequestPermissionsResult(requestCode, permissions, grantResults);<font></font>
        }<font></font>
    }<font></font>
 }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I understand it, this block of code implements the sending of a message and an event handler to overgrow access permission to Bluetooth. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, that‚Äôs all it‚Äôs left to set up </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a smartphone connection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debugging the application</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oddly enough, but it works:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jm/vs/5z/jmvs5zdesg9lvfprcdbp5-cebes.png"><br>
<a name="IV"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Part IV: Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's how the program works in kind: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8b/4r/kv/8b4rkvzlvtcl-nnqh-fb1dm8cey.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That was my first experience in developing applications for a smartphone on Android. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I would like to note that VS 2019 and Xamarin on my old computer work very slowly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the first assembly of the project, I really managed to eat these soft French rolls and drink tea. Also, the application itself turned out to be frankly miserable, the on / off switch does not work very conveniently, but on the other hand, given that I am only a little familiar with the basic development techniques for .NET, as well as the fact that I'm not a programmer at all, I could even without going through a single tutorial or a single lesson, outline your first application in a day. Therefore, the entry threshold for creating an elementary application is quite low.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I understand it, CANNY controllers can be used when tuning cars, especially domestic ones, so that it is quite possible to make some kind of ‚Äúfeature‚Äù and write an application for a smartphone to it. </font><font style="vertical-align: inherit;">The main thing to remember is that when powered from the vehicle‚Äôs on-board network, the controller outputs will also have the same voltage as the input (for example, 12 V instead of 5 V). </font><font style="vertical-align: inherit;">Do not forget to protect the Bluetooth adapter so that it does not inadvertently fail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The article turned out to be very laborious for me, I hope that everything was not in vain and you will like it.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500444/index.html">9 Python programming skills that distinguish a beginner from an experienced</a></li>
<li><a href="../en500446/index.html">A few words about R2DBC and PostgreSQL</a></li>
<li><a href="../en500448/index.html">Prometheus: HTTP monitoring through Blackbox exporter</a></li>
<li><a href="../en500450/index.html">Making a MIDI keyboard from an old children's synthesizer</a></li>
<li><a href="../en500452/index.html">High Reasoning on Deep Learning</a></li>
<li><a href="../en500456/index.html">BpfTrace - finally, a complete replacement for Dtrace on Linux</a></li>
<li><a href="../en500458/index.html">Online Speech Technical Features: Starter Pack</a></li>
<li><a href="../en500462/index.html">Detect scene changes and save h264 video clips on Raspberry Pi without decoding</a></li>
<li><a href="../en500468/index.html">Java Features Guide 8-14</a></li>
<li><a href="../en500470/index.html">Adapting your existing business solution for SwiftUI. Part 3. Working with architecture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>