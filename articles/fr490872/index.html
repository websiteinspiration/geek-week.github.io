<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ñ üö§ üíáüèº Trio - Programmation asynchrone pour les personnes üí¨ üëáüèΩ üîú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Python a une biblioth√®que Trio - une biblioth√®que de programmation asynchrone. 
 D√©couvrir Trio sera surtout int√©ressant pour ceux qui travaillent sur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Trio - Programmation asynchrone pour les personnes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/barsgroup/blog/490872/"><img src="https://habrastorage.org/webt/m7/0o/ye/m70oyejwkcwdk32csx1mq2wprao.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python a une </font><font style="vertical-align: inherit;">biblioth√®que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une biblioth√®que de programmation asynchrone. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√©couvrir Trio sera surtout int√©ressant pour ceux qui travaillent sur Asyncio, car c'est une bonne alternative qui vous permet de r√©soudre certains des probl√®mes qu'Asyncio ne peut pas g√©rer. </font><font style="vertical-align: inherit;">Dans cette revue, nous consid√©rerons ce qu'est le Trio et quelles fonctionnalit√©s il nous offre.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ceux qui commencent tout juste √† travailler en programmation asynchrone, je propose de lire une petite introduction sur ce que sont l'asynchronie et le synchronisme. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synchronisme et asynchronie </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">programmation synchrone,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> toutes les op√©rations sont effectu√©es s√©quentiellement et vous ne pouvez d√©marrer une nouvelle t√¢che qu'apr√®s avoir termin√© la pr√©c√©dente. </font><font style="vertical-align: inherit;">Cependant, l'un de ses points ¬´douloureux¬ª est que si l'un des threads travaille sur une t√¢che depuis tr√®s longtemps, le programme entier peut se figer. </font><font style="vertical-align: inherit;">Il existe des t√¢ches qui ne n√©cessitent pas de puissance de calcul, mais prennent du temps processeur, qui peuvent √™tre utilis√©es de mani√®re plus rationnelle en donnant le contr√¥le √† un autre thread. </font><font style="vertical-align: inherit;">Dans la programmation synchrone, il n'y a aucun moyen de suspendre la t√¢che en cours afin de compl√©ter ce qui suit dans son intervalle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä quoi sert l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asynchronie?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? Il est n√©cessaire de faire la distinction entre la v√©ritable asynchronie et l'asynchronie entr√©e-sortie. Dans notre cas, nous parlons d'entr√©e-sortie asynchrone. √Ä l'√©chelle mondiale - afin de gagner du temps et d'utiliser plus efficacement les installations de production. L'asynchronie vous permet de contourner les zones probl√©matiques des threads. En entr√©e-sortie asynchrone, le thread actuel n'attendra pas l'ex√©cution d'un √©v√©nement externe, mais donnera le contr√¥le √† un autre thread. Ainsi, en fait, un seul thread est ex√©cut√© √† la fois. Le thread qui a donn√© le contr√¥le entre dans la file d'attente et attend que le contr√¥le y revienne. Peut-√™tre que d'ici l√†, l'√©v√©nement externe attendu se produira et il sera possible de continuer √† travailler. Cela vous permettra de basculer entre les t√¢ches afin de minimiser la perte de temps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et maintenant, nous pouvons revenir √† ce qui est</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asyncio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le fonctionnement de cette </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boucle d'√©v√©nements de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> biblioth√®que </font><font style="vertical-align: inherit;">( </font><b><font style="vertical-align: inherit;">boucle d'</font></b><font style="vertical-align: inherit;"> √©v√©nements), qui inclut la file d'attente des t√¢ches et la boucle elle-m√™me. Le cycle contr√¥le l'ex√©cution des t√¢ches, c'est-√†-dire qu'il extrait les t√¢ches de la file d'attente et d√©termine ce qui va leur arriver. Par exemple, il peut g√©rer des t√¢ches d'E / S. C'est-√†-dire que la boucle d'√©v√©nements s√©lectionne la t√¢che, s'enregistre et commence au bon moment son traitement. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les coroutines</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sont des fonctions sp√©ciales qui renvoient le contr√¥le de cette t√¢che √† la boucle d'√©v√©nements, c'est-√†-dire les renvoient √† la file d'attente. Il est n√©cessaire que ces coroutines soient lanc√©es pr√©cis√©ment √† travers une s√©rie d'√©v√©nements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a aussi des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">futurs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- objets dans lesquels le r√©sultat actuel de l'ex√©cution d'une t√¢che est stock√©. </font><font style="vertical-align: inherit;">Il peut s'agir d'informations indiquant que la t√¢che n'a pas encore √©t√© trait√©e ou que le r√©sultat a d√©j√† √©t√© obtenu; </font><font style="vertical-align: inherit;">ou il peut y avoir une exception. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En g√©n√©ral, la biblioth√®que Asyncio est bien connue, cependant, elle pr√©sente un certain nombre d'inconv√©nients que Trio est capable de fermer.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trio</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon l'auteur de la biblioth√®que, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nathaniel Smith</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , d√©veloppant Trio, il a cherch√© √† cr√©er un outil l√©ger et facile √† utiliser pour le d√©veloppeur, qui fournirait les entr√©es / sorties asynchrones les plus simples et la gestion des erreurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une caract√©ristique importante de Trio est la gestion de contexte asynchrone, qui n'a pas Asyncio. </font><font style="vertical-align: inherit;">Pour ce faire, l'auteur a cr√©√© en Trio la soi-disant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"p√©pini√®re"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(p√©pini√®re) - une zone d'annulation qui prend la responsabilit√© de l'atomicit√© (continuit√©) d'un groupe de fils. L'id√©e cl√© est que si dans la ¬´p√©pini√®re¬ª l'une des coroutines √©choue, alors tous les flux dans la ¬´p√©pini√®re¬ª seront termin√©s avec succ√®s ou annul√©s. Dans tous les cas, le r√©sultat sera correct. Et seulement lorsque toutes les coroutines sont termin√©es, apr√®s avoir quitt√© la fonction, le d√©veloppeur d√©cide lui-m√™me comment proc√©der. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, ¬´enfants¬ª vous permet d'emp√™cher la poursuite du traitement des erreurs, ce qui peut conduire au fait que tout ¬´tombera¬ª ou que le r√©sultat sera un r√©sultat incorrect.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est exactement ce qui peut arriver avec Asyncio, car dans Asyncio le processus ne s'arr√™te pas, malgr√© le fait qu'une erreur s'est produite. </font><font style="vertical-align: inherit;">Et dans ce cas, d'une part, le d√©veloppeur ne saura pas exactement ce qui s'est pass√© au moment de l'erreur, et d'autre part, le traitement se poursuivra.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemples </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons l'exemple le plus simple de deux fonctionnalit√©s concurrentes: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asyncio</font></font></b><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> asyncio<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo1</span>():</span>
    print(<span class="hljs-string">'  foo1: '</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">2</span>)<font></font>
    print(<span class="hljs-string">'  foo1: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo2</span>():</span>
    print(<span class="hljs-string">'  foo2: '</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)<font></font>
    print(<span class="hljs-string">'  foo2: '</span>)<font></font>
<font></font>
loop = asyncio.get_event_loop()<font></font>
bundle = asyncio.wait([<font></font>
    loop.create_task(foo1()),<font></font>
    loop.create_task(foo2()),<font></font>
])<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    loop.run_until_complete(bundle)<font></font>
<span class="hljs-keyword">finally</span>:<font></font>
    loop.close()</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trio</font></font></b><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo1</span>():</span>
    print(<span class="hljs-string">'  foo1: '</span>)
    <span class="hljs-keyword">await</span> trio.sleep(<span class="hljs-number">2</span>)<font></font>
    print(<span class="hljs-string">'  foo1: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo2</span>():</span>
    print(<span class="hljs-string">'  foo2: '</span>)
    <span class="hljs-keyword">await</span> trio.sleep(<span class="hljs-number">1</span>)<font></font>
    print(<span class="hljs-string">'  foo2: '</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:<font></font>
        nursery.start_soon(foo1)<font></font>
        nursery.start_soon(foo2)<font></font>
<font></font>
trio.run(root)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dans les deux cas, le r√©sultat sera le m√™me:</font></font><br>
<br>
<pre><code class="python hljs">foo1: <font></font>
foo2: <font></font>
foo2: <font></font>
foo1: </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Structurellement, le code Asyncio et Trio dans cet exemple est similaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La diff√©rence √©vidente est que Trio ne n√©cessite pas l'ach√®vement explicite de la boucle d'√©v√©nements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prenons un exemple un peu plus vivant. </font><font style="vertical-align: inherit;">Appelons le service Web pour obtenir un horodatage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour Asyncio, nous utiliserons en plus </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiohttp<font></font>
<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, i</span>):</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<font></font>
        tasks = [<font></font>
            asyncio.ensure_future(foo(session, i))<font></font>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS)<font></font>
        ]<font></font>
        <span class="hljs-keyword">await</span> asyncio.wait(tasks)<font></font>
    print(<span class="hljs-string">f'  <span class="hljs-subst">{time.time() - start}</span>'</span>)<font></font>
<font></font>
ioloop = asyncio.get_event_loop()<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    ioloop.run_until_complete(root())<font></font>
<span class="hljs-keyword">finally</span>:<font></font>
    ioloop.close()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour nous Trio utilisation </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">demande</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> asks<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
asks.init(<span class="hljs-string">'trio'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">i</span>):</span><font></font>
    start = time.time()<font></font>
    response = <span class="hljs-keyword">await</span> asks.get(URL)<font></font>
    content = response.json()<font></font>
    print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS):<font></font>
            nursery.start_soon(foo, i)<font></font>
<font></font>
    print(<span class="hljs-string">f'  <span class="hljs-subst">{time.time() - start}</span>'</span>)<font></font>
<font></font>
trio.run(root)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans les deux cas, nous obtenons quelque chose comme</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-number">0</span> | <span class="hljs-number">1543837647522</span> (  <span class="hljs-number">0.11855053901672363</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543837647535</span> (  <span class="hljs-number">0.1389765739440918</span>)
<span class="hljs-number">3</span> | <span class="hljs-number">1543837647527</span> (  <span class="hljs-number">0.13904547691345215</span>)
<span class="hljs-number">4</span> | <span class="hljs-number">1543837647557</span> (  <span class="hljs-number">0.1591191291809082</span>)
<span class="hljs-number">1</span> | <span class="hljs-number">1543837647607</span> (  <span class="hljs-number">0.2100353240966797</span>)<font></font>
  <span class="hljs-number">0.2102828025817871</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien. </font><font style="vertical-align: inherit;">Imaginez que lors de l'ex√©cution de l'une des coroutines, une erreur s'est produite </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pour Asyncio.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, i</span>):</span><font></font>
    start = time.time()<font></font>
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">3</span>:
        <span class="hljs-keyword">raise</span> Exception
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()<font></font>
        print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<span class="hljs-number">1</span> | <span class="hljs-number">1543839060815</span> (  <span class="hljs-number">0.10857725143432617</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543839060844</span> (  <span class="hljs-number">0.10372781753540039</span>)
<span class="hljs-number">5</span> | <span class="hljs-number">1543839060843</span> (  <span class="hljs-number">0.10734415054321289</span>)
<span class="hljs-number">4</span> | <span class="hljs-number">1543839060874</span> (  <span class="hljs-number">0.13985681533813477</span>)<font></font>
  <span class="hljs-number">0.15044045448303223</span><font></font>
Traceback (most recent call last):<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">12</span>, <span class="hljs-keyword">in</span> foo
    <span class="hljs-keyword">raise</span> Exception<font></font>
Exception</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pour trio</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">i</span>):</span><font></font>
    start = time.time()<font></font>
    response = <span class="hljs-keyword">await</span> asks.get(URL)<font></font>
    content = response.json()<font></font>
    <span class="hljs-keyword">if</span> i == <span class="hljs-number">3</span>:
        <span class="hljs-keyword">raise</span> Exception<font></font>
    print(<span class="hljs-string">f'<span class="hljs-subst">{i}</span> | <span class="hljs-subst">{content.get(<span class="hljs-string">"time"</span>)}</span> (  <span class="hljs-subst">{time.time() - start}</span>)'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-number">4</span> | <span class="hljs-number">1543839223372</span> (  <span class="hljs-number">0.13524699211120605</span>)
<span class="hljs-number">2</span> | <span class="hljs-number">1543839223379</span> (  <span class="hljs-number">0.13848185539245605</span>)<font></font>
Traceback (most recent call last):<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">28</span>, <span class="hljs-keyword">in</span> &lt;module&gt;<font></font>
    trio.run(root)<font></font>
  File <span class="hljs-string">"/lib64/python3.6/site-packages/trio/_core/_run.py"</span>, line <span class="hljs-number">1337</span>, <span class="hljs-keyword">in</span> run
    <span class="hljs-keyword">raise</span> runner.main_task_outcome.error<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">23</span>, <span class="hljs-keyword">in</span> root<font></font>
    nursery.start_soon(foo, i)<font></font>
  File <span class="hljs-string">"/lib64/python3.6/site-packages/trio/_core/_run.py"</span>, line <span class="hljs-number">397</span>, <span class="hljs-keyword">in</span> __aexit__
    <span class="hljs-keyword">raise</span> combined_error_from_nursery<font></font>
  File <span class="hljs-string">"...py"</span>, line <span class="hljs-number">15</span>, <span class="hljs-keyword">in</span> foo
    <span class="hljs-keyword">raise</span> Exception<font></font>
Exception</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On voit clairement que dans Trio, imm√©diatement apr√®s l'apparition de l'erreur, la ¬´zone d'annulation¬ª a fonctionn√© et deux des quatre t√¢ches qui ne contenaient pas d'erreurs ont √©t√© anormalement termin√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans Asyncio, toutes les t√¢ches √©taient termin√©es et ce n'est qu'alors que le trackback est apparu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l'exemple donn√©, ce n'est pas important, mais imaginons que les t√¢ches d'une mani√®re ou d'une autre d√©pendent les unes des autres, et l'ensemble des t√¢ches doit avoir la propri√©t√© de l'atomicit√©. Dans ce cas, une r√©ponse rapide √† une erreur devient beaucoup plus importante. Bien s√ªr, vous pouvez utiliser </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attendent asyncio.wait (t√¢ches, return_when = FIRST_EXCEPTION)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais vous devez vous rappeler de terminer correctement les t√¢ches ouvertes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un autre exemple: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
supposons que les coroutines acc√®dent simultan√©ment √† plusieurs services Web similaires et que la premi√®re r√©ponse re√ßue soit importante.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> asyncio <span class="hljs-keyword">import</span> FIRST_COMPLETED
<span class="hljs-keyword">import</span> aiohttp<font></font>
<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(URL) <span class="hljs-keyword">as</span> response:<font></font>
        content = <span class="hljs-keyword">await</span> response.json()
        <span class="hljs-keyword">return</span> content.get(<span class="hljs-string">"time"</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:<font></font>
        tasks = [<font></font>
            asyncio.ensure_future(foo(session))<font></font>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, MAX_CLIENTS + <span class="hljs-number">1</span>)<font></font>
        ]<font></font>
        done, pending = <span class="hljs-keyword">await</span> asyncio.wait(tasks, return_when=FIRST_COMPLETED)<font></font>
        print(done.pop().result())<font></font>
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> pending:<font></font>
            future.cancel()<font></font>
<font></font>
ioloop = asyncio.get_event_loop()<font></font>
<span class="hljs-keyword">try</span>:<font></font>
    ioloop.run_until_complete(root())<font></font>
<span class="hljs-keyword">except</span>:<font></font>
    ioloop.close()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout est assez simple. </font><font style="vertical-align: inherit;">La seule exigence est de ne pas oublier d'effectuer des t√¢ches qui n'ont pas √©t√© termin√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Trio, lancer une man≈ìuvre similaire est un peu plus difficile, mais il est presque impossible de laisser les ¬´queues¬ª invisibles tout de suite:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> trio
<span class="hljs-keyword">import</span> asks<font></font>
URL = <span class="hljs-string">'https://yandex.ru/time/sync.json?geo=213'</span>
MAX_CLIENTS = <span class="hljs-number">5</span>
asks.init(<span class="hljs-string">'trio'</span>)<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">foo</span>(<span class="hljs-params">session, send_channel, nursery</span>):</span>
    response = <span class="hljs-keyword">await</span> session.request(<span class="hljs-string">'GET'</span>, url=URL)<font></font>
    content = response.json()<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> send_channel:<font></font>
        send_channel.send_nowait(content.get(<span class="hljs-string">"time"</span>))<font></font>
    nursery.cancel_scope.cancel()<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">root</span>():</span>
    send_channel, receive_channel = trio.open_memory_channel(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> send_channel, receive_channel:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> trio.open_nursery() <span class="hljs-keyword">as</span> nursery:
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> asks.Session() <span class="hljs-keyword">as</span> session:
                <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(MAX_CLIENTS):<font></font>
                    nursery.start_soon(foo, session, send_channel.clone(), nursery)<font></font>
<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> receive_channel:<font></font>
            x = <span class="hljs-keyword">await</span> receive_channel.receive()<font></font>
            print(x)<font></font>
<font></font>
trio.run(root)</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nursery.cancel_scope.cancel ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - la premi√®re coroutine qui se termine appellera une fonction dans la zone d'annulation qui annulera toutes les autres t√¢ches, il n'est donc pas n√©cessaire de s'en pr√©occuper s√©par√©ment. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certes, pour transf√©rer le r√©sultat de l'ex√©cution de la coroutine vers la fonction qui l'a provoqu√©, vous devrez initier un canal de communication. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'esp√®re que cette revue comparative a permis de comprendre les principales caract√©ristiques de Trio. </font><font style="vertical-align: inherit;">Merci √† tous!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr490850/index.html">Aidez le compilateur √† vous aider</a></li>
<li><a href="../fr490852/index.html">En d√©tail sur SpinLaunch - le secret le plus z√©l√© de l'industrie spatiale</a></li>
<li><a href="../fr490854/index.html">Les robots d'entrep√¥t utilisant l'IA pour trier les articles sont pr√™ts √† l'emploi</a></li>
<li><a href="../fr490856/index.html">Auto Dungeon Master</a></li>
<li><a href="../fr490862/index.html">LetsEncrypt pr√©voit de r√©voquer ses certificats en raison d'un bogue logiciel</a></li>
<li><a href="../fr490874/index.html">Impl√©mentation d√©lib√©r√©e du travail √† distance: comment doubler vos r√©sultats sans embaucher personne</a></li>
<li><a href="../fr490876/index.html">Pourquoi br√ªlons-nous?</a></li>
<li><a href="../fr490882/index.html">R√©soudre les probl√®mes sous Docker. Il semblerait, qu'est-ce que GIT a √† voir avec √ßa?</a></li>
<li><a href="../fr490884/index.html">Conf√©rence DEFCON 27. Votre voiture est ma voiture. Partie 1</a></li>
<li><a href="../fr490888/index.html">Choisir des cadeaux pour des femmes fantastiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>