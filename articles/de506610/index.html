<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤘🏿 📟 🧗🏿 WAL-G: PostgreSQL-Datenbanksicherungen und -wiederherstellung ⛵️ 👎🏽 🔲</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es ist seit langem bekannt, dass Backups in SQL-Dumps (mit pg_dump oder pg_dumpall ) keine gute Idee sind. Um PostgreSQL zu sichern , ist es besser, d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WAL-G: PostgreSQL-Datenbanksicherungen und -wiederherstellung</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506610/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist seit langem bekannt, dass Backups in SQL-Dumps (mit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oder </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dumpall</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) keine gute Idee sind. Um PostgreSQL zu </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sichern</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ist es besser, den Befehl </font><b><font style="vertical-align: inherit;">pg_basebackup</font></b><font style="vertical-align: inherit;"> zu verwenden </font><font style="vertical-align: inherit;">, der eine binäre Kopie der WAL-Protokolle erstellt. Wenn Sie jedoch anfangen, den gesamten Prozess der Erstellung eines Backups und der Wiederherstellung zu untersuchen, werden Sie verstehen, dass Sie mindestens ein paar Dreiräder schreiben müssen, damit all dies funktioniert und Sie keine Schmerzen sowohl von oben als auch von unten verursachen. Um das Leiden zu lindern, wurde WAL-G entwickelt. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist ein in Go geschriebenes Tool zum Sichern und Wiederherstellen von PostgreSQL-Datenbanken ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und in jüngerer Zeit MySQL / MariaDB, MongoDB und FoundationDB)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">Es unterstützt die Arbeit mit Amazon S3-Speichern (und Analoga, z. B. Yandex Object Storage) sowie mit Google Cloud Storage, Azure Storage, Swift Object Storage und nur mit dem Dateisystem. </font><font style="vertical-align: inherit;">Das gesamte Setup ist auf einfache Schritte reduziert, aber aufgrund der Tatsache, dass Artikel darüber im Internet verstreut sind, gibt es kein vollständiges Handbuch, das alle Schritte von und nach enthält (es gibt mehrere Beiträge zu Habré, aber viele Punkte fehlen dort).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9i/pq/ut/9ipqut4x24_-0192l8skbzkri6o.jpeg" alt="postgresql backup"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Artikel wurde hauptsächlich geschrieben, um Ihr Wissen zu systematisieren. </font><font style="vertical-align: inherit;">Ich bin kein DBA und kann irgendwo in einer Philister-Entwicklungssprache ausgedrückt werden, daher sind Korrekturen willkommen! </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unabhängig davon stelle ich fest, dass alle folgenden Punkte für PostgreSQL 12.3 unter Ubuntu 18.04 relevant und überprüft sind. Alle Befehle müssen als privilegierter Benutzer ausgeführt werden.</font></font></i><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Zeitpunkt dieses Schreibens ist die stabile Version von WAL-G </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v0.2.15 (März 2020)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wir werden es verwenden ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aber wenn Sie es selbst aus dem Hauptzweig zusammenstellen möchten, enthält das Github-Repository alle Anweisungen dafür</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Zum Herunterladen und Installieren müssen Sie Folgendes tun:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
curl -L <span class="hljs-string">"https://github.com/wal-g/wal-g/releases/download/v0.2.15/wal-g.linux-amd64.tar.gz"</span> -o <span class="hljs-string">"wal-g.linux-amd64.tar.gz"</span><font></font>
tar -xzf wal-g.linux-amd64.tar.gz<font></font>
mv wal-g /usr/<span class="hljs-built_in">local</span>/bin/
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danach müssen Sie zuerst WAL-G und dann PostgreSQL selbst konfigurieren.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G-Setup</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Beispiel für einen Backup-Speicher wird Amazon S3 verwendet ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">da es näher an meinen Servern liegt und sehr billig verwendet wird</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Um damit arbeiten zu können, benötigen Sie einen „s3-Bucket“ und Zugriffsschlüssel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In allen vorherigen Artikeln zu WAL-G wurde die Konfiguration mithilfe von Umgebungsvariablen verwendet. Ab dieser Version befinden sich die Einstellungen jedoch in der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datei</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .walg.json im Home-Verzeichnis des Benutzers postgres. </font><font style="vertical-align: inherit;">Führen Sie zum Erstellen das folgende Bash-Skript aus:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
cat &gt; /var/lib/postgresql/.walg.json &lt;&lt; EOF<font></font>
{<font></font>
    <span class="hljs-string">"WALG_S3_PREFIX"</span>: <span class="hljs-string">"s3://your_bucket/path"</span>,
    <span class="hljs-string">"AWS_ACCESS_KEY_ID"</span>: <span class="hljs-string">"key_id"</span>,
    <span class="hljs-string">"AWS_SECRET_ACCESS_KEY"</span>: <span class="hljs-string">"secret_key"</span>,
    <span class="hljs-string">"WALG_COMPRESSION_METHOD"</span>: <span class="hljs-string">"brotli"</span>,
    <span class="hljs-string">"WALG_DELTA_MAX_STEPS"</span>: <span class="hljs-string">"5"</span>,
    <span class="hljs-string">"PGDATA"</span>: <span class="hljs-string">"/var/lib/postgresql/12/main"</span>,
    <span class="hljs-string">"PGHOST"</span>: <span class="hljs-string">"/var/run/postgresql/.s.PGSQL.5432"</span><font></font>
}<font></font>
EOF<font></font>
<span class="hljs-comment">#    :</span><font></font>
chown postgres: /var/lib/postgresql/.walg.json<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde in jeder Hinsicht ein wenig erklären:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WALG_S3_PREFIX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - der Pfad zu Ihrem S3-Bucket, in den Backups gegossen werden (Sie können dies sowohl im Stammverzeichnis als auch im Ordner tun);</font></font></li>
<li><b>AWS_ACCESS_KEY_ID</b> –    S3 (<i>      –     ReadOnly Policy!        </i>);<br>
</li>
<li><b>AWS_SECRET_ACCESS_KEY</b> –     S3;</li>
<li><b>WALG_COMPRESSION_METHOD</b> –  ,   Brotli (          /);</li>
<li><b>WALG_DELTA_MAX_STEPS</b> –  «»     (      ,      ,      );</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGDATA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - der Pfad zum Verzeichnis mit den Daten Ihrer Datenbank ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie können dies herausfinden, indem Sie den Befehl </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters ausführen</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGHOST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Verbindung zur Datenbank, mit einer lokalen Sicherung ist es besser, dies über Unix-Socket zu tun, wie in diesem Beispiel.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weitere Parameter finden Sie in der Dokumentation: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/wal-g/wal-g/blob/v0.2.15/PostgreSQL.md#configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL-Setup</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit der Archivierer in der Datenbank WAL-Protokolle in die Cloud hochladen und von diesen wiederherstellen kann (falls erforderlich), müssen Sie mehrere Parameter in der Konfigurationsdatei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postgresql/12/main/postgresql.conf festlegen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Um zu beginnen, müssen </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie sicherstellen,</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dass keine der folgenden Einstellungen auf andere Werte festgelegt ist, damit das DBMS beim Neustart der Konfiguration nicht herunterfällt. </font><font style="vertical-align: inherit;">Sie können diese Parameter hinzufügen mit:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"wal_level=replica"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_mode=on"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_command='/usr/local/bin/wal-g wal-push \"%p\" &gt;&gt; /var/log/postgresql/archive_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> “archive_timeout=60” &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"restore_command='/usr/local/bin/wal-g wal-fetch \"%f\" \"%p\" &gt;&gt; /var/log/postgresql/restore_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf<font></font>
<font></font>
<span class="hljs-comment">#     SIGHUP    </span><font></font>
killall -s HUP postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beschreibung der einzustellenden Parameter:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal_level</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - wie viele Informationen in WAL-Magazine geschrieben werden sollen, " </font><b><font style="vertical-align: inherit;">replica</font></b><font style="vertical-align: inherit;"> " - um alles zu schreiben;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Aktiviert das Herunterladen von WAL-Protokollen mit dem Befehl aus dem Parameter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Befehl zum Archivieren des vollständigen WAL-Protokolls;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_timeout</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Die Archivierung von Protokollen erfolgt erst, wenn sie abgeschlossen ist. Wenn Ihr Server jedoch Daten ein wenig ändert / zur Datenbank hinzufügt, ist es sinnvoll, hier in Sekunden ein Limit festzulegen, nach dem der Archivierungsbefehl erzwungen wird ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ich habe daher jede Sekunde ein intensives Schreiben in die Datenbank Ich habe mich geweigert, diesen Parameter in der Produktion einzustellen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restore_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Ein Befehl zum Wiederherstellen eines WAL-Protokolls aus einer Sicherung. Er wird verwendet, wenn die letzten Datenbankänderungen in der „vollständigen Sicherung“ (Basissicherung) fehlen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weitere Informationen zu all diesen Parametern finden Sie in der Übersetzung der offiziellen Dokumentation: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://postgrespro.ru/docs/postgresql/12/runtime-config-wal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einrichten eines Sicherungszeitplans</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ob es Ihnen gefällt oder nicht, aber Cron ist der bequemste Weg, um zu beginnen. </font><font style="vertical-align: inherit;">Dies wird für die Erstellung von Backups konfiguriert. </font><font style="vertical-align: inherit;">Beginnen wir mit dem Befehl zum Erstellen einer vollständigen Sicherung: In wal-g ist dies das Argument zum Ausführen von </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backup-push</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Zunächst ist es jedoch besser, diesen Befehl manuell vom Benutzer postgres auszuführen, um sicherzustellen, dass alles in Ordnung ist (und keine Zugriffsfehler vorliegen):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Startargumente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geben den Pfad zum Datenverzeichnis an. Ich erinnere Sie daran, dass Sie ihn durch Ausführen von </font><b><font style="vertical-align: inherit;">pg_lsclusters erkennen können</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn alles reibungslos verlief und die Daten in das S3-Repository hochgeladen wurden, können Sie den regelmäßigen Start in crontab konfigurieren:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"15 4 * * *    /usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main &gt;&gt; /var/log/postgresql/walg_backup.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#       </span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Beispiel beginnt der Sicherungsvorgang jeden Tag um 4:15 Uhr morgens.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Löschen Sie alte Backups</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Höchstwahrscheinlich müssen Sie nicht unbedingt alle Backups aus dem Mesozoikum speichern. Daher ist es hilfreich, Ihren Speicher regelmäßig zu "bereinigen" (sowohl "vollständige Backups" als auch WAL-Protokolle). </font><font style="vertical-align: inherit;">Wir werden alles auch durch die Cron-Aufgabe tun:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"30 6 * * *    /usr/local/bin/wal-g delete before FIND_FULL <span class="hljs-subst">$(date -d '-10 days' '+%FT%TZ')</span> --confirm &gt;&gt; /var/log/postgresql/walg_delete.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#          (        )</span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cron führt diese Aufgabe jeden Tag um 6:30 Uhr morgens aus und löscht alles (vollständige Sicherungen, Deltas und WALs) mit Ausnahme der Kopien der letzten 10 Tage, hinterlässt jedoch mindestens eine Sicherung </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vor dem</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> angegebenen Datum, sodass jeder Punkt </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nach dem</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Datum in PITR fällt .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Von der Sicherung wiederherstellen</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist kein Geheimnis, dass die Garantie für eine gesunde Basis die regelmäßige Wiederherstellung und Überprüfung der Datenintegrität im Inneren ist. Wie man sich mit WAL-G erholt - Ich werde in diesem Abschnitt darauf eingehen, und wir werden später über Überprüfungen sprechen. </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unabhängig davon ist zu beachten,</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dass Sie für die Wiederherstellung in einer Testumgebung (alles, was nicht in der Produktion ist) das schreibgeschützte Konto in S3 verwenden müssen, um Sicherungen nicht versehentlich zu überschreiben. Im Fall von WAL-G müssen Sie dem S3-Benutzer die folgenden Rechte in Gruppenrichtlinien </font><i><font style="vertical-align: inherit;">festlegen</font></i><font style="vertical-align: inherit;"> ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Effekt: Zulassen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetObject</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: ListBucket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetBucketLocation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Und vergessen Sie natürlich nicht, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode =</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in der Einstellungsdatei </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresql.conf vorher auszuschalten</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">damit Ihre Testbasis nicht leise sichern möchte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Wiederherstellung erfolgt mit einer leichten Handbewegung, wobei </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alle PostgreSQL-Daten</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (einschließlich Benutzer) </font><b><font style="vertical-align: inherit;">gelöscht werden. Seien</font></b><font style="vertical-align: inherit;"> Sie daher äußerst vorsichtig, wenn Sie die folgenden Befehle ausführen.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#     (, pgbouncer),    ,       </span><font></font>
service pgbouncer stop<font></font>
<span class="hljs-comment">#   ,     (, monit),        (   pgsql12)</span><font></font>
monit stop pgsql12<font></font>
<span class="hljs-comment">#    </span><font></font>
service monit stop<font></font>
<span class="hljs-comment">#    </span><font></font>
service postgresql stop<font></font>
<span class="hljs-comment">#       (!!!);     ,      </span><font></font>
rm -rf /var/lib/postgresql/12/main<font></font>
<span class="hljs-comment">#      </span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-fetch /var/lib/postgresql/12/main LATEST'</span>
<span class="hljs-comment">#      -   (. https://postgrespro.ru/docs/postgresql/12/runtime-config-wal#RUNTIME-CONFIG-WAL-ARCHIVE-RECOVERY ),        postgres</span>
su - postgres -c <span class="hljs-string">'touch /var/lib/postgresql/12/main/recovery.signal'</span>
<span class="hljs-comment">#   ,     </span><font></font>
service postgresql start<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Für diejenigen, die den Wiederherstellungsprozess überprüfen möchten - im Folgenden wird ein kleines Stück Bash-Magic vorbereitet, damit das Skript bei Problemen bei der Wiederherstellung mit einem Exit-Code ungleich Null abstürzt. </font><font style="vertical-align: inherit;">In diesem Beispiel werden 120 Überprüfungen mit einer Zeitüberschreitung von 5 Sekunden (nur 10 Minuten für die Wiederherstellung) durchgeführt, um festzustellen, ob die Signaldatei gelöscht wurde (dies bedeutet, dass die Wiederherstellung erfolgreich war):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
CHECK_RECOVERY_SIGNAL_ITER=0<font></font>
<span class="hljs-keyword">while</span> [ <span class="hljs-variable">${CHECK_RECOVERY_SIGNAL_ITER}</span> -le 120 ]
<span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal removed"</span>
        <span class="hljs-built_in">break</span>
    <span class="hljs-keyword">fi</span><font></font>
    sleep 5<font></font>
    ((CHECK_RECOVERY_SIGNAL_ITER+1))<font></font>
<span class="hljs-keyword">done</span><font></font>
<font></font>
<span class="hljs-comment">#        ,    </span>
<span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal still exists!"</span>
    <span class="hljs-built_in">exit</span> 17
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vergessen Sie nach einer erfolgreichen Wiederherstellung nicht, alle Prozesse neu zu starten (pgbouncer / monit usw.).</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenüberprüfung nach Wiederherstellung</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Überprüfen Sie nach der Wiederherstellung unbedingt die Integrität der Datenbank, damit bei einer fehlerhaften / krummen Sicherung keine Situation auftritt. </font><font style="vertical-align: inherit;">Und es ist besser, dies mit jedem erstellten Archiv zu tun, aber wo und wie hängt von Ihrer Vorstellungskraft ab (Sie können einzelne Server stündlich hochfahren oder einen Test in CI durchführen). </font><font style="vertical-align: inherit;">Aber zumindest - Sie müssen die Daten und Indizes in der Datenbank überprüfen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Daten zu überprüfen, reicht es aus, sie durch den Speicherauszug zu führen. Es ist jedoch besser, wenn Sie beim Erstellen der Datenbank die Prüfsummen aktivieren ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datenprüfsummen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-keyword">if</span> ! su - postgres -c <span class="hljs-string">'pg_dumpall &gt; /dev/null'</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'pg_dumpall failed'</span>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Überprüfen von Indizes - es gibt </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein Amcheck-Modul</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Wir werden die SQL-Abfrage dafür aus </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G-Tests übernehmen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und eine kleine Logik erstellen:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#  sql-       </span><font></font>
cat &gt; /tmp/amcheck.sql &lt;&lt; EOF<font></font>
CREATE EXTENSION IF NOT EXISTS amcheck;<font></font>
SELECT bt_index_check(c.oid), c.relname, c.relpages<font></font>
FROM pg_index i<font></font>
JOIN pg_opclass op ON i.indclass[0] = op.oid<font></font>
JOIN pg_am am ON op.opcmethod = am.oid<font></font>
JOIN pg_class c ON i.indexrelid = c.oid<font></font>
JOIN pg_namespace n ON c.relnamespace = n.oid<font></font>
WHERE am.amname = <span class="hljs-string">'btree'</span>
AND c.relpersistence != <span class="hljs-string">'t'</span><font></font>
AND i.indisready AND i.indisvalid;<font></font>
EOF<font></font>
chown postgres: /tmp/amcheck.sql<font></font>
<font></font>
<span class="hljs-comment">#          </span>
<span class="hljs-comment"># (       – )</span><font></font>
cat &gt; /tmp/run_amcheck.sh &lt;&lt; EOF<font></font>
<span class="hljs-keyword">for</span> DBNAME <span class="hljs-keyword">in</span> \$(su - postgres -c <span class="hljs-string">'psql -q -A -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" '</span>)
<span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Database: \${DBNAME}"</span>
    su - postgres -c <span class="hljs-string">"psql -f /tmp/amcheck.sql -v 'ON_ERROR_STOP=1' \${DBNAME}"</span> &amp;&amp; EXIT_STATUS=\$? || EXIT_STATUS=\$?
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"\${EXIT_STATUS}"</span> -ne 0 ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"amcheck failed on DB: \${DBNAME}"</span>
        <span class="hljs-built_in">exit</span> 125
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span><font></font>
EOF<font></font>
chmod +x /tmp/run_amcheck.sh<font></font>
<font></font>
<span class="hljs-comment">#  </span><font></font>
/tmp/run_amcheck.sh &gt; /tmp/amcheck.log<font></font>
<font></font>
<span class="hljs-comment">#         exit code  grep’ </span>
<span class="hljs-keyword">if</span> grep <span class="hljs-string">'amcheck failed'</span> <span class="hljs-string">"/tmp/amcheck.log"</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'amcheck failed: '</span><font></font>
    cat /tmp/amcheck.log<font></font>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zusammenfassen</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich danke Andrei Borodin für die Hilfe bei der Vorbereitung der Veröffentlichung und bedanke mich ganz besonders für seinen Beitrag zur Entwicklung von WAL-G! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Sinne ging es zu Ende. </font><font style="vertical-align: inherit;">Ich hoffe, dass ich die einfache Einrichtung und das enorme Potenzial für die Verwendung dieses Tools in Ihrem Unternehmen vermitteln konnte. </font><font style="vertical-align: inherit;">Ich habe viel über WAL-G gehört, aber ich hatte nicht genug Zeit, mich hinzusetzen und es herauszufinden. </font><font style="vertical-align: inherit;">Und nachdem ich es zu Hause vorgestellt hatte, kam dieser Artikel aus mir heraus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unabhängig davon ist anzumerken, dass WAL-G auch mit den folgenden DBMS arbeiten kann:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL / MariaDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FoundationDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Und nach den Commits zu urteilen - ein paar mehr werden erwartet!</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de506594/index.html">Redis Best Practices, Teil 3</a></li>
<li><a href="../de506598/index.html">Microsoft: Rust является 'лучшим шансом' в отрасли программирования безопасных систем</a></li>
<li><a href="../de506600/index.html">Der Auftrag zur Entwicklung des Standortes im Hinblick auf das Projektmanagement (Theorie + Stichprobe)</a></li>
<li><a href="../de506604/index.html">Parallelität und Effizienz: Python vs FSM</a></li>
<li><a href="../de506606/index.html">PIXI.js Clicker-Erstellung</a></li>
<li><a href="../de506612/index.html">So erhöhen Sie die Vollständigkeit umfangreicher Online-Kurse</a></li>
<li><a href="../de506620/index.html">Kreatives Denken: Was es ist, wie Sie Ihr Potenzial messen und steigern können</a></li>
<li><a href="../de506624/index.html">FOSS News Nr. 20 - Überprüfung der kostenlosen und Open Source-Nachrichten für den 8. bis 14. Juni 2020</a></li>
<li><a href="../de506626/index.html">Kamailio SBC oder nicht SBC?</a></li>
<li><a href="../de506628/index.html">Die Zusammenfassung interessanter Materialien für den mobilen Entwickler # 348 (vom 8. bis 14. Juni)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>