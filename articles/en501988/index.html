<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèΩ üÜî ü§Ωüèæ How does the VK message screen render? ‚û∞ üë© üê∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is VK doing to reduce rendering lags? How to display a very large message and not kill UiThread? How to reduce scrolling delays in RecyclerView? ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How does the VK message screen render?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vk/blog/501988/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is VK doing to reduce rendering lags? </font><font style="vertical-align: inherit;">How to display a very large message and not kill UiThread? </font><font style="vertical-align: inherit;">How to reduce scrolling delays in RecyclerView? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vs/2s/jg/vs2sjg1iyfq7cdkohrmgpuy5mla.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My experience is based on the work of drawing a message screen in the VK Android application, in which it is necessary to show a huge amount of information with a minimum of brakes on the UI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have been programming for Android for almost ten years, I was previously freelance for PHP / Node.js. </font><font style="vertical-align: inherit;">Now - a senior Android developer VKontakte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Under the cut - video and transcript of my report from the Mobius 2019 Moscow conference.</font></font><a name="habracut"></a><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/GZkTwgetUWI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The report reveals three topics</font></font></h2><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Standard solutions are the basic principles of how the VK message screen works. </font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non-standard solutions are little-known or original solutions that allow minimizing UI lags.</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alternatives are about various libraries and implementations, as well as why VK developers did not use them.</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Look at the screen:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/he/h2/xj/heh2xjq-ij5pnzsu49cf11uuabu.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This message is somewhere on five screens. </font><font style="vertical-align: inherit;">And they may well be with us (in the case of forwarding messages). </font><font style="vertical-align: inherit;">Standard tools will no longer work. </font><font style="vertical-align: inherit;">Even on a top device, everything can lag. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, in addition to this, the UI itself is quite diverse:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loading dates and indicators,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service messages</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">text (emoji, link, email, hashtags),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot keyboard</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ 40 ways to display attachments,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tree of forwarded messages.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The question arises: how to make the number of lags as small as possible? </font><font style="vertical-align: inherit;">Both in the case of simple messages, and in the case of bulk messages (edge-case from the video above).</font></font><br>
<a name="ordinary"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Standard Solutions</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecyclerView and its add-ons</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are various add-ons for RecyclerView.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setHasFixedSize ( </font></font><code>boolean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many people think that this flag is needed when the list items are the same size. </font><font style="vertical-align: inherit;">But in fact, judging by the documentation, the opposite is true. </font><font style="vertical-align: inherit;">This is when the size of the RecyclerView is constant and independent of the elements (roughly, not wrap_content). </font><font style="vertical-align: inherit;">Setting the flag helps to slightly increase the speed of the RecyclerView so that it avoids unnecessary calculations.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setNestedScrollingEnabled ( </font></font><code>boolean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Minor optimization that disables NestedScroll support. </font><font style="vertical-align: inherit;">We do not have CollapsingToolbar or other features depending on NestedScroll on this screen, so we can safely set this flag to false.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setItemViewCacheSize ( </font></font><code>cache_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setting up the internal RecyclerView cache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many people think that the mechanics of RecyclerView are:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there is a ViewHolder displayed on the screen;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there is a RecycledViewPool storing ViewHolder;</font></font></li>
<li> ViewHolder    ‚Äî    RecycledViewPool.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In practice, everything is a little more complicated, because there is an intermediate cache between these two things. </font><font style="vertical-align: inherit;">It is called ItemViewCache. </font><font style="vertical-align: inherit;">What is its essence? </font><font style="vertical-align: inherit;">When the ViewHolder leaves the screen, it is not placed in the RecycledViewPool, but in the intermediate cache (ItemViewCache). </font><font style="vertical-align: inherit;">All changes in the adapter apply to both the visible ViewHolder and the ViewHolder inside the ItemViewCache. </font><font style="vertical-align: inherit;">And for the ViewHolder inside the RecycledViewPool, the changes are not applied. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Through setItemViewCacheSize we can set the size of this intermediate cache. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The larger it is, the faster the scroll will be over short distances, but the update operations will take longer (due to ViewHolder.onBind, etc.). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How RecyclerView is implemented and how its cache is structured is a rather large and complex topic. </font><font style="vertical-align: inherit;">You can read a great </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, where they talk in detail about everything.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimization OnCreate / OnBind</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another classic solution is to optimize onCreateViewHolder / onBindViewHolder:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">easy layout (we try to use FrameLayout or Custom ViewGroup as much as possible),</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heavy operations (parsing links / emoji) are done asynchronously at the stage of message loading,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">StringBuilder for formatting name, date, etc.,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and other solutions that reduce the working time of these methods.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tracking Adapter.onFailedToRecyclerView ()</font></font></h3><br>
<img src="https://habrastorage.org/webt/8l/eo/1n/8leo1nki7gxrit4wg8mhhv0q3ua.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You have a list in which some elements (or part of them) are animated with alpha. </font><font style="vertical-align: inherit;">At the moment when View, being in the process of animation, leaves the screen, then it does not go to RecycledViewPool. </font><font style="vertical-align: inherit;">Why? </font><font style="vertical-align: inherit;">RecycledViewPool sees that the View is now animated by the View.hasTransientState flag, and simply ignores it. </font><font style="vertical-align: inherit;">Therefore, the next time you scroll up and down, the picture will not be taken from RecycledViewPool, but will be created anew. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most correct decision is when ViewHolder leaves the screen, you need to cancel all animations. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-7/1r/rh/-71rrhbw5idwburnf60gtfllcau.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you need a hotfix as soon as possible or you are a lazy developer, then in the onFailedToRecycle method you can simply always return true and everything will work, but I would not advise doing so.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iu/se/ha/iusehamefbgzcvc6miixbtfmfoy.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tracking Overdraw and Profiler</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The classic way to detect problems is overdraw and profiler tracking. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Overdraw - the number of redraws of the pixel: the fewer layers and the less redraw the pixel, the faster. But according to my observations, in modern realities, this does not so much affect performance. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0h/-d/fh/0h-dfhogberhs_hsy1eseaexkwa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Profiler - aka Android Monitor, which is in Android Studio. In it, you can analyze all the called methods. For example, open messages, scroll up and down and see which methods were called and how long they took. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/la/wy/dzlawyqmpqtzxbnpcbezvfoq_ww.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All that is in the left half are the Android system calls that are needed to create / render a View / ViewHolder. We either can‚Äôt influence them, or we will need to spend a lot of effort. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The right half is our code that runs in ViewHolder.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The call block at number 1 is a call to regular expressions: somewhere they overlooked and forgot to transfer the operation to the background thread, thereby slowing the scroll by ~ 20%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Call block at number 2 - Fresco, a library for displaying pictures. </font><font style="vertical-align: inherit;">It is not optimal in some places. It is not yet clear what to do with this lag, but if we can solve it, we will save another ~ 15%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, fixing these problems, we can get an increase of ~ 35%, which is pretty cool.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diffiff</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many of you use DiffUtil in its standard form: there are two lists - called, compared and pushed changes. Doing all this on the main thread is a bit expensive because the list can be very large. So usually DiffUtil computation runs on a background thread. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ListAdapter and AsyncListDiffer do this for you. The ListAdapter extends the regular Adapter and starts everything asynchronously - just make a submitList and the entire calculation of the changes flies to the internal background thread. The ListAdapter can take into account the case of frequent updates: if you call it three times in a row, it will take only the last result.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DiffUtil itself we use only for some structural changes - the appearance of the message, its change and deletion. </font><font style="vertical-align: inherit;">For some quick-change data, it is not suitable. </font><font style="vertical-align: inherit;">For example, when we upload a photo or play audio. </font><font style="vertical-align: inherit;">Such events occur often - several times per second, and if you run DiffUtil each time, you will get a lot of extra work.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Animations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once upon a time there was an Animation framework - rather meager, but still something. </font><font style="vertical-align: inherit;">We worked with him like this:</font></font><br>
<br>
<pre><code class="java hljs">view.startAnimation(TranslateAnimation(fromX = <span class="hljs-number">0</span>, toX = <span class="hljs-number">300</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem is that the getTranslationX () parameter will return the same value before and after the animation. </font><font style="vertical-align: inherit;">This is because Animation changed the visual representation, but did not change the physical properties. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/f0/uu/tw/f0uutwhihhopkcfvps8itszyt_a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Android 3.0, the Animator framework appeared, which is more correct because it changed the specific physical property of the object. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q2/ib/qy/q2ibqywrlcla5cxqpslznxbxxm0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Later, ViewPropertyAnimator appeared and everyone still does not really understand its difference from Animator. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will explain. </font><font style="vertical-align: inherit;">Let's say you need to do the translation diagonally - shift the View along the x, y axes. </font><font style="vertical-align: inherit;">Most likely you would write typical code:</font></font><br>
<br>
<pre><code class="java hljs">val animX = ObjectAnimator.ofFloat(view, ‚ÄútranslationX‚Äù, <span class="hljs-number">100f</span>)<font></font>
val animY = ObjectAnimator.ofFloat(view, ‚ÄútranslationY‚Äù, <span class="hljs-number">200f</span>)<font></font>
AnimatorSet().apply {<font></font>
    playTogether(animX, animY)<font></font>
    start()<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And you can make it shorter:</font></font><br>
<br>
<pre><code class="java hljs">view.animate().translationX(<span class="hljs-number">100f</span>).translationY(<span class="hljs-number">200f</span>) </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you execute view.animate (), you implicitly launch ViewPropertyAnimator. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why is it needed?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Easier to read and maintain code.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Batch operations animation.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our last case, we changed two properties. When we do this through animators, animation ticks will be called separately for each Animator. That is, setTranslationX and setTranslationY will be called separately, and View will perform update operations separately. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of ViewPropertyAnimator, the change occurs at the same time, so there is a savings due to fewer operations and the change in properties itself is better optimized.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can achieve this with Animator, but you will have to write more code. </font><font style="vertical-align: inherit;">In addition, using ViewPropertyAnimator, you can be sure that the animations will be optimized as much as possible. </font><font style="vertical-align: inherit;">Why? </font><font style="vertical-align: inherit;">Android has a RenderNode (DisplayList). </font><font style="vertical-align: inherit;">Very roughly, they cache the result of onDraw and use it when redrawing. </font><font style="vertical-align: inherit;">ViewPropertyAnimator works directly with RenderNode and applies animations to it, avoiding onDraw calls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many View properties can also directly affect the RenderNode, but not all. </font><font style="vertical-align: inherit;">That is, when using ViewPropertyAnimator, you are guaranteed to use the most efficient way. </font><font style="vertical-align: inherit;">If you suddenly have some kind of animation that cannot be done with ViewPropertyAnimator, then maybe you should think about it and change it.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Animations: TransitionManager</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usually, people associate that this framework is used to move from one Activity to another. In fact, it can be used differently and greatly simplify the implementation of the animation of structural changes. Suppose we have a screen on which a voice message plays. We close it with a cross, and the die goes up. How to do it? The animation is quite complicated: the player closes with alpha, while moving not through translation, but changes its height. At the same time, our list goes up and also changes the height. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mv/ff/kh/mvffkhe5udzkypeumimmusvhiig.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the player were part of the list, then the animation would be quite simple. But with us the player is not an element of the list, but a completely independent View.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps we would start writing some kind of Animator, then we would encounter problems, crashes, start sawing crutches and double the code. </font><font style="vertical-align: inherit;">And would get something like the screen below. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wd/0d/k-/wd0dk-urz2lfr6xugvvpmp16rdk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With TransitionManager, you can make everything simpler:</font></font><br>
<br>
<pre><code class="java hljs">TransitionManager.beginDelayedTransition(<font></font>
        viewGroup = &lt;LinearLayoutManager&gt;,<font></font>
        transition = AutoTransition())<font></font>
playerView.visibility = View.GONE</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All animation happens automatically under the hood. </font><font style="vertical-align: inherit;">It looks like magic, but if you go deeper inside and see how it works, it turns out that the TransitionManager simply subscribes to all View, catches the changes in their properties, calculates diff, creates the necessary animators or ViewPropertyAnimator where necessary, and does everything as efficiently as possible. </font><font style="vertical-align: inherit;">TransitionManager allows us to make animations in the message section quick and easy to implement.</font></font><a name="extrodinary"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Custom solutions</font></font></h2><br>
<img src="https://habrastorage.org/webt/u2/rx/ji/u2rxjicmid-zkuhvqsxc4kxbeem.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the most fundamental thing on which performance and the problems that follow are based. What to do when your message is on 10 screens? If you pay attention, then all of our elements are located exactly under each other. If we accept that ViewHolder is not one message, but dozens of different ViewHolders, then everything becomes much simpler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs not a problem for us that the message has become 10 screens, because now we display only six ViewHolders in a concrete example. We got an easy layout, the code is easier to maintain, and there are no special problems, except for one - how to do this?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/gh/ui/hoghuifbuntyzu3uszyjr6vij_0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are simple ViewHolders - these are classic date separators, Load more, and so on. </font><font style="vertical-align: inherit;">And BaseViewHolder - conditionally basic ViewHolder for the message. </font><font style="vertical-align: inherit;">It has a basic implementation and several specific ones - TextViewHolder, PhotoViewHolder, AudioViewHolder, ReplyViewHolder and so on. </font><font style="vertical-align: inherit;">There are about 70 of them.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is BaseViewHolder responsible for?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BaseViewHolder is only responsible for drawing the avatar and the desired piece of bubble, as well as the line for forwarded messages - blue to the left. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6o/yh/ia/6oyhiaag8f94wm6s69vskpv6r4u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The concrete implementation of the content is already carried out by other BaseViewHolder heirs: TextViewHolder displays only text, FwdSenderViewHolder - the author of the forwarded message, AudioMsgViewHolder - the voice message, and so on. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/th/wi/sdthwihnbm9jm4xehrbh4mmrv20.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a problem: what to do with the width? Imagine a message on at least two screens. It is not very clear what width to set, because half is visible, half is not visible (and has not even been created yet). Absolutely everything cannot be measured, because it lays. I have to crutch a little, alas. There are simple cases when the message is very simple: purely text or voice - in general, consists of one Item.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_q/i0/ov/_qi0ovd7qibtvqzcya0tzv_o4vq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, use the classic wrap_content. </font><font style="vertical-align: inherit;">For a complex case, when a message consists of several pieces, we take and force each ViewHolder a fixed width. </font><font style="vertical-align: inherit;">Specifically here - 220 dp. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yi/fa/5t/yifa5tx6chfyxf2c26zeak-kaeu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the text is very short and the message is forwarded, there is an empty space on the right. </font><font style="vertical-align: inherit;">There is no escape from this, because performance is more important. </font><font style="vertical-align: inherit;">For several years, there were no complaints - maybe someone noticed, but in general, everyone got used to it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qb/mz/0l/qbmz0lzz-o_lvhongodanb3fh1m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are edge cases. </font><font style="vertical-align: inherit;">If we respond to a message with a sticker, then we can specify the width specifically for such a case, so that it looks prettier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We split into ViewHolders at the stage of loading messages: we start the background loading of the message, convert it to item, they are directly displayed in ViewHolders.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/12/w_/x7/12w_x7wp4a4a4s5f_dqeqrevlbc.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Global RecycledViewPool</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The mechanics of using our messenger are such that people do not sit in the same chat, but constantly go between them. </font><font style="vertical-align: inherit;">In the standard approach, when we went into the chat and left it, the RecycledViewPool (and the ViewHolder in it) are simply destroyed, and every time we spend resources creating the ViewHolder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This can be solved by global RecycledViewPool:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">within the framework of Application, RecycledViewPool lives as a singleton;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reused on the message screen when the user walks between screens;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set as RecyclerView.setRecycledViewPool (pool).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are pitfalls, it is important to remember two things:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you go to the screen, click back, exit. </font><font style="vertical-align: inherit;">The problem is that those ViewHolders that were on the screen are thrown away, and not returned to the pool. </font><font style="vertical-align: inherit;">This is fixed as follows:</font></font><br>
<pre><code class="java hljs">LinearLayoutManager.recycleChildrenOnDetach = <span class="hljs-keyword">true</span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RecycledViewPool has limitations: no more than five ViewHolders can be stored for each ViewType.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If 9 TextViews are displayed on the screen, only five items will be returned to the RecycledViewPool, and the rest will be thrown away. </font><font style="vertical-align: inherit;">You can change the size of the RecycledViewPool: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RecycledViewPool.setMaxRecycledViews (viewType, size) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But it‚Äôs kind of sad to write on each ViewType with your hands, because you can write your RecycledViewPool, expanding the standard one, and make it NoLimit. </font><font style="vertical-align: inherit;">By the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can download the finished implementation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DiffUtil is not always useful</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is a classic case - download, playing an audio track and voice message. </font><font style="vertical-align: inherit;">In this case, DiffUtil calls spam. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ho/3o/lt/ho3oltgo6763hgc65xxel-ccopa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our BaseViewHolder has an abstract updateUploadProgress method.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseViewHolder</span> : <span class="hljs-title">ViewHolder</span> </span>{<font></font>
    ‚Ä¶<font></font>
    <span class="hljs-function">fun <span class="hljs-title">updateUploadProgress</span><span class="hljs-params">(attachId: Int, progress: Float)</span>
    ‚Ä¶        
}
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To throw an event, we need to bypass all visible ViewHolder:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">fun <span class="hljs-title">onUploadProgress</span><span class="hljs-params">(attachId: Int, progress: Float)</span> </span>{<font></font>
    forEachActiveViewHolder {<font></font>
        it.updateUploadProgress(attachId, progress)<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a simple operation, it is unlikely that we will have more than ten ViewHolder on the screen. </font><font style="vertical-align: inherit;">Such an approach cannot lag in principle. </font><font style="vertical-align: inherit;">How to find visible ViewHolder? </font><font style="vertical-align: inherit;">A naive implementation would be something like this:</font></font><br>
<br>
<pre><code class="java hljs">val firstVisiblePosition = &lt;...&gt;<font></font>
val lastVisiblePosition = &lt;...&gt;<font></font>
<span class="hljs-keyword">for</span> (i in firstVisiblePosition.. lastVisiblePosition) {<font></font>
    val viewHolder = recycler.View.findViewHolderForAdapterPosition(i)<font></font>
    viewHolder.updateUploadProgress(..)<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there's a problem. </font><font style="vertical-align: inherit;">The intermediate cache that I mentioned earlier, ItemViewCache, contains active ViewHolders that simply do not appear on the screen. </font><font style="vertical-align: inherit;">The code above will not affect them. </font><font style="vertical-align: inherit;">Directly, we too cannot address them. </font><font style="vertical-align: inherit;">And then crutches come to our aid. </font><font style="vertical-align: inherit;">Create a WeakSet that stores links to ViewHolder. </font><font style="vertical-align: inherit;">Further it is enough for us to simply bypass this WeakSet.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Adapter</span> : <span class="hljs-title">RecyclerView</span>.<span class="hljs-title">Adapter</span> </span>{<font></font>
    val activeViewHolders = WeakSet&lt;ViewHolder&gt;()<font></font>
        <font></font>
    <span class="hljs-function">fun <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: ViewHolder, position: Int)</span> </span>{<font></font>
        activeViewHolders.add(holder)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function">fun <span class="hljs-title">onViewRecycled</span><span class="hljs-params">(holder: ViewHolder)</span> </span>{<font></font>
        activeViewHolders.remove(holder)<font></font>
    }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ViewHolder Overlay</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the example of stories. Previously, if a person reacted to a story with a sticker, we displayed it like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rc/kd/z1/rckdz16ebmfwftxzfpql2lwmsko.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks pretty ugly. I wanted to do better, because the stories are bright content, and we have a small square there. We wanted to get something like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vj/ma/51/vjma51z9m4eqwlhiagc7xvu2kg0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a problem: our message is broken into ViewHolder, they are located strictly under each other, but here they overlap. Immediately it is not clear how to solve this. You can create another ViewType ‚Äúhistory + sticker‚Äù or ‚Äúhistory + voice message‚Äù. So, instead of 70 ViewType, we would have 140 ... No, we need to come up with something more convenient.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/01/mr/5j/01mr5jqsfdpq_zcq4s3b-vf9pyq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of your favorite crutches in Android comes to mind. </font><font style="vertical-align: inherit;">For example, we were doing something, but Pixel Perfect doesn‚Äôt converge. </font><font style="vertical-align: inherit;">To fix this, you need to delete everything and write from scratch, but laziness. </font><font style="vertical-align: inherit;">As a result, we can make margin = -2dp (negative), and now everything falls into place. </font><font style="vertical-align: inherit;">But just such an approach cannot be used here. </font><font style="vertical-align: inherit;">If you set a negative margin, the sticker will move, but the place it occupied will remain empty. </font><font style="vertical-align: inherit;">But we have ItemDecoration, where itemOffset we can make a negative number. </font><font style="vertical-align: inherit;">And it works! </font><font style="vertical-align: inherit;">As a result, we get the expected overlay and at the same time there remains a paradigm where each ViewHolder is friend. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A beautiful solution in one line.</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OffsetItemDecoration</span> : <span class="hljs-title">RecyclerViewItemDecoration</span>() </span>{
    <span class="hljs-function">overrride fun <span class="hljs-title">getItemOffsets</span><span class="hljs-params">(offset: Rect, ‚Ä¶)</span> </span>{<font></font>
        offset.top = -<span class="hljs-number">100</span>dp<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Idlehandler</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a case with an asterisk, it is complex and not so often needed in practice, but it is important to know about the existence of such a method. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, I‚Äôll tell you how the main UiThread thread works. The general scheme: there is a tasks event queue in which tasks are set through handler.post, and an infinite loop that goes through this queue. That is, UiThread is just while (true). If there are tasks, we execute them, if not, we wait until they appear.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y3/ee/nn/y3eennjezxs29i4lkbvggnqkgjw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our usual realities, Handler is responsible for putting tasks into the queue, and Looper endlessly bypasses the queue. </font><font style="vertical-align: inherit;">There are tasks that are not very important for the UI. </font><font style="vertical-align: inherit;">For example, a user read a message - it is not so important for us when we display it on the UI, right now or after 20 ms. </font><font style="vertical-align: inherit;">The user will not notice the difference. </font><font style="vertical-align: inherit;">Then, perhaps it is worth running this task on the main thread only when it is free? </font><font style="vertical-align: inherit;">That is, it would be nice for us to know when the awaitNewTask line is called. </font><font style="vertical-align: inherit;">For this case, Looper has an addIdleHandler that fires when the tasks.isEmpty code fires. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looper.myQueue (). AddIdleHandler ()</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
And then the simplest implementation of IdleHandler will look like this:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@AnyThread</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IdleHandler</span> </span>{
    <span class="hljs-keyword">private</span> val handler = Handler(Looper.getMainLooper())<font></font>
<font></font>
    <span class="hljs-function">fun <span class="hljs-title">post</span><span class="hljs-params">(task: Runnable)</span> </span>{<font></font>
        handler.post {<font></font>
            Looper.myQueue().addIdleHandler {<font></font>
                task.run()<font></font>
                <span class="hljs-keyword">return</span><span class="hljs-meta">@addIdleHandler</span> <span class="hljs-keyword">false</span><font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the same way, you can measure an honest cold start of the application.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emoji</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We use our custom emoji instead of system ones. Here is an example of how emojis looked on different platforms in different years. The left and right emoji are pretty nice, but in the middle ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bv/71/m3/bv71m3d7rginefvtev6ogcgwess.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a second problem: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dw/-1/nx/dw-1nxxjfpggaxcjo_-idb0ofce.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each row is the same emoji, but the emotions they reproduce are different. I like the bottom right most, I still don't understand what it means. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a bike from VKontakte. In ~ 2014, we slightly changed one emoji. Maybe someone remembers - "Marshmallow" was. After his change, a mini-riot began. Of course, he did not reach the ‚Äúreturn the wall‚Äù level, but the reaction was quite interesting. And this tells us about the importance of interpreting emoji.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How emojis are made: we have a big bitmap, where they are all assembled in one big ‚Äúatlas‚Äù. </font><font style="vertical-align: inherit;">There are several of them - under different DPI. </font><font style="vertical-align: inherit;">And there is an EmojiSpan that contains information: I draw "such-and-such" emoji, it is in such-and-such a bitmap at such-and-such location (x, y). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And there is a ReplacementSpan that allows you to display something instead of text under Span. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, you find emoji in the text, wrap it with EmojiSpan, and the system draws the desired emoji instead of the system one.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ag/y5/tq/agy5tq5wl0ys8vbwuqgwhpfeoli.png"><a name="alt"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alternatives</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inflate</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Someone may say that since inflate is slow, why not just create layout with your hands, avoiding inflate. </font><font style="vertical-align: inherit;">And thereby speed up everything by avoiding the 100500 ViewHolder. </font><font style="vertical-align: inherit;">It's a delusion. </font><font style="vertical-align: inherit;">Before you do something, it is worth measuring it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Android has a Debug class, it has startMethodTracing and stopMethodTracing.</font></font><br>
<br>
<pre><code class="java hljs">Debug.startMethodTracing(‚Äútrace¬ª)<font></font>
inflate(...)<font></font>
Debug.stopMethodTracing()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It will allow us to collect information about the execution time of a particular piece of code. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ea/hz/wa/eahzwatykq-cflwr2ul3qnwbvq4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we see that here inflate as such is even invisible. </font><font style="vertical-align: inherit;">A quarter of the time was spent loading drawable, a quarter was loading colors. </font><font style="vertical-align: inherit;">And only somewhere in the etc part is our inflate. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I tried to translate the XML layout into code and saved somewhere around 0.5 ms. </font><font style="vertical-align: inherit;">The increase, in fact, is not the most impressive. </font><font style="vertical-align: inherit;">And the code has become much more complicated. </font><font style="vertical-align: inherit;">That is, rewriting does not make much sense.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moreover, in practice, many will not encounter this problem at all, because a long inflate usually occurs only when the application becomes very large. </font><font style="vertical-align: inherit;">In our VKontakte application, for example, there are approximately 200-300 different screens, and loading of all resources crashes. </font><font style="vertical-align: inherit;">What to do with this is still unclear. </font><font style="vertical-align: inherit;">Most likely, you will have to write your own resource manager.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anko</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anko has recently become deprecated. </font><font style="vertical-align: inherit;">Anyway, Anko is not magic, but simple syntactic sugar. </font><font style="vertical-align: inherit;">It translates everything to the conditional new View () in the same way. </font><font style="vertical-align: inherit;">Therefore, there is no benefit from Anko.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Litho / Flutter</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why did I combine two completely unrelated things? </font><font style="vertical-align: inherit;">Because this is not about technology, but about the complexity of migration to it. </font><font style="vertical-align: inherit;">You can‚Äôt just borrow and move to a new library. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is unclear whether this will give us a performance boost. </font><font style="vertical-align: inherit;">And will we not get new problems, because millions of people with completely different devices use our application every minute (you probably haven‚Äôt even heard about a quarter of them). </font><font style="vertical-align: inherit;">Moreover, messages are a very large code base. </font><font style="vertical-align: inherit;">It is impossible to rewrite everything instantly. </font><font style="vertical-align: inherit;">And doing it because of the hype of technology is stupid. </font><font style="vertical-align: inherit;">Especially when the Jetpack Compose looms somewhere far away.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jetpack compose</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google all promises us manna from heaven in the form of this library, but it is still in alpha. </font><font style="vertical-align: inherit;">And when it will be in the release - it is not clear. </font><font style="vertical-align: inherit;">Whether we can get it in its current form is also unclear. </font><font style="vertical-align: inherit;">It‚Äôs too early to experiment. </font><font style="vertical-align: inherit;">Let it come out in stable, let the main bugs close. </font><font style="vertical-align: inherit;">And only then will we look in his direction.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One Large Custom View</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is another approach that those who use various instant messengers talk about: "take and write one large Custom View, no complicated hierarchy." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What are the disadvantages?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It‚Äôs hard to maintain.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It does not make sense in current realities.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With Android 4.3, the internal caching system inside View was pumped. </font><font style="vertical-align: inherit;">For example, onMeasure is not called if the View has not changed. </font><font style="vertical-align: inherit;">And the results of the previous measurement are used. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With Android 4.3-4.4, a RenderNode (DisplayList) appeared, caching rendering. </font><font style="vertical-align: inherit;">Let's look at an example. </font><font style="vertical-align: inherit;">Suppose there is a cell in the list of dialogs: avatar, title, subtitle, read status, time, another avatar. </font><font style="vertical-align: inherit;">Conditionally - 10 elements. </font><font style="vertical-align: inherit;">And we wrote Custom View. </font><font style="vertical-align: inherit;">In this case, when changing one property, we will re-measure all the elements. </font><font style="vertical-align: inherit;">That is, just spend the extra resources. </font><font style="vertical-align: inherit;">In the case of the ViewGroup, where each element is a separate View, when changing one View, we will invalidate only one View (except when this View affects the size of others).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Summary</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, you have learned that we use the classic RecyclerView with standard optimizations. There is a part of non-standard ones, where the most important and fundamental is splitting the message into ViewHolder. Of course, you can say that this is narrowly applicable, but this approach can also be projected onto other things, for example, on a large text of 10 thousand characters. It can be divided into paragraphs, where each paragraph is a separate ViewHolder. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs also worth maximizing everything on @WorkerThread: parsing links, DiffUtils - thereby unloading @UiThead as much as possible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The global RecycledViewPool allows you to walk between message screens and not create a ViewHolder each time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there are other important things that we have not yet decided, for example, a long inflate, or rather, loading data from resources.</font></font><br>
<br>
<blockquote>    ,   Mobius 2019 Piter  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>,     .     ,     ,  SQLite,     .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Mobius 2020 Piter</a>     .</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501978/index.html">How does the Prometheus histogram work?</a></li>
<li><a href="../en501980/index.html">The history of one project or how I created 7 years PBX based on Asterisk and Php</a></li>
<li><a href="../en501982/index.html">How to transfer a shader from a game engine to Substance Painter</a></li>
<li><a href="../en501984/index.html">What to see in quarantine? A selection of materials from Technostream (part 4)</a></li>
<li><a href="../en501986/index.html">Secrets of the incredible success of Apple AirPods</a></li>
<li><a href="../en501990/index.html">Useful post: 4 events to solve the problems of the second day in OpenShift and create operators</a></li>
<li><a href="../en501992/index.html">How to organize testing in order to accelerate and stabilize product releases. Part 1</a></li>
<li><a href="../en501994/index.html">Orchestrator for MySQL: why a fail-safe project cannot be built without it</a></li>
<li><a href="../en501996/index.html">Zen Go (Pocket Version)</a></li>
<li><a href="../en501998/index.html">Expensive price of styles. Yandex Report</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>