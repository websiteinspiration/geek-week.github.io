<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕙 🤛🏾 😄 Creación de Minecraft en una semana en C ++ y Vulkan ☝🏻 🐶 🥁</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Me propuse la tarea de recrear Minecraft desde cero en una semana usando mi propio motor en C ++ y Vulkan. Me inspiró Hopson , que hizo lo mismo con C...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Creación de Minecraft en una semana en C ++ y Vulkan</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487832/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Me propuse la tarea de recrear Minecraft desde cero en una semana usando mi propio motor en C ++ y Vulkan. </font><font style="vertical-align: inherit;">Me inspiró </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hopson</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que hizo lo mismo con C ++ y OpenGL. </font><font style="vertical-align: inherit;">A su vez, se inspiró en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shane Beck</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , quien se inspiró en Minecraft, cuya fuente de inspiración fue Infiniminer, cuya creación, presumiblemente, se inspiró en la minería real.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aa1/8b2/50c/aa18b250ce4120bd3a0dc94c01a63621.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El repositorio de GitHub para este proyecto está </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cada día tiene su propia etiqueta git. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, no planeé recrear literalmente Minecraft. </font><font style="vertical-align: inherit;">Se suponía que este proyecto era educativo. </font><font style="vertical-align: inherit;">Quería aprender a usar Vulkan en algo más complicado que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vulkan-tutorial.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o la demostración de Sasha Willem. </font><font style="vertical-align: inherit;">Por lo tanto, el énfasis principal está en el diseño del motor Vulkan, y no en el diseño del juego.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tareas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El desarrollo en Vulkan es mucho más lento que en OpenGL, por lo que no pude incorporar muchas de las características de este Minecraft en el juego. </font><font style="vertical-align: inherit;">No hay mobs, ni artesanías, ni piedra roja, ni física de bloques, etc. </font><font style="vertical-align: inherit;">Desde el principio, los objetivos del proyecto fueron los siguientes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear un sistema de representación del terreno</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trituración</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encendiendo</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear un sistema generador de terreno</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alivio</font></font></li>
</ul><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arboles</font></font></li>
</ul><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biomas</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregar la capacidad de cambiar el terreno y mover bloques</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Necesitaba encontrar una manera de implementar todo esto sin agregar una GUI al juego, porque no pude encontrar ninguna biblioteca de GUI que funcionara con Vulkan y fuera fácil de integrar.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bibliotecas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, no iba a escribir una aplicación Vulkan desde cero. </font><font style="vertical-align: inherit;">Para acelerar el proceso de desarrollo, utilizaré bibliotecas listas siempre que sea posible. </font><font style="vertical-align: inherit;">A saber:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VulkanWrapper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : mi propio contenedor de C ++ para la API de Vulkan</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLFW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para ventanas y entrada del usuario</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VulkanMemoryAllocator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para asignar memoria Vulkan</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GLM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para vectores matemáticos y matrices</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para señales / slots y ECS</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : para utilidades de carga de imágenes</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FastNoise</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : para generar ruido 3D</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Día 1</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer día, preparé una caldera Vulkan y un esqueleto del motor. </font><font style="vertical-align: inherit;">La mayor parte del código era repetitivo y podía copiarlo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vulkan-tutorial.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">También incluyó un truco con el almacenamiento de datos de vértices como parte de un sombreador de vértices. </font><font style="vertical-align: inherit;">Esto significaba que ni siquiera tenía que ajustar la asignación de memoria. </font><font style="vertical-align: inherit;">Solo un transportador simple que solo puede hacer una cosa: dibujar un triángulo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El motor es lo suficientemente simple como para soportar el renderizador de triángulos. </font><font style="vertical-align: inherit;">Tiene una ventana y un bucle de juego al que se pueden conectar los sistemas. </font><font style="vertical-align: inherit;">La GUI está limitada por la velocidad de fotogramas que se muestra en el título de la ventana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El proyecto se divide en dos partes: </font></font><code>VoxelEngine</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>VoxelGame</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/875/3cd/190/8753cd190975239ad550e8c0c8b27d00.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dia 2</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Integré la biblioteca Vulkan Memory Allocator. </font><font style="vertical-align: inherit;">Esta biblioteca se encarga de la mayor parte de la plantilla de asignación de memoria de Vulkan: tipos de memoria, montones de memoria del dispositivo y asignación secundaria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora que tenía una asignación de memoria, creé clases para mallas y búferes de vértices. </font><font style="vertical-align: inherit;">Cambié el renderizador de los triángulos para que use la clase de mallas, y no las matrices integradas en el sombreador. </font><font style="vertical-align: inherit;">Actualmente, los datos de malla se transfieren a la GPU renderizando manualmente los triángulos.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/627/28d/0fc/62728d0fce9015f2be4dad88f18c7b7a.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poco ha cambiado</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Día 3</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agregué un sistema de representación gráfica. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta publicación se</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tomó como base para crear esta clase </font><font style="vertical-align: inherit;">, pero la clase está muy simplificada. Mi gráfico de representación contiene solo los elementos esenciales para manejar la sincronización con Vulkan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El gráfico de renderizado me permite establecer </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nodos</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bordes</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Los nodos son el trabajo realizado por la GPU. Las costillas son dependencias de datos entre nodos. Cada nodo recibe su propio búfer de instrucciones, en el que escribe. El gráfico está involucrado en búferes de comando de almacenamiento en búfer doble y sincronizándolos con fotogramas anteriores. Los bordes se utilizan para insertar automáticamente barreras transportadoras antes y después de que un nodo escriba en cada búfer de instrucciones. Las barreras de tubería sincronizan el uso de todos los recursos y transfieren la propiedad entre colas. Además, los bordes insertan semáforos entre nodos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los nodos y los bordes forman un </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gráfico acíclico dirigido</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Luego, el gráfico de representación realiza la </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clasificación topológica.</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nodos, lo que lleva a la creación de una lista plana de nodos ordenados para que cada nodo vaya después de todos los nodos de los que depende. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El motor tiene tres tipos de nodos. </font></font><code>AcquireNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recibe una imagen de una cadena de búfer (cadena de intercambio), </font></font><code>TransferNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transfiere datos de la CPU a la GPU y </font></font><code>PresentNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proporciona una imagen de una cadena de búfer para mostrar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada nodo puede implementar </font></font><code>preRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>render</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>postRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que se ejecutan en cada marco. </font></font><code>AcquireNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtiene una imagen de una cadena de buffers durante </font></font><code>preRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>PresentNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proporciona esta imagen a tiempo </font></font><code>postRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Refactoré el renderizador de triángulos para que use un sistema de representación gráfica, en lugar de procesar todo yo mismo. Hay un borde entre </font></font><code>AcquireNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font><code>TriangleRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">así como entre </font></font><code>TriangleRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>PresentNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Esto garantiza que la imagen de la cadena de búfer esté sincronizada correctamente durante su uso durante el marco.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/12b/d88/6ba/12bd886ba9b41891ae1e2d0ff47b9929.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juro que dentro del motor ha cambiado</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Día 4</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creé una cámara y un sistema de renderizado 3D. Hasta ahora, la cámara recibe su propio búfer persistente y grupo de descriptores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reduje la velocidad ese día porque estaba tratando de encontrar la configuración correcta para el renderizado 3D con Vulkan. La mayoría del material en línea se enfoca en renderizar usando OpenGL, que usa sistemas de coordenadas ligeramente diferentes de Vulkan. En OpenGL, el eje Z del espacio del clip se especifica como </font></font><code>[-1, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y el borde superior de la pantalla está en </font></font><code>Y = 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. En Vulkan, el eje Z se especifica como </font></font><code>[0, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y el borde superior de la pantalla está en </font></font><code>Y = -1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Debido a estas pequeñas diferencias, las matrices de proyección GLM estándar no funcionan correctamente porque están diseñadas para OpenGL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GLM tiene una opción</font></font><code>GLM_FORCE_DEPTH_ZERO_TO_ONE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, eliminando el problema con el eje Z. Después de eso, el problema con el eje Y puede eliminarse simplemente cambiando el signo del elemento de </font></font><code>(1, 1)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">matriz de proyección (GLM usa la indexación desde 0). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si volteamos el eje Y, entonces necesitamos voltear los datos del vértice, porque antes de eso, la dirección negativa del eje Y apuntaba hacia arriba.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8d9/05d/464/8d905d4643a189400471c7e8d4fbd3f6.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora en 3D!</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dia 5</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agregué la entrada del usuario y la capacidad de mover la cámara con el mouse. </font><font style="vertical-align: inherit;">El sistema de entrada es demasiado sofisticado, pero elimina las rarezas de la entrada GLFW. </font><font style="vertical-align: inherit;">En particular, tuve el problema de cambiar la posición del mouse mientras lo bloqueaba. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La entrada del teclado y el mouse es esencialmente una envoltura delgada en la parte superior de GLFW, abierta a través de controladores de señal </font></font><code>entt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo para comparar, casi lo mismo que Hopson hizo el día 1 de su proyecto.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Su navegador no admite video HTML5.</font></font><source src="https://vazgriz.com/wp-content/uploads/2020/01/voxels.webm" type="video/webm"></video></div></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Día 6</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencé a agregar código para generar y renderizar bloques voxel. </font><font style="vertical-align: inherit;">Escribir el código de malla fue fácil porque lo hice antes y conocía abstracciones que me permitieron cometer menos errores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una de las abstracciones fue una clase de plantilla </font></font><code>ChunkData&lt;T, chunkSize&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que define un cubo de tipo del </font></font><code>T</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tamaño </font></font><code>chunkSize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de cada lado. </font><font style="vertical-align: inherit;">Esta clase almacena datos en una matriz 1D y procesa datos de indexación con una coordenada 3D. </font><font style="vertical-align: inherit;">El tamaño de cada bloque es de 16 x 16 x 16, por lo que los datos internos son una matriz simple con una longitud de 4096. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otra abstracción es crear un iterador de posiciones que genere coordenadas de </font></font><code>(0, 0, 0)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font><code>(15, 15, 15)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Estas dos clases aseguran que las iteraciones con datos de bloque se realicen en un orden lineal para aumentar la localidad de caché. </font><font style="vertical-align: inherit;">La coordenada 3D aún está disponible para otras operaciones que la necesitan. </font><font style="vertical-align: inherit;">Por ejemplo:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (glm::ivec3 pos : Chunk::Positions()) {
    <span class="hljs-keyword">auto</span>&amp; data = chunkData[pos];<font></font>
    glm::ivec3 offset = ...;<font></font>
    <span class="hljs-keyword">auto</span>&amp; neighborData = chunkData[pos + offset];<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tengo varias matrices estáticas que especifican las compensaciones que se usan comúnmente en el juego. </font><font style="vertical-align: inherit;">Por ejemplo, </font></font><code>Neighbors6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define 6 vecinos con los que el cubo tiene caras comunes.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">array</span>&lt;glm::ivec3, 6&gt; Neighbors6 = {<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),    <span class="hljs-comment">//right</span>
        glm::ivec3(<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),   <span class="hljs-comment">//left</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),    <span class="hljs-comment">//top</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>),   <span class="hljs-comment">//bottom</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),    <span class="hljs-comment">//front</span>
        glm::ivec3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>)    <span class="hljs-comment">//back</span>
    };</code></pre><br>
<code>Neighbors26</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- todos estos son vecinos con los que el cubo tiene una cara, borde o vértice común. </font><font style="vertical-align: inherit;">Es decir, es una cuadrícula de 3x3x3 sin un cubo central. </font><font style="vertical-align: inherit;">También hay matrices similares para otros conjuntos de vecinos y para conjuntos de vecinos 2D. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay una matriz que define los datos necesarios para crear una cara del cubo. </font><font style="vertical-align: inherit;">Las direcciones de cada cara en esta matriz corresponden a las direcciones en la matriz </font></font><code>Neighbors6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">array</span>&lt;FaceArray, 6&gt; NeighborFaces = {
    <span class="hljs-comment">//right face</span><font></font>
    FaceArray {<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<font></font>
        glm::ivec3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),<font></font>
    },<font></font>
    ...<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias a esto, el código de creación de malla es muy simple. Simplemente omite los datos de los bloques y agrega una cara cuando el bloque es sólido, pero su vecino no lo es. El código simplemente verifica cada cara de cada cubo en un bloque. Esto es similar al método "ingenuo" descrito </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (glm::ivec3 pos : Chunk::Positions()) {<font></font>
    Block block = chunk.blocks()[pos];<font></font>
    <span class="hljs-keyword">if</span> (block.type == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; Chunk::Neighbors6.size(); i++) {<font></font>
        glm::ivec3 offset = Chunk::Neighbors6[i];<font></font>
        glm::ivec3 neighborPos = pos + offset;<font></font>
<font></font>
        <span class="hljs-comment">//<span class="hljs-doctag">NOTE:</span> bounds checking omitted</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> (chunk.blocks()[neighborPos].type == <span class="hljs-number">0</span>) {<font></font>
            Chunk::FaceArray&amp; faceArray = Chunk::NeighborFaces[i];<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> j = <span class="hljs-number">0</span>; j &lt; faceArray.size(); j++) {<font></font>
                m_vertexData.push_back(pos + faceArray[j]);<font></font>
                m_colorData.push_back(glm::i8vec4(pos.x * <span class="hljs-number">16</span>, pos.y * <span class="hljs-number">16</span>, pos.z * <span class="hljs-number">16</span>, <span class="hljs-number">0</span>));<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reemplacé </font></font><code>TriangleRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con </font></font><code>ChunkRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. También agregué un búfer de profundidad para que la malla de bloques pueda renderizarse correctamente. Era necesario agregar un borde más al gráfico de representación entre </font></font><code>TransferNode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>ChunkRenderer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Este borde transfiere la propiedad de los recursos de la familia de colas entre la cola de transferencia y la cola de gráficos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego cambié el motor para que pudiera manejar correctamente los eventos de cambio de ventana. En OpenGL, esto se hace de manera simple, pero bastante confusa en Vulkan. Dado que la cadena de buffers debe crearse explícitamente y tener un tamaño constante, cuando cambie el tamaño de la ventana, debe volver a crearla. Debe recrear todos los recursos que dependen de la cadena de búfer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos los comandos que dependen de la cadena de almacenamiento intermedio (y ahora todos estos son comandos de dibujo) deben completar la ejecución antes de destruir la cadena de almacenamiento intermedio anterior. </font><font style="vertical-align: inherit;">Esto significa que toda la GPU estará inactiva. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debe cambiar la canalización de gráficos para proporcionar una ventana gráfica dinámica y cambiar el tamaño. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No se puede crear una cadena de búfer si el tamaño de la ventana es 0 en el eje X o Y. Incluso cuando la ventana está minimizada. </font><font style="vertical-align: inherit;">Es decir, cuando esto sucede, todo el juego se detiene y continúa solo cuando se abre la ventana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora la malla es un simple tablero de ajedrez tridimensional. </font><font style="vertical-align: inherit;">Los colores RGB de la malla se configuran de acuerdo con su posición XYZ multiplicada por 16.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Su navegador no admite video HTML5.</font></font><source src="https://vazgriz.com/wp-content/uploads/2020/01/voxels2.webm" type="video/webm"></video></div></div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Día 7</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hice el proceso del juego no uno, sino varios bloques a la vez. La biblioteca ECS gestiona múltiples bloques y sus mallas </font></font><code>entt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Luego refactoré el renderizador de bloques para que renderizara todos los bloques que están en ECS. Todavía tengo solo un bloque, pero </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">podría</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> agregar otros nuevos si es necesario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Refactoré la malla para que sus datos pudieran actualizarse después de su creación. Esto me permitirá actualizar la malla de bloques en el futuro cuando agregue la capacidad de agregar y eliminar cubos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando agrega o elimina un cubo, el número de vértices en la malla puede aumentar o disminuir potencialmente. El búfer de vértices seleccionado previamente solo se puede usar si la nueva malla es del mismo tamaño o menor. Pero si la malla es más grande, entonces se deben crear nuevos búferes de vértices.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El búfer de vértices anterior no se puede eliminar de inmediato. Puede haber almacenamientos intermedios de instrucciones ejecutados desde cuadros anteriores que son específicos de un objeto en particular </font></font><code>VkBuffer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. El motor debe mantener un búfer hasta que se completen estos búferes de comando. Es decir, si dibujamos una malla en un marco </font></font><code>i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la GPU puede usar este búfer antes de que comience el marco </font></font><code>i + 2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. El búfer no se puede quitar de la CPU hasta que la GPU haya terminado de usarlo. Así que cambié el gráfico de representación para que rastree la vida útil de los recursos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si el nodo del gráfico de representación desea utilizar un recurso (búfer o imagen), debe llamar al método </font></font><code>sync</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dentro del método </font></font><code>preRender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Este método obtiene un puntero </font></font><code>shared_ptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a un recurso. Esta</font></font><code>shared_ptr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">garantiza que el recurso no se eliminará mientras se ejecutan las memorias intermedias de comandos. </font><font style="vertical-align: inherit;">(En términos de rendimiento, esta solución no es muy buena. Más sobre esto más adelante). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora la malla de bloques se regenera en cada cuadro.</font></font><br>
<br>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Su navegador no admite video HTML5.</font></font><source src="https://vazgriz.com/wp-content/uploads/2020/01/voxels3.webm" type="video/webm"></video></div></div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusión</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es todo lo que hice en una semana: preparé los conceptos básicos para representar el mundo con múltiples bloques de vóxel y continuaré trabajando en la segunda semana.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es487812/index.html">Prueba de espectro LED polaco Led E27</a></li>
<li><a href="../es487814/index.html">La velocidad y la fiabilidad son más altas, y el precio es más bajo. Nuevas unidades de estado sólido Kingston KC2000</a></li>
<li><a href="../es487822/index.html">AvitoTech On Tour: encuentro de Android en Nizhny Novgorod</a></li>
<li><a href="../es487824/index.html">Descripción general de las lámparas LED Spectrum Led GU10 de Europa</a></li>
<li><a href="../es487826/index.html">Descripción general de las lámparas LED de Polonia Spectrum Led E14</a></li>
<li><a href="../es487834/index.html">Semana de la seguridad 07: Vulnerabilidad de Android Bluetooth Stack</a></li>
<li><a href="../es487836/index.html">Carga interactiva de archivos al servidor usando RxJS</a></li>
<li><a href="../es487838/index.html">Validación de datos: un enfoque diferente</a></li>
<li><a href="../es487842/index.html">2 SIM para un enrutador de país: ¿es mucho o poco?</a></li>
<li><a href="../es487844/index.html">El olor revela</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>