<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìÇ üë®üèº‚Äçüé® ‚úãüèø Why did asynchronous web servers appear? ü•® üõí üëó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. In touch Vladislav Rodin. I am currently the head of the High Load Architect course at OTUS, and I also teach courses on software arch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Why did asynchronous web servers appear?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/496956/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. </font><font style="vertical-align: inherit;">In touch Vladislav Rodin. </font><font style="vertical-align: inherit;">I am currently the head of the High Load Architect course at OTUS, and I also teach courses on software architecture. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to teaching, as you can see, I have been writing for a blog copyright material OTUS Habr√© and today's article I want to coincide with the start of the course </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´Linux Administrator"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which now is open the set.</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/mq/fl/9f/mqfl9f73j0kklcb2wikqonkd4rk.png"><br>
<hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why does the web application slow down and not hold the load? </font><font style="vertical-align: inherit;">The developers, who were the first to encounter such a question and conducted research on some systems, came to the disappointing conclusion that optimizing a business logic alone would not be enough. </font><font style="vertical-align: inherit;">The answer to this question lies at a lower level - at the level of the operating system. </font><font style="vertical-align: inherit;">In order for your application to hold the load, it is necessary to revise its architectural concept in such a way that it works effectively at this level. </font><font style="vertical-align: inherit;">This led to the emergence of asynchronous web servers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, I could not find a single material that allows me to restore all causal relationships in the evolution of web servers at once. </font><font style="vertical-align: inherit;">So the idea of ‚Äã‚Äãwriting this article came up, which, I hope, will become such material.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux OS Features</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before talking about the models of web servers, I allow myself to recall some features of the processes and threads in Linux. </font><font style="vertical-align: inherit;">We will need this when analyzing the advantages and disadvantages of the above models.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Context switch</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most likely, any user who knows that only one program can be executed on one processor core at once will ask: ‚ÄúWhy can 20 programs be launched on my 4-core processor at a time?‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, this is due to the fact that </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preemptive multitasking</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> takes place </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The operating system allocates a certain quantum of time (~ 50 Œºs) and puts the program to execute on the kernel during this time. </font><font style="vertical-align: inherit;">After the time runs out, the </font><b><font style="vertical-align: inherit;">context switch</font></b><font style="vertical-align: inherit;"> is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interrupted</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switched</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">That is, the operating system simply puts the next program to execute. </font><font style="vertical-align: inherit;">Since switching occurs frequently, we have the impression that all programs work simultaneously. </font><font style="vertical-align: inherit;">Pay attention to the high switching frequency, this will be important for the subsequent presentation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The context switch was mentioned above. </font><font style="vertical-align: inherit;">What does it include? </font><font style="vertical-align: inherit;">When switching the context, it is necessary to save the processor registers, to clear its instruction pipeline, to save the memory regions allocated to the process. </font><font style="vertical-align: inherit;">In general, the operation is quite expensive. </font><font style="vertical-align: inherit;">It takes ~ 0.5 Œºs, while the execution of a simple line of code is ~ 1 ns. </font><font style="vertical-align: inherit;">Moreover, with an increase in the number of processes per processor core, overhead for context switching will increase.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web Server Models</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Currently, the following web server models exist:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">worker</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prefork</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asynchronous</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">combined</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's discuss each of them separately.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worker and prefork</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Historically, with these models, it all started. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The essence is very simple</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : a client comes to us, we select a separate handler for him, which processes the incoming client from the beginning to the end. A handler can be either a process (prefork) or a thread (worker). An example of such a web server is the well-known Apache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I‚Äôll make a reservation right away: creating a new handler for each client is expensive. First, with a constant number of cores, an increase in the number of processors leads to an increase in latency (due to context switches). Secondly, the required amount of memory grows linearly with the increase in clients, because even if you use memory-sharing threads, each thread has its own stack. Thus, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">number of clients processed simultaneously is limited.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the size of the pool, which, in turn, depends on the number of processor cores. </font><font style="vertical-align: inherit;">The problem is solved using vertical scaling methods. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another fundamental drawback of such servers is the non-optimal use of resources. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processes (or threads) are idle for most of the time</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Imagine the following situation: during client processing, it is necessary to take some data from the hard drive, make a request to the database, or write something to the network. </font><font style="vertical-align: inherit;">Since reading from a hard disk in Linux is a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blocking operation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the process (or thread) will hang waiting for a response, but it will still participate in the allocation of processor time.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worker vs prefork</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Worker and prefork have quite a few fundamental differences. </font><font style="vertical-align: inherit;">Streams are somewhat more economical in memory because they share it. </font><font style="vertical-align: inherit;">For the same reason, a context switch between them is easier than between processes. </font><font style="vertical-align: inherit;">However, in the case of a worker, the code becomes multi-threaded, because the threads must be synchronized. </font><font style="vertical-align: inherit;">As a result, we get all the ‚Äúcharms‚Äù of multi-threaded code: it becomes more difficult to write, read, test and debug it.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Asynchronous model</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, worker and prefork do not allow processing a large number of clients at the same time due to limited pool size, and also do not optimally use resources due to context switching and blocking system calls. As you can see, the problem is multithreading and a heavy OS scheduler. This leads to the following idea: let's process clients in only one thread, but let it be loaded at 100%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such servers are based on an event loop and a reactor template ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">event machine</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Client code, initiating an I / O operation, registers a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">callback</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in a priority queue (priority is readiness time). The event loop polls the descriptors waiting for I / O, and then updates the priority (if available). In addition, the event loop pulls events out of the priority queue, causing callbacks to return control to the event loop at the end. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This model allows you to handle a large number of clients, avoiding overhead'a to switch context</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This model is not perfect and has several disadvantages. Firstly, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no more than one processor core is consumed</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , because there is only one process. This is treated using a combined model, which will be discussed below. Secondly, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">customers are connected by this process.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The code needs to be written carefully. </font><font style="vertical-align: inherit;">Memory leaks, errors lead to the fact that all clients fall off at once. </font><font style="vertical-align: inherit;">In addition, this process should not be blocked by anything, callback should not consist in solving some difficult tasks, because all clients will be blocked. </font><font style="vertical-align: inherit;">Thirdly, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asynchronous code is much more complicated</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It is necessary to register an additional callback that the data will not come, to solve the problem of how to correctly branch, etc.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combined model</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This model is used in real servers. </font><font style="vertical-align: inherit;">This model has a pool of processes, each of which has a pool of threads, each of which, in turn, uses a processing model based on asynchronous input-output. </font><font style="vertical-align: inherit;">Nginx presents a combined model.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, turning to the basics of the operating system, we examined the conceptual differences between the web server models used in Apache and Nginx. </font><font style="vertical-align: inherit;">Each of them has its own advantages and disadvantages, so their combination is often used in production. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea of ‚Äã‚Äãasynchronous processing has evolved further: at the level of language platforms, the concepts of green threads / fibers / goroutines arose, which allow you to "hide under the hood" the asynchrony of input and output, leaving the developer happy with a beautiful synchronous code. </font><font style="vertical-align: inherit;">However, this concept deserves a separate article.</font></font><br>
<br>
<hr><br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Learn more about the course.</font></font></a></b><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496944/index.html">Digital events in St. Petersburg from April 13 to 19</a></li>
<li><a href="../en496946/index.html">Once again about GPG hardware keys for a penny</a></li>
<li><a href="../en496950/index.html">Design is design, not the beauty of pictures.</a></li>
<li><a href="../en496952/index.html">Qualcomm QCC3020 - the rise of Chinese TWS headphones</a></li>
<li><a href="../en496954/index.html">Development at Wargaming - meeting with Maxim Baryshnikov, Head of Platform (Part I)</a></li>
<li><a href="../en496958/index.html">Interesting CSS finds in the new Facebook design</a></li>
<li><a href="../en496960/index.html">Speeding up charts using OffscreenCanvas</a></li>
<li><a href="../en496962/index.html">How to tidy up an overloaded server?</a></li>
<li><a href="../en496964/index.html">IBM Weekly Seminars - April 2020</a></li>
<li><a href="../en496966/index.html">CSS LCH colors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>