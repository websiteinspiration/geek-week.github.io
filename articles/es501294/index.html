<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   驴Qu茅 puede resultar de debilitar el nivel de aislamiento de transacciones en bases de datos?   帮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos. En contacto Vladislav Rodin. Actualmente, soy el jefe del curso High Load Architect en OTUS, y tambi茅n doy cursos sobre arquitectura de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>驴Qu茅 puede resultar de debilitar el nivel de aislamiento de transacciones en bases de datos?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/501294/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola a todos. </font><font style="vertical-align: inherit;">En contacto Vladislav Rodin. </font><font style="vertical-align: inherit;">Actualmente, soy el jefe del curso High Load Architect en OTUS, y tambi茅n doy cursos sobre arquitectura de software. </font></font><br>
</i><br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem谩s de la ense帽anza, como habr谩s notado, tambi茅n estoy escribiendo material de copyright para el blog OTUS en el centro y quiero coincidir con el art铆culo de hoy para lanzar el curso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"PostgreSQL"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que actualmente est谩 abierto para reclutamiento.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/wc/kz/hr/wckzhr5i0yusvkgrw6ibzhuu5rm.png"><br>
<hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci贸n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">煤ltima vez que</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usted y yo hablamos sobre esa transacci贸n en bases de datos utilizadas para dos prop贸sitos: garantizar la tolerancia a fallas y el acceso a datos en un entorno competitivo. </font><font style="vertical-align: inherit;">Para completar estas tareas, una transacci贸n debe tener propiedades ACID. </font><font style="vertical-align: inherit;">Hoy hablaremos en detalle sobre la letra </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I (aislamiento)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en esta abreviatura.</font></font><br>
<a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aislamiento</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El aislamiento resuelve el problema de acceder a los datos en un entorno competitivo, proporcionando protecci贸n efectiva contra las condiciones de carrera. Idealmente, aislamiento significa serializaci贸n, es decir, una propiedad que garantiza que el resultado de la ejecuci贸n de transacciones en paralelo sea el mismo que si se ejecutaran secuencialmente. El principal problema de esta propiedad es que es t茅cnicamente muy dif铆cil de proporcionar y, como resultado, tiene un impacto significativo en el rendimiento del sistema. Es por eso que el aislamiento a menudo se debilita, aceptando los riesgos de algunas anomal铆as, que se discutir谩n a continuaci贸n. La posibilidad de que ocurran ciertas anomal铆as de la misma manera caracteriza el nivel de aislamiento de la transacci贸n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las anomal铆as m谩s famosas son: lectura sucia, lectura no repetible, lectura fantasma, pero de hecho hay 5 m谩s: escritura sucia, actualizaci贸n perdida del cursor, actualizaci贸n perdida, sesgo de lectura, sesgo de escritura.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escritura sucia</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La esencia de la anomal铆a es que las transacciones pueden sobrescribir datos no comprometidos. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/007/48f/64e/00748f64e3706c7ecd676eaabe4a0351.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta anomal铆a es peligrosa no solo porque los datos pueden entrar en conflicto despu茅s de cometer ambas transacciones (como en la imagen), sino tambi茅n porque se viola la atomicidad: debido a que permitimos sobrescribir datos no bloqueados, no est谩 claro c贸mo deshacer una transacci贸n sin presionar la otra . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La anomal铆a se trata de manera bastante simple: colgamos el bloqueo de escritura antes de que comience la grabaci贸n, prohibiendo que otras transacciones cambien el registro hasta que se libere el bloqueo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lectura sucia</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lectura sucia significa leer datos no confirmados. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/334/54a/0a2/33454a0a2a3312fa8f010e33110ec5f3.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los problemas surgen cuando, en base a una muestra, es necesario llevar a cabo algunas acciones o tomar decisiones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para solucionar la anomal铆a, puede colgar un bloqueo de lectura, pero afectar谩 mucho el rendimiento. </font><font style="vertical-align: inherit;">Es mucho m谩s simple decir que para una transacci贸n de reversi贸n, el estado inicial de los datos (antes de la grabaci贸n) debe almacenarse en el sistema. </font><font style="vertical-align: inherit;">驴Por qu茅 no leer desde all铆? </font><font style="vertical-align: inherit;">Esto es bastante econ贸mico, por lo que la mayor铆a de las bases de datos eliminan la lectura sucia de forma predeterminada.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actualizaci贸n perdida</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La actualizaci贸n perdida significa actualizaciones perdidas, y la traducci贸n refleja con precisi贸n la esencia del problema: de </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/7a7/185/a1b/7a7185a1b409181482510eec788255ae.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
hecho, el resultado de la transacci贸n T2 se cancel贸. </font><font style="vertical-align: inherit;">Esta situaci贸n se soluciona mediante bloqueos de escritura expl铆citos o impl铆citos. </font><font style="vertical-align: inherit;">Es decir, simplemente actualizamos el registro y luego se produce un bloqueo impl铆cito o realizamos la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selecci贸n para la actualizaci贸n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lo que provoca un bloqueo de lectura y escritura. </font><font style="vertical-align: inherit;">Tenga en cuenta que tal operaci贸n es bastante peligrosa: con nuestra lectura "inocente", bloqueamos otras lecturas. </font><font style="vertical-align: inherit;">Algunas bases de datos ofrecen una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selecci贸n para compartir</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> m谩s segura </font><font style="vertical-align: inherit;">que le permite leer datos, pero no les permite cambiar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El cursor perdi贸 la actualizaci贸n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para un control m谩s preciso, las bases pueden ofrecer otras herramientas, por ejemplo, un cursor. </font><font style="vertical-align: inherit;">Un cursor es una estructura que contiene un conjunto de l铆neas y le permite iterar sobre ellas. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">declarar cursor_name para select_statement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El contenido del cursor se describe mediante select. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
驴Por qu茅 necesitamos un cursor? </font><font style="vertical-align: inherit;">El hecho es que algunas bases de datos ofrecen bloqueo en todos los registros seleccionados por select (estabilidad de lectura), o solo en el registro en el que se encuentra actualmente el cursor (estabilidad del cursor). </font><font style="vertical-align: inherit;">Con la estabilidad del cursor, se implementa un bloqueo corto, que nos permite reducir el n煤mero de bloqueos si iteramos sobre una muestra de datos grande. </font><font style="vertical-align: inherit;">Por lo tanto, la anomal铆a de actualizaci贸n perdida se resalta por separado para el cursor.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lectura no repetible</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La lectura no repetible es que durante la ejecuci贸n de nuestra transacci贸n 2 lecturas consecutivas del mismo registro conducir谩n a resultados diferentes, porque otra transacci贸n intervino entre estas dos lecturas, cambi贸 nuestros datos y se confirm贸. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/3b8/ac7/be3/3b8ac7be3f4b29b3b20f8d4d72e52e35.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
驴Por qu茅 es esto un problema en absoluto? </font><font style="vertical-align: inherit;">Imagine que el prop贸sito de la transacci贸n T2 en la imagen es seleccionar todos los productos cuyo precio sea inferior a 150 pies c煤bicos </font><font style="vertical-align: inherit;">Alguien m谩s actualiz贸 el precio a $ 200 </font><font style="vertical-align: inherit;">Por lo tanto, el filtro instalado no funcion贸. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estas anomal铆as dejan de ocurrir cuando se agregan bloqueos de dos fases o cuando se usa el mecanismo MVCC, del cual me gustar铆a hablar por separado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lectura fantasma</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Phantom est谩 leyendo datos que ha sido agregado por otra transacci贸n. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/946/4dc/24e/9464dc24e22f13034a28f3b798d0aadc.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como ejemplo, puede observar la selecci贸n incorrecta del producto m谩s barato cuando se produce esta anomal铆a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deshacerse de las lecturas fantasmas ya es bastante dif铆cil. </font><font style="vertical-align: inherit;">El bloqueo normal no es suficiente, porque no podr铆amos bloquear lo que a煤n no est谩 disponible. </font><font style="vertical-align: inherit;">Los sistemas 2PL usan bloqueo predictivo, mientras que los sistemas MVCC usan un planificador de transacciones para cancelar transacciones que podr铆an ser interrumpidas por una inserci贸n. </font><font style="vertical-align: inherit;">Tanto el primer como el segundo mecanismo son bastante pesados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leer sesgo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sesgo de lectura surge cuando trabajamos con varias tablas, cuyo contenido deber铆a cambiar de manera consistente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supongamos que hay tablas que representan publicaciones y su metainformaci贸n: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b9c/982/e3e/b9c982e3e51222ea919510ce857a2ab6.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
una transacci贸n lee de las tablas, otra las cambia: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/04e/df8/5a1/04edf85a1ceb8791f55ab6afa1c40b8f.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado de la transacci贸n T1, la publicaci贸n tiene t铆tulo = Bueno y updated_by = T2, lo cual es una inconsistencia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, esta es una lectura no repetible, pero como parte de varias tablas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para su correcci贸n, T1 puede bloquear bloqueos en todas las l铆neas que leer谩, lo que evitar谩 que T2 cambie la informaci贸n. </font><font style="vertical-align: inherit;">En el caso de MVCC, la transacci贸n T2 se cancelar谩. </font><font style="vertical-align: inherit;">La protecci贸n contra esta anomal铆a puede ser importante si usamos cursores.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escribir sesgada</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta anomal铆a tambi茅n es m谩s f谩cil de explicar usando un ejemplo: supongamos que en nuestro sistema al menos un m茅dico debe estar de servicio, pero ambos m茅dicos deciden cancelar su deber: la </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/23a/f78/439/23af784391a4f9adaeb322e5e509f933.jpg" alt="imagen"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/8ec/2cb/d15/8ec2cbd1598ce5fa1e4d22607284795a.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
anomal铆a ha llevado al hecho de que ninguno de los m茅dicos ir谩 a trabajar. 驴Por qu茅 pas贸 esto? Debido a que la transacci贸n verific贸 una condici贸n que podr铆a ser violada por otra transacci贸n, y debido al aislamiento, no vimos este cambio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es la misma lectura no repetible. Alternativamente, las selecciones pueden bloquear bloqueos en estos registros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sesgo de escritura y el sesgo de lectura son combinaciones de anomal铆as anteriores. Puede considerar escribir sesgo, que es esencialmente una lectura fantasma. Considere una tabla en la que hay nombres de empleados, su salario y el proyecto en el que trabajan:</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/ab4/61a/f1e/ab461af1ee01323db8377074875a044b.jpg" alt="imagen"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/acd/126/e73/acd126e73fbe5310bfcb5bf0291e36c2.jpg" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtenemos la siguiente imagen: cada gerente pens贸 que su cambio no conducir铆a al presupuesto, por lo que hicieron cambios de personal, lo que en total condujo a un desbordamiento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La causa del problema es exactamente la misma que en la lectura fantasma.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recomendaciones</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El debilitamiento del nivel de aislamiento de transacciones en la base de datos es un compromiso entre la seguridad y el rendimiento, la elecci贸n de este nivel debe abordarse en funci贸n de los riesgos potenciales para el negocio en caso de anomal铆as.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aprende m谩s sobre el curso.</font></font><br>
</a><br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es501282/index.html">Efecto secundario del coronavirus: los robots ocupar谩n nuestros trabajos a煤n m谩s r谩pido</a></li>
<li><a href="../es501284/index.html">8 preguntas sobre veh铆culos no tripulados de Silicon Valley</a></li>
<li><a href="../es501286/index.html">Conceptos b谩sicos de Easygui Python. Parte 1</a></li>
<li><a href="../es501288/index.html">No se apresure a cambiar a EDI y EDS hoy: dificultades que quiz谩s no conozca</a></li>
<li><a href="../es501292/index.html">Estimaci贸n del costo de los buques comerciales. Aritm茅tica y sentido com煤n.</a></li>
<li><a href="../es501296/index.html">C贸mo hacer una carrera como programador sin resolver un problema de negocios</a></li>
<li><a href="../es501298/index.html">Crear su propio repositorio de complementos QGIS</a></li>
<li><a href="../es501300/index.html">React y Atlaskit en el servidor Atlassian y los complementos del centro de datos</a></li>
<li><a href="../es501302/index.html">Por favor no hagas ruido</a></li>
<li><a href="../es501306/index.html">Construyendo una tuber铆a para entregar Graal Native Image a los usuarios finales</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>