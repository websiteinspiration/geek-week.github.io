<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÉüèæ ü§õüèº ‚ÜîÔ∏è Hist√≥rias de travamento com Patroni ou Como eliminar um cluster do PostgreSQL üêô üìÅ üë®üèª‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O PostgreSQL n√£o possui alta disponibilidade pronta para uso. Para obter HA, voc√™ precisa colocar algo, configurar - fazer um esfor√ßo. Existem v√°rias ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Hist√≥rias de travamento com Patroni ou Como eliminar um cluster do PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/489206/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O PostgreSQL n√£o possui alta disponibilidade pronta para uso. Para obter HA, voc√™ precisa colocar algo, configurar - fazer um esfor√ßo. Existem v√°rias ferramentas que podem ajudar a aumentar a disponibilidade do PostgreSQL, e uma delas √© o Patroni. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä primeira vista, colocando o Patroni em um ambiente de teste, voc√™ pode ver o que √© uma √≥tima ferramenta e como ela lida facilmente com nossas tentativas de quebrar o cluster. Mas, na pr√°tica, em um ambiente de produ√ß√£o, nem tudo sempre acontece de maneira t√£o bonita e elegante. O Data Egret come√ßou a usar o Patroni no final de 2018 e ganhou alguma experi√™ncia: como diagnostic√°-lo, configur√°-lo e quando n√£o confiar no arquivador autom√°tico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No HighLoad ++, Alexei Lesovsky descreveu em detalhes, usando exemplos e an√°lise de log, os problemas t√≠picos que surgem ao trabalhar com o Patroni e as melhores pr√°ticas para super√°-los.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/lqh1eJwVPtk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O artigo n√£o: Instru√ß√µes de instala√ß√£o e exemplos de configura√ß√£o do Patroni; </font><font style="vertical-align: inherit;">problemas fora do Patroni e PostgreSQL; </font><font style="vertical-align: inherit;">hist√≥rias baseadas nas experi√™ncias de outras pessoas, mas apenas nos problemas que o Data Egret descobriu por si mesmos.</font></font><br>
<a name="habracut"></a><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre o orador:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alexey Lesovsky (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lesovsky</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) come√ßou como administrador de sistema (administrador de sistema Linux), trabalhou em desenvolvimento web (administrador de banco de dados PostgreSQL). </font><font style="vertical-align: inherit;">Desde 2014, ela trabalha na Data Egret. </font><font style="vertical-align: inherit;">O Data Egret est√° envolvido em consultoria no campo do PostgreSQL, ajuda muitas e muitas empresas a usar o PostgreSQL corretamente e, √© claro, adquiriu uma vasta experi√™ncia na opera√ß√£o do banco de dados. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O relat√≥rio em que este artigo se baseia √© chamado "Hist√≥rias de falhas do Patroni ou Como travar seu cluster do PostgreSQL", aqui est√° um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link para a apresenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes que voc√™ comece</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deixe-me lembr√°-lo do que √© Patroni, para que se destina e o que pode fazer. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Patroni √© um modelo para a cria√ß√£o de HA fora da caixa.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Portanto, est√° escrito na documenta√ß√£o e do meu ponto de vista - este √© um esclarecimento muito correto. Ou seja, Patroni n√£o √© uma bala de prata que ele colocou e resolver√° todos os problemas. √â necess√°rio fazer esfor√ßos para que comece a funcionar e traga benef√≠cios. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni - servi√ßo de agente.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ele √© instalado em cada servidor com um banco de dados e √© uma esp√©cie de sistema init para o PostgreSQL: inicia, para, reinicia, altera a configura√ß√£o e a topologia do cluster. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Patroni armazena "estado do cluster" no DCS.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para armazenar o estado do cluster, sua visualiza√ß√£o atual, voc√™ precisa de armazenamento. </font><font style="vertical-align: inherit;">Patroni armazena o estado em um sistema externo - um reposit√≥rio de configura√ß√£o distribu√≠do. </font><font style="vertical-align: inherit;">Essa pode ser uma das op√ß√µes: Etcd, Consul, ZooKeeper ou Etcd Kubernetes. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O AutoFile do Patroni est√° ativado por padr√£o. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ obt√©m um arquivador autom√°tico imediatamente ap√≥s a instala√ß√£o do Patroni. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, existem muitas outras coisas, como: configura√ß√µes de manuten√ß√£o, cria√ß√£o de novas r√©plicas, backup, etc. </font><font style="vertical-align: inherit;">Mas desta vez permanecer√° fora do escopo do relat√≥rio.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O principal objetivo da Patroni √© fornecer um auto-arquivador confi√°vel.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A Patroni n√£o precisa monitorar equipamentos, enviar notifica√ß√µes, fazer coisas complicadas sobre a preven√ß√£o de acidentes em potencial, etc. </font><font style="vertical-align: inherit;">√â necess√°rio que o cluster permane√ßa operacional e o aplicativo possa continuar trabalhando com o banco de dados, independentemente de quaisquer altera√ß√µes na topologia do cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas quando come√ßamos a usar o Patroni com o PostgreSQL, nosso sistema fica um pouco mais complicado. </font><font style="vertical-align: inherit;">Agora, al√©m do pr√≥prio banco de dados, quando o mestre ou a r√©plica falha, o pr√≥prio Patroni, o armazenamento distribu√≠do dos estados do cluster ou a rede podem falhar. </font><font style="vertical-align: inherit;">Considere todas as op√ß√µes √† medida que se tornam mais complicadas em termos de qu√£o dif√≠cil √© entender suas causas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 1. DBMS e DCS no mesmo cluster</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere o caso mais simples: pegamos um cluster de banco de dados e implantamos o DCS no mesmo cluster. </font><font style="vertical-align: inherit;">Este erro comum n√£o est√° relacionado apenas aos erros de implanta√ß√£o do PostgreSQL e Patroni. </font><font style="vertical-align: inherit;">Isso √© um erro na constru√ß√£o geral de arquiteturas - combinando muitos componentes diferentes em um s√≥ lugar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, houve um failover. </font><font style="vertical-align: inherit;">Come√ßamos a entender o que aconteceu. </font><font style="vertical-align: inherit;">Aqui, estamos interessados ‚Äã‚Äãem quando o feylover ocorreu, ou seja, no </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">momento em que o estado do cluster mudou.</font></font></strong><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando o failover aconteceu?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um amante da fada nem sempre acontece instantaneamente; pode ser demorado. </font><font style="vertical-align: inherit;">Portanto, ele tem um hor√°rio de in√≠cio e um hor√°rio de t√©rmino. </font><font style="vertical-align: inherit;">Todos os eventos s√£o divididos em ‚Äúantes‚Äù, ‚Äúdurante‚Äù e ‚Äúdepois‚Äù do amante dos feys. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro de tudo, quando o amor de fada aconteceu, estamos procurando o motivo.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: INFO: promoted self to leader by acquiring session lock<font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2<font></font>
pgdb-2 patroni: INFO: updated leader lock during promote<font></font>
pgdb-2 patroni: server promoting<font></font>
pgdb-2 patroni: INFO: cleared rewind state after becoming the leader<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acima est√£o os logs padr√£o do Patroni, nos quais ele relata que a fun√ß√£o de servidor foi alterada e a fun√ß√£o do assistente mudou de outro para este n√≥.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que o failover aconteceu?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, voc√™ precisa entender quais eventos fizeram a fun√ß√£o do mestre passar de um n√≥ para outro, o que aconteceu com o antigo mestre.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: patroni.utils.RetryFailedError: 'Exceeded retry deadline'<font></font>
pgdb-2 patroni: ERROR: Error communicating with DCS<font></font>
pgdb-2 patroni: INFO: demoted self because DCS is not accessible and i was a leader<font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, tudo √© simples: </font></font><code>Error communicating with DCS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- um erro ao interagir com o sistema de armazenamento de configura√ß√£o. </font><font style="vertical-align: inherit;">O mestre percebeu que n√£o poderia trabalhar com a DCS e disse que n√£o podia mais ser mestre e renunciou. </font></font><code>demoted self</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fala sobre isso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que precedeu o amante dos feylover?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ observar os eventos que antecederam o amante dos feylovers, poder√° ver os motivos que se tornaram um problema para o assistente continuar:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: ERROR: touch_member<font></font>
                ... python trace <font></font>
pgdb-2 patroni: socket.timeout: timed out <font></font>
pgdb-2 patroni: During handling of the above exception, another exception occurred:<font></font>
                ... python trace <font></font>
pgdb-2 patroni:   raise ReadTimeoutError(self, url, "Read timed out. (read timeout=%s)" % timeout_value) <font></font>
pgdb-2 patroni: urllib3.exceptions.ReadTimeoutError: HTTPConnectionPool(host='127.0.0.1', port=8500): Read timed out. (read timeout=3.3333333333333335) <font></font>
pgdb-2 patroni: During handling of the above exception, another exception occurred:<font></font>
                ... python trace <font></font>
pgdb-2 patroni:     raise MaxRetryError(_pool, url, error or ResponseError(cause)) <font></font>
pgdb-2 patroni: urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='127.0.0.1', port=8500): Max retries exceeded with url: /v1/kv/service/pgdb/members/pgdb-2?acquire=19598b72-c0d5-f066-5d24-09c1a9ad61ee&amp;dc=maindb (Caused by ReadTimeoutError("HTTPConnectionPool(host='127.0.0.1', port=8500): Read timed out. (read timeout=3.3333333333333335)",)) <font></font>
pgdb-2 patroni: INFO: no action.  i am the leader with the lock <font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os logs do Patroni mostram muitos erros de tempo limite diferentes. </font><font style="vertical-align: inherit;">O Patroni Agent n√£o p√¥de trabalhar com o DCS (neste caso, √© Consul, porta = 8500). </font><font style="vertical-align: inherit;">Patroni e o banco de dados estavam em execu√ß√£o no mesmo host e os servidores Consul estavam em execu√ß√£o no mesmo host. </font><font style="vertical-align: inherit;">Ap√≥s criar a carga no servidor, tamb√©m criamos problemas para o servidor Consul, por causa dos quais eles n√£o podiam se comunicar normalmente.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tudo est√° de volta como estava</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de um tempo, quando a carga diminuiu, nosso Patroni conseguiu se comunicar novamente com os agentes, tudo continuou:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni: INFO: promoted self to leader by acquiring session lock<font></font>
pgdb-2 patroni: WARNING: Loop time exceeded, rescheduling immediately.<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2<font></font>
pgdb-2 patroni: INFO: updated leader lock during promote<font></font>
pgdb-2 patroni: server promoting<font></font>
pgdb-2 patroni: INFO: cleared rewind state after becoming the leader<font></font>
pgdb-2 patroni: INFO: Lock owner: pgdb-2; I am pgdb-2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mesmo servidor pgdb-2 tornou-se novamente um mestre. </font><font style="vertical-align: inherit;">Houve uma pequena reviravolta - em um tempo relativamente curto, ele renunciou a si mesmo como mestre e depois assumiu a responsabilidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso pode ser considerado um falso positivo ou o fato de Patroni ter feito tudo certo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decis√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidimos por n√≥s mesmos que o problema √© que os servidores Consul est√£o no mesmo hardware que os bancos de dados. </font><font style="vertical-align: inherit;">Consequentemente, qualquer carga na CPU e nos discos (solicita√ß√£o pesada de E / S, arquivos tempor√°rios, aspiradores autom√°ticos, migra√ß√µes, backups etc.) tamb√©m afeta a intera√ß√£o com o cluster Consul. </font><font style="vertical-align: inherit;">Decidimos que isso n√£o deveria residir no mesmo equipamento que o banco de dados e alocamos um cluster separado para o Consul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alternativamente, voc√™ pode girar os par√¢metros </font></font><code>ttl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>loop_wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>retry_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tentar devido ao seu aumento para sobreviver √†s cargas de pico de curto prazo. </font><font style="vertical-align: inherit;">Mas se a carga for longa, iremos al√©m desses par√¢metros e o m√©todo n√£o funcionar√°.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 2. Interrup√ß√µes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo problema √© semelhante ao primeiro, pois novamente temos problemas ao interagir com o sistema DCS:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 patroni: ERROR: get_cluster <font></font>
maindb-1 patroni: Traceback (most recent call last):<font></font>
                ... python trace <font></font>
maindb-1 patroni: RetryFailedError: 'Exceeded retry deadline' <font></font>
maindb-1 patroni: ERROR: Error communicating with DCS <font></font>
maindb-1 patroni: INFO: closed patroni connection to the postgresql cluster <font></font>
maindb-1 patroni: INFO: postmaster pid=214121 <font></font>
... <font></font>
... <font></font>
maindb-1 patroni: INFO: demoted self because DCS is not accessible and i was a leader <font></font>
maindb-1 patroni: WARNING: Loop time exceeded, rescheduling immediately.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni novamente diz que n√£o pode interagir com o DCS; portanto, o mestre atual deixa de ser mestre e entra no modo de r√©plica. </font><font style="vertical-align: inherit;">O velho mestre se torna uma r√©plica:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 patroni: INFO: Lock owner: maindb-2; I am maindb-1 <font></font>
maindb-1 patroni: INFO: does not have lock <font></font>
maindb-1 patroni: INFO: running pg_rewind from maindb-2 <font></font>
maindb-1 patroni: INFO: running pg_rewind from user=postgres host=192.168.11.18 port=5432 ... <font></font>
maindb-1 patroni: servers diverged at WAL location 1FA/A38FF4F8 on timeline 6 <font></font>
maindb-1 patroni: rewinding from last common checkpoint at 1FA/A38FF450 on timeline 6 <font></font>
maindb-1 patroni: INFO: Lock owner: maindb-2; I am maindb-1 <font></font>
maindb-1 patroni: INFO: running pg_rewind from maindb-2 in progress <font></font>
maindb-1 patroni: Done!</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui Patroni funciona como deveria - inicia </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para rebobinar o log de transa√ß√µes, depois se conecta ao novo mestre e j√° o alcan√ßa.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que precedeu o amante dos feylover?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos encontrar a primeira coisa que precedeu o amante dos feyl - os erros que o causaram. </font><font style="vertical-align: inherit;">Os registros de Patroni s√£o convenientes nesse sentido: ele escreve as mesmas mensagens com um certo intervalo. </font><font style="vertical-align: inherit;">Voc√™ pode rolar rapidamente eles e ver quando os logs foram alterados. </font><font style="vertical-align: inherit;">Neste ponto, alguns problemas come√ßaram. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em uma situa√ß√£o normal, os logs do Patroni s√£o mais ou menos assim:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 patroni: INFO: Lock owner: maindb-1; I am maindb-1<font></font>
maindb-1 patroni: INFO: no action. i am the leader with the lock<font></font>
maindb-1 patroni: INFO: Lock owner: maindb-1; I am maindb-1<font></font>
maindb-1 patroni: INFO: no action. i am the leader with the lock</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O propriet√°rio do bloqueio √© verificado, se ele mudar, podem ocorrer eventos aos quais o Patroni deve responder. Nesse caso, tudo est√° em ordem conosco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de rolar para o local onde os erros come√ßaram a aparecer, vemos que ocorreu um arquivador autom√°tico. Como os erros estavam relacionados √† intera√ß√£o com o DCS, tamb√©m analisamos os registros do Consul - o que aconteceu l√°. Comparando aproximadamente o tempo do faylover e o tempo nos registros do Consul, vemos que os vizinhos do cluster Consul come√ßaram a duvidar da exist√™ncia de outros participantes:</font></font><br>
<br>
<pre><code class="xml hljs">maindb-2 consul[11581]: serf: EventMemberFailed: maindb-1 192.168.11.19<font></font>
maindb-2 consul[11581]: [INFO] serf: EventMemberFailed: maindb-1 192.168.11.19<font></font>
maindb-2 consul[11581]: memberlist: Suspect maindb-1 has failed, no acks received<font></font>
maindb-2 consul[11581]: [INFO] memberlist: Suspect maindb-1 has failed, no acks received</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ observar os logs de outros agentes da Consul, tamb√©m mostra que h√° um colapso na rede: todos os membros do cluster da Consul duvidam entre si. </font><font style="vertical-align: inherit;">Este foi o √≠mpeto para o amante de fadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se olharmos para entradas ainda anteriores, veremos que o sistema Consul do agente PostgreSQL tem dificuldades com a comunica√ß√£o ( </font></font><code>deadline reached</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RPC failed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<pre><code class="xml hljs">maindb-1 consul: memberlist: Suspect lbs-4 has failed, no acks received<font></font>
maindb-1 consul: [ERR] yamux: keepalive failed: i/o deadline reached<font></font>
maindb-1 consul: yamux: keepalive failed: i/o deadline reached<font></font>
maindb-1 consul: [ERR] consul: "KVS.List" RPC failed to server 192.168.11.115:8300: rpc error making call: EOF<font></font>
maindb-1 consul: [ERR] http: Request GET /v1/kv/service/sam_prod/?recurse=1, error: rpc error making call: EOF from=192.168.11.19<font></font>
maindb-1 consul: [ERR] consul: "KVS.List" RPC failed to server 192.168.11.115:8300: rpc error making call: EOF<font></font>
maindb-1 consul: [ERR] agent: Coordinate update error: rpc error making call: EOF<font></font>
maindb-1 consul: [ERR] http: Request GET /v1/kv/service/sam_prod/?recurse=1, error: rpc error making call: EOF from=192.168.11.19</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decis√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A resposta mais simples √© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reparar a rede</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">√â f√°cil aconselhar, mas as circunst√¢ncias podem ser diferentes, e isso nem sempre √© poss√≠vel. </font><font style="vertical-align: inherit;">O sistema pode viver em um data center, onde n√£o podemos influenciar o equipamento. </font><font style="vertical-align: inherit;">Precisa de outras op√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem op√ß√µes de solu√ß√£o sem trabalhar com uma rede:</font></font><br>
<br>
<ul>
<li><strong> Consul-</strong> ‚Äî <code>checks: []</code>.<br>
   ,     .    ,    Consul-    .           .</li>
<li><strong></strong> <code>raft_multiplier</code>.<br>
   Consul-,     5 (      staging-).         Consul-.  -   .</li>
<li><strong></strong> <code>renice -n -10 consul</code>.<br>
        .  renice   .          Consul-,             .</li>
<li><strong>   consul?</strong><br>
Consul-         . Patroni   Consul-    ,     :    - ,  Patroni      .   etcd,     ,    etcd   . Patroni      etcd-.    -  ,     ,   ,     Consul.</li>
<li><strong>  </strong> <code>ttl, loop_wait, retry_timeout</code>.<br>
     ,         .     Patroni       .</li>
</ul><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 3. Perda de N√≥</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ estiver usando o Patroni, estar√° familiarizado com o comando patronictl list, que mostra o estado atual do cluster:</font></font><br>
<br>
<pre><code class="xml hljs">$ patronictl list<font></font>
<font></font>
+-----------------+-------------------------+--------------+--------+---------+-----------+<font></font>
|     Cluster     |          Member         |     Host     |  Role  |  State  | Lag in MB |<font></font>
+-----------------+-------------------------+--------------+--------+---------+-----------+<font></font>
| patroni_cluster | pg01.dev.zirconus.local | 10.202.1.101 |        | running |    0.0    |<font></font>
| patroni_cluster | pg03.dev.zirconus.local | 10.202.1.103 | Leader | running |    0.0    |<font></font>
+-----------------+-------------------------+--------------+--------+---------+-----------+<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä primeira vista, essa conclus√£o pode parecer normal - h√° um mestre, r√©plicas, mas n√£o h√° atraso na replica√ß√£o. </font><font style="vertical-align: inherit;">Mas essa imagem √© normal exatamente at√© que saibamos que nesse cluster deve haver 3 n√≥s, e n√£o 2.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que o failover aconteceu?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entendemos que ocorreu um arquivador autom√°tico e, depois disso, uma r√©plica desapareceu. </font><font style="vertical-align: inherit;">Precisamos descobrir por que ela desapareceu e traz√™-la de volta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estudamos os logs novamente para entender por que o arquivador autom√°tico ocorreu:</font></font><br>
<br>
<pre><code class="xml hljs">pg02 patroni[1425]: ERROR: failed to update leader lock<font></font>
pg02 patroni[1425]: INFO: demoted self because failed to update leader lock in DCS<font></font>
pg02 patroni[1425]: WARNING: Loop time exceeded, rescheduling immediately.<font></font>
pg02 patroni[1425]: INFO: Lock owner: None; I am pg02.dev.zirconus.local<font></font>
pg02 patroni[1425]: INFO: not healthy enough for leader race<font></font>
pg02 patroni[1425]: INFO: starting after demotion in progress</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mestre pg02 n√£o p√¥de atualizar a chave mestre </font></font><code>ERROR: failed to update leader lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o a segunda r√©plica do db03 se tornou o mestre, tudo est√° em ordem aqui:</font></font><br>
<br>
<pre><code class="xml hljs">pg03 patroni[9648]: INFO: promoted self to leader by acquiring session lock<font></font>
pg03 patroni[9648]: server promoting<font></font>
pg03 patroni[9648]: INFO: cleared rewind state after becoming the leader</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E o velho mestre?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pg02, decidindo se tornar uma r√©plica, come√ßou rebobinando o log de transa√ß√µes. </font><font style="vertical-align: inherit;">Aqui, precisamos examinar os logs de r√©plica, que n√£o est√£o no cluster. </font><font style="vertical-align: inherit;">Abra os logs do Patroni e veja que, durante o processo de conex√£o com o cluster, surgiu um problema no est√°gio </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="xml hljs">pg02 patroni[1425]: INFO: running pg_rewind from pg03<font></font>
pg02 patroni[1425]: INFO: running pg_rewind from user=postgres host=10.202.1.103 port=5432 ...<font></font>
pg02 patroni[1425]: servers diverged at WAL location 33F/68E6AD10 on timeline 28<font></font>
pg02 patroni[1425]: could not open file "/data/pgdb/11/pg_wal/0000001C0000033F00000059": No such file or directory<font></font>
pg02 patroni[1425]: could not find previous WAL record at 33F/59FFE368 pg02 patroni[1425]: Failure, exiting<font></font>
pg02 patroni[1425]: ERROR: Failed to rewind from healty master: pg03<font></font>
pg02 patroni[1425]: WARNING: Postgresql is not running.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para conectar-se ao cluster, o n√≥ deve solicitar o log de transa√ß√µes do assistente e capturar o assistente. </font><font style="vertical-align: inherit;">Nesse caso, n√£o h√° log de transa√ß√µes ( </font></font><code>No such file or directory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) e a r√©plica n√£o pode ser iniciada. </font><font style="vertical-align: inherit;">Consequentemente, o PostgreSQL para com um erro. </font><font style="vertical-align: inherit;">Voc√™ precisa entender por que n√£o houve log de transa√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver o que o novo mestre tem no WAL:</font></font><br>
<br>
<pre><code class="xml hljs">LOG: checkpoint complete:<font></font>
wrote 62928 buffers (16.0%); 0 WAL file(s) added, 0 removed, 23 recycled;<font></font>
write=12.872 s, sync=0.020 s, total=13.001 s;<font></font>
sync files=16, longest=0.009 s, average=0.001 s;<font></font>
distance=520220 kB, estimate=520220 kB</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acontece que, enquanto estava em execu√ß√£o </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ocorreu um ponto de verifica√ß√£o e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alguns dos logs de transa√ß√µes antigos foram renomeados</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Quando o antigo mestre tentou se conectar ao novo mestre e solicitar esses logs, eles j√° foram renomeados, simplesmente n√£o existiam. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acordo com o registro de data e hora, o tempo entre esses eventos √© literalmente de 150 ms.</font></font><br>
<br>
<pre><code class="xml hljs">2019-08-26 00:06:11,369 LOG: checkpoint complete<font></font>
2019-08-26 00:06:11,517 INFO: running pg_rewind</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas isso foi suficiente para tornar a r√©plica incapaz de se conectar e ganhar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decis√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, usamos slots de replica√ß√£o. Essa solu√ß√£o nos pareceu boa, embora na primeira fase da opera√ß√£o tenhamos desligado os slots. Pensamos que, se os slots acumularem muitos segmentos wal, o mestre poder√° cair. Tendo sofrido por algum tempo sem slots, percebemos que precis√°vamos deles e os devolvemos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema √© que, quando o assistente entra no estado de r√©plica, o assistente exclui os slots e os segmentos wal junto com eles. Para nivelar este problema, aumentamos o par√¢metro </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Por padr√£o, √© igual a 8 segmentos, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumentamos </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para 1000</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Alocamos 16 GB </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e agora, ao alternar, sempre temos 16 GB de logs de transa√ß√µes em todos os n√≥s.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso tamb√©m se aplica a tarefas de manuten√ß√£o de longo prazo. </font><font style="vertical-align: inherit;">Digamos que precisamos atualizar uma das r√©plicas (software, SO, outra coisa) e queremos desativ√°-la. </font><font style="vertical-align: inherit;">Quando desligamos a r√©plica, o slot tamb√©m √© exclu√≠do. </font><font style="vertical-align: inherit;">Se voc√™ usar um valor pequeno de par√¢metro </font></font><code>wal_keep_segments</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, durante uma longa aus√™ncia de uma r√©plica, ele solicitar√° os logs de transa√ß√µes que podem nem aparecer no assistente - a r√©plica n√£o poder√° se conectar. </font><font style="vertical-align: inherit;">Portanto, mantemos uma grande oferta de revistas.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 4. Perda de Dados</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Houve um failover em uma base de produ√ß√£o. </font><font style="vertical-align: inherit;">Verificamos o cluster: tudo est√° em ordem, todas as r√©plicas est√£o no lugar, n√£o h√° atraso na replica√ß√£o e tamb√©m n√£o h√° erros nos logs. </font><font style="vertical-align: inherit;">Mas a equipe do produto relata que </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o h√° dados suficientes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no </font><strong><font style="vertical-align: inherit;">banco de dados</font></strong><font style="vertical-align: inherit;"> - eles est√£o em uma fonte, mas n√£o no banco de dados. </font><font style="vertical-align: inherit;">Voc√™ precisa entender o que aconteceu com eles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imediatamente percebemos que essa era </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a jam deles, mas precisamos descobrir o porqu√™.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando o failover aconteceu?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sempre podemos encontrar nos registros quando ocorreu o amante do feylover, quem se tornou o novo mestre, quem era o mestre antes e quando ele queria se tornar uma r√©plica.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-1 patroni[17836]: INFO: promoted self to leader by acquiring session lock<font></font>
pgdb-1 patroni[17836]: server promoting<font></font>
pgdb-1 patroni[17836]: INFO: cleared rewind state after becoming the leader<font></font>
pgdb-1 patroni[17836]: INFO: Lock owner: pgdb-1; I am pgdb-1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir dos logs, podemos determinar a quantidade de logs de transa√ß√µes perdidos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foi assim: o antigo assistente foi reiniciado, depois de reiniciado pela execu√ß√£o autom√°tica, foi lan√ßado o Patroni, que lan√ßou o PostgreSQL. </font><font style="vertical-align: inherit;">O PostgreSQL decidiu se tornar um membro do cluster Patroni e lan√ßou um processo </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que, por sua vez, apagou parte dos logs de transa√ß√µes, baixou novos e se conectou. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni funcionou exatamente como pretendido. </font><font style="vertical-align: inherit;">O cluster se recuperou: havia tr√™s n√≥s, depois dos tr√™s n√≥s do feylover e saiu. </font><font style="vertical-align: inherit;">Mas parte dos dados √© perdida e voc√™ precisa entender qual √© a parte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encontre nos registros do antigo mestre o momento em que aconteceu </font></font><code>pg_rewind</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni[4149]: INFO: running pg_rewind from pgdb-1<font></font>
pgdb-2 patroni[4149]: Lock owner: pgdb-1; I am pgdb-2<font></font>
pgdb-2 patroni[4149]: Deregister service pgdb/pgdb-2<font></font>
pgdb-2 patroni[4149]: running pg_rewind from pgdb-1 in progress<font></font>
pgdb-2 patroni[4149]: running pg_rewind from user=replica host=10.10.1.31 port=5432 ...<font></font>
pgdb-2 patroni[4149]: servers diverged at WAL location 0/5AD1BFD8 on timeline 66<font></font>
pgdb-2 patroni[4149]: rewinding from last common checkpoint at 0/59DD1070 on timeline 66<font></font>
pgdb-2 patroni[4149]: Done!</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ precisa encontrar a posi√ß√£o no log de transa√ß√µes, que interrompeu o antigo mestre.</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-2 patroni[4149]: INFO: Local timeline=66 lsn=0/5BDA8EB8<font></font>
pgdb-2 patroni[4149]: INFO: master_timeline=67<font></font>
...<font></font>
pgdb-2 patroni[4149]: servers diverged at WAL location 0/5AD1BFD8 on timeline 66<font></font>
postgres=# select pg_wal_lsn_diff('0/5BDA8EB8','0/5AD1BFD8');<font></font>
pg_wal_lsn_diff<font></font>
----------------<font></font>
17354464</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, √© a marca 0 / 5BDA8EB8. </font><font style="vertical-align: inherit;">A segunda marca - 0 / 5AD1BFD8 - √© necess√°ria para encontrar a dist√¢ncia pela qual o antigo mestre difere da nova. </font><font style="vertical-align: inherit;">Usando a fun√ß√£o </font></font><code>pg_wal_lsn_diff </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, comparamos essas duas marcas, obtemos 17 MB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se h√° uma grande perda de 17 MB de dados, todo mundo decide por si mesmo. </font><font style="vertical-align: inherit;">Para alguns, isso √© insignificante, mas para algu√©m √© muito inaceit√°vel. </font><font style="vertical-align: inherit;">Cada um por si determina individualmente de acordo com as necessidades do neg√≥cio.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decis√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro de tudo, voc√™ precisa decidir </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se a inicializa√ß√£o autom√°tica do Patroni sempre √© necess√°ria ap√≥s a reinicializa√ß√£o do sistema</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Na maioria das vezes, devemos ir para o antigo mestre, ver como √© diferente do estado atual, talvez inspecionar os segmentos do log de transa√ß√µes. Voc√™ precisa entender se esses dados podem ser perdidos ou executar o assistente antigo no modo aut√¥nomo para extrair os dados. Somente depois disso, decida o que fazer com os dados e conecte esse n√≥ como uma r√©plica ao nosso cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, h√° um par√¢metro</font></font><code>maximum_lag_on_failover</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, por padr√£o, seu valor √© 1 Mb. Funciona assim: se a r√©plica estiver 1 MB atr√°s do atraso da replica√ß√£o, essa r√©plica n√£o participar√° das elei√ß√µes. Se de repente ocorrer um failover, Patroni examinar√° quais r√©plicas est√£o atrasadas e aquelas que est√£o atrasadas em um grande n√∫mero de logs de transa√ß√µes n√£o podem se tornar um mestre. Esse √© um bom recurso de seguran√ßa que evita a perda de muitos dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas h√° um problema: o atraso da replica√ß√£o √© atualizado em um determinado intervalo, o valor </font></font><code>ttl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">padr√£o √© 30 s. √â bem poss√≠vel que o valor do atraso de replica√ß√£o para r√©plicas no DCS seja um, mas, na verdade, √© completamente diferente ou n√£o existe nenhum atraso. Esse n√£o √© um valor em tempo real; nem sempre reflete a imagem real e n√£o vale a pena vincular uma l√≥gica complexa a ela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O risco de "perdas" sempre permanece:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No pior dos casos: </font></font><code>maximum_lag_on_failover + ttl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No caso da m√©dia: </font></font><code>maximum_lag_on_failover + (loop_wait / 2)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao planejar implementar o Patroni e avaliar a quantidade de dados que voc√™ pode perder, considere essas f√≥rmulas para representar aproximadamente poss√≠veis perdas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A boa not√≠cia √© que pode haver um WAL de processos em segundo plano nas ‚Äúperdas‚Äù. </font><font style="vertical-align: inherit;">Esses dados podem ser facilmente ignorados e perdidos, n√£o h√° problema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que os logs s√£o, se configurados </font></font><code>maximum_lag_on_failover</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ocorreu um amor de feyl e voc√™ precisa selecionar um novo assistente:</font></font><br>
<br>
<pre><code class="xml hljs">pgdb-1 patroni[6202]: INFO: Lock owner: None; I am pgdb-1<font></font>
pgdb-1 patroni[6202]: INFO: not healthy enough for leader race<font></font>
pgdb-1 patroni[6202]: INFO: changing primary_conninfo and restarting in progress<font></font>
...<font></font>
pgdb-1 patroni[6202]: INFO: following a different leader because i am not the healthiest node<font></font>
pgdb-1 patroni[6202]: INFO: following a different leader because i am not the healthiest node</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A r√©plica simplesmente v√™ que ela </font></font><code>not healthy enough for leader race</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© e se recusa a participar da corrida de lideran√ßa. </font><font style="vertical-align: inherit;">Portanto, ele simplesmente espera que um novo assistente seja selecionado para se conectar a ele. </font><font style="vertical-align: inherit;">Essa √© uma medida adicional contra a perda de dados.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 5. Unidades</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A equipe do produto escreveu que o aplicativo tem problemas ao trabalhar com o PostgreSQL. </font><font style="vertical-align: inherit;">Ao mesmo tempo, voc√™ n√£o pode entrar no mestre, porque ele n√£o est√° dispon√≠vel via SSH, mas o arquivador autom√°tico tamb√©m n√£o ocorre. </font><font style="vertical-align: inherit;">Em seguida, o host foi reiniciado √† for√ßa e, assim, lan√ßou o arquivador autom√°tico. </font><font style="vertical-align: inherit;">Embora fosse poss√≠vel fazer um feiticeiro manual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s a reinicializa√ß√£o, vamos ver o que aconteceu com o mestre. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_1/2u/rj/_12urj0aobgqg0pp2gkkuolhjog.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sab√≠amos com anteced√™ncia sobre os problemas com os discos e, monitorando, sab√≠amos onde cavar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos logs do PostgreSQL, vemos o seguinte:</font></font><br>
<br>
<pre><code class="xml hljs">[COMMIT] LOG: duration: 1138.868 ms statement: COMMIT<font></font>
...<font></font>
[] WARNING: autovacuum worker started without a worker entry<font></font>
...<font></font>
[SELECT] LOG: temporary file: path "base/pgsql_tmp/pgsql_tmp11247.983", size 532996096<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No rosto, todos os indicadores de problemas com os discos: confirma que duram um segundo, o v√°cuo autom√°tico executa arquivos muito longos e estranhos e tempor√°rios no disco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinamos o sistema dmesg - o log de mensagens do kernel e vimos um problema com um dos discos:</font></font><br>
<br>
<pre><code class="xml hljs">md/raid10:md2: sde3: rescheduling sector 351273392<font></font>
blk_update_request: I/O error, dev sde, sector 64404728<font></font>
md/raid10:md2: sde3: rescheduling sector 63161592<font></font>
blk_update_request: I/O error, dev sde, sector 64404760<font></font>
...<font></font>
md2 : active raid10 sda3[0] sdc3[2] sdd3[3] sdb3[1] sdh3[7] sdf3[5] sdg3[6]<font></font>
      15623340032 blocks super 1.2 512K chunks 2 near-copies [8/7] [UUUUUUU_]<font></font>
      bitmap: 58/59 pages [232KB], 131072KB chunk</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O subsistema de disco no servidor era um RAID de software de 8 discos, mas um estava ausente. </font><font style="vertical-align: inherit;">A linha </font></font><code>sda3[0] sdc3[2] sdd3[3] sdb3[1] sdh3[7] sdf3[5] sdg3[6]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√° faltando </font></font><code>sde[4]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Relativamente falando, um disco caiu, isso causou problemas no disco e o aplicativo teve problemas ao trabalhar com o cluster do PostgreSQL.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decis√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, o Patroni n√£o poderia ajudar, porque o Patroni n√£o tem tarefa para monitorar o status do servidor e dos discos. </font><font style="vertical-align: inherit;">Durante os problemas, Patroni continuou a interagir com o cluster DCS e n√£o viu nenhuma dificuldade. </font><font style="vertical-align: inherit;">Para tais situa√ß√µes, √© necess√°rio monitoramento externo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema 6. Simulador de Cluster</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse √© um dos problemas mais estranhos. </font><font style="vertical-align: inherit;">Estudei por muito tempo, reli muitos logs e chamei de ‚Äúsimulador de cluster‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema era que o velho mestre n√£o podia se tornar uma sugest√£o normal. </font><font style="vertical-align: inherit;">Patroni o executou, mostrou que esse n√≥ est√° presente como uma r√©plica, mas, ao mesmo tempo, n√£o era uma r√©plica normal, agora voc√™ ver√° o porqu√™. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo come√ßou, como no caso anterior, com problemas de disco:</font></font><br>
<br>
<pre><code class="xml hljs">14:48:55.601 [COMMIT] LOG: duration: 1478.118 ms statement: COMMIT<font></font>
14:48:56.287 [COMMIT] LOG: duration: 1290.203 ms statement: COMMIT<font></font>
14:48:56.287 [COMMIT] LOG: duration: 1778.465 ms statement: COMMIT<font></font>
14:48:56.287 [COMMIT] LOG: duration: 1778.449 ms statement: COMMIT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Houve conex√µes interrompidas:</font></font><br>
<br>
<pre><code class="xml hljs">14:48:58.078 [idle in transaction] LOG: could not send data to client: Broken pipe<font></font>
14:48:58.078 [idle] LOG: could not send data to client: Broken pipe<font></font>
14:48:58.078 [idle] FATAL: connection to client lost<font></font>
14:48:58.107 [idle in transaction] FATAL: connection to client lost</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existiam longas expectativas de resposta e bloqueio de gravidade vari√°vel:</font></font><br>
<br>
<pre><code class="xml hljs">14:49:26.929 [UPDATE waiting] LOG: process 4298 acquired ExclusiveLock on tuple (2,10) of relation 52082 of database 50587 after 52487.463 ms<font></font>
14:49:26.929 [UPDATE waiting] STATEMENT: UPDATE sessions SET lastaccess='1565005714' WHERE sessionid=...<font></font>
14:49:27.929 [UPDATE waiting] LOG: process 4298 still waiting for ShareLock on transaction 364118337 after 1000.088 ms<font></font>
14:49:27.929 [UPDATE waiting] DETAIL: Process holding the lock: 4294. Wait queue: 4298.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, h√° problemas √≥bvios com os discos, incluindo arquivos tempor√°rios novamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o mais misterioso para mim - ele apareceu </font></font><code>immediate shutdown request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs">14:49:34.102 MSK 5335 @ from [] LOG: received immediate shutdown request<font></font>
14:49:34.689 [authentication] WARNING: terminating connection because of crash of another server process<font></font>
14:49:34.689 [authentication] DETAIL: The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O PostgreSQL possui tr√™s modos de desligamento:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gracioso quando esperamos que todos os clientes se desconectem por conta pr√≥pria.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√°pido, quando dizemos aos clientes para desconectar, porque vamos desligar.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Imediato, que n√£o informa aos clientes que √© necess√°rio desconectar, mas simplesmente o desliga e envia uma mensagem RST a todos os clientes (sinal TCP de que a conex√£o foi interrompida).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os processos em segundo plano do PostgreSQL n√£o enviam sinais de solicita√ß√£o de desligamento imediato, mas apenas respondem a eles. </font><font style="vertical-align: inherit;">Esta √© uma reinicializa√ß√£o de emerg√™ncia, e quem a enviou n√£o √© clara. </font><font style="vertical-align: inherit;">Se fosse </font></font><code>kill -9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, eu o veria nos logs, mas n√£o estava l√°. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compreendendo ainda mais, vi que Patroni n√£o gravou no log por um bom tempo - simplesmente n√£o houve mensagens por 54 segundos. </font><font style="vertical-align: inherit;">Durante esse per√≠odo, uma das r√©plicas fez "promo√ß√£o" e ocorreu um arquivador autom√°tico:</font></font><br>
<br>
<pre><code class="xml hljs">pgsql03 patroni: 14:48:25,000 INFO: Lock owner: pgsql03; I am pgsql03 <font></font>
pgsql03 patroni: 14:48:25,013 INFO: no action.  i am the leader with the lock <font></font>
pgsql03 patroni: 14:48:37,159 INFO: Lock owner: pgsql03; I am pgsql03 <font></font>
pgsql03 patroni: 14:49:31,155 WARNING: Exception hened during processing of request from 10.1.0.12 <font></font>
pgsql03 patroni: 14:49:31,297 WARNING: Exception hened during processing of request from 10.1.0.11 <font></font>
pgsql03 patroni: 14:49:31,298 WARNING: Exception hened during processing of request from 10.1.0.11</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni voltou a funcionar perfeitamente aqui, o antigo mestre n√£o estava dispon√≠vel, ent√£o a elei√ß√£o de um novo mestre come√ßou.</font></font><br>
<br>
<pre><code class="xml hljs">pgsql01 patroni: 14:48:57,136 INFO: promoted self to leader by acquiring session lock<font></font>
pgsql01 patroni: server promoting<font></font>
pgsql01 patroni: 14:48:57,214 INFO: cleared rewind state after becoming the leader<font></font>
pgsql01 patroni: 14:49:05,013 INFO: Lock owner: pgsql01; I am pgsql01<font></font>
pgsql01 patroni: 14:49:05,023 INFO: updated leader lock during promote</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pgsql01 se tornou o novo l√≠der e houve apenas problemas com a segunda r√©plica. </font><font style="vertical-align: inherit;">Ela honestamente tentou reconfigurar:</font></font><br>
<br>
<pre><code class="xml hljs">pgsql02 patroni: 14:48:57,124 INFO: Could not take out TTL lock <font></font>
pgsql02 patroni: 14:48:57,137 INFO: following new leader after trying and failing to obtain lock <font></font>
pgsql02 patroni: 14:49:05,014 INFO: Lock owner: pgsql01; I am pgsql02 <font></font>
pgsql02 patroni: 14:49:05,025 INFO: changing primary_conninfo and restarting in progress <font></font>
pgsql02 patroni: 14:49:15,011 INFO: Lock owner: pgsql01; I am pgsql02<font></font>
pgsql02 patroni: 14:49:15,014 INFO: changing primary_conninfo and restarting in progress <font></font>
pgsql02 patroni: 14:49:25,011 INFO: Lock owner: pgsql01; I am pgsql02 <font></font>
pgsql02 patroni: 14:49:25,014 INFO: changing primary_conninfo and restarting in progress <font></font>
pgsql02 patroni: 14:49:35,011 INFO: Lock owner: pgsql01; I am pgsql02 <font></font>
pgsql02 patroni: 14:49:35,014 INFO: changing primary_conninfo and restarting in progress</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ela tentou alterar o recovery.conf, reiniciar o PostgreSQL, conectar-se ao novo assistente. </font><font style="vertical-align: inherit;">A cada 10 segundos, h√° mensagens que ela est√° tentando, mas n√£o pode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enquanto isso, o mesmo sinal de desligamento imediato voou para o velho mestre. </font><font style="vertical-align: inherit;">O assistente iniciou uma reinicializa√ß√£o de emerg√™ncia, a recupera√ß√£o tamb√©m para. </font><font style="vertical-align: inherit;">A r√©plica n√£o pode se conectar ao mestre porque est√° no modo de desligamento.</font></font><br>
<br>
<pre><code class="xml hljs">14:49:34.293 [idle] LOG:  received replication command: IDENTIFY_SYSTEM <font></font>
WARNING:  terminating connection because of crash of another server process <font></font>
DETAIL:  The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory. <font></font>
14:49:35.232 FATAL:  could not receive data from WAL stream: server closed the connection unexpectedly             <font></font>
        This probably means the server terminated abnormally <font></font>
        before or while processing the request. <font></font>
14:49:35.232 LOG:  record with incorrect prev-link 142D46/315602C at 14CF/CF38C160 <font></font>
14:49:35.305 FATAL: could not connect to the primary server: FATAL: the database system is shutting down <font></font>
14:49:40.241 FATAL: could not connect to the primary server: FATAL: the database system is shutting down</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em algum momento, a r√©plica funcionou, mas a replica√ß√£o n√£o foi iniciada.</font></font><br>
<br>
<pre><code class="xml hljs">14:50:14.024 [] LOG:  record with incorrect prev-link 142D46/315602C at 14CF/CF38C160 <font></font>
14:50:14.028 [] LOG:  fetching timeline history file for timeline 72 from primary server <font></font>
14:50:14.104 [] FATAL:  could not start WAL streaming: ERROR:  requested starting point 14CF/CF000000 on timeline 71 is not in this server's history        <font></font>
DETAIL:  This server's history forked from timeline 71 at 14CF/CEC32E40. <font></font>
14:50:14.104 [] LOG:  new timeline 72 forked off current database system timeline 71 before current recovery point 14CF/CF38C160</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tenho uma √∫nica hip√≥tese: em recovery.conf era o endere√ßo do antigo mestre. </font><font style="vertical-align: inherit;">Quando um novo mestre j√° apareceu, a segunda r√©plica tentou se conectar ao antigo mestre. </font><font style="vertical-align: inherit;">Quando Patroni iniciou na segunda r√©plica, o n√≥ iniciou, mas n√£o p√¥de se conectar via replica√ß√£o. </font><font style="vertical-align: inherit;">Um atraso de replica√ß√£o foi formado, mais ou menos assim:</font></font><br>
<br>
<pre><code class="xml hljs">+-----------------+----------+--------------+--------+---------+-----------+<font></font>
|     Cluster     |  Member  |     Host     |  Role  |  State  | Lag in MB |<font></font>
+-----------------+----------+--------------+--------+---------+-----------+<font></font>
| patroni_cluster |  pgsql01 | 10.2.200.151 | Leader | running |       0.0 |<font></font>
| patroni_cluster |  pgsql02 | 10.2.200.152 |        | running |    9153.0 |<font></font>
| patroni_cluster |  pgsql03 | 10.2.200.153 |        | running |       0.0 |<font></font>
+-----------------+----------+--------------+--------+---------+-----------+</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, todos os tr√™s n√≥s estavam no lugar, mas o segundo n√≥ estava atr√°s. </font><font style="vertical-align: inherit;">N√£o foi poss√≠vel iniciar a replica√ß√£o porque os logs de transa√ß√µes eram diferentes. </font><font style="vertical-align: inherit;">Os logs de transa√ß√µes oferecidos pelo assistente, indicados em recovery.conf, simplesmente n√£o se encaixavam no n√≥ atual. </font><font style="vertical-align: inherit;">O PostgreSQL relatou um erro a cada 5 segundos</font></font><br>
<br>
<pre><code class="xml hljs">14:50:44.143 FATAL:  could not start WAL streaming: ERROR:  requested starting point 14CF/CF000000 on timeline 71 is not in this server's history        <font></font>
         DETAIL:  This server's history forked from timeline 71 at 14CF/CEC32E40. <font></font>
14:50:44.143 LOG:  new timeline 72 forked off current database system timeline 71 before current recovery point 14CF/ CF38C160</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui cometi um erro e n√£o testei minha hip√≥tese de que estamos nos conectando com o mestre errado. </font><font style="vertical-align: inherit;">Acabei de reiniciar o Patroni na r√©plica. </font><font style="vertical-align: inherit;">Honestamente, eu j√° terminei e pensei que teria que refaz√™-lo, mas ainda decidi tentar reinici√°-lo.</font></font><br>
<br>
<pre><code class="xml hljs">15:14:13.511 LOG: consistent recovery state reached at 14CF/A3F657B0<font></font>
15:14:13.511 LOG: database system is ready to accept read only connections</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A recupera√ß√£o foi iniciada e, mesmo o banco de dados aberto, estava pronto para aceitar a conex√£o, a replica√ß√£o iniciada:</font></font><br>
<br>
<pre><code class="xml hljs">15:14:17.072 LOG: record with incorrect prev-link 142D46/315602C at 14CF/CF38C160<font></font>
15:14:17.077 LOG: started streaming WAL from primary at 14CF/CF000000 on timeline 72<font></font>
15:14:17.536 LOG: invalid record length at 14CF/CF38C160: wanted 24, got 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas um minuto depois, ela caiu com um erro </font></font><code>terminating walreceiver process due to administrator command</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- a r√©plica dizia que os logs de transa√ß√µes n√£o eram adequados para ela.</font></font><br>
<br>
<pre><code class="xml hljs">15:15:27.823 FATAL: terminating walreceiver process due to administrator command<font></font>
15:15:27.895 LOG: invalid record length at 14CF/CF38C160: wanted 24, got 1<font></font>
15:15:27.895 LOG: invalid record length at 14CF/CF38C160: wanted 24, got 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E n√£o reiniciei o PostgreSQL, mas foi o Patroni que foi reiniciado na esperan√ßa de lan√ßar magicamente o banco de dados. </font><font style="vertical-align: inherit;">A replica√ß√£o foi iniciada novamente, mas o banco de dados foi aberto no mesmo local:</font></font><br>
<br>
<pre><code class="xml hljs">15:17:33.553 LOG: consistent recovery state reached at 14CF/A3F657B0<font></font>
15:17:33.554 LOG: database system is ready to accept read only connections</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As marcas no log de transa√ß√µes eram diferentes, eram diferentes da tentativa de ativa√ß√£o anterior - a posi√ß√£o do log de transa√ß√µes era anterior:</font></font><br>
<br>
<pre><code class="xml hljs">15:17:37.299 LOG: invalid contrecord length 5913 at 14CF/CEFFF7B0<font></font>
15:17:37.304 LOG: started streaming WAL from primary at 14CF/CE000000 on timeline 72</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A replica√ß√£o parou novamente e a mensagem de erro foi diferente e novamente n√£o muito informativa:</font></font><br>
<br>
<pre><code class="xml hljs">15:18:12.208 FATAL: terminating walreceiver process due to administrator command<font></font>
15:18:12.240 LOG: record with incorrect prev-link 60995000/589DF000 at 14CF/CEFFF7B0<font></font>
15:18:12.240 LOG: record with incorrect prev-link 60995000/589DF000 at 14CF/CEFFF7B0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o experimento, reiniciado novamente, a base foi aberta no mesmo local:</font></font><br>
<br>
<pre><code class="xml hljs">15:21:25.135 LOG: consistent recovery state reached at 14CF/A3F657B0<font></font>
15:21:25.135 LOG: database system is ready to accept read only connections</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o surgiu a id√©ia: se eu reiniciar o PostgreSQL, neste momento, no assistente atual, farei um ponto de verifica√ß√£o para mover o ponto do log de transa√ß√µes um pouco √† frente e a recupera√ß√£o iniciada em outro momento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lan√ßou Patroni, fez alguns pontos de verifica√ß√£o no mestre, alguns pontos de reinicializa√ß√£o na r√©plica quando ela foi aberta:</font></font><br>
<br>
<pre><code class="xml hljs">15:22:43.727 LOG: invalid record length at 14D1/BCF3610: wanted 24, got 0<font></font>
15:22:43.731 LOG: started streaming WAL from primary at 14D1/B000000 on timeline 72</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funcionou - a replica√ß√£o come√ßou em um lugar diferente e n√£o quebrou mais. </font><font style="vertical-align: inherit;">Mas, para mim, esse √© um dos problemas mais misteriosos sobre os quais ainda estou atormentando. </font><font style="vertical-align: inherit;">Especialmente aquele pedido estranho de desligamento imediato. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir disso, podemos concluir: Patroni pode funcionar como planejado e sem erros, mas isso n√£o √© uma garantia absoluta de que tudo est√° realmente em ordem. </font><font style="vertical-align: inherit;">Ap√≥s o amor de fey, voc√™ sempre precisa verificar se tudo est√° bem com o cluster: o n√∫mero certo de r√©plicas, sem atraso na replica√ß√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sum√°rio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com base nesses e em muitos outros problemas semelhantes, formulei recomenda√ß√µes gerais que recomendamos que voc√™ tenha em mente ao operar o Patroni.</font></font><br>
<br>
<blockquote><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao usar o Patroni, voc√™ deve ter monitoramento. </font><font style="vertical-align: inherit;">Voc√™ sempre precisa saber quando ocorreu um arquivo autom√°tico, porque se n√£o souber que possui um arquivo autom√°tico, n√£o controla o cluster.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;Ap√≥s cada amante de fey sempre verifique um cluster. </font><font style="vertical-align: inherit;">Voc√™ deve se certificar de que: r√©plicas s√£o sempre o n√∫mero atual; </font><font style="vertical-align: inherit;">sem atraso de replica√ß√£o; </font><font style="vertical-align: inherit;">n√£o h√° erros nos logs relacionados √† replica√ß√£o de streaming, com o Patroni, com o sistema DCS.</font></font></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patroni √© uma ferramenta muito boa, mas n√£o importa como voc√™ diga que n√£o √© uma bala de prata. </font><font style="vertical-align: inherit;">A automa√ß√£o pode funcionar com √™xito, mas, ao mesmo tempo, os objetos de automa√ß√£o podem estar em um estado de meio trabalho. </font><font style="vertical-align: inherit;">De qualquer forma, voc√™ precisa ter uma id√©ia de como o PostgreSQL e a replica√ß√£o funcionam, como o Patroni gerencia o PostgreSQL e como a intera√ß√£o entre os n√≥s √© garantida. </font><font style="vertical-align: inherit;">Isso √© necess√°rio para poder reparar os problemas que surgem com as m√£os.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Etapas de diagn√≥stico</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aconteceu que trabalhamos com clientes diferentes, na maioria das vezes eles n√£o t√™m uma pilha ELK, e voc√™ precisa classificar os logs abrindo 2 guias e 6 consoles: em uma guia Patroni para cada n√≥, no outro - logs Consul ou PostgreSQL. </font><font style="vertical-align: inherit;">Diagnosticar tudo isso √© dif√≠cil. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu desenvolvi a seguinte abordagem. </font><font style="vertical-align: inherit;">Eu sempre assisto quando ocorre um failover. </font><font style="vertical-align: inherit;">Para mim, √© uma esp√©cie de divisor de √°guas. </font><font style="vertical-align: inherit;">Eu olho para o que aconteceu antes, durante e depois do amante dos feys. </font><font style="vertical-align: inherit;">O failover possui dois registros de data e hora - in√≠cio e fim. </font><font style="vertical-align: inherit;">Nos logs, procuro o que precedeu o amante dos feiticeiros, ou seja, estou procurando por raz√µes. </font><font style="vertical-align: inherit;">Isso d√° uma compreens√£o da imagem do que aconteceu e do que pode ser feito no futuro, para que o amante dos fey n√£o ocorra nas mesmas circunst√¢ncias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para isso, eu olho:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro de tudo, os logs do Patroni.</font></font></li>
<li>  PostgreSQL   DCS    ,     Patroni.</li>
<li>  ‚Äî     ,    .</li>
</ul><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem muitos outros produtos para o arquivador autom√°tico: stolon, repmgr, pg_auto_failover, PAF. Eu tentei todas as 4 ferramentas e, na minha opini√£o, o Patroni √© o melhor que existe no mercado hoje. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu recomendo o Patroni? Definitivamente, sim, porque gosto de Patroni, acho que aprendi a cozinhar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ estiver interessado em analisar outros problemas com o Patroni, al√©m dos descritos no artigo, sempre poder√° acessar a p√°gina </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/zalando/patroni/issues</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Existem muitas hist√≥rias diferentes. Apesar do fato de que metade deles √© de usu√°rios analfabetos que fazem perguntas est√∫pidas sem se preocupar com uma pesquisa simples, problemas interessantes tamb√©m s√£o discutidos e, como resultado de discuss√µes, tarefas para corrigir bugs s√£o abertas, se necess√°rio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agradecemos a Zalando pelo desenvolvimento deste projeto, bem como √†s duas pessoas que come√ßaram a trabalhar neste produto: Alexander Kukushkin e Alexey Klyukin. Muito obrigado a todos os colaboradores da Patroni. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s esse relat√≥rio, gravamos uma curta entrevista na qual Alex tentou encaixar seu relat√≥rio em um conselho e dissemos por que participar e falar em confer√™ncias. Pegue em armas e venha conferir a abordagem no Saint HighLoad ++.</font></font></i><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/lnw02pCpgRw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<blockquote> HighLoad++   6-7 .      ,    .          ,        ( ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>).      -  <strong></strong>     ,  ,     ,     .<br>
<br>
    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Saint HighLoad++</a>!    ,  ,      PostgreSQL:   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>,     PostgreSQL    JSON    ;   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>   PostgreSQL 13,  ;   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>     .</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt489194/index.html">Como o OpenShift est√° mudando a estrutura organizacional de uma organiza√ß√£o de TI. A evolu√ß√£o dos modelos organizacionais ao mudar para PaaS</a></li>
<li><a href="../pt489196/index.html">Fuma√ßa m√°gica: microcontroladores vs. reguladores lineares</a></li>
<li><a href="../pt489198/index.html">Como n√£o se dar um tiro no p√© usando Liquibase</a></li>
<li><a href="../pt489200/index.html">O que as startups est√£o procurando pelo Y Combinator em 2020</a></li>
<li><a href="../pt489204/index.html">Uma an√°lise interna da confiabilidade dos servi√ßos do Facebook</a></li>
<li><a href="../pt489210/index.html">Teste de desempenho de c√≥digo do Linux com exemplos</a></li>
<li><a href="../pt489212/index.html">1C-Bitrix impede o cancelamento da inscri√ß√£o no boletim informativo pelo requisito de enviar seus dados pessoais</a></li>
<li><a href="../pt489214/index.html">Abordagem moderna para testar a localiza√ß√£o no iOS</a></li>
<li><a href="../pt489218/index.html">√â ing√™nuo. Super: c√≥digo e arquitetura de um jogo simples</a></li>
<li><a href="../pt489226/index.html">M√©todos para otimizar consultas LINQ em C # .NET</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>