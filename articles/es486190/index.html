<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>➰ ☕️ 💆🏾 Nuestra experiencia en el desarrollo de un controlador CSI en Kubernetes para Yandex.Cloud 👧🏾 👐🏾 🙆🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nos complace anunciar que la compañía Flant está reponiendo su contribución a las herramientas de código abierto de Kubernetes al lanzar una versión a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Nuestra experiencia en el desarrollo de un controlador CSI en Kubernetes para Yandex.Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/486190/"><img src="https://habrastorage.org/webt/1y/to/tn/1ytotnf73zepbwfalhzoropf9qa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos complace anunciar que la compañía Flant está reponiendo su contribución a las herramientas de código abierto de Kubernetes al lanzar una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versión alfa del controlador CSI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Interfaz de almacenamiento de contenedores) para Yandex.Cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero antes de pasar a los detalles de la implementación, responderemos a la pregunta de por qué esto es necesario cuando Yandex ya tiene el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servicio administrado para el servicio de Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducción</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Por qué es esto?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dentro de nuestra empresa, desde el comienzo de la operación de Kubernetes en producción (es decir, durante varios años), se está desarrollando nuestra propia herramienta (deckhouse), que, por cierto, también planeamos poner a disposición como un proyecto de Código Abierto en el futuro cercano. Con su ayuda, configuramos y configuramos de manera uniforme todos nuestros clústeres, y en este momento hay más de 100 de ellos, además, en las configuraciones de hardware más diversas y en todos los servicios en la nube disponibles.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los clústeres en los que se utiliza deckhouse tienen todos los componentes necesarios para el trabajo: equilibradores, monitoreo con gráficos, métricas y alertas convenientes, autenticación de usuarios a través de proveedores externos para acceder a todos los paneles, etc. </font><font style="vertical-align: inherit;">No tiene sentido poner un clúster "bombeado" en una solución administrada, ya que a menudo es imposible o dará lugar a la necesidad de desactivar la mitad de los componentes. </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Esta es nuestra experiencia, y es bastante específica. </font><font style="vertical-align: inherit;">De ninguna manera afirmamos que todos deberían participar de manera independiente en la implementación del clúster de Kubernetes en lugar de utilizar soluciones ya preparadas. </font><font style="vertical-align: inherit;">Por cierto, no tenemos experiencia real en la operación de Kubernetes de Yandex y no daremos ninguna evaluación de este servicio en este artículo.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué es y para quién?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, ya hablamos sobre el enfoque moderno del almacenamiento en Kubernetes: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cómo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funciona </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">CSI</font></a><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cómo la comunidad llegó</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a este enfoque. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actualmente, muchos proveedores importantes de servicios en la nube han desarrollado controladores para usar sus unidades en la nube como un volumen persistente en Kubernetes. Si el proveedor no tiene dicho controlador, pero al mismo tiempo se proporcionan todas las funciones necesarias a través de la API, entonces nada le impide implementar el controlador por su cuenta. Y así sucedió con Yandex.Cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como base para el desarrollo, tomamos el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controlador CSI para la nube DigitalOcean</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y un par de ideas del </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controlador para GCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ya que la interacción con la API de estas nubes (Google y Yandex) tiene varias similitudes. En particular, la API y</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> devuelven un objeto </font></font><code>Operation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para rastrear el estado de las operaciones a largo plazo (por ejemplo, crear un nuevo disco). </font><font style="vertical-align: inherit;">Para interactuar con la API </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Cloud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">se utiliza el SDK Yandex.Cloud Go</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado del trabajo realizado se </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">publica en GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y puede ser útil para aquellos que por alguna razón usan su propia instalación de Kubernetes en máquinas virtuales Yandex.Cloud (pero no un clúster administrado listo) y les gustaría usar (ordenar) discos a través de CSI.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementación</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Características clave</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actualmente, el controlador admite las siguientes funciones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ordenar discos en todas las zonas del clúster de acuerdo con la topología de los nodos en el clúster;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eliminar discos previamente ordenados;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cambiar el tamaño de los discos sin conexión (Yandex. Cloud </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no admite el</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aumento de discos que se montan en una máquina virtual). </font><font style="vertical-align: inherit;">Sobre cómo modificar el controlador para cambiar el tamaño de la manera más sencilla posible, vea a continuación.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el futuro, está previsto implementar soporte para la creación y eliminación de discos de instantáneas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La dificultad principal y su superación</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La falta de la capacidad de expandir discos en tiempo real en la API Yandex.Cloud es una limitación que complica la operación de cambio de tamaño para PV (volumen persistente): en este caso, es necesario detener el pod de la aplicación que usa el disco, y esto puede causar una simple aplicaciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acuerdo con </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la especificación CSI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , si el controlador CSI informa que solo puede cambiar el tamaño de los discos "fuera de línea" ( </font></font><code>VolumeExpansion.OFFLINE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), entonces el proceso de aumentar el disco debería ser así:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si el complemento solo tiene </font></font><code>VolumeExpansion.OFFLINE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacidad de expansión y el volumen está actualmente publicado o disponible en un nodo, </font></font><code>ControllerExpandVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEBE llamarse SOLO después de:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El complemento tiene </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacidad de </font><font style="vertical-align: inherit;">controlador </font><font style="vertical-align: inherit;">y </font></font><code>ControllerUnpublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se ha invocado con éxito.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SI NO</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El complemento NO tiene </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacidad de </font><font style="vertical-align: inherit;">controlador </font><font style="vertical-align: inherit;">, el complemento tiene </font></font><code>STAGE_UNSTAGE_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacidad de </font><font style="vertical-align: inherit;">nodo </font><font style="vertical-align: inherit;">y </font></font><code>NodeUnstageVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se ha completado con éxito.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SI NO</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El complemento NO tiene </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacidad de </font><font style="vertical-align: inherit;">controlador </font><font style="vertical-align: inherit;">, ni </font></font><code>STAGE_UNSTAGE_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capacidad de </font><font style="vertical-align: inherit;">nodo </font><font style="vertical-align: inherit;">, y se </font></font><code>NodeUnpublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ha completado con éxito.</font></font></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esencia, esto significa la necesidad de desconectar el disco de la máquina virtual antes de aumentarlo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, desafortunadamente, la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementación de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la especificación CSI a través del sidecar no cumple con estos requisitos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el contenedor de sidecar </font></font><code>csi-attacher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que debería ser responsable de la presencia del espacio necesario entre los montajes, esta funcionalidad simplemente no se implementa con el cambio de tamaño fuera de línea. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aquí</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se inició una discusión sobre esto </font><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué es un contenedor de sidecar en este contexto? </font><font style="vertical-align: inherit;">El complemento CSI en sí no interactúa con la API de Kubernetes, sino que solo responde a las llamadas de gRPC que los contenedores de sidecar le envían. </font><font style="vertical-align: inherit;">Estos últimos están </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">siendo desarrollados por</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la comunidad de Kubernetes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En nuestro caso (complemento CSI), la operación para aumentar el disco es la siguiente:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recibimos una llamada de gRPC </font></font><code>ControllerExpandVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Estamos intentando aumentar el disco en la API, pero tenemos un error sobre la imposibilidad de realizar la operación, ya que el disco está montado;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guardamos el identificador de disco en el mapa que contiene los discos para los que necesita realizar una operación de aumento. </font><font style="vertical-align: inherit;">Además, por brevedad, llamaremos a este mapa como </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elimine manualmente el pod que usa el disco. </font><font style="vertical-align: inherit;">Kubernetes lo reiniciará. </font><font style="vertical-align: inherit;">Para que el disco no tenga tiempo para montar ( </font></font><code>ControllerPublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) antes de completar la operación de aumento cuando intente montar, verificamos que este disco todavía está en funcionamiento </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y devuelve un error;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El controlador CSI está intentando volver a ejecutar la operación de cambio de tamaño. </font><font style="vertical-align: inherit;">Si la operación fue exitosa, elimine el disco de </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Porque </font><font style="vertical-align: inherit;">falta el identificador de disco </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>ControllerPublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es exitoso, el disco está montado, el pod se inicia.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo parece bastante simple, pero como siempre hay dificultades. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El redimensionador externo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> participa en la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">expansión del</font></a><font style="vertical-align: inherit;"> disco </font><font style="vertical-align: inherit;">, que, en caso de error durante la operación, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utiliza una cola</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con un aumento exponencial en el tiempo de espera de hasta 1000 segundos:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DefaultControllerRateLimiter</span><span class="hljs-params">()</span> <span class="hljs-title">RateLimiter</span></span> {
  <span class="hljs-keyword">return</span> NewMaxOfRateLimiter(<font></font>
  NewItemExponentialFailureRateLimiter(<span class="hljs-number">5</span>*time.Millisecond, <span class="hljs-number">1000</span>*time.Second),
  <span class="hljs-comment">// 10 qps, 100 bucket size.  This is only for retry speed and its only the overall factor (not per item)</span>
  &amp;BucketRateLimiter{Limiter: rate.NewLimiter(rate.Limit(<span class="hljs-number">10</span>), <span class="hljs-number">100</span>)},<font></font>
  )<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto puede llevar periódicamente al hecho de que la operación de aumentar el disco se alarga durante más de 15 minutos y, por lo tanto, la inaccesibilidad del pod correspondiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La única opción que nos permitió reducir el tiempo de inactividad potencial con bastante facilidad y sin dolor fue utilizar nuestra versión de redimensionador externo con un límite de tiempo de espera máximo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 segundos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
 <br>
<pre><code class="go hljs">workqueue.NewItemExponentialFailureRateLimiter(<span class="hljs-number">5</span>*time.Millisecond, <span class="hljs-number">5</span>*time.Second)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No consideramos necesario iniciar con urgencia una discusión y parchear el cambio de tamaño externo, porque los discos de cambio de tamaño sin conexión es un atavismo que pronto desaparecerá de todos los proveedores de la nube.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo empezar a usar?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador es compatible con Kubernetes versión 1.15 y superior. </font><font style="vertical-align: inherit;">Para que el conductor funcione, se deben cumplir los siguientes requisitos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El indicador se </font></font><code>--allow-privileged</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">establece en el valor </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para el servidor API y el kubelet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incluido </font></font><code>--feature-gates=VolumeSnapshotDataSource=true,KubeletPluginsWatcher=true,CSINodeInfo=true,CSIDriverRegistry=true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para el servidor API y kubelet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El montaje de propagación ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propagación de montaje</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) debe incluirse en el clúster. </font><font style="vertical-align: inherit;">Cuando se usa Docker, el demonio debe configurarse de modo que se permitan los montajes compartidos.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos los pasos necesarios para la instalación en sí se </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">describen en README</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">La instalación es la creación de objetos en Kubernetes a partir de manifiestos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que el controlador funcione, necesitará lo siguiente:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indique el identificador del directorio de catálogo Yandex.Cloud ( </font></font><code>folder-id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">en el manifiesto </font><font style="vertical-align: inherit;">( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consulte la documentación</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para interactuar con la API Yandex.Cloud en el controlador CSI, se utiliza una cuenta de servicio. </font><font style="vertical-align: inherit;">En el manifiesto secreto, debe pasar las </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">claves autorizadas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a la cuenta de servicio. </font><font style="vertical-align: inherit;">La documentación </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">describe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cómo crear una cuenta de servicio y obtener las claves.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pruébelo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y estaremos encantados de recibir comentarios y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nuevos problemas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si encuentra algún problema.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soporte adicional</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, nos gustaría señalar que implementamos este controlador CSI no por un gran deseo de divertirnos escribiendo aplicaciones en Go, sino por la necesidad urgente dentro de la empresa. </font><font style="vertical-align: inherit;">No parece aconsejable apoyar nuestra propia implementación, por lo tanto, si Yandex muestra interés y decide continuar apoyando el controlador, con mucho gusto transferiremos el repositorio a su disposición. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, probablemente, Yandex en el clúster administrado de Kubernetes tiene su propia implementación del controlador CSI, que se puede lanzar en código abierto. </font><font style="vertical-align: inherit;">Esta opción de desarrollo también nos parece favorable: la comunidad podrá utilizar el controlador comprobado del proveedor de servicios y no de una empresa de terceros.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PD</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lea también en nuestro blog:</font></font><br>
<br>
<ul>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> Kubernetes CCM (Cloud Controller Manager)  .</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">     Kubernetes:  Flexvolume  CSI</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> Container Storage Interface ( Kubernetes   )</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> Kubernetes-   ?  addon-operator</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">   Kubernetes (   )</a>».</li>
</ul></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es486190/">https://habr.com/ru/post/es486190/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es486178/index.html">FOSS News No. 1 - revisión de noticias gratuitas y de código abierto del 27 de enero al 2 de febrero de 2020</a></li>
<li><a href="../es486180/index.html">Consejos y fuentes para crear aplicaciones sin servidor</a></li>
<li><a href="../es486184/index.html">Cómo usar la búsqueda de manera efectiva</a></li>
<li><a href="../es486186/index.html">Nube catastrófica: cómo funciona</a></li>
<li><a href="../es486188/index.html">Presentación del sistema de copia de seguridad wal-g de PostgreSQL</a></li>
<li><a href="../es486192/index.html">Los estafadores cibernéticos piratean a los operadores móviles para obtener números de teléfono de suscriptores</a></li>
<li><a href="../es486194/index.html">Acerca de las copias de seguridad en Proxmox VE</a></li>
<li><a href="../es486198/index.html">Hablar es difícil. Ensayos sobre comunicación con no programadores</a></li>
<li><a href="../es486200/index.html">Consejos de Docker: limpie su máquina de basura</a></li>
<li><a href="../es486202/index.html">Alpine recoge las construcciones de Docker bajo Python 50 veces más lento, y las imágenes son 2 veces más pesadas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>