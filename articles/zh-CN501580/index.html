<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¦ ğŸ‘ğŸ¼ ğŸ˜– åœ¨Docker Composeä¸­æ„å»ºæ—¶çš„å®‰å…¨ç§˜å¯† ğŸ”‹ ğŸ‘¨ğŸ¾â€ğŸ³ ğŸ§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨Python Web Developerè¯¾ç¨‹å¼€å§‹ä¹‹å‰å‡†å¤‡äº†æ–‡ç« çš„ç¿»è¯‘ã€‚
 
 
  
 æ„å»ºDockeræ˜ åƒæ—¶ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¸€äº›ç§˜å¯†ï¼Œä¾‹å¦‚ç§æœ‰è½¯ä»¶åŒ…å­˜å‚¨åº“çš„å¯†ç ã€‚æ‚¨ä¸å¸Œæœ›è¿™ä¸ªç§˜å¯†å‡ºç°åœ¨å›¾åƒä¸­ï¼Œå› ä¸ºè¿™æ ·ï¼Œä»»ä½•æœ‰æƒè®¿é—®è¯¥å›¾åƒçš„äººéƒ½å¯ä»¥è®¿é—®æ‚¨çš„ç§æœ‰å­˜å‚¨åº“ã€‚
 æ³¨æ„ï¼šå¦‚æœæ‚¨è®¤ä¸ºâ€œä¸ºä»€ä¹ˆä¸åªä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Ÿâ€ï¼Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>åœ¨Docker Composeä¸­æ„å»ºæ—¶çš„å®‰å…¨ç§˜å¯†</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/501580/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python Web Developer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯¾ç¨‹å¼€å§‹ä¹‹å‰å‡†å¤‡äº†æ–‡ç« çš„ç¿»è¯‘</font><font style="vertical-align: inherit;">ã€‚</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/fp/lk/_j/fplk_j0lrqwtycgbopj8dofvevw.png"><br>
<hr> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ„å»ºDockeræ˜ åƒæ—¶ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¸€äº›ç§˜å¯†ï¼Œä¾‹å¦‚ç§æœ‰è½¯ä»¶åŒ…å­˜å‚¨åº“çš„å¯†ç ã€‚</font><font style="vertical-align: inherit;">æ‚¨ä¸å¸Œæœ›è¿™ä¸ªç§˜å¯†å‡ºç°åœ¨å›¾åƒä¸­ï¼Œå› ä¸ºè¿™æ ·ï¼Œä»»ä½•æœ‰æƒè®¿é—®è¯¥å›¾åƒçš„äººéƒ½å¯ä»¥è®¿é—®æ‚¨çš„ç§æœ‰å­˜å‚¨åº“ã€‚</font></font><br>
 <blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ³¨æ„</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šå¦‚æœæ‚¨è®¤ä¸ºâ€œä¸ºä»€ä¹ˆä¸åªä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Ÿâ€ï¼Œåˆ™åœ¨åˆ›å»ºæ˜ åƒæ—¶å°†å…¶ç”¨äºè¿è¡Œæ—¶çš„æœºå¯†ã€‚</font><font style="vertical-align: inherit;">æœ¬æ–‡é‡ç‚¹ä»‹ç»åœ¨ä½¿ç”¨Dockeræ–‡ä»¶åˆ›å»ºæ˜ åƒæ—¶ä½¿ç”¨çš„æ„å»ºæœºå¯†ã€‚</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¾ƒæ–°ç‰ˆæœ¬çš„Dockerä½¿ç”¨å®éªŒæ€§</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BuildKit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœåŠ¡ç»´æŠ¤ç§˜å¯†</font><font style="vertical-align: inherit;">ï¼Œåœ¨Docker Compose 1.25åŠæ›´é«˜ç‰ˆæœ¬ä¸­ï¼Œæ‚¨å·²ç»å¯ä»¥ä½¿ç”¨BuildKitåˆ›å»ºæ˜ åƒã€‚</font><font style="vertical-align: inherit;">ä¸å¹¸çš„æ˜¯ï¼Œæˆªè‡³2020å¹´3æœˆï¼Œä»åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¼€å‘</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®‰å…¨å¤„ç†Composeæœºå¯†â€‹â€‹çš„åŠŸèƒ½</font><font style="vertical-align: inherit;">ã€‚</font></font><a name="habracut"></a><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é‚£ä¹ˆç°åœ¨è¯¥æ€ä¹ˆåŠï¼Ÿ</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨ä»Šå¤©çš„æ–‡ç« ä¸­ï¼Œæˆ‘å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ç›¸åŒçš„Dockerfileå®‰å…¨åœ°åˆ›å»ºç§˜å¯†æ˜ åƒï¼Œè€Œåˆä¸ä¼šå¤±å»ä½¿ç”¨Docker Composeè¿›è¡Œå¿«é€Ÿå¼€å‘çš„å¥½å¤„ã€‚</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿ç”¨dockerfileçš„ä¸¤ä¸ªé€‰é¡¹</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 åœ¨Docker Composeä¸­ä½¿ç”¨ç›¸åŒçš„Dockerfileè¿›è¡Œç”Ÿäº§å’Œæœ¬åœ°å¼€å‘éå¸¸æ–¹ä¾¿ã€‚</font><font style="vertical-align: inherit;">é€šå¸¸ï¼Œæ‚¨å°†Dockerfileä¸Composeçš„æ„å»ºåŠŸèƒ½ä¸€èµ·ä½¿ç”¨ï¼š</font></font><br>
<br>
<pre><code class="python hljs">version: <span class="hljs-string">"3.7"</span><font></font>
services:<font></font>
  yourapp:<font></font>
    build:<font></font>
      context: <span class="hljs-string">"."</span>	</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ç„¶åï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ä½¿ç”¨æ­¤å‘½ä»¤ï¼Œæ‚¨å¯ä»¥ï¼ˆé‡æ–°ï¼‰ç»„è£…æ˜ åƒï¼Œç„¶åè¿è¡Œå®ƒã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ä¸ºäº†åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ï¼Œæ‚¨å¯ä»¥æ”¶é›†å›¾åƒå¹¶é€šè¿‡</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">push</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‘é€</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="python hljs">$ docker build -t myimage .<font></font>
$ docker push myimage</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ä¸€åˆ‡é¡ºåˆ©ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œå¦‚æœæ‚¨éœ€è¦ç§˜å¯†æ„å»ºè¯¥æ€ä¹ˆåŠï¼Ÿ</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç¬¬ä¸€æ¬¡å°è¯•ï¼ˆä¸å®‰å…¨ï¼‰</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 å‡è®¾æ‚¨æœ‰ä¸€ä¸ªéœ€è¦ç§˜å¯†æ„å»ºçš„è„šæœ¬ï¼Œä¾‹å¦‚ï¼Œä»ç§æœ‰</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DevPI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å­˜å‚¨åº“ä¸­ä¸‹è½½Pythonè½¯ä»¶åŒ…</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†åœ¨å¸®åŠ©ä¸‹ç®€å•åœ°æ¨å¯¼å‡ºç§˜å¯†ï¼Œ</font></font><code>use-secret.sh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»¥è¡¨æ˜æˆ‘ä»¬æ‹¥æœ‰</font><font style="vertical-align: inherit;">è¯¥ç§˜å¯†</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/bin/bash</span><font></font>
set -euo pipefail<font></font>
<font></font>
echo <span class="hljs-string">"Secret is: $THEPASSWORD"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 æ‚¨å¯ä»¥ç®€å•åœ°ä½¿ç”¨Dockeræ„å»ºå‚æ•°ä¼ é€’ç§˜å¯†ï¼Œå› ä¸ºå®ƒåœ¨Docker Composeä¸­å¾—åˆ°äº†å¹¿æ³›æ”¯æŒã€‚</font></font><br>
 <blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ³¨æ„</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šè¶…å‡ºæˆ‘ä»¬è®¨è®ºçš„èŒƒå›´ï¼Œæˆ‘æƒ³è¯´çš„æ˜¯ï¼Œåœ¨æœ¬æ–‡ä¸­ä½¿ç”¨Dockeræ–‡ä»¶ä¸æ˜¯æœ€ä½³å®è·µï¼Œä½†æ˜¯ï¼Œè¿‡äºå¤æ‚å¯èƒ½ä¼šå¹²æ‰°ä¼ è¾¾æœ¬æ–‡çš„ä¸»è¦å«ä¹‰ã€‚</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> å› æ­¤ï¼Œå¦‚æœè¦åœ¨ä½¿ç”¨Dockerçš„ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡ŒPythonåº”ç”¨ç¨‹åºï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹ä¸¤ç§å¥½çš„æ–¹æ³•ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœæ‚¨éœ€è¦DIYï¼š</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">å¸¦æœ‰ç¤ºä¾‹å’Œé“¾æ¥</font></a><font style="vertical-align: inherit;">çš„</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¯¦ç»†åˆ—è¡¨</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœæ‚¨éœ€è¦å°½å¿«çš„å·¥ä½œç‰ˆæœ¬ï¼šè€ƒè™‘</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">æœ€ä½³å®è·µ</font></a><font style="vertical-align: inherit;">çš„æ¨¡æ¿</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a></li>
</ul><br>
<pre><code class="python hljs">FROM python:<span class="hljs-number">3.8</span>-slim-buster
<span class="hljs-comment"># Using ARG for build secrets is INSECURE!</span><font></font>
ARG THEPASSWORD<font></font>
COPY use_secret.sh .<font></font>
RUN ./use_secret.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å¯ä»¥ç¼–å†™</font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå®ƒå°†ç§˜å¯†ä¼ è¾“ï¼š</font></font><br>
<br>
<pre><code class="python hljs">version: <span class="hljs-string">"3.7"</span><font></font>
services:<font></font>
  yourapp:<font></font>
    build:<font></font>
      context: <span class="hljs-string">"."</span><font></font>
      args:<font></font>
        THEPASSWORD: <span class="hljs-string">"s3kr!t"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºæœ¬åœ°å·¥ä½œï¼Œå¯ä»¥ä½¿ç”¨Composeè¿è¡Œæˆ–æ„å»ºæ˜ åƒï¼š</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose build | grep Secret<font></font>
Secret <span class="hljs-keyword">is</span>: s3kr!t</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸€åˆ‡éƒ½å¾ˆå¥½ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨Dockerç»„è£…æ˜ åƒï¼Œä»¥å‡†å¤‡å°†å…¶ç§»è‡³æ˜ åƒæ³¨å†Œè¡¨ï¼š</font></font><br>
<br>
<pre><code class="python hljs">$ docker build -t myimage --build-arg THEPASSWORD=s3krit . | grep Secret<font></font>
Secret <span class="hljs-keyword">is</span>: s3krit</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™æ ·åšæ˜¯ä¸å®‰å…¨çš„ï¼šæ°¸è¿œä¸è¦è¿™æ ·åš</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæˆ‘ä»¬å†³å®šæŸ¥çœ‹å›¾åƒçš„å„ä¸ªå±‚ï¼Œå°±ä¼šå‘ç°å…¶ä¸­éšè—ç€ç§˜å¯†ï¼</font></font><br>
<br>
<pre><code class="python hljs">$ docker history myimage<font></font>
IMAGE               CREATED              CREATED BY                                      SIZE<font></font>
c224231ec30b        <span class="hljs-number">47</span> seconds ago       |<span class="hljs-number">1</span> THEPASSWORD=s3krit /bin/sh -c ./use_secreâ€¦   <span class="hljs-number">0</span>B
<span class="hljs-number">6</span>aef62acf0db        <span class="hljs-number">48</span> seconds ago       /bin/sh -c <span class="hljs-comment">#(nop) COPY file:7aa28bbe6595e0d5â€¦   62B</span>
f88b19ca8e65        About a minute ago   /bin/sh -c <span class="hljs-comment">#(nop)  ARG THEPASSWORD              0B</span>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ‰æƒè®¿é—®è¯¥å›¾åƒçš„ä»»ä½•äººéƒ½å¯ä»¥è¯†åˆ«æ‚¨çš„å¯†ç ã€‚</font><font style="vertical-align: inherit;">é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BuildKitçš„ç§˜å¯†ï¼ˆéƒ¨åˆ†è§£å†³æ–¹æ¡ˆï¼‰</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BuildKitæ˜¯ç”¨äºåˆ›å»ºDockeræ˜ åƒçš„æ–°çš„ï¼ˆä»åœ¨è¯•éªŒä¸­ï¼‰è§£å†³æ–¹æ¡ˆï¼Œé™¤å…¶ä»–å¤–ï¼Œå®ƒè¿˜å¢åŠ äº†</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨ç»„è£…è¿‡ç¨‹ä¸­</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®‰å…¨ä½¿ç”¨æœºå¯†çš„æ”¯æŒ</font><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">Docker Composeè‡ªv1.25èµ·æä¾›äº†BuildKitæ”¯æŒã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼šDocker Composeä»ç„¶ä¸æ”¯æŒBuildKit secretsåŠŸèƒ½ã€‚</font><font style="vertical-align: inherit;">ç°åœ¨</font><font style="vertical-align: inherit;">å¯¹æ­¤</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å·¥ä½œæ­£åœ¨è¿›è¡Œ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸­ï¼Œä½†æ˜¯æˆªè‡³2020å¹´3æœˆï¼Œè¿˜æ²¡æœ‰ç°æˆçš„è§£å†³æ–¹æ¡ˆï¼Œæ›´ä¸ç”¨è¯´ä¸€ä¸ªç¨³å®šçš„ç‰ˆæœ¬äº†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œæˆ‘ä»¬å°†ç»“åˆè¿™ä¸¤ç§æ–¹æ³•ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Composeå°†ç»§ç»­ä½¿ç”¨æ„å»ºå‚æ•°æ¥ä¼ é€’ç§˜å¯†ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹äºä½¿ç”¨docker buildæ„å»ºçš„ç”Ÿäº§æ˜ åƒï¼Œæˆ‘ä»¬ä½¿ç”¨BuildKitä¼ é€’ç§˜å¯†ã€‚</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„Dockerfileåœ¨æœ¬åœ°å’Œç”Ÿäº§ç¯å¢ƒä¸­å·¥ä½œã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BuildKitå¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼ä½¿ç”¨æœºå¯†ï¼šå¸¦æœ‰æœºå¯†çš„æ–‡ä»¶åœ¨æ‰§è¡ŒRUNå‘½ä»¤æ—¶ä¼šæŒ‚è½½åœ¨ä¸€ä¸ªä¸´æ—¶ç›®å½•ä¸­ï¼Œä¾‹å¦‚</font></font><code>/var/secrets/thepassword</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ç”±äºå®ƒæ˜¯åœ¨æ‰§è¡ŒRUNå‘½ä»¤æœŸé—´å®‰è£…çš„ï¼Œå› æ­¤ä¸ä¼šå°†å…¶æ·»åŠ åˆ°æœ€ç»ˆæ˜ åƒä¸­ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å°†ä¿®æ”¹æ–‡ä»¶</font></font><code>use_secret.sh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¿™æ ·çš„ä¸´æ—¶æ–‡ä»¶ã€‚</font><font style="vertical-align: inherit;">å¦‚æœå­˜åœ¨ï¼Œå®ƒå°†ä½¿ç”¨å…¶ç¯å¢ƒå˜é‡è®¾ç½®</font></font><code>$THEPASSWORD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†è¿”å›åˆ°ç¯å¢ƒå˜é‡ã€‚</font><font style="vertical-align: inherit;">ä¹Ÿå°±æ˜¯è¯´ï¼Œ</font></font><code>$THEPASSWORD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯ä»¥ä½¿ç”¨BuildKitæˆ–buildå‚æ•°å®‰è£…</font><font style="vertical-align: inherit;">å®ƒ</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#!/bin/bash</span><font></font>
set -euo pipefail<font></font>
<span class="hljs-keyword">if</span> [ -f /run/secrets/thepassword ]; then<font></font>
   export THEPASSWORD=$(cat /run/secrets/thepassword)<font></font>
fi<font></font>
<font></font>
echo <span class="hljs-string">"Secret is: $THEPASSWORD"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç„¶åï¼Œæˆ‘ä»¬å°†ä¿®æ”¹Dockerfileä»¥æ·»åŠ BuildKitå¹¶å®‰è£…ç§˜å¯†ï¼š</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># syntax = docker/dockerfile:1.0-experimental</span>
FROM python:<span class="hljs-number">3.8</span>-slim-buster
<span class="hljs-comment"># Only use the build arg for local development:</span><font></font>
ARG THEPASSWORD<font></font>
COPY use_secret.sh .<font></font>
<span class="hljs-comment"># Mount the secret to /run/secrets:</span>
RUN --mount=type=secret,id=thepassword ./use_secret.sh</code></pre><br><font style="vertical-align: inherit;"></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬ä¸æ›´æ”¹</font><font style="vertical-align: inherit;">
æ–‡ä»¶</font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="python hljs">version: <span class="hljs-string">"3.7"</span><font></font>
services:<font></font>
  yourapp:<font></font>
    build:<font></font>
      context: <span class="hljs-string">"."</span><font></font>
      args:<font></font>
        THEPASSWORD: <span class="hljs-string">"s3kr!t"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæ‚¨éœ€è¦å®šä¹‰ä¸¤ä¸ªç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­ä¸€ä¸ªå°†å‘Šè¯‰Dockeræ‚¨éœ€è¦ä½¿ç”¨BuildKitï¼Œç¬¬äºŒä¸ªç¯å¢ƒæ˜¯Composeéœ€è¦ä½¿ç”¨Dockerçš„CLIç‰ˆæœ¬ä»¥åŠBuildKitã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬è¿˜å°†æŠŠæœºå¯†å†™å…¥æ–‡ä»¶ï¼š</font></font><br>
<br>
<pre><code class="python hljs">$ export DOCKER_BUILDKIT=<span class="hljs-number">1</span>
$ export COMPOSE_DOCKER_CLI_BUILD=<span class="hljs-number">1</span>
$ echo <span class="hljs-string">'s3krit'</span> &gt; /tmp/mypassword</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹äºComposeï¼Œæˆ‘ä»¬ä½¿ç”¨buildå‚æ•°ï¼š</font></font><br>
<br>
<pre><code class="python hljs">$ docker-compose build --progress=plain \<font></font>
    --no-cache <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> | grep Secret
<span class="hljs-comment">#12 0.347 Secret is: s3kr!t</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯·æ³¨æ„ï¼Œ</font></font><code>--no-cache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦‚æœæ‚¨è‡ªå·±æ‰§è¡Œä¸Šè¿°æ‰€æœ‰æ“ä½œï¼Œ</font><font style="vertical-align: inherit;">åˆ™</font><font style="vertical-align: inherit;">å¿…é¡»äº†è§£è¯¥æ˜ åƒå°†çœŸæ­£é‡å»ºã€‚</font><font style="vertical-align: inherit;">åœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œå¯ä»¥çœç•¥æ­¤å‚æ•°ã€‚</font></font><code>2&gt;&amp;1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é‡å®šå‘</font></font><code>stderr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ°</font></font><code>stdout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­£ç¡®çš„æ“ä½œ</font></font><code>grep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å½“æˆ‘ä»¬å‡†å¤‡åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šè¿›è¡Œæ„å»ºæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨å…·æœ‰BuildKitç§˜å¯†åŠŸèƒ½çš„docker buildï¼š</font></font><br>
<br>
<pre><code class="python hljs">$ docker build --no-cache -t myimage \<font></font>
    --secret id=thepassword,src=/tmp/mypassword \<font></font>
    --progress=plain . <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> | grep Secret
<span class="hljs-comment">#12 0.359 Secret is: s3krit</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®‰å…¨å—ï¼Ÿ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬ç¡®ä¿ç§˜å¯†ä¸å¯è§ï¼š</font></font><br>
<br>
<pre><code class="python hljs">$ docker history myimage<font></font>
IMAGE               CREATED             CREATED BY                                      SIZE<font></font>
a77f3c32b723        <span class="hljs-number">25</span> seconds ago      RUN |<span class="hljs-number">1</span> THEPASSWORD= /bin/sh -c ./use_secret.â€¦   <span class="hljs-number">0</span>B<font></font>
&lt;missing&gt;           <span class="hljs-number">25</span> seconds ago      COPY use_secret.sh . <span class="hljs-comment"># buildkit                 160B</span>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸‡å²ï¼</font><font style="vertical-align: inherit;">æˆ‘ä»¬ä½¿ç”¨Composeå’Œå°†ç§˜å¯†ä¼ é€’ç»™äº†ç›¸åŒçš„Dockerfile </font></font><code>docker build</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œåœ¨åä¸€ç§æƒ…å†µä¸‹å¹¶æœªä»ç¨‹åºé›†ä¸­æ­ç¤ºç§˜å¯†ã€‚</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº†è§£æœ‰å…³è¯¥è¯¾ç¨‹çš„æ›´å¤šä¿¡æ¯ã€‚</font></font></a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN501570/index.html">é”¯Meduza Webé—®å·ï¼šåˆå­¦è€…åˆ†æ­¥æŒ‡å—</a></li>
<li><a href="../zh-CN501572/index.html">æˆ˜äº‰68000ï¼Œç¬¬2éƒ¨åˆ†ï¼šæ°å…‹å½’æ¥</a></li>
<li><a href="../zh-CN501574/index.html">è¯„åˆ†ã€‚è®¡ç®—å¹¶æ»¡è¶³</a></li>
<li><a href="../zh-CN501576/index.html">å‡†å¤‡åŠ æ²¹</a></li>
<li><a href="../zh-CN501578/index.html">ä¿®è¾ä½œä¸ºä¸€ç§å®‰å…¨å·¥å…·ã€‚å£è¯­æ¼”è®²å’Œå¸å¼•æŠ€å·§</a></li>
<li><a href="../zh-CN501582/index.html">äºšé©¬é€Šå’Œé€Ÿå–é€šçš„åŠ¨æ€ä»·æ ¼å¦‚ä½•å¯¼è‡´ä»·å€¼2400ä¸‡ç¾å…ƒçš„å•†å“</a></li>
<li><a href="../zh-CN501588/index.html">å¯¹å„ç§æ¶æ„çš„å¤„ç†å™¨è¿›è¡Œäº†å‡ºè‰²çš„æµ‹è¯•</a></li>
<li><a href="../zh-CN501590/index.html">ç”¨è‹±è¯­æ’°å†™çš„æ–‡ç« ï¼šæ®‹é…·çš„è§„åˆ™ä¸ä¾‹å¤–ä¹‹æˆ˜</a></li>
<li><a href="../zh-CN501594/index.html">é€ƒç¦»åŠ¨ç‰©å›­æˆ–å¦‚ä½•åœ¨iOSä¸Šåšä¼‘é—²æ¸¸æˆ</a></li>
<li><a href="../zh-CN501596/index.html">ä½¿ç”¨Gitæ—¶å¦‚ä½•ä½¿ç”Ÿæ´»æ›´è½»æ¾ï¼ˆä»¥åŠç”¨äºæ·±åº¦æµ¸æ³¡çš„å¤šç§ææ–™ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>