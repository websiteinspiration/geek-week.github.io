<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•£ üå•Ô∏è üîõ Problemas e recursos da implementa√ß√£o UEFI em v√°rias plataformas üòù üë©üèª üß¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aproximadamente dezenove anos se passaram desde o lan√ßamento da primeira especifica√ß√£o EFI no ano 2000. A interface levou dez anos para entrar no merc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Problemas e recursos da implementa√ß√£o UEFI em v√°rias plataformas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/gaz-is/blog/493822/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aproximadamente dezenove anos se passaram desde o lan√ßamento da primeira especifica√ß√£o EFI no ano 2000. A interface levou dez anos para entrar no mercado de usu√°rios e ganhar uma posi√ß√£o nele. No momento, raramente voc√™ v√™ um computador moderno sem UEFI no firmware da placa-m√£e. O padr√£o de interface aumentou a "carne" e v√°rios milhares de p√°ginas na documenta√ß√£o oficial. Para o usu√°rio m√©dio, nada mudou, exceto colis√µes ocasionais com o Secure Boot ativado. Mas se o plano de trabalho muda para o desenvolvimento, tudo se torna mais interessante.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1f/ek/as/1fekaswnox-diqt-hgzmaiqnq4g.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pr√≥prio conceito da arquitetura modular da UEFI implica que esses m√≥dulos n√£o podem ser usados ‚Äã‚Äãapenas na configura√ß√£o padr√£o, mas tamb√©m fazer o download de algo pr√≥prio. O driver do sistema de arquivos (n√£o limitado ao nativo eFi-shy FAT?), Drivers perif√©ricos, aplicativos, gerenciadores de inicializa√ß√£o - voc√™ pode carregar tudo manualmente, seria bom carregar um pouco do Shell. Voc√™ pode dar um passo "mais profundo" e observar o conte√∫do do firmware, evitando dan√ßar com o SecureBoot e a necessidade de escrever uma camada de scripts (h√° artigos suficientes nas p√°ginas do hub).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesta base, nasceu a ideia de criar m√≥dulos funcionais que executam v√°rias fun√ß√µes de seguran√ßa antes de carregar o sistema operacional, o que pode unir-se e se tornar um tipo de ambiente de inicializa√ß√£o confi√°vel integrado, afetando os servi√ßos da interface de inicializa√ß√£o e tempo de execu√ß√£o, de forma que entre os m√≥dulos no firmware e os m√≥dulos no disco nada poderia ser "empurrado" sem interven√ß√£o de baixo n√≠vel e depois deles - somente com a permiss√£o do administrador de seguran√ßa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A implementa√ß√£o dessa id√©ia nos apresentou um grande n√∫mero de nuances e sutilezas do UEFI - come√ßando com muitos recursos, bugs e documentos n√£o documentados ou mal documentados e terminando com o comportamento indefinido t√£o amado por todos os desenvolvedores. </font><font style="vertical-align: inherit;">Vamos come√ßar em ordem.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depend√™ncia de plataforma</font></font></h4><br>
<img src="https://habrastorage.org/webt/wn/pz/1f/wnpz1fwi6hrqqhoogamysefkdic.png" width="770"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira coisa que voc√™ precisa descobrir ao se integrar √† plataforma √© se podemos trabalhar com ela? A vers√£o da especifica√ß√£o UEFI √© importante e, na maioria dos dispositivos, √© apresentada na faixa entre 2,1 e 2,7. O mais novo ainda n√£o chegou ao suporte de pesquisa. O mais antigo √© encontrado e seu desempenho pode ser limitado devido √† falta dos protocolos necess√°rios ou dos drivers escritos de forma incorreta para sua implementa√ß√£o. Por exemplo, UnicodeCollation geralmente n√£o √© suficiente. Ao acessar smbios, existem erros n√£o documentados, as fun√ß√µes de altera√ß√£o de idioma por meio de SetVariable () n√£o funcionam. Tudo pode acontecer, dependendo do fornecedor e da atualiza√ß√£o, porque √†s vezes voc√™ precisa colocar seus protocolos at√© em placas relativamente novas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo em nossa pr√°tica, tive a sorte de encontrar dois mini-computadores com Intel Bay Trail D e firmware de 32 bits a bordo. O caso √© raro, mas ao mesmo tempo tornou necess√°rio recompilar urgentemente os m√≥dulos. Na verdade, como a pergunta: encontraremos uma plataforma mais moderna com a mesma capacidade no futuro? E se nos encontrarmos, ent√£o onde?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pr√≥ximo passo √© determinar como integrar. Os m√≥dulos est√£o embutidos no firmware, o firmware est√° localizado no chip SPI na placa e o PCH com Intel ME est√° localizado nas proximidades. E aqui surge a pergunta mais interessante - como chegar l√°? Bom programador antigo com um "crocodilo" - isso √© bom, √© confi√°vel. Mesmo se voc√™ n√£o entender o que est√° acontecendo, sempre poder√° observar os LEDs em chamas na placa, pois eles t√™m energia suficiente do programador. Funciona quase perfeitamente, com exce√ß√£o de alguns modelos antigos da HP, onde o mikruha SOIC-16 com firmware √© t√£o acess√≠vel que √© mais f√°cil fabricar e soldar o adaptador nas pernas do que apertar o clipe. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/uu/ce/6b/uuce6bumbvwdovmxow0ntfoeynm.png" width="770"><br>
<img src="https://habrastorage.org/webt/qj/kf/k1/qjkfk14esp5_ol1vchn8fkaiwt4.png" width="770"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu sei que h√° pessoas em Habr√© que contribu√≠ram para a escrita do flashrom, gra√ßas a elas separadamente.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, apesar da confiabilidade e confiabilidade da remo√ß√£o de despejo pelo programador, esse m√©todo n√£o √© adequado se voc√™ precisar instalar algo no UEFI em v√°rias m√°quinas ou se a plataforma de destino para instala√ß√£o n√£o estiver em sua mesa. Felizmente para n√≥s, os fabricantes deixaram para tr√°s utilit√°rios de firmware nativos: FPT (ferramenta de programa√ß√£o Flash) do kit Intel (CS) ME System Tools e AFU (AMI Firmware Update) para Aptio da American Megatrends. Esses utilit√°rios s√£o iniciados no ambiente EFI e nos sistemas operacionais Windows, Linux e DOS. Os utilit√°rios s√£o um tanto intercambi√°veis, ambos permitem que voc√™ considere a imagem, se n√£o o todo, e certas regi√µes com certeza. E √†s vezes at√© deixam voc√™ escrever de volta. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/hk/vz/pp/hkvzppckxwb02epv3ieytikh5y0.png" width="770"><br>
<img src="https://habrastorage.org/webt/we/qx/3y/weqx3ysvpinegiv9gxh9biw7xdg.png" width="770"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ele escreve e n√£o escreve</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â aqui que o primeiro obst√°culo s√©rio no caminho da integra√ß√£o aparece. Nem todas as placas-m√£e permitem a leitura de todo o firmware, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proibindo o acesso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† regi√£o ME (ME √© quase sagrado, a Intel n√£o permitir√° que seja lida de uma maneira boa, mas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de uma maneira ruim</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nem sempre queremos). Menos ainda - coloque algo uniforme na regi√£o do BIOS, a menos que seja uma c√°psula assinada. A probabilidade de sucesso varia muito, dependendo do fabricante e da atualiza√ß√£o do chipset. Em alguns modelos de placas-m√£e, √© poss√≠vel observar uma imagem engra√ßada: a que n√£o foi registrada nas placas de fornecedores antigos voa em novos momentos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Äs vezes, o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">analisador IFR</font></a><font style="vertical-align: inherit;"> ajuda a combater a prote√ß√£o contra grava√ß√£o</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que abre a cortina em configura√ß√µes e vari√°veis ‚Äã‚Äãocultas. </font><font style="vertical-align: inherit;">E, √†s vezes, apenas um jumper hardcore ajuda, permitindo o acesso √† grava√ß√£o ou "desligando" o ME (se houver, √© claro).</font></font><br>
 <br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A natureza complexa dos sistemas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As placas Acer, Asus, AsRock e Gigabyte na maioria dos casos s√£o escritas sem dificuldades desnecess√°rias. </font><font style="vertical-align: inherit;">Intel, HP e hardware de servidor se destacam. </font><font style="vertical-align: inherit;">A HP n√£o apenas permite escrever em si de forma program√°tica, como tamb√©m jura em qualquer tentativa de modificar o firmware (em</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CodeRush</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">existem </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artigos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre como encontrar e desativar a verifica√ß√£o de integridade). A Intel registrou mais ou menos at√© o 87¬∫ chipset, depois ficou surda as solicita√ß√µes para abrir os port√µes da regi√£o do BIOS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com a Intel, a primeira vez foi engra√ßada. Os m√≥dulos foram importados para o firmware usando o utilit√°rio UEFITool, e encontramos um bug interessante: se inserirmos m√≥dulos ffs no final do volume DXE, depois de todas as formas livres, a imagem montada "bloqueou" a placa. A solu√ß√£o foi adicionar m√≥dulos ap√≥s qualquer driver DXE nativo. N√£o chegamos a isso imediatamente e, a princ√≠pio, parecia que a Intel estava monitorando a integridade do firmware, como a HP. Mais tarde, ficou claro que n√£o se poderia prescindir de um utilit√°rio autom√°tico para importa√ß√£o de m√≥dulos, e o problema acabou em nada depois de escrev√™-lo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O hardware do servidor √© mais simples e mais complexo ao mesmo tempo. Por um lado, sempre existem maneiras adicionais de atualizar e modificar BIOSs em servidores, por outro lado, o volume de personaliza√ß√£o nesses mesmos BIOS √© esmagador, pois eles n√£o economizam nos servidores e instalam chips de mem√≥ria flash bastante espa√ßosos, geralmente tamb√©m fazendo backup deles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao instalar em um servidor, √© sempre bom poder atualizar remotamente o BIOS via IPMI. √â verdade que, para isso, voc√™ precisa de uma licen√ßa, √© claro, paga. Se n√£o aparecer no momento certo, √© bem poss√≠vel entrar em uma situa√ß√£o engra√ßada semelhante √† que tivemos ao introduzir m√≥dulos no BIOS do servidor Supermicro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s a introdu√ß√£o dos m√≥dulos, a carga congela fortemente devido ao bloqueio por um dos m√≥dulos de seguran√ßa (eles n√£o levaram em conta a desobedi√™ncia dos BIOSs do servidor, com quem isso n√£o acontece!). Na aus√™ncia da capacidade de for√ßar o BIOS a ser revertido via IPMI, a m√£o procurou o programador, mas foi uma m√° sorte - o clipe SOIC-8 padr√£o n√£o era suficiente para um chip SOIC-16! Bem, tudo bem, porque em teoria a placa do servidor tem a capacidade de fazer backup da m√≠dia conectada, captando a imagem SUPER.ROM na raiz. Mas esse mecanismo n√£o inicia, porque de acordo com o sistema tudo est√° OK, tudo funciona, portanto, a revers√£o do BIOS n√£o √© necess√°ria! O que fazer ?! A hist√≥ria acabou circulando pela cidade em busca do clipe certo, uma soldagem de emerg√™ncia de fios, manchada pelos chineses em uma ordem incompreens√≠vel para n√≥s e, finalmente - um piscar de olhos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A Lenovo saiu ainda mais interessante. Nos comutadores recebidos do fornecedor, sob a capa do gabinete, foi encontrada uma placa de controle com dois "mikruhs" para firmware, com um SSD para sistemas operacionais e com uma bateria fixa. O BIOS acabou por ser um osso duro de roer, eu n√£o queria comer uma imagem modificada de forma alguma, sucumbindo apenas ao programador. Em uma das tentativas de escrever algo, eles inseriram uma unidade flash com o console ubuntu no switch (o terminal n√£o exibiu gr√°ficos) e inicializaram com bastante seguran√ßa. Depois de fazer o que era necess√°rio, eles desligaram o sistema usando o comando halt -p da mem√≥ria antiga. O interruptor, por sua natureza n√£o adaptado a nenhum desligamento, exceto pela falta de energia, n√£o estava pronto para isso e n√£o queria mais come√ßar. O link no rosto queimou uma vez, os ventiladores farfalharam silenciosamente, e todos os portos n√£o deram nada. Re-piscar n√£o ajudou,a bateria parecia uma luva - t√≠nhamos medo de quebrar o suporte. Como resultado, uma fina placa diel√©trica se arrastou sob a for√ßa da perseveran√ßa e inspira√ß√£o verbal sob os contatos, a mem√≥ria vol√°til foi apagada e a chave voltou √† vida.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O estudo de lix√µes retirados de dois chips mostrou muitas coisas interessantes. Em particular, um grande n√∫mero de entradas "Inv√°lidas" na NVRAM do firmware principal e v√°rias similares no backup. Bem, e n√£o um hash de dados encontrado anteriormente no volume com drivers DXE. S√≥ se podia adivinhar a causa exata do problema de iniciar a troca. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, a parte do software raramente √© privada de nuances inesperadas. Muitas placas-m√£e que chegaram antes do 87¬∫ chipset (de diferentes fabricantes) possuem um recurso desagrad√°vel para produzir um fluxo intermin√°vel de erros ao inserir o comando "dh -v" no console do shell. Com a entrada manual, isso n√£o √© cr√≠tico, mas ao coletar dados em um arquivo, ele termina em um travamento infeliz. Nos dois casos, voc√™ precisa reiniciar a m√°quina. Fico feliz que, ao mesmo tempo, o arquivo de dados n√£o inche a tamanhos imensos.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/z-/rr/_k/z-rr_k9f6o7pmt_ezbza-ysrjzw.png" width="770"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O BIOS Kraftway com placa ASRock H81M-DGS provou ser muito inst√°vel. Portanto, ele responde ao Ctrl Alt Del Del pendurado, no qual somente o Reset pode produzi-lo. Ocorreu um problema ao ignorar o script de inicializa√ß√£o &lt;startup.nsh&gt; no Shell'e - uma fra√ß√£o de segundo para escolher em vez de cinco padr√£o. Talvez esses problemas sejam causados ‚Äã‚Äãpela modifica√ß√£o dos m√≥dulos propriet√°rios do KSS, talvez o assunto seja incorretamente "desaparafusado" ME.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na placa Asus H97-PLUS, o firmware possui o seguinte recurso - o BootOrder transborda com o tempo. Provavelmente, o motivo est√° nos erros no c√≥digo. Embora, talvez, o fabricante desejasse manter todos os dispositivos de inicializa√ß√£o j√° conectados na placa, mas n√£o calculou que poderia haver mais de uma d√∫zia em um dia. Portanto, quando o BootOrder estourar, o sistema trava durante o processo de inicializa√ß√£o. Para limp√°-lo, voc√™ deve desligar todos os dispositivos de inicializa√ß√£o e ligar o sistema. O firmware se limpa e o sistema inicializa diretamente no shell de configura√ß√£o do BIOS. O desempenho permanece at√© o pr√≥ximo estouro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resumindo a experi√™ncia de trabalhar com conselhos de v√°rios fornecedores, voc√™ conclui que √© quase imposs√≠vel descobrir quais surpresas no n√≠vel EFI voc√™ ir√° lidar no pr√≥ximo quadro, mesmo que ele j√° tenha um modelo conhecido. </font><font style="vertical-align: inherit;">Esse √© um tipo de loteria, porque √†s vezes podem surgir dificuldades no est√°gio de coleta de informa√ß√µes sobre o sistema. </font><font style="vertical-align: inherit;">Talvez isso tenha uma parcela de idealismo inesgot√°vel de pesquisa e f√© no fabricante, porque de que outra forma algumas das placas-m√£e mais recentes com ME v11 e v12 podem ser interrompidas ao executar o FPT ou MEInfo de vers√µes mais antigas?</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemas de trabalho com protocolos de hardware</font></font></h4><br>
<img src="https://habrastorage.org/webt/j2/yo/ze/j2yozeg6zdyfa--juz_ycvvobbc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alguns problemas aparecem quando come√ßamos a trabalhar com dispositivos USB - unidades e tokens. Isso acontece muitas vezes porque o c√≥digo do BIOS para trabalhar com perif√©ricos √© um perigoso coquetel de drivers e aplicativos do Independent Hardware Vendor (IHV) para um perif√©rico espec√≠fico, c√≥digo do fabricante do chipset (no nosso caso, da Intel), c√≥digo do fabricante e c√≥digo do BIOS do fabricante da placa-m√£e. </font><font style="vertical-align: inherit;">
Surgiram as </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
seguintes situa√ß√µes "interessantes": </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Token "n√£o detectado". Ao mesmo tempo, um LED acende nele. Provavelmente, o controlador host n√£o realiza o procedimento de redefini√ß√£o inicial do dispositivo USB, ou seja, a energia √© fornecida, mas a redefini√ß√£o atrav√©s da altera√ß√£o das linhas D + e D- n√£o funciona corretamente e, sem ela, outras manipula√ß√µes com o token n√£o fazem sentido.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O computador congela antes de carregar o shell (novamente, com um token conectado). Nesse caso, sem um token, o PC inicia normalmente. Ao vivo, fica assim: o computador parece travar logo ap√≥s o in√≠cio, enquanto o token permanece no conector. Voc√™ remove - o carregamento continua repentinamente. Conecte - desligando novamente. O problema √≥bvio est√° na UEFI, e s√≥ se pode especular sobre os motivos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A situa√ß√£o em que n√£o √© poss√≠vel abrir a interface USB_IO. Talvez ele esteja conectado apenas √† interface para trabalhar com cart√µes inteligentes - USB CCID. Alguns drivers AMI j√° abriram o USB_IO com o par√¢metro EFI_OPEN_PROTOCOL_BY_DRIVER. O driver possui um protocolo com um GUID:</font></font><br>
<br>
<pre><code class="plaintext hljs">#define EFI_AMI_USB_CCID_PROTOCOL_GUID	 { 0x5FDEE00D, 0xDA40, 0x405A, { 0xB9, 0x2E, 0xCF, 0x4A, 0x80, 0xEA, 0x8F, 0x76} }<font></font>
 // Workaround.      EFI_OPEN_PROTOCOL_BY_DRIVER,  ,     EFI_OPEN_PROTOCOL_GET_PROTOCOL.<font></font>
 //<font></font>
 // Open USB I/O Protocol<font></font>
 //<font></font>
 Status = gBS-&gt;OpenProtocol (<font></font>
 ControllerHandle,<font></font>
 &amp;gEfiUsbIoProtocolGuid,<font></font>
 (VOID **) &amp;UsbIo,<font></font>
 This-&gt;DriverBindingHandle,<font></font>
 ControllerHandle,<font></font>
 EFI_OPEN_PROTOCOL_BY_DRIVER<font></font>
 );<font></font>
<font></font>
 if (EFI_ACCESS_DENIED == Status)<font></font>
 {		// AMI BIOS workaround (BindingStop will not be invoked)<font></font>
	 Status = gBS-&gt;OpenProtocol(<font></font>
		 ControllerHandle,<font></font>
		 &amp;gEfiUsbIoProtocolGuid,<font></font>
		 (VOID **)&amp;UsbIo,<font></font>
		 This-&gt;DriverBindingHandle,<font></font>
		 ControllerHandle,<font></font>
		 EFI_OPEN_PROTOCOL_GET_PROTOCOL<font></font>
	 );<font></font>
 }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, BindingStop () n√£o ser√° chamado, ou seja, o evento de extra√ß√£o do dispositivo n√£o √© monitorado e o driver tentar√° usar um identificador inv√°lido. Isso foi observado no PC HP Compaq Elite 8300 SFF e em alguns outros. Esse √© um tipo de prote√ß√£o do fornecedor contra drivers indesejados ou um bug de desenvolvimento regular. Talvez a AMI esteja constantemente fazendo algo na dire√ß√£o do USB CCID, mas o driver interferente n√£o pode ser descarregado, pois est√° localizado no mesmo m√≥dulo AMI UHCI junto com o USB HID, USB MassStorage. Com UninstallInterface (), as coisas s√£o semelhantes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou outro recurso interessante. Em um dos UEFI BIOS, onde o token n√£o foi detectado, USB_IO permitiu a leitura dos descritores do dispositivo, mas EFI_INVALID_PARAMETER retornou ao pr√≥ximo UsbBulkTransfer (). Al√©m disso, isso aconteceu apenas com alguns tipos de tokens, com absolutamente os mesmos par√¢metros, outros funcionaram perfeitamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, o protocolo UsbBulkTransfer () √© interessante de implementar no protocolo EFI_USB_IO_PROTOCOL. </font><font style="vertical-align: inherit;">Destina-se √† entrega garantida do pacote por um tempo ilimitado ou pelo tempo especificado no par√¢metro Timeout. </font><font style="vertical-align: inherit;">Mas um experimento foi realizado com um dispositivo MassStorage: ao copiar um arquivo grande para uma unidade flash USB, ele foi removido. </font><font style="vertical-align: inherit;">O PC est√° travado. </font><font style="vertical-align: inherit;">Ao conectar a unidade flash USB, o PC cedeu e continuou a gravar o arquivo como se nada tivesse acontecido. </font><font style="vertical-align: inherit;">A mesma situa√ß√£o ocorreu com os tokens, mas com suas pr√≥prias especificidades. </font><font style="vertical-align: inherit;">Esse √© um problema de arquitetura, na EFI n√£o h√° interrup√ß√µes, exceto um temporizador, e os dispositivos operam de acordo com uma pesquisa. </font><font style="vertical-align: inherit;">Ou seja, o sistema travou em algum lugar da pesquisa USB, mas n√£o atingiu o tempo limite; quando o dispositivo reapareceu, ele simplesmente continuou e concluiu a opera√ß√£o.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Virtualiza√ß√£o</font></font></h4> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m devemos dizer sobre ambientes virtuais. Atualmente, existem duas plataformas principais no mercado que oferecem suporte √† emula√ß√£o do ambiente EFI: VMware e VirtualBox. Ambos t√™m suas vantagens e desvantagens ao interagir com eles e com sistemas "reais". O ambiente VMware fornece trabalho adequadamente com vari√°veis ‚Äã‚Äãda NVRAM, mas trope√ßa ao exibir mensagens visualmente durante a inicializa√ß√£o dos m√≥dulos DXE: na melhor das hip√≥teses, ser√° dada prefer√™ncia √†s mensagens nativas sobre como encontrar m√≠dia inicializ√°vel, deixando para tr√°s o que precisamos. Pelo contr√°rio, o VirtualBox processa perfeitamente tudo o que √© necess√°rio, mas n√£o deseja se lembrar de vari√°veis ‚Äã‚Äãlongas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra pequena pedra no jardim do VMware - o driver FAT32 embutido suporta a cria√ß√£o e edi√ß√£o de arquivos apenas na nota√ß√£o 8.3. </font><font style="vertical-align: inherit;">N√£o est√° claro por que isso foi feito, mas essa √© uma limita√ß√£o que claramente requer aten√ß√£o. </font><font style="vertical-align: inherit;">√â prov√°vel que uma implementa√ß√£o semelhante do driver possa ser observada em plataformas reais, mas at√© agora n√£o encontramos nenhuma. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por outro lado, em m√°quinas virtuais, n√£o h√° dan√ßas com utilit√°rios de firmware, programadores, jumpers, chips desconfort√°veis. </font><font style="vertical-align: inherit;">Um arquivo ROM separado, UEFITool e uma linha no arquivo de configura√ß√£o. </font><font style="vertical-align: inherit;">Quase um id√≠lio.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No final</font></font></h4><br>
<img src="https://habrastorage.org/webt/cb/qg/va/cbqgvany9ens-l7ippxwgzox9co.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma fatia da solicita√ß√£o do CHIPSEC. </font><font style="vertical-align: inherit;">Onde eles ensinam esses sacramentos? </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como j√° mencionado, o desenvolvimento e implementa√ß√£o no shell UEFI √© um processo fascinante e criativo. </font><font style="vertical-align: inherit;">Voc√™ sempre pode encontrar algo novo, mesmo em um campo famoso. </font><font style="vertical-align: inherit;">Por um lado, √© encorajador que o padr√£o esteja se desenvolvendo; por outro, √© triste que implementa√ß√µes concretas dele pelos produtores sejam muito "criativas". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os principais problemas foram e permanecem:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partida de fornecedores da especifica√ß√£o UEFI ao desenvolver firmware.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erros no c√≥digo durante a implementa√ß√£o.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NDV no c√≥digo, pop-up durante a integra√ß√£o.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E por √∫ltimo, mas n√£o menos importante, a aus√™ncia de muitas coisas na documenta√ß√£o oficial (leitura, abertura), como, por exemplo, descri√ß√µes do protocolo para comunica√ß√£o comigo atrav√©s de dispositivos PCI como MEI, HECI. </font><font style="vertical-align: inherit;">Voc√™ pode encontrar uma descri√ß√£o dos registradores, mas n√£o dos comandos. </font><font style="vertical-align: inherit;">Encontre um GUID, mas n√£o seu objetivo. </font><font style="vertical-align: inherit;">Que mais uma vez retorna o trabalho a uma longa an√°lise, coletando dados e estat√≠sticas em plataformas e usando o desmontador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note-se que a situa√ß√£o est√° lenta mas seguramente corrigindo, e eu quero acreditar que n√£o est√° longe o momento em que o desenvolvimento do padr√£o se tornar√° um processo bastante previs√≠vel e muito agrad√°vel. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vladimir Onipchuk, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
chefe do grupo de produtos de prote√ß√£o de hardware e software da </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gazinformservice LLC</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt493810/index.html">Cinco anos de intenso desenvolvimento do mercado para reconhecimento de documentos</a></li>
<li><a href="../pt493814/index.html">Como conduzimos entrevistas em Barcelona</a></li>
<li><a href="../pt493816/index.html">Guia Git N√∫mero da pe√ßa 1: tudo o que voc√™ precisa saber sobre o diret√≥rio .git</a></li>
<li><a href="../pt493818/index.html">Guia Git N√∫mero da pe√ßa 2: a regra de ouro e outros princ√≠pios b√°sicos de rebase</a></li>
<li><a href="../pt493820/index.html">Balanceamento de carga e dimensionamento de conex√µes de longa dura√ß√£o do Kubernetes</a></li>
<li><a href="../pt493826/index.html">Dividir e conquistar: melhorar a eletr√≥lise da √°gua</a></li>
<li><a href="../pt493828/index.html">Como a interface conta hist√≥rias em videogames</a></li>
<li><a href="../pt493830/index.html">Quais perguntas s√£o feitas pelo desenvolvedor Junior iOS nas primeiras entrevistas</a></li>
<li><a href="../pt493832/index.html">Painel de distribui√ß√£o do Coronavirus COVID-19 (React + Chart.js + BootstrapTable)</a></li>
<li><a href="../pt493840/index.html">Coment√°rios: Asana, Jira, Bitrix-24, Trello, YouGile. O que voc√™ gosta e o que enfurece?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>