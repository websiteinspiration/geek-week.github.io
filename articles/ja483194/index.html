<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ± ğŸ•š ğŸ¤” æ‰‹æ•°æ–™ã®ãŸã‚ã®ãƒœãƒƒãƒˆã€‚æ–°ã—ã„ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã§ã‚µãƒƒã‚«ãƒ¼ã«è¡Œã ğŸ‘ª ğŸ¥ˆ ğŸ’”</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å‰æ›¸ã
 

ã¿ãªã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€NodeJSã‚’ä½¿ç”¨ã—ãŸé›»å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã¨VKã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”¨ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚
 

ã“ã®æ™‚ç‚¹ã§ã€å¤šãã®èª­è€…ã¯ã€Œã©ã®ãã‚‰ã„ã®æ™‚é–“ã€ã®ã‚ˆã†ãªã‚‚ã®ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã¯ã€Œä½•ã€ã¾ãŸï¼Ÿï¼ã€
 ã¯ã„ã€åŒæ§˜ã®å‡ºç‰ˆç‰©ãŒ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>æ‰‹æ•°æ–™ã®ãŸã‚ã®ãƒœãƒƒãƒˆã€‚æ–°ã—ã„ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã§ã‚µãƒƒã‚«ãƒ¼ã«è¡Œã</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483194/"><h2 id="vvedenie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‰æ›¸ã</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¿ãªã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ã€‚</font><font style="vertical-align: inherit;">ã“ã®è¨˜äº‹ã§ã¯ã€NodeJSã‚’ä½¿ç”¨ã—ãŸé›»å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã¨VKã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”¨ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã®æ™‚ç‚¹ã§ã€å¤šãã®èª­è€…ã¯ã€Œã©ã®ãã‚‰ã„ã®æ™‚é–“ã€ã®ã‚ˆã†ãªã‚‚ã®ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã¾ãŸã¯ã€Œä½•ã€ã¾ãŸï¼Ÿï¼ã€</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã¯ã„ã€åŒæ§˜ã®å‡ºç‰ˆç‰©ãŒã™ã§ã«ã‚ã‚Šã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã—ã‹ã—ã€ãã‚Œã§ã‚‚ã€ã“ã®è¨˜äº‹ã¯å½¹ç«‹ã¤ã¨æ€ã„ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒœãƒƒãƒˆã®æŠ€è¡“çš„ãªå®Ÿè£…ãŒè¡¨ã™ã‚‚ã®ã«ã¤ã„ã¦ç°¡å˜ã«èª¬æ˜ã—ã¾ã™ã€‚</font></font></p><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NestJS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŒäººæ°—ã‚’åšã—ã¦ã„</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram APIã¨å¯¾è©±ã™ã‚‹ãŸã‚</font><font style="vertical-align: inherit;">ã®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">telegraf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</font><font style="vertical-align: inherit;">ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VK APIã¨å¯¾è©±ã™ã‚‹ãŸã‚</font><font style="vertical-align: inherit;">ã®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">node-vk-bot-api</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</font><font style="vertical-align: inherit;">ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ•´ç†ã™ã‚‹ãŸã‚ã®</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Typeorm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</font><font style="vertical-align: inherit;">ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mocha</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãŠã‚ˆã³chai </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã‚¢ã‚µãƒ¼ãƒˆ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</font><font style="vertical-align: inherit;">ã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆ</font><font style="vertical-align: inherit;">ã€‚</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ†ã‚¹ãƒˆã«ã¯Travis CIã‚’ä½¿ç”¨ã—ã€Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯GitHubã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</font></font></li>
</ol><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‰¯æ¥­ã¨ã—ã¦ã€ç§ãŸã¡ã®ãƒœãƒƒãƒˆã‚’Viberã¨å‹é”ã«ã—ã¦ã€ã„ãã¤ã‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«æ±ç”¨çš„ã«ã—ã¾ã—ã‚‡ã†ã€‚ </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½•ãŒèµ·ã“ã£ãŸã®ã‹çŸ¥ã‚ŠãŸã„äººã¯çŒ«ã¸ã‚ˆã†ã“ãã€‚</font></font></p><a name="habracut"></a><br>
<h2 id="postanovka-zadachi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å•é¡Œã®å®šå¼åŒ–</font></font></h2><br>
<p>       .    .        vk, viber  telegram     : </p><br>
<p><img src="https://habrastorage.org/webt/jt/c7/h8/jtc7h8oxebenbzwymug3y2oi0oo.png" alt="ç”»åƒ"></p><br>
<p>   :</p><br>
<ol>
<li>""  .</li>
<li>    3      "".</li>
<li>""      "".</li>
<li>  ""            5 .</li>
<li>     ,         .</li>
</ol><br>
<p>       "+"     ,               .     ,         :</p><br>
<ol>
<li>  +1     ,     .</li>
<li>   ,       .</li>
</ol><br>
<p>      - , " "    .</p><br>
<p> ,        ,             ()/().</p><br>
<p>,          :</p><br>
<ol>
<li>    - .        .</li>
<li>  <em>/event_add</em>           .      .</li>
<li> <em>/event_remove</em>     .</li>
<li> <em>/add</em>        .       -  ,    ,   .           .</li>
<li> <em>/remove</em>       ,    <em>/add</em>.</li>
<li> <em>/info</em>       .</li>
<li> ,            (    ).</li>
</ol><br>
<p>      ,       "  ".      ,       .</p><br>
<h2 id="proektirovanie-i-razrabotka">  </h2><br>
<p>        :</p><br>
<p><img src="https://habrastorage.org/webt/v7/j4/gz/v7j4gzjufgbeuayina59yy8blia.jpeg" alt="ç”»åƒ"></p><br>
<p>     ,                        API,       .</p><br>
<h3 id="interfeys-i-modeli-soobscheniy">   </h3><br>
<p>      <em>IMessage</em>,   ,              :</p><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> interface IMessage {
    <span class="hljs-attr">chatId</span>: number;<font></font>
    lang: string;<font></font>
    text: string;<font></font>
    fullText: string;<font></font>
    command: string;<font></font>
    name: string;<font></font>
    getReplyStatus: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> string;<font></font>
    getReplyData: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> any;<font></font>
    setStatus: <span class="hljs-function">(<span class="hljs-params">status: string</span>) =&gt;</span> IMessage;<font></font>
    withData: <span class="hljs-function">(<span class="hljs-params">data: any</span>) =&gt;</span> IMessage;<font></font>
    answer: <span class="hljs-function">(<span class="hljs-params">args: any</span>) =&gt;</span> string | <span class="hljs-keyword">void</span>;<font></font>
}</code></pre><br>
<p>  <em>BaseMessage</em>,      :</p><br>
<div class="spoiler"><b class="spoiler_title">BaseMessage</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {IMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/i-message'</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseMessage</span> <span class="hljs-title">implements</span> <span class="hljs-title">IMessage</span> </span>{<font></font>
    public chatId: number;<font></font>
    public lang: string;<font></font>
    public text: string;<font></font>
    public fullText: string;<font></font>
    public command: string;<font></font>
<font></font>
    protected firstName: string;<font></font>
    protected lastName: string;<font></font>
<font></font>
    protected replyStatus: string;<font></font>
    protected replyData: any;<font></font>
<font></font>
    <span class="hljs-keyword">get</span> <span class="hljs-title">name</span>(): <span class="hljs-title">string</span> {
        <span class="hljs-keyword">const</span> firstName: string = <span class="hljs-keyword">this</span>.firstName || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">const</span> lastName: string = <span class="hljs-keyword">this</span>.lastName || <span class="hljs-string">''</span>;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${firstName}</span> <span class="hljs-subst">${lastName}</span>`</span>.trim();<font></font>
    }<font></font>
<font></font>
    public getReplyStatus(): string {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.replyStatus;<font></font>
    }<font></font>
<font></font>
    public getReplyData(): any {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.replyData;<font></font>
    }<font></font>
<font></font>
    public setStatus(status: string): IMessage {<font></font>
        <span class="hljs-keyword">this</span>.replyStatus = status;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<font></font>
    }<font></font>
<font></font>
    public withData(data: any): IMessage {<font></font>
        <span class="hljs-keyword">this</span>.replyData = data;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<font></font>
    }<font></font>
<font></font>
    public answer(args: any): string | <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'not implemented'</span>);<font></font>
    }<font></font>
}<font></font>
}</code></pre></div></div><br>
<p>   Telegram:</p><br>
<div class="spoiler"><b class="spoiler_title">TelegramMessage</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {BaseMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/base.message'</span>;
<span class="hljs-keyword">import</span> {IMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/i-message'</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TelegramMessage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseMessage</span> <span class="hljs-title">implements</span> <span class="hljs-title">IMessage</span> </span>{<font></font>
    private ctx: any;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(ctx) {
        <span class="hljs-keyword">super</span>();<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.ctx = ctx;<font></font>
<font></font>
        <span class="hljs-keyword">const</span> {message} = <span class="hljs-keyword">this</span>.ctx.update;
        <span class="hljs-keyword">this</span>.chatId = message.chat.id;
        <span class="hljs-keyword">this</span>.fullText = message.text;
        <span class="hljs-keyword">this</span>.command = <span class="hljs-keyword">this</span>.ctx.command;
        <span class="hljs-keyword">this</span>.text = <span class="hljs-keyword">this</span>.fullText.replace(<span class="hljs-string">`/<span class="hljs-subst">${<span class="hljs-keyword">this</span>.command}</span>`</span>, <span class="hljs-string">''</span>);
        <span class="hljs-keyword">this</span>.lang = message.from.language_code;
        <span class="hljs-keyword">this</span>.firstName = message.from.first_name;
        <span class="hljs-keyword">this</span>.lastName = message.from.last_name;<font></font>
    }<font></font>
<font></font>
    public answer(args: any): string | <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ctx.replyWithHTML(args);<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>  VK:</p><br>
<div class="spoiler"><b class="spoiler_title">VKMessage</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {BaseMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/base.message'</span>;
<span class="hljs-keyword">import</span> {IMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/i-message'</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VKMessage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseMessage</span> <span class="hljs-title">implements</span> <span class="hljs-title">IMessage</span> </span>{<font></font>
    private ctx: any;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(ctx) {
        <span class="hljs-keyword">super</span>();<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.ctx = ctx;<font></font>
<font></font>
        <span class="hljs-keyword">const</span> {message} = <span class="hljs-keyword">this</span>.ctx;
        <span class="hljs-keyword">this</span>.chatId = <span class="hljs-keyword">this</span>.getChatId(<span class="hljs-keyword">this</span>.ctx);
        <span class="hljs-keyword">this</span>.fullText = message.text;
        <span class="hljs-keyword">this</span>.command = <span class="hljs-keyword">this</span>.ctx.command;
        <span class="hljs-keyword">this</span>.text = <span class="hljs-keyword">this</span>.fullText.replace(<span class="hljs-string">`/<span class="hljs-subst">${<span class="hljs-keyword">this</span>.command}</span>`</span>, <span class="hljs-string">''</span>);
        <span class="hljs-keyword">this</span>.lang = <span class="hljs-string">'ru'</span>;
        <span class="hljs-keyword">this</span>.firstName = message.from.first_name;
        <span class="hljs-keyword">this</span>.lastName = message.from.last_name;<font></font>
    }<font></font>
<font></font>
    public answer(args: any) {<font></font>
        <span class="hljs-keyword">const</span> answer: string = <span class="hljs-string">`<span class="hljs-subst">${args}</span>`</span>.replace(<span class="hljs-regexp">/&lt;\/?(strong|i)&gt;/gm</span>, <span class="hljs-string">''</span>);
        <span class="hljs-keyword">this</span>.ctx.reply(answer);<font></font>
    }<font></font>
<font></font>
    private getChatId({message, bot}): number {<font></font>
        <span class="hljs-keyword">const</span> peerId: number = +<span class="hljs-string">`<span class="hljs-subst">${message.peer_id}</span>`</span>.replace(<span class="hljs-regexp">/[0-9]0+/</span>, <span class="hljs-string">''</span>);
        <span class="hljs-keyword">const</span> groupId: number = bot.settings.group_id;
        <span class="hljs-keyword">return</span> peerId + groupId;<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>     :</p><br>
<ol>
<li><p><em>chatId</em> â€”   .  Telegram         .    VK      .   ?             VK.               . ..        <em>group_id</em>.  ,    <em>peer_id</em> (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>)       .             :</p><br>
<pre><code class="javascript hljs">private getChatId({message, bot}): number {
    <span class="hljs-keyword">const</span> peerId: number = +(<span class="hljs-string">`<span class="hljs-subst">${message.peer_id}</span>`</span>.replace(<span class="hljs-regexp">/[0-9]0+/</span>, <span class="hljs-string">''</span>));
    <span class="hljs-keyword">const</span> groupId: number = bot.settings.group_id;
    <span class="hljs-keyword">return</span> peerId + groupId;<font></font>
}</code></pre><br>
<p>    ,     .</p><br>
</li>
<li><p><em>fullText</em>  <em>text</em>.     , <em>fullText</em>    ,     <em>text</em>    ,     .</p><br>
</li>
</ol><br>
<p> ,       <em>text</em>             .</p><br>
<ol>
<li>   Telegram  VK         <code>&lt;b&gt;</code>  <code>&lt;i&gt;</code>,            .</li>
</ol><br>
<h3 id="adaptery-dlya-priema-i-otpravki-soobscheniy">     </h3><br>
<p>        Telegram  VK        .</p><br>
<p><img src="https://habrastorage.org/webt/gz/-z/2y/gz-z2y0x-x9_78hjdhg2mul9byu.jpeg" alt="ç”»åƒ"></p><br>
<p>         API Telegram  VK   long-polling,                   .</p><br>
<div class="spoiler"><b class="spoiler_title">TelegramService</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> Telegraf <span class="hljs-keyword">from</span> <span class="hljs-string">'telegraf'</span>;<font></font>
<font></font>
<span class="hljs-keyword">import</span> {Injectable} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> SocksAgent <span class="hljs-keyword">from</span> <span class="hljs-string">'socks5-https-client/lib/Agent'</span>;
<span class="hljs-keyword">import</span> {ConfigService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/config.service'</span>;
<span class="hljs-keyword">import</span> {AppEmitter} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/event-bus.service'</span>;
<span class="hljs-keyword">import</span> {TelegramMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'./telegram.message'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TelegramService</span> </span>{<font></font>
    private bot: Telegraf&lt;any&gt;;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(config: ConfigService, appEmitter: AppEmitter) {
        <span class="hljs-keyword">const</span> botToken: string = config.get(<span class="hljs-string">'TELEGRAM_BOT_TOKEN'</span>);<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.bot = config.get(<span class="hljs-string">'TELEGRAM_USE_PROXY'</span>)<font></font>
            ? <span class="hljs-keyword">new</span> Telegraf(botToken, {
                  <span class="hljs-attr">telegram</span>: {<span class="hljs-attr">agent</span>: <span class="hljs-keyword">this</span>.getProxy(config)},<font></font>
              })<font></font>
            : <span class="hljs-keyword">new</span> Telegraf(botToken);<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function">(<span class="hljs-params">[command, event]</span>) =&gt;</span> {
            <span class="hljs-keyword">this</span>.bot.command(command, ctx =&gt; {<font></font>
                ctx.command = command;<font></font>
                appEmitter.emit(event, <span class="hljs-keyword">new</span> TelegramMessage(ctx));<font></font>
            });<font></font>
        });<font></font>
    }<font></font>
<font></font>
    public launch(): <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">this</span>.bot.launch();<font></font>
    }<font></font>
<font></font>
    private getProxy(config: ConfigService): SocksAgent {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SocksAgent({
            <span class="hljs-attr">socksHost</span>: config.get(<span class="hljs-string">'TELEGRAM_PROXY_HOST'</span>),
            <span class="hljs-attr">socksPort</span>: config.get(<span class="hljs-string">'TELEGRAM_PROXY_PORT'</span>),
            <span class="hljs-attr">socksUsername</span>: config.get(<span class="hljs-string">'TELEGRAM_PROXY_LOGIN'</span>),
            <span class="hljs-attr">socksPassword</span>: config.get(<span class="hljs-string">'TELEGRAM_PROXY_PASSWORD'</span>),<font></font>
        });<font></font>
    }<font></font>
<font></font>
    private getCommandEventMapping(<font></font>
        appEmitter: AppEmitter,<font></font>
    ): <span class="hljs-built_in">Array</span>&lt;[string, string]&gt; {
        <span class="hljs-keyword">return</span> [<font></font>
            [<span class="hljs-string">'event_add'</span>, appEmitter.EVENT_ADD],<font></font>
            [<span class="hljs-string">'event_remove'</span>, appEmitter.EVENT_REMOVE],<font></font>
            [<span class="hljs-string">'info'</span>, appEmitter.EVENT_INFO],<font></font>
            [<span class="hljs-string">'add'</span>, appEmitter.PLAYER_ADD],<font></font>
            [<span class="hljs-string">'remove'</span>, appEmitter.PLAYER_REMOVE],<font></font>
        ];<font></font>
    }<font></font>
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">VKService</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> VkBot <span class="hljs-keyword">from</span> <span class="hljs-string">'node-vk-bot-api'</span>;<font></font>
<font></font>
<span class="hljs-keyword">import</span> {Injectable} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> {ConfigService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/config.service'</span>;
<span class="hljs-keyword">import</span> {AppEmitter} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/event-bus.service'</span>;
<span class="hljs-keyword">import</span> {VKMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'./vk.message'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VKService</span> </span>{<font></font>
    private bot: VkBot&lt;any&gt;;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(config: ConfigService, appEmitter: AppEmitter) {
        <span class="hljs-keyword">const</span> botToken: string = config.get(<span class="hljs-string">'VK_TOKEN'</span>);<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.bot = <span class="hljs-keyword">new</span> VkBot(botToken);<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.getCommandEventMapping(appEmitter).forEach(<span class="hljs-function">(<span class="hljs-params">[command, event]</span>) =&gt;</span> {
            <span class="hljs-keyword">this</span>.bot.command(<span class="hljs-string">`/<span class="hljs-subst">${command}</span>`</span>, <span class="hljs-keyword">async</span> ctx =&gt; {
                <span class="hljs-keyword">const</span> [<span class="hljs-keyword">from</span>] = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.bot.execute(<span class="hljs-string">'users.get'</span>, {
                    <span class="hljs-attr">user_ids</span>: ctx.message.from_id,<font></font>
                });<font></font>
                ctx.message.from = <span class="hljs-keyword">from</span>;<font></font>
                ctx.command = command;<font></font>
                appEmitter.emit(event, <span class="hljs-keyword">new</span> VKMessage(ctx));<font></font>
            });<font></font>
        });<font></font>
    }<font></font>
<font></font>
    public launch(): <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">this</span>.bot.startPolling();<font></font>
    }<font></font>
<font></font>
    private getCommandEventMapping(<font></font>
        appEmitter: AppEmitter,<font></font>
    ): <span class="hljs-built_in">Array</span>&lt;[string, string]&gt; {
        <span class="hljs-keyword">return</span> [<font></font>
            [<span class="hljs-string">'event_add'</span>, appEmitter.EVENT_ADD],<font></font>
            [<span class="hljs-string">'event_remove'</span>, appEmitter.EVENT_REMOVE],<font></font>
            [<span class="hljs-string">'info'</span>, appEmitter.EVENT_INFO],<font></font>
            [<span class="hljs-string">'add'</span>, appEmitter.PLAYER_ADD],<font></font>
            [<span class="hljs-string">'remove'</span>, appEmitter.PLAYER_REMOVE],<font></font>
        ];<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>     :</p><br>
<ol>
<li>-       Telegram ( )        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://www.npmjs.com/package/socks5-">socks5-https-client</a>.</li>
<li>               .</li>
<li> VK            API :<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> [<span class="hljs-keyword">from</span>] = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.bot.execute(<span class="hljs-string">'users.get'</span>, {
    <span class="hljs-attr">user_ids</span>: ctx.message.from_id,<font></font>
});</code></pre></li>
</ol><br>
<h3 id="model-dannyh"> </h3><br>
<p>         :</p><br>
<ol>
<li><code>Chat</code> â€”   .</li>
<li><code>Event</code> â€”         .</li>
<li><code>Player</code> â€”       .</li>
</ol><br>
<p><img src="https://habrastorage.org/webt/yj/dc/rw/yjdcrwzw4bsie2im9fuelyb590k.jpeg" alt="ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒ"></p><br>
<p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">typeorm</a>  :</p><br>
<div class="spoiler"><b class="spoiler_title">Chat</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {<font></font>
    Entity,<font></font>
    PrimaryGeneratedColumn,<font></font>
    Column,<font></font>
    OneToMany,<font></font>
    JoinColumn,<font></font>
    Index,<font></font>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;
<span class="hljs-keyword">import</span> {Event} <span class="hljs-keyword">from</span> <span class="hljs-string">'./event'</span>;<font></font>
<font></font>
@Entity()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Chat</span> </span>{<font></font>
    @PrimaryGeneratedColumn()<font></font>
    <span class="hljs-attr">id</span>: number;<font></font>
<font></font>
    @Index({<span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>})<font></font>
    @Column()<font></font>
    <span class="hljs-attr">chatId</span>: number;<font></font>
<font></font>
    @OneToMany(<span class="hljs-function"><span class="hljs-params">type</span> =&gt;</span> Event, event =&gt; event.chat)<font></font>
    @JoinColumn()<font></font>
    <span class="hljs-attr">events</span>: Event[];<font></font>
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">Event</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {<font></font>
    Entity,<font></font>
    PrimaryGeneratedColumn,<font></font>
    Column,<font></font>
    OneToMany,<font></font>
    ManyToOne,<font></font>
    JoinColumn,<font></font>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;
<span class="hljs-keyword">import</span> {Chat} <span class="hljs-keyword">from</span> <span class="hljs-string">'./chat'</span>;
<span class="hljs-keyword">import</span> {Player} <span class="hljs-keyword">from</span> <span class="hljs-string">'./player'</span>;<font></font>
<font></font>
@Entity()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Event</span> </span>{<font></font>
    @PrimaryGeneratedColumn()<font></font>
    <span class="hljs-attr">id</span>: number;<font></font>
<font></font>
    @Column()<font></font>
    <span class="hljs-attr">date</span>: <span class="hljs-built_in">Date</span>;<font></font>
<font></font>
    @Column()<font></font>
    <span class="hljs-attr">active</span>: boolean;<font></font>
<font></font>
    @ManyToOne(<span class="hljs-function"><span class="hljs-params">type</span> =&gt;</span> Chat, chat =&gt; chat.events)
    <span class="hljs-attr">chat</span>: Chat;<font></font>
<font></font>
    @OneToMany(<span class="hljs-function"><span class="hljs-params">type</span> =&gt;</span> Player, player =&gt; player.event)<font></font>
    @JoinColumn()<font></font>
    <span class="hljs-attr">players</span>: Player[];<font></font>
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">Player</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {<font></font>
    Entity,<font></font>
    PrimaryGeneratedColumn,<font></font>
    Column,<font></font>
    ManyToOne,<font></font>
    JoinColumn,<font></font>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;
<span class="hljs-keyword">import</span> {Event} <span class="hljs-keyword">from</span> <span class="hljs-string">'./event'</span>;<font></font>
<font></font>
@Entity()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Player</span> </span>{<font></font>
    @PrimaryGeneratedColumn()<font></font>
    <span class="hljs-attr">id</span>: number;<font></font>
<font></font>
    @Column()<font></font>
    <span class="hljs-attr">name</span>: string;<font></font>
<font></font>
    @ManyToOne(<span class="hljs-function"><span class="hljs-params">type</span> =&gt;</span> Event, event =&gt; event.players)<font></font>
    @JoinColumn()<font></font>
    <span class="hljs-attr">event</span>: Event;<font></font>
}</code></pre></div></div><br>
<p>                 <em>Chat</em>, <em>Event</em>  <em>Player</em>.</p><br>
<ol>
<li>          (<em>Chat</em>)  <code>chatId</code>.    ,   .</li>
<li>            (<em>Event</em>). ..    <code>/event_add</code>         .<br>
   (  )  .</li>
<li><code>/event_remove</code>         .</li>
<li><code>/info</code>      ,         (<em>Player</em>).</li>
<li><code>/add</code>  <code>/remove</code>          .</li>
</ol><br>
<p>       :</p><br>
<div class="spoiler"><b class="spoiler_title">StorageService</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Injectable} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> {InjectConnection} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/typeorm'</span>;
<span class="hljs-keyword">import</span> {Connection, Repository, UpdateResult} <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;<font></font>
<font></font>
<span class="hljs-keyword">import</span> {Chat} <span class="hljs-keyword">from</span> <span class="hljs-string">'./models/chat'</span>;
<span class="hljs-keyword">import</span> {Event} <span class="hljs-keyword">from</span> <span class="hljs-string">'./models/event'</span>;
<span class="hljs-keyword">import</span> {Player} <span class="hljs-keyword">from</span> <span class="hljs-string">'./models/player'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StorageService</span> </span>{<font></font>
    private chatRepository: Repository&lt;Chat&gt;;<font></font>
    private eventRepository: Repository&lt;Event&gt;;<font></font>
    private playerRepository: Repository&lt;Player&gt;;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(@InjectConnection() private readonly dbConnection: Connection) {
        <span class="hljs-keyword">this</span>.chatRepository = <span class="hljs-keyword">this</span>.dbConnection.getRepository(Chat);
        <span class="hljs-keyword">this</span>.eventRepository = <span class="hljs-keyword">this</span>.dbConnection.getRepository(Event);
        <span class="hljs-keyword">this</span>.playerRepository = <span class="hljs-keyword">this</span>.dbConnection.getRepository(Player);<font></font>
    }<font></font>
<font></font>
    public <span class="hljs-keyword">get</span> <span class="hljs-title">connection</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.dbConnection;<font></font>
    }<font></font>
<font></font>
    public <span class="hljs-keyword">async</span> ensureChat(chatId: number): <span class="hljs-built_in">Promise</span>&lt;Chat&gt; {
        <span class="hljs-keyword">let</span> chat: Chat = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.chatRepository.findOne({chatId});<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (chat) {
            <span class="hljs-keyword">return</span> chat;<font></font>
        }<font></font>
<font></font>
        chat = <span class="hljs-keyword">new</span> Chat();<font></font>
        chat.chatId = chatId;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.chatRepository.save(chat);<font></font>
    }<font></font>
<font></font>
    public markChatEventsInactive(chat: Chat): <span class="hljs-built_in">Promise</span>&lt;UpdateResult&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.dbConnection<font></font>
            .createQueryBuilder()<font></font>
            .update(Event)<font></font>
            .set({<span class="hljs-attr">active</span>: <span class="hljs-literal">false</span>})<font></font>
            .where({chat})<font></font>
            .execute();<font></font>
    }<font></font>
<font></font>
    public appendChatActiveEvent(chat: Chat, <span class="hljs-attr">date</span>: <span class="hljs-built_in">Date</span>): <span class="hljs-built_in">Promise</span>&lt;Event&gt; {
        <span class="hljs-keyword">const</span> event: Event = <span class="hljs-keyword">new</span> Event();<font></font>
        event.chat = chat;<font></font>
        event.active = <span class="hljs-literal">true</span>;<font></font>
        event.date = date;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.eventRepository.save(event);<font></font>
    }<font></font>
<font></font>
    public findChatActiveEvent(chat: Chat): <span class="hljs-built_in">Promise</span>&lt;Event | <span class="hljs-literal">null</span>&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.eventRepository.findOne({<span class="hljs-attr">where</span>: {chat, <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>}});<font></font>
    }<font></font>
<font></font>
   public getPlayers(event: Event): <span class="hljs-built_in">Promise</span>&lt;Player[]&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.playerRepository.find({<span class="hljs-attr">where</span>: {event}});<font></font>
    }<font></font>
<font></font>
    public findPlayer(event: Event, <span class="hljs-attr">name</span>: string): <span class="hljs-built_in">Promise</span>&lt;Player | <span class="hljs-literal">null</span>&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.playerRepository.findOne({<span class="hljs-attr">where</span>: {event, name}});<font></font>
    }<font></font>
<font></font>
    public addPlayer(event: Event, <span class="hljs-attr">name</span>: string): <span class="hljs-built_in">Promise</span>&lt;Player&gt; {
        <span class="hljs-keyword">const</span> player: Player = <span class="hljs-keyword">new</span> Player();<font></font>
        player.event = event;<font></font>
        player.name = name;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.playerRepository.save(player);<font></font>
    }<font></font>
<font></font>
    public removePlayer(player: Player): <span class="hljs-built_in">Promise</span>&lt;Player&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.playerRepository.remove(player);<font></font>
    }<font></font>
}</code></pre></div></div><br>
<h3 id="shablonizaciya-otvetov"> </h3><br>
<p>   <em>StorageService</em>           <em>TemplateService</em>      :</p><br>
<ol>
<li>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">handlebars</a>          .</li>
<li>       ,     .</li>
<li>       .</li>
</ol><br>
<div class="spoiler"><b class="spoiler_title">TemplateService</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> handlebars <span class="hljs-keyword">from</span> <span class="hljs-string">'handlebars'</span>;
<span class="hljs-keyword">import</span> {readDirDeepSync} <span class="hljs-keyword">from</span> <span class="hljs-string">'read-dir-deep'</span>;
<span class="hljs-keyword">import</span> {Injectable, Logger} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<font></font>
<font></font>
<span class="hljs-keyword">export</span> interface IParams {
    <span class="hljs-attr">action</span>: string;<font></font>
    status: string;<font></font>
    lang?: string;<font></font>
}<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TemplateService</span> </span>{<font></font>
    private readonly DEFAULT_LANG: string = <span class="hljs-string">'en'</span>;<font></font>
    private readonly TEMPLATE_PATH: string = <span class="hljs-string">'templates'</span>;<font></font>
<font></font>
    private logger: Logger;<font></font>
    private templatesMap: <span class="hljs-built_in">Map</span>&lt;string, (d: any) =&gt; string&gt;;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(logger: Logger) {
        <span class="hljs-keyword">this</span>.logger = logger;<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.load();<font></font>
    }<font></font>
<font></font>
    public apply(params: IParams, <span class="hljs-attr">data</span>: any): string {
        <span class="hljs-keyword">this</span>.logger.log(
            <span class="hljs-string">`apply template: <span class="hljs-subst">${params.action}</span> <span class="hljs-subst">${params.status}</span> <span class="hljs-subst">${params.lang}</span>`</span>,<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">let</span> template = <span class="hljs-keyword">this</span>.getTemplate(params);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!template) {<font></font>
            params.lang = <span class="hljs-keyword">this</span>.DEFAULT_LANG;<font></font>
            template = <span class="hljs-keyword">this</span>.getTemplate(params);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!template) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'template-not-found'</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">return</span> template(data);<font></font>
    }<font></font>
<font></font>
    private getTemplate(params: IParams): <span class="hljs-function">(<span class="hljs-params">data: any</span>) =&gt;</span> string {
        <span class="hljs-keyword">const</span> {lang, action, status} = params;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.templatesMap.get(<span class="hljs-keyword">this</span>.getTemplateKey(lang, action, status));<font></font>
    }<font></font>
<font></font>
    private load() {<font></font>
        <span class="hljs-keyword">const</span> templatesDir: string = path.join(<font></font>
            process.cwd(),<font></font>
            <span class="hljs-keyword">this</span>.TEMPLATE_PATH,<font></font>
        );<font></font>
        <span class="hljs-keyword">const</span> templateFileNames: string[] = readDirDeepSync(templatesDir);<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.templatesMap = templateFileNames.reduce(<span class="hljs-function">(<span class="hljs-params">acc, fileName</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> template = fs.readFileSync(fileName, {<span class="hljs-attr">encoding</span>: <span class="hljs-string">'utf-8'</span>});<font></font>
<font></font>
            <span class="hljs-keyword">const</span> [, lang, action, status] = fileName<font></font>
                .replace(<span class="hljs-regexp">/\.hbs$/</span>, <span class="hljs-string">''</span>)<font></font>
                .split(<span class="hljs-string">'/'</span>);
            <span class="hljs-keyword">return</span> acc.set(
                <span class="hljs-keyword">this</span>.getTemplateKey(lang, action, status),<font></font>
                handlebars.compile(template),<font></font>
            );<font></font>
        }, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>());<font></font>
    }<font></font>
<font></font>
    private getTemplateKey(<font></font>
        lang: string,<font></font>
        <span class="hljs-attr">action</span>: string,
        <span class="hljs-attr">status</span>: string,<font></font>
    ): string {<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${lang}</span>-<span class="hljs-subst">${action}</span>-<span class="hljs-subst">${status}</span>`</span>;<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>     :</p><br>
<ol>
<li><p>      <code>./templates</code>       ,  ()   .</p><br>
<pre><code class="plaintext hljs">- templates<font></font>
 - en<font></font>
     - event_add<font></font>
        - invalid_date.hbs<font></font>
        - success.hbs<font></font>
     - event_info<font></font>
 - ru</code></pre><br>
<p>           Map      :</p><br>
<pre><code class="javascript hljs">private getTemplateKey(lang: string, <span class="hljs-attr">action</span>: string, <span class="hljs-attr">status</span>: string): string {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${lang}</span>-<span class="hljs-subst">${action}</span>-<span class="hljs-subst">${status}</span>`</span>;<font></font>
}</code></pre><br>
</li>
<li><p>      2  :     .<br>
 fallback    ()         .</p><br>
</li>
<li><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">handlebars</a> , :</p><br>
<pre><code class="plaintext hljs">Player &lt;strong&gt;{{name}}&lt;/strong&gt; will take part in the game <font></font>
List of players:<font></font>
{{#each players}}<font></font>
{{index}}: &lt;i&gt;{{name}}&lt;/i&gt;<font></font>
{{/each}}<font></font>
Total: &lt;strong&gt;{{total}}&lt;/strong&gt;</code></pre><br>
<p>   placeholder-,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>     Telegram.</p><br>
</li>
</ol><br>
<h3 id="servisy-obrabotki-komand-actions">   (Actions)</h3><br>
<p>,            - .      :</p><br>
<p><img src="https://habrastorage.org/webt/b3/xl/vl/b3xlvlw5qc93vkc3n-nylnjwpqa.jpeg" alt="è¡Œå‹•"></p><br>
<p>    <em>BaseAction</em> :</p><br>
<ol>
<li>     <em>AppEmitter</em>.</li>
<li>   ,  :<br>
<ul>
<li>           .</li>
<li>   <code>doAction</code>         <em>BaseAction</em>.</li>
<li>       <code>doAction</code>    <em>TemplateService</em>.</li>
</ul></li>
</ol><br>
<div class="spoiler"><b class="spoiler_title">BaseAction</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Injectable, Logger} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> {IMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/i-message'</span>;
<span class="hljs-keyword">import</span> {ConfigService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/config.service'</span>;
<span class="hljs-keyword">import</span> {AppEmitter} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/event-bus.service'</span>;
<span class="hljs-keyword">import</span> {TemplateService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/template.service'</span>;
<span class="hljs-keyword">import</span> {StorageService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/storage.service'</span>;
<span class="hljs-keyword">import</span> {Chat} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/chat'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseAction</span> </span>{<font></font>
    protected appEmitter: AppEmitter;<font></font>
    protected config: ConfigService;<font></font>
    protected logger: Logger;<font></font>
<font></font>
    protected templateService: TemplateService;<font></font>
    protected storageService: StorageService;<font></font>
<font></font>
    protected event: string;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(<font></font>
        config: ConfigService,<font></font>
        appEmitter: AppEmitter,<font></font>
        logger: Logger,<font></font>
        templateService: TemplateService,<font></font>
        storageService: StorageService,<font></font>
    ) {<font></font>
        <span class="hljs-keyword">this</span>.config = config;
        <span class="hljs-keyword">this</span>.logger = logger;<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.appEmitter = appEmitter;
        <span class="hljs-keyword">this</span>.templateService = templateService;
        <span class="hljs-keyword">this</span>.storageService = storageService;<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.setEvent();<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.logger.log(<span class="hljs-string">`subscribe on "<span class="hljs-subst">${<span class="hljs-keyword">this</span>.event}</span>" event`</span>);
        <span class="hljs-keyword">this</span>.appEmitter.on(<span class="hljs-keyword">this</span>.event, <span class="hljs-keyword">this</span>.handleEvent.bind(<span class="hljs-keyword">this</span>));<font></font>
    }<font></font>
<font></font>
    protected setEvent(): <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'not implemented'</span>);<font></font>
    }<font></font>
<font></font>
    protected <span class="hljs-keyword">async</span> doAction(chat: Chat, <span class="hljs-attr">message</span>: IMessage): <span class="hljs-built_in">Promise</span>&lt;IMessage&gt; {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'not implemented'</span>);<font></font>
    }<font></font>
<font></font>
    private <span class="hljs-keyword">async</span> handleEvent(message: IMessage) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">this</span>.logger.log(<span class="hljs-string">`"<span class="hljs-subst">${<span class="hljs-keyword">this</span>.event}</span>" event received`</span>);<font></font>
<font></font>
            <span class="hljs-keyword">const</span> chatId: number = message.chatId;
            <span class="hljs-keyword">const</span> chat: Chat = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.ensureChat(chatId);<font></font>
            message = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.doAction(chat, message);<font></font>
<font></font>
            message.answer(<font></font>
                <span class="hljs-keyword">this</span>.templateService.apply(<font></font>
                    {<font></font>
                        <span class="hljs-attr">action</span>: <span class="hljs-keyword">this</span>.event,
                        <span class="hljs-attr">status</span>: message.getReplyStatus(),
                        <span class="hljs-attr">lang</span>: message.lang,<font></font>
                    },<font></font>
                    message.getReplyData(),<font></font>
                ),<font></font>
            );<font></font>
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-keyword">this</span>.logger.error(error);<font></font>
            message.answer(error.message);<font></font>
        }<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>   <em>BaseAction</em>    <code>doAction</code>   :</p><br>
<ol>
<li><em>Chat</em>        </li>
<li>   <em>IMessage</em>.</li>
</ol><br>
<p>       <em>IMessage</em>,                .</p><br>
<div class="spoiler"><b class="spoiler_title">EventAddAction</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Injectable} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<font></font>
<font></font>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> statuses <span class="hljs-keyword">from</span> <span class="hljs-string">'./statuses'</span>;
<span class="hljs-keyword">import</span> {parseEventDate, formatEventDate} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/utils'</span>;
<span class="hljs-keyword">import</span> {BaseAction} <span class="hljs-keyword">from</span> <span class="hljs-string">'./base.action'</span>;
<span class="hljs-keyword">import</span> {Chat} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/chat'</span>;
<span class="hljs-keyword">import</span> {Event} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/event'</span>;
<span class="hljs-keyword">import</span> {IMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/i-message'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventAddAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseAction</span> </span>{<font></font>
    protected setEvent(): <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">this</span>.event = <span class="hljs-keyword">this</span>.appEmitter.EVENT_ADD;<font></font>
    }<font></font>
<font></font>
    protected <span class="hljs-keyword">async</span> doAction(chat: Chat, <span class="hljs-attr">message</span>: IMessage): <span class="hljs-built_in">Promise</span>&lt;IMessage&gt; {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.markChatEventsInactive(chat);<font></font>
<font></font>
        <span class="hljs-keyword">const</span> eventDate: <span class="hljs-built_in">Date</span> = parseEventDate(message.text.trim());<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!eventDate) {
            <span class="hljs-keyword">return</span> message.setStatus(statuses.STATUS_INVALID_DATE);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">const</span> event: Event = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.appendChatActiveEvent(<font></font>
            chat,<font></font>
            eventDate,<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">return</span> message.setStatus(statuses.STATUS_SUCCESS).withData({
            <span class="hljs-attr">date</span>: formatEventDate(event.date),<font></font>
        });<font></font>
    }<font></font>
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">EventRemoveAction</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Injectable} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<font></font>
<font></font>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> statuses <span class="hljs-keyword">from</span> <span class="hljs-string">'./statuses'</span>;
<span class="hljs-keyword">import</span> {formatEventDate} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/utils'</span>;
<span class="hljs-keyword">import</span> {BaseAction} <span class="hljs-keyword">from</span> <span class="hljs-string">'./base.action'</span>;
<span class="hljs-keyword">import</span> {Chat} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/chat'</span>;
<span class="hljs-keyword">import</span> {Event} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/event'</span>;
<span class="hljs-keyword">import</span> {IMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/i-message'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventRemoveAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseAction</span> </span>{<font></font>
    protected setEvent(): <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">this</span>.event = <span class="hljs-keyword">this</span>.appEmitter.EVENT_REMOVE;<font></font>
    }<font></font>
<font></font>
    protected <span class="hljs-keyword">async</span> doAction(chat: Chat, <span class="hljs-attr">message</span>: IMessage): <span class="hljs-built_in">Promise</span>&lt;IMessage&gt; {
        <span class="hljs-keyword">const</span> activeEvent: Event = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.findChatActiveEvent(<font></font>
            chat,<font></font>
        );<font></font>
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.markChatEventsInactive(chat);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (activeEvent) {
            <span class="hljs-keyword">return</span> message.setStatus(statuses.STATUS_SUCCESS).withData({
                <span class="hljs-attr">date</span>: formatEventDate(activeEvent.date),<font></font>
            });<font></font>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> message.setStatus(statuses.STATUS_NO_EVENT);<font></font>
        }<font></font>
    }<font></font>
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">EventInfoAction</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Injectable, Logger} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<font></font>
<font></font>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> statuses <span class="hljs-keyword">from</span> <span class="hljs-string">'./statuses'</span>;
<span class="hljs-keyword">import</span> {formatEventDate} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/utils'</span>;
<span class="hljs-keyword">import</span> {ConfigService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/config.service'</span>;
<span class="hljs-keyword">import</span> {AppEmitter} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/event-bus.service'</span>;
<span class="hljs-keyword">import</span> {TemplateService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/template.service'</span>;
<span class="hljs-keyword">import</span> {StorageService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/storage.service'</span>;
<span class="hljs-keyword">import</span> {BaseAction} <span class="hljs-keyword">from</span> <span class="hljs-string">'./base.action'</span>;
<span class="hljs-keyword">import</span> {PlayerHelper} <span class="hljs-keyword">from</span> <span class="hljs-string">'./player.helper'</span>;
<span class="hljs-keyword">import</span> {Chat} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/chat'</span>;
<span class="hljs-keyword">import</span> {Event} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/event'</span>;
<span class="hljs-keyword">import</span> {Player} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/player'</span>;
<span class="hljs-keyword">import</span> {IMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/i-message'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventInfoAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseAction</span> </span>{<font></font>
    private playerHelper: PlayerHelper;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(<font></font>
        config: ConfigService,<font></font>
        appEmitter: AppEmitter,<font></font>
        logger: Logger,<font></font>
        templateService: TemplateService,<font></font>
        playerHelper: PlayerHelper,<font></font>
        storageService: StorageService,<font></font>
    ) {<font></font>
        <span class="hljs-keyword">super</span>(config, appEmitter, logger, templateService, storageService);<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.playerHelper = playerHelper;<font></font>
    }<font></font>
<font></font>
    protected setEvent(): <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">this</span>.event = <span class="hljs-keyword">this</span>.appEmitter.EVENT_INFO;<font></font>
    }<font></font>
<font></font>
    protected <span class="hljs-keyword">async</span> doAction(chat: Chat, <span class="hljs-attr">message</span>: IMessage): <span class="hljs-built_in">Promise</span>&lt;IMessage&gt; {
        <span class="hljs-keyword">const</span> activeEvent: Event = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.findChatActiveEvent(<font></font>
            chat,<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!activeEvent) {
            <span class="hljs-keyword">return</span> message.setStatus(statuses.STATUS_NO_EVENT);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">const</span> players: Player[] = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.getPlayers(<font></font>
            activeEvent,<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">return</span> message.setStatus(statuses.STATUS_SUCCESS).withData({
            <span class="hljs-attr">date</span>: formatEventDate(activeEvent.date),<font></font>
            ...(<span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerHelper.getPlayersList(activeEvent)),<font></font>
        });<font></font>
    }<font></font>
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">PlayerAddAction</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Injectable, Logger} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<font></font>
<font></font>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> statuses <span class="hljs-keyword">from</span> <span class="hljs-string">'./statuses'</span>;
<span class="hljs-keyword">import</span> {ConfigService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/config.service'</span>;
<span class="hljs-keyword">import</span> {AppEmitter} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/event-bus.service'</span>;
<span class="hljs-keyword">import</span> {TemplateService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/template.service'</span>;
<span class="hljs-keyword">import</span> {StorageService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/storage.service'</span>;
<span class="hljs-keyword">import</span> {BaseAction} <span class="hljs-keyword">from</span> <span class="hljs-string">'./base.action'</span>;
<span class="hljs-keyword">import</span> {PlayerHelper} <span class="hljs-keyword">from</span> <span class="hljs-string">'./player.helper'</span>;
<span class="hljs-keyword">import</span> {Chat} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/chat'</span>;
<span class="hljs-keyword">import</span> {Event} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/event'</span>;
<span class="hljs-keyword">import</span> {Player} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/player'</span>;
<span class="hljs-keyword">import</span> {IMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/i-message'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlayerAddAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseAction</span> </span>{<font></font>
    private playerHelper: PlayerHelper;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(<font></font>
        config: ConfigService,<font></font>
        appEmitter: AppEmitter,<font></font>
        logger: Logger,<font></font>
        templateService: TemplateService,<font></font>
        playerHelper: PlayerHelper,<font></font>
        storageService: StorageService,<font></font>
    ) {<font></font>
        <span class="hljs-keyword">super</span>(config, appEmitter, logger, templateService, storageService);<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.playerHelper = playerHelper;<font></font>
    }<font></font>
<font></font>
    protected setEvent(): <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">this</span>.event = <span class="hljs-keyword">this</span>.appEmitter.PLAYER_ADD;<font></font>
    }<font></font>
<font></font>
    protected <span class="hljs-keyword">async</span> doAction(chat: Chat, <span class="hljs-attr">message</span>: IMessage): <span class="hljs-built_in">Promise</span>&lt;IMessage&gt; {
        <span class="hljs-keyword">const</span> activeEvent: Event = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.findChatActiveEvent(<font></font>
            chat,<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!activeEvent) {
            <span class="hljs-keyword">return</span> message.setStatus(statuses.STATUS_NO_EVENT);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">const</span> name: string = <span class="hljs-keyword">this</span>.playerHelper.getPlayerName(message);
        <span class="hljs-keyword">const</span> existedPlayer: Player = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.findPlayer(<font></font>
            activeEvent,<font></font>
            name,<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (existedPlayer) {
            <span class="hljs-keyword">return</span> message<font></font>
                .setStatus(statuses.STATUS_ALREADY_ADDED)<font></font>
                .withData({name});<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">const</span> newPlayer: Player = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.addPlayer(<font></font>
            activeEvent,<font></font>
            name,<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">return</span> message.setStatus(statuses.STATUS_SUCCESS).withData({
            <span class="hljs-attr">name</span>: newPlayer.name,<font></font>
            ...(<span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerHelper.getPlayersList(activeEvent)),<font></font>
        });<font></font>
    }<font></font>
}</code></pre></div></div><br>
<div class="spoiler"><b class="spoiler_title">PlayerRemoveAction</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Injectable, Logger} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;<font></font>
<font></font>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> statuses <span class="hljs-keyword">from</span> <span class="hljs-string">'./statuses'</span>;
<span class="hljs-keyword">import</span> {ConfigService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/config.service'</span>;
<span class="hljs-keyword">import</span> {AppEmitter} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/event-bus.service'</span>;
<span class="hljs-keyword">import</span> {TemplateService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/template.service'</span>;
<span class="hljs-keyword">import</span> {StorageService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/storage.service'</span>;
<span class="hljs-keyword">import</span> {BaseAction} <span class="hljs-keyword">from</span> <span class="hljs-string">'./base.action'</span>;
<span class="hljs-keyword">import</span> {PlayerHelper} <span class="hljs-keyword">from</span> <span class="hljs-string">'./player.helper'</span>;
<span class="hljs-keyword">import</span> {Chat} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/chat'</span>;
<span class="hljs-keyword">import</span> {Event} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/event'</span>;
<span class="hljs-keyword">import</span> {Player} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/player'</span>;
<span class="hljs-keyword">import</span> {IMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/i-message'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlayerRemoveAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseAction</span> </span>{<font></font>
    private playerHelper: PlayerHelper;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(<font></font>
        config: ConfigService,<font></font>
        appEmitter: AppEmitter,<font></font>
        logger: Logger,<font></font>
        templateService: TemplateService,<font></font>
        playerHelper: PlayerHelper,<font></font>
        storageService: StorageService,<font></font>
    ) {<font></font>
        <span class="hljs-keyword">super</span>(config, appEmitter, logger, templateService, storageService);<font></font>
<font></font>
        <span class="hljs-keyword">this</span>.playerHelper = playerHelper;<font></font>
    }<font></font>
<font></font>
    protected setEvent(): <span class="hljs-keyword">void</span> {
        <span class="hljs-keyword">this</span>.event = <span class="hljs-keyword">this</span>.appEmitter.PLAYER_REMOVE;<font></font>
    }<font></font>
<font></font>
    protected <span class="hljs-keyword">async</span> doAction(chat: Chat, <span class="hljs-attr">message</span>: IMessage): <span class="hljs-built_in">Promise</span>&lt;IMessage&gt; {
        <span class="hljs-keyword">const</span> activeEvent: Event = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.findChatActiveEvent(<font></font>
            chat,<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!activeEvent) {
            <span class="hljs-keyword">return</span> message.setStatus(statuses.STATUS_NO_EVENT);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">const</span> name: string = <span class="hljs-keyword">this</span>.playerHelper.getPlayerName(message);
        <span class="hljs-keyword">const</span> existedPlayer: Player = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.findPlayer(<font></font>
            activeEvent,<font></font>
            name,<font></font>
        );<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!existedPlayer) {
            <span class="hljs-keyword">return</span> message<font></font>
                .setStatus(statuses.STATUS_NO_PLAYER)<font></font>
                .withData({name});<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.removePlayer(existedPlayer);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> message.setStatus(statuses.STATUS_SUCCESS).withData({<font></font>
            name,<font></font>
            ...(<span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.playerHelper.getPlayersList(activeEvent)),<font></font>
        });<font></font>
    }<font></font>
}</code></pre></div></div><br>
<p>     :</p><br>
<ol>
<li> <code>/add</code>  <code>/remove</code> /      .    ,  /   .</li>
<li>    <code>/add</code>, <code>/remove</code>  <code>/info</code>       .</li>
</ol><br>
<p>,    (1)  (2)      :</p><br>
<div class="spoiler"><b class="spoiler_title">PlayerHelper</b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword">import</span> {Injectable} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> {StorageService} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/storage.service'</span>;
<span class="hljs-keyword">import</span> {Event} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/event'</span>;
<span class="hljs-keyword">import</span> {Player} <span class="hljs-keyword">from</span> <span class="hljs-string">'../storage/models/player'</span>;
<span class="hljs-keyword">import</span> {IMessage} <span class="hljs-keyword">from</span> <span class="hljs-string">'../message/i-message'</span>;<font></font>
<font></font>
@Injectable()<font></font>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlayerHelper</span> </span>{<font></font>
    protected storageService: StorageService;<font></font>
<font></font>
    <span class="hljs-keyword">constructor</span>(storageService: StorageService) {
        <span class="hljs-keyword">this</span>.storageService = storageService;<font></font>
    }<font></font>
<font></font>
    public getPlayerName(message: IMessage) {<font></font>
        <span class="hljs-keyword">const</span> name = message.text.trim();
        <span class="hljs-keyword">return</span> name.length &gt; <span class="hljs-number">0</span> ? name : message.name;<font></font>
    }<font></font>
<font></font>
    public <span class="hljs-keyword">async</span> getPlayersList(event: Event) {
        <span class="hljs-keyword">const</span> players: Player[] = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.storageService.getPlayers(event);<font></font>
<font></font>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">total</span>: players.length,
            <span class="hljs-attr">players</span>: players.map(<span class="hljs-function">(<span class="hljs-params">player, index</span>) =&gt;</span> ({
                <span class="hljs-attr">index</span>: index + <span class="hljs-number">1</span>,
                <span class="hljs-attr">name</span>: player.name,<font></font>
            })),<font></font>
        };<font></font>
    }<font></font>
}<font></font>
</code></pre></div></div><br>
<h3 id="sobiraem-vse-vmeste">  </h3><br>
<p>     ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">NestJS</a>.         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>     . </p><br>
<p> ,    NodeJS   ,           .   ,    ,       require-  ,         ,       .        Dependency Injection   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">awilix</a>,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">NestJS</a>  .</p><br>
<p>  DI      ,    NodeJS ,            ,        .</p><br>
<p><img src="https://habrastorage.org/webt/l2/gq/lc/l2gqlc0vig_zsywifjjopmt_4wc.jpeg" alt="ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¸€èˆ¬çš„ãªæ§‹é€ "></p><br>
<h2 id="konfiguraciya"></h2><br>
<p>           .</p><br>
<ol>
<li><code>TELEGRAM_BOT_TOKEN</code> â€”    Telegram .</li>
<li><code>TELEGRAM_USE_PROXY</code> â€”          TelegramAPI.</li>
<li><code>TELEGRAM_PROXY_HOST</code> â€”       TelegramAPI.</li>
<li><code>TELEGRAM_PROXY_PORT</code> â€”       TelegramAPI.</li>
<li><code>TELEGRAM_PROXY_LOGIN</code> â€”       TelegramAPI.</li>
<li><code>TELEGRAM_PROXY_PASSWORD</code> â€”       TelegramAPI.</li>
<li><code>VK_TOKEN</code> â€”    VK .</li>
<li><code>DATABASE_URL</code> â€”    .   production .</li>
</ol><br>
<p>     :</p><br>
<ol>
<li><code>TELEGRAM_BOT_TOKEN</code>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>      Telegram.</li>
<li><code>VK_TOKEN</code> â€”    ,  VK    . ..    ,             .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>  .</li>
<li><code>DATABASE_URL</code> â€”  production      PostgreSQL.          DBaaS   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">elephantsql</a>   .</li>
</ol><br>
<h2 id="ci">CI</h2><br>
<p>" -   â€”   ".    ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">TravisCI</a>       :</p><br>
<pre><code class="plaintext hljs">language: node_js<font></font>
node_js:<font></font>
  - '8'<font></font>
  - '10'<font></font>
  - '12'<font></font>
script:<font></font>
  - npm run lint<font></font>
  - npm run build<font></font>
  - npm run test:cov<font></font>
after_script:<font></font>
  - npm install -g codecov<font></font>
  - codecov</code></pre><br>
<p>                     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">codecov</a>.</p><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Docker</a>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Docker Hub</a>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Gonf</a>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  CI/CD   GitHub Actions  Python</a>.         Continuous Deployment,       Github:</p><br>
<pre><code class="plaintext hljs">name: Release<font></font>
<font></font>
on:<font></font>
  release:<font></font>
    types: [published]<font></font>
<font></font>
jobs:<font></font>
<font></font>
  build:<font></font>
<font></font>
    runs-on: ubuntu-latest<font></font>
<font></font>
    env:<font></font>
      LOGIN: ${{ secrets.DOCKER_LOGIN }}<font></font>
      NAME: ${{ secrets.DOCKER_NAME }}<font></font>
<font></font>
    steps:<font></font>
    - uses: actions/checkout@v1<font></font>
    - name: Install Node.js<font></font>
      uses: actions/setup-node@v1<font></font>
    - name: Login to docker.io<font></font>
      run:  echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin<font></font>
    - name: npm install and build<font></font>
      run: npm ci &amp;&amp; npm run build<font></font>
    - name: Build the Docker image<font></font>
      run: docker build -t $LOGIN/$NAME:${GITHUB_REF:10} -f Dockerfile .<font></font>
    - name: Push image to docker.io<font></font>
      run: docker push $LOGIN/$NAME:${GITHUB_REF:10}</code></pre><br>
<h2 id="rezultat-i-vyvody">  </h2><br>
<p>    .  Telegram     :<br>
       .</p><br>
<p><img src="https://habrastorage.org/webt/mi/tr/nb/mitrnbq3hcwu33lizpvmbxuirl0.png" alt="ãƒ‡ãƒ¢1"></p><br>
<p>   .</p><br>
<p><img src="https://habrastorage.org/webt/4v/y-/lk/4vy-lkg-dungqdpmbou0gop2w4e.png" alt="ãƒ‡ãƒ¢2"></p><br>
<p>     .</p><br>
<p><img src="https://habrastorage.org/webt/w8/i2/oo/w8i2oog_swdu2sjvqsqihwu8ww4.png" alt="demo3"></p><br>
<p>    VK      <code>&lt;b&gt;</code>  <code>&lt;i&gt;</code>.<br>
       .</p><br>
<p><img src="https://habrastorage.org/webt/ak/cu/fo/akcufo-5cwygqzcdfysm-uytzdi.png" alt="ãƒ‡ãƒ¢4"></p><br>
<p>     .</p><br>
<p><img src="https://habrastorage.org/webt/pg/ye/c7/pgyec7wg7kgltgjk7ton5wc7w64.png" alt="demo6"></p><br>
<p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Viber</a>,              .         ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Viber</a>   webhooks  long-polling.    ,    Viber         .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.          (?) .</p><br>
<p> Telegram            <code>@Tormozz48bot</code>.</p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> Github</a>.   ,   .</p><br>
<p>P.S.    .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja483174/index.html">ãƒãƒ«ãƒãƒ”ã‚¢ã‚³ãƒã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ã«ã‚µã‚¦ãƒ³ãƒ‰ã‚’éŒ²éŸ³ãŠã‚ˆã³è»¢é€ã™ã‚‹</a></li>
<li><a href="../ja483176/index.html">Messengerãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆãƒ‘ãƒ¼ãƒˆ1ï¼‰ï¼šãƒ™ãƒ¼ã‚¹ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¨­è¨ˆã—ã¾ã™</a></li>
<li><a href="../ja483182/index.html">Array.reduceï¼ˆï¼‰ã‚’ä½¿ç”¨ã™ã‚‹5ã¤ã®èˆˆå‘³æ·±ã„æ–¹æ³•ï¼ˆãŠã‚ˆã³1ã¤ã®é€€å±ˆãªæ–¹æ³•ï¼‰</a></li>
<li><a href="../ja483184/index.html">TensorFlow 2ã¸ã®è‡ªå‹•ã‚³ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</a></li>
<li><a href="../ja483190/index.html">3CXãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚µãƒãƒ¼ãƒˆã®å›ç­”ï¼šä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰3CX v16ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</a></li>
<li><a href="../ja483198/index.html">Alibaba CloudãŒæ•°ä¸‡ã‚‚ã®Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ç®¡ç†ã™ã‚‹æ–¹æ³•... Kubernetes</a></li>
<li><a href="../ja483202/index.html">REST APIã®æ¦‚è¦-RESTful Webã‚µãƒ¼ãƒ“ã‚¹</a></li>
<li><a href="../ja483204/index.html">RESTã¨SOAPã®é•ã„</a></li>
<li><a href="../ja483206/index.html">REST APIé–‹ç™º-æœ€åˆã«å¥‘ç´„ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ</a></li>
<li><a href="../ja483208/index.html">Kaggle MLï¼†DSã‚µãƒ¼ãƒ™ã‚¤2019ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€‚ã¾ãŸã¯MLã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã®ç²å¾—é¡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>