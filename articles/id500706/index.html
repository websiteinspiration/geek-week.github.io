<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👒 🤾 🎧 Memutakhirkan MySQL (Percona Server) dari 5.7 ke 8.0 🛌🏿 🎇 🔎</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kemajuan tidak berhenti, jadi alasan untuk meningkatkan ke versi terbaru MySQL menjadi semakin signifikan. Belum lama berselang, di salah satu proyek ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Memutakhirkan MySQL (Percona Server) dari 5.7 ke 8.0</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/500706/"><img src="https://habrastorage.org/webt/gr/ty/r9/grtyr9g5ysbgx9woi8ldfpn91ac.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemajuan tidak berhenti, jadi alasan untuk meningkatkan ke versi terbaru MySQL menjadi semakin signifikan. </font><font style="vertical-align: inherit;">Belum lama berselang, di salah satu proyek kami, tiba saatnya untuk meningkatkan cluster Percona Server 5.7 yang nyaman ke versi 8. </font><font style="vertical-align: inherit;">Semua ini terjadi pada platform Ubuntu Linux 16.04. </font><font style="vertical-align: inherit;">Cara melakukan operasi serupa dengan downtime minimal dan masalah apa yang kami temui selama peningkatan - baca artikel ini.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Latihan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setiap pembaruan dari server database kemungkinan besar terhubung dengan migrasi database: perubahan dalam persyaratan untuk batas sumber daya sistem dan koreksi konfigurasi database, yang harus dibersihkan dari arahan yang ketinggalan zaman. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebelum memperbarui, kami pasti akan beralih ke dokumentasi resmi:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Catatan rilis MySQL 8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panduan Upgrade dari MySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panduan Upgrade dari Percona</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tutorial MySQL tentang memperbarui replika dan penyihir</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan buatlah rencana aksi:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Perbaiki file konfigurasi dengan menghapus arahan usang.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Periksa kompatibilitas dengan utilitas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perbarui database budak dengan menginstal paket </font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Perbarui wizard dengan meletakkan paket yang sama.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami akan menganalisis setiap item dalam rencana dan melihat apa yang salah. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PENTING! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prosedur pemutakhiran kluster MySQL berbasis Galera memiliki kehalusannya sendiri yang tidak dijelaskan dalam artikel. </font><font style="vertical-align: inherit;">Anda tidak boleh menggunakan instruksi ini dalam kasus ini.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian 1: Memeriksa Konfigurasi</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di versi 8, MySQL telah dihapus </font></font><code>query_cache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Bahkan, itu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dinyatakan usang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kembali dalam versi 5.7, tetapi sekarang sudah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">benar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">benar dihapus</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Oleh karena itu, perlu untuk menghapus arahan terkait. </font><font style="vertical-align: inherit;">Dan untuk permintaan caching, Anda sekarang dapat menggunakan alat eksternal - misalnya, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arahan pro usang juga ditemukan di konfigurasi </font></font><code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Jika di MySQL 5.7 dimungkinkan untuk memilih format InnoDB, maka versi ke-8 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hanya</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> berfungsi </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">dengan format Barracuda</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasil kami adalah penghapusan arahan berikut:</font></font><br>
<br>
<ul>
<li> <code>query_cache_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>query_cache_limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>query_cache_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li> <code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>innodb_file_format_max</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk verifikasi, kami akan menggunakan gambar Percona Server Docker. </font><font style="vertical-align: inherit;">Kami akan meletakkan konfigurasi server di direktori </font></font><code>mysql_config_test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan selanjutnya membuat direktori untuk data dan log. </font><font style="vertical-align: inherit;">Contoh uji konfigurasi percona-server:</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p {mysql_config_test,mysql_data,mysql_logs}<font></font>
cp -r /etc/mysql/conf.d/* mysql_config_test/<font></font>
docker run  --name some-percona -v $(<span class="hljs-built_in">pwd</span>)/mysql_config_test:/etc/my.cnf.d/  -v $(<span class="hljs-built_in">pwd</span>)/mysql_data/:/var/lib/mysql/ -v $(<span class="hljs-built_in">pwd</span>)/mysql_logs/:/var/<span class="hljs-built_in">log</span>/mysql/ -e MYSQL_ROOT_PASSWORD=<span class="hljs-variable">${MYSQL_PASSWORD}</span> -d percona:8-centos</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasil: baik dalam log Docker, atau dalam direktori dengan log - tergantung pada konfigurasi Anda - file akan muncul di mana arahan masalah akan dijelaskan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inilah yang kami miliki:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-03T12:44:19.670831Z 0 [Warning] [MY-011068] [Server] The syntax 'expire-logs-days' is deprecated and will be removed in a future release. Please use binlog_expire_logs_seconds instead.<font></font>
2020-04-03T12:44:19.671678Z 0 [Warning] [MY-013242] [Server] --character-set-server: 'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.<font></font>
2020-04-03T12:44:19.671682Z 0 [Warning] [MY-013244] [Server] --collation-server: 'utf8_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan demikian, kami masih perlu berurusan dengan penyandian dan mengganti arahan usang </font></font><code>expire-logs-days</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian 2: Memverifikasi instalasi yang sedang berjalan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada 2 utilitas dalam dokumentasi pembaruan untuk memeriksa kompatibilitas database. </font><font style="vertical-align: inherit;">Penggunaannya membantu administrator memverifikasi kompatibilitas struktur data yang ada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita mulai dengan utilitas mysqlcheck klasik. </font><font style="vertical-align: inherit;">Cukup jalankan:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlcheck -u root -p --all-databases --check-upgrade</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika tidak ada masalah yang terdeteksi, utilitas akan keluar dengan kode 0: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xc/f-/yk/xcf-yknfyh2puesxjqupkstv_qo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, utilitas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql-shell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tersedia dalam versi modern MySQL </font><font style="vertical-align: inherit;">(dalam kasus Percona, ini adalah paket </font></font><code>percona-mysql-shell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Ini adalah pengganti untuk klien mysql klasik dan menggabungkan fungsi-fungsi klien, editor SQL dan alat administrasi MySQL. Untuk memeriksa server sebelum memperbarui, Anda dapat menjalankan perintah berikut melalui itu:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlsh -- util check-for-server-upgrade { --user=root --host=1.1.1.1 --port=3306 } --config-path=/etc/mysql/my.cnf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan berikut adalah komentar yang kami terima: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o_/nd/r5/o_ndr55tsfxrr0gbbu7zgala-vu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, tidak ada yang penting - hanya peringatan tentang penyandian </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(lihat di bawah)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Hasil keseluruhan implementasi: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/uy/xc/afuyxccks5gfu2w2bl1pgruvv-8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memutuskan bahwa pembaruan harus berjalan tanpa masalah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Catatan tentang peringatan di atas yang mengindikasikan masalah penyandian. </font><font style="vertical-align: inherit;">Faktanya adalah bahwa UTF-8 di MySQL sampai saat ini </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bukanlah UTF-8 yang "nyata"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , karena </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;">UTF-8</font></a><font style="vertical-align: inherit;"> hanya menyimpan 3 byte, bukannya 4. Dalam MySQL 8, mereka akhirnya </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memutuskan untuk memperbaikinya</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : alias </font></font><code>utf8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan segera mengarah ke penyandian </font></font><code>utf8mb4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan yang lama kolom dalam tabel akan menjadi </font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Di masa depan, penyandian </font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">akan dihapus, tetapi tidak dalam rilis ini. </font><font style="vertical-align: inherit;">Oleh karena itu, kami memutuskan untuk memperbaiki penyandian pada instalasi DBMS yang berfungsi, setelah memperbaruinya.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagian 3: Pembaruan Server</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang bisa salah ketika ada rencana yang sangat bagus? .. Sadar bahwa nuansa selalu terjadi, kami melakukan percobaan pertama pada klaster dev MySQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang telah disebutkan, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dokumentasi resmi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> menyoroti masalah memperbarui server MySQL dengan replika. Intinya adalah bahwa pada awalnya ada baiknya memperbarui semua replika (budak), karena MySQL 8 dapat mereplikasi dari wizard versi 5.7. Beberapa kesulitan terletak pada kenyataan bahwa kita menggunakan </font><font style="vertical-align: inherit;">mode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">master &lt;-&gt; master</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ketika master jarak jauh dalam mode </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read-only</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Faktanya, lalu lintas tempur memasuki satu pusat data, dan yang kedua adalah cadangan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Topologi adalah sebagai berikut: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uw/kx/j0/uwkxj0bwhbtjxd27brnug5iosaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Upgrade harus dimulai dengan </font><i><font style="vertical-align: inherit;">replika mysql dc 2</font></i><font style="vertical-align: inherit;"> replika</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql master dc 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dan </font></font><code>mysql replica dc 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan berakhir dengan server mysql master dc 1. Untuk keandalan yang lebih baik, kami menghentikan mesin virtual, membuatnya snapshots, dan menghentikan replikasi dengan perintah sesaat sebelum pembaruan </font></font><code>STOP SLAVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sisa pembaruan terlihat seperti ini:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setiap replika restart, menambahkan konfigurasi opsi 3: </font></font><code>skip-networking</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>skip-slave-start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>skip-log-bin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Faktanya adalah bahwa memperbarui database menghasilkan log biner dengan memperbarui tabel sistem. </font><font style="vertical-align: inherit;">Arahan ini menjamin bahwa tidak akan ada perubahan pada data aplikasi dalam database, dan informasi tentang memperbarui tabel sistem tidak akan masuk ke log biner. </font><font style="vertical-align: inherit;">Ini akan menghindari masalah saat melanjutkan replikasi.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instal paket </font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Penting untuk dicatat bahwa di MySQL 8, Anda </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tidak</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> perlu menjalankan perintah </font></font><code>mysqlupgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setelah memperbarui server.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Setelah awal yang berhasil, restart server lagi - sudah tanpa parameter yang ditambahkan pada paragraf pertama.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memastikan bahwa replikasi bekerja dengan sukses: kami memeriksa </font></font><code>SHOW SLAVE STATUS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan melihat bahwa tabel dengan penghitung dalam database aplikasi diperbarui.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua ini terlihat cukup sederhana: pembaruan dev berhasil. </font><font style="vertical-align: inherit;">Ok, Anda dapat dengan aman merencanakan upgrade semalam untuk produksi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tidak ada kesedihan - kami memperbarui prod</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Namun, port pengalaman pengembang yang sukses untuk produksi bukan tanpa kejutan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untungnya, proses pembaruan itu sendiri dimulai dengan replika, oleh karena itu, setelah mengalami kesulitan, kami berhenti bekerja dan mengembalikan replika dari snapshot. Studi masalah dijadwalkan kembali keesokan paginya. Entri berikut muncul di log:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-01-14T21:43:21.500563Z 2 [ERROR] [MY-012069] [InnoDB] table: t1 has 19 columns but InnoDB dictionary has 20 columns<font></font>
2020-01-14T21:43:21.500722Z 2 [ERROR] [MY-010767] [Server] Error in fixing SE data for db1.t1<font></font>
2020-01-14T21:43:24.208365Z 0 [ERROR] [MY-010022] [Server] Failed to Populate DD tables.<font></font>
2020-01-14T21:43:24.208658Z 0 [ERROR] [MY-010119] [Server] Aborting</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebuah studi tentang arsip berbagai milis di Google mengarah pada pemahaman bahwa masalah seperti itu muncul karena </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bug MySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Meskipun lebih tepatnya itu adalah bug utilitas </font></font><code>mysqlcheck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>mysqlsh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ternyata MySQL telah mengubah cara data disajikan untuk bidang desimal (int, tinyint, dll.), Jadi cara lain untuk menyimpannya adalah digunakan di dalam mysql-server. Jika database Anda </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">awalnya</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dalam versi 5.5 atau 5.1, dan kemudian Anda ditingkatkan ke 5.7, maka Anda mungkin perlu membuat </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beberapa tabel. Kemudian MySQL akan memperbarui file data, mentransfernya ke format penyimpanan saat ini. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda juga dapat memeriksa ini dengan utilitas </font></font><code>mysqlfrm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlfrm --diagnostic -vv /var/lib/mysql/db/table.frm<font></font>
...<font></font>
 <span class="hljs-string">'field_length'</span>: 8,
  <span class="hljs-string">'field_type'</span>: 246, <span class="hljs-comment">#  </span>
  <span class="hljs-string">'field_type_name'</span>: <span class="hljs-string">'decimal'</span>,
  <span class="hljs-string">'flags'</span>: 3,
  <span class="hljs-string">'flags_extra'</span>: 67,
  <span class="hljs-string">'interval_nr'</span>: 0,
 <span class="hljs-string">'name'</span>: <span class="hljs-string">'you_deciaml_column'</span>,<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika </font></font><code>field_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda memiliki 0, maka tipe lama digunakan dalam tabel - itu harus dilakukan </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Namun, jika nilainya 246, Anda sudah memiliki tipe baru. Informasi lebih lanjut tentang jenis dapat ditemukan dalam </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kode</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bug ini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mempertimbangkan kemungkinan alasan kedua yang telah melewati kami - kurangnya tabel InnoDB dalam tabel sistem </font></font><code>INNODB_SYS_TABLESPACES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, jika mereka, tabel, dibuat dalam versi 5.1. Untuk menghindari masalah selama pemutakhiran, Anda dapat menggunakan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">skrip SQL terlampir</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengapa kita tidak memiliki masalah seperti itu pada dev? Basis disalin secara berkala di sana dari produksi - dengan demikian, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabel diciptakan kembali</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sayangnya, pada basis data besar yang benar-benar berfungsi tidak akan berfungsi hanya untuk mengambil dan melakukan yang ada di mana-mana </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Percona-toolkit akan membantu di sini: utilitas perubahan skema pt-online sangat bagus untuk operasi OPTIMASI online. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paket yang diperbarui adalah sebagai berikut:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimalkan semua tabel.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lakukan pemutakhiran basis data.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memeriksanya dan pada saat yang sama mengetahui waktu pembaruan, kami menonaktifkan salah satu replika, dan untuk semua tabel kami menjalankan perintah berikut:</font></font><br>
<br>
<pre><code class="bash hljs">pt-online-schema-change --critical-load Threads_running=150 --alter <span class="hljs-string">"ENGINE=InnoDB"</span> --execute --chunk-size 100 --quiet --alter-foreign-keys-method auto h=127.0.0.1,u=root,p=<span class="hljs-variable">${MYSQL_PASSWORD}</span>,D=db1,t=t1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tabel diperbarui tanpa kunci panjang karena fakta bahwa utilitas membuat tabel sementara baru di mana ia menyalin data dari tabel utama. </font><font style="vertical-align: inherit;">Pada saat kedua tabel identik, tabel asli dikunci dan diganti dengan yang baru. </font><font style="vertical-align: inherit;">Dalam kasus kami, uji coba menunjukkan bahwa memperbarui semua tabel akan memakan waktu sekitar satu hari, tetapi menyalin data menyebabkan terlalu banyak memuat pada disk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menghindari ini, pada produksi kami menambahkan argumen </font></font><code>--sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dengan nilai 10 </font><font style="vertical-align: inherit;">ke perintah </font><font style="vertical-align: inherit;">- parameter ini mengontrol panjang menunggu setelah mentransfer paket data ke tabel baru. </font><font style="vertical-align: inherit;">Dengan cara ini Anda dapat mengurangi beban jika aplikasi yang benar-benar berjalan membutuhkan waktu respons. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah melakukan optimasi, pembaruan berhasil.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... tapi tidak sepenuhnya!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setengah jam setelah pembaruan, klien menemukan masalah. </font><font style="vertical-align: inherit;">Pangkalan itu bekerja sangat aneh: secara berkala, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">koneksi terputus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Inilah yang tampak dalam pemantauan: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hu/gn/7v/hugn7vq8clkacetlzfb-gli1bcw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grafik gigi gergaji terlihat di tangkapan layar, karena fakta bahwa bagian dari utas server MySQL secara berkala jatuh dengan kesalahan. </font><font style="vertical-align: inherit;">Kesalahan muncul di aplikasi:</font></font><br>
<br>
<pre><code class="plaintext hljs">[PDOException] SQLSTATE[HY000] [2002] Connection refused</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pemeriksaan log yang cepat mengungkapkan bahwa daemon mysqld tidak dapat memperoleh sumber daya yang diperlukan dari sistem operasi. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saat berurusan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dengan kesalahan, kami menemukan di </font><b><font style="vertical-align: inherit;">file kebijakan apparmor "yatim" sistem</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># dpkg -S /etc/apparmor.d/cache/usr.sbin.mysqld</span><font></font>
dpkg-query: no path found matching pattern /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/local/usr.sbin.mysqld</span>
dpkg-query: no path found matching pattern /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/usr.sbin.mysqld</span><font></font>
mysql-server-5.7: /etc/apparmor.d/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -l mysql-server-5.7</span>
rc  mysql-server-5.7 5.7.23-0ubuntu0.16.04.1      amd64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
File-file ini dibentuk selama peningkatan ke MySQL 5.7 beberapa tahun yang lalu dan termasuk dalam paket jarak jauh. </font><font style="vertical-align: inherit;">Menghapus file dan memulai kembali layanan apparmor memecahkan masalah:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl stop apparmor<font></font>
rm /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/usr.sbin.mysqld<font></font>
systemctl start apparmor</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Akhirnya</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa pun, bahkan operasi paling sederhana, dapat menyebabkan masalah yang tidak terduga. </font><font style="vertical-align: inherit;">Dan bahkan memiliki rencana yang dipikirkan dengan matang tidak selalu menjamin hasil yang diharapkan. </font><font style="vertical-align: inherit;">Sekarang, dalam rencana pembaruan apa pun, tim kami juga menyertakan pembersihan wajib file tambahan yang dapat muncul sebagai akibat dari tindakan terbaru. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan dengan karya grafis yang tidak terlalu profesional ini, saya ingin mengucapkan terima kasih kepada Percona atas produk hebat mereka!</font></font><br>
<br>
<img height="75" width="75" src="https://habrastorage.org/webt/b1/af/mg/b1afmgyaozxjh0dqcbr3jrkdlk4.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Baca juga di blog kami:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Database dan Kubernetes (review dan laporan video)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes tips &amp; trik: mempercepat bootstrap dari database besar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 kisah praktis dari kehidupan sehari-hari SRE kami</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”;</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">    Redis  K8s  -      </a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">  MongoDB  Kubernetes</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id500694/index.html">68 tips yang tidak diminta</a></li>
<li><a href="../id500696/index.html">Bagaimana sepatu lari berusaha beradaptasi dengan kaki wanita</a></li>
<li><a href="../id500698/index.html">Evgeny Katyshev: "OpenStreetMap tidak cocok untuk informasi apa pun"</a></li>
<li><a href="../id500700/index.html">Dukungan untuk TLS1.3 dan perluasan akun pribadi Anda: apa yang telah dilakukan untuk kuartal pertama tahun 2020</a></li>
<li><a href="../id500704/index.html">Unicorn (Airbnb, Uber, Lyft, Careem) memecat ribuan karyawan di tengah masalah selama pandemi coronavirus</a></li>
<li><a href="../id500708/index.html">Keamanan dan DBMS: apa yang perlu Anda ingat ketika memilih alat perlindungan</a></li>
<li><a href="../id500712/index.html">Digital Coronavirus - Kombinasi Ransomware dan Infostealer</a></li>
<li><a href="../id500718/index.html">EPAM dalam mode jarak jauh: cara kerjanya</a></li>
<li><a href="../id500720/index.html">Standar keamanan informasi baru: membuat hidup lebih sulit bagi penyerang</a></li>
<li><a href="../id500722/index.html">"Panggang sampai siap": yang menyimpan rekaman langka dengan cara yang tidak biasa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>