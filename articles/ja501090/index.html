<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🎨 🧓🏽 🛌 K8Sマルチクラスタージャーニー 🧕🏼 🧔🏼 🏔️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！
 
 私たちはExnessプラットフォームチームを代表しています。以前、私たちの同僚はすでにk8sの製品版イメージに関する記事を書いています。今日は、Kubernetesでのサービス移行の経験を共有したいと思います。
 
 
 
 まず、何が議論されるかをよりよく理解するために...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>K8Sマルチクラスタージャーニー</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/exness/blog/501090/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはExnessプラットフォームチームを代表しています。</font><font style="vertical-align: inherit;">以前、私たちの同僚はすでに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k8sの製品版イメージ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に関する記事を書いてい</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">今日は、Kubernetesでのサービス移行の経験を共有したいと思います。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_w/_v/4y/_w_v4y4cimb9xplp-da3e-cnwx4.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、何が議論されるかをよりよく理解するためにいくつかの数値を提供します。</font></font><br>
<br>
<ul>
<li>    100+ ,    10      QA, DevOps  Scrum.   — Python, PHP, C++, Java  Golang.&nbsp;<br>
</li>
<li>    —  2000   .     Rancher v1.6      VMware.&nbsp;<br>
</li>
</ul><br>
<h4></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らが言うように、永遠に続くものは何もなく、ランチャーはバージョン1.6のサポートの終了を十分に長い間発表しました。</font><font style="vertical-align: inherit;">はい、3年以上の間、調理方法と発生した問題の解決方法を学びましたが、解決できない問題に直面することが多くなっています。</font><font style="vertical-align: inherit;">Rancher 1.6には、権利を発行するための骨化されたシステムもあり、ほとんどすべてを実行できるか、何も実行できない。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
独自の仮想化。ただし、データストレージとセキュリティをより適切に制御できますが、運用コストがかかります。これは、会社の継続的な成長、プロジェクトの数、およびそれらの要件に耐えることが困難でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、IaC標準に準拠し、必要に応じて、地理的にどこにいてもベンダーロックなしですぐに電力を利用できるようにし、それらをすばやく放棄できるようにしたいと考えました。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初のステップ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず第一に、チームが開発サイクルを短縮し、電力を提供するプラットフォームとのやり取りの運用コストを最小限に抑えることができる最新のテクノロジーとソリューションに依存したかったのです。&nbsp; </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、最初に頭に浮かんだのはKubernetesでしたが、興奮することはなく、正しい選択のテーマについて少し調査しました。私たちはオープンソースソリューションのみを評価し、Kubernetesは不当な戦いで無条件に敗北しました。&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次は、クラスターを作成するためのツールを選択するという質問です。最も人気のあるソリューションであるkops、kubespray、kubeadmを比較しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
手始めに、kubeadmは私たちには「自転車」の発明者の一種のように複雑すぎるように見え、kopsは柔軟性に欠けていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして勝者が出ました：</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/35e/1e6/e85/35e1e6e85e12e982649fd020862463cd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは独自の仮想化とAWSで実験を開始し、誰もが同じ「クラスター」を使用する以前のリソース管理パターンに似たものを再現しようと試みました。</font><font style="vertical-align: inherit;">そして現在、10台の小さな仮想マシンの最初のクラスターがあり、そのうちのいくつかはAWSにあります。</font><font style="vertical-align: inherit;">私たちはそこにチームを移行しようとしました、すべてが「良い」ようで、物語は完成する可能性がありましたが...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の問題</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ansibleはkubesprayが構築されているものであり、IaCを追跡できるツールではありません。ノードの入力/出力中に問題が発生し、いくつかの介入が必要でした。また、異なるOSを使用している場合、プレイブックは動作しましたさまざまな方法で。クラスタ内のコマンドとノードの数が増えるにつれ、プレイブックに時間がかかっていることに気付き始めました。結局、記録は3.5時間で、あなたの記録はどうですか。 :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、kubesprayは単なるAnsibleのようで、一見するとすべてが明らかですが、最初</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/11e/593/7d7/11e5937d7576851ad38e8469502e6d7f.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はAWSと仮想化でのみキャパシティを実行するタスクがありましたが、その後、多くの場合、要件が変更されました。</font></font><br>
&nbsp;<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e4f/b1b/f10/e4fb1bf10754dc4ea192c0a05d2e524c.png"><img src="https://habrastorage.org/getpro/habr/post_images/e1d/eeb/7d5/e1deeb7d5c4b2392962fbe5b6a528388.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これに照らして、リソースを1つのオーケストレーションシステムに結合するという以前のパターンは適切ではないことが明らかになりました。クラスターが遠く離れており、異なるプロバイダーによって管理されている場合です。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらにもっと。すべてのチームが同じクラスター内で機能する場合、NodeSelectorが正しくインストールされていないさまざまなサービスが別のチームの「エイリアン」ホストに飛んで、そこでリソースを利用する可能性があり、汚染を設定する場合、これまたはそのサービスが機能していないという呼び出しが常にありました。人的要因により正しく分配されました。別の問題は、特にノードによるサービスの分配の問題を考えると、コストの計算でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別の話は、従業員への権利の問題でした。各チームはクラスターの「先頭」にいて、完全に管理する必要がありました。これは、チームがほとんど独立しているため、完全に崩壊する可能性があります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">になる方法</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記と、チームがより独立したいという願いを踏まえて、私たちは単純な結論を出しました。1つのチーム-1つのクラスターです。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで、2つ</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/5ca/125/895/5ca125895d8571f18c41034f226c65d5.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
目のクラスター</font><font style="vertical-align: inherit;">を取得し、</font><font style="vertical-align: inherit;">次に3 </font><font style="vertical-align: inherit;">つ</font><font style="vertical-align: inherit;">目のクラスター</font><font style="vertical-align: inherit;">を取得しました</font><font style="vertical-align: inherit;">。&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/81b/7a9/f75/81b7a9f755d7be0798ec641ef8d444ae.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に考え始めました。たとえば、1年間でチームに複数のクラスターができるとしましょう。たとえば、地理的に異なる地域、または異なるプロバイダーの管理下にありますか？そして、それらの一部は、任意のテスト用の一時クラスターを迅速にデプロイできるようにしたいと考えるでしょう。&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/265/52e/0a5/26552e0a5bb71a6f82b3dd4f3226b768.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フルKubernetesが来るでしょう！これはある種のMultiKubernetesであることがわかりました。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、これらすべてのクラスターを何らかの形でサポートし、それらへのアクセスを簡単に制御できるようにし、手動で介入することなく新しいクラスターを作成して古いクラスターを廃止する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetesの世界への旅が始まってから時間が経ち、利用可能なソリューションを再検討することにしました。それはすでに市場に存在していることが判明しました-Rancher 2.2。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/9a2/c00/e81/9a2c00e81c4d2a0daf2b6f0a7afe8c0a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
調査の最初の段階で、Rancher Labsはすでにバージョン2の最初のリリースを作成しましたが、いくつかのパラメーターを使用して外部依存関係なしでコンテナーを実行するか、公式のHELMチャートを使用することによって非常に迅速に上げることができましたが、それは私たちには大雑把であるように見え、それが開発されるか、すぐに放棄されるかにかかわらず、この決定に依存します。 UIのcluster = clicksパラダイム自体も適していませんでした。これは、非常に狭義のツールであるため、RKEに接続したくありませんでした。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rancher 2.2バージョンはすでにより効率的な外観をしており、以前のバージョンと同様に、多くの外部プロバイダーとの統合、権利とkubeconfigファイルの単一の配布ポイント、UIでの権利を持つkubectlイメージの起動、プロジェクトのネストされた名前空間、プロジェクトなど、箱から出してすぐに使える興味深い機能がたくさんありました。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rancher 2を中心にコミュニティがすでに形成されており、それを管理するためにHashiCorp Terraformプロバイダーが作成されました。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どうした</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、Rancherが起動された1つの小さなクラスターが取得され、他のすべてのクラスター、およびそれに関連付けられている多くのクラスターにアクセスできます。これらのクラスターへのアクセスは、ユーザーがどこにいるかに関係なく、LDAPディレクトリにユーザーを追加するのと同じくらい簡単に発行できます。が見つかり、プロバイダーが使用するリソース。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gitlab-ciとTerraformを使用して、クラウドプロバイダーまたは独自のインフラストラクチャで任意の構成のクラスターを作成し、それらをRancherに接続できるシステムが作成されました。これはすべてIaCスタイルで行われ、各クラスターはリポジトリーによって記述され、その状態はバージョン管理されます。この場合、ほとんどのモジュールは外部リポジトリから接続されるため、変数を転送したり、インスタンスのカスタム構成を記述したりするだけなので、コードの再現性の割合を減らすのに役立ちます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/eae/814/877/eae814877be3c3a957b6f75a2c657f58.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、私たちの道のりは遠くからではなく、クラスターのログとメトリックを使用した単一の作業ポイント、サービスメッシュ、マルチクラスターの負荷を管理するためのGitopsなど、多くの興味深いタスクがまだ先にあります。私たちの経験に興味を持っていただければ幸いです。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事は、A。Antipov、A。Ganush、プラットフォームエンジニアによって書かれました。&nbsp;</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja501072/index.html">では、誰がラジオを発明したのか：グリエルモマルコーニまたはアレクサンドルポポフ？</a></li>
<li><a href="../ja501076/index.html">月を削除しました。Jet Infosystemsのワーキンググループのリーダーによるライフハックを要約して共有します</a></li>
<li><a href="../ja501084/index.html">Angularで観察可能なサービス</a></li>
<li><a href="../ja501086/index.html">h4ck 2020のSumm3r。デジタルセキュリティサマーチュートリアル</a></li>
<li><a href="../ja501088/index.html">それを指定します。Yandexレポート</a></li>
<li><a href="../ja501092/index.html">有望な6月の検索と「ウダレンカ」について。Redmadrobotテクニカルサポートマネージャーの経験</a></li>
<li><a href="../ja501098/index.html">モジュラーUPS用SmartLiスマートバッテリーソリューション</a></li>
<li><a href="../ja501106/index.html">PythonとBalabolkaを使用した最も簡単な英語の単語シミュレーター</a></li>
<li><a href="../ja501108/index.html">Nvidia Streaming Multiprocessor History</a></li>
<li><a href="../ja501110/index.html">メビウスとWWDC：一緒にもっと楽しく</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>