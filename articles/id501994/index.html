<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😬 🧥 👖 Orchestrator untuk MySQL: mengapa proyek gagal-aman tidak dapat dibangun tanpanya ⏸️ 🦍 📒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Setiap proyek besar dimulai dengan sepasang server. Pertama, ada satu server DB, kemudian budak ditambahkan ke dalamnya untuk skala pembacaan. Dan di ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Orchestrator untuk MySQL: mengapa proyek gagal-aman tidak dapat dibangun tanpanya</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/citymobil/blog/501994/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setiap proyek besar dimulai dengan sepasang server. </font><font style="vertical-align: inherit;">Pertama, ada satu server DB, kemudian budak ditambahkan ke dalamnya untuk skala pembacaan. </font><font style="vertical-align: inherit;">Dan di sini - berhenti! </font><font style="vertical-align: inherit;">Satu tuan, tetapi banyak budak; </font><font style="vertical-align: inherit;">jika salah satu budak pergi, maka semuanya akan baik-baik saja, tetapi jika master pergi, itu akan menjadi buruk: downtime, admin di sabun meningkatkan server. </font><font style="vertical-align: inherit;">Apa yang harus dilakukan? </font><font style="vertical-align: inherit;">Cadangan master. </font><font style="vertical-align: inherit;">Rekan saya Pavel sudah menulis </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tentang ini </font><font style="vertical-align: inherit;">, saya tidak akan mengulanginya. </font><font style="vertical-align: inherit;">Sebaliknya, saya akan memberi tahu Anda mengapa Anda benar-benar membutuhkan Orkestra untuk MySQL!</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita mulai dengan pertanyaan utama: "Bagaimana kita akan mengganti kode ke mesin baru ketika wizard pergi?"</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya paling suka skema dengan VIP (Virtual IP), kami akan membicarakannya di bawah ini. </font><font style="vertical-align: inherit;">Ini adalah yang paling sederhana dan paling jelas, meskipun memiliki batasan yang jelas: master, yang akan kami cadangan, harus berada di segmen L2 dengan mesin baru, yaitu, Anda bisa melupakan DC kedua. </font><font style="vertical-align: inherit;">Dan, dengan cara yang baik, jika Anda mengikuti aturan bahwa L2 besar itu jahat, karena L2 hanya per rak, dan di antara rak L3, dan skema semacam itu bahkan memiliki batasan lebih.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat mendaftarkan nama DNS dalam kode dan menyelesaikannya melalui / etc / hosts. </font><font style="vertical-align: inherit;">Bahkan, tidak akan ada resolusi. </font><font style="vertical-align: inherit;">Keuntungan skema: tidak ada batasan karakteristik dari metode pertama, yaitu, Anda juga dapat mengatur lintas-DC. </font><font style="vertical-align: inherit;">Tetapi kemudian muncul pertanyaan yang jelas, seberapa cepat melalui Puppet-Ansible kita dapat mengirimkan perubahan ke / etc / hosts.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat mengubah metode kedua sedikit: pada semua server web kami menaruh caching DNS, di mana kode akan masuk ke master database. </font><font style="vertical-align: inherit;">Anda dapat mendaftarkan TTL 60 untuk entri DNS ini. </font><font style="vertical-align: inherit;">Tampaknya dengan implementasi yang tepat, metode ini baik.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skema dengan penemuan layanan, yang melibatkan penggunaan Konsul dan lain-lain.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Opsi yang menarik dengan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Penting untuk membungkus semua lalu lintas ke MySQL melalui ProxySQL, ProxySQL dapat menentukan siapa masternya sekarang. </font><font style="vertical-align: inherit;">Ngomong-ngomong, tentang salah satu opsi untuk menggunakan produk ini dapat ditemukan di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">artikel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saya </font><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Penulis Orchestrator, saat mengerjakan Github, pertama mengimplementasikan skema pertama dengan VIP, dan kemudian mendesain ulangnya dengan c consul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Skema infrastruktur khas:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/76b/1d1/aa6/76b1d1aa670440b7abab79d7af3e3c4d.png" alt="gambar"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya akan segera menggambarkan situasi yang jelas untuk dipertimbangkan:</font></font><br>
<br>
<ul>
<li>VIP-           .  :  ,    , Orchestrator    failover      ;    ,   VIP   .  .</li>
<li>            .     ifdown,     — ifup vip.       ,    failover       ,    splitbrain.</li>
<li> ,  Orchestrator   ,    VIP /    ,         VIP,    arping  ,   VIP  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semua budak harus memiliki read_only = 1, dan segera setelah Anda mempromosikan slave ke master, itu seharusnya read_only = 0.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jangan lupa bahwa budak mana pun yang telah kami pilih untuk ini dapat menjadi master (Orchestrator memiliki seluruh mekanisme preferensi, yang mana budak harus dianggap sebagai calon master baru, yang mana yang kedua, dan yang budak mana yang tidak boleh dipilih sama sekali dalam keadaan apa pun) menguasai). </font><font style="vertical-align: inherit;">Jika budak menjadi master, maka beban budak akan tetap di atasnya dan beban master akan ditambahkan, ini harus diperhitungkan.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mengapa Anda benar-benar membutuhkan Orkestrator jika Anda tidak memilikinya?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orchestrator memiliki antarmuka grafis yang sangat user-friendly yang menampilkan seluruh topologi (lihat screenshot di bawah).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orchestrator dapat melacak budak mana yang ada di belakang, dan di mana replikasi umumnya rusak (kami memiliki skrip untuk mengirim SMS ke Orchestrator).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orchestrator memberi tahu Anda slide mana yang memiliki galat eritan GTID.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antarmuka orkestra:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f9/44a/bfc/4f944abfc03d26710c2164369c185893.png" alt="gambar"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa itu GTID errant? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ada dua persyaratan dasar bagi Orkestra untuk bekerja:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penting bahwa pseudo GTID diaktifkan di semua mesin di kluster MySQL, kami mengaktifkan GTID.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penting bahwa di mana-mana ada satu jenis binlog, Anda dapat membuat pernyataan. </font><font style="vertical-align: inherit;">Kami memiliki konfigurasi di mana Row berada di master dan pada sebagian besar budak, dan mode Mixed tetap secara historis pada dua. </font><font style="vertical-align: inherit;">Akibatnya, Orchestrator tidak mau menghubungkan budak-budak ini dengan master baru.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ingatlah bahwa hal terpenting dalam seorang budak produksi adalah konsistensinya dengan tuan! </font><font style="vertical-align: inherit;">Jika Anda memiliki Global Transaction ID (GTID) diaktifkan pada master dan slave, Anda dapat menggunakan fungsi gtid_subset untuk mengetahui apakah permintaan perubahan data yang sama benar-benar dieksekusi pada mesin ini. </font><font style="vertical-align: inherit;">Baca lebih lanjut tentang ini di </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sini</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, Orchestrator menunjukkan kepada Anda melalui kesalahan erat GTID bahwa ada transaksi pada slave yang tidak ada di wizard. </font><font style="vertical-align: inherit;">Kenapa itu terjadi?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read_only = 1 tidak diaktifkan pada slave, seseorang terhubung dan mengeksekusi permintaan untuk perubahan data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Super_read_only = 1 tidak diaktifkan pada slave, maka administrator, setelah mencampuradukkan server, masuk dan mengeksekusi permintaan di sana.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika Anda memperhitungkan kedua paragraf sebelumnya, ada satu trik lagi: di MySQL, permintaan untuk flush binlogs juga jatuh ke dalam binlog, jadi ketika Anda flush untuk pertama kalinya, galaksi GTID akan muncul di wizard dan pada semua budak. </font><font style="vertical-align: inherit;">Bagaimana cara menghindarinya? </font><font style="vertical-align: inherit;">Dalam perona-5.7.25-28, pengaturan binlog_skip_flush_commands = 1 muncul, yang melarang penulisan flush ke binlog. </font><font style="vertical-align: inherit;">Ada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bug di</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mysql.com </font><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya merangkum semua hal di atas. </font><font style="vertical-align: inherit;">Jika Anda belum ingin menggunakan Orchestrator dalam mode failover, masukkan ke mode pengawasan. </font><font style="vertical-align: inherit;">Maka Anda akan selalu memiliki di depan mata Anda peta interaksi mesin MySQL dan informasi yang jelas tentang jenis replikasi pada setiap mesin, apakah budak di belakang, dan yang paling penting - seberapa banyak konsistensi yang mereka miliki dengan master!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertanyaan yang jelas adalah: "Bagaimana seharusnya Orchestrator bekerja?" Dia harus memilih master baru dari slave saat ini, dan kemudian menghubungkan kembali semua slave ke sana (inilah gunanya GTID; jika Anda menggunakan mekanisme lama dengan binlog_name dan binlog_pos, maka mengalihkan slave dari master saat ini ke yang baru tidak mungkin!). Sebelum Orchestrator datang kepada kami, saya pernah harus melakukan semua ini secara manual. Master tua jatuh karena controller Adaptec buggy, itu memiliki sekitar 10 budak. Saya perlu mentransfer VIP dari master ke salah satu budak dan menghubungkan kembali semua budak lain ke sana. Berapa banyak konsol yang harus saya buka, berapa banyak perintah simultan untuk masuk ... Saya harus menunggu sampai jam 3 pagi, menghapus beban dari semua budak, kecuali dua, membuat mobil pertama dari dua tuan, segera menghubungkan mobil kedua ke sana,oleh karena itu, ambil semua budak lain ke master baru dan kembalikan beban. Secara umum, kengerian ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bagaimana cara kerja Orchestrator ketika memasuki mode failover? Ini paling mudah ditunjukkan oleh contoh situasi di mana kami ingin menjadikan master mesin yang lebih kuat, lebih modern daripada sekarang.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/577/a97/07d/577a9707d589865d8c5318281c418758.png" alt="gambar"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gambar tersebut menunjukkan tengah proses. </font><font style="vertical-align: inherit;">Apa yang sudah dilakukan sampai titik ini? </font><font style="vertical-align: inherit;">Kami mengatakan bahwa kami ingin membuat semacam budak menjadi master baru, Orchestrator baru saja mulai menghubungkan kembali semua budak lain ke dalamnya, dan master baru bertindak sebagai mesin transit. </font><font style="vertical-align: inherit;">Dengan skema ini, kesalahan tidak terjadi, semua budak berfungsi, Orkestra menghapus VIP dari master lama, mentransfer ke yang baru, membuat read_only = 0 dan lupa tentang master lama. </font><font style="vertical-align: inherit;">Semua! </font><font style="vertical-align: inherit;">Waktu henti layanan kami adalah waktu transfer VIP, itu adalah 2-3 detik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu saja untuk hari ini, terima kasih semuanya. </font><font style="vertical-align: inherit;">Segera akan ada artikel kedua tentang Orchestrator. </font><font style="vertical-align: inherit;">Dalam film Soviet yang terkenal "The Garage," seorang pahlawan berkata, "Aku tidak akan pergi ke intelijen dengannya!" </font><font style="vertical-align: inherit;">Jadi, Orchestrator, saya akan pergi bersama Anda untuk mencari!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id501984/index.html">Apa yang harus dilihat di karantina? Pilihan bahan dari Technostream (bagian 4)</a></li>
<li><a href="../id501986/index.html">Rahasia kesuksesan Apple AirPods yang luar biasa</a></li>
<li><a href="../id501988/index.html">Bagaimana layar pesan VK ditampilkan?</a></li>
<li><a href="../id501990/index.html">Pos yang berguna: 4 acara untuk menyelesaikan masalah hari kedua di OpenShift dan membuat operator</a></li>
<li><a href="../id501992/index.html">Bagaimana mengatur pengujian untuk mempercepat dan menstabilkan rilis produk. Bagian 1</a></li>
<li><a href="../id501996/index.html">Zen Go (Versi Saku)</a></li>
<li><a href="../id501998/index.html">Harga gaya mahal. Laporan Yandex</a></li>
<li><a href="../id502000/index.html">12 Mata Kuliah Rekayasa Data Online</a></li>
<li><a href="../id502004/index.html">Metode Kanban: Memahami Proses Anda sebagai Proses Membangun Pengetahuan Kolektif - Bagian 1 (resep)</a></li>
<li><a href="../id502008/index.html">Pemrograman ke massa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>