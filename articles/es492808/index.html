<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçüè´ üôéüèº üë®üèª‚Äçüíª Sensor de posici√≥n del interruptor de luz de emergencia üë©‚Äçüë©‚Äçüëß‚Äçüë¶ üëÅ‚Äçüó® üçß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Antes que todos los que dise√±an un sistema aut√≥nomo de iluminaci√≥n de emergencia, tarde o temprano, surge el problema de encender y apagar las luces d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Sensor de posici√≥n del interruptor de luz de emergencia</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492808/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes que todos los que dise√±an un sistema aut√≥nomo de iluminaci√≥n de emergencia, tarde o temprano, surge el problema de encender y apagar las luces de emergencia. </font><font style="vertical-align: inherit;">¬øC√≥mo hacer esto de la manera m√°s conveniente y transparente, para no estropear el dise√±o de las habitaciones con interruptores adicionales?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f4/90/kp/f490kpxmliwuhfpeeuf-lhmjhou.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una de las soluciones debajo del corte.</font></font><br>
<a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antecedentes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el mundo moderno, muchas cosas se han relacionado con el suministro de energ√≠a ininterrumpido. La mayor√≠a de los tipos de actividad intelectual ya son inconcebibles sin una computadora y comunicaciones que funcionan 24/7. Esto no es ni bueno ni malo, y debes vivir con ello. Especialmente si su lugar de trabajo no est√° en una oficina moderna, repleta de UPS y generadores diesel de respaldo, sino en un departamento de un edificio residencial com√∫n de gran altura. Y sucedi√≥ que la fiabilidad del suministro de energ√≠a de las viviendas en la mayor√≠a de las ciudades de la antigua URSS deja mucho que desear. Como resultado, el hilo que conecta la toma de corriente dom√©stica y la central el√©ctrica m√°s cercana tiene la mala costumbre de romperse peri√≥dicamente. Una vez cada seis meses, y cu√°ndo y tres veces al d√≠a.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es por eso que, al comenzar las reparaciones en un nuevo apartamento, inicialmente puse cableado paralelo en el proyecto para el suministro de energ√≠a ininterrumpida y la iluminaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me gustar√≠a mucho tener a mi disposici√≥n un generador potente con ICE, capaz de proporcionar energ√≠a normal a todo el departamento, pero tuve que abandonar esta idea. En una casa privada, la pregunta no se habr√≠a planteado en absoluto, pero un apartamento es otra muy distinta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer problema es la eliminaci√≥n de los gases de escape, que no hay absolutamente ning√∫n lugar para colocar en el apartamento de una casa con calefacci√≥n central. Bueno, no tirar√°s la manguera justo afuera de la ventana, donde el humo es absorbido instant√°neamente por la ventana abierta del vecino m√°s cercano.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El segundo problema es el ruido. S√≠, los generadores inversores de cuatro tiempos modernos, cuando los escuchas en la calle, pueden parecer muy silenciosos. Y si cuelgas un silenciador adicional, entonces completamente silencioso. Pero cr√©anme, en un edificio desenergizado, lo que significa un edificio de apartamentos completamente tranquilo, incluso un ruido tan tranquilo ser√° perfectamente audible para todos los vecinos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En resumen, la idea con el generador muri√≥, tan claramente y no naci√≥. De las opciones reales restantes, solo quedaban bater√≠as.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, me permito una narraci√≥n simple de mis pruebas emocionales y las decisiones tomadas en primera persona sin ning√∫n reclamo de verdad universal. </font><font style="vertical-align: inherit;">E inmediatamente advierto que mis argumentos a alguien pueden parecer poco convincentes, y las decisiones tomadas son controvertidas. </font><font style="vertical-align: inherit;">Pero, sin embargo, todo lo descrito aqu√≠ se implementa actualmente en hardware y realiza con √©xito las tareas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y si alguien est√° interesado en el lado puramente pr√°ctico del problema y no importa c√≥mo llegu√© a esa vida, puede </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">omitir muchas cartas e ir directamente a la descripci√≥n de la soluci√≥n preparada.</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brevemente acerca de elegir el tipo de bater√≠a</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aunque este problema no tiene nada que ver con el tema del art√≠culo, me gustar√≠a insertar mis cinco centavos aqu√≠ tambi√©n. Por otra parte, que inevitablemente surgen en tales discusiones declaraciones menudo lleva a una gran cantidad </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de lulz</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> informaci√≥n √∫til. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoy, en el siglo de r√°pido desarrollo de la energ√≠a alternativa, han comenzado a aparecer sistemas de suministro de energ√≠a ininterrumpida para el hogar, relativamente asequibles, fabricados industrialmente, combinados con plantas de energ√≠a solar o e√≥lica. Los m√°s avanzados usan bater√≠as de iones de litio con un mont√≥n de "potenciadores" electr√≥nicos de la efectividad de todo el sistema.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En mi caso, no se puede hablar de ninguna mini planta de energ√≠a debido a razones objetivas, y solo la fuente de respaldo, renovable desde un tomacorriente ordinario durante la "iluminaci√≥n", fue interesante. Por lo tanto, se decidi√≥ cultivar colectivamente todo el relleno electr√≥nico del UPS del departamento por su cuenta. Y como mis manos estaban completamente desatadas, lo primero que deb√≠a decidirse era qu√© tipo de bater√≠as usar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al principio, pens√© as√≠: ‚Äú¬øPor qu√© no litio? </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Juventud de moda con estilo</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Sellado, energ√©ticamente eficiente, duradero ". Pero cuando mir√© los precios, mi fervor de litio disminuy√≥ notablemente. Una b√∫squeda r√°pida en combinaci√≥n con la aritm√©tica escolar mostr√≥ que incluso los bancos 26650 chinos muy "tontos" con (por supuesto) los 5000 mAH m√°s honestos costar√°n cinco veces m√°s que una bater√≠a √°cida de la misma intensidad energ√©tica. Y si elige algo que no est√© en la parte inferior del precio ordenado por precio, la diferencia llega f√°cilmente a 8-10 veces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øY c√≥mo puede compensar una diferencia de valor tan grande? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S√≠, el litio almacena energ√≠a de manera m√°s eficiente por cada kilogramo y metro c√∫bico, y una bater√≠a del tama√±o de un bloque de cigarrillos dedica f√°cilmente una bater√≠a de plomo-√°cido de diez kilogramos. ¬øPero es este hecho tan importante para el uso estacionario?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, un buen "litio", pero con el enfoque correcto durar√° m√°s. ¬øPero diez veces? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al mismo tiempo, en el otro lado de la escala, la potencial explosividad de las bater√≠as de origen desconocido, un algoritmo de carga m√°s complejo, problemas de eliminaci√≥n (cada persona sin hogar sabe d√≥nde usar una bater√≠a de plomo para obtener ganancias, mientras que el litio es mucho m√°s complicado hasta ahora). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En resumen, por la suma de los factores, decid√≠ posponer la idea de litio hasta la pr√≥xima iteraci√≥n. Quiz√°s en unos a√±os algo cambie, pero por ahora, el plomo es nuestro todo.</font></font><br>
<br>
<blockquote>,      ,        .    ,    ,           ,           .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cuanto a las bater√≠as de plomo, tambi√©n hay varias opciones. La opci√≥n "correcta" son las bater√≠as de respaldo especializadas, que se usan en UPS, en estaciones base celulares y en otros lugares similares donde se requiere que puedan tomar y entregar grandes corrientes, ocasionalmente experimentar una descarga fuerte y, de hecho, trabajar sin distraer a las personas. para servicio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otra opci√≥n "correcta" son las bater√≠as de tracci√≥n para cargadores autom√°ticos el√©ctricos o, qu√© demonios, un submarino di√©sel. Estas bater√≠as tienen una alta durabilidad y buena tolerancia a las descargas profundas, mientras que no le quitan al propietario la oportunidad de "recargar un poco de agua".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, la opci√≥n "incorrecta" es la bater√≠a de arranque de la tienda de autom√≥viles m√°s cercana. Tal bater√≠a puede ceder brevemente hasta un kilovatio de energ√≠a a la monta√±a, pero cualquier descarga es estresante para ella, como el trabajo para una persona perezosa. Y la gloria de las bater√≠as desechables generalmente est√° arraigada en las bater√≠as de calcio modernas: "descargadas - cambio".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, entonces, espero que nadie dude de qu√© opci√≥n finalmente seleccion√© para la implementaci√≥n. Correcto, tercero. Y las razones aqu√≠ radican no solo en el conocido anfibio verrugoso, sino tambi√©n en un simple c√°lculo pragm√°tico. Las bater√≠as de arranque son varias veces m√°s baratas que todas las dem√°s opciones, a veces se acercan al valor del litio. Y en lugar de sacudirse por una bater√≠a costosa, se siente mucho m√°s libre en una situaci√≥n de indiferencia saludable, cuando el reemplazo resulta en p√©rdidas en la cantidad de alimentos durante un par de semanas. Adem√°s, si no deja que estas bater√≠as se agoten antes de perder el pulso, su vida √∫til en el rol de copias de seguridad se calcula por muchos a√±os. Siempre puede colocar una bater√≠a con una capacidad mayor, establecer el l√≠mite de descarga m√°s suave y a√∫n as√≠ obtener una mejor relaci√≥n precio / capacidad que la bater√≠a "correcta",sufriendo una descarga profunda.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo principal en este asunto es proporcionar ventilaci√≥n al menos en el nivel de "agujero en la pared" en el lugar de instalaci√≥n de las bater√≠as. </font><font style="vertical-align: inherit;">Bueno, para organizar una protecci√≥n de cortocircuito banal, porque el bajo voltaje de la fuente de corriente aten√∫a la vigilancia y todo puede terminar muy mal.</font></font><br>
<br>
<h3><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Guerra actual</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en un solo apartamento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de cierta tranquilidad moral causada por la decisi√≥n final sobre el tipo de bater√≠a, una nueva raz√≥n inmediatamente pareci√≥ pensar cuidadosamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perm√≠tanme recordarles que inicialmente quer√≠a obtener un generador de corriente alterna para 230 V. Sin embargo, despu√©s de reconciliarme con la realidad objetiva y cambiar mentalmente a las bater√≠as, la inercia del pensamiento ya me llev√≥ al conocido mercado en l√≠nea chino para elegir un convertidor de CC a CA adecuado. Y en el proceso de estudiar las caracter√≠sticas, el t√©rmino "onda sinusoidal modificada", que se olvid√≥, surgi√≥ por primera vez, y luego el sentido com√∫n comenz√≥ a generar preguntas inc√≥modas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La esencia de las preguntas fue la siguiente. Para cubrir todas las necesidades de energ√≠a del apartamento con una bater√≠a peque√±a todav√≠a no funcionar√°. Las calderas, un microondas, una lavadora y una potente computadora de escritorio seguir√°n siendo insoportables. Y el refrigerador, la campana e incluso el ventilador banal no podr√°n funcionar correctamente debido a esta onda sinusoidal muy modificada. Por supuesto, hay inversores con una verdadera onda sinusoidal, pero no solo son m√°s caros, sino tambi√©n menos eficientes. Y el problema de los consumidores poderosos a√∫n no est√° resuelto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© consumidores quedan dentro del presupuesto? No hay tantos: electr√≥nica de consumo como computadoras port√°tiles y tel√©fonos / tabletas, un enrutador, un servidor ARM, el ambiente es un televisor y, por supuesto, la iluminaci√≥n. Adem√°s, el mensaje inicial del art√≠culo (y mi motivaci√≥n personal) es precisamente garantizar el funcionamiento de la estaci√≥n de trabajo de respaldo en forma de computadora port√°til y la m√≠nima comodidad del hogar, como la luz en el inodoro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Casi todos estos dispositivos requieren un voltaje constante de 5 a 21 V para su funcionamiento y no hay necesidad objetiva de aumentar primero el voltaje de la bater√≠a a 230 V CA, luego bajarlo y enderezarlo nuevamente a m√°s o menos el nivel inicial. En estas transformaciones, es f√°cil perder hasta un 50% de energ√≠a, lo que no sonre√≠ en absoluto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En resumen, as√≠ de f√°cil fue la idea de utilizar una red de corriente continua de bajo voltaje como alternativa. </font><font style="vertical-align: inherit;">Y despu√©s de un c√°lculo aproximado de las p√©rdidas en los cables, los 12 (13.8) V iniciales se convirtieron en 24 (27.6) V m√°s pr√°cticos.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al principio quer√≠a tomar incluso 36 (41.4) B, pero despu√©s de estudiar las caracter√≠sticas de algunos componentes electr√≥nicos que planeaba usar para trabajar con toda esta econom√≠a, tuve que moderar mi apetito.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, en un cableado alternativo con una secci√≥n transversal de 3.5 mm </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 de</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cobre puro, el voltaje se aplic√≥ finalmente desde dos bater√≠as de autom√≥vil conectadas en serie.</font></font><br>
<br>
<blockquote>,        .           (   )   .                ,      .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para permitir a los consumidores en las habitaciones, se agreg√≥ una salida m√°s a cada bloque "grande" de salidas. Y para que nadie confunda una toma de corriente ordinaria con una de respaldo, los productos de tipo "americano" con contactos planos de diferentes anchos se instalaron como este √∫ltimo. Esto, en primer lugar, no permitir√° que la aspiradora se conecte a la red de CC, y en segundo lugar, tal toma de corriente, a diferencia de la europea, siempre usa la misma polaridad cuando se usa el enchufe "correcto".</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bl/sm/th/blsmthnmtxqcekbdftv8dfg3u2a.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para estos tomacorrientes se hicieron adaptadores para laptop, reduciendo el voltaje a los 18-20 V deseados y equipados con los conectores correspondientes. </font><font style="vertical-align: inherit;">Est√° claro que los talones se hicieron con las habituales cargas USB de cinco voltios para cada peque√±a cosa. </font><font style="vertical-align: inherit;">Bueno, por si acaso, se compr√≥ un par de peque√±os convertidores de 24/230 V, con una potencia de 50 y 200 vatios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se ordenaron a China cajas para cargar con un enchufe estadounidense, los mismos cables de alimentaci√≥n y placas de convertidores de pulso prefabricadas. </font><font style="vertical-align: inherit;">Solo se necesitaba un soldador para conectar los cables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No hablar√© sobre la planta de energ√≠a en este art√≠culo, especialmente porque no hay nada interesante en √©l, por lo que ir√© directamente a uno de los problemas "inferiores", a saber, el problema de utilizar la energ√≠a almacenada en la bater√≠a para fines de iluminaci√≥n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encendiendo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, al cablear el apartamento en paralelo con el cableado principal, se extrajeron los cables de una red de CC alternativa con un voltaje de 24 (27,6) V. Entre otras cosas, se enrosc√≥ un bucle que consta de un par de dichos cables en cada caja de interruptores y luego junto con los cables de red de 230 V condujo a las luces del techo (si hab√≠a varias en la habitaci√≥n, entonces el cable alternativo conduc√≠a a una sola).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu√© hacer con la salida de la red DC en el campo de la l√°mpara es una cuesti√≥n de enfoque individual. Como fuente de luz, se eligi√≥ una tira LED regular de 24 voltios. Sus segmentos de diferentes longitudes (en proporci√≥n al √°rea de la habitaci√≥n), dependiendo del dise√±o de los accesorios, se montaron directamente en sus alojamientos o se pegaron a esas superficies desde las que brillar√≠a bien, y desde donde no ser√≠a muy llamativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cualquier caso, este es un problema m√°s est√©tico que t√©cnico, y ahora es otra cosa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, en la caja de cada interruptor, tengo un bucle de un cable de fase de una red de 230 V para encender la luz "ordinaria" y un bucle de ambos cables de una red de CC para iluminaci√≥n de emergencia. De esto y baile.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final, el desaf√≠o que ten√≠a ante m√≠ era crear un cierto dispositivo que pudiera separar tres estados entre s√≠:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AC AC OK ‚Üí apague las luces de emergencia.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La red de CA est√° desenergizada, los contactos del interruptor est√°n cerrados ‚Üí encienda la luz de emergencia. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La red de CA est√° desenergizada, los contactos del interruptor est√°n abiertos ‚Üí apague la luz de emergencia.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consideramos que las acciones son unilaterales, es decir, apagar la iluminaci√≥n ya apagada simplemente no cambia nada. </font><font style="vertical-align: inherit;">Estos estados se pueden distinguir entre s√≠ si se resuelven las tareas de determinar el funcionamiento de la red de CA y la posici√≥n de los contactos del conmutador. </font><font style="vertical-align: inherit;">Al mismo tiempo, tuve las siguientes condiciones iniciales:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La gesti√≥n de la iluminaci√≥n principal y de emergencia debe ser completamente transparente de un √≥rgano rector, no "granja colectiva" de los botones adicionales.</font></font></li>
<li> ,  ,   ,        .</li>
<li>      ,        .</li>
<li>      ‚Äì    ,  .</li>
<li>-        .</li>
<li>        (    ),  .</li>
<li>      .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, la ausencia de la red el√©ctrica de CA en las casillas cero result√≥ ser un c√°lculo de dise√±o muy complicado. </font><font style="vertical-align: inherit;">Sin ella, la determinaci√≥n de la presencia de voltaje en la entrada del interruptor se vuelve imposible. </font><font style="vertical-align: inherit;">T√©cnicamente, ser√≠a posible utilizar el cable negativo de una red de corriente continua como cero, pero esto contradice el p√°rrafo 5 completamente indestructible de mis t√©rminos de referencia.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, existe una alternativa para medir la tensi√≥n de red. No es necesario para m√≠ determinar la presencia de voltaje, es suficiente determinar la presencia de corriente en el cable de fase con los contactos del interruptor cerrados. Despu√©s de todo, si hay corriente, entonces hay voltaje. Adem√°s, la "lectura" precisa de la corriente permite que se active la iluminaci√≥n de emergencia no solo en el caso de una falla de energ√≠a, sino tambi√©n en el caso de una quemadura de bulbo banal. Este m√©todo no permite determinar el estado de la red de CA cuando el interruptor est√° apagado, pero este estado no me molesta, porque una vez que el interruptor est√° apagado, la iluminaci√≥n de emergencia tampoco deber√≠a funcionar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Determinar la presencia de corriente en el cable es bastante simple, especialmente si esta corriente es alterna. </font><font style="vertical-align: inherit;">Aqu√≠ puede aplicar, por ejemplo, un sensor Hall que detecta el campo magn√©tico alrededor del cable. </font><font style="vertical-align: inherit;">Pero puede sobrevivir con un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transformador de corriente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com√∫n </font><font style="vertical-align: inherit;">, que consiste en un circuito magn√©tico en anillo con un devanado. </font><font style="vertical-align: inherit;">Se pasa un cable de corriente alterna a trav√©s del anillo, lo que crea un campo magn√©tico en el circuito magn√©tico. </font><font style="vertical-align: inherit;">Este campo a su vez induce una corriente secundaria en el devanado, proporcional a la corriente primaria en el cable. </font><font style="vertical-align: inherit;">Por lo tanto, este dispositivo simple le permite medir la fuerza de la corriente alterna en cualquier cable, sin romperlo y generalmente sin ninguna conexi√≥n galv√°nica con el circuito primario.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El trabajo de las pinzas de corriente, una herramienta muy √∫til para cualquier electricista, se basa en el mismo principio.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si hay un transformador de este tipo cerca del interruptor, es suficiente medir el voltaje en su devanado secundario para averiguar si fluye corriente en el circuito de la l√°mpara. La presencia de corriente, como dije, en una primera aproximaci√≥n indica dos hechos: hay un voltaje en la red de 230 V, y el interruptor est√° cerrado. El primero de estos hechos es esencial para el funcionamiento del dispositivo de activaci√≥n de iluminaci√≥n de emergencia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El segundo "par√°metro de entrada" de mi dispositivo futuro deber√≠a ser la posici√≥n de los contactos del interruptor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La "lluvia de ideas" iniciada entre colegas aficionados trajo varias opciones para determinar la posici√≥n del interruptor, que se redujo principalmente a modificar el dise√±o para agregarle otro par de contactos. Aqu√≠ el alcance de la imaginaci√≥n es bastante grande.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Era posible tomar un doble en lugar de un solo interruptor y "paralelizar" mec√°nicamente sus mitades para que se convirtieran en un todo √∫nico. Esta opci√≥n no difiri√≥ en la est√©tica externa y no resolvi√≥ el problema en aquellas habitaciones donde la iluminaci√≥n era de doble circuito y el interruptor era doble inicialmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otras opciones involucraban la introducci√≥n de un micro interruptor o un interruptor de l√°minas con un im√°n en el mecanismo del interruptor. Pero despu√©s de estudiar los dise√±os de los interruptores autom√°ticos aplicados, estas opciones tambi√©n desaparecieron. La base de cer√°mica monol√≠tica de un buen interruptor simplemente no deja ninguna posibilidad, incluso para un microinterruptor compacto, y el im√°n y el interruptor de l√°minas no funcionaron debido al golpe demasiado peque√±o de la tecla y la hist√©resis en la curva de operaci√≥n / liberaci√≥n del interruptor de l√°minas.</font></font><br>
<br>
<blockquote> ¬´¬ª        ,     . , ,       ,  .  ,   ,    ,               .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En resumen, era necesario idear un m√©todo que no requiriera modificaci√≥n del interruptor. Y este m√©todo fue encontrado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arriba, describ√≠ un transformador de corriente, que le permite determinar la presencia de corriente alterna en un cable sin ruptura y contacto galv√°nico. Pero cualquier transformador es un dispositivo bidireccional (en contraste con el mismo sensor Hall), sus devanados primario y secundario son intercambiables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si aplicamos corriente alterna al devanado secundario de dicho transformador, induce voltaje en los extremos del cable enroscado en el anillo. Y, lo m√°s importante, la energ√≠a consumida por el devanado de la fuente depender√° de si la corriente secundaria en el cable encuentra su camino para el movimiento circular.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aqu√≠ se vuelve m√°s interesante. </font><font style="vertical-align: inherit;">Un cable pasa a trav√©s del anillo, que se conecta inmediatamente, en pocos cent√≠metros, a uno de los contactos del interruptor. </font><font style="vertical-align: inherit;">Solo queda proporcionar esta corriente con una ruta de retorno desde el otro lado del interruptor para obtener un dispositivo para "detectar" la posici√≥n de los contactos. </font><font style="vertical-align: inherit;">Y por la raz√≥n de que esta corriente alterna, un condensador convencional puede convertirse en un puente para ello.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gs/tr/g1/gstrg12mwdwhgu0qmbnl3twrfjc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En principio, para cerrar este circuito bajo ciertas condiciones, no se necesita un condensador. </font><font style="vertical-align: inherit;">Si se bombea una corriente de una frecuencia suficientemente alta al transformador, entonces la capacitancia par√°sita entre los cables ser√° suficiente para pasar.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/up/yp/ws/upypwscprb9xjbrlaye26xfkry8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, lo que se necesita para organizar dicho detector:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transformador de corriente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Medidor de voltaje de salida del transformador.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuente de corriente alterna de alta frecuencia.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Medidor de corriente que fluye a trav√©s del devanado de un transformador invertido.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo m√°s dif√≠cil en t√©rminos de selecci√≥n de los par√°metros √≥ptimos es un transformador, que en el modo de transformador de corriente deber√≠a dar un voltaje aceptable con una frecuencia de 50 Hz, y en el modo de "detecci√≥n" activa del estado del interruptor de circuito, tener un coeficiente de transmisi√≥n aceptable a una frecuencia de cientos de KHz. </font><font style="vertical-align: inherit;">Este elemento no es posible simular en un programa para modelar circuitos electr√≥nicos, e incluso con el c√°lculo matem√°tico todo result√≥ muy dif√≠cil. </font><font style="vertical-align: inherit;">Tuve que tomar un soldador en mis manos y pasar horas manejando varias opciones en busca de lo mejor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El n√∫mero de vueltas y la resistencia de carga √≥ptima se seleccionaron emp√≠ricamente y no el hecho de que no perd√≠ la mejor relaci√≥n. </font><font style="vertical-align: inherit;">Como resultado de los experimentos, apareci√≥ la siguiente construcci√≥n:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√∫cleo de ferrita con una permeabilidad de 10,000, tama√±o 10x6x4 mm.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bobinado de 30 vueltas con alambre esmaltado de 0.25 mm.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La carga activa del devanado es de 1 kOhm.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La permeabilidad magn√©tica es bastante grande, probablemente, tendr√≠a sentido usar un anillo para 5000 o incluso 2000 unidades, pero en cantidades suficientes tuve estos anillos. </font><font style="vertical-align: inherit;">En general, la permeabilidad en este caso es un valor de compromiso. </font><font style="vertical-align: inherit;">Demasiado bajo hace que el transformador no sea apto para funcionar a una frecuencia de 50 Hz, y demasiado alto estropea todo a frecuencias superiores a cientos de kilohercios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√∫ltiples experimentos confirmaron la realidad de la idea y se obtuvieron los siguientes resultados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el modo de transformador de corriente, el coeficiente de transmisi√≥n result√≥ ser de aproximadamente un milivoltio por vatio de potencia de flujo (voltaje 220-230 V).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el modo de sonda, dependiendo de la frecuencia y la capacidad de la fuga, la diferencia de corriente con los contactos cerrados y abiertos del interruptor alcanz√≥ dos o tres veces.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es todo. </font><font style="vertical-align: inherit;">Ambos valores son m√°s que suficientes para una fijaci√≥n confiable tanto de la corriente que fluye como para determinar la posici√≥n de los contactos del interruptor. </font><font style="vertical-align: inherit;">Solo depende de la implementaci√≥n espec√≠fica.</font></font><br>
<br>
<a name="Solution"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En hierro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A diferencia de la mayor√≠a de sus otros dise√±os, aqu√≠ ya en las primeras etapas de deliberaci√≥n, se decidi√≥ utilizar inmediatamente el microcontrolador. </font><font style="vertical-align: inherit;">Seg√∫n las necesidades y la experiencia, la elecci√≥n recay√≥ en el ATtiny13A. </font><font style="vertical-align: inherit;">Este chip tiene un ADC y tiene la capacidad de utilizar una fuente de referencia interna de 1.1 V en lugar del voltaje de alimentaci√≥n. </font><font style="vertical-align: inherit;">Hay un PWM que es excelente para generar una se√±al de sonido. </font><font style="vertical-align: inherit;">Y, que luego result√≥ ser importante, hay una EEPROM que le permite almacenar datos de calibraci√≥n.</font></font><br>
<br>
<blockquote>,          ¬´  ,       ,       - ¬´¬ª ,  ¬ª.<br>
<br>
      .         .           .   ,   ,  ,         .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ debe combinar al menos un generador, un medidor de voltaje y alg√∫n tipo de disparador para almacenar el estado actual entre mediciones. En general, cualquier bosquejo especulativo requer√≠a al menos tres casos solo en el "n√∫cleo", y el controlador result√≥ ser mucho m√°s pr√°ctico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El voltaje del transformador de corriente con una carga de 10-20 W es de 10-20 mV y es demasiado peque√±o para suministrarlo a la entrada DAC con un l√≠mite de incluso 1.1 V. Por lo tanto, adem√°s del controlador, tambi√©n necesita un amplificador con un coeficiente de transferencia de aproximadamente 100 para aumentar el voltaje de la se√±al al menos hasta cientos de milivoltios.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En general, el voltaje de la se√±al de salida de un transformador de corriente depende no solo de la potencia de carga, sino tambi√©n de su naturaleza. </font><font style="vertical-align: inherit;">Una carga puramente activa como la bombilla de Ilyich, por ejemplo, produce una onda sinusoidal de nivel de milivoltios. </font><font style="vertical-align: inherit;">Una bombilla LED de la misma potencia con una potencia de pulso simple produce r√°fagas cortas a voltios y m√°s. </font><font style="vertical-align: inherit;">Podr√≠amos jugar con esto, pero, en primer lugar, quer√≠a hacer un dispositivo universal, y en segundo lugar, en el apartamento hab√≠a una l√°mpara con una fuente de alimentaci√≥n externa equipada con un circuito PFC (es decir, una caracter√≠stica de consumo cercana a activa).</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No atormentar√© al lector con opciones intermedias e inmediatamente dar√© el diagrama final del dispositivo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vd/at/a-/vdata-spt78rd_pzv7s5awoobya.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ el voltaje de CC a trav√©s del regulador lineal econ√≥mico LM2931-5.0 alimenta al controlador. En t√©rminos de carcasa, funcionalidad y distribuci√≥n de pines, este estabilizador es similar al popular 78L05, pero difiere de √©l en un menor consumo interno (aproximadamente 500 ŒºA con una carga de 10 mA) y una mayor tolerancia a breves r√°fagas de voltaje de entrada. Si planea trabajar con un voltaje de no m√°s de 20 V, puede usar un an√°logo a√∫n m√°s econ√≥mico de LP2950-5.0.</font></font><br>
<br>
<blockquote>   LP2950-5.0        30 .      24      .    -      ,     ,       ,     ,   .          50%,   100%.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El transformador no se muestra en el diagrama, pero su devanado est√° conectado a los pines TR1 y TR2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como elemento clave para cambiar la carga, se usa un transistor MOS de canal P de baja corriente 2SJ196 (una corriente de hasta 1 A deber√≠a ser suficiente para cualquier l√°mpara LED), pero se puede usar cualquier otra adecuada para la distribuci√≥n de pines, corriente m√°xima y voltaje de drenaje m√°ximo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s del controlador y la clave de los elementos activos, se utilizan dos transistores. Se necesita uno para controlar el obturador de la llave, que funciona bajo el voltaje de la fuente de emergencia. El segundo act√∫a como una se√±al de amplificador desde la salida del transformador de corriente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este punto, podr√≠a usar amplificadores operacionales, pero en t√©rminos de detalles la ganancia fue m√≠nima, y ‚Äã‚Äãtendr√≠a que olvidarse de trabajar en frecuencias superiores a varios cientos de kilohercios.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No es la se√±al amplificada del propio transformador la que se alimenta al ADC, sino su envolvente, que se puede medir con una sola muestra, y no con la digitalizaci√≥n de "transmisi√≥n" durante alg√∫n tiempo. Para aislar la envoltura, se utilizan dos diodos Schottky, conectados de acuerdo con el circuito de duplicaci√≥n de voltaje. Tal inclusi√≥n forma un detector de amplitud cl√°sico, en el que la ca√≠da de voltaje a trav√©s de los diodos se compensa en gran medida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El principio de funcionamiento del sensor es simple. Primero, considere el algoritmo de acciones necesarias para medir la corriente en el cable.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el modo de medici√≥n actual, el pin PB0 se pone en modo de salida y est√° conectado a tierra por un cero l√≥gico. Esto evita que se env√≠en se√±ales del controlador al punto TR1. En paralelo, se realizan las mismas acciones en el pin PB3, como resultado de lo cual la salida superior del condensador C2 est√° conectada a tierra. Este condensador junto con la resistencia R1 crea un filtro de paso bajo con una frecuencia de corte de aproximadamente 1500 Hz. Gracias a este filtro, el papel de varios ruidos de alta frecuencia en la formaci√≥n de la se√±al medida se reduce considerablemente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego se aplica un nivel alto a PB4 para alimentar el amplificador de se√±al. Despu√©s de completar los transitorios, se amplifica una corriente de 50 Hz desde la salida del transformador y llega al rectificador, donde carga el condensador C8.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La carga del condensador C8 se mide usando ADC1 y del valor de voltaje obtenido se saca una conclusi√≥n sobre la corriente "primaria" que fluye a trav√©s del transformador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La detecci√≥n activa se realiza de manera diferente. Primero, el pin PB0 se traduce en un solucionador PWM, y se le aplica una se√±al con una frecuencia de cientos de kilohercios a unidades de megahercios. Esta se√±al es algo atenuada por un divisor resistivo y alimentada al devanado del transformador de corriente en el punto TR1. El condensador C1, junto con un brazo superior del divisor R4, crea un filtro de paso bajo con una frecuencia de corte de aproximadamente 1,5 MHz, que reduce el nivel de arm√≥nicos de alta frecuencia de los pulsos rectangulares.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de pasar por el devanado del transformador, la se√±al de sondeo del punto TR2 llega al mismo amplificador y detector, del mismo modo al final cargando el condensador C8 a un voltaje proporcional a la carga en el circuito del transformador "externo". Del mismo modo, la carga del condensador se mide utilizando el ADC del microcontrolador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora explicaciones para algunos "flojos". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La resistencia R5 est√° dise√±ada para limitar el voltaje en la puerta del interruptor de alimentaci√≥n, que para MOSFET de bajo voltaje generalmente no debe exceder los 20 V.En mi caso, la red de CC tiene un voltaje de hasta 30 V, lo que determin√≥ la necesidad de un divisor 1: 3, que se obtiene junto con R3. Cuando se alimenta desde una fuente de menos de 20 V, no se necesita la resistencia R5 (reemplazada por un puente).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los condensadores C4 y C5 est√°n conectados en paralelo para lograr una capacitancia de 2 ŒºF. Este par de condensadores es notable porque debe transmitir se√±ales de frecuencias bajas y altas igualmente bien. Aqu√≠ ser√≠a posible utilizar una conexi√≥n paralela de un condensador electrol√≠tico de varios microfaradios y una cer√°mica de cien o dos nanofaradios, pero un "electrolito" de tan peque√±a capacidad no proporciona una ganancia de tama√±o en comparaci√≥n con las "cer√°micas" de microfaradios. Es cierto que no era posible comprar un condensador de cer√°mica a 2 microfaradios, as√≠ que puse dos de ellos iguales.</font></font><br>
<br>
<blockquote>,   50     2  ,      .   ,        .               .    100   , ,   .       .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las resistencias R4 y R1 forman una divisi√≥n de voltaje, que iguala m√°s o menos el voltaje alterno de cinco voltios en la salida PWM con el voltaje de salida del transformador de corriente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El condensador C8, como se mencion√≥ anteriormente, acumula el voltaje a medir. Es mejor si es un condensador de alta calidad con una corriente de fuga m√≠nima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menci√≥n especial merece el "peine" TP1 / TP2 de dos pines conectado a la pata de reinicio del microcontrolador. Estos contactos se utilizan no solo para reiniciar, sino tambi√©n para ingresar al modo de calibraci√≥n, que se describe a continuaci√≥n. Simplemente, despu√©s de la implementaci√≥n de toda la lista de deseos, el controlador ya no ten√≠a pines libres, y la necesidad de agregar un control simple apareci√≥ durante la depuraci√≥n del firmware. As√≠ que tuve que usar el pie de reinicio del controlador para este prop√≥sito.</font></font><br>
<br>
<blockquote> ¬´¬ª  AVR     RESET       GPIO.         ,       .         ,        .   ,        ,      ,      ,            RESET.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, el circuito result√≥ ser bastante simple, y toda la "magia" se implementa en el firmware del microcontrolador. Sin embargo, despu√©s de la fabricaci√≥n del prototipo, result√≥ que la capacidad de cableado para el funcionamiento confiable de la "sonda" a menudo no es suficiente. La diferencia en la corriente a trav√©s del transformador simplemente resulta comparable con el nivel de interferencia y el funcionamiento del circuito no es confiable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, tuve que abandonar el anillo de ferrita que colgaba libremente de los cables y agregar un circuito de alto voltaje directamente a la placa en una nueva revisi√≥n del dispositivo, para facilitar la tarea de sondeo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El punto aqu√≠ es agregar un condensador dedicado, encendido para que la forma m√°s corta de cerrar la ruta a la corriente de RF a trav√©s de los contactos del interruptor.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/i-/_f/63/i-_f636miltufzwifkx4xaxnab0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El capacitor C10 debe estar dise√±ado para un voltaje de al menos kilovoltios, y su capacitancia debe elegirse de acuerdo con un principio de compromiso para que la confiabilidad de la operaci√≥n sea suficiente para el uso pr√°ctico y que la corriente capacitiva par√°sita a trav√©s de la l√°mpara no sea demasiado grande. </font><font style="vertical-align: inherit;">En la pr√°ctica, puede intentar "jugar" con esta denominaci√≥n, si es necesario.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En cualquier caso, un interruptor equipado con dicho sensor ya no se puede percibir como ideal. </font><font style="vertical-align: inherit;">M√°s bien, es similar a un interruptor con un indicador, por lo tanto, en primer lugar, puede causar luz par√°sita o parpadeo de l√°mparas LED de baja calidad, y en segundo lugar, puede causar una descarga el√©ctrica, aunque no es fuerte. </font><font style="vertical-align: inherit;">Por lo tanto, nunca necesita trabajar con cableado de iluminaci√≥n, confiando solo en el interruptor en la pared, siempre apague el "interruptor" en la entrada.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y, dado que todav√≠a ten√≠a que agregar parte de la red de CA a la placa, agregu√© dos interruptores de desconexi√≥n all√≠, lo que no permitir√° que la corriente de prueba de alta frecuencia pase al cableado. El valor pr√°ctico de la frecuencia del voltaje de sondeo puede alcanzar varios MHz y yo, como radioaficionado, estoy harto de la idea de aumentar la cantidad de interferencia en la red con mis propias manos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los cebadores L1 y L2 deben ser el√©ctricos, enrollados con un cable de grosor notable en los n√∫cleos de tipo mancuernas o anillos. No se pueden utilizar los choques de se√±al en el dise√±o axial de "resistencia". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El giro principal del transformador de corriente ahora es un trozo de cable enhebrado a trav√©s del anillo y soldado a los puntos TR3 y TR4 en el tablero. Es mejor si este cable est√° blindado, mientras conecta la pantalla a TR5 y TR6 en ambos lados del anillo.</font></font><br>
<br>
<blockquote> TR6       ,   .    -   ,           .          ,          .</blockquote><br>
<h3></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo de firmware y el archivo HEX ensamblado se adjuntan al final del art√≠culo junto con el circuito y el dise√±o de la placa de circuito impreso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El algoritmo del detector sintonizado es simple. Una vez cada tres segundos, el controlador se despierta del sue√±o profundo, toma medidas y, si es necesario, cambia el estado de la tecla de control en una direcci√≥n u otra. Por lo tanto, la reacci√≥n a un cambio en la posici√≥n del interruptor puede tener un retraso de hasta tres segundos. No es muy conveniente, pero esto se hace, en primer lugar, para ahorrar energ√≠a de la fuente de respaldo y, en segundo lugar, para reducir significativamente el intervalo de sondeo no permite la duraci√≥n de los transitorios en diferentes etapas de medici√≥n. El intervalo m√≠nimo puede considerarse igual a un segundo, pero el circuito estar√° en modo de consumo activo casi todo el tiempo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, en conclusi√≥n, sobre la configuraci√≥n. Debido al hecho de que diferentes sensores tienen que funcionar en condiciones completamente diferentes de acuerdo con la corriente consumida por la l√°mpara, la longitud y otras caracter√≠sticas de cableado, el nivel de interferencia y similares, fue imposible colocar un conjunto universal de par√°metros adaptativos en el firmware. Por lo tanto, cada sensor despu√©s de la instalaci√≥n requiere una sola calibraci√≥n en el sitio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El sensor ingresa al modo de calibraci√≥n cada vez que se enciende, mientras no hay datos de calibraci√≥n, o despu√©s de cerrar los contactos TP1 y TP2. La entrada en la primera etapa de calibraci√≥n se indica mediante una l√°mpara de emergencia que parpadea cinco veces.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de parpadear cinco veces, se dan 7,5 segundos para colocar el interruptor en la posici√≥n "apagado", si se encendi√≥ antes. Despu√©s de este tiempo, se mide el nivel de interferencia siempre presente en la red de CA. El valor obtenido se utiliza como punto de partida para mediciones en el ciclo de trabajo. Tambi√©n en este momento, el disyuntor se detecta a diferentes frecuencias para la posterior selecci√≥n de la frecuencia m√°s "de contraste".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, comienza la segunda etapa de calibraci√≥n y la l√°mpara de emergencia parpadea dos veces. Se dan 7,5 segundos de tiempo para cambiar el interruptor a la posici√≥n "encendido" y, despu√©s del tiempo de espera, el programa mide la corriente consumida por la l√°mpara. Si la l√°mpara tiene varios niveles de brillo, luego de encenderla, debe cambiarla inmediatamente al m√≠nimo, para que en el futuro el sensor funcione correctamente con cualquiera de los niveles disponibles.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El comienzo de la tercera y √∫ltima etapa de calibraci√≥n est√° marcado por un parpadeo de tres veces de la l√°mpara de emergencia y requiere que el interruptor permanezca en el modo "encendido", y que la red de iluminaci√≥n se desenergice a un nivel m√°s alto (es decir, con el disyuntor principal o secundario en el panel) a m√°s tardar a trav√©s de los mismos 7.5 segundos En este caso, se realiza un segundo sonido del interruptor autom√°tico ya activado a diferentes frecuencias y teniendo en cuenta los valores obtenidos en la primera etapa, se selecciona la frecuencia en la que la diferencia de corriente a trav√©s del interruptor de encendido y apagado es m√°xima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La finalizaci√≥n exitosa de la calibraci√≥n se indica mediante un solo parpadeo de la l√°mpara de emergencia y, si la red de iluminaci√≥n despu√©s de la tercera etapa a√∫n est√° desenergizada, encendiendo la iluminaci√≥n de emergencia en el siguiente ciclo de operaci√≥n de sondeo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si los valores medidos de corrientes y resistencias en diferentes condiciones est√°n demasiado cerca y no pueden usarse para una detecci√≥n confiable, la calibraci√≥n falla. </font><font style="vertical-align: inherit;">En este caso, la l√°mpara de iluminaci√≥n de emergencia parpadea dos veces cuando la posici√≥n del interruptor no tiene √©xito, o tres veces cuando el consumo de la l√°mpara de iluminaci√≥n est√°ndar es demasiado bajo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En caso de falta de voluntad persistente del sensor para calibrar con un parpadeo doble en la final, debe intentar aumentar la capacidad de C10.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El dispositivo result√≥ ser bastante simple, lo suficientemente compacto como para caber en una caja de interruptores, pero no quiere decir que sea muy f√°cil de configurar. </font><font style="vertical-align: inherit;">Por supuesto, no se basa en el componente de una "casa inteligente" moderna, porque no tiene 5G, control en la nube e incluso no se proporciona WiFi banal con GPS. </font><font style="vertical-align: inherit;">Sin embargo, ocho de estos dispositivos realizan su √∫nica funci√≥n, y no se requiere nada m√°s de ellos en condiciones de apag√≥n.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo fuente del firmware (Atmel Studio 7)</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> F_CPU 9600000 <span class="hljs-comment">//   (  : avrdude.exe -U lfuse:w:0x7a:m -U hfuse:w:0xff:m)</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/io.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/wdt.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/sleep.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/interrupt.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;util/delay.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/eeprom.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-comment">//#define PROTEUS</span><font></font>
<font></font>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-keyword">bool</span>; <span class="hljs-comment">//   </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> true  (0 == 0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> false (0 != 0)</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX_U10BIT 0b0000001111111111 <span class="hljs-comment">//      </span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> INTERVAL         3   <span class="hljs-comment">//  , </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CUR_MINIMAL_DIFF 50  <span class="hljs-comment">//      , LSB</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> RES_MINIMAL_DIFF 50  <span class="hljs-comment">//      , LSB</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FREQ_DIV_OFFSET  2   <span class="hljs-comment">//     </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> FREQ_MAXIMAL_DIV 6   <span class="hljs-comment">//     </span></span><font></font>
<font></font>
EEMEM <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>  EEPROM_cur_edge;<font></font>
EEMEM <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>  EEPROM_res_edge; <font></font>
EEMEM <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> EEPROM_frequency_dividor;<font></font>
<font></font>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cur_edge, res_edge; <span class="hljs-comment">//   ,   EEPROM    </span>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> frequency_dividor; <span class="hljs-comment">//   ,   EEPROM    </span>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> clk = <span class="hljs-number">0</span>; <span class="hljs-comment">//   watchdog</span>
<span class="hljs-keyword">bool</span> tp_reset = <span class="hljs-literal">false</span>; <span class="hljs-comment">//   TP1  TP2</span><font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init_vars</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">if</span>(MCUSR &amp; (<span class="hljs-number">1</span> &lt;&lt; EXTRF)) { <span class="hljs-comment">// ,       TP1  TP2</span>
    tp_reset = <span class="hljs-literal">true</span>;<font></font>
    MCUSR &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; EXTRF); <span class="hljs-comment">//  EXTRF       ,   </span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init_pins</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  DDRB |= (<span class="hljs-number">1</span> &lt;&lt; PB0) | (<span class="hljs-number">1</span> &lt;&lt; PB1) | (<span class="hljs-number">1</span> &lt;&lt; PB2) | (<span class="hljs-number">1</span> &lt;&lt; PB4); <span class="hljs-comment">//       </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    watchdog</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init_interrupts</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  sleep_enable(); <span class="hljs-comment">//   </span><font></font>
<font></font>
  WDTCR = (<span class="hljs-number">1</span> &lt;&lt; WDCE) | (<span class="hljs-number">1</span> &lt;&lt; WDE); <span class="hljs-comment">//  watchdog</span>
  WDTCR = (<span class="hljs-number">1</span> &lt;&lt; WDTIE) | WDTO_1S; <span class="hljs-comment">// watchdog      ,  1 </span><font></font>
<font></font>
  sei(); <span class="hljs-comment">//  </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">init_settings</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  cur_edge = eeprom_read_word(&amp;EEPROM_cur_edge); <span class="hljs-comment">//   </span>
  res_edge = eeprom_read_word(&amp;EEPROM_res_edge); <span class="hljs-comment">//   </span>
  frequency_dividor = eeprom_read_byte(&amp;EEPROM_frequency_dividor); <span class="hljs-comment">//   </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_load</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    PORTB |= (<span class="hljs-number">1</span> &lt;&lt; PB1);<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    PORTB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB1);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">blink_load</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> count)</span> </span>{
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {<font></font>
    _delay_ms(<span class="hljs-number">200</span>);<font></font>
    toggle_load(<span class="hljs-literal">true</span>);<font></font>
    _delay_ms(<span class="hljs-number">200</span>);<font></font>
    toggle_load(<span class="hljs-literal">false</span>);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   (   )</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  set_sleep_mode(SLEEP_MODE_PWR_DOWN);<font></font>
  <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) sleep_cpu();<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_amp</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    PORTB |= (<span class="hljs-number">1</span> &lt;&lt; PB4); <span class="hljs-comment">//     PB4</span>
    _delay_ms(<span class="hljs-number">250</span>);      <span class="hljs-comment">//       200 .</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    PORTB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB4);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_lpf</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    DDRB |= (<span class="hljs-number">1</span> &lt;&lt; PB3); <span class="hljs-comment">//  PB3    (  "0")     C2</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    DDRB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB3); <span class="hljs-comment">//  PB3    ( )   C2  </span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_gen</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    TCCR0A |= (<span class="hljs-number">1</span> &lt;&lt; COM0A0) | (<span class="hljs-number">1</span> &lt;&lt; WGM01); <span class="hljs-comment">//    ( )    OC0A      OCR0A</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> PROTEUS</span>
    TCCR0B |= (<span class="hljs-number">1</span> &lt;&lt; CS00); <span class="hljs-comment">//    1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    TCCR0B |= (<span class="hljs-number">1</span> &lt;&lt; CS00) | (<span class="hljs-number">1</span> &lt;&lt; CS02); <span class="hljs-comment">//    1024</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
    OCR0A = FREQ_DIV_OFFSET + frequency_dividor; <span class="hljs-comment">//   ,         OC0A</span>
  } <span class="hljs-keyword">else</span> {<font></font>
    TCCR0A = <span class="hljs-number">0</span>; <span class="hljs-comment">//  </span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toggle_adc</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> state)</span> </span>{
  <span class="hljs-keyword">if</span>(state) {<font></font>
    DDRB &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; PB2); <span class="hljs-comment">//  PB2    ( )</span>
    ADMUX = <span class="hljs-number">0b01</span> | (<span class="hljs-number">1</span> &lt;&lt; REFS0); <span class="hljs-comment">// PB2, 1.1v reference</span>
    ADCSRA = (<span class="hljs-number">1</span> &lt;&lt; ADPS0) | (<span class="hljs-number">1</span> &lt;&lt; ADPS1) | (<span class="hljs-number">1</span> &lt;&lt; ADPS2) | <span class="hljs-comment">//       = 128 (75 )</span>
             (<span class="hljs-number">1</span> &lt;&lt; ADIE) |  <span class="hljs-comment">//    </span>
             (<span class="hljs-number">1</span> &lt;&lt; ADEN);   <span class="hljs-comment">//  </span>
  } <span class="hljs-keyword">else</span> {<font></font>
    ADCSRA = <span class="hljs-number">0</span>; <span class="hljs-comment">//  </span>
    DDRB |= (<span class="hljs-number">1</span> &lt;&lt; PB2); <span class="hljs-comment">//  PB2    (  "0")   C8</span>
    _delay_ms(<span class="hljs-number">50</span>); <span class="hljs-comment">//      C8</span><font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">do_adc</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  set_sleep_mode(SLEEP_MODE_ADC); <span class="hljs-comment">//   "" </span>
  <span class="hljs-keyword">do</span> {<font></font>
    sleep_cpu(); <span class="hljs-comment">//      ,      ,   </span>
  } <span class="hljs-keyword">while</span>(ADCSRA &amp; (<span class="hljs-number">1</span> &lt;&lt; ADSC)); <span class="hljs-comment">//        ,  </span><font></font>
<font></font>
  <span class="hljs-keyword">return</span> ADC;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">/*
//  
static void blink_bin(unsigned int value, unsigned char count) {
  for(unsigned char i = 0; i &lt; count; ++i) {
    _delay_ms(1000);
    toggle_load(true);
    if(value &amp; (1 &lt;&lt; (count - i - 1))) {
      _delay_ms(500);
    } else {
      _delay_ms(50);
    }
    toggle_load(false);
  }
}
*/</span><font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get_current</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cur;<font></font>
<font></font>
  toggle_lpf(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">150</span>);<font></font>
  toggle_adc(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">50</span>); <span class="hljs-comment">//    C8</span>
  cur = do_adc(); <span class="hljs-comment">//  </span>
  toggle_adc(<span class="hljs-literal">false</span>);<font></font>
  toggle_lpf(<span class="hljs-literal">false</span>);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> cur;<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get_resistance</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> res;<font></font>
<font></font>
  toggle_gen(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">150</span>);<font></font>
  toggle_adc(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span>
  _delay_ms(<span class="hljs-number">50</span>); <span class="hljs-comment">//    C8</span>
  toggle_gen(<span class="hljs-literal">false</span>); <span class="hljs-comment">//   ,   C8     </span>
  res = do_adc(); <span class="hljs-comment">//     </span>
  toggle_adc(<span class="hljs-literal">false</span>);<font></font>
<font></font>
  <span class="hljs-keyword">return</span> MAX_U10BIT - res; <span class="hljs-comment">//      ,      </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">is_current</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">return</span> (get_current() &gt;= cur_edge);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">is_toggled_on</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">return</span> (get_resistance() &lt;= res_edge);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">do_main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{<font></font>
  toggle_amp(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span><font></font>
<font></font>
  <span class="hljs-keyword">if</span>(is_current()) {<font></font>
    toggle_load(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  ,  </span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span>(is_toggled_on()) {<font></font>
      toggle_load(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  ,  </span>
    } <span class="hljs-keyword">else</span> {<font></font>
      toggle_load(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  ,  </span><font></font>
    }<font></font>
  }<font></font>
<font></font>
  toggle_amp(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  </span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">first_on</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">return</span> (frequency_dividor == <span class="hljs-number">0xff</span>); <span class="hljs-comment">//   EEPROM   0xFF,        FREQ_MAXIMAL_DIV</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//  </span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">calibrate</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cur_off, cur_on, res_off, res_on, res_on_tmp, res_off_array[FREQ_MAXIMAL_DIV + <span class="hljs-number">1</span>], diff, max_diff, frequency_dividor_tmp;<font></font>
<font></font>
  blink_load(<span class="hljs-number">5</span>); <span class="hljs-comment">//    ,    </span>
  _delay_ms(<span class="hljs-number">7500</span>); <span class="hljs-comment">//      </span><font></font>
<font></font>
  toggle_amp(<span class="hljs-literal">true</span>); <span class="hljs-comment">//  </span><font></font>
<font></font>
  cur_off = get_current(); <span class="hljs-comment">//      ( )</span><font></font>
<font></font>
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">for</span>(frequency_dividor = <span class="hljs-number">0</span>; frequency_dividor &lt;= FREQ_MAXIMAL_DIV; ++frequency_dividor) {<font></font>
    res_off_array[frequency_dividor] = get_resistance();<font></font>
  }<font></font>
<font></font>
  blink_load(<span class="hljs-number">2</span>); <span class="hljs-comment">//     </span>
  _delay_ms(<span class="hljs-number">7500</span>); <span class="hljs-comment">//      </span><font></font>
<font></font>
  cur_on = get_current(); <span class="hljs-comment">//     </span><font></font>
<font></font>
  blink_load(<span class="hljs-number">3</span>); <span class="hljs-comment">//     </span>
  _delay_ms(<span class="hljs-number">7500</span>); <span class="hljs-comment">//      </span><font></font>
<font></font>
  <font></font>
  res_off = MAX_U10BIT;<font></font>
  res_on = MAX_U10BIT;<font></font>
  frequency_dividor_tmp = <span class="hljs-number">0</span>;<font></font>
  max_diff = <span class="hljs-number">0</span>;
  <span class="hljs-comment">//      </span>
  <span class="hljs-keyword">for</span>(frequency_dividor = <span class="hljs-number">0</span>; frequency_dividor &lt;= FREQ_MAXIMAL_DIV; ++frequency_dividor) {<font></font>
    res_on_tmp = get_resistance();<font></font>
<font></font>
    <span class="hljs-comment">//   ,      </span>
    <span class="hljs-keyword">if</span>(res_off_array[frequency_dividor] &gt; res_on_tmp) {<font></font>
      diff = res_off_array[frequency_dividor] - res_on_tmp;<font></font>
      <span class="hljs-keyword">if</span>(diff &gt; max_diff) {<font></font>
        res_off = res_off_array[frequency_dividor];<font></font>
        res_on = res_on_tmp;<font></font>
        frequency_dividor_tmp = frequency_dividor;<font></font>
        max_diff = diff;<font></font>
      }    <font></font>
    }<font></font>
  }<font></font>
  frequency_dividor = frequency_dividor_tmp;<font></font>
<font></font>
  toggle_amp(<span class="hljs-literal">false</span>); <span class="hljs-comment">//  </span><font></font>
  <font></font>
  <span class="hljs-keyword">if</span>(cur_on &gt; cur_off + CUR_MINIMAL_DIFF) { <font></font>
    cur_edge = cur_off + (cur_on - cur_off) / <span class="hljs-number">2</span>; <span class="hljs-comment">//    ,     </span><font></font>
 <font></font>
    <span class="hljs-keyword">if</span>(res_on + RES_MINIMAL_DIFF &lt; res_off) {<font></font>
      res_edge = res_off - (res_off - res_on) / <span class="hljs-number">2</span>; <span class="hljs-comment">//    ,      </span><font></font>
<font></font>
      <span class="hljs-comment">//   </span><font></font>
      eeprom_write_word(&amp;EEPROM_cur_edge, cur_edge);<font></font>
      eeprom_write_word(&amp;EEPROM_res_edge, res_edge);<font></font>
      eeprom_write_byte(&amp;EEPROM_frequency_dividor, frequency_dividor);<font></font>
      <font></font>
      blink_load(<span class="hljs-number">1</span>); <span class="hljs-comment">//  </span>
    } <span class="hljs-keyword">else</span> {<font></font>
      blink_load(<span class="hljs-number">2</span>); <span class="hljs-comment">//    </span>
      <span class="hljs-keyword">if</span>(first_on()) stop();<font></font>
    }<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    blink_load(<span class="hljs-number">3</span>); <span class="hljs-comment">//    </span>
    <span class="hljs-keyword">if</span>(first_on()) stop();<font></font>
  }<font></font>
}<font></font>
<font></font>
ISR(WDT_vect) {<font></font>
  WDTCR |= (<span class="hljs-number">1</span> &lt;&lt; WDTIE); <span class="hljs-comment">//    watchdog   ""    </span><font></font>
}<font></font>
<font></font>
EMPTY_INTERRUPT(ADC_vect); <span class="hljs-comment">//     ,     </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
  init_vars();<font></font>
  init_pins();       <font></font>
  init_interrupts(); <font></font>
  init_settings();<font></font>
<font></font>
  <span class="hljs-keyword">if</span>(tp_reset || first_on()) {<font></font>
    calibrate(); <span class="hljs-comment">//          </span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">//  </span>
  <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {<font></font>
    set_sleep_mode(SLEEP_MODE_PWR_DOWN);<font></font>
    sleep_cpu(); <span class="hljs-comment">//   watchdog</span><font></font>
<font></font>
    <span class="hljs-keyword">if</span>(++clk &gt;= INTERVAL) {<font></font>
      do_main(); <span class="hljs-comment">//  </span>
      clk = <span class="hljs-number">0</span>;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo con diagrama, cableado y el proyecto completo de Atmel Studio 7</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es492788/index.html">Cansado, pero: Alemania detuvo por completo la primera ola de COVID-19</a></li>
<li><a href="../es492798/index.html">La gente ha ido a chatear en Internet, pero ahora nuevamente sue√±an con desconectarse. ¬øQu√© esta pasando?</a></li>
<li><a href="../es492800/index.html">Proveedor de IoT GSM en viviendas y servicios p√∫blicos (Parte 1)</a></li>
<li><a href="../es492804/index.html">Sobre el tema de la replicaci√≥n de la actividad social en Internet como clave para minimizar el aumento de la incidencia durante una pandemia</a></li>
<li><a href="../es492806/index.html">C√≥mo vincular el compromiso con la monetizaci√≥n en juegos y aplicaciones m√≥viles</a></li>
<li><a href="../es492810/index.html">[COVID-19] Su tarea es suavizar el pico</a></li>
<li><a href="../es492812/index.html">Intentando ejecutar redes GAN en OpenVINO</a></li>
<li><a href="../es492816/index.html">Consejos y trucos de IntelliJ IDEA: 4. Sincronice y comparta configuraciones</a></li>
<li><a href="../es492820/index.html">.Net Core Api: obtener datos en una solicitud de diferentes fuentes</a></li>
<li><a href="../es492822/index.html">Desarrolladores CSS: ¬øpor qu√© el mundo los necesita?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>