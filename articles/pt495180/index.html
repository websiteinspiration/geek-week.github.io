<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÖüèø üòá ‚òÑÔ∏è N√≥s bombeamos a Ikea: como transformar m√∫sicas leves em Big Brother üçµ üîØ üíÇüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introdu√ß√£o
 A Ikea √© uma loja curiosa. Mesmo se voc√™ entrar nele com a inten√ß√£o de comprar uma coisa espec√≠fica e n√£o se distrair com o resto do lixo,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>N√≥s bombeamos a Ikea: como transformar m√∫sicas leves em Big Brother</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495180/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/g-/1c/b3/g-1cb35ov13g0bc7demuvnxiqla.gif"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A Ikea √© uma loja curiosa. Mesmo se voc√™ entrar nele com a inten√ß√£o de comprar uma coisa espec√≠fica e n√£o se distrair com o resto do lixo, voc√™ sair√° comprando tr√™s vezes mais que o necess√°rio. Para n√≥s, hackers, esse efeito √© especialmente evidente no departamento da Ikea com cabos de energia ou baterias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para mim, o √∫ltimo caso de tal insanidade ocorreu na Holanda. Eu estava em uma viagem planejada, planejando passar apenas algumas semanas no pa√≠s. No entanto, isso foi no in√≠cio de 2020 e o desastre com o COVID-19 ... tive que ficar longe do meu laborat√≥rio por muito mais tempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E quando vi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> linha de produtos eletr√¥nicos da </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Frekevens</font></a><font style="vertical-align: inherit;"> na Ikea </font><font style="vertical-align: inherit;">, n√£o pude evitar e comprei tudo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para quem n√£o sabe: a linha Ikea Frekvens deve se tornar um an√°logo moderno do aparelho HiFi da velha escola, mais o aparelho de m√∫sica leve hexagonal, que parece estar na casa de metade dos adolescentes dos anos 90. Nesse caso, a linha de dispositivos conectados um ao outro consiste em um alto-falante Bluetooth para sa√≠da de som e um projetor de LED (complementado por v√°rios bicos) que piscam ao ritmo da m√∫sica, bem como uma exibi√ß√£o de cubo de LED que pode exibir anima√ß√µes que tamb√©m se movem para a m√∫sica. A Ikea se orgulha de que esta linha foi desenvolvida em conjunto com a Teenage Engineering, conhecida por sua s√©rie Pocket Operator de sintetizadores port√°teis de "brinquedos".</font></font><br>
<a name="habracut"></a><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f4d/8b4/e60/f4d8b4e60e7812b5b979850a18d3926c.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como mostrado no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√≠deo promocional da</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ikea, a compra final de dezenas de dispositivos deve parecer um carnaval insuport√°vel, que meu adolescente de 15 anos n√£o se importaria de arrumar em seu quarto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu estava particularmente interessado no display de cubo LED: √© um dispositivo integrado de alta qualidade que funciona na rede el√©trica. No painel frontal, h√° uma matriz de 16 linhas e 16 colunas de LEDs brancos muito brilhantes, ou seja, um total de 256 LEDs. As anima√ß√µes incorporadas ao dispositivo eram bastante simples, mas me levaram √† ideia de que o ferro pode realmente controlar cada LED individualmente. No entanto, por causa disso, a pequena caixa era muito cara: meu bolso estava vazio por cerca de 40 euros. Para esse valor, voc√™ recebe uma caixa com LEDs e um cabo de alimenta√ß√£o. Como se sup√µe que voc√™ deve comprar este produto junto com outros produtos da Frekvens, tamb√©m recebe elementos de conex√£o adicionais: um cabo de extens√£o para fornecer energia de ponta a ponta da rede el√©trica para outras caixas,bem como um conjunto de parafusos e apoios de pl√°stico com os quais voc√™ pode prender mecanicamente o alojamento um ao outro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim que cheguei em casa, conectei o dispositivo e ... para ser sincero, fiquei um pouco decepcionado com o que eles fizeram com o ferro. </font><font style="vertical-align: inherit;">O dispositivo possui v√°rias anima√ß√µes que podem ser selecionadas pressionando um bot√£o na parte traseira do gabinete; </font><font style="vertical-align: inherit;">um pequeno microfone √© instalado no gabinete - toda vez que reconhece ru√≠do, o quadro da anima√ß√£o muda. </font><font style="vertical-align: inherit;">As anima√ß√µes n√£o s√£o muito interessantes: elas consistem em apenas quatro a cinco quadros, e os quadros em si s√£o apenas preto e branco, sem tons de cinza. </font><font style="vertical-align: inherit;">Se voc√™ estiver curioso, gravei um pequeno </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√≠deo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com todas as anima√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, isso n√£o combina comigo. </font><font style="vertical-align: inherit;">Vamos invadir o dispositivo - vamos ver o que o faz funcionar e √© poss√≠vel tornar seu comportamento um pouco mais interessante.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aut√≥psia</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para desmontar Frekvens, basta uma chave de fenda para uma fenda em forma de cruz e, possivelmente, uma faca. </font><font style="vertical-align: inherit;">Voc√™ tamb√©m precisar√° de uma parcela s√≥lida de perseveran√ßa, porque o dispositivo n√£o √© f√°cil de desmontar: o design √© complicado e alguns elementos s√£o preenchidos com silicone, provavelmente para se livrar da vibra√ß√£o e simplificar a fabrica√ß√£o.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/71d/6e9/925/71d6e9925d31cbce7d1da4cf492948de.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A desmontagem do caso Frekvens come√ßa por tr√°s. </font><font style="vertical-align: inherit;">A carca√ßa possui orif√≠cios de parafuso em todos os lados, com exce√ß√£o da frente; </font><font style="vertical-align: inherit;">gra√ßas ao conjunto de parafusos e tampas do kit do dispositivo, ele pode ser conectado a outros gadgets da Frekvens. </font><font style="vertical-align: inherit;">No entanto, os orif√≠cios traseiros dos parafusos s√£o um pouco mais profundos e, embaixo deles, existem parafusos que prendem o gabinete.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebf/2c5/8e2/ebf2c58e270c942b8e360a744f0ff6ea.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de remover a tampa traseira, vemos que todos os orif√≠cios dos parafusos t√™m inser√ß√µes met√°licas rosqueadas nas quais os parafusos podem ser parafusados. </font><font style="vertical-align: inherit;">Uau! </font><font style="vertical-align: inherit;">Isso deve fornecer aos orif√≠cios uma margem de seguran√ßa suficiente. </font><font style="vertical-align: inherit;">√â poss√≠vel que isso complique bastante a produ√ß√£o ou desmontagem; </font><font style="vertical-align: inherit;">o √∫ltimo √© complicado pelo fato de precisarmos primeiro cortar as gotas do composto de silicone endurecido.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ca/78c/bf2/4ca78cbf2e1f533658a361fd998a933a.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As inser√ß√µes s√£o presas com outras inser√ß√µes de pl√°stico; </font><font style="vertical-align: inherit;">eles precisam ser removidos primeiro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o tenho outras fotos do processo de desmontagem, mas ap√≥s esse est√°gio voc√™ ver√° quatro parafusos que precisam ser desaparafusados ‚Äã‚Äãe, em seguida, o processo continua como antes. </font><font style="vertical-align: inherit;">Entenda qual pe√ßa de pl√°stico mant√©m tudo o mais unido, corte o composto de silicone, remova os elementos de fixa√ß√£o de pl√°stico. </font><font style="vertical-align: inherit;">Continue at√© poder retirar a placa de circuito.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e40/8c0/346/e408c0346ddbea872aa6100a7c37c303.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√°: o verso da placa de circuito. Como se viu, ele √© montado a partir de duas placas de circuito impresso: a branca tem dois lados - na parte traseira existem todos os drivers de LEDs (e outra placa est√° conectada a ela) e na frente os pr√≥prios LEDs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A placa de circuito branca foi projetada muito bem: em vez de uma matriz de LEDs, existem 16 drivers de LED </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCT2024</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabalhando a partir de uma corrente cont√≠nua. Esses drivers de LED t√™m 16 canais, ou seja, cada LED √© controlado diretamente. Os drivers de LED podem ligar ou desligar totalmente os LEDs; os pr√≥prios drivers n√£o t√™m suporte nativo em escala de cinza. De fato, eles realizam a troca de registros usando sa√≠das controladas por corrente e todos alternam sequencialmente; A interface de conex√£o verde da PCB consiste em seu barramento e dados de sincroniza√ß√£o, uma linha de ativa√ß√£o instant√¢nea, uma linha de sa√≠da, terra e ativa√ß√£o da energia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesta placa verde, est√° o min√∫sculo c√©rebro do dispositivo: um microcontrolador, cujo artigo n√£o pode ser encontrado no Google, e um amplificador operacional para o microfone. </font><font style="vertical-align: inherit;">Curiosamente, h√° dicas de que o dispositivo deve ter mais recursos: existe um lugar para, presumivelmente, o I2C EEPROM 24Cxx e uma dica de que no projeto original havia um receptor de infravermelho no painel frontal. </font><font style="vertical-align: inherit;">Talvez fosse suposto que o dispositivo fosse fornecido com um controle remoto que permite criar seus pr√≥prios padr√µes? </font><font style="vertical-align: inherit;">Isso pode explicar que as anima√ß√µes existentes parecem t√£o mon√≥tonas.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/40f/a7a/1d9/40fa7a1d95a60af223eb12a5f5db7ba6.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na frente do quadro branco est√£o todos os LEDs. </font><font style="vertical-align: inherit;">Um pequeno microfone plano tamb√©m √© soldado a ele. </font><font style="vertical-align: inherit;">No come√ßo, pensei que estava soldado ao quadro verde e se destacava pelo buraco no quadro branco, mas na verdade √© apenas plano.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2bb/613/620/2bb6136207e5ce1cf78895a6827a8dfd.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos os outros eletr√¥nicos est√£o localizados na parte de tr√°s do quadro. </font><font style="vertical-align: inherit;">N√£o √© suficiente: apenas uma fonte de alimenta√ß√£o da marca Ikea, emitindo 4 V. Sob a fonte de alimenta√ß√£o, h√° uma pequena placa de circuito impresso na qual existem duas chaves t√°teis para bot√µes na parte traseira do gabinete. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, se queremos "otimizar" o design, temos uma fraqueza √≥bvia: √© melhor substituir um pequeno cart√£o verde por um processador por algo mais poderoso.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s modificamos o ferro</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu pensei que seria poss√≠vel substituir o equipamento por uma ESP-Cam. Esta √© uma placa muito barata (cerca de 10 euros) com um chip ESP32 WiFi / BT, v√°rios megabytes de PSRAM e um m√≥dulo de c√¢mera. N√£o estou muito interessado em m√∫sica leve, queria que o dispositivo respondesse a algo visual. Como j√° havia um orif√≠cio na parte frontal do receptor, pensei em us√°-lo sob a c√¢mera. Tamb√©m precisarei fazer um furo no quadro branco onde o microfone est√° localizado; felizmente, al√©m dessas faixas de microfone agora in√∫teis, isso destruir√° apenas uma faixa do LED. Furei um buraco e restaurei a pista. Colocando a placa temporariamente de volta no lugar e ligando o cubo, verifiquei se todos os LEDs ainda estavam funcionando.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ed1/c45/456/ed1c454569bc1fa6734a8c16bdfed1ae.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora eu tinha uma placa com um orif√≠cio aberto e s√≥ podia conectar e conectar mecanicamente a ESP-Cam. Os designers gentilmente indicaram o objetivo de todas as almofadas na serigrafia do quadro verde, ent√£o eu quase tive que adivinhar nada. Como a fonte de alimenta√ß√£o fornece apenas 4 V, eu a conectei diretamente √† entrada de 3,3 V do chip ESP-CAM. Eu tive que fazer isso, porque quando o conectei ao pino Vin 5V, o chip n√£o quis iniciar ... Muito provavelmente, o regulador LDO tem uma queda de tens√£o um pouco alta. Voltando, agora acho que valeu a pena tentar conectar o diodo em s√©rie com uma fonte de 4 V para obter 3,3-3,4 V, mas minha solu√ß√£o funcionou; O ESP32 √© bastante despretensioso.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/021/93d/abe/02193dabe8880ceeea91807ec0a16d2f.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soldando todos os conectores, tive que lidar com a mec√¢nica de qualquer maneira. </font><font style="vertical-align: inherit;">Era um projeto "r√°pido e sujo", e eu j√° havia soldado os conectores ESP-Cam antes, portanto, para alinhar a c√¢mera com o orif√≠cio, voc√™ poderia fazer com v√°rias juntas e muito ep√≥xi.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/f14/364/e62f143645504bfd1636cab8fdb3cdf8.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s esta opera√ß√£o, o √∫ltimo problema permaneceu: os LEDs pr√≥ximos √† c√¢mera brilharam na janela do quadro, causando todos os tipos de artefatos estranhos. </font><font style="vertical-align: inherit;">Antes de tudo, para elimin√°-los, cortei um pequeno painel de uma fita de alum√≠nio para proteger a c√¢mera da luz direta.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fa7/1a8/1bb/fa71a81bb0a3131132885840f8186e85.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo passo foi a aplica√ß√£o de tinta acr√≠lica. </font><font style="vertical-align: inherit;">Este √© um inserto de pl√°stico no qual est√£o localizados todos os difusores, atrav√©s dos quais os LEDs brilham. </font><font style="vertical-align: inherit;">Eu j√° ampliei o orif√≠cio existente no microfone para criar uma janela de quadro mais ampla para a c√¢mera, mas isso levou a outro problema - o orif√≠cio era muito percept√≠vel e muita luz difusa caiu sobre a c√¢mera. </font><font style="vertical-align: inherit;">Uma mancha de tinta acr√≠lica preta se saiu muito bem nas duas quest√µes; </font><font style="vertical-align: inherit;">a c√¢mera ainda recebia bastante luz dos LEDs, mas agora n√£o a inundou completamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, o transplante cerebral est√° completo e o corpo est√° pronto para a montagem. </font><font style="vertical-align: inherit;">Voc√™ pode iniciar o software.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programas</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos para o software. Primeiro de tudo, precisamos obter controle sobre os drivers de LED. Isso n√£o √© dif√≠cil: os sinais do driver s√£o quase diretamente consistentes com a interface perif√©rica SPI do chip ESP32: o painel CLK na placa se conecta √† interface CLK perif√©rica SPI, o painel DA na placa se conecta ao MOSI do sinal SPI. Isso permitir√° que voc√™ sincronize 256 bits com uma cadeia de drivers de LED: cada bit sincronizado controla a ativa√ß√£o ou desativa√ß√£o do LED correspondente. Al√©m disso, h√° uma entrada do LAK. Se o sinal estiver baixo, o LED manter√° seu valor anterior, independentemente do que foi transferido para os registros de turno; se o sinal estiver alto, todos eles mudar√£o simultaneamente para os valores que est√£o atualmente no registrador de turnos. Finalmente, h√° uma entrada EN que liga ou desliga todos os LEDs;Eu n√£o o conectei ao GPIO e sempre acendi os LEDs programaticamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, agora posso ligar e desligar os LEDs individuais, obtendo uma tela em preto e branco. No entanto, preciso de outra coisa. Com energia computacional suficiente, a tela tamb√©m deve ser capaz de exibir tons de cinza - para isso, basta ligar / desligar os LEDs mais rapidamente do que os olhos v√™em. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implementar isso com um √∫nico LED, geralmente uso o PWM, mas no caso de 256 LEDs, isso ocupar√° uma parte significativa do processador ESP32. Ent√£o, em vez disso, decidi usar a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modula√ß√£o de C√≥digo Bin√°rio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (tamb√©m chamada de Modula√ß√£o de √Çngulo de Bit). Essa √© uma t√©cnica que permite obter tons de cinza com menos energia da CPU. Eu j√° o usei com sucesso em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outros projetos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , por isso tinha certeza de que funcionaria.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e99/009/265/e990092656bfd3db2032718f55e7e086.jpg"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E funcionou. Tamb√©m adicionei uma tabela de pesquisa para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">converter a luminosidade CIE em PWM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , porque o olho responde essencialmente ao brilho dos LEDs de forma n√£o linear; tabela de pesquisa corrige esse problema. No final, consegui obter uma quantidade suficiente de tons de cinza e escala linear do brilho √≥ptico de acordo com o valor de pixel definido por mim.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o foi dif√≠cil implementar o projeto da c√¢mera: existe um componente ESP-IDF que pode ser adicionado ao projeto; ele cuidar√° da configura√ß√£o da c√¢mera e da troca de dados com ela, basta especificar os par√¢metros necess√°rios e solicitar o bitmap que a c√¢mera v√™. A √∫nica coisa que n√£o pude usar na configura√ß√£o padr√£o foi que o alinhamento autom√°tico e a exposi√ß√£o autom√°tica foram ativados por padr√£o, e isso interferiu bastante na minha maneira de controlar os LEDs: dependendo de qual parte da sequ√™ncia de Modula√ß√£o de c√≥digo bin√°rio a imagem foi criada, a c√¢mera aumentou aleatoriamente ou diminuiu o alinhamento e a exposi√ß√£o. Corrigi o problema mudando a c√¢mera para o alinhamento manual e a velocidade do obturador; o pr√≥prio c√≥digo examina a imagem e determina se esses par√¢metros precisam de compensa√ß√£o.Gra√ßas a esse processamento manual, tamb√©m consegui excluir pixels que olhavam diretamente para os LEDs para remov√™-los completamente da equa√ß√£o. Isso tamb√©m ajudou muito na obten√ß√£o de uma imagem est√°vel.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora eu tenho uma c√¢mera e uma tela de 16x16 em tons de cinza. O que devo fazer com eles? Tive uma ideia: na √©poca dos primeiros computadores Macintosh, havia uma extens√£o popular que adicionava apenas alguns olhos de desenho animado √† barra de menus. Esses olhos simplesmente seguiram o cursor. (Ainda existe uma varia√ß√£o desse tema para Linux / Unix chamada "xeyes".) E se eu tentar repeti-lo na vida real?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6d1/c9e/0a1/6d1c9e0a114c84f246c051c4358cdcc7.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para come√ßar, eu precisava de algumas imagens dos olhos. N√£o achei que pudesse desenhar algo que valesse a pena; ent√£o, decidi usar meus pr√≥prios olhos como figuras b√°sicas; assista a um pequeno v√≠deo em que assisto e pisco em todas as dire√ß√µes. Vale a pena considerar que, devido √† situa√ß√£o atual, eu tinha muito poucas ferramentas profissionais: deito no ch√£o para maximizar a ilumina√ß√£o que cai das l√¢mpadas fluorescentes do teto e obter uma imagem leg√≠vel; Todo o v√≠deo foi filmado no smartphone que eu seguro em minhas m√£os.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como os dados iniciais eram bastante desleixados, tive que trabalhar duro no p√≥s-processamento. Comecei cortando um fragmento que estava aproximadamente ao redor do meu olho direito. Depois converti cada quadro do v√≠deo em uma imagem e apaguei todas as imagens redundantes; no final, tive uma boa sele√ß√£o de imagens minhas olhando em dire√ß√µes diferentes, bem como alguns quadros com um piscar de olhos. No entanto, como usei um celular para gravar, o v√≠deo ficou um pouco inst√°vel e as imagens saltaram. Para corrigir isso, passei um conjunto de imagens pelo programa de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">cola de</font></a><font style="vertical-align: inherit;"> imagem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hugin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que geralmente √© usado para panoramas e imagens HDR; na sa√≠da, tirei fotos idealmente centralizadas nessa parte do meu rosto. Agora eu s√≥ conseguia marcar em qual dire√ß√£o estava olhando e se eu pisquei. Fiz isso convertendo todas as imagens em tons de cinza e depois enviando-as para o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gimp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Em cada imagem, usei um ponto vermelho para indicar a localiza√ß√£o do centro da pupila, al√©m de um ponto vermelho no canto esquerdo ou direito para indicar se eu pisquei e, se piscar, meu olho est√° meio aberto ou fechado.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bb6/112/a73/bb6112a73c7b9fbdb619afaff1b971c9.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de marcar cada imagem dessa maneira, ficou muito simples escrever um script para obter a localiza√ß√£o do aluno e o estado de piscar. O script tamb√©m dimensionou as imagens para 16x16 e as salvou como dados bin√°rios brutos, prontos para serem gravados no firmware do m√≥dulo ESP-CAM. No final, obtive um conjunto de imagens e um √≠ndice de onde a pupila est√° e em que estado do piscar de olhos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A ESP-Cam possui um componente de biblioteca de c√¢meras bastante f√°cil de usar para o ESP-IDF, portanto, foi f√°cil obter imagens. Configurei capturando imagens de 120x160 em tons de cinza, porque s√£o mais f√°ceis de processar e n√£o precisava de muita resolu√ß√£o, porque o resultado final deve ser exibido em uma tela de 16x16. No entanto, eu ainda tinha um problema de hardware: a c√¢mera ainda est√° muito pr√≥xima dos LEDs.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cb1/d78/621/cb1d786213e7450791968f0e7da4d6c3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No come√ßo, tentei resolv√™-lo por calibra√ß√£o: quando o dispositivo √© iniciado, s√£o tiradas duas fotos: uma com um LED pr√≥ximo √† lente da c√¢mera e outra apenas com um LED localizado longe da c√¢mera. Subtraindo uma imagem de outra, voc√™ pode entender quais pixels s√£o afetados pelos LEDs. Esses pixels s√£o armazenados na m√°scara; os pixels marcados na m√°scara s√£o posteriormente ignorados. A imagem acima mostra duas fotos e uma m√°scara.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com uma imagem mais limpa, eu poderia passar para o reconhecimento de movimento. Eu o implementei obtendo um quadro da c√¢mera e subtraindo o quadro anterior. Pude calcular a quantidade de movimento adicionando todos os pixels resultantes. Al√©m disso, foi poss√≠vel calcular a localiza√ß√£o da concentra√ß√£o de movimento, tomando a m√©dia das coordenadas de todos os pixels ponderados pela diferen√ßa de quadros nesse pixel. No final, a m√°gica de filtragem √© executada para que o dispositivo n√£o pare√ßa mexer como um macaco Russell Terrier com TDAH: para atrair sua aten√ß√£o, os objetos devem se mover de maneira mais uniforme ou suficientemente longe.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Havia apenas um problema: quando estava muito escuro, o algoritmo de reconhecimento de movimento √†s vezes trabalhava no reflexo dos LEDs em objetos brilhantes na sala: se o olho piscava, prestava aten√ß√£o ao seu pr√≥prio reflexo. </font><font style="vertical-align: inherit;">N√£o era exatamente isso que eu queria, ent√£o contornei esse problema tornando o algoritmo de reconhecimento de movimento ‚Äúcego‚Äù ao alterar a imagem nos LEDs; </font><font style="vertical-align: inherit;">ent√£o eu parei esse comportamento. </font><font style="vertical-align: inherit;">Al√©m disso, tamb√©m √© um pouco mais realista: quando voc√™ pisca, n√£o pode ver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O firmware possui v√°rios modos de depura√ß√£o que demonstram todo o processo. </font><font style="vertical-align: inherit;">Aqui est√° um pequeno v√≠deo ilustrando isso:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/bR-CpMdz02I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o agora eu tenho um dispositivo que est√° me seguindo ... n√£o √© realmente √∫til, eu concordo. </font><font style="vertical-align: inherit;">Mas foi interessante para mim cri√°-lo e, se algum dia encontrar algo mais √∫til que possa ser implementado em uma tela de LED 16x16, posso faz√™-lo, porque j√° tenho um c√≥digo de controle. </font><font style="vertical-align: inherit;">Falando em c√≥digo: voc√™ pode baixar livremente o meu resultado bruto a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partir daqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Espero que tenha gostado e tenha cuidado.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/UCPUPO21Cwk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt495168/index.html">Uma forma alternativa do operador tern√°rio do Python</a></li>
<li><a href="../pt495170/index.html">O que parece temporariamente desapareceu de nossas vidas e cujo retorno n√£o vale a pena esperar - uma discuss√£o</a></li>
<li><a href="../pt495174/index.html">Profissional freelancer</a></li>
<li><a href="../pt495176/index.html">Corrigindo a serializa√ß√£o de objetos no Kotlin de uma vez por todas</a></li>
<li><a href="../pt495178/index.html">Est√° na hora de sites gratuitos</a></li>
<li><a href="../pt495184/index.html">As dificuldades da substitui√ß√£o de importa√ß√µes: uma ferramenta para empresas estatais √© removida do registro de software dom√©stico</a></li>
<li><a href="../pt495188/index.html">Dificuldades no ensino de l√≠nguas estrangeiras (eu tamb√©m recomendaria aos alunos)</a></li>
<li><a href="../pt495192/index.html">O script perfeito de inicializa√ß√£o do servidor Minecraft</a></li>
<li><a href="../pt495194/index.html">Placa de √°udio m√≠nima STM-32</a></li>
<li><a href="../pt495196/index.html">Se o IB tivesse um ‚ÄúPr√™mio Darwin‚Äù, ou 7 hist√≥rias sobre estupidez, lixo, credulidade e suas conseq√º√™ncias</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>