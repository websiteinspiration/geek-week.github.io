<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕎 👨🏼‍🤝‍👨🏻 🚵🏽 高速ENUM 🤲🏻 👩🏽 🌞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="tl; dr
 github.com/QratorLabs/fastenum
 

pip install fast-enum
 列挙が必要な理由
 （すべてを知っている場合は、セクション「標準ライブラリの列挙」に進ん
 
 でください）独自のデータベースモデルでエンティティのすべての可能な状態のセ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>高速ENUM</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/480614/"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tl; dr</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/QratorLabs/fastenum</font></font></a><br>
<pre><code class="bash hljs">pip install fast-enum</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">列挙が必要な理由</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（すべてを知っている場合は、セクション「標準ライブラリの列挙」に進ん</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
でください）独自のデータベースモデルでエンティティのすべての可能な状態のセットを記述する必要があると想像してください。</font><font style="vertical-align: inherit;">ほとんどの場合、モジュールの名前空間で直接定義された一連の定数を取得します。</font></font><br>
<pre><code class="python hljs"><span class="hljs-comment"># /path/to/package/static.py:</span>
INITIAL = <span class="hljs-number">0</span>
PROCESSING = <span class="hljs-number">1</span>
PROCESSED = <span class="hljs-number">2</span>
DECLINED = <span class="hljs-number">3</span>
RETURNED = <span class="hljs-number">4</span>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...または静的クラス属性として：</font></font><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyModelStates</span>:</span>
  INITIAL = <span class="hljs-number">0</span>
  PROCESSING = <span class="hljs-number">1</span>
  PROCESSED = <span class="hljs-number">2</span>
  DECLINED = <span class="hljs-number">3</span>
  RETURNED = <span class="hljs-number">4</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このようなアプローチは、これらの状態をニーモニック名で参照するのに役立ちますが、リポジトリでは通常の整数になります。したがって、コードのさまざまな部分に散在しているマジックナンバーを同時に取り除くと同時に、読みやすく、情報量を増やすことができます。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、モジュール定数と静的属性を持つクラスの両方に、Pythonオブジェクトの固有の性質があります。それらはすべて可変（可変）です。実行時に誤って定数に値を割り当てる可能性があり、壊れたオブジェクトのデバッグとロールバックは別の冒険です。したがって、宣言された定数の数とそれらがマップされるそれらの値がプログラムの実行中に変化しないという意味で、定数のバンドルを変更しないようにすることができます。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うに</font></font><code>namedtuple()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、例のように、</font><font style="vertical-align: inherit;">を使用して名前付きタプルに整理してみます</font><font style="vertical-align: inherit;">。</font></font><br>
<pre><code class="python hljs">MyModelStates = namedtuple(<span class="hljs-string">'MyModelStates'</span>, (<span class="hljs-string">'INITIAL'</span>, <span class="hljs-string">'PROCESSING'</span>, <span class="hljs-string">'PROCESSED'</span>, <span class="hljs-string">'DECLINED'</span>, <span class="hljs-string">'RETURNED'</span>))<font></font>
EntityStates = MyModelStates(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これは非常にすっきりとして読みやすく</font></font><code>namedtuple</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はなく、</font><font style="vertical-align: inherit;">オブジェクト</font><font style="vertical-align: inherit;">は非常に拡張可能ではありません。これらの状態をすべて表示するUIがあるとします。モジュール、属性を持つクラス、または名前付きタプルで定数を使用して、それらをレンダリングできます（これについて説明しているため、最後の2つはレンダリングが簡単です）。ただし、このようなコードでは、定義した各状態について適切な説明をユーザーに提供することはできません。さらに、UIに多言語対応とi18nサポートを実装することを計画している場合は、これらの説明のすべての翻訳をすばやく完了することが非常に退屈な作業になることに気づくでしょう。州名の一致は、必ずしも説明の一致を意味するわけではありません。つまり、すべての状態を表示することはできません。</font></font><code>INITIAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じ説明で述べるc </font></font><code>gettext</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">代わりに、定数は次の形式を取ります。</font></font><br>
<pre><code class="python hljs">INITIAL = (<span class="hljs-number">0</span>, <span class="hljs-string">'My_MODEL_INITIAL_STATE'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または、クラスは次のようになります。</font></font><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyModelStates</span>:</span>
  INITIAL = (<span class="hljs-number">0</span>, <span class="hljs-string">'MY_MODEL_INITIAL_STATE'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、名前付きタプルは次のようになります。</font></font><br>
<pre><code class="python hljs">EntityStates = MyModelStates((<span class="hljs-number">0</span>, <span class="hljs-string">'MY_MODEL_INITIAL_STATE'</span>), ...)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに悪くはありません-現在、ステータス値と翻訳スタブの両方がUIでサポートされている言語で表示されることが保証されています。</font><font style="vertical-align: inherit;">しかし、これらのマッピングを使用するコードが混乱していることに気付くかもしれません。</font><font style="vertical-align: inherit;">エンティティ値を割り当てようとするたびに、使用している表示からインデックス0の値を抽出する必要があります。</font></font><br>
<br>
<pre><code class="python hljs">my_entity.state = INITIAL[<span class="hljs-number">0</span>]</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><pre><code class="python hljs">my_entity.state = MyModelStates.INITIAL[<span class="hljs-number">0</span>]</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><pre><code class="python hljs">my_entity.state = EntityStates.INITIAL[<span class="hljs-number">0</span>]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
等。</font><font style="vertical-align: inherit;">定数とクラス属性をそれぞれ使用する最初の2つのアプローチは、可変性の影響を受けることに注意してください。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そしてここで転送は私たちの助けになります</font></font></h4><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyEntityStates</span>(<span class="hljs-params">Enum</span>):</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, val, description</span>):</span><font></font>
    self.val = val<font></font>
    self.description = description<font></font>
<font></font>
  INITIAL = (<span class="hljs-number">0</span>, <span class="hljs-string">'MY_MODEL_INITIAL_STATE'</span>)<font></font>
  PROCESSING = (<span class="hljs-number">1</span>, <span class="hljs-string">'MY_MODEL_BEING_PROCESSED_STATE'</span>)<font></font>
  PROCESSED = (<span class="hljs-number">2</span>, <span class="hljs-string">'MY_MODEL_PROCESSED_STATE'</span>)<font></font>
  DECLINED = (<span class="hljs-number">3</span>, <span class="hljs-string">'MY_MODEL_DECLINED_STATE'</span>)<font></font>
  RETURNED = (<span class="hljs-number">4</span>, <span class="hljs-string">'MY_MODEL_RETURNED_STATE'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで全部です。</font><font style="vertical-align: inherit;">これで、レンダーのリストを簡単に反復できます（Jinja2構文）。</font></font><br>
<pre><code class="python hljs">{% <span class="hljs-keyword">for</span> state <span class="hljs-keyword">in</span> MyEntityState %}<font></font>
  &lt;option value=”{{ state.val }}”&gt;{{ _(state.description) }}&lt;/option&gt;<font></font>
{% endfor %}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
列挙は一連の要素の両方に対して不変です-実行時に列挙の新しいメンバーを定義することはできず、既に定義されたメンバーを削除することも、それらが格納するそれらの要素の値についても、属性値を[再]割り当てたり、属性を削除したりすることはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードでは、次のようにエンティティに値を割り当てるだけです。</font></font><br>
<pre><code class="python hljs">my_entity.state = MyEntityStates.INITIAL.val</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが非常に明確で、有益で、拡張可能です。</font><font style="vertical-align: inherit;">これが、列挙を使用する目的です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どうすれば速くできるでしょうか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
標準ライブラリからの列挙はかなり遅いので、私たちは自分自身に尋ねました-スピードアップできますか？</font><font style="vertical-align: inherit;">結局のところ、列挙の実装は可能です。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メンバー列挙へのアクセスが3倍速くなりました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メンバー</font><font style="vertical-align: inherit;">属性（</font></font><code>name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">へのアクセス時に〜8.5速くなりました</font><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値でメンバーにアクセスする場合、3倍速くなります（列挙コンストラクターを呼び出し</font></font><code>MyEnum(value))</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ディクショナリのように</font></font><code>MyEnum[name]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">名前でメンバーにアクセスする場合、1.5倍速くなり</font><font style="vertical-align: inherit;">ます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pythonの型とオブジェクトは動的です。</font><font style="vertical-align: inherit;">しかし、オブジェクトのそのような動的な性質を制限するツールがあります。</font><font style="vertical-align: inherit;">を使用すると、パフォーマンスを大幅に向上させることができます</font></font><code>__slots__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">可能な限りデータ記述子の使用を避けると、速度が向上する可能性もありますが、アプリケーションの複雑さが大幅に増加する可能性を考慮する必要があります。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スロット</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、クラス宣言を</font></font><code>__slots__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">とともに使用できます。</font><font style="vertical-align: inherit;">この場合、クラスのすべてのインスタンスは</font></font><code>__slots__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、すべての</font></font><code>__slots__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">親クラスで</font><font style="vertical-align: inherit;">宣言されたプロパティの限定されたセットのみを持ち</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記述子</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、Pythonインタープリターはオブジェクトの属性の値を直接返します（ただし、この場合、値はPythonオブジェクトであり、たとえば、C言語ではunsigned long longではないことを規定しています）：</font></font><br>
<code>value = my_obj.attribute #        ,      .</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pythonデータモデルによれば、属性値がオブジェクトの場合、記述子プロトコルを実装している場合、この属性の値を取得しようとすると、インタープリターはまず、プロパティが参照するオブジェクトへのリンクを見つけ、それを特別なメソッド</font></font><code>__get__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">呼び出します</font><font style="vertical-align: inherit;">。これは、引数として元のオブジェクトに渡されます。</font></font><br>
<pre><code class="python hljs">obj_attribute = my_obj.attribute<font></font>
obj_attribute_value = obj_attribute.__get__(my_obj)</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準ライブラリの列挙</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少なくとも、</font><font style="vertical-align: inherit;">標準の列挙実装の</font><font style="vertical-align: inherit;">プロパティ</font></font><code>name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メンバーはとして宣言され</font></font><code>types.DynamicClassAttribute</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">つまり、値を取得しようとする</font></font><code>name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、</font></font><code>value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のことが起こります。</font></font><br>
<br>
<pre><code class="python hljs">one_value = StdEnum.ONE.value  <span class="hljs-comment">#       </span><font></font>
<font></font>
<span class="hljs-comment">#   ,     </span><font></font>
one_value_attribute = StdEnum.ONE.value<font></font>
one_value = one_value_attribute.__get__(StdEnum.ONE)</code></pre><br>
<pre><code class="python hljs"><span class="hljs-comment">#   ,  __get__     (  python3.7):</span>
   <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__get__</span>(<span class="hljs-params">self, instance, ownerclass=None</span>):</span>
        <span class="hljs-keyword">if</span> instance <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">if</span> self.__isabstractmethod__:
                <span class="hljs-keyword">return</span> self
            <span class="hljs-keyword">raise</span> AttributeError()
        <span class="hljs-keyword">elif</span> self.fget <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">"unreadable attribute"</span>)
        <span class="hljs-keyword">return</span> self.fget(instance)</code></pre><br>
<pre><code class="python hljs"><span class="hljs-comment">#   DynamicClassAttribute     `name`  `value`   __get__()  :</span><font></font>
<font></font>
<span class="hljs-meta">    @DynamicClassAttribute</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">name</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">"""The name of the Enum member."""</span>
        <span class="hljs-keyword">return</span> self._name_<font></font>
<font></font>
<span class="hljs-meta">    @DynamicClassAttribute</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">value</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">"""The value of the Enum member."""</span>
        <span class="hljs-keyword">return</span> self._value_</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、呼び出しのシーケンス全体は、次の疑似コードで表すことができます。</font></font><br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_func</span>(<span class="hljs-params">enum_member, attrname</span>):</span>
        <span class="hljs-comment">#        __dict__,        -    </span>
    <span class="hljs-keyword">return</span> getattr(enum_member, <span class="hljs-string">f'_<span class="hljs-subst">{attrnme}</span>_'</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_name_value</span>(<span class="hljs-params">enum_member</span>):</span>
    name_descriptor = get_descriptor(enum_member, <span class="hljs-string">'name'</span>)
    <span class="hljs-keyword">if</span> enum_member <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">if</span> name_descriptor.__isabstractmethod__:
            <span class="hljs-keyword">return</span> name_descriptor
        <span class="hljs-keyword">raise</span> AttributeError()
    <span class="hljs-keyword">elif</span> name_descriptor.fget <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">"unreadable attribute"</span>)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> get_func(enum_member, <span class="hljs-string">'name'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の出力を示す簡単なスクリプトを作成しました。</font></font><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StdEnum</span>(<span class="hljs-params">Enum</span>):</span>
   <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, value, description</span>):</span><font></font>
       self.v = value<font></font>
       self.description = description<font></font>
<font></font>
   A = <span class="hljs-number">1</span>, <span class="hljs-string">'One'</span>
   B = <span class="hljs-number">2</span>, <span class="hljs-string">'Two'</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_name</span>():</span>
   <span class="hljs-keyword">return</span> StdEnum.A.name<font></font>
<font></font>
<span class="hljs-keyword">from</span> pycallgraph <span class="hljs-keyword">import</span> PyCallGraph
<span class="hljs-keyword">from</span> pycallgraph.output <span class="hljs-keyword">import</span> GraphvizOutput<font></font>
<font></font>
graphviz = GraphvizOutput(output_file=<span class="hljs-string">'stdenum.png'</span>)<font></font>
<font></font>
<span class="hljs-keyword">with</span> PyCallGraph(output=graphviz):<font></font>
   v = get_name()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトを実行すると、次の画像が</font></font><br>
<img src="https://habrastorage.org/webt/op/ff/m7/opffm7k3v2rgako7xufgkgqtcek.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
表示されます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは</font><font style="vertical-align: inherit;">、標準ライブラリから列挙型の</font><font style="vertical-align: inherit;">属性</font></font><code>name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メンバーに</font><font style="vertical-align: inherit;">アクセスするたび</font><font style="vertical-align: inherit;">に、記述子が呼び出されることを示しています。</font><font style="vertical-align: inherit;">次に、この記述子は、記述子で</font><font style="vertical-align: inherit;">修飾され</font></font><code>Enum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">たメソッドの標準ライブラリの</font><font style="vertical-align: inherit;">クラス</font><font style="vertical-align: inherit;">からの</font><font style="vertical-align: inherit;">呼び出しで終了し</font></font><code>def name(self)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FastEnumと比較してください。</font></font><br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> fast_enum <span class="hljs-keyword">import</span> FastEnum<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyNewEnum</span>(<span class="hljs-params">metaclass=FastEnum</span>):</span>
   A = <span class="hljs-number">1</span>
   B = <span class="hljs-number">2</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_name</span>():</span>
   <span class="hljs-keyword">return</span> MyNewEnum.A.name<font></font>
<font></font>
<span class="hljs-keyword">from</span> pycallgraph <span class="hljs-keyword">import</span> PyCallGraph
<span class="hljs-keyword">from</span> pycallgraph.output <span class="hljs-keyword">import</span> GraphvizOutput<font></font>
<font></font>
graphviz = GraphvizOutput(output_file=<span class="hljs-string">'fastenum.png'</span>)<font></font>
<font></font>
<span class="hljs-keyword">with</span> PyCallGraph(output=graphviz):<font></font>
   v = get_name()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の画像でわかること：</font></font><br>
<img src="https://habrastorage.org/webt/le/ck/td/lecktd3dtx71oi3dmlyax7qyogu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはすべて、プロパティ</font></font><code>name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのメンバーに</font><font style="vertical-align: inherit;">アクセスするたびに、列挙型の標準実装内で実際に発生します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、実装がより高速である理由でもあります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python標準ライブラリの列挙型の実装では、データ記述子プロトコルを実装するオブジェクトへの多くの呼び出しを使用します。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは私たちのプロジェクトで標準列挙実装を使用しようとしたとき、私たちはすぐに呼び出されたどのように多くのデータ記述子に気づいた</font></font><code>name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、列挙型はコード全体で非常に広範囲に使用されたため、結果のパフォーマンスは低くなりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、標準のEnumクラスには、いくつかの補助的な「保護」属性が含まれています。</font></font><br>
<ul>
<li><code>_member_names_</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -列挙型のメンバーのすべての名前を含むリスト。</font></font></li>
<li><code>_member_map_</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>OrderedDict</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、列挙型メンバーの名前をその値にマップします。</font></font></li>
<li><code>_value2member_map_</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -反対方向のマッチングを含む辞書：対応する転送メンバーへの転送メンバーの値。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ディクショナリの検索は低速です。これは、各呼び出しがハッシュ関数の計算につながるためです（もちろん、結果は個別にキャッシュされますが、アンマネージコードでは常に可能とは限りません）。ハッシュテーブルでの検索により、これらのディクショナリは列挙の最適な基盤にはなりません。</font><font style="vertical-align: inherit;">（のように</font></font><code>StdEnum.MEMBER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">列挙型メンバーの検索</font><font style="vertical-align: inherit;">自体も辞書検索です。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのアプローチ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cのエレガントな列挙とJavaの美しい拡張可能な列挙を念頭に置いて、列挙の実装を作成しました。</font><font style="vertical-align: inherit;">自宅で実装したい主な機能は次のとおりです。</font></font><br>
<br>
<ul>
<li>      ;  «»    —  -          ,        (   ) ;</li>
<li>    (   «» ),        —       ,   ,    ,        ;</li>
<li>       ( ,   ..)</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
唯一のケースで辞書検索を使用します。これは</font></font><code>value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、列挙型メンバーへの</font><font style="vertical-align: inherit;">値の逆マッピングです</font><font style="vertical-align: inherit;">。他のすべての計算は、クラス宣言（メタクラスを使用して型の作成を構成する）中に一度だけ実行されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
標準ライブラリとは異なり、</font></font><code>=</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラス宣言の</font><font style="vertical-align: inherit;">符号の後の最初の値のみを</font><font style="vertical-align: inherit;">メンバー</font><font style="vertical-align: inherit;">の値として処理します</font><font style="vertical-align: inherit;">。</font></font><br>
<code>A = 1, 'One'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準ライブラリでは、タプル全体が</font></font><code>1, "One"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値</font><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">見なされます</font></font><code>value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<code>A: 'MyEnum' = 1, 'One'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちの実装では、それは</font></font><code>1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">値として</font><font style="vertical-align: inherit;">のみ</font><font style="vertical-align: inherit;">考慮されます</font></font><code>value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">可能な限り</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用</font></font><code>__slots__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すること</font><font style="vertical-align: inherit;">により、さらなる加速が実現され</font><font style="vertical-align: inherit;">ます。</font></font><code>__slots__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インスタンス</font><font style="vertical-align: inherit;">を使用して宣言されたPythonクラスは</font><font style="vertical-align: inherit;">属性を作成しません</font></font><code>__dict__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これには、属性名とその値のマッピングが含まれます（したがって、で言及されていないインスタンスのプロパティは宣言できません</font></font><code>__slots__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">さらに、で定義された属性の値</font></font><code>__slots__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、オブジェクトのインスタンスへのポインターの定数オフセットによってアクセスされます。</font><font style="vertical-align: inherit;">これは、ハッシュ計算とハッシュテーブルスキャンを回避するため、プロパティへの高速アクセスです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">余分なチップは何ですか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FastEnumはPython 3.6で実装された型注釈を普遍的に使用するため、3.6より前のバージョンのPythonと互換性がありません。</font></font><code>typing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyPiから</font><font style="vertical-align: inherit;">モジュールをインストールする</font><font style="vertical-align: inherit;">と役立つ</font><font style="vertical-align: inherit;">と想定できます</font><font style="vertical-align: inherit;">。短い答えはノーです。実装では、一部の関数、メソッド、および戻り値の型へのポインターの引数にPEP-484を使用しているため、構文の互換性がないため、Python 3.5より前のバージョンはサポートされていません。しかし、繰り返しになりますが、コードの最初の行は</font></font><code>__new__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メタクラスはPEP-526構文を使用して変数のタイプを示します。したがって、Python 3.5も機能しません。実装は古いバージョンに移植できますが、Qrator Labsでは通常、可能な限り型注釈を使用します。これは、複雑なプロジェクトの開発に大きく役立つためです。さて、最後に！新しいバージョンで既存のコード（あなたは、Python 2を使用していないことを提供する）とは、後方互換性がない、とするので、あなたは、バージョン3.6以前のPythonで立ち往生したくない</font></font><code>asyncio</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの作業が行われている</font><font style="vertical-align: inherit;">実装では</font><font style="vertical-align: inherit;">、私たちには、3.5に比べてすぐに更新する価値のある外観。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、特別なインポートが不要になります。</font></font><code>auto</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、標準ライブラリとは異なり。列挙のメンバーが値をまったく提供せずにこの列挙のインスタンスになることを示すだけで、値が自動的に生成されます。 FastEnumでの作業にはPython 3.6で十分ですが、辞書でのキーの順序の保持はPython 3.7でのみ導入されたことに注意してください（ケース3.6では個別に使用していません</font></font><code>OrderedDict</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。自動生成された値の順序が重要である例はわかりません。開発者が環境を提供して、値を生成し、列挙型メンバーに割り当てるタスクがあれば、値自体はそれほど重要ではないと想定しているためです。ただし、まだPython 3.7に切り替えていない場合は、警告が表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
列挙をデフォルト値（1）ではなく0（ゼロ）から開始する必要がある場合</font></font><code>_ZERO_VALUED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、結果のクラスに格納されない</font><font style="vertical-align: inherit;">列挙</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">宣言するときに、特別な属性を使用してこれを行うことができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、いくつかの制限があります。列挙型のメンバーの名前はすべて大文字で記述する必要があります。そうでない場合、メタクラスによって処理されません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、列挙型の基本クラスを宣言できます（基本クラスはメタクラス自体を使用できるため、すべてのサブクラスにメタクラスを提供する必要がないことに注意してください）-このクラスで一般的なロジック（属性とメソッド）を定義し、列挙型のメンバーを定義しないでください（したがって、クラスは「ファイナライズ」されません）。</font><font style="vertical-align: inherit;">このクラスの継承クラスを必要な数だけ宣言すると、相続人自身も同じロジックになります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エイリアスとそれらがどのように役立つか</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコードを使用しているとします。</font></font><br>
<pre><code class="python hljs">package_a.some_lib_enum.MyEnum</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MyEnumクラスは次のように宣言されています。</font></font><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyEnum</span>(<span class="hljs-params">metaclass=FastEnum</span>):</span>
  ONE: <span class="hljs-string">'MyEnum'</span>
  TWO: <span class="hljs-string">'MyEnum'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、リファクタリングを行い、リストを別のパッケージに転送することを決定しました。</font><font style="vertical-align: inherit;">あなたはこのようなものを作成します：</font></font><br>
<pre><code class="python hljs">package_b.some_lib_enum.MyMovedEnum</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MyMovedEnumは次のように宣言されています。</font></font><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyMovedEnum</span>(<span class="hljs-params">MyEnum</span>):</span>
  <span class="hljs-keyword">pass</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、古い住所にある乗換が廃止されたと見なされる段階の準備が整いました。この列挙のインポートと呼び出しを書き換えて、この列挙の新しい名前（そのエイリアス）が使用されるようにします。このエイリアス列挙のすべてのメンバーが、古い名前のクラスで実際に宣言されていることを確認できます。プロジェクトのドキュメントで、</font></font><code>MyEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非推奨であり、将来コードから削除される</font><font style="vertical-align: inherit;">ことを宣言し</font><font style="vertical-align: inherit;">ます。たとえば、次のリリースでは。コードが、を使用して列挙型メンバーを含む属性を持つオブジェクトを格納するとします</font></font><code>pickle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。この時点</font></font><code>MyMovedEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で、コード内</font><font style="vertical-align: inherit;">でを使用</font><font style="vertical-align: inherit;">しますが、内部的には列挙型のすべてのメンバーがインスタンス</font></font><code>MyEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。あなたの次のステップは、広告を交換することです</font></font><code>MyEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、</font></font><code>MyMovedEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのため、これは</font></font><code>MyMovedEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サブクラス</font><font style="vertical-align: inherit;">では</font><font style="vertical-align: inherit;">なく、</font></font><code>MyEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのすべてのメンバー自体を宣言します。</font></font><code>MyEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一方、はメンバーを宣言せず、単なるエイリアス（サブクラス）になり</font></font><code>MyMovedEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで全部です。この段階でアプリケーションを再起動する</font></font><code>unpickle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、列挙型のすべてのメンバーがインスタンスとして再宣言され</font></font><code>MyMovedEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、この新しいクラスに関連付けられ</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。データベースなどに格納されているすべてのオブジェクトが再デシリアライズされている（そしておそらくシリアライズされてリポジトリに格納されている）ことを確認した瞬間-以前に廃止されたクラスとしてマークされていた新しいリリースをリリースできます</font></font><code>MyEnum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より不必要に宣言され、コードベースから削除されるかもしれません。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ぜひお</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
試しください：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/QratorLabs/fastenum</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pypi.org/project/fast-enum</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カルマのプロは作者FastEnumに行く-</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サンチャゴコルケス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPDは：例えば、バージョン1.3.0には、既存のクラスから継承することが可能になりました</font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>float</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>str</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このような列挙型のメンバーは、同じ値（</font></font><code>IntEnum.MEMBER == int(value_given_to_member)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を持つクリーンなオブジェクトと等しいかどうかのテストに成功し</font><font style="vertical-align: inherit;">、もちろん、これらの継承されたクラスのインスタンスであることを示しています。</font><font style="vertical-align: inherit;">これにより、継承元の列挙型のメンバーを</font><font style="vertical-align: inherit;">pythonインタープリターの戻りコードとして</font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">直接引数</font></font><code>sys.exit()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にすることができます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja480598/index.html">...パズルのプログラミングの基礎</a></li>
<li><a href="../ja480606/index.html">フロントエンド開発者としてのスキルをアップグレードする方法に関する5つのアイデア（2019年12月）</a></li>
<li><a href="../ja480608/index.html">RustがC ++をベンチマークゲームの結果で上回る</a></li>
<li><a href="../ja480610/index.html">C ++ vtables。パート2（仮想継承+コンパイラー生成コード）</a></li>
<li><a href="../ja480612/index.html">Webデザインのアクセシビリティ基準を満たすようにこれらの変更を行ってください。</a></li>
<li><a href="../ja480618/index.html">電子ゲームTic Tac Toe。私は何に来ましたか</a></li>
<li><a href="../ja480620/index.html">管理者を支援するSD-WANとDNA：アーキテクチャの特徴と実践</a></li>
<li><a href="../ja480622/index.html">利用可能なストレージ容量を正しく使用する方法</a></li>
<li><a href="../ja480626/index.html">レガシーシステムとプロセスの継承またはCTOの役割における最初の90日間</a></li>
<li><a href="../ja480628/index.html">最初の15万件の本番インシデントを処理したときに、SREについて何を学びましたか</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>