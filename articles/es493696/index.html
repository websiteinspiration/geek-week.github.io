<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßïüèæ üë©üèº‚Äçüíª ‚õ™Ô∏è Acelerar el subsistema de disco Qemu KVM en Linux üëö üëã üë®üèª‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A veces asumo varias tareas para configurar servidores. Hace alg√∫n tiempo, el due√±o de una peque√±a empresa de hosting se me acerc√≥ con un problema int...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Acelerar el subsistema de disco Qemu KVM en Linux</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/493696/"><img src="https://habrastorage.org/webt/gx/ub/i1/gxubi1ucfhq7jujnimizriacaqa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A veces asumo varias tareas para configurar servidores. </font><font style="vertical-align: inherit;">Hace alg√∫n tiempo, el due√±o de una peque√±a empresa de hosting se me acerc√≥ con un problema interesante. </font><font style="vertical-align: inherit;">Le gustar√≠a ejecutar m√°quinas virtuales de Windows bajo KVM en sus servidores, donde Ubuntu 18.04 ya estaba instalado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, sus pruebas mostraron que el sistema de disco KVM se retras√≥ decentemente detr√°s de los indicadores que ten√≠a bajo Hyper-V. </font><font style="vertical-align: inherit;">Quer√≠a liberar qemu en sus servidores Ubuntu para evitar comprar costosas licencias de servidor de Windows (la versi√≥n gratuita de Microsoft Hyper-V Server no funcion√≥ debido a sus limitaciones).</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0. Disposici√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para las pruebas, utilizamos el SSD Samsung 970 Pro de 1TB. </font><font style="vertical-align: inherit;">El cliente verific√≥ los resultados del trabajo en CrystalDiskMark, por lo que m√°s adelante en el art√≠culo, todos los gr√°ficos de √©l.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows 10 LTSC</font></font></th>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">Hyper-V </font><font style="vertical-align: inherit;">2</font></font></th>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">KVM </font><font style="vertical-align: inherit;">2</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/h_/-8/n1/h_-8n1bwsgaovljitrm1wztowbi.png"></td>
<td><img src="https://habrastorage.org/webt/to/eh/ft/toehft7m0vaghk2a3vdlmkxdwq8.png"></td>
<td><img src="https://habrastorage.org/webt/-i/na/am/-inaamktv9beteru7huusvcktmo.png"></td>
</tr>
</tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El primer paso fue mejorar el rendimiento aleatorio de E / S. </font><font style="vertical-align: inherit;">Este tipo de carga es t√≠pico para las m√°quinas virtuales, especialmente aquellas que usan varias bases de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ubuntu (16.04 LTS y 18.04) todav√≠a usa qemu versi√≥n 2.11. </font><font style="vertical-align: inherit;">Por lo tanto, algunos de los √∫ltimos bollos qemu no se consideran en este art√≠culo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidimos que debemos evitar atar el hierro a una m√°quina virtual, ya que esto complica la portabilidad de las m√°quinas virtuales, por lo que las opciones para lanzar SSD / discos f√≠sicos / particiones en m√°quinas virtuales se consideraron indeseables.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acerca del tama√±o del archivo de prueba para CrystalDiskMark</font></font></b><div class="spoiler_text">   ,          100  4.   ,         :   ,    .<br>
<br>
,        ,  Windows       .    100  4    ,     40  .<br>
<br>
       ,      ,         100-1.         4.<br>
</div></div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Utilizamos vol√∫menes LVM, no archivos para almacenar discos de m√°quinas virtuales.</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La l√≥gica es esta. El archivo con el disco virtual se almacena en el sistema de archivos de Linux, NTFS se encuentra dentro del propio archivo. Cada sistema de archivos consume recursos durante las operaciones de disco. Por lo tanto, cuanto menor sea la profundidad de la mu√±eca, m√°s r√°pida ser√° la entrada / salida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si hablamos de archivos qcow2, su nombre significa "Qemu Copy-On-Write" y, de hecho, tienen su propia tabla de traducci√≥n dentro de la cual es responsable de qu√© bloques est√°n ocupados, cu√°les no y d√≥nde se encuentra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La capa LVM consume significativamente menos recursos de procesador que el sistema de archivos. Una de las razones de esto es que los bloques que contiene son mucho m√°s grandes que un bloque t√≠pico del sistema de archivos (4KB). Cuanto mayor sea el bloqueo (extensi√≥n) en el dispositivo LVM f√≠sico, m√°s r√°pido se produce IO y menor fragmentaci√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero incluso para SSD, la E / S aleatoria es mucho m√°s lenta que la serie. Por lo tanto, al crear el grupo de vol√∫menes, especificaremos una extensi√≥n muy grande: 256 MB. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La lectura anticipada de un volumen l√≥gico debe estar desactivada, ya que gasta IO sin ganar, ya que ahora nadie est√° desfragmentando discos en Windows en SSD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LVM es bastante conveniente de usar para alojar m√°quinas virtuales. Los vol√∫menes LVM son f√°cilmente transportables entre discos f√≠sicos; hay instant√°neas y redimensionamientos en l√≠nea. Adem√°s, virt-manager (libvirt) puede crear vol√∫menes l√≥gicos listos para usar para discos de m√°quinas virtuales del grupo Volumen.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La capacidad de crear vol√∫menes delgados tambi√©n parece atractiva, pero dado que un volumen delgado es una capa adicional de abstracci√≥n, es obvio que degradar√° el rendimiento de IO. </font><font style="vertical-align: inherit;">Adem√°s, libvirt no tiene una forma elegante de crear autom√°ticamente discos para m√°quinas virtuales en un grupo delgado.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#    SSD    (volume group)</span><font></font>
pvcreate /dev/nvme1n1p1<font></font>
<font></font>
<span class="hljs-comment">#    win    (extent) 256.</span><font></font>
vgcreate -s 256M win_pool /dev/nvme1n1p1<font></font>
<font></font>
<span class="hljs-comment">#    vm1.    C</span><font></font>
lvcreate -n vm1 -L 100G win_pool<font></font>
<font></font>
<span class="hljs-comment">#      (read ahead)</span><font></font>
lvchange -r none /dev/win_pool/vm1<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Volumen delgado como un disco y / o configuraciones de volumen l√≥gico para instant√°neas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si desea utilizar un grupo delgado en el que crear√° vol√∫menes delgados, entonces tiene sentido establecer el tama√±o del fragmento del grupo en 4 MB, que es mucho m√°s grande que el tama√±o predeterminado de 64 KB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo que implicar√° un trabajo m√°s r√°pido de esta capa de abstracci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El mecanismo de instant√°nea en LVM funciona casi en el mismo c√≥digo que los vol√∫menes delgados, por lo que la configuraci√≥n ser√° la misma para aumentar la velocidad de la instant√°nea.</font></font><br>
<br>
<pre><code class="bash hljs">lvcreate -c 4m -L 300G -T -Zn win_pool/thin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La opci√≥n </font></font><code>-Zn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deshabilita la sobrescritura del fragmento con ceros durante la selecci√≥n, lo que aumenta la velocidad del trabajo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configuraci√≥n para lvm.conf o un archivo similar (por ejemplo, lvmlocal.conf):</font></font><br>
<br>
<pre><code class="bash hljs">thin_pool_chunk_size = 4096<font></font>
thin_pool_zero = n</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede determinar el tama√±o √≥ptimo del fragmento completando la prueba con el siguiente comando, eligiendo el valor </font></font><code>--blocksize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">fio --name=randwrite --filename=/dev/nvme0n1p9 --size=10G --ioengine=libaio --iodepth=1 --buffered=0 --direct=1 --rw=randwrite --blocksize=4m</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede ver el tama√±o actual del fragmento con el comando:</font></font><br>
<br>
<pre><code class="bash hljs">lvs -ao name,chunksize</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Aumentar el n√∫mero de procesadores l√≥gicos asignados a cada m√°quina virtual KVM mejora el rendimiento del disco</font></font></h4><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 CPU</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/rk/d5/pp/rkd5pphdlwmwx0ykk_mszbtcxjc.png"></td>
<td><img src="https://habrastorage.org/webt/o6/0s/u-/o60su-evqzflfsjh4v0wl7ih8sa.png"></td>
<td><img src="https://habrastorage.org/webt/gv/0x/jf/gv0xjf7ky6xkidam9duclsztowo.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Est√° claro que casi nadie asignar√° 10 procesadores a la m√°quina virtual, pero fue interesante observar el caso extremo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ya depende de la cantidad de procesadores libres. </font><font style="vertical-align: inherit;">En mi opini√≥n, no es conveniente asignar m√°s de 4. </font><font style="vertical-align: inherit;">Con el n√∫mero de hilos igual a 8, obtuvimos el m√°ximo rendimiento de lectura y escritura aleatoria. </font><font style="vertical-align: inherit;">Esta es una especificidad de CrystalDiskMark 6.0.2, en la que la segunda prueba realiza 8 subprocesos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De lo cual podemos concluir que es bueno tener un procesador l√≥gico para cada tarea que use activamente IO.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Utilizamos grandes p√°ginas de memoria de acceso aleatorio (enormes p√°ginas) para evitar la degradaci√≥n del rendimiento debido a la fragmentaci√≥n de la RAM</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este paquete puede ser √∫til cuando necesitamos informaci√≥n diversa sobre p√°ginas enormes durante la operaci√≥n.</font></font><br>
<br>
<pre><code class="bash hljs">apt install hugepages</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Editar </font></font><code>/etc/default/grub</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">GRUB_CMDLINE_LINUX=<span class="hljs-string">"default_hugepagesz=1GB hugepagesz=1G hugepages=64"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, se asignaron 64 GB de memoria para todas las m√°quinas virtuales como p√°ginas enormes. </font><font style="vertical-align: inherit;">En su caso puede haber menos / m√°s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aplicamos esta configuraci√≥n a GRUB para que la pr√≥xima vez que se inicie el sistema, se activen:</font></font><br>
<br>
<pre><code class="bash hljs">grub-mkconfig -o /boot/grub/grub.cfg
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Edici√≥n de la configuraci√≥n de la m√°quina virtual:</font></font><br>
<br>
<pre><code class="bash hljs">virsh edit vm_name</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A√±adir:</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">memoryBacking</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">hugepages</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">memoryBacking</span>&gt;</span></code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Agregue una transmisi√≥n dedicada a cada m√°quina virtual para servir IO</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debe agregar lo que est√° resaltado en negrita. </font><font style="vertical-align: inherit;">Usamos </font></font><code>virsh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, como en el p√°rrafo anterior.</font></font><br>
<br>
<blockquote><b>&lt;iothreads&gt;1&lt;/iothreads&gt;</b><br>
<br>
&lt;disk type='block' device='disk'&gt;<br>
&lt;driver name='qemu' type='raw' cache='none' io='threads' <b>iothread='1'</b>/&gt;<br>
&lt;source dev='/dev/win/terminal'/&gt;<br>
&lt;target dev='vda' bus='virtio'/&gt;<br>
&lt;boot order='2'/&gt;<br>
&lt;address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/&gt;<br>
&lt;/disk&gt;</blockquote><br>
<br>
<h4>4.1.       writeback</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para acelerar la escritura accidental en el disco, pero con un mayor riesgo de p√©rdida de datos, puede usar </font></font><code>cache=writeback</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el p√°rrafo anterior. </font><font style="vertical-align: inherit;">Solo se puede usar si existe una gran confianza en la calidad y el respaldo de la energ√≠a y en presencia de respaldos.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. Configuraci√≥n del subsistema de disco en Virt Manager</font></font></h4><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bus de disco: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
formato de almacenamiento </font><font style="vertical-align: inherit;">VirtIO </font><font style="vertical-align: inherit;">: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
modo de cach√© sin </font><font style="vertical-align: inherit;">procesar </font><font style="vertical-align: inherit;">: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
modo IO de </font><font style="vertical-align: inherit;">reescritura </font><font style="vertical-align: inherit;">: subprocesos</font></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1. </font><font style="vertical-align: inherit;">Configurar un subsistema de disco a trav√©s de un archivo de configuraci√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qemu 2.11 (que actualmente usa Ubuntu) admite dos tipos de dispositivos virtuales de disco: virtio-blk y virtio-scsi. </font><font style="vertical-align: inherit;">Cuando se especifica en Virt Manager </font></font><code>Disk bus: VirtIO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, esto significa usar el dispositivo virtio-blk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En todos los casos, virtio-blk es mejor en velocidad, a pesar de que en la versi√≥n probada de qemu todav√≠a no era compatible con TRIM, a diferencia de virtio-scsi ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ya lo admite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> desde la versi√≥n 5.x </font><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde el punto de vista de la velocidad de E / S del disco, virtio-scsi solo tiene sentido en casos ex√≥ticos, por ejemplo, cuando necesita conectar cientos de discos a una m√°quina virtual.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. Durante la instalaci√≥n de Windows, instale el controlador VirtIO</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De lo contrario, el disco no estar√° disponible para el sistema operativo. </font><font style="vertical-align: inherit;">Para hacer esto, use la imagen del controlador, que conectamos previamente a la m√°quina virtual.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. Resultados despu√©s de aplicar todos los ajustes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, el tweak 4.1 no se us√≥, ya que no estaba seguro de la fiabilidad de la fuente de alimentaci√≥n del cliente.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">Hyper-V </font><font style="vertical-align: inherit;">2</font></font></th>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">KVM </font><font style="vertical-align: inherit;">2</font></font></th>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">KVM </font><font style="vertical-align: inherit;">4</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/to/eh/ft/toehft7m0vaghk2a3vdlmkxdwq8.png"></td>
<td><img src="https://habrastorage.org/webt/4a/la/5s/4ala5snjmars3uaepsbb63lcgqm.png"></td>
<td><img src="https://habrastorage.org/webt/fu/tt/0k/futt0kedtld37khc96igkyks1zq.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debe comprender que estos resultados tienen una convenci√≥n determinada, ya que cada vez que inicia CrystalDiskMark, los valores son ligeramente diferentes.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVM fuera de la caja </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 CPU</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KVM despu√©s de ajustes </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2 CPU</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/-i/na/am/-inaamktv9beteru7huusvcktmo.png"></td>
<td><img src="https://habrastorage.org/webt/4a/la/5s/4ala5snjmars3uaepsbb63lcgqm.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos que fue posible acelerar significativamente el trabajo del subsistema de disco en qemu (kvm) con el mismo n√∫mero de n√∫cleos. </font><font style="vertical-align: inherit;">La escritura se aceler√≥ en un promedio de 58% y la lectura en un 25%. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elementos clave de √©xito</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : uso de vol√∫menes LVM en lugar de archivos qcow2, E / S separadas y grandes p√°ginas. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dirija los errores notados al PM. </font><font style="vertical-align: inherit;">Aumento el karma para esto.</font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS vhost-user-blk y vhost-user-nvme</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante los experimentos, Qemu 2.12 y la versi√≥n 3 tambi√©n se compilaron. </font><font style="vertical-align: inherit;">Se prob√≥ la opci√≥n vhost-user-blk para un disco. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final, funcion√≥ peor que virtio-blk.</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CPU </font><font style="vertical-align: inherit;">vhost-user-blk </font><font style="vertical-align: inherit;">4</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU virtio-blk </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4</font></font></th>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/x_/zw/04/x_zw04o-k8gq4so3yvyp66ddyga.png"></td>
<td><img src="https://habrastorage.org/webt/fu/tt/0k/futt0kedtld37khc96igkyks1zq.png"></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para usar vhost-user-nvme era necesario parchear qemu, esta opci√≥n complicaba la actualizaci√≥n autom√°tica de los servidores en producci√≥n, por lo que no se prob√≥.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPS SPDK</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intel dise√±√≥ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este marco</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para lograr indicadores de rendimiento sobresalientes para sistemas de disco en m√°quinas virtuales que deber√≠an ejecutarse en sus procesadores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que spdk funcione bien, recurren a muchos trucos: le asignan n√∫cleos separados, colocan los n√∫cleos de m√°quina virtual y spdk en un z√≥calo. Cargue la m√°quina virtual en una porci√≥n contigua de memoria. Si aplica tales medidas al virtio-blk regular, tambi√©n funcionar√° m√°s r√°pido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SPDK es capaz de trabajar en 3 modos: vhost-user-scsi, vhost-user-blk y vhost-user-nvme. El segundo modo solo est√° disponible en qemu desde 2.12, que a√∫n no est√° disponible en ubuntu. El modo vhost-user-nvme es generalmente megaexperimental: debe parchear qemu para ello. Actualmente, solo la emulaci√≥n scsi funciona y es lenta.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay una limitaci√≥n m√°s seria para el modo vhost-user-scsi: spdk no puede ser arrancable.</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aseg√∫rese de que la opci√≥n bootindex = 2 Qemu est√© disponible en el dispositivo vhost-user-scsi-pci.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los registros se establecen cuando usan su controlador para compartir SSD en m√∫ltiples dispositivos y reenviarlos como vhost-user-nvme. </font><font style="vertical-align: inherit;">El enfoque de perforaci√≥n de hierro no nos conven√≠a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La impresi√≥n era que era normal usar SPDK solo con su implementaci√≥n de discos l√≥gicos (que es completamente diferente de lvm est√°ndar). </font><font style="vertical-align: inherit;">Esta es una bicicleta hecha a s√≠ misma con sus im√°genes y clonaci√≥n. </font><font style="vertical-align: inherit;">Los equipos son todos diferentes de LVM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La dificultad en la configuraci√≥n de SPDK, el soporte y la portabilidad de las m√°quinas virtuales, as√≠ como la conexi√≥n a los procesadores Intel, se alejaron de su uso.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expresiones de gratitud</font></font></h4><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gracias por la imagen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TripletConcept</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es mejor verlo en tama√±o completo en una ventana separada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para obtener permiso para compartir materiales de trabajo:</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">st_neon</font></font></a></i><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede solicitar una m√°quina virtual con SSD de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RUVDS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para el cup√≥n a continuaci√≥n. </font><b><i><font style="vertical-align: inherit;">Dirija los errores notados al PM. </font></i></b><b><i><font style="vertical-align: inherit;">Aumento el karma para esto.</font></i></b></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a><br>
<br>
<b><i><font style="vertical-align: inherit;"></font></i></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es493682/index.html">C√≥mo elegir inversiones a largo plazo: 6 acciones de la cartera de Warren Buffett</a></li>
<li><a href="../es493686/index.html">El misterioso origen del juego de mesa sobre pirater√≠a de c√≥digos Mastermind</a></li>
<li><a href="../es493688/index.html">Hacemos que Microsoft Teams sea gratuito: mant√©ngase en contacto con colegas en este momento dif√≠cil</a></li>
<li><a href="../es493690/index.html">20 consejos para el piloto DJI Mavic Mini para proteger tu dron de accidentes y p√©rdidas</a></li>
<li><a href="../es493692/index.html">Estructuras de datos te√≥ricos y su aplicaci√≥n en JavaScript. P1 Parejas</a></li>
<li><a href="../es493700/index.html">Uso de malware en Azure para obtener acceso a inquilinos de Microsoft 365</a></li>
<li><a href="../es493702/index.html">Transici√≥n masiva al trabajo remoto: problemas t√©cnicos y amenazas a la seguridad.</a></li>
<li><a href="../es493704/index.html">Usar TypeScript en JavaScript sin escribir TypeScript</a></li>
<li><a href="../es493706/index.html">Conoce a tu enemigo: crea una puerta trasera Node.js</a></li>
<li><a href="../es493708/index.html">Anatom√≠a de mi hogar Kubernetes cluster</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>