<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌑 🛒 👃🏾 Facebook Webhook処理の進化：1秒あたり0から25,000に 👩🏽‍💼 💅🏿 🔍</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ほとんどの場合、誰もwebhookを知る必要はありません。ただし念のため、Webhookは外部システムでイベントを報告するためのメカニズムです。たとえば、オンラインレジを介してオンラインストアで購入する、GitHubリポジトリにコードを送信する、チャットでのユーザーアクションなどです。典型的なAPI...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Facebook Webhook処理の進化：1秒あたり0から25,000に</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486844/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ほとんどの場合、誰もwebhookを知る必要はありません。ただし念のため、Webhookは外部システムでイベントを報告するためのメカニズムです。たとえば、オンラインレジを介してオンラインストアで購入する、GitHubリポジトリにコードを送信する、チャットでのユーザーアクションなどです。典型的なAPIでは、ユーザーがチャットで何かを書いた場合は、常にサーバーに照会する必要があります。 Webhookメカニズムを使用すると、通知を「サブスクライブ」でき、イベントが発生するとサーバー自体がHTTPリクエストを送信します。これは、サーバー上で常に新しいデータを要求するよりも便利で高速です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/xp/4l/t8xp4lbyixxglmd2wlzdjkzgrbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ManyChatは、企業がインスタントメッセンジャーのチャットを介して顧客と通信するのに役立つプラットフォームです。 Webhookは、ビジネスを通じて顧客と通信するため、ManyChatの重要な部分の1つです。そして、彼らは多くのことをやり取りします。たとえば、企業は月に何十億ものメッセージを顧客に送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのメッセージはFacebook Messengerを介して送信されます。遅いAPIという機能があります。顧客がピザを注文するメッセージを書き込むと、FacebookはWebhookをManyChatに送信します。プラットフォームはそれを処理し、リクエストを送り返し、ユーザーはメッセージを受け取ります。 APIが遅いため、リクエストによっては数秒かかる場合があります。しかし、プラットフォームが長時間応答しない場合、ビジネスはクライアントを失い、FacebookはアプリケーションをWebhookから切断できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、Webhookの処理は、プラットフォームの主要なエンジニアリングタスクの1つです。</font><font style="vertical-align: inherit;">この問題を解決するために、ManyChatはYiiのシンプルなコントローラーからGalaxiesを備えた分散システムに3年間で数回処理アーキテクチャーを変更しました。</font><font style="vertical-align: inherit;">詳細については、ドミトリークシニコフ（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャンセラリウス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dmitry Kushnikovは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ManyChat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">開発を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">主導</font></a><font style="vertical-align: inherit;">し、2001年から専門的にPHPのプログラミングを行っています。</font><font style="vertical-align: inherit;">Dmitryは、サービスと負荷の増加に伴ってアーキテクチャがどのように変化したか、さまざまな段階で適用されたソリューションとテクノロジー、Webhook処理がどのように進化したか、およびプラットフォームがPHPの適度なリソースを使用して巨大な負荷に対処する方法を説明します。</font></font><br>
<br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意。</font><font style="vertical-align: inherit;">この記事は、</font></font></em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP Russia 2019の</font></font></em></a><font style="vertical-align: inherit;"><em><font style="vertical-align: inherit;"> Dmitryのレポート「The Facebook webhook processing of the zero to 1 to 12,500 per second」に基づいてい</font></em></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">しかし、彼が準備している間に、指標は25,000に上昇しました。</font></font></em><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Hiy3Wv1mqHM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ManyChatとは</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、私たちのタスクのコンテキストを紹介します。 ManyChatは、企業がマーケティング、販売、サポートのためにインスタントメッセンジャーを使用できるようにするサービスです。主な製品は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Facebook MessengerのMessengerマーケティング用プラットフォームです</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 3年間、世界100か国の100万を超える企業がこのサービスを使用して、7億人の顧客と通信しました。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアント側</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では、このようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ca/r8/8d/car88depa1ktozsq9z_pnfgkwoe.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Facebook Messengerのダイアログにあるボタン、写真、ギャラリー。</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
これはFacebook Messengerインターフェースです。テキストメッセージに加えて、それは顧客と対話する対話要素を送信し、対話を行い、彼らの製品への関心を高め、販売することができます。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネス側から</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてが異なって見えます。</font><font style="vertical-align: inherit;">これは、ビジュアルインターフェイスを使用して、ビジネス担当者が対話スクリプトを作成およびプログラムするWebアプリケーションのインターフェイスです。</font><font style="vertical-align: inherit;">写真はシナリオの一例です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4f/n5/qv/4fn5qvo7pcwuqmojh3zsyzjru4q.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのシステムの中心はFlow Builderコンポーネントです。</font></font></em><font style="vertical-align: inherit;"><strong><font style="vertical-align: inherit;">ボット</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
と呼ばれるスクリプトと自動化ルールのセット</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">したがって、簡単にするために、ManyChatはボットデザイナーであると言えます。</font><em><font style="vertical-align: inherit;">ボットの例。</font></em><font style="vertical-align: inherit;">
対話の</font><font style="vertical-align: inherit;">ためにクライアント</font><strong><font style="vertical-align: inherit;">がボットにサブスクライブする</font></strong><font style="vertical-align: inherit;">ため</font><font style="vertical-align: inherit;">、対話に参加するビジネスのクライアントは</font><strong><font style="vertical-align: inherit;">サブスクライバー</font></strong><font style="vertical-align: inherit;">と呼ばれ</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/ix/i2/3m/ixi23mwbcq56ue2zcoyhyqjcy-e.png"><br>
<em><font style="vertical-align: inherit;"></font></em><br>
<br><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜFacebook</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜフェイスブックメッセンジャー、私たちは生き残った電報の国ですか？</font><font style="vertical-align: inherit;">これには理由があります。</font></font><br>
<br>
<ul>
<li>Telegram   ,  <strong>     №1  Facebook</strong>.   1,5  ,   Telegram  200-300 .</li>
<li><strong> Facebook   </strong>,      .       ,    Facebook   -     .</li>
<li>  Facebook   F8  -    <strong>300  </strong>.        Facebook Messenger.          20  . ManyChat    40%.</li>
</ul><br>
<h3>  Facebook</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Facebookとのやり取りは次のよう</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/_m/gw/y9_mgwxr-h-8dm1hzmnobmnvmsk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
に構成されています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ビジネスはWebアプリケーションを使用してボットのロジックを構成します。</font><font style="vertical-align: inherit;">クライアントが電話を介してボットとやり取りすると、Facebookはこの情報を受け取り、Webhookを送信します。</font><font style="vertical-align: inherit;">ManyChatは、ビジネスによってプログラムされたロジックに応じてそれを処理し、要求を返します。</font><font style="vertical-align: inherit;">次に、Facebookはメッセージをユーザーの電話に配信します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">技術スタック</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
適度なスタックでこれをすべて行います。</font><font style="vertical-align: inherit;">もちろん、コアはPHPです。</font><font style="vertical-align: inherit;">WebサーバーはNginxを実行し、メインデータベースはPostgreSQLです。RedisとElasticsearchもあります。</font><font style="vertical-align: inherit;">それはすべてアマゾンウェブサービスクラウドで回転します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Facebook Webhookの処理</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Facebookのウェブカメラは次のようになります。これは、JSON形式のペイロードを含むリクエストです。</font></font><br>
<br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"object"</span>:<span class="hljs-string">"page"</span>,
    <span class="hljs-attr">"entry"</span>:[<font></font>
        }<font></font>
            <span class="hljs-string">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span>,
            <span class="hljs-string">"time"</span>:<span class="hljs-number">1458692752478</span>,
            <span class="hljs-string">"messaging"</span>:[<font></font>
                {<font></font>
                    <span class="hljs-attr">"sender"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PSID&gt;"</span><font></font>
                    },<font></font>
                    <span class="hljs-attr">"recipient"</span>:{
                        <span class="hljs-attr">"id"</span>:<span class="hljs-string">"&lt;PAGE_ID&gt;"</span><font></font>
                    },<font></font>
<font></font>
                    ...<font></font>
                }<font></font>
            ]  <font></font>
        }<font></font>
    ]<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Webhookは負荷の10％にすぎませんが、システムの最も重要な部分です。</font><font style="vertical-align: inherit;">それらを介して、ビジネスはユーザーと通信します。</font><font style="vertical-align: inherit;">メッセージが遅くなったり送信されなかったりすると、ユーザーはボットとのやり取りを拒否し、ビジネスはクライアントを失います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
製品の発売以来のアーキテクチャの進化を見てみましょう。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2016年5月</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">サービスを開始しました。20のボット、そのうち10はボット、20はサブスクライバーです。</font><font style="vertical-align: inherit;">負荷は0 RPSでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
相互作用スキームは次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o9/g0/4h/o9g04hhven61_yy9lgtam45cosk.png"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエストはnginxに送信されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NginxはPHP-FPMにアクセスします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP-FPMはアプリケーションをYiiまで使用します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webhookコントローラーはロジックを処理し、それに従ってFacebookにリクエストを送信します。</font></font></li>
</ul><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NginxとPHP-FPMの束</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2016年6月</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。1か月後、ProductHuntでManyChatを発表し、ボットの数が2,000に増えました。</font><font style="vertical-align: inherit;">加入者数は7000人に増えました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で、システムに最初の問題が発生しました。</font><font style="vertical-align: inherit;">Facebook APIはそれほど高速ではありません。要求によっては数秒かかる場合もあれば、数十秒かかる場合もあります。</font><font style="vertical-align: inherit;">しかし、Webhookサーバーは迅速な応答を求めています。</font><font style="vertical-align: inherit;">APIが遅いため、長い間応答しません。サーバーが最初に誓ってから、アプリケーションをWebhookから完全に切断できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーはほとんどいない、私たちはまだアプリケーションを開発していて、私たちは私たちの市場、聴衆を探しており、負荷の問題はすでに現れています。</font><font style="vertical-align: inherit;">しかし、私たちはシンプルなソリューションによって救われました：</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コントローラーが起動した時点で、Facebookへのアクセスを中断します</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Facebookにはすべて問題ないことを伝えますが、バックグラウンドではリクエストとWebhookを処理します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/ww/ku/uawwkuo6kpyu7_4cxib5btfvasq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQLのキュー</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2016年12月。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスは5〜10倍に成長しました。1万のボットと70万の加入者です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、統計の表示、メッセージ配信、インプレッションの変換、遷移などの新しいタスクにも取り組みました。</font><font style="vertical-align: inherit;">ライブチャットも実装。</font><font style="vertical-align: inherit;">対話の自動化に加えて、企業はメッセージをサブスクライバーに直接書き込むことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの問題の解決策により、追跡されるフックの数が4倍になりました。</font><font style="vertical-align: inherit;">送信したメッセージごとに、さらに3つのWebhookを受信しました。</font><font style="vertical-align: inherit;">処理システムを再度改善する必要がありました。</font><font style="vertical-align: inherit;">私たちは小さなプラットフォームで、バックエンドで作業したのはたった2人なので、PostgreSQLのキューという最も単純なソリューションを選択しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まだ複雑なシステムを実装したくないので、処理フローを共有するだけです。</font><font style="vertical-align: inherit;">ユーザーが応答を受け取るために迅速に処理する必要があるWebhookは、同期的に処理されます。</font><font style="vertical-align: inherit;">残りはすべて、非同期リクエストのキューに入れて送信されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/05/xo/c8/05xoc80prmektoowus0ogzrxqks.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redisのキュー</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2017年6月。</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスは拡大しています。ボット75,000、加入者700万。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別の新機能を実装しています。私たちが処理したすべてのWebhookは、メッセンジャーでの通信のみに関係しました。しかし今、私たち</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はビジネスにビジネスページのサブスクライバー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と通信する機会を与えることを決定し</font><font style="vertical-align: inherit;">、ページ自体のフィードに関連する新しいタイプのWebhookの処理を開始しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスページフィードが頻繁に更新されることはありません。マーケティング担当者はしばしば何かを投稿し、それから彼らはそれぞれのようにフォローし、それらを数えます。ビジネスページに大量のトラフィックはありません。ただし、逆の状況もあります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ケイティペリーデー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ケイティ・ペリーは世界中で多くのファンを持つ有名なアメリカの歌手です。</font><font style="vertical-align: inherit;">彼女のFacebookグループだけで6400万人の購読者がいます。</font><font style="vertical-align: inherit;">ある時点で、歌手のマーケティング担当者はFacebook Messengerでボットを作成することを決定し、プラットフォームを選択しました。</font><font style="vertical-align: inherit;">その時点で、ボットをサブスクライブするように求めるメッセージを発行したとき、負荷は3〜4倍に増加しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この状況は、キューの通常の実装なしでは何もできないことを理解するのに役立ちました。</font><font style="vertical-align: inherit;">解決策として、彼らはRedisを選択しました。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キューにRedisを選択することは、素晴らしい決断です。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">彼は膨大な数の問題の解決を助けました。現在、Redisクラスターを介して毎秒100万の異なるリクエストを渡します。すべてのカスケードキューだけでなく、監視などの他のタスクにも使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Redisのキューは最初の試行では実装されませんでした。 Redisでwebhookを折りたたみ、1つのプロセスで処理することを開始したとき、上部のファネルを拡張しました。処理される着信webhookも多くありましたが、プロセス自体にはまだ時間がかかりました。この最初の決定は失敗しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/57/3u/kq/573ukqmfkwheeseoxvkdadulp54.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らがこれらのリクエストの数をスケーリングしようとしたとき、わずかな崩壊がありました。キューはさまざまなページからの要求を蓄積できますが、1つのページからの要求は続けて入ることができます。 1つのハンドラーが遅い場合、1つのサブスクライバーと1つのボットからの要求が誤った順序で処理されます。ユーザーはメッセージを送信し、ボットでいくつかのアクションを実行しますが、ランダムに応答を受信します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fk/vc/fd/fkvcfdcbeisa-ew7hcvusczdags.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはまれなケースのようですが、ワークロードをテストすると、これが頻繁に発生することが示されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは別の解決策を探し始めました。ここで、Redisのシンプルさとパワーが役に立ちました</font><font style="vertical-align: inherit;">。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ボットごとにキュー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を作成することにしました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jh/zy/7f/jhzy7fcdcsjc4x7yatu6pbde3xw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使い方？各ボットに関連するメッセージがキューに追加されます。ハンドラを各キューに上げないようにするために、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">制御キュー</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を作成しました</font><font style="vertical-align: inherit;">。彼女はそのように働きます。リクエストがボットから送信されるたびに、2つのメッセージがRedisで公開されます。1つはボットのキューに、もう1つはコントロールにあります。ハンドラーはコントロールを監視し、ボットを処理するタスクがあるときにデーモンを起動するたびに監視します。デーモンは対応するボットのキューをレイクします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主なタスクに加えて、「騒々しい隣人」の問題を解決しました。これは、1つのボットが大量のWebhookを生成し、他のページが処理を待機しているためにシステムの速度が低下した場合です。問題を解決するには、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケーリング</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するだけで十分</font><font style="vertical-align: inherit;">です。制御キューがいっぱいになると、新しいハンドラーを追加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キューは仮想</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">これらはRedisメモリ内の単なるセルです。</font><font style="vertical-align: inherit;">キューに何もない場合、それは存在せず、何も占有しません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHP</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2018年1月</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。毎月10億の投稿に達しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
負荷はシステムあたり5000 RPSでした。これはピーク時の負荷ではなく、標準です。有名な歌手のボットが登場すると、この数字からすでにすべてが数倍に成長しています。しかし、それは問題ではありません。問題はPHP-FPMにあります。5000RPSの負荷に耐えられなくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当時の誰もがファッショナブルな非同期処理について話していました。私たちはそれをさらに詳しく見て、ReactPHPを見て、簡単なテストを行い、PHP-FPMに置き換えて、即座に4倍に増加しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qs/5r/ik/qs5rikje32_otggcyz--ow8fj4g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
処理の書き換えは行っていません。ReactPHPはYiiフレームワークを作成しました。最初に、4つのReactPHPサービスを調達し、その後30に達しました。長い間、それらのサービスを利用し、フレームワークは負荷に対処しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
じょうごを拡張するとすぐに、別の崩壊が起こりました。受付でじょうごを開始した後、処理は再び悪化し始めました。</font><font style="vertical-align: inherit;">この問題を解決するために、処理をクラスターに分割することにしました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスター</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らはボットを取得してクラスターに分散し、Redis、Postgres、ハンドラーから論理チェーンを構築しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cj/mw/oc/cjmwoc_unxshst1gpdu-gbyl_le.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、私たちは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ギャラクシー」の</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">概念を形成しました</font><strong><font style="vertical-align: inherit;">-処理に対する論理的な物理的な抽象化</font></strong><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">インスタンス：Redis、PostgreSQL、および一連のPHPサービスで構成されます。</font><font style="vertical-align: inherit;">各ボットは特定のクラスターに属しており、ReactPHPはこのボットのメッセージを配置する必要があるクラスターを認識しています。</font><font style="vertical-align: inherit;">上記のスキームはさらに機能します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ml/ey/sc/mleyscad0juq-izrevpl_huwi8i.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
宇宙は拡大しており、私たちのシステムの宇宙も拡大しています。これが発生すると、新しい「銀河」が追加されます。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">銀河は私たちのスケーリングの方法です。</font></font></blockquote><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHPをNginxとLuaの束で置き換える</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の6か月間、私たちは成長を続けました。1か月あたり2億人のサブスクライバーと30億のメッセージです。</font><font style="vertical-align: inherit;">同じ負荷で、2億人の登録ユーザーがいるサイトを想像してみてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい問題が発生しました。</font><font style="vertical-align: inherit;">Webhookは同じタイプの小さなタスクであり、PHPはそれらを解決するのに適していません。</font><font style="vertical-align: inherit;">ReactPHPでさえ役に立たなくなった。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">彼は1万RPSの負荷に対処できませんでした-ReactPHPの導入以来、負荷は増加しています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに、受信Webhookの処理を中断することができないため、デプロイメントの場合でも、シーケンシャルに再起動する必要がありました。</font><font style="vertical-align: inherit;">Facebookは、問題があることを認識したときにアプリケーションを無効にします。</font><font style="vertical-align: inherit;">ManyChatにとって、これは災害です。65万のアクティブに運営されているビジネスは私たちを許しません。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ReactPHPとは異なるロジックを徐々に削除し、それをプロセッサに渡し、新しいキューを分離しました。その過程で、彼らは</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHPが1つの単純なタスクを実行する</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことに気づき</font><strong><font style="vertical-align: inherit;">ました</font></strong><font style="vertical-align: inherit;">。</font><strong><font style="vertical-align: inherit;">それは、Webhookを取得してキューに入れること</font></strong><font style="vertical-align: inherit;">です。残りはすべて処理によって行われます。そのような単純なタスクの類似物はありますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nginxにはモジュールがあることを思い出し、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenResty</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリに気づきました</font><font style="vertical-align: inherit;">。 Luaプログラミング言語をサポートすることに加えて、彼女はRedisと連携するためのモジュールも持っていました。 3時間で書かれたテストは、ReactPHPの30のサービスのすべての作業がnginx側で直接実行できることを示しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/cm/yf/aycmyfs312-ozvcqs9fvdbt0mny.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが結果です。ある種のエンドポイントを処理し、リクエストの本文を取得して、Redisに直接追加します。</font></font><br>
<br>
<pre><code class="nginx hljs"><span class="hljs-attribute">location</span> / {
    <span class="hljs-attribute">error_log</span> /var/log/nginx/error.log;<font></font>
<font></font>
    <span class="hljs-attribute">resolver</span> <span class="hljs-comment">###resolver###;</span><font></font>
<font></font>
    content_by_lua <span class="hljs-string">'

        ngx.req.read_body()
        local mybody = ngx.req.get_body_data()

        if not mybody then
            return ngx.exit(400)
        end

        local hash = ngx.crc32_long(mybody)
        local cluster = hash % ###wh_inbound_shards### + 1

        local redis = require "resty.redis";
        local red = radis.new()
        red:set_timeout(3000)

        local ok, err = red:connect("###redisConnectionWh2.server.host###", 6379)
		
        if not ok then
            ngx.log(ngx.ERR, err, "Redis failed to connect")
            return ngx.exit(403)
        end

        local ok, err = red:rpush("###wh_inbound_queue###" .. queuesuffix .. cluster, mybody)
        
        if not ok then
            ngx.log(ngx.ERR, err, "Failed to write data", mybody)
            return ngx.exit(500)
        end

        local ok, err = red:set_keepalive(10000, 100)

        ngn.say("ok")
    '</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OpenRestyとLuaはスループットの向上に貢献しています。</font><font style="vertical-align: inherit;">私たちはワークロードに対処し続け、サービスは存続し、誰もが幸せです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luaでのソリューションの改善</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最終段階（</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注：レポートの時点</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）は</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2019年2月です</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">5億人のサブスクライバーが毎月100万のボットから700万のメッセージを送受信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、Luaのソリューションを改善するためのステップです。</font><font style="vertical-align: inherit;">徐々にいくつかのロジックをキューから切り離し、システム間でWebhookを配布する主要な処理をLuaに転送します。</font><font style="vertical-align: inherit;">現在、私たちのシステムはより生産的で依存性が低くなっています。</font><strong><font style="vertical-align: inherit;">独立した処理と非同期処理</font></strong></font><br>
<br>
<img src="https://habrastorage.org/webt/07/9u/ci/079uci4cp73vm1_ocbdyla05fc8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を維持</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">します</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">処理は統計などに関係しますが、現在は完全に異なるシステムになっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムはシンプルに見えますが、そうではありません。</font><font style="vertical-align: inherit;">内部では、要求を処理する500のサービスがあります。</font><font style="vertical-align: inherit;">システム全体は、50のAmazonインスタンス（Redis、PostgreSQL、およびPHPハンドラー自体）で実行されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">進化の処理</font></font></h2><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHPでHighloadを行うのはクールです。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システム開発の過程でこれをどのように行ったかを簡単に思い出してください。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常のNginxとPHP-FPMから始めました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL、Redisにキューを追加しました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスタリングを追加しました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHPを実装しました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactPHPを一連のNginxとLuaに置き換え、後でロジックをそのグループに移動しました。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/e4/l4/z_/e4l4z_wwdlb9amca7hywk_exaha.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの経験から、脆弱な部分を連続的に変更し、スタックを拡張せずに、単純な既知のアプローチを使用して、アーキテクチャを成長および構築できることがわかりました。</font></font><br>
<br>
<blockquote>        ,        ,     11   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">TeamLead Conf</a>.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a> ,    LeSS,       .<br>
<br>
       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">PHP Russia</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Saint HighLoad++</a>,         .     PHP   ,            — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>  PHP Russia 13 .     highload  PHP,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  Saint HighLoad++    .</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja486824/index.html">ANTLRを使用する際の悪いアドバイス</a></li>
<li><a href="../ja486826/index.html">Django 2とViber REST APIで本格的なViberbotを作成します。パート1-Webhook</a></li>
<li><a href="../ja486828/index.html">フードデザインダイジェスト、2020年1月</a></li>
<li><a href="../ja486832/index.html">タイガは何年ですか-わかりません</a></li>
<li><a href="../ja486842/index.html">領事+ iptables =：3</a></li>
<li><a href="../ja486850/index.html">新しい指定席-カプセルホテルのよう</a></li>
<li><a href="../ja486858/index.html">本格的なViberbotの作成。パート2-最初の連絡先または「conversion_started」</a></li>
<li><a href="../ja486860/index.html">ATX12VO-新しい方法を食べる</a></li>
<li><a href="../ja486862/index.html">モーションデザインが人とのつながりを助ける5つの理由</a></li>
<li><a href="../ja486864/index.html">OpenVPNからWireGuardに移行してネットワークを1つのL2ネットワークに結合する</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>