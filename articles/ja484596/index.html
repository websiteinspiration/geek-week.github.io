<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧔🏼 💕 😚 Blazorクライアント側オンラインストア：パート1-認証OIDC（OAuth2）+ Identity Server4 🤱🏿 🧝🏾 🈲</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！だから、はい、前回の記事で私はBlazor WasmでTodoリストを作成しようとしましたが、満足しました。今、私はそれを試すために、真剣に何かをとることに決めました。シンプルな架空のオンラインストアのBlazorでシンプルなSPA UIを作成します。戦闘オプションにできる限り近...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Blazorクライアント側オンラインストア：パート1-認証OIDC（OAuth2）+ Identity Server4</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484596/"><img src="https://habrastorage.org/webt/0d/by/eu/0dbyeudmd_chabkph5lsogj4gnm.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
こんにちは、ハブル！</font><font style="vertical-align: inherit;">だから、はい、前回の記事で私はBlazor WasmでTodoリストを作成しようとしましたが、満足しました。</font><font style="vertical-align: inherit;">今、私はそれを試すために、真剣に何かをとることに決めました。</font><font style="vertical-align: inherit;">シンプルな架空のオンラインストアのBlazorでシンプルなSPA UIを作成します。</font><font style="vertical-align: inherit;">戦闘オプションにできる限り近い。</font><font style="vertical-align: inherit;">まず、ユーザーの承認とロールによるユーザーの分離を記録します。つまり、管理者と一般ユーザーには少し異なるインターフェースが表示されます。</font><font style="vertical-align: inherit;">これもすべてDockerイメージに収集して、Dockerレジストリにアップロードしました。</font><font style="vertical-align: inherit;">詳しくは猫へようこそ。</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
小さなものは、承認とPWAサポートを備えたwasm用のアプリケーションをすぐに作成する機能を追加しました。</font><font style="vertical-align: inherit;">承認用の新しいライブラリを追加しました。</font><font style="vertical-align: inherit;">この記事で説明することはすべて、はるかに簡単になりました。</font></font><br>
<img src="https://habrastorage.org/webt/wi/zf/bl/wizfblynb2fb0vhu3lwozg2ml1s.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツ</font></font></h2><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blazor + MVVM = Silverlightが反撃し、古代の悪は無敵です</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blazorクライアント側オンラインストア：パート1-認証OIDC（OAuth2）+ Identity Server4</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blazorクライアント側オンラインストア：パート2-CI / CD</font></font></a></li>
</ul><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参考文献</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Dockerレジストリの</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">イメージソース</font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発売</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私のイメージをダウンロードする必要があるため、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
compose（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">tyk</font></a><font style="vertical-align: inherit;">）で</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">docker</font></a><font style="vertical-align: inherit;">がすでにインストールされて</font><font style="vertical-align: inherit;">おり、インターネットが接続されている必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マイクロサービスが機能するために必要な証明書を作成するには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.netコア</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">インストールし</font><font style="vertical-align: inherit;">、Windows PowerShellでこれらのコマンドを実行します。</font></font><br>
<br>
<pre><code class="bash hljs"> dotnet --info<font></font>
 dotnet dev-certs https --trust<font></font>
 dotnet dev-certs https -ep <span class="hljs-variable">$env</span>:APPDATA\ASP.NET\Https\blazor-eshop-api.pfx -p 1234Qwert<font></font>
 dotnet dev-certs https -ep <span class="hljs-variable">$env</span>:APPDATA\ASP.NET\Https\blazor-eshop-spa-angular.pfx -p 1234Qwert<font></font>
dotnet dev-certs https -ep <span class="hljs-variable">$env</span>:APPDATA\ASP.NET\Https\blazor-eshop-spa-blazor.pfx -p 1234Qwert<font></font>
dotnet dev-certs https -ep <span class="hljs-variable">$env</span>:APPDATA\ASP.NET\Https\blazor-eshop-sso.pfx -p 1234Qwert
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトを開始するには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker-compose.ymlファイル</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をダウンロード</font><font style="vertical-align: inherit;">（またはその内容を同じ名前のファイルにコピー）し、このファイルが配置されているディレクトリでdocker-compose upコマンドを実行する必要があります。</font><font style="vertical-align: inherit;">マイクロサービスは、アドレス</font></font><br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https：// localhost：8000 </font></font></a></b> <br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https：// localhost：8001 </font></font></a></b> <br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https：// localhost：8002</font></font></a></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
 and </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https：// localhost：8003で</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リッスンし</font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ます</font></a></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブラウザでWASMクライアントを認証するためのライブラリ </font></font></h2><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.nuget.org/packages/Sotsera.Blazor.Oidc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">
インストールして</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">人生</font></a><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">楽しんでください</font></a></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identity Server4を設定する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、既製のサーバーを使用して、そこにSPAクライアントの設定を追加しました。</font><font style="vertical-align: inherit;">Identity Server4自体の設定はBlazorに関するものであるため、この記事の範囲を超えています。</font><font style="vertical-align: inherit;">興味があれば、私の情報源を調べることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
利用可能なクライアントのリストにクライアントを追加します</font></font><br>
<br>
<pre><code class="cs hljs">              <span class="hljs-keyword">new</span> Client<font></font>
                {<font></font>
                    ClientId = <span class="hljs-string">"spaBlazorClient"</span>,<font></font>
                    ClientName = <span class="hljs-string">"SPA Blazor Client"</span>,<font></font>
<font></font>
                    RequireClientSecret = <span class="hljs-literal">false</span>,<font></font>
                    RequireConsent = <span class="hljs-literal">false</span>,<font></font>
<font></font>
                    RedirectUris = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-keyword">string</span>&gt;<font></font>
                    {<font></font>
                        <span class="hljs-string">$"<span class="hljs-subst">{clientsUrl[<span class="hljs-string">"SpaBlazor"</span>]}</span>/oidc/callbacks/authentication-redirect"</span>,
                        <span class="hljs-string">$"<span class="hljs-subst">{clientsUrl[<span class="hljs-string">"SpaBlazor"</span>]}</span>/_content/Sotsera.Blazor.Oidc/silent-renew.html"</span>,
                        <span class="hljs-string">$"<span class="hljs-subst">{clientsUrl[<span class="hljs-string">"SpaBlazor"</span>]}</span>"</span>,<font></font>
                    },<font></font>
                    PostLogoutRedirectUris = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-keyword">string</span>&gt;<font></font>
                    {<font></font>
                        <span class="hljs-string">$"<span class="hljs-subst">{clientsUrl[<span class="hljs-string">"SpaBlazor"</span>]}</span>/oidc/callbacks/logout-redirect"</span>,
                        <span class="hljs-string">$"<span class="hljs-subst">{clientsUrl[<span class="hljs-string">"SpaBlazor"</span>]}</span>"</span>,<font></font>
                    },<font></font>
                    AllowedCorsOrigins = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-keyword">string</span>&gt;<font></font>
                    {<font></font>
                        <span class="hljs-string">$"<span class="hljs-subst">{clientsUrl[<span class="hljs-string">"SpaBlazor"</span>]}</span>"</span>,<font></font>
                    },<font></font>
<font></font>
                    AllowedGrantTypes = GrantTypes.Code,<font></font>
                    AllowedScopes = { <span class="hljs-string">"openid"</span>, <span class="hljs-string">"profile"</span>, <span class="hljs-string">"email"</span>, <span class="hljs-string">"api"</span> },<font></font>
<font></font>
                    AllowOfflineAccess = <span class="hljs-literal">true</span>,<font></font>
                    RefreshTokenUsage = TokenUsage.ReUse<font></font>
                }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JWTトークンでより多くのロールを取得するために、IProfileServiceを実装します </font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">using</span> IdentityModel;
<span class="hljs-keyword">using</span> IdentityServer4.Models;
<span class="hljs-keyword">using</span> IdentityServer4.Services;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Identity;
<span class="hljs-keyword">using</span> Microsoft.eShopOnContainers.Services.Identity.API.Models;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.IdentityModel.Tokens.Jwt;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Security.Claims;
<span class="hljs-keyword">using</span> System.Threading.Tasks;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Microsoft.eShopOnContainers.Services.Identity.API.Services</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProfileService</span> : <span class="hljs-title">IProfileService</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> UserManager&lt;ApplicationUser&gt; _userManager;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProfileService</span>(<span class="hljs-params">UserManager&lt;ApplicationUser&gt; userManager</span>)</span><font></font>
        {<font></font>
            _userManager = userManager;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">public</span> Task <span class="hljs-title">GetProfileDataAsync</span>(<span class="hljs-params">ProfileDataRequestContext context</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> subject = context.Subject ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-keyword">nameof</span>(context.Subject));<font></font>
<font></font>
            <span class="hljs-keyword">var</span> subjectId = subject.Claims.Where(x =&gt; x.Type == <span class="hljs-string">"sub"</span>).FirstOrDefault().Value;<font></font>
<font></font>
            <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">await</span> _userManager.FindByIdAsync(subjectId);
            <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentException(<span class="hljs-string">"Invalid subject identifier"</span>);
            <span class="hljs-keyword">var</span> claims = GetClaimsFromUser(user);<font></font>
            context.IssuedClaims = claims.ToList();<font></font>
            <span class="hljs-keyword">var</span> roles = <span class="hljs-keyword">await</span> _userManager.GetRolesAsync(user);
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> role <span class="hljs-keyword">in</span> roles)<font></font>
            {<font></font>
                context.IssuedClaims.Add(<span class="hljs-keyword">new</span> Claim(JwtClaimTypes.Role, role));<font></font>
            }<font></font>
           <font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">public</span> Task <span class="hljs-title">IsActiveAsync</span>(<span class="hljs-params">IsActiveContext context</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> subject = context.Subject ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-keyword">nameof</span>(context.Subject));<font></font>
<font></font>
            <span class="hljs-keyword">var</span> subjectId = subject.Claims.Where(x =&gt; x.Type == <span class="hljs-string">"sub"</span>).FirstOrDefault().Value;
            <span class="hljs-keyword">var</span> user = <span class="hljs-keyword">await</span> _userManager.FindByIdAsync(subjectId);<font></font>
<font></font>
            context.IsActive = <span class="hljs-literal">false</span>;<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>)<font></font>
            {<font></font>
                <span class="hljs-keyword">if</span> (_userManager.SupportsUserSecurityStamp)<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> security_stamp = subject.Claims.Where(c =&gt; c.Type == <span class="hljs-string">"security_stamp"</span>).Select(c =&gt; c.Value).SingleOrDefault();
                    <span class="hljs-keyword">if</span> (security_stamp != <span class="hljs-literal">null</span>)<font></font>
                    {<font></font>
                        <span class="hljs-keyword">var</span> db_security_stamp = <span class="hljs-keyword">await</span> _userManager.GetSecurityStampAsync(user);
                        <span class="hljs-keyword">if</span> (db_security_stamp != security_stamp)
                            <span class="hljs-keyword">return</span>;<font></font>
                    }<font></font>
                }<font></font>
<font></font>
                context.IsActive =<font></font>
                    !user.LockoutEnabled ||<font></font>
                    !user.LockoutEnd.HasValue ||<font></font>
                    user.LockoutEnd &lt;= DateTime.Now;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> IEnumerable&lt;Claim&gt; <span class="hljs-title">GetClaimsFromUser</span>(<span class="hljs-params">ApplicationUser user</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> claims = <span class="hljs-keyword">new</span> List&lt;Claim&gt;<font></font>
            {<font></font>
                <span class="hljs-keyword">new</span> Claim(JwtClaimTypes.Subject, user.Id),
                <span class="hljs-keyword">new</span> Claim(JwtClaimTypes.PreferredUserName, user.UserName),
                <span class="hljs-keyword">new</span> Claim(JwtRegisteredClaimNames.UniqueName, user.UserName)<font></font>
            };<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.Name))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"name"</span>, user.Name));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.LastName))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"last_name"</span>, user.LastName));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.CardNumber))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"card_number"</span>, user.CardNumber));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.CardHolderName))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"card_holder"</span>, user.CardHolderName));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.SecurityNumber))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"card_security_number"</span>, user.SecurityNumber));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.Expiration))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"card_expiration"</span>, user.Expiration));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.City))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"address_city"</span>, user.City));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.Country))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"address_country"</span>, user.Country));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.State))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"address_state"</span>, user.State));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.Street))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"address_street"</span>, user.Street));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.ZipCode))<font></font>
                claims.Add(<span class="hljs-keyword">new</span> Claim(<span class="hljs-string">"address_zip_code"</span>, user.ZipCode));<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (_userManager.SupportsUserEmail)<font></font>
            {<font></font>
                claims.AddRange(<span class="hljs-keyword">new</span>[]<font></font>
                {<font></font>
                    <span class="hljs-keyword">new</span> Claim(JwtClaimTypes.Email, user.Email),
                    <span class="hljs-keyword">new</span> Claim(JwtClaimTypes.EmailVerified, user.EmailConfirmed ? <span class="hljs-string">"true"</span> : <span class="hljs-string">"false"</span>, ClaimValueTypes.Boolean)<font></font>
                });<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (_userManager.SupportsUserPhoneNumber &amp;&amp; !<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(user.PhoneNumber))<font></font>
            {<font></font>
                claims.AddRange(<span class="hljs-keyword">new</span>[]<font></font>
                {<font></font>
                    <span class="hljs-keyword">new</span> Claim(JwtClaimTypes.PhoneNumber, user.PhoneNumber),
                    <span class="hljs-keyword">new</span> Claim(JwtClaimTypes.PhoneNumberVerified, user.PhoneNumberConfirmed ? <span class="hljs-string">"true"</span> : <span class="hljs-string">"false"</span>, ClaimValueTypes.Boolean)<font></font>
                });<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">return</span> claims;<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、このコードの要点は </font></font><br>
<br>
<pre><code class="cs hljs">
  <span class="hljs-keyword">var</span> roles = <span class="hljs-keyword">await</span> _userManager.GetRolesAsync(user);
  <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> role <span class="hljs-keyword">in</span> roles)<font></font>
  {<font></font>
     context.IssuedClaims.Add(<span class="hljs-keyword">new</span> Claim(JwtClaimTypes.Role, role));<font></font>
  }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてそれをasp.netに追加します </font></font><br>
<br>
<pre><code class="cs hljs">services.AddIdentityServer().AddProfileService&lt;ProfileService&gt;()</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトの作成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、設定の転送が非常に簡単だったので、ASP.NET Coreホストを選択しました。</font><font style="vertical-align: inherit;">Dockerイメージの組み立てが簡単になりました。</font><font style="vertical-align: inherit;">必要に応じて、コンテナー内でnginxをホストすることもできます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eh/ez/5e/ehez5ei_v0untezw-n132dvrhb4.png"><br>
<br>
<img src="https://habrastorage.org/webt/i1/0a/sc/i10ascbtjvdueaqdyzvsmhl5yfu.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成ファイルおよび環境変数からの設定の転送</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバ側</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定モデルを追加する </font></font><br>
<br>
<pre><code class="cs hljs">
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigModel</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> SsoUri { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> ApiUri { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Startup.csに登録する</font></font><br>
<br>
<pre><code class="cs hljs">
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
        {<font></font>
            services.AddMvc();<font></font>
            services.AddResponseCompression(opts =&gt;<font></font>
            {<font></font>
                opts.MimeTypes = ResponseCompressionDefaults.MimeTypes.Concat(<font></font>
                    <span class="hljs-keyword">new</span>[] { <span class="hljs-string">"application/octet-stream"</span> });<font></font>
            });<font></font>
            services.Configure&lt;ConfigModel&gt;(Configuration);<font></font>
        }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
jsonとしてクライアントに渡す </font></font><br>
<br>
<pre><code class="cs hljs">
<span class="hljs-keyword">using</span> BlazorEShop.Shared.Presentation;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Mvc;
<span class="hljs-keyword">using</span> Microsoft.Extensions.Options;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">BlazorEShop.Spa.BlazorWasm.Server.Controllers</span><font></font>
{<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/config"</span>)</span>]<font></font>
    [<span class="hljs-meta">ApiController</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConfigController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IOptionsSnapshot&lt;ConfigModel&gt; _configuration;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConfigController</span>(<span class="hljs-params">IOptionsSnapshot&lt;ConfigModel&gt; configuration</span>)</span><font></font>
        {<font></font>
            _configuration = configuration;<font></font>
        }<font></font>
        <span class="hljs-comment">// GET: api/&lt;controller&gt;</span>
        [<span class="hljs-meta">HttpGet</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> ConfigModel <span class="hljs-title">Get</span>(<span class="hljs-params"></span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> _configuration.Value;<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアント側</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーから設定を取得し、DIコンテナーに追加します</font></font><br>
<br>
<pre><code class="cs hljs">
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Net.Http;
<span class="hljs-keyword">using</span> System.Threading;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> BlazorEShop.Shared.Presentation;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Blazor.Hosting;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Components;
<span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">BlazorEShop.Spa.BlazorWasm.Client</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-keyword">string</span>[] args</span>)</span><font></font>
        {<font></font>
            Task.Run(<span class="hljs-keyword">async</span> () =&gt;<font></font>
            {<font></font>
                ConfigModel cfg = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">var</span> host = BlazorWebAssemblyHost.CreateDefaultBuilder().Build();
                <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> scope = host.Services.CreateScope())<font></font>
                {<font></font>
                    <span class="hljs-keyword">var</span> nm = scope.ServiceProvider.GetRequiredService&lt;NavigationManager&gt;();
                    <span class="hljs-keyword">var</span> uri = nm.BaseUri;<font></font>
                    Console.WriteLine(<span class="hljs-string">$"BASE URI: <span class="hljs-subst">{uri}</span>"</span>);<font></font>
                    cfg = <span class="hljs-keyword">await</span> GetConfig(<span class="hljs-string">$"<span class="hljs-subst">{(uri.EndsWith(<span class="hljs-string">'/'</span>) ? uri : uri + <span class="hljs-string">"/"</span>)}</span>api/v1/config"</span>);<font></font>
                }<font></font>
                <span class="hljs-keyword">await</span> BlazorWebAssemblyHost<font></font>
                    .CreateDefaultBuilder()<font></font>
                    .ConfigureServices(x =&gt; x.AddScoped&lt;ConfigModel&gt;(y =&gt; cfg))<font></font>
                    .UseBlazorStartup&lt;Startup&gt;()<font></font>
                    .Build()<font></font>
                    .StartAsync()<font></font>
                     .ContinueWith((a, b) =&gt; Console.WriteLine(a.Exception), <span class="hljs-literal">null</span>);<font></font>
            });<font></font>
            Console.WriteLine(<span class="hljs-string">"END MAIN"</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> Task&lt;ConfigModel&gt; <span class="hljs-title">GetConfig</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> url</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> HttpClient();
            <span class="hljs-keyword">var</span> cfg = <span class="hljs-keyword">await</span> client<font></font>
                .GetJsonAsync&lt;ConfigModel&gt;(url);<font></font>
            <span class="hljs-keyword">return</span> cfg;<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Blazor Wasmはasync void Mainをサポートしておらず、スレッドが1つしかないため、タスクから結果を取得しようとするとデッドロックが発生するため、すべてをTask.Run（async（）=&gt; {}）;でラップする必要がありました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クライアント側でOIDC（OAuth2）ライブラリをアクティブにする</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ConfigModel内のサーバーから受け取った設定でservices.AddOidcを呼び出します。</font></font><br>
<br>
<pre><code class="cs hljs">
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Components.Builder;
<span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;
<span class="hljs-keyword">using</span> Sotsera.Blazor.Oidc;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Net.Http;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> BlazorEShop.Shared.Presentation;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Components;<font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">BlazorEShop.Spa.BlazorWasm.Client</span><font></font>
{<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Startup</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> provider = services.BuildServiceProvider();
            <span class="hljs-keyword">var</span> cfg = provider.GetService&lt;ConfigModel&gt;();<font></font>
            services.AddOidc(<span class="hljs-keyword">new</span> Uri(cfg.SsoUri), (settings, siteUri) =&gt;<font></font>
            {<font></font>
                settings.UseDefaultCallbackUris(siteUri);<font></font>
                settings.ClientId = <span class="hljs-string">"spaBlazorClient"</span>;<font></font>
                settings.ResponseType = <span class="hljs-string">"code"</span>;<font></font>
                settings.Scope = <span class="hljs-string">"openid profile email api"</span>;<font></font>
                settings.UseRedirectToCallerAfterAuthenticationRedirect();<font></font>
                settings.UseRedirectToCallerAfterLogoutRedirect();<font></font>
                settings.MinimumLogeLevel = Microsoft.Extensions.Logging.LogLevel.Information;<font></font>
                settings.LoadUserInfo = <span class="hljs-literal">true</span>;<font></font>
                settings.FilterProtocolClaims = <span class="hljs-literal">true</span>;<font></font>
                settings.MonitorSession = <span class="hljs-literal">true</span>;<font></font>
                settings.StorageType = Sotsera.Blazor.Oidc.Configuration.Model.StorageType.LocalStorage;<font></font>
            });<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Configure</span>(<span class="hljs-params">IComponentsApplicationBuilder app</span>)</span><font></font>
        {<font></font>
            app.AddComponent&lt;App&gt;(<span class="hljs-string">"app"</span>);<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">App.razorのメインコンポーネントの構成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 App.blazor-許可されたユーザーと許可されていないユーザーが異なるテキストを表示し、oidcのライブラリからのルートが接続されるように変更します。</font></font><br>
<br>
<pre><code class="cs hljs"><font></font>
@using BlazorEShop.Shared.Presentation<font></font>
@using Microsoft.AspNetCore.Components<font></font>
@using Microsoft.Extensions.DependencyInjection<font></font>
@using Sotsera.Blazor.Oidc<font></font>
@inject IUserManager UserManager<font></font>
<font></font>
&lt;Router AppAssembly=<span class="hljs-string">"@typeof(Program).Assembly"</span> AdditionalAssemblies=<span class="hljs-string">"new[] { typeof(IUserManager).Assembly }"</span>&gt;<font></font>
    &lt;Found Context=<span class="hljs-string">"routeData"</span>&gt;<font></font>
        &lt;AuthorizeRouteView RouteData=<span class="hljs-string">"@routeData"</span> DefaultLayout=<span class="hljs-string">"@typeof(MainLayout)"</span>&gt;<font></font>
            &lt;NotAuthorized&gt;<font></font>
                &lt;h3&gt;Sorry&lt;/h3&gt;<font></font>
                &lt;p&gt;You<span class="hljs-string">'re not authorized to reach this page.&lt;/p&gt;
                &lt;p&gt;You may need to log in as a different user.&lt;/p&gt;
            &lt;/NotAuthorized&gt;
            &lt;Authorizing&gt;
                &lt;h3&gt;Authentication in progress&lt;/h3&gt;
            &lt;/Authorizing&gt;
        &lt;/AuthorizeRouteView&gt;
    &lt;/Found&gt;
    &lt;NotFound&gt;
        &lt;CascadingAuthenticationState&gt;
            &lt;LayoutView Layout="@typeof(MainLayout)"&gt;
                &lt;h3&gt;Sorry&lt;/h3&gt;
                &lt;p&gt;Sorry, there'</span>s nothing at <span class="hljs-keyword">this</span> address.&lt;/p&gt;<font></font>
            &lt;/LayoutView&gt;<font></font>
        &lt;/CascadingAuthenticationState&gt;<font></font>
    &lt;/NotFound&gt;<font></font>
&lt;/Router&gt;<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーのログインとログアウト</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザー管理は、IUserManagerインターフェイスを介して実行されます。</font><font style="vertical-align: inherit;">DIコンテナから取得できます。</font><font style="vertical-align: inherit;">例えば：</font></font><br>
<br>
<pre><code class="cs hljs"><font></font>
@inject IUserManager UserManager<font></font>
@using Sotsera.Blazor.Oidc<font></font>
@using Microsoft.Extensions.DependencyInjection<font></font>
&lt;AuthorizeView&gt;<font></font>
    &lt;Authorized&gt;<font></font>
        &lt;span <span class="hljs-keyword">class</span>=<span class="hljs-string">"login-display-name mr-3"</span>&gt;<font></font>
            Hello, @context.User.Identity.Name!<font></font>
        &lt;/span&gt;<font></font>
        &lt;button type=<span class="hljs-string">"button"</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">"btn btn-primary btn-sm"</span> @onclick=<span class="hljs-string">"LogoutRedirect"</span>&gt;<font></font>
            Log <span class="hljs-keyword">out</span><font></font>
        &lt;/button&gt;<font></font>
    &lt;/Authorized&gt;<font></font>
    &lt;NotAuthorized&gt;<font></font>
        &lt;button type=<span class="hljs-string">"button"</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">"btn btn-primary btn-sm"</span> @onclick=<span class="hljs-string">"LoginRedirect"</span>&gt;<font></font>
            Log <span class="hljs-keyword">in</span><font></font>
        &lt;/button&gt;<font></font>
    &lt;/NotAuthorized&gt;<font></font>
&lt;/AuthorizeView&gt;<font></font>
<font></font>
@code<font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoginRedirect</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">await</span> UserManager.BeginAuthenticationAsync(p =&gt; p.WithRedirect());<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LogoutRedirect</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">await</span> UserManager.BeginLogoutAsync(p =&gt; p.WithRedirect());<font></font>
}<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">許可ユーザーと非許可ユーザーのためのさまざまな情報の表示</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、AuthorizeViewを使用して、アプリケーションの任意の部分で、承認されたユーザーのみが表示する領域を指定できます。</font><font style="vertical-align: inherit;">ロールを使用して、このコンテンツを表示できるロールを持つユーザーを指定することもできます。</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">AuthorizeView</span> <span class="hljs-attr">Roles</span>=<span class="hljs-string">"admin, administrator"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Authorized</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>User Info<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>@context.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><font></font>
        @foreach (var c in context.User.Claims)<font></font>
        {<font></font>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>@c.Type : @c.Value : @string.Join(";", c.Properties.Select(x =&gt; $"{x.Key} : {x.Value}"))<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><font></font>
        }<font></font>
<font></font>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Authorized</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">NotAuthorized</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>       admin   administrator<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">NotAuthorized</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">AuthorizeView</span>&gt;</span>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">承認とユーザーの役割に応じて特定のページにアクセス </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが標準属性Authorizeになります。</font><font style="vertical-align: inherit;">もちろん、サーバー側でもユーザー権限チェックを行うほうがよいでしょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
任意のロールを持つ許可されたユーザーのみがアクセスできるページ</font></font><br>
<br>
<pre><code class="xml hljs">@page "/user"<font></font>
@attribute [Authorize]<font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>     <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理者またはボスの役割を持つ承認されたユーザーのみがアクセスできるページ </font></font><br>
<br>
<pre><code class="xml hljs">@page "/admin"<font></font>
@attribute [Authorize(Roles="admin, boss")]<font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>      admin  boss<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API呼び出し</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、DIコンテナーから取得できるOidcHttpClientを使用します。</font><font style="vertical-align: inherit;">現在のユーザーのトークンをリクエストに自動的に置きます。</font><font style="vertical-align: inherit;">例えば：</font></font><br>
<br>
<pre><code class="cs hljs">
@page <span class="hljs-string">"/fetchdata"</span><font></font>
@inject Sotsera.Blazor.Oidc.OidcHttpClient Http<font></font>
@inject BlazorEShop.Shared.Presentation.ConfigModel Config<font></font>
<font></font>
@using BlazorEShop.Shared.Presentation<font></font>
&lt;h1&gt;Weather forecast&lt;/h1&gt;<font></font>
<font></font>
&lt;p&gt;This component demonstrates fetching data <span class="hljs-keyword">from</span> the server.&lt;/p&gt;<font></font>
<font></font>
@if (products == <span class="hljs-literal">null</span>)<font></font>
{<font></font>
    &lt;p&gt;&lt;em&gt;Loading...&lt;/em&gt;&lt;/p&gt;<font></font>
}<font></font>
<span class="hljs-keyword">else</span><font></font>
{<font></font>
    &lt;table <span class="hljs-keyword">class</span>=<span class="hljs-string">"table"</span>&gt;<font></font>
        &lt;thead&gt;<font></font>
            &lt;tr&gt;<font></font>
                &lt;th&gt;Id&lt;/th&gt;<font></font>
                &lt;th&gt;Version&lt;/th&gt;<font></font>
            &lt;/tr&gt;<font></font>
        &lt;/thead&gt;<font></font>
        &lt;tbody&gt;<font></font>
            @foreach (<span class="hljs-keyword">var</span> product <span class="hljs-keyword">in</span> products.Value)<font></font>
            {<font></font>
                &lt;tr&gt;<font></font>
                    &lt;td&gt;@product.Id&lt;/td&gt;<font></font>
                    &lt;td&gt;@product.Version&lt;/td&gt;<font></font>
                &lt;/tr&gt;<font></font>
            }<font></font>
        &lt;/tbody&gt;<font></font>
    &lt;/table&gt;<font></font>
}<font></font>
<font></font>
@code {<font></font>
    <span class="hljs-keyword">private</span> PageResultModel&lt;ProductModel&gt; products;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">OnInitializedAsync</span>(<span class="hljs-params"></span>)</span><font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> uri = Config.ApiUri;<font></font>
        products = <span class="hljs-keyword">await</span> Http.GetJsonAsync&lt;PageResultModel&lt;ProductModel&gt;&gt;(<span class="hljs-string">$"<span class="hljs-subst">{(uri.EndsWith(<span class="hljs-string">'/'</span>) ? uri : uri + <span class="hljs-string">"/"</span>)}</span>api/v1/products?take=100&amp;skip=0"</span>);<font></font>
    }<font></font>
}<font></font>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja484584/index.html">ITプロジェクトにマネージャーが必要な理由と、マネージャーがいない場合に何が起こるか</a></li>
<li><a href="../ja484586/index.html">PHPでIPv6を使用する</a></li>
<li><a href="../ja484588/index.html">自動プログラム管理モデル</a></li>
<li><a href="../ja484590/index.html">男の子が見せることを恥じないように</a></li>
<li><a href="../ja484592/index.html">先週のフロントエンドの世界からの新鮮な食材のダイジェストNo. 398（2020年1月13日〜19日）</a></li>
<li><a href="../ja484600/index.html">Microsoft Ignite The Tour Prague Technical Conference</a></li>
<li><a href="../ja484602/index.html">本「iOSおよびAndroid向けC＃でのモバイルアプリケーションの開発」</a></li>
<li><a href="../ja484604/index.html">新年、新しいブラウザ：Microsoft Edgeの予備評価が終了し、ダウンロードできるようになりました</a></li>
<li><a href="../ja484606/index.html">マイクロソフトは2030年までにマイナスの炭素排出量に完全に切り替えます</a></li>
<li><a href="../ja484610/index.html">さよならクリーンコード</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>