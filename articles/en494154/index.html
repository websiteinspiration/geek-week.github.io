<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî• üï• üå∑ How we accelerated video encoding eight times ü§® ‚ôãÔ∏è üèØ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every day, millions of viewers watch videos on the Internet. But for the video to become available, it must not only be uploaded to the server, but al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How we accelerated video encoding eight times</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/494154/"><img src="https://habrastorage.org/webt/mu/t5/ov/mut5ovwkds2o3dn2vnxmxvnelwo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Every day, millions of viewers watch videos on the Internet. But for the video to become available, it must not only be uploaded to the server, but also processed. The faster this happens, the better the service and its users. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My name is Askar Kamalov, a year ago I joined the Yandex video technology team. Today I will briefly tell Habr‚Äôs readers about how, using parallelization of the coding process, we managed to speed up the delivery of video to the user many times. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This post will primarily be of interest to those who have not previously thought about what is happening under the hood of video services. In the comments, you can ask questions and suggest topics for future posts.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A few words about the task itself. </font><font style="vertical-align: inherit;">Yandex not only helps to search for videos on other sites, but also stores videos for its own services. </font><font style="vertical-align: inherit;">Whether it‚Äôs an author‚Äôs program or a sports match in Ether, a movie on KinoPoisk or videos in Zen and News - all this is uploaded to our servers. </font><font style="vertical-align: inherit;">In order for users to watch a video, it needs to be prepared: convert it to the required format, create a preview, or even drive it through </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DeepHD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> technology </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">An unprepared file just takes up space. </font><font style="vertical-align: inherit;">And we are talking not only about the optimal use of iron, but also about the speed of content delivery to users. </font><font style="vertical-align: inherit;">Example: a record with the decisive moment of a hockey match can be searched in the search within a minute after the event itself.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequential coding</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the user's happiness largely depends on how quickly the video becomes available. </font><font style="vertical-align: inherit;">And this is mainly determined by the speed of transcoding. </font><font style="vertical-align: inherit;">When there are no strict requirements for video upload speed, then there are no problems. </font><font style="vertical-align: inherit;">Take a single, indivisible file, convert it, upload. </font><font style="vertical-align: inherit;">At the beginning of our journey, we worked like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lh/rv/ix/lhrvixp8ipl0f8yfbtxrm9uh174.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The client uploads the video to the repository, the Analyzer component collects meta information and transfers the video for conversion to the Worker component. </font><font style="vertical-align: inherit;">All steps are performed sequentially. </font><font style="vertical-align: inherit;">At the same time, there can be many servers for encoding, but only one is busy processing a specific video. </font><font style="vertical-align: inherit;">Simple, transparent layout. </font><font style="vertical-align: inherit;">This is where its merits end. </font><font style="vertical-align: inherit;">Such a scheme is scaled only vertically (due to the purchase of more powerful servers).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequential coding with intermediate result</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to somehow smooth out the painful expectation, the industry came up with a quick coding option. This is a deceptive name, because in fact, full-fledged coding takes place sequentially and for as long. But with an intermediate result. The idea is this: prepare and upload the low-resolution version of the video as soon as possible, and only later - higher-resolution versions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the one hand, video is becoming faster. And it is useful for important events. But on the other - the picture is blurry, and this annoys the audience.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that you need not only to quickly process the video, but also to preserve its quality. </font><font style="vertical-align: inherit;">This is what users now expect from a video service. </font><font style="vertical-align: inherit;">It may seem that it is enough to buy the most productive servers (and regularly upgrade them all at once). </font><font style="vertical-align: inherit;">But this is a way to a dead end, because there is always a video that will slow down even the most powerful hardware.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parallel coding</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is much more efficient to divide a difficult task into many less complex ones and simultaneously solve them on different servers. Such is MapReduce for video. In this case, we do not rest on the performance of a single server and can scale horizontally (by adding new machines). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, the idea of ‚Äã‚Äãsplitting a video into small pieces, simultaneously processing and gluing them together is not a secret. You can find many references to this approach (for example, on Habr√© I recommend a post about the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DistVIDc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> project </font><font style="vertical-align: inherit;">). But this generally does not make it easier, because you can‚Äôt just take a ready-made solution and build it into yourself. We need to adapt to our infrastructure, our video and even our workload. In general, it's easier to write your own.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, in the new architecture, we divided the monolithic Worker block with sequential coding into microservices Segmenter, Tcoder, Combiner.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zq/xo/db/zqxodbzp7qwxo22evvnn1ftyk8o.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Segmenter splits the video into fragments in about 10 seconds. </font><font style="vertical-align: inherit;">Fragments consist of one or more GOP ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">group of pictures</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Each GOP is independent and encoded separately, so that it can be decoded without reference to frames from other GOPs. </font><font style="vertical-align: inherit;">That is, fragments can be reproduced independently of each other. </font><font style="vertical-align: inherit;">This segmentation reduces latency, allowing you to start processing earlier.</font></font></li>
<li>Tcoder   .     ,    ,     (,     ,    ),             .   , Tcoder        .</li>
<li>ombiner   :   ,  Tcoder,     .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A few words about the sound. </font><font style="vertical-align: inherit;">The most popular AAC audio codec has a nasty feature. </font><font style="vertical-align: inherit;">If you code the fragments separately, then seamlessly gluing them together simply will not work. </font><font style="vertical-align: inherit;">Transitions will be noticeable. </font><font style="vertical-align: inherit;">Video codecs have no such problem. </font><font style="vertical-align: inherit;">Theoretically, you can look for a difficult technical solution, but this game is just not worth the candle (audio weighs significantly less than video). </font><font style="vertical-align: inherit;">Therefore, only video is encoded in parallel with us, and the audio track is processed as a whole.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">results</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to parallel video processing, we significantly reduced the delay between downloading a video to us and its availability to users. For example, earlier it could take two hours to create several full-fledged versions of different quality for a FullHD movie lasting an hour and a half. Now it all takes 15 minutes. Moreover, in parallel processing, we create a high-resolution version even faster than a low-resolution version with the old approach with an intermediate result. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And something else. With the old approach, either servers might be missing or they were idle without tasks. Parallel coding can increase the share of iron utilization. Now our cluster of more than a thousand servers is always busy with something.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, there is still room for improvement. </font><font style="vertical-align: inherit;">For example, we can save a lot of time if we start processing fragments of a video even before it has arrived in full. </font><font style="vertical-align: inherit;">As they say, further - more. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Write in the comments about what tasks in the field of working with video you would like to read.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Useful links to industry peers</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SVE: Distributed Video Processing at Facebook Scale</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplifying Media Innovation at Netflix with Archer. </font><font style="vertical-align: inherit;">Netflix Technology Blog</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494136/index.html">What to drip in the eye, so as not to itch</a></li>
<li><a href="../en494138/index.html">Human rights and algorithms: copyright brute force will not work in the USA, Australia, Russia and the EU</a></li>
<li><a href="../en494140/index.html">Investigating a DNSpionage Campaign Using Cisco Threat Response, Including Remote Work</a></li>
<li><a href="../en494150/index.html">ClickHouse in Avito: live gatherings with Alexey Milovidov</a></li>
<li><a href="../en494152/index.html">HoughNet: Search for vanishing points fused with a classic algorithm</a></li>
<li><a href="../en494156/index.html">How to work from home - the experience of Plesk removers</a></li>
<li><a href="../en494158/index.html">How to maintain the quality of work under quarantine</a></li>
<li><a href="../en494162/index.html">Troubleshooting Postgres with pgCenter. Alexey Lesovsky</a></li>
<li><a href="../en494164/index.html">How to improve the performance of agile teams through testing</a></li>
<li><a href="../en494170/index.html">Top 3 Python Features You Did Not Know About (Probably)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>