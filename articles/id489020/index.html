<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐯 🤲🏿 🎖️ Studi tentang satu berbahaya 🔆 🔮 👍🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya menemukan file doc baru-baru ini berbahaya yang dikirim dengan email phishing. Saya memutuskan bahwa ini adalah alasan yang bagus untuk memprakti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Studi tentang satu berbahaya</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489020/"><img src="https://habrastorage.org/webt/ee/hd/a7/eehda7mpejjegq4jc2me1nvupy4.jpeg" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya menemukan file doc baru-baru ini berbahaya yang dikirim dengan email phishing. </font><font style="vertical-align: inherit;">Saya memutuskan bahwa ini adalah alasan yang bagus untuk mempraktikkan teknik reverse dan menulis sesuatu yang baru di Habr. </font><font style="vertical-align: inherit;">Di bawah kucing - contoh parsing penetes makro berbahaya dan dll tidak kurang berbahaya.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Makro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sha256 dari file - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abb052d9b0660f90bcf5fc394db0e16d6edd29f41224f8053ed90a4b8ef1b519</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dalam file doc itu sendiri, pada halaman pertama ada gambar yang memberitahukan bahwa file ini dilindungi dan menjelaskan cara mengaktifkan makro, ada dua tabel besar dengan angka dalam file. Bilangan ditulis dalam bentuk desimal, terpanjang sepuluh digit, ada positif dan negatif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ketika korban mengizinkan eksekusi makro (ada yang mengaktifkannya secara default?), Serangkaian tindakan diluncurkan, yang akhirnya menjalankan fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, yang mengubah direktori saat ini menjadi yang sementara dan membuat file "icutils.dll" di dalamnya, di mana ia menuliskan angka-angka dari tabel pertama berturut-turut sebagai integer 32 bit dengan tanda. </font><font style="vertical-align: inherit;">Hasilnya adalah dll yang benar. </font><font style="vertical-align: inherit;">Fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">klon</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diimpor dari dll ini </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="vbscript hljs">Declare PtrSafe <span class="hljs-keyword">Function</span> clone Lib <span class="hljs-string">"icutils.dll"</span> _<font></font>
(<span class="hljs-keyword">ByVal</span> Saved As <span class="hljs-built_in">String</span>, <span class="hljs-keyword">ByVal</span> <span class="hljs-built_in">Time</span> As Integer) As Boolean</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan itu dimulai dengan dua parameter:</font></font><br>
<br>
<pre><code class="vbscript hljs">R1 = Module1.clone(<span class="hljs-string">"Cream"</span>, <span class="hljs-number">0</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jika panggilan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">klon</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mengembalikan False, file icutils.dll ditimpa dengan data dari tabel kedua dan klon dipanggil lagi dengan parameter yang sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ke depan, saya akan mengatakan bahwa dll pertama adalah 64 bit dan tidak akan berjalan pada sistem 32 bit. </font><font style="vertical-align: inherit;">Dengan demikian, makro memilih arsitektur kode biner yang benar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menariknya, fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memiliki sepotong kode yang tidak memiliki tujuan fungsional:</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">Sub</span> updatedb_network()<font></font>
...<font></font>
<span class="hljs-keyword">Dim</span> query_to_change As Variant
    <span class="hljs-keyword">Set</span> query_to_change = CurrentDb.QueryDefs(<span class="hljs-string">"query_name"</span>)<font></font>
    <font></font>
    query_to_change.SQL = <span class="hljs-string">"SELECT * FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE Fashion"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE '"</span> &amp; something &amp; <span class="hljs-string">"'"</span><font></font>
...<font></font>
<span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mungkin dia ada di sini untuk memberikan tampilan pekerjaan yang bermanfaat bagi mereka yang dengan cepat membalik kode, melihat beberapa baris dalam SQL dan berpikir bahwa semuanya baik-baik saja? </font><font style="vertical-align: inherit;">Saya tidak tahu. </font><font style="vertical-align: inherit;">Juga, sebagian besar fungsi dan variabel memiliki nama acak atau tidak-nyata (misalnya, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updatedb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang tidak berinteraksi dengan database atau jaringan). </font><font style="vertical-align: inherit;">Meskipun ada, misalnya, fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dump_payload</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , yang menyimpan 4 byte di icutil.dll. </font><font style="vertical-align: inherit;">Tetapi bagaimanapun juga, keberadaan fungsi </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Document_Open</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> harus segera diperingatkan </font><font style="vertical-align: inherit;">, pembuat malware tidak dapat mengubah namanya secara sewenang-wenang (meskipun mereka dapat menggunakan fungsi lain yang diluncurkan secara otomatis sebagai gantinya). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, fungsionalitas makro kurang lebih jelas, saatnya untuk membongkar dll dan melanjutkan ke analisis mereka.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dll pertama</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dll pertama (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7427cc4b6b659b89552bf727aed332043f4551ca2ee2126cca75fbe1ab8bf114</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) 64 bit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daftar fungsi yang diimpor berisi fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (mulai program), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (membuat utas dalam </font><font style="vertical-align: inherit;">proses </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lain</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (mengalokasikan blok memori dalam </font><font style="vertical-align: inherit;">proses </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lain</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (menulis ke memori </font><font style="vertical-align: inherit;">proses </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lain</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), yang langsung menyarankan injeksi kode ke proses lain. proses. Sekarang mari kita lihat apa sebenarnya yang dia lakukan dengan menggunakan IDA Free dan Ghidra.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Titik masuk utama hanya mengembalikan 1, tidak melakukan apa pun. Fungsi yang diekspor kedua adalah klon, yang dipanggil oleh makro dan berisi kode berbahaya. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parameter yang dipanggil sepertinya tidak mempengaruhi apa pun. Aplikasi mendekripsi dua blok data. Blok data 0x78 pertama dengan konten berikut (sudah didekripsi):</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d&lt;\x04\xe0\x1d\xe6\x00\xde\x01\xa4\x17\xbc\x03x\x01\xe0\x1d\xe2\x16x\x07Qy\xbc\x03@Fx\x07Df\xbc\x03\x89a\xde\x01q\x11\xe0\x1d|Ix\x07D@\xbc\x03\x8a\x01\xde\x01^9\xde\x01\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d\xab</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Blok data kedua panjangnya 0x1D4C dan berisi kode yang dapat dieksekusi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, pointer ke modul kernel32, hasil dari fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTickCount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (), dan alamat fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwDelayExecution</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> () dari kernel32 </font><font style="vertical-align: inherit;">ditulis ke struktur 0x90 byte </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian proses ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) "cmd.exe" dibuat. Menggunakan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , dua buffer dialokasikan di dalamnya: dengan izin RW dengan panjang 0x108 dan dengan izin RWX dengan panjang 0x1D4C. Buffer RW menyalin blok data di atas dan struktur yang disebutkan di atas dengan panjang 0x90. Struktur juga menulis pointer ke blok data yang didekripsi (di ruang alamat proses anak (cmd.exe)). Di RWX, buffer disalin ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) blok data yang didekripsi dengan kode. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian, dalam proses cmd.exe, aliran ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) dibuat dengan titik masuk di awal buffer RWX, pointer ke buffer RW dilewatkan sebagai argumen. </font><font style="vertical-align: inherit;">Ini melengkapi fungsi klon, tindakan berlanjut dalam proses cmd.exe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menariknya, fungsi klon tampaknya seperti potongan kode yang tidak dapat diakses yang mengimpor ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibraryW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pustaka</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> " </font><i><font style="vertical-align: inherit;">WorkPolyhistor</font></i><font style="vertical-align: inherit;"> ".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode disuntikkan ke cmd.exe</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ia melakukan tindakan berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">menemukan alamat fungsi-fungsi yang diperlukan dari </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel32.dll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (alamatnya diperoleh dari proses induk)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memuat </font><i><font style="vertical-align: inherit;">pustaka </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ntdll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ole32</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User32</font></font></i></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temukan alamat fungsi yang diperlukan di perpustakaan ini.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sangat menarik bahwa untuk sebagian besar fungsi dalam kode tidak ada nama fungsi, tetapi hanya CRC32 atas nama (semua nama fungsi dari pustaka dimuat dicari sampai ada fungsi dengan CRC32 yang diinginkan atas nama). </font><font style="vertical-align: inherit;">Mungkin ini adalah perlindungan terhadap mendapatkan daftar fungsi yang diimpor oleh utilitas string, meskipun aneh bahwa kode yang disimpan dalam bentuk terenkripsi memiliki perlindungan seperti itu, sedangkan dll itu sendiri mengimpor fungsi hanya dengan nama. </font><font style="vertical-align: inherit;">Secara total, fungsi-fungsi berikut terdeteksi: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
kernel32:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetProcAddress</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Perpustakaan Load</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Globalalloc</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetTempPath </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DapatkanFileAttributesW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Buat ProsesW </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bebas global </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GlobalRealloc </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> File Writeile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateFileW (ditemukan dengan nama)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> File Writeile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Closehandle</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gettickcount</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> BacaFile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetfileSize</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
nll:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RtlCreateUnicodeStringFromAsciiz</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eksekusi ZwDelay</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwTerminateProcess</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> swprintf</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OLE32:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menginisialisasi (ditemukan dengan nama)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoCreateInstance (ditemukan dengan nama)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
msvcrt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rand</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> srand</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, proses menggunakan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTempPath</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memperoleh jalur ke direktori sementara, membuat file di dalamnya dengan nama 26342235.dat, di mana nama file adalah catatan desimal dari TickCount yang diterima dari proses induk dan beralih pada setiap upaya baru (mis. Jika unduhan gagal pada upaya pertama, maka pada upaya kedua file akan dibuat dengan nama 26342236.dat). </font><font style="vertical-align: inherit;">Setelah itu, perpustakaan wininet dimuat dan ada pointer ke fungsi-fungsi berikut:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetCloseHandle (crc32: 0xe5191d24)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState (crc32: 0xf2e5fc0c)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenA (crc32: 0xda16a83d)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenUrlA (crc32: 0x16505e0)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetReadFile (crc32: 0x6cc098f5)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menggunakan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memeriksa apakah ada jaringan, jika tidak, aplikasi memanggil fungsi di alamat yang tidak ada dan crash (perlindungan terhadap penentuan alamat dari mana muatan diperoleh dengan menggunakan mesin yang diisolasi dari jaringan. Ini adalah satu-satunya kasus ketika aplikasi berakhir secara abnormal, dalam 3 upaya sisanya dilakukan , setelah itu cmd.exe berakhir menggunakan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Jika ada jaringan, kemudian menggunakan fungsi yang ditemukan, muatan diunduh dari URL yang diteruskan dari proses induk (https://pastebin.com/raw/Jyujxy7z) dan disimpan ke file yang dibuat sebelumnya dengan ekstensi .dat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, payload dibaca dari file dat, didekodekan (base64), didekripsi menggunakan XOR dengan CRC32 dari URL, periksa bahwa 2 byte pertama dari data yang didekripsi adalah 'MZ', jika demikian, hasilnya disimpan ke file dengan nama yang sama tetapi ekstensi. exe</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kode dekripsi python</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> crc32
<span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt_payload</span>(<span class="hljs-params">payload_b64: bytes, url: str</span>):</span><font></font>
    payload_bin = b64decode(payload_b64.decode())<font></font>
    key = str(crc32(url.encode())).encode()<font></font>
    decrypted = bytearray()<font></font>
    <span class="hljs-keyword">for</span> i, b <span class="hljs-keyword">in</span> enumerate(payload_bin):<font></font>
        decrypted.append(b ^ key[i % len(key)])<font></font>
    <span class="hljs-keyword">return</span> bytes(decrypted)
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menggunakan fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">file yang disimpan diluncurkan. </font><font style="vertical-align: inherit;">Jika semuanya berjalan dengan baik, proses cmd.exe keluar menggunakan </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Jika terjadi kesalahan (kecuali karena kurangnya jaringan), maka semuanya diulangi lagi, maksimal 3 upaya dilakukan, nama file dat dan exe bertambah 1 setiap kali.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dll kedua</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dll kedua (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">006200fcd7cd1e71be6c2ee029c767e3a28f480613e077bf15fadb60a88fdfca</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) 32 bit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di dalamnya, fungsi jahat utama diimplementasikan dalam fungsi </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">klon</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Itu juga mendekripsi 2 buffer. </font><font style="vertical-align: inherit;">Buffer pertama berukuran 0x78 (120) byte, data tersebut didekripsi dan ditulis ke dalamnya (dalam bentuk dekripsi):</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\x1e(\xf0\x0e\xc5r\xc0;\x12)\xc0;Jr\xc0;Y4\xbc\x03/Mx\x07\x038\xde\x01\x9e\x05\xe0\x1d#\x08\xbc\x03\xeeU\xf0\x0e\x18{x\x078\x1a\xf0\x0e\xccg\xf0\x0eze\xde\x01\x89&amp;\xe0\x1d\xf6\x1f\xe0\x1d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dapat dilihat bahwa pada awalnya adalah URL yang sama seperti pada versi x64. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buffer kedua ukuran 0x4678 byte dialokasikan dengan izin RWX. </font><font style="vertical-align: inherit;">Kode didekripsi ke dalamnya, setelah fungsi dipanggil dari itu dengan offset 0x4639 dari awal buffer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya tidak menganalisis kode ini secara detail. </font><font style="vertical-align: inherit;">Dia juga menemukan fungsi pada CRC32, meluncurkan notepad.exe, menyuntikkan kode di sana yang mengunduh muatan dari URL yang sama di pastebin.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muatan dengan pastebin</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Payload yang didekripsi dengan pastebin adalah file exe 32-bit (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9509111de52db3d9a6c06aa2068e14e0128b31e9e45ada7a8936a35ddfaf155f</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) Saya tidak membongkar secara detail namun karena kurangnya waktu.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara umum, malware terkesan membuat saya agak ditulis dengan buruk, dengan banyak kesalahan (saya tidak sengaja menyebutnya di sini). </font><font style="vertical-align: inherit;">Seolah-olah mereka mencambuk. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dll ditemukan dalam fungsi memori yang kemudian tidak digunakan di mana pun. </font><font style="vertical-align: inherit;">Mungkin kode ini, seperti makro, secara teratur ditulis ulang oleh penjahat dunia maya setiap kali mulai terdeteksi oleh antivirus, sebagai akibat dari artefak tersebut tetap dalam kode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sangat menarik juga bahwa dalam versi "dll" dari dll yang "dijatuhkan" ke disk x64, nama fungsi impor "berbahaya" tidak di-mask (setidaknya Anda bisa melihatnya string), dan dalam kode yang didekripsi dalam memori dan tidak muat di disk, mereka berada di CRC32 dari nama, bukan hanya dengan nama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muatan pastebin dihapus beberapa hari kemudian. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KDPV diambil dari sini</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id489008/index.html">Routing di chatbots kompleks dengan kerangka kerja Hobot</a></li>
<li><a href="../id489010/index.html">Kami berbagi lapisan data Rusia terbesar di pelatihan online dengan proyek-proyek dalam linguistik, personalisasi, peddesign, ML</a></li>
<li><a href="../id489012/index.html">Google Cloud Spanner: baik, buruk, jahat</a></li>
<li><a href="../id489014/index.html">Buku “Algoritma Sempurna. Algoritma Greedy dan Pemrograman Dinamis "</a></li>
<li><a href="../id489016/index.html">German Gref: “Kami mencoba mengorganisir diskusi tentang AGI, dan tidak ada satu pun ilmuwan yang menghargai diri sendiri yang datang ke sana”</a></li>
<li><a href="../id489022/index.html">Menggunakan RabbitMQ dengan MonsterMQ Bagian 2</a></li>
<li><a href="../id489024/index.html">Perpustakaan Webix JavaScript melalui mata seorang pemula. Bagian 5. Bekerja dengan data di sisi pengguna</a></li>
<li><a href="../id489026/index.html">Mengubah Algoritma Google AdSense Dapat Mengarah ke Pemilik Situs dan Webmaster</a></li>
<li><a href="../id489028/index.html">Tentang kerja jarak jauh</a></li>
<li><a href="../id489034/index.html">Aplikasi seluler UIS yang baru - siksaan atau keselamatan bagi mereka yang mencari pengadaan publik?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>