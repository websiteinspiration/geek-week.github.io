<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≥ ‚òÑÔ∏è üõåüèº Pourquoi Discord passe de Go √† Rust ‚õ∑Ô∏è üîß üì™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La rouille devient une langue de premier ordre dans un large √©ventail de domaines. Chez Discord, nous l'utilisons avec succ√®s √† la fois c√¥t√© serveur e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pourquoi Discord passe de Go √† Rust</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487116/"><img src="https://habrastorage.org/getpro/habr/post_images/84a/0f1/d61/84a0f1d6126d5fd59b9c708f19c84692.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La rouille devient une langue de premier ordre dans un large √©ventail de domaines. </font><font style="vertical-align: inherit;">Chez Discord, nous l'utilisons avec succ√®s √† la fois c√¥t√© serveur et c√¥t√© client. </font><font style="vertical-align: inherit;">Par exemple, du c√¥t√© client dans le pipeline d'encodage vid√©o pour Go Live, et du c√¥t√© serveur pour les fonctions </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elixir NIF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Native Implemented Functions). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons r√©cemment consid√©rablement am√©lior√© les performances d'un service unique, en le r√©√©crivant de Go to Rust. </font><font style="vertical-align: inherit;">Cet article explique pourquoi il √©tait logique pour nous de r√©√©crire le service, comment nous l'avons fait et combien la productivit√© s'est am√©lior√©e.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Service de suivi de l'√©tat de lecture (√âtats de lecture)</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre entreprise est construite autour d'un seul produit, alors commen√ßons par un certain contexte, ce que nous avons exactement transf√©r√© de Go √† Rust. Il s'agit d'un service Read States. Sa seule t√¢che est de garder une trace des canaux et des messages que vous lisez. Les √©tats de lecture sont accessibles chaque fois que vous vous connectez √† Discord, chaque fois que vous envoyez un message et chaque fois que vous lisez le message. En bref, les √©tats sont lus en continu et sont sur un ¬´chemin chaud¬ª. Nous voulons nous assurer que Discord est toujours rapide, donc la v√©rification de l'√©tat doit √™tre rapide.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mise en ≈ìuvre du service sur Go ne r√©pondait pas √† toutes les exigences. </font><font style="vertical-align: inherit;">La plupart du temps, cela fonctionnait rapidement, mais toutes les quelques minutes, il y avait de forts retards, visibles par les utilisateurs. </font><font style="vertical-align: inherit;">Apr√®s avoir examin√© la situation, nous avons d√©termin√© que les retards √©taient dus aux principales caract√©ristiques de Go: son mod√®le de m√©moire et le garbage collector (GC).</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi Go ne r√©pond pas √† nos objectifs de performance</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour expliquer pourquoi Go n'atteint pas nos objectifs de performances, nous devons d'abord discuter des structures de donn√©es, de l'√©chelle, des mod√®les d'acc√®s et de l'architecture des services. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour stocker des informations d'√©tat, nous utilisons une structure de donn√©es, appel√©e: √âtat de lecture. Il y en a des milliards dans Discord: un √©tat pour chaque utilisateur par canal. Chaque √©tat poss√®de plusieurs compteurs, qui doivent √™tre mis √† jour atomiquement et souvent remis √† z√©ro. Par exemple, l'un des compteurs est le num√©ro </font></font><code>@mention</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du canal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour mettre √† jour rapidement le compteur atomique, chaque serveur Read States poss√®de un cache LRU (Least Latest Used). Chaque cache a des millions d'utilisateurs et des dizaines de millions d'√©tats. Le cache est mis √† jour des centaines de milliers de fois par seconde.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour des raisons de s√©curit√©, le cache est synchronis√© avec le cluster de bases de donn√©es Cassandra. </font><font style="vertical-align: inherit;">Lorsqu'une cl√© est pouss√©e hors du cache, nous entrons les √©tats de cet utilisateur dans la base de donn√©es. </font><font style="vertical-align: inherit;">√Ä l'avenir, nous pr√©voyons de mettre √† jour la base de donn√©es dans les 30 secondes √† chaque mise √† jour d'√©tat. </font><font style="vertical-align: inherit;">Il s'agit de dizaines de milliers d'enregistrements dans la base de donn√©es chaque seconde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le graphique ci-dessous montre le temps de r√©ponse et la charge CPU √† l'intervalle de temps de pointe pour le service Go </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></sup></a><a name="1_1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">On peut voir que les retards et les salves de charge sur le processeur se produisent environ toutes les deux minutes.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/90d/37b/89f/90d37b89f25eab54420107e63c086c44.png"><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D'o√π vient donc l'augmentation des retards toutes les deux minutes?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans Go, la m√©moire n'est pas lib√©r√©e imm√©diatement lorsqu'une cl√© est pouss√©e hors du cache. Au lieu de cela, le garbage collector s'ex√©cute p√©riodiquement et recherche les parties inutilis√©es de la m√©moire. C'est beaucoup de travail qui peut ralentir un programme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est tr√®s probable que des ralentissements p√©riodiques de notre service soient associ√©s √† la collecte des ordures. Mais nous avons √©crit un code Go tr√®s efficace avec une quantit√© minimale d'allocation de m√©moire. Il ne devrait plus y avoir beaucoup de d√©chets. Que se passe-t-il? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fouillant dans le code source de Go, nous avons appris que Go d√©marre de force la r√©cup√©ration de place </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">au moins toutes les deux minutes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Quelle que soit la taille du segment de m√©moire, si le GC n'a pas d√©marr√© pendant deux minutes, Go le forcera √† d√©marrer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons d√©cid√© que si vous ex√©cutez GC plus souvent, vous pouvez √©viter ces pics avec des retards importants, nous avons donc d√©fini un point de terminaison dans le service pour modifier la valeur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GC Percent</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† la vol√©e </font><font style="vertical-align: inherit;">. Malheureusement, la configuration de GC Percent n'a rien affect√©. Comment cela pourrait-il arriver? Il s'av√®re que GC n'a pas voulu d√©marrer plus souvent, car nous n'avons pas allou√© suffisamment de m√©moire.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons commenc√© √† creuser plus loin. Il s'est av√©r√© que de tels retards importants ne se produisent pas en raison de l'√©norme quantit√© de m√©moire lib√©r√©e, mais parce que le garbage collector scanne l'int√©gralit√© du cache LRU pour v√©rifier toute la m√©moire. Ensuite, nous avons d√©cid√© que si nous diminuions le cache LRU, le volume d'analyse diminuerait. Par cons√©quent, nous avons ajout√© un param√®tre suppl√©mentaire au service pour modifier la taille du cache LRU et chang√© l'architecture, divisant le LRU en plusieurs caches distincts sur chaque serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et c'est arriv√©. Avec des caches plus petits, les retards de pointe sont r√©duits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, le compromis avec la diminution du cache LRU a augment√© le 99e centile (c'est-√†-dire que la valeur moyenne pour un √©chantillon de 99% des retards a augment√©, √† l'exclusion des pics). En effet, la diminution du cache r√©duit la probabilit√© que l'√©tat de lecture de l'utilisateur soit dans le cache. S'il n'est pas l√†, alors nous devons nous tourner vers la base de donn√©es.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s un grand nombre de tests de charge sur diff√©rentes tailles de cache, nous avons en quelque sorte trouv√© un param√®tre acceptable. </font><font style="vertical-align: inherit;">Bien que ce ne soit pas id√©al, c'√©tait une solution satisfaisante, nous avons donc quitt√© le service pendant longtemps pour travailler comme √ßa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le m√™me temps, nous avons mis en ≈ìuvre Rust avec beaucoup de succ√®s dans d'autres syst√®mes Discord et, par cons√©quent, nous avons pris la d√©cision collective d'√©crire des cadres et des biblioth√®ques pour de nouveaux services uniquement dans Rust. </font><font style="vertical-align: inherit;">Et ce service semblait √™tre un excellent candidat pour le portage vers Rust: il est petit et autonome, et nous esp√©rions que Rust corrigerait ces explosions avec des retards et rendrait finalement le service plus agr√©able pour les utilisateurs </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sup></a><a name="2_2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestion de la m√©moire √† Rust</font></font></h1><br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rust est incroyablement rapide et efficace avec la m√©moire: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en l'absence d'un environnement d'ex√©cution et d'un garbage collector,</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> il convient aux services haute performance, aux applications embarqu√©es et s'int√®gre facilement avec d'autres langages. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></sup></a><a name="3_3"></a></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rust n'a pas de collecteur d'ordures, nous avons donc d√©cid√© qu'il n'y aurait pas de tels retards, comme Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la gestion de la m√©moire, il utilise une approche assez unique avec l'id√©e de "poss√©der" la m√©moire. </font><font style="vertical-align: inherit;">En bref, Rust garde une trace de qui a le droit de lire et d'√©crire dans la m√©moire. </font><font style="vertical-align: inherit;">Il sait quand un programme utilise de la m√©moire et la lib√®re imm√©diatement d√®s que la m√©moire n'est plus n√©cessaire. </font><font style="vertical-align: inherit;">Rust applique les r√®gles de m√©moire au moment de la compilation, ce qui √©limine pratiquement la possibilit√© d'erreurs de m√©moire au moment de l'ex√©cution. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></sup></a><a name="4_4"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous n'avez pas besoin de suivre manuellement la m√©moire. </font><font style="vertical-align: inherit;">Le compilateur s'en chargera. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, dans la version Rust, lorsque l'√©tat de lecture est exclu du cache LRU, la m√©moire est lib√©r√©e imm√©diatement. </font><font style="vertical-align: inherit;">Cette m√©moire ne reste pas et n'attend pas le garbage collector. </font><font style="vertical-align: inherit;">Rust sait qu'il n'est plus utilis√© et le lib√®re imm√©diatement. </font><font style="vertical-align: inherit;">Il n'y a aucun processus en cours d'ex√©cution pour analyser la m√©moire √† lib√©rer.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rouille asynchrone</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il y avait un probl√®me avec l'√©cosyst√®me de Rust. Au moment de la mise en ≈ìuvre de notre service, il n'y avait pas de fonctions asynchrones d√©centes dans la branche stable de Rust. Pour un service r√©seau, la programmation asynchrone est un must. La communaut√© a d√©velopp√© plusieurs biblioth√®ques, mais avec une connexion non triviale et des messages d'erreur tr√®s stupides. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heureusement, l'√©quipe de Rust a travaill√© dur pour simplifier la programmation asynchrone, et elle √©tait d√©j√† disponible sur le canal instable (Nightly).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Discord n'a jamais eu peur d'apprendre de nouvelles technologies prometteuses. Par exemple, nous avons √©t√© l'un des premiers utilisateurs d'Elixir, React, React Native et Scylla. Si une technologie semble prometteuse et nous donne un avantage, nous sommes pr√™ts √† affronter l'in√©vitable difficult√© de mise en ≈ìuvre et l'instabilit√© des outils avanc√©s. C'est l'une des raisons pour lesquelles nous avons atteint si rapidement un public de 250 millions d'utilisateurs avec moins de 50 programmeurs en l'√©tat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'introduction de nouvelles fonctions asynchrones √† partir du canal instable de Rust est un autre exemple de notre volont√© d'adopter une nouvelle technologie prometteuse. L'√©quipe d'ing√©nierie a d√©cid√© de mettre en ≈ìuvre les fonctions n√©cessaires sans attendre leur support dans la version stable. Avec d'autres repr√©sentants de la communaut√©, nous avons surmont√© tous les probl√®mes qui se sont pos√©s, et maintenant la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rouille asynchrone</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maintenu dans une branche stable. </font><font style="vertical-align: inherit;">Notre tarif a pay√©.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mise en ≈ìuvre, tests de r√©sistance et lancement</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R√©√©crire le code √©tait simple. Nous avons commenc√© par une diffusion approximative, puis l'avons r√©duite √† des endroits o√π cela avait du sens. Par exemple, Rust a un excellent syst√®me de type avec un support √©tendu pour les g√©n√©riques (pour travailler avec des donn√©es de tout type), nous avons donc discr√®tement jet√© le code Go, qui compensait le manque de g√©n√©riques. De plus, le mod√®le de m√©moire Rust prend en compte la s√©curit√© de la m√©moire dans diff√©rents threads, nous avons donc jet√© les goroutines de protection. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les tests de charge ont imm√©diatement montr√© un excellent r√©sultat. Les performances du service sur Rust se sont av√©r√©es aussi √©lev√©es que celles de la version Go, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais sans ces √©clats de retard accru</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√®gle g√©n√©rale, nous n'avons pratiquement pas optimis√© la version Rust. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais m√™me avec les optimisations les plus simples, Rust a pu surpasser une version soigneusement r√©gl√©e de Go.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ceci est une preuve √©loquente de la facilit√© d'√©criture de programmes Rust efficaces par rapport √† un approfondissement de Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous n'avons pas satisfait le simple quo de performance. </font><font style="vertical-align: inherit;">Apr√®s un peu de profilage et d'optimisation, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous avons d√©pass√© Go √† tous √©gards</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Retard, CPU et m√©moire - tout s'est am√©lior√© dans la version Rust. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les optimisations des performances de la rouille comprenaient:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passer √† BTreeMap au lieu de HashMap dans le cache LRU pour optimiser l'utilisation de la m√©moire.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remplacement de la biblioth√®que de m√©triques d'origine par une version prenant en charge la concurrence simultan√©e moderne Rust.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diminuez le nombre de copies en m√©moire.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Satisfait, nous avons d√©cid√© de d√©ployer le service. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le lancement s'est d√©roul√© sans heurts, car nous avons effectu√© des tests de r√©sistance. </font><font style="vertical-align: inherit;">Nous avons connect√© le service √† un n≈ìud de test, d√©couvert et corrig√© plusieurs cas limites. </font><font style="vertical-align: inherit;">Peu de temps apr√®s, ils ont d√©ploy√© une nouvelle version sur l'ensemble du parc de serveurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les r√©sultats sont montr√©s plus bas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le graphique violet est Go, le graphique bleu est Rust.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/yb/-v/mi/yb-vmise0bioz33f8yfrockjr_0.png"></a><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Augmentez la taille du cache</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque le service a fonctionn√© avec succ√®s pendant plusieurs jours, nous avons d√©cid√© d'augmenter √† nouveau le cache LRU. </font><font style="vertical-align: inherit;">Comme mentionn√© ci-dessus, dans la version Go, cela n'a pas pu √™tre fait, car le temps de collecte des ordures a augment√©. </font><font style="vertical-align: inherit;">√âtant donn√© que nous ne faisons plus de r√©cup√©ration de place, vous pouvez augmenter le comptage du cache sur une augmentation encore plus importante des performances. </font><font style="vertical-align: inherit;">Nous avons donc augment√© la m√©moire sur les serveurs, optimis√© la structure des donn√©es pour une utilisation moindre de la m√©moire (pour le plaisir) et augment√© la taille du cache √† 8 millions d'√©tats d'√©tat de lecture. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les r√©sultats ci-dessous parlent d'eux-m√™mes. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notez que le temps moyen est maintenant mesur√© en microsecondes et le retard maximum </font></font><code>@mention</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est mesur√© en millisecondes.</font></font></b><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93f/55a/500/93f55a500413c691a4e711e4c90ceada.png"></div><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©veloppement de l'√©cosyst√®me</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfin, Rust poss√®de un merveilleux √©cosyst√®me qui se d√©veloppe rapidement. </font><font style="vertical-align: inherit;">Par exemple, r√©cemment, une nouvelle version du runtime asynchrone que nous utilisons est Tokio 0.2. </font><font style="vertical-align: inherit;">Nous avons mis √† jour, et sans aucun effort de notre part, r√©duit automatiquement la charge sur le CPU. </font><font style="vertical-align: inherit;">Dans le graphique ci-dessous, vous pouvez voir comment la charge a diminu√© depuis le 16 janvier environ.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e5f/128/490/e5f12849036cfea0b9e9246a1e321ed0.png"></div><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Derni√®res pens√©es</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Discord utilise actuellement Rust dans de nombreuses parties de la pile logicielle: pour GameSDK, la capture et l'encodage de vid√©os dans Go Live, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elixir NIF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , plusieurs services backend et bien d'autres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors du d√©marrage d'un nouveau projet ou composant logiciel, nous envisageons certainement d'utiliser Rust. Bien s√ªr, seulement l√† o√π cela a du sens. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus des performances, Rust offre aux d√©veloppeurs de nombreux autres avantages. Par exemple, son type v√©rificateur de s√©curit√© et d'emprunt (v√©rificateur d'emprunt) simplifie consid√©rablement la refactorisation lorsque vous modifiez les exigences du produit ou introduisez de nouvelles fonctionnalit√©s linguistiques. L'√©cosyst√®me et les outils sont excellents et se d√©veloppent rapidement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fait amusant: l'√©quipe de Rust utilise √©galement Discord pour se coordonner. Il y a m√™me un tr√®s utile</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveur communautaire de Rust</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o√π nous discutons parfois.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><div style="text-align:center;"><img src="https://habrastorage.org/webt/br/pc/l_/brpcl_fl4bwj8fcmaeodxotfw5s.png"></div></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notes de bas de page</font></font></h4><br>
<font color="gray"><ol>
<li><a name="1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphiques tir√©s de Go version 1.9.2. </font><font style="vertical-align: inherit;">Nous avons essay√© les versions 1.8, 1.9 et 1.10 sans aucune am√©lioration. </font><font style="vertical-align: inherit;">La migration initiale de Go to Rust s'est termin√©e en mai 2019. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[rendre]</font></font></a><br>
</li>
<li><a name="2"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour plus de clart√©, nous ne recommandons pas de tout r√©√©crire dans Rust sans raison. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[rendre]</font></font></a><br>
</li>
<li><a name="3"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Citation du site officiel. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[rendre]</font></font></a><br>
</li>
<li><a name="4"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bien s√ªr, jusqu'√† ce que vous utilisiez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dangereux</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[rendre]</font></font></a></li>
</ol></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr487100/index.html">Structures de donn√©es immuables √† la pointe de la technologie</a></li>
<li><a href="../fr487106/index.html">Contr√¥le RunUO de l'analyseur PVS-Studio</a></li>
<li><a href="../fr487108/index.html">Profil de joueur mobile: recherche MyTracker</a></li>
<li><a href="../fr487110/index.html">Slurm SRE. Une exp√©rience compl√®te avec des experts de Booking.com et de Google.com</a></li>
<li><a href="../fr487112/index.html">Edge of Madness: The Basic Circle</a></li>
<li><a href="../fr487118/index.html">Loki - collecte de journaux √† l'aide de l'approche Prometheus</a></li>
<li><a href="../fr487120/index.html">Comment distribuer des chatons</a></li>
<li><a href="../fr487122/index.html">Traduction du guide de style JavaScript de Google</a></li>
<li><a href="../fr487124/index.html">Entretien avec Borey Yangel sur la conduite autonome de Yandex et l'histoire de la cr√©ation d'Alice</a></li>
<li><a href="../fr487126/index.html">Comment les √©quipes de d√©veloppement d'entreprise utilisent GitLab et Mattermost ChatOps pour acc√©l√©rer le d√©veloppement</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>