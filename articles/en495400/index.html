<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍⚕️ 👃🏿 👩🏿‍🤝‍👨🏾 Work with SD card via SPI interface. VHDL implementation ⛺️ 📠 🚊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! Once at work, I got the task of assessing the possibility of implementing data storage on an SD card when connecting it to an FPGA. The use o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Work with SD card via SPI interface. VHDL implementation</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495400/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hi Habr! </font><font style="vertical-align: inherit;">Once at work, I got the task of assessing the possibility of implementing data storage on an SD card when connecting it to an FPGA. </font><font style="vertical-align: inherit;">The use of SPI was assumed as an interaction interface, since it is easier to implement. </font><font style="vertical-align: inherit;">I would like to share the experience gained.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/qw/p6/gaqwp6tekmw-myhnjrsmwo5cam8.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the space on the printed circuit board is always limited, consideration of SD-cards will be performed on the example of cards in the microSD form factor.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Content</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Reading specification </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1 General information </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2 Initialization </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3 Erasing information </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 Reading information </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.1 Reading one data block </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.2 Reading many data blocks </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 Writing information </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.1 Writing one data block </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.2 Writing many data blocks </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Implementing the algorithm in hardware </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1 Component of the physical layer </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2 Component of the command level </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3 Component of communication with the outside world </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Verification in hardware </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Results</font></font></a><br>
<br>
<a name="SpecRead"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Reading specifications</font></font></h2><br>
<a name="GeneralInformation"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1 General</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A quick reading of the specification tells us the following SD card options:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data transfer to the SD card is carried out on one line; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reading data from an SD card is carried out on one line; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in SPI mode, the power can be only + 3.3V; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clock frequency in initialization mode in the range of 100-400 kHz;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clock frequency after initialization - 25 MHz.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This immediately leads to the point about the theoretical peak bandwidth: 25 MHz * 1 bit = 25 Mb / s, which is </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">somewhat</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> small. </font><font style="vertical-align: inherit;">The second minus the use of SD-cards, power + 3.3V. </font><font style="vertical-align: inherit;">On the printed circuit board on which it was planned to install the SD card, there is no such voltage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MicroSD form factor cards can be divided into 3 categories by capacity:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDSC </font><font style="vertical-align: inherit;">Card capacity up to 2 GB inclusive. </font><font style="vertical-align: inherit;">The address inside the card is byte.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDHC. </font><font style="vertical-align: inherit;">The card capacity is more than 2 GB and up to 32 GB inclusive. </font><font style="vertical-align: inherit;">The address inside the card indicates a 512 byte block.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDXC. </font><font style="vertical-align: inherit;">The card capacity is more than 32 GB and up to 128 TB inclusive. </font><font style="vertical-align: inherit;">The address inside the card indicates a 512 byte block.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The general view of the map is shown in the figure below. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wp/qo/4d/wpqo4dulzwlonas-3evcspttvra.png"><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contact number</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Name</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A type</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Description</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSV</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not used</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CS</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chip selection</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DI</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data line from Master device (MOSI)</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vdd</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutrition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supply voltage</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCLK</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clock signal</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vss</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutrition</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Land</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DO</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Output</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Line to Master Device (MISO)</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSV</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not used</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The connection is carried out according to the diagram below: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ey/jl/xj/eyjlxjhgg_iucbvd0ms-gzmjinu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The resistors must be rated at 50 kOhm.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
After turning on the power, the SD card is in SDIO mode. </font><font style="vertical-align: inherit;">To switch to SPI mode, you must perform initialization. </font><font style="vertical-align: inherit;">The protocol for working with the card involves the use of a control scheme for the correct transfer of data and commands in the form of a CRC algorithm. </font><font style="vertical-align: inherit;">When operating in SPI mode, CRC verification is disabled by default. </font><font style="vertical-align: inherit;">Thus, the first command sent to the card to switch the card to SPI mode must contain the correct CRC value. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commands transmitted over the SPI interface are 48 bits in size. </font><font style="vertical-align: inherit;">Command format:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bit 47 (leftmost) always contains the value 0. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bit 46 always contains the value 1.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bits 45..40 contain the command index.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bits 39..8 contain the arguments of the command. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bits 7..1 contain CRC from previous bits. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bit 0 always contains the value 1.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bits 47 and 46 give the card the ability to unambiguously track the start of a transaction, since the MOSI bus at rest is equal to one. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dd/ap/8n/ddap8nsdyqcbqezjudom42bzfx8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The commands used when working with the SD card will receive answers like R1, R3, R7. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/xq/ce/btxqcevcwggh9qgt6pxznanb0pc.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An answer of type R1, size 8 bits. </font></font></sub><font style="vertical-align: inherit;"><sub><font style="vertical-align: inherit;">Answer type R3, size 40 bits. </font></sub><sub><font style="vertical-align: inherit;">Answer type R7, size 40 bits. </font></sub><font style="vertical-align: inherit;">
All commands and their answers are detailed in the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Physical Layer Simplified Specification.</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/mu/dg/yb/mudgybpndrbrqpsz5icwgkb1prk.png"></a><br>
<sub><font style="vertical-align: inherit;"></font></sub><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/s-/vq/a8/s-vqa83la-g6k3bwgvvmmfoawms.png"></a><br>
<sub><font style="vertical-align: inherit;"></font></sub><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><br>
<br>
<a name="Init"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2 Initialization</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialization Algorithm:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After turning on the power, wait at least 1 ms.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generate a minimum of 74 clock switching for the card. </font><font style="vertical-align: inherit;">CS and MOSI lines must be in logical unit state.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generate command CMD0. </font><font style="vertical-align: inherit;">The CMD0 command resets the SD card.</font></font></li>
<li>    CMD0.     R1.  ,   R1    16   ,    3.   R1   ,     0x01 (     ),    3,     5. </li>
<li>  CMD8.            . </li>
<li>    CMD8.     R7.  ,     ,    ,    7, ,           ,    17,    13. </li>
<li>  CMD55.  CMD55  ,     . </li>
<li>    CMD55.     R1.     0x01 (    ),    7,    9. </li>
<li>  ACMD41.  ACMD41  ,    SDSC ( 0x00000000)    . </li>
<li>    ACMD41.     R1.      ,    ,    11. ,    0x00 ( )    14,       7.</li>
<li>  CMD1.  CMD1   ACMD41.</li>
<li>    CMD1.     R1.       ,    ,    13, ,    0x00 ( ),    14,       11.</li>
<li> .   ,   .      . </li>
<li>  CMD16.          ,  512 . </li>
<li>    CMD16.     R1.  ,    0x00 (  )    16,    13. </li>
<li>   .       .   . </li>
<li>  CMD55.  CMD55  ,     . </li>
<li>    CMD55.     R1.     0x01 (    ),    17,    19. </li>
<li>  ACMD41.   ACMD41.  ACMD41  ,    SDHC ( 0x40000000)    .</li>
<li>    ACMD41.     R1.      ,    ,    13. ,    0x00 ( )    21,       17. </li>
<li>  CMD58.    . </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Waiting for a response to CMD58 command. </font><font style="vertical-align: inherit;">The answer is an R3 type response. </font><font style="vertical-align: inherit;">If a bit is set in the response that the card works with block addresses of 512 bytes, go to step 16, otherwise to step 14.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After initialization is completed, the card can be operated in blocks of 512 bytes with a clock frequency of 25 MHz. </font><font style="vertical-align: inherit;">This is the full version of the initialization algorithm, which covers all types of cards. </font><font style="vertical-align: inherit;">In my case, when using a 16 GB card, the initialization algorithm consisted of steps 1-6, 17-22, 16.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphic Algorithm</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/vp/di/pw/vpdipwdy4umv4iahsea1g2snruu.png"></a></div>
                    </div><br>
<a name="Erase"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3 Erasing Information</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Micro SD form factor cards support erase commands. </font><font style="vertical-align: inherit;">After the erase command, the value of the specified erase addresses will be filled with the value 0xFF or 0x00, depending on the card. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Information Erasing Algorithm</font></font><br>
<br>
<ol>
<li>  CMD32.        .</li>
<li>    CMD32.     R1.       0x00 ( -    ),    3,    4.</li>
<li> .   ,     . </li>
<li>  CMD33.        .        ,        CMD32. </li>
<li>    CMD33.     R1.       0x00 ( -    ),    3,    6 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending CMD38 command. </font><font style="vertical-align: inherit;">The command to erase information from the selected blocks. </font><font style="vertical-align: inherit;">Any 4 bytes should be sent as an argument, except for the values ​​0x00000001, 0x00000002.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Waiting for a response to CMD38 command. </font><font style="vertical-align: inherit;">The answer is a response of type R1b. </font><font style="vertical-align: inherit;">This is an extended version of the answer when the card generates an R1 response, and then draws the MISO line to zero, indicating the chip is busy. </font><font style="vertical-align: inherit;">It is necessary to wait until the unit value appears on the MISO line. </font><font style="vertical-align: inherit;">If the answer is not 0x00 (there was some error while executing the command), go to step 3, otherwise to step 8</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Completion of the erase algorithm. </font></font></li>
</ol><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphic Algorithm</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/hm/qs/cq/hmqscqj62emd9yp30prqqasyjjm.png"></a></div>
                    </div><br>
<a name="Read"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 Reading information</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reading information from an SD card via SPI is possible in two ways.</font></font><br>
<br>
<a name="ReadOne"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.1 Reading a single data block</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When reading one data block, the Master device generates a command for the SD card to read one data block, awaits a response that the command has been processed and is waiting for a packet with data from the card. </font><font style="vertical-align: inherit;">After receiving a packet with data from the card, the read transaction ends. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/g_/oe/q_/g_oeq_mpttrajxmeltmmb5hpl28.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">General view of a transaction reading one block of data. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, such an option was implemented, but the resulting speed was very upset (speed comparisons will be lower).</font></font><br>
<br>
<a name="ReadMore"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4.2 Reading multiple data blocks</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When reading multiple data blocks, the Master device generates a command for the SD card to read multiple data blocks, awaits a response that the command has been processed, and expects a packet of data from the card. </font><font style="vertical-align: inherit;">After sending a data packet, the card sends the next data packet. </font><font style="vertical-align: inherit;">This will continue until a command is received from the Master device to complete the reading. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ai/ed/tz/aiedtzc1nfh__byzfhuozjnstjc.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">General view of a transaction reading many data blocks. </font></font></sub><br>
<br>
<img src="https://habrastorage.org/webt/i8/ko/9l/i8ko9lasfzqwjehte6q6yg8bs1w.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Packet Structure</font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Where:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Token </font><font style="vertical-align: inherit;">The read command uses the value 0xFE.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Block. </font><font style="vertical-align: inherit;">Contains data read from the card.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRC </font><font style="vertical-align: inherit;">Contain the checksum from the previous fields.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If an error occurred while reading, the card instead of Data Token returns an Error Token. </font><font style="vertical-align: inherit;">Error Token size is 1 byte. </font><font style="vertical-align: inherit;">Bits 7..5 contain a value of zero, bits 4..0 encode the type of error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algorithm for reading multiple data blocks:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending CMD18 command. </font><font style="vertical-align: inherit;">The command tells the card that multiple blocks will be read.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Waiting for a response to CMD18 command. </font><font style="vertical-align: inherit;">The answer is an R1 type response. </font><font style="vertical-align: inherit;">If the answer is not 0x00 (there was some error while executing the command), go to step 3, otherwise to step 4.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Error status. </font><font style="vertical-align: inherit;">Reading failed, exiting the reading algorithm.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Waiting for a token from the card. </font><font style="vertical-align: inherit;">If an Error Token is received from the card, go to step 3, otherwise go to step 5.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receive from a data block card 512 bytes in size. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receive from the card CRC field size of 2 bytes. </font></font></li>
<li>    .     ,    8,    4. </li>
<li>  CMD12.       .  ,       Data Packet,   . </li>
<li>     CMD12.     R1b.     R1,         MISO  ,   .      MISO  ,      .       0x00 ( -    ),    3,    10.</li>
<li>  . </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a slight nuance in the reading algorithm. </font><font style="vertical-align: inherit;">The chip select signal (CS) must be set to logic zero before generating the CMD18 command and set to logic one after receiving a response to the CMD12 command.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphic Algorithm</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/ht/8f/uf/ht8fufwcf9qq-bdrif-4chjd5cg.png"></a></div>
                    </div><br>
<a name="Write"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5 Recording Information</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Writing information to the SD card via the SPI interface is possible in two versions.</font></font><br>
<br>
<a name="WriteOne"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.1 Writing a single data block</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When recording one data block, the Master device generates a command for the SD card to write one data block, awaits a response from the card that the command has been processed, transmits a packet with data for recording to the card, expects a response from the card that the data is written, completes the transaction. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/u1/j5/7f/u1j57f-xmwqesdk1yzw_fenwvmi.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">General view of a write transaction of one data block. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As with reading, a record of one data block was originally implemented. </font><font style="vertical-align: inherit;">The speed results were unsatisfactory.</font></font><br>
<br>
<a name="WriteMore"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.5.2 Writing multiple data blocks</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When recording multiple data blocks, the Master device generates a command to record multiple data blocks, awaits a response from the card that the command has been processed, transmits a packet with data for recording to the card, expects a response from the card that the data is recorded. </font><font style="vertical-align: inherit;">After receiving a Master response, the device transmits a packet with the following data for recording to the card. </font><font style="vertical-align: inherit;">This will continue until the Master device sends a Stop Data Token. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/-p/l7/fz/-pl7fz2rfyuv5akb7ksrcwdipsy.png"><br>
<sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">General view of a write transaction for multiple data blocks. </font></font></sub><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The structure of the Data Packet is similar to the structure of the Data Packet when reading data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Format:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Token </font><font style="vertical-align: inherit;">For the write command, the value 0xFC is used.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Block. </font><font style="vertical-align: inherit;">Contains data written to the card.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CRC </font><font style="vertical-align: inherit;">Contain the checksum from the previous fields.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Stop Tran Token used to complete the write command is 1 byte in size and equal to 0xFD. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the last bit of the Data Packet has been pushed into the card, the card responds to the next clock with the status of the data record - Data Response. </font><font style="vertical-align: inherit;">Data Response has a size of 1 byte, bits 7..5 can be any, bit 4 is always zero, bit 0 is always equal to one, bits 3..1 encode the status of the data record. </font><font style="vertical-align: inherit;">After the card has returned the Data Packet, the card draws the MISO line to zero, indicating the card is busy. </font><font style="vertical-align: inherit;">After the logical unit level is on the MISO line, you can transfer the next data packet to the card. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The algorithm for recording multiple data blocks:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending CMD25 command. </font><font style="vertical-align: inherit;">The command tells the card that multiple blocks will be written.</font></font></li>
<li>    CMD25.     R1.       0x00 ( -    ),    3,    4.</li>
<li> .   ,   . </li>
<li>   . </li>
<li>   512   . </li>
<li>    CRC  2 . </li>
<li> Data Response  .       ,    3,    8. </li>
<li>   .     ,    9,    4. </li>
<li> Stop Tran Token.   ,     . </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Waiting for a response from the card. </font><font style="vertical-align: inherit;">The card on Stop Tran Token draws the MISO line to zero, indicating the card is busy. </font><font style="vertical-align: inherit;">It is necessary to wait on the MISO line for the unit value, which will indicate the end of the command</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The completion of the recording algorithm. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is also a small nuance in the recording algorithm. </font><font style="vertical-align: inherit;">The chip select signal (CS) must be set to logic zero before generating the CMD25 command and set to logic one after receiving a response to Stop Tran Token</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Graphic Algorithm</font></font></b>
                        <div class="spoiler_text"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/_9/kt/ts/_9kttsrffln_gmvgw-l4ch0ekva.png"></a></div>
                    </div><br>
<a name="Hardware"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Implementation of the algorithm in hardware</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result of reading the specification, we get some characteristics of the algorithm that need to be implemented in the hardware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Possible operating modes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initial frequency formation. </font><font style="vertical-align: inherit;">CS and MOSI lines must be in logical unit state.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transfer data to an SD card. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receive data from an SD card. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Waiting for the completion of the team. </font><font style="vertical-align: inherit;">It is used when, after generating a response, the SD card draws the MISO line to zero in order to wait for the appearance of a unit.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read response when writing data. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Waiting for a token while reading data. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Possible clock modes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clock signal to initialize. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clock signal for work. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From my point of view, the algorithm is optimally implemented using three components:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The component of the physical layer, which is connected directly to the SD card, generates SCLK, CS, DI signals, reads with DO. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A command-level component that prepares all the data for a component in the physical layer. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A component of communication with the outside world that hides the entire internal device and provides an interface for commands (reading, writing, erasing) and data.</font></font></li>
</ul><br>
<a name="HwPhy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.1 Physical layer component</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SDPhy <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Control bus</span>
			iPhyTxData	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">9</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iPhyMode	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">4</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iPhyTxWrite	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oPhyTxReady	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>; 
			<span class="hljs-comment">-- Out Data</span>
			oPhyRxData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">7</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>); <font></font>
			oPhyRxWrite	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oPhyCmdEnd	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> ); 
<span class="hljs-keyword">end</span> SDPhy;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where:</font></font><br>
<br>
<ul>
<li> iPhyTxData    ,  iPhyMode  ,    . </li>
<li>iPhyTxWrite ,    iPhyTxData  iPhyMode . </li>
<li>oPhyTxReady ,      .     FULL FIFO,    .</li>
<li>oPhyRxData   ,   SD-.</li>
<li>oPhyRxWrite ,     oPhyRxData . </li>
<li>oPhyCmdEnd ,     .</li>
<li>oSdCS    (CS)  SD-. </li>
<li>oSdClk    SD-.</li>
<li>oSdMosi     SD-.</li>
<li>oSdMosiT        SD-.</li>
<li>iSdMiso     SD-. </li>
<li>sclk      SD- (50 ).</li>
<li>pclk  ,     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rst reset signal, active level one.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In FPGAs, there are special units for working with a clock signal (PLL, MMCM), however, receiving a clock signal less than 5 MHz from their output is problematic. </font><font style="vertical-align: inherit;">As a result, the physical layer operates at a frequency of 50 MHz. </font><font style="vertical-align: inherit;">Together with each data in the iPhyMode signal, a bit is received that indicates at what frequency these data should be transferred to the SD card (or received from it). </font><font style="vertical-align: inherit;">Depending on the speed bit, Clock enable signals are generated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Two automata are implemented in the component of the physical layer, for transferring data to an SD card and for receiving data from it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Machine code for data transfer: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SDummy state provides initial frequency shaping, 128 switching. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STxBits status provides data transfer to the SD card. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code of the machine for receiving data: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The sRxBits state provides data reception from the SD card. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The sBusy state ensures that the SD card is ready (the card releases the MISO line to unit level). </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The sResp state implements reading the response when writing data. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The sToken state implements a token wait while reading data. </font></font></li>
</ul><br>
<a name="HwCmd"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.2 Command-level component</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SdCommand <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Command from host</span>
			oSdInitComp	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdInitFail	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdAddress	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdStartErase	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdStartRead	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdStartWrite	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdCmdFinish	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">1</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdhcPresent	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Data</span>
			oSdReadData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdDataR	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdWriteData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdDataW	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">32</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> );
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdInitComp sign completion of initialization of the SD card. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdInitFail sign of initialization failure. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdAddress address in the SD card to execute the command. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartErase start erase command execution. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartRead start reading command execution. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStartWrite start write command execution. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdCmdFinish team completion status. </font><font style="vertical-align: inherit;">The zero bit is equal to one, the command completed successfully. </font><font style="vertical-align: inherit;">The first bit is one, the command completed with an error.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdhcPresent SDHC / SDXC card detection flag. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdReadData Read data to write to the SD card. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdDataR data for writing to the SD card. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdWriteData flag to write data read from the SD card. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdDataW data read from an SD card.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The remaining signals coincide with the signals of the physical layer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The component has 5 automatic machines.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdInit ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - initialization of the SD card.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdErase ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - erase data from an SD card.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdRead ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - read data from an SD card.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdWrite ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - write data to an SD card.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smSdCommand ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) - on the basis of the generated features prepares data for the physical layer from all previous machines.</font></font></li>
</ul><br>
<a name="HwHost"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.3 Component of communication with the outside world</font></font></h3><br>
<pre><code class="vhdl hljs"><span class="hljs-keyword">entity</span> SdHost <span class="hljs-keyword">is</span>
	<span class="hljs-keyword">generic</span>	(	gTCQ		: <span class="hljs-built_in">time</span> := <span class="hljs-number">2</span> ns );
	<span class="hljs-keyword">port</span>	(	<span class="hljs-comment">-- Sd Host command</span>
			iSdCommand	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">2</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdAddress	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdStart	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdStatus	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>( <span class="hljs-number">1</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdInitFail	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Write data to card</span>
			iSdTxData	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			iSdTxValid	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdTxLast	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdTxReady	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Read data from card</span>
			oSdRxData	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic_vector</span>(<span class="hljs-number">31</span> <span class="hljs-keyword">downto</span> <span class="hljs-number">0</span>);<font></font>
			oSdRxValid	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdRxLast	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdRxReady	: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- Spi</span>
			oSdCS		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdClk		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosi		: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			oSdMosiT	: <span class="hljs-keyword">out</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			iSdMiso		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;
			<span class="hljs-comment">-- system</span>
			pclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			sclk		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span>;<font></font>
			rst		: <span class="hljs-keyword">in</span>	<span class="hljs-built_in">std_logic</span> );
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdCommand command code to execute. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdAddress is the address to execute the command. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdStart start command execution. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdStatus team completion status. </font><font style="vertical-align: inherit;">The zero bit is equal to one - the command is completed. </font><font style="vertical-align: inherit;">The first bit is one - the command completed with an error.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdInitFail sign of initialization failure. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxData. </font><font style="vertical-align: inherit;">Axi-Stream interface for writing data to an SD card. </font><font style="vertical-align: inherit;">Port with data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxValid. </font><font style="vertical-align: inherit;">Axi-Stream interface for writing data to an SD card. </font><font style="vertical-align: inherit;">Port with a write signal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdTxLast. </font><font style="vertical-align: inherit;">Axi-Stream interface for writing data to an SD card. </font><font style="vertical-align: inherit;">Port with a sign of the last dw in the data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdTxReady. </font><font style="vertical-align: inherit;">Axi-Stream interface for writing data to an SD card. </font><font style="vertical-align: inherit;">Port with a sign of readiness for receiving data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxData. </font><font style="vertical-align: inherit;">Axi-Stream interface for reading data from an SD card. </font><font style="vertical-align: inherit;">Port with data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxValid. </font><font style="vertical-align: inherit;">Axi-Stream interface for reading data from an SD card. </font><font style="vertical-align: inherit;">Port with a write signal.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oSdRxLast. </font><font style="vertical-align: inherit;">Axi-Stream interface for reading data from an SD card. </font><font style="vertical-align: inherit;">Port with a sign of the last dw in the data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iSdRxReady. </font><font style="vertical-align: inherit;">Axi-Stream interface for reading data from an SD card. </font><font style="vertical-align: inherit;">Port with a sign of readiness for receiving data.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The remaining signals coincide with the signals of the physical layer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The component implements one smSdControl ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">machine </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SIdle state. </font><font style="vertical-align: inherit;">Waiting for initialization and command to complete.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The state of sWaitCmd. </font><font style="vertical-align: inherit;">Checking the type of command.</font></font></li>
<li>sReadCmd.    FIFO,   ,     SD-      . </li>
<li>sWriteCmd. ,   FIFO      SD-,      . </li>
<li>sEraseCmd.     . </li>
<li>sWaitEnd.       . </li>
<li>sFinish.   ,  . </li>
</ul><br>
<a name="RealTest"></a><h2>3.   </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The algorithm is written, verified in the simulator. </font><font style="vertical-align: inherit;">It is necessary to check now in iron. </font><font style="vertical-align: inherit;">From what was available, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zybo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> board </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">from Digilent came up</font></a><font style="vertical-align: inherit;"> 
. It has free FPGA terminals in a bank with a voltage of + 3.3V, to which you can easily connect an external device. </font><font style="vertical-align: inherit;">Yes, and the type of FPGA used is Zynq-7000, which means there is a processor core. </font><font style="vertical-align: inherit;">You can write a test in C, which will simplify the testing task. </font><font style="vertical-align: inherit;">
So, we connect the implemented algorithm to the processor core via the GP port (4-byte operation is possible, similar to </font><abbr title="Programmed input/output"><font style="vertical-align: inherit;">PIO</font></abbr><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">We won’t bother with interruptions; we implement a timer poll. </font><font style="vertical-align: inherit;">
When working on the processor module, the data recording algorithm will be as follows:</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/oe/oy/nj/oeoynjbbxwco9wrihj-f3unb3cs.png"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><abbr title="Programmed input / output"><font style="vertical-align: inherit;"></font></abbr><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set address in SD card. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set command code 2. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write data to a buffer located in programmable logic. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run the command. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wait until the command completes. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reset team completion status.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implemented Test:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress ++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data write to %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">2</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Write data to PL */</span>
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1024</span>; i++)<font></font>
	{<font></font>
		Xil_Out32(<span class="hljs-number">0x43c00014</span>, cntrData);<font></font>
		cntrData++;<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in write \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Duration operation */</span><font></font>
	durationWrite += cntrDuration;<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cntrDuration &gt; MaxWrite )<font></font>
	{<font></font>
		MaxWrite = cntrDuration;<font></font>
	}<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To the question of why the outer boundary of 1024 is used in the cycle. The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">number of blocks is set to 8. The</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> size of one block is 512 bytes. </font><font style="vertical-align: inherit;">The total size of 8 data blocks is 8 * 512 bytes = 4096 bytes. </font><font style="vertical-align: inherit;">The bus between the processor module and the programmable logic is 4 bytes in size. </font><font style="vertical-align: inherit;">It turns out that to send 4096 bytes of 4 bytes from the processor module to the programmable logic, it is necessary to perform 4096/4 = 1024 write operations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When working on the processor module, the data reading algorithm will be as follows:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set address in SD card. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set command code 1. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run the command. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wait until the command completes. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reset team completion status.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read data from the buffer in programmable logic. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implemented Test:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data read from %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			 <span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in read \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	 <span class="hljs-comment">/** Duration operation */</span><font></font>
	 durationRead += cntrDuration;<font></font>
<font></font>
	 <span class="hljs-keyword">if</span> (cntrDuration &gt; MaxRead )<font></font>
	 {<font></font>
		 MaxRead = cntrDuration;<font></font>
	 }<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Read data from PL */</span>
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int32_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1024</span>; i++)<font></font>
	{<font></font>
		DataR = Xil_In32(<span class="hljs-number">0x43c0001c</span>);
		<span class="hljs-keyword">if</span> (DataR != cntrData)<font></font>
		{<font></font>
			xil_printf(<span class="hljs-string">"Data corrupt! \n\r"</span>);<font></font>
		}<font></font>
		DataR = Xil_In32(<span class="hljs-number">0x43c00020</span>);<font></font>
		cntrData++;<font></font>
	}<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When working on the processor module, the data erasure algorithm will be as follows:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set address in SD card. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set command code 4. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run the command. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wait until the command completes. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reset team completion status.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implemented Test:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">for</span> (SectorAddress = <span class="hljs-number">0</span>; SectorAddress &lt; <span class="hljs-number">1048576</span>; SectorAddress++)<font></font>
{<font></font>
	<span class="hljs-keyword">if</span> ((SectorAddress % <span class="hljs-number">1024</span>) == <span class="hljs-number">0</span>)<font></font>
	{<font></font>
		xil_printf(<span class="hljs-string">"Data erase from %d sector \n\r"</span>, SectorAddress);<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Set address */</span>
	Xil_Out32(<span class="hljs-number">0x43c00008</span>, SectorAddress);<font></font>
<font></font>
	<span class="hljs-comment">/** Set command */</span>
	Xil_Out32(<span class="hljs-number">0x43c00004</span>, <span class="hljs-number">4</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">1</span>);<font></font>
<font></font>
	<span class="hljs-comment">/** Wait end of operation */</span>
	<span class="hljs-keyword">for</span> (;;)<font></font>
	{<font></font>
		status = Xil_In32(<span class="hljs-number">0x43c0000c</span>);
		<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x01</span> || status == <span class="hljs-number">0x03</span>)<font></font>
		{<font></font>
			<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0x03</span>)<font></font>
			{<font></font>
				xil_printf(<span class="hljs-string">"Error in write! \n\r"</span>);<font></font>
			}<font></font>
			<span class="hljs-keyword">break</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">else</span><font></font>
		{<font></font>
			cntrDuration++;<font></font>
			usleep(<span class="hljs-number">100</span>);<font></font>
		}<font></font>
	}<font></font>
<font></font>
	<span class="hljs-comment">/** Duration operation */</span><font></font>
	durationErase += cntrDuration;<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cntrDuration &gt; MaxErase )<font></font>
	{<font></font>
		MaxErase = cntrDuration;<font></font>
	}<font></font>
<font></font>
	cntrDuration = <span class="hljs-number">0x00</span>;<font></font>
<font></font>
	<span class="hljs-comment">/** Clear start */</span>
	Xil_Out32(<span class="hljs-number">0x43c00000</span>, <span class="hljs-number">0</span>);<font></font>
<font></font>
	SectorAddress += <span class="hljs-number">7</span>;<font></font>
}<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test completely on github.</font></font></a><br>
<br>
<a name="Results"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Results</font></font></h2><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Amount of data</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reading </font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Record</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erase </font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 block (512 bytes)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.7 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.36 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.58 Mbps</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 blocks (4096 bytes)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15.4 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.38 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.66 Mbps</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 blocks (8192 bytes)</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">18.82 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11.26 Mbps</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.79 Mbps</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A 16 GB card was used. </font><font style="vertical-align: inherit;">During testing, 2 GB of data was recorded, 2 GB of data was read, and 2 GB of data was erased. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The conclusions are disappointing. </font><font style="vertical-align: inherit;">When using FPGA, it makes no sense to use the SD card in SPI mode, except for the case when it is very necessary to store large amounts of data without presenting speed requirements.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495388/index.html">1970s television show that became an ancestor of eSports</a></li>
<li><a href="../en495390/index.html">STM32CubeMonitor is worth a try</a></li>
<li><a href="../en495392/index.html">How to search for bugs on the front end: 4 main stages</a></li>
<li><a href="../en495396/index.html">First impression of concepts</a></li>
<li><a href="../en495398/index.html">Ro.Ri.Re</a></li>
<li><a href="../en495402/index.html">Last year, we finally photographed a black hole. Now what?</a></li>
<li><a href="../en495404/index.html">Are sagging stocks promising? Let's analyze with python</a></li>
<li><a href="../en495408/index.html"># 02 - And a whole byte is not enough ... | The cross of changes</a></li>
<li><a href="../en495412/index.html">Norbert Wiener. An interesting person. Colleagues, enemies, struggle for independence</a></li>
<li><a href="../en495414/index.html">Consequences of fear</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>