<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😞 😑 🔖 Un moyen simple de protéger votre Mikrotik des attaques 🏇🏿 🤗 🧑🏾‍🤝‍🧑🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je souhaite partager avec la communauté une manière simple et pratique d'utiliser Mikrotik pour protéger mon réseau et mes services qui «surveillent» ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Un moyen simple de protéger votre Mikrotik des attaques</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499146/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je souhaite partager avec la communauté une manière simple et pratique d'utiliser Mikrotik pour protéger mon réseau et mes services qui «surveillent» les attaques externes. À savoir, avec seulement trois règles, organiser un pot de miel sur Mikrotik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginons donc que nous ayons un petit bureau, une adresse IP externe derrière laquelle se trouve un serveur RDP, pour que les employés puissent travailler à distance. La première règle est bien sûr de changer le port 3389 de l'interface externe en un autre. Mais ce n'est pas pour longtemps, après quelques jours, le journal d'audit du serveur Terminal Server commencera à afficher plusieurs autorisations infructueuses par seconde de clients inconnus.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre situation, vous avez un astérisque caché derrière Mikrotik, bien sûr, pas sur le port 5060 udp, et après quelques jours, la devinette du mot de passe commence également ... oui oui, je sais, fail2ban est notre affaire, mais je dois encore gonfler dessus ... par exemple, je l'ai récemment levé pour ubuntu Le 18 avril, j'ai été surpris de constater que fail2ban ne contient pas les paramètres réels pour l'astérisque de la même boîte de la même distribution ubuntu ... mais Google ne peut pas google paramétrer rapidement les "recettes" prêtes à l'emploi, le nombre de versions augmente au fil des ans et les articles avec " recettes "pour les anciennes versions ne fonctionnent plus, mais presque pas de nouvelles ... Mais quelque chose que je m'éloigne ...</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, ce qui est un pot de miel en un mot - est un leurre, dans notre cas, un port populaire sur une IP externe, toute demande à ce port d'un client externe envoie l'adresse src à la liste noire. </font><font style="vertical-align: inherit;">Tout.</font></font><br>
 <br>
<pre><code class="plaintext hljs">/ip firewall filter<font></font>
add action=add-src-to-address-list address-list="Honeypot Hacker" \<font></font>
    address-list-timeout=30d0h0m chain=input comment="block honeypot ssh rdp winbox" \<font></font>
    connection-state=new dst-port=22,3389,8291 in-interface=\<font></font>
    ether4-wan protocol=tcp<font></font>
add action=add-src-to-address-list address-list="Honeypot Hacker" \<font></font>
    address-list-timeout=30d0h0m chain=input comment=\<font></font>
    "block honeypot asterisk" connection-state=new dst-port=5060 \<font></font>
    in-interface=ether4-wan protocol=udp <font></font>
/ip firewall raw<font></font>
add action=drop chain=prerouting in-interface=ether4-wan src-address-list=\<font></font>
    "Honeypot Hacker"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première règle sur les ports TCP populaires 22, 3389, 8291 de l'interface externe ether4-wan envoie l'IP invité à la liste Honeypot Hacker (les ports pour ssh, rdp et winbox sont désactivés à l'avance ou modifiés pour d'autres). Le second fait de même sur le populaire UDP 5060. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La troisième règle à l'étape de pré-routage supprime les paquets des "invités" dont l'adresse srs est entrée dans le "Honeypot Hacker". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après deux semaines de travail chez moi, Mikrotik, la liste Honeypot Hacker comprenait environ un millier et demi d'adresses IP de fans respectueux de la mamelle de mes ressources réseau (téléphonie domestique, courrier, nextcloud, rdp). Les attaques par force brute ont cessé, le bonheur s'est ensuivi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au travail, tout ne s'est pas avéré si simple, ils continuent de casser le serveur rdp avec des attaques par force brute.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apparemment, le numéro de port a été déterminé par le scanner bien avant que le pot de miel ne soit allumé, et pendant la quarantaine, il n'est pas si facile de reconfigurer plus de 100 utilisateurs, dont 20% ont plus de 65 ans. </font><font style="vertical-align: inherit;">Dans le cas où le port ne peut pas être changé, il existe une petite recette de travail. </font><font style="vertical-align: inherit;">J'ai rencontré des semblables sur Internet, mais il y a un réglage fin et fin:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Règles de configuration du port Knocking</font></font></b>
                        <div class="spoiler_text"> <pre><code class="plaintext hljs"> /ip firewall filter<font></font>
add action=add-src-to-address-list address-list=rdp_blacklist \<font></font>
    address-list-timeout=15m chain=forward comment=rdp_to_blacklist \<font></font>
    connection-state=new dst-port=3389 protocol=tcp src-address-list=\<font></font>
    rdp_stage12<font></font>
add action=add-src-to-address-list address-list=rdp_stage12 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage11<font></font>
add action=add-src-to-address-list address-list=rdp_stage11 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage10<font></font>
add action=add-src-to-address-list address-list=rdp_stage10 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage9<font></font>
add action=add-src-to-address-list address-list=rdp_stage9 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage8<font></font>
add action=add-src-to-address-list address-list=rdp_stage8 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage4<font></font>
add action=add-src-to-address-list address-list=rdp_stage7 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage6<font></font>
add action=add-src-to-address-list address-list=rdp_stage6 \<font></font>
    address-list-timeout=4m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage5<font></font>
add action=add-src-to-address-list address-list=rdp_stage5 \<font></font>
    address-list-timeout=2m chain=forward connection-state=new dst-port=\<font></font>
    3389 protocol=tcp src-address-list=rdp_stage4<font></font>
add action=add-src-to-address-list address-list=rdp_stage4 \<font></font>
    address-list-timeout=2m chain=forward connection-state=new dst-port=\<font></font>
    3389 protocol=tcp src-address-list=rdp_stage3<font></font>
add action=add-src-to-address-list address-list=rdp_stage3 \<font></font>
    address-list-timeout=2m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage2<font></font>
add action=add-src-to-address-list address-list=rdp_stage2 \<font></font>
    address-list-timeout=2m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp src-address-list=rdp_stage1<font></font>
add action=add-src-to-address-list address-list=rdp_stage1 \<font></font>
    address-list-timeout=2m chain=forward connection-state=new dst-port=3389 \<font></font>
    protocol=tcp <font></font>
/ip firewall raw<font></font>
add action=drop chain=prerouting in-interface=ether4-wan src-address-list=\<font></font>
rdp_blacklist<font></font>
</code></pre> </div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 4 minutes, le client distant n'est autorisé à faire que 12 nouvelles «demandes» au serveur RDP. </font><font style="vertical-align: inherit;">Une tentative de connexion est de 1 à 4 «demandes». </font><font style="vertical-align: inherit;">À la 12e «demande» - une serrure pendant 15 minutes. </font><font style="vertical-align: inherit;">Dans mon cas, les attaquants n'ont pas arrêté de pirater le serveur, ils se sont adaptés aux temporisateurs et maintenant ils le font très lentement, une telle vitesse de sélection réduit l'efficacité de l'attaque à zéro. </font><font style="vertical-align: inherit;">Les employés de l'entreprise ne subissent pratiquement aucun inconvénient dans le travail effectué.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un autre petit truc</font></font></b>
                        <div class="spoiler_text">            5,     ,     .<br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter <font></font>
add action=add-src-to-address-list address-list=rdp_blacklist \<font></font>
    address-list-timeout=1w0d0h0m chain=forward comment=\<font></font>
    "night_rdp_blacklist" connection-state=new disabled=\<font></font>
    yes dst-port=3389 protocol=tcp src-address-list=rdp_stage8</code></pre><br>
  8    IP       . !<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, en plus de ce qui précède, j'ajouterai un lien vers l'article Wiki, avec le paramètre de travail de protection de Mikrotik contre les scanners réseau. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki.mikrotik.com/wiki/Drop_port_scanners</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sur mes appareils, ce paramètre fonctionne en conjonction avec les règles du pot de miel décrites ci-dessus, en les complétant bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD: Comme suggéré dans les commentaires, la règle de suppression de paquets a été déplacée vers RAW pour réduire la charge sur le routeur.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499130/index.html">BlockAdBlock Advertising Anti-Blocking Reverse Engineering</a></li>
<li><a href="../fr499134/index.html">4 étapes pour augmenter le produit LTV grâce à la communication avec les utilisateurs</a></li>
<li><a href="../fr499136/index.html">#BeeFree, ou ... Beeline - vous n'avez pas pu résister?</a></li>
<li><a href="../fr499138/index.html">Tri topologique</a></li>
<li><a href="../fr499140/index.html">Génération sous contrôle: comment freiner les modèles de langage puissants</a></li>
<li><a href="../fr499148/index.html">Aérosol et dioxyde de chlore (ClO2): comment est-ce lié?</a></li>
<li><a href="../fr499150/index.html">Et un guerrier sur le terrain: est-il possible de fournir des services d'hébergement de qualité sans équipe</a></li>
<li><a href="../fr499152/index.html">DLL et Python</a></li>
<li><a href="../fr499154/index.html">Le condensé de matériaux intéressants pour le développeur mobile # 342 (du 20 au 26 avril)</a></li>
<li><a href="../fr499160/index.html">SCRUM russe. Insensé et impitoyable</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>