<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✍🏽 😸 📟 仮想テーブルテーブルとは何ですか？ 🛀🏿 📄 👨🏻‍💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Slackで、C ++の頭字語用語集の新しい頭字語「VTT」に出くわしました。ゴッドボルト：
 
 

test.o: In function `MyClass': test.cc:3: undefined reference to `VTT for MyClass'
 この文脈での「VTT」は「仮...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>仮想テーブルテーブルとは何ですか？</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474318/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slackで、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++の頭字語用語集の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい頭字語</font><font style="vertical-align: inherit;">「VTT」に</font><font style="vertical-align: inherit;">出くわしました</font><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゴッドボルト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">test.o: In function `MyClass':<font></font>
test.cc:3: undefined reference to `VTT for MyClass'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この文脈での「VTT」は「仮想テーブルテーブル」を意味します。</font><font style="vertical-align: inherit;">これは、仮想基本クラスから継承される基本クラスを作成するときに（Itanium C ++ ABIで）使用される補助データ構造です。</font><font style="vertical-align: inherit;">VTTは、仮想テーブル（vtable）およびタイプ情報（typeinfo）と同じレイアウトルールに従っているため、上記のエラーが発生した場合は、「VTT」を「vtable」に置き換えてデバッグを開始できます。</font><font style="vertical-align: inherit;">（おそらく、</font><font style="vertical-align: inherit;">クラスの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要な機能を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> undefinedのままにしました</font><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">VTTまたは同様の構造が必要な理由を確認するために、基本から始めましょう。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非仮想継承の設計順序</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
継承階層がある場合、基本クラスは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最も基本的なから</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構築さ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">れ</font></a><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">チャーリーを作成するには、まず彼の親クラスであるMrsBucketとMrBucketを再帰的に作成し、MrBucketを作成するにはまず彼の親クラスであるGrandmaJosephineとGrandpaJoeを作成する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A</span> {</span>};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">B</span> :</span> A {};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">C</span> {</span>};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">D</span> :</span> C {};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">E</span> :</span> B, D {};<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-comment">// A B C D E</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮想基本クラスの設計順序</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、仮想継承はすべてのカードを混乱させます！</font><font style="vertical-align: inherit;">仮想継承を使用すると、2つの異なる親クラスが共通の祖先を共有できる菱形の階層を作成できます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">G</span> {</span>};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">M</span> :</span> <span class="hljs-keyword">virtual</span> G {};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">F</span> :</span> <span class="hljs-keyword">virtual</span> G {};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">E</span> :</span> M, F {};<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-comment">// G M F E</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前のセクションでは、各コンストラクターは、その基本クラスのコンストラクターを呼び出す責任がありました。しかし、今では仮想継承があり、コンストラクタMとFは、Gを構築する必要がないことを何らかの形で知っている必要があります。この場合、MとFがベースオブジェクトの作成を担当する場合、共通のベースオブジェクトは2回作成されるため、あまり良くありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itanium C ++ ABIは、仮想継承サブオブジェクトを操作するために、各コンストラクターを2つの部分（基本オブジェクトコンストラクターと完全オブジェクトコンストラクター）に分割します。基本オブジェクトのコンストラクターは、すべての非仮想継承サブオブジェクト（およびそのサブオブジェクト）を構築し、それらのvptrをvtableにインストールし、コードを中括弧で囲んでC ++コードで実行します。完全なC ++オブジェクトを作成するたびに呼び出される完全なオブジェクトのコンストラクターは、派生オブジェクトのすべての仮想継承サブオブジェクトを作成し、残りを実行します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前のセクションのABCDEの例と次の例の違いを検討してください。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">A</span> {</span>};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">B</span> :</span> <span class="hljs-keyword">virtual</span> A {};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">C</span> {</span>};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">D</span> :</span> <span class="hljs-keyword">virtual</span> C {};
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">E</span> :</span> B, D {};<font></font>
<font></font>
<span class="hljs-comment">//    </span>
<span class="hljs-comment">// A C B D E</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完全なオブジェクトEのコンストラクターは、最初に仮想サブオブジェクトAおよびCの基本オブジェクトのコンストラクターを呼び出します。</font><font style="vertical-align: inherit;">次に、ベースの非仮想継承オブジェクトBおよびDのコンストラクターが呼び出され、BおよびDは、それぞれAおよびCの構築を担当しなくなります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vtableテーブルの設計</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、次のようないくつかの仮想メソッドを持つクラスがあるとします（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Godbolt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Cat</span> {</span><font></font>
    Cat() { poke(); }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">poke</span><span class="hljs-params">()</span> </span>{ <span class="hljs-built_in">puts</span>(<span class="hljs-string">"meow"</span>); }<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Lion</span> :</span> Cat {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> roar = <span class="hljs-string">"roar"</span>;<font></font>
    Lion() { poke(); }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">poke</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{<font></font>
        roar += <span class="hljs-string">'!'</span>;
        <span class="hljs-built_in">puts</span>(roar.c_str());<font></font>
    }<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lionを構築するとき、基本的なCatサブオブジェクトを構築することから始めます。 Catのコンストラクタはpoke（）を呼び出します。この時点では、Catオブジェクトは1つしかありません。Lionオブジェクトを作成するために必要なメンバーデータはまだ初期化していません。 CatコンストラクターがLion :: poke（）を呼び出すと、初期化されていないメンバーstd ::文字列のうなり声を変更しようとし、UBを取得します。したがって、C ++標準では、Catコンストラクターでこれを行う必要があります。poke（）仮想メソッドの呼び出しでは、Lion :: poke（）ではなくCat :: poke（）を呼び出す必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題はない。</font><font style="vertical-align: inherit;">コンパイラーは、単にオブジェクトのvptrをCatオブジェクトのvtableに設定することで、Cat :: Cat（）（基本オブジェクトのバージョンと完全オブジェクトのバージョンの両方）を開始します。</font><font style="vertical-align: inherit;">Lion :: Lion（）は、Cat :: Cat（）を呼び出し、vptrをLion内のCatオブジェクトのvtableテーブルへのポインターにリセットしてから、括弧内のコードを実行します。</font><font style="vertical-align: inherit;">問題ない！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仮想継承オフセット</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
猫に実質的に動物を継承させます。</font><font style="vertical-align: inherit;">次に、Catのvtableは、Cat仮想メンバー関数の関数ポインターだけでなく、Cat内のAnimal仮想サブオブジェクトのオフセットも格納します。</font><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゴッドボルト</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Animal</span> {</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *data = <span class="hljs-string">"hi"</span>;<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Cat</span> :</span> <span class="hljs-keyword">virtual</span> Animal {<font></font>
    Cat() { <span class="hljs-built_in">puts</span>(data); }<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Nermal</span> :</span> Cat {};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Garfield</span> :</span> Cat {
    <span class="hljs-keyword">int</span> padding;<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Catコンストラクターは、メンバーAnimal ::データを照会します。このCatオブジェクトがNermalオブジェクトの基本サブオブジェクトである場合、そのメンバーデータはvptrの直後のオフセット8にあります。ただし、CatオブジェクトがGarfieldオブジェクトの基になるサブオブジェクトである場合、メンバーデータはvptrおよびGarfield ::パディングの後ろのオフセット16にあります。この状況を処理するために、Itanium ABIは仮想ベースオブジェクトのオフセットをCatオブジェクトのvtableに格納します。 Cat-in-Nermalのvtableは、基になるCatサブオブジェクトであるAnimalがオフセット8に格納されるという事実を保持します。 Cat-in-Garfieldのvtableは、基になるCatサブオブジェクトであるAnimalがオフセット16に格納されるという事実を保持しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを前のセクションと組み合わせます。コンパイラーは、Cat :: Cat（）（基本オブジェクトバージョンと完全オブジェクトバージョンの両方）が、タイプに応じて、Cat-in-NermalのvtableまたはCat-in-Garfieldのvtableにvptrをインストールすることから始まることを確認する必要があります。ほとんどの派生施設！しかし、それはどのように機能しますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も派生したオブジェクトの完全なオブジェクトのコンストラクターは、オブジェクトの構築時にベースサブオブジェクトのvptrが参照するテーブルvtableを事前に計算する必要があり、最も派生したオブジェクトの完全なオブジェクトのコンストラクターは、この情報をベースサブオブジェクトのベースオブジェクトのコンストラクターに渡す必要があります。隠しパラメータとして！ Cat :: Cat（）（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Godbolt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">の生成コードを見てみましょう</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs">_ZN3CatC1Ev: #    Cat<font></font>
  movq $_ZTV3Cat+<span class="hljs-number">24</span>, (%rdi)  <span class="hljs-meta"># this-&gt;vptr = &amp;vtable-for-Cat;</span><font></font>
  retq<font></font>
<font></font>
_ZN3CatC2Ev: #     <span class="hljs-function">Cat
  <span class="hljs-title">movq</span> <span class="hljs-params">(%rsi)</span>, %rax  <span class="hljs-meta"># fetch a value from rsi</span>
  movq %rax, <span class="hljs-params">(%rdi)</span>  <span class="hljs-meta"># this-&gt;vptr = *rsi;</span>
  retq</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ベースオブジェクトのコンストラクターは、％rdiのこの非表示パラメーターだけでなく、％rsi！の非表示VTTパラメーターも受け入れます。</font><font style="vertical-align: inherit;">基本オブジェクトコンストラクターは（％rsi）からアドレスを読み込み、アドレスをCatオブジェクトのvtableに格納します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ベースのCatオブジェクトのコンストラクターを呼び出す人は誰でも、vptrに書き込むべきCat :: Cat（）アドレスを予測し、そのアドレスに（％rsi）でポインターを設定する責任があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜ別のレベルのアイデンティティが必要なのですか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完全なNermalオブジェクトのコンストラクターを考えてみましょう。</font></font><br>
<br>
<pre><code class="cpp hljs">_ZN3CatC2Ev: #    <span class="hljs-function">Cat
  <span class="hljs-title">movq</span> <span class="hljs-params">(%rsi)</span>, %rax  #    rsi
  movq %rax, <span class="hljs-params">(%rdi)</span>  <span class="hljs-meta"># this-&gt;vptr = *rsi;</span>
  retq
_ZN6NermalC1Ev: #    Nermal
  pushq %rbx
  movq %rdi, %rbx
  movl $_ZTT6Nermal+8, %esi    # %rsi </span>= &amp;VTT-<span class="hljs-keyword">for</span>-Nermal<font></font>
  callq _ZN3CatC2Ev            #     Cat<font></font>
  movq $_ZTV6Nermal+<span class="hljs-number">24</span>, (%rbx) <span class="hljs-meta"># this-&gt;vptr = &amp;vtable-for-Nermal</span><font></font>
  popq %rbx<font></font>
  retq<font></font>
_ZTT6Nermal:<font></font>
  .quad _ZTV6Nermal+<span class="hljs-number">24</span>         <span class="hljs-meta"># vtable-for-Nermal</span>
  .quad _ZTC6Nermal0_3Cat+<span class="hljs-number">24</span>   <span class="hljs-meta"># construction-vtable-for-Cat-in-Nermal</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
_ZTC6Nermal0_3Cat + 24がデータセクションにあり、そのアドレスが_ZTC6Nermal0_3Cat + 24を直接渡すのではなく、％rsiに渡されるのはなぜですか？</font></font><br>
<br>
<pre><code class="cpp hljs">#   ?<font></font>
<font></font>
_ZN3CatC2Ev: #     Cat<font></font>
  movq %rsi, (%rdi)  <span class="hljs-meta"># this-&gt;vptr = rsi;</span><font></font>
  retq<font></font>
_ZN6NermalC1Ev: #     Nermal<font></font>
  pushq %rbx<font></font>
  movq %rdi, %rbx<font></font>
  movl $_ZTC6Nermal0_3Cat+<span class="hljs-number">24</span>, %esi # %rsi = &amp;construction-vtable-<span class="hljs-keyword">for</span>-Cat-in-Nermal<font></font>
  callq _ZN3CatC2Ev                #     Cat<font></font>
  movq $_ZTV6Nermal+<span class="hljs-number">24</span>, (%rbx)     # <span class="hljs-keyword">this</span>-&gt;vptr = &amp;vtable-<span class="hljs-keyword">for</span>-Nermal<font></font>
  popq %rbx<font></font>
  retq</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、複数のレベルの継承が可能なためです。</font><font style="vertical-align: inherit;">各継承レベルで、ベースオブジェクトのコンストラクターはvptrを設定し、制御をチェーンのさらに下の次のベースコンストラクターに渡す必要があります。これにより、vptrsを他の値に設定できます。</font><font style="vertical-align: inherit;">これは、vtableへのポインタのリストまたはテーブルを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここに具体的な例があります（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Godbolt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VB</span> {</span>
    <span class="hljs-keyword">int</span> member_of_vb = <span class="hljs-number">42</span>;<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Grandparent</span> :</span> <span class="hljs-keyword">virtual</span> VB {<font></font>
    Grandparent() {}<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Parent</span> :</span> Grandparent {<font></font>
    Parent() {}<font></font>
};<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Gretel</span> :</span> Parent {<font></font>
    Gretel() : VB{<span class="hljs-number">1000</span>} {}<font></font>
};<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Hansel</span> :</span> Parent {
    <span class="hljs-keyword">int</span> padding;<font></font>
    Hansel() : VB{<span class="hljs-number">2000</span>} {}<font></font>
};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grandparent基本コンストラクターオブジェクトは、vptrをGrandparentに設定する必要があります—これは、最も派生したクラスです。</font><font style="vertical-align: inherit;">Parentベースオブジェクトのコンストラクターは、最初に適切な％rsiを使用してGrandparent :: Grandparent（）を呼び出し、次にvptrをParentに設定する必要があります。これは、最も派生したクラスです。</font><font style="vertical-align: inherit;">これをGretelに実装する方法：</font></font><br>
<br>
<pre><code class="cpp hljs">Gretel::Gretel() [  ]:<font></font>
  pushq %rbx<font></font>
  movq %rdi, %rbx<font></font>
  movl $<span class="hljs-number">1000</span>, <span class="hljs-number">8</span>(%rdi) <span class="hljs-meta"># imm = 0x3E8</span>
  movl $VTT <span class="hljs-keyword">for</span> Gretel+<span class="hljs-number">8</span>, %<span class="hljs-function">esi
  callq <span class="hljs-title">Parent::Parent</span><span class="hljs-params">()</span> [  ]
  movq $vtable <span class="hljs-keyword">for</span> Gretel+24, <span class="hljs-params">(%rbx)</span>
  popq %rbx
  retq
VTT <span class="hljs-keyword">for</span> Gretel:
  .quad vtable <span class="hljs-keyword">for</span> Gretel+24
  .quad construction vtable <span class="hljs-keyword">for</span> Parent-in-Gretel+24
  .quad construction vtable <span class="hljs-keyword">for</span> Grandparent-in-Gretel+24</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Godboltを見ると、Parentクラスのベースオブジェクトのコンストラクターが最初にGrandparent :: Grandparent（）を％rsi + 8で呼び出してから、独自のvptrを（％rsi）に設定していることがわかります。そこで、ここでは、Gretelがいわば、構築中にすべての基本クラスがたどるパンくずリストを慎重に配置したという事実を使用しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じVTTがデストラクタで使用されています（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Godbolt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">私の知る限り、VTTテーブルのnull行は使用されません。</font><font style="vertical-align: inherit;">GretelコンストラクターはGretel + 24のvtableをvptrにロードしますが、このアドレスは静的であることを知っているため、VTTからロードする必要はありません。</font><font style="vertical-align: inherit;">テーブルのゼロ行は単に歴史的な理由で保存されたと思います。</font><font style="vertical-align: inherit;">（もちろん、Itanium ABIに違反し、Itanium-ABIに準拠している古いコードにリンクすることは不可能であるため、コンパイラーはそれを破棄することはできません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以上が、仮想テーブルのテーブル、つまりVTTです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに詳しい情報</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VTT情報は次の場所にあります</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。StackOverflow：“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスのVTTは何ですか？</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">” </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=http://web.archive.org/web/20190930143149/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GCC C ++コンパイラv4.0.1での複数継承に関するVTableの注釈</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”（Morgan Deters、2005）</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Itanium C ++ ABI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、「VTT Order」セクション</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、VTTはItanium C ++ ABIの機能であり、Linuxで使用されることを繰り返します。 、OSXなど </font><font style="vertical-align: inherit;">Windowsで使用されるMSVC ABIにはVTTがなく、仮想継承にまったく異なるメカニズムを使用します。</font><font style="vertical-align: inherit;">私は（今のところ）MSVC ABIについてほとんど何も知りませんが、多分いつか私はすべてを見つけてそれについて投稿を書くでしょう！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja474306/index.html">ポインティング、フォーカス、アクティブ状態のスタイルを変える。</a></li>
<li><a href="../ja474308/index.html">Pythonで記述されたHTTP APIのタイプ：Instagramの経験</a></li>
<li><a href="../ja474310/index.html">CSSに乱数はありますか？</a></li>
<li><a href="../ja474312/index.html">Windows Server CoreへのGUIのインストール</a></li>
<li><a href="../ja474316/index.html">自家製の電気自動車-パート1.すべての始まりと、YouTubeでの1,000,000回の視聴の記録</a></li>
<li><a href="../ja474320/index.html">DDDコミュニティ危機</a></li>
<li><a href="../ja474322/index.html">ScalaConf 2019-John Preacher、Holy Grail、およびHaskell教授</a></li>
<li><a href="../ja474324/index.html">Почему Солнце вращается вокруг Земли</a></li>
<li><a href="../ja474326/index.html">CIとCDの違いを理解する：「何かが痛みを引き起こした場合、より頻繁に行う」</a></li>
<li><a href="../ja474330/index.html">モバイル開発者向けの興味深い資料の要約＃320（10月28日-11月3日）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>