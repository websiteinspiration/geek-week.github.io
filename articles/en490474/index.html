<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèÇüèø ‚ö±Ô∏è ü•ä STM32 Part 1: The Basics ‚ùî üë©üèª‚Äçüéì üò©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You cannot trust code that you did not write completely yourself. - Ken ThompsonPerhaps my favorite quote. It was she who became the reason why I deci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32 Part 1: The Basics</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490474/"><blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You cannot trust code that you did not write completely yourself. </font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Ken Thompson</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perhaps my favorite quote. It was she who became the reason why I decided to dive into the very depths of the rabbit hole. I started my journey into the world of programming quite recently, only about a month passed and I decided to write articles to consolidate the material. It all started with a simple task, to synchronize the lamps in your photo studio using Arduina. The problem was solved, but I did not go into the photo studio anymore, there is no time. From that moment, I decided to thoroughly engage in microcontroller programming. Arduin, although attractive in its simplicity, I did not like the platform. The choice fell on the company ST and their popular products. At that moment, I still had no idea what the difference was, but as a typical consumer I compared the speed of the ‚Äúprocessor‚Äù and the amount of memory, I bought myself an impressive board with a STM32F746NG display - Discovery.I will miss the moments of despair and get right to the point.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immersed in the image of a programmer, I read a lot, studied, experimented. </font><font style="vertical-align: inherit;">And as I already described above, I wanted to study well, that's all. </font><font style="vertical-align: inherit;">And for this I set a goal, not any ready-made solutions, only mine. </font><font style="vertical-align: inherit;">And if everything worked out for me then you will succeed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
List of everything you need:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ubuntu</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16+ </font><font style="vertical-align: inherit;">virtual machine </font><font style="vertical-align: inherit;">or whatever</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arm</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compiler - download at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads</font></font></a> </li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">openocd</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debugger and programmer - you won‚Äôt be able to download from the link, we collect from the sources, the instruction is attached</font></font><br>
<br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://git.code.sf.net/p/openocd/code openocd</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Text editor to your liking</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After everything is installed and assembled, we can proceed to the first project! </font><font style="vertical-align: inherit;">And no, it's not even a blinking light bulb. </font><font style="vertical-align: inherit;">To begin with, we must delve into the initialization process of the microwell itself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What we need:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Makefile </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Linker.ld</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Init.c</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the last paragraph Init.c. </font><font style="vertical-align: inherit;">First of all, our mk should load the address "stack pointer" is a pointer to the memory address that is used for the PUSH and POP instructions. </font><font style="vertical-align: inherit;">I strongly recommend that you thoroughly study these two instructions, as I will not explain in detail all the instructions. </font><font style="vertical-align: inherit;">How to implement this, see below.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's look at this example. </font><font style="vertical-align: inherit;">Extern means that the symbol is external, and we declared this symbol in the Linker.ld file, we will return to it a bit later.</font></font><br>
<br>
<pre><code class="cpp hljs"> __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Here we use an attribute that tells the compiler to place the array in the isr_vector section and that even if we do not use it in the code, it still must be included in the program. And its first element will be that same pointer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's figure out why this array is and what it will be eaten with. Unlike a conventional processor, mic on the arm architecture starts execution when not from the zero address, but from the address pointed to by the pointer in this array, everything is complicated. Also, the first pointer in this array always points to the beginning of the stack, but the second already points to the beginning of our code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will give an example. it is given that the stack begins with 0x20010000 and the program code is 0x0800008. then the array can be written as</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {
    <span class="hljs-number">0x20010000</span>,
    <span class="hljs-number">0x08000008</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, the controller first initializes the stack, and then considers the address of the first instruction and loads it into the program counter register. Now the most important thing, depending on the model, these numbers may be different, but with the example of stm32f7 I can confidently say that this array should be in memory at the address 0x08000000. It is from this address that mk will start its work after turning on or reset. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we will stop and pay attention to how to put this array in the section we need. This is done by "ld" or linker. This program collects our entire program together and the Linker.ld script is used for this. I give an example and further analyze it.</font></font><br>
<br>
<pre><code class="plaintext hljs">MEMORY{<font></font>
	ROM_AXIM (rx) : ORIGIN = 0x08000000, LENGTH = 1M<font></font>
	RAM_DTCM (rwx): ORIGIN = 0x20000000, LENGTH = 64K<font></font>
}<font></font>
<font></font>
_estack = LENGTH(RAM_DTCM) + ORIGIN(RAM_DTCM);<font></font>
<font></font>
SECTIONS{<font></font>
	.isr_vector : {<font></font>
	KEEP(*(.isr_vector))<font></font>
	} &gt;ROM_AXIM&lt;/code&gt;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let‚Äôs see what happens here. MEMORY defines sections of memory and SECTIONS defines sections. here we see our _estack and the fact that it is equal to the sum of the beginning of memory and its length, that is, the end of our memory. The .isr_vector section in which we put our array is also defined. </font></font><code>&gt;ROM_AXIM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at the end of our section means that this section should be placed in the memory section that starts with 0x08000000 as required by our microns. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We put the array where it is necessary now we need some kind of instruction for our micron to work. Here is the augmented init.c:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *_estack;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Reset_Handler</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">void</span> *vectors[] __attribute__((section(<span class="hljs-string">".isr_vector"</span>), used)) = {<font></font>
    &amp;_estack,<font></font>
    &amp;Reset_Handler<font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">void</span> __attribute__((naked, noreturn)) Reset_Handler()<font></font>
{<font></font>
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I mentioned earlier, the second address must be a pointer to the first function or instruction. </font><font style="vertical-align: inherit;">And again, the attributes, but everything is simple, the function does not return any values ‚Äã‚Äãand follows any ABI at the entrance, that is, naked ‚Äúnaked‚Äù. </font><font style="vertical-align: inherit;">In such functions, the usual assembler is shoved. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now is the time to compile our code, and see what's under the hood. </font><font style="vertical-align: inherit;">We will not touch the Makefile for now.</font></font><br>
<br>
<pre><code class="bash hljs">arm-none-eabi-gcc -c init.c -o init.o -mthumb</code></pre><br>
<pre><code class="bash hljs">arm-none-eabi-gcc -TLinker.ld -o prog.elf init.o -Wl,--gc-sections -nostartfiles -nodefaultlibs -nostdlib</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here we see a lot of incomprehensible. </font><font style="vertical-align: inherit;">in order:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-mthumb compile for armv7, which uses only thumb instructions </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-TLinker.ld specify the linker script. </font><font style="vertical-align: inherit;">by default, it compiles for execution in the Linux environment</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-Wl, - gc-sections -nostartfiles -nodefaultlibs -nostdlib remove all standard libraries, environment C initialization files, and all other auxiliary libraries such as mathematics.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, there‚Äôs no sense in loading this into microns. </font><font style="vertical-align: inherit;">But there is a sense in viewing and studying the binary.</font></font><br>
<br>
<pre><code class="bash hljs">objcopy -O ihex prog.elf prog.bin</code></pre><br>
<pre><code class="bash hljs">hexdump prog.bin</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And then we will see the conclusion. </font><font style="vertical-align: inherit;">‚Äú00000000: 00 01 00 02 09 00 00 08‚Äù which will symbolize our success. </font><font style="vertical-align: inherit;">This is my first article and I was not able to fully reveal all the material and essence, so in the next I will describe the mechanisms in more detail and we friends will be able to move on to a program that will not blink a light, but configure the clock of the processor and buses.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490462/index.html">Monopoly of services and Net Neutrality - berries will be ahead</a></li>
<li><a href="../en490464/index.html">About an unsuccessful attempt to brute force copyright or 68 billion tunes that will not change anything</a></li>
<li><a href="../en490466/index.html">Roadmap of Mathematical Disciplines for Machine Learning, Part 2 (Probabilities)</a></li>
<li><a href="../en490470/index.html">OWASP Moscow 2020/1</a></li>
<li><a href="../en490472/index.html">As I wrote a semi-decentralized cryptocurrency in PHP. (Part 1 - Collecting Libraries)</a></li>
<li><a href="../en490476/index.html">Wireless sensor for opening and closing with advanced functionality</a></li>
<li><a href="../en490478/index.html">DIY DIY Soldering Station v2</a></li>
<li><a href="../en490480/index.html">O Tiling-wm in 2 words</a></li>
<li><a href="../en490484/index.html">Managing smart home sensors with the Google Assistant</a></li>
<li><a href="../en490490/index.html">Weekend Reading: 10 materials on the effects of sound on health - from ‚Äúnoise hygiene‚Äù to good sleep and GTD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>