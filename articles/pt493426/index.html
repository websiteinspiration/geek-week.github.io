<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêº üë©‚Äçüëß‚Äçüë¶ ‚ûï Organiza√ß√£o do c√≥digo em microsservi√ßos e minha abordagem do uso da arquitetura hexagonal e DDD ‚ôíÔ∏è ü¶é üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! No Monolith, todo o c√≥digo deve estar no mesmo estilo e, em diferentes microsservi√ßos, voc√™ pode usar diferentes abordagens, linguagens de p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Organiza√ß√£o do c√≥digo em microsservi√ßos e minha abordagem do uso da arquitetura hexagonal e DDD</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493426/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ak/h6/c_/akh6c_safonprea6vtagzdaoy58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ol√° Habr! No Monolith, todo o c√≥digo deve estar no mesmo estilo e, em diferentes microsservi√ßos, voc√™ pode usar diferentes abordagens, linguagens de programa√ß√£o e estruturas. Para microsservi√ßos simples com 1 a 2 controladores e 1 a 10 a√ß√µes, n√£o h√° um sentido particular em bloquear camadas de abstra√ß√µes. Para microsservi√ßos complexos com estados diferentes e a l√≥gica de transi√ß√£o entre eles, pelo contr√°rio, √© melhor n√£o ser pregui√ßoso inicialmente. Quero falar sobre minha experi√™ncia na organiza√ß√£o de c√≥digos e no uso das abordagens DDD, portas e adaptadores para ambos os casos. H√° um breve resumo do artigo: junho - escreve o c√≥digo no controlador. Meio - escreve um monte de abstra√ß√µes. S√™nior - sabe quando escrever c√≥digo no controlador e quando s√£o necess√°rias abstra√ß√µes.</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui voc√™ precisa colocar imediatamente um fim para I - Portas em C # s√£o interface ou resumo, e Adaptadores s√£o implementa√ß√µes concretas (classe, estrutura). </font><font style="vertical-align: inherit;">Para refer√™ncia, recomendo a leitura desta tradu√ß√£o de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDD, Hexagonal, Cebola, Limpa, CQRS ... como eu reuni tudo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e este artigo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">equ√≠voco da Arquitetura Limpa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Aqui, lembre-se de que a abordagem √© descrita para um mon√≥lito grande e complexo. </font><font style="vertical-align: inherit;">Quero falar sobre as varia√ß√µes dessa abordagem em microsservi√ßos, 80% dos quais s√£o simples e 20 de m√©dia ou alta complexidade.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terminologia</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) PrimaryAdapters </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Introduzir uma interface amig√°vel para um </font><font style="vertical-align: inherit;">sistema de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chamada</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> externa </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ligue e use SecondaryApdapters and Logic. </font><font style="vertical-align: inherit;">Eles dizem ao aplicativo para fazer alguma coisa. </font><font style="vertical-align: inherit;">Pontos de entrada para o seu c√≥digo. </font><font style="vertical-align: inherit;">Representantes t√≠picos: ItemsService, CreateItemCommandHandler. </font><font style="vertical-align: inherit;">Use Logic e SecondaryAdapters para o trabalho deles.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) Adaptadores secund√°rios </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fornece uma interface para um </font><font style="vertical-align: inherit;">sistema </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chamado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> externo </font><font style="vertical-align: inherit;">, conveniente para uso por nosso sistema. </font><font style="vertical-align: inherit;">Ele recebe comandos do aplicativo. </font><font style="vertical-align: inherit;">Representantes t√≠picos: ItemsRepository, EmailSender, Logger, DistributedCache. </font><font style="vertical-align: inherit;">Eles usam bibliotecas e estruturas como EntityFramework para seu trabalho.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) L√≥gica</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1) Entidades</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Combine dados e l√≥gica. </font><font style="vertical-align: inherit;">Objetos OOP t√≠picos. </font><font style="vertical-align: inherit;">Item, Dinheiro, Usu√°rio. </font><font style="vertical-align: inherit;">H√° tamb√©m ValueObjects e eventos. </font><font style="vertical-align: inherit;">Apenas outros objetos da camada Entidades s√£o usados. </font><font style="vertical-align: inherit;">Em teoria, essa camada √© o n√∫cleo do aplicativo que n√£o depende de ningu√©m. </font><font style="vertical-align: inherit;">Todos dependem dele.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2) Servi√ßos de Dom√≠nio</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Computa√ß√£o nua. </font><font style="vertical-align: inherit;">Eles s√£o necess√°rios para a l√≥gica que n√£o pode ser anexada a uma entidade espec√≠fica. </font><font style="vertical-align: inherit;">Use Entidades ou outros Servi√ßos de Dom√≠nio. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> use PrimaryAdapters (eles sempre usam eles mesmos) e SecondaryAdapters. </font><font style="vertical-align: inherit;">Geralmente, esse √© todo o tipo de AmountCalculator, Validator e muito mais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O fluxo de chamada de c√≥digo sempre deve estar em uma dire√ß√£o PrimaryAdapters -&gt; Logic e SecondaryAdapters.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dom√≠nio</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa √© a √°rea de assunto para a qual o sistema est√° sendo desenvolvido. </font><font style="vertical-align: inherit;">Por exemplo, para a Loja Online do Dom√≠nio, √© Com√©rcio Eletr√¥nico.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexto limitado</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BoundedContext √© usado para dividir o sistema em partes isoladas com uma certa responsabilidade. Uma das maneiras de obter sucesso no design do sistema √© encontrar e destacar todos os seus BoundedContexts nele. Em uma arquitetura de microsservi√ßo, 1 microsservi√ßo = 1 BoundedContext. Por exemplo: Uma loja on-line pode ter um BoundedContext Shopping Cart e BoundedContext trabalhando com pedidos, BoundedContext trabalhando com arquivos. E um grande BoundedContext pode ser dividido em pequenos peda√ßos dentro. Por exemplo, para o BoundedContext da cesta de mercadorias, voc√™ pode fazer uma divis√£o no contexto de adicionar mercadorias √† cesta e no contexto de remover mercadorias da cesta. No mon√≥lito 1, um BoundedContext grande √© um m√≥dulo. Aqui √© necess√°rio fazer uma observa√ß√£o de que todas as Entidades vivem dentro de um contexto espec√≠fico, ou seja,Item do contexto da cesta de mercadorias e Item do contexto da vitrine de mercadorias, podem ser diferentes classes com diferentes campos e m√©todos. Em um mon√≥lito, eles simplesmente mapeiam um ao outro e usam algum ItemD para que o EF passe para trabalhar com o banco de dados e que possui campos comuns a todos, ou seja, se Item do contexto (m√≥dulo) do Cesto tiver a propriedade Property1 e Item do contexto da fachada da loja de mercadorias possui a propriedade Property2, o ItemDto ter√° a Property1 e a Property2. Em cada contexto, haver√° seu pr√≥prio reposit√≥rio, que retirar√° o Item, que j√° √© caracter√≠stico desse contexto, do banco de dados. Em microsservi√ßos, isso √© f√°cil. Cada um tem seu pr√≥prio banco de dados e sua pr√≥pria ess√™ncia. Cada servi√ßo mundial tem suas pr√≥prias classes. SimplesmenteEm um mon√≥lito, eles simplesmente mapeiam um ao outro e usam algum ItemD para que o EF passe para trabalhar com o banco de dados e que possui campos comuns a todos, ou seja, se Item do contexto (m√≥dulo) do Cesto tiver a propriedade Property1 e Item do contexto da montra de mercadorias possui a propriedade Property2, o ItemDto ter√° a Property1 e a Property2. Em cada contexto, haver√° seu pr√≥prio reposit√≥rio, que retirar√° o Item, que j√° √© caracter√≠stico desse contexto, do banco de dados. Em microsservi√ßos, isso √© f√°cil. Cada um tem seu pr√≥prio banco de dados e sua pr√≥pria ess√™ncia. Cada servi√ßo mundial tem suas pr√≥prias classes. SimplesmenteEm um mon√≥lito, eles simplesmente mapeiam um ao outro e usam algum ItemD para que o EF passe para trabalhar com o banco de dados e que possui campos comuns a todos, ou seja, se Item do contexto (m√≥dulo) do Cesto tiver a propriedade Property1 e Item do contexto da montra de mercadorias possui a propriedade Property2, o ItemDto ter√° a Property1 e a Property2. Em cada contexto, haver√° seu pr√≥prio reposit√≥rio, que retirar√° o Item, que j√° √© caracter√≠stico desse contexto, do banco de dados. Em microsservi√ßos, isso √© f√°cil. Cada um tem seu pr√≥prio banco de dados e sua pr√≥pria ess√™ncia. Cada servi√ßo mundial tem suas pr√≥prias classes. SimplesmenteEm cada contexto, haver√° seu pr√≥prio reposit√≥rio, que retirar√° o Item, que j√° √© caracter√≠stico desse contexto, do banco de dados. Em microsservi√ßos, isso √© f√°cil. Cada um tem seu pr√≥prio banco de dados e sua pr√≥pria ess√™ncia. Cada servi√ßo mundial tem suas pr√≥prias classes. SimplesmenteEm cada contexto, haver√° seu pr√≥prio reposit√≥rio, que retirar√° o Item, que j√° √© caracter√≠stico desse contexto, do banco de dados. Em microsservi√ßos, isso √© f√°cil. Cada um tem seu pr√≥prio banco de dados e sua pr√≥pria ess√™ncia. Cada servi√ßo mundial tem suas pr√≥prias classes. Simplesmente</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lembre-se de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que Item e ItemsRepository de diferentes BoundedContext podem ser objetos diferentes com m√©todos e propriedades diferentes. </font><font style="vertical-align: inherit;">Freq√ºentemente, o BoundedContext nos microsservi√ßos √© violado pela introdu√ß√£o de algumas bibliotecas comuns. </font><font style="vertical-align: inherit;">O resultado √© uma classe que possui v√°rias dezenas de m√©todos ou propriedades e cada microsservi√ßo usa 1 - 2 apenas o necess√°rio, portanto, voc√™ deve ter cuidado com as bibliotecas compartilhadas nos microsservi√ßos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depend√™ncias entre camadas</font></font></h3><br>
<img src="https://habrastorage.org/webt/8g/kb/4y/8gkb4yjeoduvybjcxsyo77apjre.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√ß√£o para microsservi√ßos simples, dos quais 80% da lei de Pareto</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jogue fora a camada PrimaryAdatapters e SecondaryAdapters. Deixe apenas a camada l√≥gica. Mais precisamente, em um aplicativo ASP.NET t√≠pico que usamos - PimaryAdater √© Controller e SecondaryAdapter √© DbContext da EF. Se o Controlador de repente se tornar muito grande, cortamos em peda√ßos usando parcial. Isso √© muito melhor do que criar abstra√ß√µes desnecess√°rias e gastar tempo com elas. Por exemplo, a Microsoft fez isso para o BasketMicrotservice no exemplo do aplicativo de cont√™iner EShop docker. Sim, basta escrever o c√≥digo no controlador. S√≥ n√£o escreva c√≥digo espaguete. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importante</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lembre-se de que a camada l√≥gica permanece conosco e ainda usamos Entidades com sua l√≥gica e DomainServices com seus c√°lculos e n√£o apenas escrevemos uma parede de c√≥digo espaguete no controlador. </font><font style="vertical-align: inherit;">Acabamos de jogar fora o ItemService e o ItemRepository t√≠picos. </font><font style="vertical-align: inherit;">O bom e velho ItemValidator, ItemMapper, AmountCalculator etc. nesse esp√≠rito ainda permanecem conosco. </font><font style="vertical-align: inherit;">Como ainda temos a camada L√≥gica, podemos mudar para uma op√ß√£o mais complexa a qualquer momento, agrupando abstra√ß√µes adicionais com ItemsService, ItemsRepository.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um servi√ßo que calcula o pre√ßo final de um produto com desconto. </font><font style="vertical-align: inherit;">Em teoria, faz parte da Domain Online Store e representa seu cat√°logo de produtos BoundedContext. </font><font style="vertical-align: inherit;">Para simplificar, pulei toda a l√≥gica de valida√ß√£o. </font><font style="vertical-align: inherit;">Pode ser descrito em algum tipo de ItemValidator e DiscountValidator. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Pasta l√≥gica: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.1) Pasta entidades: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desconto:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Discount</span><font></font>
    {<font></font>
        [<span class="hljs-meta">Key</span>]
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Value { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dinheiro:</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">Owned</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Money</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Amount { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Money <span class="hljs-title">Apply</span>(<span class="hljs-params">Discount discount</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> amount = Amount * (<span class="hljs-number">1</span> - discount.Value);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Money()<font></font>
            {<font></font>
                Amount = amount<font></font>
            };<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Produtos:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Item</span><font></font>
    {<font></font>
        [<span class="hljs-meta">Key</span>]
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Money Price { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span> Money();<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.2) Pasta DomainServices </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Calculadora de pre√ßos de </font><font style="vertical-align: inherit;">produtos </font><font style="vertical-align: inherit;">, incluindo descontos:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IPriceCalculator</span><font></font>
    {<font></font>
        <span class="hljs-function">Money <span class="hljs-title">WithDiscounts</span>(<span class="hljs-params">Item item, IEnumerable&lt;Discount&gt; discounts</span>)</span>;<font></font>
    }<font></font>
<font></font>
     <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PriceCalculator</span>:<span class="hljs-title">IPriceCalculator</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Money <span class="hljs-title">WithDiscounts</span>(<span class="hljs-params">Item item, IEnumerable&lt;Discount&gt; discounts</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> discounts.Aggregate(item.Price, (m, d) =&gt; m.Apply(d));<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) DbContext </font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsDbContext</span> : <span class="hljs-title">DbContext</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsDbContext</span>(<span class="hljs-params">DbContextOptions&lt;ItemsDbContext&gt; options</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span><font></font>
        {<font></font>
<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Item&gt; Items { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Discount&gt; Discounts { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Controlador</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/items"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPriceCalculator _priceCalculator;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsController</span>(<span class="hljs-params">ItemsDbContext context, IPriceCalculator priceCalculator</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
            _priceCalculator = priceCalculator;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}/price-with-discounts"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _context.Items.FindAsync(id);
            <span class="hljs-keyword">var</span> discounts = <span class="hljs-keyword">await</span> _context.Discounts.ToListAsync();
            <span class="hljs-keyword">return</span> _priceCalculator.WithDiscounts(item, discounts).Amount;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Op√ß√£o para microsservi√ßos complexos, dos quais 20% e para a maioria dos mon√≥litos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, usamos uma abordagem padr√£o com o m√°ximo isolamento das camadas uma da outra. </font><font style="vertical-align: inherit;">Adicione uma classe para PrimaryAdapter (ItemService) e SecondaryAdapter (ItemRepository). </font><font style="vertical-align: inherit;">Na pasta L√≥gica, tudo permanece como antes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Pasta SecondaryAdapters</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IItemsRepository</span><font></font>
    {<font></font>
        <span class="hljs-function">Task&lt;Item&gt; <span class="hljs-title">Get</span>(<span class="hljs-params">Guid id</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsRepository</span> : <span class="hljs-title">IItemsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsRepository</span>(<span class="hljs-params">ItemsDbContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;Item&gt; <span class="hljs-title">Get</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _context.Items.FindAsync(id);
            <span class="hljs-keyword">return</span> item;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IDiscountsRepository</span><font></font>
    {<font></font>
        Task&lt;List&lt;Discount&gt;&gt; Get();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DiscountsRepository</span> : <span class="hljs-title">IDiscountsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DiscountsRepository</span>(<span class="hljs-params">ItemsDbContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Task&lt;List&lt;Discount&gt;&gt; Get()<font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> _context.Discounts.ToListAsync();<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Pasta PrimaryAdapters</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IItemService</span><font></font>
    {<font></font>
        <span class="hljs-function">Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemService</span> : <span class="hljs-title">IItemService</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IItemsRepository _items;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IDiscountsRepository _discounts;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPriceCalculator _priceCalculator;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemService</span>(<span class="hljs-params">IItemsRepository items, IDiscountsRepository discounts, IPriceCalculator priceCalculator</span>)</span><font></font>
        {<font></font>
            _items = items;<font></font>
            _discounts = discounts;<font></font>
            _priceCalculator = priceCalculator;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _items.Get(id);
            <span class="hljs-keyword">var</span> discounts = <span class="hljs-keyword">await</span> _discounts.Get();
            <span class="hljs-keyword">return</span> _priceCalculator.WithDiscounts(item, discounts).Amount;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nosso controlador agora usa nosso IItemService</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/items"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IItemService _service;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsController</span>(<span class="hljs-params">IItemService service</span>)</span><font></font>
        {<font></font>
            _service = service;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}/price-with-discounts"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _service.GetPriceWithDiscount(id);
            <span class="hljs-keyword">return</span> result;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adicionado muito c√≥digo adicional. Em vez disso, maior flexibilidade do sistema. Agora √© mais f√°cil alterar o Contoller e, geralmente, o ASP.NET Core para outra coisa, ou alterar o DbContext e o EntityFramework Core para outra coisa ou adicionar o cache ao Redis. A primeira abordagem vence em microsservi√ßos simples e mon√≥litos muito simples e pequenos. O segundo em todos os outros casos, quando voc√™ precisar√° adicionar e concluir esse c√≥digo por mais de um ano. Bem, na segunda abordagem, al√©m do Item da entidade e do desconto, √© √∫til criar DTOs separados que usar√£o o DbContex EF e DTOs (modelos) que o ASP.NET Controller usar√°, por exemplo. ItemDto e ItemModel. Isso tornar√° os modelos de dom√≠nio ainda mais independentes. E, finalmente, um exemplo de um aplicativo simples que escrevi usando a segunda abordagem do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TestRuvds</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">De fato, ele √© redundante aqui, e todas essas abstra√ß√µes est√£o aqui como exemplo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo de implementa√ß√£o</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualServersModule</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agradecimentos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
obrigado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">canxes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AndrewDemb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para erros gramaticais encontrados.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt493412/index.html">Jogos com Wifi no ESP32</a></li>
<li><a href="../pt493416/index.html">IDA Pro e t√©cnicas de engenharia reversa</a></li>
<li><a href="../pt493418/index.html">Por que o aprendizado de m√°quina usa dados "sint√©ticos"</a></li>
<li><a href="../pt493420/index.html">Minha maneira de apresentar Python aos alunos do ensino m√©dio</a></li>
<li><a href="../pt493424/index.html">Implementamos convers√µes de c√≥digo Python</a></li>
<li><a href="../pt493428/index.html">"N√£o daremos origem a teorias da conspira√ß√£o". Fale sobre confer√™ncias de ML com pessoas de empresas de ci√™ncia e TI</a></li>
<li><a href="../pt493430/index.html">Arquitetura de rede para aplicativos da Web</a></li>
<li><a href="../pt493432/index.html">Por que n√£o iniciar uma carreira em uma pequena empresa que n√£o √© de TI</a></li>
<li><a href="../pt493436/index.html">Programa para altera√ß√£o de direitos de acesso e registro de nomes de arquivos / diret√≥rios no Bash</a></li>
<li><a href="../pt493438/index.html">Exibir resultados de pesquisa e problemas de desempenho</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>