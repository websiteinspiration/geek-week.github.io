<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈴 👨🏼‍🚀 👨🏻‍🏭 Système multimédia pour Toyota Prius (partie 2) 📰 🛌 🎞️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Poursuite du projet de remplacement du système multimédia Toyota Prius. 
 
 Dans cet article - PHY, Transport et livraison de paquets au périphérique ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Système multimédia pour Toyota Prius (partie 2)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493670/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poursuite du projet de remplacement du </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">système multimédia Toyota Prius. </font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article - PHY, Transport et livraison de paquets au périphérique hôte, qui a finalement réussi à être vérifié sur la vraie tête native de la Prius. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rapidement le conte de fées affecte, mais pas vite la chose se fait. </font><font style="vertical-align: inherit;">Aujourd'hui, je poursuis le projet prolongé de refonte du système médiatique de Prius, qui a commencé il y a 2 ans.</font></font><br>
<a name="habracut"></a><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Offtopic historique</font></font></b>
                        <div class="spoiler_text">   —  USB-AVC    ,        .           ,     , ..       ++ —     ,  . <br>
<br>
  ,    ,        ,     ,           . <br>
<br>
,      ,     ,   PHY- . <br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, depuis le tout début. </font><font style="vertical-align: inherit;">En fouillant sur Internet pour trouver des adaptateurs à AVC-LAN, j'ai très souvent vu des solutions similaires à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cela</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Et dans la discussion, de tels commentaires passent souvent à travers:</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Honnêtement, ça ne marche pas très bien, ou plutôt ça ne marche pas bien avec toutes les têtes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors que le pneu est parfaitement lisible sur une vieille radio avec un Spacio de 99 ans.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'étais initialement fondamentalement opposé à faire quelque chose, et les solutions structurellement instables ne me conviennent pas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons répéter le chemin de la rétro-ingénierie du pneu. Aller. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous nous connectons au bus sur une voiture en direct, et supprimons la forme d'onde: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cc/cz/uf/ccczuftggnmbqqtebaewgwcx_3e.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le début du pack. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/ac/v-/wu/acv-wuwaaoywpav08fjqekdyaq8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les bits sont quelque part au milieu, plus gros. </font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/l3/cy/ba/l3cyba6lailk2fcxp9274-eltlk.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelque chose de très similaire à ACK.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Un peu plus sur cette étrange étape - ci-dessous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai déjà fait des captures d'écran des formes d'onde à partir des données stockées, tout en les prenant, je n'ai pas immédiatement fait attention à la plage de tension dans laquelle j'ai pris les données. Et quand il l'a dessiné, il a dû redescendre dans la voiture pour s'assurer qu'il n'avait pas survécu à l'esprit. Oui, la portée du bus différentiel n'est que de 200 mV (!!!).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous allons à la fiche technique utilisée par les collègues ST485, et nous voyons ce qui suit:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dm/ui/n8/dmuin85kauk3hwji9d6w4d2dx5w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, en fait, la racine de tous les problèmes a été trouvée, à cause de laquelle nous devons jouer avec des résistances et prier les dieux de la colophane pour que le convertisseur fonctionne sur une machine spécifique. Travailler près des seuils est mauvais. Mais encore plus intéressant, c'est que pour AVC-LAN, qui dans sa physique est un clone de certains IE-Bus de NEC, selon ses spécifications (le lien sera un peu plus loin), l'état actif est une tension supérieure à 120 mV, tandis que ST485 a le droit de considérer rien de moins de 200 mV est nul. Eh bien, si, en raison d'écarts de fabrication, le ST485 a un niveau de seuil légèrement inférieur et apparaît sur le bus pour une marge légèrement supérieure à la norme (jusqu'à 6 volts est autorisé), alors, bien sûr, le ST485 sera en mesure de recevoir un tel signal. Et ces imprécisions de fabrication sont la seule chose qui force </font><b><font style="vertical-align: inherit;">parfois les</font></b><font style="vertical-align: inherit;"> appareils avec ST485 dans la composition</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">travail. Bien sûr, nous ne mettrons pas un tel bonheur dans le développement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxième solution disponible basée sur le même ST485 et un amplificateur opérationnel, je n'ai pas aimé l'abondance de composants. Eh bien, au 21e siècle, nous vivons, après tout. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solution: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe des convertisseurs spéciaux pour AVC-LAN. Mais je n'ai pas pu les obtenir à un prix abordable pour cet appareil. La Chine fraternelle est de nouveau venue à la rescousse, où le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HA12240FP a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> été découvert </font><font style="vertical-align: inherit;">, qui a une différence de tension pour percevoir un journal. "1" par fiche technique est de 80..110 mV. Cela permettra à notre pneu de fixer un niveau actif avec une marge presque double. Arrange. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous donnons naissance au schéma sur le STM32F103 mentionné dans la première partie: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ds/mj/ey/dsmjeylhhd1tldlydzj7kdf8yky.png"><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Le schéma est né à la hâte, il contient une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erreur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Les conducteurs de bus doivent être alimentés en 5V. Si c'est le cas, comme dans le diagramme, leur différentiel augmente. seuil, et tous les paquets ne sont pas acceptés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout est simple au primitivisme, je pense, n'a pas besoin de description. Sauf, peut-être, le fait que le choix des jambes pour RX1 / 2 n'est pas accidentel, et la première version du circuit a nécessité un «raffinement de fichier» afin d'obtenir des signaux vers les entrées de capture / comparaison, car je veux l'utiliser pour mesurer la longueur d'impulsion. Solutions alternatives - l'interrogation et l'interruption lors d'un changement d'état perdent en précision et en complexité de mise en œuvre logicielle. De plus - je voudrais recevoir au moins deux lignes en parallèle (il y en a trois dans la tête), et si les fronts coïncident sur deux, vous pouvez dire adieu à l'idée d'une précision acceptable si vous n'utilisez pas la capture / comparaison.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une analyse plus approfondie des données contenues dans le package est bien écrite </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais, étant donné que les liens sont incohérents, je vais répéter brièvement ici:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le bus différentiel, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici, ils</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> écrivent sur l'interprétation des niveaux du journal. </font><font style="vertical-align: inherit;">"1" à &lt;20mV, journal. </font><font style="vertical-align: inherit;">"0" -&gt; 110mV.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La longueur du bit est de 40 µs, les 20 premiers µs sont toujours «0», les 7 derniers µs sont toujours «1», au milieu se trouve la valeur du bit. </font></font><br>
<img src="https://habrastorage.org/webt/vv/6_/_8/vv6__8pbidlx43eqnvjbupnee3g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, le feu de circulation:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i1/u2/k-/i1u2k-ji3f5mckou9r7mut6nzkm.png"><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bit de départ - supérieur à 180 μs </font></font></li>
<li>        (ACK).    «»,    - :<br>
<br>
<img src="https://habrastorage.org/webt/pg/sl/hq/pgslhqq84ha2ytwegw9njtlq6we.png"><br>
<br>
  ACK-    ,    Dallas 1-wire,      ,  , , .    ,   . 1     ,      «0» ( ,    ),     .2  ,      ,    ,   .  .3 ,        (1),     ,           ,    7  ,    . «1». <br>
 </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien ... nous avons déterminé le niveau physique, dessiné le circuit et séparé la planche. Il s'est avéré quelque chose comme ceci: La </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_d/4y/gj/_d4ygj2rf315jb9yqodcdfh7dda.png"><br>
<br>
<img src="https://habrastorage.org/webt/fu/om/rm/fuomrmmvbepdwmvpiqrmh1efezm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
carte de circuit imprimé est sortie quelque peu sans succès, et non parce que le code QR ne fonctionnait pas en sérigraphie. Il y a une erreur dans le circuit (dans le schéma ci-dessus, je l'ai déjà corrigé) concernant la sélection des jambes pour le RX, et trois pilotes de ligne sont divorcés. Lors de l’écriture et du débogage du programme, j’ai réalisé que c’est bien si vous pouvez en exécuter au moins deux régulièrement. Oui, et plus n'est pas nécessaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien ... l'appareil s'est avéré être simple et efficace, tandis que le problème constructif de l'inadéquation des niveaux a été résolu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus loin dans le programme:</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"> </a>   .   ,        .  : *         USB —     ,    ,     «»  .    . *      ,             8,  6-    ,   4.4   .       ,    ,       . </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moniteur Android</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour inverser complètement la logique du bus. </font><font style="vertical-align: inherit;">Si quelqu'un est fort dans Android et Kotlin, je serai reconnaissant de l'opportunité de consulter. </font><font style="vertical-align: inherit;">Ce sont des tentatives timides pour tout maîtriser à la fois, donc n'entrez pas dans le référentiel par référence sans une nouvelle passe :)</font></font></li>
</ol><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UPD: les </font><font style="vertical-align: inherit;">données </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font><font style="vertical-align: inherit;">temporelles fixes </font><font style="vertical-align: inherit;">au lieu des microsecondes étaient ms.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr493660/index.html">CSS: guide complet des fonctions calc ()</a></li>
<li><a href="../fr493662/index.html">Puissance spatiale</a></li>
<li><a href="../fr493664/index.html">Analyse du taux de propagation COVID-19 et publication des résultats sur dstack.ai</a></li>
<li><a href="../fr493666/index.html">Comment nous avons appris à l'intelligence artificielle à répondre aux questions d'assistance. Découvrez Yandex.Taxi</a></li>
<li><a href="../fr493668/index.html">Comment j'ai créé le prochain constructeur de site</a></li>
<li><a href="../fr493674/index.html">Présentation du lecteur vidéo pour le Web</a></li>
<li><a href="../fr493680/index.html">10 astuces pour ne pas fusionner konfu en ligne</a></li>
<li><a href="../fr493686/index.html">L'origine mystérieuse du jeu de société sur le piratage des codes Mastermind</a></li>
<li><a href="../fr493688/index.html">Nous rendons Microsoft Teams gratuits - restez en contact avec vos collègues en ces temps difficiles</a></li>
<li><a href="../fr493690/index.html">20 conseils pour le pilote DJI Mavic Mini pour protéger votre drone contre les accidents et les pertes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>