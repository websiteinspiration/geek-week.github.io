<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🤝‍👨🏾 🙍🏽 ♣️ パート3：LinuxをSDカードからRocketChipにほぼ出荷する 🤧 🧓🏻 👨‍🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前の部分、多かれ少なかれワーキングメモリコントローラが実装され、またはしなく、TileLinkにアダプタであるのQuartusからIPコア、オーバーラッパー。今日、「RocketChipをあまり知られていないCyclone搭載の中国のマザーボードに移植する」という見出しの下に、動作するコンソールが表...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>パート3：LinuxをSDカードからRocketChipにほぼ出荷する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458482/"><p><img src="https://habrastorage.org/webt/4j/fu/lu/4jfulumeapi32exqv7d6vnseaho.png" width="45%" align="left"><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前の部分</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、多かれ少なかれワーキングメモリコントローラが実装され、またはしなく、TileLinkにアダプタであるのQuartusからIPコア、オーバーラッパー。今日、「RocketChipをあまり知られていないCyclone搭載の中国のマザーボードに移植する」という見出しの下に、動作するコンソールが表示されます。プロセスは少し遅れました：Linuxをすぐに起動して次に進むとすでに思っていましたが、それはありませんでした。この部分では、U-Boot、BBL、およびtimid Linuxカーネルの初期化を開始するプロセスを確認することを提案します。しかし、コンソールがあります-U-Boot-ovskaya、そしてかなり高度なもので、本格的なコンソールに期待するものの多くを備えています。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハードウェアはSPI経由で接続されたSDカードとUARTを追加します。</font><font style="vertical-align: inherit;">BootROMソフトウェアコンポーネントは</font></font><code>xip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オン</font><font style="vertical-align: inherit;">に置き換えられ</font></font><code>sdboot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、実際には次のブートステージ（SDカード上）に追加されます。</font></font></p><a name="habracut"></a><br>
<h2 id="dopilivanie-apparatnoy-chasti"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハードウェアのドーピング</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">したがって、タスク：「大きな」コアに移動し、UART（Raspberryから）とSDアダプター（6つのピンを持つある種類のCa​​talexボードが使用されました：GND、VCC、MISO、MOSI、SCK、CS）。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原則として、すべてが非常に単純でした。</font><font style="vertical-align: inherit;">しかし、これを実現する前に、私は左右に少し投げられました：前回以降</font><font style="vertical-align: inherit;">、SDカードでも同じ</font></font><code>System</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ように</font></font><code>HasPeripheryUART</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（そしてそれぞれ実装）</font><font style="vertical-align: inherit;">を混ぜるだけでよいと判断しました</font><font style="vertical-align: inherit;">-そしてすべてが準備されます。</font><font style="vertical-align: inherit;">次に、それが「深刻な」デザインにどのように実装されているかを確認することにしました。</font><font style="vertical-align: inherit;">それでは、私たちは何を真剣に受け止めていますか？</font><font style="vertical-align: inherit;">芸術的には、明らかに適合しない-モンスターは残ってい</font></font><code>unleahshed.DevKitConfigs</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">そして突然、どこかにある種のオーバーレイがあり、それらはキーによってパラメーターを介して追加されたことがわかりました。</font><font style="vertical-align: inherit;">これはおそらく非常に柔軟で構成可能だと思いますが、最初は何かを開始する必要があります... </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しかし、同じことはなく、簡単にできるのではないでしょうか？..</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、</font></font><code>vera.iofpga.FPGAChip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microsemi FPGAと</font></font><del><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すぐに引用に引き込まれた</font></font></del><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 私は類推によって実装を試みましたが、ここでの利点は、多かれ少なかれ「マザーボードのレイアウト」全体が1つのファイルにあることです。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結局のところ、</font></font><code>System.scala</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行</font><font style="vertical-align: inherit;">に追加する必要があるだけです</font></font></p><br>
<pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">System</span>(<span class="hljs-params">implicit p: <span class="hljs-type">Parameters</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">RocketSubsystem</span></span><font></font>
...<font></font>
  <span class="hljs-keyword">with</span> <span class="hljs-type">HasPeripherySPI</span>
  <span class="hljs-keyword">with</span> <span class="hljs-type">HasPeripheryUART</span><font></font>
...<font></font>
{<font></font>
  <span class="hljs-keyword">val</span> tlclock = <span class="hljs-keyword">new</span> <span class="hljs-type">FixedClockResource</span>(<span class="hljs-string">"tlclk"</span>, p(<span class="hljs-type">DevKitFPGAFrequencyKey</span>))<font></font>
  ...<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemModule</span>[+<span class="hljs-type">L</span> &lt;: <span class="hljs-type">System</span>](<span class="hljs-params">_outer: <span class="hljs-type">L</span></span>)</span>
  <span class="hljs-keyword">extends</span> <span class="hljs-type">RocketSubsystemModuleImp</span>(_outer)<font></font>
...<font></font>
    <span class="hljs-keyword">with</span> <span class="hljs-type">HasPeripheryUARTModuleImp</span>
    <span class="hljs-keyword">with</span> <span class="hljs-type">HasPeripheryGPIOModuleImp</span>
...</code></pre><br>
<p>    <code>System</code>    ,       SoC,  dts-.   , DTS/DTB —      plug-and-play   :  dts-    dtb-    ,      .  ,    <code>tlclock</code>   ,   BootROM (,     <code>sdboot</code>)   —      dts-      <code>TL_CLK</code>,           .</p><br>
<p>    «»:</p><br>
<p><strong>Platform.scala:</strong></p><br>
<pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlatformIO</span>(<span class="hljs-params">implicit val p: <span class="hljs-type">Parameters</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">Bundle</span> </span>{<font></font>
<font></font>
...<font></font>
<font></font>
  <span class="hljs-comment">// UART</span>
  io.uart_tx := sys.uart(<span class="hljs-number">0</span>).txd<font></font>
  sys.uart(<span class="hljs-number">0</span>).rxd := <span class="hljs-type">RegNext</span>(<span class="hljs-type">RegNext</span>(io.uart_rx))<font></font>
<font></font>
  <span class="hljs-comment">// SD card</span>
  io.sd_cs := sys.spi(<span class="hljs-number">0</span>).cs(<span class="hljs-number">0</span>)<font></font>
  io.sd_sck := sys.spi(<span class="hljs-number">0</span>).sck<font></font>
  io.sd_mosi := sys.spi(<span class="hljs-number">0</span>).dq(<span class="hljs-number">0</span>).o<font></font>
  sys.spi(<span class="hljs-number">0</span>).dq(<span class="hljs-number">0</span>).i := <span class="hljs-literal">false</span>.<span class="hljs-type">B</span>
  sys.spi(<span class="hljs-number">0</span>).dq(<span class="hljs-number">1</span>).i := <span class="hljs-type">RegNext</span>(<span class="hljs-type">RegNext</span>(io.sd_miso))<font></font>
  sys.spi(<span class="hljs-number">0</span>).dq(<span class="hljs-number">2</span>).i := <span class="hljs-literal">false</span>.<span class="hljs-type">B</span>
  sys.spi(<span class="hljs-number">0</span>).dq(<span class="hljs-number">3</span>).i := <span class="hljs-literal">false</span>.<span class="hljs-type">B</span>
}</code></pre><br>
<p> ,  ,          .  ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>. ,  <em></em>     ,        «  ».      —  MISO  MOSI    <code>dq</code>?       , , ,       .</p><br>
<p>,                 3.3V.</p><br>
<div class="spoiler"><b class="spoiler_title">SD-</b><div class="spoiler_text"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上からの眺め：</font></font></p><br>
<img src="https://habrastorage.org/webt/su/zf/q4/suzfq4lwejcelmwt3rpk5w_min0.jpeg"><br>
<p> :</p><br>
<img src="https://habrastorage.org/webt/y0/__/qq/y0__qqavfhkikpsorvmzqhbamlw.jpeg"></div></div><br>
<h2 id="otladka-programmnoy-chasti-instrumenty">  : </h2><br>
<p>         .</p><br>
<h3 id="minicom">Minicom</h3><br>
<p>-,    -  ,     .    Linux (   —  ,   RaspberryPi)    Minicom.  ,        .</p><br>
<p> ,          <code>-D /dev/ttyS0</code> —   <code>-D</code>.    :    <code>Ctrl-A, X</code>.     ,      —      SSH   <code>killall -KILL minicom</code>.</p><br>
<p>    .   RaspberryPi   UART,        - :   Bluetooth,       .  ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>.</p><br>
<h3 id="perepisyvanie-pamyati"> </h3><br>
<p> ,       <em> </em> ()      . ,      GDB,        :   Raspberry  ,   SSH   4444 (telnet  OpenOCD)    <code>load_image</code>.    ,    ,     <em>«  ,    »</em>:   ,         .</p><br>
<h3 id="osobennosti-ustanovki-breakpoint-ov">  breakpoint-</h3><br>
<p>,          ,       .   breakpoint-          <strong>   </strong>. ,       <code>b</code>  GDB. ,    :</p><br>
<ul>
<li>    BootROM,   ROM</li>
<li>    ,     SD-, ,   ,    .        ,     breakpoint</li>
</ul><br>
<p>,       ,       .</p><br>
<h3 id="bystraya-podmena-bootrom">  BootROM</h3><br>
<p>        BootROM    .   : BootROM   ,   ,    —    ( -       BootROM  C  Assembler...).  ,     <strong> </strong>:   :</p><br>
<ul>
<li> bootrom.mif (   MIF  HEX,    HEX     - ,  MIF —   )</li>
<li> Quartus  <code>Processing -&gt; Update Memory Initialization File</code></li>
<li>  Assembler (   Tasks)  Start again</li>
</ul><br>
<p>    —   .</p><br>
<h2 id="podgotovka-sd-karty"> SD-</h2><br>
<p>   ,       14Gb   :</p><br>
<pre><code class="plaintext hljs">git clone https://github.com/sifive/freedom-u-sdk<font></font>
git submodule update --recursive --init<font></font>
make</code></pre><br>
<p>    ,  ,    , SD-,  </p><br>
<pre><code class="plaintext hljs">sudo make DISK=/dev/sdX format-boot-loader</code></pre><br>
<p>…  <code>sdX</code> — ,  . <strong>:     ,   !</strong>       - <code>sudo</code>,         <code>root</code>,     - <code>sudo</code> .</p><br>
<p>   ,   GPT   ,     FAT  <code>uEnv.txt</code>      FIT (   ,     ),   — ,     Ext4  .    — <em></em>:    U-Boot ( ,   ,   BootROM),  , ,    ,      .</p><br>
<h2 id="uroven-pervyy-bootrom"> , BootROM</h2><br>
<p>  : «      ,    —    ».     ,        , ,  « GND —      » <em>(,  -   ...)</em>    ,      ,      :    ,         —   ,        ,   ,     «»  . , ,      , ,  …  , ,       ,  ,   .    <em></em>:  RX/TX  UART-,   —  </p><br>
<pre><code class="plaintext hljs">INIT<font></font>
CMD0<font></font>
ERROR</code></pre><br>
<p>,   —  SD-   .  ,  …  …     ,  -  :         VCC.      5V  ,  ,  ,  ,   ,    .      ,  <strong>   UART.</strong> <em>facepalm.jpg</em>  , «     »,    — ...</p><br>
<p>     Minicom </p><br>
<pre><code class="plaintext hljs">INIT<font></font>
CMD0<font></font>
CMD8<font></font>
ACMD41<font></font>
CMD58<font></font>
CMD16<font></font>
CMD18<font></font>
LOADING /</code></pre><br>
<p> , <del> </del>   .        MinuetOS  .     .</p><br>
<p>  ,    BOOT   . ,     OpenOCD  Raspberry,   GDB  ,  ,    .</p><br>
<p>-,    GDB   ,  <code>$pc</code> (program counter,   )   <code>0x0</code> — ,     . ,     <code>BOOT</code>   . <em>   ...</em></p><br>
<pre><code class="diff hljs">diff --git a/bootrom/sdboot/sd.c b/bootrom/sdboot/sd.c<font></font>
index c6b5ede..bca1b7f 100644<font></font>
<span class="hljs-comment">--- a/bootrom/sdboot/sd.c</span>
<span class="hljs-comment">+++ b/bootrom/sdboot/sd.c</span><font></font>
@@ -224,6 +224,8 @@ int main(void)<font></font>
<font></font>
        kputs("BOOT");<font></font>
<font></font>
<span class="hljs-addition">+    while(*(volatile char *)0x10000){}</span>
<span class="hljs-addition">+</span><font></font>
        __asm__ __volatile__ ("fence.i" : : : "memory");<font></font>
        return 0;<font></font>
 }</code></pre><br>
<p>    « »:  - , ,  ,   —  Undefined Behavior,       (,   <code>0x10000</code>  BootROM).</p><br>
<p><img src="https://habrastorage.org/webt/wj/xw/a9/wjxwa9m9hqoghtvy79zsbysctr0.png" alt="デバッガはありますが、ソースがありません"></p><br>
<p> ,     —  embedded,    .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>    … --:</p><br>
<pre><code class="plaintext hljs">(gdb) file builds/zeowaa-e115/sdboot.elf<font></font>
A program is being debugged already.<font></font>
Are you sure you want to change the file? (y or n) y<font></font>
Reading symbols from builds/zeowaa-e115/sdboot.elf...done.</code></pre><br>
<p><img src="https://habrastorage.org/webt/ya/08/zp/ya08zpufla55qz02j5fhwcoijy4.png" alt="ソースコードがあります！"></p><br>
<p>    MIF-   bin,      ELF.</p><br>
<p>      ,    (   ,      ,   — ). </p><br>
<pre><code class="plaintext hljs">set variable $pc=0xADDR</code></pre><br>
<p>      (   —   ).       ,    ( memory-mapped ).</p><br>
<p>       ( ,  ),    « sd-   »,         ,   <code>0x89800</code>  :</p><br>
<pre><code class="diff hljs">diff --git a/bootrom/sdboot/head.S b/bootrom/sdboot/head.S<font></font>
index 14fa740..2a6c944 100644<font></font>
<span class="hljs-comment">--- a/bootrom/sdboot/head.S</span>
<span class="hljs-comment">+++ b/bootrom/sdboot/head.S</span><font></font>
@@ -13,7 +13,7 @@ _prog_start:<font></font>
   smp_resume(s1, s2)<font></font>
   csrr a0, mhartid<font></font>
   la a1, dtb<font></font>
<span class="hljs-deletion">-  li s1, PAYLOAD_DEST</span>
<span class="hljs-addition">+  li s1, (PAYLOAD_DEST + 0x89800)</span><font></font>
   jr s1<font></font>
<font></font>
   .section .rodata</code></pre><br>
<p>,     ,         4Gb,    2Gb      Makefile <code>DEMO_END=11718750</code>  <code>DEMO_END=3078900</code> (      —  ,      ).</p><br>
<h2 id="uroven-vtoroy-u-boot"> , U-Boot</h2><br>
<p>    «»,      <code>0x0000000080089a84</code>.    :   ,    «  »,     «»,        dtb-   SoC,    <code>HiFive_U-Boot</code>  <code>CONFIG_SYS_TEXT_BASE=0x80089800</code> ( <code>0x08000000</code>),      .    <del>  </del>  :</p><br>
<pre><code class="plaintext hljs">(gdb) file ../freedom-u-sdk/work/HiFive_U-Boot/u-boot<font></font>
(gdb) tui en</code></pre><br>
<p> :</p><br>
<pre><code class="plaintext hljs">   │304     /*                                               │<font></font>
   │305      * trap entry                                    │<font></font>
   │306      */                                              │<font></font>
   │307     trap_entry:                                      │<font></font>
   │308         addi sp, sp, -32*REGBYTES                    │<font></font>
  &gt;│309         SREG x1, 1*REGBYTES(sp)                      │<font></font>
   │310         SREG x2, 2*REGBYTES(sp)                      │<font></font>
   │311         SREG x3, 3*REGBYTES(sp)                      │</code></pre><br>
<p>     308  309.  , ,   <code>$sp</code>   <code>0xfffffffe31cdc0a0</code>. ,     «» -  307.       <code>trap_entry</code>,      <code>0x80089800</code> (  U-Boot),   ,         … , :</p><br>
<pre><code class="plaintext hljs">(gdb) b trap_entry<font></font>
Breakpoint 1 at 0x80089a80: file /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S, line 308.<font></font>
(gdb) set variable $pc=0x80089800<font></font>
(gdb) c<font></font>
Continuing.<font></font>
<font></font>
Breakpoint 1, trap_entry () at /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S:308<font></font>
(gdb) p/x $sp<font></font>
$4 = 0x81cf950</code></pre><br>
<p>   ,  :     (, ,      ,      ).</p><br>
<p>    <code>0x881cf950</code>.     ,  <code>handle_trap</code>   ,     <code>_exit_trap</code>   <code>epc=2148315240</code> (  ):</p><br>
<pre><code class="plaintext hljs">(gdb) x/10i 2148315240<font></font>
   0x800cb068 &lt;strnlen+12&gt;:     lbu     a4,0(a5)<font></font>
   0x800cb06c &lt;strnlen+16&gt;:     bnez    a4,0x800cb078 &lt;strnlen+28&gt;<font></font>
   0x800cb070 &lt;strnlen+20&gt;:     sub     a0,a5,a0<font></font>
   0x800cb074 &lt;strnlen+24&gt;:     ret<font></font>
   0x800cb078 &lt;strnlen+28&gt;:     addi    a5,a5,1<font></font>
   0x800cb07c &lt;strnlen+32&gt;:     j       0x800cb064 &lt;strnlen+8&gt;<font></font>
   0x800cb080 &lt;strdup&gt;: addi    sp,sp,-32<font></font>
   0x800cb084 &lt;strdup+4&gt;:       sd      s0,16(sp)<font></font>
   0x800cb088 &lt;strdup+8&gt;:       sd      ra,24(sp)<font></font>
   0x800cb08c &lt;strdup+12&gt;:      li      s0,0</code></pre><br>
<p> breakpoint  <code>strnlen</code>,   :</p><br>
<pre><code class="plaintext hljs">(gdb) bt<font></font>
#0  strnlen (s=s@entry=0x10060000 "", count=18446744073709551615) at lib/string.c:283<font></font>
#1  0x00000000800cc14c in string (buf=buf@entry=0x881cbd4c "", end=end@entry=0x881cc15c "", s=0x10060000 "", field_width=&lt;optimized out&gt;, precision=&lt;optimized out&gt;, flags=&lt;optimized out&gt;) at lib/vsprintf.c:265<font></font>
#2  0x00000000800cc63c in vsnprintf_internal (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=0x800d446e "s , epc %08x , ra %08lx\n", fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=0x881cc1a0,<font></font>
    args@entry=0x881cc188) at lib/vsprintf.c:619<font></font>
#3  0x00000000800cca54 in vsnprintf (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=args@entry=0x881cc188) at lib/vsprintf.c:710<font></font>
#4  0x00000000800cca68 in vscnprintf (buf=buf@entry=0x881cbd38 "exception code: 5 , ", size=size@entry=1060, fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n", args=args@entry=0x881cc188) at lib/vsprintf.c:717<font></font>
#5  0x00000000800ccb50 in printf (fmt=fmt@entry=0x800d4458 "exception code: %d , %s , epc %08x , ra %08lx\n") at lib/vsprintf.c:792<font></font>
#6  0x000000008008a9f0 in _exit_trap (regs=&lt;optimized out&gt;, epc=2148315240, code=&lt;optimized out&gt;) at arch/riscv/lib/interrupts.c:92<font></font>
#7  handle_trap (mcause=&lt;optimized out&gt;, epc=&lt;optimized out&gt;, regs=&lt;optimized out&gt;) at arch/riscv/lib/interrupts.c:55<font></font>
#8  0x0000000080089b10 in trap_entry () at /hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot/arch/riscv/cpu/HiFive/start.S:343<font></font>
Backtrace stopped: frame did not save the PC</code></pre><br>
<p>, <code>_exit_trap</code>       , <em>    </em>. , -      . <code>set directories ../freedom-u-sdk/HiFive_U-Boot/</code> !  !</p><br>
<p> ,   ,    -   ,    (<code>mcause == 5</code>).    ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  . 37,     <code>Load access fault</code>. , -,  ,   </p><br>
<p><strong>arch/riscv/cpu/HiFive/start.S:</strong></p><br>
<pre><code class="plaintext hljs">call_board_init_f:<font></font>
    li  t0, -16<font></font>
    li  t1, CONFIG_SYS_INIT_SP_ADDR<font></font>
    and sp, t1, t0  /* force 16 byte alignment */<font></font>
<font></font>
#ifdef CONFIG_DEBUG_UART<font></font>
    jal debug_uart_init<font></font>
#endif<font></font>
<font></font>
call_board_init_f_0:<font></font>
    mv  a0, sp<font></font>
    jal board_init_f_alloc_reserve<font></font>
    mv  sp, a0<font></font>
    jal board_init_f_init_reserve<font></font>
<font></font>
    mv  a0, zero    /* a0 &lt;-- boot_flags = 0 */<font></font>
    la t5, board_init_f<font></font>
    jr t5       /* jump to board_init_f() */<font></font>
</code></pre><br>
<p><code>$sp</code>     ,   <code>board_init_f_init_reserve</code>  . ,   :     <code>CONFIG_SYS_INIT_SP_ADDR</code>.     <code>HiFive_U-Boot/include/configs/HiFive-U540.h</code>.  -    ,  ,  ,     — ,    ?    ,           -<code>#if 0</code>-     ,     :</p><br>
<pre><code class="diff hljs">diff --git a/include/configs/HiFive-U540.h b/include/configs/HiFive-U540.h<font></font>
index ca89383..245542c 100644<font></font>
<span class="hljs-comment">--- a/include/configs/HiFive-U540.h</span>
<span class="hljs-comment">+++ b/include/configs/HiFive-U540.h</span>
<span class="hljs-meta">@@ -65,12 +65,9 @@</span><font></font>
 #define CONFIG_SYS_SDRAM_BASE  PHYS_SDRAM_0<font></font>
 #endif<font></font>
 #if 1<font></font>
<span class="hljs-deletion">-/*#define CONFIG_NR_DRAM_BANKS 1*/</span>
<span class="hljs-addition">+#define CONFIG_NR_DRAM_BANKS   1</span><font></font>
 #define PHYS_SDRAM_0   0x80000000              /* SDRAM Bank #1 */<font></font>
<span class="hljs-deletion">-#define PHYS_SDRAM_1   \</span>
<span class="hljs-deletion">-       (PHYS_SDRAM_0 + PHYS_SDRAM_0_SIZE)      /* SDRAM Bank #2 */</span>
<span class="hljs-deletion">-#define PHYS_SDRAM_0_SIZE      0x80000000      /* 2 GB */</span>
<span class="hljs-deletion">-#define PHYS_SDRAM_1_SIZE      0x10000000      /* 256 MB */</span>
<span class="hljs-addition">+#define PHYS_SDRAM_0_SIZE      0x40000000      /* 1 GB */</span><font></font>
 #define CONFIG_SYS_SDRAM_BASE  PHYS_SDRAM_0<font></font>
 #endif<font></font>
 /*<font></font>
<span class="hljs-meta">@@ -81,7 +78,7 @@</span><font></font>
 #define CONSOLE_ARG                            "console=ttyS0,115200\0"<font></font>
<font></font>
 /* Init Stack Pointer */<font></font>
<span class="hljs-deletion">-#define CONFIG_SYS_INIT_SP_ADDR                (0x08000000 + 0x001D0000 - \</span>
<span class="hljs-addition">+#define CONFIG_SYS_INIT_SP_ADDR                (0x80000000 + 0x001D0000 - \</span><font></font>
                                        GENERATED_GBL_DATA_SIZE)<font></font>
<font></font>
 #define CONFIG_SYS_LOAD_ADDR           0xa0000000      /* partway up SDRAM */</code></pre><br>
<p> -   <del></del> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>   .  ,          .            .</p><br>
<div class="spoiler"><b class="spoiler_title">, ,  </b><div class="spoiler_text"><pre><code class="plaintext hljs">trosinenko@trosinenko-pc:/hdd/trosinenko/fpga/freedom-u-sdk/HiFive_U-Boot$ git show --name-status<font></font>
commit 39cd67d59c16ac87b46b51ac1fb58f16f1eb1048 (HEAD -&gt; zeowaa-1gb)<font></font>
Author: Anatoly Trosinenko &lt;anatoly.trosinenko@gmail.com&gt;<font></font>
Date:   Tue Jul 2 17:13:16 2019 +0300<font></font>
<font></font>
    Initial support for Zeowaa A-E115FB board<font></font>
<font></font>
M       arch/riscv/Kconfig<font></font>
A       arch/riscv/cpu/zeowaa-1gb/Makefile<font></font>
A       arch/riscv/cpu/zeowaa-1gb/cpu.c<font></font>
A       arch/riscv/cpu/zeowaa-1gb/start.S<font></font>
A       arch/riscv/cpu/zeowaa-1gb/timer.c<font></font>
A       arch/riscv/cpu/zeowaa-1gb/u-boot.lds<font></font>
M       arch/riscv/dts/Makefile<font></font>
A       arch/riscv/dts/zeowaa-1gb.dts<font></font>
A       board/Zeowaa/zeowaa-1gb/Kconfig<font></font>
A       board/Zeowaa/zeowaa-1gb/MAINTAINERS<font></font>
A       board/Zeowaa/zeowaa-1gb/Makefile<font></font>
A       board/Zeowaa/zeowaa-1gb/Zeowaa-A-E115FB.c<font></font>
A       configs/zeowaa-1gb_defconfig<font></font>
A       include/configs/zeowaa-1gb.h</code></pre><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p></div></div><br>
<p> ,   SiFive-       .   ,  U-Boot      Linux  Kconfig — ,   <code>make menuconfig</code>,             <code>?</code>  ..  ,       ,      PLL (,  -        PCIe,    ),    ,          UART   ,      ,   ,    DRAM (         ).</p><br>
<p> ,          JTAG,    SD- — , ,     .   ,  BootROM  ,  <code>ERROR</code>,   ,     U-Boot. -    : ,   bitstream     ,   «»  .. ,      <code>LOADING /</code>     <code>set variable $pc=0x80089800</code>,       (,  ,        ,       - ).</p><br>
<p>,    ,    ,       JTAG-  </p><br>
<pre><code class="plaintext hljs">Error: unable to halt hart 0<font></font>
Error:   dmcontrol=0x80000001<font></font>
Error:   dmstatus =0x00030c82</code></pre><br>
<p>, !    ! -     TileLink,      -   —   … ,           :</p><br>
<pre><code class="plaintext hljs">INIT<font></font>
CMD0<font></font>
CMD8<font></font>
ACMD41<font></font>
CMD58<font></font>
CMD16<font></font>
CMD18<font></font>
LOADING<font></font>
BOOT<font></font>
<font></font>
U-Boot 2018.09-g39cd67d-dirty (Jul 03 2019 - 13:50:33 +0300)<font></font>
<font></font>
DRAM:  1 GiB<font></font>
MMC:<font></font>
BEFORE LOAD ENVBEFORE FDTCONTROLADDRBEFORE LOADADDRIn:    serial<font></font>
Out:   serial<font></font>
Err:   serial<font></font>
Hit any key to stop autoboot:  3</code></pre><br>
<p>     <code>In: serial</code>    —       ,      environment.  , «    »?          !  :  U-Boot      2^24   SD-, ,    <del> </del>  ,      ,        ,   ELF-,    .  : ,       ,     .</p><br>
<p>,    ? ,    -  ...</p><br>
<pre><code class="plaintext hljs">(gdb) x/x 0x0200bff8<font></font>
0x200bff8:      0x00000000</code></pre><br>
<p> ,    ?</p><br>
<pre><code class="plaintext hljs">(gdb) set variable *0x0200bff8=310000000<font></font>
(gdb) c</code></pre><br>
<p>:</p><br>
<pre><code class="plaintext hljs">Hit any key to stop autoboot:  0<font></font>
MMC_SPI: 0 at 0:1 hz 20000000 mode 0</code></pre><br>
<p>:   . , -        :</p><br>
<p><strong>HiFive_U-Boot/cmd/bootmenu.c:</strong></p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bootmenu_loop</span><span class="hljs-params">(struct bootmenu_data *menu,
        <span class="hljs-keyword">enum</span> bootmenu_key *key, <span class="hljs-keyword">int</span> *esc)</span>
</span>{
    <span class="hljs-keyword">int</span> c;<font></font>
<font></font>
    <span class="hljs-keyword">while</span> (!tstc()) {<font></font>
        WATCHDOG_RESET();<font></font>
        mdelay(<span class="hljs-number">10</span>);<font></font>
    }<font></font>
<font></font>
    c = getc();<font></font>
<font></font>
    <span class="hljs-keyword">switch</span> (*esc) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
        <span class="hljs-comment">/* First char of ANSI escape sequence '\e' */</span>
        <span class="hljs-keyword">if</span> (c == <span class="hljs-string">'\e'</span>) {<font></font>
            *esc = <span class="hljs-number">1</span>;<font></font>
            *key = KEY_NONE;<font></font>
        }<font></font>
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
        <span class="hljs-comment">/* Second char of ANSI '[' */</span>
        <span class="hljs-keyword">if</span> (c == <span class="hljs-string">'['</span>) {<font></font>
...</code></pre><br>
<p> <abbr title="実際には、少なくともこれだけではなく、さらに参照してください">  </abbr>,    :      :</p><br>
<pre><code class="scala hljs">  <span class="hljs-keyword">case</span> <span class="hljs-type">DTSTimebase</span> =&gt; <span class="hljs-type">BigInt</span>(<span class="hljs-number">0</span>)</code></pre><br>
<p>…   ,      «   —  0».   <code>WithNBigCores</code>      1MHz (, ,      U-Boot).   , ,   :    ,  25MHz!     .   «» ...</p><br>
<pre><code class="plaintext hljs">Hit any key to stop autoboot:  0<font></font>
MMC_SPI: 0 at 0:1 hz 20000000 mode 0<font></font>
## Unknown partition table type 0<font></font>
libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND<font></font>
** No partition table - mmc 0 **<font></font>
## Info: input data size = 34 = 0x22<font></font>
Running uEnv.txt boot2...<font></font>
## Error: "boot2" not defined<font></font>
HiFive-Unleashed #</code></pre><br>
<p>   ! ,  , , ,   <code>mmc_spi 1 10000000 0; mmc part</code>,   SPI  20MHz  10MHz. ? ,       20MHz,      . ,   , ,    ,  :      (  —  25MHz)  ,           .   ,    115200Hz UART-   ,  ,     25000000  20000000  1, ..     25MHz. ,   ,    , ,  -  (   )…  ,      —  , , . 25MHz —    Core i9.</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="plaintext hljs">HiFive-Unleashed # env edit mmcsetup<font></font>
edit: mmc_spi 1 10000000 0; mmc part<font></font>
HiFive-Unleashed # boot<font></font>
MMC_SPI: 1 at 0:1 hz 10000000 mode 0<font></font>
<font></font>
Partition Map for MMC device 0  --   Partition Type: EFI<font></font>
<font></font>
Part    Start LBA       End LBA         Name<font></font>
        Attributes<font></font>
        Type GUID<font></font>
        Partition GUID<font></font>
  1     0x00000800      0x0000ffde      "Vfat Boot"<font></font>
        attrs:  0x0000000000000000<font></font>
        type:   ebd0a0a2-b9e5-4433-87c0-68b6b72699c7<font></font>
        type:   data<font></font>
        guid:   76bd71fd-1694-4ff3-8197-bfa81699c2fb<font></font>
  2     0x00040800      0x002efaf4      "root"<font></font>
        attrs:  0x0000000000000000<font></font>
        type:   0fc63daf-8483-4772-8e79-3d69d8477de4<font></font>
        type:   linux<font></font>
        guid:   9f3adcc5-440c-4772-b7b7-283124f38bf3<font></font>
  3     0x0000044c      0x000007e4      "uboot"<font></font>
        attrs:  0x0000000000000000<font></font>
        type:   5b193300-fc78-40cd-8002-e86c45580b47<font></font>
        guid:   bb349257-0694-4e0f-9932-c801b4d76fa3<font></font>
  4     0x00000400      0x0000044b      "uboot-env"<font></font>
        attrs:  0x0000000000000000<font></font>
        type:   a09354ac-cd63-11e8-9aff-70b3d592f0fa<font></font>
        guid:   4db442d0-2109-435f-b858-be69629e7dbf<font></font>
libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND<font></font>
2376 bytes read in 0 ms<font></font>
Running uEnv.txt boot2...<font></font>
15332118 bytes read in 0 ms<font></font>
## Loading kernel from FIT Image at 90000000 ...<font></font>
   Using 'config-1' configuration<font></font>
   Trying 'bbl' kernel subimage<font></font>
     Description:  BBL/SBI/riscv-pk<font></font>
     Type:         Kernel Image<font></font>
     Compression:  uncompressed<font></font>
     Data Start:   0x900000d4<font></font>
     Data Size:    74266 Bytes = 72.5 KiB<font></font>
     Architecture: RISC-V<font></font>
     OS:           Linux<font></font>
     Load Address: 0x80000000<font></font>
     Entry Point:  0x80000000<font></font>
     Hash algo:    sha256<font></font>
     Hash value:   28972571467c4ad0cf08a81d9cf92b9dffc5a7cb2e0cd12fdbb3216cf1f19cbd<font></font>
   Verifying Hash Integrity ... sha256+ OK<font></font>
## Loading fdt from FIT Image at 90000000 ...<font></font>
   Using 'config-1' configuration<font></font>
   Trying 'fdt' fdt subimage<font></font>
     Description:  unavailable<font></font>
     Type:         Flat Device Tree<font></font>
     Compression:  uncompressed<font></font>
     Data Start:   0x90e9d31c<font></font>
     Data Size:    6911 Bytes = 6.7 KiB<font></font>
     Architecture: RISC-V<font></font>
     Load Address: 0x81f00000<font></font>
     Hash algo:    sha256<font></font>
     Hash value:   10b0244a5a9205357772ea1c4e135a4f882409262176d8c7191238cff65bb3a8<font></font>
   Verifying Hash Integrity ... sha256+ OK<font></font>
   Loading fdt from 0x90e9d31c to 0x81f00000<font></font>
   Booting using the fdt blob at 0x81f00000<font></font>
## Loading loadables from FIT Image at 90000000 ...<font></font>
   Trying 'kernel' loadables subimage<font></font>
     Description:  Linux kernel<font></font>
     Type:         Kernel Image<font></font>
     Compression:  uncompressed<font></font>
     Data Start:   0x900123e8<font></font>
     Data Size:    10781356 Bytes = 10.3 MiB<font></font>
     Architecture: RISC-V<font></font>
     OS:           Linux<font></font>
     Load Address: 0x80200000<font></font>
     Entry Point:  unavailable<font></font>
     Hash algo:    sha256<font></font>
     Hash value:   72a9847164f4efb2ac9bae736f86efe7e3772ab1f01ae275e427e2a5389c84f0<font></font>
   Verifying Hash Integrity ... sha256+ OK<font></font>
   Loading loadables from 0x900123e8 to 0x80200000<font></font>
## Loading loadables from FIT Image at 90000000 ...<font></font>
   Trying 'ramdisk' loadables subimage<font></font>
     Description:  buildroot initramfs<font></font>
     Type:         RAMDisk Image<font></font>
     Compression:  gzip compressed<font></font>
     Data Start:   0x90a5a780<font></font>
     Data Size:    4467411 Bytes = 4.3 MiB<font></font>
     Architecture: RISC-V<font></font>
     OS:           Linux<font></font>
     Load Address: 0x82000000<font></font>
     Entry Point:  unavailable<font></font>
     Hash algo:    sha256<font></font>
     Hash value:   883dfd33ca047e3ac10d5667ffdef7b8005cac58b95055c2c2beda44bec49bd0<font></font>
   Verifying Hash Integrity ... sha256+ OK<font></font>
   Loading loadables from 0x90a5a780 to 0x82000000</code></pre></div></div><br>
<p>,     ,     .      .  mcause ,      <code>$pc</code>   <code>si</code>   <code>trap_entry</code>.    U-Boot     mcause = 0..4,      .     ,  ,    ,  :    <code>conf/rvboot-fit.txt</code> :</p><br>
<pre><code class="plaintext hljs">fitfile=image.fit<font></font>
# below much match what's in FIT (ugha)</code></pre><br>
<p> ,     ,      ,   ,  <code>SIF0</code> —  <abbr title="それは次に判明したので、実際にはありません"> -  PCIe</abbr>:</p><br>
<pre><code class="diff hljs"><span class="hljs-deletion">-bootargs=console=ttySIF0,921600 debug</span>
<span class="hljs-addition">+bootargs=console=ttyS0,125200 debug</span></code></pre><br>
<p>       SHA-256  MD5:     ( ,  ),    ,         MD5 —  .    ?        (    ),   :</p><br>
<pre><code class="plaintext hljs">...<font></font>
   Verifying Hash Integrity ... md5+ OK<font></font>
   Loading loadables from 0x90a5a758 to 0x82000000<font></font>
libfdt fdt_check_header(): FDT_ERR_BADMAGIC<font></font>
chosen {<font></font>
        linux,initrd-end = &lt;0x00000000 0x83000000&gt;;<font></font>
        linux,initrd-start = &lt;0x00000000 0x82000000&gt;;<font></font>
        riscv,kernel-end = &lt;0x00000000 0x80a00000&gt;;<font></font>
        riscv,kernel-start = &lt;0x00000000 0x80200000&gt;;<font></font>
        bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait";<font></font>
};<font></font>
libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND<font></font>
chosen {<font></font>
        linux,initrd-end = &lt;0x00000000 0x83000000&gt;;<font></font>
        linux,initrd-start = &lt;0x00000000 0x82000000&gt;;<font></font>
        riscv,kernel-end = &lt;0x00000000 0x80a00000&gt;;<font></font>
        riscv,kernel-start = &lt;0x00000000 0x80200000&gt;;<font></font>
        bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait";<font></font>
};<font></font>
   Loading Kernel Image ... OK<font></font>
Booting kernel in<font></font>
3</code></pre><br>
<p>    ...</p><br>
<pre><code class="plaintext hljs">(gdb) x/x 0x0200bff8<font></font>
0x200bff8:      0x00000000</code></pre><br>
<p>, ,     ,     ,  . , ,  ,         ,  :</p><br>
<pre><code class="plaintext hljs">0x00000000bff6dbb0 in ?? ()<font></font>
(gdb) set variable *0x0200bff8=1000000<font></font>
(gdb) c<font></font>
Continuing.<font></font>
^C<font></font>
Program received signal SIGINT, Interrupt.<font></font>
0x00000000bff6dbb0 in ?? ()<font></font>
(gdb) set variable *0x0200bff8=2000000<font></font>
(gdb) c<font></font>
Continuing.<font></font>
^C<font></font>
Program received signal SIGINT, Interrupt.<font></font>
0x00000000bff6dbb0 in ?? ()<font></font>
(gdb) set variable *0x0200bff8=3000000<font></font>
(gdb) c<font></font>
Continuing.</code></pre><br>
<p> ...</p><br>
<pre><code class="plaintext hljs">   Loading Kernel Image ... OK<font></font>
Booting kernel in<font></font>
3<font></font>
2<font></font>
1<font></font>
0<font></font>
## Starting application at 0x80000000 ...</code></pre><br>
<p> ,     —  , ,     !</p><br>
<p>       - </p><br>
<pre><code class="plaintext hljs">0000000080001c20 &lt;poweroff&gt;:<font></font>
    80001c20:   1141                    addi    sp,sp,-16<font></font>
    80001c22:   e022                    sd      s0,0(sp)<font></font>
    80001c24:   842a                    mv      s0,a0<font></font>
    80001c26:   00005517                auipc   a0,0x5<font></font>
    80001c2a:   0ca50513                addi    a0,a0,202 # 80006cf0 &lt;softfloat_countLeadingZeros8+0x558&gt;<font></font>
    80001c2e:   e406                    sd      ra,8(sp)<font></font>
    80001c30:   f7fff0ef                jal     ra,80001bae &lt;printm&gt;<font></font>
    80001c34:   8522                    mv      a0,s0<font></font>
    80001c36:   267000ef                jal     ra,8000269c &lt;finisher_exit&gt;<font></font>
    80001c3a:   00010797                auipc   a5,0x10<font></font>
    80001c3e:   41e78793                addi    a5,a5,1054 # 80012058 &lt;htif&gt;<font></font>
    80001c42:   639c                    ld      a5,0(a5)<font></font>
    80001c44:   c399                    beqz    a5,80001c4a &lt;poweroff+0x2a&gt;<font></font>
    80001c46:   72c000ef                jal     ra,80002372 &lt;htif_poweroff&gt;<font></font>
    80001c4a:   45a1                    li      a1,8<font></font>
    80001c4c:   4501                    li      a0,0<font></font>
    80001c4e:   dc7ff0ef                jal     ra,80001a14 &lt;send_ipi_many&gt;<font></font>
    80001c52:   10500073                wfi<font></font>
    80001c56:   bff5                    j       80001c52 &lt;poweroff+0x32&gt;</code></pre><br>
<p>  Berkeley Boot Loader.       <code>htif</code> — host interface,   tethered-  (      ARM), -  standalone. ,      ,  ,     :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">poweroff</span><span class="hljs-params">(<span class="hljs-keyword">uint16_t</span> code)</span>
</span>{<font></font>
  printm(<span class="hljs-string">"Power off\r\n"</span>);<font></font>
  finisher_exit(code);<font></font>
  <span class="hljs-keyword">if</span> (htif) {<font></font>
    htif_poweroff();<font></font>
  } <span class="hljs-keyword">else</span> {<font></font>
    send_ipi_many(<span class="hljs-number">0</span>, IPI_HALT);
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) { <span class="hljs-function"><span class="hljs-keyword">asm</span> <span class="hljs-title">volatile</span> <span class="hljs-params">(<span class="hljs-string">"wfi\n"</span>)</span></span>; }<font></font>
  }<font></font>
}</code></pre><br>
<h2 id="kvest-zapusti-chasy">:  </h2><br>
<p>   CLINT   </p><br>
<pre><code class="scala hljs">    <span class="hljs-keyword">val</span> io = <span class="hljs-type">IO</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">Bundle</span> {
      <span class="hljs-keyword">val</span> rtcTick = <span class="hljs-type">Bool</span>(<span class="hljs-type">INPUT</span>)<font></font>
    })<font></font>
<font></font>
    <span class="hljs-keyword">val</span> time = <span class="hljs-type">RegInit</span>(<span class="hljs-type">UInt</span>(<span class="hljs-number">0</span>, width = timeWidth))<font></font>
    when (io.rtcTick) { time := time + <span class="hljs-type">UInt</span>(<span class="hljs-number">1</span>) }</code></pre><br>
<p>   RTC,    MockAON,     : «,     ? ? !»      ,       ,       <code>System.scala</code>:</p><br>
<pre><code class="scala hljs">  <span class="hljs-keyword">val</span> rtcDivider = <span class="hljs-type">RegInit</span>(<span class="hljs-number">0.</span>asUInt(<span class="hljs-number">16.</span><span class="hljs-type">W</span>)) <span class="hljs-comment">//      16,   :)</span>
  <span class="hljs-keyword">val</span> mhzInt = p(<span class="hljs-type">DevKitFPGAFrequencyKey</span>).toInt
  <span class="hljs-comment">// ,     </span>
  rtcDivider := <span class="hljs-type">Mux</span>(rtcDivider === (mhzInt - <span class="hljs-number">1</span>).<span class="hljs-type">U</span>, <span class="hljs-number">0.</span><span class="hljs-type">U</span>, rtcDivider + <span class="hljs-number">1.</span><span class="hljs-type">U</span>)<font></font>
  outer.clintOpt.foreach { clint =&gt;<font></font>
    clint.module.io.rtcTick := rtcDivider === <span class="hljs-number">0.</span><span class="hljs-type">U</span>
  }</code></pre><br>
<h2 id="probirayas-k-linux-kernel">  Linux kernel</h2><br>
<p>          ,    :</p><br>
<p>BBL   FDT   <code>0xF0000000</code>,     !   ,  …   <strong>HiFive_U-Boot/arch/riscv/lib/boot.c</strong>,   <code>0x81F00000</code>,     U-Boot.</p><br>
<p> BBL ,   .      <code>mem_prop</code>,   <strong>riscv-pk/machine/fdt.c</strong>:   ,     fdt ram  <code>device_type = "memory"</code> — , ,     ,      —       .</p><br>
<p>    (   ,   ):</p><br>
<pre><code class="plaintext hljs">This is bbl's dummy_payload.  To boot a real kernel, reconfigure bbl<font></font>
with the flag --with-payload=PATH, then rebuild bbl. Alternatively,<font></font>
bbl can be used in firmware-only mode by adding device-tree nodes<font></font>
for an external payload and use QEMU's -bios and -kernel options.</code></pre><br>
<p>,      <code>riscv,kernel-start</code>  <code>riscv,kernel-end</code>  DTB,   .  <code>query_chosen</code> ,  BBL   32- ,     <code>&lt;0x0 0xADDR&gt;</code>,   , ,  .    <code>chosen</code></p><br>
<pre><code class="plaintext hljs">chosen {<font></font>
      #address-cells = &lt;1&gt;;<font></font>
      #size-cells = &lt;0&gt;;<font></font>
      ...<font></font>
}</code></pre><br>
<p>   : <abbr title="しかし、より良い解決策があります">  <code>0x0</code>  </abbr>.</p><br>
<p> 100500       ,   :</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="plaintext hljs">   Verifying Hash Integrity ... md5+ OK<font></font>
   Loading loadables from 0x90a5a758 to 0x82000000<font></font>
libfdt fdt_check_header(): FDT_ERR_BADMAGIC<font></font>
chosen {<font></font>
        linux,initrd-end = &lt;0x83000000&gt;;<font></font>
        linux,initrd-start = &lt;0x82000000&gt;;<font></font>
        riscv,kernel-end = &lt;0x80a00000&gt;;<font></font>
        riscv,kernel-start = &lt;0x80200000&gt;;<font></font>
        #address-cells = &lt;0x00000001&gt;;<font></font>
        #size-cells = &lt;0x00000000&gt;;<font></font>
        bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait";<font></font>
        stdout-path = "uart0:38400n8";<font></font>
};<font></font>
libfdt fdt_path_offset() returned FDT_ERR_NOTFOUND<font></font>
chosen {<font></font>
        linux,initrd-end = &lt;0x83000000&gt;;<font></font>
        linux,initrd-start = &lt;0x82000000&gt;;<font></font>
        riscv,kernel-end = &lt;0x80a00000&gt;;<font></font>
        riscv,kernel-start = &lt;0x80200000&gt;;<font></font>
        #address-cells = &lt;0x00000001&gt;;<font></font>
        #size-cells = &lt;0x00000000&gt;;<font></font>
        bootargs = "debug console=tty0 console=ttyS0,125200 root=/dev/mmcblk0p2 rootwait";<font></font>
        stdout-path = "uart0:38400n8";<font></font>
};<font></font>
   Loading Kernel Image ... OK<font></font>
Booting kernel in<font></font>
3<font></font>
2<font></font>
1<font></font>
0<font></font>
## Starting application at 0x80000000 ...<font></font>
bbl loader<font></font>
<font></font>
                SIFIVE, INC.<font></font>
<font></font>
         5555555555555555555555555<font></font>
        5555                   5555<font></font>
       5555                     5555<font></font>
      5555                       5555<font></font>
     5555       5555555555555555555555<font></font>
    5555       555555555555555555555555<font></font>
   5555                             5555<font></font>
  5555                               5555<font></font>
 5555                                 5555<font></font>
5555555555555555555555555555          55555<font></font>
 55555           555555555           55555<font></font>
   55555           55555           55555<font></font>
     55555           5           55555<font></font>
       55555                   55555<font></font>
         55555               55555<font></font>
           55555           55555<font></font>
             55555       55555<font></font>
               55555   55555<font></font>
                 555555555<font></font>
                   55555<font></font>
                     5<font></font>
<font></font>
           SiFive RISC-V Core IP<font></font>
[    0.000000] OF: fdt: Ignoring memory range 0x80000000 - 0x80200000<font></font>
[    0.000000] Linux version 4.19.0-sifive-1+ (trosinenko@trosinenko-pc) (gcc version 8.3.0 (Buildroot 2019.02-07449-g4eddd28f99)) #1 SMP Wed Jul 3 21:29:21 MSK 2019<font></font>
[    0.000000] bootconsole [early0] enabled<font></font>
[    0.000000] Initial ramdisk at: 0x(____ptrval____) (16777216 bytes)<font></font>
[    0.000000] Zone ranges:<font></font>
[    0.000000]   DMA32    [mem 0x0000000080200000-0x00000000bfffffff]<font></font>
[    0.000000]   Normal   [mem 0x00000000c0000000-0x00000bffffffffff]<font></font>
[    0.000000] Movable zone start for each node<font></font>
[    0.000000] Early memory node ranges<font></font>
[    0.000000]   node   0: [mem 0x0000000080200000-0x00000000bfffffff]<font></font>
[    0.000000] Initmem setup node 0 [mem 0x0000000080200000-0x00000000bfffffff]<font></font>
[    0.000000] On node 0 totalpages: 261632<font></font>
[    0.000000]   DMA32 zone: 3577 pages used for memmap<font></font>
[    0.000000]   DMA32 zone: 0 pages reserved<font></font>
[    0.000000]   DMA32 zone: 261632 pages, LIFO batch:63<font></font>
[    0.000000] software IO TLB: mapped [mem 0xbb1fc000-0xbf1fc000] (64MB)</code></pre></div></div><br>
<p>(  BBL,       — ).</p><br>
<p> ,  ,  ,   RocketChip     JTAG   trap-   —      .</p><br>
<pre><code class="plaintext hljs">Program received signal SIGTRAP, Trace/breakpoint trap.<font></font>
0xffffffe0000024ca in ?? ()<font></font>
(gdb) bt<font></font>
#0  0xffffffe0000024ca in ?? ()<font></font>
Backtrace stopped: previous frame identical to this frame (corrupt stack?)<font></font>
(gdb) file work/linux/vmlinux<font></font>
A program is being debugged already.<font></font>
Are you sure you want to change the file? (y or n) y<font></font>
Reading symbols from work/linux/vmlinux...done.<font></font>
(gdb) bt<font></font>
#0  0xffffffe0000024ca in setup_smp () at /hdd/trosinenko/fpga/freedom-u-sdk/linux/arch/riscv/kernel/smpboot.c:75<font></font>
#1  0x0000000000000000 in ?? ()<font></font>
Backtrace stopped: frame did not save the PC</code></pre><br>
<p><strong>freedom-u-sdk/linux/arch/riscv/kernel/smpboot.c:</strong></p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> __init <span class="hljs-title">setup_smp</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_node</span> *<span class="hljs-title">dn</span> = <span class="hljs-title">NULL</span>;</span>
    <span class="hljs-keyword">int</span> hart;
    <span class="hljs-keyword">bool</span> found_boot_cpu = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">int</span> cpuid = <span class="hljs-number">1</span>;<font></font>
<font></font>
    <span class="hljs-keyword">while</span> ((dn = of_find_node_by_type(dn, <span class="hljs-string">"cpu"</span>))) {<font></font>
        hart = riscv_of_processor_hartid(dn);<font></font>
        <span class="hljs-keyword">if</span> (hart &lt; <span class="hljs-number">0</span>)
            <span class="hljs-keyword">continue</span>;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (hart == cpuid_to_hartid_map(<span class="hljs-number">0</span>)) {<font></font>
            BUG_ON(found_boot_cpu);<font></font>
            found_boot_cpu = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">continue</span>;<font></font>
        }<font></font>
<font></font>
        cpuid_to_hartid_map(cpuid) = hart;<font></font>
        set_cpu_possible(cpuid, <span class="hljs-literal">true</span>);<font></font>
        set_cpu_present(cpuid, <span class="hljs-literal">true</span>);<font></font>
        cpuid++;<font></font>
    }<font></font>
<font></font>
    BUG_ON(!found_boot_cpu); <span class="hljs-comment">// &lt;   </span>
}</code></pre><br>
<p>    , <em>CPU not found, running software emulation</em>.    running.     .</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* The lucky hart to first increment this variable will boot the other cores */</span>
<span class="hljs-keyword">atomic_t</span> hart_lottery;
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> boot_cpu_hartid;</code></pre><br>
<p>   <strong>linux/arch/riscv/kernel/setup.c</strong> —       .  ,   -  ,     ...</p><br>
<p>        .</p><br>
<p> .       ,   ,      singlestep-.</p><br>
<p>   ( ):<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://asciinema.org/a/h22F5eCMXYF9n7n89CY6NJNEi.svg" alt="アスキーキャスト"></a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja458462/index.html">Linux名前空間の詳細</a></li>
<li><a href="../ja458464/index.html">レーザーモデムの3 kmギガビットリンク</a></li>
<li><a href="../ja458470/index.html">テクスチャリング、またはSurfaceアーティストになるために知っておくべきこと。パート2.マスクとテクスチャ</a></li>
<li><a href="../ja458472/index.html">オープンデータを使用した熱ポテンシャル法による地域の評価の編集</a></li>
<li><a href="../ja458474/index.html">HighLoad ++ 2018を使用した最高のレポート</a></li>
<li><a href="../ja458484/index.html">PSR規格</a></li>
<li><a href="../ja458486/index.html">ゲームでファブリックを操作する秘訣アランウェイク</a></li>
<li><a href="../ja458488/index.html">データサイエンスダイジェスト（2019年7月）</a></li>
<li><a href="../ja458490/index.html">ハンドルをしっかり握って…ドライバーの状態をモニタリングするプロジェクト</a></li>
<li><a href="../ja458492/index.html">«Мы всегда верили в конкуренцию и право выбора пользователя» © Яндекс</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>