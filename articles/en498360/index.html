<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê® üßëüèΩ‚Äçü§ù‚Äçüßëüèº üë®üèΩ Integrated Server Load Metrics Evaluation üöó üë©‚Äçüë¶‚Äçüë¶ üñêÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Working in one of the largest banks in the country, I had to face the task of evaluating the efficiency of resource use of approximately 16 thousand s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Integrated Server Load Metrics Evaluation</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498360/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Working in one of the largest banks in the country, I had to face the task of evaluating the efficiency of resource use of approximately 16 thousand servers. </font><font style="vertical-align: inherit;">The task was formulated very simply - it was necessary to develop a methodology for evaluating server load metrics for a period. </font><font style="vertical-align: inherit;">Ideally, server load per period should be estimated using one or several (no more than 8) numbers.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A few words about the features of using virtual servers</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Large organizations (especially banks) have a motley zoo of legacy applications deployed on different servers using a variety of virtualization technologies. A private cloud is a promising technology, but in reality, large organizations will long use various virtualization platforms to deploy a variety of applications.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As virtualization platforms evolve, there comes a time when no one in the company can understand how efficiently the resources are used. Even the most advanced monitoring tools do not provide an answer to this question due to various server usage scenarios. For example, a department may have a report server that will be fully loaded for only a limited period of time. Say 3-4 hours at the end of the month. In real-life scenarios, no one allocates dynamically resources for such servers - this is difficult technically and organizationally. Resources are allocated specifically for the maximum periodic server load, although it happens infrequently. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a summary, in large organizations, virtual farm resources are spent extremely inefficiently.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below I propose a methodology with which you can easily justify the increase and decrease in resources allocated to the virtual server, regardless of the scenario.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Methodology</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To assess the load of resources, it is necessary to collect statistics of various counters; to assess the load of resources, various metrics will be used. Conventionally, counters can be divided into 2 types (according to the rate of change): ‚Äúfast‚Äù and ‚Äúslow‚Äù. A good example of a ‚Äúfast‚Äù counter is the processor load counter (% CPU). An example of a slow counter is the percentage of free hard disk space (% FreeSpace). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Evaluation of slow counters consists in calculating the extreme (minimum or maximum) value of the metric for the period. This approach allows (for example, when assessing disk free space) to estimate the free resource and, if necessary, to allocate additional volumes or reduce current ones.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For fast counters, a different approach is used. The disadvantages of using simple integral metrics (average, maximum, minimum and median) to assess the dynamics of such counters are well described </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Common disadvantages include the lack of information about increased loads (medium and peak). If we take the maximum value for the period as an integral metric, then the presence of outliers (for example, instant loading of the CPU up to 100% when the program starts) will not give objective information. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is proposed to use the 0.9 quantile to estimate the fast metric (this is a value that indicates the level below which the observed value in 90% of the samples lies). With a uniform server load according to this metric, we can adequately estimate the average processor load. But this approach has the same drawbacks - the lack of information about increased loads (medium and peak). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below, as an illustration, the weekly and daily chart of the% CPU counter. The maximum counter value on the charts was 100%.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ym/al/xi/ymalxitgoyqlsthnyhs0cjttbie.png"><br>
<br>
<img src="https://habrastorage.org/webt/wj/xk/aj/wjxkajy2y3enm93easqblqnl-x8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The graph shows that during the indicated period there is a burst of load, which lasts about 3 hours. For this counter, a variety of metrics were calculated for the week. Figure 2 shows that the median (green line, 5% value), average (yellow, 12% value) and 0.9 quantile (red, 27% value) filter the load change and information about it is lost. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a development of the idea of ‚Äã‚Äãquantiles, I would like to propose the idea of ‚Äã‚Äãa sliding quantile. This is an analogue of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">moving average.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">but the quantile 0.9 is used as a window function. </font><font style="vertical-align: inherit;">Moreover, we will use 2 sliding quantiles to estimate the level of the counter - fast with a short period (1 hour) and slow with a long period (24 hours). </font><font style="vertical-align: inherit;">A fast quantile will filter out instantaneous emissions and provide peak load information. </font><font style="vertical-align: inherit;">A slow quantile will allow you to estimate the average load. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see from the graphs, moving quantiles of 0.9 are dynamic characteristics (brown - fast, purple - slow). </font><font style="vertical-align: inherit;">For simplicity, evaluating the status of the counter as metrics it is proposed to use:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the maximum quantile value with a period of 1 hour, which shows the maximum continuous server load for the period,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the average quantile value with a period of 24 hours, which shows the average server load for the period.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the graph, the maximum value of the fast quantile is the black line at 85%, the average value of the slow quantile is the pink line at 30%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, when analyzing the load of server resources (according to the% CPU counter), if we take the average for the month (12%) as a metric, we can make an erroneous decision to reduce the allocated resources. </font><font style="vertical-align: inherit;">The double fast / slow moving quantile metric (85 and 30%) shows that there are enough allocated resources, but no surpluses.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decision</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The implementation of the assessment of the efficiency of resource use has been decomposed into 3 tasks:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data collection </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">development of assessment methodology </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">methodology implementation in current architecture </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Above, I examined task 2 of this implementation, below we will talk a little about the third task. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data was collected in the ClickHouse database. This column DBMS is ideal for storing time-series data. This was discussed in detail at </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClickHouse Meetup</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on September 5, 2019. A comparison of ClickHouse with other time-series DBMS can be found </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result of data collection, we formed several tables in which the data was organized line by line (the values ‚Äã‚Äãof each counter were written in a separate line). And, of course, there were problems with raw data.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first problem is the unevenness of the intervals between the counter entries. For example, if the standard counter recording period was 5 minutes, sometimes there were gaps and the next record was more than 5 minutes (up to 20 minutes) from the previous one. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second problem is that sometimes the counter data came 2 or more times (with different values) with the same time stamp. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the third problem - ClickHouse has no window functions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve the first problem, you can use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASOF JOIN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The idea is quite simple - for each counter of each server to create a table evenly with evenly filled time intervals. Using ASOF JOIN allows filling the values ‚Äã‚Äãin the new table with the nearest values ‚Äã‚Äãfrom the raw data table (filling options similar to ffill and bfill can be configured). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The solution to the second problem is aggregation with the choice of the maximum value at a given time.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve the third problem, several solutions were considered. </font><font style="vertical-align: inherit;">First, the Python script was rejected due to insufficient performance. </font><font style="vertical-align: inherit;">The second solution ‚Äî copying raw data to an MSSQL database, calculating metrics, and copying back ‚Äî seemed too complicated to implement. </font><font style="vertical-align: inherit;">MSSQL also has window functions, but there is no aggregate function needed. </font><font style="vertical-align: inherit;">One might be puzzled and write your own SQL CLR function. </font><font style="vertical-align: inherit;">But this option was rejected due to excessive complexity. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A working solution could be an SQL script for ClickHouse. </font><font style="vertical-align: inherit;">An example of this script is given below. </font><font style="vertical-align: inherit;">For simplicity, I looked at calculating only the fast quantile for a single counter for multiple servers. </font><font style="vertical-align: inherit;">The solution does not look very simple and not very convenient, but it works.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, a test report was created in PowerBI to demonstrate the methodology. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/qk/t9/kgqkt92tcilmz8h9gqieermwz3w.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/c_/m5/tk/c_m5tk-r1ehlvrdhh_dbsj3rzie.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In conclusion, I would like to speculate on the development of the solution. </font><font style="vertical-align: inherit;">If you look at the solution from the point of view of data warehouses, you can see that in this way the task of creating a data warehouse (Data Warehouse) from a layer of raw data (Staging Area) is solved. </font><font style="vertical-align: inherit;">You can discuss the architecture, but for ClickHouse as a column database, normalization is not critical (or maybe even harmful). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further development of the repository is seen in the creation of aggregate tables (day \ week \ month) with different lifetimes (TTL). </font><font style="vertical-align: inherit;">This will avoid excessive swelling of the storage. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step may be to use data for predictive analytics. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code and data for testing are posted </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498346/index.html">GoLand 2020.1 - Enhanced support for Go Modules, a lot of auto-completion and much more</a></li>
<li><a href="../en498350/index.html">The best materials for job interviews and job searches</a></li>
<li><a href="../en498352/index.html">SHISHUA: the world's fastest pseudo random number generator</a></li>
<li><a href="../en498354/index.html">How to translate ‚ÄúWishlist‚Äù into ‚Äúhardware‚Äù, or semi-ideal semi-mobile semi-desktop</a></li>
<li><a href="../en498358/index.html">Learn French or how to get a universal adapter from a PSA diagnostic scanner</a></li>
<li><a href="../en498362/index.html">Kingston maintains leadership in SSD shipments: how do we do it?</a></li>
<li><a href="../en498366/index.html">What algorithms do Yandex developers implement every day</a></li>
<li><a href="../en498368/index.html">The story of one switch</a></li>
<li><a href="../en498370/index.html">SAP UI5 and Confirmation Windows: Again About the Context</a></li>
<li><a href="../en498372/index.html">Network simulator tutorial ns-3. Chapter 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>