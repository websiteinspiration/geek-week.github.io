<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§πüèø üë©‚Äçüë©‚Äçüë¶‚Äçüë¶ üíº Linux Kernel TLS y Nginx üîê ü§≥üèº üçç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo hablar√© sobre la historia del desarrollo y el estado actual de la tecnolog√≠a para acelerar la distribuci√≥n de contenido en conexiones...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Linux Kernel TLS y Nginx</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501010/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En este art√≠culo hablar√© sobre la historia del desarrollo y el estado actual de la tecnolog√≠a para acelerar la distribuci√≥n de contenido en conexiones TLS mediante la transferencia de cifrado al n√∫cleo del sistema operativo, as√≠ como sobre mi contribuci√≥n al desarrollo de esta direcci√≥n.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antecedentes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2015, Randall Stewart y Scott Long de Netflix hicieron una presentaci√≥n en la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conferencia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> AsiaBSDCon2015 </font><font style="vertical-align: inherit;">sobre la optimizaci√≥n de la distribuci√≥n de contenido encriptado. El mensaje principal del informe es transferir el cifrado de datos al kernel del sistema operativo para reducir la cantidad de copias de datos entre kernel-space y user-space y utilizar la llamada optimizada del sistema sendfile () sin bloqueo. El tema result√≥ ser muy prometedor y ya en la conferencia </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netdev 1.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2016, </font><font style="vertical-align: inherit;">Dave Watson de Facebook hizo una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre la necesidad de crear sockets TLS en el kernel de Linux, y Boris Pismenny, Ilya Lesokhin y Liran Liss de Mellanox </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hicieron una presentaci√≥n.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sobre la capacidad de usar la aceleraci√≥n de hardware TLS en tarjetas de red. </font><font style="vertical-align: inherit;">El tema tambi√©n fue discutido en HighLoad ++ 2017 por un orador de Tempesta Technologies.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soporte de kernel de Linux</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado de todas estas conversaciones fue la aparici√≥n de Kernel TLS en el kernel Linux 4.13 (2017) con soporte para TLSv1.2 y el cifrado AES128-GCM. </font><font style="vertical-align: inherit;">Inicialmente, solo se admit√≠a el cifrado del tr√°fico saliente, el soporte de descifrado apareci√≥ m√°s tarde en el kernel de Linux 4.17 (2018). </font><font style="vertical-align: inherit;">En la versi√≥n 5.1, agregaron soporte para TLSv1.3 y AES256-GCM, y en la versi√≥n 5.2 tambi√©n agregaron el cifrado AES128-CCM (2019).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apoyo en espacio de usuario</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En todos los informes mencionados anteriormente, se dijo que solo el cifrado de datos √∫tiles se puede colocar en el n√∫cleo, y todas las aprobaciones de TLS y los mensajes de control deben procesarse de la misma manera en el espacio del usuario. Y para esto, se utiliz√≥ una versi√≥n modificada de OpenSSL. Sin embargo, en el momento de la publicaci√≥n de los informes en el dominio p√∫blico, no hab√≠a informaci√≥n sobre qu√© modificaciones a esta conocida biblioteca deb√≠an realizarse para admitir la funcionalidad. Quiz√°s el √∫nico ejemplo disponible del uso de Linux Kernel TLS fue el art√≠culo del blog Filippo Valsorda </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Playing with kernel TLS en Linux 4.13 y Go</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que apareci√≥ inmediatamente despu√©s del lanzamiento del n√∫cleo Linux 4.13. </font><font style="vertical-align: inherit;">Y, aunque mostr√≥ un ejemplo v√°lido del uso de la tecnolog√≠a, no trajo una comprensi√≥n de c√≥mo usar la tecnolog√≠a en proyectos reales. </font><font style="vertical-align: inherit;">Despu√©s de todo, muy pocas personas escriben un servidor WEB para su proyecto por su cuenta, generalmente todos usan herramientas conocidas y probadas.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soporte en OpenSSL</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las primeras discusiones sobre la tecnolog√≠a en OpenSSL aparecieron en el verano de 2017, poco antes del lanzamiento del kernel Linux 4.13 ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR 3631</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), sin embargo, el proceso de discusi√≥n fue muy, muy lento, los primeros comentarios reales aparecieron en octubre (despu√©s del lanzamiento del kernel 4.13), y en realidad la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versi√≥n de trabajo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comenz√≥ a debatir en febrero de 2018. Para cuando se acordaron todas las correcciones, se cerr√≥ la ventana para agregar nuevas funciones en OpenSSL 1.1.1 y el soporte para Kernel TLS se traslad√≥ a la pr√≥xima versi√≥n. </font><font style="vertical-align: inherit;">Desde ese momento, se ha agregado el soporte Kernel TLS RX, y SSL_sendfile () es una llamada a la llamada al sistema correspondiente con un peque√±o procesamiento de posibles situaciones en el protocolo TLS. </font><font style="vertical-align: inherit;">Pero ahora en 2020, OpenSSL 3.0 a√∫n no se ha lanzado, TLSv1.3 es compatible con la gran mayor√≠a de los navegadores, y el cifrado AES128-GCM se reemplaza activamente por el AES256-GCM m√°s resistente. </font><font style="vertical-align: inherit;">As√≠ que me tom√© la libertad y envi√© una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicitud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de extracci√≥n para admitir nuevos cifrados y TLSv1.3 con la esperanza de que lo aceptaran antes del nuevo lanzamiento de la biblioteca.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soporte en servidores WEB</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero soportar Kernel TLS en la biblioteca TLS no es suficiente. Los informes sobre la tecnolog√≠a dicen que se puede obtener la m√°xima eficiencia utilizando el env√≠o sin copiar datos al espacio del usuario, utilizando la llamada al sistema sendfile (). Y la aplicaci√≥n del servidor debe poder distinguir entre situaciones en las que puede usar sendfile () en un socket con TLS, y cuando necesita hacer "read the old way" read () / SSL_write (). En abril de 2019 apareci√≥ un cierto progreso hacia la adici√≥n de funcionalidad a Nginx, pero no se aceptaron cambios en el c√≥digo principal. La posici√≥n de los desarrolladores es que la API para estas funciones a√∫n no est√° aprobada en OpenSSL, y el c√≥digo real propuesto en el parche no parece ser lo suficientemente port√°til para diferentes plataformas. Para ser sincero, el c√≥digo no solo no se ve muy bien, sino que tambi√©n contiene errores que impiden que Nginx se cree sin correcciones adicionales.No pude encontrar el soporte de Kernel TLS en otros servidores web (tal vez alguien lo vio, d√≠game en los comentarios).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øY que hacer?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mientras la comunidad est√° esperando el lanzamiento de OpenSSL 3.0, para comenzar a desarrollar el soporte para Kernel TLS en Nginx con una API estable, yo fui en sentido contrario. </font><font style="vertical-align: inherit;">En mi </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rinc√≥n acogedor de</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GitHub, hice 2 cosas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cre√© </font><font style="vertical-align: inherit;">una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bifurcaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OpenSSL y export√© todo lo relacionado con Kernel TLS a la versi√≥n estable de OpenSSL 1.1.1 (rama OpenSSL_1_1_1-ktls). </font><font style="vertical-align: inherit;">Especialmente para poder verificar la funcionalidad en condiciones de funcionamiento estable del resto de la biblioteca. </font><font style="vertical-align: inherit;">A medida que las versiones estables est√°n disponibles, trato de cambiar la base para que el fork est√© actualizado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cre√© </font><font style="vertical-align: inherit;">una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bifurcaci√≥n de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nginx, en la que agregu√© (basado en un parche de Mellanox) soporte para llamar a SSL_sendfile () en condiciones cuando es realmente posible y con las comprobaciones de socket SSL necesarias, y la capacidad de habilitar / deshabilitar la funcionalidad a trav√©s de la variable de configuraci√≥n. </font><font style="vertical-align: inherit;">Adem√°s de esta caracter√≠stica, en mi bifurcaci√≥n tambi√©n hay varios parches que optimizan un poco el trabajo de Nginx y corrigen algunos errores (rama de caracter√≠stica maestra). </font><font style="vertical-align: inherit;">En la medida de lo posible, trato de volver a crear una base basada en la rama maestra del repositorio principal de Nginx, para mantener la bifurcaci√≥n actualizada.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Invito a todos a participar en las pruebas. </font><font style="vertical-align: inherit;">Se pueden enviar comentarios y correcciones al c√≥digo en Issues on GitHub. </font><font style="vertical-align: inherit;">Para construir este Nginx con este OpenSSL y el soporte Kernel TLS incluido, agregue par√°metros al script de configuraci√≥n:</font></font><br>
<br>
<pre><code class="bash hljs">./configure --with-openssl=&lt;OpenSSL-fork-dir&gt; --with-openssl-opt=<span class="hljs-string">"enable-ktls"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por el momento, no tengo la oportunidad de probar este paquete Nginx + OpenSSL bajo una gran carga para confirmar el rendimiento del comentario en el parche Nginx, por lo que si de repente alguien puede medir la diferencia en la carga de la CPU a altas velocidades de carga de archivos, ser√≠a genial obtener gr√°ficos y agregar ellos en un art√≠culo para una comprensi√≥n visual del efecto.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es501000/index.html">Generaci√≥n de c√≥digo en Go con el ejemplo de crear un cliente para la base de datos</a></li>
<li><a href="../es501002/index.html">Umka: nuevo lenguaje de script est√°ticamente tipado</a></li>
<li><a href="../es501004/index.html">Hazlo. Trabajo</a></li>
<li><a href="../es501006/index.html">Somos amigos STM32 con pantalla LCD 1604 en bus I2C (biblioteca HAL)</a></li>
<li><a href="../es501008/index.html">Pavimentaci√≥n de domin√≥</a></li>
<li><a href="../es501012/index.html">C√≥mo estaba buscando un motor para ni√±os para un blog</a></li>
<li><a href="../es501016/index.html">Sobre las tendencias de desarrollo de la arquitectura del procesador, o por qu√© creo en el √©xito de Huawei en el mercado de servidores</a></li>
<li><a href="../es501018/index.html">C√≥mo sortear algunas restricciones de Google Translate</a></li>
<li><a href="../es501020/index.html">C√≥mo probar el c√≥digo que contiene setTimeout / setInterval debajo del cap√≥</a></li>
<li><a href="../es501022/index.html">"Estoy en el desierto": por qu√© el autoaislamiento result√≥ ser un estr√©s grave para nosotros y lo que todo result√≥ en</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>