<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☄️ 🎅🏼 😠 Windowsのイベントトレースの学習：理論と実践 👩‍💻 👨🏼‍⚖️ 🛶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは。最近、Windowsトレースサービスに対処する必要がありました。このサービスはWindows 2000で登場しましたが、インターネット上のこのサービスに関する記事はほとんどなかったため、この記事を書くというアイデアが浮かびました。それでは始めましょう！
 
 今日私は話そうとします：
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Windowsのイベントトレースの学習：理論と実践</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502362/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは。</font><font style="vertical-align: inherit;">最近、Windowsトレースサービスに対処する必要がありました。</font><font style="vertical-align: inherit;">このサービスはWindows 2000で登場しましたが、インターネット上のこのサービスに関する記事はほとんどなかったため、この記事を書くというアイデアが浮かびました。</font><font style="vertical-align: inherit;">それでは始めましょう！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日私は話そうとします：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Windowsトレースサービスの理論</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ETWセッションの作成</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> イベントトレースAPIを使用してETWを操作する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tracerptとxperfを使用してETWを操作する</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windowsトレースサービスの理論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベントトレースfor Windows（ETW）は、1つまたは複数のイベントプロバイダーからリアルタイムで、または* .etlファイルから特定の期間イベントを受信できるようにするサービスです。</font><font style="vertical-align: inherit;">わからない？</font><font style="vertical-align: inherit;">それを理解しましょう！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ETWのしくみを理解するには、このサービスの構造を理解する必要があります</font></font><br>
<br>
<img src="https://docs.microsoft.com/en-us/windows/win32/etw/images/etdiag2.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。ETWアーキテクチャには4つの要素が含まれています</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベントプロバイダー</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベント消費者</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETWコントローラー</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETWセッション（イベントトレースセッション）</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
動作原理は以下の通りです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くのイベントプロバイダーがシステムに登録されています。</font><font style="vertical-align: inherit;">イベントをETWセッションと共有できるアプリケーション。</font><font style="vertical-align: inherit;">また、このシステムには、1つ以上のプロバイダーからのイベントを消費し、それらをリアルタイムでユーザーに提供するか、サプライヤーからのすべてのイベントをログファイル（* .etl）に書き込むことができるアクティブなETWセッションがいくつかあります。</font><font style="vertical-align: inherit;">そしてコントローラーはこの全体の動きを制御します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、上記で検討したアーキテクチャの各要素をより詳細に検討して、最終的に作業の原理を理解します。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベントプロバイダー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベントプロバイダーは、イベント追跡ツールを含むアプリケーションです。プロバイダーが登録された後、コントローラーはプロバイダーでのイベント追跡を有効または無効にできます。プロバイダーは、オンまたはオフの解釈を決定します。通常、有効なプロバイダーはイベントを生成しますが、無効なプロバイダーは生成しません。これにより、常にイベントを生成する必要なく、アプリケーションにイベントトラッキングを追加できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのベンダーは、一度に複数のETWセッションでイベントを共有できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各イベントは、ヘッダーとデータの2つの要素で構成されます。</font><font style="vertical-align: inherit;">イベントヘッダーには、イベントに関する情報（プロバイダー識別子、イベント識別子、タイムスタンプなど）が含まれています。</font><font style="vertical-align: inherit;">残りのデータは特定のプロバイダーによって決定されます。ETWはデータを受信して​​バッファーに書き込み、その解釈は情報の利用者に割り当てられます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロバイダーには、主に4つのタイプがあり</font><font style="vertical-align: inherit;">
ます。MOF </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロバイダー（クラシック）</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロバイダーWPP </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロバイダーは、マニフェスト</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロバイダーのTraceLoggingに</font><font style="vertical-align: inherit;">基づいてい</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベントプロバイダーは、イベントペイロードに格納するフィールドの種類が異なります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベントプロバイダーは整理されているようです。</font><font style="vertical-align: inherit;">進め！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コントローラー </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コントローラーは、1つ以上のETWセッションの操作を担当するアプリケーションです。</font><font style="vertical-align: inherit;">ログファイルのサイズと場所を決定し、イベントトレースセッション（ETWセッション）を開始および停止し、プロバイダーがセッションでイベントを記録できるようにするのは、コントローラーです。</font><font style="vertical-align: inherit;">前述のように、プロバイダーがイベントを共有できるのはコントローラーです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">消費者 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンシューマーは、1つ以上のトレースセッションから同時にイベントを受信して​​処理するアプリケーションです。</font><font style="vertical-align: inherit;">コンシューマーは、ログファイルに格納されたイベントを受信するか、イベントをリアルタイムで配信するセッションから受信できます。</font><font style="vertical-align: inherit;">すでにご存じのとおり、1つのETWセッションには複数のサプライヤーが参加する可能性があります。</font><font style="vertical-align: inherit;">問題が発生します：混乱はありますか？</font><font style="vertical-align: inherit;">さまざまなETWセッションのイベントはどのように相互に関連していますか？</font><font style="vertical-align: inherit;">イベントは発生した時間でソートされます。</font><font style="vertical-align: inherit;">システムは時系列でイベントを配信します！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETWセッション</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベント追跡セッション（ETWセッション）は、コントローラーが許可する1つ以上のプロバイダーからのイベントを記録します。</font><font style="vertical-align: inherit;">セッションは、バッファの管理とフラッシュも行います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベントトレースは、同時に実行される最大64のイベントトレースセッションをサポートします。</font><font style="vertical-align: inherit;">これらのセッションのうち、2つの特別な目的のセッションがあります。</font><font style="vertical-align: inherit;">残りのセッションは一般的に使用できます。</font><font style="vertical-align: inherit;">2つの特別目的セッション：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グローバルロガーセッション</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTカーネルロガーセッション</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
グローバルロガーイベントトレースセッションは、デバイスドライバーによって生成されたイベントなど、オペレーティングシステムの起動プロセスの最初に発生したイベントを記録します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NTイベントトラッキングセッションカーネルロガーは、ディスクI / Oイベントやページエラーなど、オペレーティングシステムによって生成された定義済みのシステムイベントを記録します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さあ、練習しましょう!!!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ETWセッションの作成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業を開始する前に、いくつかのユーティリティの知識が必要です。つまり</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、特定のOSで利用可能なプロバイダーのリスト</font></font><br>
<br>
<pre><code class="bash hljs">logman query providers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロバイダーに関する完全な情報を取得する</font></font><br>
<br>
<pre><code class="bash hljs">wevtutil gp &lt; &gt; /ge /gm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのアクティブなETWセッションのリスト</font></font><br>
<br>
<pre><code class="bash hljs">xperf -loggers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ファイルを表示するには、メモ帳++を用意することをお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンピューター上のプロバイダーのリスト（およびWindows 10には1000を超えるプロバイダー）のリストを確認した後、それらのセッションの1つを選択します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hl/6e/wm/hl6ewmoxww9guutq7rt9m_rnfug.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私はMicrosoft-Windows-WinINetを選択しました（このサービスは、Microsoft Edgeブラウザーで作業するときのすべてのアクションを記録します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Win + R-&gt; compmgmt.msc </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.「パフォーマンス」</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.「データコレクターセット」</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4.「イベントトレースセッション」</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5。 「新規」</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6.「データコレクターセット」</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. </font><font style="vertical-align: inherit;">データコレクター</font><font style="vertical-align: inherit;">の名前を指定し</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます8.「手動で作成（詳細）」（「手動で作成（経験者向け）」）</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gk/ec/_w/gkec_w2zlyy-m_jo25bm2bfgx38.png" alt="画像"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
9.興味深いものを追加しますセッションあたりの米国のプロバイダー</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
10. [Keywords（Any）]フィールドに興味のあるキーワードを</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
指定します-0xFFFFFFFFFFFFFFFFFF 11.ログレベルを指定します0xFF </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
= </font></font><img src="https://habrastorage.org/webt/d7/yw/3w/d7yw3w3ondmdrmeb_avfvnafa7y.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
12.セッションログファイルを保存するパスを選択します</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
13.「このデータコレクターセットを今すぐ開始します（「</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今すぐ</font><font style="vertical-align: inherit;">データコレクターのグループを実行します」）</font><font style="vertical-align: inherit;">作成したセッションが機能します。 Microsoft Edgeでは、セッションを取得して私たちに関する情報を収集するために、いくつかの作業が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しばらくしてから、ログファイルを保存した場所に移動します。そこで次のコマンドを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">tracerpt <span class="hljs-string">"   .etl"</span> -o -report -summary -lr</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコマンドを実行すると、4つのファイルが生成されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/up/e_/rp/upe_rph8_bnkvfuemiai0lquv0w.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、dumpfile.xmlに関心があります。</font><font style="vertical-align: inherit;">このファイルは、メモ帳++を使用して開くことも、Excelで開くこともできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このファイルを注意深く調査すると、このセッションはインターネット上の私たちの動きに関するほとんどすべての情報を収集したことがわかります!!! </font><font style="vertical-align: inherit;">あなたはここでそれについて続きを読むことができます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは、ETWと抽出利益を研究します</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、私たちは次に進みます。</font><font style="vertical-align: inherit;">単一のイベントプロバイダーとのセッションを作成しました。</font><font style="vertical-align: inherit;">ログファイルからセッションデータを受信しました。</font><font style="vertical-align: inherit;">コーディングの時間です！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベントトレースAPIを使用してETWを操作する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
habrには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これまでに作成され</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">た</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Worst API</font></a><font style="vertical-align: inherit;">という興味深い記事があり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、アプリケーションを作成するときに最もよくある多くの質問に対する回答を紹介します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++でコーディングします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も単純なものから始めましょう。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベント追跡セッションを構成して開始する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、一般的な考えを検討します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トレースセッションを開始するには：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1）構造EVENT_TRACE_PROPERTIESを設定します</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2）</font><font style="vertical-align: inherit;">StartTrace </font><font style="vertical-align: inherit;">を使用してセッションを開始します</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、イベントプロバイダーを有効にします</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3）EnableTraceを使用してプロバイダーをオンにします。 EnableTraceEx | EnableTraceEx2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トレースセッションを停止するには、次のことを行う必要があります</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。4）</font><font style="vertical-align: inherit;">トレースセッションを停止する前に、</font><font style="vertical-align: inherit;">EnableTrace </font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用してプロバイダーを無効にする必要があります。 EnableTraceEx | EnableTraceEx2、EVENT_CONTROL_CODE_DISABLE_PROVIDERを渡します</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5）ControlTrace関数を呼び出して、EVENT_TRACE_CONTROL_STOPを渡します</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下の例では、MyEventTraceSessionというセッションを作成しています。</font><font style="vertical-align: inherit;">現在のディレクトリにあるログファイルの名前はWriteThePuth.etlで</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、イベントプロバイダーはMicrosoft-Windows-Kernel-Processです。</font><font style="vertical-align: inherit;">あなたは彼のGUIDを見つけることができます</font></font><br>
<br>
<pre><code class="bash hljs">wevtutil gp Microsoft-Windows-Kernel-Process /ge /gm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
直接コーディング：</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-meta">#include &lt;windows.h&gt;</span>
<span class="hljs-meta">#include &lt;stdio.h&gt;</span>
<span class="hljs-meta">#include &lt;conio.h&gt;</span>
<span class="hljs-meta">#include &lt;strsafe.h&gt;</span>
<span class="hljs-meta">#include &lt;wmistr.h&gt;</span>
<span class="hljs-meta">#include &lt;evntrace.h&gt;</span>
<span class="hljs-meta">#include &lt;iostream&gt;</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGFILE_PATH L"WriteThePuth.etl"</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGSESSION_NAME L"MyEventTraceSession"</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">// GUID,     .</span>
<span class="hljs-comment">//      GUID .</span><font></font>
<font></font>
<span class="hljs-comment">// {AE44CB98-BD11-4069-8093-770EC9258A12}</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GUID SessionGuid =<font></font>
{ <span class="hljs-number">0xae44cb98</span>, <span class="hljs-number">0xbd11</span>, <span class="hljs-number">0x4069</span>, { <span class="hljs-number">0x80</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xe</span>, <span class="hljs-number">0xc9</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x8a</span>, <span class="hljs-number">0x12</span> } };<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// GUID,   ,   </span>
<span class="hljs-comment">//    .</span><font></font>
<font></font>
<span class="hljs-comment">//{22FB2CD6-0E7B-422B-A0C7-2FAD1FD0E716} Microsoft-Windows-Kernel-Process</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> GUID ProviderGuid =<font></font>
{ <span class="hljs-number">0xd22FB2CD6</span>, <span class="hljs-number">0x0E7B</span>, <span class="hljs-number">0x422B</span>, {<span class="hljs-number">0xA0</span>, <span class="hljs-number">0xC7</span>, <span class="hljs-number">0x2F</span>, <span class="hljs-number">0xAD</span>, <span class="hljs-number">0x1F</span>, <span class="hljs-number">0xD0</span>, <span class="hljs-number">0xE7</span>, <span class="hljs-number">0x16</span> } };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">wmain</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>)</span><font></font>
{<font></font>
    setlocale(LC_ALL, <span class="hljs-string">"ru"</span>);<font></font>
    ULONG status = ERROR_SUCCESS;<font></font>
    TRACEHANDLE SessionHandle = <span class="hljs-number">0</span>;<font></font>
    EVENT_TRACE_PROPERTIES* pSessionProperties = NULL;<font></font>
    ULONG BufferSize = <span class="hljs-number">0</span>;<font></font>
    BOOL TraceOn = TRUE;<font></font>
<font></font>
    <font></font>
    BufferSize = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-keyword">sizeof</span>(LOGFILE_PATH) + <span class="hljs-keyword">sizeof</span>(LOGSESSION_NAME);<font></font>
    pSessionProperties = (EVENT_TRACE_PROPERTIES*)malloc(BufferSize);<font></font>
    <span class="hljs-keyword">if</span> (NULL == pSessionProperties)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"Unable to allocate %d bytes for properties structure.\n"</span>, BufferSize);
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    ZeroMemory(pSessionProperties, BufferSize);<font></font>
    pSessionProperties-&gt;Wnode.BufferSize = BufferSize;<font></font>
    pSessionProperties-&gt;Wnode.Flags = WNODE_FLAG_TRACED_GUID;<font></font>
    pSessionProperties-&gt;Wnode.ClientContext = <span class="hljs-number">1</span>; <span class="hljs-comment">//QPC clock resolution</span><font></font>
    pSessionProperties-&gt;Wnode.Guid = SessionGuid;<font></font>
    pSessionProperties-&gt;LogFileMode = EVENT_TRACE_FILE_MODE_SEQUENTIAL;<font></font>
    pSessionProperties-&gt;MaximumFileSize = <span class="hljs-number">1024</span>;  <span class="hljs-comment">// 1024 MB</span>
    pSessionProperties-&gt;LoggerNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES);<font></font>
    pSessionProperties-&gt;LogFileNameOffset = <span class="hljs-keyword">sizeof</span>(EVENT_TRACE_PROPERTIES) + <span class="hljs-keyword">sizeof</span>(LOGSESSION_NAME);<font></font>
    StringCbCopy((LPWSTR)((<span class="hljs-keyword">char</span>*)pSessionProperties + pSessionProperties-&gt;LogFileNameOffset), <span class="hljs-keyword">sizeof</span>(LOGFILE_PATH), LOGFILE_PATH);<font></font>
    <font></font>
<font></font>
    status = StartTrace((PTRACEHANDLE)&amp;SessionHandle, LOGSESSION_NAME, pSessionProperties);<font></font>
    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"StartTrace() failed with %lu\n"</span>, status);
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//  ,   ,      .</span><font></font>
<font></font>
    status = EnableTraceEx2(<font></font>
        SessionHandle,<font></font>
        (LPCGUID)&amp;ProviderGuid,<font></font>
        EVENT_CONTROL_CODE_ENABLE_PROVIDER,<font></font>
        TRACE_LEVEL_INFORMATION,<font></font>
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,<font></font>
        NULL<font></font>
        );<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
    {<font></font>
        wprintf(L<span class="hljs-string">"EnableTrace() failed with %lu\n"</span>, status);<font></font>
        TraceOn = FALSE;<font></font>
        <span class="hljs-keyword">goto</span> cleanup;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   .    ,   </span>
    wprintf(L<span class="hljs-string">"Run the provider application. Then hit any key to stop the session.\n"</span>);<font></font>
    _getch();<font></font>
   <font></font>
<font></font>
cleanup:<font></font>
    <span class="hljs-keyword">if</span> (SessionHandle)<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span> (TraceOn)<font></font>
        {<font></font>
            status = EnableTraceEx2(<font></font>
                SessionHandle,<font></font>
                (LPCGUID)&amp;ProviderGuid,<font></font>
                EVENT_CONTROL_CODE_DISABLE_PROVIDER,<font></font>
                TRACE_LEVEL_INFORMATION,<font></font>
                <span class="hljs-number">0</span>,
                <span class="hljs-number">0</span>,
                <span class="hljs-number">0</span>,<font></font>
                NULL<font></font>
                );<font></font>
        }<font></font>
<font></font>
        status = ControlTrace(SessionHandle, LOGSESSION_NAME, pSessionProperties, EVENT_TRACE_CONTROL_STOP);<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (ERROR_SUCCESS != status)<font></font>
        {<font></font>
            wprintf(L<span class="hljs-string">"ControlTrace(stop) failed with %lu\n"</span>, status);<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (pSessionProperties)<font></font>
    {<font></font>
        free(pSessionProperties);<font></font>
        pSessionProperties = NULL;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のプログラムをさらに詳しく分析します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1）EVENT_TRACE_PROPERTIES構造体</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
を設定するイベントトレースセッションを構成するには、EVENT_TRACE_PROPERTIES構造体を使用してセッションプロパティを指定する必要があります。 EVENT_TRACE_PROPERTIES構造体に割り当てるメモリは、メモリ内の構造体に続くセッションとログファイルの名前を含めるのに十分な大きさである必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2）StartTraceを使用してセッションを開始するセッション</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
のプロパティを指定した後、StartTrace関数を呼び出してセッションを開始します。関数が成功した場合、SessionHandleパラメータにはセッション記述子が含まれ、LoggerNameOffsetプロパティにはセッション名のオフセットが含まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3）EnableTraceを使用してプロバイダーをオンにします。 EnableTraceEx | EnableTraceEx2 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セッションでのイベントの記録を許可するプロバイダーを有効にするには、EnableTrace関数を呼び出してクラシックプロバイダーを有効にし、EnableTraceEx関数を呼び出してマニフェストベースのプロバイダーを有効にします。その他の場合-EnableTraceEx2。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4）トレースセッションを停止する前に、EnableTraceを使用してプロバイダーを無効にする必要があります。 EnableTraceEx | EVENT_CONTROL_CODE_DISABLE_PROVIDERを渡して、TraceEx2を有効にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベントの収集後にトレースセッションを停止するには、ControlTrace関数を呼び出して、EVENT_TRACE_CONTROL_STOPを制御コードとして渡します。停止するセッションを指定するには、以前のStartTrace関数の呼び出しから取得したイベントトレースセッション記述子、または以前に開始したセッションの名前を渡します。セッションを停止する前に、必ずすべてのプロバイダーを切断してください。プロバイダーを初めてオフにする前にセッションを停止すると、ETWはプロバイダーを切断し、プロバイダーのコールバック制御関数を呼び出そうとします。セッションを開始したアプリケーションが、プロバイダーを切断したり、ControlTrace関数を呼び出したりせずに終了した場合、プロバイダーはオンのままです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5）トレースセッションを停止するには、ControlTrace関数を呼び出して、EVENT_TRACE_CONTROL_STOPを渡します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の例で見たように、イベントトレーシングAPIの使用は最も簡単ではありません。</font><font style="vertical-align: inherit;">作業内容に応じて、引き続きイベントプロバイダーまたはイベントコンシューマーを作成できます。</font><font style="vertical-align: inherit;">ただし、これらのタスクはどちらも非常に膨大であり、この記事では取り上げません。</font><font style="vertical-align: inherit;">さらに複雑なのは、4種類のイベントプロバイダーです。したがって、イベントを書き込むための4つのオプションと、それらを消費するための4つのオプションがあります。</font><font style="vertical-align: inherit;">イベントトレーシングAPIの使用については、公式のMicrosoft Webサイトで詳細に説明されています。イベントトレーシングの使用イベントトレーシングAPI </font><font style="vertical-align: inherit;">
をしばらく</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用した</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">後、質問がありました。私の人生を簡素化するユーティリティはありますか？</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tracerptとxperfを使用してETWを操作する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この章では、理論的な観点からこれらのユーティリティを検討しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tracerptコマンドを使用して、イベントトレースログ、パフォーマンスモニターによって生成されたログファイル、およびリアルタイムイベントトレースプロバイダーを分析できます。</font><font style="vertical-align: inherit;">ダンプファイル、レポートファイル、およびレポートスキーマを作成します。</font><font style="vertical-align: inherit;">このユーティリティには多数のパラメータがありますが、次の「最小」は作業を開始するのに適しています</font></font><br>
<br>
<pre><code class="bash hljs">tracerpt <span class="hljs-string">" 1- .etl"</span> ... <span class="hljs-string">" n- .etl"</span> -o &lt;   &gt; -report &lt;    &gt; -summary&lt;    &gt; </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
xperf.exeユーティリティは、本格的なコントローラーです。</font><font style="vertical-align: inherit;">ETWプロバイダーとセッションを管理するためのコマンドライン引数をサポートしています。</font><font style="vertical-align: inherit;">コントローラは、現在アクティブなセッションのステータスを要求し、システムに登録されているすべてのプロバイダのリストを受け取ることができます。</font><font style="vertical-align: inherit;">たとえば、すべてのアクティブなセッションを取得するには、次のコマンドを使用します。</font></font><br>
<br>
<pre><code class="bash hljs">C:\&gt;xperf -loggers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムに登録されているすべてのプロバイダーのリストを取得するには、次のコマンドを使用します。</font></font><br>
<br>
<pre><code class="bash hljs">C:\&gt;xperf -providers</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コントローラには、さらにいくつかの重要な機能があります。</font><font style="vertical-align: inherit;">セッションを更新し、バッファをディスクにフラッシュできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは今のところすべてです！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、この記事では、いくつかの興味深い問題（たとえば、リアルタイムでのイベントの消費や特別な目的のセッションでの作業）については取り上げませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたは以下のサイトでそれについて読むことができます：</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベントトレース</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 -公式Microsoftのドキュメント</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちは、ETWを勉強してのメリット抽出</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">悪の側でWindowsのイベントトレースを。</font><font style="vertical-align: inherit;">しかし、これは</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">これまで作成され</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">た</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">最悪のAPIで</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">はありません</font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja502350/index.html">人気のポータブルコンソールのサウンドアンプのリバースエンジニアリング-主な調査結果の説明</a></li>
<li><a href="../ja502352/index.html">モバイルデベロッパー向けの興味深い資料の要約＃344（5月12〜17日）</a></li>
<li><a href="../ja502354/index.html">IaaSプロバイダーはヨーロッパ市場で戦っています-状況と業界のイベントについて話し合います</a></li>
<li><a href="../ja502358/index.html">WinFormsアプリケーションでのApplicationControllerおよびIoCに基づくMVPの実装</a></li>
<li><a href="../ja502360/index.html">グリズリー放電またはスーパードリル</a></li>
<li><a href="../ja502366/index.html">オープンソースPythonの作業を比較する-名前付きエンティティの認識のためのライブラリ</a></li>
<li><a href="../ja502368/index.html">トレッドミルをポンピングします</a></li>
<li><a href="../ja502370/index.html">ブレッドボードにゲーム「Snake」を置く。パート1：ステートマシン</a></li>
<li><a href="../ja502372/index.html">ボックス版のBitrix24のカスタマイズの問題と原則</a></li>
<li><a href="../ja502374/index.html">FT8通信プロトコル-仕組み</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>