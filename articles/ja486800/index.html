<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛠️ ⌛️ 🐉 カサンドラ。オラクルしか知らないなら死なない方法 🖼️ 🛋️ 🥐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル。
 
 私の名前はミシャブトリモフです。カサンドラについて少しお話ししたいと思います。私の話は、NoSQLデータベースに遭遇したことがない人に役立ちます-知っておくべき多くの実装機能と落とし穴があります。そして、もしオラクルや他のリレーショナルベースを除けば、何も見たことがないな...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>カサンドラ。オラクルしか知らないなら死なない方法</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qiwi/blog/486800/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の名前はミシャブトリモフです。カサンドラについて少しお話ししたいと思います。私の話は、NoSQLデータベースに遭遇したことがない人に役立ちます-知っておくべき多くの実装機能と落とし穴があります。そして、もしオラクルや他のリレーショナルベースを除けば、何も見たことがないなら、これらのことはあなたの命を救うでしょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cassandraの良い点は何ですか？これは、単一障害点なしで設計されたNoSQLデータベースであり、拡張性に優れています。任意のベースに数テラバイトを追加する必要がある場合は、リングにノードを追加するだけです。別のデータセンターに拡張しますか？クラスタにノードを追加します。処理済みRPSを増やしますか？クラスタにノードを追加します。他の方法も機能します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/4s/4m/jn/4s4mjnltsraqofl5-ey4g2fi9t0.png" width="700"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼女は他に何が得意ですか？</font><font style="vertical-align: inherit;">多くのリクエストを処理するためのものです。</font><font style="vertical-align: inherit;">しかし、いくらですか？</font><font style="vertical-align: inherit;">1秒あたり10、20、30、40,000リクエスト-これは多くありません。</font><font style="vertical-align: inherit;">毎秒10万件の記録も要求されます。</font><font style="vertical-align: inherit;">毎秒200万件のリクエストを保持していると言う企業があります。</font><font style="vertical-align: inherit;">ここで彼らはおそらく信じなければなりません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして原則として、Cassandraはリレーショナルデータとの大きな違いが1つあります-それはそれらのようには見えません。</font><font style="vertical-align: inherit;">そして、これは覚えておくことが非常に重要です。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じように見えるすべてが同じように機能するわけではありません</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同僚が私のところに来て尋ねると、次のようになります。「CQL Cassandraクエリ言語は次のとおりです。これには、selectステートメントがあり、場所、場所、および場所があります。手紙を書いてもうまくいきません。なぜ？"。 Cassandraをリレーショナルデータベースとして扱う場合、これは残忍な自殺で人生を終わらせる理想的な方法です。そして私は主張しません、それはロシアでは禁止されています。あなたは何か間違ったことを設計しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、顧客が私たちのところにやって来て、こう言います：「テレビ番組のデータベース、またはレシピのディレクトリのデータベースを構築しましょう。そこに料理を用意するか、シリーズと俳優のリストを用意します。」私達は嬉しそうに言います：「さあ！」。これらは送信する2バイトで、2、3枚のプレートですべて準備ができています。すべてが非常に迅速に、確実に機能します。そして、顧客が来て主婦も逆の問題を解決していると言うまではすべてうまくいきます。彼らは製品のリストを持っていて、料理したい料理を知りたいのです。あなたが死んでいる。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、Cassandraがハイブリッドデータベースであるためです。これは、キー値であり、データを幅の広い列に格納します。 JavaまたはKotlinで言えば、次のように記述できます。</font></font><br>
<br>
<code>Map&lt;RowKey, SortedMap&lt;ColumnKey, ColumnValue&gt;&gt;</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、ソートされたマップも含まれるマップです。このマップの最初のキーは、行キーまたはパーティションキー-パーティションキーです。すでにソートされているマップのキーである2番目のキーは、クラスタリングキーです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースの分布を説明するために、3つのノードを描画します。次に、データをノードに分解する方法を理解する必要があります。すべてを1つに押し込んだ場合（ちなみに、1,000、2000、5-好きなだけの数になるかもしれません）、これは実際には配布に関するものではありません。したがって、数値を返す数学関数が必要です。ただの数、ある範囲に入る長い整数。そして、1つのノードが1つの範囲、2番目-2番目、n番目-n番目を担当します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vl/xn/mn/vlxnmnvvigtwc_ho-wkjqy5r60e.png" width="900"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この番号は、パーティションキーと呼ばれるものにのみ適用されるハッシュ関数を使用して取得されます。</font><font style="vertical-align: inherit;">これは主キーディレクティブで指定された列であり、これが最初で最も基本的なマップキーになる列です。</font><font style="vertical-align: inherit;">どのノードがどのデータを取得するかを決定します。</font><font style="vertical-align: inherit;">Cassandraで、SQLとほぼ同じ構文でテーブルが作成されます。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (<font></font>
	user_id uu <span class="hljs-keyword">id</span>,
	<span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>,
	<span class="hljs-keyword">year</span> <span class="hljs-built_in">int</span>,<font></font>
	salary <span class="hljs-built_in">float</span>,<font></font>
	PRIMARY <span class="hljs-keyword">KEY</span>(user_id)<font></font>
<font></font>
)<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合の主キーは1つの列で構成され、パーティションキーでもあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーはどのように私たちと一緒に落ちますか？</font><font style="vertical-align: inherit;">パートは1つのノートに分類され、別のノートに分類され、3番目のノートに分類されます。</font><font style="vertical-align: inherit;">これは通常のハッシュテーブルであり、マップでもあり、Pythonのディクショナリでもあり、すべての値の読み取り、キーによる読み取りおよび書き込みが可能な単純なKey値構造でもあります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vp/3_/xa/vp3_xa1bupu1wawi77ytwk0pike.png" width="900"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">選択：フィルターを許可してフルスキャンにする場合、またはしない方法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レッツ・書き込みいくつかの文を選択：</font></font><code>select * from users where, userid = </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。結局のところ、Oracleのように、selectを記述し、条件を指定すると、すべてが機能し、ユーザーはそれを取得します。ただし、たとえば、特定の出生年のユーザーを選択した場合、Cassandraは彼女が要求を満たすことができないことを誓います。彼女は私たちが誕生年のデータをどのように配布するかについて何も知らないため、キーとして指定された列は1つだけです。それから彼女は言います：「さて、私はまだこの要求を満たすことができる。許可フィルタリングを追加します。」ディレクティブを追加すると、すべてが機能します。そしてその瞬間、恐ろしいことが起こります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストデータを運転するとき、すべてがうまくいきます。たとえば、400万件のレコードがある本番環境で要求を満たした場合、すべてが私たちにとってあまり良くありません。フィルタリングの許可は、Cassandraがこのテーブルのすべてのデータをすべてのノード、すべてのデータセンター（このクラスターに多数ある場合）から収集し、それをフィルターすることを許可するディレクティブであるためです。これはフルスキャンの類似物であり、誰もがそれを喜ぶことはほとんどありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
識別子によるユーザーのみが必要な場合は、これが適しています。ただし、他のクエリを記述して、選択に他の制限を課す必要がある場合もあります。したがって、思い出してください。私たちは皆、パーティションキーを持つマップを持っていますが、その中にはソートされたマップがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、彼女にはクラスタリングキーと呼ばれるキーもあります。このキーは、選択した列で構成されます。この列を使用して、Cassandraはデータが物理的に並べ替えられ、各ノードに配置される方法を理解します。つまり、一部のパーティションキーの場合、クラスタリングキーは、データをこのツリーにどのようにプッシュするか、どのような場所に配置するかを正確に指示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは実際にはツリーであり、コンパレーターは単にそこで呼び出され、そこに特定の列のセットをオブジェクトの形で渡し、列の列挙の形でも設定されます。</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users_by_year_salary_id (<font></font>
	user_id <span class="hljs-keyword">uuid</span>,
	<span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>,
	<span class="hljs-keyword">year</span> <span class="hljs-built_in">int</span>,<font></font>
	salary <span class="hljs-built_in">float</span>,<font></font>
	PRIMARY <span class="hljs-keyword">KEY</span>((<span class="hljs-keyword">year</span>), salary, user_id)
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主キーディレクティブに注意してください。最初の引数（この場合は年）は常にパーティションキーです。</font><font style="vertical-align: inherit;">1つまたは複数の列で構成できますが、問題ではありません。</font><font style="vertical-align: inherit;">複数の列がある場合は、言語のプリプロセッサがこれが主キーであり、その後ろに他のすべての列-クラスタリングキーであることを理解できるように、括弧で再度削除する必要があります。</font><font style="vertical-align: inherit;">この場合、それらはコンパレーターで送信順に送信されます。</font><font style="vertical-align: inherit;">つまり、最初の列はより重要で、2番目の列はそれほど重要ではありません。</font><font style="vertical-align: inherit;">たとえば、等値フィールドのデータクラスを作成する場合は、フィールドをリストし、フィールドのサイズが大きいフィールドと小さいフィールドを書き込みます。</font><font style="vertical-align: inherit;">Cassandraでは、これは、相対的に言えば、等しい値が適用されるデータクラスフィールドです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソートを設定し、制限を課します</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソート順（降順、昇順、問題ではない）はキーの作成と同時に設定され、後で変更することはできないことに注意してください。データをどのように並べ替えるか、どのように配置するかを物理的に決定します。クラスタリングキーまたはソート順を変更する必要がある場合は、新しいテーブルを作成し、そこにデータを注ぎ込む必要があります。既存のものではこれは動作しません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/qh/qt/kgqhqtjece2c4irbhyll0mxsl10.png" width="900"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはテーブルにユーザーを入れて、彼らが最初に誕生年までにリングに入り、次に給与とユーザーIDによって各ノードの内部に入るのを見ました。これで、制限を課して選択できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの仕事が再び現れます</font></font><code>where, and</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そしてユーザーが私たちに連絡して、すべてが再び元気です。</font><font style="vertical-align: inherit;">しかし、重要度の低いクラスタリングキーパーツのみを使用しようとすると、Cassandraはすぐに、このオブジェクトにコンパレーターnullのこれらのフィールドがあるマップでは見つからないが、これを設定しただけであることを誓います。 -それがどこにあるか。</font><font style="vertical-align: inherit;">このノードからすべてのデータを再度取得して、フィルター処理する必要があります。</font><font style="vertical-align: inherit;">そして、これはノード内のフルスキャンのアナログです。これは悪いことです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理解できない状況では、新しいテーブルを作成します</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ID、年齢、または給与でユーザーを取得できるようにするには、どうすればよいですか？何もない。 2つのテーブルを使用するだけです。 3つの異なる方法でユーザーを取得する必要がある場合-3つのテーブルがあります。ネジのスペースを節約した時代は終わりました。これは最も安いリソースです。ユーザーにとって致命的となる応答時間よりはるかにコストがかかりません。ユーザーは、1分で何かを取得する方が10分よりもはるかに優れています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
過剰なスペースを交換し、非正規化されたデータを適切にスケーリングできるように交換して、確実に機能します。実際、実際には、3つのデータセンターで構成され、それぞれに5つのノードがあり、許容できるレベルのデータストレージ（確かに何も失われていない場合）を備えたクラスターは、1つのデータセンターの停止に完全に耐えることができます。そして、残りの2つのそれぞれにさらに2つのノードがあります。その後、問題が始まります。これは非常に優れた冗長性であり、2、3の不要なSSDドライブとプロセッサが必要です。したがって、リレーションシップも外部キーもないSQLではないCassandraを使用するには、単純なルールを知る必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご要望に応じて設計いたします。主なものはデータではなく、アプリケーションがデータをどのように処理するかです。彼が異なる方法で異なるデータを受信する必要がある場合、または同じデータを異なる方法で受信する必要がある場合、アプリケーションに都合のよい方法でそれらを配置する必要があります。そうしないと、フルスキャンに失敗し、Cassandraは何のメリットもありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データの非正規化は標準です。通常のフォームは忘れてください。リレーショナルデータベースはもうありません。私たちは何かを100回入れます、それは100回嘘をつくでしょう。とにかく止めるより安いです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パーティション分割用のキーを選択して、それらが通常分散されるようにします。</font><font style="vertical-align: inherit;">キーからのハッシュが1つの狭い範囲に入る必要はありません。</font><font style="vertical-align: inherit;">つまり、上の例の誕生年は悪い例です。</font><font style="vertical-align: inherit;">むしろ、ユーザーが通常は生年ごとに分布しているのは良いことであり、5年生の学生について話しているのは悪いことです。そこでパーティション分割するのはあまり良いことではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソートは、クラスタリングキーの作成中に一度選択されます。</font><font style="vertical-align: inherit;">それを変更する必要がある場合は、別のキーでテーブルをいっぱいにする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最も重要なことは、100の異なる方法で同じデータを収集する必要がある場合、100の異なるテーブルがあることです。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja486788/index.html">ウェビナー「リモート監視と機器診断。Winnum CNCソリューションのケーススタディ»</a></li>
<li><a href="../ja486790/index.html">そして再びQbot-バンキング型トロイの木馬の新種</a></li>
<li><a href="../ja486792/index.html">別の惑星の氷の衛星へのロボットの経路は、南極の深部から始まります</a></li>
<li><a href="../ja486794/index.html">人間のニューロンのプロセスは計算する予想外の能力を示しました</a></li>
<li><a href="../ja486798/index.html">サハリンにGameDevはありますか？終わり</a></li>
<li><a href="../ja486802/index.html">人々は推薦システムに出会います。因数分解</a></li>
<li><a href="../ja486804/index.html">グローバルヘルスインフォマティクス：クラウドテクノロジー</a></li>
<li><a href="../ja486808/index.html">薬局の電子妊娠検査：仕組み</a></li>
<li><a href="../ja486810/index.html">新しいOdnoklassnikiフロントエンド：ReactをJavaで起動します。パートII</a></li>
<li><a href="../ja486814/index.html">Zabbix：ネットワークトポロジは明確で自動</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>