<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧗🏼 🛂 🕣 我们如何在SSRS 2014上构建动态报告 👨🏻‍🍳 🕹️ 👩🏻‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我们已经讨论过如何帮助一家制造公司改变公司培训和人员发展流程。淹没在纸质文档和Excel电子表格中的客户员工获得了便捷的iPad应用程序和一个Web门户。该产品最重要的功能之一是创建动态报告，经理可以通过该报告来判断“现场”员工的工作。这些是巨大的文档，包含数十个字段，平均大小为3000 * 160...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>我们如何在SSRS 2014上构建动态报告</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/487704/"><img src="https://habrastorage.org/webt/_q/hb/qb/_qhbqb8irkmfwui-lrqaktkhe8q.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已经讨论过</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何帮助一家制造公司改变公司培训和人员发展流程。</font><font style="vertical-align: inherit;">淹没在纸质文档和Excel电子表格中的客户员工获得了便捷的iPad应用程序和一个Web门户。</font><font style="vertical-align: inherit;">该产品最重要的功能之一是创建动态报告，经理可以通过该报告来判断“现场”员工的工作。</font><font style="vertical-align: inherit;">这些是巨大的文档，包含数十个字段，平均大小为3000 * 1600像素。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在本文中，我们将讨论如何基于Microsoft SQL Server Reporting Services部署此功能，为什么这样的后端可能与Web门户成为坏朋友，以及哪些技巧将有助于建立他们的关系。</font><font style="vertical-align: inherit;">解决方案的整个业务部分已经在上一篇文章中进行了描述，因此在此我们重点关注技术问题。</font><font style="vertical-align: inherit;">让我们开始吧！</font></font><br>
<br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题的提法</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们有一个供数百个用户使用的门户。</font><font style="vertical-align: inherit;">它们按逐步的层次结构排列，其中每个用户都有一个较高级别的主管。</font><font style="vertical-align: inherit;">权限的这种区分是必要的，以便用户可以与任何下属员工一起创建事件。</font><font style="vertical-align: inherit;">您可以跳过步骤，即 </font><font style="vertical-align: inherit;">用户可以从比自己低的任何级别的员工处开始活动。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这意味着什么事件？</font><font style="vertical-align: inherit;">这可以是对贸易公司员工的培训，支持或证明，主管在销售点进行该行为。</font><font style="vertical-align: inherit;">此类事件的结果是在iPad上填写了调查表，其中对员工的专业素质和技能进行了评分。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据调查表数据，您可以准备统计信息，例如：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vasya Ivanov在一个月内与他的下属进行了多少活动？</font><font style="vertical-align: inherit;">其中有多少完成了？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">满意评级的百分比是多少？</font><font style="vertical-align: inherit;">采购员回答最糟糕的问题是什么？</font><font style="vertical-align: inherit;">哪个经理的考试成绩更差？</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这样的统计信息包含在</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">报告</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，可以通过网络接口来创建，在XLS，PDF，DOCX格式，并打印。</font><font style="vertical-align: inherit;">所有这些功能都是为不同级别的经理设计的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
报告的内容和设计在</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模板</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中定义</font><font style="vertical-align: inherit;">，可让您设置必要的参数。</font><font style="vertical-align: inherit;">如果将来用户需要新类型的报告，则系统可以创建模板，指定可修改的参数以及向门户网站添加模板。</font><font style="vertical-align: inherit;">所有这些-不会干扰产品的源代码和工作流程。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">规格和限制</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该门户网站运行在微服务架构上，前端使用Angular 5编写。资源使用JWT授权，支持Google Chrome，Firefox，Microsoft Edge和</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IE 11</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">浏览器</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有数据都存储在MS SQL Server 2014中。SQLServer Reporting Services（SSRS）已安装在服务器上，客户可以使用它，并且不会拒绝。</font><font style="vertical-align: inherit;">因此，最重要的限制是：从外部无法访问SSRS，因此您只能通过NTLM授权从本地网络访问Web界面和SOAP。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于SSRS的几句话</font></font></b><div class="spoiler_text"><b>SSRS </b>–    ,        ,     .     docs.microsoft.com,  SSRS        (API)    ( Report Server,  -    HTTP). <br>
</div></div><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请注意以下问题：如何在没有手动方法的情况下以最小的资源和最大的客户收益完成任务？</font></font></b></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于客户在专用服务器上具有SSRS，因此让SSRS进行所有生成和导出报告的工作。</font><font style="vertical-align: inherit;">然后，我们不必编写自己的报告服务，即可将模块导出到XLS，PDF，DOCX，HTML和相应的API。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，任务是使SSRS与门户成为朋友，并确保任务中指定功能的运行。</font><font style="vertical-align: inherit;">因此，让我们仔细研究一下这些方案的清单-几乎在每个方面都发现了有趣的细微差别。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决方案结构</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于我们已经有了SSRS，因此有用于管理报告模板的所有工具： </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">报表服务器-负责处理报表的整个逻辑，报表的存储，生成，管理等等。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">报表管理器-具有用于管理报表的网络界面的服务。</font><font style="vertical-align: inherit;">在这里，您可以将在SQL Server数据工具中创建的模板上载到服务器，配置访问权限，数据源和参数（包括在报告请求时可以更改的参数）。</font><font style="vertical-align: inherit;">他能够生成有关已下载模板的报告，并将其上传为各种格式，包括XLS，PDF，DOCX和HTML。</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">总计：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们在SQL Server数据工具中创建模板，借助于报表管理器，我们将其填充在报表服务器上，我们进行配置-并且它已经准备就绪。</font><font style="vertical-align: inherit;">我们可以生成报告，更改其参数。</font></font><br>
<br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下一个问题：如何通过门户网站要求生成有关特定模板的报告，并将结果显示在最前面以输出到UI或以所需格式下载？</font></font></i></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从SSRS向门户报告</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如上所述，SSRS具有自己的API，可以访问报告。但是出于安全性和数字卫生的原因，我们不想提供其功能-我们只需要以正确的格式向SSRS请求数据，然后将结果传输给用户即可。报表管理将由经过特殊培训的客户人员处理。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于仅从本地网络访问SSRS，因此服务器和门户之间的数据交换是通过代理服务进行的。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/kz/f5/9x/kzf59xp7_ltztohtag_orirmn5i.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">门户网站和服务器之间的数据交换</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
让我们看看它是如何工作的以及为什么ReportProxy在这里。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，在门户网站一侧，我们有一个ReportService，门户网站可以访问该报告服务。该服务检查用户的授权，其权限级别，并将数据从SSRS转换为合同规定的所需格式。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ReportService API仅包含2个方法，对我们来说已经足够了：</font></font><br>
<br>
<ol>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetReports-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提供当前用户可以接收的所有模板的标识符和名称；</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetReportData（格式，参数）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -使用给定的参数集，以指定的格式提供现成的导出报告数据。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您需要这两种方法才能与SSRS进行通信，并以正确的形式从中获取必要的数据。</font><font style="vertical-align: inherit;">从</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档中可以知道</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我们可以使用SOAP API通过HTTP访问报表服务器。</font><font style="vertical-align: inherit;">似乎这个谜团正在发展……但实际上，这里有一个惊喜在等待着我们。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于SSRS不对外开放，您只能通过NTLM身份验证来访问它，因此不能直接从SOAP门户获得它。</font><font style="vertical-align: inherit;">我们也有自己的愿望：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">仅允许访问所需的功能集，甚至禁止更改；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您必须切换到另一个报表系统，则ReportService中的编辑应该最少，最好根本不需要。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是ReportProxy为我们提供帮助的地方，它与SSRS位于同一台计算机上，并负责将ReportService的请求代理到SSRS。</font><font style="vertical-align: inherit;">请求处理如下：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务接收到来自ReportService的请求，检查JWT授权；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">按照API方法，代理通过SSRS中的SOAP协议获取必要的数据，并一路通过NTLM登录。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">响应该请求，将从SSRS接收的数据发送回ReportService。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实际上，ReportProxy是SSRS和ReportService之间的适配器。 </font></font><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">控制器如下：</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs">[BasicAuthentication]<font></font>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReportProxyController</span> : <span class="hljs-title">ApiController</span>
</span>{<font></font>
    [HttpGet()]<font></font>
    public List&lt;ReportItem&gt; Get(string rootPath)<font></font>
    {<font></font>
        <span class="hljs-comment">//  ...</span><font></font>
    }<font></font>
<font></font>
    public HttpResponseMessage Post([FromBody]ReportRequest request)<font></font>
    {<font></font>
        <span class="hljs-comment">//  ...</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br>
  BasicAuthentication   :<br>
<br>
<pre><code class="javascript hljs">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicAuthenticationAttribute</span> : <span class="hljs-title">AuthorizationFilterAttribute</span>
</span>{<font></font>
    public override <span class="hljs-keyword">void</span> OnAuthorization(HttpActionContext actionContext)<font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> authHeader = actionContext.Request.Headers.Authorization;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (authHeader != <span class="hljs-literal">null</span>)<font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> authenticationToken = actionContext.Request.Headers.Authorization.Parameter;
            <span class="hljs-keyword">var</span> tokenFromBase64 = Convert.FromBase64String(authenticationToken);
            <span class="hljs-keyword">var</span> decodedAuthenticationToken = Encoding.UTF8.GetString(tokenFromBase64);
            <span class="hljs-keyword">var</span> usernamePasswordArray = decodedAuthenticationToken.Split(<span class="hljs-string">':'</span>);
            <span class="hljs-keyword">var</span> userName = usernamePasswordArray[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">var</span> password = usernamePasswordArray[<span class="hljs-number">1</span>];<font></font>
<font></font>
            <span class="hljs-keyword">var</span> isValid = userName == BasiAuthConf.Login &amp;&amp; password == BasiAuthConf.Password;<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (isValid)<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> principal = <span class="hljs-keyword">new</span> GenericPrincipal(<span class="hljs-keyword">new</span> GenericIdentity(userName), <span class="hljs-literal">null</span>);<font></font>
                Thread.CurrentPrincipal = principal;<font></font>
<font></font>
                <span class="hljs-keyword">return</span>;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        HandleUnathorized(actionContext);<font></font>
    }<font></font>
<font></font>
    private <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> HandleUnathorized(HttpActionContext actionContext)<font></font>
    {<font></font>
        actionContext.Response = actionContext.Request.CreateResponse(<font></font>
            HttpStatusCode.Unauthorized<font></font>
        );<font></font>
<font></font>
        actionContext.Response.Headers.Add(<font></font>
            <span class="hljs-string">"WWW-Authenticate"</span>, <span class="hljs-string">"Basic Scheme='Data' location = 'http://localhost:"</span><font></font>
        );<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果，该过程如下所示：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前端将http请求发送到ReportService；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReportService将http请求发送到ReportProxy；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReportProxy通过SOAP接口从SSRS接收数据并将结果发送到ReportService；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReportService根据合同带来结果，并将结果提供给客户端。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们有一个工作系统，该系统要求提供可用模板列表，并转至SSRS进行报告，并以任何受支持的格式将其显示在最前面。</font><font style="vertical-align: inherit;">现在，您需要根据指定的参数在正面显示生成的报告，并有机会将其上传到XLS，PDF，DOCX文件并进行打印。</font><font style="vertical-align: inherit;">让我们从显示开始。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在门户网站中使用SSRS报告</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
乍看之下，这是日常事务-报告采用HTML格式，因此我们可以做任何想做的事情！</font><font style="vertical-align: inherit;">我们将其嵌入页面中，以设计样式进行着色，然后事情就发生了。</font><font style="vertical-align: inherit;">实际上，事实证明有很多陷阱。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据设计概念，门户网站上的报告部分应包含两个页面：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1）模板列表，我们可以在其中：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查看整个门户网站的活动统计信息；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查看我们可用的所有模板；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单击所需的模板，然后转到相应的报告生成器。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/yx/tp/1h/yxtp1h3tvvpujymptptca2gcyew.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2）报告生成器，使我们能够：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置模板参数并为其创建报​​告；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查看结果如何；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选择输出文件格式，下载；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以方便，直观的形式打印报告。</font></font></li>
</ul><br>
 <img src="https://habrastorage.org/webt/au/ct/2f/auct2fiklpvvfad6vpbovv0xat0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一页没有特殊问题，因此我们将不作进一步考虑。</font><font style="vertical-align: inherit;">报告生成器迫使我们打开工程师的位置，以便真正的人可以方便地使用TK上的所有功能。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题编号1。</font><font style="vertical-align: inherit;">巨人桌</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据设计概念，此页面应具有查看区域，以便用户可以在导出之前查看其报告。如果报表不适合窗口，则可以水平和垂直滚动。同时，一个典型的报告可以达到几个屏幕的大小，这意味着我们需要粘贴带有行和列名称的块。否则，用户将不得不不断返回表格的顶部以记住特定单元格的含义。或者通常，打印报告并不断将必要的叶子放在眼前会更容易，但随后屏幕上的桌子就失去了意义。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，不能避免粘附块。而且SSRS 2014不知道如何修复MHTML文档中的行和列-仅在其自己的Web界面中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，我们回想起现代浏览器支持</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSS sticky属性</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，该</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">属性</font></a><font style="vertical-align: inherit;">仅提供我们需要的功能。放置位置：在已标记的块上粘贴，在左侧或顶部指定缩进量（left，top属性），并且在水平和垂直滚动期间该块将保留在原位。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您需要找到CSS可以捕获的参数。允许SSRS 2014在Web界面中捕获它们的自定义单元格值在导出为HTML时丢失。好，我们将自己标记它们-我们只会了解如何。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在阅读了几个小时的文档和与同事讨论之后，似乎没有选择。在这里，根据绘图的所有定律，ToolTip字段为我们打开了，这使我们可以指定单元格的工具提示。原来，它被扔到了工具提示属性中的导出HTML代码中-恰好在属于SQL Server数据工具中自定义单元格的标记上。别无选择-我们没有找到另一种方法标记细胞以进行固定。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，您需要通过ToolTip在HTML中构建标记规则和转发标记。然后，使用JS，将工具提示属性更改为指定标记处的CSS类。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
只有两种固定单元的方法：垂直（固定列）和水平（固定行）。</font><font style="vertical-align: inherit;">在角单元格上放置另一个标记是有意义的，当在两个方向上滚动时，这些标记将保留在原处-固定不变。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下一步是执行UI。</font><font style="vertical-align: inherit;">收到HTML文档时，需要查找其中带有标记的所有HTML元素，识别值，设置适当的CSS类并删除tooltip属性，以便将鼠标悬停时该属性不会出现。</font><font style="vertical-align: inherit;">应当注意，结果标记由嵌套表（表标记）组成。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查看代码</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs">type FixationType = <span class="hljs-string">'row'</span> | <span class="hljs-string">'column'</span> | <span class="hljs-string">'both'</span>;<font></font>
<font></font>
init(reportHTML: HTMLElement) {<font></font>
    <span class="hljs-comment">//    </span><font></font>
<font></font>
    <span class="hljs-comment">// -  </span>
    <span class="hljs-keyword">const</span> rowsFixed: NodeList = reportHTML.querySelectorAll(<span class="hljs-string">'[title^="RowFixed"]'</span>);
    <span class="hljs-comment">// -  </span>
    <span class="hljs-keyword">const</span> columnFixed: NodeList = reportHTML.querySelectorAll(<span class="hljs-string">'[title^="ColumnFixed"]'</span>);
    <span class="hljs-comment">// -    </span>
    <span class="hljs-keyword">const</span> bothFixed: NodeList = reportHTML.querySelectorAll(<span class="hljs-string">'[title^="BothFixed"]'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">this</span>.prepare(rowsFixed, <span class="hljs-string">'row'</span>);
    <span class="hljs-keyword">this</span>.prepare(columnFixed, <span class="hljs-string">'column'</span>);
    <span class="hljs-keyword">this</span>.prepare(bothFixed, <span class="hljs-string">'both'</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
prepare(nodeList: NodeList, <span class="hljs-attr">fixingType</span>: FixationType) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; nodeList.length; i++) {
        <span class="hljs-keyword">const</span> element: HTMLElement = nodeList[i];
        <span class="hljs-comment">//   -</span>
        element.classList.add(fixingType + <span class="hljs-string">'-fixed'</span>);<font></font>
<font></font>
        element.removeAttribute(<span class="hljs-string">'title'</span>);<font></font>
        element.removeAttribute(<span class="hljs-string">'alt'</span>); <span class="hljs-comment">//   SSRS</span><font></font>
<font></font>
        element.parentElement.classList.add(fixingType  + <span class="hljs-string">'-fixed-parent'</span>);<font></font>
<font></font>
        <span class="hljs-comment">//     ,     </span>
        element.style.width = element.getBoundingClientRect().width  + <span class="hljs-string">'px'</span>;
        <span class="hljs-comment">//     ,     </span>
        element.style.height = element.getBoundingClientRect().height  + <span class="hljs-string">'px'</span>;<font></font>
<font></font>
        <span class="hljs-comment">//  </span>
        <span class="hljs-keyword">this</span>.calculateCellCascadeParams(element, fixingType);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一个新问题：具有级联行为，当在一个表中一次固定几个沿一个方向移动的块时，一个接一个的单元将被分层。</font><font style="vertical-align: inherit;">同时，尚不清楚每个下一个块应退缩多少-缩进必须通过JavaScript根据其前面的块的高度进行计算。</font><font style="vertical-align: inherit;">所有这些都适用于垂直和水平锚。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更正脚本解决了该问题。</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-comment">//      </span>
calculateCellCascadeParams(cell: HTMLElement, <span class="hljs-attr">fixationType</span>: FixationType) {
    <span class="hljs-keyword">const</span> currentTD: HTMLTableCellElement = cell.parentElement;
    <span class="hljs-keyword">const</span> currentCellIndex = currentTD.cellIndex;<font></font>
<font></font>
    <span class="hljs-comment">//   </span>
    currentTD.style.left = <span class="hljs-string">''</span>;<font></font>
    currentTD.style.top = <span class="hljs-string">''</span>;<font></font>
<font></font>
    <span class="hljs-keyword">const</span> currentTDStyles = getComputedStyle(currentTD);<font></font>
<font></font>
    <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">if</span> (fixationType === <span class="hljs-string">'row'</span> || fixationType === <span class="hljs-string">'both'</span>) {
        <span class="hljs-keyword">const</span> parentRow: HTMLTableRowElement = currentTD.parentElement;<font></font>
<font></font>
        <span class="hljs-comment">//        </span>
        <span class="hljs-comment">//    .</span>
        <span class="hljs-comment">//   ,    .</span>
        <span class="hljs-keyword">let</span> previousRow: HTMLTableRowElement = parentRow;
        <span class="hljs-keyword">let</span> topOffset = <span class="hljs-number">0</span>;<font></font>
<font></font>
        <span class="hljs-keyword">while</span> (previousRow = previousRow.previousElementSibling) {
            <span class="hljs-keyword">let</span> previousCellIndex = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">let</span> cellIndexBulk = <span class="hljs-number">0</span>;<font></font>
<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; previousRow.cells.length; i++) {
                <span class="hljs-keyword">if</span> (previousRow.cells[i].colSpan &gt; <span class="hljs-number">1</span>) {<font></font>
                    cellIndexBulk += previousRow.cells[i].colSpan;<font></font>
                } <span class="hljs-keyword">else</span> {<font></font>
                    cellIndexBulk += <span class="hljs-number">1</span>;<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> ((cellIndexBulk - <span class="hljs-number">1</span>) &gt;= currentCellIndex) {<font></font>
                    previousCellIndex = i;<font></font>
                    <span class="hljs-keyword">break</span>;<font></font>
                }<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">const</span> previousCell = previousRow.cells[previousCellIndex];<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (previousCell.classList.contains(fixationType + <span class="hljs-string">'_fixed_parent'</span>)) {<font></font>
                topOffset += previousCell.getBoundingClientRect().height;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (topOffset &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span> (currentTDStyles.top) {<font></font>
                topOffset += &lt;any&gt;currentTDStyles.top.replace('px', '') - 0;<font></font>
            }<font></font>
<font></font>
            currentTD.style.top = topOffset + 'px';<font></font>
        }<font></font>
    }<font></font>
<font></font>
    //  <font></font>
    if (fixationType === 'column' || fixationType === 'both') {<font></font>
        //       <font></font>
        //     .<font></font>
        //   ,    .<font></font>
        let previousCell: HTMLTableCellElement = currentTD;<font></font>
        let leftOffset = 0;<font></font>
<font></font>
        while (previousCell = previousCell.previousElementSibling) {<font></font>
            if (previousCell.classList.contains(fixationType + '_fixed_parent')) {<font></font>
                leftOffset += previousCell.getBoundingClientRect().width;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        if (leftOffset &gt; 0) {<font></font>
            if (currentTDStyles.left) {<font></font>
                leftOffset += &lt;any&gt;currentTDStyles.left.replace('px', '') - 0;<font></font>
            }<font></font>
<font></font>
            currentTD.style.left = leftOffset + 'px';<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该代码检查标记元素的标签，并将固定单元格的参数添加到缩进值。</font><font style="vertical-align: inherit;">对于粘附行，对于列，将其高度相加，然后将其宽度相加。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/vj/ix/bf/vjixbfnbewh6_pb3smfcogdpevc.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">带有粘性顶部报告的示例，</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
结果如下所示：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们从SSRS获取标记，并将其粘贴到DOM中的正确位置；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">识别标记；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调整级联行为的参数。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于粘贴行为是通过CSS完全实现的，而JS仅涉及传入文档的准备，因此该解决方案的运行速度足够快且没有滞后。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不幸的是，对于IE，必须禁用粘贴块，因为 </font><font style="vertical-align: inherit;">它不支持位置：粘性属性。</font><font style="vertical-align: inherit;">其余的-Safari，Mozilla Firefox和Chrome-表现出色。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
继续。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题编号2。</font><font style="vertical-align: inherit;">报告导出</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要将报告从系统中拉出，您必须（1）通过ReportService访问Blob对象的SSRS，（2）使用window.URL.createObjectURL方法通过接口获取到该对象的链接，（3）将链接放在标记中并模拟点击上传文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
此功能适用于Firefox，Safari和Apple以外的所有版本的Chrome。为了使IE，Edge和iOS的Chrome浏览器也支持该功能，我不得不全神贯注。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在IE和Edge中，该事件根本不会触发浏览器下载文件的请求。这些浏览器具有这样的功能：为了模拟点击，需要确认用户要下载，以及明确指示进一步的操作。该解决方案在window.navigator.msSaveOrOpenBlob（）方法中找到，该方法在IE和Edge中均可用。他只知道如何向用户征求操作许可，并明确下一步要做什么。因此，我们确定window.navigator.msSaveOrOpenBlob方法是否存在，并对此情况采取行动。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
iOS上的Chrome没有这种骇客功能，我们没有报告，而是有空白页。</font><font style="vertical-align: inherit;">在网上漫步时，我们发现了一个类似的故事，判断应该在iOS 13中修复此错误。</font><font style="vertical-align: inherit;">不幸的是，我们早在iOS 12时就编写了该应用程序，因此最终我们决定不再浪费时间，只需关闭Chrome for iOS中的按钮即可。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在介绍最终导出到UI的过程。</font><font style="vertical-align: inherit;">Angular报表组件中有一个按钮，可启动一系列步骤：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过事件的参数，处理程序将接收导出格式的标识符（例如，“ PDF”）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">向ReportService发送请求以接收指定格式的Blob对象；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查浏览器是IE还是Edge；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当答案来自ReportService时：</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果是IE或Edge，则调用window.navigator.msSaveOrOpenBlob（fileStream，fileName）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">否则，它将调用this.exportDownload（fileStream，fileName）方法，其中fileStream是从对ReportService的请求中获取的Blob，而fileName是要保存的文件的名称。</font><font style="vertical-align: inherit;">该方法使用链接到window.URL.createObjectURL（fileStream）的方法创建一个隐藏标签，模拟单击并删除该标签。</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解决了这个问题之后，最后的冒险仍然存在。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题编号3。</font><font style="vertical-align: inherit;">打印</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们可以在门户网站上查看报告，并将其导出为XLS，PDF，DOCX格式。</font><font style="vertical-align: inherit;">为了获得准确的多页报告，仍然需要执行文档的打印。</font><font style="vertical-align: inherit;">如果事实证明该表分为几页，则每个页面都应包含标题-与上一节中我们讨论过的粘滞块相同。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最简单的选择是使用显示的报告获取当前页面，使用CSS隐藏所有多余的内容，然后使用window.print（）方法将其发送以进行打印。</font><font style="vertical-align: inherit;">由于以下几个原因，该方法无法立即使用：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非标准查看区域-报表本身包含在可单独滚动的区域中，因此页面不会拉伸到令人难以置信的水平尺寸。</font><font style="vertical-align: inherit;">使用window.print（）修剪不适合屏幕的内容；</font></font></li>
<li>   ,      ;</li>
<li>     ,       .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有这些都可以使用JS和CSS进行修复，但是我们决定节省开发人员的时间，并寻找window.print（）的替代方法。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SSRS可以立即为我们提供具有适当分页功能的现成PDF。这使我们免于先前版本的所有麻烦，唯一的问题是，我们可以通过浏览器打印PDF吗？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于PDF是第三方标准，因此浏览器通过各种查看器插件来支持它。没有插件-没有卡通漫画，因此我们再次需要其他选择。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您将PDF作为图像放在页面上，然后发送该页面进行打印？ Angular已经有提供此类渲染的库和组件。搜索，试验，实施。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了不处理我们不想打印的数据，决定将渲染的内容传输到新页面，并且已经执行window.print（）。</font><font style="vertical-align: inherit;">结果，整个过程如下：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请求ReportService以PDF格式导出报告；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们得到Blob对象，将其转换为URL（URL.createObjectURL（fileStream）），将该URL提供给PDF查看器进行渲染；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们从PDF查看器中获取图像；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">打开一个新页面，并在其中添加一些标记（标题，一些缩进）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将PDF查看器中的图像添加到标记中，调用window.print（）。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
经过多次检查后，页面上还出现了一个JS代码，该代码在打印之前检查是否已加载所有图像。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，文档的整体外观由SSRS模板的参数确定，并且UI不会干扰此过程。</font><font style="vertical-align: inherit;">这减少了可能的错误数量。</font><font style="vertical-align: inherit;">由于图像正被传输进行打印，因此我们可以确保版面不受损坏或变形。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
也有缺点：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">较大的报告会占很大的比重，这会对移动平台产生不利影响；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设计不会自动更新-需要在模板级别安装颜色，字体和其他设计元素。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我们的案例中，预计不会频繁添加新模板，因此该解决方案是可以接受的。</font><font style="vertical-align: inherit;">移动性能已被视为理所当然。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后一个字</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是常规项目再次使我们为非平凡任务寻找简单解决方案的方式。</font><font style="vertical-align: inherit;">最终产品完全符合设计要求，外观漂亮。</font><font style="vertical-align: inherit;">最重要的是，尽管我们不必寻找最明显的实现方法，但是完成任务的速度要比采用原始报告模块承担所有后果的速度快。</font><font style="vertical-align: inherit;">最后，我们能够专注于项目的业务目标。</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN487690/index.html">PHP摘要173号（2020年1月27日至2月10日）</a></li>
<li><a href="../zh-CN487694/index.html">虚拟私有云如何托管Yandex.Cloud，以及我们的用户如何帮助我们实现有用的功能</a></li>
<li><a href="../zh-CN487696/index.html">2月10日至16日在莫斯科举行的数字活动</a></li>
<li><a href="../zh-CN487698/index.html">2月10日至16日在圣彼得堡举行的数字活动</a></li>
<li><a href="../zh-CN487702/index.html">机器学习文章精选：案例研究，指南和2020年1月的研究</a></li>
<li><a href="../zh-CN487706/index.html">使用Consul示例的分布式系统中的服务发现。亚历山大·西加切夫（Alexander Sigachev）</a></li>
<li><a href="../zh-CN487716/index.html">完美的SAST。解析器</a></li>
<li><a href="../zh-CN487720/index.html">关于竞争性的白痴症（以反应性编程为例）</a></li>
<li><a href="../zh-CN487724/index.html">BlazingPizza：Blazor应用程序从头到尾。第2部分。添加组件</a></li>
<li><a href="../zh-CN487728/index.html">@Pythonetc汇编，2020年1月</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>