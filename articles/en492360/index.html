<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>➗ 🛑 👊🏾 Home-made compiler and game library Raylib. Docking experience 🗜️ 👩🏻‍🤝‍👨🏽 👩🏽‍🤝‍👨🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="They say that the success of a programming language or compiler depends largely on its ability to interact with third-party code. Of course, the "succ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Home-made compiler and game library Raylib. Docking experience</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492360/"><img src="https://habrastorage.org/webt/8t/_f/bp/8t_fbpm_rwroajowpikfyrhm17w.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They say that the success of a programming language or compiler depends largely on its ability to interact with third-party code. Of course, the "success" of an amateur compiler must be understood with a certain amount of conventionality and even irony. However, here, integration with external libraries written in C can become a good school of life. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
About my compiler </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XD Pascal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> there were already </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">several posts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on Habré. The compiler is written extremely simply and entirely manually, while the language has very atypical extensions - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">methods and interfaces borrowed from Go</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">To date, the base language is fully implemented, self-compilation works, the simplest optimizations are introduced. </font><font style="vertical-align: inherit;">Here a natural desire arose to establish the interaction of the compiler with some simple game library. </font><font style="vertical-align: inherit;">The choice fell on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raylib</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - but he would never have fallen on her if I had foreseen her pitfalls at once. </font><font style="vertical-align: inherit;">An innocent venture turned into a fight against challenge agreements.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devil in detail</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I liked the Raylib library because it is relatively small, actively developing, almost no external dependencies, and has a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ready-made binding for Pascal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In addition, all material arithmetic in it is of single precision. Unfortunately, this is relevant for me, because double precision has not yet appeared in my XD Pascal. ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Addition:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> double-precision arithmetic is implemented). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first, it seemed like a little was required of me - just to implement the </font></font><code>cdecl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raylib calling convention. </font></font><code>stdcall</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I already had </font><font style="vertical-align: inherit;">support </font><font style="vertical-align: inherit;">, because I had to interact with the Windows API. It only remained to learn how to clear the call stack, not inside the function, but on the calling side.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then a strange thing was discovered. </font><font style="vertical-align: inherit;">Some kind of diabolical force forced the author of Raylib to use in his API the transfer of structures into functions by value and the return of structures as a result. </font><font style="vertical-align: inherit;">It has been said more than once that this is bad practice, and to the credit of the developers of the Windows API it must be said that they avoided this in every possible way. </font><font style="vertical-align: inherit;">But not the Raylib developer. </font><font style="vertical-align: inherit;">From here many problems arose - both objective and subjective.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passing structures by value</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This problem is rather subjective, although not all. The fact is that my XD Pascal was designed from the very beginning to generate code on the fly, without explicitly constructing an abstract syntax tree (AST). In my defense, I can only say that all the early Pascal compilers were the same, including the unforgettable Turbo Pascal, and the language itself was designed by Niklaus Wirth specifically for compilation without AST. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This approach was quite acceptable until the need to interact with the code in C. The compiler without AST can put the actual parameters of the function on the stack exactly in the order in which they are listed in the source text - from left to right. However, C code with its conventions </font></font><code>cdecl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>stdcall</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expects the reverse order. </font><font style="vertical-align: inherit;">It’s not a big deal to “flip” the stack if you know in advance that all parameters are exactly the same size (for example, 4 bytes), as is the case with the Windows API. </font><font style="vertical-align: inherit;">But if structures of arbitrary size appear on the stack, the “flip” of the stack becomes much more complicated. </font><font style="vertical-align: inherit;">Now we have to put up with him; </font><font style="vertical-align: inherit;">maybe the transition to AST will one day save me from this absurdity. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, the problem of the transfer of structures has an objective side, associated, for example, with alignment. </font><font style="vertical-align: inherit;">In both Raylib and XD Pascal, all structure fields are not aligned, and structures as a whole are aligned by 4 bytes. </font><font style="vertical-align: inherit;">Here, for me, no integration difficulties have arisen, but I will not risk asserting that such an agreement is portable to other compilers and platforms.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Return structure as result</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Structure as a result of a function is already a serious and absolutely objective problem. One can only wonder how the IT industry allowed such a blatant chaos, hiding behind the directives </font></font><code>cdecl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>stdcall</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The general thing here is only the idea of ​​allocating a place in the stack of the calling party for the result of the function, and then passing the hidden parameter-pointer to the allocated place to the function. But further questions arise, to which each answers his own way. What position should the hidden parameter be in? Does it need to be abandoned if the result structure fits entirely in the register? And in two registers? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Microsoft </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tried to</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> put things in order by deciding:</font></font><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On x86 plaftorms, all arguments are widened to 32 bits when they are passed. </font><font style="vertical-align: inherit;">Return values ​​are also widened to 32 bits and returned in the EAX register, except for 8-byte structures, which are returned in the EDX: EAX register pair. </font><font style="vertical-align: inherit;">Larger structures are returned in the EAX register as pointers to hidden return structures.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This somewhat vague wording leaves the fate of structures, for example, 7 bytes long, unclear. </font><font style="vertical-align: inherit;">At the same time, the author of one </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">painfully detailed study</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> claims that the actual behavior of the Visual C ++ compiler in the absence of alignment of structures does not correspond to the documentation at all. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With industrial Pascal compilers, things are even worse. </font><font style="vertical-align: inherit;">Free Pascal (in Delphi mode) is incompatible with Delphi 6 even when transferring 8-byte structures with convention</font></font><code>cdecl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Free Pascal is trying to follow Microsoft’s prescription - in this case, it’s pretty straightforward. </font><font style="vertical-align: inherit;">Meanwhile, Delphi 6 creates a hidden pointer parameter and does not return anything useful in the EDX: EAX registers. </font><font style="vertical-align: inherit;">I followed the example of Free Pascal, since this is the version that is implemented in Raylib. </font><font style="vertical-align: inherit;">I suspect that working with Raylib from Delphi 6 is generally impossible. </font><font style="vertical-align: inherit;">I don’t know if something has changed in new versions of Delphi.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a compromise, XD Pascal implements the following logic of using </font></font><code>cdecl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>stdcall</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: structures of no more than 4 bytes are returned by value to EAX, structures of no more than 8 bytes are returned to EDX: EAX, all others through a hidden pointer parameter passed by the latter. </font><font style="vertical-align: inherit;">Fortunately, in Raylib there are no structures of 3 or 7 bytes, so the ambiguity associated with them can be bypassed for now. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ht/l1/w6/htl1w6l18w0agugzjtcjkt7qbh4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Raylib library as a whole </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">successfully docked</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with my homemade compiler. </font><font style="vertical-align: inherit;">A fly in the ointment remained the only function </font></font><code>GetTime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that returns </font></font><code>Double</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Addition:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function is now supported).</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492342/index.html">Life and work under national quarantine</a></li>
<li><a href="../en492350/index.html">IT emigration to New Zealand</a></li>
<li><a href="../en492352/index.html">Gnuplot 5.0. DIY 4-axis spiderplot</a></li>
<li><a href="../en492354/index.html">History of Speech Synthesizers: The Computer Age</a></li>
<li><a href="../en492358/index.html">Interview: NORM Lead Podcast on Media Career and Launch of Own Conversation</a></li>
<li><a href="../en492362/index.html">How to visualize and animate (geophysical) models</a></li>
<li><a href="../en492364/index.html">General Financial Analysis in Python (Part 1)</a></li>
<li><a href="../en492366/index.html">How to use JavaScript console: going beyond console.log ()</a></li>
<li><a href="../en492374/index.html">Experiment: Redux from the OOP world</a></li>
<li><a href="../en492376/index.html">How to make your article or documentation understand quickly and accurately</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>