<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚋 🍼 👨🏾‍🤝‍👨🏽 ICQ New: guide d'élevage de bots ℹ️ 💇🏾 😧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chaque fois, en entrant dans le messager, nous rencontrons des bots dans leurs manifestations les plus diverses. Certains parlent de la météo, d'autre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ICQ New: guide d'élevage de bots</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/506206/"><img src="https://habrastorage.org/webt/hz/yl/ac/hzylac6lisykfejesv6dmsxquok.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque fois, en entrant dans le messager, nous rencontrons des bots dans leurs manifestations les plus diverses. Certains parlent de la météo, d'autres jouent des hamburgers et d'autres encore jettent des mèmes d'humeur. Certes, une pensée est apparue parmi beaucoup d'entre vous: "Mais puis-je créer mon propre bot?" Malheureusement, souvent, de telles pensées sont brisées à propos d'une mauvaise compréhension de la façon de créer un bot. Probablement, pour cela, vous devez être un spécialiste informatique cool et comprendre des millions de technologies? Pas vraiment. Et aujourd'hui, nous allons essayer de montrer que la création de notre bot est un processus simple et compréhensible. Analysons le cycle complet de création d'un bot, de l'obtention des données nécessaires du messager à l'écriture de code et au lancement sur le serveur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a quelque temps, la plate-forme de bot a été fortement mise à jour dans ICQ. </font><font style="vertical-align: inherit;">Elle est devenue plus amicale, compréhensible et confortable. </font><font style="vertical-align: inherit;">En utilisant la bibliothèque Python des développeurs, nous allons créer notre premier bot.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Première chose</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, vous devez être enregistré dans ICQ. </font><font style="vertical-align: inherit;">Cela peut être fait via l'application pour un téléphone mobile, un ordinateur ou directement à partir d'un navigateur dans la version Web. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après l'enregistrement, vous pouvez commencer à créer votre propre bot dans le système:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trouver </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">métabot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur ICQ.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écrivez-lui une équipe </font></font><code>/newbot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoyez un nom pour votre nouveau bot (devrait se terminer par </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après ce métabot enverra les données de votre bot:</font></font><br>
<br>
<ul>
<li><code>botId</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: numéro de bot unique;</font></font></li>
<li><code>nick</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: nom du bot à rechercher;</font></font></li>
<li><code>token</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: le jeton utilisé pour les requêtes réseau vers le serveur.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ça y est, le bot est créé. Il peut être trouvé dans la recherche, écrivez-lui un message. Maintenant, nous devons rendre le bot actif et réagir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la page </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://icq.com/botapi/#/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> il y a une description complète des méthodes API. Ils sont utilisés pour interagir avec le serveur. Examinons certains d'entre eux plus en détail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode de base est </font></font><code>/events/get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il est utilisé pour recevoir de nouveaux événements de bot. Par exemple, si quelqu'un a écrit un bot, cet événement sera donné à l'invite </font></font><code>/events/get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Écrivons un message au bot et vérifions l'apparence de l'événement correspondant. Cela peut être fait, par exemple, dans un navigateur. Pour ce faire, accédez à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://api.icq.net/bot/v1/events/get?token=Your token &amp; pollTime = 1 &amp; lastEventId = 0</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Paramètre</font></font><code>pollTime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">responsable de la durée de conservation de la demande par le serveur. </font><font style="vertical-align: inherit;">Par exemple, si vous entrez la valeur 60, le serveur attendra les événements du bot pendant 60 secondes, et s'il n'y en a pas pendant ce temps, le serveur renverra un tableau d'événements vide. </font></font><code>lastEventId</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">responsable du dernier événement traité. </font><font style="vertical-align: inherit;">En d'autres termes, les événements avec des valeurs inférieures à celles transmises seront écrêtés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après être allé à cette adresse, quelque chose comme ça apparaîtra à l'écran:</font></font><br>
<br>
<pre><code class="json hljs">{
 <span class="hljs-attr">"events"</span>: [<font></font>
  {<font></font>
    <span class="hljs-attr">"eventId"</span>: <span class="hljs-number">41</span>,
     <span class="hljs-attr">"payload"</span>: {
         <span class="hljs-attr">"chat"</span>: {
           <span class="hljs-attr">"chatId"</span>: <span class="hljs-string">"745294945"</span>,
            <span class="hljs-attr">"type"</span>: <span class="hljs-string">"private"</span><font></font>
         },<font></font>
         <span class="hljs-attr">"from"</span>: {
                <span class="hljs-attr">"firstName"</span>: <span class="hljs-string">"Andrey"</span>,
                <span class="hljs-attr">"lastName"</span>: <span class="hljs-string">"Shvedov"</span>,
                <span class="hljs-attr">"nick"</span>: <span class="hljs-string">"shvedoff"</span>,
                <span class="hljs-attr">"userId"</span>: <span class="hljs-string">"745294945"</span><font></font>
         },<font></font>
         <span class="hljs-attr">"msgId"</span>: <span class="hljs-string">"6831171945581511151"</span>,
         <span class="hljs-attr">"text"</span>: <span class="hljs-string">""</span>,
         <span class="hljs-attr">"timestamp"</span>: <span class="hljs-number">1590506161</span><font></font>
     },<font></font>
     <span class="hljs-attr">"type"</span>: <span class="hljs-string">"newMessage"</span><font></font>
  }<font></font>
 ],<font></font>
 <span class="hljs-attr">"ok"</span>: <span class="hljs-literal">true</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la même manière, vous pouvez envoyer un message au nom du bot en utilisant la méthode </font></font><code>/messages/sendText</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous n'avons pas besoin d'étudier ces méthodes plus en détail, nous avons une bibliothèque Python prête à l'emploi qui nous permet d'écrire notre bot sans entrer dans les détails.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écrire un code?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oui, mais nous devons d'abord préparer notre propre ordinateur pour cela. </font><font style="vertical-align: inherit;">Nous utiliserons Python dans la troisième version (téléchargez la version pour votre système d'exploitation ici: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.python.org/downloads/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et le gestionnaire de packages pip ici: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://pip.pypa.io/en/stable/installing/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) vous devez installer la bibliothèque pour travailler avec les bots:</font></font><br>
<br>
<pre><code class="bash hljs">$ pip3 install --upgrade mailru-im-bot
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez maintenant continuer.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous écrivons!</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À titre d'exemple, nous écrirons un robot de jeu qui testera la connaissance des mathématiques simples. Il fonctionnera comme ceci: une personne écrit un message à un bot, elle se présente et propose de jouer. Une fois que l'utilisateur est d'accord, le bot génère un exemple mathématique simple et 4 options à choisir. Lorsque l'utilisateur clique sur le bouton avec la réponse sélectionnée, le bot répond, à tort ou à raison. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le bot doit d'abord recevoir des événements du serveur. Pour ce faire, en plus d'importer toutes les bibliothèques, nous devons créer un objet de classe </font></font><code>Bot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et commencer à recevoir des mises à jour:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> bot.bot <span class="hljs-keyword">import</span> Bot<font></font>
<font></font>
<font></font>
logging.basicConfig(format=<span class="hljs-string">'%(asctime)s %(levelname)s %(message)s'</span>,<font></font>
                    datefmt=<span class="hljs-string">'%Y.%m.%d %I:%M:%S %p'</span>, level=logging.DEBUG)<font></font>
<font></font>
TOKEN = <span class="hljs-string">""</span> <span class="hljs-comment">#your token here</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    bot = Bot(token=TOKEN)<font></font>
    bot.start_polling()<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous importons la bibliothèque de journalisation et l'exécutons. </font><font style="vertical-align: inherit;">Nous importons également la bibliothèque pour les bots ICQ, définissons le paramètre nécessaire </font></font><code>token</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, créons un objet de classe </font></font><code>Bot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et commençons à recevoir des mises à jour du serveur ( </font></font><code>bot.start_polling()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, notre bot peut recevoir des événements, mais ne peut pas les traiter. </font><font style="vertical-align: inherit;">Nous complétons le bot pour qu'il puisse répondre aux messages. </font><font style="vertical-align: inherit;">Pour ce faire, ajoutez les importations nécessaires:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> bot.handler <span class="hljs-keyword">import</span> MessageHandler
</code></pre><br>
<code>json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nécessaire pour formater la partie du message responsable des boutons. </font></font><code>MessageHandler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nécessaire pour ajouter de nouveaux messages au code du gestionnaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous avons besoin d'une fonction qui composera un message pour la réponse:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span>(<span class="hljs-params">bot, event</span>):</span><font></font>
    default_markup = [<font></font>
        [{<span class="hljs-string">"text"</span>: <span class="hljs-string">"!"</span>, <span class="hljs-string">"callbackData"</span>: <span class="hljs-string">"start"</span>}]<font></font>
        ]<font></font>
<font></font>
    first_message_text = <span class="hljs-string">"!  -  . ?"</span><font></font>
    bot.send_text(chat_id=event.from_chat,<font></font>
         text=first_message_text,<font></font>
         inline_keyboard_markup=json.dumps(default_markup))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reçoit l'entrée du bot créé et l'événement d'un nouveau message. </font></font><code>default_markup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- une matrice de boutons (un objet "liste" constitué d'un tableau de chaînes de boutons. Dans notre cas, c'est le seul bouton </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Démarrer!</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><code>first_message_text</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- une chaîne dont le texte sera envoyé à l'utilisateur. </font><font style="vertical-align: inherit;">La méthode </font></font><code>send_text</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accepte:</font></font><br>
<br>
<ul>
<li><code>chat_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (champ de l'événement en cours de traitement) - identifiant du chat d'où le message a été reçu, </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">texte du message à envoyer </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>inline_keyboard_markup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- nos boutons.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reste maintenant à décrire l'appel à cette fonction lorsqu'un message est reçu. </font><font style="vertical-align: inherit;">Pour cela, la bibliothèque a un design spécial:</font></font><br>
<br>
<pre><code class="python hljs">bot.dispatcher.add_handler(MessageHandler(callback=startup))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il vous permet d'appeler automatiquement une fonction </font></font><code>startup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec les paramètres nécessaires </font><font style="vertical-align: inherit;">lorsque vous recevez un nouveau message </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ce gestionnaire doit être placé dans la fonction </font></font><code>main()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nous avons un tel code qui vous permet d'envoyer un message de démarrage lorsque le bot reçoit un message:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> bot.bot <span class="hljs-keyword">import</span> Bot
<span class="hljs-keyword">from</span> bot.handler <span class="hljs-keyword">import</span> MessageHandler<font></font>
<font></font>
logging.basicConfig(format=<span class="hljs-string">'%(asctime)s %(levelname)s %(message)s'</span>,<font></font>
                    datefmt=<span class="hljs-string">'%Y.%m.%d %I:%M:%S %p'</span>, level=logging.DEBUG)<font></font>
<font></font>
TOKEN = «» <span class="hljs-comment">#your token here</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span>(<span class="hljs-params">bot, event</span>):</span><font></font>
    default_markup = [<font></font>
        [{«text»: «!», «callbackData»: «start»}]<font></font>
        ]<font></font>
    first_message_text = «!  —  . ?»<font></font>
    bot.send_text(chat_id=event.from_chat,<font></font>
        text=first_message_text,<font></font>
        inline_keyboard_markup=json.dumps(default_markup))<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    bot = Bot(token=TOKEN)<font></font>
    bot.dispatcher.add_handler(MessageHandler(callback=startup))<font></font>
    bot.start_polling()<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'utilisateur, cela ressemblera à ceci:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6a4/a51/4b4/6a4a514b4e5629c69a6cb9a1f187de4b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considérez plus en détail le bouton que nous avons envoyé dans le message:</font></font><br>
<br>
<pre><code class="python hljs">[ [{«text»: «!», «callbackData»: «start»}]]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus du texte écrit sur le bouton, le message a un champ </font></font><code>callbackData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Lorsqu'un bouton est cliqué, le serveur génère un événement de clic de bouton. </font><font style="vertical-align: inherit;">Il y passe ce champ comme identifiant du bouton pressé. </font><font style="vertical-align: inherit;">C'est-à-dire, par cette ligne reçue du serveur, nous pouvons juger sur quel bouton l'utilisateur a cliqué. </font><font style="vertical-align: inherit;">Ainsi, nous devons en outre ajouter la logique de traitement des clics sur les boutons au bot. </font><font style="vertical-align: inherit;">Pour ce faire, nous devrons à nouveau importer les méthodes nécessaires:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> bot.handler <span class="hljs-keyword">import</span> BotButtonCommandHandler
<span class="hljs-keyword">from</span> bot.filter <span class="hljs-keyword">import</span> Filter
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première ligne est le gestionnaire d'événements pour cliquer sur un bouton, la seconde est un filtre pour vous aider à comprendre quel bouton est enfoncé. </font><font style="vertical-align: inherit;">Nous devons également décrire la logique de la réponse aux clics sur les boutons:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">bot, event</span>):</span>
    question = <span class="hljs-string">''</span>
    operands = [<span class="hljs-string">"+"</span>, <span class="hljs-string">"-"</span>, <span class="hljs-string">"*"</span>]<font></font>
    operations_count = randrange(<span class="hljs-number">3</span>)+<span class="hljs-number">2</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(operations_count):<font></font>
        question += str(randrange(<span class="hljs-number">9</span>))<font></font>
        question += choice(operands)<font></font>
    question = question[:<span class="hljs-number">-1</span>]<font></font>
    answer = eval(question)<font></font>
    buttons = [<font></font>
        [{<span class="hljs-string">'text'</span>: str(answer), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"right"</span>},<font></font>
         {<span class="hljs-string">'text'</span>: str(answer+<span class="hljs-number">1</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>}],<font></font>
        [{<span class="hljs-string">'text'</span>: str(answer<span class="hljs-number">-1</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>},<font></font>
         {<span class="hljs-string">'text'</span>: str(answer+<span class="hljs-number">2</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>}]]<font></font>
    shuffle(buttons[<span class="hljs-number">0</span>])<font></font>
    shuffle(buttons[<span class="hljs-number">1</span>])<font></font>
    shuffle(buttons)<font></font>
    bot.answer_callback_query(<font></font>
        query_id=event.data[<span class="hljs-string">'queryId'</span>],<font></font>
        text=<span class="hljs-string">' '</span>)<font></font>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=question,<font></font>
        inline_keyboard_markup=json.dumps(buttons))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par analogie avec les messages, une fonction accepte les mêmes arguments en entrée. </font><font style="vertical-align: inherit;">Ensuite, un exemple et un tableau de boutons avec des réponses sont générés. </font><font style="vertical-align: inherit;">L'une des réponses sera correcte. </font><font style="vertical-align: inherit;">Sur cette base, les réponses seront différentes </font></font><code>callbackData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En fin de compte, vous devez certainement appeler la méthode </font></font><code>answer_callback_query</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec des paramètres:</font></font><br>
<br>
<ul>
<li><code>query_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - numéro unique de l'événement d'appuyer sur le bouton</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>text</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le texte qui sera affiché dans l'info-bulle lorsque vous cliquerez sur le bouton.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En appelant cette méthode, nous montrerons à l'utilisateur que le bot a accepté le clic d'un bouton. </font><font style="vertical-align: inherit;">Sinon, l'indicateur de téléchargement apparaîtra sur le bouton pendant un certain temps. </font><font style="vertical-align: inherit;">En utilisant la méthode, </font></font><code>send_text</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous devez envoyer le message lui-même avec des boutons de questions et réponses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutons immédiatement des fonctions pour traiter les réponses correctes et incorrectes:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">right</span>(<span class="hljs-params">bot, event</span>):</span>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=<span class="hljs-string">'!'</span>)<font></font>
    start(bot, event)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrong</span>(<span class="hljs-params">bot, event</span>):</span>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=<span class="hljs-string">':('</span>)<font></font>
    start(bot, event)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces fonctions seront appelées lorsque vous cliquez sur les réponses correctes et incorrectes. </font><font style="vertical-align: inherit;">Et après le message avec la bonne réponse, l'utilisateur recevra une nouvelle question. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne reste plus qu'à ajouter des gestionnaires de clic de bouton:</font></font><br>
<br>
<pre><code class="python hljs">    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=start, filters=Filter.callback_data(«start»)))<font></font>
    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=wrong, filters=Filter.callback_data(«wrong»)))<font></font>
    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=right, filters=Filter.callback_data(«right»)))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chacun de ces trois gestionnaires contient un filtre par </font></font><code>callbackData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(par exemple, </font></font><code>filters=Filter.callback_data(«start»)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) et une fonction à appeler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ceci termine la programmation du bot. </font><font style="vertical-align: inherit;">Le code résultant ressemble à ceci:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> bot.bot <span class="hljs-keyword">import</span> Bot
<span class="hljs-keyword">from</span> bot.handler <span class="hljs-keyword">import</span> BotButtonCommandHandler
<span class="hljs-keyword">from</span> bot.handler <span class="hljs-keyword">import</span> MessageHandler
<span class="hljs-keyword">from</span> bot.filter <span class="hljs-keyword">import</span> Filter
<span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> randrange, choice, random, shuffle<font></font>
<font></font>
logging.basicConfig(format=<span class="hljs-string">'%(asctime)s %(levelname)s %(message)s'</span>,<font></font>
        datefmt=<span class="hljs-string">'%Y.%m.%d %I:%M:%S %p'</span>, level=logging.DEBUG)<font></font>
<font></font>
TOKEN = <span class="hljs-string">""</span> <span class="hljs-comment">#your token here</span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span>(<span class="hljs-params">bot, event</span>):</span><font></font>
    default_markup = [<font></font>
        [{<span class="hljs-string">"text"</span>: <span class="hljs-string">"!"</span>, <span class="hljs-string">"callbackData"</span>: <span class="hljs-string">"start"</span>}]<font></font>
        ]<font></font>
<font></font>
    first_message_text = <span class="hljs-string">"!  -  . ?"</span><font></font>
    bot.send_text(chat_id=event.from_chat,<font></font>
        text=first_message_text,<font></font>
        inline_keyboard_markup=json.dumps(default_markup))<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">bot, event</span>):</span>
    question = <span class="hljs-string">''</span>
    operands = [<span class="hljs-string">"+"</span>, <span class="hljs-string">"-"</span>, <span class="hljs-string">"*"</span>]<font></font>
    operations_count = randrange(<span class="hljs-number">3</span>)+<span class="hljs-number">2</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(operations_count):<font></font>
        question += str(randrange(<span class="hljs-number">9</span>))<font></font>
        question += choice(operands)<font></font>
    question = question[:<span class="hljs-number">-1</span>]<font></font>
    answer = eval(question)<font></font>
    buttons = [<font></font>
        [{<span class="hljs-string">'text'</span>: str(answer), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"right"</span>},<font></font>
         {<span class="hljs-string">'text'</span>: str(answer+<span class="hljs-number">1</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>}],<font></font>
        [{<span class="hljs-string">'text'</span>: str(answer<span class="hljs-number">-1</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>},<font></font>
         {<span class="hljs-string">'text'</span>: str(answer+<span class="hljs-number">2</span>), <span class="hljs-string">'callbackData'</span>: <span class="hljs-string">"wrong"</span>}]]<font></font>
    shuffle(buttons[<span class="hljs-number">0</span>])<font></font>
    shuffle(buttons[<span class="hljs-number">1</span>])<font></font>
    shuffle(buttons)<font></font>
    bot.answer_callback_query(<font></font>
        query_id=event.data[<span class="hljs-string">'queryId'</span>],<font></font>
        text=<span class="hljs-string">' '</span>)<font></font>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=question,<font></font>
        inline_keyboard_markup=json.dumps(buttons))<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">right</span>(<span class="hljs-params">bot, event</span>):</span>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=<span class="hljs-string">'!'</span>)<font></font>
    start(bot, event)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">wrong</span>(<span class="hljs-params">bot, event</span>):</span>
    bot.send_text(chat_id=event.data[<span class="hljs-string">'message'</span>][<span class="hljs-string">'chat'</span>][<span class="hljs-string">'chatId'</span>],<font></font>
        text=<span class="hljs-string">':('</span>)<font></font>
    start(bot, event)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    bot = Bot(token=TOKEN)<font></font>
    bot.dispatcher.add_handler(MessageHandler(callback=startup))<font></font>
    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=start, filters=Filter.callback_data(<span class="hljs-string">"start"</span>)))<font></font>
    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=wrong, filters=Filter.callback_data(<span class="hljs-string">"wrong"</span>)))<font></font>
    bot.dispatcher.add_handler(BotButtonCommandHandler(<font></font>
        callback=right, filters=Filter.callback_data(<span class="hljs-string">"right"</span>)))<font></font>
    bot.start_polling()<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je note qu'il contient les importations nécessaires à la fonction pour générer la question. </font><font style="vertical-align: inherit;">Au lieu de cela et d'autres fonctions, vous pouvez écrire une sorte de votre propre logique :)</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Où et comment courir?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est plus pratique de lancer un bot sur un serveur distant. </font><font style="vertical-align: inherit;">Il existe de nombreux services qui offrent des serveurs virtuels avec un accès suffisant pour installer des programmes. </font><font style="vertical-align: inherit;">Certains services offrent une période d'essai gratuite. </font><font style="vertical-align: inherit;">Puisque nous sommes Mail.ru, nous l'analyserons à l'aide de l'exemple de Mail.ru Cloud Solutions. </font><font style="vertical-align: inherit;">Il y a un processus d'inscription simple, un accès rapide à votre serveur, ainsi qu'une période d'essai gratuite sans carte bancaire ou autres difficultés.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous enregistrons un compte sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://mcs.mail.ru/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créez une instance d'une machine virtuelle. </font><font style="vertical-align: inherit;">Tous les paramètres restent inchangés, ils suffisent.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le service vous proposera de télécharger la clé d'accès. </font><font style="vertical-align: inherit;">Télécharger.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maintenant, nous allons à notre machine virtuelle: </font></font><code>ssh -i ./xxx.pem user@ip</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
où </font></font><code>./xxx.pem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est le chemin d'accès à la clé téléchargée.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Après cela, nous devons installer les programmes et packages nécessaires:</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo curl https://raw.githubusercontent.com/dvershinin/apt-get-centos/master/apt-get.sh -o /usr/<span class="hljs-built_in">local</span>/bin/apt-get<font></font>
$ chmod 0755 /usr/<span class="hljs-built_in">local</span>/bin/apt-get<font></font>
$ sudo apt-get install python3<font></font>
$ curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py<font></font>
$ python3 get-pip.py<font></font>
$ pip3 install --upgrade mailru-im-bot</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous avons installé Python et toutes les bibliothèques nécessaires pour que notre bot fonctionne. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il reste à copier le bot sur le serveur et à l'exécuter. </font><font style="vertical-align: inherit;">Dans le dossier contenant le script, exécutez:</font></font><code>scp -i ./xxx.pem ./path/to_bot.py user@ip:~</code><br>
<br>
<ul>
<li><code>./xxx.pem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - chemin d'accès à la clé;</font></font></li>
<li><code>./path/to_bot.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - chemin vers le fichier avec le bot;</font></font></li>
<li><code>user@ip:~</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - identifiant, adresse et chemin où copier le bot.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après cela, le fichier avec le bot sera dans le répertoire personnel du serveur distant. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous retournons sur le serveur et exécutons :, </font></font><code>python3 ~/file_name.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">où </font></font><code>file_name.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est le nom de notre fichier avec le bot.</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et après?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, nous avons eu un bot autonome travaillant sur notre serveur personnel. </font><font style="vertical-align: inherit;">Si vous souhaitez développer davantage la création de bots pour ICQ, étudiez la documentation sur les bots API plus en détail et compliquez la logique interne de votre bot. </font><font style="vertical-align: inherit;">Et ICQ dispose également d'un chat dans lequel vous pouvez poser des questions sur les robots: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://icq.im/botapi_faq</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liens utiles</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://icq.com/botapi/#/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - API de bot ICQ. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/mail-ru-im/bot-python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Bibliothèque Python pour les bots ICQ. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://icq.im/metabot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - récupérez le jeton et modifiez le bot. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/shvedoff/Icq_buttons</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - un bot qui effectue toutes les actions possibles avec des boutons. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://icq.im/AoLE1J5Ecm5DIjZh1gg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - chat pour des questions sur les bots.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr506180/index.html">Comment choisir la bonne alimentation pour votre UPS. Nous analysons l'exemple d'Eaton</a></li>
<li><a href="../fr506188/index.html">Analyseur de grammaire personnalisé de 400 lignes</a></li>
<li><a href="../fr506190/index.html">Comment soustraire une série d'intervalles de temps et essayer l'algorithme de Bentley-Ottmann</a></li>
<li><a href="../fr506196/index.html">Comment nous avons piraté une usine intelligente</a></li>
<li><a href="../fr506204/index.html">Type de données abstrait. Partie 2: Gestion des données</a></li>
<li><a href="../fr506218/index.html">Le mégaphone continue d'interférer avec mon trafic HTTP en 2020, d'envoyer des annonces, même après avoir reçu des interdictions</a></li>
<li><a href="../fr506222/index.html">Listes de contrôle: essayez de ne pas manquer les détails</a></li>
<li><a href="../fr506228/index.html">AdonisJS 5 - Framework de type Laravel sur nodeJS et avec Typescript digne de votre attention</a></li>
<li><a href="../fr506230/index.html">Des spots qui m'ont surpris. Test et revue de Gauss QPlus</a></li>
<li><a href="../fr506238/index.html">Coloscopie Sur un sujet délicat sans ridicule</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>