<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🎤 🕍 💂🏼 Guía de desarrollo del servicio backend de Python 🚵 ⚱️ 🎺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola, mi nombre es Alexander Vasin, soy desarrollador de backend en Edadil. La idea de este material comenzó con el hecho de que quería analizar la ta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Guía de desarrollo del servicio backend de Python</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/499534/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola, mi nombre es Alexander Vasin, soy desarrollador de backend en Edadil. La idea de este material comenzó con el hecho de que quería analizar la tarea introductoria ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya.Disk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) en la Yandex </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Backend Development</font></a><font style="vertical-align: inherit;"> School. Comencé a describir todas las sutilezas de la elección de ciertas tecnologías, la metodología de prueba ... Resultó no ser un análisis en absoluto, sino una guía muy detallada sobre cómo escribir backends en Python. Desde la idea inicial solo había requisitos para el servicio, en cuyo ejemplo es conveniente desmontar herramientas y tecnologías. Como resultado, me desperté con cien mil personajes. Se requería exactamente tanto para considerar todo con gran detalle. Entonces, el programa para los próximos 100 kilobytes: cómo construir un backend de servicio, desde la elección de herramientas hasta la implementación. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pm/sz/r2/pmszr288srjaplio0w_utpnb4ym.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TL; DR:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aquí hay </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un representante de GitHub con aplicación</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y quién ama los hilos largos (reales) - por favor, bajo cat.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desarrollaremos y probaremos el servicio API REST en Python, lo empacaremos en un contenedor Docker liviano y lo implementaremos usando Ansible.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede implementar el servicio REST API de diferentes maneras utilizando diferentes herramientas. </font><font style="vertical-align: inherit;">La solución descrita no es la única correcta, elegí la implementación y las herramientas basadas en mi experiencia personal y preferencias.</font></font></blockquote><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qué hacemos?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué herramientas elegir?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desarrollo</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Por qué necesitas comenzar con setup.py?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo especificar versiones de dependencia?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de datos</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diseñamos el esquema</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Describir el esquema en SQLAlchemy.</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personalizar alambique</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generamos migraciones</font></font></a></li>
</ul></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicitud</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serialización de datos</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipuladores</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importaciones</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / ciudadanos</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PARCHE / importaciones / $ import_id / ciudadanos / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importaciones / $ import_id / ciudadanos / cumpleaños</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentil / age</font></font></a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pruebas</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipuladores</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / ciudadanos</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importaciones</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PARCHE / importaciones / $ import_id / ciudadanos / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importaciones / $ import_id / ciudadanos / cumpleaños</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentil / age</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migraciones</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montaje</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desplegar</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pruebas de estrés</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qué más se puede hacer?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente</font></font></a></li>
</ul><br>
<a name="task"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qué hacemos?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine que una tienda de regalos en línea planea lanzar una acción en diferentes regiones. </font><font style="vertical-align: inherit;">Para que una estrategia de ventas sea efectiva, se necesita un análisis de mercado. </font><font style="vertical-align: inherit;">La tienda tiene un proveedor que envía regularmente (por ejemplo, por correo) la descarga de datos con información sobre los residentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desarrollemos un servicio API REST de Python que analizará los datos proporcionados e identificará la demanda de obsequios de residentes de diferentes grupos de edad en diferentes ciudades por mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implementamos los siguientes controladores en el servicio:</font></font><br>
<br>
<ul>
<li> <code>POST /imports</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agrega una nueva carga con datos;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Devuelve a los residentes de la descarga especificada;</font></font><br>
 </li>
<li> <code>PATCH /imports/$import_id/citizens/$citizen_id</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cambia la información sobre el residente (y sus familiares) en la descarga especificada;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens/birthdays</code><br>
  ,        ( ),   ;<br>
 </li>
<li> <code>GET /imports/$import_id/towns/stat/percentile/age</code><br>
 50-, 75-  99-   ( )      .<br>
 </li>
</ul><br>
<a name="tools"></a><h1>  ?</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, estamos escribiendo un servicio en Python usando marcos familiares, bibliotecas y DBMS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 conferencias del</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> video curso, se describen varios DBMS y sus características. Para mi implementación, elegí el DBMS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que se ha establecido como una solución confiable con excelente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentación en ruso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , una fuerte comunidad rusa (siempre puede encontrar la respuesta a una pregunta en ruso) e incluso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursos gratuitos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . El modelo relacional es bastante versátil y bien entendido por muchos desarrolladores. Aunque se podría hacer lo mismo en cualquier DBMS NoSQL, en este artículo consideraremos PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El objetivo principal del servicio, la transmisión de datos a través de la red entre la base de datos y los clientes, no implica una gran carga en el procesador, sino que requiere la capacidad de procesar múltiples solicitudes al mismo tiempo. En </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 conferencias</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> consideró enfoque asincrónico. Le permite servir de manera eficiente a varios clientes dentro del mismo proceso del sistema operativo (a diferencia, por ejemplo, del modelo previo a la bifurcación utilizado en Flask / Django, que crea varios procesos para procesar las solicitudes de los usuarios, cada uno de ellos consume memoria, pero está inactivo la mayor parte del tiempo ) Por lo tanto, como biblioteca para escribir el servicio, elegí el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> asíncrono </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
La </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">quinta conferencia del</font></a><font style="vertical-align: inherit;"> video curso dice que </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">SQLAlchemy</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/or/rj/pn/orrjpnx6upvsipcqbsql7f36vzc.png"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le permite descomponer consultas complejas en partes, reutilizarlas, generar consultas con un conjunto dinámico de campos (por ejemplo, el procesador PATCH permite la actualización parcial de un residente con campos arbitrarios) y centrarse directamente en la lógica empresarial. El controlador </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpg puede</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manejar estas solicitudes y transferir los datos más rápido </font><font style="vertical-align: inherit;">, y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpgsa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> los ayudará a hacer amigos </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mi herramienta favorita para administrar el estado de la base de datos y trabajar con migraciones es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por cierto, recientemente hablé sobre eso en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moscow Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La lógica de validación fue descrita sucintamente por los esquemas de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Marshmallow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (incluidas las comprobaciones de los lazos familiares). Usando el módulo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://github.com/maximdanilchenko/aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp-spec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vinculaba aiohttp-handlers y esquemas para la validación de datos, y la ventaja era generar documentación en formato </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swagger</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y mostrarla en una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interfaz gráfica</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para escribir pruebas, elegí </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, más sobre esto en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 conferencias</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para depurar y perfilar este proyecto, utilicé el depurador PyCharm ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clase 9</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conferencia 7 se</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> describe cómo cualquier computadora </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (o incluso en un sistema operativo diferente) puede ejecutarse empaquetado sin tener que ajustar el entorno de la aplicación para iniciar y fácil de instalar / actualizar / eliminar la aplicación en el servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para la implementación, elegí </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansible</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le permite describir declarativamente el estado deseado del servidor y sus servicios, funciona a través de ssh y no requiere un software especial.</font></font><br>
<br>
<a name="development"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desarrollo</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidí darle un nombre al paquete Python </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y usar la siguiente estructura: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ox/ly/wt/oxlywtje20xt5ceou8pbtfp8an8.png" width="550"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
en el archivo </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">publiqué</font></a></font><code>analyzer/__init__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> información general sobre el paquete: descripción ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cadena de documentación</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), versión, licencia, contactos de desarrollador.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se puede ver con la ayuda incorporada</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python<font></font>
&gt;&gt;&gt; import analyzer<font></font>
&gt;&gt;&gt; <span class="hljs-built_in">help</span>(analyzer)<font></font>
<font></font>
Help on package analyzer:<font></font>
<font></font>
NAME<font></font>
    analyzer<font></font>
<font></font>
DESCRIPTION<font></font>
      REST API,    .<font></font>
<font></font>
PACKAGE CONTENTS<font></font>
    api (package)<font></font>
    db (package)<font></font>
    utils (package)<font></font>
<font></font>
DATA<font></font>
    __all__ = (<span class="hljs-string">'__author__'</span>, <span class="hljs-string">'__email__'</span>, <span class="hljs-string">'__license__'</span>, <span class="hljs-string">'__maintainer__'</span>,...<font></font>
    __email__ = <span class="hljs-string">'alvassin@yandex.ru'</span>
    __license__ = <span class="hljs-string">'MIT'</span>
    __maintainer__ = <span class="hljs-string">'Alexander Vasin'</span><font></font>
<font></font>
VERSION<font></font>
    0.0.1<font></font>
<font></font>
AUTHOR<font></font>
    Alexander Vasin<font></font>
<font></font>
FILE<font></font>
    /Users/alvassin/Work/backendschool2019/analyzer/__init__.py</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El paquete tiene dos puntos de entrada: el servicio REST API ( </font></font><code>analyzer/api/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) y la utilidad de administración de estado de la base de datos ( </font></font><code>analyzer/db/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Los archivos se llaman </font></font><code>__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por una razón: en primer lugar, dicho nombre llama la atención, deja en claro que el archivo es un punto de entrada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En segundo lugar, gracias a este enfoque de los puntos de entrada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>     python -m</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># REST API</span>
$ python -m analyzer.api --<span class="hljs-built_in">help</span><font></font>
<font></font>
<span class="hljs-comment">#    </span>
$ python -m analyzer.db --<span class="hljs-built_in">help</span></code></pre><br>
<a name="setuppy"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Por qué necesitas comenzar con setup.py?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mirando hacia el futuro, pensaremos en cómo distribuir la aplicación: puede empaquetarse en un archivo zip (así como en wheel / egg-), un paquete rpm, un archivo pkg para macOS e instalarse en una computadora remota, una máquina virtual, MacBook o Docker- envase. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El objetivo principal del archivo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>setup.py</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es describir el paquete con la aplicación </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
El archivo debe contener información general sobre el paquete (nombre, versión, autor, etc.), pero también puede especificar los módulos necesarios para el trabajo, dependencias "adicionales" (por ejemplo, para pruebas), puntos de entrada (por ejemplo, comandos ejecutables ) y requisitos para el intérprete. </font><font style="vertical-align: inherit;">
Los complementos de Setuptools le permiten recopilar artefactos del paquete descrito. Hay complementos integrados: zip, egg, rpm, macOS pkg. Los complementos restantes se distribuyen a través de PyPI: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">rueda</font></a><font style="vertical-align: inherit;"> ,</font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">distutils</a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">setuptools</a></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la línea inferior, describiendo un archivo, tenemos grandes oportunidades. </font><font style="vertical-align: inherit;">Es por eso que el desarrollo de un nuevo proyecto debe comenzar con </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la función, </font></font><code>setup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">los módulos dependientes se indican mediante una lista:</font></font><br>
<br>
<pre><code class="python hljs">setup(..., install_requires=[<span class="hljs-string">"aiohttp"</span>, <span class="hljs-string">"SQLAlchemy"</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero describí las dependencias en archivos separados </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuyos contenidos se utilizan </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Me parece más flexible, además hay un secreto: más adelante te permitirá construir una imagen Docker más rápido. </font><font style="vertical-align: inherit;">Las dependencias se establecerán como un paso separado antes de instalar la aplicación en sí, y al reconstruir el contenedor Docker, está en la memoria caché. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">poder leer las dependencias de los archivos </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la función está escrita:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vale la pena señalar que </font></font><code>setuptools</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuando la distribución de la fuente por defecto de montaje incluye sólo los archivos de ensamblaje </font></font><code>.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.cpp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Para un archivo de dependencia </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">golpear la bolsa, deben especificarse claramente en el archivo </font></font><code>MANIFEST.in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setup.py por completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> importlib.machinery <span class="hljs-keyword">import</span> SourceFileLoader<font></font>
<font></font>
<span class="hljs-keyword">from</span> pkg_resources <span class="hljs-keyword">import</span> parse_requirements
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> find_packages, setup<font></font>
<font></font>
module_name = <span class="hljs-string">'analyzer'</span><font></font>
<font></font>
<span class="hljs-comment"># ,     (   ), </span>
<span class="hljs-comment">#   __init__.py   machinery.</span><font></font>
module = SourceFileLoader(<font></font>
    module_name, os.path.join(module_name, <span class="hljs-string">'__init__.py'</span>)<font></font>
).load_module()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements<font></font>
<font></font>
setup(<font></font>
    name=module_name,<font></font>
    version=module.__version__,<font></font>
    author=module.__author__,<font></font>
    author_email=module.__email__,<font></font>
    license=module.__license__,<font></font>
    description=module.__doc__,<font></font>
    long_description=open(<span class="hljs-string">'README.rst'</span>).read(),<font></font>
    url=<span class="hljs-string">'https://github.com/alvassin/backendschool2019'</span>,<font></font>
    platforms=<span class="hljs-string">'all'</span>,<font></font>
    classifiers=[<font></font>
        <span class="hljs-string">'Intended Audience :: Developers'</span>,
        <span class="hljs-string">'Natural Language :: Russian'</span>,
        <span class="hljs-string">'Operating System :: MacOS'</span>,
        <span class="hljs-string">'Operating System :: POSIX'</span>,
        <span class="hljs-string">'Programming Language :: Python'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.8'</span>,
        <span class="hljs-string">'Programming Language :: Python :: Implementation :: CPython'</span><font></font>
    ],<font></font>
    python_requires=<span class="hljs-string">'&gt;=3.8'</span>,<font></font>
    packages=find_packages(exclude=[<span class="hljs-string">'tests'</span>]),<font></font>
    install_requires=load_requirements(<span class="hljs-string">'requirements.txt'</span>),<font></font>
    extras_require={<span class="hljs-string">'dev'</span>: load_requirements(<span class="hljs-string">'requirements.dev.txt'</span>)},<font></font>
    entry_points={<font></font>
        <span class="hljs-string">'console_scripts'</span>: [
            <span class="hljs-comment"># f-strings  setup.py   - </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-comment">#   ,     Python 3.8, </span>
            <span class="hljs-comment"># source distribution       </span>
            <span class="hljs-comment">#   Python.     </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-string">'{0}-api = {0}.api.__main__:main'</span>.format(module_name),
            <span class="hljs-string">'{0}-db = {0}.db.__main__:main'</span>.format(module_name)<font></font>
        ]<font></font>
    },<font></font>
    include_package_data=<span class="hljs-literal">True</span>
)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede instalar un proyecto en modo de desarrollo utilizando el siguiente comando (en modo editable, Python no instalará el paquete completo en una carpeta </font></font><code>site-packages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sino que solo creará enlaces, por lo que cualquier cambio realizado en los archivos del paquete será visible de inmediato):</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#      extra- "dev"</span>
pip install -e <span class="hljs-string">'.[dev]'</span><font></font>
<font></font>
<span class="hljs-comment">#      </span>
pip install -e .</code></pre><br>
<a name="requirements"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo especificar versiones de dependencia?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es genial cuando los desarrolladores trabajan activamente en sus paquetes: los errores se corrigen activamente en ellos, aparece una nueva funcionalidad y se pueden obtener comentarios más rápidamente. Pero a veces los cambios en las bibliotecas dependientes no son compatibles con versiones anteriores y pueden provocar errores en su aplicación si no lo piensa de antemano. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cada paquete dependiente, puede especificar una versión específica, por ejemplo </font></font><code>aiohttp==3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Luego, se garantizará que la aplicación se construirá específicamente con esas versiones de las bibliotecas dependientes con las que se probó. Pero este enfoque tiene un inconveniente: si los desarrolladores corrigen un error crítico en un paquete dependiente que no afecta la compatibilidad con versiones anteriores, esta solución no entrará en la aplicación. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay un enfoque para el versionado de versiones </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semánticas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que sugiere enviar la versión en el formato </font></font><code>MAJOR.MINOR.PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - aumenta cuando se agregan cambios incompatibles hacia atrás;</font></font></li>
<li><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Aumenta cuando se agrega nueva funcionalidad con soporte para compatibilidad con versiones anteriores;</font></font></li>
<li><code>PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - aumenta al agregar correcciones de errores con soporte de compatibilidad con versiones anteriores.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si un paquete dependiente sigue este enfoque (de los cuales los autores se presentan por lo general en los archivos README y los Cambios), es suficiente para fijar el valor de </font></font><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y para limitar el valor mínimo para el parche versión: </font></font><code>&gt;= MAJOR.MINOR.PATCH, == MAJOR.MINOR.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tal requisito se puede implementar utilizando el operador </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ =</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por ejemplo, </font></font><code>aiohttp~=3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permitirá que PIP se instale para la </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versión 3.6.3, pero no 3.7. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si especifica el intervalo de versiones de dependencia, esto le dará una ventaja más: no habrá conflictos de versión entre las bibliotecas dependientes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si está desarrollando una biblioteca que requiere un paquete de dependencia diferente, no permita una versión específica, sino un intervalo. </font><font style="vertical-align: inherit;">Entonces será mucho más fácil para los usuarios de su biblioteca usarlo (de repente, su aplicación requiere el mismo paquete de dependencia, pero de una versión diferente). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El control de versiones semántico es solo un acuerdo entre autores y consumidores de paquetes. </font><font style="vertical-align: inherit;">No garantiza que los autores escriban código sin errores y no pueden cometer un error en la nueva versión de su paquete.</font></font><br>
<br>
<a name="db"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de datos</font></font></h2><br>
<a name="dbstructure"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diseñamos el esquema</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La descripción del manejador POST / importaciones proporciona un ejemplo de descarga con información sobre los residentes:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo de carga</font></font></b>
                        <div class="spoiler_text"><pre><code class="json hljs">{
  <span class="hljs-attr">"citizens"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"26.12.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">2</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"01.04.1997"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">1</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"2"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">11</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"23.11.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"female"</span>,
      <span class="hljs-attr">"relatives"</span>: []<font></font>
    },<font></font>
    ...<font></font>
  ]<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer pensamiento fue almacenar toda la información sobre el residente en una tabla </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, donde la relación estaría representada por un campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forma de una lista de enteros</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero este método tiene varias desventajas.</font></font></b>
                        <div class="spoiler_text"><ol>
<li>   <code>GET /imports/$import_id/citizens/birthdays</code>   ,      ,     <code>citizens</code>   .          <code>relatives</code>    <code>UNNEST</code>.<br>
<br>
     ,  <b>    10- </b>:<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
    relations.citizen_id, <font></font>
    relations.relative_id, <font></font>
    date_part(<span class="hljs-string">'month'</span>, relatives.birth_date) <span class="hljs-keyword">as</span> relative_birth_month
<span class="hljs-keyword">FROM</span> (
	<span class="hljs-keyword">SELECT</span><font></font>
        citizens.import_id, <font></font>
        citizens.citizen_id,<font></font>
        <span class="hljs-keyword">UNNEST</span>(citizens.relatives) <span class="hljs-keyword">as</span> relative_id
	<span class="hljs-keyword">FROM</span> citizens
    <span class="hljs-keyword">WHERE</span> import_id = <span class="hljs-number">1</span>
) <span class="hljs-keyword">as</span> relations
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> citizens <span class="hljs-keyword">as</span> relatives <span class="hljs-keyword">ON</span>
    relations.import_id = relatives.import_id <span class="hljs-keyword">AND</span><font></font>
    relations.relative_id = relatives.citizen_id<font></font>
</code></pre><br>
 </li>
<li>    <b>    <code>relatives</code>   PostgreSQL</b>,   :    <code>relatives</code>     ,      .       (     )         .</li>
</ol></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, decidí llevar todos los datos necesarios para trabajar a una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tercera forma normal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y se obtuvo la siguiente estructura:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/pf/px/dipfpxxw142kafiect0yhrtt4uo.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tabla de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">importaciones</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> consta de una columna que se incrementa automáticamente </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es necesario para crear una verificación de clave externa en la tabla </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tabla de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ciudadanos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> almacena </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">datos escalares</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre el residente (todos los campos excepto la información sobre las relaciones familiares). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se utiliza un par ( </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">como clave principal </font><font style="vertical-align: inherit;">, garantizando la unicidad de los residentes </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dentro del marco </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una clave foránea </font></font><code>citizens.import_id -&gt; imports.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asegura que el campo </font></font><code>citizens.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contenga solo descargas existentes.</font></font><br>
 </li>
<li>  <b>relations</b>    <b> </b>. <br>
<br>
<b>     </b> (     ):           <code>citizens</code>  <code>relations</code>     .<br>
     (<code>import_id</code>, <code>citizen_id</code>, <code>relative_id</code>)  ,      <code>import_id</code>   <code>citizen_id</code>   c  <code>relative_id</code>. <br>
<br>
       : <code>(relations.import_id, relations.citizen_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>  <code>(relations.import_id, relations.relative_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>, ,        <code>citizen_id</code>   <code>relative_id</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta estructura garantiza la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">integridad de los datos utilizando las herramientas de PostgreSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , le permite </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtener de manera eficiente a los residentes con parientes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la base de datos, pero está </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sujeto a una condición de carrera</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> al actualizar la información sobre los residentes con consultas competitivas (analizaremos más de cerca la implementación del controlador PATCH).</font></font><br>
<br>
<a name="do_sqlalchemy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Describir el esquema en SQLAlchemy.</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capítulo 5,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hablé sobre cómo crear consultas usando SQLAlchemy, necesita describir el esquema de la base de datos usando objetos especiales: las tablas se describen usando </font></font><code>sqlalchemy.Table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y vinculadas a un registro </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que almacena toda la metainformación sobre la base de datos. Por cierto, el registro </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no solo puede almacenar la metainformación descrita en Python, sino que también representa el estado real de la base de datos en forma de objetos SQLAlchemy. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta característica también permite que Alembic compare condiciones y genere un código de migración automáticamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por cierto, cada base de datos tiene su propio esquema de nombres de restricciones predeterminado. </font><font style="vertical-align: inherit;">Para no perder el tiempo nombrando nuevas restricciones o buscando / recordando qué restricción está a punto de eliminar, SQLAlchemy sugiere usar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convenciones de nomenclatura para los</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> patrones de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">nomenclatura</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se pueden definir en el registro </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cree un registro de MetaData y pásele patrones de nombres</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> MetaData<font></font>
<font></font>
convention = {<font></font>
    <span class="hljs-string">'all_column_names'</span>: <span class="hljs-keyword">lambda</span> constraint, table: <span class="hljs-string">'_'</span>.join([<font></font>
        column.name <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> constraint.columns.values()<font></font>
    ]),<font></font>
<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-string">'ix'</span>: <span class="hljs-string">'ix__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'uq'</span>: <span class="hljs-string">'uq__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#  CHECK-constraint-</span>
    <span class="hljs-string">'ck'</span>: <span class="hljs-string">'ck__%(table_name)s__%(constraint_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'fk'</span>: <span class="hljs-string">'fk__%(table_name)s__%(all_column_names)s__%(referred_table_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'pk'</span>: <span class="hljs-string">'pk__%(table_name)s'</span><font></font>
}<font></font>
metadata = MetaData(naming_convention=convention)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si especifica patrones de nomenclatura, Alembic los usará durante la generación automática de migraciones y nombrará todas las restricciones de acuerdo con ellos. </font><font style="vertical-align: inherit;">En el futuro, el registro creado </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deberá describir las tablas:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Describimos el esquema de la base de datos con objetos SQLAlchemy</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<font></font>
<font></font>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> (<font></font>
    Column, Date, Enum <span class="hljs-keyword">as</span> PgEnum, ForeignKey, ForeignKeyConstraint, Integer,<font></font>
    String, Table<font></font>
)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@unique</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gender</span>(<span class="hljs-params">Enum</span>):</span>
    female = <span class="hljs-string">'female'</span>
    male = <span class="hljs-string">'male'</span><font></font>
<font></font>
<font></font>
imports_table = Table(<font></font>
    <span class="hljs-string">'imports'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>)<font></font>
)<font></font>
<font></font>
citizens_table = Table(<font></font>
    <span class="hljs-string">'citizens'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, ForeignKey(<span class="hljs-string">'imports.import_id'</span>),<font></font>
           primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'town'</span>, String, nullable=<span class="hljs-literal">False</span>, index=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'street'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'building'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'apartment'</span>, Integer, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'name'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'birth_date'</span>, Date, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'gender'</span>, PgEnum(Gender, name=<span class="hljs-string">'gender'</span>), nullable=<span class="hljs-literal">False</span>),<font></font>
)<font></font>
<font></font>
relations_table = Table(<font></font>
    <span class="hljs-string">'relations'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'relative_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'citizen_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'relative_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
)<font></font>
</code></pre></div>
                    </div><br>
<a name="db_alembic"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personalizar alambique</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se describe el esquema de la base de datos, es necesario generar migraciones, pero para esto primero debe configurar Alembic, que también se trata en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Capítulo 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para usar el comando </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, debe realizar los siguientes pasos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paquete de instalación: </font></font><code>pip install alembic</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicializar Alambique: </font></font><code>cd analyzer &amp;&amp; alembic init db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este comando creará un archivo de configuración </font></font><code>analyzer/alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y una carpeta </font></font><code>analyzer/db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con el siguiente contenido:</font></font><br>
 <ul>
<li> <code>env.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Llamado cada vez que inicias Alembic. </font><font style="vertical-align: inherit;">Se conecta al registro de Alembic </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con una descripción del estado deseado de la base de datos y contiene instrucciones para iniciar las migraciones.</font></font><br>
 </li>
<li><code>script.py.mako</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - la plantilla en función de la cual se generan las migraciones.</font></font></li>
<li><code>versions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - la carpeta en la que Alembic buscará (y generará) migraciones.</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Especifique la dirección de la base de datos en el archivo alembic.ini:</font></font><br>
<br>
<pre><code class="plaintext hljs">; analyzer/alembic.ini<font></font>
[alembic] <font></font>
sqlalchemy.url = postgresql://user:hackme@localhost/analyzer</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Especifique una descripción del estado deseado de la base de datos (registro </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) para que Alembic pueda generar migraciones automáticamente:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/alembic/env.py</span>
<span class="hljs-keyword">from</span> analyzer.db <span class="hljs-keyword">import</span> schema<font></font>
target_metadata = schema.metadata</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic está configurado y ya se puede usar, pero en nuestro caso esta configuración tiene varias desventajas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La utilidad </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">busca </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el directorio de trabajo actual. </font><font style="vertical-align: inherit;">Puede </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">especificar la </font><font style="vertical-align: inherit;">ruta al </font><font style="vertical-align: inherit;">argumento de la línea de comando, pero esto es inconveniente: quiero poder llamar al comando desde cualquier carpeta sin parámetros adicionales.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para configurar Alembic para que funcione con una base de datos específica, debe cambiar el archivo </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Sería mucho más conveniente especificar la configuración de la base de datos para la variable de entorno y / o un argumento de línea de comando, por ejemplo </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El nombre de la utilidad </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no se correlaciona muy bien con el nombre de nuestro servicio (y el usuario puede no tener Python y no saber nada sobre Alembic). </font><font style="vertical-align: inherit;">Sería mucho más conveniente para el usuario final si todos los comandos ejecutables del servicio tuvieran un prefijo común, por ejemplo </font></font><code>analyzer-*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estos problemas se resuelven con una pequeña envoltura. </font></font><code>analyzer/db/__main__.py:</code><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic utiliza un módulo estándar para procesar argumentos de línea de comando </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">argparse</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Le permite agregar un argumento opcional </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con un valor predeterminado de una variable de entorno </font></font><code>ANALYZER_PG_URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El código</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    alembic.parser.add_argument(<font></font>
        <span class="hljs-string">'--pg-url'</span>, default=os.getenv(<span class="hljs-string">'ANALYZER_PG_URL'</span>, DEFAULT_PG_URL),<font></font>
        help=<span class="hljs-string">'Database URL [env var: ANALYZER_PG_URL]'</span><font></font>
    )<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#   sqlalchemy.url   Alembic</span>
    config.set_main_option(<span class="hljs-string">'sqlalchemy.url'</span>, options.pg_url)<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La ruta al archivo </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se puede calcular en relación con la ubicación del archivo ejecutable y no con el directorio de trabajo actual del usuario.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El código</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<font></font>
<font></font>
<font></font>
PROJECT_PATH = Path(__file__).parent.parent.resolve()<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#     (alembic.ini),   </span>
    <span class="hljs-comment">#    </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(options.config):<font></font>
        options.config = os.path.join(PROJECT_PATH, options.config)<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#      alembic   (,  alembic</span>
    <span class="hljs-comment">#   env.py,       )</span>
    alembic_location = config.get_main_option(<span class="hljs-string">'script_location'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(alembic_location):<font></font>
        config.set_main_option(<span class="hljs-string">'script_location'</span>,<font></font>
                               os.path.join(PROJECT_PATH, alembic_location))<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilidad para administrar el estado de la base de datos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> está lista, puede registrarse </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como un comando ejecutable con un nombre que sea comprensible para el usuario final, por ejemplo </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registre un comando ejecutable en setup.py</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup<font></font>
<font></font>
setup(..., entry_points={<font></font>
    <span class="hljs-string">'console_scripts'</span>: [
        <span class="hljs-string">'analyzer-db = analyzer.db.__main__:main'</span><font></font>
    ]<font></font>
})<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de reinstalar el módulo, se generará un archivo </font></font><code>env/bin/analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y el comando </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estará disponible:</font></font><br>
<br>
<pre><code class="bash hljs">$ pip install -e <span class="hljs-string">'.[dev]'</span></code></pre><br>
<a name="db_alembic_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generamos migraciones</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para generar migraciones, se requieren dos estados: el estado deseado (que describimos con los objetos SQLAlchemy) y el estado real (la base de datos, en nuestro caso, está vacía). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidí que la forma más fácil de aumentar Postgres con Docker era agregar un comando </font></font><code>make postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que ejecutara un contenedor con PostgreSQL en el puerto 5432 en segundo plano:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eleve PostgreSQL y genere migración</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ make postgres<font></font>
...<font></font>
$ analyzer-db revision --message=<span class="hljs-string">"Initial"</span> --autogenerate<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'imports'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'citizens'</span>
INFO  [alembic.autogenerate.compare] Detected added index <span class="hljs-string">'ix__citizens__town'</span> on <span class="hljs-string">'['</span>town<span class="hljs-string">']'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'relations'</span>
  Generating /Users/alvassin/Work/backendschool2019/analyzer/db/alembic/versions/d5f704ed4610_initial.py ...  <span class="hljs-keyword">done</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, Alembic hace un buen trabajo en el trabajo de rutina de generar migraciones, pero me gustaría llamar la atención sobre lo siguiente:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los tipos de datos de usuario especificados en las tablas creadas se crean automáticamente (en nuestro caso - </font></font><code>gender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), pero </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no se genera </font><font style="vertical-align: inherit;">el código para eliminarlos </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si aplica, revierte y luego aplica la migración nuevamente, esto causará un error porque el tipo de datos especificado ya existe.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eliminar el tipo de datos de género en el método de degradación</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic <span class="hljs-keyword">import</span> op
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Enum<font></font>
<font></font>
GenderType = Enum(<span class="hljs-string">'female'</span>, <span class="hljs-string">'male'</span>, name=<span class="hljs-string">'gender'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upgrade</span>():</span><font></font>
    ...<font></font>
    <span class="hljs-comment">#      GenderType   </span>
    op.create_table(<span class="hljs-string">'citizens'</span>, ...,<font></font>
                    Column(<span class="hljs-string">'gender'</span>, GenderType, nullable=<span class="hljs-literal">False</span>))<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
    op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
<font></font>
    <span class="hljs-comment">#       </span>
    GenderType.drop(op.get_bind())</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el método, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">algunas acciones a veces se pueden eliminar (si eliminamos toda la tabla, no puede eliminar sus índices por separado):</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por ejemplo</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
op.drop_table(<span class="hljs-string">'relations'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      citizens,    </span>
<span class="hljs-comment">#    </span>
op.drop_index(op.f(<span class="hljs-string">'ix__citizens__town'</span>), table_name=<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'imports'</span>)</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando la migración está arreglada y lista, la aplicamos:</font></font><br>
<br>
<pre><code class="bash hljs">$ analyzer-db upgrade head<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.runtime.migration] Running upgrade  -&gt; d5f704ed4610, Initial</code></pre><br>
<a name="application"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicitud</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de comenzar a crear controladores, debe configurar la aplicación aiohttp.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si observa el inicio rápido de aiohttp, puede escribir algo como esto</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    logging.basicConfig(level=logging.DEBUG)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = web.Application()<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app.router.add_route(...)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    web.run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este código plantea una serie de preguntas y tiene una serie de desventajas:</font></font><br>
<br>
<ul>
<li> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cómo configurar la aplicación? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como mínimo, debe especificar el host y el puerto para conectar clientes, así como la información para conectarse a la base de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Realmente me gusta resolver este problema con la ayuda del módulo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>ConfigArgParse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: extiende el estándar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>argparse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y permite usar argumentos de línea de comando, variables de entorno (indispensables para configurar contenedores Docker) e incluso archivos de configuración (así como combinar estos métodos) para la configuración. </font><font style="vertical-align: inherit;">Al </font></font><code>ConfigArgParse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usarlo, también puede validar los valores de los parámetros de configuración de la aplicación.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un ejemplo de procesamiento de parámetros usando ConfigArgParse</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser, ArgumentDefaultsHelpFormatter<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.argparse <span class="hljs-keyword">import</span> positive_int<font></font>
<font></font>
parser = ArgumentParser(<font></font>
    <span class="hljs-comment">#        ANALYZER_,</span>
    <span class="hljs-comment">#  ANALYZER_API_ADDRESS  ANALYZER_API_PORT</span>
    auto_env_var_prefix=<span class="hljs-string">'ANALYZER_'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#     </span><font></font>
    formatter_class=ArgumentDefaultsHelpFormatter<font></font>
)<font></font>
<font></font>
parser.add_argument(<span class="hljs-string">'--api-address'</span>, default=<span class="hljs-string">'0.0.0.0'</span>,<font></font>
                    help=<span class="hljs-string">'IPv4/IPv6 address API server would listen on'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
parser.add_argument(<span class="hljs-string">'--api-port'</span>, type=positive_int, default=<span class="hljs-number">8081</span>,<font></font>
                    help=<span class="hljs-string">'TCP port API server would listen on'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#   ,     </span>
    <span class="hljs-comment">#  ,    </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#       </span><font></font>
    app = web.Application()<font></font>
    web.run_app(app, host=args.api_address, port=args.api_port)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div><br>
, <code>ConfigArgParse</code>,   <code>argparse</code>,           (     <code>-h</code>  <code>--help</code>).       :<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python __main__.py --<span class="hljs-built_in">help</span><font></font>
usage: __main__.py [-h] [--api-address API_ADDRESS] [--api-port API_PORT]<font></font>
<font></font>
If an arg is specified <span class="hljs-keyword">in</span> more than one place, <span class="hljs-keyword">then</span> commandline values override environment variables <span class="hljs-built_in">which</span> override defaults.<font></font>
<font></font>
optional arguments:<font></font>
  -h, --<span class="hljs-built_in">help</span>            show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span><font></font>
  --api-address API_ADDRESS<font></font>
                        IPv4/IPv6 address API server would listen on [env var: ANALYZER_API_ADDRESS] (default: 0.0.0.0)<font></font>
  --api-port API_PORT   TCP port API server would listen on [env var: ANALYZER_API_PORT] (default: 8081)</code></pre></div>
                    </div></li>
<li>             — ,    «»     .          ,  <strong>     </strong>. <br>
<br>
    <code>os.environ.clear()</code>,  Python            (,      <code>asyncio</code>?),        ,   <code>ConfigArgParser</code>.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Callable
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
ENV_VAR_PREFIX = <span class="hljs-string">'ANALYZER_'</span><font></font>
<font></font>
parser = ArgumentParser(auto_env_var_prefix=ENV_VAR_PREFIX)<font></font>
parser.add_argument(<span class="hljs-string">'--pg-url'</span>, type=URL, default=URL(DEFAULT_PG_URL),<font></font>
                   help=<span class="hljs-string">'URL to use to connect to the database'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_environ</span>(<span class="hljs-params">rule: Callable</span>):</span>
    <span class="hljs-string">"""
      ,     
     rule
    """</span>
    <span class="hljs-comment">#   os.environ    tuple,    </span>
    <span class="hljs-comment"># os.environ   </span>
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> filter(rule, tuple(os.environ)):<font></font>
        os.environ.pop(name)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#      ANALYZER_</span>
    clear_environ(<span class="hljs-keyword">lambda</span> i: i.startswith(ENV_VAR_PREFIX))<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = create_app(args)<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li> <strong>   stderr/      .</strong><br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> 9</a> ,    <code>logging.basicConfig()</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>   stderr</code></a>.<br>
<br>
       ,       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a>   aiomisc.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    aiomisc</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiomisc.log <span class="hljs-keyword">import</span> basic_config<font></font>
<font></font>
basic_config(logging.DEBUG, buffered=<span class="hljs-literal">True</span>)    
</code></pre></div>
                    </div></li>
<li> <strong>  ,     </strong>    ?    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>fork</code></a>     ,           (,  Windows   ).<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv<font></font>
<font></font>
<span class="hljs-keyword">import</span> forklib
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket
<span class="hljs-keyword">from</span> setproctitle <span class="hljs-keyword">import</span> setproctitle<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8081</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
    setproctitle(<span class="hljs-string">f'[Master] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span>():</span>
        setproctitle(<span class="hljs-string">f'[Worker] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
        app = Application()<font></font>
        run_app(app, sock=sock)<font></font>
<font></font>
    forklib.fork(os.cpu_count(), worker, auto_restart=<span class="hljs-literal">True</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()<font></font>
</code></pre></div>
                    </div></li>
<li>    <strong>   -    </strong>?  ,      (   —    )    ,      <code>nobody</code>.      —     .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> pwd<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8085</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
<font></font>
    user = pwd.getpwnam(<span class="hljs-string">'nobody'</span>)<font></font>
    os.setgid(user.pw_gid)<font></font>
    os.setuid(user.pw_uid)<font></font>
<font></font>
    app = create_app(...)<font></font>
    run_app(app, sock=sock)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li>            <code>create_app</code>,         .</li>
</ul><br>
<a name="serialization"></a><h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas las respuestas exitosas del manejador serán devueltas en formato JSON. </font><font style="vertical-align: inherit;">También sería conveniente para los clientes recibir información sobre errores en forma serializada (por ejemplo, para ver qué campos no pasaron la validación). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La documentación </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ofrece un método </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://docs.aio"><code>json_response</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que toma un objeto, lo serializa en JSON y devuelve un nuevo objeto </font></font><code>aiohttp.web.Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con un encabezado </font></font><code>Content-Type: application/json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y datos serializados dentro.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo serializar datos usando json_response</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, View, run_app
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> json_response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> json_response({<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero hay otra forma: aiohttp le permite registrar un serializador arbitrario para un tipo específico de datos de respuesta en el registro </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Por ejemplo, puede especificar un serializador </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para objetos de tipo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapping</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, será suficiente para que el controlador devuelva un objeto </font></font><code>Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con los datos de respuesta en el parámetro </font></font><code>body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">aiohttp encontrará un serializador que coincida con el tipo de datos y serializará la respuesta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además del hecho de que la serialización de objetos se describe en un solo lugar, este enfoque también es más flexible: le permite implementar soluciones muy interesantes (consideraremos uno de los casos de uso en el controlador </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo serializar datos usando aiohttp.PAYLOAD_REGISTRY</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> MappingProxyType
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Mapping<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> PAYLOAD_REGISTRY, JsonPayload
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app, Application, Response, View<font></font>
<font></font>
PAYLOAD_REGISTRY.register(JsonPayload, (Mapping, MappingProxyType))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> Response(body={<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es importante comprender que </font></font><code>json_response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, por ejemplo </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, utilizan un </font><font style="vertical-align: inherit;">método </font><font style="vertical-align: inherit;">estándar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>json.dumps</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que no puede serializar tipos de datos complejos, por ejemplo, </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font><code>asyncpg.Record</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>asyncpg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelve registros de la base de datos como instancias de esta clase). </font><font style="vertical-align: inherit;">Además, algunos objetos complejos pueden contener otros: en un registro de la base de datos puede haber un campo de tipo </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los desarrolladores de Python han abordado este problema: el método le </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite usar el argumento </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para especificar una función que se llama cuando es necesario serializar un objeto desconocido. </font><font style="vertical-align: inherit;">Se espera que la función arroje un objeto desconocido a un tipo que pueda serializar el módulo json.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo extender JsonPayload para serializar objetos arbitrarios</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial, singledispatch
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Any<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.payload <span class="hljs-keyword">import</span> JsonPayload <span class="hljs-keyword">as</span> BaseJsonPayload
<span class="hljs-keyword">from</span> aiohttp.typedefs <span class="hljs-keyword">import</span> JSONEncoder<font></font>
<font></font>
<span class="hljs-meta">@singledispatch</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert</span>(<span class="hljs-params">value</span>):</span>
    <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">f'Unserializable value: <span class="hljs-subst">{value!r}</span>'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(Record)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_asyncpg_record</span>(<span class="hljs-params">value: Record</span>):</span>
    <span class="hljs-string">"""
        , 
    asyncpg
    """</span>
    <span class="hljs-keyword">return</span> dict(value)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(date)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_date</span>(<span class="hljs-params">value: date</span>):</span>
    <span class="hljs-string">"""
       date      —  
      .     
      ..
    """</span>
    <span class="hljs-keyword">return</span> value.strftime(<span class="hljs-string">'%d.%m.%Y'</span>)<font></font>
    <font></font>
 <font></font>
dumps = partial(json.dumps, default=convert)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JsonPayload</span>(<span class="hljs-params">BaseJsonPayload</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,
                 value: Any,
                 encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 dumps: JSONEncoder = dumps,
                 *args: Any,
                 **kwargs: Any</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        super().__init__(value, encoding, content_type, dumps, *args, **kwargs)</code></pre></div>
                    </div><br>
<a name="handlers"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipuladores</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aiohttp le permite implementar controladores con funciones y clases asincrónicas. </font><font style="vertical-align: inherit;">Las clases son más extensibles: en primer lugar, el código que pertenece a un controlador puede colocarse en un lugar y, en segundo lugar, las clases le permiten usar la herencia para deshacerse de la duplicación de código (por ejemplo, cada controlador requiere una conexión a la base de datos).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clase base de manejador</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_urldispatcher <span class="hljs-keyword">import</span> View
<span class="hljs-keyword">from</span> asyncpgsa <span class="hljs-keyword">import</span> PG<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseView</span>(<span class="hljs-params">View</span>):</span><font></font>
    URL_PATH: str<font></font>
<font></font>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pg</span>(<span class="hljs-params">self</span>) -&gt; PG:</span>
        <span class="hljs-keyword">return</span> self.request.app[<span class="hljs-string">'pg'</span>]
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como es difícil leer un archivo grande, decidí dividir los controladores en archivos. </font><font style="vertical-align: inherit;">Los archivos pequeños fomentan la conectividad débil, y si, por ejemplo, hay importaciones de anillo dentro de los controladores, significa que algo puede estar mal con la composición de las entidades.</font></font><br>
<br>
<a name="imports_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importaciones</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El manejador de entrada recibe json con datos sobre los residentes. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El tamaño de solicitud máximo permitido</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en aiohttp está controlado por la opción </font></font><code>client_max_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=http://docs.aiohttp.org/en/stable/web_reference.html&amp;usg=ALkJrhjiLqGH4UNxxq95QJuC_k3cjikCiw#aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es de 2 MB de forma predeterminada</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si se excede el límite, aiohttp devolverá una respuesta HTTP con un estado de 413: Error de entidad de solicitud demasiado grande. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al mismo tiempo, el json correcto con las líneas y números más largos pesará ~ 63 megabytes, por lo que las restricciones sobre el tamaño de la solicitud deben ampliarse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuación, debe </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verificar y deserializar los datos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si son incorrectos, debe devolver una respuesta HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Necesitaba dos esquemas </font></font><code>Marhsmallow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. El primero </font></font><code>CitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, verifica los datos de cada residente individual y también deserializa la cadena de feliz cumpleaños en el objeto </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipo de datos, formato y disponibilidad de todos los campos obligatorios;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta de campos desconocidos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fecha de nacimiento debe indicarse en el formato </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y no puede tener ninguna importancia en el futuro;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La lista de familiares de cada residente debe contener identificadores únicos de residentes existentes en esta carga.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El segundo esquema </font></font><code>ImportSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, comprueba la descarga en su conjunto:</font></font><br>
<br>
<ul>
<li><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada residente dentro de la descarga debe ser único;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los lazos familiares deben ser bidireccionales (si el residente # 1 tiene un residente # 2 en la lista de parientes, entonces el residente # 2 también debe tener un pariente # 1).</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si los datos son correctos, deben agregarse a la base de datos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con uno nuevo y único </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para agregar datos, deberá realizar varias consultas en diferentes tablas. </font><font style="vertical-align: inherit;">Para evitar datos agregados parcialmente en la base de datos en caso de error o excepción (por ejemplo, al desconectar un cliente que no recibió una respuesta completa, aiohttp </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=http://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lanzará una excepción CancelledError</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debe usar una transacción</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es necesario agregar datos a las tablas en partes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ya que en una consulta a PostgreSQL no puede haber más de 32,767 argumentos. </font><font style="vertical-align: inherit;">Hay </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 campos </font><font style="vertical-align: inherit;">en la tabla </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En consecuencia, para 1 consulta, solo se pueden insertar 32.767 / 9 = 3.640 filas en esta tabla, y en una carga puede haber hasta 10.000 habitantes.</font></font><br>
<br>
<a name="citizens_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / ciudadanos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador devuelve a todos los residentes para descargar con el especificado </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> especificada </font><b><font style="vertical-align: inherit;">no existe</font></b><font style="vertical-align: inherit;"> , debe devolver la respuesta 404: No encontrado HTTP. </font><font style="vertical-align: inherit;">Este comportamiento parece ser común para los controladores que necesitan una descarga existente, por lo que extraje el código de verificación en una clase separada.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clase base para manipuladores con descargas</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_exceptions <span class="hljs-keyword">import</span> HTTPNotFound
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, exists<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> imports_table<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseImportView</span>(<span class="hljs-params">BaseView</span>):</span>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">import_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> int(self.request.match_info.get(<span class="hljs-string">'import_id'</span>))<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_import_exists</span>(<span class="hljs-params">self</span>):</span><font></font>
        query = select([<font></font>
            exists().where(imports_table.c.import_id == self.import_id)<font></font>
        ])<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">await</span> self.pg.fetchval(query):
            <span class="hljs-keyword">raise</span> HTTPNotFound()
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para obtener una lista de parientes para cada residente, deberá realizar una </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabla </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a otra </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, agregando el campo </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agrupado por </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si el residente no tiene parientes, </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le devolverá el </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor </font><font style="vertical-align: inherit;">en el campo </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y, como resultado de la agregación, se verá la lista de parientes </font></font><code>[NULL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para corregir este valor incorrecto, utilicé la función </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_remove</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La base de datos almacena la fecha en un formato </font></font><code>YYYY-MM-DD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pero necesitamos un formato </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Técnicamente, puede formatear la fecha con una consulta SQL o en el lado de Python al momento de serializar la respuesta con </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(asyncpg devuelve el valor del campo </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como una instancia de la clase</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elegí la serialización en el lado de Python, dado que </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es el único objeto </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el proyecto con un solo formato (consulte la sección </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Serialización de datos"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pesar de que el procesador ejecuta dos solicitudes (comprobando la existencia de una descarga y una solicitud de una lista de residentes), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no es necesario utilizar una transacción</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . De manera predeterminada, PostgreSQL usa el nivel de aislamiento, </font></font><code>READ COMMITTED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e incluso dentro de una transacción todos los cambios a otras transacciones completadas con éxito serán visibles (agregando nuevas filas, cambiando las existentes).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La carga más grande en una vista de texto puede tomar ~ 63 megabytes, esto es bastante, especialmente teniendo en cuenta que varias solicitudes para recibir datos pueden llegar al mismo tiempo. </font><font style="vertical-align: inherit;">Hay una forma bastante interesante </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de obtener datos de la base de datos utilizando el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y enviarlos al cliente por partes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer esto, necesitamos implementar dos objetos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un objeto de </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tipo </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que devuelve registros de la base de datos. </font><font style="vertical-align: inherit;">En la primera llamada, se conecta a la base de datos, abre una transacción y crea un cursor; durante la iteración posterior, devuelve registros de la base de datos. </font><font style="vertical-align: inherit;">Es devuelto por el manejador.</font></font><br>
 <br>
 <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seleccionar código de consulta</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> AsyncIterable
<span class="hljs-keyword">from</span> asyncpgsa.transactionmanager <span class="hljs-keyword">import</span> ConnectionTransactionContextManager
<span class="hljs-keyword">from</span> sqlalchemy.sql <span class="hljs-keyword">import</span> Select<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelectQuery</span>(<span class="hljs-params">AsyncIterable</span>):</span>
    <span class="hljs-string">"""
    ,     PostgreSQL   
    ,  ,    
    """</span>
    PREFETCH = <span class="hljs-number">500</span><font></font>
<font></font>
    __slots__ = (<font></font>
        <span class="hljs-string">'query'</span>, <span class="hljs-string">'transaction_ctx'</span>, <span class="hljs-string">'prefetch'</span>, <span class="hljs-string">'timeout'</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, query: Select,
                 transaction_ctx: ConnectionTransactionContextManager,
                 prefetch: int = None,
                 timeout: float = None</span>):</span><font></font>
        self.query = query<font></font>
        self.transaction_ctx = transaction_ctx<font></font>
        self.prefetch = prefetch <span class="hljs-keyword">or</span> self.PREFETCH<font></font>
        self.timeout = timeout<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aiter__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.transaction_ctx <span class="hljs-keyword">as</span> conn:<font></font>
            cursor = conn.cursor(self.query, prefetch=self.prefetch,<font></font>
                                 timeout=self.timeout)<font></font>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
                <span class="hljs-keyword">yield</span> row
</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un serializador </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que puede iterar sobre generadores asincrónicos, serializar datos de un generador asincrónico a JSON y enviar datos a clientes en partes. </font><font style="vertical-align: inherit;">Está registrado </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como un serializador de objetos </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsyncGenJSONListPayload Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> Payload<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># ,    JSON  asyncpg.Record  datetime.date</span>
dumps = partial(json.dumps, default=convert, ensure_ascii=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncGenJSONListPayload</span>(<span class="hljs-params">Payload</span>):</span>
    <span class="hljs-string">"""
       AsyncIterable,     
     JSON   
    """</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, value, encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 root_object: str = <span class="hljs-string">'data'</span>,
                 *args, **kwargs</span>):</span><font></font>
        self.root_object = root_object<font></font>
        super().__init__(value, content_type=content_type, encoding=encoding,<font></font>
                         *args, **kwargs)<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">self, writer</span>):</span>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<font></font>
            (<span class="hljs-string">'{"%s":['</span> % self.root_object).encode(self._encoding)<font></font>
        )<font></font>
<font></font>
        first = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> self._value:
            <span class="hljs-comment">#      </span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> first:
                <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b','</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                first = <span class="hljs-literal">False</span><font></font>
<font></font>
            <span class="hljs-keyword">await</span> writer.write(dumps(row).encode(self._encoding))<font></font>
<font></font>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b']}'</span>)</code></pre></div>
                    </div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, en el controlador será posible crear un objeto </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pasarle una consulta SQL y una función para abrir la transacción y devolverlo a </font></font><code>Response body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Código de controlador</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/api/handlers/citizens.py</span>
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> Response
<span class="hljs-keyword">from</span> aiohttp_apispec <span class="hljs-keyword">import</span> docs, response_schema<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.schema <span class="hljs-keyword">import</span> CitizensResponseSchema
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> citizens_table <span class="hljs-keyword">as</span> citizens_t
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> SelectQuery<font></font>
<font></font>
<span class="hljs-keyword">from</span> .query <span class="hljs-keyword">import</span> CITIZENS_QUERY
<span class="hljs-keyword">from</span> .base <span class="hljs-keyword">import</span> BaseImportView<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CitizensView</span>(<span class="hljs-params">BaseImportView</span>):</span>
    URL_PATH = <span class="hljs-string">r'/imports/{import_id:\d+}/citizens'</span><font></font>
<font></font>
<span class="hljs-meta">    @docs(summary='    ')</span>
<span class="hljs-meta">    @response_schema(CitizensResponseSchema())</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">await</span> self.check_import_exists()<font></font>
<font></font>
        query = CITIZENS_QUERY.where(<font></font>
            citizens_t.c.import_id == self.import_id<font></font>
        )<font></font>
        body = SelectQuery(query, self.pg.transaction())<font></font>
        <span class="hljs-keyword">return</span> Response(body=body)
</code></pre></div>
                    </div><br>
<code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">detecta un </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serializador </font><font style="vertical-align: inherit;">registrado </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para objetos de tipo </font><font style="vertical-align: inherit;">en el registro </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Luego, el serializador iterará sobre el objeto </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y enviará datos al cliente. En la primera llamada, el objeto </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recibe una conexión a la base de datos, abre una transacción y crea un cursor; durante la iteración adicional, recibirá datos de la base de datos con el cursor y los devolverá línea por línea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este enfoque permite no asignar memoria para la cantidad total de datos con cada solicitud, pero tiene una peculiaridad: la aplicación no podrá devolver el estado HTTP correspondiente al cliente si se produce un error (después de todo, el estado HTTP, los encabezados ya se han enviado al cliente y se están escribiendo datos).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando ocurre una excepción, no queda nada más que desconectarse. </font><font style="vertical-align: inherit;">Por supuesto, se puede asegurar una excepción, pero el cliente no podrá entender exactamente qué error ocurrió. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por otro lado, puede surgir una situación similar incluso si el procesador recibe todos los datos de la base de datos, pero la red parpadea mientras transmite datos al cliente; nadie está a salvo de esto.</font></font><br>
<br>
<a name="update_citizen_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PARCHE / importaciones / $ import_id / ciudadanos / $ citizen_id</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador recibe el identificador de la descarga </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, el residente </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, así como json con los nuevos datos sobre el residente. </font><font style="vertical-align: inherit;">En el caso de una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descarga inexistente o de un residente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se debe devolver una respuesta HTTP </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los datos transmitidos por el cliente deben ser </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verificados y deserializados</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si son incorrectos, debe devolver una respuesta HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Implementé un esquema Marshmallow </font></font><code>PatchCitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que verifica:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El tipo y el formato de los datos para los campos especificados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fecha de nacimiento. </font><font style="vertical-align: inherit;">Debe especificarse en un formato </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y no puede tener importancia en el futuro.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una lista de familiares de cada residente. </font><font style="vertical-align: inherit;">Debe tener identificadores únicos para los residentes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La existencia de los parientes indicados en el campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no se puede verificar por separado: si </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se </font><font style="vertical-align: inherit;">agrega un </font><font style="vertical-align: inherit;">residente inexistente </font><font style="vertical-align: inherit;">a la tabla, </font><font style="vertical-align: inherit;">PostgreSQL devolverá un error </font></font><code>ForeignKeyViolationError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que se puede procesar y se puede devolver el estado HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Qué estado debería devolverse si el cliente envió </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">datos incorrectos para un residente o descarga inexistente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? Es semánticamente más correcto verificar primero la existencia de una descarga y un residente (si no hay ninguno, regresar </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) y solo luego si el cliente ha enviado los datos correctos (si no, regresar </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). En la práctica, a menudo es más barato verificar los datos primero, y solo si son correctos, acceder a la base de datos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ambas opciones son aceptables, pero decidí elegir una segunda opción más barata, ya que en cualquier caso el resultado de la operación es un error que no afecta nada (el cliente corregirá los datos y luego descubrirá que el residente no existe). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si los datos son correctos, es necesario </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actualizar la información sobre el residente en la base de datos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En el controlador, deberá realizar varias consultas a diferentes tablas. Si se produce un error o una excepción, los cambios en la base de datos deben deshacerse, por lo que las </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas deben realizarse en una transacción</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El método le </font></font><code>PATCH</code> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite transferir solo algunos campos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para un residente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador debe estar escrito de tal manera que no se bloquee al acceder a datos que el cliente no especificó, y tampoco ejecuta consultas en tablas en las que los datos no han cambiado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si el cliente especificó el campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, es necesario obtener una lista de parientes existentes. Si ha cambiado, determine qué registros de la tabla </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deben eliminarse y cuáles agregar para alinear la base de datos con la solicitud del cliente. Por defecto, PostgreSQL usa aislamiento de transacciones </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code> READ COMMITTED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Esto significa que, como parte de la transacción actual, los cambios serán visibles para los registros existentes (así como los nuevos) de otras transacciones completadas. Esto puede conducir a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una condición de carrera entre solicitudes competitivas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supongamos que hay una descarga con los residentes.</font></font><code>#1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>#2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>#3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sin parentesco. El servicio recibe dos solicitudes simultáneas para cambiar el residente # 1: </font></font><code><nobr>{"relatives": [2]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code><nobr>{"relatives": [3]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. aiohttp creará dos controladores que recibirán simultáneamente el estado actual del residente de PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada controlador no detectará una sola relación relacionada y decidirá agregar una nueva relación con el pariente especificado. Como resultado, el residente # 1 tiene el mismo campo que los parientes </font></font><code>[2,3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/bk/mz/gobkmzuhzr47rfzgvtygkxb1stm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este comportamiento no puede llamarse obvio. Se esperan dos opciones para decidir el resultado de la carrera: completar solo la primera solicitud y que la segunda devuelva una respuesta HTTP </font></font><br>
<code>409: Conflict</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(para que el cliente repita la solicitud), o ejecutar solicitudes por turno (la segunda solicitud se procesará solo después de que se complete la primera). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La primera opción se puede implementar activando el modo de aislamiento</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>SERIALIZABLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Si durante el procesamiento de la solicitud alguien ya logró cambiar y confirmar los datos, se generará una excepción, que se puede procesar y devolver el estado HTTP correspondiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La desventaja de esta solución: una gran cantidad de bloqueos en PostgreSQL </font></font><code>SERIALIZABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arrojará una excepción, incluso si las consultas competitivas cambian los registros de los residentes de diferentes descargas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
También puede usar el mecanismo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloqueo de recomendación</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Si obtiene este bloqueo activado </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, las solicitudes competitivas para diferentes descargas podrán ejecutarse en paralelo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para procesar solicitudes competitivas en una carga, puede implementar el comportamiento de cualquiera de las opciones: la función </font></font><code>pg_try_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intenta obtener un bloqueo y</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
devuelve el resultado booleano inmediatamente (si no fue posible obtener el bloqueo, se puede lanzar una excepción) y </font></font><code>pg_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espera hasta que el </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
recurso esté disponible para el bloqueo (en este caso, las solicitudes se ejecutarán secuencialmente, me decidí por esta opción). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, el controlador debe </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devolver la información actual sobre el residente actualizado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Fue posible limitarnos a devolver datos de su solicitud al cliente (dado que estamos devolviendo una respuesta al cliente, significa que no hubo excepciones y que todas las solicitudes se completaron con éxito). O bien, use la palabra clave RETURNING en consultas que modifiquen la base de datos y generen una respuesta a partir de los resultados. Pero ambos enfoques no nos permitirían ver y probar el caso con la raza de los estados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No hubo requisitos de alta carga para el servicio, así que decidí solicitar nuevamente todos los datos sobre el residente y devolver al cliente un resultado honesto de la base de datos. </font></font><br>
<br>
<a name="citizen_birthdays_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importaciones / $ import_id / ciudadanos / cumpleaños</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador calcula la cantidad de regalos que cada residente de la descarga recibirá a sus familiares (primer pedido). </font><font style="vertical-align: inherit;">El número se agrupa por mes para cargar con el especificado </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En el caso de una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga inexistente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se debe devolver una respuesta HTTP </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay dos opciones de implementación:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenga datos para residentes con parientes de la base de datos y, en el lado de Python, agregue datos por mes y genere listas para aquellos meses para los que no hay datos en la base de datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compile una solicitud json en la base de datos y agregue talones para los meses que faltan.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me decidí por la primera opción: visualmente parece más comprensible y compatible. El número de cumpleaños en un mes determinado puede obtenerse </font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de la tabla con lazos familiares ( </font></font><code>relations.citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- el residente para quien consideramos los cumpleaños de familiares) en la tabla </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(que contiene la fecha de nacimiento de la que desea obtener el mes). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los valores del mes no deben contener ceros a la izquierda. El mes obtenido del campo </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usando la función </font></font><code>date_part</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede contener un cero a la izquierda. Para quitarlo, he realizado </font></font><code>cast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font><code>integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la consulta SQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pesar de que el controlador necesita cumplir dos solicitudes (verificar la existencia de descarga y obtener información sobre cumpleaños y regalos), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no se requiere</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> una </font><b><font style="vertical-align: inherit;">transacción</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De manera predeterminada, PostgreSQL usa el modo LEER COMPROMETIDO, en el que todos los registros nuevos (agregados por otras transacciones) y existentes (modificados por otras transacciones) son visibles en la transacción actual después de que se completen con éxito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, si se agrega una nueva carga al momento de recibir los datos, no afectará a los existentes. </font><font style="vertical-align: inherit;">Si al momento de recibir los datos se ejecuta una solicitud para cambiar el residente, los datos aún no estarán visibles (si la transacción que cambió los datos no se ha completado) o la transacción se completará por completo y todos los cambios serán visibles de inmediato. </font><font style="vertical-align: inherit;">La integridad obtenida de la base de datos no será violada.</font></font><br>
<br>
<a name="town_age_stat_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentil / age</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador calcula los percentiles 50, 75 y 99 de las edades (años completos) de los residentes por ciudad en la muestra con el import_id especificado. </font><font style="vertical-align: inherit;">En el caso de una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">carga inexistente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se debe devolver una respuesta HTTP </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pesar de que el procesador ejecuta dos solicitudes (comprobando la existencia de descarga y obteniendo una lista de residentes), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no es necesario utilizar una transacción</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay dos opciones de implementación:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenga la edad de los residentes de la base de datos, agrupada por ciudad, y luego, en el lado de Python, calcule los percentiles usando numpy (que se especifica como referencia en la tarea) y redondee hasta dos decimales.</font></font></li>
<li>     PostgreSQL:  percentile_cont     ,             SQL-,  numpy   .</li>
</ol> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La segunda opción requiere transferir menos datos entre la aplicación y PostgreSQL, pero no tiene una trampa muy obvia: en PostgreSQL, el redondeo es matemático, ( </font></font><code>SELECT ROUND(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelve 3), y en Python - contabilidad, al entero más cercano ( </font></font><code>round(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelve 2). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para probar el controlador, la implementación debe ser la misma tanto en PostgreSQL como en Python (implementar una función con redondeo matemático en Python parece más fácil). </font><font style="vertical-align: inherit;">Vale la pena señalar que al calcular los percentiles, numpy y PostgreSQL pueden devolver números ligeramente diferentes, pero dado el redondeo, esta diferencia no será notable.</font></font><br>
<br>
<a name="testing"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pruebas</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Qué se debe verificar en esta aplicación? En primer lugar, que los manejadores cumplan con los requisitos y realicen el trabajo requerido en un entorno lo más cercano posible al entorno de combate. En segundo lugar, las migraciones que cambian el estado de la base de datos funcionan sin errores. En tercer lugar, hay una serie de funciones auxiliares que también podrían cubrirse correctamente mediante pruebas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidí usar el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">marco pytest debido</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a su flexibilidad y facilidad de uso. Ofrece un poderoso mecanismo para preparar el entorno para las pruebas: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accesorios</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es decir, funciones con un decorador</font></font><code>pytest.mark.fixture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cuyos nombres pueden especificarse por el parámetro en la prueba. </font><font style="vertical-align: inherit;">Si pytest detecta un parámetro con un nombre de dispositivo en la anotación de prueba, ejecutará este dispositivo y pasará el resultado en el valor de este parámetro. </font><font style="vertical-align: inherit;">Y si el dispositivo es un generador, entonces el parámetro de prueba tomará el valor devuelto </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y después de que finalice la prueba, se ejecutará la segunda parte del </font><font style="vertical-align: inherit;">dispositivo </font><font style="vertical-align: inherit;">, que puede borrar recursos o cerrar conexiones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para la mayoría de las pruebas, necesitamos una base de datos PostgreSQL. </font><font style="vertical-align: inherit;">Para aislar las pruebas entre sí, puede crear una base de datos separada antes de cada prueba y eliminarla después de la ejecución.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear una base de datos de dispositivos para cada prueba</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">from</span> sqlalchemy_utils <span class="hljs-keyword">import</span> create_database, drop_database
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
PG_URL = os.getenv(<span class="hljs-string">'CI_ANALYZER_PG_URL'</span>, DEFAULT_PG_URL)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">postgres</span>():</span>
    tmp_name = <span class="hljs-string">'.'</span>.join([uuid.uuid4().hex, <span class="hljs-string">'pytest'</span>])<font></font>
    tmp_url = str(URL(PG_URL).with_path(tmp_name))<font></font>
    create_database(tmp_url)<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#      postgres  -</span>
        <span class="hljs-keyword">yield</span> tmp_url
    <span class="hljs-keyword">finally</span>:<font></font>
        drop_database(tmp_url)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_db</span>(<span class="hljs-params">postgres</span>):</span>
    <span class="hljs-string">"""
     ,  PostgreSQL
    """</span><font></font>
    engine = create_engine(postgres)<font></font>
    <span class="hljs-keyword">assert</span> engine.execute(<span class="hljs-string">'SELECT 1'</span>).scalar() == <span class="hljs-number">1</span>
    engine.dispose()</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El módulo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sqlalchemy_utils</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hizo un gran trabajo de esta tarea </font><font style="vertical-align: inherit;">, teniendo en cuenta las características de diferentes bases de datos y controladores. Por ejemplo, PostgreSQL no permite la ejecución </font></font><code>CREATE DATABASE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en un bloque de transacciones. Al crear una base de datos, se </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traduce </font></font><code>psycopg2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(que generalmente ejecuta todas las solicitudes en una transacción) al modo de confirmación automática. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otra característica importante: si al menos un cliente está conectado a PostgreSQL, la base de datos no se puede eliminar, pero </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desconecta a todos los clientes antes de eliminar la base de datos. La base de datos se eliminará con éxito incluso si se bloquea alguna prueba con conexiones activas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Necesitamos PostgreSQL en diferentes estados: para probar las migraciones, necesitamos una base de datos limpia, mientras que los controladores requieren que se apliquen todas las migraciones. </font><font style="vertical-align: inherit;">Puede cambiar programáticamente el estado de una base de datos utilizando comandos Alembic; requieren el objeto de configuración Alembic para llamarlos.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear un objeto de configuración Alembic de dispositivo</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> SimpleNamespace<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> make_alembic_config<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alembic_config</span>(<span class="hljs-params">postgres</span>):</span>
    cmd_options = SimpleNamespace(config=<span class="hljs-string">'alembic.ini'</span>, name=<span class="hljs-string">'alembic'</span>,<font></font>
                                  pg_url=postgres, raiseerr=<span class="hljs-literal">False</span>, x=<span class="hljs-literal">None</span>)
    <span class="hljs-keyword">return</span> make_alembic_config(cmd_options)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que los dispositivos </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tienen un parámetro </font></font><code>postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite no solo indicar la dependencia de la prueba en los dispositivos, sino también las dependencias entre ellos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este mecanismo le permite separar de manera flexible la lógica y escribir código muy conciso y reutilizable.</font></font><br>
<br>
<a name="testing_handlers"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipuladores</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las pruebas de controladores requieren una base de datos con tablas y tipos de datos creados. Para aplicar migraciones, debe llamar mediante programación al comando Alembic de actualización. Para llamarlo, necesita un objeto con la configuración Alembic, que ya hemos definido con los accesorios </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La base de datos con migraciones parece una entidad completamente independiente y se puede representar como un elemento fijo:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic.command <span class="hljs-keyword">import</span> upgrade<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrated_postgres</span>(<span class="hljs-params">alembic_config, postgres</span>):</span>
    upgrade(alembic_config, <span class="hljs-string">'head'</span>)
    <span class="hljs-comment">#  DSN  ,    </span>
    <span class="hljs-keyword">return</span> postgres</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando hay muchas migraciones en el proyecto, su aplicación para cada prueba puede llevar demasiado tiempo. Para acelerar el proceso, puede </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crear una base de datos con migraciones</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> una vez </font><font style="vertical-align: inherit;">y luego </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usarla como plantilla</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además de la base de datos para probar controladores, necesitará una aplicación en ejecución, así como un cliente configurado para trabajar con esta aplicación. Para hacer que la aplicación sea fácil de probar, puse su creación en una función </font></font><code>create_app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que toma parámetros para ejecutarse: una base de datos, un puerto para la API REST y otros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los argumentos para iniciar la aplicación también se pueden representar como un elemento separado. Para crearlos, deberá determinar el puerto libre para ejecutar la aplicación de prueba y la dirección a la base de datos temporal migrada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para determinar el puerto libre, utilicé el dispositivo </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">del paquete aiomisc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un dispositivo estándar </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">también estaría bien, pero devuelve una función para determinar los puertos libres, mientras que </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inmediatamente devuelve el número de puerto. </font><font style="vertical-align: inherit;">Para nuestra aplicación, necesitamos determinar solo un puerto libre, así que decidí no escribir una línea de código adicional con una llamada </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arguments</span>(<span class="hljs-params">aiomisc_unused_port, migrated_postgres</span>):</span>
    <span class="hljs-keyword">return</span> parser.parse_args(<font></font>
        [<font></font>
            <span class="hljs-string">'--log-level=debug'</span>,
            <span class="hljs-string">'--api-address=127.0.0.1'</span>,
            <span class="hljs-string">f'--api-port=<span class="hljs-subst">{aiomisc_unused_port}</span>'</span>,
            <span class="hljs-string">f'--pg-url=<span class="hljs-subst">{migrated_postgres}</span>'</span><font></font>
        ]<font></font>
    )</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas las pruebas con controladores implican solicitudes a la API REST; </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no </font><font style="vertical-align: inherit;">es </font><font style="vertical-align: inherit;">necesario </font><font style="vertical-align: inherit;">trabajar directamente con la aplicación </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Por lo tanto, hice un accesorio que inicia la aplicación y el uso de fábrica </font></font><code>aiohttp_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crea y devuelve un cliente de prueba estándar conectado a la aplicación </font></font><code>aiohttp.test_utils.TestClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">api_client</span>(<span class="hljs-params">aiohttp_client, arguments</span>):</span><font></font>
    app = create_app(arguments)<font></font>
    client = <span class="hljs-keyword">await</span> aiohttp_client(app, server_kwargs={
        <span class="hljs-string">'port'</span>: arguments.api_port<font></font>
    })<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> client
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> client.close()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, si especifica la fijación en los parámetros de prueba </font></font><code>api_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sucederá lo siguiente:</font></font><br>
<br>
<ol>
<li> <code>postgres</code>    (  <code>migrated_postgres</code>).</li>
<li> <code>alembic_config</code>    Alembic,      (  <code>migrated_postgres</code>).</li>
<li> <code>migrated_postgres</code>   (  <code>arguments</code>).</li>
<li> <code>aiomisc_unused_port</code>    (  <code>arguments</code>).</li>
<li> <code>arguments</code>     (  <code>api_client</code>).</li>
<li> <code>api_client</code>          .</li>
<li> .</li>
<li> <code>api_client</code>     .</li>
<li> <code>postgres</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los accesorios le permiten evitar la duplicación de código, pero además de preparar el entorno en las pruebas, hay otro lugar potencial en el que habrá una gran cantidad del mismo código: solicitudes de solicitud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primero, al hacer una solicitud, esperamos obtener un cierto estado HTTP. En segundo lugar, si el estado coincide con el esperado, antes de trabajar con los datos, debe asegurarse de que tengan el formato correcto. Aquí es fácil cometer un error y escribir un controlador que haga los cálculos correctos y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devuelva el resultado correcto, pero no pase la validación automática debido al formato de respuesta incorrecto</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (por ejemplo, olvide envolver la respuesta en un diccionario con una clave </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Todos estos controles podrían hacerse en un solo lugar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el modulo</font></font><code>analyzer.testing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> He preparado para cada controlador una función auxiliar que verifica el estado de HTTP, así como el formato de respuesta usando Marshmallow. </font></font><br>
<br>
<a name="test_citizens_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / ciudadanos</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidí comenzar con un controlador que devuelva residentes, porque es muy útil para verificar los resultados de otros controladores que cambian el estado de la base de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intencionalmente no utilicé código que agrega datos a la base de datos desde el controlador </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, aunque no es difícil convertirlo en una función separada. </font><font style="vertical-align: inherit;">El código del controlador tiene la propiedad de cambiar, y si hay algún error en el código que se agrega a la base de datos, existe la posibilidad de que la prueba deje de funcionar según lo previsto e implícitamente para los desarrolladores dejarán de mostrar errores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para esta prueba, definí los siguientes conjuntos de datos de prueba:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga con varios familiares. </font><font style="vertical-align: inherit;">Comprueba que para cada residente se formará correctamente una lista con identificadores de familiares.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga con un residente sin parientes. </font><font style="vertical-align: inherit;">Comprueba que el campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es una lista vacía (debido </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a la consulta SQL, la lista de parientes puede ser igual </font></font><code>[None]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga con un residente que es un pariente suyo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga vacía. </font><font style="vertical-align: inherit;">Comprueba que el controlador permite agregar descargas vacías y no se bloquea con un error.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para ejecutar la misma prueba por separado en cada carga, utilicé otro mecanismo pytest muy poderoso: la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parametrización</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Este mecanismo le permite ajustar la función de prueba en el decorador </font></font><code>pytest.mark.parametrize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y describir en ella qué parámetros debe tomar la función de prueba para cada caso de prueba individual.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cómo parametrizar una prueba</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
datasets = [<font></font>
    <span class="hljs-comment">#    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">3</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   </span><font></font>
    [<font></font>
        generate_citizen(relatives=[])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   ,    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, name=<span class="hljs-string">''</span>, gender=<span class="hljs-string">'male'</span>,<font></font>
                         birth_date=<span class="hljs-string">'17.02.2020'</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    [],<font></font>
]<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.mark.parametrize('dataset', datasets)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_citizens</span>(<span class="hljs-params">api_client, dataset</span>):</span>
    <span class="hljs-string">"""
        4 ,    
    """</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, la prueba agregará la carga a la base de datos, luego, mediante una solicitud al controlador, recibirá información sobre los residentes y comparará la carga de referencia con la recibida. Pero, ¿cómo se compara a los residentes? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada residente consta de campos escalares y un campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, una lista de identificadores de parientes. Una lista en Python es un tipo ordenado, y al comparar el orden de los elementos de cada lista sí importa, pero al comparar listas con hermanos, el orden no debería importar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si lleva </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al conjunto antes de la comparación, al compararlo no funciona para encontrar una situación en la que uno de los habitantes del campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tenga duplicados. Si ordena la lista con los identificadores de parientes, esto evitará el problema del diferente orden de los identificadores de parientes, pero al mismo tiempo detectará duplicados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al comparar dos listas con residentes, uno puede encontrar un problema similar: técnicamente, el orden de los residentes en la descarga no es importante, pero es importante detectar si hay dos residentes con los mismos identificadores en una descarga y no en la otra. </font><font style="vertical-align: inherit;">Entonces, además de organizar la lista con parientes, los parientes de cada residente deben organizar a los residentes en cada descarga. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como la tarea de comparar residentes surgirá más de una vez, implementé dos funciones: una para comparar dos residentes y la segunda para comparar dos listas con residentes:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compara residentes</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Iterable, Mapping<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize_citizen</span>(<span class="hljs-params">citizen</span>):</span>
    <span class="hljs-string">"""
         
    """</span>
    <span class="hljs-keyword">return</span> {**citizen, <span class="hljs-string">'relatives'</span>: sorted(citizen[<span class="hljs-string">'relatives'</span>])}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizens</span>(<span class="hljs-params">left: Mapping, right: Mapping</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
      
    """</span>
    <span class="hljs-keyword">return</span> normalize_citizen(left) == normalize_citizen(right)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizen_groups</span>(<span class="hljs-params">left: Iterable, right: Iterable</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
          ,   
      
    """</span>
    left = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> left]<font></font>
    left.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])<font></font>
<font></font>
    right = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> right]<font></font>
    right.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])
    <span class="hljs-keyword">return</span> left == right
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para asegurarme de que este controlador no regrese a los residentes de otras descargas, decidí agregar una descarga adicional con un habitante antes de cada prueba.</font></font><br>
<br>
<a name="test_imports_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importaciones</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Definí los siguientes conjuntos de datos para probar el controlador:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datos correctos, que se espera agregar con éxito a la base de datos.</font></font></b><br>
 <br>
<ul>
<li>    ( ).<br>
<br>
      .    ,     ,    insert    ,    .</li>
<li>   ( , ).<br>
<br>
,            .<br>
 </li>
<li>    .<br>
<br>
     ,       . :)<br>
 </li>
<li>    <br>
<br>
,  aiohttp             PostgreSQL    32 767  (    ).<br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga vacía </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador debe tener en cuenta este caso y no caerse, intentando realizar una inserción vacía en la tabla con los habitantes.</font></font><br>
 </li>
</ul><br>
 </li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datos con errores, espere una respuesta HTTP de 400: Solicitud incorrecta.</font></font></b><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fecha de nacimiento es incorrecta (tiempo futuro).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citizen_id no es único dentro de la carga.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un parentesco se indica incorrectamente (solo hay de un residente a otro, pero no hay comentarios).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El residente tiene un pariente inexistente en la descarga.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los lazos familiares no son únicos.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si el procesador funcionó correctamente y se agregaron los datos, debe agregar los residentes a la base de datos y compararlos con la descarga estándar. </font><font style="vertical-align: inherit;">Para conseguir residentes, utilicé el controlador ya probado </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y, para comparar, una función </font></font><code>compare_citizen_groups</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="test_update_citizen_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PARCHE / importaciones / $ import_id / ciudadanos / $ citizen_id</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La validación de los datos es similar en muchos aspectos a la descrita en el controlador </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con algunas excepciones: solo hay un residente y el cliente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puede pasar </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">los campos que desee</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidí usar los siguientes conjuntos con datos incorrectos para verificar que el controlador devolverá una respuesta HTTP </font></font><code>400: Bad request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El campo está especificado, pero tiene un tipo o formato de datos incorrecto</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fecha de nacimiento es incorrecta (hora futura).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contiene un pariente que no existe en la descarga.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
También es necesario verificar que el controlador actualice correctamente la información sobre el residente y sus familiares. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer esto, cree una carga con tres habitantes, dos de los cuales son parientes, y envíe una solicitud con nuevos valores para todos los campos escalares y un nuevo identificador relativo en el campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para asegurarme de que el controlador distinga entre los residentes de diferentes descargas antes de la prueba (y, por ejemplo, no cambia a los residentes con los mismos identificadores de otra descarga), creé una descarga adicional con tres residentes que tienen los mismos identificadores.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador debe guardar los nuevos valores de los campos escalares, agregar un nuevo pariente especificado y eliminar la relación con un pariente antiguo no especificado. </font><font style="vertical-align: inherit;">Todos los cambios en el parentesco deben ser bilaterales. </font><font style="vertical-align: inherit;">No debe haber cambios en otras descargas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que dicho controlador puede estar sujeto a condiciones de carrera (esto se discutió en la sección Desarrollo), agregué </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dos pruebas adicionales</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Uno reproduce el problema con el estado de la carrera (extiende la clase de controlador y elimina el bloqueo), el segundo prueba que el problema con el estado de la carrera no se reproduce.</font></font><br>
<br>
<a name="test_citizen_birthdays_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importaciones / $ import_id / ciudadanos / cumpleaños</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para probar este controlador, seleccioné los siguientes conjuntos de datos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una descarga en la que un residente tiene un pariente en un mes y dos parientes en otro.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga con un residente sin parientes. </font><font style="vertical-align: inherit;">Comprueba que el controlador no lo tenga en cuenta en los cálculos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga vacía. </font><font style="vertical-align: inherit;">Comprueba que el controlador no fallará y devolverá el diccionario correcto con 12 meses en la respuesta.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga con un residente que es un pariente suyo. </font><font style="vertical-align: inherit;">Comprueba que un residente comprará un regalo para el mes de su nacimiento.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador debe devolver todos los meses en la respuesta, incluso si no hay cumpleaños en estos meses. </font><font style="vertical-align: inherit;">Para evitar la duplicación, hice una función a la que puedes pasar el diccionario para que lo complemente con valores para los meses que faltan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para asegurarme de que el controlador distinga entre residentes de diferentes descargas, agregué una descarga adicional con dos parientes. </font><font style="vertical-align: inherit;">Si el controlador los usa por error en los cálculos, los resultados serán incorrectos y el controlador caerá con un error.</font></font><br>
<br>
<a name="test_town_age_stat_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentil / age</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La peculiaridad de esta prueba es que los resultados de su trabajo dependen de la hora actual: la edad de los habitantes se calcula en función de la fecha actual. </font><font style="vertical-align: inherit;">Para garantizar que los resultados de la prueba no cambien con el tiempo, se debe registrar la fecha actual, las fechas de nacimiento de los residentes y los resultados esperados. </font><font style="vertical-align: inherit;">Esto facilitará la reproducción de cualquier caso, incluso borde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Cuál es la mejor fecha de reparación? </font><font style="vertical-align: inherit;">El controlador utiliza la función PostgreSQL para calcular la edad de los residentes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>AGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que toma el primer parámetro como la fecha para la que es necesario calcular la edad y el segundo como la fecha base (definida por una constante </font></font><code>TownAgeStatView.CURRENT_DATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reemplazamos la fecha base en el controlador con el tiempo de prueba</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@patch('analyzer.api.handlers.TownAgeStatView.CURRENT_DATE', new=CURRENT_DATE)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_ages</span>(<span class="hljs-params">...</span>):</span>
    ...</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para probar el controlador, seleccioné los siguientes conjuntos de datos (para todos los residentes indiqué una ciudad, porque el controlador agrega los resultados por ciudad):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga con varios residentes cuyo cumpleaños es mañana (edad - varios años y 364 días). </font><font style="vertical-align: inherit;">Comprueba que el procesador usa solo la cantidad de años completos en los cálculos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descargar con un residente cuyo cumpleaños es hoy (edad, exactamente unos pocos años). </font><font style="vertical-align: inherit;">Comprueba el caso regional: la edad de un residente cuyo cumpleaños es hoy no debe calcularse como reducida en 1 año.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga vacía. </font><font style="vertical-align: inherit;">El controlador no debe caer sobre él.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El </font></font><code>numpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">punto </font><font style="vertical-align: inherit;">de </font><font style="vertical-align: inherit;">referencia </font><font style="vertical-align: inherit;">para calcular percentiles, </font><font style="vertical-align: inherit;">con interpolación lineal, y los resultados de referencia para las pruebas que calculé para ellos. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
También debe redondear los valores de percentiles fraccionarios a dos decimales. </font><font style="vertical-align: inherit;">Si usó PostgreSQL para redondear en el controlador y Python para calcular los datos de referencia, puede notar que el </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redondeo en Python 3 y PostgreSQL puede dar resultados diferentes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por ejemplo</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs"># Python 3<font></font>
round(2.5)<font></font>
&gt; 2<font></font>
<font></font>
-- PostgreSQL<font></font>
SELECT ROUND(2.5)<font></font>
&gt; 3<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El hecho es que Python usa redondeo bancario </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">al par más cercano</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y PostgreSQL </font><font style="vertical-align: inherit;">usa </font><font style="vertical-align: inherit;">matemático (medio arriba). </font><font style="vertical-align: inherit;">En caso de que los cálculos y el redondeo se realicen en PostgreSQL, también sería correcto usar el redondeo matemático en las pruebas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al principio describí conjuntos de datos con fechas de nacimiento en formato de texto, pero fue inconveniente leer una prueba en este formato: cada vez que tenía que calcular la edad de cada habitante en mi mente para recordar lo que estaba comprobando un conjunto de datos en particular. </font><font style="vertical-align: inherit;">Por supuesto, podría pasar con los comentarios en el código, pero decidí ir un poco más allá y escribí una función </font></font><code>age2date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que le permite describir la fecha de nacimiento en forma de edad: la cantidad de años y días.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por ejemplo, así</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">age2date</span>(<span class="hljs-params">years: int, days: int = <span class="hljs-number">0</span>, base_date=CURRENT_DATE</span>) -&gt; str:</span><font></font>
    birth_date = copy(base_date).replace(year=base_date.year - years)<font></font>
    birth_date -= timedelta(days=days)<font></font>
    <span class="hljs-keyword">return</span> birth_date.strftime(BIRTH_DATE_FORMAT)<font></font>
<font></font>
<span class="hljs-comment">#    ?  ,     ?</span>
generate_citizen(birth_date=<span class="hljs-string">'17.02.2009'</span>)<font></font>
<font></font>
<span class="hljs-comment">#   11       </span>
generate_citizen(birth_date=age2date(years=<span class="hljs-number">11</span>))
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para asegurarme de que el controlador distinga entre residentes de diferentes descargas, agregué una descarga adicional con un residente de otra ciudad: si el controlador lo usa por error, aparecerá una ciudad adicional en los resultados y la prueba se interrumpirá.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un hecho interesante: cuando escribí esta prueba el 29 de febrero de 2020, de repente dejé de generar descargas con los residentes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debido a un error en Faker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2020 es un año bisiesto, y otros años que Faker eligió no siempre fueron años bisiestos en ellos también no fue el 29 de febrero). </font><font style="vertical-align: inherit;">¡Recuerde registrar fechas y probar casos límite!</font></font></blockquote><br>
<a name="test_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migraciones</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El código de migración a primera vista parece obvio y menos propenso a errores, ¿por qué probarlo? Este es un error muy peligroso: los errores más insidiosos de las migraciones pueden manifestarse en el momento más inoportuno. Incluso si no estropean los datos, pueden causar tiempos de inactividad innecesarios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La </font><font style="vertical-align: inherit;">migración </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inicial</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> existente en el proyecto </font><font style="vertical-align: inherit;">cambia la estructura de la base de datos, pero no cambia los datos. ¿Qué errores comunes pueden protegerse de tales migraciones?</font></font><br>
<br>
<ul>
<li>  <code>downgrade</code>           (     ,      ,     ).<br>
<br>
   ,        (--):         ,        —    .<br>
 </li>
<li>C   .</li>
<li>    ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mayoría de estos errores serán detectados por la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prueba de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">escalera</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Su idea - para usar una sola migración, realizando constantemente los métodos </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para cada migración. </font><font style="vertical-align: inherit;">Tal prueba es suficiente para agregarse al proyecto una vez, no requiere soporte y servirá fielmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero si la migración, además de la estructura, cambiara los datos, entonces sería necesario escribir al menos una prueba separada, verificando que los datos cambien correctamente en el método </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y vuelvan al estado inicial </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Por las dudas: un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proyecto con ejemplos de pruebas de diferentes migraciones</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que preparé para un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">informe sobre Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en Moscú Python.</font></font><br>
<br>
<a name="build"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montaje</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El artefacto final que vamos a implementar y que queremos obtener como resultado del ensamblaje es una imagen de Docker. Para construir, debe </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">seleccionar la imagen base</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con Python. La imagen oficial </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>python:latest</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pesa ~ 1 GB y, si se usa como imagen base, la imagen con la aplicación será enorme. Hay </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imágenes basadas en el sistema operativo Alpine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cuyo tamaño es mucho más pequeño. Pero con el creciente número de paquetes instalados, el tamaño de la imagen final crecerá y, como resultado, incluso la imagen recopilada en base a Alpine no será tan pequeña. Elegí </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">snakepacker / python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como imagen base </font><font style="vertical-align: inherit;">: pesa un poco más que las imágenes Alpine, pero se basa en Ubuntu, que ofrece una gran selección de paquetes y bibliotecas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De otra manera</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduzca el tamaño de la imagen con la aplicación</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : no incluya en la imagen final el compilador, las bibliotecas y los archivos con encabezados para el ensamblaje, que no son necesarios para que la aplicación funcione. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer esto, puede usar el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ensamblaje de varias etapas de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Docker:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando una imagen "pesada" </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 1 GB, ~ 500 MB comprimidos), cree un entorno virtual, instale todas las dependencias y el paquete de la aplicación. </font><font style="vertical-align: inherit;">Esta imagen se necesita exclusivamente para el ensamblaje, puede contener un compilador, todas las bibliotecas y archivos necesarios con encabezados.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#   </span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/*</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copiamos el entorno virtual terminado en una imagen "ligera" </font></font><code>snakepacker/python:3.8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 100 MB, comprimida ~ 50 MB), que contiene solo el intérprete de la versión requerida de Python. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Importante: en un entorno virtual, se utilizan rutas absolutas, por lo que debe copiarse en la misma dirección en la que se ensambló en el contenedor del recopilador.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#       builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reducir el tiempo que lleva construir la imagen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , los módulos dependientes de la aplicación pueden instalarse antes de instalarse en el entorno virtual. </font><font style="vertical-align: inherit;">Luego, Docker los almacenará en caché y no se reinstalará si no han cambiado.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile por completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">###############      ################</span>
<span class="hljs-comment">#  — «» (~1 ,    ~500 )    </span>
<span class="hljs-comment">#    </span>
FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#      pip</span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
RUN /usr/share/python3/app/bin/pip install -U pip<font></font>
<font></font>
<span class="hljs-comment">#   ,  .   </span>
<span class="hljs-comment"># Docker   ,  requirements.txt  </span><font></font>
COPY requirements.txt /mnt/<font></font>
RUN /usr/share/python3/app/bin/pip install -Ur /mnt/requirements.txt<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/* \<font></font>
    &amp;&amp; /usr/share/python3/app/bin/pip check<font></font>
<font></font>
<span class="hljs-comment">###########################   ############################</span>
<span class="hljs-comment">#    «» (~100 ,    ~50 )   Python</span>
FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#         builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para facilitar el montaje, agregué un comando </font></font><code>make upload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que recopila la imagen de Docker y la carga en hub.docker.com.</font></font><br>
<br>
<a name="ci"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora que el código está cubierto con pruebas y podemos construir una imagen de Docker, es hora de automatizar estos procesos. Lo primero que viene a la mente: ejecute pruebas para crear solicitudes de grupo y, cuando agregue cambios a la rama maestra, recopile una nueva imagen de Docker y cárguela en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">paquetes de GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , si no va a distribuir la imagen públicamente). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resolví este problema con las </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acciones de GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Para hacer esto, era necesario crear un archivo YAML en una carpeta </font></font><code>.github/workflows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y describir en él un flujo de trabajo (con dos tareas: </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que nombré </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tarea </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se ejecuta cada vez que se inicia el flujo de trabajo </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, utilizando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servicios</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recoge un contenedor con PostgreSQL, espera a que esté disponible y se inicia </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el contenedor </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tarea </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se realiza solo si los cambios se han agregado a la rama </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y si la tarea </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fue exitosa. </font><font style="vertical-align: inherit;">Ella recopila la distribución de origen por el contenedor </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, luego recopila y carga la imagen de Docker </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>docker/build-push-action@v1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descripción completa del flujo de trabajo.</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">name: CI<font></font>
<font></font>
# Workflow      <font></font>
#   -  master<font></font>
on:<font></font>
  push:<font></font>
    branches: [ master ]<font></font>
  pull_request:<font></font>
    branches: [ master ]<font></font>
<font></font>
jobs:<font></font>
  #       workflow<font></font>
  test:<font></font>
    runs-on: ubuntu-latest<font></font>
<font></font>
    services:<font></font>
      postgres:<font></font>
        image: docker://postgres<font></font>
        ports:<font></font>
          - 5432:5432<font></font>
        env:<font></font>
          POSTGRES_USER: user<font></font>
          POSTGRES_PASSWORD: hackme<font></font>
          POSTGRES_DB: analyzer<font></font>
<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: test<font></font>
        uses: docker://snakepacker/python:all<font></font>
        env:<font></font>
          CI_ANALYZER_PG_URL: postgresql://user:hackme@postgres/analyzer<font></font>
        with:<font></font>
          args: /bin/bash -c "pip install -U '.[dev]' &amp;&amp; pylama &amp;&amp; wait-for-port postgres:5432 &amp;&amp; pytest -vv --cov=analyzer --cov-report=term-missing tests"<font></font>
<font></font>
  #    Docker-  <font></font>
  publish:<font></font>
    #        master<font></font>
    if: github.event_name == 'push' &amp;&amp; github.ref == 'refs/heads/master'<font></font>
    # ,   test   <font></font>
    needs: test<font></font>
    runs-on: ubuntu-latest<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: sdist<font></font>
        uses: docker://snakepacker/python:all<font></font>
        with:<font></font>
          args: make sdist<font></font>
<font></font>
      - name: build-push<font></font>
        uses: docker/build-push-action@v1<font></font>
        with:<font></font>
          username: ${{ secrets.REGISTRY_LOGIN }}<font></font>
          password: ${{ secrets.REGISTRY_TOKEN }}<font></font>
          repository: alvassin/backendschool2019<font></font>
          target: api<font></font>
          tags: 0.0.1, latest<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, al agregar cambios al maestro en la pestaña Acciones en GitHub, puede ver el inicio de las pruebas, el ensamblaje y la carga de la imagen de Docker: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/qx/pm/r5qxpmy7mlttqniibfvxadvzitw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
y al crear una solicitud de grupo en la rama maestra, los resultados de la tarea también se mostrarán en ella </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pz/d9/nk/pzd9nkmxq7a75fnlcw2tx37i308.png"><br>
<br>
<a name="deployment"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desplegar</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implementar la aplicación en el servidor proporcionado, debe instalar Docker, Docker Compose, iniciar los contenedores con la aplicación y PostgreSQL y aplicar las migraciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estos pasos pueden automatizarse utilizando el sistema de gestión de configuración de Ansible. Está escrito en Python, no requiere agentes especiales (se conecta directamente a través de ssh), utiliza plantillas jinja y permite describir declarativamente el estado deseado en los archivos YAML. El enfoque declarativo le permite no pensar en el estado actual del sistema y las acciones necesarias para llevar el sistema al estado deseado. Todo este trabajo descansa sobre los hombros de los módulos Ansible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ansible le permite agrupar tareas relacionadas lógicamente en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">roles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y luego reutilizarlas. Necesitaremos dos roles:</font></font><code>docker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(instala y configura Docker) y </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(instala y configura la aplicación). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El rol</font></font><code>docker</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> agrega un repositorio con Docker al sistema, instala y configura paquetes </font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Opcionalmente, puede configurar la API REST para que se reanude automáticamente después de reiniciar el servidor. Ubuntu le permite resolver este problema con la ayuda de un sistema de inicialización </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>systemd</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Controla unidades que representan varios recursos (demonios, sockets, puntos de montaje y otros). Para agregar una nueva unidad a systemd, debe describir su configuración en un archivo .service separado y colocar este archivo en una de las carpetas especiales, por ejemplo, en </font></font><code>/etc/systemd/system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Luego se puede iniciar la unidad, así como habilitar la carga automática para ella. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paquete</font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">durante la instalación, creará automáticamente un archivo con la configuración de la unidad; solo necesita asegurarse de que se está ejecutando y se enciende cuando se inicia el sistema. </font><font style="vertical-align: inherit;">Para Docker Compose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>  docker-compose@.service</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">será creado por Ansible. </font><font style="vertical-align: inherit;">El símbolo </font></font><code>@</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el nombre indica a systemd que la unidad es una plantilla. </font><font style="vertical-align: inherit;">Esto le permite iniciar el servicio </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con un parámetro, por ejemplo, con el nombre de nuestro servicio, que se sustituirá </font></font><code>%i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el archivo de configuración de la unidad:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=%i service with docker compose<font></font>
Requires=docker.service<font></font>
After=docker.service<font></font>
<font></font>
[Service]<font></font>
Type=oneshot<font></font>
RemainAfterExit=true<font></font>
WorkingDirectory=/etc/docker/compose/%i<font></font>
ExecStart=/usr/local/bin/docker-compose up -d --remove-orphans<font></font>
ExecStop=/usr/local/bin/docker-compose down<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El rol</font></font><code>analyzer</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> generará un archivo desde la plantilla </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la dirección </font></font><code>/etc/docker/compose/analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, registrará la aplicación como un servicio lanzado automáticamente </font></font><code>systemd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y aplicará la migración. </font><font style="vertical-align: inherit;">Cuando los roles estén listos, debe describir el libro de jugadas.</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: Gathering facts<font></font>
  hosts: all<font></font>
  become: yes<font></font>
  gather_facts: yes<font></font>
<font></font>
- name: Install docker<font></font>
  hosts: docker<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - docker<font></font>
<font></font>
- name: Install analyzer<font></font>
  hosts: api<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La lista de hosts, así como las variables utilizadas en los roles, se pueden especificar en el archivo de inventario </font></font><code>hosts.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">[api]<font></font>
130.193.51.154<font></font>
<font></font>
[docker:children]<font></font>
api<font></font>
<font></font>
[api:vars]<font></font>
analyzer_image = alvassin/backendschool2019<font></font>
analyzer_pg_user = user<font></font>
analyzer_pg_password = hackme<font></font>
analyzer_pg_dbname = analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de que todos los archivos Ansible estén listos, ejecútelos:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ansible-playbook -i hosts.ini deploy.yml</code></pre><br>
<a name="load_testing"></a><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre pruebas de estrés</font></font></b>
                        <div class="spoiler_text">,   ,     .      ,      -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>.     :      ,    —   ,         10 . ,         (, ,   CI-):           .<br>
<br>
,     ,      ,        10 .   ?  ,          ,   .  ,     ,       .<br>
<br>
          RPS,      :      . ,    ,     <code>import_id</code>,    <code>POST /imports</code>      .      . <br>
<br>
,       Python 3,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Locust</a>. <br>
<br>
   ,      <code>locustfile.py</code>     <code>locust</code>.         -     .<br>
<br>
 Locust   .    ,        .       <br>
 <code>self.round</code>           .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    locustfile.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># locustfile.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> http <span class="hljs-keyword">import</span> HTTPStatus<font></font>
<font></font>
<span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpLocust, constant, task, TaskSet
<span class="hljs-keyword">from</span> locust.exception <span class="hljs-keyword">import</span> RescheduleTask<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.handlers <span class="hljs-keyword">import</span> (<font></font>
    CitizenBirthdaysView, CitizensView, CitizenView, TownAgeStatView<font></font>
)<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen, generate_citizens, url_for<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnalyzerTaskSet</span>(<span class="hljs-params">TaskSet</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        super().__init__(*args, **kwargs)<font></font>
        self.round = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_dataset</span>(<span class="hljs-params">self</span>):</span><font></font>
        citizens = [<font></font>
            <span class="hljs-comment">#     .   </span>
            <span class="hljs-comment"># PATCH-  relatives    </span>
            <span class="hljs-comment"># ,     - </span>
            <span class="hljs-comment"># (     ,    </span>
            <span class="hljs-comment"># ).</span>
            generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>]),<font></font>
            generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
            *generate_citizens(citizens_num=<span class="hljs-number">9998</span>, relations_num=<span class="hljs-number">1000</span>,<font></font>
                               start_citizen_id=<span class="hljs-number">3</span>)<font></font>
        ]<font></font>
        <span class="hljs-keyword">return</span> {citizen[<span class="hljs-string">'citizen_id'</span>]: citizen <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> citizens}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">request</span>(<span class="hljs-params">self, method, path, expected_status, **kwargs</span>):</span>
        <span class="hljs-keyword">with</span> self.client.request(<font></font>
                method, path, catch_response=<span class="hljs-literal">True</span>, **kwargs<font></font>
        ) <span class="hljs-keyword">as</span> resp:
            <span class="hljs-keyword">if</span> resp.status_code != expected_status:<font></font>
                resp.failure(<span class="hljs-string">f'expected status <span class="hljs-subst">{expected_status}</span>, '</span>
                             <span class="hljs-string">f'got <span class="hljs-subst">{resp.status_code}</span>'</span>)<font></font>
            logging.info(<font></font>
                <span class="hljs-string">'round %r: %s %s, http status %d (expected %d), took %rs'</span>,<font></font>
                self.round, method, path, resp.status_code, expected_status,<font></font>
                resp.elapsed.total_seconds()<font></font>
            )<font></font>
            <span class="hljs-keyword">return</span> resp<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_import</span>(<span class="hljs-params">self, dataset</span>):</span>
        resp = self.request(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/imports'</span>, HTTPStatus.CREATED,<font></font>
                            json={<span class="hljs-string">'citizens'</span>: list(dataset.values())})
        <span class="hljs-keyword">if</span> resp.status_code != HTTPStatus.CREATED:
            <span class="hljs-keyword">raise</span> RescheduleTask
        <span class="hljs-keyword">return</span> resp.json()[<span class="hljs-string">'data'</span>][<span class="hljs-string">'import_id'</span>]<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_citizens</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizensView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_citizen</span>(<span class="hljs-params">self, import_id</span>):</span>
        url = url_for(CitizenView.URL_PATH, import_id=import_id, citizen_id=<span class="hljs-number">1</span>)<font></font>
        self.request(<span class="hljs-string">'PATCH'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/{citizen_id}'</span>,<font></font>
                     json={<span class="hljs-string">'relatives'</span>: [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>)]})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_birthdays</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizenBirthdaysView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/birthdays'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_town_stats</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(TownAgeStatView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/towns/stat/percentile/age'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @task</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">workflow</span>(<span class="hljs-params">self</span>):</span>
        self.round += <span class="hljs-number">1</span><font></font>
        dataset = self.make_dataset()<font></font>
<font></font>
        import_id = self.create_import(dataset)<font></font>
        self.get_citizens(import_id)<font></font>
        self.update_citizen(import_id)<font></font>
        self.get_birthdays(import_id)<font></font>
        self.get_town_stats(import_id)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsiteUser</span>(<span class="hljs-params">HttpLocust</span>):</span><font></font>
    task_set = AnalyzerTaskSet<font></font>
    wait_time = constant(<span class="hljs-number">1</span>)</code></pre></div>
                    </div><br>
 100  c  ,  ,        :<br>
<br>
<img src="https://habrastorage.org/webt/qx/ri/b3/qxrib3jily9gzmexxhupu35tipa.png"><br>
<br>
       ,           ( — 95 ,  — ).        .<br>
<br>
<img src="https://habrastorage.org/webt/dn/px/fn/dnpxfn5ly7vttziqnnfpvvdsl9g.png"><br>
<br>
      —     Ansible       ~20.15  ~20.30    Locust.<br>
<br>
<img src="https://habrastorage.org/webt/om/1e/ok/om1eoknqvzqmyez-plpgykhz8io.png"></div>
                    </div><br>
<a name="whatelse"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qué más se puede hacer?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La creación de perfiles de la aplicación mostró que aproximadamente una cuarta parte del tiempo total de ejecución de la consulta se gasta en serializar y deserializar JSON: hay muchos datos enviados y recibidos del servicio. </font><font style="vertical-align: inherit;">Estos procesos pueden acelerarse significativamente usando la biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orjson</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero el servicio tendrá que estar preparado un poco, </font></font><code>orjson</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no es un reemplazo </font></font><code>json</code> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
directo </font><font style="vertical-align: inherit;">para el módulo estándar. </font><font style="vertical-align: inherit;">Por lo general, la producción requiere varias copias del servicio para garantizar la tolerancia a fallas y hacer frente a la carga. </font><font style="vertical-align: inherit;">Para administrar un grupo de servicios, necesita una herramienta que muestre si una copia del servicio está "viva". </font><font style="vertical-align: inherit;">Este problema puede resolverse mediante un controlador </font></font><code>/health</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que sondee todos los recursos necesarios para el trabajo, en nuestro caso, una base de datos. </font><font style="vertical-align: inherit;">Si</font></font><code>SELECT 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejecutado en menos de un segundo, entonces el servicio está vivo. Si no, debes prestarle atención. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando una aplicación trabaja de manera muy intensiva con una red, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uvloop</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puede aumentar el rendimiento de manera </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">genial</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un factor importante es la legibilidad del código. Uno de mis colegas, Yuri Shikanov, escribió un módulo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que combina varias herramientas </font><font style="vertical-align: inherit;">para la verificación automática y la ejecución de código, que es fácil de agregar a un </font></font><code>pre-commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enlace Git, configurado con un solo archivo de configuración o variables de entorno. Gray le permite ordenar las importaciones ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isort</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), optimiza las expresiones de python según las nuevas versiones del lenguaje ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pyupgrade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), agrega comas al final de las llamadas a funciones, importaciones, listas, etc. (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add-trailing-comma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), y también cita a un solo formulario ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unificar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<a name="final"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* * *</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es todo para mí: desarrollamos, cubrimos con pruebas, ensamblamos e implementamos el servicio, y también realizamos pruebas de carga.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expresiones de gratitud</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me gustaría expresar mi profunda gratitud a los muchachos que se tomaron el tiempo para participar en la redacción de este artículo, para revisar el código, para presentar mis ideas y comentarios: a Maria Zelenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zelma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vladimir Solomatin </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leenr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anastasia Semenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">morkov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yuri Shikanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dizballanze</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Shushpanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mishush</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Mosein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavkazzz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y especialmente a Dmitry Orlov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orlovdl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es499518/index.html">La videoconferencia es ahora un mercado y nuevas tecnologías. Longrid, primera parte</a></li>
<li><a href="../es499522/index.html">Todas las innovaciones de Windows 10 2004 (20H1)</a></li>
<li><a href="../es499524/index.html">Quarkus: actualizaciones de la aplicación utilizando el ejemplo helloworld de JBoss EAP Quickstart</a></li>
<li><a href="../es499528/index.html">Un puente matemático "deslumbrante" que se extiende más allá del Gran Teorema de Fermat</a></li>
<li><a href="../es499532/index.html">Palabras en números: análisis de blog gratuito habravebinary con Yandex.Metrica</a></li>
<li><a href="../es499536/index.html">Growbox como método de conocerse</a></li>
<li><a href="../es499540/index.html">Cómo funciona la renderización de juegos en 3D: texturizado y filtrado de texturas</a></li>
<li><a href="../es499542/index.html">Top Fakapov Cyan</a></li>
<li><a href="../es499544/index.html">Aprende redes neuronales en Hojas de cálculo de Google</a></li>
<li><a href="../es499546/index.html">Desarrollo de firmware para una videocámara analógica EVR-Y2022F</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>