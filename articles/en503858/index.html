<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💳 🕴🏾 🦌 The book "Terraform: infrastructure at the code level" 🤙 👩🏿‍🤝‍👨🏻 ➿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, habrozhiteli! The book is intended for everyone who is responsible for the code already written. This applies to system administrators, operati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>The book "Terraform: infrastructure at the code level"</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/503858/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/el/eg/lp/eleglpt_bkgjd7cftgp1yrmg_gk.jpeg" align="left" alt="image"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, habrozhiteli! The book is intended for everyone who is responsible for the code already written. This applies to system administrators, operations specialists, release, SR, DevOps engineers, infrastructure developers, full-cycle developers, engineering team leaders and technical directors. Whatever your position, if you are involved in infrastructure, deploy code, configure servers, scale clusters, back up data, monitor applications and answer calls at three in the morning, this book is for you.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Together, these responsibilities are commonly referred to as operational activities (or system administration). </font><font style="vertical-align: inherit;">Previously, developers who knew how to write code but did not understand system administration were often met; </font><font style="vertical-align: inherit;">system administrators quite often came across without the ability to write code. </font><font style="vertical-align: inherit;">Once this separation was acceptable, but in the modern world, which can no longer be imagined without cloud computing and the DevOps movement, almost any developer needs administrative skills, and any system administrator must be able to program.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You will not only learn how to manage the infrastructure in the form of code using Terraform, but also learn how it fits into the overall concept of DevOps. </font><font style="vertical-align: inherit;">Here are some questions you can answer by reading this book.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why use IaC at all?</font></font></li>
<li>    , ,     ?</li>
<li>   Terraform, Chef, Ansible, Puppet, Salt, CloudFormation, Docker, Packer  Kubernetes?</li>
<li>   Terraform       ?</li>
<li>   Terraform,    ?</li>
<li>    Terraform,       ?</li>
<li>     Terraform?</li>
<li>  Terraform     ?</li>
<li>    Terraform   ?</li>
</ul><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    </b>
                        <div class="spoiler_text">    2017 .   2019-         ,      !                 .  ,        .<br>
<br>
        ,  ,     ,    Terraform,    .<br>
<br>
<ul>
<li>   Terraform.    ,   Terraform  0.8.     Terraform   0.12.       ,     .  ,   !</li>
<li>   .           Terraform.    , ,    ,  ,    ,  ,  ,    .</li>
<li>  .      Terraform   .  , ,               — ,      .</li>
<li>   .  8      ,      Terraform    . ,  ,      ,          : ,      .</li>
<li>HCL2.  Terraform 0.12   HCL   HCL2.        (       ${…}!),   ,     ,   null, for_each  for,    .          HCL2,         5  6.</li>
<li>   .  Terraform 0.9    .        Terraform    .  Terraform 0.9     ,       ;     0.10      .       3.</li>
<li>    Terraform.  Terraform 0.10         (    AWS, GCP, Azure  . .).         ,         .          terraform init  ,       .       2  7.</li>
<li>   .  2016   Terraform        (AWS, GCP  Azure).      100,  ,  ,   1.               (,     Alicloud, Oracle Cloud Infrastructure, VMware vSphere  .),       ,     (GitHub, GitLab  BitBucket),   (MySQL, PostreSQL  InfluxDB),     ( DataDog, New Relic  Grafana),   Kubernetes, Helm, Heroku, Rundeck  Rightscale   .  ,       : ,   AWS     ,        ,   CloudFormation!</li>
<li>  Terraform.  2017   HashiCorp    Terraform (registry.terraform.io) —  ,         Terraform,  .  2018          .  Terraform 0.11        .       « »  . 153.</li>
<li>  .  Terraform 0.9    :         ,    ,   errored.tfstate.  Terraform 0.12    .    ,            ,     .</li>
<li>   .      ,     (.  «  »  . 144),  « »         (,  «  Terraform»  . 242),  plan    apply (.  «  »  . 64),     create_before_destroy,    count,           (.  «»  . 160),    ,   provider   .</li>
</ul></div>
                    </div><br>
<h3>.    Terraform</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(much more attention is paid to the issues of automatic testing in the book later) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The DevOps world is full of different fears: everyone is afraid to allow things to work, lose data, or be hacked. When making any change, you always ask yourself what consequences it will have. Will it behave the same in all environments? Will it cause another outage? And, if that happens, how much will you have to stay at work this time to fix it? As the company grows, more is at stake, making the deployment process even worse and increasing the risk of errors. Many companies try to minimize this risk through less frequent deployments, but as a result, each individual deployment becomes larger and more prone to errors.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you manage your infrastructure in the form of code, you have a better way to minimize risks: tests. </font><font style="vertical-align: inherit;">Their goal is to give you enough confidence to make changes. </font><font style="vertical-align: inherit;">The key word here is confidence: no tests can guarantee no errors, so you are more likely to deal with probability. </font><font style="vertical-align: inherit;">If you can capture all of your infrastructure and deployment processes as code, you can test this code in a test environment. </font><font style="vertical-align: inherit;">If successful, there is a big chance that the same code will work in an industrial environment. </font><font style="vertical-align: inherit;">In a world of fear and uncertainty, high probability and confidence are expensive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this chapter, we will go through the process of testing infrastructure code, both manual and automatic, with an emphasis on the latter. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual tests:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">basics of manual testing;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cleaning up resources after tests.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automated tests:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unit tests;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">integration tests;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">end-to-end tests;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other testing approaches.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual tests</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When thinking about how to test Terraform code, it’s useful to draw some parallels with testing code written in general-purpose programming languages ​​such as Ruby. </font><font style="vertical-align: inherit;">Imagine you are writing a simple Ruby web server in the web-server.rb file:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebServer</span> &lt; <span class="hljs-title">WEBrick</span>::<span class="hljs-title">HTTPServlet</span>::<span class="hljs-title">AbstractServlet</span>
  <span class="hljs-title">def</span> <span class="hljs-title">do_GET</span>(<span class="hljs-title">request</span>, <span class="hljs-title">response</span>)
     <span class="hljs-title">case</span> <span class="hljs-title">request</span>.<span class="hljs-title">path</span>
     <span class="hljs-title">when</span> "/"
         <span class="hljs-title">response</span>.<span class="hljs-title">status</span> </span>= <span class="hljs-number">200</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Hello, World'</span>
     <span class="hljs-keyword">else</span>
         response.status = <span class="hljs-number">404</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Not Found'</span><font></font>
     end<font></font>
  end<font></font>
end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This code will return a 200 OK response with the body Hello, World for the URL /; </font><font style="vertical-align: inherit;">for any other address the answer will be 404. How would you test this code manually? </font><font style="vertical-align: inherit;">Typically, some more code is added to run the web server locally:</font></font><br>
<br>
<pre><code class="java hljs">#   ,      <font></font>
#  ,       <font></font>
<span class="hljs-keyword">if</span> __FILE__ == $<span class="hljs-number">0</span>
  #      <span class="hljs-number">8000</span>
  server = WEBrick::HTTPServer.new :Port =&gt; <span class="hljs-number">8000</span>
  server.mount <span class="hljs-string">'/'</span>, WebServer<font></font>
<font></font>
  #    Ctrl+C<font></font>
  trap <span class="hljs-string">'INT'</span> <span class="hljs-keyword">do</span> server.shutdown end<font></font>
<font></font>
  #  <font></font>
  server.start<font></font>
end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you run this file in the terminal, it will load the web server on port 8000:</font></font><br>
<br>
<pre><code class="java hljs">$ ruby web-server.rb<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick <span class="hljs-number">1.3</span><span class="hljs-number">.1</span>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO ruby <span class="hljs-number">2.3</span><span class="hljs-number">.7</span> (<span class="hljs-number">2018</span>-<span class="hljs-number">03</span>-<span class="hljs-number">28</span>) [universal.x86_64-darwin17]<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick::HTTPServer#start: pid=<span class="hljs-number">19767</span> port=<span class="hljs-number">8000</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To check the operation of this server, you can use the browser or curl:</font></font><br>
<br>
<pre><code class="java hljs">$ curl localhost:<span class="hljs-number">8000</span>/<font></font>
Hello, World<font></font>
<font></font>
$ curl localhost:<span class="hljs-number">8000</span>/invalid-path<font></font>
Not Found</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now imagine that we changed this code by adding an / api entry point to it that returns 201 Created and a body in JSON format:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebServer</span> &lt; <span class="hljs-title">WEBrick</span>::<span class="hljs-title">HTTPServlet</span>::<span class="hljs-title">AbstractServlet</span>
  <span class="hljs-title">def</span> <span class="hljs-title">do_GET</span>(<span class="hljs-title">request</span>, <span class="hljs-title">response</span>)
     <span class="hljs-title">case</span> <span class="hljs-title">request</span>.<span class="hljs-title">path</span>
     <span class="hljs-title">when</span> "/"
         <span class="hljs-title">response</span>.<span class="hljs-title">status</span> </span>= <span class="hljs-number">200</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Hello, World'</span>
     when <span class="hljs-string">"/api"</span>
         response.status = <span class="hljs-number">201</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'application/json'</span>
         response.body = <span class="hljs-string">'{"foo":"bar"}'</span>
     <span class="hljs-keyword">else</span>
         response.status = <span class="hljs-number">404</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Not Found'</span><font></font>
     end<font></font>
  end<font></font>
end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To manually test this updated code, press Ctrl + C and restart the web server by running the script again:</font></font><br>
<br>
<pre><code class="java hljs">$ ruby web-server.rb<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick <span class="hljs-number">1.3</span><span class="hljs-number">.1</span>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO ruby <span class="hljs-number">2.3</span><span class="hljs-number">.7</span> (<span class="hljs-number">2018</span>-<span class="hljs-number">03</span>-<span class="hljs-number">28</span>) [universal.x86_64-darwin17]<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick::HTTPServer#start: pid=<span class="hljs-number">19767</span> port=<span class="hljs-number">8000</span><font></font>
^C<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">15</span>:<span class="hljs-number">54</span>] INFO going to shutdown ...<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">15</span>:<span class="hljs-number">54</span>] INFO WEBrick::HTTPServer#start done.<font></font>
<font></font>
$ ruby web-server.rb<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick <span class="hljs-number">1.3</span><span class="hljs-number">.1</span>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO ruby <span class="hljs-number">2.3</span><span class="hljs-number">.7</span> (<span class="hljs-number">2018</span>-<span class="hljs-number">03</span>-<span class="hljs-number">28</span>) [universal.x86_64-darwin17]<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick::HTTPServer#start: pid=<span class="hljs-number">19767</span> port=<span class="hljs-number">8000</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To check the new version, you can again use the curl command:</font></font><br>
<br>
<pre><code class="java hljs">$ curl localhost:<span class="hljs-number">8000</span>/api<font></font>
{<span class="hljs-string">"foo"</span>:<span class="hljs-string">"bar"</span>}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual Testing Basics</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What will this kind of manual testing look like in Terraform? </font><font style="vertical-align: inherit;">For example, from the previous chapters, you still have the code for deploying ALB. </font><font style="vertical-align: inherit;">Here is a snippet of the modules / networking / alb / main.tf file:</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_lb"</span> <span class="hljs-string">"example"</span> {<font></font>
   name                     = <span class="hljs-keyword">var</span>.alb_name<font></font>
   load_balancer_type = <span class="hljs-string">"application"</span>
   subnets                  = <span class="hljs-keyword">var</span>.subnet_ids<font></font>
   security_groups      = [aws_security_group.alb.id]<font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_lb_listener"</span> <span class="hljs-string">"http"</span> {<font></font>
   load_balancer_arn = aws_lb.example.arn<font></font>
   port                      = local.http_port<font></font>
   protocol                = <span class="hljs-string">"HTTP"</span><font></font>
<font></font>
   #      <span class="hljs-number">404</span><font></font>
   default_action {<font></font>
      type = <span class="hljs-string">"fixed-response"</span><font></font>
<font></font>
      fixed_response {<font></font>
        content_type = <span class="hljs-string">"text/plain"</span>
        message_body = <span class="hljs-string">"404: page not found"</span>
        status_code = <span class="hljs-number">404</span><font></font>
      }<font></font>
    }<font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_security_group"</span> <span class="hljs-string">"alb"</span> {<font></font>
   name = <span class="hljs-keyword">var</span>.alb_name<font></font>
}<font></font>
<font></font>
# (...)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you compare this listing with Ruby code, you can see one pretty obvious difference: AWS ALB, target groups, listeners, security groups, and any other resources cannot be deployed on your own computer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The key conclusion about testing No. 1 follows from this: Terraform code testing cannot take place locally. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This applies not only to Terraform, but also to most IaC tools. The only practical way to do manual testing in Terraform is to deploy the code in a real environment (i.e. in AWS). In other words, independently launching the terraform apply and terraform destroy commands that you worked on while reading the book is manual testing in Terraform.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is one of the reasons why it is so important to have easy-to-deploy examples in the examples folder of each module (see chapter 6). </font><font style="vertical-align: inherit;">To test the alb module, the easiest way is to use the demo code that you created in examples / alb:</font></font><br>
<br>
<pre><code class="java hljs">provider <span class="hljs-string">"aws"</span> {<font></font>
   region = <span class="hljs-string">"us-east-2"</span><font></font>
<font></font>
   #     AWS  <span class="hljs-number">2</span>.x<font></font>
   version = <span class="hljs-string">"~&gt; 2.0"</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">module</span> <span class="hljs-string">"alb"</span> {<font></font>
    source = <span class="hljs-string">"../../modules/networking/alb"</span><font></font>
<font></font>
    alb_name = <span class="hljs-string">"terraform-up-and-running"</span>
    subnet_ids = data.aws_subnet_ids.<span class="hljs-keyword">default</span>.ids<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To deploy this example, you need to run the terraform apply command, as you have done repeatedly:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">$ terraform <span class="hljs-title">apply</span>

<span class="hljs-params">(...)</span>

Apply complete! Resources: 5 added, 0 changed, 0 destroyed.

Outputs:

alb_dns_name </span>= hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the end of the deployment, you can use a tool such as curl to, for example, make sure that ALB returns 404 by default:</font></font><br>
<br>
<pre><code class="java hljs">$ curl \<font></font>
   -s \<font></font>
   -o /dev/<span class="hljs-keyword">null</span> \<font></font>
   -w <span class="hljs-string">"%{http_code}"</span> \<font></font>
hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com<font></font>
<font></font>
<span class="hljs-number">404</span></code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infrastructure check</font></font><br>
<br>
      ,   HTTP, ,     ,   curl  HTTP-.        . ,        MySQL,       MySQL.      VPN-,      VPN.      ,      ,       SSH    - .    .   ,    ,      .       ,    .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let me remind you: ALB returns 404 due to the absence of other listener rules in the configuration, and the default action in the alb module has a response of 404:</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_lb_listener"</span> <span class="hljs-string">"http"</span> {<font></font>
   load_balancer_arn = aws_lb.example.arn<font></font>
   port                      = local.http_port<font></font>
   protocol                = <span class="hljs-string">"HTTP"</span><font></font>
<font></font>
   #      <span class="hljs-number">404</span><font></font>
   default_action {<font></font>
      type = <span class="hljs-string">"fixed-response"</span><font></font>
<font></font>
      fixed_response {<font></font>
       content_type = <span class="hljs-string">"text/plain"</span>
       message_body = <span class="hljs-string">"404: page not found"</span>
       status_code = <span class="hljs-number">404</span><font></font>
      }<font></font>
   }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, you already know how to run and test your code. </font><font style="vertical-align: inherit;">Now you can start making changes. </font><font style="vertical-align: inherit;">Every time you change something (so that, for example, the default action returns 401), you need to use the terraform apply command to deploy the new code:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">$ terraform <span class="hljs-title">apply</span>

<span class="hljs-params">(...)</span>

Apply complete! Resources: 0 added, 1 changed, 0 destroyed.

Outputs:

alb_dns_name </span>= hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To check the new version, you can restart curl:</font></font><br>
<br>
<pre><code class="java hljs">$ curl \<font></font>
   -s \<font></font>
   -o /dev/<span class="hljs-keyword">null</span> \<font></font>
   -w <span class="hljs-string">"%{http_code}"</span> \<font></font>
   hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com
<span class="hljs-number">401</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When done, run the terraform destroy command to remove the resources:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">$ terraform <span class="hljs-title">destroy</span>

<span class="hljs-params">(...)</span>

Apply complete! Resources: 0 added, 0 changed, 5 destroyed.</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In other words, when working with Terraform, every developer needs good code samples for testing and a real development environment (like an AWS account), which serves as the equivalent of a local computer and is used to run tests. In the manual testing process, you will most likely have to create and remove a large number of infrastructure components, and this can lead to many errors. In this regard, the environment should be completely isolated from more stable environments intended for final testing and in particular for industrial applications.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Given the above, I strongly recommend that each development team prepare an isolated environment in which you can create and remove any infrastructure without consequences. </font><font style="vertical-align: inherit;">To minimize the likelihood of conflicts between different developers (imagine that two developers are trying to create a load balancer with the same name), the ideal solution would be to give each team member a separate, completely isolated environment. </font><font style="vertical-align: inherit;">For example, if you use Terraform in conjunction with AWS, each developer should ideally have their own account where they can test everything they want.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resource cleanup after tests</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The presence of many isolated environments is necessary for high productivity of developers, but if you are not careful, you can accumulate a lot of extra resources that will clutter up all your environments and cost you a round sum. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To keep costs under control, regularly clean your isolated media. This is the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">key conclusion about testing number 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At a minimum, you should create such a culture in the team when, after testing, the developers delete everything that they deployed using the terraform destroy command. It may be possible to find tools for cleaning up excess or old resources that can be run on a regular basis (say, using cron). Here are some examples for different deployment environments.</font></font><br>
<br>
<ul>
<li>cloud-nuke (http://bit.ly/2OIgM9r).      ,         .        AWS ( Amazon EC2 Instances, ASG, ELB  . .).      (Google Cloud, Azure)   .    —    ,    . , cloud-nuke      cron,           .   ,   ,      ,      :<br>
<br>
<pre><code class="java hljs">$ cloud-nuke aws --older-than <span class="hljs-number">48</span>h</code></pre></li>
<li>Janitor Monkey (http://bit.ly/2M4GoLB).      ,   AWS  ,    (  —   ).    ,  ,    ,            .    Netflix Simian Army,      Chaos Monkey    .   ,    Simian Army    ,       : ,   Janitor Monkey   Swabbie (http://bit.ly/2OLrOLb).</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aws-nuke (http://bit.ly/2ZB8lOe). </font><font style="vertical-align: inherit;">This is an open source tool to delete all contents of an AWS account. </font><font style="vertical-align: inherit;">The accounts and resources to be deleted are specified in the configuration file in the YAML format:</font></font><br>
<br>
<pre><code class="java hljs">#   <font></font>
regions:<font></font>
- us-east-<span class="hljs-number">2</span><font></font>
<font></font>
#    <font></font>
accounts:<font></font>
   <span class="hljs-string">"111111111111"</span>: {}<font></font>
<font></font>
#    <font></font>
resource-types:<font></font>
   targets:<font></font>
   - S3Object<font></font>
   - S3Bucket<font></font>
   - IAMRole</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aws-nuke starts as follows:</font></font><br>
<br>
<pre><code class="java hljs">$ aws-nuke -<span class="hljs-number">5</span>c config.yml</code></pre></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automated Tests</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The concept of automatic testing is that tests are written to test the behavior of real code. </font><font style="vertical-align: inherit;">In Chapter 8, you will learn that using the CI server, these tests can be run after each individual commit. </font><font style="vertical-align: inherit;">If they are not completed, the fixation can immediately be undone or corrected. </font><font style="vertical-align: inherit;">Thus, your code will always be operational. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are three types of automated tests.</font></font><br>
<br>
<ul>
<li> .       — .    ,             .   (,  , -    )   mock-.       (, mock-     ,  )    ,        .</li>
<li> .      .          ,          .      mock-: ,     ,     ,      ,   , ,  ,  mock-.</li>
<li> .      (, ,  ,  )       .          : , Selenium        .         - mock-,          (        ,  ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each type of test has its own purpose, and with their help you can identify all kinds of errors, so they should be used together. Unit tests are fast and allow you to immediately get an idea of ​​the changes made and check a variety of combinations. This gives you confidence that the elementary components of your code (individual modules) behave as you expected. However, the fact that the modules work correctly separately does not mean at all that they can work together, therefore, to make sure that your elementary components are compatible, integration tests are needed. On the other hand, the correct behavior of different parts of the system does not guarantee that this system will work as it should after deployment in an industrial environment, so through tests are needed to test your code in conditions close to real ones.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
»More information about the book can be found on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the publisher’s website</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
» </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contents</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
» </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excerpt</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
For Khabrozhiteley 25% discount on coupon - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Upon payment of the paper version of the book, an electronic book is sent by e-mail.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en503842/index.html">Brain prosthesis: synchronization of artificial and biological neural networks</a></li>
<li><a href="../en503844/index.html">Speed ​​Up MatTable Rendering in Few Steps</a></li>
<li><a href="../en503846/index.html">Flash, “Whether he dies again is unknown, but the flowers disappear ...”</a></li>
<li><a href="../en503848/index.html">We invite you to free webinars on SLS printing on Sinterit 26.05 and 3D scanners Shining 28.05</a></li>
<li><a href="../en503854/index.html">Use SIL to the maximum</a></li>
<li><a href="../en503860/index.html">Setting up the neural network environment Mask R-CNN</a></li>
<li><a href="../en503862/index.html">Psychological problems as a payment for success in creating breakthrough products</a></li>
<li><a href="../es486176/index.html">Memo de correspondencia de correo electrónico corporativo</a></li>
<li><a href="../es486178/index.html">FOSS News No. 1 - revisión de noticias gratuitas y de código abierto del 27 de enero al 2 de febrero de 2020</a></li>
<li><a href="../es486180/index.html">Consejos y fuentes para crear aplicaciones sin servidor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>