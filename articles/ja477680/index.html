<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔷 🛌🏾 🕔 私たちの手は退屈ではありません：K8でルーククラスターを復元する 👎🏽 🔠 😕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="我々はすでにについて話しましたか/なぜルークのように：かなりの程度まで、それはKubernetesクラスター内のストレージでの作業が簡素化されます。ただし、この単純さのために、特定の困難が生じます。新しい資料が、そうした困難が顕在化する前に理解を深めるのに役立つことを期待しています。
 
 そして、...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>私たちの手は退屈ではありません：K8でルーククラスターを復元する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/477680/"><img src="https://habrastorage.org/webt/x_/rb/jm/x_rbjmnxk6egjidxf_fvk1otkqe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我々は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すでにについて話しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">か/なぜルークのように：かなりの程度まで、それはKubernetesクラスター内のストレージでの作業が簡素化されます。</font><font style="vertical-align: inherit;">ただし、この単純さのために、特定の困難が生じます。</font><font style="vertical-align: inherit;">新しい資料が、そうした困難が顕在化する前に理解を深めるのに役立つことを期待しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、それをもっと面白く読むため</font><font style="vertical-align: inherit;">に、クラスター内の架空の問題の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">から始め</font><font style="vertical-align: inherit;">ます。</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「すべてが失われています！」</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
K8sクラスターでRookを構成して起動したところ、彼は彼の仕事に満足していたと想像してみてください。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 新しいポッドはCephからのRBDイメージをマウントできません。</font></font></li>
<li>   <code>lsblk</code>  <code>df</code>     Kubernetes.   : «-  »     RBD-.    ,     …</li>
<li> ,     .   —    pod’  OSD,  pod’ MGR.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポッドは</font></font><code>rook-ceph-operator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いつ</font><font style="vertical-align: inherit;">発売されました</font><font style="vertical-align: inherit;">か？</font><font style="vertical-align: inherit;">彼が配備されたのはそれほど前のことではありません。</font><font style="vertical-align: inherit;">どうして？</font><font style="vertical-align: inherit;">Rookのオペレーターは、新しいクラスターを作成することを決定しました...クラスターとその中のデータをどのように復元できますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はじめに、</font><font style="vertical-align: inherit;">Rookの「内部」を慎重に調査し、そのコンポーネントの段階的な復元を実行して、</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もう少し</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">興味深い方法に</font><font style="vertical-align: inherit;">進みましょう</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">もちろん、</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より短い</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正しい方法</font><font style="vertical-align: inherit;">もあり</font><font style="vertical-align: inherit;">ます。バックアップを使用することです。</font><font style="vertical-align: inherit;">ご存知のように、管理者は2つのタイプに分けられます。バックアップを行わない管理者と、すでにバックアップを行っている管理者です。しかし、これについては調査後に詳しく説明します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少し練習、または長い道のり</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">見て、モニターを復元してください</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、ConfigMapのリストを見てみましょう</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">バックアップ</font></font><code>rook-ceph-config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とに</font><font style="vertical-align: inherit;">必要なものが</font><font style="vertical-align: inherit;">あり</font></font><code>rook-config-override</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。これらは、クラスターのデプロイメントが成功したときに表示されます。</font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：新しいバージョンでは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このPR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の採用後</font><font style="vertical-align: inherit;">、ConfigMapはクラスター展開の成功の指標ではなくなりました。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
さらにアクションを実行するには、マウントされたRBDイメージが存在するすべてのサーバーをハードリブートする必要があります（</font></font><code>ls /dev/rbd*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。これは、sysrq（またはデータセンターへの「徒歩」）で行う必要があります。この要件は、マウントされたRBDを切断するタスクが原因で発生します。このタスクでは、通常の再起動は機能しません（正常にアンマウントしようとすると失敗します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
劇場はハンガーで始まり、Cephクラスターはモニターで始まります。それらを見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rookは次のエンティティをモニターポッドにマウントします。</font></font><br>
<br>
<pre><code class="plaintext hljs">Volumes:<font></font>
 rook-ceph-config:<font></font>
   Type:      ConfigMap (a volume populated by a ConfigMap)<font></font>
   Name:      rook-ceph-config<font></font>
 rook-ceph-mons-keyring:<font></font>
   Type:        Secret (a volume populated by a Secret)<font></font>
   SecretName:  rook-ceph-mons-keyring<font></font>
 rook-ceph-log:<font></font>
   Type:          HostPath (bare host directory volume)<font></font>
   Path:          /var/lib/rook/kube-rook/log<font></font>
 ceph-daemon-data:<font></font>
   Type:          HostPath (bare host directory volume)<font></font>
   Path:          /var/lib/rook/mon-a/data<font></font>
Mounts:<font></font>
  /etc/ceph from rook-ceph-config (ro)<font></font>
  /etc/ceph/keyring-store/ from rook-ceph-mons-keyring (ro)<font></font>
  /var/lib/ceph/mon/ceph-a from ceph-daemon-data (rw)<font></font>
  /var/log/ceph from rook-ceph-log (rw)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
秘密が何であるか見てみましょう</font></font><code>rook-ceph-mons-keyring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Secret<font></font>
data:<font></font>
 keyring: LongBase64EncodedString=</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理者とモニターの権限を持つ通常のキーリングをデコードして取得します。</font></font><br>
<br>
<pre><code class="plaintext hljs">[mon.]<font></font>
       key = AQAhT19dlUz0LhBBINv5M5G4YyBswyU43RsLxA==<font></font>
       caps mon = "allow *"<font></font>
[client.admin]<font></font>
       key = AQAhT19d9MMEMRGG+wxIwDqWO1aZiZGcGlSMKp==<font></font>
       caps mds = "allow *"<font></font>
       caps mon = "allow *"<font></font>
       caps osd = "allow *"<font></font>
       caps mgr = "allow *"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
覚えておいてください。</font><font style="vertical-align: inherit;">秘密裏にキーリングを見てください</font></font><code>rook-ceph-admin-keyring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Secret<font></font>
data:<font></font>
 keyring: anotherBase64EncodedString=</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その中には何ですか？</font></font><br>
<br>
<pre><code class="plaintext hljs">[client.admin]<font></font>
       key = AQAhT19d9MMEMRGG+wxIwDqWO1aZiZGcGlSMKp==<font></font>
       caps mds = "allow *"<font></font>
       caps mon = "allow *"<font></font>
       caps osd = "allow *"<font></font>
       caps mgr = "allow *"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じ。</font><font style="vertical-align: inherit;">もっと見てみましょう...たとえば、ここに秘密があり</font></font><code>rook-ceph-mgr-a-keyring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます：</font></font><br>
<br>
<pre><code class="plaintext hljs">[mgr.a]<font></font>
       key = AQBZR19dbVeaIhBBXFYyxGyusGf8x1bNQunuew==<font></font>
       caps mon = "allow *"<font></font>
       caps mds = "allow *"<font></font>
       caps osd = "allow *"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最終的に、ConfigMapにはさらにいくつかの秘密があります</font></font><code>rook-ceph-mon</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: Secret<font></font>
data:<font></font>
 admin-secret: AQAhT19d9MMEMRGG+wxIwDqWO1aZiZGcGlSMKp==<font></font>
 cluster-name: a3ViZS1yb29r<font></font>
 fsid: ZmZiYjliZDMtODRkOS00ZDk1LTczNTItYWY4MzZhOGJkNDJhCg==<font></font>
 mon-secret: AQAhT19dlUz0LhBBINv5M5G4YyBswyU43RsLxA==</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、これはキーリング付きの最初のリストであり、上記のすべての秘密はここから得られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
知られているように（参照</font></font><code>dataDirHostPath</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">での</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメントを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、ルーク・ストアにそのようなデータを2つの場所で。</font><font style="vertical-align: inherit;">したがって、ノードに移動して、モニターとOSDを備えたポッドにマウントされているディレクトリにあるキーリングを確認します。</font><font style="vertical-align: inherit;">これを行うには、ノード</font></font><code>/var/lib/rook/mon-a/data/keyring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">見つけて次のよう</font><font style="vertical-align: inherit;">に表示します。</font></font><br>
<br>
<pre><code class="plaintext hljs"># cat /var/lib/rook/mon-a/data/keyring<font></font>
[mon.]<font></font>
       key = AXAbS19d8NNUXOBB+XyYwXqXI1asIzGcGlzMGg==<font></font>
       caps mon = "allow *"</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">突然、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">秘密は異なることが判明しました-ConfigMapとは異なります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理キーリングはどうですか？</font><font style="vertical-align: inherit;">私たちはそれも持っています：</font></font><br>
<br>
<pre><code class="plaintext hljs"># cat /var/lib/rook/kube-rook/client.admin.keyring<font></font>
[client.admin]<font></font>
       key = AXAbR19d8GGSMUBN+FyYwEqGI1aZizGcJlHMLgx= <font></font>
       caps mds = "allow *"<font></font>
       caps mon = "allow *"<font></font>
       caps osd = "allow *"<font></font>
       caps mgr = "allow *"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここに問題があります。</font><font style="vertical-align: inherit;">失敗がありました：クラスターが再作成されました...しかし実際にはそうではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しく生成されたキーリングがシークレットに保存されており</font><font style="vertical-align: inherit;">、古いクラスターの</font><font style="vertical-align: inherit;">ものでは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ない</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことが明らかになりました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">したがって：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モニターからファイル</font></font><code>/var/lib/rook/mon-a/data/keyring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（またはバックアップ）</font><font style="vertical-align: inherit;">からキーリングを取得します</font><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">秘密にキーリングを変更する</font></font><code>rook-ceph-mons-keyring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">管理者からキーリングを登録し、ConfigMapで監視します</font></font><code>rook-ceph-mon</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> モニター付きのポッドコントローラーを取り外します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
奇跡は長くはかからないでしょう：モニターが現れて起動します。</font><font style="vertical-align: inherit;">はじめまして！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSDを復元する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポッドに移動し</font></font><code>rook-operator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。呼び出し</font></font><code>ceph mon dump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、すべてのモニターが適切に配置されていることを示していますが、</font></font><code>ceph -s</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それらはクォーラムにあります。</font><font style="vertical-align: inherit;">ただし、OSD（</font></font><code>ceph osd tree</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">ツリー</font><font style="vertical-align: inherit;">を見ると、奇妙なことがわかります。OSDが表示され始めましたが、空です。</font><font style="vertical-align: inherit;">どういうわけかそれらも修復する必要があることがわかりました。</font><font style="vertical-align: inherit;">しかし、どうやって？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その間、ConfigMap'ahは私たち</font></font><code>rook-ceph-config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">や</font></font><code>rook-config-override</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">そしての</font><font style="vertical-align: inherit;">ような名前を持つ他の多くのConfigMap'ov </font><font style="vertical-align: inherit;">にとってとても必要</font><font style="vertical-align: inherit;">なように見えました</font></font><code>rook-ceph-osd-$nodename-config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">それらを見てみましょう：</font></font><br>
<br>
<pre><code class="plaintext hljs">kind: ConfigMap<font></font>
data:<font></font>
 osd-dirs: '{"/mnt/osd1":16,"/mnt/osd2":18}'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが間違っている、すべてが混同されている！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オペレーターポッドをゼロにスケーリングし、生成されたデプロイメントポッドをOSDから削除して、これらのConfigMapを修正します。</font><font style="vertical-align: inherit;">しかし、</font><font style="vertical-align: inherit;">ノードごと</font><font style="vertical-align: inherit;">に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正しい</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OSDマップを</font><font style="vertical-align: inherit;">どこで取得でき</font><font style="vertical-align: inherit;">ますか？</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><code>/mnt/osd[1-2]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノード</font><font style="vertical-align: inherit;">のディレクトリ</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">もう一度調べてみましょう</font><font style="vertical-align: inherit;">。そこで何かを把握できるように願っています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディレクトリに</font></font><code>/mnt/osd1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、2つのサブディレクトリが</font></font><code>osd0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あり</font></font><code>osd16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">最後の1つは、ConfigMap（16）で指定されたIDだけですか？</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイズを確認し、</font></font><code>osd0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それ以上の</font><font style="vertical-align: inherit;">ことを確認してください</font></font><code>osd16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul><br><font style="vertical-align: inherit;"></font><code>osd0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これが目的のOSDである</font><font style="vertical-align: inherit;">
と結論付けます。</font><font style="vertical-align: inherit;">これは</font></font><code>/mnt/osd1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ConfigMapで</font><font style="vertical-align: inherit;">指定され</font><font style="vertical-align: inherit;">たものです（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディレクトリベースの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> osdを使用しているため</font><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
段階的にすべてのノードをチェックし、ConfigMapを編集します。</font><font style="vertical-align: inherit;">すべての指示の後、Rookオペレーターのポッドを実行して、そのログを読み取ることができます。</font><font style="vertical-align: inherit;">そして、それらのすべてが素晴らしいです：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 私はクラスターオペレーターです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ノード上にドライブを見つけました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> モニターを見つけました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モニターが友達になった、つまり </font><font style="vertical-align: inherit;">定足数を形成しました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> OSD展開の実行...</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rookオペレーターのポッドに戻り、クラスターの活性を確認してみましょう...はい、一部のノードのOSD名に関する結論に少しミスをしました！</font><font style="vertical-align: inherit;">重要ではありません。彼らはConfigMapを再度修正し、新しいOSDから余分なディレクトリを削除して、待望の状態になりました</font></font><code>HEALTH_OK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プール内の画像を確認します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># rbd ls -p kube</span><font></font>
pvc-9cfa2a98-b878-437e-8d57-acb26c7118fb<font></font>
pvc-9fcc4308-0343-434c-a65f-9fd181ab103e<font></font>
pvc-a6466fea-bded-4ac7-8935-7c347cff0d43<font></font>
pvc-b284d098-f0fc-420c-8ef1-7d60e330af67<font></font>
pvc-b6d02124-143d-4ce3-810f-3326cfa180ae<font></font>
pvc-c0800871-0749-40ab-8545-b900b83eeee9<font></font>
pvc-c274dbe9-1566-4a33-bada-aabeb4c76c32<font></font>
…</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが整いました-クラスターが保存されます！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックアップ</font><font style="vertical-align: inherit;">をするのが</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">面倒</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rookのバックアップが行われた場合、回復手順ははるかに単純になり、要約すると次のようになります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rookオペレーターのデプロイメントをゼロにスケーリングします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rookオペレーターを除くすべてのデプロイメントを削除します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> すべてのシークレットとConfigMapをバックアップから復元します。</font></font></li>
<li><font style="vertical-align: inherit;"></font><code>/var/lib/rook/mon-*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノード上</font><font style="vertical-align: inherit;">のディレクトリの内容を復元し</font><font style="vertical-align: inherit;">ます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（あなたが突然失われた場合）CRDを復元し</font></font><code>CephCluster</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>CephFilesystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>CephBlockPool</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>CephNFS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>CephObjectStore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rookオペレーターのデプロイメントを1にスケーリングします。</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">役立つヒント</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バックアップを作成してください！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、それらから復元する必要がある状況を回避するには：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> サーバーの再起動で構成されるクラスターでの大規模な作業の前に、Rookオペレーターをゼロにスケーリングして、あまり実行しないようにします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モニターで、事前</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にnodeAffinity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">追加</font></a><font style="vertical-align: inherit;">し</font><font style="vertical-align: inherit;">ます。</font></font></li>
<li><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">事前設定されたタイムアウト</font></font></a> <code>ROOK_MON_HEALTHCHECK_INTERVAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とに</font><font style="vertical-align: inherit;">注意してください</font></font><code>ROOK_MON_OUT_TIMEOUT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論の代わりに</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rookが追加の「レイヤー」（Kubernetesでストレージを整理する一般的なスキーム）であることを主張する意味はありませんが、単純化すると、インフラストラクチャに新たな困難と潜在的な問題が追加されます。</font><font style="vertical-align: inherit;">事柄は「小さい」ままです。一方でこれらのリスクと、ソリューションが特定のケースでもたらすメリットとの間で情報に基づいた選択を行うことです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ちなみに、</font><font style="vertical-align: inherit;">「既存のRook Cephクラスターを新しいKubernetesクラスターに採用する」</font><font style="vertical-align: inherit;">という</font><font style="vertical-align: inherit;">セクション</font><font style="vertical-align: inherit;">が最近Rookのドキュメントに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追加されました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">既存のデータを新しいKubernetesクラスターに移動したり、何らかの理由で崩壊したクラスターを復元したりするために何をする必要があるかを詳しく説明します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのブログも読んでください：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルークかルークではないか-それが問題だ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」;</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Rook — „“    Kubernetes</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Longhorn,    K8s  Rancher,   CNCF</a>».</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">    provisioning  Kubernetes   Ceph</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja477668/index.html">11月29日午後6時-devleads-mitap</a></li>
<li><a href="../ja477670/index.html">テストを自動化するもの</a></li>
<li><a href="../ja477672/index.html">チームメンバーの権利と義務：法的および文化的側面</a></li>
<li><a href="../ja477674/index.html">AIは愛を意味しますか？</a></li>
<li><a href="../ja477678/index.html">ロシアのデジタルテレビの展望</a></li>
<li><a href="../ja477682/index.html">インフラストラクチャ内のレガシーサービス</a></li>
<li><a href="../ja477686/index.html">私たちのAIジャーニー会議</a></li>
<li><a href="../ja477688/index.html">12月のITイベントダイジェスト</a></li>
<li><a href="../ja477692/index.html">本番環境でZGCとShenandoah GCを使用した経験</a></li>
<li><a href="../ja477694/index.html">JavaScriptを何かで置き換える必要はありません-他の言語も同じ問題に直面します</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>