<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëì üìß ü•É HLS in MP4 using ffmpeg in a browser üëµüèª ü§¶üèæ üë®‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! For more than two months, in my free time I have been sawing a web application for converting HLS and DASH to MP4 using emscripten and ffmpeg, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>HLS in MP4 using ffmpeg in a browser</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504722/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello! </font><font style="vertical-align: inherit;">For more than two months, in my free time I have been sawing a web application for converting HLS and DASH to MP4 using emscripten and ffmpeg, from which I want to share how I managed to do this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article I will not cite the source code of the ffmpeg edits and patches, as </font><font style="vertical-align: inherit;">most of them were done on my knee, and I'm not very good at C. But now there are enough articles to help you.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Two years ago I had the goal of combining an audio and video track together into one mp4 file. Then I just plunged into emscripten and for the basics I found the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ffmpeg.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> repository </font><font style="vertical-align: inherit;">from which I learned a lot. Then I was almost able to achieve the goal, although I was very conditionally oriented in C. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Understanding the source code, ffmpeg made a patch for working with the file system, where reading from a file called an asynchronous function in js from which I read the blob of the file and passed the buffer, and when I was writing, I called js function that sent buffer data to the repository.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there was a problem with asynchronous functions, which I could not solve correctly, they worked through asyncify (fastcomp), which did not work correctly in some cases, namely, the execution of code in wasm did not stop, without waiting for a result from the js function, that's all broke down. </font><font style="vertical-align: inherit;">This problem was fixed via the EMTERPRETIFY_WHITELIST flag, which apparently moved the code from wasm to asm at the same time and slowed it down, and it was necessary to debug the call stack and add a broken function to the list with every exception. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, with such problems, this could not be called a working solution, on which all this remained a small demo.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/y-/gu/z-/y-guz-s_vswdqlgfbt8vbshowcg.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One and a half years later</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After watching a report on Google Dev Summit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">about new features in WebAssambly</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I went to see how emscripten was doing and saw a message:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emscripten emits WebAssembly using the upstream LLVM wasm backend, since version 1.39.0 (October 2019), and the old fastcomp backend is deprecated</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I wanted to go try to rebuild my repacker formats. </font><font style="vertical-align: inherit;">About a week I googled how to fix new compilation problems and finally put it all together. </font><font style="vertical-align: inherit;">The changes were not that many, but it wasn‚Äôt going to because of the new library linker, and already desperate to collect at least something, I just sawed out the problem libraries (as it turned out, the libraries themselves are connected and you no longer need to point them out with the hands). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now, the moment has come when it has gathered and earned! </font><font style="vertical-align: inherit;">The problem with the asynchronous code was gone, there was no need to debug anything, it worked as it should from the beginning. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here I seem to have reached my goal, but ... a new one appeared.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rewrite HTTP Protocol</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such a thought has been in my mind for a long time. </font><font style="vertical-align: inherit;">This can allow you to download HLS or DASH, and not only a ready-made playlist but also a live stream. </font><font style="vertical-align: inherit;">And I‚Äôve never seen anything like this on the Internet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It took me about three weeks to make at least something working with me with short breaks. </font><font style="vertical-align: inherit;">I knew C (while having zero experience), there were a lot of problems with pointers (it‚Äôs hard to keep track of where it goes, and even in someone else‚Äôs code), but at last something was compiled without errors. </font><font style="vertical-align: inherit;">After the first successes, this gave even more enthusiasm to complete the idea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just a couple of weeks, and finally I managed to do the first iteration of the working http protocol, and that would seem to be all?</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When the hardest is over</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this point, I had a framework ready, a small html form with an url input field and a start button, basically it worked. But it was still necessary to write an extension to bypass CORS and load data, make a storage that would write data in chunks, make an interface with progress display, all this was debugged to fix problems in different browsers. In general, the time has come to finally make it possible to use it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basically, userscript was made, which was a proxy for fetch requests from ffmpeg to download data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A couple of days later, an extension for Chrome and Firefox was ready, which using webRequest collected all the hls links that the browser loads when watching a video.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Firefox, as it turned out, the extension API does not allow you to manage power, from which you can not prevent the computer from falling asleep, alas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The extension looks like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/a6/ig/vua6igsxprko_lw12jwmstkfq48.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just improved the page on which the site was a little, screwed material-ui, finalized all the places that were whipped up. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tq/s1/il/tqs1iltzg0y1-h1hmmatewctvyo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After testing different ways of storing data, I revealed a number of problems: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blob</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Chrome writes them to RAM and drops to disk when it overflows, but only in OSX when the memory overflows, the OS leaves the account and closes all the applications that were open. And Firefox generally always kept data in memory. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache storage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- it works like IndexedDb, but after writing data, in Chrome blob they remain in RAM (either a bug or a fitcha), but it turns out that the data is written to cache storage (to disk) and also drops the same when the memory is full volume to disk as blob. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IndexedDb</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - works like a clock, knows how to store blob, writes data without frills, but Firefox strictly limits the amount of 2gb. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I worked on it a bit, I managed to make the function of interrupting the ffmpeg process (via the pointer), I came up with how to make the choice of formats (ffprobe) and network error handling. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ut/80/eo/ut80eoy4c02vuelxcfrx9ngswga.png"><br>
<br>
<img src="https://habrastorage.org/webt/ae/b7/qi/aeb7qikdlqnzfhuyiy6_-onisro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now, you can try the result yourself </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For me, this is an indispensable thing when you need to record a stream on a tweet or download a VOD. </font><font style="vertical-align: inherit;">It also works with a laptop, mixer, and any other sites that broadcast content in HLS or DASH (alas, the DASH implementation in ffmpeg is very conditional and live may not download correctly, because it does not take into account the fragment request interval). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for reading! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have questions about ffmpeg and emscripten - write, I will try to answer.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504712/index.html">Why am I not using SharedViewModel for fragments?</a></li>
<li><a href="../en504714/index.html">Go software measurement tools</a></li>
<li><a href="../en504716/index.html">Secure access to a smart home in the absence of a public IP (part 1)</a></li>
<li><a href="../en504718/index.html">The digest of fresh materials from the world of the front-end for the last week No. 417 (May 25 - 31, 2020)</a></li>
<li><a href="../en504720/index.html">The fastest template engine for PHP</a></li>
<li><a href="../en504724/index.html">Connectionism</a></li>
<li><a href="../en504726/index.html">4 agreements</a></li>
<li><a href="../en504728/index.html">Godot Editor port for WebAssembly released</a></li>
<li><a href="../en504730/index.html">It may turn out that you buy any rubbish on Amazon - and literally</a></li>
<li><a href="../en504732/index.html">Digital Solarography</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>