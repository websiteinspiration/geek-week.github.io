<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö± ‚Ñ¢Ô∏è üë©üèª‚Äçüè´ Como limitar a frequ√™ncia de solicita√ß√µes no HAProxy: instru√ß√µes passo a passo üç≠ üèÜ üî∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O autor explica como implementar no limite de velocidade da consulta HAProxy ( limite de taxa) com um determinado endere√ßo IP. A equipe do Mail.ru Clo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como limitar a frequ√™ncia de solicita√ß√µes no HAProxy: instru√ß√µes passo a passo</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499594/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/000/ebc/00e/000ebc00ecfca624add0621c731f2405.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O autor explica como implementar no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">limite de velocidade da consulta</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> HAProxy </font><font style="vertical-align: inherit;">( </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">limite de</font></a><font style="vertical-align: inherit;"> taxa) com um determinado endere√ßo IP. A equipe do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> traduziu seu artigo - esperamos que, com ele, voc√™ n√£o precise gastar tanto tempo e esfor√ßo com ele quanto gastou. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O fato √© que esse √© um dos m√©todos mais populares de proteger um servidor contra ataques de nega√ß√£o de servi√ßo, mas √© dif√≠cil encontrar instru√ß√µes claras na Internet sobre como configur√°-lo especificamente. Por tentativa e erro, o autor for√ßou o HAProxy a limitar a frequ√™ncia de solicita√ß√µes em uma lista de endere√ßos IP, que s√£o atualizados em tempo real. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nenhum conhecimento pr√©vio √© necess√°rio para configurar o HAProxy, pois todas as etapas necess√°rias s√£o descritas abaixo.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O HAProxy de c√≥digo aberto e gratuito √© um balanceador de carga e servidor proxy altamente acess√≠veis. </font><font style="vertical-align: inherit;">Nos √∫ltimos anos, tornou-se </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muito popular</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> porque oferece alto desempenho com um m√≠nimo de recursos. </font><font style="vertical-align: inherit;">Diferentemente de programas alternativos, a vers√£o sem fins lucrativos do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAProxy Community Edition</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oferece recursos suficientes para balanceamento de carga confi√°vel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este programa √© inicialmente muito dif√≠cil de entender. </font><font style="vertical-align: inherit;">No entanto, ela possui </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> t√©cnica muito meticulosa e detalhada </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O autor diz que esta √© a documenta√ß√£o mais detalhada entre todos os programas de c√≥digo aberto que ele j√° usou. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, aqui est√° um guia passo a passo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurando um Balanceador de Carga</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para economizar tempo e n√£o se distrair com a configura√ß√£o da infraestrutura, pegue as imagens do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Compose</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e inicie rapidamente os componentes principais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira tarefa √© aumentar a inst√¢ncia de trabalho do balanceador de carga HAProxy com v√°rios servidores de backend Apache.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clonar o reposit√≥rio</font></font></h4><br>
<pre><code class="bash hljs">$ git <span class="hljs-built_in">clone</span> git@github.com:stargazer/haproxy-ratelimiter.git<font></font>
$ <span class="hljs-built_in">cd</span> haproxy-ratelimiter</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode ver </font></font><code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com os par√¢metros de instala√ß√£o. A discuss√£o est√° al√©m do escopo deste artigo, ent√£o vamos insistir no fato de que eles criaram uma inst√¢ncia HAProxy trabalhando chamado </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dois servidores de back-end </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Para configurar o HAProxy, inicialmente usaremos o arquivo </font></font><code>haproxy-basic.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e depois mudaremos para </font></font><code>haproxy-ratelimiting.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por simplicidade, o arquivo de configura√ß√£o foi </font></font><code>haproxy-basic.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduzido ao m√≠nimo e limpo de excesso. Vejamos:</font></font><br>
<br>
<pre><code class="plaintext hljs">defaults<font></font>
mode http<font></font>
timeout connect 5000ms<font></font>
timeout client 50000ms<font></font>
timeout server 50000ms<font></font>
<font></font>
frontend proxy<font></font>
bind *:80<font></font>
<font></font>
use_backend api<font></font>
<font></font>
backend api<font></font>
balance roundrobin<font></font>
<font></font>
server api01 api01:80<font></font>
server api02 api02:80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A se√ß√£o </font></font><code>frontend proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define o HAProxy para escutar na porta 80 e encaminhar todas as solicita√ß√µes para o pool de servidores </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no back-end. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CATEGORIA </font></font><code>backend api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">especifica backend piscina </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com dois servidores de back-end </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e endere√ßos correspondentes. </font><font style="vertical-align: inherit;">O servidor para atender a cada solicita√ß√£o recebida √© selecionado pelo algoritmo de balanceamento de carga </font></font><code>roundrobin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ou seja, os dois servidores dispon√≠veis s√£o usados ‚Äã‚Äãalternadamente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos lan√ßar todos os tr√™s de nossos cont√™ineres</font></font></h4><br>
<pre><code class="bash hljs">$ sudo docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora temos um cont√™iner </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que redireciona solicita√ß√µes para dois servidores </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font><font style="vertical-align: inherit;">back </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">end </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Obteremos uma resposta de um deles se inserirmos na barra de endere√ßo </font></font><code>http://localhost/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â interessante atualizar a p√°gina v√°rias vezes e ver os logs </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api01_1 </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 09 +0000] "GET / HTTP / 1.1" 200 45</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 10 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api01_1 </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 10 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api01_1 </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode ver, dois servidores </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processam solicita√ß√µes por vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora temos uma inst√¢ncia HAProxy com uma configura√ß√£o de balanceamento de carga muito simples e temos alguma id√©ia de como ela funciona.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicione um limite ao n√∫mero de solicita√ß√µes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para definir um limite no n√∫mero de solicita√ß√µes para o balanceador de carga, √© necess√°rio modificar o arquivo de configura√ß√£o na inst√¢ncia HAProxy. </font><font style="vertical-align: inherit;">Verifique se o cont√™iner </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usa o arquivo de configura√ß√£o </font></font><code>haproxy-ratelimiter.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basta modificar o Dockerfile para substituir o arquivo de configura√ß√£o.</font></font><br>
<br>
<pre><code class="plaintext hljs">FROM haproxy:1.7<font></font>
COPY haproxy-ratelimiter.cfg /usr/local/etc/haproxy/haproxy.cfg</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Definindo limites</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas as configura√ß√µes s√£o registradas no arquivo de configura√ß√£o </font></font><code>haproxy-ratelimiter.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Vamos estud√°-lo com cuidado.</font></font><br>
<br>
<pre><code class="plaintext hljs">defaults<font></font>
mode http<font></font>
timeout connect 5000ms<font></font>
timeout client 50000ms<font></font>
timeout server 50000ms<font></font>
<font></font>
frontend proxy<font></font>
bind *:80<font></font>
<font></font>
# ACL function declarations<font></font>
acl is_abuse src_http_req_rate(Abuse) ge 10<font></font>
acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0<font></font>
acl abuse_cnt src_get_gpc0(Abuse) gt 0<font></font>
<font></font>
# Rules<font></font>
tcp-request connection track-sc0 src table Abuse<font></font>
tcp-request connection reject if abuse_cnt<font></font>
http-request deny if abuse_cnt<font></font>
http-request deny if is_abuse inc_abuse_cnt<font></font>
<font></font>
use_backend api<font></font>
backend api<font></font>
balance roundrobin<font></font>
<font></font>
server api01 api01:80<font></font>
server api02 api02:80<font></font>
<font></font>
backend Abuse<font></font>
stick-table type ip size 100K expire 30m store gpc0,http_req_rate(10s)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O HAProxy oferece um conjunto de primitivas de baixo n√≠vel que fornecem mais flexibilidade e s√£o adequadas para uma variedade de casos de uso. </font><font style="vertical-align: inherit;">Seus contadores geralmente me lembram o registro acumulativo (somador) na CPU. </font><font style="vertical-align: inherit;">Eles armazenam resultados intermedi√°rios, usam sem√¢nticas diferentes como entrada, mas no final s√£o apenas n√∫meros. </font><font style="vertical-align: inherit;">Para entender tudo bem, faz sentido come√ßar do final do arquivo de configura√ß√£o.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mesa </font></font><code>Abuse</code></h4><br>
<pre><code class="plaintext hljs">backend Abuse<font></font>
stick-table type ip size 100K expire 30m store gpc0,http_req_rate(10s)</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, montamos um back-end fict√≠cio chamado </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">("abuso"). </font><font style="vertical-align: inherit;">Fict√≠cio, porque √© usado apenas para stick-table, ao qual o restante da configura√ß√£o pode se referir por nome </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Uma tabela de palitos √© uma tabela armazenada na mem√≥ria do processo, onde para cada registro voc√™ pode determinar a vida √∫til. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nossa tabela possui as seguintes caracter√≠sticas:</font></font><br>
<br>
<ul>
<li><code>type ip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: As solicita√ß√µes s√£o salvas na tabela pelo endere√ßo IP como uma chave. </font><font style="vertical-align: inherit;">Portanto, solicita√ß√µes do mesmo endere√ßo IP se referir√£o ao mesmo registro. </font><font style="vertical-align: inherit;">Essencialmente, isso significa que estamos rastreando endere√ßos IP e dados relacionados.</font></font><br>
</li>
<li><code>size 100K</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: A tabela cont√©m um m√°ximo de 100 mil registros.</font></font><br>
</li>
<li><code>expire 30m</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: O per√≠odo de reten√ß√£o de registros √© de 30 minutos de inatividade.</font></font><br>
</li>
<li><code>store gpc0,http_req_rate(10s)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: O contador </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e o n√∫mero de solicita√ß√µes de endere√ßo IP dos √∫ltimos 10 segundos s√£o </font><font style="vertical-align: inherit;">armazenados com entradas </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Com a ajuda, </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rastrearemos quantas vezes o endere√ßo IP √© observado em abusos. </font><font style="vertical-align: inherit;">De fato, um valor de contador positivo significa que o endere√ßo IP j√° est√° marcado como suspeito. </font><font style="vertical-align: inherit;">Vamos ligar para este contador </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, a tabela </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite rastrear se o endere√ßo IP est√° marcado como suspeito, bem como a frequ√™ncia atual de solicita√ß√µes desse endere√ßo. </font><font style="vertical-align: inherit;">Portanto, temos um hist√≥rico de registros, bem como informa√ß√µes em tempo real. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos para a se√ß√£o </font></font><code>frontend proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e veja as novidades l√°.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fun√ß√µes e regras da ACL</font></font></h4><br>
<pre><code class="plaintext hljs">frontend proxy<font></font>
bind *:80<font></font>
<font></font>
# ACL function declarations<font></font>
acl is_abuse src_http_req_rate(Abuse) ge 10<font></font>
acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0<font></font>
acl abuse_cnt src_get_gpc0(Abuse) gt 0<font></font>
<font></font>
# Rules<font></font>
tcp-request connection track-sc0 src table Abuse<font></font>
tcp-request connection reject if abuse_cnt<font></font>
http-request deny if abuse_cnt<font></font>
http-request deny if is_abuse inc_abuse_cnt<font></font>
<font></font>
use_backend api</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listas de controle de acesso (ACLs) s√£o declara√ß√µes de fun√ß√£o que s√£o chamadas somente quando a regra √© definida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos dar uma olhada em todas as tr√™s entradas da ACL. </font><font style="vertical-align: inherit;">Lembre-se de que todos fazem refer√™ncia expl√≠cita a uma tabela </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que usa endere√ßos IP como chave; portanto, cada fun√ß√£o se aplica ao endere√ßo IP da solicita√ß√£o:</font></font><br>
<br>
<ul>
<li><code>acl is_abuse src_http_req_rate(Abuse) ge 10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: A fun√ß√£o </font></font><code>is_abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornar√° </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se a frequ√™ncia atual da solicita√ß√£o for maior ou igual a dez.</font></font><br>
</li>
<li><code>acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: A fun√ß√£o </font></font><code>inc_abuse_cnt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornar√° </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se o valor do incremento for </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maior que zero. </font><font style="vertical-align: inherit;">Como o valor inicial </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© zero, essa fun√ß√£o sempre retorna </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Em outras palavras, aumenta o valor </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, essencialmente sinalizando abuso a partir deste endere√ßo IP.</font></font><br>
</li>
<li><code>acl abuse_cnt src_get_gpc0(Abuse) gt 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: A fun√ß√£o </font></font><code>abuse_cnt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornar√° </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se o valor for </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maior que zero. </font><font style="vertical-align: inherit;">Em outras palavras, ele diz se esse endere√ßo IP j√° foi detectado em abusos.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como mencionado anteriormente, as ACLs s√£o simplesmente declara√ß√µes, ou seja, declara√ß√µes de fun√ß√£o. </font><font style="vertical-align: inherit;">Eles n√£o se aplicam a solicita√ß√µes de entrada at√© que alguma regra seja acionada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faz sentido olhar para as regras definidas na mesma se√ß√£o </font></font><code>frontend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As regras s√£o aplicadas a cada solicita√ß√£o recebida uma por uma - e executam as fun√ß√µes da ACL que acabamos de definir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver o que cada regra faz:</font></font><br>
<br>
<ul>
<li><code>tcp-request connection track-sc0 src table Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Adiciona uma consulta √† tabela </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Como a chave √© o endere√ßo IP na tabela, essa regra √© adicionada √† lista de endere√ßos IP.</font></font><br>
</li>
<li><code>tcp-request connection reject if abuse_cnt</code>:   TCP-,  IP-    ,     abuse.  ,   TCP-   IP-.<br>
</li>
<li><code>http-request deny if abuse_cnt</code>:  ,  IP-    .        IP-,      abuse.<br>
</li>
<li><code>http-request deny if is_abuse inc_abuse_cnt</code>:  ,  <code>is_abuse</code>  <code>inc_abuse_cnt</code>   <code>True</code>.  ,    ,    IP-        ,    IP-    .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em ess√™ncia, introduzimos dois tipos de verifica√ß√µes: em tempo real e na lista negra do hist√≥rico de consultas. </font><font style="vertical-align: inherit;">A segunda regra rejeita todas as novas conex√µes TCP se o endere√ßo IP foi observado em abusos. </font><font style="vertical-align: inherit;">A terceira regra pro√≠be o servi√ßo de solicita√ß√µes HTTP para um endere√ßo IP da lista negra, independentemente da frequ√™ncia atual de solicita√ß√µes desse endere√ßo. </font><font style="vertical-align: inherit;">A quarta regra garante que as solicita√ß√µes HTTP de um endere√ßo IP sejam rejeitadas no momento exato em que o limite de frequ√™ncia de solicita√ß√µes for superado. </font><font style="vertical-align: inherit;">Assim, a segunda regra funciona principalmente em novas conex√µes TCP, a terceira e a quarta - em conex√µes j√° estabelecidas, sendo a primeira uma verifica√ß√£o hist√≥rica e a segunda uma verifica√ß√£o em tempo real.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos tentar o filtro em a√ß√£o!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora podemos montar e lan√ßar nossos cont√™ineres novamente.</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo docker-compose down<font></font>
$ sudo docker-compose build<font></font>
$ sudo docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O balanceador de carga deve iniciar antes dos dois servidores de back-end. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos direcionar nosso navegador para </font></font><code>http://localhost/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Se atualizarmos a p√°gina rapidamente uma d√∫zia de vezes, excederemos o limite de dez solicita√ß√µes em um intervalo de dez segundos - e nossas solicita√ß√µes ser√£o rejeitadas. </font><font style="vertical-align: inherit;">Se continuarmos a atualizar a p√°gina, novas solicita√ß√µes ser√£o rejeitadas imediatamente - mesmo antes de a conex√£o TCP ser estabelecida.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quest√µes</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que o limite de dez solicita√ß√µes por dez segundos?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tabela </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">determina </font></font><code>http_req_rate(10s)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ou seja, a frequ√™ncia das solicita√ß√µes √© medida em uma janela de dez segundos. </font><font style="vertical-align: inherit;">Uma fun√ß√£o </font></font><code>is_abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">da ACL retorna </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a uma taxa de solicita√ß√£o ‚â•10 dentro do intervalo especificado. </font><font style="vertical-align: inherit;">Assim, o abuso √© considerado a frequ√™ncia de solicita√ß√µes de dez ou mais solicita√ß√µes em dez segundos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, por exemplo, decidimos definir um limite baixo para facilitar a verifica√ß√£o da opera√ß√£o do limitador.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qual √© a diferen√ßa entre as regras de conex√£o http-request e tcp-request?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://cbonte.github.io/haproxy-dconv/1.7/configuration.html&amp;usg=ALkJrhgb_OmvELip54CFB7JnMccq9dosQw#4.2-"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicita√ß√£o http: a instru√ß√£o solicita√ß√£o http define um conjunto de regras que se aplicam √† camada de rede 7 [modelo OSI]</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conex√£o tcp-request: executando uma a√ß√£o em uma conex√£o de entrada, dependendo de uma condi√ß√£o na camada de rede 4</font></font></i></blockquote><br>
<h3>  HTTP-,        TCP-?</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine que as solicita√ß√µes HTTP para o servidor enviem v√°rias conex√µes TCP do mesmo endere√ßo IP. </font><font style="vertical-align: inherit;">A frequ√™ncia das solicita√ß√µes HTTP exceder√° rapidamente os limites. </font><font style="vertical-align: inherit;">√â ent√£o que a quarta regra entra em vigor, que descarta solicita√ß√µes e coloca o endere√ßo IP na lista negra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora √© perfeitamente poss√≠vel que as conex√µes HTTP do mesmo endere√ßo IP permane√ßam abertas (consulte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conex√£o HTTP persistente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e a frequ√™ncia das solicita√ß√µes HTTP caiu abaixo do valor limite. </font><font style="vertical-align: inherit;">A terceira regra garante o bloqueio cont√≠nuo de solicita√ß√µes HTTP, pois √© </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acionada neste IP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, suponha que, ap√≥s alguns minutos, o mesmo IP tente estabelecer conex√µes TCP. </font><font style="vertical-align: inherit;">Eles s√£o descartados imediatamente, porque a segunda regra se aplica: ele v√™ o endere√ßo IP rotulado e descarta a conex√£o imediatamente.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No in√≠cio, pode ser dif√≠cil entender a limita√ß√£o da velocidade de processamento de solicita√ß√µes usando o HAProxy. </font><font style="vertical-align: inherit;">Para fazer tudo certo, voc√™ precisa de um pensamento bastante "de baixo n√≠vel" e de v√°rias a√ß√µes n√£o intuitivas. </font><font style="vertical-align: inherit;">A documenta√ß√£o nesta parte √© provavelmente muito t√©cnica e sofre com a aus√™ncia de exemplos b√°sicos. </font><font style="vertical-align: inherit;">Esperamos que este guia corrija as defici√™ncias e mostre a dire√ß√£o a todos que desejam seguir esse caminho. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que mais se pode ler</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como a arquitetura tolerante a falhas √© implementada na plataforma Mail.ru Cloud Solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os 10 principais truques e dicas do Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nosso canal Telegram sobre transforma√ß√£o digital</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499582/index.html">Predator-Prey Model em Node.js</a></li>
<li><a href="../pt499584/index.html">Monitor de toque industrial FPM-215W</a></li>
<li><a href="../pt499586/index.html">Como pensar na navega√ß√£o em aplicativos m√≥veis</a></li>
<li><a href="../pt499588/index.html">Autentica√ß√£o no .NET Core gRpc com JWT</a></li>
<li><a href="../pt499592/index.html">AI: Complementando o mundo de amanh√£</a></li>
<li><a href="../pt499598/index.html">E n√≥s iremos para o norte! Ser√° poss√≠vel economizar no resfriamento dos data centers devido ao clima?</a></li>
<li><a href="../pt499600/index.html">Como trabalhar juntos, trabalhando separados</a></li>
<li><a href="../pt499602/index.html">Movendo uma confer√™ncia on-line: InnerSource Commons Summit Experience</a></li>
<li><a href="../pt499604/index.html">4 argumentos para convencer um diretor a comprar uma UPS em uma pequena empresa</a></li>
<li><a href="../pt499606/index.html">Software de videoconfer√™ncia: Skype, Hangouts e Zoom meio-sangue</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>