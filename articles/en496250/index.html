<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßô üï∫üèø üêÑ How strange code hides errors? TensorFlow.NET Analysis üë©üèø‚Äç‚öñÔ∏è üóíÔ∏è üëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Static analysis is an extremely useful tool for any developer, as it helps to find in time not only errors, but also just suspicious and strange piece...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How strange code hides errors? TensorFlow.NET Analysis</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/496250/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/765/bb4/d84/765bb4d84187d986358a301bbeed082f.png" alt="TensorFlow.NET and PVS-Studio"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Static analysis is an extremely useful tool for any developer, as it helps to find in time not only errors, but also just suspicious and strange pieces of code that can cause bewilderment for programmers who would have to work with him in the future. This idea will be demonstrated by the analysis of the open C # project TensorFlow.NET, developed to work with the popular TensorFlow machine learning library.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My name is Nikita Lipilin. </font><font style="vertical-align: inherit;">Some time ago I joined the C # programmers department of PVS-Studio. </font><font style="vertical-align: inherit;">Traditionally, all newcomers to the team write articles that discuss the results of checking various open projects using the PVS-Studio static analyzer. </font><font style="vertical-align: inherit;">Such articles help new employees to get to know the product better, and at the same time provide additional benefits in terms of popularizing the static analysis methodology. </font><font style="vertical-align: inherit;">I suggest that you familiarize yourself with my first work on the topic of analysis of open projects.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The variety of possible errors in the program code is amazing. Some of them reveal themselves immediately, upon a surface examination of the created application, others can be difficult to notice even when conducting a code review by a team of experienced developers. However, it also happens that, due to carelessness or some other reason, the programmer sometimes writes simply strange and illogical code, which, nevertheless, (seems to) successfully fulfill its function. But only further, when returning to what was written, or when others study this code, questions begin to arise that cannot be answered.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Refactoring old code can turn into problems, especially if other parts of the program depend on it, so when you find even some frankly curved constructions, the ‚Ä≥ Does it work? Don‚Äôt touch it! ‚Ä≥. Subsequently, this makes it difficult to study the source, and therefore, it becomes difficult to expand the available capabilities. The code base is clogged, there is a likelihood that some small and invisible, but potentially very unpleasant internal problem will not be fixed in time.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At some point, the consequences of this error will be felt, but its search will take a lot of time, because the developer‚Äôs suspicions will fall on a huge number of strange code fragments that were not refactored at one time. It follows from this that various problems and oddities in a particular fragment should be corrected immediately after its writing. In the case when there are reasonable reasons to leave everything as it is (for example, if the code is written as some kind of blank ‚Ä≥ for later ‚Ä≥), such a fragment should be accompanied by an explanatory comment.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is also worth noting that, regardless of the developer‚Äôs qualifications, some problematic and simply unsuccessful moments can slip away from his gaze, and sometimes a ‚Äútemporary solution‚Äù can be applied at some place, which will soon be forgotten and becomes ‚Äúpermanent‚Äù. Subsequently, the analysis of such code (most likely, another developer will be engaged in this) will take an unacceptably much effort. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In such cases, code review can help. However, if the task is quite serious, then this option will require a lot of time. In addition, when there are a lot of small errors or shortcomings, then the inspector may well not notice high-level errors behind them. Checking the code becomes a tedious routine, and gradually the effectiveness of the review decreases.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviously, routine tasks will be much better transferred from person to computer. This approach is used in many areas of modernity. Automation of various processes is the key to prosperity. What is automation in the context of this topic? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A reliable assistant in solving the problem of writing reasonable and stable working code is static analysis. Each time before sending the results of their activities to the review, the programmer will be able to conduct an automated check and not burden other developers (and himself) with unnecessary work. The code will be sent for verification only after all analyzer warnings have been taken into account: errors have been fixed, and strange moments have been rewritten or at least explained by a comment.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, the need for code review does not disappear, but static analysis complements and greatly simplifies its implementation. </font><font style="vertical-align: inherit;">A sufficiently large part of the errors will be fixed thanks to the analyzer, and strange moments will definitely not be forgotten and marked accordingly. </font><font style="vertical-align: inherit;">Accordingly, with a code review, it will be possible to focus on verifying the correctness of the implementation of complex logical interactions and finding underlying problems that, unfortunately, cannot be detected by the analyzer (so far).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TensorFlow.NET</font></font></h2><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d02/39d/72d/d0239d72ded7154a696d5c975a0555d1.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article is inspired by the TensorFlow.NET project. It represents the implementation of the ability to work with the functionality of the popular TensorFlow machine learning library through C # code (by the way, we also </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tested it</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). This idea seemed quite interesting, because at the time of writing, working with the library is available only in Python, Java and Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The source code available on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is constantly being updated and now its volume is a little more than one hundred thousand lines. After a superficial study, there was a desire to conduct verification using static analysis. PVS-Studio was used as a specific tool, which has proved its effectiveness in a fairly large number of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">different projects</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/261/70b/247/26170b247e9b81a3643bd5682b7d5203.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For TensorFlow.NET, the analyzer displayed a number of alerts: 39 High levels, 227 Medium levels and 154 Low levels (you can read about warning levels </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the subsection ‚ÄúWarning levels and sets of diagnostic rules‚Äù). A detailed analysis of each of them would make this article gigantic, therefore only those that seemed most interesting to me are described below. It is also worth noting that some of the problems found are encountered several times in the project, and the analysis of each such piece of code is beyond the scope of this article.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The project sets itself a rather serious task, and, unfortunately, the appearance of various kinds of strange code fragments is inevitable. </font><font style="vertical-align: inherit;">In this article I will try to show that the use of static analysis can greatly simplify the work of programmers, pointing to areas that may cause questions. </font><font style="vertical-align: inherit;">Not always a warning indicates an error, but quite often it indicates a code that would cause questions in a person. </font><font style="vertical-align: inherit;">Accordingly, the likelihood of a strange code being either redesigned or, in any case, commented accordingly is significantly increased.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragments that attracted attention when studying the analyzer report</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, a fairly large number of analyzer warnings for this project can be called not so much errors, but rather strange code. When viewing lines for which a warning is issued, at least bewilderment arises. Of course, some of the examples below are probably ‚Ä≥ temporary solutions ‚Ä≥, but they don‚Äôt give any comments on this issue, which means that someone who will work with this code in the future will have questions, searching for answers to which will take extra time.</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/263/3fc/e7c/2633fce7cba470cd8a0c16e6751b3513.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, some warnings point to code that is obviously not just weird, but just wrong. </font><font style="vertical-align: inherit;">This is the main danger of ‚Ä≥ strange code ‚Ä≥ - it is extremely difficult to notice a real mistake if here and there you see incomprehensible solutions and gradually get used to the fact that the code seems to be incorrect.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sophisticated collection tour</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> _RemoveDefaultAttrs(....)<font></font>
{<font></font>
  <span class="hljs-keyword">var</span> producer_op_dict = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-keyword">string</span>, OpDef&gt;();<font></font>
  producer_op_list.Op.Select(op =&gt;<font></font>
  {<font></font>
    producer_op_dict[op.Name] = op;<font></font>
    <span class="hljs-keyword">return</span> op;<font></font>
  }).ToArray();           <font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3010</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The return value of function 'ToArray' is required to be utilized. importer.cs 218 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The analyzer considers the call to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toray</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at this point to be suspicious, since the value returned by this function is not assigned to a variable. However, such a code is not an error. This construct is used to populate the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">producer_op_dict</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dictionary with </font><font style="vertical-align: inherit;">values ‚Äã‚Äãcorresponding to the elements of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">producer_op_list.Op</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> list </font><font style="vertical-align: inherit;">. A call to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToArray is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necessary so that the function passed as an argument to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Select</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method is </font><font style="vertical-align: inherit;">called for all elements in the collection.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my opinion, the code does not look the best. </font><font style="vertical-align: inherit;">Filling out the dictionary is somewhat unobvious, and some developers may want to remove the ‚Ä≥ unnecessary ‚Ä≥ call of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToArray</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It would be much simpler and more understandable to use the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foreach loop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> here </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">var</span> producer_op_dict = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-keyword">string</span>, OpDef&gt;();<font></font>
<font></font>
<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> op <span class="hljs-keyword">in</span> producer_op_list.Op)<font></font>
{<font></font>
  producer_op_dict[op.Name] = op;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, the code looks as simple as possible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another similar moment looks like this:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> GraphDef <span class="hljs-title">convert_variables_to_constants</span>(<span class="hljs-params">....</span>)</span><font></font>
{<font></font>
  ....<font></font>
  inference_graph.Node.Select(x =&gt; map_name_to_node[x.Name] = x).ToArray();<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3010</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The return value of function 'ToArray' is required to be utilized. </font><font style="vertical-align: inherit;">graph_util_impl.cs 48 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only difference is that such a record looks more concise, but only the temptation to remove the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToArray</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> call </font><font style="vertical-align: inherit;">here does not disappear, and it still looks unobvious.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temporary solution</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> GraphDef <span class="hljs-title">convert_variables_to_constants</span>(<span class="hljs-params">....</span>)</span><font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">var</span> source_op_name = get_input_name(node);
  <span class="hljs-keyword">while</span>(map_name_to_node[source_op_name].Op == <span class="hljs-string">"Identity"</span>)<font></font>
  {<font></font>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotImplementedException);<font></font>
    ....<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3020</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> An unconditional 'throw' within a loop. graph_util_impl.cs 73 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the project under consideration, the following approach is often used: if some behavior needs to be implemented later, a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NotImplementedException is</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> thrown at the appropriate place </font><font style="vertical-align: inherit;">. It is clear why the analyzer warns of a possible error in this piece: using </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> instead of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> does not really look too reasonable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is not the only warning that appears due to the use of temporary solutions. For example, there is a method:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Tensor[] _SoftmaxCrossEntropyWithLogitsGrad(<font></font>
  Operation op, Tensor[] grads<font></font>
)<font></font>
{<font></font>
  <span class="hljs-keyword">var</span> grad_loss = grads[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">var</span> grad_grad = grads[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">var</span> softmax_grad = op.outputs[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">var</span> grad = _BroadcastMul(grad_loss, softmax_grad);<font></font>
<font></font>
  <span class="hljs-keyword">var</span> logits = op.inputs[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">if</span>(grad_grad != <span class="hljs-literal">null</span> &amp;&amp; !IsZero(grad_grad)) <span class="hljs-comment">// &lt;=</span><font></font>
  {<font></font>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotImplementedException(<span class="hljs-string">"_SoftmaxCrossEntropyWithLogitsGrad"</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Tensor[] <font></font>
  {<font></font>
    grad,<font></font>
    _BroadcastMul(grad_loss, -nn_ops.log_softmax(logits))<font></font>
  };<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3022</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Expression 'grad_grad! = Null &amp;&amp;! IsZero (grad_grad)' is always false. </font><font style="vertical-align: inherit;">nn_grad.cs 93 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NotImplementedException ("_ SoftmaxCrossEntropyWithLogitsGrad")</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will never be thrown, as this code is simply unreachable. </font><font style="vertical-align: inherit;">In order to unravel the reason, you must go to the code of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IsZero</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">IsZero</span>(<span class="hljs-params">Tensor g</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-keyword">string</span>[] { <span class="hljs-string">"ZerosLike"</span>, <span class="hljs-string">"Zeros"</span> }.Contains(g.op.type))
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
<font></font>
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotImplementedException(<span class="hljs-string">"IsZero"</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The method either returns </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or throws an exception. </font><font style="vertical-align: inherit;">This code is not an error - obviously, the implementation here is left for later. </font><font style="vertical-align: inherit;">The main thing is that ‚Ä≥ then ‚Ä≥ really has arrived. </font><font style="vertical-align: inherit;">Well, it turned out very successfully that PVS-Studio will not let you forget that there is such an imperfection here :)</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is Tensor is Tensor?</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Tensor[] _ExtractInputShapes(Tensor[] inputs)<font></font>
{<font></font>
  <span class="hljs-keyword">var</span> sizes = <span class="hljs-keyword">new</span> Tensor[inputs.Length];
  <span class="hljs-keyword">bool</span> fully_known = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; inputs.Length; i++)<font></font>
  {<font></font>
    <span class="hljs-keyword">var</span> x = inputs[i];<font></font>
<font></font>
    <span class="hljs-keyword">var</span> input_shape = array_ops.shape(x);
    <span class="hljs-keyword">if</span> (!(input_shape <span class="hljs-keyword">is</span> Tensor) || input_shape.op.type != <span class="hljs-string">"Const"</span>)<font></font>
    {<font></font>
      fully_known = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
<font></font>
    sizes[i] = input_shape;<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3051</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> An excessive type check. </font><font style="vertical-align: inherit;">The object is already of the 'Tensor' type. </font><font style="vertical-align: inherit;">array_grad.cs 154 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The return type of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shape</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tensor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">So the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_shape is Tensor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> check </font><font style="vertical-align: inherit;">looks at least weird. </font><font style="vertical-align: inherit;">Perhaps, once the method returned a value of a different type and the verification made sense, but it is also possible that instead of Tensor, the condition should specify some kind of heir to this class. </font><font style="vertical-align: inherit;">One way or another, the developer should pay attention to this fragment.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thorough Check</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Tensor[] _BaseFusedBatchNormGrad(....)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (data_format == <span class="hljs-string">"NCHW"</span>) <span class="hljs-comment">// &lt;=</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotImplementedException(<span class="hljs-string">""</span>);<font></font>
<font></font>
  <span class="hljs-keyword">var</span> results = grad_fun(<span class="hljs-keyword">new</span> FusedBatchNormParams<font></font>
  {<font></font>
    YBackprop = grad_y,<font></font>
    X = x,<font></font>
    Scale = scale,<font></font>
    ReserveSpace1 = pop_mean,<font></font>
    ReserveSpace2 = pop_var,<font></font>
    ReserveSpace3 = version == <span class="hljs-number">2</span> ? op.outputs[<span class="hljs-number">5</span>] : <span class="hljs-literal">null</span>,<font></font>
    Epsilon = epsilon,<font></font>
    DataFormat = data_format,<font></font>
    IsTraining = is_training<font></font>
  });<font></font>
<font></font>
  <span class="hljs-keyword">var</span> (dx, dscale, doffset) = (results[<span class="hljs-number">0</span>], results[<span class="hljs-number">1</span>], results[<span class="hljs-number">2</span>]);
  <span class="hljs-keyword">if</span> (data_format == <span class="hljs-string">"NCHW"</span>) <span class="hljs-comment">// &lt;=</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotImplementedException(<span class="hljs-string">""</span>);<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warnings</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3021</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There are two 'if' statements with identical conditional expressions. </font><font style="vertical-align: inherit;">The first 'if' statement contains method return. </font><font style="vertical-align: inherit;">This means that the second 'if' statement is senseless nn_grad.cs 230</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3022</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Expression 'data_format == "NCHW"' is always false. </font><font style="vertical-align: inherit;">nn_grad.cs 247</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unlike some of the previous examples, there is clearly something wrong with the code. </font><font style="vertical-align: inherit;">The second check does not make any sense, since if the condition is true, then the execution of the program will not reach it at all. </font><font style="vertical-align: inherit;">Perhaps some typo is allowed here, or one of the checks is generally superfluous.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The illusion of choice</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> Tensor <span class="hljs-title">Activate</span>(<span class="hljs-params">Tensor x, <span class="hljs-keyword">string</span> name = <span class="hljs-literal">null</span></span>)</span><font></font>
{<font></font>
  ....<font></font>
  Tensor negative_part;<font></font>
  <span class="hljs-keyword">if</span> (Math.Abs(_threshold) &gt; <span class="hljs-number">0.000001f</span>)<font></font>
  {<font></font>
    negative_part = gen_ops.relu(-x + _threshold);<font></font>
  } <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    negative_part = gen_ops.relu(-x + _threshold);<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3004</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The 'then' statement is equivalent to the 'else' statement. gen_nn_ops.activations.cs 156 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A rather amusing demonstration of the effectiveness of using static analysis in development. It is difficult to come up with a reasonable reason why the developer wrote this particular code - most likely, this is a typical copy-paste error (although this, of course, may be another ‚Ä≥ for later ‚Ä≥). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are other fragments of a similar plan, for example:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Operation _GroupControlDeps(
  <span class="hljs-keyword">string</span> dev, Operation[] deps, <span class="hljs-keyword">string</span> name = <span class="hljs-literal">null</span><font></font>
)<font></font>
{<font></font>
  <span class="hljs-keyword">return</span> tf_with(ops.control_dependencies(deps), ctl =&gt;<font></font>
  {<font></font>
    <span class="hljs-keyword">if</span> (dev == <span class="hljs-literal">null</span>)<font></font>
    {<font></font>
      <span class="hljs-keyword">return</span> gen_control_flow_ops.no_op(name);<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
      <span class="hljs-keyword">return</span> gen_control_flow_ops.no_op(name);<font></font>
    }<font></font>
  });<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3004</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The 'then' statement is equivalent to the 'else' statement. </font><font style="vertical-align: inherit;">control_flow_ops.cs 135 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maybe once the check made sense, but over time it disappeared, or some further changes are planned in the future. </font><font style="vertical-align: inherit;">However, neither one nor the other option seems to be sufficient justification for leaving something similar in the code, without explaining this oddity in any way. </font><font style="vertical-align: inherit;">With a high degree of probability, a copy-paste error was made in exactly the same way.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Belated Check</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Tensor[] <span class="hljs-title">Input</span>(<span class="hljs-params"><span class="hljs-keyword">int</span>[] batch_shape = <span class="hljs-literal">null</span>,
  TF_DataType dtype = TF_DataType.DtInvalid,
  <span class="hljs-keyword">string</span> name = <span class="hljs-literal">null</span>,
  <span class="hljs-keyword">bool</span> sparse = <span class="hljs-literal">false</span>,
  Tensor tensor = <span class="hljs-literal">null</span></span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">var</span> batch_size = batch_shape[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">var</span> shape = batch_shape.Skip(<span class="hljs-number">1</span>).ToArray(); <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
  InputLayer input_layer = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (batch_shape != <span class="hljs-literal">null</span>)                   <span class="hljs-comment">// &lt;=</span><font></font>
    ....<font></font>
  <span class="hljs-keyword">else</span><font></font>
    ....<font></font>
<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3095</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The 'batch_shape' object was used before it was verified against null. </font><font style="vertical-align: inherit;">Check lines: 39, 42. keras.layers.cs 39 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A classic and rather dangerous error of the potential use of a variable, which is a link to nowhere. </font><font style="vertical-align: inherit;">In this case, the code clearly implies the possibility that </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_shape</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will be </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - this is clear both from the list of arguments and from the subsequent verification of the same variable. </font><font style="vertical-align: inherit;">Thus, the analyzer here indicates a clear error.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another ‚Ä≥ for later ‚Ä≥?</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MnistDataSet</span>(<span class="hljs-params">
  NDArray images, NDArray labels, Type dataType, <span class="hljs-keyword">bool</span> reshape // &lt;=
</span>)</span> <font></font>
{<font></font>
  EpochsCompleted = <span class="hljs-number">0</span>;<font></font>
  IndexInEpoch = <span class="hljs-number">0</span>;<font></font>
<font></font>
  NumOfExamples = images.shape[<span class="hljs-number">0</span>];<font></font>
<font></font>
  images = images.reshape(<font></font>
    images.shape[<span class="hljs-number">0</span>], images.shape[<span class="hljs-number">1</span>] * images.shape[<span class="hljs-number">2</span>]<font></font>
  );<font></font>
  images = images.astype(dataType);<font></font>
  <span class="hljs-comment">// for debug np.multiply performance</span>
  <span class="hljs-keyword">var</span> sw = <span class="hljs-keyword">new</span> Stopwatch();<font></font>
  sw.Start();<font></font>
  images = np.multiply(images, <span class="hljs-number">1.0f</span> / <span class="hljs-number">255.0f</span>);<font></font>
  sw.Stop();<font></font>
  Console.WriteLine(<span class="hljs-string">$"<span class="hljs-subst">{sw.ElapsedMilliseconds}</span>ms"</span>);<font></font>
  Data = images;<font></font>
<font></font>
  labels = labels.astype(dataType);<font></font>
  Labels = labels;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3117</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Constructor parameter 'reshape' is not used. </font><font style="vertical-align: inherit;">MnistDataSet.cs 15 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Like some other oddities, this is most likely due to the fact that the functionality is far from being fully implemented and it is quite possible that the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reshape</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><font style="vertical-align: inherit;">will be used somehow in this constructor in the future. </font><font style="vertical-align: inherit;">But for the time being, it seems as if he is being thrown here just like that. </font><font style="vertical-align: inherit;">If this is really done ‚Ä≥ for later ‚Ä≥, then it would be wise to mark this with some comment. </font><font style="vertical-align: inherit;">If not, then it turns out that the code that constructs the object will have to throw an extra parameter into the constructor, and it is quite possible that it would be more convenient not to do this.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elusive possible null dereference</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Tensor[] _GatherV2Grad(Operation op, Tensor[] grads)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span>((<span class="hljs-keyword">int</span>)axis_static == <span class="hljs-number">0</span>)<font></font>
  {<font></font>
    <span class="hljs-keyword">var</span> params_tail_shape = params_shape.slice(<span class="hljs-keyword">new</span> NumSharp.Slice(start:<span class="hljs-number">1</span>));
    <span class="hljs-keyword">var</span> values_shape = array_ops.concat(
      <span class="hljs-keyword">new</span>[] { indices_size, params_tail_shape }, <span class="hljs-number">0</span><font></font>
    );<font></font>
    <span class="hljs-keyword">var</span> values = array_ops.reshape(grad, values_shape);<font></font>
    indices = array_ops.reshape(indices, indices_size);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Tensor[]<font></font>
    {<font></font>
      <span class="hljs-keyword">new</span> IndexedSlices(values, indices, params_shape), <span class="hljs-comment">// &lt;=</span>
      <span class="hljs-literal">null</span>,
      <span class="hljs-literal">null</span><font></font>
    };<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3146</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Possible null dereference of the 1st argument 'values' inside method. The '_outputs.FirstOrDefault ()' can return default null value. array_grad.cs 199 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To understand what the problem is, you should first turn to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indexedSlices</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> constructor </font><i><font style="vertical-align: inherit;">code</font></i><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">IndexedSlices</span>(<span class="hljs-params">
  Tensor values, Tensor indices, Tensor dense_shape = <span class="hljs-literal">null</span>
</span>)</span><font></font>
{<font></font>
  _values = values;<font></font>
  _indices = indices;<font></font>
  _dense_shape = dense_shape;<font></font>
<font></font>
  _values.Tag = <span class="hljs-keyword">this</span>; <span class="hljs-comment">// &lt;=</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviously, passing </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to this constructor will throw an exception. However, why does the analyzer consider that the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">values</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable </font><font style="vertical-align: inherit;">may contain </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio uses the Data-Flow Analysis technique, which allows you to find the sets of possible values ‚Äã‚Äãof variables in different parts of the code. A warning tells you that null in the specified variable can be returned with the following line: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_outputs.FirstOrDefault ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . However, looking at the code above, you can find that the value of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">values</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> variable is </font><font style="vertical-align: inherit;">obtained by calling </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_ops.reshape (grad, values_shape)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . So where does </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_outputs.FirstOrDefault () then</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact is that when analyzing the data stream, not only the current function is considered, but also all called; </font><font style="vertical-align: inherit;">PVS-Studio gets information about the set of possible values ‚Äã‚Äãof any variable anywhere. </font><font style="vertical-align: inherit;">Thus, a warning means that the implementation of </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_ops.reshape (grad, values_shape)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contains a call to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_outputs.FirstOrDefault ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the result of which is ultimately returned. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To verify this, go to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reshape</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implementation </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Tensor reshape&lt;T1, T2&gt;(T1 tensor, T2 shape, <span class="hljs-keyword">string</span> name = <span class="hljs-literal">null</span>)<font></font>
            =&gt; gen_array_ops.reshape(tensor, shape, <span class="hljs-literal">null</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then go to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reshape</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> method </font><font style="vertical-align: inherit;">called inside:</font></font><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Tensor reshape&lt;T1, T2&gt;(T1 tensor, T2 shape, <span class="hljs-keyword">string</span> name = <span class="hljs-literal">null</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">var</span> _op = _op_def_lib._apply_op_helper(
    <span class="hljs-string">"Reshape"</span>, name, <span class="hljs-keyword">new</span> { tensor, shape }<font></font>
  );<font></font>
  <span class="hljs-keyword">return</span> _op.output;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_apply_op_helper</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">returns an object of the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Operation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> class </font><font style="vertical-align: inherit;">that contains the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">output</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> property </font><font style="vertical-align: inherit;">. It is upon receipt of its value that the code described in the warning is called:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> Tensor output =&gt; _outputs.FirstOrDefault();</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tensor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is, of course, a reference type, so the default value for it will be </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">From all this it can be seen that PVS-Studio meticulously analyzes the logical structure of the code, penetrating deep into the structure of calls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The analyzer completed its work, indicating a potentially problematic place. </font><font style="vertical-align: inherit;">The programmer has to check whether a situation may arise when elements in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_outputs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> are absent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the static analysis will at least force the developer to pay attention to the suspicious fragment in order to assess whether the error may actually occur there. </font><font style="vertical-align: inherit;">With this approach, the number of errors that go unnoticed will be rapidly reduced.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unreliable waiting?</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-keyword">private</span> (LoopVar&lt;TItem&gt;, Tensor[]) _BuildLoop&lt;TItem&gt;(<font></font>
  ....<font></font>
) <span class="hljs-keyword">where</span> ....<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Finds the closest enclosing non-None control pivot.</span>
  <span class="hljs-keyword">var</span> outer_context = _outer_context;
  <span class="hljs-keyword">object</span> control_pivot = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">while</span> (outer_context != <span class="hljs-literal">null</span> &amp;&amp; control_pivot == <span class="hljs-literal">null</span>) <span class="hljs-comment">// &lt;=</span><font></font>
  {<font></font>
<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (control_pivot != <span class="hljs-literal">null</span>)<font></font>
  {<font></font>
<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3032</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Waiting on this expression is unreliable, as compiler may optimize some of the variables. </font><font style="vertical-align: inherit;">Use volatile variable (s) or synchronization primitives to avoid this. </font><font style="vertical-align: inherit;">WhileContext.cs 212 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The analyzer indicates that such an implementation of waiting can be optimized by the compiler, but I doubt that they really tried to implement waiting here - most likely, the code has simply not been added and it will be further developed in the future. </font><font style="vertical-align: inherit;">It might be worth throwing a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NotImplementedException here</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , given that this practice is used elsewhere in the project. </font><font style="vertical-align: inherit;">One way or another, I believe that some explanatory comment would obviously not hurt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Breaking borders</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TensorShape</span>(<span class="hljs-params"><span class="hljs-keyword">int</span>[][] dims</span>)</span><font></font>
{<font></font>
  <span class="hljs-keyword">if</span>(dims.Length == <span class="hljs-number">1</span>)<font></font>
  {<font></font>
    <span class="hljs-keyword">switch</span> (dims[<span class="hljs-number">0</span>].Length)<font></font>
    {<font></font>
      <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: shape = <span class="hljs-keyword">new</span> Shape(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">0</span>]); <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: shape = Shape.Vector((<span class="hljs-keyword">int</span>)dims[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]); <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: shape = Shape.Matrix(dims[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], dims[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>]); <span class="hljs-keyword">break</span>; <span class="hljs-comment">// &lt;=</span>
      <span class="hljs-keyword">default</span>: shape = <span class="hljs-keyword">new</span> Shape(dims[<span class="hljs-number">0</span>]); <span class="hljs-keyword">break</span>;<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotImplementedException(<span class="hljs-string">"TensorShape int[][] dims"</span>);<font></font>
  }<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3106</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Possibly index is out of bound. The '1' index is pointing beyond 'dims' bound. TensorShape.cs 107 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Among the weird snippets of code I saw, there was a real mistake, which is very difficult to notice. The following fragment is erroneous here: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dims [1] [2]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Getting an element with index 1 from an array of one element is obviously a mistake. At the same time, if you change the fragment to </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dims [0] [2]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , another error appears - getting an element with index 2 from the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dims [0]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> array </font><font style="vertical-align: inherit;">, the length of which in this case branch is 2. Thus, this problem turned out to be as if with a "double bottom".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In any case, this code fragment should be studied and corrected by the developer. </font><font style="vertical-align: inherit;">In my opinion, this example is an excellent illustration of the performance of Data Flow Analysis in PVS-Studio.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Olepatka?</font></font></h3><br>
<pre><code class="cs hljs"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> _init_from_args(<span class="hljs-keyword">object</span> initial_value = <span class="hljs-literal">null</span>, ....) <span class="hljs-comment">// &lt;=</span><font></font>
{<font></font>
  <span class="hljs-keyword">var</span> init_from_fn = initial_value.GetType().Name == <span class="hljs-string">"Func`1"</span>; <span class="hljs-comment">// &lt;=</span><font></font>
  ....<font></font>
  tf_with(...., scope =&gt;<font></font>
  {<font></font>
    ....<font></font>
    tf_with(...., <span class="hljs-keyword">delegate</span><font></font>
    {<font></font>
      initial_value = ops.convert_to_tensor(  <span class="hljs-comment">// &lt;=</span>
        init_from_fn ? (initial_value <span class="hljs-keyword">as</span> Func&lt;Tensor&gt;)():initial_value,<font></font>
        name: <span class="hljs-string">"initial_value"</span>,<font></font>
        dtype: dtype<font></font>
      );<font></font>
    });<font></font>
    _shape = shape ?? (initial_value <span class="hljs-keyword">as</span> Tensor).TensorShape;<font></font>
    _initial_value = initial_value <span class="hljs-keyword">as</span> Tensor; <span class="hljs-comment">// &lt;=</span><font></font>
    ....<font></font>
    _dtype = _initial_value.dtype.as_base_dtype(); <span class="hljs-comment">// &lt;=</span><font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_in_graph_mode)<font></font>
    {<font></font>
      ....<font></font>
<font></font>
      <span class="hljs-keyword">if</span> (initial_value != <span class="hljs-literal">null</span>) <span class="hljs-comment">// &lt;=</span><font></font>
      {<font></font>
        ....<font></font>
      }<font></font>
<font></font>
      ....<font></font>
    }<font></font>
<font></font>
    ....<font></font>
  });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To understand the code above, it is also worthwhile to introduce the implementation of the tf_with function:</font></font><br>
<br>
<pre><code class="cs hljs">[<span class="hljs-meta">DebuggerStepThrough</span>] <span class="hljs-comment">// with "Just My Code" enabled this lets the </span>
[<span class="hljs-meta">DebuggerNonUserCode()</span>]  <span class="hljs-comment">//debugger break at the origin of the exception</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> tf_with&lt;T&gt;(<font></font>
  T py, Action&lt;T&gt; action<font></font>
) <span class="hljs-keyword">where</span> T : ITensorFlowObject<font></font>
{<font></font>
  <span class="hljs-keyword">try</span><font></font>
  {<font></font>
    py.__enter__();<font></font>
    action(py);<font></font>
  }<font></font>
  <span class="hljs-keyword">finally</span><font></font>
  {<font></font>
    py.__exit__();<font></font>
    py.Dispose();<font></font>
  }<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analyzer Warning</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : V3019 Possibly an incorrect variable is compared to null after type conversion using 'as' keyword. Check variables 'initial_value', '_initial_value'. ResourceVariable.cs 137 </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_init_from_args</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a fairly voluminous function, so many fragments have been omitted. You can see it completely by clicking on the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Although the warning at first did not seem really serious to me, after studying, I realized that something was definitely wrong with the code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firstly, it should be noted that the method can be called without passing parameters and by default it </font><font style="vertical-align: inherit;">will be </font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;"> in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initial_value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In this case, an exception will be thrown on the first line. </font><font style="vertical-align: inherit;">
Secondly, verification</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initial_value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inequality </font><font style="vertical-align: inherit;">looks strange: if </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initial_value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> really became </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> after calling </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ops.convert_to_tensor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_initial_value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> would be </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which means that calling </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_initial_value.dtype.as_base_dtype ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> would also throw an exception. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analyzer hints that you may need to check for </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_initial_value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but as noted above, referring to this variable take place before this test, so this option would also be incorrect. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Would this tiny mistake be noticed in such a giant function without PVS-Studio? </font><font style="vertical-align: inherit;">I doubt it very much.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a project with a lot of examples of strange code, a lot of problems can be hidden. The programmer, getting used to seeing the incomprehensible, ceases to notice errors at the same time. The consequences can be very sad. Indeed, among analyzer warnings there are also false ones, however, in most cases, warnings at least indicate fragments of code that can cause questions when viewed by a person. In the case when the strange code is written intentionally, it is worth leaving explanations so that the fragment is clear to the developer who will work with this code in the future (even if it means leaving comments for himself).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, static analysis tools, such as PVS-Studio, can be great help in finding potential errors and oddities so that they are visible and not forgotten, and all temporary solutions are subsequently refined and turned into a clean, structured and stable working the code.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to share this article with an English-speaking audience, then please use the link to the translation: Nikita Lipilin. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How does strange code hide errors? </font><font style="vertical-align: inherit;">TensorFlow.NET Analysis</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496236/index.html">How do we import outsourced testing. Step-by-step instruction</a></li>
<li><a href="../en496238/index.html">Twenty-eight Steps to Survive and Succeed in Crisis</a></li>
<li><a href="../en496240/index.html">Product Discovery 101 for Product Manager</a></li>
<li><a href="../en496242/index.html">Cyberpunk is already here: schoolchildren study at Minecraft, and students take physical tests in CS: GO</a></li>
<li><a href="../en496248/index.html">Challenges, bald heads and wine. How we at HFLabs endure self-isolation</a></li>
<li><a href="../en496252/index.html">Aerodynamically offset centering aircraft</a></li>
<li><a href="../en496254/index.html">How Rostelecom mistakenly redirected traffic to Google, AWS, Cloudflare, etc.</a></li>
<li><a href="../en496256/index.html">Machine learning on R: expert techniques for predictive analysis</a></li>
<li><a href="../en496258/index.html">Online holivar: a new format for the exchange of experience. This Saturday</a></li>
<li><a href="../en496260/index.html">Cybersecurity tips for working from home</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>