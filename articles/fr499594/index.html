<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⚰️ 😅 👩‍❤️‍👨 Comment limiter la fréquence des demandes dans HAProxy: instructions pas à pas 🤽🏼 👩‍🚒 📍</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'auteur explique comment implémenter dans HAProxy une limite de vitesse de requête (limitation de débit) avec certaines adresses IP. L'équipe Mail.ru...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comment limiter la fréquence des demandes dans HAProxy: instructions pas à pas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499594/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/000/ebc/00e/000ebc00ecfca624add0621c731f2405.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'auteur explique comment implémenter dans HAProxy </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">une limite de vitesse de requête</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (limitation de débit) avec certaines adresses IP. L'équipe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a </font><font style="vertical-align: inherit;">traduit son article - nous espérons que vous n'aurez pas à y consacrer autant de temps et d'efforts que vous ne l'avez dû. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fait est que c'est l'une des méthodes les plus populaires pour protéger un serveur contre les attaques DoS, mais il est difficile de trouver des instructions claires sur Internet pour le configurer spécifiquement. Par essais et erreurs, l'auteur a contraint HAProxy à limiter la fréquence des requêtes sur une liste d'adresses IP, qui est mise à jour en temps réel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aucune connaissance préalable n'est requise pour configurer HAProxy, car toutes les étapes nécessaires sont décrites ci-dessous.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Open source et gratuit HAProxy est un équilibreur de charge et un serveur proxy hautement accessibles. </font><font style="vertical-align: inherit;">Ces dernières années, il est devenu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">très populaire</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> car il offre des performances élevées avec un minimum de ressources. </font><font style="vertical-align: inherit;">Contrairement aux programmes alternatifs, la version à but non lucratif de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAProxy Community Edition</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> offre suffisamment de fonctionnalités pour un équilibrage de charge fiable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce programme est au début assez difficile à comprendre. </font><font style="vertical-align: inherit;">Cependant, elle dispose d'une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> technique très méticuleuse et détaillée </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">L'auteur dit que c'est la documentation la plus détaillée parmi tous les programmes open source qu'il ait jamais utilisés. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici donc un guide étape par étape.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration d'un équilibreur de charge</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour gagner du temps et ne pas vous laisser distraire par la configuration de l'infrastructure, prenez les images </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Compose</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et lancez rapidement les principaux composants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La première tâche consiste à augmenter l'instance de travail de l'équilibreur de charge HAProxy avec plusieurs serveurs principaux Apache.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clonez le référentiel</font></font></h4><br>
<pre><code class="bash hljs">$ git <span class="hljs-built_in">clone</span> git@github.com:stargazer/haproxy-ratelimiter.git<font></font>
$ <span class="hljs-built_in">cd</span> haproxy-ratelimiter</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez consulter </font></font><code>Dockerfile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec les paramètres d'installation. Leur discussion dépasse le cadre de cet article, nous allons donc nous attarder sur le fait qu'ils ont créé une instance HAProxy fonctionnelle appelée </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deux serveurs principaux </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pour configurer HAProxy, nous allons d'abord utiliser le fichier </font></font><code>haproxy-basic.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puis basculer vers </font></font><code>haproxy-ratelimiting.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par souci de simplicité, le fichier de configuration a été </font></font><code>haproxy-basic.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">réduit au strict minimum et débarrassé de tout excès. Regardons ça:</font></font><br>
<br>
<pre><code class="plaintext hljs">defaults<font></font>
mode http<font></font>
timeout connect 5000ms<font></font>
timeout client 50000ms<font></font>
timeout server 50000ms<font></font>
<font></font>
frontend proxy<font></font>
bind *:80<font></font>
<font></font>
use_backend api<font></font>
<font></font>
backend api<font></font>
balance roundrobin<font></font>
<font></font>
server api01 api01:80<font></font>
server api02 api02:80</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La section </font></font><code>frontend proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">définit HAProxy pour écouter sur le port 80 et transmettre toutes les demandes au pool de serveurs </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sur le backend. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CATÉGORIE </font></font><code>backend api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spécifie le pool principal </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec deux serveurs principaux </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et les adresses correspondantes. </font><font style="vertical-align: inherit;">Le serveur pour traiter chaque demande entrante est sélectionné par l'algorithme d'équilibrage de charge </font></font><code>roundrobin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, c'est-à-dire que les deux serveurs disponibles sont utilisés tour à tour.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lançons les trois de nos conteneurs</font></font></h4><br>
<pre><code class="bash hljs">$ sudo docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons maintenant un conteneur </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui redirige les demandes vers deux serveurs principaux </font></font><code>api01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font><font style="vertical-align: inherit;">serveurs </font></font><code>api02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nous obtiendrons une réponse de l'un d'eux si nous entrons dans la barre d'adresse </font></font><code>http://localhost/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est intéressant de rafraîchir la page plusieurs fois et de consulter les journaux </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 09 +0000] "GET / HTTP / 1.1" 200 45</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 10 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 10 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api01_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api02_1 | </font><font style="vertical-align: inherit;">192.168.192.3 - - [08 / Jan / 2019: 11: 38: 11 +0000] "GET / HTTP / 1.1" 304 -</font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, deux serveurs </font></font><code>api</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traitent les demandes à tour de rôle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons maintenant une instance HAProxy avec une configuration d'équilibrage de charge très simple, et nous avons une idée de son fonctionnement.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajouter une limite au nombre de demandes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour définir une limite sur le nombre de demandes à l'équilibreur de charge, vous devez modifier le fichier de configuration dans l'instance HAProxy. </font><font style="vertical-align: inherit;">Assurez-vous que le conteneur </font></font><code>loadbalancer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilise le fichier de configuration </font></font><code>haproxy-ratelimiter.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez simplement le Dockerfile pour remplacer le fichier de configuration.</font></font><br>
<br>
<pre><code class="plaintext hljs">FROM haproxy:1.7<font></font>
COPY haproxy-ratelimiter.cfg /usr/local/etc/haproxy/haproxy.cfg</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fixer des limites</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les paramètres sont enregistrés dans le fichier de configuration </font></font><code>haproxy-ratelimiter.cfg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Étudions-le attentivement.</font></font><br>
<br>
<pre><code class="plaintext hljs">defaults<font></font>
mode http<font></font>
timeout connect 5000ms<font></font>
timeout client 50000ms<font></font>
timeout server 50000ms<font></font>
<font></font>
frontend proxy<font></font>
bind *:80<font></font>
<font></font>
# ACL function declarations<font></font>
acl is_abuse src_http_req_rate(Abuse) ge 10<font></font>
acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0<font></font>
acl abuse_cnt src_get_gpc0(Abuse) gt 0<font></font>
<font></font>
# Rules<font></font>
tcp-request connection track-sc0 src table Abuse<font></font>
tcp-request connection reject if abuse_cnt<font></font>
http-request deny if abuse_cnt<font></font>
http-request deny if is_abuse inc_abuse_cnt<font></font>
<font></font>
use_backend api<font></font>
backend api<font></font>
balance roundrobin<font></font>
<font></font>
server api01 api01:80<font></font>
server api02 api02:80<font></font>
<font></font>
backend Abuse<font></font>
stick-table type ip size 100K expire 30m store gpc0,http_req_rate(10s)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HAProxy propose un ensemble de primitives de bas niveau qui offrent plus de flexibilité et conviennent à une variété de cas d'utilisation. </font><font style="vertical-align: inherit;">Ses compteurs me rappellent souvent le registre cumulatif (additionneur) du CPU. </font><font style="vertical-align: inherit;">Ils stockent des résultats intermédiaires, prennent différentes sémantiques en entrée, mais au final ce ne sont que des nombres. </font><font style="vertical-align: inherit;">Pour bien comprendre tout, il est logique de commencer à la toute fin du fichier de configuration.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table </font></font><code>Abuse</code></h4><br>
<pre><code class="plaintext hljs">backend Abuse<font></font>
stick-table type ip size 100K expire 30m store gpc0,http_req_rate(10s)</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous avons mis en place un backend factice appelé </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(«abus»). </font><font style="vertical-align: inherit;">Fictif, car il n'est utilisé que pour stick-table, auquel le reste de la configuration peut faire référence par son nom </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Un stick-table est une table stockée dans la mémoire de processus, où pour chaque enregistrement, vous pouvez déterminer la durée de vie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre table présente les caractéristiques suivantes:</font></font><br>
<br>
<ul>
<li><code>type ip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Les demandes sont enregistrées dans le tableau par adresse IP sous forme de clé. </font><font style="vertical-align: inherit;">Ainsi, les demandes provenant de la même adresse IP feront référence au même enregistrement. </font><font style="vertical-align: inherit;">Essentiellement, cela signifie que nous suivons les adresses IP et les données connexes.</font></font><br>
</li>
<li><code>size 100K</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Le tableau contient un maximum de 100 000 enregistrements.</font></font><br>
</li>
<li><code>expire 30m</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: La période de conservation des enregistrements est de 30 minutes d'inactivité.</font></font><br>
</li>
<li><code>store gpc0,http_req_rate(10s)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Le compteur </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et le nombre de demandes d'adresses IP pour les 10 dernières secondes sont </font><font style="vertical-align: inherit;">stockés avec des entrées </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Avec l'aide, </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous suivrons combien de fois l'adresse IP est remarquée dans les abus. </font><font style="vertical-align: inherit;">En fait, une valeur de compteur positive signifie que l'adresse IP est déjà marquée comme suspecte. </font><font style="vertical-align: inherit;">Appelons ce compteur </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, le tableau </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous permet de suivre si l'adresse IP est marquée comme suspecte, ainsi que la fréquence actuelle des demandes de cette adresse. </font><font style="vertical-align: inherit;">Par conséquent, nous avons un historique des enregistrements, ainsi que des informations en temps réel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons maintenant à la section </font></font><code>frontend proxy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et voyons les nouveautés.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fonctions et règles ACL</font></font></h4><br>
<pre><code class="plaintext hljs">frontend proxy<font></font>
bind *:80<font></font>
<font></font>
# ACL function declarations<font></font>
acl is_abuse src_http_req_rate(Abuse) ge 10<font></font>
acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0<font></font>
acl abuse_cnt src_get_gpc0(Abuse) gt 0<font></font>
<font></font>
# Rules<font></font>
tcp-request connection track-sc0 src table Abuse<font></font>
tcp-request connection reject if abuse_cnt<font></font>
http-request deny if abuse_cnt<font></font>
http-request deny if is_abuse inc_abuse_cnt<font></font>
<font></font>
use_backend api</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les listes de contrôle d'accès (ACL) sont des déclarations de fonctions qui sont appelées uniquement lorsque la règle est définie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons de plus près les trois entrées ACL. </font><font style="vertical-align: inherit;">Gardez à l'esprit qu'ils font tous explicitement référence à une table </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui utilise des adresses IP comme clé, de sorte que chaque fonction s'applique à l'adresse IP de la demande:</font></font><br>
<br>
<ul>
<li><code>acl is_abuse src_http_req_rate(Abuse) ge 10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: La fonction </font></font><code>is_abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retourne </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si la fréquence de requête actuelle est supérieure ou égale à dix.</font></font><br>
</li>
<li><code>acl inc_abuse_cnt src_inc_gpc0(Abuse) gt 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: La fonction </font></font><code>inc_abuse_cnt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si la valeur d'incrément est </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supérieure à zéro. </font><font style="vertical-align: inherit;">Puisque la valeur initiale </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est zéro, cette fonction retourne toujours </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En d'autres termes, il augmente la valeur </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, signalant essentiellement un abus de cette adresse IP.</font></font><br>
</li>
<li><code>acl abuse_cnt src_get_gpc0(Abuse) gt 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: La fonction </font></font><code>abuse_cnt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si la valeur est </font></font><code>gpc0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supérieure à zéro. </font><font style="vertical-align: inherit;">En d'autres termes, il dit si cette adresse IP a déjà été repérée dans des abus.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme mentionné précédemment, les ACL sont simplement des déclarations, c'est-à-dire des déclarations de fonctions. </font><font style="vertical-align: inherit;">Ils ne s'appliquent pas aux demandes entrantes tant qu'une règle n'est pas déclenchée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est logique de regarder les règles définies dans la même section </font></font><code>frontend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Les règles sont appliquées à chaque demande entrante une par une - et exécutent les fonctions de l'ACL que nous venons de définir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons ce que fait chaque règle:</font></font><br>
<br>
<ul>
<li><code>tcp-request connection track-sc0 src table Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Ajoute une requête à la table </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Étant donné que la clé est l'adresse IP dans le tableau, cette règle s'ajoute à la liste des adresses IP.</font></font><br>
</li>
<li><code>tcp-request connection reject if abuse_cnt</code>:   TCP-,  IP-    ,     abuse.  ,   TCP-   IP-.<br>
</li>
<li><code>http-request deny if abuse_cnt</code>:  ,  IP-    .        IP-,      abuse.<br>
</li>
<li><code>http-request deny if is_abuse inc_abuse_cnt</code>:  ,  <code>is_abuse</code>  <code>inc_abuse_cnt</code>   <code>True</code>.  ,    ,    IP-        ,    IP-    .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En substance, nous introduisons deux types de contrôles: en temps réel et dans la liste noire de l'historique des requêtes. </font><font style="vertical-align: inherit;">La deuxième règle rejette toutes les nouvelles connexions TCP si l'adresse IP a été remarquée lors d'abus. </font><font style="vertical-align: inherit;">La troisième règle interdit le service des requêtes HTTP pour une adresse IP de la liste noire, quelle que soit la fréquence actuelle des requêtes de cette adresse. </font><font style="vertical-align: inherit;">La quatrième règle garantit que les demandes HTTP provenant d'une adresse IP sont rejetées au moment même dès que le seuil de fréquence des demandes est dépassé. </font><font style="vertical-align: inherit;">Ainsi, la deuxième règle fonctionne principalement sur les nouvelles connexions TCP, la troisième et la quatrième sur les connexions déjà établies, la première étant une vérification historique et la seconde une vérification en temps réel.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essayons le filtre en action!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons maintenant assembler et lancer à nouveau nos conteneurs.</font></font><br>
<br>
<pre><code class="bash hljs">$ sudo docker-compose down<font></font>
$ sudo docker-compose build<font></font>
$ sudo docker-compose up</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'équilibreur de charge doit démarrer avant les deux serveurs principaux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dirigeons notre navigateur vers </font></font><code>http://localhost/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si nous actualisons rapidement la page une douzaine de fois, nous dépasserons le seuil de dix demandes dans un intervalle de dix secondes - et nos demandes seront rejetées. </font><font style="vertical-align: inherit;">Si nous continuons à actualiser la page, les nouvelles demandes seront rejetées immédiatement - avant même que la connexion TCP ne soit établie.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Des questions</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pourquoi la limite de dix demandes par dix secondes?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le tableau </font></font><code>Abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">détermine </font></font><code>http_req_rate(10s)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, c'est-à-dire que la fréquence des demandes est mesurée dans une fenêtre de dix secondes. </font><font style="vertical-align: inherit;">Une fonction </font></font><code>is_abuse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de l'ACL revient </font></font><code>True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à un taux de demande ≥10 dans l'intervalle spécifié. </font><font style="vertical-align: inherit;">Ainsi, l'abus est considéré comme la fréquence des demandes de dix demandes ou plus en dix secondes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet article, par exemple, nous avons décidé de définir une limite basse pour faciliter le contrôle du fonctionnement du limiteur.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelle est la différence entre les règles de connexion http-request et tcp-request?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://cbonte.github.io/haproxy-dconv/1.7/configuration.html&amp;usg=ALkJrhhh8Cc9-K571z_C3bCAWcfpXuAobg#4.2-"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http-request: l'instruction http-request définit un ensemble de règles qui s'appliquent à la couche réseau 7 [modèle OSI]</font></font></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connexion tcp-request: exécution d'une action sur une connexion entrante en fonction d'une condition au niveau de la couche réseau 4</font></font></i></blockquote><br>
<h3>  HTTP-,        TCP-?</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginez que les requêtes HTTP au serveur envoient plusieurs connexions TCP à partir de la même adresse IP. </font><font style="vertical-align: inherit;">La fréquence des requêtes HTTP dépassera rapidement les seuils. </font><font style="vertical-align: inherit;">C'est alors que la quatrième règle entre en vigueur, qui rejette les demandes et met l'adresse IP sur liste noire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, il est tout à fait possible que les connexions HTTP à partir de la même adresse IP restent ouvertes (voir </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connexion HTTP persistante</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), et la fréquence des demandes HTTP est tombée en dessous de la valeur seuil. </font><font style="vertical-align: inherit;">La troisième règle garantit le blocage continu des requêtes HTTP, car il est </font></font><code>abuse indicator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">déclenché sur cette IP. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supposons maintenant qu'après quelques minutes, la même IP tente d'établir des connexions TCP. </font><font style="vertical-align: inherit;">Ils sont abandonnés immédiatement, car la deuxième règle s'applique: il voit l'adresse IP étiquetée et abandonne immédiatement la connexion.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au début, il peut être difficile de comprendre la limitation de la vitesse de traitement des demandes à l'aide de HAProxy. </font><font style="vertical-align: inherit;">Pour tout faire correctement, vous avez besoin d'une réflexion assez "de bas niveau" et d'un certain nombre d'actions non intuitives. </font><font style="vertical-align: inherit;">La documentation de cette partie est probablement trop technique et souffre de l'absence d'exemples de base. </font><font style="vertical-align: inherit;">Nous espérons que ce guide comblera la lacune et montrera la direction à tous ceux qui souhaitent emprunter cette voie. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quoi d'autre à lire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment l'architecture tolérante aux pannes est implémentée dans la plateforme Mail.ru Cloud Solutions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les 10 meilleurs trucs et astuces de Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notre chaîne Telegram sur la transformation numérique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr499582/index.html">Modèle Predator-Prey sur Node.js</a></li>
<li><a href="../fr499584/index.html">Moniteur tactile industriel FPM-215W</a></li>
<li><a href="../fr499586/index.html">Comment penser la navigation dans les applications mobiles</a></li>
<li><a href="../fr499588/index.html">Authentification dans .NET Core gRpc avec JWT</a></li>
<li><a href="../fr499592/index.html">AI: Compléter le monde de demain</a></li>
<li><a href="../fr499598/index.html">Et nous irons au nord! Sera-t-il possible d'économiser sur le refroidissement des centres de données en raison des conditions météorologiques?</a></li>
<li><a href="../fr499600/index.html">Comment travailler ensemble, travailler séparément</a></li>
<li><a href="../fr499602/index.html">Déplacer une conférence en ligne: expérience du sommet InnerSource Commons</a></li>
<li><a href="../fr499604/index.html">4 arguments pour convaincre un directeur d'acheter un onduleur dans une petite entreprise</a></li>
<li><a href="../fr499606/index.html">Logiciel de vidéoconférence: Skype, Hangouts et Zoom Half-Blood</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>