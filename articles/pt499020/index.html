<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòë üíØ üë®üèº Um estudo de um comportamento vago üî† ü§ôüèΩ üîà</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O artigo explora as poss√≠veis manifesta√ß√µes de comportamento indefinido que ocorrem no c ++ quando uma fun√ß√£o n√£o nula √© conclu√≠da sem chamar retorno ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Um estudo de um comportamento vago</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499020/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O artigo explora as poss√≠veis manifesta√ß√µes de comportamento indefinido que ocorrem no c ++ quando uma fun√ß√£o n√£o nula √© conclu√≠da sem chamar retorno com um valor adequado. </font><font style="vertical-align: inherit;">O artigo √© mais cient√≠fico e divertido do que pr√°tico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quem n√£o gosta de se divertir pulando em um ancinho - passamos, n√£o paramos.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdu√ß√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo mundo sabe que, ao desenvolver c√≥digo c ++, voc√™ n√£o deve permitir um comportamento indefinido. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Contudo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comportamento indefinido pode n√£o parecer perigoso o suficiente devido √† abstra√ß√£o das poss√≠veis conseq√º√™ncias;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nem sempre √© claro onde est√° a linha.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos tentar especificar as poss√≠veis manifesta√ß√µes de comportamento indefinido que ocorrem em um caso bastante simples - em uma fun√ß√£o n√£o nula, n√£o h√° retorno. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, considere o c√≥digo gerado pelos compiladores mais populares em diferentes modos de otimiza√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pesquisa no Linux ser√° realizada usando o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compiler Explorer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pesquisa no Windows e no macOs X - no hardware diretamente dispon√≠vel para mim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas as compila√ß√µes ser√£o feitas para x86-x64. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nenhuma medida ser√° tomada para aprimorar ou suprimir avisos / erros do compilador.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Haver√° muito c√≥digo desmontado. </font><font style="vertical-align: inherit;">Seu design, infelizmente, √© heterog√™neo, porque </font><font style="vertical-align: inherit;">Eu tenho que usar v√°rias ferramentas diferentes (bem, pelo menos eu consegui obter a sintaxe da Intel em todos os lugares). </font><font style="vertical-align: inherit;">Farei coment√°rios moderadamente detalhados sobre c√≥digo desmontado, que, no entanto, n√£o eliminam a necessidade de conhecimento dos registros do processador e dos princ√≠pios da pilha.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ler Padr√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rascunho final C ++ 11 n3797, rascunho final C ++ 14 N3936:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.6.3 A declara√ß√£o de retorno </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fluir do final de uma fun√ß√£o √© equivalente a um retorno sem valor; </font><font style="vertical-align: inherit;">isso resulta em </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
comportamento </font><font style="vertical-align: inherit;">indefinido </font><font style="vertical-align: inherit;">em uma fun√ß√£o de retorno de valor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atingir o final de uma fun√ß√£o √© equivalente a retornar sem um valor de retorno; </font><font style="vertical-align: inherit;">para uma fun√ß√£o cujo valor de retorno √© fornecido, isso leva a um comportamento indefinido.</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Projeto C ++ 17 n4713</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.6.3 A declara√ß√£o de retorno </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fluir do final de um construtor, destruidor ou fun√ß√£o com um tipo de retorno cv void √© equivalente a um retorno sem operando. </font><font style="vertical-align: inherit;">Caso contr√°rio, o fluxo do final de uma fun√ß√£o que n√£o seja main (6.8.3.1) resulta em comportamento indefinido. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atingir o final de um construtor, destruidor ou fun√ß√£o com um valor de retorno nulo (possivelmente com qualificadores const e vol√°teis) √© equivalente a retornar sem um valor de retorno. </font><font style="vertical-align: inherit;">Para todas as outras fun√ß√µes, isso leva a um comportamento indefinido (exceto para a fun√ß√£o principal).</font></font><br>
</blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que isso significa na pr√°tica? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se a assinatura da fun√ß√£o fornecer um valor de retorno:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sua execu√ß√£o deve terminar com uma declara√ß√£o de retorno com uma inst√¢ncia do tipo apropriado;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">caso contr√°rio, comportamento vago;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o comportamento indefinido n√£o inicia no momento em que a fun√ß√£o √© chamada e n√£o no momento em que o valor retornado √© usado, mas a partir do momento em que a fun√ß√£o n√£o √© conclu√≠da corretamente;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se a fun√ß√£o contiver caminhos de execu√ß√£o corretos e incorretos - o comportamento indefinido ocorrer√° apenas em caminhos incorretos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o comportamento indefinido em quest√£o n√£o afeta a execu√ß√£o das instru√ß√µes contidas no corpo da fun√ß√£o.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A frase sobre a fun√ß√£o principal n√£o √© uma novidade do c ++ 17 - nas vers√µes anteriores do Padr√£o, uma exce√ß√£o semelhante foi descrita na se√ß√£o 3.6.1 Fun√ß√£o principal.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo 1 - bool</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em c ++, n√£o existe um tipo com um estado mais simples que bool. </font><font style="vertical-align: inherit;">Vamos come√ßar com ele.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O MSVC fornece um erro de compila√ß√£o C4716 para esse exemplo; portanto, o c√≥digo do MSVC precisar√° ser um pouco complicado, fornecendo pelo menos um caminho de execu√ß√£o correto:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compila√ß√£o:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plataforma</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilador</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado da compila√ß√£o</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-x64 Clang 10.0.0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aviso: a fun√ß√£o non-void n√£o retorna um valor [-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-x64 gcc 9.3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aviso: nenhuma instru√ß√£o return na fun√ß√£o retornando non-void [-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mac OS X</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apple clang vers√£o 11.0.0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aviso: o controle atinge o final da fun√ß√£o n√£o nula [-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">janelas</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSVC 2019 16.5.4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O exemplo original √© o erro C4716, complicado - aviso C4715: nem todos os caminhos de controle retornam um valor</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resultados da execu√ß√£o:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otimiza√ß√£o</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retorno do programa</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sa√≠da do console</font></font></b></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem sa√≠da</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem sa√≠da</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem sa√≠da</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang vers√£o 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0, -O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, exemplo original</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem constru√ß√£o</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem constru√ß√£o</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo complicado do Windows MSVC 2019 16.5.4</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41.</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1 / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 1</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo neste exemplo mais simples, quatro compiladores demonstraram pelo menos tr√™s maneiras de exibir um comportamento indefinido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos descobrir o que esses compiladores compilaram l√°.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O0</font></font></h4><br>
<img src="https://habrastorage.org/webt/yc/pg/vw/ycpgvw4062ruxbxhec61lpr5oec.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A √∫ltima instru√ß√£o na fun√ß√£o bad () √© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descri√ß√£o das instru√ß√µes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do Manual do desenvolvedor de software das arquiteturas Intel 64 e IA-32</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote>UD2‚ÄîUndefined Instruction<br>
Generates an invalid opcode exception. This instruction is provided for software testing to explicitly generate an invalid opcode exception. The opcode for this instruction is reserved for this purpose.<br>
Other than raising the invalid opcode exception, this instruction has no effect on processor state or memory.<br>
<br>
Even though it is the execution of the UD2 instruction that causes the invalid opcode exception, the instruction pointer saved by delivery of the exception references the UD2 instruction (and not the following instruction).<br>
<br>
This instruction‚Äôs operation is the same in non-64-bit modes and 64-bit mode.<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em suma, esta √© uma instru√ß√£o especial para lan√ßar uma exce√ß√£o. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ precisa encerrar a chamada bad () em uma tentativa ... catch! Block </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o importa como. </font><font style="vertical-align: inherit;">Esta n√£o √© uma exce√ß√£o c ++. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â poss√≠vel pegar o ud2 em tempo de execu√ß√£o? </font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No Windows, __try deve ser usado para isso; no Linux e macOs X, o manipulador de sinal SIGILL.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/qg/al/gl/qgalgl3q6xaqajpp2kdjqxpbp9m.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado da otimiza√ß√£o, o compilador simplesmente pegou e jogou fora o corpo da fun√ß√£o bad () e sua chamada.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br>
<img src="https://habrastorage.org/webt/a7/ny/2g/a7ny2ghbcx-bj4a73pqzu_y_eam.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Explica√ß√µes (na ordem inversa, porque neste caso a cadeia √© mais f√°cil de analisar a partir do final): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. O operador de sa√≠da no fluxo √© chamado para bool (linha 14); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. O endere√ßo std :: cout √© colocado no registrador edi - este √© o primeiro argumento do operador de sa√≠da no fluxo (linha 13); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. O conte√∫do do registro eax √© colocado no registro esi - este √© o segundo argumento do operador de sa√≠da no fluxo (linha 12); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Os tr√™s bytes altos de eax s√£o redefinidos para zero, o valor de al n√£o muda (linha 11); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. A fun√ß√£o bad () √© chamada (linha 10); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0. A fun√ß√£o bad () deve colocar o valor de retorno no registro al. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em vez disso, a linha 4 mostra nop (sem opera√ß√£o, simulado). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um byte de lixo do registro al √© enviado para o console. </font><font style="vertical-align: inherit;">O programa termina normalmente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O1, -O2, -O3</font></font></h4><br>
<img src="https://habrastorage.org/webt/dp/sl/yh/dpslyhnvjwxt2c24ifgw6lgpxnu.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O compilador jogou tudo como resultado da otimiza√ß√£o.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang vers√£o 11.0.0, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fun√ß√£o main (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ey/kl/aw/eyklawd5cgswoa14yg-h8iotxkq.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O caminho do argumento booleano do operador de sa√≠da para o fluxo (desta vez na ordem direta): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. O conte√∫do do registro al √© colocado no registro edx (linha 8); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Todos os bits do registrador edx s√£o zerados, exceto o mais baixo (linha 9); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Um ponteiro para std :: cout √© colocado no registrador rdi - este √© o primeiro argumento do operador de sa√≠da no fluxo (linha 10); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. O conte√∫do do registrador edx √© colocado no registrador esi - este √© o segundo argumento para o operador de sa√≠da no fluxo (linha 11); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. A instru√ß√£o de sa√≠da √© chamada no fluxo para bool (linha 13); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o principal espera obter o resultado da fun√ß√£o bad () do registro al. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o bad (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v5/tx/1p/v5tx1pohulp-fewcheimnj0wnkk.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. O valor do pr√≥ximo byte da pilha, ainda n√£o alocado, √© colocado no registrador al (linha 4);</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Todos os bits do registro al s√£o excetuados, exceto os menos significativos (linha 5); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um pouco de lixo da pilha n√£o alocada √© enviado para o console. </font><font style="vertical-align: inherit;">Aconteceu que, durante uma execu√ß√£o de teste, foi zero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O programa termina normalmente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang vers√£o 11.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/zh/mm/t0/zhmmt0z4yvmtiunqa287sdu9lky.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O argumento booleano do operador de sa√≠da no fluxo √© anulado (linha 5). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A chamada bad () foi lan√ßada durante a otimiza√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O programa sempre exibe zero no console e sai normalmente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, Exemplo avan√ßado, / Od</font></font></h4><br>
<img src="https://habrastorage.org/webt/pb/iz/ku/pbizkuhiff8y37zk6i2ea1qrwb8.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pode-se observar que a fun√ß√£o bad () deve fornecer um valor de retorno no registro al. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/ej/zn/auejznebzsjq0n_e4kgtbkfd5ae.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O valor retornado pela fun√ß√£o bad () √© primeiro empurrado para a pilha e depois para o registrador edx para que a sa√≠da seja transmitida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um √∫nico byte de lixo do registrador al √© enviado ao console (se um pouco mais precisamente, ent√£o o byte baixo do resultado de rand ()). </font><font style="vertical-align: inherit;">O programa termina normalmente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo complicado do Windows MSVC 2019 16.5.4, / O1, / O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/mk/wr/jy/mkwrjyimc1tfaqfzq_hzuorcaba.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O compilador for√ßou for√ßosamente a chamada bad (). </font><font style="vertical-align: inherit;">Fun√ß√£o principal:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">copia um byte do ebx da mem√≥ria localizada em [rsp + 30h];</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se rand () retornou zero, copie a unidade de ecx para ebx (linha 11);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">copia o mesmo valor para dl (mais precisamente, seu byte menos significativo) (linha 13);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chama a fun√ß√£o de sa√≠da no fluxo, que gera o valor dl (linha 14).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um byte de lixo da RAM (do endere√ßo rsp + 30h) √© enviado para o fluxo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A conclus√£o do exemplo 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os resultados da considera√ß√£o das listagens de desmontagem s√£o mostrados na tabela:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otimiza√ß√£o</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retorno do programa</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sa√≠da do console</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Causa</font></font></b></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem sa√≠da</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem sa√≠da</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A sa√≠da do console e a chamada para a fun√ß√£o bad () foram lan√ßadas como resultado da otimiza√ß√£o</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um byte de lixo do registro al</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem sa√≠da</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A sa√≠da do console e a chamada para a fun√ß√£o bad () foram lan√ßadas como resultado da otimiza√ß√£o</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang vers√£o 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco de lixo da RAM</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chamada de fun√ß√£o inv√°lida () substitu√≠da por zero</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, exemplo original</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem constru√ß√£o</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem constru√ß√£o</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem constru√ß√£o</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo complicado do Windows MSVC 2019 16.5.4</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41.</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um byte de lixo do registro al</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1 / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um byte de lixo da RAM</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como se viu, os compiladores n√£o demonstraram 3, mas at√© 6 variantes de comportamento indefinido - pouco antes de considerar as listagens dos desmontadores, n√£o conseguimos distinguir algumas delas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo 1a - Gerenciando comportamento indefinido</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos tentar orientar um pouco com comportamento indefinido - afetar o valor retornado pela fun√ß√£o bad (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso s√≥ pode ser feito com compiladores que produzem lixo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, remova os valores desejados dos locais de onde os compiladores os levar√£o.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o bad () vazia n√£o modifica o valor do registrador al, como o c√≥digo de chamada exige. </font><font style="vertical-align: inherit;">Portanto, se colocarmos um certo valor em al antes de chamar bad (), esperamos ver esse valor como resultado da execu√ß√£o de bad (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, isso pode ser feito chamando qualquer outra fun√ß√£o que retorne bool. </font><font style="vertical-align: inherit;">Mas isso tamb√©m pode ser feito usando uma fun√ß√£o que retorna, por exemplo, char n√£o cantado.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de exemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">goodTrue</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> rand();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">goodFalse</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> !goodTrue();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">goodChar</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch)</span>
</span>{
    <span class="hljs-keyword">return</span> ch;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    goodTrue();<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodChar(<span class="hljs-number">85</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodFalse();<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodChar(<span class="hljs-number">240</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sa√≠da para o console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No exemplo para MSVC, a fun√ß√£o bad () retorna o byte baixo do resultado de rand (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sem modificar a fun√ß√£o bad (), o c√≥digo externo pode afetar seu valor de retorno modificando o resultado de rand ().</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de exemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">control</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> value)</span>
</span>{
    <span class="hljs-keyword">uint32_t</span> count = <span class="hljs-number">0</span>;<font></font>
    srand(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">while</span> ((rand() &amp; <span class="hljs-number">0xff</span>) != value) {<font></font>
        ++count;<font></font>
    }<font></font>
<font></font>
    srand(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {<font></font>
        rand();<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    control(<span class="hljs-number">1</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">85</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">0</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">240</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sa√≠da para o console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / O1, / O2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para n√£o influenciar o valor "retornado" pela fun√ß√£o bad (), basta criar uma vari√°vel de pilha. </font><font style="vertical-align: inherit;">Para que o registro n√£o seja descartado durante a otimiza√ß√£o, voc√™ deve marc√°-lo como vol√°til.</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de exemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch = <span class="hljs-number">1</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">85</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">240</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sa√≠da para o console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang vers√£o 11.0.0, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de chamar bad (), voc√™ deve inserir um determinado valor nessa c√©lula de mem√≥ria, que ser√° um a menos que o topo da pilha no momento de chamar bad ().</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de exemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">putToStack</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> value)</span>
</span>{
    <span class="hljs-keyword">uint8_t</span> memory[<span class="hljs-number">1</span>]{value};<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    putToStack(<span class="hljs-number">20</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">55</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">0xfe</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">11</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
      -O0,         memory.          ,    .<br>
<br>
   memory      ,   ‚Äî       ,    ,   .<br>
<br>
   , ..        ,      ‚Äî   putToStack     .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sa√≠da para o console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que aconteceu: √© poss√≠vel alterar a sa√≠da da fun√ß√£o bad (), e apenas o bit de baixa ordem √© levado em considera√ß√£o.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A conclus√£o do exemplo 1a</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um exemplo tornou poss√≠vel verificar a interpreta√ß√£o correta das listagens de desmontadores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo 1b - bool quebrado</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, voc√™ pensa: "41" ser√° exibido no console em vez de "1" ... Isso √© perigoso? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos verificar dois compiladores que fornecem um byte inteiro de lixo.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de exemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">bool</span> badBool1 = bad();
    <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (badBool1) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (!badBool1) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sa√≠da para o console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 35 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): false </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(badBool1 == true || badBool1 == false || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , verdadeiro, falso} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, verdadeiro, falso} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O comportamento indefinido levou ao aparecimento de uma vari√°vel booleana que quebra pelo menos:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operadores de compara√ß√£o para valores booleanos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fun√ß√£o hash de valor booleano.</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / O1, / O2</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de exemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch = <span class="hljs-number">213</span>;
  <span class="hljs-keyword">bool</span> badBool1 = bad();<font></font>
  ch = <span class="hljs-number">137</span>;
  <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (!badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sa√≠da para o console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 213 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 137 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): false </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(badBool1 == true || badBool1 == false || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , verdadeiro, falso} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, verdadeiro, falso} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O trabalho com uma vari√°vel booleana corrompida n√£o mudou quando a otimiza√ß√£o foi ativada.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de exemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">goodChar</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch)</span>
</span>{
  <span class="hljs-keyword">return</span> ch;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  goodChar(<span class="hljs-number">213</span>);
  <span class="hljs-keyword">bool</span> badBool1 = bad();<font></font>
<font></font>
  goodChar(<span class="hljs-number">137</span>);
  <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (!badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sa√≠da para o console:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 213 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 137 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): true </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
(badBool1 == true || badBool1 == false || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , verdadeiro, falso} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, verdadeiro, falso} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font><br>
</b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comparado ao MSVC, o gcc tamb√©m adicionou a opera√ß√£o incorreta do operador not.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A conclus√£o do exemplo 1b</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A interrup√ß√£o das opera√ß√µes b√°sicas com valores booleanos pode ter s√©rias conseq√º√™ncias para a l√≥gica de alto n√≠vel. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que isso aconteceu? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como algumas opera√ß√µes com vari√°veis ‚Äã‚Äãbooleanas s√£o implementadas sob a suposi√ß√£o de que true √© estritamente uma unidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o vamos considerar essa quest√£o no desmontador - o artigo acabou sendo volumoso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais uma vez, esclareceremos a tabela com o comportamento dos compiladores:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otimiza√ß√£o</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retorno do programa</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sa√≠da do console</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Causa</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consequ√™ncias do uso do resultado de bad ()</font></font></b></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem sa√≠da</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem sa√≠da</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A sa√≠da do console e a chamada para a fun√ß√£o bad () foram lan√ßadas como resultado da otimiza√ß√£o</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um byte de lixo do registro al</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Viola√ß√£o do trabalho: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
n√£o; </font><font style="vertical-align: inherit;">==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hash.</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem sa√≠da</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A sa√≠da do console e a chamada para a fun√ß√£o bad () foram lan√ßadas como resultado da otimiza√ß√£o</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">macOs X Apple clang vers√£o 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco de lixo da RAM</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chamada de fun√ß√£o inv√°lida () substitu√≠da por zero</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, exemplo original</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem constru√ß√£o</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem constru√ß√£o</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem constru√ß√£o</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo complicado do Windows MSVC 2019 16.5.4</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41.</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um byte de lixo do registro al</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Viola√ß√£o do trabalho: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hash.</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1 / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um byte de lixo da RAM</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Viola√ß√£o do trabalho: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hash.</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quatro compiladores deram 7 manifesta√ß√µes diferentes de comportamento indefinido.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo 2 - struct</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos dar um exemplo um pouco mais complicado:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; rnd &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A estrutura de teste requer um √∫nico par√¢metro do tipo int para construir. </font><font style="vertical-align: inherit;">As mensagens de diagn√≥stico s√£o enviadas pelo construtor e destruidor. </font><font style="vertical-align: inherit;">A fun√ß√£o bad (int) possui dois caminhos de execu√ß√£o v√°lidos, nenhum dos quais ser√° implementado em uma √∫nica chamada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desta vez - primeiro a tabela, depois a an√°lise do desmontador em pontos obscuros.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otimiza√ß√£o</font></font></b></td>
<td><b>Program return</b></td>
<td><b>Console output</b></td>
<td><b></b></td>
</tr>
<tr>
<td colspan="4"><b>Linux x86-x64 Clang 10.0.0</b></td>
</tr>
<tr>
<td>-O0</td>
<td>255</td>
<td>rnd: 1804289383</td>
<td>ud2</td>
</tr>
<tr>
<td>-O1, -O2</td>
<td>0</td>
<td>rnd: 1804289383<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>Linux x86-x64 gcc 9.3</b></td>
</tr>
<tr>
<td>-O0</td>
<td>0</td>
<td>rnd: 1804289383<br>
4198608<br>
Test::~Test()</td>
<td>nop       .<br>
value    .</td>
</tr>
<tr>
<td>-O1, -O2, -O3</td>
<td>0</td>
<td>rnd: 1804289383<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>macOs X Apple clang version 11.0.0</b></td>
</tr>
<tr>
<td>-O0</td>
<td>The program has unexpectedly finished.</td>
<td>rnd: 16807</td>
<td>ud2</td>
</tr>
<tr>
<td>-O1, -O2</td>
<td>0</td>
<td>rnd: 16807<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>Windows MSVC 2019 16.5.4</b></td>
</tr>
<tr>
<td>/Od /RTCs</td>
<td>Access violation reading location 0x00000000CCCCCCCC</td>
<td>rnd: 41</td>
<td>  MSVC stack frame run-time error checking</td>
</tr>
<tr>
<td>/Od, /O1, /O2</td>
<td>0</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rnd: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8791061810776 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test :: ~ Test ()</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lixo de um local de mem√≥ria cujo endere√ßo est√° em rax</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Novamente, vemos muitas op√ß√µes: al√©m do j√° conhecido ud2, existem pelo menos 4 comportamentos diferentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manuseio do compilador com um construtor √© muito interessante:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em alguns casos, a execu√ß√£o continuou sem chamar o construtor - nesse caso, o objeto estava em algum estado aleat√≥rio;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em outros casos, uma chamada de construtor n√£o foi fornecida no caminho de execu√ß√£o, o que √© bastante estranho.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/z7/cq/ry/z7cqry23rk0ul156zrdhnedehl0.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Somente uma compara√ß√£o √© feita no c√≥digo (linha 14) e h√° apenas um salto condicional (linha 15). </font><font style="vertical-align: inherit;">O compilador ignorou a segunda compara√ß√£o e o segundo salto condicional. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso leva √† suspeita de que o comportamento indefinido come√ßou mais cedo do que o padr√£o prescreve. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas verificar a condi√ß√£o do segundo se n√£o cont√©m efeitos colaterais, e a l√≥gica do compilador funcionou da seguinte maneira:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se a segunda condi√ß√£o for verdadeira - voc√™ precisar√° chamar o construtor Test com o argumento 142;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se a segunda condi√ß√£o n√£o for verdadeira, a fun√ß√£o sair√° sem retornar um valor, o que significa comportamento indefinido no qual o compilador pode fazer qualquer coisa. </font><font style="vertical-align: inherit;">Incluindo - chame o mesmo construtor com o mesmo argumento;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verifica√ß√£o √© sup√©rflua; o construtor Test com argumento 142 pode ser chamado sem verificar a condi√ß√£o.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver o que acontece se a segunda verifica√ß√£o contiver uma condi√ß√£o com efeitos colaterais:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == rand()) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == rand()) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; rnd &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<img src="https://habrastorage.org/webt/j5/mi/-w/j5mi-w148l3tnejie9aaxus5nr8.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O compilador reproduziu honestamente todos os efeitos colaterais pretendidos, chamando rand () (linha 16), dissipando assim d√∫vidas sobre o in√≠cio inadequado inadequado de um comportamento indefinido.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od / RTCs</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A op√ß√£o / RTCs permite a verifica√ß√£o de erros em tempo de execu√ß√£o do quadro da pilha. Esta op√ß√£o est√° dispon√≠vel apenas no conjunto de depura√ß√£o. Considere o c√≥digo desmontado do segmento main (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kl/sr/4y/klsr4ygrimmzxwbwuqtvfd3xvmy.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de chamar bad (int) (linha 4), os argumentos s√£o preparados - o valor da vari√°vel rnd √© copiado para o registrador edx (linha 2) e o endere√ßo efetivo de alguma vari√°vel local localizada no endere√ßo √© carregado no registrador rcx rsp + 28h (linha 3). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presumivelmente, rsp + 28 √© o endere√ßo de uma vari√°vel tempor√°ria que armazena o resultado da chamada incorreta (int). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa suposi√ß√£o √© confirmada pelas linhas 19 e 20 - o endere√ßo efetivo da mesma vari√°vel √© carregado no rcx, ap√≥s o qual o destruidor √© chamado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, no intervalo das linhas 4-18, essa vari√°vel n√£o √© acessada, apesar da sa√≠da do valor do seu campo de dados para transmitir.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como vimos nas listagens anteriores da MSVC, o argumento para o operador de sa√≠da do fluxo deve ser esperado no registro rdx. </font><font style="vertical-align: inherit;">O registro rdx obt√©m o resultado da desreferencia do endere√ßo localizado em rax (linha 9). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, o c√≥digo de chamada espera de bad (int):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">preenchendo uma vari√°vel cujo endere√ßo √© passado atrav√©s do registro rcx (aqui vemos o RVO em a√ß√£o);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornando o endere√ßo dessa vari√°vel atrav√©s do registro rax.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos passar a listar bad (int):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c3/vm/-x/c3vm-xwuhghbvtp6byyqwf6l6xg.png" alt="imagem"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em eax, o valor 0xCCCCCCCC √© inserido, o que vimos na mensagem de viola√ß√£o de acesso (linha 9) (observe que s√£o apenas 4 bytes, enquanto na mensagem de AccessViolation o endere√ßo consiste em 8 bytes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o comando rep stos √© chamado, executando ciclos 0xC de grava√ß√£o do conte√∫do do eax na mem√≥ria, iniciando no endere√ßo rdi (linha 10). </font><font style="vertical-align: inherit;">S√£o 48 bytes - exatamente o que est√° alocado na pilha na linha 6;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nos caminhos de execu√ß√£o corretos, o valor de rsp + 40h √© inserido em rax (linhas 23, 36);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o valor do registrador rcx (atrav√©s do qual main () passou o endere√ßo de destino) √© empurrado para a pilha em rsp + 8 (linha 4);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rdi √© empurrado para a pilha, o que reduz a rsp em 8 (linha 5);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os bytes de 30 h s√£o alocados na pilha diminuindo a rsp (linha 6).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, rsp + 8 na linha 4 e rsp + 40h no restante do c√≥digo t√™m o mesmo valor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo √© bastante confuso como </font><font style="vertical-align: inherit;">n√£o usa rbp. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° dois acidentes na mensagem de viola√ß√£o de acesso:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zeros na parte superior do endere√ßo - pode haver algum lixo;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acidentalmente, o endere√ßo estava incorreto.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aparentemente, a op√ß√£o / RTCs ativou a substitui√ß√£o da pilha com certos valores diferentes de zero, e a mensagem Viola√ß√£o de acesso foi apenas um efeito colateral aleat√≥rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver como o c√≥digo com a op√ß√£o / RTCs ativada difere do c√≥digo sem ele. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r4/ai/gh/r4aighkarr9kdcerpk60u6jvdya.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O c√≥digo para se√ß√µes de main () difere apenas nos endere√ßos de vari√°veis ‚Äã‚Äãlocais na pilha. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/oi/zt/kqoizt0khccfqovtmw6qn_--xiq.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(para maior clareza, coloquei duas vers√µes da fun√ß√£o ruim (int) lado a lado - com / RTCs e sem) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sem os / RTCs, a instru√ß√£o rep stos desapareceu e preparou argumentos para ela no in√≠cio da fun√ß√£o.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo 2a</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais uma vez, tente controlar o comportamento indefinido. </font><font style="vertical-align: inherit;">Desta vez para apenas um compilador.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od / RTCs</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com a op√ß√£o / RTCs, o compilador insere c√≥digo no in√≠cio da fun√ß√£o incorreta (int) que preenche a metade inferior do rax com um valor fixo, o que pode levar a uma viola√ß√£o do Access. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para alterar esse comportamento, basta preencher rax com algum endere√ßo v√°lido. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso pode ser alcan√ßado com uma modifica√ß√£o muito simples: adicione a sa√≠da de algo para std :: cout no corpo ruim (int).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de exemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; v &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rnd: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8791039331928 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Test :: ~ Test ()</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
operador &lt;&lt; retorna um link para o fluxo, que √© implementado como a coloca√ß√£o do endere√ßo std :: cout em rax. </font><font style="vertical-align: inherit;">O endere√ßo est√° correto, pode ser desreferenciado. </font><font style="vertical-align: inherit;">A viola√ß√£o de acesso √© impedida.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando os exemplos mais simples, fomos capazes de:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coletar cerca de 10 manifesta√ß√µes diferentes de comportamento indefinido;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aprenda em detalhes exatamente como essas op√ß√µes ser√£o executadas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos os compiladores demonstraram ades√£o estrita ao Padr√£o - em nenhum exemplo o comportamento indefinido come√ßou mais cedo. </font><font style="vertical-align: inherit;">Mas voc√™ n√£o pode recusar uma fantasia para desenvolvedores de compiladores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Freq√ºentemente, a manifesta√ß√£o depende de nuances sutis: vale a pena adicionar ou remover uma linha de c√≥digo aparentemente irrelevante - e o comportamento do programa muda significativamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, √© mais f√°cil n√£o escrever esse c√≥digo do que resolver quebra-cabe√ßas mais tarde.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499008/index.html">Por que os desenvolvedores s√£o t√£o lentos: problemas comuns e suas solu√ß√µes</a></li>
<li><a href="../pt499010/index.html">Estudamos o mecanismo VoIP do Mediastreamer2. Parte 11</a></li>
<li><a href="../pt499014/index.html">23 perguntas dif√≠ceis para entrevistas em JavaScript</a></li>
<li><a href="../pt499016/index.html">Integra√ß√£o com ESIA para .Net: mais f√°cil do que parece</a></li>
<li><a href="../pt499018/index.html">6 aplicativos de esportes em casa</a></li>
<li><a href="../pt499030/index.html">Monitorando o desempenho do MySQL para Grafana on isic em 20 minutos</a></li>
<li><a href="../pt499032/index.html">Como usar o Prometheus para detectar anomalias no GitLab</a></li>
<li><a href="../pt499034/index.html">Como implantar refatora√ß√£o perigosa para produzir com um milh√£o de usu√°rios?</a></li>
<li><a href="../pt499036/index.html">Trabalho do fornecedor: uma sele√ß√£o de materiais sobre protocolos, TI e infraestrutura de rede</a></li>
<li><a href="../pt499038/index.html">Minha experi√™ncia usando um monitor vertical</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>