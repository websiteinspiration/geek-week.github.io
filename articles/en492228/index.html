<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèº üëÇüèº üåá As Sports.ru wrote their WYSIWYG editor üñêÔ∏è üë®‚Äçüéì üö∂üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In mid-2018, Sports.ru thought about moving to a new WYSIWYG text editor for user posts. Since June 2019, the editor has been in beta mode. During thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>As Sports.ru wrote their WYSIWYG editor</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sports_ru/blog/492228/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In mid-2018, Sports.ru thought about moving to a new </font></font><abbr title="What you see is what you get"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WYSIWYG</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> text editor for user posts. </font><font style="vertical-align: inherit;">Since June 2019, the editor has been in beta mode. </font><font style="vertical-align: inherit;">During this time, we solved many problems associated with both the design of the architecture of the entire service and the implementation of the editor itself in the browser based on the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProseMirror</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">, and decided to share our experience.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wc/2p/ag/wc2pagubhgtlo-bvev4wjyfmrsk.png"><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table of contents</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Introduction </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Why did you need WYSIWYG </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2. </font><font style="vertical-align: inherit;">Description of the task that the developers faced </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. How to choose the tool </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. What happened </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1. </font><font style="vertical-align: inherit;">Service architecture </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2. </font><font style="vertical-align: inherit;">What are the challenges </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Beta Test Results</font></font></a><br>
<br>
<a name="Intro"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Introduction</font></font></h2><br>
<a name="Why"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Why did you need WYSIWYG</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sports.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is media about sports with an audience of 20 million users per month. Our main differences from classic media are the community and </font></font><abbr title="User Generated Content"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UGC</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . User content - ratings, comments, chats, posts - not only complements the editorial value, but also creates a platform for users to interact with each other. Every month, our users write almost 10 thousand posts. The best of them are submitted to the main page of the site together with the editorial ones, sent to mobile applications, social networks. User content accounts for about 40% of all reads on Sports.ru pages. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We want to be the most convenient platform for sports authors, to help create content and deliver it to an interested audience. 10 years we used the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">TinyMCE</font></a><font style="vertical-align: inherit;"> editor</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- and in the end it became outdated, it ceased to suit both the team and users who were used to modern editors. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ff/ub/ig/ffubigpbednsp8phz7btg-icbm8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">1. The interface of the old editor based on TinyMCE</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
From the authors of blogs regularly received about the following complaints:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I wrote for a long time, then accidentally closed the tab and everything was gone;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">writing long texts is very inconvenient;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It‚Äôs annoying that to insert each image, you must first upload it to the image hosting.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The team also had its own complaints:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in TinyMCE you cannot upload images directly from a file, you can only attach links to images, and due to the fact that users were not able to upload images to our storage, if links to them died, we could not do anything about it;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the possibilities for editing and formatting the text are not balanced. </font><font style="vertical-align: inherit;">On the one hand, there were not enough styles, for example, for internal headers in the text. </font><font style="vertical-align: inherit;">On the other hand, it was possible to use the available tools in any combination. </font><font style="vertical-align: inherit;">As a result, the posts looked not uniform (at Sports.ru, work began on the implementation of the design system and user posts should look in accordance with it);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">content is created and stored in HTML, so it‚Äôs difficult to manage styles in posts on different clients, and just make changes to the layout of posts.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next is a story about how we solved the problem of creating a new editor on the front-end side. </font><font style="vertical-align: inherit;">True, there will also be something about the product, design and backend parts, because without this it will be difficult to understand why a particular decision was made at the front end.</font></font><br>
<br>
<a name="Task"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2. </font><font style="vertical-align: inherit;">Description of the task facing the developers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In short, the thesis from which we initially drew upon: blogging on Sports.ru is a pain. </font><font style="vertical-align: inherit;">In principle, it would be possible not to make a new editor, but simply add autosave and the ability to upload pictures to your own storage - and most of the complaints from users and employees would disappear. </font><font style="vertical-align: inherit;">But I still wanted not to support the tool on old technologies, but to create a new modern editor that we can easily develop and scale.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the inconvenient interface, one of the main technical problems of the old editor was that the content of the post was saved immediately as an HTML string, and changes in the appearance of the post either required the intervention of backend developers, or were implemented in runtime on the client (for example, the placement of ad units in the body of the post). Our task, among other things, was to separate the data from their presentation and, accordingly, leave the layout and interface in the client code, and work with the data in the server code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a role model, we took </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Medium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sometimes spying on ideas from </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Doc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In addition to solving the problems already identified, we decided to add several new features that would make using the editor more comfortable:</font></font><br>
<br>
<ul>
<li>  WYSIWYG, .. what you see is what you get (. ¬´ ,   ¬ª,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>),           ,     .     ,      ;</li>
<li>  (      ,       ,      ,   ,    ; ,           )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, the editor himself should not have been tied to the features of Sports.ru, because Sports.ru, although the flagship project in our company, is still not the only one. The company is also developing the international sports media </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tribuna</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a social network for betting enthusiasts Betting </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insider</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and has recently launched its own production studio engaged in advertising projects. Developing an online editor is expensive enough to not want to reuse this code on another site with different typesetting and styles, with its own set of tools for editing and formatting.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have a lot of text content, and before starting work on creating a new post editor, we thought about how this content should be stored. TinyMCE did not give us a choice and the content had to be stored only in HTML, which, as mentioned above, did not suit the team. As a result, we came up with our own format for storing text data that meets our requirements, and called it structured body.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Structured body is an array of objects that reflects the structure of the content. In this case, the content is divided into elements that are independent blocks, for example, paragraph, list, picture. An element stores information about what type it is and what properties it has. For example, the subtitle block describes the title in the text, it must contain the text and level fields. Accordingly, text contains the text of this heading, and level contains the level (from 1 to 4). A structured body, consisting of one second-level header, might look, for example, like this:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> structuredBody = [<font></font>
    {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;    <span class="hljs-attr">type</span>: <span class="hljs-string">'subtitle'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <span class="hljs-attr">value</span>: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    <span class="hljs-attr">text</span>: <span class="hljs-string">'    '</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <span class="hljs-attr">level</span>: <span class="hljs-number">2</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },<font></font>
    },<font></font>
];<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The transition to structured body allowed us to begin the process of separating business logic, data and their presentation. Ultimately, we want the server and clients to exchange only data. And how and why to display this data to the end user, each client will determine independently. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Content in the formatd body format is stored in JSON, and to validate its contents, we created a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSON schema</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> called structured body schema. This diagram describes all valid elements and their properties. Thus, we can be sure that wherever a structured body is needed, one set of keys and values ‚Äã‚Äãis used.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moreover, it allows different teams to use the same services to process content in this format. For example, a service for generating HTML from a structured body for displaying content or an editor for creating content. This significantly reduces the cost of developing and supporting the entire core of services related to the creation and display of content.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It was assumed that the new editor should accept input and output content exclusively in the structured body format. And here it was necessary to take into account the subtle point: since earlier the posts were immediately saved in HTML, this HTML string from the database was transmitted to the client for display (hereinafter, by the client we mean only the browser, unless otherwise specified). Now we want to store the content of all posts in the structured body, but clients can only process HTML. So, along with the task of moving to a new editor, the task of implementing a new way for clients to display posts for reading directly from structured body is simultaneously going on. We decided that it is better to eat an elephant piecemeal, so first you need to completely abandon TinyMCE, and only then take on the logic of displaying posts for reading. Moreover,not all old posts managed to translate the content into a new format, which means that these posts will always be stored only in HTML and it is necessary for them to also retain the ability to read.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Total: part of the posts (all new and old that were successfully transferred to the new format) will be stored in two formats - HTML and structured body - until the new display logic for reading is implemented, and the rest (most of the old and very very old posts) will remain only in HTML.</font></font><br>
<br>
<a name="How"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. How to choose a tool</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We had to realize the ability to edit and create a post on the client, taking into account the above features and limitations. As always, you can take a ready-made solution, or you can come up with your own. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To begin with, we examined what ready-made libraries for creating WYSIWYG editors are and whether they are suitable for us. We settled on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slate</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Draft.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProseMirror</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to storing content in a data structure, the critical moment for us was also the ability to work with Vue or pure JS, because we had already begun to move the site to a new technological stack using Vue + Vuex. In addition, I would like to expand the capabilities of the finished library with the help of new modules (third-party or self-written) if necessary.</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tab. </font><font style="vertical-align: inherit;">1. Comparison of the reviewed libraries by the most important parameters for Sports.ru</font></font></i><br>
<img src="https://habrastorage.org/webt/fw/hf/xa/fwhfxa6ozwkyfdpdj8t6j5lcbuy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As you can see from the table, ProseMirror fully complied with our requirements, so we no longer considered the idea of ‚Äã‚Äãwriting our own library for editing text content, but began to study this library in more detail. </font><font style="vertical-align: inherit;">There is still a rather popular </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quill</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which did not get into our comparison just because we honestly forgot about it at the stage of selecting a tool. </font><font style="vertical-align: inherit;">According to our key requirements, it also passes, but it just so happened. </font><font style="vertical-align: inherit;">We already talked about what ProseMirror is and how to work with it in another </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<a name="What"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. What happened</font></font></h2><br>
<a name="Architecture"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1. </font><font style="vertical-align: inherit;">Service Architecture</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The content editor itself on the client is far from all. </font><font style="vertical-align: inherit;">You need to place the editor in an existing project, display it somewhere on the web page, and also consider interaction with the backend, solve the problem of simultaneously supporting two editors (you couldn‚Äôt immediately abandon the old one) and storing the content in two formats (HTML and structured body). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All these tasks can be divided into those related to the frontend, backend and their integration. </font><font style="vertical-align: inherit;">We are primarily concerned with front-end and integration issues, although we also mention a couple of important aspects of the back-end tasks. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Frontend services for the editor can be divided into several levels:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web page for creating and editing a post;</font></font></li>
<li>Vue-app,    .  ,  ,   Vue,         -, , , ,       ..,    ,         ,      ;</li>
<li>WYSIWYG-   ProseMirror,      Vue.      ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>;</li>
<li>SB2HTML ‚Äì    HTML  structured body,    .    , structured body ‚Äì       ,    .      ,   ,     ,      .    Sports.ru     HTML  structured body,  -     HTML  .       HTML    Node.Js,        JS-   .<br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The process of saving the post is shown in Fig. </font><font style="vertical-align: inherit;">2. The content of the post in the structured body format and its meta-data are transferred to the backend. </font><font style="vertical-align: inherit;">The backend sends content to the SB2HTML service, receives ready HTML in the response, puts all this into the database and tells the client that the post has been successfully saved, or reports an error. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/of/fp/j8/offpj883_eq2swjl-ogb6jxprks.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">2. Scheme for saving a post when creating or editing in a WYSIWYG editor</font></font></i><br>
<br>
<a name="Difficulties"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2. </font><font style="vertical-align: inherit;">What difficulties did you face?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were many difficulties, they arose constantly and often in the most unexpected moments. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we already said, the content editor is located inside the form, which allows you to enter additional data necessary to create a post, such as title, annotation, etc. For annotation, it should be possible to download images from a file and via a link from the Internet. But for content we also want to load images from a file and by reference, moreover, according to the same rules. And here we are faced with a dilemma: on the one hand, the content of a post is isolated from the external form when editing and is served by ProseMirror tools, but on the other hand, I want to observe the </font><abbr title="Don't Repeat Yourself"><font style="vertical-align: inherit;">DRY</font></abbr><font style="vertical-align: inherit;"> principle</font></font><abbr title="Don't Repeat Yourself"><font style="vertical-align: inherit;"></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and do not duplicate the same code. We solved this as follows: we described loading images as a set of methods in an object at the Vue form level and passed this object as one of the parameters to the constructor of the WYSIWYG editor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entities that describe content ‚Äî Node and Fragment ‚Äî are defined in the ProseMirror model. However, only indexes are used for a transaction to determine the range of characters to which this transaction is applied (indexes are counted both from the beginning of the document and from the beginning of the parent node). Character indexing is one of the central concepts of ProseMirror, but when editing and formatting text it is much more convenient to think about entities from the ProseMirror model. As a result, for a comfortable work with content, we wrote our helpers to simplify interaction with a document for transactions. After the beginning of our work, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiptap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">appeared</font></a><font style="vertical-align: inherit;"> , which is a set of similar helpers.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next problem was that at the stage of creating the scheme, we realized that we already have an approved internal format for storing content - a structured body that meets our needs, and ProseMirror stores the content in its own format in a story. Switching to the ProseMirror format was difficult and impractical. We found ourselves in a situation where data in one format comes to the client via the API, and another needs to be displayed. A similar situation arises when it is necessary to save modified or created content. To do this, we implemented a converter that converts formats back and forth. They wrote a simple test for him, which takes the content of one post in the formatd body format, translates it into the ProseMirror format, then back and already compares the original version with the received one. It turned out quickly and easily.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the future, as the document scheme changed and, as a rule, became more complicated, it became clear that the slightest change could lead to errors in the editor, and such a test seems to give very poor coverage. As a result, I had to write tests on almost all combinations of nodes and brands on two small converter methods. Now without these tests it is impossible to determine whether the next change in the circuit will break something or not.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next problem is again related to the need for backward compatibility of old and new technologies. Our WYSIWYG editor is implemented only in browsers (desktop and, soon, mobile). Accordingly, for editing content on the client is given in JSON in the format structured body, however, reading posts in browsers is carried out only from HTML. At the same time, most mobile applications have already switched to displaying user posts directly from structured body.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For mobile applications, it was necessary to provide for the case when the client cannot process some element from structured body. For example, if a new element is added to structured body, the display of which is implemented only in a newer version of the application. Since not all users update their applications at the same time, it was necessary to provide a plan ‚ÄúB‚Äù for older versions: instead of creating HTML from structured body, insert a ready-made HTML fragment for the desired element. The presence of HTML fragments for each element was not provided in the structured body scheme, because the very idea of ‚Äã‚Äãthis structure was to refuse to store data in HTML. But in the end, we came to the conclusion that we need two structured body schemes - one for display and one for editing. The differences between the schemes arethat the structured body for editing contains only the content of the article, and for display we add some additional elements. In particular, an HTML fragment for each element is created when a post is saved in the SB2HTML service and is added only to structured body to display the post. In addition, the structured body also displays advertising space in the content for display.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we open content for editing in a browser, we basically can‚Äôt encounter an unknown element, because all posts are created and displayed in the same way. But they decided to foresee such a case for the future too. To do this, we added a default stub element to the ProseMirror schema. We named this element unsupportedBlock. The stub appears in place of an unsupported item. We stylized it as a gray rectangle with text stating that this element is not supported and cannot be edited. When a post is saved, such an element remains unchanged in structured body. The user can change its location relative to other elements, but the internal content of an unknown element cannot be changed or edited. However, the user can delete such an element, then, of course,it will not be saved in the final document.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All the problems described were related to the difficulties of implementing the WYSIWYG editor itself. But while it existed in beta mode, we could not abandon the old editor on TinyMCE and were forced to support both editors, providing backward compatibility between them. For example, you could create a post in the WYSIWYG editor, save, then edit it in TinyMCE, save, reopen in WYSIWYG, and so on. As a result, when opening in WYSIWYG, we saw the same content as in the previous save in TinyMCE. To implement backward compatibility, it was necessary to submit HTML content to TinyMCE, which we already learned to create from structured body and save to the database while saving the post. And when saving a post through TinyMCE, the created content on the server is run through the HTML2SB service,as a result, we can save both fresh HTML and structured body.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HTML2SB is the opposite of what SB2HTML does, that is, converts content from HTML to structured body. </font><font style="vertical-align: inherit;">Chronologically, this service appeared earlier than anything else, because before the creation of the WYSIWYG editor, the only way to get post content in structured body format was direct parsing from HTML. </font><font style="vertical-align: inherit;">HTML2SB was part of the backend infrastructure around the post editor, but after abandoning TinyMCE, it was no longer needed.</font></font><br>
<br>
<a name="Results"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Beta Results</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now WYSIWYG-editor is available to all users in beta version, and will soon become the main editor of Sports.ru posts. </font><font style="vertical-align: inherit;">We have already received a tool for creating and editing posts that meets most of our requirements:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the editor‚Äôs interface has become clear, concise and modern, writing long posts has become much easier;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now you can download images from a file and by a link that are immediately placed in our repository;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">added the option to embed embeds from major social networks and video hosting sites;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cleaned up text formatting styles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mobile applications have already switched to displaying posts from structured body and can set their own styles for content.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, the editor is not yet fully debugged, we periodically detect new bugs. </font><font style="vertical-align: inherit;">The following updates are coming:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autosave;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WYSIWYG version for users with extended rights (administrators, full-time editors);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">creating and editing posts from mobile browsers;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Messages about parallel editing of a document by several users;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tips and onboarding;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">statistical widgets for sports teams, matches and lineups.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the time of this writing, more than 13,000 posts have already been published through the beta version of the editor, which is about 20% of the total number of user texts on Sports.ru for the period from June 2019 to February 2020 inclusive. The share of posts created and published through the new editor is growing steadily. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/2i/4b/ad2i4b4dubgv9--l-vl7ghh6cnw.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. 3. The proportion of user posts created and published in the new editor</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seems that the organic growth in the share of user posts created and published through the new editor is a signal that users are happy with the update, which is also confirmed by feedback in the announcement of its launch in beta testing (some of them are shown in Fig. 4). </font><font style="vertical-align: inherit;">Therefore, in the coming months we plan to completely transfer the creation of posts to the new editor, so as to focus only on its support and development.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, what functionality would you add to our WYSIWYG editor? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k-/bm/nz/k-bmnzzgoh5wi-nvq516-pca8uk.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fig. </font><font style="vertical-align: inherit;">4. User comments in a post with the announcement of the WYSIWYG editor update&nbsp;</font></font></i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492216/index.html">Saving Values ‚Äã‚Äãin a .Net Application at the Build Stage</a></li>
<li><a href="../en492218/index.html">Icon Design Rules to Remember</a></li>
<li><a href="../en492220/index.html">5 little-known secrets of Pandas</a></li>
<li><a href="../en492222/index.html">Write-up CTFZone Quals 2019: Chicken</a></li>
<li><a href="../en492226/index.html">Price Comparison on Managed Kubernetes (2020)</a></li>
<li><a href="../en492232/index.html">How Smartcalls became Voximplant Kit - rebranding and killer features</a></li>
<li><a href="../en492234/index.html">Research: why people are ready to receive less in social projects</a></li>
<li><a href="../en492242/index.html">M5Stack and its contacts</a></li>
<li><a href="../en492244/index.html">Removal for the period of coronavirus: home "arrest" or time of opportunity?</a></li>
<li><a href="../en492246/index.html">Coronavirus: Possible Implications for Society, Economics, and Medicine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>