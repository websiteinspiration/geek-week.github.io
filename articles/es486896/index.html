<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèïÔ∏è üë©üèº‚Äç‚úàÔ∏è üìß Autorizaci√≥n UID y Stalker en el MAG250 üë©üèº‚Äçüé® üé¶ üí¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace tiempo que me interesa el tema de la autorizaci√≥n de consolas de medios en el portal Stalker, pero no fue antes de eso. Un d√≠a, accidentalmente o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Autorizaci√≥n UID y Stalker en el MAG250</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486896/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hace tiempo que me interesa el tema de la autorizaci√≥n de consolas de medios en el portal Stalker, pero no fue antes de eso. </font><font style="vertical-align: inherit;">Un d√≠a, accidentalmente obtuve el prefijo Infomir MAG250 y decid√≠ abordar este problema.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, desarme el prefijo, solde el cable al conector y lo conecte a la computadora. </font><font style="vertical-align: inherit;">Despu√©s de lanzar el programa de terminal, me complaci√≥ el familiar U-Boot. </font><font style="vertical-align: inherit;">El proceso de arranque tambi√©n se puede interrumpir presionando cualquier tecla (por lo general, el fabricante deshabilita dichos chips y tiene que pasar mucho tiempo para llevar U-Boot al estado deseado). </font><font style="vertical-align: inherit;">El acceso con privilegios de root tambi√©n estaba disponible a trav√©s de ssh. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o-/4t/p6/o-4tp67pijj-mwgwzsxy7tcq0fu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La consola est√° equipada con DRAM de 256 MB y dos unidades flash, NOR 1 MB y NAND 256 MB. </font><font style="vertical-align: inherit;">Con NOR, U-Boot se carga en el proceso, que carga el n√∫cleo y el sistema de archivos desde NAND.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funci√≥n Getuid ()</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El prefijo se autoriza en el portal Stalker, enviando un mont√≥n de informaci√≥n, como, por ejemplo, tipo, versi√≥n de firmware, versi√≥n de hardware, n√∫mero de serie, etc. Pero estaba espec√≠ficamente interesado en el par√°metro device_id, que emiti√≥ la funci√≥n gSTB.GetUID (). A primera vista, era un hash como SHA256 o MD5. En referencia a la documentaci√≥n oficial </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soft.infomir.com/stbapi/JS/v343/gSTB.html#.GetUID</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la funci√≥n puede tomar hasta dos par√°metros, pero lo primero que me interes√≥ fue la opci√≥n sin par√°metros. Al cargar stbapp en la IDA, podemos encontrar f√°cilmente esta funci√≥n. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ev/5q/ln/ev5qlnsrhnbb2d61izfqbwqktp4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yendo un poco m√°s all√°, vemos un momento interesante</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k7/gr/ow/k7growkphe0iah5oqaidlljtgpe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠, el programa asigna 0x41 bytes de memoria, lo anula y llama a la funci√≥n del controlador / dev / stapi / stevt_ioctl, pas√°ndole este fragmento de memoria y el par√°metro 0xC004C919. </font><font style="vertical-align: inherit;">Por lo tanto, un determinado controlador stevt_ioctl es responsable de generar el UID. </font><font style="vertical-align: inherit;">Para verificar esto, esboc√© r√°pidamente este c√≥digo: al </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mo/fa/no/mofanof9n_oicnlia9xzepfbbpo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ejecutarlo en la consola, vi un UID familiar.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stevt_ioctl</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El siguiente paso es desmontar el controlador stapi_ioctl_stripped.ko, que se encuentra en / root / modules. </font><font style="vertical-align: inherit;">Cargamos el controlador en la IDA y encontramos el controlador 0xC004C919 ioctl (llam√© a esta funci√≥n calcHash). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yh/0x/ph/yh0xphq5q-bouv83w_vdpsl10js.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay tres puntos interesantes. </font><font style="vertical-align: inherit;">Primero, se copian 0x41 bytes de memoria del espacio del usuario al espacio del n√∫cleo (esto es exactamente lo que transmite el usuario y en nuestro caso consiste en ceros), la funci√≥n </font><b><font style="vertical-align: inherit;">get_mem_type</font></b><font style="vertical-align: inherit;"> se </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llama</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(en el camino en el n√∫cleo mismo) y el resultado (nuevamente 0x41 bytes) se copia en el √°rea de direcci√≥n del usuario. </font><font style="vertical-align: inherit;">Para encontrar la direcci√≥n de la funci√≥n get_mem_type, vi dos posibilidades: solo mira el archivo / proc / kallsysms, esperando que el acceso no est√© restringido, o bien, o de lo contrario, escribe un ensamblaje en ensamblador para el controlador que devuelve el valor del registro r0 en el lugar correcto. </font><font style="vertical-align: inherit;">Despu√©s de buscar en / proc / kallsysms, me sorprendi√≥ gratamente y encontr√© la direcci√≥n de la funci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_mem_type</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x8080E380.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√∫cleo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para un an√°lisis posterior, deber√° analizar el n√∫cleo. El n√∫cleo en s√≠ se puede encontrar en el firmware del fabricante, o puede eliminar el volcado utilizando U-Boot </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jy/pw/rk/jypwrkvsciffckeuityrrpxw0gk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o montar la partici√≥n deseada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n la informaci√≥n de U-Boot, el n√∫cleo se carga a 0x80800000 y el punto de entrada se encuentra a 0x80801000. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cargamos el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kernel en el IDA y encontramos la funci√≥n </font><b><font style="vertical-align: inherit;">get_mem_type</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de analizar el c√≥digo, descubr√≠ esta secci√≥n, que supuestamente devolvi√≥ el UID. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d3/fq/tf/d3fqtfjotcjbowla35u8ww7rzzg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces el UID se almacena en 0x80D635EC. A continuaci√≥n, estamos buscando en la AIF, donde se forma este valor. Esto estaba en la funci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">init_board_extra</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (no traducir√© la lista completa)</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cl/ws/l2/clwsl2szmjouku6qbpyucp2g2hc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, este es el mismo valor desconocido en la direcci√≥n del registro r4 a partir del cual se calcula el hash de inter√©s (por cierto, fill_hash fue resuelto por SHA256). </font><font style="vertical-align: inherit;">Realmente estaba ansioso por descubrir qu√© era y r√°pidamente escrib√≠ un inserto en el ensamblador, que, a trav√©s de la funci√≥n printk, devolvi√≥ el contenido de la memoria en la direcci√≥n del registro r2. </font><font style="vertical-align: inherit;">Habiendo modificado el kernel de esta manera, hice una nueva uImage y la cargu√© en una unidad USB. </font><font style="vertical-align: inherit;">Y en el conjunto de terminales U-Boot:</font></font><br>
<br>
<pre><code class="plaintext hljs">usb start<font></font>
fatload usb 0:1 80000000 uImage<font></font>
bootm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero despu√©s del √∫ltimo equipo, me esperaba tanta tristeza. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xy/pw/js/xypwjsvafjdefnqk9q4u18npeji.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
U-Boot se neg√≥ cort√©smente a enviar mi nuevo n√∫cleo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Edici√≥n de U-Boot</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para convencer a U-Boot de que inicie mi kernel, decid√≠ parchearlo en la memoria con el comando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mw</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Para comenzar, hice un volcado completo de NOR flash, que se encuentra en 0xA0000000. </font><font style="vertical-align: inherit;">Habiendo conducido el volcado a la IDA, descubr√≠ la direcci√≥n de memoria donde se copi√≥ el U-Boot. </font><font style="vertical-align: inherit;">Fue 0x8FD00000. </font><font style="vertical-align: inherit;">Nuevamente, despu√©s de deshacerme de esta parte de la memoria y ejecutar IDA, encontr√© f√°cilmente una funci√≥n que verificaba la firma. </font><font style="vertical-align: inherit;">Si todo estaba correcto, devolvi√≥ 0. Adem√°s, la llamaron en dos lugares diferentes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/on/tq/eb/ontqebdlazmflevjnrx2kx9nnkw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo que hizo exactamente esta funci√≥n no fue interesante para m√≠. </font><font style="vertical-align: inherit;">Solo necesitaba devolver 0 as√≠:</font></font><br>
<br>
<pre><code class="plaintext hljs">mov #0x0, r0<font></font>
rts<font></font>
nop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo correspondiente para U-Boot ahora era as√≠:</font></font><br>
<br>
<pre><code class="plaintext hljs">usb start<font></font>
mw.l 8fd0ec08 000b200a;<font></font>
mw.l 8fd0ec0c 00900009<font></font>
fatload usb 0:1 80000000 uImage<font></font>
bootm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces U-Boot carg√≥ felizmente mi kernel, que emiti√≥</font></font><br>
<br>
<pre><code class="plaintext hljs">EF0F3A38FF7FD567012016J04501200:1a:79:23:7e:2MAG250pq8UK0DAOQD1JzpmBx1Vwdb58f9jP7SN</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An√°lisis completo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, ¬øen qu√© consist√≠a el UID? Era un n√∫mero desconocido de 8 bytes, el n√∫mero de serie de la consola, la direcci√≥n MAC, el tipo de consola y un pedazo de basura. Queda por averiguar qu√© tipo de n√∫mero desconocido era y de d√≥nde proven√≠a la basura. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Regres√©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a la funci√≥n </font><b><font style="vertical-align: inherit;">init_board_extra nuevamente</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se tom√≥ un n√∫mero desconocido de esta secci√≥n del c√≥digo:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8g/hu/u2/8ghuu2d4buowz6plm_feo1hi9pk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠, usando la funci√≥n __ioremap, el n√∫cleo accedi√≥ a la memoria f√≠sica a 0x00000000 (que era la direcci√≥n NOR del flash), escribi√≥ 0x0F a 0x00000000, luego 0x98 a 0x000000AA y ley√≥ 8 bytes a partir de 0x000000C2. ¬øY qu√© es eso? Estos son los comandos del protocolo CFI con los que el n√∫cleo se comunic√≥ con NOR. 0x0F trajo el NOR a su estado original, y con el modificador de comando 0x98 mods CFI. En este m√≥dulo, en la direcci√≥n 0x000000C2 se encuentra el √Årea de c√≥digo de seguridad o un n√∫mero de dispositivo √∫nico de 64 bits. Aquellos. n√∫mero desconocido es un n√∫mero √∫nico de flash NOR. El siguiente es un volcado de identificaci√≥n CFI. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5y/y_/ez/5yy_eziyuvoq3pirbxmfecrjfqu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede realizar su volcado directamente en U-Boot configurando</font></font><br>
<pre><code class="plaintext hljs">mw.w a0000000 f0<font></font>
mw.w a00000aa 98<font></font>
md.b a1000000 100<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una pieza de basura era solo un juego de caracteres ordinario de 32 bytes que se coseba en el n√∫cleo mismo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n3/dz/tb/n3dztbcvv-kjjud2dhvkg25lrni.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y esta basura se procesaba antes de usar la funci√≥n de cifrado </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">swap_pairs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que simplemente cambiaba la posici√≥n de los bytes.</font></font><br>
<br>
<pre><code class="plaintext hljs">[0x00000003]&lt;-&gt;[0x0000000F]<font></font>
[0x00000005]&lt;-&gt;[0x0000001F]<font></font>
[0x00000009]&lt;-&gt;[0x00000002]<font></font>
[0x0000000A]&lt;-&gt;[0x0000001D]<font></font>
[0x00000010]&lt;-&gt;[0x00000015]<font></font>
[0x00000004]&lt;-&gt;[0x00000013]<font></font>
[0x0000000D]&lt;-&gt;[0x00000018]</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n la informaci√≥n recibida, me atrevo a suponer que la base de datos del fabricante contiene informaci√≥n sobre cada ID NOR flash y el n√∫mero de serie y la direcci√≥n MAC correspondientes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, es imposible seleccionar todo esto, pero puede escribir su propio software, que emular√° completamente la consola.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es486896/">https://habr.com/ru/post/es486896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es486880/index.html">Errores de traductores que llevaron a consecuencias desastrosas</a></li>
<li><a href="../es486884/index.html">La compa√±√≠a farmac√©utica japonesa comienza a probar drogas sintetizadas usando una red neuronal</a></li>
<li><a href="../es486888/index.html">El libro "Enfoque orientado a objetos. 5to int. ed. "</a></li>
<li><a href="../es486890/index.html">Autodesarrollo: c√≥mo no me sent√© en dos sillas y encontr√© un tercero</a></li>
<li><a href="../es486892/index.html">Contact Picker API, o c√≥mo compartir sus contactos con un navegador</a></li>
<li><a href="../es486902/index.html">Programaci√≥n Orientada a Protocolo en Swift 5.1</a></li>
<li><a href="../es486904/index.html">Mostrar a los desarrolladores el estado del control de calidad del c√≥digo fuente en SonarQube</a></li>
<li><a href="../es486908/index.html">Wulfric Ransomware es un criptor que no existe</a></li>
<li><a href="../es486912/index.html">Lowkiq. ¬øPor qu√© lo hicimos?</a></li>
<li><a href="../es486914/index.html">8. Fortinet Getting Started v6.0. Trabajar con los usuarios</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>