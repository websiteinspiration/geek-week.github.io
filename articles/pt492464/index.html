<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ûüèΩ üì§ ‚ÅâÔ∏è DBA: organize competentemente a sincroniza√ß√£o e as importa√ß√µes ü•© üîë üë®üèº‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Com o processamento complexo de grandes conjuntos de dados (diferentes processos ETL : importa√ß√µes, convers√µes e sincroniza√ß√£o com uma fonte externa),...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBA: organize competentemente a sincroniza√ß√£o e as importa√ß√µes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/492464/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com o processamento complexo de grandes conjuntos de dados (diferentes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">processos ETL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : importa√ß√µes, convers√µes e sincroniza√ß√£o com uma fonte externa), geralmente √© necess√°rio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"lembrar" temporariamente e processar imediatamente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> algo volumoso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma tarefa t√≠pica desse tipo geralmente soa algo como isto: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Aqui, o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">departamento de contabilidade carregou os</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √∫ltimos pagamentos recebidos </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">do banco do cliente</font></a><font style="vertical-align: inherit;"> , precisamos envi√°-los rapidamente para o site e vincul√°-los √†s contas".</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mas quando o volume desse "algo" come√ßa a ser medido em centenas de megabytes, e o servi√ßo Isso deve continuar a funcionar com a base no modo 24x7, existem muitos efeitos colaterais que arruinar√£o sua vida.</font></font><br>
<img src="https://habrastorage.org/webt/tl/g3/ff/tlg3ffjptyayqlu-5k06oonr_vi.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para lidar com eles no PostgreSQL (e n√£o apenas nele), voc√™ pode usar algumas op√ß√µes de otimiza√ß√£o que permitir√£o processar mais rapidamente e com menos recursos.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Para onde enviar?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, vamos decidir onde podemos fazer o upload dos dados que queremos ‚Äúprocessar‚Äù.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1 </font><font style="vertical-align: inherit;">Tabelas tempor√°rias (TABELA TEMPOR√ÅRIA)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em princ√≠pio, para o PostgreSQL, as tempor√°rias s√£o as mesmas tabelas que as outras. </font><font style="vertical-align: inherit;">Portanto, supersti√ß√µes como </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"tudo √© armazenado apenas na mem√≥ria, mas pode terminar"</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√£o incorretas </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mas existem v√°rias diferen√ßas significativas.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espa√ßo de nome pr√≥prio para cada conex√£o com o banco de dados</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se duas conex√µes tentarem fazer ao mesmo tempo </font></font><code>CREATE TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, algu√©m definitivamente obter√° um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erro de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> objetos de banco de dados </font><b><font style="vertical-align: inherit;">n√£o exclusivos</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas se ambos tentam executar </font><font style="vertical-align: inherit;">, normalmente ambos o fazem e cada um recebe </font><b><font style="vertical-align: inherit;">sua pr√≥pria c√≥pia da</font></b><font style="vertical-align: inherit;"> tabela. </font><font style="vertical-align: inherit;">E n√£o haver√° nada em comum entre eles.</font></font><code>CREATE <b>TEMPORARY</b> TABLE x</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Autodestrui√ß√£o" com desconex√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando voc√™ fecha a conex√£o, todas as tabelas tempor√°rias s√£o exclu√≠das automaticamente; portanto, </font></font><code>DROP TABLE x</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o faz sentido </font><font style="vertical-align: inherit;">executar manualmente </font><font style="vertical-align: inherit;">, exceto ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ trabalha com o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer no modo de transa√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o banco de dados continua assumindo que essa conex√£o ainda est√° ativa e tempor√°ria. a tabela ainda existe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, uma tentativa de recri√°-lo, de outra conex√£o com o pgbouncer, resultar√° em um erro. </font><font style="vertical-align: inherit;">Mas isso pode ser contornado aproveitando-se </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
√â verdade que √© melhor n√£o fazer a mesma coisa, porque ent√£o voc√™ pode "repentinamente" descobrir os dados deixados pelo "propriet√°rio anterior". </font><font style="vertical-align: inherit;">Em vez disso, √© muito melhor ler o manual e ver que, ao criar a tabela, h√° uma oportunidade de adicionar</font></font><code>CREATE TEMPORARY TABLE <b>IF NOT EXISTS</b> x</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - isto √©, quando a transa√ß√£o for conclu√≠da, a tabela ser√° exclu√≠da automaticamente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o replica√ß√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como apenas uma jun√ß√£o espec√≠fica pertence, as tabelas tempor√°rias n√£o s√£o replicadas. </font><font style="vertical-align: inherit;">Mas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isso elimina a necessidade de gravar dados duplicados</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no heap + WAL, de modo que INSERT / UPDATE / DELETE √© muito mais r√°pido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas como a tabela tempor√°ria ainda √© uma tabela "quase comum", tamb√©m n√£o pode ser criada na r√©plica. </font><font style="vertical-align: inherit;">Pelo menos por enquanto, embora o patch correspondente j√° exista h√° muito tempo.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2 </font><font style="vertical-align: inherit;">Tabelas n√£o registradas (UNLOGGED TABLE)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o que fazer, por exemplo, se voc√™ tiver algum tipo de processo ETL complicado que n√£o pode ser implementado em uma √∫nica transa√ß√£o e ainda tiver o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer no modo de transa√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou o fluxo de dados √© t√£o grande que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o h√° largura de banda suficiente por conex√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do banco de dados (leitura, um processo na CPU)? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou algumas das opera√ß√µes ocorrem de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forma ass√≠ncrona</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em conex√µes diferentes? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe apenas uma op√ß√£o: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">criar temporariamente uma tabela n√£o tempor√°ria</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Chala√ßa, sim. </font><font style="vertical-align: inherit;">Ou seja:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">criou tabelas "his" com nomes maximamente aleat√≥rios para n√£o cruzar com ningu√©m</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extrair</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : derramou dados de uma fonte externa para eles</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transforma√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : transformada, preenchida em campos de liga√ß√£o de chave</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carregar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : derramou os dados finais nas tabelas de destino</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabelas "minhas" exclu√≠das</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora - uma mosca na pomada. </font><font style="vertical-align: inherit;">De fato, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toda a escrita no PostgreSQL acontece duas vezes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primeiro no WAL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , depois no corpo da tabela / √≠ndice. </font><font style="vertical-align: inherit;">Tudo isso √© feito para oferecer suporte ao ACID e √† visibilidade correta dos dados entre </font><font style="vertical-align: inherit;">transa√ß√µes aninhadas </font></font><code>COMMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aninhadas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas n√£o precisamos disso! </font><font style="vertical-align: inherit;">Temos todo o processo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou passamos com sucesso, ou n√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">N√£o importa quantas transa√ß√µes intermedi√°rias existam, n√£o estamos interessados ‚Äã‚Äãem ‚Äúcontinuar o processo do meio‚Äù, especialmente quando n√£o est√° claro onde estava. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para isso, os desenvolvedores do PostgreSQL introduziram a vers√£o 9.1, como </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tabelas n√£o registradas em di√°rio (UNLOGGED)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote>      . ,    ,      (.  29),      <b>   </b>. ,     ;         <b> </b>.  ,    <b> </b>   .  ,    ,   .</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em suma, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser√° muito mais r√°pido</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas se o servidor de banco de dados "travar" - ser√° desagrad√°vel. </font><font style="vertical-align: inherit;">Mas com que frequ√™ncia isso acontece e seu processo ETL sabe como modific√°-lo corretamente "do meio" ap√≥s a "revitaliza√ß√£o" do banco de dados? .. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Caso contr√°rio, o caso acima √© semelhante ao seu - use </font></font><code>UNLOGGED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas nunca </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inclua esse atributo em tabelas reais</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dados dos quais voc√™ √© querido.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.3 </font><font style="vertical-align: inherit;">EM COMPROMISSO {EXCLUIR LINHAS | </font><font style="vertical-align: inherit;">SOLTA}</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse design permite ao criar uma tabela para definir o comportamento autom√°tico quando a transa√ß√£o termina. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre o que </font><font style="vertical-align: inherit;">eu j√° escrevi acima, gera </font><font style="vertical-align: inherit;">, mas a </font><font style="vertical-align: inherit;">situa√ß√£o √© mais interessante - aqui √© gerada </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Como toda a infraestrutura para armazenar a meta descri√ß√£o da tabela tempor√°ria √© exatamente a mesma que a usual, a </font><b><font style="vertical-align: inherit;">cria√ß√£o e exclus√£o constantes de tabelas tempor√°rias levam a um forte "aumento" das tabelas do sistema</font></b><font style="vertical-align: inherit;"> pg_class, pg_attribute, pg_attrdef, pg_depend, ... </font><font style="vertical-align: inherit;">
Agora, imagine que voc√™ tem um trabalhador na linha conectar-se ao banco de dados, que a cada segundo abre uma nova transa√ß√£o, cria, preenche, processa e exclui a tabela tempor√°ria ... O lixo nas tabelas do sistema se acumular√° em excesso, e isso √© um freio extra a cada opera√ß√£o.</font></font><code>ON COMMIT <b>DROP</b></code><font style="vertical-align: inherit;"></font><code>DROP TABLE</code><font style="vertical-align: inherit;"></font><code>ON COMMIT <b>DELETE ROWS</b></code><font style="vertical-align: inherit;"></font><code>TRUNCATE TABLE</code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, n√£o! </font><font style="vertical-align: inherit;">Nesse caso, √© muito mais eficiente </font></font><code>CREATE TEMPORARY TABLE x ... ON COMMIT DELETE ROWS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retir√°-lo do ciclo da transa√ß√£o - ent√£o, no in√≠cio de cada nova transa√ß√£o, a tabela j√° </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">existir√°</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (salve a chamada </font></font><code>CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ficar√° vazia</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , gra√ßas a </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(tamb√©m salvamos a liga√ß√£o) no final da transa√ß√£o anterior.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.4 </font><font style="vertical-align: inherit;">COMO ... INCLUINDO ...</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mencionei no in√≠cio que um dos casos de uso t√≠picos de tabelas tempor√°rias s√£o v√°rios tipos de importa√ß√µes - e o desenvolvedor copia e cola a lista de campos da tabela de destino na declara√ß√£o de seu arquivo tempor√°rio ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas a pregui√ßa √© o mecanismo do progresso! </font><font style="vertical-align: inherit;">Portanto, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">criar uma nova tabela "no modelo"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser muito mais simples:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> import_table(
  <span class="hljs-keyword">LIKE</span> target_table<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como voc√™ pode adicionar muitos dados a essa tabela, as pesquisas nela nunca ser√£o r√°pidas. Mas existe uma solu√ß√£o tradicional contra isso - √≠ndices! E, sim, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uma tabela tempor√°ria tamb√©m pode ter √≠ndices</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como, frequentemente, os √≠ndices desejados coincidem com os da tabela de destino, voc√™ pode simplesmente escrever </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
Se voc√™ tamb√©m precisar de </font><font style="vertical-align: inherit;">-values ‚Äã‚Äã(por exemplo, para preencher os valores da chave prim√°ria), poder√° usar </font><font style="vertical-align: inherit;">. Bem, ou simplesmente - </font><font style="vertical-align: inherit;">- ele copiar√° padr√µes, √≠ndices, restri√ß√µes ... </font><font style="vertical-align: inherit;">
Mas aqui voc√™ precisa entender que, se voc√™ criou uma </font><b><font style="vertical-align: inherit;">tabela de importa√ß√£o imediatamente com √≠ndices, os dados ser√£o preenchidos por mais tempo</font></b></font><code>LIKE target_table <b>INCLUDING INDEXES</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>DEFAULT</code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING DEFAULTS</b></code><font style="vertical-align: inherit;"></font><code>LIKE target_table <b>INCLUDING ALL</b></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do que se voc√™ preencher tudo primeiro e depois rolar os √≠ndices - veja como um exemplo de como o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> faz isso </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">RTFM</font></a><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Como escrever?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou dizer simplesmente - use </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">COPY</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-stream em vez de "pacotes" </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acelera√ß√£o √†s vezes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Voc√™ pode at√© diretamente de um arquivo pr√©-gerado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Como lidar com isso?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, deixe nossa introdu√ß√£o parecer algo como isto:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voc√™ tem em seu banco de dados uma placa com dados do cliente para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">registros de 1 milh√£o</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos os dias o cliente envia uma nova </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"imagem" completa</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por experi√™ncia, voc√™ sabe que </font><b><font style="vertical-align: inherit;">n√£o mais que 10 mil registros mudam</font></b><font style="vertical-align: inherit;"> de tempos em tempos</font></font><b><font style="vertical-align: inherit;"></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um exemplo cl√°ssico de tal situa√ß√£o √© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o banco de dados da KLADR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - existem muitos endere√ßos, mas em cada upload semanal de altera√ß√µes (renomea√ß√£o de assentamentos, associa√ß√µes de rua, aparecimento de novas casas), existem muito poucos em todo o pa√≠s.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1 </font><font style="vertical-align: inherit;">Algoritmo de sincroniza√ß√£o total</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para simplificar, digamos que voc√™ nem precise reestruturar os dados - basta trazer a tabela da forma correta, ou seja:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excluir</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tudo o que n√£o √© mais</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atualizar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tudo o que j√° estava, e voc√™ precisa atualizar</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">insira</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tudo o que n√£o foi</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que nessa ordem vale a pena fazer opera√ß√µes? </font><font style="vertical-align: inherit;">Porque √© assim que o tamanho da tabela aumenta minimamente ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lembre-se do MVCC!</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXCLUIR DO dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o, √© claro, voc√™ pode fazer apenas duas opera√ß√µes:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delete</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>DELETE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">)</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cole</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tudo de uma nova imagem</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, ao mesmo tempo, gra√ßas ao MVCC, o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tamanho da tabela aumentar√° exatamente duas vezes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Obtenha + 1 milh√£o de registros de imagem na tabela devido a uma atualiza√ß√£o de 10 K - uma redund√¢ncia t√£o ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRUNCATE dst</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um desenvolvedor mais experiente sabe que todo o prato pode ser limpo de maneira barata:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clear</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) a tabela inteira</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cole</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tudo de uma nova imagem</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√©todo √© eficaz, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√†s vezes √© bastante aplic√°vel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas h√° um problema ... Injetaremos 1 milh√£o de registros, por isso n√£o podemos deixar a tabela em branco por todo esse tempo (como acontecer√° sem envolver uma √∫nica transa√ß√£o). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que significa:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">come√ßamos uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transa√ß√£o longa</font></font></b></li>
<li><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imp√µe </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Lock</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fazemos a inser√ß√£o por um longo tempo, e todos os outros neste momento </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o podem nem</font></font><code>SELECT</code></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algo est√° ruim ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER TABLE ... RENOMEAR ... / DROP TABLE ...</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como op√ß√£o, preencha tudo em uma nova tabela separada e simplesmente renomeie-a para a antiga. </font><font style="vertical-align: inherit;">Algumas pequenas coisas desagrad√°veis:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AccessExclusive</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamb√©m </font><font style="vertical-align: inherit;">, embora substancialmente menos no tempo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos os planos / estat√≠sticas de consulta desta tabela s√£o redefinidos, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© necess√°rio conduzir ANALYZE</font></font></a></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todas as chaves estrangeiras</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (FK) </font><b><font style="vertical-align: inherit;">quebram</font></b><font style="vertical-align: inherit;"> na mesa</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Havia um patch WIP de Simon Riggs, que sugeria executar uma </font></font><code>ALTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">opera√ß√£o para substituir o corpo da tabela no n√≠vel do arquivo, sem tocar nas estat√≠sticas e no FK, mas n√£o coletava o quorum.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EXCLUIR, ATUALIZAR, INSERIR</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, paramos em uma vers√£o sem bloqueio de tr√™s opera√ß√µes. </font><font style="vertical-align: inherit;">Quase tr√™s ... Como fazer isso de maneira mais eficaz?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ,     "" </span>
<span class="hljs-keyword">BEGIN</span>;<font></font>
<font></font>
<span class="hljs-comment">--      </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> tmp(
  <span class="hljs-keyword">LIKE</span> dst <span class="hljs-keyword">INCLUDING</span> <span class="hljs-keyword">INDEXES</span> <span class="hljs-comment">--    ,   </span>
) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">COMMIT</span> <span class="hljs-keyword">DROP</span>; <span class="hljs-comment">--       </span><font></font>
<font></font>
<span class="hljs-comment">-- -     COPY</span><font></font>
COPY tmp FROM STDIN;<font></font>
<span class="hljs-comment">-- ...</span>
<span class="hljs-comment">-- \.</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">USING</span><font></font>
  dst X<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  tmp Y<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2) <span class="hljs-comment">--   </span>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (X.pk1, X.pk2) <span class="hljs-keyword">AND</span>
  Y <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>; <span class="hljs-comment">-- ""</span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  dst D<font></font>
<span class="hljs-keyword">SET</span><font></font>
  (f1, f2, f3) = (T.f1, T.f2, T.f3)<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">WHERE</span>
  (D.pk1, D.pk2) = (T.pk1, T.pk2) <span class="hljs-keyword">AND</span>
  (D.f1, D.f2, D.f3) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (T.f1, T.f2, T.f3); <span class="hljs-comment">--   </span><font></font>
<font></font>
<span class="hljs-comment">--  </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span><font></font>
  dst<font></font>
<span class="hljs-keyword">SELECT</span><font></font>
  T.*<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  tmp T<font></font>
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><font></font>
  dst D<font></font>
    <span class="hljs-keyword">USING</span>(pk1, pk2)
<span class="hljs-keyword">WHERE</span>
  D <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">NULL</span>;<font></font>
<font></font>
<span class="hljs-keyword">COMMIT</span>;
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2 </font><font style="vertical-align: inherit;">Importar p√≥s-processamento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No mesmo KLADRE, todos os registros alterados devem ser executados adicionalmente atrav√©s do p√≥s-processamento - normalizar, destacar palavras-chave e trazer para as estruturas necess√°rias. </font><font style="vertical-align: inherit;">Mas como voc√™ sabe </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exatamente o que mudou</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sem complicar o c√≥digo de sincroniza√ß√£o, idealmente sem toc√°-lo? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se apenas seu processo tiver acesso de grava√ß√£o no momento da sincroniza√ß√£o, voc√™ poder√° usar um gatilho que coletar√° todas as altera√ß√µes para n√≥s:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--  </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr(...);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house(...);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr, <span class="hljs-comment">--      /</span><font></font>
  rn kladr<font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> kladr_house$<span class="hljs-keyword">log</span>(<font></font>
  ro kladr_house,<font></font>
  rn kladr_house<font></font>
);<font></font>
<font></font>
<span class="hljs-comment">--    </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> diff$<span class="hljs-keyword">log</span>() <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">trigger</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
  dst <span class="hljs-built_in">varchar</span> = TG_TABLE_NAME || <span class="hljs-string">'$log'</span>;<font></font>
  stmt text = '';<font></font>
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-comment">--      </span>
  <span class="hljs-keyword">IF</span> TG_OP = <span class="hljs-string">'UPDATE'</span> <span class="hljs-keyword">THEN</span>
    <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NEW</span> <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">OLD</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NEW</span>;
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;
  <span class="hljs-comment">--   </span>
  stmt = '<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">' || dst::text || '</span>(ro,rn)<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">';
  CASE TG_OP
    WHEN '</span><span class="hljs-keyword">INSERT</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span><span class="hljs-literal">NULL</span>,$<span class="hljs-number">1</span>)<span class="hljs-string">' USING NEW;
    WHEN '</span><span class="hljs-keyword">UPDATE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,$<span class="hljs-number">2</span>)<span class="hljs-string">' USING OLD, NEW;
    WHEN '</span><span class="hljs-keyword">DELETE</span><span class="hljs-string">' THEN
      EXECUTE stmt || '</span>$<span class="hljs-number">1</span>,<span class="hljs-literal">NULL</span>)<span class="hljs-string">' USING OLD;
  END CASE;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora podemos impor gatilhos (ou ativar </font></font><code>ALTER TABLE ... ENABLE TRIGGER ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">antes de iniciar a sincroniza√ß√£o </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">log</span>
  <span class="hljs-keyword">AFTER</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">DELETE</span>
  <span class="hljs-keyword">ON</span> kladr_house
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-keyword">ROW</span>
      <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">PROCEDURE</span> diff$<span class="hljs-keyword">log</span>();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ent√£o silenciosamente das tabelas de log, extra√≠mos todas as altera√ß√µes necess√°rias e as executamos por meio de manipuladores adicionais.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.3 </font><font style="vertical-align: inherit;">Importar conjuntos relacionados</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acima, consideramos casos em que as estruturas de dados da fonte e do receptor coincidem. </font><font style="vertical-align: inherit;">Mas e se a descarga de um sistema externo tiver um formato diferente da estrutura de armazenamento em nosso banco de dados? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tome como exemplo o armazenamento de clientes e suas contas, a op√ß√£o cl√°ssica de muitos para um:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">client</span>(<font></font>
  client_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, inn<font></font>
    <span class="hljs-built_in">varchar</span>
      <span class="hljs-keyword">UNIQUE</span>
, <span class="hljs-keyword">name</span>
    <span class="hljs-built_in">varchar</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> invoice(<font></font>
  invoice_id<font></font>
    <span class="hljs-built_in">serial</span>
      PRIMARY <span class="hljs-keyword">KEY</span><font></font>
, client_id<font></font>
    <span class="hljs-built_in">integer</span>
      <span class="hljs-keyword">REFERENCES</span> <span class="hljs-keyword">client</span>(client_id)<font></font>
, <span class="hljs-built_in">number</span>
    <span class="hljs-built_in">varchar</span><font></font>
, dt<font></font>
    <span class="hljs-built_in">date</span>
, <span class="hljs-keyword">sum</span>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o descarregamento de uma fonte externa chega at√© n√≥s na forma de "tudo em um":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> invoice_import(<font></font>
  client_inn<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, client_name<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_number<font></font>
    <span class="hljs-built_in">varchar</span><font></font>
, invoice_dt<font></font>
    <span class="hljs-built_in">date</span><font></font>
, invoice_sum<font></font>
    <span class="hljs-built_in">numeric</span>(<span class="hljs-number">32</span>,<span class="hljs-number">2</span>)<font></font>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, os dados do cliente podem ser duplicados dessa maneira, e o registro principal √© a "conta":</font></font><br>
<br>
<pre><code class="plaintext hljs">0123456789;;A-01;2020-03-16;1000.00<font></font>
9876543210;;A-02;2020-03-16;666.00<font></font>
0123456789;;B-03;2020-03-16;9999.00<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o modelo, basta inserir nossos dados de teste, mas lembre-se - com </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais efici√™ncia!</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> invoice_import
<span class="hljs-keyword">VALUES</span>
  (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-01'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">1000.00</span>)<font></font>
, (<span class="hljs-string">'9876543210'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'A-02'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">666.00</span>)<font></font>
, (<span class="hljs-string">'0123456789'</span>, <span class="hljs-string">''</span>, <span class="hljs-string">'B-03'</span>, <span class="hljs-string">'2020-03-16'</span>, <span class="hljs-number">9999.00</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, selecionamos os "cortes" aos quais nossos "fatos" se referem. </font><font style="vertical-align: inherit;">No nosso caso, as contas se referem aos clientes:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TEMPORARY</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">ON</span>(client_inn)
<span class="hljs-comment">--   SELECT DISTINCT,    </span><font></font>
  client_inn inn<font></font>
, client_name <span class="hljs-string">"name"</span>
<span class="hljs-keyword">FROM</span>
  invoice_import;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para associar corretamente as contas aos IDs dos clientes, precisamos primeiro descobrir ou gerar esses identificadores. </font><font style="vertical-align: inherit;">Adicione campos para eles:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> invoice_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> client_import <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> client_id <span class="hljs-built_in">integer</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usaremos o m√©todo de sincroniza√ß√£o de tabelas descrito acima com uma pequena corre√ß√£o - n√£o atualizaremos ou excluiremos nada da tabela de destino, porque a importa√ß√£o de clientes √© "somente anexar":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-comment">--     ID   </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span>
  <span class="hljs-keyword">client</span> D
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--       ID</span>
<span class="hljs-keyword">WITH</span> ins <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">client</span>(<font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span><font></font>
  )<font></font>
  <span class="hljs-keyword">SELECT</span><font></font>
    inn<font></font>
  , <span class="hljs-keyword">name</span>
  <span class="hljs-keyword">FROM</span><font></font>
    client_import<font></font>
  <span class="hljs-keyword">WHERE</span>
    client_id <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-comment">--  ID  </span>
  <span class="hljs-keyword">RETURNING</span> *<font></font>
)<font></font>
<span class="hljs-keyword">UPDATE</span><font></font>
  client_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  ins D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.inn = D.inn; <span class="hljs-comment">-- unique key</span><font></font>
<font></font>
<span class="hljs-comment">--  ID    </span>
<span class="hljs-keyword">UPDATE</span><font></font>
  invoice_import T<font></font>
<span class="hljs-keyword">SET</span><font></font>
  client_id = D.client_id<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  client_import D<font></font>
<span class="hljs-keyword">WHERE</span>
  T.client_inn = D.inn; <span class="hljs-comment">--  </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, tudo - </font></font><code>invoice_import</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agora preenchemos o campo de comunica√ß√£o </font></font><code>client_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com o qual inseriremos a conta.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt492454/index.html">Vendemos Refatora√ß√£o de Arquitetura a um cliente ou qual √© o problema dos desenvolvedores</a></li>
<li><a href="../pt492456/index.html">Como visualizar e animar modelos (geof√≠sicos). Mostrar dados brutos</a></li>
<li><a href="../pt492458/index.html">GUI simples para M5Stack (Arduino)</a></li>
<li><a href="../pt492460/index.html">Programa√ß√£o funcional √© o que voc√™ (provavelmente) foi informado. Se voc√™ ouviu</a></li>
<li><a href="../pt492462/index.html">Fonte da verdade: como um analista ensina um gerente e um desenvolvedor a trabalhar juntos</a></li>
<li><a href="../pt492466/index.html">Como mudar de qualquer provedor de host com cPanel para Plesk em Rusonix em apenas cinco etapas</a></li>
<li><a href="../pt492468/index.html">Lenovo Thinkserver SE350: um her√≥i da periferia</a></li>
<li><a href="../pt492474/index.html">Estruturamos as informa√ß√µes nas caixas do Android e analisamos o que um prefixo normal deve ser capaz de fazer.</a></li>
<li><a href="../pt492478/index.html">Sem gest√£o do conhecimento d√≥i: 5 principais consequ√™ncias da falta de um sistema</a></li>
<li><a href="../pt492480/index.html">Como lutamos contra as epidemias antes e o que fazemos contra o coronav√≠rus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>