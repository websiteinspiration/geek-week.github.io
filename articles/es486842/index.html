<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôãüèª ü•å ü§∂üèø C√≥nsul + iptables =: 3 ‚å®Ô∏è üßë üîµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En 2010, Wargaming ten√≠a 50 servidores y un modelo de red simple: backend, frontend y firewall. El n√∫mero de servidores creci√≥, el modelo se volvi√≥ m√°...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>C√≥nsul + iptables =: 3</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/486842/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En 2010, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wargaming</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ten√≠a 50 servidores y un modelo de red simple: backend, frontend y firewall. El n√∫mero de servidores creci√≥, el modelo se volvi√≥ m√°s complicado: etapas, VLAN aisladas con ACL, luego VPN con VRF, VLAN con ACL a L2, VRF de ACL a L3. La cabeza est√° girando? M√°s ser√° m√°s divertido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando los servidores comenzaron a trabajar 16,000 sin roturas con tantos segmentos heterog√©neos, se hizo imposible. Por lo tanto, se les ocurri√≥ una soluci√≥n diferente. Tomamos la pila de Netfilter, le agregamos Consul como fuente de datos y obtuvimos un firewall distribuido r√°pidamente. Reemplazaron la ACL en los enrutadores y se usaron como firewall externo e interno. Para la gesti√≥n din√°mica de herramientas, desarrollamos el sistema BEFW, que se us√≥ en todas partes: desde controlar el acceso de los usuarios a la red de supermercados hasta aislar los segmentos de la red entre s√≠.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/wg/bd/odwgbdlxcjww7ln1u_btv23hyvq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√≥mo funciona todo y por qu√© deber√≠a echar un vistazo m√°s de cerca a este sistema, le dice a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ivan Agarkov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">annmuor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - el jefe del grupo de seguridad de infraestructura de la unidad de Mantenimiento en el centro de desarrollo de la empresa de Minsk. </font><font style="vertical-align: inherit;">Ivan es fan√°tico de SELinux, ama a Perl, escribe c√≥digo. </font><font style="vertical-align: inherit;">Como jefe del grupo IB, trabaja regularmente con registros, copias de seguridad e I + D para proteger Wargaming de los piratas inform√°ticos y garantizar el funcionamiento de todos los servidores de juegos de la empresa.</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/4zP67uYnsR4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referencia de la historia</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de decir c√≥mo lo hicimos, te dir√© c√≥mo llegamos a esto y por qu√© era necesario. Para hacer esto, transferimos hace 9 a√±os: 2010, solo apareci√≥ World of Tanks. Wargaming ten√≠a aproximadamente 50 servidores. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e6/qf/6h/e6qf6hugl_efcmn73qn16mcyeoc.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gr√°fico de crecimiento de los servidores de la empresa.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ten√≠amos un modelo de red. Para ese momento fue √≥ptimo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bi/zw/vj/bizwvjhrfphzbrhme6v1avzjxag.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El modelo de red en 2010.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
En la parte delantera hay tipos malos que quieren rompernos, pero hay un firewall en √©l. No hay firewall en el back-end, pero hay 50 servidores all√≠, todos los conocemos. Todo funciona bien </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A lo largo de 4 a√±os, la flota de servidores ha crecido 100 veces, hasta 5000. Aparecieron las primeras redes aisladas, por etapas: no pueden entrar en producci√≥n y, a menudo, las cosas que podr√≠an ser peligrosas giraban all√≠. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z0/6e/ba/z06ebavv-r6yu7fuhy2zvvhsnw0.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelo de red en 2014.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por inercia, se utilizaron las mismas piezas de hierro y todo el trabajo se realiz√≥ en VLAN aisladas: las ACL se escriben en la VLAN que permiten o proh√≠ben cualquier conexi√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2016, el n√∫mero de servidores lleg√≥ a 8000. Wargaming absorbi√≥ otros estudios, aparecieron redes de afiliados adicionales. Parecen ser nuestros, pero no del todo: la VLAN a menudo no funciona para los socios, debe usar una VPN con VRF, el aislamiento se vuelve m√°s complicado. Creci√≥ una mezcla de aislados de ACL. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w-/zj/ej/w-zjej3fr8frinvbg4z1thbwdre.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El modelo de red en 2016.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A principios de 2018, la flota de autom√≥viles creci√≥ a 16,000. Hubo 6 segmentos, y el resto no contamos, incluidos los cerrados, en los que se almacenaron los datos financieros. Hay redes de contenedores (Kubernetes), DevOps, redes en la nube conectadas a trav√©s de VPN, por ejemplo, desde el IVS. Hab√≠a muchas reglas, dol√≠a. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iv/zf/cd/ivzfcdz9lzxsiugegpfthzwubik.png"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modelo de red y m√©todos de aislamiento en 2018.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para el aislamiento utilizamos: VLAN con ACL en L2, VRF con ACL en L3, VPN y mucho m√°s. </font><font style="vertical-align: inherit;">Demasiado.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos viven con ACL y VLAN. </font><font style="vertical-align: inherit;">¬øQu√© est√° mal en general? </font><font style="vertical-align: inherit;">Harold, ocultando el dolor, responder√° esta pregunta. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y2/hi/tl/y2hitlbrqlvcbm6rjg59tzaaqxw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hubo muchos problemas, pero hubo cinco masivos.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aumentos de precios geom√©tricos para las nuevas reglas</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Cada nueva regla se agreg√≥ m√°s tiempo que la anterior, porque primero ten√≠a que ver si ya exist√≠a dicha regla.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No hay firewall dentro de los segmentos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Los segmentos se separaron de alguna manera entre s√≠, en el interior ya no hay suficientes recursos.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las reglas se han aplicado durante mucho tiempo. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las manos que los operadores de reglas locales podr√≠an escribir en una hora. </font><font style="vertical-align: inherit;">Global tard√≥ varios d√≠as.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dificultades con la auditor√≠a de las reglas</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">M√°s precisamente, no fue posible. </font><font style="vertical-align: inherit;">Las primeras reglas se escribieron en 2010, y la mayor√≠a de sus autores ya no trabajaban para la empresa.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bajo nivel de control sobre la infraestructura</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Este es el problema principal: no sab√≠amos bien qu√© estaba pasando con nosotros.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ se ve√≠a el ingeniero de redes en 2018 cuando escuch√≥: "Necesitamos m√°s ACL".</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hh/rl/_i/hhrl_ig_xefe7lps5yrz_liioam.png" width="350"></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soluciones</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A principios de 2018, se decidi√≥ hacer algo al respecto. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El precio de la integraci√≥n est√° en constante crecimiento.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El punto de partida fue que los grandes centros de datos ya no admit√≠an VLAN y ACL aisladas, porque la memoria en los dispositivos se agot√≥. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soluci√≥n: elimin√≥ el factor humano y automatiz√≥ la provisi√≥n de acceso al m√°ximo. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuevas reglas aplican por mucho tiempo.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Soluci√≥n: acelerar la aplicaci√≥n de las reglas, hacerla distribuida y paralela. Para hacer esto, necesita un sistema distribuido para que las reglas se entreguen por s√≠ mismas, sin rsync o SFTP por mil sistemas. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La falta de un firewall dentro de los segmentos.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El firewall dentro de los segmentos comenz√≥ a volar hacia nosotros cuando aparecieron diferentes servicios dentro de la misma red. Soluci√≥n: use un firewall basado en host. Casi en todas partes tenemos Linux, e iptables est√°n en todas partes, esto no es un problema. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dificultades con la auditor√≠a de las reglas.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Soluci√≥n: mantenga todas las reglas en un solo lugar para su revisi√≥n y administraci√≥n, de modo que podamos auditar todo. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bajo nivel de control sobre la infraestructura.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Soluci√≥n: haga un inventario de todos los servicios y accesos entre ellos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es m√°s un proceso administrativo que t√©cnico. </font><font style="vertical-align: inherit;">A veces tenemos 200-300 nuevos lanzamientos por semana, especialmente durante las promociones y los d√≠as festivos. </font><font style="vertical-align: inherit;">Sin embargo, esto es solo para un equipo de nuestros DevOps. </font><font style="vertical-align: inherit;">Con tantos lanzamientos, es imposible ver qu√© tipo de puertos, IP, integraci√≥n se necesitan. </font><font style="vertical-align: inherit;">Por lo tanto, necesit√°bamos gerentes de servicio especialmente capacitados que entrevistaran a los equipos: "¬øQu√© hay all√≠ y por qu√© lo plantearon?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de todo lo que lanzamos, el ingeniero de redes en 2019 comenz√≥ a verse as√≠.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yv/fx/qi/yvfxqisjbogjxfy6czj0p6xmvuw.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥nsul</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidimos que pondr√≠amos todo lo que encontr√°ramos con la ayuda de los gerentes de servicio en Consul y desde all√≠ escribir√≠amos las reglas de iptables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo decidimos hacer esto?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recopilamos todos los servicios, redes y usuarios.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hagamos reglas de iptables basadas en ellas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control automatizado.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LUCRO.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consul no es una API remota; puede funcionar en todos los nodos y escribir en iptables. </font><font style="vertical-align: inherit;">¬°Solo queda encontrar controles autom√°ticos que limpien el exceso, y la mayor√≠a de los problemas se resolver√°n! </font><font style="vertical-align: inherit;">Finalizaremos el resto en el proceso.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© c√≥nsul?</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bien establecido</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En 2014-15, lo usamos como back-end para Vault, en el que almacenamos contrase√±as. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No pierde datos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Durante el uso, Consul no perdi√≥ datos en ning√∫n accidente. Esta es una gran ventaja para el sistema de gesti√≥n de firewall. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las comunicaciones P2P aceleran la propagaci√≥n del cambio</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Con P2P, todos los cambios se producen r√°pidamente, sin necesidad de esperar horas. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conveniente API REST.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tambi√©n consideramos Apache ZooKeeper, pero no tiene una API REST, tendr√° que poner muletas. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funciona como un almac√©n de claves (KV) y como un directorio (Service Discovery)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Puede almacenar inmediatamente servicios, cat√°logos, centros de datos. Esto es conveniente no solo para nosotros, sino tambi√©n para los equipos vecinos, porque al construir un servicio global, pensamos en grande.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escrito en Go, que es parte de la pila de Wargaming. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nos encanta este lenguaje, tenemos muchos desarrolladores de Go. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Potente sistema ACL. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En Consul, puede usar ACL para administrar qui√©n y qu√© escribir. </font><font style="vertical-align: inherit;">Garantizamos que las reglas del firewall no se superpondr√°n con nada m√°s y no tendremos problemas con esto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero el c√≥nsul tiene sus inconvenientes.</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No se escala dentro del centro de datos, si no tiene una versi√≥n comercial. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es escalado solo por la federaci√≥n.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Muy dependiente de la calidad de la red y la carga del servidor. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥nsul no funcionar√° normalmente como un servidor en un servidor ocupado si hay retrasos en la red, por ejemplo, velocidad desigual. </font><font style="vertical-align: inherit;">Esto se debe a las conexiones P2P y los modelos de distribuci√≥n de actualizaciones.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dificultades con el monitoreo de accesibilidad</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En el estado de C√≥nsul se puede decir que todo est√° bien, pero hace mucho que muri√≥.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resolvimos la mayor√≠a de estos problemas durante la operaci√≥n de C√≥nsul, as√≠ que lo elegimos. </font><font style="vertical-align: inherit;">La compa√±√≠a tiene planes para un backend alternativo, pero hemos aprendido c√≥mo lidiar con los problemas y todav√≠a estamos viviendo con Consul.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo funciona el c√≥nsul</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el centro de datos condicional, instalamos servidores, de tres a cinco. </font><font style="vertical-align: inherit;">Uno o dos servidores no funcionar√°n: no podr√°n organizar un qu√≥rum y decidir qui√©n tiene raz√≥n, qui√©n est√° equivocado, cuando los datos no coinciden. </font><font style="vertical-align: inherit;">M√°s de cinco no tiene sentido, el rendimiento disminuir√°. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lj/bb/ms/ljbbms9ipssmvl-pooll-judvgs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los clientes se conectan en cualquier orden a los servidores: los mismos agentes, solo con una bandera </font></font><code>server = false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jx/ku/ub/jxkuubjet3kolzk07yqq0qkak8m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de eso, los clientes reciben una lista de conexiones P2P y crean conexiones entre ellos. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ow/st/ca/owstcacfv-iuaz42vdlyk1cmes8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A nivel global, estamos interconectando varios centros de datos. </font><font style="vertical-align: inherit;">Tambi√©n conectan P2P y se comunican. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gx/5r/s5/gx5rs5yetwzbe63odrgx6ppfnm4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando deseamos recopilar datos de otro centro de datos, la solicitud va de servidor a servidor. </font><font style="vertical-align: inherit;">Tal esquema se llama </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">protocolo Serf</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El protocolo Serf, como C√≥nsul, es desarrollado por HashiCorp.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algunos hechos importantes sobre el c√≥nsul</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥nsul tiene documentaci√≥n que describe su trabajo. </font><font style="vertical-align: inherit;">Dar√© solo hechos seleccionados que vale la pena conocer. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los servidores de c√≥nsul seleccionan maestros de entre los votantes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">C√≥nsul selecciona el asistente de la lista de servidores para cada centro de datos, y todas las solicitudes van solo a √©l, independientemente de la cantidad de servidores. </font><font style="vertical-align: inherit;">Colgar al mago no conduce a la reelecci√≥n. </font><font style="vertical-align: inherit;">Si el asistente no est√° seleccionado, las solicitudes no son atendidas por nadie.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQuieres escala horizontal? </font><font style="vertical-align: inherit;">Lo siento, pero no.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una solicitud a otro centro de datos va de maestro a maestro, independientemente del servidor al que lleg√≥. </font><font style="vertical-align: inherit;">El maestro seleccionado recibe el 100% de la carga, excepto la carga en las solicitudes de reenv√≠o. </font><font style="vertical-align: inherit;">Todos los servidores del centro de datos tienen una copia actualizada de los datos, pero solo uno responde.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La √∫nica forma de escalar es habilitar el modo obsoleto en el cliente.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En modo obsoleto, puede responder sin qu√≥rum. Este es un modo en el que rechazamos la coherencia de los datos, pero leemos un poco m√°s r√°pido de lo habitual y cualquier servidor responde. Naturalmente, la grabaci√≥n es solo a trav√©s del maestro. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥nsul no copia datos entre centros de datos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Al recopilar la federaci√≥n, cada servidor tendr√° solo sus propios datos. Para otros, siempre se vuelve hacia alguien m√°s. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La atomicidad de las operaciones no est√° garantizada fuera de la transacci√≥n</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Recuerda que no solo puedes cambiar algo. Si lo desea de manera diferente, realice una transacci√≥n con un candado. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las operaciones de bloqueo no garantizan el bloqueo</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . La solicitud va de maestro a maestro, y no directamente, por lo que no hay garant√≠a de que el bloqueo funcione cuando se bloquea, por ejemplo, en otro centro de datos.</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las ACL tampoco garantizan el acceso (en muchos casos)</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es posible que la ACL no funcione porque est√° almacenada en un centro de datos de la federaci√≥n, en el centro de datos de ACL (DC principal). Si el DC no le responde, el ACL no funcionar√°. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un asistente flotante congelar√° a toda la federaci√≥n</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por ejemplo, en la federaci√≥n hay 10 centros de datos, y en uno hay una red defectuosa, y un maestro cae. Todos los que se comunican con √©l est√°n atrapados en un c√≠rculo: se est√° haciendo una solicitud, no hay respuesta, el hilo se cuelga. No ser√° posible saber cu√°ndo ocurrir√° esto, solo en una o dos horas toda la federaci√≥n caer√°. No puedes hacer nada al respecto.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El estado, el qu√≥rum y las elecciones se procesan en un hilo separado. </font><font style="vertical-align: inherit;">La re-selecci√≥n no suceder√°, el estado no mostrar√° nada. </font><font style="vertical-align: inherit;">Piensas que tienes un c√≥nsul en vivo, preguntas, y no pasa nada, no hay respuesta. </font><font style="vertical-align: inherit;">Adem√°s, el estado muestra que todo est√° bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfrentamos este problema, tuvimos que reconstruir partes espec√≠ficas de los centros de datos para evitarlo. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La versi√≥n comercial de Consul Enterprise no tiene algunas de las desventajas anteriores</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tiene muchas funciones √∫tiles: votaci√≥n, distribuci√≥n, escalado. </font><font style="vertical-align: inherit;">Solo hay un "pero": un sistema de licencias para un sistema distribuido es muy costoso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Life hack: </font></font><code>rm -rf /var/lib/consul</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- una cura para todas las enfermedades del agente. </font><font style="vertical-align: inherit;">Si algo no funciona para usted, simplemente elimine sus datos y descargue los datos de la copia. </font><font style="vertical-align: inherit;">Lo m√°s probable es que el c√≥nsul trabaje.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Befw</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora hablemos de lo que agregamos al c√≥nsul. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BEFW</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - un acr√≥nimo de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bed and</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ack </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nd </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the F</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the ire of </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the W</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> all. </font><font style="vertical-align: inherit;">Era necesario nombrar de alguna manera el producto cuando cre√© el repositorio para poner las primeras confirmaciones de prueba en √©l. </font><font style="vertical-align: inherit;">Este nombre permanece.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plantillas de reglas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las reglas est√°n escritas en la sintaxis de iptables.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-N BEFW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-P GOTA DE ENTRADA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A ENTRADA -m estado - estado RELACIONADO, ESTABLECIDO -j ACEPTAR</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A ENTRADA -i lo -j ACEPTAR</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-A ENTRADA -j ANTES</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos vamos a la cadena BEFW, excepto </font></font><code>ESTABLISHED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RELATED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y localhost. </font><font style="vertical-align: inherit;">La plantilla puede ser cualquier cosa, esto es solo un ejemplo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPara qu√© sirve BEFW?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Servicios</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos un servicio, siempre tiene un puerto, el nodo en el que funciona. </font><font style="vertical-align: inherit;">Desde nuestro nodo, podemos preguntar localmente al agente y descubrir que tenemos alg√∫n tipo de servicio. </font><font style="vertical-align: inherit;">Tambi√©n puedes poner etiquetas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/lc/7n/fmlc7n4h4rmyqbeemb7lcn6lzco.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cualquier servicio que se est√© ejecutando y registrado con Consul se convierte en una regla de iptables. </font><font style="vertical-align: inherit;">Tenemos SSH - abre el puerto 22. El script bash es simple: curl e iptables, no se necesita nada m√°s.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clientes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo abrir el acceso no a todos, sino de forma selectiva? </font><font style="vertical-align: inherit;">Por el nombre del servicio, agregue listas de IP al repositorio de KV. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pg/y4/nu/pgy4nufltcqaimdqv7ncfpntix0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, queremos que todos los miembros de la d√©cima red puedan acceder al servicio SSH_TCP_22. </font><font style="vertical-align: inherit;">A√±adir un peque√±o campo TTL? </font><font style="vertical-align: inherit;">y ahora tenemos permisos temporales, por ejemplo, por un d√≠a.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accesos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conectamos servicios y clientes: tenemos un servicio, para cada almacenamiento KV est√° listo. </font><font style="vertical-align: inherit;">Ahora damos acceso no a todos, sino de forma selectiva.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/f1/yo/vn/f1yovnkwz7qddj1sw267obg3gvk.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grupos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si cada vez que escribimos miles de IP para accesos, nos cansaremos. </font><font style="vertical-align: inherit;">Creemos agrupaciones, un subconjunto separado en KV. </font><font style="vertical-align: inherit;">Lo llamaremos Alias ‚Äã‚Äã(o grupos) y almacenaremos grupos all√≠ de acuerdo con el mismo principio. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vz/un/um/vzunum6qz9s9fs8odlwiwlz6vsc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conectar: ‚Äã‚Äãahora podemos abrir SSH no espec√≠ficamente en P2P, sino en un grupo completo o en varios grupos. </font><font style="vertical-align: inherit;">Del mismo modo, hay TTL: puede agregar al grupo y eliminarlo temporalmente.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ao/2w/as/ao2was0eioehjrwnn1ypgh4zj5w.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integraci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestro problema es el factor humano y la automatizaci√≥n. Hasta ahora lo hemos resuelto as√≠. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8g/pv/j0/8gpvj0liyxy64mamjpwr8nbn4xc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabajamos con Puppet y le transferimos todo lo relacionado con el sistema (c√≥digo de aplicaci√≥n). Puppetdb (PostgreSQL normal) almacena una lista de servicios que se ejecutan all√≠, puede encontrarlos por tipo de recurso. All√≠ puedes encontrar qui√©n va a d√≥nde. Tambi√©n tenemos un sistema de solicitud de extracci√≥n y combinaci√≥n para esto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escribimos befw-sync, la soluci√≥n m√°s simple que ayuda a transferir datos. Primero, las cookies de sincronizaci√≥n van a puppetdb. La API HTTP est√° configurada all√≠: preguntamos qu√© servicios tenemos, qu√© hay que hacer. Luego hacen una solicitud al C√≥nsul.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øHay integraci√≥n? </font><font style="vertical-align: inherit;">S√≠: escribieron las reglas, se les permiti√≥ aceptar la solicitud de extracci√≥n. </font><font style="vertical-align: inherit;">¬øNecesita alg√∫n puerto o agregar un host a alg√∫n grupo? </font><font style="vertical-align: inherit;">Solicitud de extracci√≥n, revisi√≥n: no m√°s "Encuentre otras 200 ACL e intente hacer algo al respecto".</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mejoramiento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El ping localhost con una cadena de reglas vac√≠a tarda 0.075 ms. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_j/6p/ce/_j6pceeghhejvrabuazobzgbfmw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agregue 10,000 iptables a esta cadena. </font><font style="vertical-align: inherit;">Como resultado, el ping aumentar√° 5 veces: iptables es completamente lineal, el procesamiento de cada direcci√≥n lleva alg√∫n tiempo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/er/v9/ic/erv9ic34w6oqhoy7aekpfimpys4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para el firewall, en el que migramos miles de ACL, tenemos muchas reglas, y esto introduce un retraso. </font><font style="vertical-align: inherit;">Para los protocolos de juego, esto es malo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero si ponemos </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10,000 direcciones en</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ping de </font><strong><font style="vertical-align: inherit;">ipset</font></strong><font style="vertical-align: inherit;"> , incluso disminuir√°. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_l/zb/qs/_lzbqsckkctv-01v3vu-irjhvcq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El punto es que la "O" (complejidad del algoritmo) para ipset siempre es 1, sin importar cu√°ntas reglas haya. </font><font style="vertical-align: inherit;">Es cierto, hay una limitaci√≥n: no puede haber m√°s de 65535 reglas. Por ahora, vivimos con esto: puede combinarlas, expandirlas, hacer dos ipsets en uno.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Almacenamiento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La continuaci√≥n l√≥gica del proceso de iteraci√≥n es el almacenamiento de informaci√≥n del cliente para el servicio en ipset. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x0/up/dv/x0updv72n35faryycb_ntjmpqik.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora tenemos el mismo SSH, y no escribimos inmediatamente 100 IP, pero configuramos el nombre ipset para comunicarnos y la siguiente regla </font></font><code>DROP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Puede rehacer la regla "Qui√©n no est√° aqu√≠, eso es DROP", pero m√°s claramente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora tenemos reglas y conjuntos. </font><font style="vertical-align: inherit;">La tarea principal es hacer un conjunto antes de escribir la regla, porque de lo contrario iptables no escribir√° la regla.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esquema general</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En forma de diagrama, todo lo que dije se ve as√≠. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/qa/i-/9wqai-52aq3i3onq1dovwbfzpfc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comprom√©tete con Puppet, todo se env√≠a al host, los servicios est√°n aqu√≠, ipset est√° all√≠, y quien no est√° registrado all√≠ no est√° permitido.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permiten negar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para salvar r√°pidamente al mundo o apagar r√°pidamente a alguien, al comienzo de todas las cadenas hicimos dos ipset: </font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>rules_deny</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">¬øC√≥mo funciona? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, alguien con bots crea una carga en nuestra web. </font><font style="vertical-align: inherit;">Anteriormente, era necesario encontrar su IP en los registros, remitirlo a los ingenieros de red para que pudieran encontrar la fuente del tr√°fico y prohibirlo. </font><font style="vertical-align: inherit;">Ahora se ve diferente. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a6/so/xq/a6soxqdkwf8qokucl-ztjs6xdde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enviamos al C√≥nsul, esperamos 2.5 s, y ya est√°. </font><font style="vertical-align: inherit;">Dado que Consul se distribuye r√°pidamente a trav√©s de P2P, funciona en todas partes, en cualquier parte del mundo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una vez que detuve por completo WOT, cometiendo un error con el firewall. </font></font><code>rules_allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Este es nuestro seguro contra tales casos. </font><font style="vertical-align: inherit;">Si cometimos un error con el firewall en alg√∫n lugar, algo est√° bloqueado en alg√∫n lugar, siempre podemos enviar un condicional </font></font><code>0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para aumentar r√°pidamente todo. </font><font style="vertical-align: inherit;">Luego arreglaremos todo con nuestras manos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otros conjuntos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede agregar cualquier otro conjunto en el espacio </font></font><code>$IPSETS$</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/md/hv/jf/mdhvjfb8t36heje-udbnw5fly0m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPara qu√©? </font><font style="vertical-align: inherit;">A veces alguien necesita un ipset, por ejemplo, para emular la desconexi√≥n de alguna parte del cl√∫ster. </font><font style="vertical-align: inherit;">Todos pueden traer cualquier conjunto, llamarlos y ser√°n tomados del c√≥nsul. </font><font style="vertical-align: inherit;">Al mismo tiempo, los conjuntos pueden participar en las reglas de iptables y ser como un equipo </font></font><code>NOOP</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: el demonio respaldar√° la coherencia.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los usuarios</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sol√≠a ‚Äã‚Äãser as√≠: un usuario conectado a una red y recibi√≥ par√°metros a trav√©s de un dominio. </font><font style="vertical-align: inherit;">Hasta la pr√≥xima generaci√≥n de firewalls, Cisco no pod√≠a entender d√≥nde est√° el usuario y d√≥nde est√° la IP. </font><font style="vertical-align: inherit;">Por lo tanto, el acceso se otorg√≥ solo a trav√©s de m√°quinas de nombre de host. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© hemos hecho? </font><font style="vertical-align: inherit;">Encajado en el momento de recibir la direcci√≥n. </font><font style="vertical-align: inherit;">Por lo general, es dot1x, Wi-Fi o VPN: todo pasa por RADIUS. </font><font style="vertical-align: inherit;">Para cada usuario, cree un grupo por nombre de usuario y coloque una IP con TTL, que es igual a su dhcp.lease: tan pronto como caduque, la regla desaparecer√°. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/ps/ad/tfpsad3jh-egdfn_uehr3yvmcao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora podemos abrir el acceso a los servicios, as√≠ como a otros grupos, por nombre de usuario. </font><font style="vertical-align: inherit;">Eliminamos el dolor con el nombre de host cuando cambian, y quitamos la carga de los ingenieros de red porque ya no necesitaban Cisco. </font><font style="vertical-align: inherit;">Ahora, los propios ingenieros prescriben el acceso a sus servidores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aislamiento</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paralelamente, comenzamos a desmontar el aislamiento. </font><font style="vertical-align: inherit;">Los gerentes de servicio hicieron un inventario y analizamos todas nuestras redes. </font><font style="vertical-align: inherit;">Los descomponemos en los mismos grupos, y en los servidores necesarios se agregaron los grupos, por ejemplo, para negar. </font><font style="vertical-align: inherit;">Ahora, el mismo aislamiento de etapas entra en reglas_denegaci√≥n en la producci√≥n, pero no en la producci√≥n misma. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fd/9g/ed/fd9gedlbs2_9gyyg-5lwm_fp75m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El esquema funciona de manera r√°pida y sencilla: elimine todas las ACL de los servidores, descargue hardware y reduzca la cantidad de VLAN aisladas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control de integridad</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anteriormente, un disparador especial funcionaba para nosotros, que informaba cuando alguien cambiaba la regla del firewall con sus manos. </font><font style="vertical-align: inherit;">Escrib√≠ un gran verificador de reglas de firewall, fue dif√≠cil. </font><font style="vertical-align: inherit;">Ahora la integridad controla BEFW. </font><font style="vertical-align: inherit;">Celosamente se asegura de que las reglas que hace no cambien. </font><font style="vertical-align: inherit;">Si alguien cambia las reglas del firewall, devolver√° todo. </font><font style="vertical-align: inherit;">"R√°pidamente plante√© un proxy aqu√≠ para trabajar desde casa", ya no hay tales opciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFW controla el ipset de los servicios y la lista en befw.conf, las reglas de servicio en la cadena BEFW. </font><font style="vertical-align: inherit;">Pero no sigue otras cadenas y reglas y otros ipset.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protecci√≥n contra accidentes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BEFW siempre guarda el √∫ltimo estado exitoso directamente en la estructura binaria de state.bin. Si algo sali√≥ mal, siempre vuelve a este estado.bin. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2z/fe/ru/2zferuy2qiohwpa6odt1s0d642g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este es el seguro inestable del C√≥nsul cuando no envi√≥ datos o alguien cometi√≥ un error y us√≥ reglas que no pudieron aplicarse. Para que no nos quedemos sin un firewall, BEFW regresar√° al √∫ltimo estado si se produce un error en alg√∫n momento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En situaciones cr√≠ticas, esto es una garant√≠a de que permaneceremos con un firewall en funcionamiento. Abrimos todas las redes grises con la esperanza de que el administrador venga y lo arregle. Alg√∫n d√≠a lo sacar√© en configuraciones, pero ahora solo tenemos tres redes grises: 10/8, 172/12 y 192.168 / 16. Como parte de nuestro c√≥nsul, esta es una caracter√≠stica importante que ayuda a desarrollar m√°s.</font></font><br>
<br>
<em>:      -  BEFW.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>.     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> GitHub</a>.</em><br>
<br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Te contar√© sobre los errores que encontramos. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset add set 0.0.0.0/0.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬øQu√© sucede si agrega a ipset 0.0.0.0/0? ¬øSe agregar√°n todas las IP? ¬øSe abrir√° el acceso a Internet? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No, tenemos un error que nos cost√≥ dos horas de tiempo de inactividad. Adem√°s, el error no ha estado funcionando desde 2016, se encuentra en RedHat Bugzilla con el n√∫mero # 1297092, pero lo encontramos por accidente, seg√∫n el informe del desarrollador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora BEFW tiene una regla estricta, que se </font></font><code>0.0.0.0/0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convierte en dos direcciones: </font></font><code>0.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>128.0.0.0/1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ipset restore set &lt;archivo.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬øQu√© hace ipset cuando lo cuentas </font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? ¬øCrees que funciona igual que iptables? ¬øRecuperar datos? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nada de eso: se fusiona y las direcciones antiguas no desaparecen, no se cierra el acceso.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encontramos un error cuando probamos el aislamiento. Ahora hay un sistema bastante complicado: en lugar de </font></font><code>restore</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llevarse a cabo </font></font><code>create temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, entonces </font></font><code>restore flush temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>restore temp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Al final del intercambio: por atomicidad, porque si se realiza por primera vez </font></font><code>flush</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y en ese momento llega un paquete, se descartar√° y algo saldr√° mal. Por lo tanto, hay un poco de magia negra. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥nsul kv get -datacenter = otro.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como dije, creemos que estamos solicitando algunos datos, pero obtendremos datos o un error. Podemos hacer esto a trav√©s del C√≥nsul localmente, pero en este caso, tanto uno como el otro colgar√°n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El cliente local de Consul es un contenedor sobre la API HTTP. Pero simplemente se cuelga y no responde Ctrl + C o Ctrl + Z, no importa qu√©, solo</font></font><code>kill -9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la consola adyacente. </font><font style="vertical-align: inherit;">Nos encontramos con esto cuando est√°bamos construyendo un gran grupo. </font><font style="vertical-align: inherit;">Pero todav√≠a no tenemos soluci√≥n, nos estamos preparando para corregir este error en Consul. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El l√≠der del c√≥nsul no responde. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuestro maestro en el centro de datos no responde, pensamos: "Probablemente, ¬øel algoritmo de re-selecci√≥n funcionar√° ahora?" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No, no funcionar√°, y el monitoreo no mostrar√° nada: el c√≥nsul dir√° que hay un √≠ndice de compromiso, se ha encontrado un l√≠der, todo est√° bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øC√≥mo estamos luchando contra esto? </font></font><code>service consul restart</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en cron cada hora. </font><font style="vertical-align: inherit;">Si tiene 50 servidores, no es gran cosa. </font><font style="vertical-align: inherit;">Cuando haya 16,000, comprender√° c√≥mo funciona.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtuvimos las siguientes ventajas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100% de cobertura de todas las m√°quinas Linux.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Velocidad.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automatizaci√≥n</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liberaron a los ingenieros de hierro y redes de la esclavitud.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hay oportunidades de integraci√≥n que son casi infinitas: incluso con Kubernetes, incluso con Ansible, incluso con Python.</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contras</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : C√≥nsul, con quien ahora vivimos, y un precio de error muy alto. </font><font style="vertical-align: inherit;">Como ejemplo, una vez a las 6 pm (horario de m√°xima audiencia en Rusia), descart√© algo en las listas de redes. </font><font style="vertical-align: inherit;">Est√°bamos construyendo aislamiento en BEFW en ese momento. </font><font style="vertical-align: inherit;">Parece que me equivoqu√© en alguna parte, indiqu√© la m√°scara incorrecta, pero todo cay√≥ en dos segundos. </font><font style="vertical-align: inherit;">El monitoreo se enciende, el oficial de guardia entra: "¬°Todo est√° con nosotros!" </font><font style="vertical-align: inherit;">El jefe del departamento se puso gris cuando le explic√≥ al negocio por qu√© sucedi√≥ esto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El precio del error es tan alto que se nos ocurri√≥ nuestro propio procedimiento de profilaxis complicado. </font><font style="vertical-align: inherit;">Si lo implementar√° en una producci√≥n grande, no necesita dar una ficha maestra sobre C√≥nsul a todos. </font><font style="vertical-align: inherit;">Terminar√° mal. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Costo.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escrib√≠ el c√≥digo solo durante 400 horas. </font><font style="vertical-align: inherit;">Para apoyar a mi equipo de 4 personas, pasa 10 horas al mes. </font><font style="vertical-align: inherit;">En comparaci√≥n con el precio de cualquier firewall de nueva generaci√≥n, es gratis. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Planes </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El plan a largo plazo es la b√∫squeda de transporte alternativo a cambio o adicional del c√≥nsul. </font><font style="vertical-align: inherit;">Quiz√°s sea Kafka o algo as√≠. </font><font style="vertical-align: inherit;">Pero en los pr√≥ximos a√±os viviremos del c√≥nsul. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Planes inmediatos: integraci√≥n con Fail2ban, con monitoreo, con nftables, posiblemente con otras distribuciones, m√©tricas, monitoreo avanzado, optimizaci√≥n. </font><font style="vertical-align: inherit;">El soporte de Kubernetes tambi√©n est√° en alg√∫n lugar de los planes, porque en este momento tenemos varios grupos y deseos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otro de los planes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buscar anomal√≠as de tr√°fico;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gesti√≥n de mapas de red;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apoyo de Kubernetes;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">montaje de paquetes para todos los sistemas;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IU web</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trabajamos constantemente para expandir la configuraci√≥n, aumentar las m√©tricas y optimizar. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√önete al proyecto </font><font style="vertical-align: inherit;">El proyecto result√≥ ser genial, pero, desafortunadamente, sigue siendo un proyecto de una persona. </font><font style="vertical-align: inherit;">Ven a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e intenta hacer algo: comprometerte, probar, ofrecer algo, dar tu evaluaci√≥n.</font></font></i><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mientras tanto, nos estamos preparando para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saint HighLoad ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que se llevar√° a cabo los d√≠as 6 y 7 de abril en San Petersburgo, e invitamos a los desarrolladores de sistemas de alta carga </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a solicitar un informe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Los oradores experimentados ya saben qu√© hacer, y recomendamos que los reci√©n llegados a los discursos al menos lo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intenten</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Participar en la conferencia como orador tiene varias ventajas. </font><font style="vertical-align: inherit;">Que puedes leer, por ejemplo, al final de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es486842/">https://habr.com/ru/post/es486842/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es486822/index.html">[Por los muelles] Aleteo. Parte 4. Para desarrolladores web</a></li>
<li><a href="../es486824/index.html">Mal consejo al trabajar con ANTLR</a></li>
<li><a href="../es486826/index.html">Creaci√≥n de un Viberbot completo en Django 2 y la API REST de Viber. Primera parte - Webhook</a></li>
<li><a href="../es486828/index.html">Food Design Digest, enero de 2020</a></li>
<li><a href="../es486832/index.html">¬øCu√°ntos a√±os pasa Taiga? No, no.</a></li>
<li><a href="../es486844/index.html">La evoluci√≥n del procesamiento de webhook de Facebook: de cero a 25,000 por segundo</a></li>
<li><a href="../es486850/index.html">Nuevo asiento reservado, como un hotel c√°psula</a></li>
<li><a href="../es486858/index.html">Creando un Viberbot completo. Segunda parte: primer contacto o "conversion_started"</a></li>
<li><a href="../es486860/index.html">ATX12VO - Comer una nueva forma</a></li>
<li><a href="../es486862/index.html">5 razones por las que el dise√±o de movimiento te ayuda a conectarte con las personas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>