<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº üë®üèª üôãüèΩ Simple detection of performance problems in PostgreSQL ‚úèÔ∏è ü¶á ‚òÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Is there a very large and large database in the world that does not suffer from performance problems from time to time? I bet there aren't that many. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Simple detection of performance problems in PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488968/"><img width="50%" align="left" src="https://habrastorage.org/webt/eh/u7/zc/ehu7zcus6trwjpqofvosp35wj7a.jpeg"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is there a very large and large database in the world that does not suffer from performance problems from time to time? </font><font style="vertical-align: inherit;">I bet there aren't that many. </font><font style="vertical-align: inherit;">Therefore, every DBA (database administrator) responsible for PostgreSQL needs to know how to track potential performance problems in order to figure out what is actually happening.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL performance improvement after setting options</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many people think that changing parameters in postgresql.conf is the real path to success. </font><font style="vertical-align: inherit;">However, this is not always the case. </font><font style="vertical-align: inherit;">Of course, most often good database configuration options are very useful. </font><font style="vertical-align: inherit;">However, in many cases, real problems will arise due to a strange request hidden deep in some application logic. </font><font style="vertical-align: inherit;">It is even likely that the queries causing the real problems are not the ones you noticed. </font><font style="vertical-align: inherit;">A natural question arises: how can we track these requests and find out what is actually happening? </font><font style="vertical-align: inherit;">My favorite tool for this is pg_stat_statements, which should always be turned on in my opinion if you are using PostgreSQL 9.2 or higher (please do not use it in older versions).</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enabling pg_stat_statements</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To enable pg_stat_statements on your server, change the following line in postgresql.conf and restart PostgreSQL:</font></font><br>
<br>
<pre><code class="sql hljs">shared_preload_libraries = ‚Äòpg_stat_statements‚Äô</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After downloading this module to the server, PostgreSQL will automatically begin to collect information. </font><font style="vertical-align: inherit;">The good thing is that the module overhead is really very low (the overhead is basically just ‚Äúnoise‚Äù). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then run the following command to create the view needed to access the data:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> EXTENSION pg_stat_statements;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The extension will create a view called pg_stat_statements and make the data easily accessible.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detecting Slow Queries in PostgreSQL</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The easiest way to find the most interesting queries is to sort the output of pg_stat_statements by total_time:</font></font><br>
<br>
<pre><code class="sql hljs">	
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_stat_statements <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_time <span class="hljs-keyword">DESC</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The beauty here is that the type of request that is the most time-consuming will naturally appear at the top of the list. </font><font style="vertical-align: inherit;">The best way is to go from the first to, say, the 10th request and see what happens there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my opinion, it is impossible to configure the system without viewing the most time-consuming queries on the database server. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learn more about detecting slow queries in PostgreSQL.</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL in-depth performance analysis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pg_stat_statements can offer much more than just a request and the time it took. </font><font style="vertical-align: inherit;">Here is the presentation structure:</font></font><br>
<br>
<pre><code class="sql hljs">	
test=<span class="hljs-comment"># \d pg_stat_statements</span><font></font>
View "public.pg_stat_statements"<font></font>
Column               |     Type         | Collation | Nullable | Default<font></font>
<span class="hljs-comment">---------------------+------------------+-----------+----------+---------</span><font></font>
 userid              | oid              |           |          |<font></font>
 dbid                | oid              |           |          |<font></font>
 queryid             | bigint           |           |          |<font></font>
 query               | text             |           |          |<font></font>
 calls               | bigint           |           |          |<font></font>
 total_time          | double precision |           |          |<font></font>
 min_time            | double precision |           |          |<font></font>
 max_time            | double precision |           |          |<font></font>
 mean_time           | double precision |           |          |<font></font>
 stddev_time         | double precision |           |          |<font></font>
 rows                | bigint           |           |          |<font></font>
 shared_blks_hit     | bigint           |           |          |<font></font>
 shared_blks_read    | bigint           |           |          |<font></font>
 shared_blks_dirtied | bigint           |           |          |<font></font>
 shared_blks_written | bigint           |           |          |<font></font>
 local_blks_hit      | bigint           |           |          |<font></font>
 local_blks_read     | bigint           |           |          |<font></font>
 local_blks_dirtied  | bigint           |           |          |<font></font>
 local_blks_written  | bigint           |           |          |<font></font>
 temp_blks_read      | bigint           |           |          |<font></font>
 temp_blks_written   | bigint           |           |          |<font></font>
 blk_read_time       | double precision |           |          |<font></font>
 blk_write_time      | double precision |           |          |<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is quite useful to look at the stddev_time column as well. If the standard deviation is large, you can expect some of these queries to be fast and some to be slow, which can lead to poor user experience. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ‚Äúrows‚Äù column can also be quite informative. Suppose 1,000 calls returned 1,000,000,000 rows: in fact, this means that each call returned an average of 1 million rows. It's easy to understand that returning so much data all the time is not too good. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to check whether a particular type of request shows poor caching performance, shared_ * will be of interest. In short: PostgreSQL can tell you the cache hit rate for each individual query type if pg_stat_statements is enabled.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It also makes sense to look at the temp_blks_ * fields. </font><font style="vertical-align: inherit;">Each time PostgreSQL needs to access a disk for sorting or materialization, temporary blocks are required. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally there are blk_read_time and blk_write_time. </font><font style="vertical-align: inherit;">Usually these fields are empty if track_io_timing is not enabled. </font><font style="vertical-align: inherit;">The idea here is to be able to measure the amount of time that a particular type of request spends on I / O. </font><font style="vertical-align: inherit;">This will allow you to answer the question of whether your system is tied to I / O or CPU. </font><font style="vertical-align: inherit;">In most cases, it is recommended that you enable I / O timing, as this will give you important information.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work with Java and Hibernate</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pg_stat_statements gives good information. </font><font style="vertical-align: inherit;">However, in some cases, the request may be aborted due to a configuration variable:</font></font><br>
<br>
<pre><code class="sql hljs">test=<span class="hljs-comment"># SHOW track_activity_query_size;</span><font></font>
track_activity_query_size<font></font>
<span class="hljs-comment">---------------------------</span><font></font>
1024<font></font>
(1 row)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For most applications, 1024 bytes is absolutely sufficient. </font><font style="vertical-align: inherit;">However, this is usually not the case if you are using Hibernate or Java. </font><font style="vertical-align: inherit;">Hibernate tends to send insanely long queries to the database, and so SQL code can be cut long before the relevant parts are run (e.g. FROM clause, etc.). </font><font style="vertical-align: inherit;">Therefore, it makes sense to increase track_activity_query_size to a higher value (possibly 32.786).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Useful Queries for Identifying Bottlenecks in PostgreSQL</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is one query that I found particularly useful in this context: The following query shows 20 queries that take a lot of time:</font></font><br>
<br>
<pre><code class="sql hljs">
test=<span class="hljs-comment"># SELECT substring(query, 1, 50) AS short_query,</span><font></font>
              round(total_time::numeric, 2) AS total_time,<font></font>
              calls,<font></font>
              round(mean_time::numeric, 2) AS mean,<font></font>
              round((100 * total_time / sum(total_time::numeric) OVER ())::numeric, 2) AS percentage_cpu<font></font>
FROM  pg_stat_statements<font></font>
ORDER BY total_time DESC<font></font>
LIMIT 20;<font></font>
           short_query                              | total_time | calls | mean | percentage_cpu<font></font>
<span class="hljs-comment">----------------------------------------------------+------------+-------+------+----------------</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> pg_catalog.lower(<span class="hljs-keyword">name</span>) A   | <span class="hljs-number">11.85</span>      | <span class="hljs-number">7</span>     | <span class="hljs-number">1.69</span> | <span class="hljs-number">38.63</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">EXISTS</span> performance_check <span class="hljs-keyword">CASCADE</span>;    | 4.49       | 4     | 1.12 | 14.64
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> performance_check.pg_st  | <span class="hljs-number">2.23</span>       | <span class="hljs-number">4</span>     | <span class="hljs-number">0.56</span> | <span class="hljs-number">7.27</span>
<span class="hljs-keyword">SELECT</span> pg_catalog.quote_ident(c.relname) <span class="hljs-keyword">FROM</span> pg_c  | <span class="hljs-number">1.78</span>       | <span class="hljs-number">2</span>     | <span class="hljs-number">0.89</span> | <span class="hljs-number">5.81</span>
<span class="hljs-keyword">SELECT</span> a.attname, +                                 | <span class="hljs-number">1.28</span>       | <span class="hljs-number">1</span>     | <span class="hljs-number">1.28</span> | <span class="hljs-number">4.18</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">substring</span>(<span class="hljs-keyword">query</span>, ?, ?) <span class="hljs-keyword">AS</span> short_query,roun   | <span class="hljs-number">1.18</span>       | <span class="hljs-number">3</span>     | <span class="hljs-number">0.39</span> | <span class="hljs-number">3.86</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">FUNCTION</span> performance_check.pg_st  | <span class="hljs-number">1.17</span>       | <span class="hljs-number">4</span>     | <span class="hljs-number">0.29</span> | <span class="hljs-number">3.81</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">FROM</span> pg_stat_activity <span class="hljs-keyword">LIMIT</span> ?;         | 1.17       | 2     | 0.59 | 3.82
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">SCHEMA</span> performance_check;                    | 1.01       | 4     | 0.25 | 3.30
<span class="hljs-keyword">SELECT</span> pg_catalog.quote_ident(c.relname) <span class="hljs-keyword">FROM</span> pg_c  | <span class="hljs-number">0.92</span>       | <span class="hljs-number">2</span>     | <span class="hljs-number">0.46</span> | <span class="hljs-number">3.00</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">FROM</span> performance_check.pg_stat_activi  | <span class="hljs-number">0.74</span>       | <span class="hljs-number">1</span>     | <span class="hljs-number">0.74</span> | <span class="hljs-number">2.43</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_stat_statements <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_ti  | <span class="hljs-number">0.56</span>       | <span class="hljs-number">1</span>     | <span class="hljs-number">0.56</span> | <span class="hljs-number">1.82</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">FROM</span> pg_stat_statements <span class="hljs-keyword">LIMIT</span> ?;       | 0.45       | 4     | 0.11 | 1.45
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">FUNCTION</span> performance_check.pg_sta  | <span class="hljs-number">0.35</span>       | <span class="hljs-number">4</span>     | <span class="hljs-number">0.09</span> | <span class="hljs-number">1.13</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">FROM</span> performance_check.pg_stat_statem  | <span class="hljs-number">0.30</span>       | <span class="hljs-number">1</span>     | <span class="hljs-number">0.30</span> | <span class="hljs-number">0.96</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">FROM</span> performance_check.pg_stat_activi  | <span class="hljs-number">0.22</span>       | <span class="hljs-number">1</span>     | <span class="hljs-number">0.22</span> | <span class="hljs-number">0.72</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">SCHEMA</span> performance_check <span class="hljs-keyword">TO</span> schoenig_  | <span class="hljs-number">0.20</span>       | <span class="hljs-number">3</span>     | <span class="hljs-number">0.07</span> | <span class="hljs-number">0.66</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">FROM</span> performance_check.pg_stat_statem  | <span class="hljs-number">0.20</span>       | <span class="hljs-number">1</span>     | <span class="hljs-number">0.20</span> | <span class="hljs-number">0.67</span>
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">FUNCTION</span> performance_check.pg_sta  | <span class="hljs-number">0.19</span>       | <span class="hljs-number">4</span>     | <span class="hljs-number">0.05</span> | <span class="hljs-number">0.62</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">query</span> <span class="hljs-keyword">FROM</span> performance_check.pg_stat_statem  | <span class="hljs-number">0.17</span>       | <span class="hljs-number">1</span>     | <span class="hljs-number">0.17</span> | <span class="hljs-number">0.56</span>
(<span class="hljs-number">20</span> <span class="hljs-keyword">rows</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The last column is particularly noteworthy: it shows the percentage of total time spent on one query. </font><font style="vertical-align: inherit;">This will help you figure out how the query affects overall performance or not.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488958/index.html">Transcript of my interview with Ruby author</a></li>
<li><a href="../en488960/index.html">Programming, Immunity and the Army</a></li>
<li><a href="../en488962/index.html">Can I write scripts in C ++?</a></li>
<li><a href="../en488964/index.html">Urgent tasks. May the Savior come</a></li>
<li><a href="../en488966/index.html">Ansible playbooks is a code: we check, test, continuously integrate. Ivan Ponomarev</a></li>
<li><a href="../en488982/index.html">S905X processor (secured boot) software security overview</a></li>
<li><a href="../en488984/index.html">‚ÄúIf sites work better, it will be perfect‚Äù: interview with Playwright developer Andrey Lushnikov</a></li>
<li><a href="../en488986/index.html">Who is a mentor and what kind of flexible skills should he have</a></li>
<li><a href="../en488990/index.html">Overview of the full-face mask of UNIX 5100, filters to it, comparison with UNIX 5000, 6100 models and PPM-88 mask</a></li>
<li><a href="../en488994/index.html">DDR5? Yes, we barely met DDR4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>