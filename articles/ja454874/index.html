<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧒🏾 ⚗️ 🚕 マイクロコントローラーのマルチタスクについて少し 💢 🌟 🏬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="マルチタスクについて少し
 

毎日または時々、マイクロコントローラのプログラミングに携わっている人は誰でも、遅かれ早かれ、マルチタスクオペレーティングシステムを使用する必要があるかという質問に直面します。それらの多くはネットワーク上にあり、それらの多くは無料（またはほぼ無料）です。選ぶだけ。
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>マイクロコントローラーのマルチタスクについて少し</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454874/"><p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルチタスクについて少し</font></font></strong></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">毎日または時々、マイクロコントローラのプログラミングに携わっている人は誰でも、遅かれ早かれ、マルチタスクオペレーティングシステムを使用する必要があるかという質問に直面します。</font><font style="vertical-align: inherit;">それらの多くはネットワーク上にあり、それらの多くは無料（またはほぼ無料）です。</font><font style="vertical-align: inherit;">選ぶだけ。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイクロコントローラーが複数の異なるアクションを同時に実行する必要があるプロジェクトに遭遇した場合も、同様の疑問が生じます。それらのいくつかは他と接続されていませんが、残りは反対に、お互いなしではできません。さらに、両方が多すぎる可能性があります。 「多すぎる」とは、誰が評価するか、誰が開発を実行するかによって異なります。まあ、それが同じ人なら。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">むしろ、それは量の問題ではなく、実行速度やその他の要件に関するタスクの質的な違いの問題です。このような考えが発生する可能性があるのは、たとえば、プロジェクトで電源電圧を定期的に監視する必要がある場合（それが欠落していないか）、入力量の値をかなり頻繁に読み取って保存し（休止しない）、時々温度を監視してファンを制御し（呼吸するものがない）、信頼できる人と一緒に監視し（あなたが指示するのは良いことです）、オペレーターと連絡を取り（彼を苛立たせないようにしてください）、認知症のプログラムの永久メモリのチェックサムをチェックします（オンになっているとき、または週に1回、または朝に）。</font></font><a name="habracut"></a></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このような異種タスクは、単一のバックグラウンドタスクとタイマー割り込みに依存して、非常に有意義かつ正常にプログラムできます。これらの割り込みのハンドラでは、次のタスクの「ピース」の1つが実行されるたびに。重要性、緊急性、または類似の考慮事項に応じて、これらの課題は多くの場合、一部のタスクで繰り返されますが、他のタスクではめったに繰り返されません。それでも、各タスクが短時間で作業の一部を実行し、次の作業の準備などを行う必要があります。このアプローチは、慣れていれば複雑すぎないようです。プロジェクトをビルドするときに不便が発生します。または、たとえば、突然別の人に乗り換えます。多くの場合、2番目の方法の方が難しく、疑似多数のタスクがないことに注意してください。</font></font></p><br>
<p>        ? ,   .   .    ,   ,       ,      ,   ,   ,         ,   .    , ,    !   ,       ,  .</p><br>
<p> ,       ,      ?</p><br>
<p>     “”    Cortex-M4 (, ,   M3  M7).   ,        .</p><br>
<p>,   .       .    1     .      main,    .</p><br>
<p><img src="https://habrastorage.org/webt/hz/er/47/hzer47qstbq61q9nj41xkqnquoo.jpeg"></p><br>
<p> ,         ()         .     3     - .</p><br>
<p>,   ,  -      , ,  ,           .      .    () — .  - .</p><br>
<p>  ,     ,       , , ,    .</p><br>
<p> ,  .   2   ,    2.</p><br>
<p><img src="https://habrastorage.org/webt/5j/dm/sv/5jdmsvttcr9cfs5ygk_giclmc5w.jpeg"> </p><br>
<p>       main      ,     ?  .      3.</p><br>
<p><img src="https://habrastorage.org/webt/jg/mh/q4/jgmhq4bmtd26vzif444qypg3c18.jpeg"> </p><br>
<p>  ,  -      -     ?        ,           .  ,   .   3       ( ).     4.</p><br>
<p><img src="https://habrastorage.org/webt/50/no/ma/50nomamrfalo_crb2hmf1nkalli.jpeg"></p><br>
<p> ,  ,        -   .         ,   .      ,        (    — )       - ,     .  ,   ,    .   ,    ,      ,    Cortex-M4.</p><br>
<p>       ,    ,  ,     . ?  ,   -  .               .   5     .</p><br>
<p><img src="https://habrastorage.org/webt/tp/tz/wo/tptzwopr7htrcuhwgb6y6ydfdae.jpeg"></p><br>
<p>  ,          . ,    ,     ,          (    SP),         (  ),      (     SP)         .       SP   . ,    , .           .</p><br>
<p>,     ,    task3    main.   , ,  ,   Cortex-M4   SysTick      ,       .         .</p><br>
<p> ,     ,        ,      .</p><br>
<pre><code class="plaintext hljs">U8 main_start_task_switcher(void);</code></pre><br>
<p>   0,       ,  -   . ,  ,          ,         . , .</p><br>
<p> -     ,         , ,   .</p><br>
<p>,  ,               ,       .  ,        ,           ,    .     </p><br>
<pre><code class="plaintext hljs">  U8 task_run_and_return_task_number(U32 taskAddress);</code></pre><br>
<p>    32-     ,    .   ()    ,      ,  0,      .       ,      ,            main.         .</p><br>
<p>   .          .</p><br>
<p>,  ,   ,      ,   SPI ,  - ,   ,   .           ( ),     - .      ,     .        - .  :   ,   . , ,    .</p><br>
<p>      .  ,            .      .     ,   ,     ,     .               . , ,      ,     ,      .</p><br>
<p>  ,  .       :    .       :<br>
 SP  SP .  ,      ,           .  ,        .  ,      .</p><br>
<p> ,   , ,            .           ,      .  Cortex-M4        SVC,      .    ,     .            ,     .    ,    .   ,   ,       .    ,     .</p><br>
<pre><code class="plaintext hljs"> void release_me_and_set_sleep_period(U32 ticks);</code></pre><br>
<p>        .  0,        .  0xFFFFFFFF,    „“   ,  -  .       ,        .</p><br>
<p>  -        ,    .</p><br>
<pre><code class="plaintext hljs">  void task_wake_up_action(U8 taskNumber);<font></font>
<font></font>
    void set_task_sleep_period(U8 taskNumber, U32 ticks);</code></pre><br>
<p>,   ,   .</p><br>
<pre><code class="plaintext hljs">   void task_remove_action(U8 taskNumber);</code></pre><br>
<p>,  ,     . ,   ,    .  ?</p><br>
<p>  ,    ,     ,    .</p><br>
<p>  ,  ,    ,    ,      ,  (   Cortex-M4).      .    .   ,     Cortex-M4(M3, M7),   IAR Embedded Workbench.</p><br>
<p>,        ,  ,    .  ,       ARM Cortex-M4.</p><br>
<pre><code class="plaintext hljs">SysTick_Handler<font></font>
    STMDB   SP!,{R4-R11}        ;  <font></font>
    LDR     R0,=timersTable     ;   <font></font>
    LDR     R1,=stacksTable     ;   <font></font>
    LDR     R2,[R0]             ;R2   () <font></font>
    STR     SP,[R1,R2,LSL #2]   ;   SP (R2 * 4)<font></font>
__st_next_check<font></font>
    ADD     R2,R2,#1            ;  <font></font>
    CMP     R2,#TASKS_LIMIT     ;R2-TASKS_LIMIT <font></font>
    BLO     __st_no_border_yet  ;  <font></font>
    MOV     R2,#0               ;    (main)<font></font>
    LDR     R3,[R1]             ; main SP<font></font>
    MOV     SP,R3<font></font>
    B       __st_timer_ok<font></font>
__st_no_border_yet<font></font>
;;    LDR     SP,[R1,R2,LSL #2]   ;    (errata Cortex M4)<font></font>
;;    CMP     SP,#0               ;<font></font>
    LDR     R3,[R1,R2,LSL #2]   ;  SP     <font></font>
    CMP     R3,#0               ; =0    <font></font>
    BEQ     __st_next_check<font></font>
      MOV     SP,R3<font></font>
    LDR     R3,[R0,R2,LSL #2]   ;  suspend timer<font></font>
    CBZ     R3,__st_timer_ok    ; 0    ,  <font></font>
;<font></font>
    CMP     R3,#0xFFFFFFFF      ; ,  <font></font>
    BEQ     __st_next_check<font></font>
    SUB     R3,R3,#1            ;  1<font></font>
    STR     R3,[R0,R2,LSL #2]   ;  suspend timer<font></font>
    B       __st_next_check<font></font>
__st_timer_ok<font></font>
    STR     R2,[R0]             ;    <font></font>
    LDMIA   SP!,{R4-R11}        ;  R4-R11<font></font>
    BX      LR</code></pre><br>
<p> ,   ,     ,   .    ,      ,     (  ).    .    ,          SVC. ,        (    ),   .   ,              .     ,         ,    (    ). ,    ,             SVC,         .  ,   ,  ,   .   .       .         SVC. ,  , .   .</p><br>
<pre><code class="plaintext hljs">SVC_Handler<font></font>
    LDR     R0,__sysTickAddr    ; SysTick <font></font>
    MOV     R1,#6               ;   CSR ,  <font></font>
    STR     R1,[R0]             ;Stop SysTimer<font></font>
    MOV     R1,#7               ; ,  <font></font>
    STR     R1,[R0]             ;Start SysTimer<font></font>
;<font></font>
    STMDB   SP!,{R4-R11}        ;  <font></font>
    LDR     R0,=timersTable     ;   <font></font>
    LDR     R1,=stacksTable     ;   <font></font>
    LDR     R2,[R0]             ;R2   () <font></font>
    STR     SP,[R1,R2,LSL #2]   ;   SP (R2 * 4)<font></font>
    LDR     R3,=tmpTimersTable  ;   tmpTimers<font></font>
    LDR     R3,[R3,R2,LSL #2]   ;tmpTimer   <font></font>
    STR     R3,[R0,R2,LSL #2]   ; timer <font></font>
__svc_next_check<font></font>
    ADD     R2,R2,#1            ;  <font></font>
    CMP     R2,#TASKS_LIMIT     ;R2-TASKS_LIMIT <font></font>
    BLO     __svc_no_border_yet ;  <font></font>
    MOV     R2,#0               ;    (main)<font></font>
    LDR     R3,[R1]             ; main SP<font></font>
    MOV     SP,R3<font></font>
    B       __svc_timer_ok<font></font>
__svc_no_border_yet<font></font>
;;    LDR     SP,[R1,R2,LSL #2]   ;Restore SP does not work (errata Cortex M4)<font></font>
;;    CMP     SP,#0               ;<font></font>
    LDR     R3,[R1,R2,LSL #2]   ;  SP     <font></font>
    CMP     R3,#0               ; =0    <font></font>
    BEQ     __svc_next_check<font></font>
      MOV     SP,R3<font></font>
    LDR     R3,[R0,R2,LSL #2]   ;  suspend timer<font></font>
    CBZ     R3,__svc_timer_ok   ; 0    ,  <font></font>
    B       __svc_next_check<font></font>
__svc_timer_ok<font></font>
    STR     R2,[R0]             ;    <font></font>
    LDMIA   SP!,{R4-R11}        ; R4-R11<font></font>
    BX      LR</code></pre><br>
<p> ,            ,          7.</p><br>
<pre><code class="plaintext hljs">            DATA<font></font>
            SECTION .taskSwitcher:CODE:ROOT(2)<font></font>
__topStack<font></font>
            DCD     sfe(CSTACK)<font></font>
__botStack<font></font>
            DCD     sfb(CSTACK)<font></font>
__dimStack<font></font>
            DCD     sizeof(CSTACK)<font></font>
__sysAIRCRaddr<font></font>
            DCD     0xE000ED0C<font></font>
__sysTickAddr<font></font>
            DCD     0xE000E010<font></font>
__sysSHPRaddr<font></font>
            DCD     0xE000ED18<font></font>
__sysTickReload<font></font>
            DCD     RELOAD<font></font>
;*******************************************************************************<font></font>
; Task table for concurrent tasks (main is number 0).<font></font>
;*******************************************************************************<font></font>
            SECTION TABLE:DATA:ROOT(2)<font></font>
            DS32    1             ;stack shift due to FPU<font></font>
mainCopyCONTROL<font></font>
            DS32    1             ;Needed to determine if FPU is used<font></font>
mainPSRvalue<font></font>
            DS32    1             ;Copy from main<font></font>
;*******************************************************************************</code></pre><br>
<p> ,       ,       IAR Embedded Workbench,        .     STM32F303VCT6 (ARM Cortex-M4).  ,    STM32F3DISCOVERY.   ,         .</p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに便利な機能がいくつかあります。</font><font style="vertical-align: inherit;">たとえば、各スタック領域で影響を受けていないワードの数をカウントする、つまりゼロのままであるサブルーチン。</font><font style="vertical-align: inherit;">これは、デバッグ時に、スタックを1つのタスクで満たすのが制限レベルに近すぎるかどうかを確認する必要がある場合に役立ちます。</font></font></p><br>
<pre><code class="plaintext hljs">  U32 get_task_stack_empty_space(U8 taskNum);</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もう1つ関数について説明します。</font><font style="vertical-align: inherit;">これは、タスク自体がリスト内の番号を見つける機会です。</font><font style="vertical-align: inherit;">その後、後で誰かに伝えることができます。</font></font></p><br>
<pre><code class="plaintext hljs">;*******************************************************************************<font></font>
;     Example: U8 get_my_number(void);<font></font>
;     (). ..    .<font></font>
;*******************************************************************************<font></font>
get_my_number<font></font>
    LDR     R0,=timersTable   ;    (currentTaskNumber)<font></font>
    LDR     R0,[R0]           ; <font></font>
    BX      LR<font></font>
;==============================================================</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現時点では、これですべてです。</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja454850/index.html">単一のアルゴリズムの進化</a></li>
<li><a href="../ja454856/index.html">ブラウザー以外のソフトウェアにおけるSSL / TLS証明書検証の脆弱性を分析します</a></li>
<li><a href="../ja454864/index.html">さまざまな企業の開発プロセスはどうですか</a></li>
<li><a href="../ja454868/index.html">EmscriptenなしでWebAssemblyでCをコンパイルする</a></li>
<li><a href="../ja454872/index.html">Space Invaders：512バイト（Assembler x86）にもなりました</a></li>
<li><a href="../ja454876/index.html">ゲームにおけるキャラクター能力の柔軟なシステムの設計について</a></li>
<li><a href="../ja454878/index.html">MITER ATT＆CKを勉強しています。モバイルマトリックス：デバイスアクセス。パート3</a></li>
<li><a href="../ja454880/index.html">フリーランサーの人生における「オフシーズン」：生き残り、生き残る方法は？</a></li>
<li><a href="../ja454884/index.html">JSでの読みやすいテストの命名と行動パターン</a></li>
<li><a href="../ja454886/index.html">肝臓に座っています。肝腫瘍の切除が外科医の優れたスキルの指標である理由</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>