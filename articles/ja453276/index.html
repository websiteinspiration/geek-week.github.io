<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔫 ⚕️ ⏳ Arduinoとタイマー割り込み 🐈 ☪️ 🛴</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！Eによる記事「Timer interrupts」の翻訳を紹介します。
 序文
 

Arduinoボードを使用すると、さまざまな問題を迅速かつ最小限に解決できます。しかし、任意の時間間隔が必要な場合（センサーの定期的なポーリング、高精度のPWM信号、長時間のパルス）標準ライブラリ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Arduinoとタイマー割り込み</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453276/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル！</font><font style="vertical-align: inherit;">Eによる</font><font style="vertical-align: inherit;">記事</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「Timer interrupts」の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">翻訳を紹介します</font><font style="vertical-align: inherit;">。</font></font></p><br>
<h3 id="predislovie"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">序文</font></font></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduinoボードを使用すると、さまざまな問題を迅速かつ最小限に解決できます。</font><font style="vertical-align: inherit;">しかし、任意の時間間隔が必要な場合（センサーの定期的なポーリング、高精度のPWM信号、長時間のパルス）標準ライブラリの遅延関数は便利ではありません。</font><font style="vertical-align: inherit;">彼らの行動の間、スケッチは中断され、それを管理することができなくなります。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この状況では、組み込みのAVRタイマーを使用することをお勧めします。</font><font style="vertical-align: inherit;">これを行う方法、およびデータシートの技術的な荒野で迷子にならない方法は</font><font style="vertical-align: inherit;">、その翻訳があなたの注意にもたらされる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功した記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と述べ</font><font style="vertical-align: inherit;">ています。</font></font></p><br>
<p><img src="https://habrastorage.org/webt/3g/n_/iw/3gn_iwqe-tubwgqslsclzuaznki.png"></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、AVRタイマーとArduinoタイマー、およびそれらをArduinoプロジェクトとユーザー回路で使用する方法について説明します。</font></font></p><br>
<h3 id="chto-takoe-taymer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイマーとは？</font></font></h3><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイクロコントローラーの日常生活と同様に、タイマーは、設定した瞬間に将来信号を送ることができるものです。</font><font style="vertical-align: inherit;">この瞬間が来ると、マイクロコントローラーが中断され、特定のコードを実行するなど、何かをするように指示します。</font></font></p><br>
<p>,    ,     .        <em>millis()</em>       ,         .</p><br>
<p>, ,   ,   - ,     5 .    ,    ,                 .        ,    .     ,     .</p><br>
<h3 id="kak-rabotaet-taymer">  ?</h3><br>
<p>    ,  <em> </em>.       ,    .            ,          .     ,    ,   .</p><br>
<p>           —       .           (<em>Interrupt Service Routine</em>  <em>ISR</em>),    ,   . ISR    ,       -   .</p><br>
<p>       ,      .      .  ,     ,      .      ,       .       1 ,    (  ) :</p><br>
<p>T = 1 / f (f   )<br>
T = 1 / 1  = 1 / 10^6 <br>
T = (1 ∗ 10^-6) </p><br>
<p>       .         ,        .</p><br>
<h3 id="tipy-taymerov"> </h3><br>
<p>   Arduino  8  AVR     .   Atmega168  Atmega328    Timer0, Timer1  Timer2.     ,            .     .</p><br>
<p>Timer0:<br>
Timer0  8  ,  ,          255 (. .   ). Timer0     Arduino   <em>delay()</em>  <em>millis()</em>,          .</p><br>
<p>Timer1:<br>
Timer1  16       65535 (  ).     Arduino Servo,        .</p><br>
<p>Timer2:<br>
Timer2 — 8      Timer0.    Arduino  <em>tone()</em>.</p><br>
<p>Timer3, Timer4, Timer5:<br>
 ATmega1280  ATmega2560 (   Arduino Mega)    .   16     Timer1.</p><br>
<h3 id="konfiguraciya-registrov"> </h3><br>
<p>       AVR   .     .    —   /      TCCRxA  TCCRxB,  x —   (TCCR1A  TCCR1B,  . .).    8       .     Atmega328:</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>TCCR1A</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>7</td>
<td>6</td>
<td>5</td>
<td>4</td>
<td>3</td>
<td>2</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>0x80</td>
<td>COM1A1</td>
<td>COM1A0</td>
<td>COM1B1</td>
<td>COM1B0</td>
<td>-</td>
<td>-</td>
<td>WGM11</td>
<td>WGM10</td>
</tr>
<tr>
<td>ReadWrite</td>
<td>RW</td>
<td>RW</td>
<td>RW</td>
<td>RW</td>
<td>R</td>
<td>R</td>
<td>RW</td>
<td>RW</td>
</tr>
<tr>
<td> </td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table></div><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>TCCR1B</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>7</td>
<td>6</td>
<td>5</td>
<td>4</td>
<td>3</td>
<td>2</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>0x81</td>
<td>ICNC1</td>
<td>ICES1</td>
<td>-</td>
<td>WGM13</td>
<td>WGM12</td>
<td>CS12</td>
<td>CS11</td>
<td>CS10</td>
</tr>
<tr>
<td>ReadWrite</td>
<td>RW</td>
<td>RW</td>
<td>R</td>
<td>RW</td>
<td>RW</td>
<td>RW</td>
<td>RW</td>
<td>RW</td>
</tr>
<tr>
<td> </td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody>
</table></div><br>
<p>       TCCR1B: CS12, CS11  CS10.     .             .    ,    :</p><br>
<div class="scrollable-table"><table>
<thead>
<tr>
<th>CS12</th>
<th>CS11</th>
<th>CS10</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>   (Timer/Counter )</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>1</td>
<td>clk_io/1 ( )</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>0</td>
<td>clk_io/8 ( )</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>1</td>
<td>clk_io/64 ( )</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>0</td>
<td>clk_io/256 ( )</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>1</td>
<td>clk_io/1024 ( )</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0</td>
<td>     T1.   </td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>     T1.   </td>
</tr>
</tbody>
</table></div><br>
<p>       .</p><br>
<p>  ,  Timer1         .   ,     ,   ,    13,     .     Arduino ,        avr-libc ,       .   AVR      .</p><br>
<p>  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// avr-libc library includes</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/io.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/interrupt.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LEDPIN 13</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span>
</span>{<font></font>
    pinMode(LEDPIN, OUTPUT);<font></font>
<font></font>
    <span class="hljs-comment">//  Timer1</span>
    cli(); <span class="hljs-comment">//   </span>
    TCCR1A = <span class="hljs-number">0</span>; <span class="hljs-comment">//  TCCR1A   0</span>
    TCCR1B = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-comment">//   Timer1 overflow:</span>
    TIMSK1 = (<span class="hljs-number">1</span> &lt;&lt; TOIE1);
    <span class="hljs-comment">//  CS10  ,      :</span>
    TCCR1B |= (<span class="hljs-number">1</span> &lt;&lt; CS10);<font></font>
<font></font>
    sei();  <span class="hljs-comment">//   </span>
}</code></pre><br>
<p> TIMSK1     /1.   ,    .   TOIE1       .    .</p><br>
<p>    CS10,    ,      ,  ISR(TIMER1_OVF_vect).      .</p><br>
<p>    ISR:</p><br>
<pre><code class="cpp hljs">ISR(TIMER1_OVF_vect)<font></font>
{<font></font>
    digitalWrite(LEDPIN, !digitalRead(LEDPIN));<font></font>
}</code></pre><br>
<p>     loop()      ,     .   ,  TCCR1B=0   .</p><br>
<h3 id="kak-chasto-budet-migat-svetodiod">    ?</h3><br>
<p>Timer1        ,    Atmega328    16 .   16-,       (2^16 – 1),  65535.  16    1/(16 ∗ 10^6)   6.25e-8 .    65535    (65535 ∗ 6.25e-8 )  ISR     0,0041 .     ,   .   ,   .</p><br>
<p>          50% ,     ,     .       —   8-          .</p><br>
<h3 id="delitel-taymera-i-rezhim-ctc">    CTC</h3><br>
<p>  ,    ,             . ,         .   TCCR1B    CS    .    CS10  CS12 :</p><br>
<pre><code class="cpp hljs">TCCR1B |= (<span class="hljs-number">1</span> &lt;&lt; CS10);<font></font>
TCCR1B |= (<span class="hljs-number">1</span> &lt;&lt; CS12);</code></pre><br>
<p>      1024.     1/(16 ∗ 10^6 / 1024)  6.4e-5 .      (65535 ∗ 6.4e-5)   4,194.   .</p><br>
<p>     AVR .        CTC.    ,           .      ,     ,   ,        .</p><br>
<p>   CTC  ,    ,      . ,    -  1024.</p><br>
<p>  :</p><br>
<pre><code class="plaintext hljs">(target time) = (timer resolution) * (# timer counts + 1)<font></font>
<font></font>
(# timer counts + 1) = (target time) / (timer resolution)<font></font>
(# timer counts + 1) = (1 s) / (6.4e-5 s)<font></font>
(# timer counts + 1) = 15625<font></font>
(# timer counts) = 15625 - 1 = 15624</code></pre><br>
<p>           CTC             .     ,     .          ,        .</p><br>
<p>  setup()  :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span>
</span>{<font></font>
    pinMode(LEDPIN, OUTPUT);<font></font>
<font></font>
    <span class="hljs-comment">//  Timer1</span>
    cli(); <span class="hljs-comment">//   </span>
    TCCR1A = <span class="hljs-number">0</span>; <span class="hljs-comment">//    0</span>
    TCCR1B = <span class="hljs-number">0</span>; <font></font>
<font></font>
    OCR1A = <span class="hljs-number">15624</span>; <span class="hljs-comment">//   </span>
    TCCR1B |= (<span class="hljs-number">1</span> &lt;&lt; WGM12); <span class="hljs-comment">//   CTC </span><font></font>
<font></font>
    <span class="hljs-comment">//   CS10  CS12    1024</span>
    TCCR1B |= (<span class="hljs-number">1</span> &lt;&lt; CS10);<font></font>
    TCCR1B |= (<span class="hljs-number">1</span> &lt;&lt; CS12);<font></font>
<font></font>
    TIMSK1 |= (<span class="hljs-number">1</span> &lt;&lt; OCIE1A);  <span class="hljs-comment">//    </span>
    sei(); <span class="hljs-comment">//   </span>
}</code></pre><br>
<p>         :</p><br>
<pre><code class="cpp hljs">ISR(TIMER1_COMPA_vect)<font></font>
{<font></font>
     digitalWrite(LEDPIN, !digitalRead(LEDPIN));<font></font>
}</code></pre><br>
<p>         .          loop().      ,      .             .</p><br>
<p>            :</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Arduino  CTC </span>
<span class="hljs-comment">// avr-libc library includes</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/io.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;avr/interrupt.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LEDPIN 13</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span>
</span>{<font></font>
    pinMode(LEDPIN, OUTPUT);<font></font>
<font></font>
    <span class="hljs-comment">//  Timer1</span>
    cli();  <span class="hljs-comment">//   </span>
    TCCR1A = <span class="hljs-number">0</span>;   <span class="hljs-comment">//    0</span>
    TCCR1B = <span class="hljs-number">0</span>;<font></font>
<font></font>
    OCR1A = <span class="hljs-number">15624</span>; <span class="hljs-comment">//   </span><font></font>
<font></font>
    TCCR1B |= (<span class="hljs-number">1</span> &lt;&lt; WGM12);  <span class="hljs-comment">//  CTC  </span>
    TCCR1B |= (<span class="hljs-number">1</span> &lt;&lt; CS10); <span class="hljs-comment">//      1024</span>
    TCCR1B |= (<span class="hljs-number">1</span> &lt;&lt; CS12);<font></font>
<font></font>
    TIMSK1 |= (<span class="hljs-number">1</span> &lt;&lt; OCIE1A);  <span class="hljs-comment">//      </span>
    sei(); <span class="hljs-comment">//   </span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">//  </span><font></font>
}<font></font>
<font></font>
ISR(TIMER1_COMPA_vect)<font></font>
{<font></font>
    digitalWrite(LEDPIN, !digitalRead(LEDPIN));<font></font>
}</code></pre><br>
<p>,      ISR     .       10 .   ,       .    ISR               10.            :</p><br>
<pre><code class="cpp hljs">ISR(TIMER1_COMPA_vect)<font></font>
{<font></font>
    seconds++;<font></font>
    <span class="hljs-keyword">if</span>(seconds == <span class="hljs-number">10</span>)<font></font>
    {<font></font>
        seconds = <span class="hljs-number">0</span>;<font></font>
        readSensor();<font></font>
    }<font></font>
}</code></pre><br>
<p>     ISR      <em>volatile</em>. ,         : </p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">volatile</span> byte seconds;</code></pre><br>
<h3 id="posleslovie-perevodchika"> </h3><br>
<p>             . ,       .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja453260/index.html">DPI設定機能</a></li>
<li><a href="../ja453262/index.html">CortexMマイクロコントローラーに保存されている定数の場所（例としてC ++ IARコンパイラーを使用）</a></li>
<li><a href="../ja453264/index.html">Virtuali-tee：カバーはしないが露出する「医療用Tシャツ」</a></li>
<li><a href="../ja453272/index.html">GitHubスポンサー：オープンソースに貢献する新しい方法</a></li>
<li><a href="../ja453274/index.html">サムスンペイの隠し手数料Yandex.Money</a></li>
<li><a href="../ja453278/index.html">なぜエンジニアはアプリケーションの監視を気にしないのですか？</a></li>
<li><a href="../ja453280/index.html">技術的負債</a></li>
<li><a href="../ja453286/index.html">私の人生で最も高価な間違い：SIMカードポートへの攻撃の詳細</a></li>
<li><a href="../ja453290/index.html">データサイエンスダイジェスト（2019年5月）</a></li>
<li><a href="../ja453292/index.html">「ブラックホールについての小さな本」</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>