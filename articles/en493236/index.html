<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñêüèº ‚öôÔ∏è üò• Asterisk: external trunks in Request Sent state üïì üëï ü§µüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A familiar picture?
 
 

[root@pbx scripts]# asterisk -x "sip show registry" Host dnsmgr Username Refresh State Reg.Time sipnet.ru:5060 Y XXXXXXXXXXX ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Asterisk: external trunks in Request Sent state</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493236/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A familiar picture?</font></font><br>
<br>
<pre><code class="bash hljs">[root@pbx scripts]<span class="hljs-comment"># asterisk -x "sip show registry"</span><font></font>
Host                                    dnsmgr Username       Refresh State                Reg.Time<font></font>
sipnet.ru:5060                          Y      XXXXXXXXXXX         102 Request Sent           Fri, 20 Mar 2020 09:19:31<font></font>
87.103.236.26:5060                      N      XXXXXX             105 Request Sent           Fri, 20 Mar 2020 09:20:55<font></font>
sbc.megafon.ru:5060                     Y      XXXXXXXXXXX@       165 Request Sent           Fri, 20 Mar 2020 09:20:28<font></font>
login.mtt.ru:5060                       Y      XXXXXXXXXXXXXX       105 Request Sent           Fri, 20 Mar 2020 09:19:50<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once she got me too, and I wrote a script.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I tried to search for ready-made recipes, the majority boiled down to this: </font><font style="vertical-align: inherit;">
I got a ping of the addresses, turned on the debug and saw in it exactly what was said in the first sentence of the quote "packets go, but the answers do not come." But why? </font><font style="vertical-align: inherit;">
Point number 1 was ruled out elementary. Point number 2 - too, because a test connection from the same IP address but a different internal host worked. Point number 4 is absolutely "zhost". But number 3 is already closer. It just doesn‚Äôt block, but for some reason it does not allow the host to exchange packets with Asterisk. </font><font style="vertical-align: inherit;">
And this happens in 99% of cases after point 2, when the PPPoE session breaks. The session is then restored, and access to the Internet from LAN is also available, but UDP sessions are stuck. </font><font style="vertical-align: inherit;">
Here is what Mikrotik tells us through which these sessions go:</font></font><br>
<br>
<code>     ,    .<br>
<br>
1)    .<br>
2)    <br>
3)     <br>
4)       .<br>
    ..  </code><br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="bash hljs">[admin@MikroTik] &gt; /ip firewall connection <span class="hljs-built_in">print</span> <span class="hljs-built_in">where</span> dst-address~<span class="hljs-string">":5060"</span> and srcnat<font></font>
Flags: E - expected, S - seen-reply, A - assured, C - confirmed, D - dying, F - fasttrack, s - srcnat, d - dstnat<font></font>
 <span class="hljs-comment">#          PR.. SRC-ADDRESS           DST-ADDRESS           TCP-STATE   TIMEOUT     ORIG-RATE REPL-RATE ORIG-PACKETS REPL-PACKETS      ORIG-BYTES</span><font></font>
 0  SAC  s  udp  10.X.X.X:5060     80.75.130.83:5060                 59m48s           0bps      0bps        2 172        2 191       1 358 335<font></font>
 1  SAC  s  udp  10.X.X.X:5060     193.201.229.35:5060               59m47s           0bps      0bps        1 611        1 662         996 786<font></font>
 2  SAC  s  udp  10.X.X.X:5060     212.53.40.40:5060                 59m44s           0bps      0bps        1 837        1 830       1 114 259<font></font>
 3  SAC  s  udp  10.X.X.X:5060     87.103.236.26:5060                59m21s           0bps      0bps        2 501        2 509       1 614 239<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the state of the sessions in normal mode when everything is working. </font><font style="vertical-align: inherit;">In the absence of registrations, if memory serves me correctly, there is no flag S - seen-reply. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We try to cut down the stuck sessions with the command:</font></font><br>
<br>
<pre><code class="bash hljs">[admin@MikroTik] &gt; ip firewall connection remove [find <span class="hljs-built_in">where</span> dst-address~<span class="hljs-string">":5060"</span> and srcnat]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And, lo and behold, literally in a second trunks are restored, calls go on, life blooms with bright colors! </font><font style="vertical-align: inherit;">So we are writing a script! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we need to control Mikrot based on information from Asterisk. </font><font style="vertical-align: inherit;">Therefore, the script will be run in cron every 5 minutes on the host with Asterisk, and we will manage Mikrot via ssh with a certificate. </font><font style="vertical-align: inherit;">Here </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> perfectly painted everything - how to create the key and tied it to a new user on the microtia. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, the script itself:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-keyword">if</span> /usr/sbin/asterisk -x <span class="hljs-string">"sip show registry"</span> | grep -q <span class="hljs-string">"Request Sent"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span> Resetting UDP connections on Mikrotik"</span> &gt;&gt; /var/<span class="hljs-built_in">log</span>/asterisk/mikrotik<font></font>
    ssh -l admin-ssh -i /XXXX/.ssh/id_dsa 10.X.X.X <span class="hljs-string">'ip firewall connection remove [find where dst-address~":5060" and srcnat]'</span><font></font>
    sleep 2<font></font>
    asterisk -x <span class="hljs-string">"sip reload"</span>
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just in case, 2 seconds after the reset of the hung-up sessions, we update the registration - so that it definitely works! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From September 4, 2019, the script worked 273 times, judging by the log. </font><font style="vertical-align: inherit;">You can calculate how much he saved me time, and the managers and their client nerves. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS A similar situation occurs on all routers that I came across in conjunction with Asterisk. </font><font style="vertical-align: inherit;">And only Mikrot can solve the problem without affecting other services. </font><font style="vertical-align: inherit;">The rest of the routers need to be stupidly overloaded.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493224/index.html">How I streamed the seminar and students even talked to me</a></li>
<li><a href="../en493226/index.html">How to read and fix 100,000 lines of code per week</a></li>
<li><a href="../en493230/index.html">New Google PageSpeed ‚Äã‚ÄãInsights powered by Lighthouse 6 (beta): check your site‚Äôs performance</a></li>
<li><a href="../en493232/index.html">The history of my work at Open Product LLC</a></li>
<li><a href="../en493234/index.html">ING Launches Lion: A Library of Productive, Affordable, and Flexible Web Components</a></li>
<li><a href="../en493242/index.html">HTTP String Fast Processing Algorithms</a></li>
<li><a href="../en493244/index.html">What can a quantum computer</a></li>
<li><a href="../en493248/index.html">Webinar "Winnum Opportunities for Industrial Analytics"</a></li>
<li><a href="../en493250/index.html">What is happening with travel right now - and how to protect yourself in transport</a></li>
<li><a href="../en493252/index.html">Teaching experience at a development school, or why you need to go to school after university</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>