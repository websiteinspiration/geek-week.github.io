<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍👩‍👦‍👦 👨🏿‍🎤 👨‍👩‍👧‍👧 BASCOM AVR環境のMK AVR用AQUA RTOSリアルタイムOS 🧑🏾‍🤝‍🧑🏾 🗽 👨🏽‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="「ライトを点滅させる」よりも複雑なMKコードを記述する場合、開発者は「スーパーサイクルと割り込み」のスタイルの線形プログラミングに固有の制限に直面します。割り込みの処理には速度と簡潔さが必要です。これにより、コードにフラグが追加され、プロジェクトスタイルが「割り込みとフラグのあるスーパーサイクル」に...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>BASCOM AVR環境のMK AVR用AQUA RTOSリアルタイムOS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453708/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ライトを点滅させる」よりも複雑なMKコードを記述する場合、開発者は「スーパーサイクルと割り込み」のスタイルの線形プログラミングに固有の制限に直面します。割り込みの処理には速度と簡潔さが必要です。これにより、コードにフラグが追加され、プロジェクトスタイルが「割り込みとフラグのあるスーパーサイクル」になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムの複雑さが増すと、相互に依存するフラグの数が指数関数的に増加し、プロジェクトはすぐに読みにくく、管理しにくい「パスタコード」に変わります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リアルタイムのオペレーティングシステムを使用すると、「パスタコード」を取り除き、柔軟性と管理性を複雑なMKプロジェクトに戻すことができます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いくつかの協調リアルタイムオペレーティングシステムが開発されており、AVRマイクロコントローラーで非常に人気があります。ただし、それらはすべてCまたはアセンブラーで記述されており、BASCOM AVR環境でMKをプログラミングする人には適していません。深刻なアプリケーションを作成するためのこのような有用なツールを利用できません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この欠点を修正するために、BASCOM AVRプログラミング環境用の簡単なRTOSを開発しました。これを読者の注目を集めました。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/cd6/0be/c64/cd60bec64b2a0b96ed562770a9063355.jpg" alt="画像"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの人にとって、おなじみのMKプログラミングスタイルは、いわゆる</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スーパーサイクル</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。この場合、コードは、一連の関数、プロシージャ、および記述子（定数、変数）で構成され、一般に「バックグラウンドコード」と呼ばれるライブラリのものと、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do-loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造で囲まれた大きな無限ループで構成され</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。起動時に、MK自体と外部デバイスの機器が最初に初期化され、定数と変数の初期値が設定され、次に制御がこの無限スーパーサイクルに移されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スーパーサイクルの単純さは明らかです。 MKが実行するタスクのほとんどは、何らかの方法で循環しているためです。不利な点も明らかです。あるデバイスまたは信号が即時の反応を必要とする場合、MKはサイクルが回るのと同じくらい早くそれを提供します。信号の継続時間がサイクル周期より短い場合、そのような信号はスキップされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の例では、ボタンが</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">押された</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">かどうかを確認します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">do</span>
    <span class="hljs-comment">' - </span>
    <span class="hljs-keyword">if</span> button = <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-comment">'    </span>
    <span class="hljs-comment">'  - </span>
<span class="hljs-keyword">loop</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、「一部のコード」が十分に長く機能する場合、MKはボタンの短押しに気付かない可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸い、MKにはこの問題を解決できる割り込みシステムが装備されています。すべての重要な信号を割り込みに「掛けて」、ハンドラごとに書き込むことができます。したがって、次のレベルが表示されます：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中断の</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ある</font><i><font style="vertical-align: inherit;">スーパーサイクル</font></i><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下の例は、ボタンのクリックを処理するスーパーサイクルと割り込みを備えたプログラムの構造を示しています。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">on</span> button button_isr <span class="hljs-comment">'   </span><font></font>
enable interrupts<font></font>
<font></font>
<span class="hljs-comment">' ***  ***</span>
<span class="hljs-keyword">do</span>
    <span class="hljs-comment">' - </span>
<span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-comment">'  </span><font></font>
button_isr:<font></font>
    <span class="hljs-comment">'  -   </span>
return</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、割り込みを使用すると、新しい問題が発生します。割り込みハンドラのコードは、可能な限り高速で短くする必要があります。</font><font style="vertical-align: inherit;">割り込みの内部では、MK機能が制限されています。</font><font style="vertical-align: inherit;">AVR MKには階層的な割り込みシステムがないため、割り込み内で別の割り込みが発生することはありません。現時点ではハードウェアが無効になっています。</font><font style="vertical-align: inherit;">そのため、割り込みはできるだけ迅速に実行する必要があります。そうしないと、他の割り込み（およびおそらくより重要な割り込み）がスキップされて処理されません。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">割り込みメモリ</font></font></b><div class="spoiler_text">  ,   ,         ,     .          .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、特にこのコードに遅延が必要な場合は、割り込みハンドラーに複雑なものを書き込むことはできません。遅延が機能するまで、MKはメインプログラム（スーパーサイクル）に戻らず、他の割り込みに耳を貸さないためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このため、割り込みハンドラー内では、イベントごとに独自のフラグでイベントの事実にフラグを付け、スーパーサイクル内のフラグを確認して処理するだけで済みます。もちろん、これによりイベントへの反応時間が長くなりますが、少なくとも重要なものを見逃すことはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、次のレベルの複雑さが発生します- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">割り込みとフラグを持つスーパーサイクル</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコードを示します。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">on</span> button button_isr <span class="hljs-comment">'   </span><font></font>
enable interrupts<font></font>
<font></font>
<span class="hljs-comment">' ***  ***</span>
<span class="hljs-keyword">do</span>
    <span class="hljs-comment">' - </span>
    <span class="hljs-keyword">if</span> button_flag = <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> 
        <span class="hljs-comment">'    </span>
        button_flag = <span class="hljs-number">0</span> <span class="hljs-comment">'    </span>
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>
    <span class="hljs-comment">'  - </span>
<span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-comment">' ***    ***</span><font></font>
button_isr:<font></font>
    button_flag = <span class="hljs-number">1</span>
return</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、MKのかなりの数のプログラムが制限されます。ただし、そのようなプログラムは通常、多かれ少なかれ単純です。もっと複雑なものを書くと、フラグの数は雪だるまのように増え始め、コードはますます混乱して読みにくくなります。また、上記の例では、遅延の問題は解決されていません。もちろん、タイマーに個別の割り込みを「掛ける」ことができます。その中で、さまざまなフラグを制御することもできます。しかし、これによりプログラムは完全に見苦しくなり、相互に依存するフラグの数は指数関数的に増加しており、開発者自身もそのような「パスタコード」をすぐに理解することはほとんどできません。間違いを見つけたりコードを修正したりすることは、新しいプロジェクトを開発するための努力においてしばしば同等になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「パスタコード」の問題を解決し、より読みやすく管理しやすくするにはどうすればよいですか？救助に来る</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オペレーティングシステム</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（OS）。</font><font style="vertical-align: inherit;">その中で、MKが実装する必要のある機能は、OSによって操作が制御されるタスクに分割されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MKのオペレーティングシステムの種類</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MKのオペレーティングシステムは、プリエンプティブOSと協調OSの2つの大きなクラスに分類できます。</font><font style="vertical-align: inherit;">これらのOSのいずれでも、タスクは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ディスパッチャー</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ばれる特別な手順によって制御さ</font><i><font style="vertical-align: inherit;">れ</font></i><font style="vertical-align: inherit;">ます。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">混み</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合った</font><font style="vertical-align: inherit;">OS </font><i><font style="vertical-align: inherit;">では、</font></i><font style="vertical-align: inherit;">ディスパッチャがいつでも独立して実行を1つのタスクから別のタスクに切り替え、特定の数のクロックサイクルを割り当てます（タスクの優先度に応じて異なる場合があります）。</font><font style="vertical-align: inherit;">このようなアプローチは全体としてうまく機能し、タスクの内容をまったく見ないようにすることができます。少なくともタスクコードを記述できます。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-number">1</span>:
<span class="hljs-keyword">goto</span> <span class="hljs-number">1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
-それでも、残りのタスク（このタスクを含む）は実行されます。ただし、プリエンプティブOSには多くのリソース（メモリとプロセッササイクル）が必要です。これは、各スイッチが無効になっているタスクのコンテキストを完全に保存し、更新可能なタスクのコンテキストをロードする必要があるためです。ここでのコンテキストは、マシンレジスタとスタックの内容を参照します（BASCOMは2つのスタックを使用します-サブルーチンの戻りアドレス用のハードウェアと引数を渡すためのソフトウェアです）。この負荷は多くのプロセッササイクルを必要とするだけでなく、各タスクのコンテキストが機能するまでしばらくの間保存する必要があります。最初はマルチタスク指向の「大規模」プロセッサでは、これらの機能はハードウェアでサポートされることが多く、はるかに多くのリソースがあります。 MK AVRにはマルチタスクハードウェアサポートはありません（すべて「手動」で行う必要があります）。使用可能なメモリが少ない。したがって、OSを置き換えることは存在しますが、単純なMKにはあまり適していません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もう一つは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">協調OS</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。ここでは、タスク自体がディスパッチャに制御を移すポイントを制御し、彼が他のタスクを開始できるようにします。さらに、ここでのタスクはこれを行うために必要です-そうしないと、コードの実行が停止します。一方で、このアプローチは全体的な信頼性を低下させるようです。タスクがハングした場合、ディスパッチャを呼び出さず、システム全体が応答を停止します。一方、線形コードまたはスーパーサイクルは、この点では優れていません。まったく同じリスクでハングアップする可能性があるためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、協調OSには重要な利点があります。</font><font style="vertical-align: inherit;">ここでプログラマーが自分で切り替える瞬間を設定するため、たとえば、タスクがリソースを処理しているときや、算術式の計算中に突然発生することはありません。</font><font style="vertical-align: inherit;">したがって、協調型OSでは、ほとんどの場合、コンテキストを維持せずに実行できます。</font><font style="vertical-align: inherit;">これにより、プロセッサ時間とメモリが大幅に節約されるため、MK AVRでの実装にはるかに適しているように見えます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BASCOM AVRでのタスク切り替え</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BASCOM AVR環境でタスク切り替えを実装するには、それぞれが通常の手順として実装されているタスクコードが、どこかでディスパッチャを呼び出す必要があります。これも通常の手順として実装されています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つのタスクがあり、それぞれがそのコードのある場所でディスパッチャーによって呼び出されたとします。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">sub</span> task1()
    <span class="hljs-keyword">do</span>
        <span class="hljs-comment">'  1</span>
        <span class="hljs-comment">' </span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-comment">' ----------------------------------</span>
<span class="hljs-keyword">sub</span> task2()
    <span class="hljs-keyword">do</span>
        <span class="hljs-comment">'  2</span>
        <span class="hljs-comment">' </span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスク1が実行されたとしましょう。「ディスパッチャー呼び出し」を行ったときにスタックで何が起こるか見てみましょう：</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スタックの先頭の</font><font style="vertical-align: inherit;">メインコード（2バイト）に</font><font style="vertical-align: inherit;">アドレスを返す-&gt;ディスパッチャーを呼び出したタスク1にアドレスを返す（2バイト）</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スタックの最上部は、ディスパッチャ呼び出し（この</font><font style="vertical-align: inherit;">例で</font><font style="vertical-align: inherit;">は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ループ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令</font><font style="vertical-align: inherit;">）に</font><font style="vertical-align: inherit;">続くタスク1の命令のアドレスを指します</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も単純な場合のディスパッチャーの目標は、制御をタスク2に移すことです。問題は、これをどのように行うかです。 （ディスパッチャがタスク2のアドレスをすでに知っているとします）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、ディスパッチャーはスタックから（そして覚えておくべき場所から）タスク1への戻りのアドレスをプルし、スタック上のこの場所にタスク2のアドレスを置いてから、returnコマンドを発行する必要があります。プロセッサはスタックからそこに配置されたアドレスを抽出し、タスク1に戻るのではなく、タスク2の実行に進みます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、タスク2がディスパッチャーを呼び出すときに、スタックを引き出して、タスク2に戻ることができるアドレスを保存します。以前に保存したタスク1のアドレスをスタックにロードします。コマンドを実行します</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、問題1の続きの時点で自分自身を見つけます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、次のような混乱が生じ</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク1-&gt;ディスパッチャー-&gt;タスク2-&gt;ディスパッチャー-&gt;タスク1 ....</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
悪くない！</font><font style="vertical-align: inherit;">そしてそれは機能します。</font><font style="vertical-align: inherit;">しかし、もちろん、これは実際に使用可能なOSには十分ではありません。</font><font style="vertical-align: inherit;">結局のところ、常にではなく、すべてのタスクが機能するわけではありません。たとえば、何かが</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">期待</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">できます</font><font style="vertical-align: inherit;">（遅延時間の満了、信号の出現など）。</font><font style="vertical-align: inherit;">したがって、タスクには</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステータス</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（WORKS、READY、EXPECTEDなど）が必要です。</font><font style="vertical-align: inherit;">また、タスクに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">優先度</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を割り当てると便利です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">次に、複数のタスクを実行する準備ができている場合、ディスパッチャは優先度が最も高いタスクを続行します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アクアRTOS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のアイデアを実装するために、タスクに必要なサービスを提供し、BASCOM AVR環境での協調マルチタスクの実装を可能にする協調型OS AQUA RTOSが開発されました。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BASCOM AVRの手順モードに関する重要なお知らせ</font></font></b><div class="spoiler_text"> ,    AUQA RTOS,  ,   BASCOM AVR     .    config submode = new | old. <br>
    old , -,     ,    ,   -  , -,   ,    sub name / end sub    ,    name: / return.                 bylabel.    ,      sub name / end sub (      ). <br>
   ,  submode = old   :      ;  ,   $include,     ,        –        goto  .<br>
 ,  AQUA RTOS             task_name: / return,     sub name / end sub,       config submode = old,     –  goto  /    / :.<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AQUA RTOSタスクのステータス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AQUA RTOSのタスクには、次のステータスが定義されています。</font></font><br>
<br>
<pre><code class="vbscript hljs">OSTS_UNDEFINE <font></font>
OSTS_READY <font></font>
OSTS_RUN <font></font>
OSTS_DELAY<font></font>
OSTS_STOP<font></font>
OSTS_WAIT <font></font>
OSTS_PAUSE <font></font>
OSTS_RESTART </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクがまだ初期化されていない場合は、ステータス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_UNDEFINE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が割り当てられます</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初期化後、タスクのステータスは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_STOPになり</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスク</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を実行する準備ができて</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いる場合は、ステータス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_READY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が割り当てられます</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在実行中のタスクのステータスは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_RUN</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それから、彼女はステータス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_STOP、OSTS_READY、OSTS_DELAY、OSTS_WAIT、OSTS_PAUSEに移動でき</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ステータス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_DELAYに</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遅延を</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">満たすタスクがあります</font><font style="vertical-align: inherit;">。</font><b><font style="vertical-align: inherit;">OSTS_WAIT</font></b></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ステータス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">、セマフォ、イベント、またはメッセージを待っ</font></i><font style="vertical-align: inherit;">ているタスクに割り当てられ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（以下でそれらの詳細）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
違いは何ですか</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_STOP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_PAUSEDステータスは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なんらかの理由でタスクが</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_STOP</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のステータスを受け取った</font><font style="vertical-align: inherit;">場合、その後のタスクの再開（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_READY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のステータスを</font><b><font style="vertical-align: inherit;">受け取ったとき</font></b><font style="vertical-align: inherit;">）は、そのエントリポイントから実行されます。</font><font style="vertical-align: inherit;">最初から。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_PAUSE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のステータスから、</font><font style="vertical-align: inherit;">タスクは中断された場所で引き続き機能します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクステータス管理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OS自体は、OSサービスを呼び出すことにより、ユーザーだけでなくタスクも自動的に管理できます。</font><font style="vertical-align: inherit;">いくつかのタスク管理サービスがあります（すべてのOSサービスの名前は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレフィックスで</font><b><font style="vertical-align: inherit;">始まり</font></b><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<pre><code class="vbscript hljs">OS_InitTask(task_label, task_prio) <font></font>
OS_Stop() <font></font>
OS_StopTask(task_label) <font></font>
OS_Pause()<font></font>
OS_PauseTask(task_label)<font></font>
OS_Resume() <font></font>
OS_ResumeTask(task_label)<font></font>
OS_Restart() </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それぞれに、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_service</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_serviceTaskの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2つのオプションがあります</font><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_InitTask</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービス</font><font style="vertical-align: inherit;">はオプションが1つのみです</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。OS_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービス</font><font style="vertical-align: inherit;">はOS自体を初期化します）。</font><b><font style="vertical-align: inherit;">OS_service</font></b><font style="vertical-align: inherit;">と</font><b><font style="vertical-align: inherit;">OS_serviceTaskの</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
違いは何</font><font style="vertical-align: inherit;">ですか？</font><font style="vertical-align: inherit;">最初の方法は、それを引き起こしたタスク自体に作用します。</font><font style="vertical-align: inherit;">もう1つは、引数として別のタスクへのポインターを設定し、1つのタスクから別のタスクを管理することを可能にします。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_Resumeについて</font></font></b><div class="spoiler_text">   ,  OS_Resume  OS_ResumeTask,      .    ,  OS_Resume*     OSTS_READY.         .<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">優先度とタスクキュー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のように、実際のシステムでは、いくつかのタスクがより重要な場合と、他のタスクが二次的な場合があります。したがって、OSの便利な機能は、タスクに優先順位を割り当てる機能です。この場合、複数の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既製の</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク</font><font style="vertical-align: inherit;">が同時に存在する場合、</font><font style="vertical-align: inherit;">OSは最初に最も優先度の高いタスクを選択します。場合は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべて</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">既製のタスクは同じ優先順位を持っている、OSは「カルーセル」またはラウンドロビンと呼ばれるためには、サークル内の実行にそれらを配置します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AQUA RTOSでは</font><font style="vertical-align: inherit;">、最初の引数としてタスク</font><b><font style="vertical-align: inherit;">の</font></b><font style="vertical-align: inherit;">アドレスを</font><b><font style="vertical-align: inherit;">受け取り</font></b><font style="vertical-align: inherit;">、2番目の引数として1から15までの数値を</font><b><font style="vertical-align: inherit;">受け取るOS_InitTask</font></b><font style="vertical-align: inherit;">サービスを呼び出して</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期化</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する</font><font style="vertical-align: inherit;">ときに、タスクに優先度が割り当てられ</font><font style="vertical-align: inherit;">ます。</font><i><font style="vertical-align: inherit;">数値が小さいほど優先度が高くなります</font></i></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">OSの運用中は、タスクに付与された優先度の変更は行われません。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遅延</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各タスクでは、遅延は他のタスクとは無関係に処理されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、OSが1つのタスクの遅延を解決している間、他のタスクを実行できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
提供されるサービスの遅延の構成について</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_Delay | </font><font style="vertical-align: inherit;">OS_DelayTask</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">引数は、</font><font style="vertical-align: inherit;">タスク</font><font style="vertical-align: inherit;">が</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遅延</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する</font><font style="vertical-align: inherit;">ミリ秒数です</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">引数の次元は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dword</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">であるため、最大遅延は4294967295 ms、つまり約120時間であり、ほとんどのアプリケーションではこれで十分と思われます。</font><font style="vertical-align: inherit;">遅延サービスを呼び出した後、ディスパッチャが自動的に呼び出され、遅延期間中は他のタスクに制御が移ります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セマフォ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AQUA RTOSのセマフォは、タスクで使用できるフラグや変数のようなものです。バイナリとカウント可能の2つのタイプがあります。最初の状態は2つのみです。つまり、フリーとクローズです。 2番目のものはバイトカウンターです（現在のバージョンのAQUA RTOSでセマフォをカウントするサービスは実装されていません（私は怠惰な尻です）。したがって、以下に述べるすべてはバイナリセマフォにのみ適用されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セマフォと単純なフラグの違い</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定されたセマフォの</font><i><font style="vertical-align: inherit;">解放を</font></i><font style="vertical-align: inherit;">タスクに</font><i><font style="vertical-align: inherit;">待機さ</font></i><font style="vertical-align: inherit;">せることができること</font><font style="vertical-align: inherit;">です。いくつかの点で、セマフォの使用は実際に鉄道に似ています。セマフォに到達すると、コンポジション（タスク）がセマフォをチェックし、開いていない場合は、有効化信号がさらに進むのを待機します。このとき、他の列車（タスク）は動き続ける（走る）ことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、すべての黒い作業がディスパッチャに割り当てられます。タスクがセマフォを待つように命令されるとすぐに、制御がディスパッチャに自動的に転送され、指定されたセマフォが解放されるまで、彼は他のタスクを開始できます。セマフォの状態が</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">free</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">変化するとすぐ</font><font style="vertical-align: inherit;">に、ディスパッチャはこのセマフォを待機していたすべてのタスクに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">準備完了</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステータス</font><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_READY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><font style="vertical-align: inherit;">割り当て</font><font style="vertical-align: inherit;">、優先度と優先度の順に実行されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
合計で、AQUA RTOSは16のバイナリセマフォを提供します（この数は、内部ではビットフラグとして実装されているため、タスクコントロールユニットの変数の次元を変更することで原則的に増やすことができます）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バイナリセマフォは、次のサービスを通じて機能します。</font></font><br>
<br>
<pre><code class="vbscript hljs">hBSem OS_CreateBSemaphore() <font></font>
OS_WaitBSemaphore(hBSem)                              <font></font>
OS_WaitBSemaphoreTask(task_label, hBSem)<font></font>
OS_BusyBSemaphore(hBSem)<font></font>
OS_FreeBSemaphore(hBSem)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セマフォを使用する前に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成する</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要があります</font><font style="vertical-align: inherit;">。これは</font><font style="vertical-align: inherit;">、作成された</font><b><font style="vertical-align: inherit;">hBSem</font></b><font style="vertical-align: inherit;">セマフォの一意のバイト識別子（ハンドル）を返す</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_CreateBSemaphore</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスを呼び出す</font><font style="vertical-align: inherit;">か、ユーザー定義のハンドラーからエラー</font><b><font style="vertical-align: inherit;">OSERR_BSEM_MAX_REACHEDが</font></b><font style="vertical-align: inherit;">スローされ</font><font style="vertical-align: inherit;">、バイナリセマフォの可能な最大数に達したことを示します。</font><font style="vertical-align: inherit;">
受け取った識別子は、他のセマフォサービスに引数として渡すことで操作できます。</font><font style="vertical-align: inherit;">
サービス</font><b><font style="vertical-align: inherit;">OS_WaitBSemaphore | OS_WaitBSemaphoreTask</font></b><font style="vertical-align: inherit;">は、（現在の|指定された）タスクを</font><b><font style="vertical-align: inherit;">hBSem </font></b><i><font style="vertical-align: inherit;">セマフォの解放</font></i><font style="vertical-align: inherit;">を</font><i><font style="vertical-align: inherit;">待機</font></i><font style="vertical-align: inherit;">する状態にします</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このセマフォがビジー状態で、ディスパッチャに制御を移して他のタスクを実行できるようにする場合。</font><font style="vertical-align: inherit;">セマフォが空いている場合、コントロール転送は発生せず、タスクは単に続行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_BusyBSemaphore</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_FreeBSemaphoreは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、それぞれ</font><font style="vertical-align: inherit;">セマフォ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hBSemを</font></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジー</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">状態</font><font style="vertical-align: inherit;">または</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フリー</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">状態に</font><font style="vertical-align: inherit;">設定し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OSを簡素化し、コード量を削減するためのセマフォの破棄は提供されていません。</font><font style="vertical-align: inherit;">したがって、作成されたすべてのセマフォは静的です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベント</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セマフォに加えて、タスクはイベント駆動型にすることができます。</font><font style="vertical-align: inherit;">1つのタスクに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のイベント</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><i><font style="vertical-align: inherit;">期待する</font></i><font style="vertical-align: inherit;">ように指示することができ</font><font style="vertical-align: inherit;">、別のタスク（およびバックグラウンドコード）が</font><font style="vertical-align: inherit;">このイベントを</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通知</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する場合があります。</font><font style="vertical-align: inherit;">同時に、このイベントを待機していたすべてのタスクは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、実行準備完了</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステータス</font><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSTS_READY</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）を</font><b><font style="vertical-align: inherit;">受け取り</font></b><font style="vertical-align: inherit;">、ディスパッチャによって優先度と優先度の順に実行のために設定されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクはどのイベントに応答できますか？</font><font style="vertical-align: inherit;">ええと、例えば：</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">割り込み; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラーの発生;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースの解放（これにセマフォを使用する方が便利な場合があります）; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I / Oラインのステータスを変更するか、キーボードのキーを押す。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RS-232経由で文字を受信または送信します。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションのある部分から別の部分への情報転送（メッセージも参照）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベントシステムは、次のサービスを通じて実装されます。</font></font><br>
<br>
<pre><code class="vbscript hljs">hEvent OS_CreateEvent()<font></font>
OS_WaitEvent(hEvent)<font></font>
OS_WaitEventTask(task_label, hEvent)<font></font>
OS_WaitEventTO(hEvent, dwTimeout)<font></font>
OS_SignalEvent(hEvent) </code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベントを使用する前に、イベント</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を作成</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する必要</font><i><font style="vertical-align: inherit;">があります</font></i><font style="vertical-align: inherit;">。これは</font><font style="vertical-align: inherit;">、</font><b><font style="vertical-align: inherit;">hEvent</font></b><font style="vertical-align: inherit;">イベントの一意のバイト識別子（ハンドル）を返す</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_CreateEvent</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を呼び出す</font><font style="vertical-align: inherit;">か</font><font style="vertical-align: inherit;">、OSで生成できるイベントの数が上限に達したことを示す</font><b><font style="vertical-align: inherit;">OSERR_EVENT_MAX_REACHED</font></b><font style="vertical-align: inherit;">エラー</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">スローする</font><font style="vertical-align: inherit;">ことによって行われます（最大255の異なるイベント）。</font><font style="vertical-align: inherit;">
タスクに</font><b><font style="vertical-align: inherit;">hEvent</font></b><font style="vertical-align: inherit;">イベントを待機させるには</font><font style="vertical-align: inherit;">、そのコード</font><font style="vertical-align: inherit;">で</font><b><font style="vertical-align: inherit;">OS_WaitEvent</font></b><font style="vertical-align: inherit;">を呼び出し</font><font style="vertical-align: inherit;">、イベントハンドルを引数として渡します。このサービスを呼び出すと、制御が自動的にディスパッチャーに転送されます。</font><font style="vertical-align: inherit;">
セマフォサービスとは異なり、イベントサービスには、イベントを待機するオプションがあります。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイムアウト</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これを行うには、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_WaitEventTO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスを使用します</font><font style="vertical-align: inherit;">。ここの2番目の引数では、タスクがイベントを予期できるミリ秒数を指定できます。指定された時間が経過すると、タスクは</font><font style="vertical-align: inherit;">イベントが発生したかのよう</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に実行準備完了</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステータスを受け取り</font><font style="vertical-align: inherit;">、ディスパッチャによって優先度と優先度の順に実行を継続するように設定されます。タスクは、それがイベントではなく、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_TIMEOUT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グローバルフラグをチェックすることでチェックできるタイムアウトであることを知ることができます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">タスクまたはバックグラウンドコードは</font><font style="vertical-align: inherit;">、引数としてイベントハンドルを</font><b><font style="vertical-align: inherit;">受け取るOS_SignalEvent</font></b><font style="vertical-align: inherit;">サービスを呼び出すことにより、特定のイベントの発生を</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通知</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でき</font><font style="vertical-align: inherit;">ます。この場合、このイベントを待機しているすべてのタスク、OSがステータスを設定します</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行の準備ができている</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため、優先度と優先度の順に実行を継続できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージシステムは、一般的にイベントシステムと同様に機能しますが、より多くのオプションと柔軟性を備えたタスクを提供します。指定されたトピックのメッセージを待つだけでなく、メッセージ自体をあるタスクから別のタスクに転送する方法（数値または文字列）を提供します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、次のサービスを通じて実装されます。</font></font><br>
<br>
<pre><code class="vbscript hljs">hTopic OS_CreateMessage()<font></font>
OS_WaitMessage(hTopic)<font></font>
OS_WaitMessageTask(task_label, hTopic)<font></font>
OS_WaitMessageTO(hTopic, dwTimeout) <font></font>
OS_SendMessage(hTopic, wMessage)<font></font>
word_ptr OS_GetMessage(hTopic) <font></font>
word_ptr OS_PeekMessage(hTopic) <font></font>
<span class="hljs-built_in">string</span> OS_GetMessageString(hTopic) 
<span class="hljs-built_in">string</span> OS_PeekMessageString(hTopic)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージングサービスを使用するには、まず</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージの件名を</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成</font><i><font style="vertical-align: inherit;">する</font></i><font style="vertical-align: inherit;">必要があり</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">。これは</font><font style="vertical-align: inherit;">、</font><b><font style="vertical-align: inherit;">hTopic</font></b><font style="vertical-align: inherit;">トピックのバイトハンドルを返す</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_CreateMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービス</font><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">またはユーザー定義ハンドラーを介して実行され、エラー</font><b><font style="vertical-align: inherit;">OSERR_TOPIC_MAX_REACHEDが</font></b><font style="vertical-align: inherit;">スローされ</font><font style="vertical-align: inherit;">、メッセージトピックの最大数に達したため、作成できなくなったことを示します。</font><b><font style="vertical-align: inherit;">hTopic</font></b><font style="vertical-align: inherit;"> 
トピック</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">メッセージを待機するようにタスクに通知する</font><font style="vertical-align: inherit;">には、コードで</font><b><font style="vertical-align: inherit;">OS_WaitMessage</font></b><font style="vertical-align: inherit;">を呼び出し</font><font style="vertical-align: inherit;">、トピックのハンドルを引数として渡します。このサービスを呼び出すと、制御が自動的にタスクマネージャに渡されます。したがって、このサービスは現在のタスクを次の状態にします</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hTopicで</font></font></b></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">メッセージを</font></i><i><b><font style="vertical-align: inherit;">待ち</font></b></i><font style="vertical-align: inherit;">ます。</font><b><font style="vertical-align: inherit;">OS_WaitMessageTO</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
タイムアウトの待機サービス</font><font style="vertical-align: inherit;">は、</font><b><font style="vertical-align: inherit;">イベント</font></b><font style="vertical-align: inherit;">システムの</font><b><font style="vertical-align: inherit;">OS_WaitEventTO</font></b><font style="vertical-align: inherit;">サービスと同様に</font><font style="vertical-align: inherit;">機能します。</font><font style="vertical-align: inherit;">
メッセージを送信するために、</font><b><font style="vertical-align: inherit;">OS_SendMessage</font></b><font style="vertical-align: inherit;">サービスが</font><b><font style="vertical-align: inherit;">提供され</font></b><font style="vertical-align: inherit;">ます。最初の引数はメッセージが送信されるトピックへのハンドルで、2番目の引数は</font><b><font style="vertical-align: inherit;">word</font></b><font style="vertical-align: inherit;"> dimension argument </font><font style="vertical-align: inherit;">です。これは、独立した番号または</font><i><font style="vertical-align: inherit;">文字列へのポインタの</font></i><font style="vertical-align: inherit;">いずれか</font><font style="vertical-align: inherit;">であり、すでにメッセージです。</font><font style="vertical-align: inherit;">
行ポインタを取得するに</font><font style="vertical-align: inherit;">は、たとえば次のように、</font><b><font style="vertical-align: inherit;">BASCOM</font></b><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">組み込まれたvarptr関数を使用します</font><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="vbscript hljs">strMessage = <span class="hljs-string">"Hello, world!"</span>
OS_SendMessage hTopic, varptr (strMessage)</code></pre><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_WaitMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を呼び出した後に作業を再開し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。つまり、予期されるメッセージが受信された場合、タスクはその後の自動破棄でメッセージを受信するか、メッセージを表示するだけです。この場合、メッセージは破棄されません。これを行うには、リストの最後の4つのサービスを使用します。最初の2つ</font><font style="vertical-align: inherit;">は、独立したメッセージであるか、メッセージを含む文字列へのポインタとして機能</font><font style="vertical-align: inherit;">する、いくつかの次元</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wordを</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返し</font><font style="vertical-align: inherit;">ます。この場合、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_GetMessageは、</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動的にメッセージを削除し、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_PeekMessageは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それを残します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクがポインタではなく文字列をすぐに必要とする場合は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_GetMessageString</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font><b><font style="vertical-align: inherit;">OS_PeekMessageString</font></b><font style="vertical-align: inherit;">サービスを使用できます。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、前の2つと同様に機能しますが、文字列へのポインタではなく文字列を返します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部タイマーサービス</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
遅延とタイミングを処理するために、AQUA RTOSは組み込みのICハードウェアタイマー</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIMER0を使用します</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">したがって、外部コード（バックグラウンドとタスク）ではこのタイマーを使用しないでください。</font><font style="vertical-align: inherit;">しかし、通常、これは必要ありません。</font><font style="vertical-align: inherit;">OSは、時間間隔を操作するために必要なすべてのツールを備えたタスクを提供します。</font><font style="vertical-align: inherit;">タイマーの分解能は1 msです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AQUA RTOSの使用例</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期設定</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーコードの最初に、コードを組み込みシミュレータで実行するか、実際のハードウェアで実行するかを決定する必要があります。</font><font style="vertical-align: inherit;">定数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SIM = TRUE |を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定義します</font><b><font style="vertical-align: inherit;">。</font></b><font style="vertical-align: inherit;">シミュレーションモードを設定する</font><b><font style="vertical-align: inherit;">FALSE</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、OSコードで、OSが</font><font style="vertical-align: inherit;">サポートするタスクの最大数を決定する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_MAX_TASK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定数を編集</font><font style="vertical-align: inherit;">します。</font><font style="vertical-align: inherit;">この数値が小さいほど、OSの動作が速く（オーバーヘッドが少なく）、消費するメモリも少なくなります。</font><font style="vertical-align: inherit;">したがって、必要以上のタスクがあることを示すべきではありません。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクの数が変更された場合は、この定数を変更することを忘れないでください。</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSの初期化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開始する前に、AQUA RTOSを初期化する必要があります。これを行うには、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスを呼び出します</font><font style="vertical-align: inherit;">。このサービスは、OSの初期設定を構成します。さらに重要なのは、引数（ユーザー定義のエラー処理ルーチンのアドレス）があることです。彼女はまた、エラーコードという引数を持っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このハンドラーはユーザーコード内にある必要があります（少なくともスタブの形式です）。OSはエラーコードを送信します。ユーザーは、エラーコードをキャッチしてそれに応じて処理する方法が他にありません。少なくとも開発段階では、スタブを置かずに、この手順で出力されるある種のエラー情報を含めることを強くお勧めします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、AQUA RTOSを使用する最初のステップは、OS初期化コードとエラーハンドラープロシージャをユーザープログラムに追加することです。</font></font><br>
<br>
<pre><code class="vbscript hljs">OS_Init my_err_trap <font></font>
<font></font>
    <span class="hljs-comment">'...</span>
    <span class="hljs-comment">'...</span>
    <span class="hljs-comment">'...</span><font></font>
<font></font>
<span class="hljs-keyword">sub</span> my_err_trap(err_code as byte)<font></font>
    print err_code <font></font>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクの初期化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のステップは、名前と優先度を指定してタスクを初期化することです。</font></font><br>
<br>
<pre><code class="vbscript hljs">OS_InitTask task_1, <span class="hljs-number">1</span>
OS_InitTask task_2 , <span class="hljs-number">1</span>
<span class="hljs-comment">'...</span>
OS_InitTask task_N , <span class="hljs-number">1</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストタスク</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LEDで点滅</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでは、標準のArduino Nano V3ボードにダウンロードできるテストアプリケーションを作成しましょう。</font><font style="vertical-align: inherit;">OSファイルを含むフォルダー（testなど）にフォルダーを作成し、そこに次のbas-fileを作成します。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-comment">'   </span><font></font>
config submode = old <font></font>
$include <span class="hljs-string">"..\aquaRTOS_1.05.bas"</span><font></font>
<font></font>
$regfile = <span class="hljs-string">"m328pdef.dat"</span>
$crystal = <span class="hljs-number">16000000</span>
$hwstack = <span class="hljs-number">48</span>
$swstack = <span class="hljs-number">48</span>
$framesize = <span class="hljs-number">64</span><font></font>
<font></font>
<span class="hljs-comment">'  </span>
declare <span class="hljs-keyword">sub</span> my_err_trap (<span class="hljs-keyword">byval</span> err_code as byte)<font></font>
declare <span class="hljs-keyword">sub</span> task_1()<font></font>
declare <span class="hljs-keyword">sub</span> task_2()<font></font>
<font></font>
<span class="hljs-comment">'      </span>
led_1 alias portd<span class="hljs-number">.4</span>
led_2 alias portd<span class="hljs-number">.5</span>
config portd<span class="hljs-number">.4</span> = output<font></font>
config portd<span class="hljs-number">.5</span> = output<font></font>
<font></font>
<span class="hljs-comment">' ***    ***</span>
<span class="hljs-comment">'  </span><font></font>
OS_Init my_err_trap <font></font>
<font></font>
<span class="hljs-comment">'  </span>
OS_InitTask task_1, <span class="hljs-number">1</span>
OS_InitTask task_2 , <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-comment">'      «» (OSTS_STOP)</span>
<span class="hljs-comment">'    ,     </span>
<span class="hljs-comment">' «  » (OSTS_READY)   OS_ResumeTask</span><font></font>
OS_ResumeTask task_1<font></font>
OS_ResumeTask task_2<font></font>
<font></font>
<span class="hljs-comment">'     </span><font></font>
OS_Sheduler<font></font>
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-comment">' ***  ***</span>
<span class="hljs-keyword">sub</span> task_1 ()
    <span class="hljs-keyword">do</span>
        toogle led_1 <span class="hljs-comment">'   1</span>
        OS_delay <span class="hljs-number">1000</span> <span class="hljs-comment">'   1000 </span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-keyword">sub</span> task_2 ()
    <span class="hljs-keyword">do</span>
        toogle led_2 <span class="hljs-comment">'   2</span>
        OS_delay <span class="hljs-number">333</span> <span class="hljs-comment">'   333 </span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-comment">' ****************************************************</span>
<span class="hljs-comment">'  </span>
<span class="hljs-keyword">sub</span> my_err_trap(err_code as byte)<font></font>
    print <span class="hljs-string">"OS Error: "</span>; err_code 
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LEDのアノードを</font><font style="vertical-align: inherit;">Arduinoボード</font><font style="vertical-align: inherit;">の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ピン</font><font style="vertical-align: inherit;">（またはコード内の対応する定義行を変更して他のピン）に接続します。カソードを100〜500オームの終端抵抗を介して</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バスに</font><b><font style="vertical-align: inherit;">接続し</font></b><font style="vertical-align: inherit;">ます。ファームウェアをコンパイルしてボードにアップロードします。 LEDは、2秒と0.66秒の周期で非同期に切り替わります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを見てみましょう。したがって、最初に機器を初期化し（コンパイラオプション、ポート操作モードを設定し、エイリアスを割り当てます）、次にOS自体、最後にタスクを初期化します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作成されたばかりのタスクは「停止」状態であるため、ステータスを「実行準備完了」にする必要があります（実際のアプリケーションのすべてのタスクではない可能性があります。結局のところ、開発者が考えたように、一部は最初は停止状態で実行できます。他のタスクからのみ実行され、システムの開始直後には実行されません。ただし、この例では、両方のタスクがすぐに開始されます）。したがって、タスクごとに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_ResumeTask</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスを呼び出します</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、タスクを実行する準備ができましたが、まだ完了していません。誰がそれらを起動しますか？もちろん、ディスパッチャー！これを行うには、システムが初めて起動したときにそれを呼び出す必要があります。すべてが正しく記述されている場合、ディスパッチャーはタスクを1つずつ実行し、プログラムの主要部分を</font><b><font style="vertical-align: inherit;">end</font></b><font style="vertical-align: inherit;">ステートメントで</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">終了できます。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクを見てみましょう。それらのそれぞれが無限の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do-loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">として組み立てられていることはすぐにわかり</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。 2番目の重要なプロパティ-このようなサイクル内では、ディスパッチャーまたは自動的にディスパッチャーを呼び出すOSサービスへの少なくとも1つの呼び出しが必要です-そうでない場合、そのようなタスクは制御を放棄することはなく、他のタスクは実行できません。私たちの場合、これは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_Delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遅延</font><b><font style="vertical-align: inherit;">サービス</font></b><font style="vertical-align: inherit;">です。引数として、各タスクを一時停止するミリ秒数を彼に示しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードの先頭で定数</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SIM = TRUE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を設定し、コード</font><font style="vertical-align: inherit;">を実際のチップではなくシミュレーターで実行すると、OSの動作を追跡できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
呼び出したディスパッチャは、ステータスが「実行準備完了」であるかどうかを確認し、優先順位に従って並べます。優先度が同じ場合、ディスパッチャは「カルーセル上でタスクをロール」し、新しく完了したタスクをキューの最後に移動します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実行すべきタスク（例えば、選択した</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、ディスパッチャは、リターンアドレス（最初、彼がポイント置き換え</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">終了</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令</font><font style="vertical-align: inherit;">のアドレスをメインコードで）</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク・エントリ・ポイント</font><font style="vertical-align: inherit;">システムは、タスクの初期化中に認識し、実行し、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リターン</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドを</font><font style="vertical-align: inherit;">、力をスタックから戻りアドレスをプルしてそこに移動する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MK-つまり</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font><b><font style="vertical-align: inherit;">task_1</font></b><font style="vertical-align: inherit;">タスクの実行を開始します</font><font style="vertical-align: inherit;">（オペレーター</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行う</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コード</font><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスク</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1は</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そのLEDを切り替えて、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスを呼び出します</font><b><font style="vertical-align: inherit;">。OS_delay</font></b><font style="vertical-align: inherit;">サービス</font><font style="vertical-align: inherit;">は、必要なアクションを完了した後、ディスパッチャーに行きます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ディスパッチャはスタックにあったアドレスを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクコントロール</font><b><font style="vertical-align: inherit;">ユニットに保存し</font></b><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼び出し</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">続く命令</font><font style="vertical-align: inherit;">、つまり</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ループ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令を指す</font><font style="vertical-align: inherit;">）、次に「カルーセルを回す」ことで</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が完了して</font><font style="vertical-align: inherit;">いる</font><font style="vertical-align: inherit;">必要があることを検出し</font><font style="vertical-align: inherit;">ます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク</font><b><font style="vertical-align: inherit;">アドレスを</font></b><font style="vertical-align: inherit;">プッシュし</font><font style="vertical-align: inherit;">（現在</font><font style="vertical-align: inherit;">は</font><b><font style="vertical-align: inherit;">task_2</font></b><font style="vertical-align: inherit;">タスク</font><b><font style="vertical-align: inherit;">コードの</font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステートメント</font><font style="vertical-align: inherit;">を</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">）、</font><b><font style="vertical-align: inherit;">return</font></b><font style="vertical-align: inherit;">コマンドを実行し</font><b><font style="vertical-align: inherit;">ます</font></b></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これにより、MKはスタックから戻りアドレスをプルしてそこに</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">移動し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><b><font style="vertical-align: inherit;">つまり</font></b><font style="vertical-align: inherit;">、</font><b><font style="vertical-align: inherit;">task_2</font></b><font style="vertical-align: inherit;">の実行を開始し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスク</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_2は</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そのLEDを切り替え、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスを呼び出します</font><b><font style="vertical-align: inherit;">。OS_delay</font></b><font style="vertical-align: inherit;">サービス</font><font style="vertical-align: inherit;">は、必要なアクションを完了した後、ディスパッチャーに行きます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ディスパッチャはスタックにあったアドレスを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクコントロール</font><b><font style="vertical-align: inherit;">ユニットに保存し</font></b><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼び出し</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">続く命令</font><font style="vertical-align: inherit;">、つまり</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ループ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令を</font><b><font style="vertical-align: inherit;">指し</font></b><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">）、「カルーセルを回す」ことで、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_2を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完了する必要があることを検出し</font><font style="vertical-align: inherit;">ます。初期状態との違いは、タスク制御ブロック</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1にあることです。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクの開始アドレスは格納されませんが、ディスパッチャーへの遷移が発生したポイントのアドレスが格納されます。</font><font style="vertical-align: inherit;">そこで（</font><b><font style="vertical-align: inherit;">task_1</font></b><font style="vertical-align: inherit;">タスク</font><b><font style="vertical-align: inherit;">コード</font></b><font style="vertical-align: inherit;">の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ループ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">）、制御が移ります。</font><font style="vertical-align: inherit;">
タスク</font><b><font style="vertical-align: inherit;">task_1</font></b><font style="vertical-align: inherit;">は</font><b><font style="vertical-align: inherit;">ループ</font></b><font style="vertical-align: inherit;">ステートメントを実行し、</font><font style="vertical-align: inherit;">その後、「タスク1-ディスパッチャ-タスク2-ディスパッチャ」のサイクル全体が際限なく繰り返されます。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージを送る</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、あるタスクから別のタスクにメッセージを送信してみましょう。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-comment">'   </span><font></font>
config submode = old <font></font>
$include <span class="hljs-string">"..\aquaRTOS_1.05.bas"</span><font></font>
<font></font>
$regfile = <span class="hljs-string">"m328pdef.dat"</span>
$crystal = <span class="hljs-number">16000000</span>
$hwstack = <span class="hljs-number">48</span>
$swstack = <span class="hljs-number">48</span>
$framesize = <span class="hljs-number">64</span><font></font>
<font></font>
<span class="hljs-comment">'  </span>
declare <span class="hljs-keyword">sub</span> my_err_trap (<span class="hljs-keyword">byval</span> err_code as byte)<font></font>
declare <span class="hljs-keyword">sub</span> task_1()<font></font>
declare <span class="hljs-keyword">sub</span> task_2()<font></font>
<font></font>
<span class="hljs-keyword">const</span> OS_SIM = TURE <span class="hljs-comment">'      </span><font></font>
<font></font>
<span class="hljs-comment">'  </span>
<span class="hljs-keyword">dim</span> hTopic as byte <span class="hljs-comment">'    </span>
<span class="hljs-keyword">dim</span> task_1_cnt as byte <span class="hljs-comment">'    1</span>
<span class="hljs-keyword">dim</span> strMessage as <span class="hljs-built_in">string</span> * <span class="hljs-number">16</span> <span class="hljs-comment">' </span><font></font>
<font></font>
<span class="hljs-comment">' ***    ***</span><font></font>
OS_CreateMessage hTopic<font></font>
<font></font>
OS_Init my_err_trap<font></font>
<font></font>
OS_InitTask task_1 , <span class="hljs-number">1</span>
OS_InitTask task_2 , <span class="hljs-number">1</span><font></font>
<font></font>
OS_ResumeTask task_1<font></font>
OS_ResumeTask task_2<font></font>
<font></font>
OS_Sheduler<font></font>
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-comment">' ***  ***</span><font></font>
<font></font>
<span class="hljs-keyword">sub</span> task_1()
    <span class="hljs-keyword">do</span>
        print <span class="hljs-string">"task 1"</span><font></font>
        OS_Sheduler<font></font>
        incr task_1_cnt <span class="hljs-comment">'    1</span>
        <span class="hljs-keyword">if</span> task_1_cnt &gt; <span class="hljs-number">3</span> <span class="hljs-keyword">then</span>
            print <span class="hljs-string">"task 1 is sending message to task 2"</span>
            strMessage = <span class="hljs-string">"Hello, task 2!"</span>
            <span class="hljs-comment">'    2</span><font></font>
            OS_SendMessage hTopic , varptr(strMessage)         <font></font>
            task_1_cnt = <span class="hljs-number">0</span>
        <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-keyword">sub</span> task_2()
    <span class="hljs-keyword">do</span>
        print <span class="hljs-string">"task 2 is waiting messages..."</span>
        <span class="hljs-comment">'      1</span><font></font>
        OS_WaitMessage hTopic<font></font>
        print <span class="hljs-string">"message recieved: "</span> ; OS_GetMessageString (hTopic)
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-comment">' ****************************************************</span>
<span class="hljs-comment">'  </span>
<span class="hljs-keyword">sub</span> my_err_trap(err_code as byte)<font></font>
    print <span class="hljs-string">"OS Error: "</span>; err_code 
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シミュレータでプログラムを実行すると、ターミナルウィンドウに次のような出力が表示されます。</font></font><br>
<br>
<blockquote>task 1<br>
task 2 is waiting messages…<br>
task 1<br>
task 1<br>
task 1<br>
task 1 is sending message to task 2<br>
task 1<br>
message recieved: Hello, task 2!<br>
task 2 is waiting messages…<br>
task 1<br>
task 1<br>
…<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業とタスクの切り替えが発生する順序に注意してください。タスク1がタスク1を印刷</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すると</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すぐに</font><font style="vertical-align: inherit;">、制御がディスパッチャに転送され、ディスパッチャが2番目のタスクを開始できるようになります。タスク2は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク2がメッセージを待機しています...を出力し</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、次に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hTopic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トピックのメッセージ待機サービスを呼び出し</font><b><font style="vertical-align: inherit;">ます。</font></b><font style="vertical-align: inherit;">制御が自動的にディスパッチャに転送され、ディスパッチャが再び</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1を呼び出します。</font><b><font style="vertical-align: inherit;">タスク1を</font></b><font style="vertical-align: inherit;">再び出力</font><font style="vertical-align: inherit;">し、ディスパッチャに制御を渡します。ただし、ディスパッチャはタスク2がメッセージを待機していることを検出したため</font><font style="vertical-align: inherit;">、ディスパッチャ呼び出しに続く</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステートメントでタスク1に制御を返します</font><font style="vertical-align: inherit;">。</font><b><font style="vertical-align: inherit;">task_1_cnt</font></b></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
 カウンターが</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク1では、指定された値を超えます。タスクはメッセージを送信しますが、実行を継続し</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。ループ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステートメント</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">実行し、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク1を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再度出力し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その後、彼女はディスパッチャを呼び出します。ディスパッチャは、タスク2のメッセージがあることを発見し、制御を彼女に渡します。</font><font style="vertical-align: inherit;">次に、プロセスは周期的に実行されます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベント処理</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコードは、2つのボタンをポーリングし、対応するボタンを押すとLEDを切り替えます。 </font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-comment">'   </span><font></font>
config submode = old<font></font>
$include <span class="hljs-string">"..\aquaRTOS_1.05.bas"</span><font></font>
<font></font>
$regfile = <span class="hljs-string">"m328pdef.dat"</span>
$crystal = <span class="hljs-number">16000000</span>
$hwstack = <span class="hljs-number">48</span>
$swstack = <span class="hljs-number">48</span>
$framesize = <span class="hljs-number">64</span><font></font>
<font></font>
<span class="hljs-comment">'  </span>
declare <span class="hljs-keyword">sub</span> my_err_trap (<span class="hljs-keyword">byval</span> err_code as byte)<font></font>
declare <span class="hljs-keyword">sub</span> task_scankeys()<font></font>
declare <span class="hljs-keyword">sub</span> task_led_1()<font></font>
declare <span class="hljs-keyword">sub</span> task_led_2()<font></font>
<font></font>
<span class="hljs-comment">'       </span>
led_1 alias portd<span class="hljs-number">.4</span>
led_2 alias portd<span class="hljs-number">.5</span>
config portd<span class="hljs-number">.4</span> = output<font></font>
config portd<span class="hljs-number">.5</span> = output<font></font>
button_1 alias pind<span class="hljs-number">.6</span>
button_2 alias pind<span class="hljs-number">.7</span>
config portd<span class="hljs-number">.6</span> = input<font></font>
config portd<span class="hljs-number">.7</span> = input<font></font>
<font></font>
<span class="hljs-comment">'  </span>
<span class="hljs-keyword">dim</span> eventButton_1 as byte
<span class="hljs-keyword">dim</span> eventButton_2 as byte<font></font>
<font></font>
<span class="hljs-comment">' ***    ***</span>
eventButton_1 = OS_CreateEvent  <span class="hljs-comment">'      </span><font></font>
eventButton_2 = OS_CreateEvent<font></font>
<font></font>
OS_Init my_err_trap<font></font>
<font></font>
OS_InitTask task_scankeys , <span class="hljs-number">1</span>
OS_InitTask task_led_1 , <span class="hljs-number">1</span>
OS_InitTask task_led_2 , <span class="hljs-number">1</span><font></font>
<font></font>
OS_ResumeTask task_scankeys<font></font>
OS_ResumeTask task_led_1<font></font>
OS_ResumeTask task_led_2<font></font>
<font></font>
OS_Sheduler<font></font>
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-comment">' ***  ***</span><font></font>
<font></font>
<span class="hljs-keyword">sub</span> task_scankeys()
   <span class="hljs-keyword">do</span>
      debounce button_1 , <span class="hljs-number">0</span> , btn_1_click , <span class="hljs-keyword">sub</span>
      debounce button_2 , <span class="hljs-number">0</span> , btn_2_click , <span class="hljs-keyword">sub</span><font></font>
      OS_Sheduler<font></font>
   <span class="hljs-keyword">loop</span><font></font>
<font></font>
btn_1_click:<font></font>
    OS_SignalEvent eventButton_1<font></font>
return<font></font>
<font></font>
btn_2_click:<font></font>
    OS_SignalEvent eventButton_2<font></font>
    return<font></font>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-keyword">sub</span> task_led_1()
    <span class="hljs-keyword">do</span><font></font>
        OS_WaitEvent eventButton_1<font></font>
        toggle led_1<font></font>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-keyword">sub</span> task_led_2()
    <span class="hljs-keyword">do</span><font></font>
        OS_WaitEvent eventButton_2<font></font>
        toggle led_2<font></font>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-comment">' ****************************************************</span>
<span class="hljs-comment">'  </span>
<span class="hljs-keyword">sub</span> my_err_trap(err_code as byte)<font></font>
    print <span class="hljs-string">"OS Error: "</span>; err_code
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AQUA RTOSでの実際のアプリケーション例</font></font></h2><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コーヒーの自動販売機プログラムがどのように見えるか想像してみましょう。</font><font style="vertical-align: inherit;">マシンは、コーヒーオプションの存在とボタンのLEDの選択を示す必要があります。</font><font style="vertical-align: inherit;">コインレシーバーから信号を受信し、注文した飲み物を準備し、変更を発行します。</font><font style="vertical-align: inherit;">さらに、機械は内部装置を制御する必要があります。たとえば、給湯器の温度を95〜97°Cのレベルに維持します。</font><font style="vertical-align: inherit;">機器の誤動作や材料の在庫に関するデータを送信し、リモートアクセス（GSMモデムなど）を介してコマンドを受信するだけでなく、信号破壊行為も行います。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベント駆動型アプローチ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、開発者が通常の「スーパーサイクル+フラグ+割り込み」スキームから、タスクとイベントに基づくアプローチに切り替えるのが難しい場合があります。</font><font style="vertical-align: inherit;">これには、デバイスが実行する必要がある基本的なタスクを強調表示する必要があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのマシンのそのようなタスクを概説してみましょう：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヒーターの制御と管理</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ControlHeater（）</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可用性と飲み物の選択の表示</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ShowGoods（）</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コイン/紙幣の受け入れとそれらの合計</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-AcceptMoney（）</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポーリングボタン</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ScanKeys（）</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配送の変更</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-MakeChange（）</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドリンク休暇</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ReleaseCoffee（）</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">破壊行為保護- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アラーム（）</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクの重要度と呼び出し頻度を推定してみましょう。</font><font style="vertical-align: inherit;">コーヒーを作るには常に沸騰したお湯が必要なので、</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ControlHeater（）は</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明らかに重要です。しかし、ヒーターは慣性が高く、水はゆっくりと冷却されるため、あまり頻繁に実行しないでください。 1分に1回温度をチェックするだけで十分です。このタスクに優先度5を与えましょう</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ShowGoods（）は</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それほど重要で</font><b><font style="vertical-align: inherit;">はあり</font></b><font style="vertical-align: inherit;">ません。食材の供給がなくなった場合、商品のリリース後にのみオファーが変更される可能性があります。したがって、このタスクに優先度8を割り当て、マシンの起動時および商品がリリースされるたびに実行されるようにします。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スキャンキー（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マシンがボタンを押したときにすばやく応答できるように、優先度を高くする必要があります。このタスクの優先度を3にしましょう。40ミリ秒ごとに実行します。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AcceptMoney（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もユーザーインターフェイスの一部です。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScanKeys（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と同じ優先度を与え、</font><font style="vertical-align: inherit;">20ミリ秒ごとに実行します。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MakeChange（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、商品のリリース後にのみ実行されます。それを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee（）に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関連付けて</font><font style="vertical-align: inherit;">優先度10を</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">割り当て</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font><b><font style="vertical-align: inherit;">。ReleaseCoffee（）は</font></b><font style="vertical-align: inherit;">、適切な金額が受け入れられ、ドリンク選択ボタンが押された場合にのみ必要です。迅速な応答のために、優先順位を2にします。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
破壊抵抗はマシンのかなり重要な機能であるため、</font><b><font style="vertical-align: inherit;">Alarm（）</font></b><font style="vertical-align: inherit;">タスク</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最高の優先順位を1に設定し、1秒に1回アクティブにして、傾斜センサーまたは改ざんセンサーを確認できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、優先度の異なる7つのタスクが必要になります。</font><font style="vertical-align: inherit;">起動後、プログラムがEEPROMから設定を読み込んで機器を初期化したら、OSを初期化してタスクを起動します。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-comment">'   </span>
declare <span class="hljs-keyword">sub</span> ControlHeater()<font></font>
declare <span class="hljs-keyword">sub</span> ShowGoods() <font></font>
declare <span class="hljs-keyword">sub</span> AcceptMoney()<font></font>
declare <span class="hljs-keyword">sub</span> ScanKeys()<font></font>
declare <span class="hljs-keyword">sub</span> MakeChange ()<font></font>
declare <span class="hljs-keyword">sub</span> ReleaseCoffee()<font></font>
declare <span class="hljs-keyword">sub</span> Alarm()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RTOSの一部として機能するには、各タスクに特定の構造が必要です。ディスパッチャ（またはディスパッチャに制御を自動的に転送するOSサービス）への呼び出しが少なくとも1つ必要です。これが、協調マルチタスクを保証する唯一の方法です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は次のようになります。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">sub</span> ReleaseCoffee()
    <span class="hljs-keyword">do</span><font></font>
        OS_WaitMessage bCoffeeSelection<font></font>
        wItem = OS_GetMessage(bCoffeeSelection)<font></font>
        Release wItem <font></font>
    <span class="hljs-keyword">loop</span> 
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span> </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">無限ループ</font><font style="vertical-align: inherit;">
の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスク</font><font style="vertical-align: inherit;">は、トピック</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bCoffeeSelection</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に関するメッセージを予期し、</font><font style="vertical-align: inherit;">それが到着するまで何もしません（コントロールは自動的にディスパッチャに返されるため、他のタスクを開始できます）。メッセージが送信される</font><font style="vertical-align: inherit;">とすぐに</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が実行可能になり、これが発生すると、タスクは</font><b><font style="vertical-align: inherit;">OS_GetMessage</font></b><font style="vertical-align: inherit;">サービスを使用し</font><font style="vertical-align: inherit;">てメッセージの内容（選択されたドリンクのコード）</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wItem</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">受け取り</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、商品を顧客にリリースします。以来</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffeeは（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージサブシステムを使用して、メッセージがマルチタスクの開始前に作成する必要があります。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">dim</span> bCoffeeSelection as byte<font></font>
bCoffeeSelection = OS_CreateMessage()</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のように、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShowGoods（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は起動時と商品がリリースされるたびに実行する必要があります。</font><font style="vertical-align: inherit;">これをリリースプロシージャ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">関連付けるに</font><font style="vertical-align: inherit;">は、イベントサービスを使用します。</font><font style="vertical-align: inherit;">これを行うには、マルチタスクを開始する前にイベントを作成します。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">dim</span> bGoodsReliased as byte<font></font>
bGoodsReliased = OS_CreateEvent()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロシージャで、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Release wItemの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">後に</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bGoodsReliased</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベントに関するアラームを追加します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="vbscript hljs">OS_SignalEvent bGoodsReliased</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSの初期化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業用にOSを準備するには、OSを初期化して、ユーザーコードにあるエラーハンドラーのアドレスを示す必要があります。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスを使用してこれを</font><b><font style="vertical-align: inherit;">行い</font></b><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="vbscript hljs">OS_Init Mailfuncion</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーコードでは、ハンドラー（バイト引数がエラーコードであるプロシージャ）を追加する必要があります。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">sub</span> Mailfuncion (bCoffeeErr)<font></font>
    print <span class="hljs-string">"Mailfunction! Error #: "</span>; bCoffeeErr
    <span class="hljs-keyword">if</span> isErrCritical (bCoffeeErr) = <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <font></font>
        CallService(bCoffeeErr)<font></font>
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この手順では、エラーコードを出力します（または、他の方法で画面に表示したり、GSMモデム経由で表示したりできます）。エラーが重大な場合は、サービス部門に連絡します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タスクの起動 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
イベント、セマフォなどはすでに覚えています。</font><font style="vertical-align: inherit;">使用する前に初期化する必要があります。</font><font style="vertical-align: inherit;">さらに、開始</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する前</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に、タスク自体を</font><b><font style="vertical-align: inherit;">OS_InitTask</font></b><font style="vertical-align: inherit;">サービスで初期化する必要があります</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="vbscript hljs">OS_InitTask ControlHeater , <span class="hljs-number">5</span>
OS_InitTask ShowGoods , <span class="hljs-number">8</span> 
OS_InitTask AcceptMoney , <span class="hljs-number">3</span>
OS_InitTask ScanKeys , <span class="hljs-number">3</span>
OS_InitTask MakeChange, <span class="hljs-number">10</span>
OS_InitTask ReleaseCoffee , <span class="hljs-number">2</span>
OS_InitTask Alarm , <span class="hljs-number">1</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マルチタスクモードはまだ開始されていないため、タスクの開始順序は重要ではなく、いずれの場合も優先順位に依存しません。</font><font style="vertical-align: inherit;">この時点で、すべてのタスクはまだ停止状態です。</font><font style="vertical-align: inherit;">実行のために準備するには、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_ResumeTask</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービス</font><b><font style="vertical-align: inherit;">を</font></b><font style="vertical-align: inherit;">使用し</font><font style="vertical-align: inherit;">て、ステータスを「実行準備完了」</font><b><font style="vertical-align: inherit;">に</font></b><font style="vertical-align: inherit;">設定する</font><font style="vertical-align: inherit;">必要があります</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="vbscript hljs">OS_ResumeTask ControlHeater <font></font>
OS_ResumeTask ShowGoods<font></font>
OS_ResumeTask AcceptMoney <font></font>
OS_ResumeTask ScanKeys<font></font>
OS_ResumeTask MakeChange<font></font>
OS_ResumeTask ReleaseCoffee<font></font>
OS_ResumeTask Alarm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでに述べたように、マルチタスクが起動されたときに、必ずしもすべてのタスクを開始する必要はありません。</font><font style="vertical-align: inherit;">それらの一部は、いつでも「停止」状態のままになり、特定の条件下でのみ準備ができます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_ResumeTask</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービス</font><font style="vertical-align: inherit;">は、マルチタスクがすでに実行されているときに、コード（バックグラウンドまたはタスク）のどこからでもいつでも呼び出すことができます。</font><font style="vertical-align: inherit;">主なことは、それが参照するタスクは事前に初期化されているということです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルチタスク開始</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、すべてがマルチタスクを開始する準備ができました。</font><font style="vertical-align: inherit;">これを行うには、ディスパッチャーを呼び出します。</font></font><br>
<br>
<pre><code class="vbscript hljs">OS_Sheduler</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、プログラムコードを安全に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">終了</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でき</font><font style="vertical-align: inherit;">ます。これで、OSがコードの実行を制御できるようになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コード全体を見てみましょう。</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-comment">'   </span><font></font>
config submode = old<font></font>
$include <span class="hljs-string">"..\aquaRTOS_1.05.bas"</span>
$include <span class="hljs-string">"coffee_hardware.bas"</span> <span class="hljs-comment">'     </span>
<span class="hljs-comment">'       Coffee_</span>
$regfile = <span class="hljs-string">"m328pdef.dat"</span> <span class="hljs-comment">' Arduino Nano v3</span>
$crystal = <span class="hljs-number">16000000</span>
$hwstack = <span class="hljs-number">48</span>
$swstack = <span class="hljs-number">48</span>
$framesize = <span class="hljs-number">64</span><font></font>
<font></font>
Coffee_InitHardware <span class="hljs-comment">'   </span><font></font>
<font></font>
<span class="hljs-comment">'  </span>
declare <span class="hljs-keyword">sub</span> Mailfuncion (<span class="hljs-keyword">byval</span> bCoffeeErr as byte) <span class="hljs-comment">'  </span>
declare <span class="hljs-keyword">sub</span> ControlHeater () <span class="hljs-comment">'  </span>
declare <span class="hljs-keyword">sub</span> ShowGoods () <span class="hljs-comment">'   </span>
declare <span class="hljs-keyword">sub</span> AcceptMoney () <span class="hljs-comment">'  </span>
declare <span class="hljs-keyword">sub</span> ScanKeys () <span class="hljs-comment">'  </span>
declare <span class="hljs-keyword">sub</span> MakeChange () <span class="hljs-comment">'     </span>
declare <span class="hljs-keyword">sub</span> ReleaseCoffee () <span class="hljs-comment">'  </span>
declare <span class="hljs-keyword">sub</span> Alarm () <span class="hljs-comment">'   </span><font></font>
<font></font>
<span class="hljs-comment">'    </span><font></font>
Coffee_InitHardware ()<font></font>
<font></font>
<span class="hljs-comment">'  </span>
<span class="hljs-keyword">dim</span> wMoney as long <span class="hljs-comment">'   </span>
<span class="hljs-keyword">dim</span> wGoods as long <span class="hljs-comment">'  </span><font></font>
<font></font>
<span class="hljs-comment">' ***    ***</span><font></font>
<font></font>
<span class="hljs-comment">'  </span><font></font>
OS_Init Mailfuncion <font></font>
<font></font>
<span class="hljs-comment">'      </span>
<span class="hljs-keyword">dim</span> bCoffeeSelection as byte<font></font>
bCoffeeSelection = OS_CreateMessage() <font></font>
<font></font>
<span class="hljs-comment">'    </span>
<span class="hljs-keyword">dim</span> bGoodsReliased as byte<font></font>
bGoodsReliased = OS_CreateEvent() <font></font>
<font></font>
<span class="hljs-comment">'  </span>
OS_InitTask ControlHeater , <span class="hljs-number">5</span>
OS_InitTask ShowGoods , <span class="hljs-number">8</span> 
OS_InitTask AcceptMoney , <span class="hljs-number">3</span>
OS_InitTask ScanKeys , <span class="hljs-number">3</span>
OS_InitTask MakeChange, <span class="hljs-number">10</span>
OS_InitTask ReleaseCoffee , <span class="hljs-number">2</span>
OS_InitTask Alarm , <span class="hljs-number">1</span><font></font>
<font></font>
<span class="hljs-comment">'    </span><font></font>
OS_ResumeTask ControlHeater <font></font>
OS_ResumeTask ShowGoods<font></font>
OS_ResumeTask AcceptMoney <font></font>
OS_ResumeTask ScanKeys<font></font>
OS_ResumeTask MakeChange<font></font>
OS_ResumeTask ReleaseCoffee<font></font>
OS_ResumeTask Alarm<font></font>
<font></font>
<span class="hljs-comment">'  </span><font></font>
OS_Sheduler<font></font>
<font></font>
<span class="hljs-keyword">end</span><font></font>
<font></font>
<span class="hljs-comment">' ***   ***</span><font></font>
<font></font>
<span class="hljs-comment">' -----------------------------------</span>
<span class="hljs-keyword">sub</span> ControlHeater()
    <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span> GetWaterTemp()
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">is</span> &gt; <span class="hljs-number">97</span> 
                Coffee_HeaterOff <span class="hljs-comment">'  </span>
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">is</span> &lt; <span class="hljs-number">95</span>
                Coffee_HeaterOn <span class="hljs-comment">'  </span>
            <span class="hljs-keyword">case</span> <span class="hljs-keyword">is</span> &lt; <span class="hljs-number">5</span>
                CallServce (WARNING_WATER_FROZEN) <span class="hljs-comment">'   </span>
        <span class="hljs-keyword">end</span> <span class="hljs-keyword">select</span>
        OS_Delay <span class="hljs-number">60000</span> <span class="hljs-comment">'  1 </span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-comment">' -----------------------------------</span>
<span class="hljs-keyword">sub</span> ShowGoods()
    <span class="hljs-keyword">do</span>
        LEDS = Coffee_GetDrinkSupplies() <span class="hljs-comment">'    D,</span>
        <span class="hljs-comment">'        </span>
        <span class="hljs-comment">'   LEDS </span>
         OS_WaitEvent bGoodsReliased <span class="hljs-comment">'   " "</span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-comment">' -----------------------------------</span>
<span class="hljs-keyword">sub</span> AcceptMoney()
    <span class="hljs-keyword">do</span><font></font>
        wMoney = wMoney + ReadMoneyAcceptor()<font></font>
        OS_Delay <span class="hljs-number">20</span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-comment">' -----------------------------------</span>
<span class="hljs-keyword">sub</span> ScanKeys()
    <span class="hljs-keyword">do</span><font></font>
        wGoods = ButtonPressed()<font></font>
        <span class="hljs-keyword">if</span> wMoney &gt;= GostOf(wGoods) <span class="hljs-keyword">then</span><font></font>
            OS_SendMessage bCoffeeSelection, wGoods<font></font>
            <span class="hljs-comment">'     bCoffeeSelection, </span>
            <span class="hljs-comment">'    </span>
        <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>
        OS_Delay <span class="hljs-number">40</span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-comment">' -----------------------------------</span>
<span class="hljs-keyword">sub</span> MakeChange()
    <span class="hljs-keyword">do</span>
        OS_WaitEvent bGoodsReliased <span class="hljs-comment">'   " "</span><font></font>
        Refund wMoney<font></font>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-comment">' -----------------------------------</span>
<span class="hljs-keyword">sub</span> ReleaseCoffee()
    <span class="hljs-keyword">do</span>
        OS_WaitMessage bCoffeeSelection <span class="hljs-comment">'  bCoffeeSelection</span>
        wItem = OS_GetMessage(bCoffeeSelection) <span class="hljs-comment">'  </span>
        Release wItem <span class="hljs-comment">'   </span>
        wMoney = wMoney – CostOf (wItem) <span class="hljs-comment">'    </span>
        OS_SignalEvent bGoodsReliased <span class="hljs-comment">'    </span>
        <span class="hljs-comment">'  ,       :</span>
        <span class="hljs-comment">' MakeChange  ShowGoods</span>
        <span class="hljs-comment">'  ,  ,     </span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span><font></font>
<font></font>
<span class="hljs-comment">' -----------------------------------</span>
<span class="hljs-keyword">sub</span> Alarm() 
    <span class="hljs-keyword">do</span>
        OS_Delay <span class="hljs-number">1000</span>
        <span class="hljs-keyword">if</span> Hijack() = <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <font></font>
            CallPolice()<font></font>
        <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>
    <span class="hljs-keyword">loop</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span> 
<span class="hljs-comment">' -----------------------------------</span><font></font>
<font></font>
<span class="hljs-comment">' ***    ***</span>
<span class="hljs-keyword">sub</span> Mailfuncion (bCoffeeErr)<font></font>
    print <span class="hljs-string">"Mailfunction! Error #: "</span>; bCoffeeErr
    <span class="hljs-keyword">if</span> isErrCritical (bCoffeeErr) = <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <font></font>
        CallService()<font></font>
    <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>
<span class="hljs-keyword">end</span> <span class="hljs-keyword">sub</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、より正確なアプローチは、ボタンとキャッシュセンサーの定期的なポーリングではなく、割り込みの使用です。</font><font style="vertical-align: inherit;">これらの割り込みのハンドラーでは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SendMessage（）サービス</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用して</font><font style="vertical-align: inherit;">、押されたキーの数または入力されたコイン/紙幣の値に等しい内容</font><font style="vertical-align: inherit;">でメッセージを送信できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">読者は自分でプログラムを完成させることをお勧めします。</font><font style="vertical-align: inherit;">タスク指向のアプローチとOSが提供するサービスのおかげで、コードの変更は最小限で済みます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AQUA RTOSソースコード</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースコードバージョン1.05は、こちらからダウンロードできます。 </font></font></b></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q：なぜAQUAですか？</font></font></i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A：ええと、私は水族館のコントローラーを作りました。それは、人々だけでなく魚にとっても「スマートホーム」のようなものです。あらゆる種類のセンサー、リアルタイムクロック、リレーおよびアナログ電源出力、オンスクリーンメニュー、柔軟な「イベントプログラム」、さらにはWiFiモジュールさえも満載です。間隔がカウントされ、ボタンがポーリングされ、センサーが処理され、イベントプログラムがEEPROMから読み取られて実行され、画面が更新され、Wi-Fiが応答します。さらに、コントローラは、設定とプログラミングのためにマルチレベルメニューに移動する必要があります。フラグと割り込みを実行することは、理解も変更もされていない「パスタコード」を取得することです。そのため、OSが必要だと思いました。ここで彼女はアクアです。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q：確かにコードは論理的なエラーや不具合でいっぱいですか？</font></font></i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A：確かに。</font><font style="vertical-align: inherit;">私は、可能な限り、さまざまなテストを考え出し、さまざまなタスクでOSを動かし、かなりの数のバグを非難しましたが、これはすべてが完全であるという意味ではありません。</font><font style="vertical-align: inherit;">コードの裏通りにまだたくさんあると私は確信しています。</font><font style="vertical-align: inherit;">したがって、私は、顔の虫に私を突き刺す代わりに、礼儀正しくそして巧みにそれらを指さし、そしてあなたがそれらを修正する方が良いと思う方法を教えてくれれば非常に感謝します。</font><font style="vertical-align: inherit;">また、プロジェクトが集団的創造性の産物としてさらに発展することも素晴らしいことです。</font><font style="vertical-align: inherit;">たとえば、誰かがセマフォをカウントするためのサービスを追加し（忘れていませんか？-私は怠惰なお尻です）、他の改善を提供します。</font><font style="vertical-align: inherit;">いずれにせよ、私は建設的な貢献に非常に感謝します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja453692/index.html">初心者向け3Dゲームシェーダー：効果</a></li>
<li><a href="../ja453696/index.html">双方向角度バインディング、もう少し理解</a></li>
<li><a href="../ja453698/index.html">量子意識における量子情報</a></li>
<li><a href="../ja453700/index.html">SDL 2のレッスン：レッスン1-こんにちは、SDL 2</a></li>
<li><a href="../ja453706/index.html">Google Cloud Professional Data Engineer認定試験に合格した方法</a></li>
<li><a href="../ja453710/index.html">大規模プロジェクトでの開発実践：mitap SberPractice iOS＃1</a></li>
<li><a href="../ja453712/index.html">eBayがWebAssemblyでバーコードスキャナーを実行した方法</a></li>
<li><a href="../ja453714/index.html">TON（Telegram Open Network）テストクライアントとスマートコントラクト用の新しいFift言語</a></li>
<li><a href="../ja453716/index.html">家族のIT担当者のための国のコワーキング-誰かいますか？</a></li>
<li><a href="../ja453720/index.html">Cでのラムダ式の微妙さ＃</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>