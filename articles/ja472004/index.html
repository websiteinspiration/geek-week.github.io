<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¼ ğŸ”² ğŸš£ Boost.Spiritã€ã¾ãŸã¯ã€Œã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒªãƒ†ã‚£ã€ã‚’ãƒªã‚¹ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«è¿½åŠ  ğŸ¢ â›©ï¸ ğŸ¤¹ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã“ã‚“ã«ã¡ã¯ã€åŒåƒšã€‚ç§ã¯ã¾ã ISPã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºè€…ã§ã‚ã‚Šã€ç§ã®åå‰ã¯ã¾ã ãƒ‰ãƒŸãƒˆãƒªãƒ¼ã‚¹ãƒŸãƒ«ãƒãƒ•ã§ã™ã€‚Boost.Asioã§ã®ä½œæ¥­ã®éå»æ•°ã‹æœˆã®é–“ã«å¤šãã®è³‡æ–™ãŒè“„ç©ã•ã‚ŒãŸãŸã‚ã€ã—ã°ã‚‰ãã®é–“ï¼ˆã‹ãªã‚Šé•·ã„é–“ï¼‰æ¬¡ã®å‡ºç‰ˆç‰©ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’æ±ºã‚ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãã—ã¦ã€ã‚³ã‚¤ãƒ³ã‚’æŠ•ã’ã‚‹æ–¹ãŒç°¡å˜ã ã¨æ€ã‚ã‚ŒãŸãã®ç¬é–“ã§...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Boost.Spiritã€ã¾ãŸã¯ã€Œã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒªãƒ†ã‚£ã€ã‚’ãƒªã‚¹ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«è¿½åŠ </h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ispsystem/blog/472004/"><p><img src="https://habrastorage.org/webt/qv/yu/6-/qvyu6-kaqci3ha5ivctj0nvbwco.png" alt="ç”»åƒ"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã‚“ã«ã¡ã¯ã€åŒåƒšã€‚</font><font style="vertical-align: inherit;">ç§ã¯ã¾ã ISPã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºè€…ã§ã‚ã‚Šã€ç§ã®åå‰ã¯ã¾ã ãƒ‰ãƒŸãƒˆãƒªãƒ¼ã‚¹ãƒŸãƒ«ãƒãƒ•ã§ã™ã€‚</font><font style="vertical-align: inherit;">Boost.Asioã§ã®ä½œæ¥­ã®éå»æ•°ã‹æœˆã®é–“ã«å¤šãã®è³‡æ–™ãŒè“„ç©ã•ã‚ŒãŸãŸã‚ã€ã—ã°ã‚‰ãã®é–“ï¼ˆã‹ãªã‚Šé•·ã„é–“ï¼‰æ¬¡ã®å‡ºç‰ˆç‰©ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’æ±ºã‚ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</font><font style="vertical-align: inherit;">ãã—ã¦ã€ã‚³ã‚¤ãƒ³ã‚’æŠ•ã’ã‚‹æ–¹ãŒç°¡å˜ã ã¨æ€ã‚ã‚ŒãŸãã®ç¬é–“ã§ã•ãˆã€1ã¤ã®ã‚¿ã‚¹ã‚¯ãŒã™ã¹ã¦ã‚’å¤‰ãˆã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒè¦æ±‚ã•ã‚ŒãŸãƒªã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’é–‹ç™ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ãƒªã‚¹ãƒˆè‡ªä½“ã¯é€šå¸¸ã®json_arrayã§ã™ã€‚</font><font style="vertical-align: inherit;">ã‚­ãƒ£ãƒƒãƒˆã¸ã‚ˆã†ã“ãã€‚æœ€è¿‘ã®æµ®ãæ²ˆã¿ãŒã‚ã‚Šã¾ã™ã€‚</font></font></p><a name="habracut"></a><br>
<h3 id="diskleymer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å…è²¬äº‹é …</font></font></h3><br>
<p> ,     Â«Â»   -    .    -     ,    Boost.Spirit       .</p><br>
<h3 id="zadacha"></h3><br>
<p>   :</p><br>
<pre><code class="cpp hljs">(string_field CP value AND int_field NOT LT <span class="hljs-number">150</span>) OR bool_field EQ <span class="hljs-literal">true</span></code></pre><br>
<p> - ,     json  ,     .</p><br>
<h3 id="pervye-shagi"> </h3><br>
<p>       .      ,      STL ,   std::remove_if.</p><br>
<p>  ,        .     nlohmann::json,    :</p><br>
<pre><code class="cpp hljs">filter = <span class="hljs-string">"(string_field CP value AND int_field NOT LT 150) OR bool_field EQ true"</span>;<font></font>
json.erase(<span class="hljs-built_in">std</span>::remove_if(json.begin(), json.end(), <span class="hljs-built_in">std</span>::not_fn(JsonFilter{filter})), json.end());</code></pre><br>
<p>          .       ,    â€”  .          :</p><br>
<p><img src="https://habrastorage.org/webt/if/yc/zk/ifyczkjiznmiebrxvof3oxgnur4.jpeg" alt="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ„ãƒªãƒ¼"></p><br>
<p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">AST</a>,     . ,     ,      .   â€¦  ...</p><br>
<h3 id="znakomstvo"></h3><br>
<p>   :   ?    Asio   Spirit     ,   â€“  "- ".             ,         ,       : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">AST </a></p><br>
<p>  ,   :</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArithmeticGrammar1</span>  
   :</span> <span class="hljs-keyword">public</span> qi::grammar&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::const_iterator, ASTNodePtr(), qi::space_type&gt; {  
<span class="hljs-keyword">public</span>:  
   <span class="hljs-keyword">using</span> Iterator = <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::const_iterator;  <font></font>
  ArithmeticGrammar1() : ArithmeticGrammar1::base_type(start) {  <font></font>
      start = (product &gt;&gt; <span class="hljs-string">'+'</span> &gt;&gt; start)  <font></font>
      [qi::_val = phx::new_&lt;OperatorNode&lt;<span class="hljs-string">'+'</span>&gt;&gt; (qi::_1, qi::_2)] |  <font></font>
         product[qi::_val = qi::_1];  <font></font>
      product = (factor &gt;&gt; <span class="hljs-string">'*'</span> &gt;&gt; product)  <font></font>
      [qi::_val = phx::new_&lt;OperatorNode&lt;<span class="hljs-string">'*'</span>&gt;&gt; (qi::_1, qi::_2)] |  <font></font>
         factor[qi::_val = qi::_1];  <font></font>
      factor = group[qi::_val = qi::_1] |  <font></font>
         qi::int_[qi::_val = phx::new_&lt;ConstantNode&gt;(qi::_1)];  <font></font>
      group %= <span class="hljs-string">'('</span> &gt;&gt; start &gt;&gt; <span class="hljs-string">')'</span>;  <font></font>
  }  <font></font>
<font></font>
   qi::rule&lt;Iterator, ASTNodePtr(), qi::space_type&gt; start, group, product, factor;  <font></font>
};</code></pre></div></div><br>
<p>    qi::grammar. <em>ASTNodePtr()</em> â€”   ,           .</p><br>
<div class="spoiler"><b class="spoiler_title">AST node </b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span>  <span class="hljs-title">ASTNode</span> {</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">double</span> <span class="hljs-title">evaluate</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-keyword">virtual</span> ~ASTNode() {}<font></font>
};<font></font>
<span class="hljs-keyword">using</span> ASTNodePtr = ASTNode*;<font></font>
<font></font>
<span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">char</span> Operator&gt;  
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OperatorNode</span> :</span> <span class="hljs-keyword">public</span> ASTNode {  
<span class="hljs-keyword">public</span>:  <font></font>
   OperatorNode(<span class="hljs-keyword">const</span> ASTNodePtr &amp;left, <span class="hljs-keyword">const</span> ASTNodePtr &amp;right)  <font></font>
      : left(left)<font></font>
      , right(right) {}  <font></font>
   <span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">evaluate</span><span class="hljs-params">()</span> </span>{  
      <span class="hljs-keyword">if</span> (Operator == <span class="hljs-string">'+'</span>)  
         <span class="hljs-keyword">return</span> left-&gt;evaluate() + right-&gt;evaluate();  
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Operator == <span class="hljs-string">'*'</span>)  
         <span class="hljs-keyword">return</span> left-&gt;evaluate() * right-&gt;evaluate();  <font></font>
  }  <font></font>
  ~OperatorNode() {  <font></font>
      <span class="hljs-keyword">delete</span> left;  
      <span class="hljs-keyword">delete</span> right;  <font></font>
  }    <font></font>
<span class="hljs-keyword">private</span>:  <font></font>
   ASTNodePtr left, right; <span class="hljs-comment">// </span><font></font>
};  <font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConstantNode</span> :</span> <span class="hljs-keyword">public</span> ASTNode {  
<span class="hljs-keyword">public</span>:  <font></font>
   ConstantNode(<span class="hljs-keyword">double</span> value) : value(value) {}  
   <span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">evaluate</span><span class="hljs-params">()</span> </span>{  
      <span class="hljs-keyword">return</span> value;  <font></font>
   }<font></font>
<span class="hljs-keyword">private</span>:  
   <span class="hljs-keyword">double</span> value;  <font></font>
};</code></pre></div></div><br>
<p>   Boost.Phoenix             AST-     .       :</p><br>
<pre><code class="cpp hljs">start = (product &gt;&gt; <span class="hljs-string">'+'</span> &gt;&gt; start)[qi::_val = phx::new_&lt;OperatorNode&lt;<span class="hljs-string">'+'</span>&gt;&gt; (qi::_1, qi::_2)] <font></font>
          | product[qi::_val = qi::_1];  </code></pre><br>
<p>start â€”   .  .       product  start     product.</p><br>
<p>         .  ,       ,   . <em>qi::_val</em> â€”     <em>boost::spirit::qi::_val</em> â€” .        .   start    OperatorNode,        product,   â€”   start.</p><br>
<p> . ,    , start  ,  product.    ?</p><br>
<pre><code class="cpp hljs">product = (factor &gt;&gt; <span class="hljs-string">'*'</span> &gt;&gt; product) [qi::_val = phx::new_&lt;OperatorNode&lt;<span class="hljs-string">'*'</span>&gt;&gt; (qi::_1, qi::_2)] | factor[qi::_val = qi::_1]; </code></pre><br>
<p>     .   - ,      OperatorNode    - factor.    .</p><br>
<pre><code class="cpp hljs">factor = group[qi::_val = qi::_1] | qi::int_[qi::_val = phx::new_&lt;ConstantNode&gt;(qi::_1)];</code></pre><br>
<p>      , ,        int. ,       ,      -  :</p><br>
<pre><code class="cpp hljs">factor1 = ConstantNode(<span class="hljs-number">1</span>) <span class="hljs-comment">//   ,   </span>
factor2 = ConstantNode(<span class="hljs-number">3</span>)<font></font>
product = OperatorNode&lt;<span class="hljs-string">'*'</span>&gt;(factor1, factor2)<font></font>
start = product</code></pre><br>
<p> ,    (   ,   ,  ,  ),    .     <em>evaluate()</em>       , !</p><br>
<p>    <em>qi::space_type</em> â€”         .        :-).</p><br>
<p>            start (   +)  product (*).    ,   ,  And    Or,         .       ,     â€”   .        , , .        <em>qi::no_case</em></p><br>
<p>,      ,         <em>qi::int_</em> :</p><br>
<pre><code class="cpp hljs">field = qi::char_(<span class="hljs-string">"a-zA-Z_"</span>) &gt;&gt; *qi::char_(<span class="hljs-string">"a-zA-Z_0-9"</span>);</code></pre><br>
<p>      (   ):</p><br>
<pre><code class="plaintext hljs">start = product &gt;&gt; qi::no_case["OR"] &gt;&gt; start | product;<font></font>
product = factor &gt;&gt; qi::no_case["AND"] &gt;&gt; product | factor;<font></font>
factor = group | field;<font></font>
group %= '(' &gt;&gt; start &gt;&gt; ')';</code></pre><br>
<p>       <em>"field And field2"</em>.  â€¦   . </p><br>
<p>    : <em>qi::space_type</em>    ,       ,          :</p><br>
<pre><code class="cpp hljs"><span class="hljs-string">"fieldAndfield2"</span><font></font>
\\        ,   <font></font>
<span class="hljs-string">"(5 * 5) + 11 "</span><font></font>
\\ <font></font>
<span class="hljs-string">"(5*5)+11"</span></code></pre><br>
<p>    . ,   skipper:</p><br>
<pre><code class="cpp hljs">skipper = +qi::lit(<span class="hljs-string">' '</span>); <span class="hljs-comment">//    . ,    ,   ,  ,  C++ .</span>
start = product &gt;&gt; skipper &gt;&gt; qi::no_case[<span class="hljs-string">"OR"</span>] &gt;&gt; skipper &gt;&gt; start | product;<font></font>
...</code></pre><br>
<p>      ,        ,      .        :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">enum</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Operator</span> {</span>  
  EQ, <span class="hljs-comment">//   </span>
  LT, <span class="hljs-comment">// </span>
  GT, <span class="hljs-comment">// </span>
  CP  <span class="hljs-comment">//  (  )</span><font></font>
};<font></font>
<font></font>
unary = qi::no_case[<span class="hljs-string">"NOT"</span>]; <span class="hljs-comment">// ,         </span></code></pre><br>
<p>     :</p><br>
<pre><code class="cpp hljs">value = qi::double_ | qi::int_ | qi::bool_ | <span class="hljs-built_in">string</span>;  
<span class="hljs-built_in">string</span> = qi::lit(<span class="hljs-string">"'"</span>) &gt;&gt; +qi::char_(<span class="hljs-string">"a-zA-Z0-9_. "</span>) &gt;&gt; qi::lit(<span class="hljs-string">"'"</span>);</code></pre><br>
<p>   ,        .      <em>boost::variant&lt;int, double, bool, std::string&gt;</em>,         ,   ,     .      :</p><br>
<pre><code class="cpp hljs"><span class="hljs-keyword">using</span> ValueType = boost::variant&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">double</span>, <span class="hljs-keyword">bool</span>, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt;;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ValueGetter</span> :</span> <span class="hljs-keyword">public</span> boost::static_visitor&lt;Json&gt; {  
   <span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> Type&gt;  
   <span class="hljs-function">Json <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Type &amp;value)</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> value; }  <font></font>
};</code></pre><br>
<p>    Json?  ,          ,      ,     json.</p><br>
<p> .   .       .     ,     ,      :</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractMatcher</span> {</span>  
<span class="hljs-keyword">public</span>:  <font></font>
  AbstractMatcher() = <span class="hljs-keyword">default</span>;  
  <span class="hljs-keyword">virtual</span> ~AbstractMatcher() = <span class="hljs-keyword">default</span>;    
  <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">bool</span> <span class="hljs-title">evaluate</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Json &amp;object)</span> </span>= <span class="hljs-number">0</span>; <span class="hljs-comment">//      </span><font></font>
};<font></font>
<span class="hljs-keyword">using</span> MatcherPtr = <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;AbstractMatcher&gt;;</code></pre><br>
<p>   â€”   :</p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword">enum</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logic</span> {</span>  <font></font>
  AND,  <font></font>
  OR  <font></font>
};  <font></font>
<font></font>
<span class="hljs-keyword">template</span> &lt;Logic Operator&gt;  
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogicNode</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> AbstractMatcher {  
<span class="hljs-keyword">public</span>:  <font></font>
   LogicNode(MatcherPtr &amp;left, MatcherPtr &amp;right)  <font></font>
      : m_left(<span class="hljs-built_in">std</span>::move(left))  <font></font>
      , m_right(<span class="hljs-built_in">std</span>::move(right)) {  
      <span class="hljs-keyword">switch</span> (Operator) {  
         <span class="hljs-keyword">case</span> Logic::AND:  <font></font>
            m_evaluator = &amp;LogicNode::And;  <font></font>
            <span class="hljs-keyword">break</span>;  
         <span class="hljs-keyword">case</span> Logic::OR:  <font></font>
            m_evaluator = &amp;LogicNode::Or;  <font></font>
      }  <font></font>
   }  <font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">evaluate</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Json &amp;object)</span> <span class="hljs-keyword">final</span> </span>{  
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::invoke(m_evaluator, <span class="hljs-keyword">this</span>, object);  <font></font>
  }  <font></font>
<font></font>
<span class="hljs-keyword">private</span>: <font></font>
  MatcherPtr m_left;  <font></font>
  MatcherPtr m_right;<font></font>
  <span class="hljs-keyword">using</span> EvaluateType = <span class="hljs-keyword">bool</span>(LogicNode::*)(<span class="hljs-keyword">const</span> Json &amp;);   <font></font>
  EvaluateType m_evaluator = <span class="hljs-literal">nullptr</span>;  <font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">And</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Json &amp;object)</span> </span>{ <span class="hljs-keyword">return</span> m_left-&gt;evaluate(object) &amp;&amp; m_right-&gt;evaluate(object); }  
  <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Or</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Json &amp;object)</span> </span>{ <span class="hljs-keyword">return</span> m_left-&gt;evaluate(object) || m_right-&gt;evaluate(object); }  <font></font>
};</code></pre></div></div><br>
<p>, ,  </p><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ObjectNode</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> AbstractMatcher {  
<span class="hljs-keyword">public</span>:  <font></font>
   ObjectNode(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> field, <span class="hljs-keyword">const</span> ValueType &amp;value, boost::optional&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&gt; &amp;unary, Operator oper)  <font></font>
      : m_field(<span class="hljs-built_in">std</span>::move(field))  <font></font>
      , m_json_value(boost::apply_visitor(ValueGetter(), value))  <font></font>
      , m_reject(unary.has_value()) {  <font></font>
      <span class="hljs-keyword">switch</span> (oper) {  
         <span class="hljs-keyword">case</span> Operator::EQ:  <font></font>
            m_evaluator = &amp;ObjectNode::Equal;  <font></font>
            <span class="hljs-keyword">break</span>;  
         <span class="hljs-keyword">case</span> Operator::LT:  <font></font>
            m_evaluator = &amp;ObjectNode::LesserThan;  <font></font>
            <span class="hljs-keyword">break</span>;  
         <span class="hljs-keyword">case</span> Operator::GT:  <font></font>
            m_evaluator = &amp;ObjectNode::GreaterThan;  <font></font>
            <span class="hljs-keyword">break</span>;  
         <span class="hljs-keyword">case</span> Operator::CP:  <font></font>
            m_evaluator = &amp;ObjectNode::Substr;  <font></font>
            <span class="hljs-keyword">break</span>;  <font></font>
     }  <font></font>
  }  <font></font>
<font></font>
   <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">evaluate</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Json &amp;object)</span> <span class="hljs-keyword">final</span> </span>{  
      <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> &amp;value = object.at(m_field);  
      <span class="hljs-keyword">const</span> <span class="hljs-keyword">bool</span> result = <span class="hljs-built_in">std</span>::invoke(m_evaluator, <span class="hljs-keyword">this</span>, value);  
      <span class="hljs-keyword">return</span> m_reject ? !result : result;  <font></font>
  }  <font></font>
<font></font>
<span class="hljs-keyword">private</span>:  
   <span class="hljs-keyword">using</span> EvaluateType = <span class="hljs-keyword">bool</span>(ObjectNode::*)(<span class="hljs-keyword">const</span> Json &amp;);  <font></font>
<font></font>
   <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> m_field;  
   <span class="hljs-keyword">const</span> Json m_json_value;  
   <span class="hljs-keyword">const</span> <span class="hljs-keyword">bool</span> m_reject;  <font></font>
<font></font>
   EvaluateType m_evaluator = <span class="hljs-literal">nullptr</span>;  <font></font>
<font></font>
   <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Equal</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Json &amp;json)</span> </span>{ <span class="hljs-keyword">return</span> json == m_json_value; }  
   <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">LesserThan</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Json &amp;json)</span> </span>{ <span class="hljs-keyword">return</span> json &lt; m_json_value; }  
   <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">GreaterThan</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Json &amp;json)</span> </span>{ <span class="hljs-keyword">return</span> json &gt; m_json_value; }  
   <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">Substr</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Json &amp;json)</span> </span>{ <span class="hljs-keyword">return</span> Str(json).find(Str(m_json_value)) != <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::npos; }  <font></font>
};</code></pre></div></div><br>
<p>     :</p><br>
<div class="spoiler"><b class="spoiler_title">Json </b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">JsonFilterGrammar</span> :</span> qi::grammar&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>::const_iterator, MatcherPtr()&gt; {  <font></font>
   JsonFilterGrammar()  <font></font>
      : JsonFilterGrammar::base_type(expression) {  <font></font>
<font></font>
  skipper = +qi::lit(<span class="hljs-string">' '</span>);  <font></font>
  unary = qi::no_case[<span class="hljs-string">"NOT"</span>];  <font></font>
  compare.add  <font></font>
         (<span class="hljs-string">"eq"</span>, Operator::EQ)  <font></font>
         (<span class="hljs-string">"lt"</span>, Operator::LT)  <font></font>
         (<span class="hljs-string">"gt"</span>, Operator::GT)  <font></font>
         (<span class="hljs-string">"cp"</span>, Operator::CP);  <font></font>
<font></font>
  expression = (product &gt;&gt; skipper &gt;&gt; qi::no_case[<span class="hljs-string">"OR"</span>] &gt;&gt; skipper &gt;&gt; expression)  <font></font>
      [qi::_val = make_shared_&lt;LogicNode&lt;Logic::OR&gt;&gt;()(qi::_1, qi::_2)] |  <font></font>
  product[qi::_val = qi::_1];  <font></font>
  product = (term &gt;&gt; skipper &gt;&gt; qi::no_case[<span class="hljs-string">"AND"</span>] &gt;&gt; skipper &gt;&gt; product)  <font></font>
      [qi::_val = make_shared_&lt;LogicNode&lt;Logic::AND&gt;&gt;()(qi::_1, qi::_2)]|  <font></font>
  term[qi::_val = qi::_1];  <font></font>
  term = group[qi::_val = qi::_1] |  <font></font>
  (field &gt;&gt; -(skipper &gt;&gt; unary)&gt;&gt; skipper &gt;&gt; qi::no_case[compare] &gt;&gt; skipper &gt;&gt; value)  <font></font>
         [qi::_val = make_shared_&lt;ObjectNode&gt;()(qi::_1, qi::_4, qi::_2, qi::_3)];  <font></font>
  field = qi::char_(<span class="hljs-string">"a-zA-Z_"</span>) &gt;&gt; *qi::char_(<span class="hljs-string">"a-zA-Z_0-9"</span>);  <font></font>
  value = qi::double_ | qi::int_ | qi::bool_ | <span class="hljs-built_in">string</span>;  
  <span class="hljs-built_in">string</span> = qi::lit(<span class="hljs-string">"'"</span>) &gt;&gt; +qi::char_(<span class="hljs-string">"a-zA-Z0-9_. \u20BDâ‚¬$Â¥-"</span>) &gt;&gt; qi::lit(<span class="hljs-string">"'"</span>);  <font></font>
  group %= <span class="hljs-string">'('</span> &gt;&gt; expression &gt;&gt; <span class="hljs-string">')'</span>;  <font></font>
  }  <font></font>
<font></font>
  qi::rule&lt;Iterator&gt; skipper;  <font></font>
  qi::rule&lt;Iterator, MatcherPtr()&gt; product, term, expression, group;  <font></font>
  qi::rule&lt;Iterator, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>()&gt; field, unary, <span class="hljs-built_in">string</span>;  <font></font>
  qi::rule&lt;Iterator, ValueType()&gt; value;  <font></font>
  qi::symbols&lt;<span class="hljs-keyword">char</span>, Operator&gt; compare;  <span class="hljs-comment">//      enum</span>
};</code></pre></div></div><br>
<p>  .        :</p><br>
<pre><code class="cpp hljs">MatcherPtr matcher;
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> filter = <span class="hljs-string">"int not LT 15"</span>;<font></font>
JsonFilterGrammar grammar;<font></font>
<font></font>
qi::parse(filter.begin(), filter.end(), grammar, matcher); <span class="hljs-comment">//     matcher   .</span></code></pre><br>
<p>       ( ,    - ).         :</p><br>
<pre><code class="cpp hljs"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> filter = <span class="hljs-string">"int not LT 15"</span>;<font></font>
Json json{ {{<span class="hljs-string">"int"</span>, <span class="hljs-number">10</span>}}, {{<span class="hljs-string">"int"</span>, <span class="hljs-number">11</span>}}, {{<span class="hljs-string">"int"</span>, <span class="hljs-number">20</span>}}, {{<span class="hljs-string">"int"</span>, <span class="hljs-number">30</span>}}, {{<span class="hljs-string">"int"</span>, <span class="hljs-number">9</span>}} };
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; json.dump() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
json.erase(<span class="hljs-built_in">std</span>::remove_if(json.begin(), json.end(), <span class="hljs-built_in">std</span>::not_fn(JsonFilter{filter})), json.end());
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; json.dump() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;</code></pre><br>
<p>  :</p><br>
<pre><code class="bash hljs">[{<span class="hljs-string">"int"</span>:10},{<span class="hljs-string">"int"</span>:11},{<span class="hljs-string">"int"</span>:20},{<span class="hljs-string">"int"</span>:30},{<span class="hljs-string">"int"</span>:9}]<font></font>
[{<span class="hljs-string">"int"</span>:20},{<span class="hljs-string">"int"</span>:30}]</code></pre><br>
<p>,  ,           .  .   .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja471992/index.html">æ®‹ã‚Šã®PEGæ©Ÿèƒ½ã®å®Ÿè£…</a></li>
<li><a href="../ja471994/index.html">Core Developer Sprintã§PEGã«å–ã‚Šçµ„ã¿ã¾ã™</a></li>
<li><a href="../ja471998/index.html">Fï¼ƒ10ï¼šãƒªã‚¹ãƒˆ</a></li>
<li><a href="../ja472000/index.html">ã€Œã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒåŸºæº–ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€ï¼šKotlinã«é–¢ã™ã‚‹Marchin Moskala</a></li>
<li><a href="../ja472002/index.html">Gradleã§ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å†æ¢±åŒ…</a></li>
<li><a href="../ja472006/index.html">è»Šè¼ªã‚’å†ç™ºæ˜ã™ã‚‹ã“ã¨ãŒæœ‰ç”¨ã§ã‚ã‚‹ç†ç”±</a></li>
<li><a href="../ja472012/index.html">30åˆ†ã§ã‹ã‚“ã°ã‚“</a></li>
<li><a href="../ja472014/index.html">OTUSã€‚ç§ãŸã¡ã®å¥½ããªé–“é•ã„</a></li>
<li><a href="../ja472018/index.html">Flask-Potionã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªåˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã€ãƒ‘ãƒ¼ãƒˆ0ï¼šå¿…è¦ãªã‚‚ã®ã™ã¹ã¦ã‚’æº–å‚™ã™ã‚‹</a></li>
<li><a href="../ja472020/index.html">ãƒˆãƒƒãƒ—10ï¼šHolyJS 2019 Piterã®æœ€é«˜ã®ãƒ¬ãƒãƒ¼ãƒˆ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>