<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ›µ ğŸ› ï¸ ğŸ§šğŸ¼ DBAï¼šè¿½æ±‚é£é” ğŸ¤ª ğŸ§€ ğŸ•·ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è°ˆåˆ°äº†ç›‘è§†PostgreSQLæ•°æ®åº“çš„é—®é¢˜ï¼š
 å¢é•¿wait-åº”ç”¨ç¨‹åºå·²â€œåœåœ¨â€æŸäººçš„é”ä¸Šã€‚å¦‚æœè¿™æ˜¯è¿‡å»çš„ä¸€æ¬¡å¼‚å¸¸-æ˜¯äº†è§£åŸå§‹åŸå› çš„æœºä¼šã€‚å¯¹äºDBAï¼Œè¿™ç§æƒ…å†µæ˜¯æœ€ä¸æ„‰å¿«çš„ä¸€ç§ï¼š
 
 

- ä¹ä¸€çœ‹ï¼ŒåŸºåœ°æ­£åœ¨è¿ä½œ
- æ²¡æœ‰æœåŠ¡å™¨èµ„æºè€—å°½
- ...ä½†æ˜¯æœ‰äº›è¦æ±‚â€œæ”¾æ…¢äº†é€Ÿåº¦â€
 â€œç«‹...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DBAï¼šè¿½æ±‚é£é”</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/503680/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è°ˆåˆ°äº†ç›‘è§†PostgreSQLæ•°æ®åº“</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„é—®é¢˜ï¼š</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¢é•¿</font></font><code>wait</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-åº”ç”¨ç¨‹åºå·²</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€œåœåœ¨â€</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æŸäºº</font><b><font style="vertical-align: inherit;">çš„é”ä¸Š</font></b><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">å¦‚æœè¿™æ˜¯è¿‡å»çš„ä¸€æ¬¡å¼‚å¸¸-æ˜¯äº†è§£åŸå§‹åŸå› çš„æœºä¼šã€‚</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹äºDBAï¼Œè¿™ç§æƒ…å†µæ˜¯æœ€ä¸æ„‰å¿«çš„ä¸€ç§ï¼š</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¹ä¸€çœ‹ï¼ŒåŸºåœ°æ­£åœ¨è¿ä½œ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ²¡æœ‰æœåŠ¡å™¨èµ„æºè€—å°½</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...ä½†æ˜¯æœ‰äº›è¦æ±‚â€œæ”¾æ…¢äº†é€Ÿåº¦â€</font></font></li>
</ul><img src="https://habrastorage.org/webt/jy/wa/sk/jywaskrftah-9f7d9xwp3jvkn_q.png" align="right"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
â€œç«‹å³â€ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ•è·é”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„æœºä¼š</font><font style="vertical-align: inherit;">éå¸¸å°ï¼Œå®ƒä»¬åªèƒ½æŒç»­å‡ ç§’é’Ÿï¼Œä½†ä¼šä½¿è¯·æ±‚çš„è®¡åˆ’æ‰§è¡Œæ—¶é—´æ¶åŒ–æ•°åå€ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œæ‚¨åªæ˜¯ä¸æƒ³åä¸‹æ¥æ•æ‰ç½‘ä¸Šå‘ç”Ÿçš„äº‹æƒ…ï¼Œè€Œè¦åœ¨ä¸€ä¸ªå¹³é™çš„ç¯å¢ƒä¸­æ‰¾å‡ºäº‹å®</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œç”±</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å“ªäº›</font><s><font style="vertical-align: inherit;">å¼€å‘äººå‘˜æ¥æƒ©ç½š</font></s><font style="vertical-align: inherit;">åˆ°åº•æ˜¯ä»€ä¹ˆé—®é¢˜-è°ï¼Œè°ä¸è°ä»¥åŠç”±äºæ•°æ®åº“çš„å“ªäº›èµ„æºå‘ç”Ÿå†²çªã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯å¦‚ä½•ï¼Ÿ</font><font style="vertical-align: inherit;">ç¡®å®ï¼Œä¸å…·æœ‰è®¡åˆ’çš„è¯·æ±‚ä¸åŒï¼Œè¯¥è¯·æ±‚</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½¿æ‚¨å¯ä»¥è¯¦ç»†</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº†è§£èµ„æºçš„ç”¨é€”å’ŒèŠ±è´¹çš„æ—¶é—´ï¼Œè¯¥</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é”ä¸ä¼šç•™ä¸‹æ˜æ˜¾çš„ç—•è¿¹</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> â€¦â€¦ </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é™¤éè¾“å…¥ç®€çŸ­çš„æ—¥å¿—ï¼š</font><font style="vertical-align: inherit;">ä½†æ˜¯è®©æˆ‘ä»¬å°è¯•æŠ“ä½å®ƒï¼</font></font><code><blockquote>process ... <b>still waiting for</b> ...</blockquote></code><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬æŠ“ä½äº†æ—¥å¿—ä¸­çš„é”</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯ï¼Œå³ä½¿è‡³å°‘è¦åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºæ­¤è¡Œï¼Œä¹Ÿå¿…é¡»æ­£ç¡®é…ç½®æœåŠ¡å™¨ï¼š</font></font><br>
<blockquote><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">log_lock_waits</a> = <b>'on'</b></code></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...å¹¶ä¸ºæˆ‘ä»¬çš„åˆ†æè®¾ç½®æœ€å°è¾¹ç•Œï¼š</font></font><br>
<blockquote><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">deadlock_timeout</a> = <b>'100ms'</b></code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯ç”¨</font></font><code>log_lock_waits</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¤å‚æ•°åï¼Œæ­¤å‚æ•°è¿˜å°†ç¡®å®šæœ‰å…³ç­‰å¾…é˜»å¡çš„æ¶ˆæ¯å°†åœ¨ä»€ä¹ˆæ—¶é—´åå†™å…¥æœåŠ¡å™¨æ—¥å¿—ã€‚</font><font style="vertical-align: inherit;">å¦‚æœæ‚¨è¦è°ƒæŸ¥ç”±é”å¼•èµ·çš„å»¶è¿Ÿï¼Œåˆ™ä¸é€šå¸¸çš„å€¼ç›¸æ¯”ï¼Œå°†å…¶å‡å°‘æ˜¯æœ‰æ„ä¹‰çš„</font></font><code>deadlock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨æ­¤æœŸé—´æ²¡æœ‰æ—¶é—´â€œè§£å¼€â€çš„æ‰€æœ‰æ­»é”å°†è¢«æ’•è£‚ã€‚</font><font style="vertical-align: inherit;">è¿™æ˜¯â€œå¸¸è§„â€é”-é€šè¿‡å‡ ä¸ªæ¡ç›®è½¬å‚¨åˆ°æ—¥å¿—ä¸­ï¼š</font></font><br>
<blockquote><i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest LOG: <b>process <font color="red">38162</font> still waiting for ExclusiveLock on advisory lock <font color="blue">[225382138,225386226,141586103,2]</font> after 100.047 ms</b><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest DETAIL: <b>Process holding the lock: 38154. Wait queue: <font color="red">38162</font>.</b><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest CONTEXT: SQL statement <code>"SELECT pg_advisory_xact_lock( '""'::regclass::oid::integer, 141586103::integer )"<br>
 PL/pgSQL function inline_code_block line 2 at PERFORM</code><br>
<br>
<i>2019-03-27 00:06:46.026</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest STATEMENT: <code> DO $$ BEGIN<br>
 PERFORM pg_advisory_xact_lock( '""'::regclass::oid::integer, 141586103::integer );<br>
 EXCEPTION<br>
 WHEN query_canceled THEN RETURN;<br>
 END; $$;</code><br>
â€¦<br>
<br>
<i>2019-03-27 00:06:46.077</i> MSK [38162:84/166010018] [inside.tensor.ru] [local] csr-inside-bl10:10081: MergeRequest LOG: <b>process <font color="red">38162</font> <font color="green">acquired</font> ExclusiveLock on advisory lock <font color="blue">[225382138,225386226,141586103,2]</font> after 150.741 ms</b></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¤ç¤ºä¾‹è¡¨æ˜ï¼Œ</font><font style="vertical-align: inherit;">ä»é”å®šå‡ºç°åœ¨æ—¥å¿—ä¸­åˆ°è§£å†³å®ƒçš„é‚£ä¸€åˆ»ä¹‹é—´</font><font style="vertical-align: inherit;">ï¼Œæˆ‘ä»¬</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åªæœ‰50ms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä»…åœ¨æ­¤æ—¶é—´é—´éš”å†…ï¼Œæˆ‘ä»¬è‡³å°‘å¯ä»¥è·å¾—æœ‰å…³å®ƒçš„ä¸€äº›ä¿¡æ¯ï¼Œå¹¶ä¸”æˆ‘ä»¬èƒ½å¤Ÿåšåˆ°è¿™ä¸€ç‚¹çš„é€Ÿåº¦è¶Šå¿«ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æçš„é”å°±è¶Šå¤šã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯¹æˆ‘ä»¬æ¥è¯´ï¼Œæœ€é‡è¦çš„ä¿¡æ¯</font><font style="vertical-align: inherit;">æ˜¯ç­‰å¾…é”å®š</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„è¿›ç¨‹</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„</font><b><font style="vertical-align: inherit;">PID</font></b><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">é€šè¿‡å®ƒï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒæ—¥å¿—å’Œæ•°æ®åº“çŠ¶æ€ä¹‹é—´çš„ä¿¡æ¯ã€‚</font><font style="vertical-align: inherit;">å¹¶ä¸”åŒæ—¶æ‰¾å‡ºç‰¹å®šçš„é”æœ‰å¤šé—®é¢˜-å³â€œæŒ‚â€äº†å¤šé•¿æ—¶é—´ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨å†…å®¹</font></font><code>LOG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®°å½•</font><font style="vertical-align: inherit;">ä¸Šåªéœ€è¦å‡ ä¸ªRegExp </font><font style="vertical-align: inherit;">ï¼š</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> RE_lock_detect = <span class="hljs-regexp">/^process (\d+) still waiting for (.*) on (.*) after (\d+\.\d{3}) ms(?: at character \d+)?$/</span>; <span class="hljs-comment">//    </span>
<span class="hljs-keyword">const</span> RE_lock_acquire = <span class="hljs-regexp">/^process (\d+) acquired (.*) on (.*) after (\d+\.\d{3}) ms(?: at character \d+)?$/</span>; <span class="hljs-comment">//   </span>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬åˆ°æ—¥å¿—</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®é™…ä¸Šï¼Œå®ƒä»ç„¶æœ‰äº›ä¸è¶³-è·å–æ—¥å¿—ï¼Œäº†è§£å¦‚ä½•å¯¹å…¶è¿›è¡Œç›‘è§†å¹¶åšå‡ºç›¸åº”çš„å“åº”ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å·²ç»æ‹¥æœ‰äº†æ‰€æœ‰åŠŸèƒ½-åœ¨çº¿æ—¥å¿—è§£æå™¨å’Œé¢„å…ˆæ¿€æ´»çš„æ•°æ®åº“è¿æ¥ï¼Œæˆ‘åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æœ‰å…³PostgreSQLç›‘æ§ç³»ç»Ÿ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„æ–‡ç« ä¸­è°ˆåˆ°äº†è¯¥</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">æ–¹æ³•</font></a><font style="vertical-align: inherit;">ï¼š</font></font><br>
<img src="https://habrastorage.org/webt/tc/pv/oq/tcpvoqmeliadskfh2rpnffg7uwo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æ²¡æœ‰éƒ¨ç½²ä»»ä½•ç±»ä¼¼çš„ç³»ç»Ÿï¼Œé‚£ä¹ˆå°±å¯ä»¥äº†â€œå°±åœ¨æ§åˆ¶å°æ—è¾¹â€ï¼</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœå®‰è£…çš„PostgreSQL 10åŠæ›´é«˜ç‰ˆæœ¬å¾ˆå¹¸è¿ï¼Œå› ä¸ºå‡ºç°äº†</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_current_logfileï¼ˆï¼‰</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡½æ•°</font><font style="vertical-align: inherit;">ï¼Œè¯¥å‡½æ•°æ˜¾å¼ç»™å‡ºå½“å‰æ—¥å¿—æ–‡ä»¶çš„åç§°ã€‚</font><font style="vertical-align: inherit;">ä»æ§åˆ¶å°è·å–å®ƒå¾ˆå®¹æ˜“ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) &lt;&gt; '/' THEN current_setting('data_directory') ELSE '' END || '/' || pg_current_logfile()"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æœè¯¥ç‰ˆæœ¬çªç„¶æ›´å¹´è½»-ä¸€åˆ‡éƒ½ä¼šå‡ºç°ï¼Œä½†ä¼šç¨å¾®å¤æ‚ä¸€ç‚¹ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">ps uw -U postgres \<font></font>
  | grep [l]ogger \<font></font>
  | awk <span class="hljs-string">'{print "/proc/"$2"/fd"}'</span> \<font></font>
  | xargs ls -l \<font></font>
  | grep `<span class="hljs-built_in">cd</span>; psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) = '/' THEN current_setting('log_directory') ELSE current_setting('data_directory') || '/' || current_setting('log_directory') END"</span>` \<font></font>
  | awk <span class="hljs-string">'{print $NF}'</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬</font></font><code>tail -f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¾—åˆ°</font><font style="vertical-align: inherit;">å®Œæ•´çš„æ–‡ä»¶åï¼Œç„¶åè¾“å…¥è¯¥æ–‡ä»¶åï¼Œå¹¶åœ¨</font><font style="vertical-align: inherit;">é‚£é‡ŒæŸ¥æ‰¾å¤–è§‚</font></font><code>'still waiting for'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¥½å§ï¼Œä¸€æ—¦è¯¥çº¿ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬å°±ä¼šè°ƒç”¨...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è§£æè¯·æ±‚</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
lasï¼Œæ—¥å¿—ä¸­çš„é˜»å¡å¯¹è±¡ç»ä¸æ˜¯å¯¼è‡´å†²çªçš„èµ„æºã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°è¯•å¹¶è¡Œåˆ›å»ºç›¸åŒåç§°çš„ç´¢å¼•ï¼Œåˆ™logä¸­åªä¼šå‡ºç°ç±»ä¼¼çš„å†…å®¹</font></font><code>still waiting for ExclusiveLock on transaction 12345</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œ</font><font style="vertical-align: inherit;">å¯¹äºæˆ‘ä»¬æ„Ÿå…´è¶£çš„è¿‡ç¨‹</font><font style="vertical-align: inherit;">ï¼Œæˆ‘ä»¬å°†å¿…é¡»</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»æ•°æ®åº“ä¸­åˆ é™¤æ‰€æœ‰é”çš„çŠ¶æ€</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä»…å…³äºä¸€å¯¹æµç¨‹ï¼ˆè°é”å®šäº†è°/è°æœŸæœ›å®ƒï¼‰çš„ä¿¡æ¯æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºäº¤æ˜“ä¹‹é—´ç»å¸¸å­˜åœ¨å¯¹ä¸åŒèµ„æºçš„æœŸæœ›â€œé“¾â€ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs">tx1 [resA] -&gt; tx2 [resA]<font></font>
tx2 [resB] -&gt; tx3 [resB]<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç»å…¸ï¼šâ€œèåœçš„ç¥–çˆ¶ï¼Œç¥–çˆ¶çš„ç¥–æ¯ï¼Œç¥–æ¯çš„ç¥–æ¯â€¦â€¦â€ </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªè¯·æ±‚ï¼Œè¯¥è¯·æ±‚å°†å‘Šè¯‰æˆ‘ä»¬ç¡®åˆ‡çš„åŸå› æ˜¯è°æˆä¸ºç‰¹å®šPIDçš„æ•´ä¸ªé”é“¾æ•…éšœçš„æ ¹æœ¬åŸå› ï¼š</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> lm <span class="hljs-keyword">AS</span> (
<span class="hljs-comment">-- lock modes</span>
  <span class="hljs-keyword">SELECT</span><font></font>
    rn<font></font>
  , <span class="hljs-keyword">CASE</span>
      <span class="hljs-keyword">WHEN</span> lm &lt;&gt; <span class="hljs-string">'Share'</span> <span class="hljs-keyword">THEN</span> row_number() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> lm &lt;&gt; <span class="hljs-string">'Share'</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rn)
    <span class="hljs-keyword">END</span> rx<font></font>
  , lm || <span class="hljs-string">'Lock'</span> lm
  <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span>
      row_number() <span class="hljs-keyword">OVER</span>() rn<font></font>
    , lm<font></font>
    <span class="hljs-keyword">FROM</span>
      <span class="hljs-keyword">unnest</span>(
        <span class="hljs-built_in">ARRAY</span>[
          <span class="hljs-string">'AccessShare'</span>
        , <span class="hljs-string">'RowShare'</span>
        , <span class="hljs-string">'RowExclusive'</span>
        , <span class="hljs-string">'ShareUpdateExclusive'</span>
        , <span class="hljs-string">'Share'</span>
        , <span class="hljs-string">'ShareRowExclusive'</span>
        , <span class="hljs-string">'Exclusive'</span>
        , <span class="hljs-string">'AccessExclusive'</span><font></font>
        ]<font></font>
      ) T(lm)<font></font>
  ) T<font></font>
)<font></font>
<span class="hljs-comment">-- lock types</span>
, lt <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span>
    row_number() <span class="hljs-keyword">OVER</span>() rn<font></font>
  , lt<font></font>
  <span class="hljs-keyword">FROM</span>
    <span class="hljs-keyword">unnest</span>(
      <span class="hljs-built_in">ARRAY</span>[
        <span class="hljs-string">'relation'</span>
      , <span class="hljs-string">'extend'</span>
      , <span class="hljs-string">'page'</span>
      , <span class="hljs-string">'tuple'</span>
      , <span class="hljs-string">'transactionid'</span>
      , <span class="hljs-string">'virtualxid'</span>
      , <span class="hljs-string">'object'</span>
      , <span class="hljs-string">'userlock'</span>
      , <span class="hljs-string">'advisory'</span>
      , <span class="hljs-string">''</span><font></font>
      ]<font></font>
    ) T(lt)<font></font>
)<font></font>
<span class="hljs-comment">-- lock modes conflicts</span>
, lmx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    lr.rn lrn<font></font>
  , lr.rx lrx<font></font>
  , lr.lm lr<font></font>
  , ld.rn ldn<font></font>
  , ld.rx ldx<font></font>
  , ld.lm ld<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    lm lr<font></font>
  <span class="hljs-keyword">JOIN</span>
    lm ld <span class="hljs-keyword">ON</span>
      ld.rx &gt; (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(rx) <span class="hljs-keyword">FROM</span> lm) - lr.rx <span class="hljs-keyword">OR</span><font></font>
      (<font></font>
        (lr.rx = ld.rx) <span class="hljs-keyword">IS</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">AND</span>
        (lr.rx, ld.rx) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>) <span class="hljs-keyword">AND</span>
        ld.rn &gt;= (<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">max</span>(rn) <span class="hljs-keyword">FROM</span> lm) - lr.rn<font></font>
      )<font></font>
)<font></font>
<span class="hljs-comment">-- locked targets/pids</span>
, lcx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
    (lr.locktype, lr.database, lr.relation, lr.page, lr.tuple, lr.virtualxid, lr.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lr.classid, lr.objid, lr.objsubid) target<font></font>
  , ld.pid  ldp<font></font>
  , ld.mode ldm<font></font>
  , lr.pid  lrp<font></font>
  , lr.mode lrm<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_locks ld<font></font>
  <span class="hljs-keyword">JOIN</span>
    pg_locks lr <span class="hljs-keyword">ON</span>
      lr.pid &lt;&gt; ld.pid <span class="hljs-keyword">AND</span>
      (lr.locktype, lr.database, lr.relation, lr.page, lr.tuple, lr.virtualxid, lr.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lr.classid, lr.objid, lr.objsubid) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> (ld.locktype, ld.database, ld.relation, ld.page, ld.tuple, ld.virtualxid, ld.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, ld.classid, ld.objid, ld.objsubid) <span class="hljs-keyword">AND</span>
      (lr.granted, ld.granted) = (<span class="hljs-literal">TRUE</span>, <span class="hljs-literal">FALSE</span>)
  <span class="hljs-keyword">JOIN</span>
    lmx <span class="hljs-keyword">ON</span><font></font>
      (lmx.lr, lmx.ld) = (lr.mode, ld.mode)<font></font>
  <span class="hljs-keyword">WHERE</span>
    (ld.pid, ld.granted) = ($<span class="hljs-number">1</span>::<span class="hljs-built_in">integer</span>, <span class="hljs-literal">FALSE</span>) <span class="hljs-comment">-- PID</span><font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  lc.locktype <span class="hljs-string">"type"</span>
, <span class="hljs-keyword">CASE</span> lc.locktype
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'extend'</span>        <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'page'</span>          <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation, page]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span>         <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[relation, page, tuple]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[transactionid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'virtualxid'</span>    <span class="hljs-keyword">THEN</span> regexp_split_to_array(virtualxid::<span class="hljs-built_in">text</span>, <span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'object'</span>        <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'userlock'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'advisory'</span>      <span class="hljs-keyword">THEN</span> <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
  <span class="hljs-keyword">END</span> target<font></font>
, lc.pid = lcx.ldp <span class="hljs-string">"locked"</span><font></font>
, lc.pid<font></font>
, regexp_replace(lc.mode, <span class="hljs-string">'Lock$'</span>, <span class="hljs-string">''</span>) <span class="hljs-string">"mode"</span><font></font>
, lc.granted<font></font>
, (lc.locktype, lc.database, lc.relation, lc.page, lc.tuple, lc.virtualxid, lc.transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span>, lc.classid, lc.objid, lc.objsubid) <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> lcx.target <span class="hljs-string">"conflict"</span>
<span class="hljs-keyword">FROM</span><font></font>
  lcx<font></font>
<span class="hljs-keyword">JOIN</span>
  pg_locks lc <span class="hljs-keyword">ON</span>
    lc.pid <span class="hljs-keyword">IN</span> (lcx.ldp, lcx.lrp);
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é—®é¢˜1-å¯åŠ¨ç¼“æ…¢</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æ‚¨ä»æ—¥å¿—ç¤ºä¾‹ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼Œåœ¨è¡¨ç¤ºå‘ç”Ÿé”å®šçš„</font></font><code>LOG</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¡Œï¼ˆ</font></font><code>DETAIL, CONTEXT, STATEMENT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼‰</font><font style="vertical-align: inherit;">æ—è¾¹</font><font style="vertical-align: inherit;">ï¼Œè¿˜æœ‰3è¡Œï¼ˆ</font><font style="vertical-align: inherit;">ï¼‰æŠ¥å‘Šæ‰©å±•ä¿¡æ¯ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘ä»¬ç­‰å¾…æ‰€æœ‰4ä¸ªæ¡ç›®çš„å®Œæ•´â€œåŒ…â€çš„å½¢æˆï¼Œç„¶åæ‰è½¬å‘æ•°æ®åº“ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œåªæœ‰åœ¨ä¸‹ä¸€ä¸ªï¼ˆå·²ç»æ˜¯ç¬¬5ä¸ªï¼ï¼‰è®°å½•åˆ°è¾¾æ—¶ï¼Œä»¥åŠå¦ä¸€ä¸ªè¿‡ç¨‹çš„è¯¦ç»†ä¿¡æ¯æˆ–é€šè¿‡è¶…æ—¶ï¼Œæˆ‘ä»¬æ‰èƒ½å®Œæˆç¨‹åºåŒ…çš„å½¢æˆã€‚</font><font style="vertical-align: inherit;">æ˜¾ç„¶ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹éƒ½ä¼šå¼•èµ·ä¸å¿…è¦çš„ç­‰å¾…ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºäº†æ¶ˆé™¤è¿™äº›å»¶è¿Ÿï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ°</font><font style="vertical-align: inherit;">é”</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®°å½•çš„æµå¤„ç†</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ä¹Ÿå°±æ˜¯è¯´ï¼Œç°åœ¨æˆ‘ä»¬</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¯¹ç¬¬ä¸€æ¡è®°å½•è¿›è¡Œæ’åºåç«‹å³</font><b><font style="vertical-align: inherit;">è½¬å‘ç›®æ ‡æ•°æ®åº“</font></b><font style="vertical-align: inherit;">ï¼Œå¹¶æ„è¯†åˆ°è¿™å°±æ˜¯æ­¤å¤„æè¿°çš„é”ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é—®é¢˜2-è¦æ±‚ç¼“æ…¢</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯ï¼Œæœ‰äº›é”æ²¡æœ‰æ—¶é—´è¿›è¡Œåˆ†æã€‚</font><font style="vertical-align: inherit;">ä»–ä»¬å¼€å§‹æ›´æ·±å…¥åœ°ç ”ç©¶-å‘ç°åœ¨æŸäº›æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬çš„åˆ†æè¯·æ±‚æ‰§è¡Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">äº†15-20ms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åŸå› å¾ˆæ™®é-åŸºåœ°ä¸Šçš„æ´»åŠ¨é”æ€»æ•°è¾¾åˆ°å‡ åƒä¸ªï¼š</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/sp/ex/lkspexwtgdfrqhmh3siwsnx_s30.png"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_locks</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™é‡Œåº”è¯¥æ³¨æ„çš„æ˜¯ï¼ŒPostgreSQLä¸­çš„é”å¹¶ä¸â€œå­˜å‚¨â€åœ¨ä»»ä½•åœ°æ–¹ï¼Œè€Œæ˜¯ä»…åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç³»ç»Ÿè§†å›¾pg_locksä¸­æ˜¾ç¤º</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œè¿™ç›´æ¥åæ˜ äº†è¯¥å‡½æ•°</font></font><code>pg_lock_status</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">æ ¹æ®æˆ‘ä»¬çš„è¦æ±‚ï¼Œ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬é˜…è¯»äº†ä¸‰é</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼</font><font style="vertical-align: inherit;">åŒæ—¶ï¼Œæˆ‘ä»¬è¯»å–äº†æˆåƒä¸Šä¸‡ä¸ªé”å®ä¾‹ï¼Œå¹¶ä¸¢å¼ƒäº†ä¸PIDæ— å…³çš„é‚£äº›å®ä¾‹ï¼Œé”æœ¬èº«è®¾æ³•â€œè§£æâ€äº†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è§£å†³æ–¹æ¡ˆæ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨CTEä¸­â€œç‰©åŒ–â€ pg_locksçš„çŠ¶æ€</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -åœ¨æ­¤ä¹‹åï¼Œæ‚¨å¯ä»¥å¤šæ¬¡è¿è¡Œå®ƒï¼Œå®ƒå·²ç»ä¸ä¼šæ”¹å˜ã€‚</font><font style="vertical-align: inherit;">æ­¤å¤–ï¼Œåœ¨ç ”ç©¶äº†ç®—æ³•ä¹‹åï¼Œå¯ä»¥å°†æ‰€æœ‰å†…å®¹å‡å°‘åˆ°ä»…ä¸¤æ¬¡æ‰«æã€‚</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åŠ¨åŠ›è¿‡å¤§</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è€Œä¸”ï¼Œå¦‚æœå†ä»”ç»†çœ‹ä¸€ä¸‹ä¸Šé¢çš„æŸ¥è¯¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°CTE </font></font><code>lm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¹¶</font></font><code>lmx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ²¡æœ‰ä»¥ä»»ä½•æ–¹å¼ä¸æ•°æ®ç»‘å®šï¼Œè€Œæ˜¯ç®€å•åœ°è®¡ç®—å‡º</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¨¡å¼é˜»å¡ä¹‹é—´</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å§‹ç»ˆå­˜åœ¨ç›¸åŒçš„â€œé™æ€â€çŸ©é˜µå®šä¹‰</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">å†²çª</font></a><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œè®©æˆ‘ä»¬å°†å…¶è®¾ç½®ä¸ºquality </font></font><code>VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">é—®é¢˜3-é‚»å±…</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯éƒ¨åˆ†é”ä»ç„¶è¢«è·³è¿‡ã€‚é€šå¸¸è¿™æ˜¯æ ¹æ®ä»¥ä¸‹æ–¹æ¡ˆå‘ç”Ÿçš„-æŸäººé˜»æ­¢äº†ä¸€ç§æµè¡Œçš„èµ„æºï¼Œå¹¶ä¸”</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‡ ä¸ªè¿‡ç¨‹</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿…é€Ÿå¹¶è¿…é€Ÿåœ°è·‘å…¥è¯¥èµ„æºæˆ–æ²¿é“¾è¿›ä¸€æ­¥å‘å±•</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç»“æœï¼Œæˆ‘ä»¬æ•è·äº†ç¬¬ä¸€ä¸ªPIDï¼Œåˆ°è¾¾äº†ç›®æ ‡æ•°æ®åº“ï¼ˆå¹¶ä¸”ä¸ºäº†ä¸ä½¿å®ƒè¿‡è½½ï¼Œæˆ‘ä»¬åªä¿ç•™äº†ä¸€ä¸ªè¿æ¥ï¼‰ï¼Œè¿›è¡Œäº†åˆ†æï¼Œè¿”å›ç»“æœï¼Œå¹¶è·å–äº†ä¸‹ä¸€ä¸ªPID ...ä½†æ˜¯åœ¨è¯¥æ•°æ®åº“ä¸Šï¼Œç”Ÿå‘½æ˜¯ä¸å€¼å¾—çš„ï¼Œå¹¶ä¸”PIDé”å®šï¼ƒ2å·²ç»æ¶ˆå¤±äº†ï¼</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬ä»ç„¶ä»è¯·æ±‚ä¸­çš„å¸¸è§„åˆ—è¡¨ä¸­è¿‡æ»¤é”ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åˆ†åˆ«è®¿é—®æ¯ä¸ªPIDçš„æ•°æ®åº“ï¼Ÿè®©æˆ‘ä»¬</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç«‹å³ä»æ•°æ®åº“ä¸­ç›´æ¥è·å–å†²çªè¿›ç¨‹çš„æ•´ä¸ªåˆ—è¡¨ï¼Œ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¹¶å°†å…¶é”åˆ†é…ç»™åœ¨æ‰§è¡Œè¯·æ±‚æœŸé—´æ‰è½çš„æ‰€æœ‰PIDï¼š</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">WITH</span> lm(ld, lr) <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">VALUES</span>
    (<span class="hljs-string">'AccessShareLock'</span>, <span class="hljs-string">'{AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'RowShareLock'</span>, <span class="hljs-string">'{ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'RowExclusiveLock'</span>, <span class="hljs-string">'{ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareUpdateExclusiveLock'</span>, <span class="hljs-string">'{ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareLock'</span>, <span class="hljs-string">'{RowExclusiveLock,ShareUpdateExclusiveLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ShareRowExclusiveLock'</span>, <span class="hljs-string">'{RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'ExclusiveLock'</span>, <span class="hljs-string">'{RowShareLock,RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
  , (<span class="hljs-string">'AccessExclusiveLock'</span>, <span class="hljs-string">'{AccessShareLock,RowShareLock,RowExclusiveLock,ShareUpdateExclusiveLock,ShareLock,ShareRowExclusiveLock,ExclusiveLock,AccessExclusiveLock}'</span>::<span class="hljs-built_in">text</span>[])<font></font>
)<font></font>
, locks <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    (<font></font>
      locktype<font></font>
    , <span class="hljs-keyword">database</span><font></font>
    , relation<font></font>
    , page<font></font>
    , tuple<font></font>
    , virtualxid<font></font>
    , transactionid::<span class="hljs-built_in">text</span>::<span class="hljs-built_in">bigint</span><font></font>
    , classid<font></font>
    , objid<font></font>
    , objsubid<font></font>
    ) target<font></font>
  , *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    pg_locks<font></font>
)<font></font>
, ld <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    locks<font></font>
  <span class="hljs-keyword">WHERE</span>
    <span class="hljs-keyword">NOT</span> granted<font></font>
)<font></font>
, lr <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span><font></font>
    *<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    locks<font></font>
  <span class="hljs-keyword">WHERE</span>
    target::<span class="hljs-built_in">text</span> = <span class="hljs-keyword">ANY</span>(<span class="hljs-built_in">ARRAY</span>(
      <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span>
        target::<span class="hljs-built_in">text</span>
      <span class="hljs-keyword">FROM</span><font></font>
        ld<font></font>
    )) <span class="hljs-keyword">AND</span><font></font>
    granted<font></font>
)<font></font>
, lcx <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span><font></font>
    lr.target<font></font>
  , ld.pid ldp<font></font>
  , ld.mode ldm<font></font>
  , lr.pid lrp<font></font>
  , lr.mode lrm<font></font>
  <span class="hljs-keyword">FROM</span><font></font>
    ld<font></font>
  <span class="hljs-keyword">JOIN</span><font></font>
    lr<font></font>
      <span class="hljs-keyword">ON</span> lr.pid &lt;&gt; ld.pid <span class="hljs-keyword">AND</span>
        lr.target <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> ld.target<font></font>
)<font></font>
<span class="hljs-keyword">SELECT</span>
  lc.locktype <span class="hljs-string">"type"</span>
, <span class="hljs-keyword">CASE</span> lc.locktype
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'relation'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'extend'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'page'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation, page]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'tuple'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[relation, page, tuple]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'transactionid'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[transactionid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'virtualxid'</span> <span class="hljs-keyword">THEN</span>
      regexp_split_to_array(virtualxid::<span class="hljs-built_in">text</span>, <span class="hljs-string">'/'</span>)
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'userlock'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid::<span class="hljs-built_in">text</span>]
    <span class="hljs-keyword">WHEN</span> <span class="hljs-string">'advisory'</span> <span class="hljs-keyword">THEN</span>
      <span class="hljs-built_in">ARRAY</span>[classid, objid, objsubid]::<span class="hljs-built_in">text</span>[]
  <span class="hljs-keyword">END</span> target<font></font>
, lc.pid = lcx.ldp <span class="hljs-keyword">as</span> <span class="hljs-keyword">locked</span><font></font>
, lc.pid<font></font>
, regexp_replace(lc.mode, <span class="hljs-string">'Lock$'</span>, <span class="hljs-string">''</span>) <span class="hljs-string">"mode"</span><font></font>
, lc.granted<font></font>
, lc.target <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> lcx.target <span class="hljs-keyword">as</span> conflict
<span class="hljs-keyword">FROM</span><font></font>
  lcx<font></font>
<span class="hljs-keyword">JOIN</span><font></font>
  locks lc<font></font>
    <span class="hljs-keyword">ON</span> lc.pid <span class="hljs-keyword">IN</span> (lcx.ldp, lcx.lrp);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰æ—¶é—´åˆ†æç”šè‡³</font><font style="vertical-align: inherit;">è¿›å…¥æ—¥å¿—å</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»…1-2 ms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„é”</font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ†æä¸€ä¸‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…¶å®ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦èŠ±è¿™ä¹ˆé•¿æ—¶é—´ï¼Ÿ</font><font style="vertical-align: inherit;">ç»“æœæ˜¯ä»€ä¹ˆç»™æˆ‘ä»¬ï¼Ÿ</font></font><br>
<br>
<pre><code class="plaintext hljs">type     | target                  | locked | pid    | mode        | granted | conflict<font></font>
---------------------------------------------------------------------------------------<font></font>
relation | {225388639}             | f      | 216547 | AccessShare | t       | f<font></font>
relation | {423576026}             | f      | 216547 | AccessShare | t       | f<font></font>
advisory | {225386226,194303167,2} | t      |  24964 | Exclusive   | f       | t<font></font>
relation | {341894815}             | t      |  24964 | AccessShare | t       | f<font></font>
relation | {416441672}             | f      | 216547 | AccessShare | t       | f<font></font>
relation | {225964322}             | f      | 216547 | AccessShare | t       | f<font></font>
...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨æœ¬å›¾ä¸­ï¼Œ</font></font><code>target</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¸¦æœ‰ç±»å‹çš„</font><font style="vertical-align: inherit;">å€¼å¯¹æˆ‘ä»¬å¾ˆæœ‰ç”¨</font></font><code>relation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œå› ä¸ºæ¯ä¸ªè¿™æ ·çš„å€¼éƒ½æ˜¯</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¡¨æˆ–ç´¢å¼•</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çš„</font><b><font style="vertical-align: inherit;">OID</font></b><font style="vertical-align: inherit;">ã€‚</font><font style="vertical-align: inherit;">ç°åœ¨åªå‰©ä¸‹å¾ˆå°‘çš„ä¸œè¥¿äº†-å­¦ä¹ å¦‚ä½•ä¸ºæˆ‘ä»¬ä»ç„¶æœªçŸ¥çš„OIDè¯¢é—®æ•°æ®åº“ï¼Œä»¥ä¾¿å°†å®ƒä»¬è½¬æ¢ä¸ºäººç±»å¯è¯»çš„å½¢å¼ï¼š</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> $<span class="hljs-number">1</span>::<span class="hljs-keyword">oid</span>::regclass;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼ŒçŸ¥é“äº†é”çš„å®Œæ•´â€œçŸ©é˜µâ€ä»¥åŠæ¯ä¸ªäº‹åŠ¡å°†å®ƒä»¬å åŠ åœ¨å…¶ä¸Šçš„æ‰€æœ‰å¯¹è±¡ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¾—å‡ºç»“è®ºâ€œå‘ç”Ÿäº†</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä»€ä¹ˆ</font><b><font style="vertical-align: inherit;">â€ï¼Œ</font></b><font style="vertical-align: inherit;">ä»¥åŠæ˜¯ä»€ä¹ˆèµ„æºå¯¼è‡´äº†å†²çªï¼Œå³ä½¿è¯·æ±‚è¢«é˜»æ­¢ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¸ºæ‰€çŸ¥ã€‚</font><font style="vertical-align: inherit;">ä¾‹å¦‚ï¼Œå½“é˜»å¡è¯·æ±‚çš„æ‰§è¡Œæ—¶é—´ä¸è¶³ä»¥åˆ°è¾¾æ—¥å¿—ï¼Œä½†äº‹åŠ¡åœ¨å®Œæˆåä»å¤„äºæ´»åŠ¨çŠ¶æ€å¹¶é•¿æ—¶é—´äº§ç”Ÿé—®é¢˜æ—¶ï¼Œåˆ™å¾ˆå®¹æ˜“å‘ç”Ÿè¿™ç§æƒ…å†µã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4m/4m/j7/4m4mj7nqgpeoxe13qoldzrmhhr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯å…³äºè¿™ä¸€ç‚¹-åœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">â€œå…¨éƒ¨é è‡ªå·±â€</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åŒæ—¶ï¼Œæˆ‘ä»¬å°†æ”¶é›†å®Œæ•´ç‰ˆæœ¬çš„â€œç›‘è§†â€ï¼Œä¸€æ—¦æ—¥å¿—ä¸­å‡ºç°å¯ç–‘å†…å®¹ï¼Œå®ƒå°†è‡ªåŠ¨åˆ é™¤å­˜æ¡£çš„é”çŠ¶æ€ï¼š</font></font><br>
<br>
<pre><code class="bash hljs">ps uw -U postgres \<font></font>
  | grep [l]ogger \<font></font>
  | awk <span class="hljs-string">'{print "/proc/"$2"/fd"}'</span> \<font></font>
  | xargs ls -l \<font></font>
  | grep `<span class="hljs-built_in">cd</span>; psql -U postgres postgres -t -A -c <span class="hljs-string">"SELECT CASE WHEN substr(current_setting('log_directory'), 1, 1) = '/' THEN current_setting('log_directory') ELSE current_setting('data_directory') || '/' || current_setting('log_directory') END"</span>` \<font></font>
  | awk <span class="hljs-string">'{print $NF}'</span> \<font></font>
  | xargs -l -I{} tail -f {} \<font></font>
  | stdbuf -o0 grep <span class="hljs-string">'still waiting for'</span> \<font></font>
  | xargs -l -I{} date <span class="hljs-string">'+%Y%m%d-%H%M%S.%N'</span> \<font></font>
  | xargs -l -I{} psql -U postgres postgres -f detect-lock.sql -o {}-lock.log<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç„¶å</font></font><code>detect-lock.sql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ”¾åœ¨æœ€åä¸€ä¸ªè¯·æ±‚ã€‚</font><font style="vertical-align: inherit;">è¿è¡Œ-å¹¶åœ¨å…¶ä¸­è·å¾—ä¸€å †åŒ…å«æ‰€éœ€å†…å®¹çš„æ–‡ä»¶ï¼š</font></font><br>
<br>
<pre><code class="plaintext hljs"># cat 20200526-181433.331839375-lock.log<font></font>
     type      |     target     | locked |  pid   |     mode     | granted | conflict<font></font>
---------------+----------------+--------+--------+--------------+---------+----------<font></font>
 relation      | {279588430}    | t      | 136325 | RowExclusive | t       | f<font></font>
 relation      | {279588422}    | t      | 136325 | RowExclusive | t       | f<font></font>
 relation      | {17157}        | t      | 136325 | RowExclusive | t       | f<font></font>
 virtualxid    | {110,12171420} | t      | 136325 | Exclusive    | t       | f<font></font>
 relation      | {279588430}    | f      |  39339 | RowExclusive | t       | f<font></font>
 relation      | {279588422}    | f      |  39339 | RowExclusive | t       | f<font></font>
 relation      | {17157}        | f      |  39339 | RowExclusive | t       | f<font></font>
 virtualxid    | {360,11744113} | f      |  39339 | Exclusive    | t       | f<font></font>
 virtualxid    | {638,4806358}  | t      |  80553 | Exclusive    | t       | f<font></font>
 advisory      | {1,1,2}        | t      |  80553 | Exclusive    | f       | t<font></font>
 advisory      | {1,1,2}        | f      |  80258 | Exclusive    | t       | t<font></font>
 transactionid | {3852607686}   | t      | 136325 | Exclusive    | t       | f<font></font>
 extend        | {279588422}    | t      | 136325 | Exclusive    | f       | t<font></font>
 extend        | {279588422}    | f      |  39339 | Exclusive    | t       | t<font></font>
 transactionid | {3852607712}   | f      |  39339 | Exclusive    | t       | f<font></font>
(15 rows)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¥½å§-åä¸‹æ¥åˆ†æ...</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN503668/index.html">åœ†å¹³æ–¹ï¼šè§†è§‰è¯æ®</a></li>
<li><a href="../zh-CN503670/index.html">Mac OSä¼šå˜æ…¢å—ï¼Ÿ-Catalinaåœ¨å¯åŠ¨æ—¶ä¼šé€šè¿‡Internetæ£€æŸ¥æ‰€æœ‰æœªç­¾åçš„ä»£ç </a></li>
<li><a href="../zh-CN503672/index.html">æ‚¨åœ¨å“ªä¸€è¾¹ï¼šæ¨å…¥å’Œæ‹‰å…¥æ‰€éœ€çŠ¶æ€é…ç½®</a></li>
<li><a href="../zh-CN503676/index.html">æå®¢éª„å‚²æ—¥çš„ä¸‰ä¸ªæå®¢é¡¹ç›®</a></li>
<li><a href="../zh-CN503678/index.html">Vuexç ´åå°è£…</a></li>
<li><a href="../zh-CN503682/index.html">Snomäº¤æ¢Aåˆ°Z</a></li>
<li><a href="../zh-CN503688/index.html">ä¹”å°”Â·æ–¯æ³¢æ–¯åŸºï¼ˆJoel Spolskyï¼‰ï¼šæˆä¸ºè½¯ä»¶å¼€å‘äººå‘˜æ„å‘³ç€ä»€ä¹ˆï¼ˆä»ç¼–ç äººå‘˜åˆ°å¼€å‘äººå‘˜çš„åºè¨€ï¼‰</a></li>
<li><a href="../zh-CN503690/index.html">Kubernetesæœ€ä½³å®è·µ Kubernetesé›¶åœæœºé›†ç¾¤å‡çº§</a></li>
<li><a href="../zh-CN503696/index.html">æˆ˜äº‰æœºå™¨ï¼šå½“æœºæ¢°æ¨¡æ‹Ÿè®¡ç®—æœºç»Ÿæ²»å¤§æµ·æ—¶</a></li>
<li><a href="../zh-CN503698/index.html">è¿œç¨‹è®°å¸-ä½œä¸ºä¸šåŠ¡æ”¶ç›Š</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>