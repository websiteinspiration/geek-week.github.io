<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚è™ üôçüèΩ üöñ We continue to analyze vulnerabilities of industrial switches: we execute arbitrary code without a password ‚åõÔ∏è üôéüèª ‚ôøÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Positive Research 2019, we reviewed the Moxa Industrial Switch Management Protocol. This time, we will continue this topic and analyze in detail th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We continue to analyze vulnerabilities of industrial switches: we execute arbitrary code without a password</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/493944/"><img src="https://habrastorage.org/webt/wk/gg/bb/wkggbbfxuzftoyyqhtjr0hh6x6o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Positive Research 2019, we reviewed the Moxa Industrial Switch Management Protocol. </font><font style="vertical-align: inherit;">This time, we will continue this topic and analyze in detail the vulnerability CVE-2018-10731 in the Phoenix Contact switches of the FL SWITCH 3xxx, FL SWITCH 4xxx, and FL SWITCH 48xx line models identified by our experts. </font><font style="vertical-align: inherit;">This vulnerability, detected in the device‚Äôs web interface, allows arbitrary code to be executed without knowing the device‚Äôs credentials and is rated at 9 out of 10 on the CVSS version 3 scale.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First look</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The devices mentioned above are running Linux, and you can use the web interface to configure them. As with many other IoT devices, domestic and industrial, the web interface consists of many CGI applications that process user HTTP requests. In our case, CGI applications actively use the cgic library, which facilitates working with HTTP requests, and the functions of this library are built into the shared library </font></font><code>libipinfusionweb.so</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">located in the device‚Äôs file system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When processing an HTTP request, the web server passes the user request data to the CGI application as a set of environment variables. Their initial processing is performed by the </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">library </font><font style="vertical-align: inherit;">function </font></font><code>libipinfusionweb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Next, the function </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calls the function of the </font></font><code>cgiMain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CGI application, in which the further processing of the request takes place.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eu/hm/yd/euhmydlkhy2r76pkvmiurftmv3a.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 1. Processing an HTTP request</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In the course of its work, the main function of the library </font></font><code>libipinfusionweb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calls a function </font></font><code>get_login_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that determines whether the user has passed authentication on the system using the passed Cookie values. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/-a/tl/ra-atlrdqdebpr4qgh855ykd5f8.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2. Pseudo-code fragment of the main</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
function The function </font></font><code>get_login_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">receives the value of the Cookie parameter </font></font><code>c_session</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the function </font></font><code>cookies_get_value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and stores it in a variable </font></font><code>local_e0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The variable itself </font></font><code>local_e0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is an array of single-byte characters with a length of 0x80 and is located at a distance of 0xE0 from the beginning of the stack. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2s/m7/ti/2sm7tilkgmlwt5ahmjz742yonxu.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 3. Fragment of the pseudo-code of the get_login_user function</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
However, in the function code </font></font><code>cookies_get_value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it can be seen that the </font></font><code>cgiCookieString</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">value of the Cookie parameter </font><font style="vertical-align: inherit;">received by the function </font><font style="vertical-align: inherit;">has a maximum length of 0x400 bytes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jt/uz/xv/jtuzxvss3ihvfbtjp0vnq0ytr4c.png"><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 4. A fragment of the pseudo-code of the cookie_get_value function</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Thus, when passing a Cookie parameter longer than 0xE0 (224) characters, the function will </font></font><code>get_login_user</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">save the value of this parameter to its stack, as a result of which all information on the stack that is behind the variable </font></font><code>local_e0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be overwritten, including the address return function.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: When one function calls another, the return address is stored on the stack. </font><font style="vertical-align: inherit;">Control is transferred to this address when the called function finishes its work. </font><font style="vertical-align: inherit;">Accordingly, if you rewrite this address, you can gain control over the program execution process. </font><font style="vertical-align: inherit;">For example, an attacker can replace this address with the address of a malicious shellcode located in the address space of the program.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note that the rewrite of the return address occurs before authentication is verified, which makes it possible to exploit this vulnerability to an attacker who does not know the credentials of the device.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exploitation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We examined several options for demonstrating the possibility of exploiting this vulnerability. The simplest thing is to write the payload code onto the stack (0x400 - 0xE0 = 800 bytes remains for it, it‚Äôs enough for the code) and rewrite the return address with the code address. Theoretically, this option was possible, since the processor of the vulnerable switch does not support the NX-bit function (that is, it allows the execution of code located anywhere, including on the stack), but in practice it had serious limitations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The vulnerable switch processor has an MIPS architecture; many of the processor instructions in this architecture are encoded in byte sequences containing zero bytes. The buffer contents are written down to the first zero byte (due to the use of the function</font></font><code>strcpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), therefore, it is only necessary to use operands that do not contain a null byte, which is impossible, since any payload would use at least several of these bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When constructing the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROP chain,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> again, we would have to face the restrictions of the null byte: the address of the ROP gadgets should not contain zeros, which greatly complicates their search. By and large, we could only use one zero, copied by the strcpy function. This imposes a limitation on the creation of a full-fledged ROP chain, and in addition to this, the gadgets we needed were extremely few. However, during searches in the libipinfusionweb library, the following code fragment was found: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/am/xs/u5/amxsu5zw9x3p9-0tfzjtu-geal8.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 5. A fragment of the libipinfusionweb library's executable code</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Provided that the contents of the register $ s0 are controlled, this code fragment allows you to execute an OS command using a function </font></font><code>mysystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(initially this function did not have a name, but we renamed it, since it is very similar to the Linux system function). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we are rewriting the return address from the get_login_user function, this function will be executed to the end. In the epilogue of the get_login_user function, you can see that the value of the register $ s0 is restored from the previously saved value on the stack (at offset 0xD8 from the top of the stack). However, at this point, this area of ‚Äã‚Äãthe stack is already under our control, that is, in fact, we can achieve control over the contents of the register $ s0 and thus execute arbitrary OS commands using the function </font></font><code>mysystem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e3/k7/d9/e3k7d9mryjtpuojvi62ho7weooy.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 6. A snippet of the get_login_user function executable code</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Thus, in order to successfully demonstrate the exploitation of this vulnerability, we need to send as a parameter a </font></font><code>Cookie c_session</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">long line containing:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS string command, which will be subsequently passed to the mysystem function;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the address of this command on the stack;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new return address (address of the code fragment shown in Fig. 5).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The final payload should look like this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uz/zv/xp/uzzvxpf4lv9zws3zpnmjgdzqcyq.png"><br>
 <br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 7. Payload</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
At this point, we already had a shell on the device obtained using a vulnerability that needed administrator rights to operate. </font><font style="vertical-align: inherit;">Therefore, we were able to obtain additional information that helped us to operate:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASLR on the device under study was disabled - therefore, the addresses of the gadget used and the OS commands will always be the same.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/wi/84/v3/wi84v3-p-susaji9zxkzat8yrdq.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 8. ASLR status on the device under investigation</font></font></i><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The range of memory addresses in which the stack could lie. </font><font style="vertical-align: inherit;">To calculate the exact address, we went over all the addresses in this range.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a payload, we implemented the download of a web shell, a CGI application with the following contents:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">eval</span> <span class="hljs-variable">$HTTP_CMD</span> 2&gt;&amp;1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since, according to the CGI protocol, the contents of the HTTP headers are transmitted to the CGI application in the form of environment variables with the names HTTP_ &lt;Header Name&gt;, this shell </font></font><code>eval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will </font><font style="vertical-align: inherit;">use the command </font><font style="vertical-align: inherit;">to execute the contents of the CMD HTTP header. </font><font style="vertical-align: inherit;">The figure below shows the result of the successful operation and execution of the ls command using the loaded shell. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/az/lp/um/azlpumbjd1xgx9r6q3xqhihtiqy.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 9. The result of the successful operation and execution of the ls command</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have demonstrated the ability to exploit this vulnerability. </font><font style="vertical-align: inherit;">As we already mentioned, its operation does not require knowledge of the password, and therefore can be performed even by an unauthenticated attacker. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hacking an industrial network switch can compromise the entire production. </font><font style="vertical-align: inherit;">Violation of network interaction can adversely affect the process until it stops completely. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Information about the vulnerability and PoC were transmitted to the vendor, who released the updated firmware version 1.34, and the identifier CVE-2018-10731 was assigned to the vulnerability itself.</font></font><br>
<br>
<blockquote><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looking for a person</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you have a desire to do such things, we are just looking for a specialist in our team. </font><font style="vertical-align: inherit;">We are engaged in security analysis of process control systems (large industrial / energy / transport facilities, etc.). </font><font style="vertical-align: inherit;">On each project, we look for ways to stop or disrupt the operation of these objects. </font><font style="vertical-align: inherit;">Each time we find many ways to influence the manufacturing process, exploring industrial hardware and software, analyzing proprietary network protocols. </font><font style="vertical-align: inherit;">We find and report a lot of zirodey, write reports (not according to GOST) and do much more. </font><font style="vertical-align: inherit;">When there is time, we speak at IB and not only conferences. </font><font style="vertical-align: inherit;">Link to the vacancy: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hh.ru/vacancy/36371389</font></font></a></blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Posted by</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vyacheslav Moskvin, Positive Technologies</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493932/index.html">Overview of Google Surveys. Why it is not suitable for serious research</a></li>
<li><a href="../en493934/index.html">Who, how and on what explored the world's oceans - we analyze the NOAA bases</a></li>
<li><a href="../en493938/index.html">How to cut costs in AWS</a></li>
<li><a href="../en493940/index.html">Natural Coronavirus 2019-nCoV Treatment Protocol</a></li>
<li><a href="../en493942/index.html">Basic virus in 20 minutes or why you should use antivirus</a></li>
<li><a href="../en493948/index.html">How I made a KN95 respirator at home from improvised materials. detailed instructions</a></li>
<li><a href="../en493950/index.html">Neural network calculator for adding and subtracting not very large numbers</a></li>
<li><a href="../en493952/index.html">How to evaluate intelligence? Google approach</a></li>
<li><a href="../en493954/index.html">PostgreSQL Add not null constraints to large tables</a></li>
<li><a href="../en493960/index.html">Configuring an XPrinter Label Printer on Linux in VMware Workstation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>