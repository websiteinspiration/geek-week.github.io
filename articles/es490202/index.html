<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤟🏼 👩🏾 🔘 Recuento de consultas: pruebas de rendimiento básicas de Django 💾 ⛄️ 📑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos. Hemos preparado una traducción de otro material útil para los estudiantes del curso "Desarrollador web en Python" , que comenzó ayer.
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Recuento de consultas: pruebas de rendimiento básicas de Django</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/490202/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola a todos. </font><font style="vertical-align: inherit;">Hemos preparado una traducción de otro material útil para los estudiantes del curso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Desarrollador web en Python"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que comenzó ayer.</font></font><br>
</b></i><br>
<br>
<img src="https://habrastorage.org/webt/-i/l9/rg/-il9rgpfjconn-on4udsprg5vyi.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A menudo puede escuchar sobre métodos de prueba como TDD y cómo probar la lógica de negocios de una aplicación. Sin embargo, probar el rendimiento de la aplicación es una tarea completamente diferente. Hay muchas formas diferentes, pero el enfoque más común es crear un entorno en el que pueda realizar un ataque DDoS en su aplicación y observar su comportamiento. Este es un tema muy interesante, pero no es de lo que quiero hablar hoy. Hoy veremos una prueba más simple, una que puede hacer usando las pruebas unitarias Django predeterminadas: es decir, probar la cantidad de veces que su aplicación accede a la base de datos.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probar esto es muy simple, y este es exactamente el aspecto que puede dañar el rendimiento de la aplicación en las primeras etapas. Este aspecto es el primero en probarse cuando algo comienza a funcionar lentamente. La buena noticia es que solo hay una cosa que necesita saber para escribir pruebas de este tipo: el método </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClaimNumQueries</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y es bastante fácil de usar. Aquí hay un ejemplo:</font></font><br>
<br>
<pre><code class="django hljs"><span class="xml">from django.test import TestCase, Client
from django.urls import reverse
from trucks.models import Truck

class TrucksTestCase(TestCase):
    def test_list_trucks_view_performance(self):
        client = Client()

        Truck.objects.create(...)

        with self.assertNumQueries(6):
            response = client.get(reverse("trucks:list_trucks"))

        self.assertEqual(response.context["trucks_list"], 1)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El código anterior afirma que durante la vista, la </font></font><code>"trucks:list_trucks"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aplicación accederá a la base de datos solo 6 veces. Pero hay algo más, tenga en cuenta que antes de comenzar, primero creamos un nuevo objeto </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y después de eso decimos que </font></font><code>trucks_list</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hay al menos un objeto </font><font style="vertical-align: inherit;">en los datos de contexto de la vista </font><font style="vertical-align: inherit;">. En este tipo de pruebas, esto es importante, porque necesita una garantía de que no está probando en un conjunto de datos vacío. Es importante comprender que simplemente crear instancias de una clase </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no </font><font style="vertical-align: inherit;">es </font><font style="vertical-align: inherit;">suficiente. Debe verificar si se ha incluido en el contexto. Quizás esté filtrando la lista de camiones, por lo que es probable que su instancia </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no se incluya en el resultado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habiendo hecho todo lo anterior, ya hemos logrado un progreso significativo, pero hay otro paso importante que es fácil de olvidar. Si queremos que nuestras vistas se escalen, debemos asegurarnos de que el rendimiento no disminuya a medida que aumenta el número de artículos devueltos. Al final, todavía tenemos un problema de rendimiento si recurrimos a la base de datos no 6 veces para obtener un elemento, sino 106 si tenemos 100 elementos. Necesitamos un número constante de llamadas a la base de datos, que no dependerá del número de artículos devueltos. Afortunadamente, este problema también se resuelve de manera muy simple, necesitamos agregar uno más (o varios) elementos a la base de datos y nuevamente contar el número de visitas. Así se verá la prueba en la versión final:</font></font><br>
<br>
<pre><code class="django hljs"><span class="xml">from django.test import TestCase, Client
from django.urls import reverse
from trucks.models import Truck

class TrucksTestCase(TestCase):
    def test_list_trucks_view_performance(self):
        client = Client()

        Truck.objects.create(...)

        with self.assertNumQueries(6):
            response = client.get(reverse("trucks:list_trucks"))

        self.assertEqual(response.context["trucks_list"], 1)

        Truck.objects.create(...)

        with self.assertNumQueries(6):
            response = client.get(reverse("trucks:list_trucks"))

        self.assertEqual(response.context["trucks_list"], 2)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que nuevamente verificamos el número de artículos devueltos en el contexto, pero en la segunda ejecución esperamos 2 camiones ( </font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">La razón de este comportamiento es similar al primer caso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Asegurar un número constante de llamadas a la base de datos al agregar nuevos datos es más prioritario que garantizar un pequeño número de llamadas en general. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo último que debe hacer es asegurarse de que sus datos estén lo más hidratados posible. </font><font style="vertical-align: inherit;">Esto significa que debe crear datos relacionados que se utilizarán durante el procesamiento de su vista. </font><font style="vertical-align: inherit;">Si no lo hace, existe el riesgo de que su aplicación acceda a la base de datos con más frecuencia en producción que en la prueba (aunque puede tener éxito). </font><font style="vertical-align: inherit;">En nuestro ejemplo, necesitábamos crear </font></font><code>TruckDriver</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una empresa para nuestro</font></font><code>Truck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="django hljs"><span class="xml">from trucks.models import Truck, TruckDriver
...
        truck = Truck.objects.create(...)
        TruckDriver.objects.create(name="Alex", truck=truck)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si el número de llamadas a la base de datos ya no es constante después de realizar los pasos descritos anteriormente, busque más información sobre los métodos </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select_related</font></font></a> </i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prefetch_related</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es todo por hoy, espero que a partir de este momento comience a verificar el número de consultas de su aplicación a la base de datos al comienzo del proyecto. </font><font style="vertical-align: inherit;">Esto no llevará mucho tiempo, pero evitará los problemas que puedan surgir con el aumento en el número de usuarios de su aplicación. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por cierto, todavía puedes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tomar el curso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nos vemos.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es490186/index.html">De qué hicimos JET BI. Sistema de inteligencia de negocios de arquitectura sin digresiones líricas</a></li>
<li><a href="../es490190/index.html">Voy a buscar: posicionamiento geográfico de host por dirección IP en Internet global utilizando el intercambio de cifrado Binance como ejemplo</a></li>
<li><a href="../es490194/index.html">Usando RabbitMQ con MonsterMQ Parte 4</a></li>
<li><a href="../es490196/index.html">[Flipper Zero] rechaza Raspberry Pi, crea nuestra propia placa desde cero. Encontrar el chip WiFi correcto</a></li>
<li><a href="../es490198/index.html">¡Confiar pero verificar! Zona de demostración con proyectores Epson para cine en casa en la sala de demostración Pult.ru</a></li>
<li><a href="../es490204/index.html">El resumen de eventos para reclutadores de recursos humanos y TI en marzo de 2020</a></li>
<li><a href="../es490208/index.html">Sección de back-end en DUMP2020: bromas, ventilador, falla</a></li>
<li><a href="../es490210/index.html">Acelerando la interfaz. Cuando muchas solicitudes de servidor son buenas</a></li>
<li><a href="../es490222/index.html">Biblioteca estándar del día de la muerte</a></li>
<li><a href="../es490224/index.html">Sigilo de moda</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>