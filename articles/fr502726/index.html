<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏾‍🤝‍🧑🏻 👩🏼‍⚕️ 💃🏽 WebRTC Faire une application avec blackjack et appels vidéo ⚖️ 👇🏻 🌷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cher lecteur, avant de commencer à écrire le code, examinons le concept des appels vidéo. 
 
 Imaginez la situation: nous avons une plate-forme de cha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WebRTC Faire une application avec blackjack et appels vidéo</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502726/"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cher lecteur, avant de commencer à écrire le code, examinons le concept des appels vidéo. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginez la situation: nous avons une plate-forme de chat et nous devons y attacher des appels vidéo, c'est-à-dire qu'un certain Vasya est assis en ligne et qu'il veut appeler Petya, pour implémenter une telle fonctionnalité, nous avons besoin de la technologie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebSocket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, élevons notre serveur WebSocket, node.js nous aidera avec cela; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez le fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sockets.js</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et écrivez-y le code de socket du serveur:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> WebSocketServer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'websocket'</span>).server;
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request, response</span>) </span>{
 <span class="hljs-comment">//    ,    ,  http</span><font></font>
});<font></font>
server.listen(<span class="hljs-number">1337</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{});<font></font>
<font></font>
<span class="hljs-comment">//   </span>
<span class="hljs-keyword">const</span> wsServer = <span class="hljs-keyword">new</span> WebSocketServer({
  <span class="hljs-attr">httpServer</span>: server<font></font>
});<font></font>
<font></font>
wsServer.on(<span class="hljs-string">'request'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">request</span>) </span>{
  <span class="hljs-keyword">let</span> connection = request.accept(<span class="hljs-literal">null</span>, request.origin);
<span class="hljs-comment">//   </span><font></font>
})<font></font>
</code></pre><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez un fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">index.html</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et écrivez-y le code pour ouvrir une connexion socket:</font></font><br>
<br>
<pre><code class="xml hljs">     <span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">autoplay</span> <span class="hljs-attr">muted</span> <span class="hljs-attr">height</span>=<span class="hljs-string">'300'</span> <span class="hljs-attr">width</span>=<span class="hljs-string">'300'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position:fixed;bottom:0;left:0;z-index: 9999;"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'my'</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span> <span class="hljs-comment">&lt;!--   --&gt;</span> <font></font>
<font></font>
          <span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">autoplay</span> <span class="hljs-attr">height</span>=<span class="hljs-string">'300'</span> <span class="hljs-attr">width</span>=<span class="hljs-string">'300'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position:fixed;bottom:0;left:300px;z-index: 999999;"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">""</span> <span class="hljs-attr">id</span>=<span class="hljs-string">'not_my'</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span> <span class="hljs-comment">&lt;!--  --&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, créez et connectez le fichier </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script.js</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à notre fichier html:</font></font><br>
<br>
<pre><code class="javascript hljs">  <span class="hljs-keyword">let</span> connection = <span class="hljs-keyword">new</span> WebSocket(<span class="hljs-string">'ws://127.0.0.1:1337'</span>);<span class="hljs-comment">//   -</span>
  connection.onopen = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
<span class="hljs-comment">//  ,  -      </span><font></font>
 }<font></font>
connection.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>)</span>{
<span class="hljs-comment">//        </span><font></font>
<font></font>
<font></font>
}<font></font>
connection.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
        <span class="hljs-built_in">console</span>.error(error)
       <span class="hljs-comment">//  ,   </span><font></font>
      };<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Revenons donc à nos Vasya et Petya</font></font></h3><br>
<img src="https://habrastorage.org/webt/o7/et/no/o7etnouazbck9mntphu8zdom6ni.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit de l'étape initiale à laquelle Vasya et Petya échangent simplement JSON pour savoir si nous recevrons un appel ou non. C'est-à-dire que lorsque nous visitons notre page, nous devons ouvrir une connexion WebSocket pour communiquer avec notre serveur de socket. </font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous envoyons d'abord un casque au socket du serveur JSON afin que nous voulions appeler Petya depuis le compte de Vasya </font></font><br>
<br>
<pre><code class="javascript hljs">connection.send(<span class="hljs-built_in">JSON</span>.stringify({
<span class="hljs-comment">//  </span><font></font>
}))<font></font>
</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous devons accepter ce JSON sur le serveur de socket, après avoir reçu la demande, nous attachons l'événement de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">message</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> à notre serveur </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="javascript hljs">connection.on(<span class="hljs-string">'message'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>)</span>{
<span class="hljs-comment">//   message    ,     JSON  JS</span>
<span class="hljs-keyword">let</span> self = <span class="hljs-built_in">JSON</span>.parse(message.utf8Data);<font></font>
})<font></font>
</code></pre></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Après avoir parlé et décidé que les deux utilisateurs sont prêts pour une conversation, nous devons comprendre comment fonctionne la communication vidéo dans un navigateur, un module pour cela est construit en js - RTCPeerConnection</font></font></h3><br>
<img src="https://habrastorage.org/webt/05/z3/h4/05z3h4tof97q9_bctcnmhyz5vuq.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous devons ouvrir RTCPeerConnection, avec lequel nous pouvons générer une offre et l'envoyer à l'utilisateur dont nous avons besoin, à nouveau via notre serveur de socket, qui, à sa réception, générera une réponse et la renverra, après quoi nous commencerons à échanger des paquets de glace contenant des informations sur l'environnement cet ordinateur, qui est nécessaire pour la mise en place réussie des communications vidéo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous générons et envoyons une offre</font></font></h2><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> pc = <span class="hljs-keyword">new</span> RTCPeerConnection();<font></font>
            <font></font>
            <span class="hljs-keyword">var</span> peerConnectionConfig = {
              <span class="hljs-attr">iceServers</span>: [<font></font>
                  {<font></font>
                      <span class="hljs-attr">urls</span>: <span class="hljs-string">'stun:stun.l.google.com:19302'</span><font></font>
                  }<font></font>
                ]<font></font>
            }<font></font>
            pc.onicecandidate = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'new ice candidate'</span>, event.candidate);<font></font>
<font></font>
              <span class="hljs-keyword">if</span> (event.candidate !== <span class="hljs-literal">null</span>) {<font></font>
                connection.send(<span class="hljs-built_in">JSON</span>.stringify({
                 <span class="hljs-comment">// json  ice </span><font></font>
                }))<font></font>
              }<font></font>
          };<font></font>
<font></font>
            navigator.getUserMedia = navigator.getUserMedia ||<font></font>
                         navigator.webkitGetUserMedia ||<font></font>
                         navigator.mozGetUserMedia;<font></font>
                      <font></font>
<font></font>
            navigator.getUserMedia({<span class="hljs-attr">video</span>: <span class="hljs-literal">true</span>,<span class="hljs-attr">audio</span>:<span class="hljs-literal">true</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">stream</span>) </span>{
              <span class="hljs-comment">//      onaddstream  ,</span>
              <span class="hljs-comment">//    .</span>
            <span class="hljs-keyword">var</span> my_video = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'my'</span>)<font></font>
            my_video.srcObject = stream<font></font>
<font></font>
              pc.onaddstream = <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
                <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'not_my'</span>).srcObject = e.stream;
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'not stream is added'</span>)<font></font>
              }<font></font>
              pc.addStream(stream);   <font></font>
            <font></font>
              pc.createOffer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">offer</span>) </span>{<font></font>
                pc.setLocalDescription(offer, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                  <span class="hljs-comment">//  offer  </span><font></font>
                  }))<font></font>
                }, e=&gt; <span class="hljs-built_in">console</span>.log(e));<font></font>
              }, e=&gt; <span class="hljs-built_in">console</span>.log(e));<font></font>
            },<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span>{<span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"Error getting audio stream from getUserMedia"</span>)});<font></font>
<font></font>
            <span class="hljs-comment">//  </span>
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">endCall</span>(<span class="hljs-params"></span>) </span>{
              <span class="hljs-keyword">var</span> videos = <span class="hljs-built_in">document</span>.getElementsByTagName(<span class="hljs-string">"video"</span>);
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; videos.length; i++) {<font></font>
                videos[i].pause();<font></font>
              }<font></font>
            <font></font>
              pc.close();<font></font>
            }<font></font>
<font></font>
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">error</span>(<span class="hljs-params">err</span>) </span>{<font></font>
              endCall();<font></font>
            }<font></font>
 </code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous traitons l'offre et générons la réponse</font></font></h2><br>
<pre><code class="javascript hljs"><span class="hljs-keyword">var</span> pc = <span class="hljs-keyword">new</span> RTCPeerConnection();<span class="hljs-comment">// connection</span>
<span class="hljs-keyword">var</span> peerConnectionConfig = { <span class="hljs-comment">// ice server</span>
              <span class="hljs-attr">iceServers</span>: [<font></font>
                  {<font></font>
                      <span class="hljs-attr">urls</span>: <span class="hljs-string">'stun:stun.l.google.com:19302'</span><font></font>
                  }<font></font>
                ]<font></font>
            }<font></font>
            pc.onicecandidate = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'new ice candidate'</span>, event.candidate);<font></font>
<font></font>
              <span class="hljs-keyword">if</span> (event.candidate !== <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// ice </span><font></font>
              }<font></font>
          };<font></font>
<font></font>
<font></font>
            navigator.getUserMedia = navigator.getUserMedia ||<font></font>
                         navigator.webkitGetUserMedia ||<font></font>
                         navigator.mozGetUserMedia;<font></font>
<font></font>
            navigator.getUserMedia({<span class="hljs-attr">video</span>: <span class="hljs-literal">true</span>,<span class="hljs-attr">audio</span>:<span class="hljs-literal">true</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">stream</span>) </span>{<span class="hljs-comment">//          </span>
              <span class="hljs-keyword">var</span> my_video = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'my'</span>)<font></font>
              my_video.srcObject = stream<font></font>
              <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'stream is added while offering'</span>)<font></font>
<font></font>
              pc.onaddstream = <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'not my stream is added while offering'</span>)
                <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'not_my'</span>).srcObject = e.stream;<font></font>
                <font></font>
              }<font></font>
              pc.addStream(stream);<font></font>
            <font></font>
              pc.setRemoteDescription(<span class="hljs-keyword">new</span> RTCSessionDescription(data.offer), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{<font></font>
                pc.createAnswer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">answer</span>) </span>{<font></font>
                  pc.setLocalDescription(answer, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    <span class="hljs-comment">// </span>
                  }, e =&gt; <span class="hljs-built_in">console</span>.log(e));<font></font>
                }, e =&gt; <span class="hljs-built_in">console</span>.log(e));<font></font>
              }, e =&gt; <span class="hljs-built_in">console</span>.log(e));<font></font>
            },<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span>{<span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"Error getting audio stream from getUserMedia"</span>)});<font></font>
          }<font></font>
        }<font></font>
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous acceptons la réponse et créons un flux vidéo</font></font></h2><br>
<pre><code class="javascript hljs">pc.setRemoteDescription(<span class="hljs-keyword">new</span> RTCSessionDescription(data.answer), <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ }, error);
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et la dernière chose que nous devons faire est de traiter les paquets de glace</font></font></h2><br>
<pre><code class="javascript hljs">pc.addIceCandidate(<span class="hljs-keyword">new</span> RTCIceCandidate(ice))<span class="hljs-comment">// ice -  ,    </span>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr502714/index.html">Exportez les données OpenStreetMap à l'aide de l'éditeur visuel sur rete.js</a></li>
<li><a href="../fr502716/index.html">Vous ne pouvez pas partager votre ordinateur personnel? Faites un sur deux</a></li>
<li><a href="../fr502718/index.html">Le projet Talking Head, ou l'histoire du développement de logiciels pour un robot de téléprésence</a></li>
<li><a href="../fr502720/index.html">Tendances des tests à examiner en 2020</a></li>
<li><a href="../fr502722/index.html">Silicon Valley en russe. Comment fonctionne # ITX5 à Innopolis</a></li>
<li><a href="../fr502728/index.html">Astuces intéressantes et astuces SSH</a></li>
<li><a href="../fr502730/index.html">Que savent les designers industriels des appareils que vous utilisez quotidiennement. Ou 50 ans de transformation d'une souris d'ordinateur</a></li>
<li><a href="../fr502732/index.html">Livre «Comment tester sur Google» - version électronique gratuite</a></li>
<li><a href="../fr502734/index.html">Ack better grep</a></li>
<li><a href="../fr502740/index.html">Comment désinfecter les avions à l'ère de Covid-19?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>