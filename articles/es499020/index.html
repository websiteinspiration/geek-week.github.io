<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>答   Un estudio de un comportamiento vago.  答 こ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El art铆culo explora las posibles manifestaciones de comportamiento indefinido que ocurre en c ++ cuando se completa una funci贸n no nula sin llamar a r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Un estudio de un comportamiento vago.</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/499020/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El art铆culo explora las posibles manifestaciones de comportamiento indefinido que ocurre en c ++ cuando se completa una funci贸n no nula sin llamar a return con un valor adecuado. </font><font style="vertical-align: inherit;">El art铆culo es m谩s cient铆fico y entretenido que pr谩ctico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
驴A qui茅n no le gusta divertirse saltando en un rastrillo? Pasamos, no nos detenemos.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci贸n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo el mundo sabe que al desarrollar c贸digo c ++, no debe permitir un comportamiento indefinido. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el comportamiento indefinido puede no parecer lo suficientemente peligroso debido a la abstracci贸n de las posibles consecuencias;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no siempre est谩 claro d贸nde est谩 la l铆nea.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tratemos de especificar las posibles manifestaciones de comportamiento indefinido que ocurre en un caso bastante simple: en una funci贸n no nula, no hay retorno. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer esto, considere el c贸digo generado por los compiladores m谩s populares en diferentes modos de optimizaci贸n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La investigaci贸n en Linux se llevar谩 a cabo utilizando el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Explorador de compiladores</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Investigaci贸n sobre Windows y macOs X: sobre el hardware directamente disponible para m铆. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas las compilaciones se realizar谩n para x86-x64. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No se tomar谩n medidas para mejorar o suprimir las advertencias / errores del compilador.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habr谩 mucho c贸digo desmontado. </font><font style="vertical-align: inherit;">Su dise帽o, lamentablemente, es abigarrado, porque </font><font style="vertical-align: inherit;">Tengo que usar varias herramientas diferentes (bueno, al menos logr茅 obtener la sintaxis de Intel en todas partes). </font><font style="vertical-align: inherit;">Dar茅 comentarios moderadamente detallados sobre el c贸digo desmontado, que, sin embargo, no eliminan la necesidad de conocer los registros del procesador y los principios de la pila.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leer est谩ndar</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++ 11 borrador final n3797, C ++ 14 borrador final N3936:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.6.3 La declaraci贸n de retorno </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... El </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
flujo del final de una funci贸n es equivalente a un retorno sin valor; </font><font style="vertical-align: inherit;">Esto da como resultado un </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
comportamiento </font><font style="vertical-align: inherit;">indefinido </font><font style="vertical-align: inherit;">en una funci贸n de retorno de valor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alcanzar el final de una funci贸n es equivalente a regresar sin un valor de retorno; </font><font style="vertical-align: inherit;">para una funci贸n cuyo valor de retorno se proporciona, esto conduce a un comportamiento indefinido.</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++ 17 draft n4713</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9.6.3 La declaraci贸n de retorno </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Que fluye del final de un constructor, un destructor o una funci贸n con un tipo de retorno vac铆o cv es equivalente a un retorno sin operando. </font><font style="vertical-align: inherit;">De lo contrario, fluir fuera del final de una funci贸n que no sea main (6.8.3.1) da como resultado un comportamiento indefinido. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><br>
</blockquote><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alcanzar el final de un constructor, destructor o funci贸n con un valor de retorno nulo (posiblemente con calificadores constantes y vol谩tiles) es equivalente a un retorno sin un valor de retorno. </font><font style="vertical-align: inherit;">Para todas las dem谩s funciones, esto conduce a un comportamiento indefinido (a excepci贸n de la funci贸n principal).</font></font><br>
</blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">驴Qu茅 significa esto en la pr谩ctica? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la firma de la funci贸n proporciona un valor de retorno:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">su ejecuci贸n debe terminar con una declaraci贸n de retorno con una instancia del tipo apropiado;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de lo contrario, comportamiento vago;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el comportamiento indefinido no comienza desde el momento en que se llama la funci贸n y no desde el momento en que se utiliza el valor devuelto, sino desde el momento en que la funci贸n no se completa correctamente;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si la funci贸n contiene rutas de ejecuci贸n correctas e incorrectas, el comportamiento indefinido solo ocurrir谩 en rutas incorrectas;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El comportamiento indefinido en cuesti贸n no afecta la ejecuci贸n de las instrucciones contenidas en el cuerpo de la funci贸n.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La frase sobre la funci贸n principal no es una novedad de c ++ 17: en versiones anteriores del Est谩ndar, se describi贸 una excepci贸n similar en la secci贸n 3.6.1 Funci贸n principal.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo 1 - bool</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En c ++ no hay ning煤n tipo con un estado m谩s simple que bool. </font><font style="vertical-align: inherit;">Comencemos con 茅l.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MSVC da un error de compilaci贸n C4716 para tal ejemplo, por lo que el c贸digo para MSVC tendr谩 que ser un poco complicado al proporcionar al menos una ruta de ejecuci贸n correcta:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compilacion:</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plataforma</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compilador</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado de compilaci贸n</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-x64 Clang 10.0.0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">advertencia: la funci贸n no nula no devuelve un valor [-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86-x64 gcc 9.3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">advertencia: no hay declaraci贸n de retorno en la funci贸n que devuelve no vac铆o [-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mac OS X</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apple clang versi贸n 11.0.0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">advertencia: el control llega al final de la funci贸n no nula [-Wreturn-type]</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ventanas</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSVC 2019 16.5.4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El ejemplo original es el error C4716, complicado: advertencia C4715: no todas las rutas de control devuelven un valor</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resultados de ejecuci贸n:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mejoramiento</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programa de retorno</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salida de la consola</font></font></b></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ninguna salida</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ninguna salida</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ninguna salida</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOs X Apple clang versi贸n 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0, -O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, ejemplo original</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No construir</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No construir</font></font></td>
</tr>
<tr>
<td colspan="3"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Ejemplo complicado</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incluso en este ejemplo m谩s simple, cuatro compiladores han demostrado al menos tres formas de mostrar un comportamiento indefinido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos qu茅 compilaron estos compiladores all铆.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O0</font></font></h4><br>
<img src="https://habrastorage.org/webt/yc/pg/vw/ycpgvw4062ruxbxhec61lpr5oec.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La 煤ltima declaraci贸n en la funci贸n bad () es </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descripci贸n de las instrucciones </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">del Manual del desarrollador de software de las arquitecturas Intel 64 e IA-32</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote>UD2Undefined Instruction<br>
Generates an invalid opcode exception. This instruction is provided for software testing to explicitly generate an invalid opcode exception. The opcode for this instruction is reserved for this purpose.<br>
Other than raising the invalid opcode exception, this instruction has no effect on processor state or memory.<br>
<br>
Even though it is the execution of the UD2 instruction that causes the invalid opcode exception, the instruction pointer saved by delivery of the exception references the UD2 instruction (and not the following instruction).<br>
<br>
This instructions operation is the same in non-64-bit modes and 64-bit mode.<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En resumen, esta es una instrucci贸n especial para lanzar una excepci贸n. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Necesitas envolver la llamada bad () en un intento ... 隆atrapa! </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No importa c贸mo. </font><font style="vertical-align: inherit;">Esto no es una excepci贸n de C ++. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">驴Es posible atrapar ud2 en tiempo de ejecuci贸n? </font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En Windows, __try deber铆a usarse para esto; en Linux y macOs X, el controlador de se帽al SIGILL.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/qg/al/gl/qgalgl3q6xaqajpp2kdjqxpbp9m.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado de la optimizaci贸n, el compilador simplemente tom贸 y descart贸 tanto el cuerpo de la funci贸n bad () como su llamada.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br>
<img src="https://habrastorage.org/webt/a7/ny/2g/a7ny2ghbcx-bj4a73pqzu_y_eam.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Explicaciones (en orden inverso, porque en este caso la cadena es m谩s f谩cil de analizar desde el final): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. El operador de salida en la secuencia se llama bool (l铆nea 14); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. La direcci贸n std :: cout se coloca en el registro edi: este es el primer argumento del operador de salida en la secuencia (l铆nea 13); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. El contenido del registro eax se coloca en el registro esi: este es el segundo argumento del operador de salida en la secuencia (l铆nea 12); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Los tres bytes altos de eax se restablecen a cero, el valor de al no cambia (l铆nea 11); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. La funci贸n bad () se llama (l铆nea 10); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0. La funci贸n bad () debe poner el valor de retorno en el registro al. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cambio, la l铆nea 4 muestra nop (Sin operaci贸n, ficticio). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un byte de basura del registro al se env铆a a la consola. </font><font style="vertical-align: inherit;">El programa termina normalmente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O1, -O2, -O3</font></font></h4><br>
<img src="https://habrastorage.org/webt/dp/sl/yh/dpslyhnvjwxt2c24ifgw6lgpxnu.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El compilador arroj贸 todo como resultado de la optimizaci贸n.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOs X Apple clang versi贸n 11.0.0, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funci贸n main (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ey/kl/aw/eyklawd5cgswoa14yg-h8iotxkq.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
la ruta del argumento booleano del operador de salida al flujo (esta vez en el orden directo): </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. El contenido del registro al se coloca en el registro edx (l铆nea 8); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Todos los bits del registro edx se ponen a cero, excepto el m谩s bajo (l铆nea 9); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Se coloca un puntero a std :: cout en el registro rdi; este es el primer argumento del operador de salida en la secuencia (l铆nea 10); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. El contenido del registro edx se coloca en el registro esi: este es el segundo argumento para el operador de salida en la secuencia (l铆nea 11); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. La declaraci贸n de salida se llama en secuencia para bool (l铆nea 13); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La funci贸n principal espera obtener el resultado de la funci贸n bad () del registro al. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La funci贸n bad (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v5/tx/1p/v5tx1pohulp-fewcheimnj0wnkk.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. El valor del siguiente byte de la pila, a煤n no asignado, se coloca en el registro al (l铆nea 4);</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Todos los bits del registro al est谩n exceptuados, excepto el menos significativo (l铆nea 5); </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un poco de basura de la pila no asignada se env铆a a la consola. </font><font style="vertical-align: inherit;">Dio la casualidad de que durante una ejecuci贸n de prueba result贸 ser cero. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El programa termina normalmente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOs X Apple clang versi贸n 11.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/zh/mm/t0/zhmmt0z4yvmtiunqa287sdu9lky.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El argumento booleano del operador de salida en la secuencia est谩 anulado (l铆nea 5). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La llamada bad () se lanz贸 durante la optimizaci贸n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El programa siempre muestra cero en la consola y sale normalmente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, Ejemplo avanzado, / Od</font></font></h4><br>
<img src="https://habrastorage.org/webt/pb/iz/ku/pbizkuhiff8y37zk6i2ea1qrwb8.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se puede ver que la funci贸n bad () deber铆a proporcionar un valor de retorno en el registro al. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/au/ej/zn/auejznebzsjq0n_e4kgtbkfd5ae.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El valor devuelto por la funci贸n bad () se inserta primero en la pila y luego en el registro edx para que la salida se transmita. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un solo byte de basura del registro al se env铆a a la consola (si es un poco m谩s preciso, entonces el byte bajo del resultado de rand ()). </font><font style="vertical-align: inherit;">El programa termina normalmente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Ejemplo complicado, / O1, / O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/mk/wr/jy/mkwrjyimc1tfaqfzq_hzuorcaba.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El compilador forz贸 a la fuerza la llamada bad (). </font><font style="vertical-align: inherit;">Funci贸n principal:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">copia un byte de ebx de la memoria ubicada en [rsp + 30h];</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si rand () devolvi贸 cero, copie la unidad de ecx a ebx (l铆nea 11);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">copia el mismo valor en dl (m谩s precisamente, su byte menos significativo) (l铆nea 13);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llama a la funci贸n de salida en flujo, que genera el valor dl (l铆nea 14).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un byte de basura de RAM (de la direcci贸n rsp + 30h) se emite para transmitir.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La conclusi贸n del ejemplo 1</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los resultados de la consideraci贸n de las listas de desensambladores se muestran en la tabla:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mejoramiento</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programa de retorno</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salida de la consola</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Porque</font></font></b></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ninguna salida</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ninguna salida</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La salida de la consola y la llamada a la funci贸n bad () se lanzaron como resultado de la optimizaci贸n</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un byte de basura del registro al</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ninguna salida</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La salida de la consola y la llamada a la funci贸n bad () se lanzaron como resultado de la optimizaci贸n</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOs X Apple clang versi贸n 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un poco de basura de la RAM</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llamada de funci贸n bad () reemplazada por cero</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, ejemplo original</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No construir</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No construir</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No construir</font></font></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Ejemplo complicado</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un byte de basura del registro al</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un byte de basura de RAM</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Result贸 que los compiladores no demostraron 3, sino hasta 6 variantes de comportamiento indefinido; justo antes de considerar las listas de desensambladores, no pudimos distinguir algunas de ellas.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo 1a - Gesti贸n de comportamiento indefinido</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intentemos dirigirnos un poco con un comportamiento indefinido: afecta el valor devuelto por la funci贸n bad (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto solo se puede hacer con compiladores que generan basura. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer esto, transfiera los valores deseados a los lugares desde donde los tomar谩n los compiladores.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La funci贸n vac铆a bad () no modifica el valor de register al, como lo requiere el c贸digo de llamada. </font><font style="vertical-align: inherit;">Por lo tanto, si colocamos un cierto valor en al antes de llamar a bad (), entonces esperamos ver exactamente este valor como resultado de ejecutar bad (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, esto se puede hacer llamando a cualquier otra funci贸n que devuelva bool. </font><font style="vertical-align: inherit;">Pero tambi茅n se puede hacer usando una funci贸n que devuelve, por ejemplo, sin caracteres char.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C贸digo de ejemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">goodTrue</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> rand();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">goodFalse</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> !goodTrue();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">goodChar</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch)</span>
</span>{
    <span class="hljs-keyword">return</span> ch;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    goodTrue();<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodChar(<span class="hljs-number">85</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodFalse();<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    goodChar(<span class="hljs-number">240</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salida a la consola:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el ejemplo de MSVC, la funci贸n bad () devuelve el byte bajo del resultado de rand (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin modificar la funci贸n bad (), el c贸digo externo puede afectar su valor de retorno al modificar el resultado de rand ().</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C贸digo de ejemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">control</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> value)</span>
</span>{
    <span class="hljs-keyword">uint32_t</span> count = <span class="hljs-number">0</span>;<font></font>
    srand(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">while</span> ((rand() &amp; <span class="hljs-number">0xff</span>) != value) {<font></font>
        ++count;<font></font>
    }<font></font>
<font></font>
    srand(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {<font></font>
        rand();<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    control(<span class="hljs-number">1</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">85</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">0</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    control(<span class="hljs-number">240</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salida a la consola:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / O1, / O2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para influir no en el valor "devuelto" por la funci贸n bad (), es suficiente crear una variable de pila. </font><font style="vertical-align: inherit;">Para que el registro no se elimine durante la optimizaci贸n, debe marcarlo como vol谩til.</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C贸digo de ejemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch = <span class="hljs-number">1</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">85</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  ch = <span class="hljs-number">240</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salida a la consola:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
85 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
240</font></font><br>
</blockquote><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOs X Apple clang versi贸n 11.0.0, -O0</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de llamar a bad (), debe ingresar un cierto valor en esa celda de memoria, que ser谩 uno menos que la parte superior de la pila al momento de llamar a bad ().</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C贸digo de ejemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span> </span>{}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">putToStack</span><span class="hljs-params">(<span class="hljs-keyword">uint8_t</span> value)</span>
</span>{
    <span class="hljs-keyword">uint8_t</span> memory[<span class="hljs-number">1</span>]{value};<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
    putToStack(<span class="hljs-number">20</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">55</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">0xfe</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    putToStack(<span class="hljs-number">11</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
      -O0,         memory.          ,    .<br>
<br>
   memory      ,          ,    ,   .<br>
<br>
   , ..        ,         putToStack     .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salida a la consola:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece haber sucedido: es posible cambiar la salida de la funci贸n bad (), y solo se tiene en cuenta el bit de orden inferior.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La conclusi贸n del ejemplo 1a</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un ejemplo permiti贸 verificar la interpretaci贸n correcta de las listas de desensambladores.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo 1b - bool roto</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno, piensas en ello, "41" se mostrar谩 en la consola en lugar de "1" ... 驴Es peligroso? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comprobaremos dos compiladores que proporcionan un byte completo de basura.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C贸digo de ejemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">bool</span> badBool1 = bad();
    <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (badBool1) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (!badBool1) {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
              &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salida a la consola:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 35 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): verdadero </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): falso </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(badBool1 == verdadero || badBool1 == falso || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">falso</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , verdadero, falso} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El comportamiento indefinido condujo a la aparici贸n de una variable booleana que rompe al menos:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operadores de comparaci贸n para valores booleanos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funci贸n hash de valor booleano.</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / O1, / O2</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C贸digo de ejemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">if</span> (rand() == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch = <span class="hljs-number">213</span>;
  <span class="hljs-keyword">bool</span> badBool1 = bad();<font></font>
  ch = <span class="hljs-number">137</span>;
  <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (!badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salida a la consola:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 213 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 137 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): verdadero </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): falso </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(badBool1 == verdadero || badBool1 == falso || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">falso</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , verdadero, falso} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El trabajo con una variable booleana corrupta no cambi贸 cuando se activ贸 la optimizaci贸n.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3, -O0</font></font></h4><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C贸digo de ejemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;set&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unordered_set&gt;</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">bad</span><span class="hljs-params">()</span>
</span>{<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> <span class="hljs-title">goodChar</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> ch)</span>
</span>{
  <span class="hljs-keyword">return</span> ch;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{<font></font>
  goodChar(<span class="hljs-number">213</span>);
  <span class="hljs-keyword">bool</span> badBool1 = bad();<font></font>
<font></font>
  goodChar(<span class="hljs-number">137</span>);
  <span class="hljs-keyword">bool</span> badBool2 = bad();<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool1: "</span> &lt;&lt; badBool1 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"badBool2: "</span> &lt;&lt; badBool2 &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (!badBool1) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): true"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"if (!badBool1): false"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"(badBool1 == true || badBool1 == false || badBool1 == badBool2): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::boolalpha &lt;&lt; (badBool1 == <span class="hljs-literal">true</span> || badBool1 == <span class="hljs-literal">false</span> || badBool1 == badBool2)<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"std::unordered_set&lt;bool&gt;{badBool1, badBool2, true, false}.size(): "</span>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unordered_set</span>&lt;<span class="hljs-keyword">bool</span>&gt;{badBool1, badBool2, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>}.size()<font></font>
    &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salida a la consola:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">badBool1: 213 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
badBool2: 137 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (badBool1): verdadero </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
if (! badBool1): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verdadero</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
(badBool1 == verdadero || badBool1 == falso || badBool1 == badBool2): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">falso</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: set &lt;bool&gt; {badBool1, badBool2 , verdadero, falso} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
std :: unordered_set &lt;bool&gt; {badBool1, badBool2, true, false} .size (): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font><br>
</b><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En comparaci贸n con MSVC, gcc tambi茅n agreg贸 la operaci贸n incorrecta del operador no.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La conclusi贸n del ejemplo 1b</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La interrupci贸n de las operaciones b谩sicas con valores booleanos puede tener serias consecuencias para la l贸gica de alto nivel. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">驴Por qu茅 sucedi贸? </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debido a que algunas operaciones con variables booleanas se implementan bajo el supuesto de que verdadero es estrictamente una unidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No consideraremos este problema en el desensamblador: el art铆culo result贸 ser voluminoso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una vez m谩s, aclaramos la tabla con el comportamiento de los compiladores:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mejoramiento</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programa de retorno</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salida de la consola</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Porque</font></font></b></td>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consecuencias de usar el resultado de bad ()</font></font></b></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ninguna salida</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ud2</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ninguna salida</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La salida de la consola y la llamada a la funci贸n bad () se lanzaron como resultado de la optimizaci贸n</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 gcc 9.3</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un byte de basura del registro al</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Violaci贸n del trabajo: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
no; </font><font style="vertical-align: inherit;">==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hash.</font></font><br>
</td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2, -O3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ninguna salida</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La salida de la consola y la llamada a la funci贸n bad () se lanzaron como resultado de la optimizaci贸n</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MacOs X Apple clang versi贸n 11.0.0</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un poco de basura de la RAM</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-O1, -O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llamada de funci贸n bad () reemplazada por cero</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, ejemplo original</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od, / O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No construir</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No construir</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No construir</font></font></td>
<td></td>
</tr>
<tr>
<td colspan="4"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4 Ejemplo complicado</font></font></b></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ Od</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">41</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un byte de basura del registro al</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Violaci贸n de trabajo: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hash.</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ O1, / O2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 0</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un byte de basura de RAM</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Violaci贸n de trabajo: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
==; </font><font style="vertical-align: inherit;">! =; </font><font style="vertical-align: inherit;">&lt;; </font><font style="vertical-align: inherit;">&gt;; </font><font style="vertical-align: inherit;">&lt;=; </font><font style="vertical-align: inherit;">&gt; =; </font><font style="vertical-align: inherit;">std :: hash.</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuatro compiladores dieron 7 manifestaciones diferentes de comportamiento indefinido.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo 2 - struct</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tomemos un ejemplo un poco m谩s complicado:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; rnd &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La estructura de prueba requiere un 煤nico par谩metro de tipo int para construir. </font><font style="vertical-align: inherit;">Los mensajes de diagn贸stico salen de su constructor y destructor. </font><font style="vertical-align: inherit;">La funci贸n bad (int) tiene dos rutas de ejecuci贸n v谩lidas, ninguna de las cuales se implementar谩 en una sola llamada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta vez, primero la tabla, luego el an谩lisis del desensamblador en puntos oscuros.</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mejoramiento</font></font></b></td>
<td><b>Program return</b></td>
<td><b>Console output</b></td>
<td><b></b></td>
</tr>
<tr>
<td colspan="4"><b>Linux x86-x64 Clang 10.0.0</b></td>
</tr>
<tr>
<td>-O0</td>
<td>255</td>
<td>rnd: 1804289383</td>
<td>ud2</td>
</tr>
<tr>
<td>-O1, -O2</td>
<td>0</td>
<td>rnd: 1804289383<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>Linux x86-x64 gcc 9.3</b></td>
</tr>
<tr>
<td>-O0</td>
<td>0</td>
<td>rnd: 1804289383<br>
4198608<br>
Test::~Test()</td>
<td>nop       .<br>
value    .</td>
</tr>
<tr>
<td>-O1, -O2, -O3</td>
<td>0</td>
<td>rnd: 1804289383<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>macOs X Apple clang version 11.0.0</b></td>
</tr>
<tr>
<td>-O0</td>
<td>The program has unexpectedly finished.</td>
<td>rnd: 16807</td>
<td>ud2</td>
</tr>
<tr>
<td>-O1, -O2</td>
<td>0</td>
<td>rnd: 16807<br>
Test::Test(142)<br>
142<br>
Test::~Test()</td>
<td> if (v == 1)  .  else if    else.</td>
</tr>
<tr>
<td colspan="4"><b>Windows MSVC 2019 16.5.4</b></td>
</tr>
<tr>
<td>/Od /RTCs</td>
<td>Access violation reading location 0x00000000CCCCCCCC</td>
<td>rnd: 41</td>
<td>  MSVC stack frame run-time error checking</td>
</tr>
<tr>
<td>/Od, /O1, /O2</td>
<td>0</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rnd: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8791061810776 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prueba :: ~ Prueba ()</font></font><br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basura de una ubicaci贸n de memoria cuya direcci贸n est谩 en rax</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuevamente vemos muchas opciones: adem谩s del ud2 ya conocido, hay al menos 4 comportamientos diferentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El manejo del compilador con un constructor es muy interesante:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en algunos casos, la ejecuci贸n continu贸 sin llamar al constructor; en este caso, el objeto estaba en alg煤n estado aleatorio;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en otros casos, no se proporcion贸 una llamada de constructor en la ruta de ejecuci贸n, lo cual es bastante extra帽o.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux x86-x64 Clang 10.0.0, -O1, -O2</font></font></h4><br>
<img src="https://habrastorage.org/webt/z7/cq/ry/z7cqry23rk0ul156zrdhnedehl0.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo se hace una comparaci贸n en el c贸digo (l铆nea 14), y solo hay un salto condicional (l铆nea 15). </font><font style="vertical-align: inherit;">El compilador ignor贸 la segunda comparaci贸n y el segundo salto condicional. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto lleva a sospechar que el comportamiento indefinido comenz贸 antes de lo que prescribe el Est谩ndar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero al verificar la condici贸n del segundo si no contiene ning煤n efecto secundario, y la l贸gica del compilador funcion贸 de la siguiente manera:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si la segunda condici贸n es verdadera, debe llamar al constructor Prueba con el argumento 142;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la segunda condici贸n no es verdadera, la funci贸n se cerrar谩 sin devolver un valor, lo que significa un comportamiento indefinido en el que el compilador puede hacer cualquier cosa. </font><font style="vertical-align: inherit;">Incluyendo: llamar al mismo constructor con el mismo argumento;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la verificaci贸n es superflua; se puede llamar al constructor de prueba con el argumento 142 sin verificar la condici贸n.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos qu茅 sucede si la segunda verificaci贸n contiene una condici贸n con efectos secundarios:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == rand()) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C贸digo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == rand()) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; rnd &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<img src="https://habrastorage.org/webt/j5/mi/-w/j5mi-w148l3tnejie9aaxus5nr8.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El compilador reprodujo honestamente todos los efectos secundarios previstos al llamar a rand () (l铆nea 16), disipando as铆 las dudas sobre el comienzo temprano inapropiado de un comportamiento indefinido.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od / RTC</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La opci贸n / RTCs permite la comprobaci贸n de errores de tiempo de ejecuci贸n del marco de la pila. Esta opci贸n solo est谩 disponible en el ensamblaje de depuraci贸n. Considere el c贸digo desensamblado del segmento main (): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kl/sr/4y/klsr4ygrimmzxwbwuqtvfd3xvmy.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
antes de llamar a bad (int) (l铆nea 4), los argumentos est谩n preparados: el valor de la variable rnd se copia en el registro edx (l铆nea 2), y la direcci贸n efectiva de alguna variable local ubicada en la direcci贸n se carga en el registro rcx rsp + 28h (l铆nea 3). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presumiblemente, rsp + 28 es la direcci贸n de una variable temporal que almacena el resultado de llamar a bad (int). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta suposici贸n es confirmada por las l铆neas 19 y 20: la direcci贸n efectiva de la misma variable se carga en rcx, despu茅s de lo cual se llama al destructor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, en el intervalo de las l铆neas 4 a 18, no se accede a esta variable, a pesar de la salida del valor de su campo de datos para transmitir.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como vimos en listados anteriores de MSVC, el argumento para el operador de salida de flujo deber铆a esperarse en el registro rdx. </font><font style="vertical-align: inherit;">El registro rdx obtiene el resultado de desreferenciar la direcci贸n ubicada en rax (l铆nea 9). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, el c贸digo de llamada espera de bad (int):</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rellenando una variable cuya direcci贸n se pasa a trav茅s del registro rcx (aqu铆 vemos RVO en acci贸n);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devolviendo la direcci贸n de esta variable a trav茅s del registro rax.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pasemos a enumerar bad (int):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c3/vm/-x/c3vm-xwuhghbvtp6byyqwf6l6xg.png" alt="imagen"><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en eax, se ingresa el valor 0xCCCCCCCC, que vimos en el mensaje de infracci贸n de acceso (l铆nea 9) (tenga en cuenta que solo tiene 4 bytes, mientras que en el mensaje de AccessViolation la direcci贸n consta de 8 bytes);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se llama al comando rep stos, que ejecuta ciclos 0xC de escritura de los contenidos de eax en la memoria comenzando desde la direcci贸n rdi (l铆nea 10). </font><font style="vertical-align: inherit;">Estos son 48 bytes, exactamente la cantidad asignada en la pila en la l铆nea 6;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en las rutas de ejecuci贸n correctas, el valor de rsp + 40h se ingresa en rax (l铆neas 23, 36);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el valor del registro rcx (a trav茅s del cual main () pas贸 la direcci贸n de destino) se inserta en la pila en rsp + 8 (l铆nea 4);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rdi es empujado a la pila, lo que reduce rsp en 8 (l铆nea 5);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se asignan 30h bytes en la pila disminuyendo rsp (l铆nea 6).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces rsp + 8 en la l铆nea 4 y rsp + 40h en el resto del c贸digo tienen el mismo valor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c贸digo es bastante confuso ya que </font><font style="vertical-align: inherit;">no usa rbp. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay dos accidentes en el mensaje de Infracci贸n de acceso:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ceros en la parte superior de la direcci贸n: puede haber basura;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la direcci贸n result贸 accidentalmente incorrecta.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aparentemente, la opci贸n / RTC permiti贸 la sobrescritura de la pila con ciertos valores distintos de cero, y el mensaje de Infracci贸n de acceso fue solo un efecto secundario aleatorio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veamos c贸mo el c贸digo con la opci贸n / RTC activada difiere del c贸digo sin 茅l. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r4/ai/gh/r4aighkarr9kdcerpk60u6jvdya.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c贸digo para las secciones de main () difiere solo en las direcciones de las variables locales en la pila. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/oi/zt/kqoizt0khccfqovtmw6qn_--xiq.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(para mayor claridad, coloqu茅 dos versiones de la funci贸n bad (int) al lado: con / RTC y sin) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin los / RTC, la instrucci贸n rep stos desapareci贸 y prepar茅 argumentos para ello al comienzo de la funci贸n.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo 2a</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuevamente, intente controlar el comportamiento indefinido. </font><font style="vertical-align: inherit;">Esta vez para solo un compilador.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows MSVC 2019 16.5.4, / Od / RTC</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con la opci贸n / RTCs, el compilador inserta c贸digo al comienzo de la funci贸n incorrecta (int) que llena la mitad inferior de rax con un valor fijo, lo que puede conducir a una infracci贸n de acceso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cambiar este comportamiento, simplemente complete rax con alguna direcci贸n v谩lida. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto se puede lograr con una modificaci贸n muy simple: agregue la salida de algo a std :: cout al cuerpo incorrecto (int).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C贸digo de ejemplo completo</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Test</span>
{</span>
    Test(<span class="hljs-keyword">uint64_t</span> v)<font></font>
        : value(v)<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::Test("</span> &lt;&lt; v &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
    ~Test()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Test::~Test()"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">uint64_t</span> value;<font></font>
};<font></font>
<font></font>
<span class="hljs-function">Test <span class="hljs-title">bad</span><span class="hljs-params">(<span class="hljs-keyword">int</span> v)</span>
</span>{
  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"rnd: "</span> &lt;&lt; v &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (v == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">42</span>};<font></font>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> {<span class="hljs-number">142</span>};<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> rnd = rand();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; bad(rnd).value &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rnd: 41 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8791039331928 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prueba :: ~ Prueba ()</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El operador &lt;&lt; devuelve un enlace a stream, que se implementa al colocar la direcci贸n std :: cout en rax. </font><font style="vertical-align: inherit;">La direcci贸n es correcta, puede ser desreferenciada. </font><font style="vertical-align: inherit;">Se evita la violaci贸n de acceso.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi贸n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando los ejemplos m谩s simples, pudimos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recolectar alrededor de 10 manifestaciones diferentes de comportamiento indefinido;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aprenda en detalle exactamente c贸mo se ejecutar谩n estas opciones.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos los compiladores demostraron una estricta adherencia al Est谩ndar; en ning煤n caso el comportamiento indefinido comenz贸 antes de lo esperado. </font><font style="vertical-align: inherit;">Pero no puedes rechazar una fantas铆a para compilar desarrolladores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A menudo, la manifestaci贸n depende de sutiles matices: vale la pena agregar o eliminar una l铆nea de c贸digo aparentemente irrelevante, y el comportamiento del programa cambia significativamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, es m谩s f谩cil no escribir ese c贸digo que resolver acertijos m谩s tarde.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es499008/index.html">Por qu茅 los desarrolladores son tan lentos: problemas comunes y sus soluciones</a></li>
<li><a href="../es499010/index.html">Estudiamos el motor VoIP Mediastreamer2. Parte 11</a></li>
<li><a href="../es499014/index.html">23 preguntas dif铆ciles para entrevistas de JavaScript</a></li>
<li><a href="../es499016/index.html">Integraci贸n con ESIA para .Net: m谩s f谩cil de lo que parece</a></li>
<li><a href="../es499018/index.html">6 aplicaciones de deportes en casa</a></li>
<li><a href="../es499030/index.html">Monitoreo del rendimiento de MySQL para Grafana en isic en 20 minutos</a></li>
<li><a href="../es499032/index.html">C贸mo usar Prometheus para detectar anomal铆as en GitLab</a></li>
<li><a href="../es499034/index.html">驴C贸mo implementar una refactorizaci贸n peligrosa para pinchar con un mill贸n de usuarios?</a></li>
<li><a href="../es499036/index.html">Trabajo del proveedor: una selecci贸n de materiales sobre protocolos, TI e infraestructura de red</a></li>
<li><a href="../es499038/index.html">Mi experiencia usando un monitor vertical</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>