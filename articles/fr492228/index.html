<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎹 🧑🏽‍🤝‍🧑🏻 🙌🏻 Comme Sports.ru a écrit son éditeur WYSIWYG 👩‍💻 🧑🏼 🤾🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mi-2018, Sports.ru a pensé à passer à un nouvel éditeur de texte WYSIWYG pour les publications des utilisateurs. Depuis juin 2019, l'éditeur est en mo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Comme Sports.ru a écrit son éditeur WYSIWYG</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sports_ru/blog/492228/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mi-2018, Sports.ru a pensé à passer à un nouvel </font></font><abbr title="Ce que vous voyez est ce que vous obtenez"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">éditeur de</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> texte </font><abbr title="What You See Is What You Get"><font style="vertical-align: inherit;">WYSIWYG</font></abbr><font style="vertical-align: inherit;"> pour les publications des utilisateurs. </font><font style="vertical-align: inherit;">Depuis juin 2019, l'éditeur est en mode bêta. </font><font style="vertical-align: inherit;">Pendant ce temps, nous avons résolu de nombreux problèmes liés à la fois à la conception de l'architecture de l'ensemble du service et à l'implémentation de l'éditeur lui-même dans le navigateur basé sur la bibliothèque </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProseMirror</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et avons décidé de partager notre expérience.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wc/2p/ag/wc2pagubhgtlo-bvev4wjyfmrsk.png"><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table des matières</font></font></h1><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Introduction </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Pourquoi avez-vous eu besoin de WYSIWYG </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2. </font><font style="vertical-align: inherit;">Description de la tâche des développeurs </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Comment choisir l'outil </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Que s'est-il passé? </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1. </font><font style="vertical-align: inherit;">Architecture de service </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2. </font><font style="vertical-align: inherit;">Quels sont les défis </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Résultats du test bêta</font></font></a><br>
<br>
<a name="Intro"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Introduction</font></font></h2><br>
<a name="Why"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1. </font><font style="vertical-align: inherit;">Pourquoi avez-vous eu besoin de WYSIWYG</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sports.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un média sur le sport avec un public de 20 millions d'utilisateurs par mois. Nos principales différences par rapport aux médias classiques sont la communauté et l' </font></font><abbr title="Contenu généré par l'utilisateur"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UGC</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Le contenu utilisateur - évaluations, commentaires, chats, publications - complète non seulement la valeur éditoriale, mais crée également une plate-forme permettant aux utilisateurs d'interagir les uns avec les autres. Chaque mois, nos utilisateurs écrivent près de 10 000 messages. Les meilleurs d'entre eux sont soumis à la page principale du site avec les éditoriaux, envoyés aux applications mobiles, aux réseaux sociaux. Le contenu utilisateur représente environ 40% de toutes les lectures sur les pages Sports.ru. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voulons être la plate-forme la plus pratique pour les auteurs sportifs, pour aider à créer du contenu et à le livrer à un public intéressé. 10 ans, nous avons utilisé l'éditeur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TinyMCE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- et finalement il est devenu obsolète, il a cessé de convenir à la fois à l'équipe et aux utilisateurs habitués aux éditeurs modernes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ff/ub/ig/ffubigpbednsp8phz7btg-icbm8.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure. </font><font style="vertical-align: inherit;">1. L'interface de l'ancien éditeur basé sur TinyMCE</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Des auteurs de blogs ont régulièrement reçu les plaintes suivantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J'ai écrit pendant longtemps, puis j'ai accidentellement fermé l'onglet et tout a disparu;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">écrire de longs textes est très gênant;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est gênant que pour insérer chaque image, vous devez d'abord la télécharger sur l'hébergement d'images.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'équipe avait également ses propres plaintes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans TinyMCE, vous ne pouvez pas télécharger d'images directement à partir d'un fichier, vous pouvez uniquement attacher des liens vers des images, et en raison du fait que les utilisateurs n'ont pas pu télécharger des images vers notre stockage, si des liens vers eux sont morts, nous ne pourrions rien faire à ce sujet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les possibilités d'édition et de mise en forme du texte ne sont pas équilibrées. </font><font style="vertical-align: inherit;">D'une part, il n'y avait pas assez de styles, par exemple, pour les en-têtes internes dans le texte. </font><font style="vertical-align: inherit;">D'un autre côté, il était possible d'utiliser les outils disponibles dans n'importe quelle combinaison. </font><font style="vertical-align: inherit;">En conséquence, les messages ne semblaient pas uniformes (sur Sports.ru, les travaux ont commencé sur la mise en œuvre du système de conception et les messages des utilisateurs devraient être conformes à celui-ci);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le contenu est créé et stocké en HTML, il est donc difficile de gérer les styles dans les publications sur différents clients et de simplement modifier la disposition des publications.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici une histoire sur la façon dont nous avons résolu le problème de la création d'un nouvel éditeur sur le côté frontal. </font><font style="vertical-align: inherit;">Certes, il y aura aussi quelque chose au sujet du produit, de la conception et des composants de backend, car sans cela, il sera difficile de comprendre pourquoi une décision particulière a été prise à l'avant.</font></font><br>
<br>
<a name="Task"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2. </font><font style="vertical-align: inherit;">Description de la tâche des développeurs</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En bref, la thèse dont nous nous sommes d'abord inspirés: bloguer sur Sports.ru est une douleur. </font><font style="vertical-align: inherit;">En principe, il serait possible de ne pas créer un nouvel éditeur, mais simplement d'ajouter la sauvegarde automatique et la possibilité de télécharger des photos sur votre propre stockage - et la plupart des plaintes des utilisateurs et des employés disparaîtraient. </font><font style="vertical-align: inherit;">Mais je ne voulais toujours pas soutenir l'outil sur les anciennes technologies, mais créer un nouvel éditeur moderne que nous pouvons facilement développer et faire évoluer.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus de l'interface peu pratique, l'un des principaux problèmes techniques de l'ancien éditeur était que le contenu de la publication était immédiatement enregistré sous forme de chaîne HTML et que les modifications de l'apparence de la publication nécessitaient l'intervention de développeurs principaux ou étaient mises en œuvre au moment de l'exécution sur le client (par exemple, le placement des blocs d'annonces). dans le corps du message). Notre tâche, entre autres, était de séparer les données de leur présentation et, par conséquent, de laisser la disposition et l'interface dans le code client, et de travailler avec les données dans le code serveur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme modèle, nous avons pris </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Medium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , espionnant parfois les idées de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Google Doc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En plus de résoudre les problèmes déjà identifiés, nous avons décidé d'ajouter plusieurs nouvelles fonctionnalités qui rendraient l'utilisation de l'éditeur plus confortable:</font></font><br>
<br>
<ul>
<li>  WYSIWYG, .. what you see is what you get (. « ,   »,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>),           ,     .     ,      ;</li>
<li>  (      ,       ,      ,   ,    ; ,           )     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le même temps, l'éditeur lui-même n'aurait pas dû être lié aux fonctionnalités de Sports.ru, car Sports.ru, bien que le projet phare de notre société, ne soit toujours pas le seul. La société développe également le média sportif international </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tribuna</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un réseau social pour les amateurs de paris Betting </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insider</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et a récemment lancé son propre studio de production engagé dans des projets publicitaires. Développer un éditeur en ligne coûte assez cher pour ne pas vouloir réutiliser ce code sur un autre site avec une composition et des styles différents, avec son propre ensemble d'outils pour l'édition et la mise en forme.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons beaucoup de contenu texte, et avant de commencer à travailler sur la création d'un nouvel éditeur de publication, nous avons réfléchi à la façon dont ce contenu devrait être stocké. TinyMCE ne nous a pas laissé le choix et le contenu devait être stocké uniquement en HTML, ce qui, comme mentionné ci-dessus, ne convenait pas à l'équipe. En conséquence, nous avons mis au point notre propre format de stockage des données texte qui répond à nos exigences, et nous l'avons appelé corps structuré.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le corps structuré est un tableau d'objets qui reflète la structure du contenu. Dans ce cas, le contenu est divisé en éléments qui sont des blocs indépendants, par exemple, paragraphe, liste, image. Un élément stocke des informations sur son type et ses propriétés. Par exemple, le bloc de sous-titres décrit le titre dans le texte, il doit contenir le texte et les champs de niveau. En conséquence, le texte contient le texte de cette rubrique et le niveau contient le niveau (de 1 à 4). Un corps structuré, composé d'un en-tête de deuxième niveau, pourrait ressembler, par exemple, à ceci:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> structuredBody = [<font></font>
    {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;    <span class="hljs-attr">type</span>: <span class="hljs-string">'subtitle'</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <span class="hljs-attr">value</span>: {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    <span class="hljs-attr">text</span>: <span class="hljs-string">'    '</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <span class="hljs-attr">level</span>: <span class="hljs-number">2</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  },<font></font>
    },<font></font>
];<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La transition vers un corps structuré nous a permis d'entamer le processus de séparation de la logique métier, des données et de leur présentation. En fin de compte, nous voulons que le serveur et les clients n'échangent que des données. Et comment et pourquoi afficher ces données à l'utilisateur final, chaque client le déterminera indépendamment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le contenu au format corps formatd est stocké dans JSON, et pour valider son contenu, nous avons créé un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">schéma JSON</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> appelé schéma de corps structuré. Ce diagramme décrit tous les éléments valides et leurs propriétés. Ainsi, nous pouvons être sûrs que partout où un corps structuré est nécessaire, un ensemble de clés et de valeurs est utilisé.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, cela permet à différentes équipes d'utiliser les mêmes services pour traiter du contenu dans ce format. Par exemple, un service pour générer du HTML à partir d'un corps structuré pour afficher du contenu ou un éditeur pour créer du contenu. Cela réduit considérablement le coût de développement et de prise en charge de l'ensemble des services liés à la création et à l'affichage de contenu.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il a été supposé que le nouvel éditeur devrait accepter le contenu d'entrée et de sortie exclusivement dans le format de corps structuré. Et ici, il fallait prendre en compte le point subtil: puisque auparavant les messages étaient immédiatement enregistrés en HTML, cette chaîne HTML de la base de données était transmise au client pour affichage (ci-après, par le client, nous entendons uniquement le navigateur, sauf indication contraire). Maintenant, nous voulons stocker le contenu de toutes les publications dans le corps structuré, mais les clients ne peuvent traiter que du HTML. Ainsi, parallèlement à la tâche de passer à un nouvel éditeur, la tâche d'implémenter une nouvelle façon pour les clients d'afficher les articles à lire directement à partir du corps structuré se poursuit simultanément. Nous avons décidé qu'il vaut mieux manger un éléphant au coup par coup, donc vous devez d'abord abandonner complètement TinyMCE, et ensuite seulement adopter la logique d'affichage des messages à lire. De plus,tous les anciens messages n'ont pas réussi à traduire le contenu dans un nouveau format, ce qui signifie que ces messages seront toujours stockés uniquement en HTML et il est nécessaire qu'ils conservent également la possibilité de lire.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Total: une partie des articles (tous les nouveaux et anciens qui ont été transférés avec succès vers le nouveau format) seront stockés dans deux formats - HTML et corps structuré - jusqu'à ce que la nouvelle logique d'affichage pour la lecture soit mise en œuvre, et le reste (la plupart des anciens et très très anciens) messages) resteront uniquement en HTML.</font></font><br>
<br>
<a name="How"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Comment choisir un outil</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous devions réaliser la possibilité de modifier et de créer un article sur le client, en tenant compte des caractéristiques et des limitations ci-dessus. Comme toujours, vous pouvez prendre une solution toute faite ou vous pouvez proposer la vôtre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, nous avons examiné ce que sont les bibliothèques prêtes à l'emploi pour créer des éditeurs WYSIWYG et si elles nous conviennent. Nous nous sommes installés sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slate</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Draft.js</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProseMirror</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En plus de stocker du contenu dans une structure de données, le moment critique pour nous a également été la possibilité de travailler avec Vue ou JS pur, car nous avions déjà commencé à déplacer le site vers une nouvelle pile technologique utilisant Vue + Vuex. De plus, je voudrais étendre les capacités de la bibliothèque terminée avec l'aide de nouveaux modules (tiers ou auto-écrits) si nécessaire.</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Languette. </font><font style="vertical-align: inherit;">1. Comparaison des bibliothèques examinées par les paramètres les plus importants pour Sports.ru</font></font></i><br>
<img src="https://habrastorage.org/webt/fw/hf/xa/fwhfxa6ozwkyfdpdj8t6j5lcbuy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Comme vous pouvez le voir dans le tableau, ProseMirror a pleinement respecté nos exigences, nous n'avons donc plus envisagé l'idée d'écrire notre propre bibliothèque pour éditer le contenu du texte, mais nous avons commencé à étudier cette bibliothèque plus en détail. </font><font style="vertical-align: inherit;">Il y a encore une </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plume</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> assez populaire </font><font style="vertical-align: inherit;">, qui n'est pas entrée dans notre comparaison juste parce que nous l'avons honnêtement oublié au stade de la sélection d'un outil. </font><font style="vertical-align: inherit;">Selon nos principales exigences, cela passe également, mais il en est ainsi. </font><font style="vertical-align: inherit;">Nous avons déjà parlé de ce qu'est ProseMirror et comment travailler avec lui dans un autre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<a name="What"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Que s'est-il passé</font></font></h2><br>
<a name="Architecture"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1. </font><font style="vertical-align: inherit;">Architecture de service</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'éditeur de contenu lui-même sur le client est loin d'être tout. </font><font style="vertical-align: inherit;">Vous devez placer l'éditeur dans un projet existant, l'afficher quelque part sur la page Web et également envisager une interaction avec le backend, résoudre le problème de la prise en charge simultanée de deux éditeurs (vous ne pouviez pas immédiatement abandonner l'ancien) et stocker le contenu dans deux formats (HTML et structuré corps). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toutes ces tâches peuvent être divisées en celles liées au frontend, au backend et à leur intégration. </font><font style="vertical-align: inherit;">Nous sommes principalement concernés par les problèmes de front-end et d'intégration, bien que nous mentionnions également quelques aspects importants des tâches back-end. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les services frontaux pour l'éditeur peuvent être divisés en plusieurs niveaux:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">page Web pour créer et éditer une publication;</font></font></li>
<li>Vue-app,    .  ,  ,   Vue,         -, , , ,       ..,    ,         ,      ;</li>
<li>WYSIWYG-   ProseMirror,      Vue.      ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>;</li>
<li>SB2HTML –    HTML  structured body,    .    , structured body –       ,    .      ,   ,     ,      .    Sports.ru     HTML  structured body,  -     HTML  .       HTML    Node.Js,        JS-   .<br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le processus d'enregistrement du message est illustré à la Fig. </font><font style="vertical-align: inherit;">2. Le contenu du message au format de corps structuré et ses métadonnées sont transférés au backend. </font><font style="vertical-align: inherit;">Le backend envoie du contenu au service SB2HTML, reçoit le code HTML prêt dans la réponse, met tout cela dans la base de données et indique au client que la publication a été enregistrée avec succès, ou signale une erreur. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/of/fp/j8/offpj883_eq2swjl-ogb6jxprks.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure. </font><font style="vertical-align: inherit;">2. Schéma d'enregistrement d'une publication lors de la création ou de la modification dans un éditeur WYSIWYG</font></font></i><br>
<br>
<a name="Difficulties"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2. </font><font style="vertical-align: inherit;">Quelles difficultés avez-vous rencontrées?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les difficultés sont nombreuses, elles surgissent constamment et souvent dans les moments les plus inattendus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous l'avons déjà dit, l'éditeur de contenu est situé à l'intérieur du formulaire, ce qui vous permet de saisir les données supplémentaires nécessaires à la création d'une publication, telles que le titre, l'annotation, etc. Pour l'annotation, il devrait être possible de télécharger des images à partir d'un fichier et via un lien depuis Internet. Mais pour le contenu, nous voulons également charger des images à partir d'un fichier et par référence, en outre, selon les mêmes règles. Et ici, nous sommes confrontés à un dilemme: d'une part, le contenu du message est isolé du formulaire externe lors de l'édition et est servi par les outils ProseMirror, mais d'autre part, je veux observer le principe </font></font><abbr title="Ne vous répétez pas"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DRY</font></font></abbr><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ne dupliquez pas le même code. Nous avons résolu ce problème comme suit: nous avons décrit le chargement d'images comme un ensemble de méthodes dans un objet au niveau du formulaire Vue et passé cet objet comme l'un des paramètres au constructeur de l'éditeur WYSIWYG.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les entités qui décrivent le contenu - Node et Fragment - sont définies dans le modèle ProseMirror. Cependant, seuls les index sont utilisés pour une transaction afin de déterminer la plage de caractères à laquelle cette transaction est appliquée (les index sont comptés à la fois depuis le début du document et depuis le début du nœud parent). L'indexation des caractères est l'un des concepts centraux de ProseMirror, mais lors de l'édition et de la mise en forme du texte, il est beaucoup plus pratique de penser aux entités du modèle ProseMirror. En conséquence, pour un travail confortable avec le contenu, nous avons écrit nos assistants pour simplifier l'interaction avec un document pour les transactions. Après le début de notre travail, la bibliothèque </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiptap est apparue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui est un ensemble d'aides similaires.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le problème suivant était qu'au stade de la création du schéma, nous nous sommes rendu compte que nous avions déjà un format interne approuvé pour stocker le contenu - un corps structuré qui répond à nos besoins, et ProseMirror stocke le contenu dans son propre format dans une histoire. Le passage au format ProseMirror était difficile et peu pratique. Nous nous sommes retrouvés dans une situation où les données dans un format arrivent au client via l'API, et un autre doit être affiché. Une situation similaire se produit lorsqu'il est nécessaire d'enregistrer du contenu modifié ou créé. Pour ce faire, nous avons implémenté un convertisseur qui convertit les formats dans les deux sens. Ils ont écrit un test simple pour lui, qui prend le contenu d'un article au format corps formatd, le traduit au format ProseMirror, puis revient et compare déjà la version originale avec celle reçue. Cela s'est avéré rapidement et facilement.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus tard, au fur et à mesure que le schéma des documents a changé et, en règle générale, est devenu plus compliqué, il est devenu clair que le moindre changement pouvait entraîner des erreurs dans l'éditeur, et un tel test semble donner une très mauvaise couverture. En conséquence, j'ai dû écrire des tests sur presque toutes les combinaisons de nœuds et de marques sur deux petites méthodes de conversion. Maintenant, sans ces tests, il est impossible de déterminer si le prochain changement de circuit cassera quelque chose ou non.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le problème suivant est à nouveau lié au besoin de compatibilité descendante des anciennes et nouvelles technologies. Notre éditeur WYSIWYG est implémenté uniquement dans les navigateurs (ordinateur de bureau et, bientôt, mobile). En conséquence, pour l'édition de contenu sur le client est donné en JSON dans le corps structuré de format, cependant, la lecture des messages dans les navigateurs est effectuée uniquement à partir de HTML. Dans le même temps, la plupart des applications mobiles sont déjà passées à l'affichage de messages d'utilisateurs directement à partir d'un corps structuré.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les applications mobiles, il était nécessaire de prévoir le cas où le client ne peut pas traiter certains éléments du corps structuré. Par exemple, si un nouvel élément est ajouté au corps structuré, dont l'affichage n'est implémenté que dans une version plus récente de l'application. Étant donné que tous les utilisateurs ne mettent pas à jour leurs applications en même temps, il était nécessaire de fournir un plan «B» pour les anciennes versions: au lieu de créer du HTML à partir d'un corps structuré, insérez un fragment HTML prêt à l'emploi pour l'élément souhaité. La présence de fragments HTML pour chaque élément n'était pas prévue dans le schéma de corps structuré, car l'idée même de cette structure était de refuser de stocker des données en HTML. Mais à la fin, nous sommes arrivés à la conclusion que nous avons besoin de deux schémas de corps structurés - un pour l'affichage et un pour l'édition. Les différences entre les régimes sontque le corps structuré pour l'édition ne contient que le contenu de l'article, et pour l'affichage nous ajoutons quelques éléments supplémentaires. En particulier, un fragment HTML pour chaque élément est créé lorsqu'un message est enregistré dans le service SB2HTML et est ajouté uniquement au corps structuré pour afficher le message. De plus, le corps structuré affiche également de l'espace publicitaire dans le contenu à afficher.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous ouvrons du contenu pour le modifier dans un navigateur, nous ne pouvons pratiquement pas rencontrer d'élément inconnu, car tous les articles sont créés et affichés de la même manière. Mais ils ont décidé de prévoir un tel cas pour l'avenir également. Pour ce faire, nous avons ajouté un élément stub par défaut au schéma ProseMirror. Nous avons nommé cet élément unsupportedBlock. Le talon apparaît à la place d'un élément non pris en charge. Nous l'avons stylisé comme un rectangle gris avec du texte indiquant que cet élément n'est pas pris en charge et ne peut pas être modifié. Lorsqu'un article est enregistré, un tel élément reste inchangé dans le corps structuré. L'utilisateur peut modifier son emplacement par rapport à d'autres éléments, mais le contenu interne d'un élément inconnu ne peut pas être modifié ou modifié. Cependant, l'utilisateur peut supprimer un tel élément, puis, bien sûr,il ne sera pas enregistré dans le document final.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les problèmes décrits étaient liés aux difficultés de mise en œuvre de l'éditeur WYSIWYG lui-même. Mais alors qu'il existait en mode bêta, nous ne pouvions pas abandonner l'ancien éditeur sur TinyMCE et avons été obligés de prendre en charge les deux éditeurs, offrant une compatibilité descendante entre eux. Par exemple, vous pouvez créer un article dans l'éditeur WYSIWYG, l'enregistrer, le modifier dans TinyMCE, l'enregistrer, l'ouvrir à nouveau dans WYSIWYG, etc. Par conséquent, lors de l'ouverture dans WYSIWYG, nous avons vu le même contenu que dans la sauvegarde précédente dans TinyMCE. Pour implémenter la compatibilité descendante, il était nécessaire de soumettre du contenu HTML à TinyMCE, que nous avons déjà appris à créer à partir d'un corps structuré et à enregistrer dans la base de données lors de l'enregistrement de la publication. Et lors de l'enregistrement d'une publication via TinyMCE, le contenu créé sur le serveur est exécuté via le service HTML2SB,en conséquence, nous pouvons enregistrer à la fois du HTML frais et un corps structuré.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HTML2SB est l'opposé de ce que fait SB2HTML, c'est-à-dire qu'il convertit le contenu HTML en corps structuré. </font><font style="vertical-align: inherit;">Chronologiquement, ce service est apparu plus tôt que toute autre chose, car avant la création de l'éditeur WYSIWYG, la seule façon d'obtenir du contenu de publication au format de corps structuré était l'analyse directe à partir de HTML. </font><font style="vertical-align: inherit;">HTML2SB faisait partie de l'infrastructure backend autour de l'éditeur de publication, mais après avoir abandonné TinyMCE, il n'était plus nécessaire.</font></font><br>
<br>
<a name="Results"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. Résultats bêta</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, l'éditeur WYSIWYG est disponible pour tous les utilisateurs en version bêta, et deviendra bientôt l'éditeur principal des articles Sports.ru. </font><font style="vertical-align: inherit;">Nous avons déjà reçu un outil pour créer et éditer des articles qui répond à la plupart de nos exigences:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'interface de l'éditeur est devenue claire, concise et moderne, la rédaction de longs articles est devenue beaucoup plus facile;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez maintenant télécharger des images à partir d'un fichier et par un lien qui sont immédiatement placés dans notre référentiel;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajouté la possibilité d'intégrer les intégrations des principaux réseaux sociaux et sites d'hébergement vidéo;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nettoyé les styles de mise en forme du texte;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les applications mobiles sont déjà passées à l'affichage de publications à partir d'un corps structuré et peuvent définir leurs propres styles de contenu.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, l'éditeur n'est pas encore complètement débogué, nous détectons périodiquement de nouveaux bugs. </font><font style="vertical-align: inherit;">Les mises à jour suivantes arrivent:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sauvegarde automatique;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Version WYSIWYG pour les utilisateurs avec des droits étendus (administrateurs, éditeurs à temps plein);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">créer et modifier des articles à partir de navigateurs mobiles;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Messages sur l'édition parallèle d'un document par plusieurs utilisateurs;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pourboires et intégration;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">widgets statistiques pour les équipes sportives, les matchs et les alignements.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au moment d'écrire ces lignes, plus de 13000 articles ont déjà été publiés via la version bêta de l'éditeur, ce qui représente environ 20% du nombre total de textes utilisateur sur Sports.ru pour la période de juin 2019 à février 2020 inclus. La part des articles créés et publiés par le nouvel éditeur augmente régulièrement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/2i/4b/ad2i4b4dubgv9--l-vl7ghh6cnw.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure. 3. La proportion de messages d'utilisateurs créés et publiés dans le nouvel éditeur</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semble que la croissance organique de la part des publications d'utilisateurs créées et publiées via le nouvel éditeur soit un signe que les utilisateurs sont satisfaits de la mise à jour, ce qui est également confirmé par les commentaires lors de l'annonce de son lancement en bêta-test (certains d'entre eux sont illustrés sur la figure 4). </font><font style="vertical-align: inherit;">Par conséquent, dans les mois à venir, nous prévoyons de transférer complètement la création de messages vers le nouvel éditeur, afin de nous concentrer uniquement sur son support et son développement.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au fait, quelle fonctionnalité ajouteriez-vous à notre éditeur WYSIWYG? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k-/bm/nz/k-bmnzzgoh5wi-nvq516-pca8uk.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure. </font><font style="vertical-align: inherit;">4. Commentaires des utilisateurs dans un article avec l'annonce de la mise à jour de l'éditeur WYSIWYG&nbsp;</font></font></i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr492216/index.html">Enregistrement de valeurs dans une application .Net au stade de la création</a></li>
<li><a href="../fr492218/index.html">Règles de conception d'icônes à retenir</a></li>
<li><a href="../fr492220/index.html">5 secrets peu connus des Pandas</a></li>
<li><a href="../fr492222/index.html">Rédaction CTFZone Quals 2019: Poulet</a></li>
<li><a href="../fr492226/index.html">Comparaison de prix sur les Kubernetes gérés (2020)</a></li>
<li><a href="../fr492232/index.html">Comment les Smartcalls sont devenus le kit Voximplant - caractéristiques de rebranding et de tueur</a></li>
<li><a href="../fr492234/index.html">Recherche: pourquoi les gens sont prêts à recevoir moins dans les projets sociaux</a></li>
<li><a href="../fr492242/index.html">M5Stack et ses contacts</a></li>
<li><a href="../fr492244/index.html">Enlèvement pour la période du coronavirus: "arrestation" à domicile ou moment opportun?</a></li>
<li><a href="../fr492246/index.html">Coronavirus: implications possibles pour la société, l'économie et la médecine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>