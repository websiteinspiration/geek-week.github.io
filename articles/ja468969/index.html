<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥖 🍺 👨🏻‍🚀 APIを介してPowerShellからGoogleユーザーを作成する ☁️ 🚵🏼 🚓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは！
 
 この記事では、PowerShellがGoogle APIと対話してG Suiteユーザーを操作する方法について説明します。
 
 組織では、いくつかの内部サービスとクラウドサービスを使用しています。ほとんどの場合、それらの権限はGoogleまたはActive Directoryに...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>APIを介してPowerShellからGoogleユーザーを作成する</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468969/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、PowerShellがGoogle APIと対話してG Suiteユーザーを操作する方法について説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
組織では、いくつかの内部サービスとクラウドサービスを使用しています。</font><font style="vertical-align: inherit;">ほとんどの場合、それらの権限はGoogleまたはActive Directoryにあります。その間、レプリカを維持することはできません。新しい従業員が解放されると、これら2つのシステムでアカウントを作成/有効化する必要があります。</font><font style="vertical-align: inherit;">プロセスを自動化するために、情報を収集して両方のサービスに送信するスクリプトを作成することにしました。</font></font><br>
<a name="habracut"></a><br>
<h3><font color="#5D8DDF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログインする</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要件を構成して、承認の管理者として実在の人物を使用することを決定しました。これにより、偶発的または意図的な大規模な変更の場合のアクションの分析が簡素化されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Google APIは、認証と承認にOAuth 2.0プロトコルを使用します。</font><font style="vertical-align: inherit;">ユースケースと詳細な説明は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OAuth 2.0を使用したGoogle APIへのアクセスにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デスクトップアプリケーションの承認に使用されるスクリプトを選択しました。</font><font style="vertical-align: inherit;">ユーザーからの不要な移動を必要としないサービスアカウントを使用するオプションもあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下の画像は、Googleページから選択したシナリオの概略図です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wx/sp/rw/wxsprwm-uqyd1koa-2xx4sgjkku.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず、ユーザーをGoogleアカウントの認証ページに送り、GETパラメータを示します。</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションID</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションがアクセスする必要がある領域</font></font></li>
<li>,        </li>
<li>,     </li>
<li> </li>
<li>   </li>
</ul><br>
 </li>
<li>  ,         ,     ,  GET </li>
<li> ()      ,    ,      </li>
<li>   Google API :<br>
 <br>
 <ul>
<li>Access ,      </li>
<li>C   </li>
<li>Refresh ,    Access .</li>
</ul> </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、Google APIコンソールに移動する必要があります：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">資格情報-Google API Consoleで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、必要なアプリケーションを選択し、[資格情報]セクションでクライアントOAuth識別子を作成します。同じ場所（または後で、作成された識別子のプロパティ）で、リダイレクトを許可するアドレスを指定する必要があります。私たちの場合、異なるポートを持ついくつかのlocalhostエントリになります（以下を参照）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトアルゴリズムを読みやすくするために、アプリケーションのアクセストークンと更新トークンを返す別の関数に最初のステップを出力できます。</font></font><br>
<br>
<pre><code class="cs hljs">$client_secret = <span class="hljs-string">'Our Client Secret'</span>
$client_id = <span class="hljs-string">'Our Client ID'</span><font></font>
function Get-GoogleAuthToken {<font></font>
  <span class="hljs-keyword">if</span> (-not [System.Net.HttpListener]::IsSupported) {
    <span class="hljs-string">"HttpListener is not supported."</span>
    exit <span class="hljs-number">1</span><font></font>
  }<font></font>
  $codeverifier = -<span class="hljs-keyword">join</span> ((<span class="hljs-number">65.</span><span class="hljs-number">.90</span>) + (<span class="hljs-number">97.</span><span class="hljs-number">.122</span>) + (<span class="hljs-number">48.</span><span class="hljs-number">.57</span>) + <span class="hljs-number">45</span> + <span class="hljs-number">46</span> + <span class="hljs-number">95</span> + <span class="hljs-number">126</span> |Get-Random -Count <span class="hljs-number">60</span>| % {[<span class="hljs-keyword">char</span>]$_})<font></font>
  $hasher = <span class="hljs-keyword">new</span>-<span class="hljs-keyword">object</span> System.Security.Cryptography.SHA256Managed<font></font>
  $hashByteArray = $hasher.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($codeverifier))<font></font>
  $base64 = ((([System.Convert]::ToBase64String($hashByteArray)).replace(<span class="hljs-string">'='</span>,<span class="hljs-string">''</span>)).replace(<span class="hljs-string">'+'</span>,<span class="hljs-string">'-'</span>)).replace(<span class="hljs-string">'/'</span>,<span class="hljs-string">'_'</span>)<font></font>
  $ports = @(<span class="hljs-number">10600</span>,<span class="hljs-number">15084</span>,<span class="hljs-number">39700</span>,<span class="hljs-number">42847</span>,<span class="hljs-number">65387</span>,<span class="hljs-number">32079</span>)<font></font>
  $port = $ports[(<span class="hljs-keyword">get</span>-random -Minimum <span class="hljs-number">0</span> -maximum <span class="hljs-number">5</span>)]<font></font>
  Write-Host <span class="hljs-string">"Start browser..."</span>
  Start-Process <span class="hljs-string">"https://accounts.google.com/o/oauth2/v2/auth?code_challenge_method=S256&amp;code_challenge=$base64&amp;access_type=offline&amp;client_id=$client_id&amp;redirect_uri=http://localhost:$port&amp;response_type=code&amp;scope=https://www.googleapis.com/auth/admin.directory.user https://www.googleapis.com/auth/admin.directory.group"</span><font></font>
  $listener = New-Object System.Net.HttpListener<font></font>
  $listener.Prefixes.Add(<span class="hljs-string">"http://localhost:"</span>+$port+<span class="hljs-string">'/'</span>)
  <span class="hljs-keyword">try</span> {$listener.Start()} <span class="hljs-keyword">catch</span> {
    <span class="hljs-string">"Unable to start listener."</span>
    exit <span class="hljs-number">1</span><font></font>
  }<font></font>
  <span class="hljs-keyword">while</span> (($code -eq $<span class="hljs-literal">null</span>)) {<font></font>
    $context = $listener.GetContext()<font></font>
    Write-Host <span class="hljs-string">"Connection accepted"</span> -f <span class="hljs-string">'mag'</span><font></font>
    $url = $context.Request.RawUrl<font></font>
    $code = $url.split(<span class="hljs-string">'?'</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">'='</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">'&amp;'</span>)[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">if</span> ($url.split(<span class="hljs-string">'?'</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">'='</span>)[<span class="hljs-number">0</span>] -eq <span class="hljs-string">'error'</span>) {<font></font>
      Write-Host <span class="hljs-string">"Error!"</span>$code -f <span class="hljs-string">'red'</span>
      $buffer = [System.Text.Encoding]::UTF8.GetBytes(<span class="hljs-string">"Error!"</span>+$code)<font></font>
      $context.Response.ContentLength64 = $buffer.Length<font></font>
      $context.Response.OutputStream.Write($buffer, <span class="hljs-number">0</span>, $buffer.Length)<font></font>
      $context.Response.OutputStream.Close()<font></font>
      $listener.Stop()<font></font>
      exit <span class="hljs-number">1</span><font></font>
    }<font></font>
    $buffer = [System.Text.Encoding]::UTF8.GetBytes(<span class="hljs-string">"Now you can close this browser tab."</span>)<font></font>
    $context.Response.ContentLength64 = $buffer.Length<font></font>
    $context.Response.OutputStream.Write($buffer, <span class="hljs-number">0</span>, $buffer.Length)<font></font>
    $context.Response.OutputStream.Close()<font></font>
    $listener.Stop()<font></font>
  }<font></font>
  Return Invoke-RestMethod -Method Post -Uri <span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span> -Body @{<font></font>
    code = $code<font></font>
    client_id = $client_id<font></font>
    client_secret = $client_secret<font></font>
    redirect_uri = <span class="hljs-string">'http://localhost:'</span>+$port<font></font>
    grant_type = <span class="hljs-string">'authorization_code'</span><font></font>
    code_verifier   = $codeverifier<font></font>
  }<font></font>
  $code = $<span class="hljs-literal">null</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OAuthクライアント識別子のプロパティで取得したクライアントIDとクライアントシークレットを設定します。コード検証は43〜128文字の文字列で、予約されていない文字からランダムに生成する必要があります：[AZ] / [az] / [0-9 ] / "-" / "。" / "_" / "〜"。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、このコードは再送信されます。これにより、ユーザーの承認後にリダイレクトを返す応答を攻撃者が傍受できる脆弱性が排除されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在のリクエストでコードベリファイアを平文で送信する（無意味にする-これはSHA256をサポートしないシステムにのみ適しています）、またはBASE64Urlでエンコードする必要があるSHA256アルゴリズムを使用してハッシュを作成し（テーブルの2文字がBase64と異なる）、文字を削除できます。行末：=。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ローカルマシンでhttpをリッスンして、承認後に応答を取得する必要があります。これはリダイレクトとして返されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
管理タスクは特別なサーバーで実行され、複数の管理者が同時にスクリプトを実行する可能性を排除できないため、現在のユーザーのポートをランダムに選択しますが、定義済みのポートを指定しました。また、APIコンソールで信頼できるものとして追加する必要があります。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACCESS_TYPE =オフライン</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションがブラウザでユーザーとの対話なしに独立してトークン期限切れ更新できるという意味では、</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">response_type =コードは</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードが返されますどのようにするためのフォーマットを設定します（ユーザーがスクリプトに、ブラウザからコードをコピーしたときに、古い認証方法を参照）、</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スコープ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エリアとアクセスのタイプを示します。スペースまたは％20（URLエンコーディングによる）で区切る必要があります。タイプを含むアクセス領域のリストは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Google APIのOAuth 2.0スコープで確認できます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
認証コードを受信すると、アプリケーションはブラウザに終了メッセージを返し、ポートの待機を停止し、トークンを受信するためのPOSTリクエストを送信します。その中に、コンソールAPIから以前に設定されたIDとシークレット、ユーザーのリダイレクト先のアドレス、およびプロトコル仕様に基づくgrant_typeが示されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
応答として、アクセストークン、その期間（秒単位）、およびアクセストークンを更新できる更新トークンを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションは、有効期間が長い安全な場所にトークンを格納する必要があるため、取得したアクセスを取り消すまで、更新トークンはアプリケーションに返されません。</font><font style="vertical-align: inherit;">最後に、トークンを取り消す要求を追加しました。アプリケーションが正常に完了せず、更新トークンが返されなかった場合は、手順が再び開始されます（トークンを端末にローカルに保存するのは安全ではないと考えましたが、暗号化を複雑にしたり、ブラウザーを頻繁に開いたりしたくないので）。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">do</span> {<font></font>
  $token_result = Get-GoogleAuthToken<font></font>
  $token = $token_result.<span class="hljs-function">access_token
  <span class="hljs-title">if</span> (<span class="hljs-params">$token_result.refresh_token -eq $<span class="hljs-literal">null</span></span>)</span> {<font></font>
    Write-Host (<span class="hljs-string">"Session is not destroyed. Revoking token..."</span>)<font></font>
    Invoke-WebRequest -Uri (<span class="hljs-string">"https://accounts.google.com/o/oauth2/revoke?token="</span>+$token)<font></font>
  }<font></font>
} <span class="hljs-keyword">while</span> ($token_result.refresh_token -eq $<span class="hljs-literal">null</span>)<font></font>
$refresh_token = $token_result.refresh_token<font></font>
$minute = ([<span class="hljs-keyword">int</span>](<span class="hljs-string">"{0:mm}"</span> -f ([timespan]::fromseconds($token_result.expires_in))))+((Get-date).Minute)<span class="hljs-number">-2</span>
<span class="hljs-keyword">if</span> ($minute -lt <span class="hljs-number">0</span>) {$minute += <span class="hljs-number">60</span>}<font></font>
elseif ($minute -gt <span class="hljs-number">59</span>) {$minute -=<span class="hljs-number">60</span>}<font></font>
$token_expire = @{<font></font>
  hour = ([<span class="hljs-keyword">int</span>](<span class="hljs-string">"{0:hh}"</span> -f ([timespan]::fromseconds($token_result.expires_in))))+((Get-date).Hour)<font></font>
  minute = $minute<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
お気づきかもしれませんが、トークンを呼び出すときには、Invoke-WebRequestが使用されます。</font><font style="vertical-align: inherit;">Invoke-RestMethodとは異なり、受信したデータを使いやすい形式で返さず、リクエストのステータスを表示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、スクリプトはユーザーの姓名の入力を求め、ユーザー名+メールを生成します。</font></font><br>
<br>
<h3><font color="#5D8DDF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">お問い合わせ</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下はリクエストです。まず、新しいログインを作成するか、現在のログインをオンにするかを決定するには、そのようなログインを持つユーザーがすでに存在するかどうかを確認する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのリクエストを、スイッチを使用して選択する単一の関数の形式で実装することにしました。</font></font><br>
<br>
<pre><code class="cs hljs">function GoogleQuery {<font></font>
  param (<font></font>
    $type,<font></font>
    $query<font></font>
  )<font></font>
  <span class="hljs-keyword">switch</span> ($type) {
    <span class="hljs-string">"SearchAccount"</span> {<font></font>
      Return Invoke-RestMethod -Method Get -Uri <span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users"</span> -Headers @{Authorization = <span class="hljs-string">"Bearer "</span>+(Get-GoogleToken)} -Body @{<font></font>
        domain = <span class="hljs-string">'rocketguys.com'</span>
        query  = <span class="hljs-string">"email:$query"</span><font></font>
      }<font></font>
    }<font></font>
    <span class="hljs-string">"UpdateAccount"</span> {<font></font>
      $body = @{<font></font>
        name  = @{<font></font>
          givenName = $query[<span class="hljs-string">'givenName'</span>]<font></font>
          familyName = $query[<span class="hljs-string">'familyName'</span>]<font></font>
        }<font></font>
        suspended = <span class="hljs-string">'false'</span>
        password = $query[<span class="hljs-string">'password'</span>]<font></font>
        changePasswordAtNextLogin = <span class="hljs-string">'true'</span><font></font>
        phones = @(@{<font></font>
          primary = <span class="hljs-string">'true'</span>
          <span class="hljs-keyword">value</span> = $query[<span class="hljs-string">'phone'</span>]<font></font>
          type = <span class="hljs-string">"mobile"</span><font></font>
        })<font></font>
        orgUnitPath = $query[<span class="hljs-string">'orgunit'</span>]<font></font>
      }<font></font>
      Return Invoke-RestMethod -Method Put -Uri (<span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users/"</span>+$query[<span class="hljs-string">'email'</span>]) -Headers @{Authorization = <span class="hljs-string">"Bearer "</span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string">'application/json; charset=utf-8'</span><font></font>
    }<font></font>
    <font></font>
    <span class="hljs-string">"CreateAccount"</span> {<font></font>
      $body = @{<font></font>
        primaryEmail = $query[<span class="hljs-string">'email'</span>]<font></font>
        name  = @{<font></font>
          givenName = $query[<span class="hljs-string">'givenName'</span>]<font></font>
          familyName = $query[<span class="hljs-string">'familyName'</span>]<font></font>
        }<font></font>
        suspended = <span class="hljs-string">'false'</span>
        password = $query[<span class="hljs-string">'password'</span>]<font></font>
        changePasswordAtNextLogin = <span class="hljs-string">'true'</span><font></font>
        phones = @(@{<font></font>
          primary = <span class="hljs-string">'true'</span>
          <span class="hljs-keyword">value</span> = $query[<span class="hljs-string">'phone'</span>]<font></font>
          type = <span class="hljs-string">"mobile"</span><font></font>
        })<font></font>
        orgUnitPath = $query[<span class="hljs-string">'orgunit'</span>]<font></font>
      }<font></font>
      Return Invoke-RestMethod -Method Post -Uri <span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users"</span> -Headers @{Authorization = <span class="hljs-string">"Bearer "</span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string">'application/json; charset=utf-8'</span><font></font>
    }<font></font>
    <span class="hljs-string">"AddMember"</span> {<font></font>
      $body = @{<font></font>
        userKey = $query[<span class="hljs-string">'email'</span>]<font></font>
      }<font></font>
      $ifrequest = Invoke-RestMethod -Method Get -Uri <span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/groups"</span> -Headers @{Authorization = <span class="hljs-string">"Bearer "</span>+(Get-GoogleToken)} -Body $body<font></font>
      $array = @()<font></font>
      <span class="hljs-keyword">foreach</span> ($<span class="hljs-keyword">group</span> <span class="hljs-keyword">in</span> $ifrequest.groups) {$array += $<span class="hljs-keyword">group</span>.email}
      <span class="hljs-keyword">if</span> ($array -notcontains $query[<span class="hljs-string">'groupkey'</span>]) {<font></font>
        $body = @{<font></font>
          email = $query[<span class="hljs-string">'email'</span>]<font></font>
          role = <span class="hljs-string">"MEMBER"</span><font></font>
        }<font></font>
        Return Invoke-RestMethod -Method Post -Uri (<span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/groups/"</span>+$query[<span class="hljs-string">'groupkey'</span>]+<span class="hljs-string">"/members"</span>) -Headers @{Authorization = <span class="hljs-string">"Bearer "</span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string">'application/json; charset=utf-8'</span>
      } <span class="hljs-keyword">else</span> {<font></font>
        Return ($query[<span class="hljs-string">'email'</span>]+<span class="hljs-string">" now is a member of "</span>+$query[<span class="hljs-string">'groupkey'</span>])<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各リクエストでは、トークンのタイプとアクセストークン自体を含むAuthorizationヘッダーを送信する必要があります。</font><font style="vertical-align: inherit;">現時点では、トークンのタイプは常にベアラーです。</font><font style="vertical-align: inherit;">なぜなら </font><font style="vertical-align: inherit;">トークンの有効期限が切れていないことを確認し、トークンが発行されてから1時間後に更新する必要があります。Accessトークンを返す別の関数のリクエストを示しました。</font><font style="vertical-align: inherit;">同じコードが、最初のアクセストークンを受け取ったときのスクリプトの先頭にあります。</font></font><br>
<br>
<pre><code class="cs hljs">function Get-GoogleToken {
  <span class="hljs-keyword">if</span> (((Get-date).Hour -gt $token_expire.hour) -or (((Get-date).Hour -ge $token_expire.hour) -and ((Get-date).Minute -gt $token_expire.minute))) {<font></font>
  Write-Host <span class="hljs-string">"Token Expired. Refreshing..."</span>
    $request = (Invoke-RestMethod -Method Post -Uri <span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span> -ContentType <span class="hljs-string">'application/x-www-form-urlencoded'</span> -Body @{<font></font>
      client_id = $client_id<font></font>
      client_secret = $client_secret<font></font>
      refresh_token = $refresh_token<font></font>
      grant_type = <span class="hljs-string">'refresh_token'</span><font></font>
    })<font></font>
    $token = $request.access_token<font></font>
    $minute = ([<span class="hljs-keyword">int</span>](<span class="hljs-string">"{0:mm}"</span> -f ([timespan]::fromseconds($request.expires_in))))+((Get-date).Minute)<span class="hljs-number">-2</span>
    <span class="hljs-keyword">if</span> ($minute -lt <span class="hljs-number">0</span>) {$minute += <span class="hljs-number">60</span>}<font></font>
    elseif ($minute -gt <span class="hljs-number">59</span>) {$minute -=<span class="hljs-number">60</span>}<font></font>
    $script:token_expire = @{<font></font>
      hour = ([<span class="hljs-keyword">int</span>](<span class="hljs-string">"{0:hh}"</span> -f ([timespan]::fromseconds($request.expires_in))))+((Get-date).Hour)<font></font>
      minute = $minute<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> $token<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログインの存在を確認する：</font></font><br>
<br>
<pre><code class="cs hljs">function Check_Google {<font></font>
  $query = (GoogleQuery <span class="hljs-string">'SearchAccount'</span> $username)
  <span class="hljs-keyword">if</span> ($query.users -ne $<span class="hljs-literal">null</span>) {<font></font>
    $user = $query.users[<span class="hljs-number">0</span>]<font></font>
    Write-Host $user.name.fullName<span class="hljs-string">' - '</span>$user.PrimaryEmail<span class="hljs-string">' - suspended: '</span>$user.Suspended<font></font>
    $GAresult = $user<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> ($GAresult) {<font></font>
      $<span class="hljs-keyword">return</span> = $GAresult<font></font>
  } <span class="hljs-keyword">else</span> {$<span class="hljs-keyword">return</span> = <span class="hljs-string">'gg'</span>}
  <span class="hljs-keyword">return</span> $<span class="hljs-keyword">return</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メールリクエスト：$クエリは、エイリアスを含むこのメールでユーザーを検索するようAPIに要求します。</font><font style="vertical-align: inherit;">ワイルドカードを使用することもできます：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=、：、：{PREFIX} *</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを取得するには、GETリクエストメソッドを使用して、データを挿入します（アカウントを作成するか、メンバーをグループに追加します）-POST、既存のデータを更新します-PUT、エントリを削除します（たとえば、グループからの参加者）-DELETE。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、スクリプトは電話番号（無効な文字列）を要求し、それを地域の配布グループに含めるよう要求します。</font><font style="vertical-align: inherit;">選択したActive Directory OUに基づいてユーザーが持つべき組織単位を決定し、パスワードを作成します。</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">do</span> {<font></font>
  $phone = Read-Host <span class="hljs-string">"   +7"</span>
} <span class="hljs-keyword">while</span> (-not $phone)
<span class="hljs-keyword">do</span> {<font></font>
    $moscow = Read-Host <span class="hljs-string">"  ? (y/n) "</span>
} <span class="hljs-keyword">while</span> (-not (($moscow -eq <span class="hljs-string">'y'</span>) -or ($moscow -eq <span class="hljs-string">'n'</span>)))<font></font>
$orgunit = <span class="hljs-string">'/'</span>
<span class="hljs-keyword">if</span> ($OU -like <span class="hljs-string">"*OU=Delivery,OU=Users,OU=ROOT,DC=rocket,DC=local"</span>) {<font></font>
    Write-host <span class="hljs-string">"   /Team delivery"</span>
    $orgunit = <span class="hljs-string">"/Team delivery"</span><font></font>
}<font></font>
$Password =  -<span class="hljs-keyword">join</span> ( <span class="hljs-number">48.</span><span class="hljs-number">.57</span> + <span class="hljs-number">65.</span><span class="hljs-number">.90</span> + <span class="hljs-number">97.</span><span class="hljs-number">.122</span> | Get-Random -Count <span class="hljs-number">12</span> | % {[<span class="hljs-keyword">char</span>]$_})+<span class="hljs-string">"*Ba"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、アカウントの操作を開始します。</font></font><br>
<br>
<pre><code class="cs hljs">$query = @{<font></font>
  email = $email<font></font>
  givenName = $firstname<font></font>
  familyName = $lastname<font></font>
  password = $password<font></font>
  phone = $phone<font></font>
  orgunit = $orgunit<font></font>
}<font></font>
<span class="hljs-keyword">if</span> ($GMailExist) {<font></font>
  Write-Host <span class="hljs-string">"  "</span> -<span class="hljs-function">f <span class="hljs-title">mag</span>
  (<span class="hljs-params">GoogleQuery <span class="hljs-string">'UpdateAccount'</span> $query</span>) | fl
  write-host "      $Username  Google."
} else</span> {<font></font>
  Write-Host <span class="hljs-string">"  "</span> -<span class="hljs-function">f <span class="hljs-title">mag</span>
  (<span class="hljs-params">GoogleQuery <span class="hljs-string">'CreateAccount'</span> $query</span>) | fl
}
<span class="hljs-title">if</span> (<span class="hljs-params">$moscow -eq <span class="hljs-string">"y"</span></span>)</span>{<font></font>
  write-host <span class="hljs-string">"   moscowoffice"</span><font></font>
  $query = @{<font></font>
    groupkey = <span class="hljs-string">'moscowoffice@rocketguys.com'</span><font></font>
    email = $email<font></font>
  }<font></font>
  (GoogleQuery <span class="hljs-string">'AddMember'</span> $query) | fl<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アカウントの更新と作成の機能は同じ構文であり、すべての追加フィールドが必須というわけではありません。電話番号のセクションでは、番号とそのタイプを持つ1つのレコードから含めることができる配列を指定する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーをグループに追加するときにエラーが発生しないようにするために、まずユーザー自身からグループメンバーのリストまたはコンポジションを受信することにより、そのユーザーがこのグループにすでに属しているかどうかを確認できます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のユーザーのグループの構成の要求は再帰的ではなく、直接のメンバーシップのみが表示されます。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーがメンバーである子グループがすでに存在する親グループへのユーザーの組み込みは成功します。</font></font><br>
<br>
<h3><font color="#5D8DDF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーに新しいアカウントのパスワードを送信するために残ります。</font><font style="vertical-align: inherit;">これはSMSを介して行われ、手順と一般的な情報を送信し、個人用メールにログインします。個人用メールは、電話番号とともに、人材選択部門から提供されました。</font><font style="vertical-align: inherit;">別の方法として、お金を節約し、秘密の電報チャットにパスワードを送信することもできます。これも2番目の要素と見なすことができます（macbooksは例外です）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後までお読みいただきありがとうございます。</font><font style="vertical-align: inherit;">私は記事を書くスタイルを改善するための提案を見てうれしいです、そしてスクリプトを書くときにあなたがより少ない間違いをとらえることを望みます=）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主題的に有用であるか、または単にあなたの質問に答えることができるリンクのリスト：</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モバイルおよびデスクトップアプリ向けOAuth 2.0</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebサーバーアプリケーションでのOAuth 2.0の使用</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OAuthパブリッククライアントによるコード交換の証明キー</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShellでランダムな文字を生成する</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASCIIテーブルと説明</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShell：文字列のハッシュ値を取得する</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base64Urlのエンコード/デコード</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base64エンコーディングとBase64urlエンコーディング</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShell 5.1のInvoke-RestMethod</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手順1でaccess_typeがオフラインであっても更新トークンを取得しない</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">比較演算子について</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Directory API：ユーザーアカウント</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーを検索</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Directory API：グループ</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoke-RestMethodのエラー処理-Powershell</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja468957/index.html">Unexploredの例におけるサイクリックダンジョンの生成</a></li>
<li><a href="../ja468959/index.html">あられのマルチモジュールプロジェクトの依存関係管理</a></li>
<li><a href="../ja468961/index.html">560ドルで生活の中のルーチンを取り除く方法は？または生きる方法ではなく、生きる方法</a></li>
<li><a href="../ja468963/index.html">バックアップ、読者のリクエストに応じて一部：UrBackupの概要、BackupPC、AMANDA</a></li>
<li><a href="../ja468967/index.html">TAUの動的方程式を得る「技術」。そして、なぜシステム識別は厄介であり、「正直な物理学」が支配するのか</a></li>
<li><a href="../ja468971/index.html">ニンテンドーDS用のJavaで書く</a></li>
<li><a href="../ja468973/index.html">PythonでTensorflowを使用して衛星画像を分類するためのニューラルネットワーク</a></li>
<li><a href="../ja468989/index.html">UEBAマーケットダイ-ロングライブUEBA</a></li>
<li><a href="../ja468991/index.html">モジュラースプライトキャラクターとそのアニメーション</a></li>
<li><a href="../ja468993/index.html">Oculus QuestがPCに接続し、手を見る</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>