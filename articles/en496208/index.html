<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèº üïú üê∑ How JIT inlines our C # code (heuristics) üàÇÔ∏è üë©‚Äçüíª üëéüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Inlining is one of the most important optimizations in compilers. It not only removes the overhead from the call, but also opens up many possibilities...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How JIT inlines our C # code (heuristics)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496208/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inlining is one of the most important optimizations in compilers. It not only removes the overhead from the call, but also opens up many possibilities for other optimizations, for example, constant folding, dead code elimination, etc. Moreover, sometimes inlining leads to a decrease in the size of the calling function! I asked several people if they knew by what rules the functions in C # are inlined, and most answered that the JIT looks at the size of the IL code and inlines only small functions with a size of, say, up to 32 bytes. Therefore, I decided to write this post to disclose implementation details with the help of such an example, which will show several heuristics in action at once:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mv/iv/du/mvivdukz21t0nffkwemqibomtsq.png"><br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do you think the call to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Volume</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> constructor will be inlined </font><font style="vertical-align: inherit;">here? Obviously not. It is too large, especially due to the heavyweight </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">throw new</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operators, which lead to a rather bold codegen. Let's check in Disasmo: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8r/2o/v0/8r2ov0qz705abeh6pp-6zuyeo2g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inline! Moreover, all exceptions and their branches have successfully deleted! You can say something in the style of ‚ÄúAh, okay, the jit is very smart and did a full analysis of all candidates for inline, looked what would happen if you pass specific arguments‚Äù or ‚ÄúThe jit tries to inline everything that is possible, performs all the optimizations, and then decides profitably it or not ‚Äù(pick up combinatorics and calculate the complexity of this operation, for example, for a call graph of ten or two methods).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well ... no, this is unrealistic, especially in terms of just in time. Therefore, most compilers use the so-called observations and heuristics to solve this classic </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backpack problem</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and try to determine their own budget and fit into it as efficiently as possible (and no, PGO is not a panacea). RyuJIT has positive and negative observations. Positive increase the coefficient of benefit (benefit multiplier). The higher the coefficient, the more code we can inline. Negative observations on the contrary - lower it or even prohibit inlining. Let's see what observations RyuJIT made for our example: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/zy/3f/ejzy3fi8jlcuaumh3pdc6szdfm8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These observations can be seen in the logs from COMPlus_JitDump (for example, in Disasmo): </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9o/0q/a3/9o0qa370-1vcsnvx7rxvqqisswm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All these simple observations increased the coefficient from </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11.5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and helped to successfully overcome the budget of the inlineer, for example, the fact that we pass a constant argument and it is compared with another constant tells us that with a high degree of probability after collapsing the constants one of the condition branches will be deleted and the code will become smaller. </font><font style="vertical-align: inherit;">Or, for example, the fact that this is a constructor and it is called inside the loop is also a hint to the jit that it should soften the requirements for inlining. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to benefit multiplier, RyuJIT also uses observations to predict the size of the native function code and its performance impact using magic constants in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EstimateCodeSize ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EstimatePerformanceImpact ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> obtained using ML. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, did you notice this trick ?:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">if</span> ((<span class="hljs-keyword">value</span> - <span class="hljs-string">'A'</span>) &gt; (<span class="hljs-string">'Z'</span> - <span class="hljs-string">'A'</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is an optimized version for:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span> &lt; <span class="hljs-string">'A'</span> || <span class="hljs-keyword">value</span> &gt; <span class="hljs-string">'Z'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Both expressions are one and the same, but in the first case we have one base unit, and in the second there are three of them. </font><font style="vertical-align: inherit;">It turns out that inliner has a strict limit on the number of base blocks in the function and if it exceeds 5 then it doesn‚Äôt matter how big our benefit multiplier is - inlining is canceled. </font><font style="vertical-align: inherit;">So I applied this trick to fit into this strict requirement. </font><font style="vertical-align: inherit;">It would be great if Roslyn did it for me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Issue in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Roslyn</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/dotnet/runtime/issues/13347</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
of PR in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RyuJIT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (my awkward attempt): </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/dotnet/coreclr/pull/27480 </font></font></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I described an example of why it makes sense to do not only in Jit but and in the C # compiler.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inlining and virtual methods</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is clear here, you cannot inline what there is no information about at the compilation stage, although if the type or method is sealed then </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">why not</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inlining and throwing exceptions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If a method never returns a value (for example, it just does </font></font><code>throw new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...), then such methods are automatically marked as throw-helpers and will not inline. </font><font style="vertical-align: inherit;">This is such a way to sweep the complex codegen from </font></font><code>throw new</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">under the carpet and appease the inliner.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inlining and [AggressiveInlining] attribute</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, you </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recommend that the</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inlineer inline the method, but you have to be extremely careful for two reasons:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perhaps you optimize one case and worsen all the others (for example, improve the case of constant arguments) by the size of the codegen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inlining often generates a large number of temporary variables that can exceed a certain limit - the number of variables whose life cycle RyuJIT can track (512) and after that the code will begin to grow into terrible spills on the stack and slow down greatly. </font><font style="vertical-align: inherit;">Two good examples: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tyts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tyts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inlining and dynamic methods</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Currently, such methods do not inline and do not inline themselves: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/dotnet/runtime/issues/34500</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My attempt to write my heuristic</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recently, I tried to write your own heuristics to help here such an occasion: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tw/pl/cu/twplcuelj-n790gvbxftqhl_cvw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">post last</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I mentioned that I recently optimized to RyuJIT calculation of the length of the constant strings ( </font></font><code>"Hello".Length -&gt; 5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we see that if zainlaynit), and so, in the example above ^ </font></font><code>Validate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code>Test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, we get </font></font><code>if ("hello".Length &gt; 10)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">what is optimized in </font></font><code>if (5 &gt; 10)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">what is optimized in the removal of the entire condition / branch. However, the inliner refused to inline </font></font><code>Validate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pn/za/6g/pnza6gdpjfmkgarek834nctlfci.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the main problem here is that there is no heuristic yet that tells the jit that we are passing a constant string to </font></font><code>System.String::get_Length</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which means that the callvirt-call will most likely collapse into a constant and the whole branch will be deleted. Actually, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my heuristic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and adds this observation (the only minus is that you have to resolve all callvirts, which is not very fast). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are other restrictions, a list of which can be found in general </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can read the thoughts of one of the main JIT developers about the design of the inliner and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">his article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the use of Machine Learning for this case.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496194/index.html">On the binarization of fine structure tomographic images</a></li>
<li><a href="../en496196/index.html">DEFCON Conference 26. Wagging the tail: covert passive surveillance. Part 1</a></li>
<li><a href="../en496198/index.html">Presentations of the second ROS Meetup on the topic of training robots</a></li>
<li><a href="../en496204/index.html">CI / CD Process Update: Preparation and Planning</a></li>
<li><a href="../en496206/index.html">A billion operations in the database in 0.3 seconds. Do not compare OLTP with OLAP, but QuestDB with PostgreSQL</a></li>
<li><a href="../en496210/index.html">Biodiversity may have evolved from the principle of playing rock-paper-scissors</a></li>
<li><a href="../en496212/index.html"># 04 - And a whole byte is not enough ... | Take BK by the horns</a></li>
<li><a href="../en496214/index.html">AdColony: 89% of publishers of mobile apps and games use promotional videos</a></li>
<li><a href="../en496216/index.html">Dark store: are you already thinking about this?</a></li>
<li><a href="../en496220/index.html">Provide udalenku and do not screw up. IT Director Tips</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>