<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖕🏻 📗 ☝🏾 「ナイト」の悪夢：DevOpsに関する有益なストーリー 🧓🏽 😘 🌙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1066年、バイキングによるイギリス侵攻が始まってから200年以上が経過しました。ハロルド王は騎士団を集め、ダーウェント川に向かって同名の部隊であるノルウェー王ハラルドとの決定的な戦いのために行進した。銃工たちは1か月間働き、スカンジナビアの斧に騎士が当たるのを防ぐのに十分な新世代の鎧を作りました。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>「ナイト」の悪夢：DevOpsに関する有益なストーリー</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/moex/blog/458304/"><img src="https://habrastorage.org/webt/im/2a/ct/im2actpwxzvrz1_j4k-2easujdy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1066年、バイキングによるイギリス侵攻が始まってから200年以上が経過しました。ハロルド王は騎士団を集め、ダーウェント川に向かって同名の部隊であるノルウェー王ハラルドとの決定的な戦いのために行進した。銃工たちは1か月間働き、スカンジナビアの斧に騎士が当たるのを防ぐのに十分な新世代の鎧を作りました。そして、これまでにトーナメントで何回の実験と試行が行われたか！しかし、期待はそれ自体正当化されるべきでした-軽量で信頼性の高い機器は、徒歩でも、大きな損失なしにバイキングを分散させることができました。そして最後に、スタンフォードブリッジで会いました。光沢のある鎧を着た指揮官が率いる騎士団の主な分遣隊は、敵と橋の真ん中で衝突しました。はい、ポドゴルニーマスターの鋼がパンチを握っています！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゆっくりと、しかし確実に、バイキングは総当たり戦の防御に向かって動いています。</font><font style="vertical-align: inherit;">勝利が近いようです。</font><font style="vertical-align: inherit;">そして戦場で、ついに騎士の指揮官とノルウェーの首長がお互いを見つけます。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
両手槍の斧はすでに壊れており、彼は通常のサクソンで身を守ることを余儀なくされています。これは騎士と半剣に例えることはできません。</font><font style="vertical-align: inherit;">短剣のある波-指揮官の鎧はペンナイフのようですが、それは鎧を通り抜けます...魔法が効いているようです-隣の騎士の鎧が点在しています！</font><font style="vertical-align: inherit;">別の波が、再びターゲットに向かい、今度は装甲の左側にある騎士が突然赤熱します。</font><font style="vertical-align: inherit;">3番目の打撃-騎士は目の前で泳ぎ、つまずき、転倒し、二度と立ち上がることはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「*** ** **** ****！」月曜日の朝5時に冷や汗で目覚めたペトロビッチは叫んだ。すべてが完全にうまくいかなかった：午後11時に彼はツンドラの性質に関する子供の報告の資料を探してウィキペディアに登ったが、朝の1時までに彼はどういうわけか彼はイギリスのバイキングの侵入の説明に気付いた。また、週末には、今日から始まる次のリリースの戦いが繰り広げられました。いつものように、私たちは長期間にわたって徹底的にテストし、すべてがスムーズに進むかどうかにかかわらず、継続的インテグレーションシステムを100万回実行しました... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸運なことに一部の人にとっては残念ながら被害者にとっては、何かを改善して追加を得るために他の人の過ちから学ぶ機会が常にあります自信の部分。この翻訳された記事では、もう一度詳しく説明しますが、「私たちの」業界の事例の1つを思い出してください。</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
昨年のカンファレンスでは、DevOps、コードとしての構成、継続的デリバリーについて話しました。</font><font style="vertical-align: inherit;">以下のストーリーを使用して、DevOps / Continuous Deliveryイニシアチブの一部として、完全に自動化された再現可能なデプロイメントを作成することの重要性を説明しました。</font><font style="vertical-align: inherit;">会議の後、何人かの人がブログで話を共有するように頼みました。</font><font style="vertical-align: inherit;">これは絶対に本当の話です。</font><font style="vertical-align: inherit;">これは私が読んだことの改定であり、私自身はこれに参加しませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、約4億ドルの資産を持つ企業が、導入の失敗により45分で倒産したという話です。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少し背景</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ナイトキャピタルグループ（英語で「ナイト」は「ナイト」を意味します）は、マーケットメイキング、電子執行、機関投資家向け販売および取引に従事するアメリカのグローバル金融会社です。 2012年、ナイトは米国株式の最大のトレーダーであり、NYSEとNASDAQの市場シェアは約17％でした。 Knight's Electronic Trading Group（ETG）は、1日あたり平均33億を超えるトランザクションの1日あたりの平均取引量を管理し、1日あたり210億ドルを超える取引を行っています。冗談じゃないよ！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012年7月31日の時点で、ナイトの現金および現金同等物は約3億6500万ドルでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012年8月1日、ニューヨーク証券取引所は、新しいリテール流動性プログラムであるリテール流動性プログラム（ナイトなどのリテールブローカーを通じて個人投資家向けの価格設定を改善するために設計されたプログラム）を開始する予定でした。このイベントの準備として、Knightは自動化された高速アルゴリズムルーターSMARSを更新しました。SMARSは注文を市場に送信して実行します。 SMARSの主な機能の1つは、Knights取引プラットフォームの他のコンポーネント（「親」アプリケーション）からアプリケーションを受信し、1つ以上の「子」アプリケーションを送信して実行することです。つまり、SMARSは、取引プラットフォームから大量の注文を受け取り、それらをいくつかの小さな注文に分割して、株の買い手/売り手を見つけます。親アプリケーションが大きいほど、より多くの子入札が作成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SMARSの更新は、「Power Peg」と呼ばれる古い未使用のコードに代わるものでした。この機能のKnightは8年間使用していませんでした。</font><font style="vertical-align: inherit;">更新されたコードは、Power Peg機能をアクティブにするために使用された古いフラグを再割り当てしました。</font><font style="vertical-align: inherit;">コードは徹底的にテストされ、正しく機能し、信頼性がありました。</font><font style="vertical-align: inherit;">何が悪かったのでしょうか？</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何が悪かったのでしょうか？</font><font style="vertical-align: inherit;">そして本当に！</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012年7月27日から2012年7月31日までの間に、ナイトは新しいソフトウェアを1日あたり限られた数のサーバー（合計8台）に手動で展開しました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SECのドキュメントで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">、手動での展開について次</font><font style="vertical-align: inherit;">のように述べ</font><font style="vertical-align: inherit;">ています（SECは、米国株式市場の規制機関である証券取引委員会です）。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「新しいコードの導入中、Knightの従業員の1人は新しいコードを8つのSMARSサーバーの1つにコピーしませんでした。</font><font style="vertical-align: inherit;">ナイトはこの展開の2回目のテクニカルレビューを実施しなかったため、8台目のサーバーからPower Pegコードが削除されず、新しいRLPコードが追加されませんでした。</font><font style="vertical-align: inherit;">同社には、再検証を必要とする適切な手順がありませんでした。」</font><font style="vertical-align: inherit;">リリース番号70694、2013年10月16日</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012年8月1日の午前9時30分（EST）に市場が開き、ナイトは新しいリテール流動性プログラムで顧客に代わってブローカーディーラーからのリクエストの処理を開始しました。</font><font style="vertical-align: inherit;">正しく展開された7台のサーバーは、アプリケーションを正しく処理し始めました。</font><font style="vertical-align: inherit;">そして、8番目のサーバーに移動したアプリケーションは、変更されたフラグをアクティブにし、Power Pegを復活させた可能性があります。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゾンビアタック：キラーコード</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、「死んだ」Power Pegコードが必要な理由を説明する必要があります。この機能は、子注文の実行の結果として親の要求で売買された株式をカウントするためのものでした。親アプリケーションの実行後、Power Pegは子アプリケーションの送信を禁止します。原則として、Power Pegは子の注文を追跡し、親アプリケーションの完了後にその実行を停止します。 2005年に、Knightはこの累積的な追跡機能をコード実行の初期段階にロールバックしました（したがって、Power Pegから数量追跡を削除しました）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8番目のサーバーのPower Pegフラグがアクティブになると、Power Pegは子注文を実行のためにルーティングし始めましたが、それらを親注文のシェア数と関連付けませんでした-一種の閉ループが発生しました</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地獄45分</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
想像してみてください。追跡なしで自動高速アプリケーションを市場に送信できるシステムと、十分なアプリケーションが完了したかどうかを確認できるシステムがあるとします。</font><font style="vertical-align: inherit;">はい、すべてがとても悪かった。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
午前9時30分に市場が開かれたとき、人々は何かがおかしいことにすぐに気づきました。午前9時31分までに、ウォールストリートの多くの人に深刻な事態が発生していることが明らかになりました。市場は、通常の状況と比較して、特定の株の取引量が異常である入札で殺到しました。彼らはウォールストリートの9:32までに、なぜこの不名誉が止まらないのか疑問に思いました。ほぼいつまでも高速取引。なぜ誰かがそれをしたシステムのkillボタンをクリックしなかったのですか？結局のところ、スイッチはありませんでした。取引の最初の45分間の間に、ナイトからのトランザクションの実行は取引量の50％以上に達し、特定のシェアをその値の10％以上上昇させました。その結果、誤った取引により、その他の株式は下落した。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに悪いことに、Knightシステムは、これらのイベントの前から、午前8時1分（SMARSが市場前取引に適した注文を処理したとき）にも自動メールの送信を開始しました。メッセージで、システムはSMARSを参照し、「Power Peg is not available」というエラーを表示しました。午前8時1分から午前9時30分までの間に、97通の手紙がナイトの従業員に送られました。もちろん、これらの手紙はシステム警告のように見えなかったので、すぐにそれらを見た人はいませんでした。ああ。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
地獄の45分間、ナイトは誤ったトランザクションを停止しようとしました。システムをオフにすることはできず（そのような状況に対応するための文書化された手順もありませんでした）、したがって、ライブ取引条件の問題に対処しようとして、彼らは市場に残り、毎分800万株が販売されました。会社の従業員は、エラーのあるアプリケーションがどこから来たのか判断できなかったため、正しく展開されたサーバーから新しいコードを削除しました。言い換えれば、彼らは作業中のコードを削除し、壊れたままにしました。これは、コードが最初に誤って配置された場所だけでなく、すべてのサーバーでPower Pegコードをアクティブにする追加の親の要求を引き起こす問題を悪化させただけです。最終的に、システムを停止することに成功しました-取引の45分後。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
取引の進行中に、Power Pegコードは212の親の要求を受信して​​処理しました。その結果、SMARSは数百万の子会社を市場に送り、154の取引で400万の取引を完了し、397百万株を超えました。株式市場の専門家にとって、これはナイトが80の異なる会社の株式を35億ドルで購入し、74の会社の株式を31億5000万ドルで売却したことを意味します。しかし、ナイトは現金と現金同等物でわずか3億6500万ドルしか持っていません。 45分で、ナイトはアメリカ株の最大のトレーダーであり、NYSEとNASDAQの主要マーケットメーカーから破産しました。彼らは、損失をカバーするために必要な金額を収集するために48時間を要しました（約6人の投資家からの4億ドルの投資のおかげでそれを行うことができました）。最終的に、Knight Capital GroupはGetco LLCに買収され（2012年12月）、現在の合併会社はKCG Holdingsと呼ばれています。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どのような結論を導き出す必要がありますか</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012年8月1日のイベントは、すべての開発チームとプロジェクトチームのレッスンになるはずです。</font><font style="vertical-align: inherit;">優れたソフトウェアを作成してテストするだけでは不十分です。</font><font style="vertical-align: inherit;">また、あなたが提供する価値を顧客が正確に受け取ることができるように（そしてあなたが会社を破産しないように）、それが市場に正しく届けられることを確認する必要もあります。</font><font style="vertical-align: inherit;">SMARSを配備したエンジニアは、Knightで行われた手順がリスクを考慮していなかったという事実を非難するだけではありません。</font><font style="vertical-align: inherit;">手順（またはその欠如）は明らかに誤りでした。</font><font style="vertical-align: inherit;">展開プロセスが、人々が指示をどのように読み、それに従うかに依存するたびに、あなたは危険にさらされます。</font><font style="vertical-align: inherit;">人々は間違いを犯します。</font><font style="vertical-align: inherit;">エラーは、命令、命令の解釈、またはそれらの実装にある可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レイアウトは自動化され、再現可能であり、可能な限り人為的なミスがないようにする必要があります。</font><font style="vertical-align: inherit;">Knightが自動展開システム（構成、自動展開、およびテストのセット）を実装していた場合、Knightの悪夢に変わったミスは回避できたはずです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下に、継続的デリバリーの原則をいくつか示します（完全な継続的デリバリープロセスを実装していない場合でも）。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソフトウェアのリリースは、再現性と信頼性のあるプロセスでなければなりません。 </font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">できることはすべて自動化します。</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja458286/index.html">ORM：このタスクに解決策がない理由ですが、それを行うにはそれにもかかわらず、何かが必要です</a></li>
<li><a href="../ja458288/index.html">アントン・ベリコフ：「OpenStreetMapの威力を理解する最も簡単な方法は、自分で地図の編集を始めることです」</a></li>
<li><a href="../ja458290/index.html">生細胞における生合成デュアルコアコンピューター</a></li>
<li><a href="../ja458292/index.html">PHPダイジェスト159（2019年6月17日-7月1日）</a></li>
<li><a href="../ja458298/index.html">250,000ルーブル（2パーツ）のソーラーパネルに大きなハーフギアを作りました</a></li>
<li><a href="../ja458306/index.html">先週のフロントエンドの世界からの新鮮な食材のダイジェストNo. 371（2019年6月24日〜30日）</a></li>
<li><a href="../ja458308/index.html">概要：テスラの将来はどうなるか、どのような要因がテスラに影響するか</a></li>
<li><a href="../ja458310/index.html">Telegrafを使用して.NETアプリケーションからメトリックを収集する</a></li>
<li><a href="../ja458312/index.html">モスクワのAndroidアカデミー：上級コース</a></li>
<li><a href="../ja458316/index.html">Yandex Retro Games Battle 2019-ZX Spectrum用のゲームの開発</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>