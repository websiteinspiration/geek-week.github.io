<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏻‍✈️ ↙️ 👁‍🗨 Simulinkから共有ライブラリを呼び出す 🚲 🌓 🎾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！
 Simulinkで共有ライブラリを呼び出す方法について、同僚のミハイルによる記事の翻訳を紹介します。なぜ作成されたのですか？実際、多くの企業がすでに多くのレガシーモデルを再利用したいと考えており、「レガシーをSimulinkに統合するにはどうすればよいですか？」そして、私の遺...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Simulinkから共有ライブラリを呼び出す</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/etmc_exponenta/blog/503908/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル！</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simulinkで共有ライブラリを呼び出す方法について、同僚のミハイルによる記事の翻訳を紹介します。なぜ作成されたのですか？実際、多くの企業がすでに多くのレガシーモデルを再利用したいと考えており、「レガシーをSimulinkに統合するにはどうすればよいですか？」そして、私の遺産がDLLの形式であるなら？」したがって、元の記事が書かれました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
猫の下で、Simulinkで共有ライブラリを呼び出す方法がいくつか説明されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードへのすべての変更は、ミハイルの許可を得て行われ、記事が過負荷にならないように行われました。</font></font><br>
<br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、Simulinkモデルで共有ライブラリの関数を使用する方法を示します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
exmuライブラリをSimulinkに埋め込む必要があるとしましょう。</font><font style="vertical-align: inherit;">そのコードは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.hの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソースに含まれています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これは、3つの関数を含む非常に単純なライブラリです</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。void exlib_init（void）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -書き込み用にファイルを開きます。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_print（float data）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -データをファイルに書き込みます。</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void exlib_term（void）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ファイルを閉じます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリアセンブリ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ライブラリをコンパイルします。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライブラリがプリコンパイルされてバイナリファイルとして配布されている場合、この手順は必要ありません。この場合、ステップ3に直接進むことができますが、ライブラリを操作するには、ライブラリプロバイダーから.dllファイル（またはLinuxの場合は.so）と対応するヘッダーファイル（.h）を取得する必要があることに注意してください。 Windowsの場合、静的ライブラリではなく、いわゆるインポートライブラリである.libファイルも必要です。このインポートライブラリは、暗黙的なリンクに必要です。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、MATLAB mexコマンドを使用して、現在アクティブなホストコンパイラを呼び出し、共有ライブラリ（Windowsではexlib.dll、Linuxではexlib.so）をコンパイルします。コマンドが最初に実行されたことを確認することが重要です。</font></font><br>
<pre><code class="matlab hljs">mex -setup
</code></pre><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サポートされているコンパイラ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を選択します</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、mexを使用してライブラリをコンパイルします。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリを構築するためのコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">mingw = strfind(mex.getCompilerConfigurations(<span class="hljs-string">'C'</span>,<span class="hljs-string">'Selected'</span>).Name,<span class="hljs-string">'MinGW64 Compiler'</span>);
<span class="hljs-keyword">if</span> isunix
    <span class="hljs-comment">% GCC</span>
    mex(<span class="hljs-string">'LDEXT=.so'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">elseif</span> mingw
    <span class="hljs-comment">% MinGW builds static shared library, so dll and lib files are the same</span>
    <span class="hljs-comment">% loadlibrary uses the dll file, while legacy code tool looks for the lib file</span>
    mex(<span class="hljs-string">'LDEXT=.lib'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);<font></font>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'LINKLIBS='</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">else</span>
    <span class="hljs-comment">% Visual</span>
    mex(<span class="hljs-string">'LDEXT=.dll'</span>,<span class="hljs-string">'LINKEXPORT='</span>,<span class="hljs-string">'LINKEXPORTVER='</span>,<span class="hljs-string">'CMDLINE300="del exlib.exp exlib.dll.manifest"'</span>,<span class="hljs-string">'exlib.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
</div>
                    </div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイルされたライブラリの確認</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイル後、結果のライブラリをロードしてMATLABで使用できることを確認する必要があります。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリをチェックするためのコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-comment">% Load the library</span>
[~,~] = loadlibrary([<span class="hljs-string">'exlib'</span>,system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>)],<span class="hljs-string">'exlib.h'</span>);
<span class="hljs-comment">% Display functions available in the library</span>
libfunctionsview(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Initialize</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_init'</span>);
<span class="hljs-comment">% Step</span>
<span class="hljs-keyword">for</span> <span class="hljs-built_in">i</span> = <span class="hljs-number">1</span>:<span class="hljs-number">10</span>
    calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_print'</span>,single(<span class="hljs-built_in">i</span>));
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Terminate</span>
calllib(<span class="hljs-string">'exlib'</span>,<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-comment">% Unload the library</span>
unloadlibrary(<span class="hljs-string">'exlib'</span>);
<span class="hljs-comment">% Show contents of generated file</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが機能することを確認したので、Simulinkを使い始めましょう！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S関数を使用した共有ライブラリの呼び出し</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S-Functionを使用すると、SimulinkでCコードを使用できます。</font><font style="vertical-align: inherit;">このアプローチにより、ユーザーはライブラリをロードしてその関数を呼び出すために必要なCコードを開発できます。</font><font style="vertical-align: inherit;">次に、このコードは、Simulinkによって認識されて共有ライブラリにリンクされるバイナリファイルにコンパイルされます。</font><font style="vertical-align: inherit;">このバイナリはS関数と呼ばれます。</font><font style="vertical-align: inherit;">Simulinkには、このS関数を呼び出すためのブロックがあります。</font><font style="vertical-align: inherit;">SimulinkでS-Functionを作成する方法はいくつかあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レガシーコードツールの使用</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のアプローチは、</font><font style="vertical-align: inherit;">MATLABを使用して作成された仕様に従ってS-Functionを自動的に作成するのに役立つ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツール</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">である</font><b><font style="vertical-align: inherit;">Legacy Code Tool</font></b><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">することです。</font><font style="vertical-align: inherit;">この例では、S-Functionがインポートライブラリにリンクされ（Windowsでは、対応する* .libファイルが必要です）、ライブラリ関数が呼び出されます。</font><font style="vertical-align: inherit;">このアプローチは、暗黙的なリンクと呼ばれます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、レガシーコードツールの構造を初期化する必要があります</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レガシーコードツール構造を初期化するためのコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs">specs = legacy_code(<span class="hljs-string">'initialize'</span>);
<span class="hljs-comment">% Prototype for the initialization function</span>
specs.StartFcnSpec = <span class="hljs-string">'exlib_init()'</span>;
<span class="hljs-comment">% Prototype for the step function</span>
specs.OutputFcnSpec = <span class="hljs-string">'exlib_print(single u1)'</span>;
<span class="hljs-comment">% Prototype for the terminate function</span>
specs.TerminateFcnSpec = <span class="hljs-string">'exlib_term()'</span>;
<span class="hljs-comment">% Shared library to link with (.so on Linux and .dll on Windows)</span>
specs.HostLibFiles = {[<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]};
<span class="hljs-comment">% We must supply header file when linking with shared library, otherwise</span>
<span class="hljs-comment">% compiler might make wrong assumptions about function's prototype.</span>
specs.HeaderFiles = {<span class="hljs-string">'exlib.h'</span>};<font></font>
specs.SFunctionName = <span class="hljs-string">'sfun_exlib'</span>;
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S-Functionを作成し、コンパイルしてリンクします。</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'generate_for_sim'</span>,specs);<font></font>
### Start Compiling sfun_exlib<font></font>
    mex(<span class="hljs-string">'sfun_exlib.c'</span>, <span class="hljs-string">'-I/tmp/simulink_shrlib_fex'</span>, <span class="hljs-string">'/tmp/simulink_shrlib_fex/exlib.so'</span>)<font></font>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.<font></font>
### Finish Compiling sfun_exlib<font></font>
### Exit<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、Simulinkブロックを作成します。</font></font><br>
<pre><code class="matlab hljs">legacy_code(<span class="hljs-string">'slblock_generate'</span>,specs);
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シミュレーションを実行します。</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test'</span>);<font></font>
snapnow;<font></font>
sim(<span class="hljs-string">'simlib_test'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S関数を手動で書く</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のアプローチは、共有ライブラリをロードし、このライブラリから関数を呼び出すための独自のS-Functionを作成することです。</font><font style="vertical-align: inherit;">このアプローチでは、ランタイムリンクとも呼ばれる明示的なリンクを使用します。</font><font style="vertical-align: inherit;">最も簡単な解決策は、レガシコードツールによって以前に自動的に生成されたS-Functionを適応させることです。</font><font style="vertical-align: inherit;">この例では、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlStart</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlOutputs、</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mdlTerminate</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><i><font style="vertical-align: inherit;">が</font></i><i><font style="vertical-align: inherit;">変更されてい</font></i><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更後のこれらの関数の外観は次のとおりです。</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードを表示</font></font></b>
                        <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlStart</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Load the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_init_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    dllHandle = dlopen(<span class="hljs-string">"./exlib.so"</span>,RTLD_LAZY);<font></font>
    exlib_init_ptr = dlsym(dllHandle, <span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_init_type exlib_init_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    dllHandle = LoadLibrary(<span class="hljs-string">"exlib.dll"</span>);<font></font>
    exlib_init_ptr = (exlib_init_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_init"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  exlib_init_ptr();<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlOutputs</span><span class="hljs-params">(SimStruct *S, int_T tid)</span>
</span>{<font></font>
  real32_T *u1 = <span class="hljs-number">0</span>;<font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_print_ptr)(<span class="hljs-keyword">float</span>);<font></font>
    exlib_print_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_print_type exlib_print_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_print_ptr = (exlib_print_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_print"</span>);
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
<font></font>
  <span class="hljs-comment">/*
   * Get access to Parameter/Input/Output/DWork/size information
   */</span>
  u1 = (real32_T *) ssGetInputPortSignal(S, <span class="hljs-number">0</span>);<font></font>
<font></font>
  <span class="hljs-comment">/*
   * Call the function from library
   */</span><font></font>
  exlib_print_ptr( *u1);<font></font>
}<font></font>
</code></pre><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mdlTerminate</span><span class="hljs-params">(SimStruct *S)</span>
</span>{
  <span class="hljs-comment">/*
   * Unload the dynamic library
   */</span><font></font>
<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(__GNUC__) &amp;&amp; !defined(__MINGW32__)</span>
    <span class="hljs-keyword">void</span> (*exlib_term_ptr)(<span class="hljs-keyword">void</span>);<font></font>
    exlib_term_ptr = dlsym(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    dlclose(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
    exlib_term_type exlib_term_ptr = <span class="hljs-literal">NULL</span>;<font></font>
    exlib_term_ptr = (exlib_term_type)GetProcAddress(dllHandle,<span class="hljs-string">"exlib_term"</span>);<font></font>
    exlib_term_ptr();<font></font>
    FreeLibrary(dllHandle);<font></font>
  <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果のS-Functionをコンパイルします。</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>,<span class="hljs-string">'-ldl'</span>);
<span class="hljs-keyword">else</span>
    mex(<span class="hljs-string">'sfun_exlib_dyn.c'</span>);
<span class="hljs-keyword">end</span>
Building with <span class="hljs-string">'gcc'</span>.<font></font>
MEX completed successfully.</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そしてシミュレーションを実行します：</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_dyn'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_dyn'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S-Function Builderの使用</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
別のアプローチは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S-Function Builder</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ブロックを使用すること</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">これは、複雑さの点でレガシーコードツールと手書きのS-Functionの間のクロスと見なすことができる特別なユニットです。</font><font style="vertical-align: inherit;">S-Function Builderは、S-Functionの特性を説明するグラフィカルインターフェイスを提供し、S-Functionは自動的に作成されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S-Function Builderの使用には、いくつかのパフォーマンス制限と問題があります。</font><font style="vertical-align: inherit;">現在、これはS-Functionを作成するための古いアプローチと考えられています。</font><font style="vertical-align: inherit;">R2020aのリリースで登場し、後で説明するCファンクションブロックを使用することをお勧めします。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATLAB関数を使用した共有ライブラリの呼び出し </font></font></h2><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATLAB Function</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ブロック</font><font style="vertical-align: inherit;">を使用すると、MATLAB言語を使用してSimulinkでカスタムアルゴリズムを記述できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MATLAB関数から共有ライブラリを呼び出すには、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.ceval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数を使用します</font><font style="vertical-align: inherit;">。これは、MATLAB関数の本体でのみ使用できます（MATLABでは使用できません）。</font><font style="vertical-align: inherit;">Coder.cevalは、MATLAB Coderが機能する必要はありません。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
共有ライブラリを呼び出すMATLAB Functionブロックのコード：</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードを表示</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fcn</span><span class="hljs-params">(u)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Keep track of initialization and runtime count</span>
<span class="hljs-keyword">persistent</span> runTimeCnt<font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly (current directory in this case)</span>
coder.extrinsic(<span class="hljs-string">'pwd'</span>,<span class="hljs-string">'system_dependent'</span>);<font></font>
libpath = coder.const(pwd);<font></font>
<span class="hljs-comment">% Shared library to link with</span>
libname = coder.const([<span class="hljs-string">'exlib'</span>,strrep(system_dependent(<span class="hljs-string">'GetSharedLibExt'</span>),<span class="hljs-string">'.dll'</span>,<span class="hljs-string">'.lib'</span>)]);
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(<span class="hljs-string">'exlib.h'</span>);<font></font>
<font></font>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">isempty</span>(runTimeCnt)
    <span class="hljs-comment">% Initialize</span>
    coder.ceval(<span class="hljs-string">'exlib_init'</span>);<font></font>
    runTimeCnt = <span class="hljs-number">0</span>;
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Step</span>
coder.ceval(<span class="hljs-string">'exlib_print'</span>,single(u));<font></font>
runTimeCnt = runTimeCnt+<span class="hljs-number">1</span>;
<span class="hljs-comment">% Terminate on the 10th step</span>
<span class="hljs-keyword">if</span> (runTimeCnt == <span class="hljs-number">11</span>)<font></font>
    coder.ceval(<span class="hljs-string">'exlib_term'</span>);
<span class="hljs-keyword">end</span>
</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチには1つの欠点があります-シミュレーションの最後に完了関数を呼び出す適切な方法がない（MATLAB Systemブロックと比較して）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モデルの補完関数を定義するには、exlib_term（）;を設定します。カテゴリのモデル設定で、</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シミュレーションターゲット-&gt;カスタムコード-&gt;関数を終了します</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 「Import custom code」パラメーターがモデル設定で設定されている場合、「</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.cinclude</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用する代わりに」「Simulation Target」パネルですべてのコード依存関係を指定する必要があります</font><font style="vertical-align: inherit;">。このパラメーターが設定されていない場合は、シミュレーションターゲット、coder.cinclude、およびcoder.updateBuildInfoの設定を組み合わせることができます。</font></font><br>
</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
別の方法は、使用して依存関係を維持することです</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上記の例で示されているように、</font><i><font style="vertical-align: inherit;">coder.cinclude</font></i><font style="vertical-align: inherit;">および</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.updateBuildInfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そして</font><font style="vertical-align: inherit;">慣例により</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を呼び出します</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シミュレーションを実行します。</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mlf'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mlf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stateflowからの共有ライブラリの呼び出し </font></font></h2><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stateflow</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ダイアグラム</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">共有ライブラリ関数を使用する場合</font><font style="vertical-align: inherit;">は、これらの関数をStateflowから直接呼び出す必要があります。 Stateflowドキュメントには、これを行う方法を示す例があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Stateflowでの外部関数の呼び出しは非常に簡単です。Stateflowダイアグラムで関数の名前を指定する必要があります。</font></font><br>
<img src="https://habrastorage.org/webt/_f/3m/z7/_f3mz7djr11eebq8egiisjpk9ru.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、Stateflowがこれらの外部関数の検索場所を認識できるように、モデルパラメーターを構成する必要があります。</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simulation</font></font></i></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Target- </font></font></i><font style="vertical-align: inherit;"><b><i><font style="vertical-align: inherit;">&gt; Custom</font></i></b><i><font style="vertical-align: inherit;"> Code- </font></i><b><i><font style="vertical-align: inherit;">&gt; Libraries</font></i></b><font style="vertical-align: inherit;">の設定で</font><b><i><font style="vertical-align: inherit;">、</font></i></b><i><font style="vertical-align: inherit;"> exlib.lib（またはLinuxの場合はexlib.so）</font></i><font style="vertical-align: inherit;">を入力</font><b><i><font style="vertical-align: inherit;">する</font></i></b><font style="vertical-align: inherit;">必要があり</font><b><i><font style="vertical-align: inherit;">ます</font></i></b><font style="vertical-align: inherit;">。で</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シミュレーションターゲット- &gt;カスタムコード-あなたは&gt;ヘッダ・ファイル</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">入力する必要</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の#include「exlib.hを」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。また、補完関数の指定を忘れないようにすることも重要です。で</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シミュレーションターゲット-&gt;カスタムコード-&gt;終了関数で</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exlib_term（）;を</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定する必要があります</font><i><font style="vertical-align: inherit;">。</font></i><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シミュレーションを実行します。</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_sf'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_sf'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このセクションの情報は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Cアクション言語</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用するStateflowダイアグラムに適用されることに注意してください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Stateflowダイアグラムが使用している場合は</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATLABアクション言語を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そして</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coder.ceval必要とされる</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MATLAB関数の場合と同様に、。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATLAB Systemブロックを使用した共有ライブラリの呼び出し </font></font></h2> <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MATLAB Systemブロック</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用すると、Simulinkでシステムオブジェクトを使用できます。</font><font style="vertical-align: inherit;">このブロックの詳細については、ドキュメントを参照してください。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムオブジェクトのサポートは、R2013bのリリースでSimulinkに登場しました。</font><font style="vertical-align: inherit;">初期化、シミュレーション、および完了関数を簡単に定義できるため、多くの人がシステムオブジェクトを使用します。</font><font style="vertical-align: inherit;">また、システムオブジェクトはこれらの関数の補助的なMATLABコードを使用できます（たとえば、ステップ関数の前処理および後処理データなど）。すべてCコードを記述する必要はありません</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。MATLABSystemブロックで使用されるシステムオブジェクトは次のようになります。</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムオブジェクトコード</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-keyword">classdef</span> exlib &lt; matlab.System
    <span class="hljs-comment">% Call exlib shared library</span>
    <span class="hljs-comment">%</span>
    <span class="hljs-comment">% This example shows how to call shared library from Simulink using</span>
    <span class="hljs-comment">% MATLAB System block.</span>
    <span class="hljs-keyword">properties</span> (Nontunable,Access=private)<font></font>
        libName = exlib.getLibName;<font></font>
        libPath = pwd;<font></font>
        libHeader = <span class="hljs-string">'exlib.h'</span>;
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Static)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">libName</span> = <span class="hljs-title">getLibName</span></span>
            <span class="hljs-keyword">if</span> isunix<font></font>
                libName = <span class="hljs-string">'exlib.so'</span>;
            <span class="hljs-keyword">else</span>
                libName = <span class="hljs-string">'exlib.lib'</span>;
            <span class="hljs-keyword">end</span>
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span><font></font>
    <font></font>
    <span class="hljs-keyword">methods</span> (Access=protected)
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setupImpl</span><span class="hljs-params">(obj, ~)</span></span>
            <span class="hljs-comment">% Initialize.</span>
            coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,obj.libName,obj.libPath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
            coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,obj.libPath);<font></font>
            coder.cinclude(obj.libHeader);<font></font>
            coder.ceval(<span class="hljs-string">'exlib_init'</span>);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stepImpl</span><span class="hljs-params">(~, u)</span></span>
            <span class="hljs-comment">% Step.</span>
            coder.ceval(<span class="hljs-string">'exlib_print'</span>,u);
        <span class="hljs-keyword">end</span><font></font>
        <font></font>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">releaseImpl</span><span class="hljs-params">(~)</span></span>
            <span class="hljs-comment">% Terminate.</span>
            coder.ceval(<span class="hljs-string">'exlib_term'</span>);
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span></code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シミュレーションを実行します。</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_mls'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_mls'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Callerブロックを使用して共有ライブラリを呼び出す </font></font></h2> <br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Caller</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ブロックを</font><font style="vertical-align: inherit;">使用すると、Simulinkから直接C関数を呼び出すことができます。このブロックの詳細については、ドキュメントを参照してください。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、MATLAB R2018bで最初に登場した比較的新しいアプローチです。その主な目的は、Simulinkの関数呼び出しとCライブラリを非常にシンプルにすることです。ただし、このブロックのドキュメントで確認できる制限があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
後</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib.so/exlib.libがいる</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に追加されて</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt;ライブラリ-シミュレーションターゲット</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する#include「exlib.h」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シミュレーションターゲット-ヘッダー&gt;は</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モデルの設定で、ちょうどC発信者のブロックに「リフレッシュカスタムコード」ボタンをクリックして、ライブラリに含まれるすべての関数を表示します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
選択した後</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_printの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能を</font><font style="vertical-align: inherit;">、ポートの指定]ダイアログボックスが自動的に入力されています。</font></font><br>
<img src="https://habrastorage.org/webt/4s/sz/bd/4sszbddxgbpffb3urxzbw2dv-ua.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして再び、あなたが追加する必要が</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_init</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exlib_term</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数呼び出しを</font><font style="vertical-align: inherit;">シミュレーションターゲットに。</font><font style="vertical-align: inherit;">他のいくつかのC Callerブロックを追加して、初期化関数と終了関数を直接呼び出すこともできます。</font><font style="vertical-align: inherit;">これらのC Callerブロックは、Initialize FunctionおよびTerminate Functionサブシステムに配置する必要があります。</font><font style="vertical-align: inherit;">次のStateflowの例を検討することもでき</font><font style="vertical-align: inherit;">
ます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定の時間に</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行するように</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">サブシステムをスケジュール</font></a><font style="vertical-align: inherit;">するシミュレーションを実行します。</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ccaller'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_ccaller'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Functionブロックを使用した共有ライブラリの呼び出し</font></font></h2> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部コードをSimulinkに統合するための最新の追加</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font><b><font style="vertical-align: inherit;">C Function</font></b><font style="vertical-align: inherit;">ブロック</font><font style="vertical-align: inherit;">です。彼はR2020aに登場しました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使いやすさの点ではC Callerブロックに似ていますが、インポートされた関数の周りにCラッパーを作成できます（したがって、このブロックはS-Function Builderに似ています）。しかし、ほとんどの場合、C Functionブロックを使用する主なシナリオは、既存のC関数を呼び出すのではなく、アプリケーションでそのようなコードが必要な場合に、小さなCコードを書くことです。たとえば、ハードウェアレジスタまたはコンパイラの組み込み関数へのアクセスが必要になる場合があります。</font><i><font style="vertical-align: inherit;">exlib.so/exlib.lib</font></i><font style="vertical-align: inherit;">を</font><b><i><font style="vertical-align: inherit;">「シミュレーションターゲット-&gt;ライブラリ」</font></i></b><font style="vertical-align: inherit;">と</font><i><font style="vertical-align: inherit;">#include「exlib.h」</font></i><font style="vertical-align: inherit;">の設定</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
に追加することを忘れないでください</font><i><font style="vertical-align: inherit;">。</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><b><i><font style="vertical-align: inherit;"></font></i></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定で</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「シミュレーションターゲット- &gt;ヘッダ・ファイル」</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">モデル設定インチ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、C Functionブロックの設定で、データ型がsingleの入力データの文字を追加し、出力、開始コード、終了コードを指定する必要があります。</font></font><br>
<img src="https://habrastorage.org/webt/pm/ek/uz/pmekuz8kkzafgxf8ky1v8coqqla.png"><br>
<br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_cfunction'</span>,<span class="hljs-string">'SimUserLibraries'</span>,<span class="hljs-string">'exlib.so'</span>);
<span class="hljs-keyword">end</span>
sim(<span class="hljs-string">'simlib_test_cfunction'</span>);
<span class="hljs-comment">% Observe the results:</span>
<span class="hljs-built_in">type</span>(<span class="hljs-string">'exlib.txt'</span>);
<span class="hljs-number">0.000000</span>
<span class="hljs-number">1.000000</span>
<span class="hljs-number">2.000000</span>
<span class="hljs-number">3.000000</span>
<span class="hljs-number">4.000000</span>
<span class="hljs-number">5.000000</span>
<span class="hljs-number">6.000000</span>
<span class="hljs-number">7.000000</span>
<span class="hljs-number">8.000000</span>
<span class="hljs-number">9.000000</span>
<span class="hljs-number">10.000000</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Embedded Coderを使用して生成された共有ライブラリを呼び出す </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embedded Coderを使用するシナリオの1つは、SimulinkモデルからCコードを自動生成し、このコードを共有ライブラリにパッケージ化することです。ドキュメントには、共有ライブラリを自動的に生成し、Cで記述された外部アプリケーションから呼び出す方法を示す例もあります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じSimulinkモデルでアルゴリズムまたはアルゴリズムの一部をCコードとして実行する必要がある場合は、使用する方がよいことに注意してください。 Simulink CoderのS-Functionまたは</font><i><font style="vertical-align: inherit;">ソフトウェア</font></i><font style="vertical-align: inherit;">インザ</font><i><font style="vertical-align: inherit;">ループ</font></i><font style="vertical-align: inherit;">シミュレーション</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ただし、Embedded Coderによって生成された共有ライブラリを半自然なモデリングに使用する場合、同じライブラリを他の開発者が使用するより大きなモデルに統合して、知的財産を保護する必要がある場合があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embedded Coderによって生成された共有ライブラリの操作は、記事で使用された共有ライブラリの操作と同じです。</font><font style="vertical-align: inherit;">2つの入力と1つの出力を持つ単純なモデルを考えます。</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/wt/vo/wu/wtvowu3jc24ttsqd1qfgok9jxpc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モデルを構築した後、.dllファイル（Linuxでは.so）、. libファイル（.dllのインポートライブラリ）、. expファイル（.dllとリンクするためのエクスポートファイル）を取得します。</font></font><br>
<pre><code class="matlab hljs"><span class="hljs-keyword">if</span> isunix<font></font>
    set_param(<span class="hljs-string">'simlib_test_ert'</span>,<span class="hljs-string">'CustomHeaderCode'</span>,<span class="hljs-string">'#include &lt;stddef.h&gt;'</span>);
<span class="hljs-keyword">end</span>
rtwbuild(<span class="hljs-string">'simlib_test_ert'</span>);<font></font>
### Starting build procedure <span class="hljs-keyword">for</span>: simlib_test_ert<font></font>
### Successful completion of build procedure <span class="hljs-keyword">for</span>: simlib_test_ert</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
生成された共有ライブラリは、次の文字をエクスポートします。</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-function">ex_init
<span class="hljs-keyword">double</span> <span class="hljs-title">ex_step</span><span class="hljs-params">(<span class="hljs-keyword">double</span>, <span class="hljs-keyword">double</span>)</span>
simlib_test_ert_terminate</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、入力と出力はグローバル文字としてエクスポートされ、初期化、ステップ、および完了関数はモデルの命名規則に従います。</font><font style="vertical-align: inherit;">必要に応じて、関数のプロトタイプ、シンボル名などを構成できます（これらの設定の説明は、この記事の範囲外です）。</font><font style="vertical-align: inherit;">このモデルでは、モデルのステップ関数のプロトタイプは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Out1 = ex_step（In1、In2）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">として定義されてい</font><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの関数を呼び出すには、上記のメソッドのいずれかを使用する必要があります。</font><font style="vertical-align: inherit;">たとえば、MATLAB関数を使用できます（簡単にするため、step関数のみを呼び出します）。</font></font><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コードを表示</font></font></b>
                        <div class="spoiler_text"><pre><code class="matlab hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">y</span> = <span class="hljs-title">fcn</span><span class="hljs-params">(u1, u2)</span></span>
<span class="hljs-comment">%#codegen</span><font></font>
<font></font>
<span class="hljs-comment">% Generate library path on the fly</span>
coder.extrinsic(<span class="hljs-string">'RTW.getBuildDir'</span>,<span class="hljs-string">'fullfile'</span>);<font></font>
buildDir = coder.const(RTW.getBuildDir(<span class="hljs-string">'simlib_test_ert'</span>));<font></font>
libpath = coder.const(buildDir.CodeGenFolder);<font></font>
incpath = coder.const(fullfile(buildDir.BuildDirectory,<span class="hljs-string">'simlib_test_ert.h'</span>));
<span class="hljs-comment">% Shared library to link with</span>
<span class="hljs-keyword">if</span> isunix<font></font>
    ext = <span class="hljs-string">'.so'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert'</span>,ext];
<span class="hljs-keyword">else</span>
    ext = <span class="hljs-string">'.lib'</span>;<font></font>
    libname = [<span class="hljs-string">'simlib_test_ert_'</span>,computer(<span class="hljs-string">'arch'</span>),ext];
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% Add the external library. Mark it as precompiled, so it won't appear as</span>
<span class="hljs-comment">% makefile target during code generation.</span>
coder.updateBuildInfo(<span class="hljs-string">'addLinkObjects'</span>,libname,libpath,<span class="hljs-number">1000</span>,<span class="hljs-built_in">true</span>,<span class="hljs-built_in">true</span>);<font></font>
coder.updateBuildInfo(<span class="hljs-string">'addIncludePaths'</span>,libpath);<font></font>
coder.cinclude(incpath);<font></font>
<font></font>
<span class="hljs-comment">% Initialize output</span>
y = <span class="hljs-number">0</span>;
<span class="hljs-comment">% Step</span>
y = coder.ceval(<span class="hljs-string">'ex_step'</span>,u1,u2);</code></pre><br>
</div>
                    </div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
シミュレーションを実行し、その結果を確認します。</font></font><br>
<pre><code class="matlab hljs">open_system(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
sim(<span class="hljs-string">'simlib_test_callert'</span>);<font></font>
snapnow;<font></font>
</code></pre><br>
<img src="https://habrastorage.org/webt/ga/qw/vt/gaqwvt2gg4g87wrtxufr78pezxa.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、Simulinkモデルから共有ライブラリを呼び出すさまざまな方法について説明します。</font><font style="vertical-align: inherit;">暗黙的リンクと明示的リンクの両方が考慮されました。</font><font style="vertical-align: inherit;">すべての方法には長所と短所があり、それらの適合性は特定のワークフロー、要件、および目標に依存します。</font><b><font style="vertical-align: inherit;">レガシーコードツールの</font></b><font style="vertical-align: inherit;">共有ライブラリとの暗黙のリンクを実装する場合は、この場合には、我々は単にライブラリから直接関数を呼び出すことができ、およびリンカは、残りの世話をするためのアプローチは、最も適しています。</font><b><font style="vertical-align: inherit;">MATLAB Systemブロック</font></b><font style="vertical-align: inherit;">は、次の利点を提供する別のアプローチです。</font></font><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期化、ステップ、および完了機能のパラダイムへの優れたコンプライアンスにより、これらのすべての機能を、モデルの規模ではなく、ブロック自体の中で維持できます。</font></font><br>
</li>
<li>       <br>
</li>
<li>    MATLAB     MATLAB<br>
</li>
<li> MATLAB System           (,    S-)<br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MATLAB Functionブロックを使用することの欠点は、その使用によりコード生成中に追加のオーバーヘッドが発生する可能性があることです。したがって、レガシーコードツールとS関数は、プロダクションコードの生成に適しています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
手書きのS関数は、共有ライブラリへの明示的なリンクを実装するのに最適です。この場合、関数を</font><i><font style="vertical-align: inherit;">呼び出せる</font></i><font style="vertical-align: inherit;">ようにするには、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibrary / dlopen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetProcAddress / dlsym</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FreeLibrary / dlclose</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの関数を使用する必要があり</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">R2018bで導入された</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C Callerブロック</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、C関数を呼び出す最も簡単な方法ですが、制限があります。</font><b><font style="vertical-align: inherit;">C Function</font></b><font style="vertical-align: inherit;">ブロックについても同じことが言えます。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これはR2020aの最新の追加です。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ここ</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
からソースとモデルをダウンロードします</font><b><font style="vertical-align: inherit;">UPD：</font></b><font style="vertical-align: inherit;"> 
資料をダウンロードするためのリンクが更新されました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><br><font style="vertical-align: inherit;"></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja503896/index.html">スノムアカデミー</a></li>
<li><a href="../ja503898/index.html">1日のリモートフロントエンド</a></li>
<li><a href="../ja503902/index.html">隣人に自分のプロジェクト、または銀行のInnerSourceに取り組む方法</a></li>
<li><a href="../ja503904/index.html">世界とnの世界、または人文科学の数学</a></li>
<li><a href="../ja503906/index.html">LabVIEW NXG-単純なデータ型と型変換</a></li>
<li><a href="../ja503910/index.html">「ウダレンカ」に行った人の実験</a></li>
<li><a href="../ja503916/index.html">FIXプロトコルを使用した取引。パート1：テスト環境のセットアップ</a></li>
<li><a href="../ja503918/index.html">Goモジュールでパッケージを管理する：実用的なガイド</a></li>
<li><a href="../ja503920/index.html">STM32でマイクシステムをテストする方法：Yandexデバイス開発者の経験</a></li>
<li><a href="../ja503922/index.html">EUがCookieの壁を根絶する理由</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>