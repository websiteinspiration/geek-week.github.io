<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëâüèø üí≥ ‚úã A little more about improper testing ü§í ü§• ü§òüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One day I accidentally caught the eye of a code that a user was trying to monitor the performance of RAM in his virtual machine. I won‚Äôt give this cod...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>A little more about improper testing</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487248/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One day I accidentally caught the eye of a code that a user was trying to monitor the performance of RAM in his virtual machine. </font><font style="vertical-align: inherit;">I won‚Äôt give this code (there is a ‚Äúfootcloth‚Äù) and leave only the most essential. </font><font style="vertical-align: inherit;">So, the cat is in the studio!</font></font><br>
<a name="habracut"></a><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNT 1024</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SIZE (1024*1024)</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">start</span>;</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">end</span>;</span>
	<span class="hljs-keyword">long</span> millis;
	<span class="hljs-keyword">double</span> gbs;
	<span class="hljs-keyword">char</span> ** buffers;<font></font>
	buffers = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>*[CNT];
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;CNT;i++) {<font></font>
		buffers[i] = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[SIZE];<font></font>
	}<font></font>
	gettimeofday(&amp;start, <span class="hljs-literal">NULL</span>);
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;CNT;i++) {
		<span class="hljs-built_in">memset</span>(buffers[i], <span class="hljs-number">0</span>, SIZE);<font></font>
	}<font></font>
	gettimeofday(&amp;end, <span class="hljs-literal">NULL</span>);<font></font>
	millis = (end.tv_sec - start.tv_sec) * <span class="hljs-number">1000</span> +<font></font>
		(end.tv_usec - start.tv_usec) / <span class="hljs-number">1000</span>;<font></font>
	gbs = <span class="hljs-number">1000.0</span> / millis;
	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; gbs &lt;&lt; <span class="hljs-string">" GB/s\n"</span>;
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;CNT;i++) {
		<span class="hljs-keyword">delete</span> buffers[i];<font></font>
	}<font></font>
	<span class="hljs-keyword">delete</span> buffers;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Everything is simple - we allocate memory and write one gigabyte into it. And what does this test show? </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ ./memtest </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4.06504 GB / s</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Approximately 4GB / s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What?!?! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How?!?!? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is Core i7 (albeit not the newest), DDR4, the processor is almost not loaded - WHY?!?! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The answer, as always, is unusually ordinary. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The new operator (like the malloc function, by the way) does not actually allocate memory. With this call, the allocator looks at the list of free sections in the memory pool, and if there are none, calls sbrk () to enlarge the data segment, and then returns the program a link to the address from the newly selected section. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem is that the selected area is completely virtual. Real memory pages are not allocated.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And when the first access to each page from this selected segment occurs, the MMU ‚Äúshoots‚Äù the page fault, after which the virtual page to which access is made is assigned to the real one. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, in fact, we are testing not the performance of the bus and RAM modules, but the performance of the MMU and VMM of the operating system. </font><font style="vertical-align: inherit;">And in order to test the real performance of RAM, we just need to initialize the allocated sections once. </font><font style="vertical-align: inherit;">For example, like this:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CNT 1024</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SIZE (1024*1024)</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">start</span>;</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">end</span>;</span>
	<span class="hljs-keyword">long</span> millis;
	<span class="hljs-keyword">double</span> gbs;
	<span class="hljs-keyword">char</span> ** buffers;<font></font>
	buffers = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>*[CNT];
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;CNT;i++) {
                <span class="hljs-comment">// FIXED HERE!!!</span>
		buffers[i] = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[SIZE](); <span class="hljs-comment">// Add brackets, &amp;$# !!!</span><font></font>
	}<font></font>
	gettimeofday(&amp;start, <span class="hljs-literal">NULL</span>);
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;CNT;i++) {
		<span class="hljs-built_in">memset</span>(buffers[i], <span class="hljs-number">0</span>, SIZE);<font></font>
	}<font></font>
	gettimeofday(&amp;end, <span class="hljs-literal">NULL</span>);<font></font>
	millis = (end.tv_sec - start.tv_sec) * <span class="hljs-number">1000</span> +<font></font>
		(end.tv_usec - start.tv_usec) / <span class="hljs-number">1000</span>;<font></font>
	gbs = <span class="hljs-number">1000.0</span> / millis;
	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; gbs &lt;&lt; <span class="hljs-string">" GB/s\n"</span>;
	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;CNT;i++) {
		<span class="hljs-keyword">delete</span> buffers[i];<font></font>
	}<font></font>
	<span class="hljs-keyword">delete</span> buffers;
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, we simply initialize the allocated buffers with the default value (char 0). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Checking: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">$ ./memtest </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
28.5714 GB / s</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Another thing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moral - if you need large buffers to work quickly and quickly, do not forget to initialize them.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487232/index.html">Immune imprinting in childhood: the origin of virus protection</a></li>
<li><a href="../en487234/index.html">Iron or optimization? Badoo, Avito and Mamba - about PHP performance</a></li>
<li><a href="../en487238/index.html">How to design power grid protection equipment</a></li>
<li><a href="../en487242/index.html">February IT Events Digest</a></li>
<li><a href="../en487246/index.html">Tensor Certification Authority may compromise customer private keys</a></li>
<li><a href="../en487250/index.html">Delayed Alpha blending</a></li>
<li><a href="../en487254/index.html">How to use CCTV cameras not only to monitor intruders</a></li>
<li><a href="../en487256/index.html">Burn and return from the ashes or Phoenix people</a></li>
<li><a href="../en487258/index.html">Asynchronous PHP</a></li>
<li><a href="../en487260/index.html">NoVerify: a PHP linter that works fast</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>