<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤴 👸🏻 👏🏻 UDPホールパンチングを使用した、NATプロバイダーの背後にある2台のコンピューター間の直接VPNトンネル 🗓️ 👨‍🏭 🚲</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ネットワーク機器の設定なしで、VPSと標準のLinuxユーティリティを使用した単純なスクリプトを使用して、それぞれがNATプロバイダーの背後にある 2台のコンピューター間で直接（ポイントツーポイント）VPNトンネルを整理する方法についての記事。
 
 前書き
 リモートコンピューター制御、データ転送...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>UDPホールパンチングを使用した、NATプロバイダーの背後にある2台のコンピューター間の直接VPNトンネル</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478452/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワーク機器の設定なしで、VPSと標準のLinuxユーティリティを使用した単純なスクリプトを使用して</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それぞれがNATプロバイダーの背後にある</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2台のコンピューター間で直接（ポイントツーポイント）VPNトンネルを整理する方法についての記事</font><font style="vertical-align: inherit;">。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リモートコンピューター制御、データ転送などのための多くのプログラム（TeamViewer、Hamachi）があります。</font><font style="vertical-align: inherit;">彼らは驚くほどうまく、どんな条件でも動作します。</font><font style="vertical-align: inherit;">しかし、原則として、これらは有料サービスです。</font><font style="vertical-align: inherit;">これらのプログラムがどのように機能するかは不明であり、それらを使用したいという欲求はあまりありません。</font><font style="vertical-align: inherit;">Linux（主にUbuntu）のユーザーとして、OpenVPN、SSH、VNC、RDPなどのサービスを使用して、必要に応じてデータを転送し、PCを管理しました。</font><font style="vertical-align: inherit;">2台のコンピューター間のネットワークを整理するために、VPNサーバーを使用して、これらのコンピューターがOpenVPNサーバーに接続し、すべてのトラフィックがサーバーを通過するようにしました。</font><font style="vertical-align: inherit;">トラフィックが双方向になるため、これはあまり良くありません。その結果、速度が失われました。</font></font><br>
<img src="https://habrastorage.org/webt/j5/kk/h0/j5kkh0_winnv7kf_gl4z0wjpwkq.jpeg"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPNトンネルを整理し、サーバーを介してノード間でデータを転送するための古典的なスキーム</font></font></i><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理論 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は</font><font style="vertical-align: inherit;">、仲介サーバーを使用せずに、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NAT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロバイダーの</font><font style="vertical-align: inherit;">背後にあるノードからノードへ直接データ伝送チャネルを編成するためのソリューションについて長い間考えてきました</font><font style="vertical-align: inherit;">。 GREトンネル、IPsec、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UDPホールパンチング</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、OpenVPN </font><font style="vertical-align: inherit;">などのさまざまなテクノロジーに関する記事をいくつか</font><font style="vertical-align: inherit;">読んだ後、ノードが相互に接続をパンチする、つまり、リモートノードのIPとポートにパケットを送信する必要があることに気付きました。私は、NATを介してGREトンネルを整理し、NetCatを使用してメッセージを相互に送信する実験をいくつか行いましたが、うまくいく場合もあれば、うまくいかない場合もあり、すべてプロバイダーが使用するNATのタイプに依存していました。少し前に興味深い</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">記事</font></a><font style="vertical-align: inherit;">が私の目を引きました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでは、2台のコンピューター（以下、ノード）間のOpenVPN接続の構成についての説明がありました。</font><font style="vertical-align: inherit;">読み取り、チェック、および作業を行いましたが、ホストのローカルポートと外部ポートが一致するという条件で、つまり、プロバイダーがCone NATを使用します。</font><font style="vertical-align: inherit;">2つのコンピューター間でトンネルを構成することは興味深いことでした。両方が任意のタイプ（コーンまたは対称）NATの背後にある場合、つまり、ローカルポートが外部ポートと一致しない場合があります。</font><font style="vertical-align: inherit;">タスクは、外部の支援なしに外部インターフェイスの現在のポートを決定することが不可能であることに残りました。</font><font style="vertical-align: inherit;">外部IPアドレス（たとえば、curl ifconfig.me）を何らかの方法で見つけることができるが、現在の外部ポートの決定に問題がある場合。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">練習</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題を解決するには、VPS（S-blue oval）を使用する必要がありました。その上で、「コネクタ」として機能するスクリプト（</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">STUNサーバーの</font></a><font style="vertical-align: inherit;">ようなもの）を作成しました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：TCPDumpユーティリティを使用して、特定のインターフェイスとポートでUDPパケットを受信し（UDPプロトコルはどこでも使用されます）、パケットの内容を解析し、送信元IPアドレス/ポートを決定し、接続の現在のパラメーター（IPアドレスとポート）を返すNetCatユーティリティで応答しました。このデータが利用可能な場合は、接続先のリモートホストの同じパラメーター（IPアドレスとポート）、そうでない場合は、表示されるまで待機しました。このビジネスのすべてを接続の識別子（ID）と比較しました。複数の接続が互いに干渉する可能性があるため、IDを使用すると、すべてが解決されました。ノードが独自の古いデータを受信し、それを介して接続しようとしたという問題もあり、これはホスト名ハッシュを使用して解決されました。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/486/043/3a4/4860433a4c6b0e589ed61c923649fc95.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ノードAとBで、スクリプトと事前生成されたキーを使用してVPN接続を承認しました。これは次のように機能しました。スクリプトが実行され、ローカルポートが20,000から65,000の範囲でランダムに選択され、このポートから接続IDを含むVPSにパケットが送信されましたNetCatユーティリティを使用したホスト名ハッシュとTCPDumpがすぐに起動され、応答を待機していました。それに応じて、このノードの現在のデータ（IPアドレス/ポート）を含むパケットが届き、リモートノードからのデータがある場合は、それらも届き、ノード間でのグリーティングの交換が始まりました。リモートノードのデータがない場合は、セッションを維持するためにポーリングが30〜45秒の間隔で繰り返されました。必要なすべてのデータ（現在のノードとリモートのIPアドレスとポート）がノード上にある時点で、パケットの交換が始まりました。パケットには、番号m = 0と、0〜254の生成された番号が含まれていました（この番号は、VPN接続の内部IPアドレスを生成するために使用されました）。 m = 0のパケットを受信すると、リモートノードは応答としてm = 1を送信し、以下同様に10を送信します。m= 10パケットを受信すると、m = 13で1秒の頻度でパケットパケットが送信され、OpenVPNが開始され、リモートノードもm = 13を受信しました。ローカルポート、IPアドレス、リモートホストのポート、および生成された10.XX {1,2} / 30形式の内部IPを使用してOpenVPNを起動しました。リモートホストのIPアドレスとポート、および10.XX {1,2} / 30の形式の生成された内部IP。リモートホストのIPアドレスとポート、および10.XX {1,2} / 30の形式の生成された内部IP。</font></font><br>
<img src="https://habrastorage.org/webt/jv/ee/uh/jveeuhusbrnchqcfwownlas0tha.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーの関与なしの直接VPNトンネルとノード間のデータ転送の図</font></font></i><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告：スクリプトは</font></font></b><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、VPS </font></font></b><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">上のUbuntu 18.04およびDebian 9 OS </font></b><b><font style="vertical-align: inherit;">スクリプトで</font></b><b><font style="vertical-align: inherit;">作成およびテストされてい</font></b><i><font style="vertical-align: inherit;">ます</font></i><b><font style="vertical-align: inherit;">：＃cat</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
connector2.sh</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$1</span> == <span class="hljs-string">''</span> ]]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"     "</span>; <span class="hljs-built_in">exit</span>; <span class="hljs-keyword">fi</span>
iface=`ip route get 8.8.8.8 | head -n 1 | sed <span class="hljs-string">'s|.*dev ||'</span> | awk <span class="hljs-string">'{print $1}'</span>`<font></font>
a=0<font></font>
until (( <span class="hljs-variable">$a</span> == 500)); <span class="hljs-keyword">do</span>
	packet=`tcpdump -i <span class="hljs-variable">$iface</span> udp port <span class="hljs-variable">$1</span> -vvn -c1 -A`
		<span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$packet</span>"</span> == *<span class="hljs-string">"Ident"</span>* ]]; <span class="hljs-keyword">then</span>
			pack=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$packet</span>"</span> | grep -e <span class="hljs-string">"udp sum ok"</span> -e <span class="hljs-string">"Ident"</span>`<font></font>
 			myip=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$pack</span> | sed <span class="hljs-string">'s/\./ /g'</span> | awk <span class="hljs-string">'{print $1"."$2"."$3"."$4}'</span>`<font></font>
 			myport=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$pack</span> | sed <span class="hljs-string">'s/\./ /g'</span> | awk <span class="hljs-string">'{print $5}'</span>`<font></font>
 			id=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$pack</span> | sed <span class="hljs-string">'s|.*Ident:||'</span> | awk <span class="hljs-string">'{print $1}'</span>`<font></font>
 			myname=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$pack</span> | sed <span class="hljs-string">'s|.*Ident:||'</span> | awk <span class="hljs-string">'{print $2}'</span>`
			<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$myip</span>:<span class="hljs-variable">$myport</span> <span class="hljs-variable">$myname</span>"</span> &gt; /tmp/vpn2-<span class="hljs-variable">$id</span>-<span class="hljs-variable">$myname</span>
			<span class="hljs-built_in">echo</span> <span class="hljs-string">"MyData <span class="hljs-variable">$myip</span>:<span class="hljs-variable">$myport</span> <span class="hljs-subst">$(cat /tmp/vpn2-$id-* | grep -v $myname | awk {'print $1'})</span>"</span> | nc <span class="hljs-variable">$myip</span> <span class="hljs-variable">$myport</span> -u -p <span class="hljs-variable">$1</span> -w 1<font></font>
			cat /tmp/vpn2-<span class="hljs-variable">$id</span>-*<font></font>
			topoint=`cat /tmp/vpn2-<span class="hljs-variable">$id</span>-* | grep -v <span class="hljs-string">"<span class="hljs-variable">$myname</span>"</span> | sed <span class="hljs-string">'s/:/ /g'</span>`
			<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$topoint</span> != <span class="hljs-string">''</span> ]]; <span class="hljs-keyword">then</span>
						ip=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$topoint</span> | awk <span class="hljs-string">'{print $1}'</span>`<font></font>
						port=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$topoint</span> | awk <span class="hljs-string">'{print $2}'</span>`
						<span class="hljs-built_in">echo</span> <span class="hljs-string">"MyData <span class="hljs-variable">$ip</span>:<span class="hljs-variable">$port</span> <span class="hljs-subst">$(cat /tmp/vpn2-$id-* | grep $myname | awk {'print $1'})</span>"</span> | nc <span class="hljs-variable">$ip</span> <span class="hljs-variable">$port</span> -u -p <span class="hljs-variable">$1</span> -w 1
						<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/etc/rc.localの行で自動的に実行されます </font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
nohup /--/connector2.sh 13013 &gt; /var/<span class="hljs-built_in">log</span>/connector2.log &amp;
<span class="hljs-built_in">exit</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
13013はリッスンするポート、/ var / log / connector2.logはログです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノード上のスクリプト：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃cat vpn7.sh</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">########################    ###</span>
WARN=<span class="hljs-string">'\033[37;1;41m'</span>				<span class="hljs-comment">#</span>
END=<span class="hljs-string">'\033[0m'</span>					<span class="hljs-comment">#</span>
RED=<span class="hljs-string">'\033[0;31m'</span>         <span class="hljs-comment">#  ${RED}		#</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>      <span class="hljs-comment">#  ${GREEN}		#</span>
<span class="hljs-comment">#################################################</span>
<span class="hljs-comment">#######################     #########################################################</span>
al=<span class="hljs-string">"ip echo readlink dirname ps grep awk kill md5sum shuf nc curl sleep openvpn tcpdump cat"</span><font></font>
ch=0<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-variable">$al</span>; <span class="hljs-keyword">do</span> <span class="hljs-built_in">which</span> <span class="hljs-variable">$i</span> &gt; /dev/null || <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>   <span class="hljs-variable">$i</span> <span class="hljs-variable">${END}</span>"</span>; <span class="hljs-built_in">which</span> <span class="hljs-variable">$i</span> &gt; /dev/null || ch=1; <span class="hljs-keyword">done</span>
<span class="hljs-keyword">if</span> (( <span class="hljs-variable">$ch</span> &gt; 0 )); <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>,      <span class="hljs-variable">${END}</span>"</span>; <span class="hljs-built_in">exit</span>; <span class="hljs-keyword">fi</span>
<span class="hljs-comment">#######################################################################################################################</span><font></font>
<font></font>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$1</span> == <span class="hljs-string">''</span> ]]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>   (  ,      !) <span class="hljs-variable">${END}</span> \t
<span class="hljs-variable">${GREEN}</span>           /etc/rc.local  nohup /&lt;  &gt;/vpn7.sh  &gt; /var/log/vpn7.log 2&gt;/dev/hull &amp; <span class="hljs-variable">${END}</span>"</span>; <span class="hljs-built_in">exit</span>; <span class="hljs-keyword">fi</span>
ABSOLUTE_FILENAME=`readlink -f <span class="hljs-string">"<span class="hljs-variable">$0</span>"</span>`                                                    <span class="hljs-comment">#    </span>
DIR=`dirname <span class="hljs-string">"<span class="hljs-variable">$ABSOLUTE_FILENAME</span>"</span>`                                                      <span class="hljs-comment">#     </span>
<span class="hljs-comment">###############################       ##################################</span>
cfg=<span class="hljs-string">"<span class="hljs-variable">$DIR</span>/vpn.cfg"</span>
<span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$cfg</span>"</span> ]]; <span class="hljs-keyword">then</span>
		      <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>    <span class="hljs-variable">$cfg</span>"</span>
                      <span class="hljs-built_in">source</span> <span class="hljs-string">"<span class="hljs-variable">$cfg</span>"</span>
                  <span class="hljs-keyword">else</span>
                      <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>    !"</span>
                  <span class="hljs-keyword">fi</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment">###############################     ##################################</span>
key=<span class="hljs-string">"<span class="hljs-variable">$DIR</span>/secret.key"</span>
<span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> ]; <span class="hljs-keyword">then</span>
				<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${WARN}</span>  VPN-  ,    : \
openvpn --genkey --secret secret.key :       \
    !!!<span class="hljs-variable">${END}</span>
 # ls -l secret.key
 -rw------- 1 root root 637  27 11:12 secret.key
 # chmod 600 secret.key"</span>;
				<span class="hljs-built_in">exit</span>;
				<span class="hljs-keyword">fi</span>
<span class="hljs-comment">#########################################################################################</span>
localport=`shuf -i 20000-65000 -n 1`						<span class="hljs-comment">#   </span>
name=`uname -n | md5sum | awk <span class="hljs-string">'{print $1}'</span>`                                             <span class="hljs-comment">#  </span>
ipsrv=<span class="hljs-string">"45.141.103.45"</span>                                                                  <span class="hljs-comment"># IP-      </span>
portsrv=<span class="hljs-string">"13013"</span><font></font>
<font></font>
<span class="hljs-comment">###############################   ###########</span><font></font>
<font></font>
until [[ <span class="hljs-variable">$count</span> &gt; 100 ]]; <span class="hljs-keyword">do</span>
<span class="hljs-comment">#########################################################################################</span>
until [[ -n <span class="hljs-string">"<span class="hljs-variable">$iftosrv</span>"</span> ]]; <span class="hljs-keyword">do</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>   "</span>; iftosrv=`ip route get <span class="hljs-variable">$ipsrv</span> | head -n 1 | sed <span class="hljs-string">'s|.*dev ||'</span> | awk <span class="hljs-string">'{print $1}'</span>`; sleep 5; <span class="hljs-keyword">done</span>	<span class="hljs-comment">#  </span>
netcattosrv=<span class="hljs-string">"nc -u <span class="hljs-variable">$ipsrv</span> <span class="hljs-variable">$portsrv</span> -p <span class="hljs-variable">$localport</span> -w 1"</span>				<span class="hljs-comment">#    NC</span>
tcpdumptosrv=<span class="hljs-string">"tcpdump -i <span class="hljs-variable">$iftosrv</span> udp and src port <span class="hljs-variable">$portsrv</span> and src <span class="hljs-variable">$ipsrv</span> and dst port <span class="hljs-variable">$localport</span> -n -c1 -A"</span>   <span class="hljs-comment">#   </span>
id=`<span class="hljs-built_in">echo</span> <span class="hljs-variable">$1</span>| md5sum | awk <span class="hljs-string">'{print $1}'</span>` 					<span class="hljs-comment">#     md5      </span>
<span class="hljs-comment">#####################        ###################################</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span> 1 -     <span class="hljs-variable">$ipsrv</span>:<span class="hljs-variable">$portsrv</span> <span class="hljs-variable">${END}</span>"</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>  <span class="hljs-variable">$iftosrv</span>    <span class="hljs-variable">$localport</span> <span class="hljs-variable">${END}</span>"</span>
until [[ -n <span class="hljs-string">"<span class="hljs-variable">$ip</span>"</span> &amp;&amp; -n <span class="hljs-string">"<span class="hljs-variable">$port</span>"</span> ]]; <span class="hljs-keyword">do</span>
			<span class="hljs-keyword">if</span> [[ -z <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> ]]; <span class="hljs-keyword">then</span>
				sleep 1 &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"Ident: <span class="hljs-variable">$id</span> <span class="hljs-variable">$name</span>"</span> | <span class="hljs-variable">$netcattosrv</span> &gt; /dev/null &amp;<font></font>
				sleep 4 &amp;&amp; pid=`ps xa | grep <span class="hljs-string">"<span class="hljs-variable">$tcpdumptosrv</span>"</span> | grep -v grep | awk <span class="hljs-string">'{print $1}'</span>` &amp;&amp; <span class="hljs-keyword">if</span> [[ -n <span class="hljs-variable">$pid</span> ]]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">kill</span> <span class="hljs-variable">$pid</span>; <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>    ,   ..."</span>; <span class="hljs-keyword">fi</span> &amp;<font></font>
				data=`<span class="hljs-variable">$tcpdumptosrv</span>`<font></font>
				sleep 2<font></font>
			<span class="hljs-keyword">fi</span>
			<span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> ]]; <span class="hljs-keyword">then</span>
				<span class="hljs-comment">#echo ": $data"</span>
				data=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> | grep <span class="hljs-string">"MyData"</span> | sed <span class="hljs-string">'s|.*MyData ||'</span> | sed <span class="hljs-string">'s/:/ /g'</span>`<font></font>
				myip=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> | awk <span class="hljs-string">'{print $1}'</span>`<font></font>
				myport=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> | awk <span class="hljs-string">'{print $2}'</span>`<font></font>
				ip=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> | awk <span class="hljs-string">'{print $3}'</span>`<font></font>
				port=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$data</span>"</span> | awk <span class="hljs-string">'{print $4}'</span>`<font></font>
				data=<span class="hljs-string">''</span>
				<span class="hljs-keyword">if</span> [[ -z <span class="hljs-variable">$tst</span> ]]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>  IP: <span class="hljs-variable">$myip</span>  : <span class="hljs-variable">$myport</span> <span class="hljs-variable">${END}</span>"</span>; <span class="hljs-keyword">fi</span>
				<span class="hljs-keyword">if</span> [[ -n <span class="hljs-variable">$localport</span> &amp;&amp; -n <span class="hljs-variable">$myport</span> &amp;&amp; -z <span class="hljs-variable">$tst</span> ]];<span class="hljs-keyword">then</span>
										<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$localport</span> == <span class="hljs-variable">$myport</span> ]]; <span class="hljs-keyword">then</span>
										<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>   <span class="hljs-variable">$localport</span>    <span class="hljs-variable">$myport</span> ,  CONE NAT <span class="hljs-variable">${END}</span>"</span>; tst=1
										<span class="hljs-keyword">else</span>
										<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${RED}</span>   <span class="hljs-variable">$localport</span>    <span class="hljs-variable">$myport</span> ,  SYMMETRIC NAT <span class="hljs-variable">${END}</span>"</span>; tst=1
										<span class="hljs-keyword">fi</span>
										<span class="hljs-keyword">fi</span>
				<span class="hljs-keyword">fi</span>
			<span class="hljs-keyword">if</span> [[ -n <span class="hljs-string">"<span class="hljs-variable">$ip</span>"</span> &amp;&amp; -n <span class="hljs-string">"<span class="hljs-variable">$port</span>"</span> ]]; <span class="hljs-keyword">then</span>
								<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>    : IP: <span class="hljs-variable">$ip</span> : <span class="hljs-variable">$port</span>,    ... <span class="hljs-variable">${END}</span>"</span>;
							 <span class="hljs-keyword">else</span><font></font>
								sleep=`shuf -i 30-45 -n 1`;<font></font>
								<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${RED}</span>   ,       ,   <span class="hljs-variable">$sleep</span>     ... <span class="hljs-variable">${END}</span>"</span>;<font></font>
								sleep <span class="hljs-variable">$sleep</span> &amp;&amp; pid=`ps xa | grep <span class="hljs-string">"<span class="hljs-variable">$tcpdumptosrv</span>"</span> | grep -v grep | awk <span class="hljs-string">'{print $1}'</span>` &amp;&amp; <span class="hljs-keyword">if</span> [[ -n <span class="hljs-variable">$pid</span> ]]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">kill</span> <span class="hljs-variable">$pid</span>; <span class="hljs-keyword">fi</span> &amp;<font></font>
								data=`<span class="hljs-variable">$tcpdumptosrv</span>`
							 <span class="hljs-keyword">fi</span>
			<span class="hljs-keyword">done</span><font></font>
<font></font>
<span class="hljs-comment">######################     </span>
iftopeer=`ip route get <span class="hljs-string">"<span class="hljs-variable">$ip</span>"</span> | head -n 1 | sed <span class="hljs-string">'s|.*dev ||'</span> | awk <span class="hljs-string">'{print $1}'</span>`
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span> 2 -      <span class="hljs-variable">$ip</span>:<span class="hljs-variable">$port</span><span class="hljs-variable">${END}</span>"</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>  : <span class="hljs-variable">$myip</span>:<span class="hljs-variable">$myport</span> -&gt; <span class="hljs-variable">$ip</span>:<span class="hljs-variable">$port</span> <span class="hljs-variable">${END}</span>"</span><font></font>
m=0<font></font>
t=0<font></font>
connect=0<font></font>
until (( <span class="hljs-variable">$connect</span> &gt;= 10 )); <span class="hljs-keyword">do</span>
                        <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$oktet</span>"</span> ]; <span class="hljs-keyword">then</span>
							<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>  ,     <span class="hljs-variable">$cfg</span>"</span><font></font>
                                                        oktet=`shuf -i 0-254 -n 1`<font></font>
							<span class="hljs-built_in">echo</span> <span class="hljs-string">"oktet=<span class="hljs-variable">$oktet</span>"</span> &gt;&gt; <span class="hljs-variable">$cfg</span>
                                                 <span class="hljs-keyword">fi</span>
			netcattopeer=<span class="hljs-string">"nc -u <span class="hljs-variable">$ip</span> <span class="hljs-variable">$port</span> -p <span class="hljs-variable">$localport</span> -w 1"</span>
			tcpdumptopeer=<span class="hljs-string">"tcpdump -i <span class="hljs-variable">$iftopeer</span> udp and port <span class="hljs-variable">$localport</span> and src "</span><span class="hljs-variable">$ip</span><span class="hljs-string">" -n -c1 -A"</span>
			until (( <span class="hljs-variable">$m</span> &gt;= 10 )); <span class="hljs-keyword">do</span>
				<span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> {1..3}; <span class="hljs-keyword">do</span>
						   <span class="hljs-keyword">for</span> pid1nc <span class="hljs-keyword">in</span> `ps xa | grep <span class="hljs-string">"<span class="hljs-variable">$netcattopeer</span>"</span> | grep -v grep | awk <span class="hljs-string">'{print $1}'</span>`;<span class="hljs-keyword">do</span> <span class="hljs-built_in">kill</span> <span class="hljs-variable">$pid1nc</span>; <span class="hljs-keyword">done</span>;
						   <span class="hljs-built_in">echo</span> <span class="hljs-string">"445Hi: <span class="hljs-variable">$m</span> <span class="hljs-variable">$oktet</span>"</span> | <span class="hljs-variable">$netcattopeer</span> &gt; /dev/null &amp;<font></font>
						   sleep 1<font></font>
						   <span class="hljs-keyword">for</span> pidnc <span class="hljs-keyword">in</span> `ps xa | grep <span class="hljs-string">"<span class="hljs-variable">$netcattopeer</span>"</span> | grep -v grep | awk <span class="hljs-string">'{print $1}'</span>`;<span class="hljs-keyword">do</span> <span class="hljs-built_in">kill</span> <span class="hljs-variable">$pidnc</span>; <span class="hljs-keyword">done</span>
						 <span class="hljs-keyword">done</span> &amp;<font></font>
				sleep 4 &amp;&amp; pid=`ps xa | grep <span class="hljs-string">"<span class="hljs-variable">$tcpdumptopeer</span>"</span> | grep -v grep | awk <span class="hljs-string">'{print $1}'</span>` &amp;&amp; sleep 10 &amp;&amp; <span class="hljs-keyword">if</span> [[ -n <span class="hljs-variable">$pid</span> ]]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">kill</span> <span class="hljs-variable">$pid</span> &amp;&amp; <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${RED}</span>    ,   ... <span class="hljs-variable">${END}</span>"</span>; <span class="hljs-keyword">fi</span> &amp;<font></font>
				peer=`<span class="hljs-variable">$tcpdumptopeer</span>`
				<span class="hljs-keyword">if</span> [[ -n <span class="hljs-variable">$peer</span> ]]; <span class="hljs-keyword">then</span>
					newport=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$peer</span>"</span> | grep <span class="hljs-string">" IP "</span> | sed <span class="hljs-string">"s|.* <span class="hljs-variable">$ip</span>.||"</span> | awk <span class="hljs-string">'{print $1}'</span>`
					<span class="hljs-keyword">if</span> (( <span class="hljs-variable">$newport</span> != <span class="hljs-variable">$port</span> )); <span class="hljs-keyword">then</span>
									<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${WARN}</span>  <span class="hljs-variable">$port</span> -&gt; <span class="hljs-variable">$newport</span> <span class="hljs-variable">${END}</span>"</span>;<font></font>
									port=<span class="hljs-variable">$newport</span>;<font></font>
									netcattopeer=<span class="hljs-string">"nc -u <span class="hljs-variable">$ip</span> <span class="hljs-variable">$port</span> -p <span class="hljs-variable">$localport</span> -w 1"</span>
									<span class="hljs-keyword">fi</span>
					mm=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$peer</span>"</span> | grep <span class="hljs-string">"445Hi: "</span> | sed <span class="hljs-string">'s|.*445Hi: ||'</span> | awk <span class="hljs-string">'{print $1}'</span>`
					<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span> : <span class="hljs-variable">$mm</span> - : <span class="hljs-variable">$mm</span>+1 <span class="hljs-variable">${END}</span>"</span>
					<span class="hljs-keyword">if</span> (( <span class="hljs-variable">$m</span> &lt;= <span class="hljs-variable">$mm</span> )); <span class="hljs-keyword">then</span>
								 m=$(( <span class="hljs-variable">$mm</span> + <span class="hljs-number">1</span> ));
							     <span class="hljs-keyword">fi</span>
					text=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$peer</span>"</span> | grep <span class="hljs-string">"445Hi: "</span> | sed <span class="hljs-string">'s|.*445Hi: ||'</span> | awk <span class="hljs-string">'{print $2}'</span>`
						<span class="hljs-keyword">else</span><font></font>
					(( t++ ))<font></font>
					<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${RED}</span>   <span class="hljs-variable">$t</span>  <span class="hljs-variable">${END}</span>"</span>
					<span class="hljs-keyword">if</span> (( <span class="hljs-variable">$t</span> &gt; 5 ));<span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${RED}</span>   ,  <span class="hljs-variable">${END}</span>"</span>; m=10; connect=1012; ip=<span class="hljs-string">''</span>; port=<span class="hljs-string">''</span>; <span class="hljs-keyword">fi</span>
					<span class="hljs-keyword">fi</span>
				<span class="hljs-keyword">done</span>
			<span class="hljs-keyword">if</span> (( <span class="hljs-variable">$connect</span> &lt; 1012 )); <span class="hljs-keyword">then</span>
			<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>: <span class="hljs-variable">$m</span> <span class="hljs-variable">${END}</span>"</span><font></font>
<font></font>
			<span class="hljs-keyword">if</span> [[ -n <span class="hljs-variable">$endoktet</span> ]]; <span class="hljs-keyword">then</span> 	<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>    = <span class="hljs-variable">$endoktet</span>"</span>
							<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$endoktet</span> == 1 ]]; <span class="hljs-keyword">then</span>
										    ipaddress=<span class="hljs-string">"10.<span class="hljs-variable">$text</span>.<span class="hljs-variable">$oktet</span>.1"</span>
										 <span class="hljs-keyword">else</span>
										    ipaddress=<span class="hljs-string">"10.<span class="hljs-variable">$oktet</span>.<span class="hljs-variable">$text</span>.2"</span>
										 <span class="hljs-keyword">fi</span>
						<span class="hljs-keyword">else</span>
							<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>    ,     <span class="hljs-variable">$cfg</span>"</span>
				                        <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$port</span> &gt; <span class="hljs-variable">$myport</span> ]]; <span class="hljs-keyword">then</span>
                                	                       			    ipaddress=<span class="hljs-string">"10.<span class="hljs-variable">$text</span>.<span class="hljs-variable">$oktet</span>.1"</span>
                                        	              			    <span class="hljs-built_in">echo</span> <span class="hljs-string">"endoktet=1"</span> &gt;&gt; <span class="hljs-variable">$cfg</span>
                                                	        		  <span class="hljs-keyword">else</span>
                                                  	      			    ipaddress=<span class="hljs-string">"10.<span class="hljs-variable">$oktet</span>.<span class="hljs-variable">$text</span>.2"</span>
                                                   	     			    <span class="hljs-built_in">echo</span> <span class="hljs-string">"endoktet=2"</span> &gt;&gt; <span class="hljs-variable">$cfg</span>
                                                     	  			  <span class="hljs-keyword">fi</span><font></font>
<font></font>
						<span class="hljs-keyword">fi</span><font></font>
<font></font>
			m=12<font></font>
			<span class="hljs-keyword">for</span> w <span class="hljs-keyword">in</span> {1..9}; <span class="hljs-keyword">do</span>
					   <span class="hljs-keyword">for</span> pid2nc <span class="hljs-keyword">in</span> `ps xa | grep <span class="hljs-string">"<span class="hljs-variable">$netcattopeer</span>"</span> | grep -v grep | awk <span class="hljs-string">'{print $1}'</span>`;<span class="hljs-keyword">do</span> <span class="hljs-built_in">kill</span> <span class="hljs-variable">$pid2nc</span>; <span class="hljs-keyword">done</span>;
					   <span class="hljs-built_in">echo</span> <span class="hljs-string">"445Hi: <span class="hljs-variable">$m</span> <span class="hljs-variable">$oktet</span>"</span> | <span class="hljs-variable">$netcattopeer</span> &gt; /dev/null; sleep 0.5;
					 <span class="hljs-keyword">done</span>
			<span class="hljs-keyword">for</span> pidnc <span class="hljs-keyword">in</span> `ps xa | grep <span class="hljs-string">"<span class="hljs-variable">$netcattopeer</span>"</span> | grep -v grep | awk <span class="hljs-string">'{print $1}'</span>`; <span class="hljs-keyword">do</span>
								<span class="hljs-built_in">kill</span> <span class="hljs-variable">$pidnc</span> &amp;&amp; <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${RED}</span>  <span class="hljs-variable">$pidnc</span> (NetCat)    <span class="hljs-variable">$localport</span><span class="hljs-variable">${END}</span>"</span>;
								<span class="hljs-keyword">done</span><font></font>
			rpfilter=`cat /proc/sys/net/ipv4/conf/all/rp_filter`<font></font>
			<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$rpfilter</span> == 1 ]]; <span class="hljs-keyword">then</span>
							<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span>rp_filter=<span class="hljs-variable">$rpfilter</span> -      ()<span class="hljs-variable">${END}</span>"</span>;
						 <span class="hljs-keyword">else</span>
							<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${RED}</span>, rp_filter=<span class="hljs-variable">$rpfilter</span>!  (sysctl -w net.ipv4.conf.all.rp_filter=1) « »       () <span class="hljs-variable">${END}</span>"</span>;<font></font>
							sysctl -w net.ipv4.conf.all.rp_filter=1<font></font>
						 <span class="hljs-keyword">fi</span>
			<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${GREEN}</span> ... IP-: <span class="hljs-variable">$ipaddress</span>...<span class="hljs-variable">${END}</span>"</span>
			$(<span class="hljs-built_in">which</span> lsmod) | grep tun || $(<span class="hljs-built_in">which</span> modprobe) tun<font></font>
			openvpn --remote <span class="hljs-variable">$ip</span> --rport <span class="hljs-variable">$port</span> --lport <span class="hljs-variable">$localport</span> \<font></font>
                        --proto udp --dev tap --<span class="hljs-built_in">float</span> --auth-nocache --verb 3 --mute 20 \<font></font>
                        --ifconfig <span class="hljs-string">"<span class="hljs-variable">$ipaddress</span>"</span> 255.255.255.252 \<font></font>
                        --secret <span class="hljs-string">"<span class="hljs-variable">$DIR</span>/secret.key"</span> \<font></font>
                        --auth SHA256 --cipher AES-256-CBC \<font></font>
                        --ncp-disable --ping 10  --ping-exit 40 \<font></font>
			--comp-lzo yes<font></font>
			<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-subst">$(date)</span> <span class="hljs-variable">${RED}</span>  ... <span class="hljs-variable">${END}</span>"</span><font></font>
			m=0<font></font>
			t=0<font></font>
                        (( connect++ ));<font></font>
			<span class="hljs-keyword">fi</span>
			<span class="hljs-keyword">done</span>
<span class="hljs-keyword">done</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトをクリップボードにコピーし、テキストエディターに貼り付けます。次に例を示します。</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment"># nano vpn7.sh</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトを実行可能にします。</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment"># chmod +x vpn7.sh</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の実行では認証キー</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">secret.key</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生成されるため、リモート側には生成しない</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でください。コピーする必要があります。</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment"># openvpn --genkey --secret secret.key </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、次のようにスクリプトを実行します。</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment"># ./vpn7.sh 517vA0051smB4dE</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
strongpasswordgenerator.comで生成されたキー517vA0051smB4dEは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ etc / rc.local</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
の行によって自動的に</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">開始され</font></a><font style="vertical-align: inherit;">ます</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash</span>
nohup /--/vpn7.sh &lt;ID-&gt; &gt;/var/<span class="hljs-built_in">log</span>/vpn7.log 2&gt;/dev/hull &amp;
<span class="hljs-built_in">exit</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、接続IDは接続の一意のフレーズ、/ var / log / vpn7.logは接続ログ、ipsrv = "45.141.103.45"は、connector2.shが実行されているノードのIPアドレスです（最初のスクリプト）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが正しく設定されていれば、時計のように動作します。オンにして数分後にリモートホストと接続します。</font><font style="vertical-align: inherit;">スクリプトは無限のサイクルと時間遅延を使用します。つまり、スクリプトはノードがオンになっている間に動作し、接続が失われた場合にスクリプトを復元しようとします。</font><font style="vertical-align: inherit;">スクリプトは完璧ではありませんが、このテクノロジーが機能するという事実は、たとえば次のような多くの新しいアイデアを与えてくれます。</font></font><br>
<br>
<ul>
<li>      ,     , ,         </li>
<li>      </li>
<li>         </li>
<li>           - </li>
</ul><br>
<b>:</b><br>
<br>
<ul>
<li>    </li>
<li>  </li>
<li>     </li>
<li>   </li>
<li>  </li>
</ul><br>
<b>:</b><br>
<br>
<ul>
<li>    VPS     ,     </li>
<li>       (   )</li>
<li>         ,    NAT</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロバイダー「ハード」NATを使用すると機能しない場合がある</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトをさらにいくつかのシステムに開発し、回答の待機時間を最小限に抑え、送信データの暗号化を強化し、それをWindowsおよびAndroidに適合させ、プロキシを介して作業する方法などを教える計画があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
白いIPv4アドレスの不足を背景に、IPv6がすべての家に届くまで、私の解決策は適切だと思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2019年12月12日更新、追加：</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なりすましアクティベーションコマンドに対処、脆弱性CVE-2019-14899</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NCハングプロセスを終了するコマンド、接続セットアッププロセスが加速されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内部IPアドレスは最初の起動時に生成され、それらのコンポーネントはvpn.cfgに保存されます</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPSを使用せずに、STUNとYandex.Diskを使用した、VPNトンネルの他の実装が</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここに公開されています</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478438/index.html">電動スクリーン-静止モニターの代替</a></li>
<li><a href="../ja478440/index.html">Energyraはオランダの太陽電池パネル工場の再開に取り組んでいます</a></li>
<li><a href="../ja478442/index.html">ITプロジェクトマネージャーの作業を改善する12のソーシャルスキル</a></li>
<li><a href="../ja478448/index.html">あなたが見つけることができる水中ナビゲーションシステムの最も包括的な分類</a></li>
<li><a href="../ja478450/index.html">ストレージシステムでのオブジェクトビデオ分析システムの開発と実装の経験</a></li>
<li><a href="../ja478456/index.html">スマートスピーカーだけではありません。TOP 7自明ではないが有望なIoTソリューション</a></li>
<li><a href="../ja478460/index.html">雨が降らないでください。組み立てモデル。神経技術者＃1工芸品研究所で作られたニューラルネットワークをトレーニングするためのデバイス</a></li>
<li><a href="../ja478462/index.html">暗号通貨 ICO、IEO、STO。鉱業 ブロックチェーン：ロシアの規制。全文：2014-2019</a></li>
<li><a href="../ja478464/index.html">テレメトリー「ベレシタ」を分析、または2019年4月11日に月の近くで何が起こったのか</a></li>
<li><a href="../ja478466/index.html">サイバーセキュリティスマートプラットフォームに1,100万ドルを投資</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>