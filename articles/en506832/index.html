<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚵🏾 🧖🏾 🛸 How many processor instructions does the compiler use? 👩🏾‍🌾 🤦🏼 🐭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A month ago, I tried to count how many different instructions are supported by modern processors, and counted 945 in Ice Lake. Commentators raised an ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How many processor instructions does the compiler use?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506832/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A month ago, I </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tried to count</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> how many different instructions are supported by modern processors, and counted 945 in Ice Lake. Commentators </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">raised an interesting question</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : what part of all this diversity is actually used by compilers? For example, a certain Pepijn de Vos in 2016 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calculated</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> how many different instructions are involved in the binaries in his / usr / bin, and counted 411 - i.e. approximately a third of all x86_64 instructions that existed at that time were not used in any of the standard programs in its OS. His other curious find is that the code for x86_64 consists of instructions for a third </font></font><code>mov</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. (In general, it is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=http://web.archive.org/web/20190331191157/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">known</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that instructions alone are </font></font><code>mov</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enough to write any program.)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decided to develop de Vos research using the LLVM / Clang compiler as the “reference code”. </font><font style="vertical-align: inherit;">It has several advantages over the contents of / usr / bin of an unnamed version of an unnamed OS:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It’s convenient to work with it: this is one huge binary, comparable in size to all the contents of / usr / bin of average Linux;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It allows you to compare different ISAs: </font><font style="vertical-align: inherit;">official </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">releases</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for x86, ARM, SPARC, MIPS and PowerPC are available </font><font style="vertical-align: inherit;">on </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">releases.llvm.org/download.html</font></a><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It allows you to track historical trends: official binaries are available for all releases since 2003;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, in the study of compilers it is logical to use the compiler as an experimental object :-)</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I'll start with the statistics for the March release of LLVM 10.0:</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ISA</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Binary size</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Section Size .text</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total number of instructions</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Number of different instructions</font></font></th>
</tr>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AArch64</font></font></th>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;&nbsp;97 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">74 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">13,814,975</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">195</font></font></td>
</tr>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARMv7A</font></font></th>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">101 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">80 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15,621,010</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">308</font></font></td>
</tr>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i386</font></font></th>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">106 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">88 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">20,138,657</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">122</font></font></td>
</tr>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerPC64LE</font></font></th>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">108 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">89 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">17,208,502</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">288</font></font></td>
</tr>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SPARCv9</font></font></th>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">129 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">105 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">19,993,362</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">122</font></font></td>
</tr>
<tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x86_64</font></font></th>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">107 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">87 MB</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15,281,299</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">203</font></font></td>
</tr>
</tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the last topic, commentators </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mentioned</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that they get the most compact code for SPARC. </font><font style="vertical-align: inherit;">Here we see that the binary for AArch64 is one third smaller in size and in the total number of instructions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is the distribution according to the number of instructions:</font></font><br>
<img src="https://habrastorage.org/webt/kh/ww/hm/khwwhmu8v3ybigswfc2qkw_h9wu.png" width="256"> <img src="https://habrastorage.org/webt/j9/sp/je/j9spjenramwfdy81yg1knir-vxa.png" width="256"> <img src="https://habrastorage.org/webt/98/x0/s1/98x0s1ug_plt-kum6z-pnequy3k.png" width="256"> <img src="https://habrastorage.org/webt/fm/uo/bu/fmuobun0f3s-ou6wq4qbsaht0yk.png" width="256"> <img src="https://habrastorage.org/webt/7v/6h/j1/7v6hj10_uzguo7gnlinmk8nqiaq.png" width="256"> <img src="https://habrastorage.org/webt/xg/xz/qu/xgxzquiy039jdtqw2u708x7be1k.png" width="256"><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unexpectedly, the 11% code for SPARC consists of </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s filling </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">branch delay slots</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . For i386, among the most frequent instructions, we see both </font></font><code>int3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filling the gaps between the functions and </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">used to align loops to cache lines. The de Vos observation that the code is one third consists of </font></font><code>mov</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is confirmed on both x86 variants; but even on load-store architectures </font></font><code>mov</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it turns out, if not the most frequent instruction, then the second after load. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
How has the set of instructions used changed over time? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only ISA for which each release has an official binary is the i386:</font></font><br>
<img src="https://habrastorage.org/webt/jm/90/tp/jm90tpkyf7o9o9asxx6lkyedpvg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The gray line laid on the right axis is the number of different instructions used in the compiler. As we can see, some time ago the compiler was compiled much more diverse. </font></font><code>int3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It was used to fill in the gaps only in 2018; previously used the same </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as for alignment within functions. Here you can see that alignment inside functions has been used since 2013; before that </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there were much less. It is also interesting that until 2016 they </font></font><code>mov</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">accounted for almost half of the compiler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The very first versions of LLVM, before the advent of clang, were also released with binaries for SPARC. Then support for SPARC lost its relevance, and again it appeared only after 14 years - with an order of magnitude increased number of </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s:</font></font><br>
<img src="https://habrastorage.org/webt/yx/cb/ax/yxcbax8rti9hvxewftfrhy3casg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Historically, the next ISA for which LLVM binaries were released was PowerPC: first for Mac OS X and then, after a ten-year hiatus, for RHEL. As you can see from the graph, the transition after this break to the 64-bit version of ISA was accompanied by replacing the majority </font></font><code>lwz</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with </font></font><code>ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and in addition, doubling the variety of instructions: </font></font><br>
<img src="https://habrastorage.org/webt/3u/ry/is/3uryiswbi_mulnxmx-fhmd1dkeu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the binaries for x86_64 and ARM, the frequency of using different instructions was almost unchanged: </font></font><br>
<img src="https://habrastorage.org/webt/nw/-3/6t/nw-36tjm3kcixpao1e477xqss8o.png"><br>
<br>
<img src="https://habrastorage.org/webt/m9/6q/g_/m96qg_c_icdo7tfhkdortqzm708.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When counting ARM instructions, I cut off the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">condition suffixes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - together with them, about a thousand different instructions were obtained, but even without them, ARM is far ahead of other ISAs in the variety of generated instructions. Thus layer</font></font><code>b</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on this graph includes all conditional branchings too. </font><font style="vertical-align: inherit;">For the rest of the ISA, where only transitions and a few other instructions can be conditional, the suffixes of conditions were not cut off during the calculation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, the most recent ISA for which official binaries are published is AArch64. </font><font style="vertical-align: inherit;">What is interesting here is that it </font></font><code>orr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has almost ceased to be used since last year: </font></font><br>
<img src="https://habrastorage.org/webt/p3/t5/bn/p3t5bn-h4uc-ve0khw7pancivxu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PowerPC and AArch64 turned out to be the only ISAs for which the number of different instructions used is growing and growing.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en506814/index.html">Cool, non-tube review Audio-Technica AT-LPW40WN</a></li>
<li><a href="../en506816/index.html">Device Manager Update and monitoring</a></li>
<li><a href="../en506826/index.html">We make a scintillation spectrometer ourselves from ... a radiometer</a></li>
<li><a href="../en506828/index.html">How to make generative images look natural with mathematical algorithms</a></li>
<li><a href="../en506830/index.html">Web Apps: Micro Frontend Module Federation Supported Framework</a></li>
<li><a href="../en506834/index.html">"The last program." Artificial Intelligence Web Series</a></li>
<li><a href="../en506838/index.html">From Lithuania to New York: KGB Dedicated to Intelligence</a></li>
<li><a href="../en506842/index.html">RPA: robotic invoice registration process. The most comprehensive guide</a></li>
<li><a href="../en506848/index.html">Why did we switch to $ SPINNED_TECHNOLOGY at $ FAMOUS_COMPANY</a></li>
<li><a href="../en506852/index.html">How Signal crypto messenger successfully resists wiretapping by US authorities</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>