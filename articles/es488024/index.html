<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>  锔 Fant谩sticas cerraduras de asesoramiento y d贸nde viven ю  </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="PostgreSQL tiene un mecanismo muy conveniente para bloqueos de aviso , tambi茅n son bloqueos de aviso . En Tensor los usamos en muchos lugares del sist...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fant谩sticas cerraduras de asesoramiento y d贸nde viven</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/488024/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL tiene un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mecanismo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> muy conveniente </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">para bloqueos de aviso</font></a><font style="vertical-align: inherit;"> , tambi茅n son </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloqueos de aviso</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En Tensor los usamos en muchos lugares del sistema, pero pocas personas entienden en detalle c贸mo funcionan exactamente y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qu茅 problemas se pueden obtener si se maltratan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zi/sc/ak/ziscak3l-89wfdsjqhytpmkjalg.png"><br>
<a name="habracut"></a><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leer m谩s sobre cerraduras</font></font></b><div class="spoiler_text">   ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a>, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">    PostgreSQL</a>.</div></div><br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ventajas de las cerraduras de recomendaci贸n</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La diferencia fundamental entre este mecanismo y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">los bloqueos de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nivel de tabla / p谩gina / registro </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">"ordinarios"</font></a><font style="vertical-align: inherit;"> es que hay varias caracter铆sticas clave.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bloqueo de ID personalizado</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los bloqueos "normales" en PG siempre est谩n vinculados a un objeto de base de datos espec铆fico (tabla, registro, p谩gina de datos) y al proceso que sirve la conexi贸n. </font><font style="vertical-align: inherit;">Los bloqueos de aviso tambi茅n son un proceso, pero en lugar de un objeto real, se puede establecer un identificador abstracto como </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(bigint)</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o como </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(entero, entero)</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por cierto, adjuntar cada bloqueo a un proceso significa que al nombrarlo </font></font><code>pg_terminate_backend(pid)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o completar correctamente la conexi贸n desde el lado del cliente, puede deshacerse de todos los bloqueos impuestos por 茅l.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comprobaci贸n de CAS para captura de bloqueo</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CAS es un sistema de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comparaci贸n y configuraci贸n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es decir, la verificaci贸n de la capacidad de captura y la captura de la cerradura en s铆 tienen lugar como una operaci贸n at贸mica, y obviamente nadie puede separarse entre ellas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, si primero realiza una solicitud de verificaci贸n para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_locks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mira el resultado, luego decide si bloquear o no, entonces nadie garantiza que entre estas operaciones nadie lograr谩 tomar el objeto que necesita. </font><font style="vertical-align: inherit;">Pero si usa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_try_advisory_lock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , recibir谩 inmediatamente este bloqueo o la funci贸n simplemente regresar谩 </font></font><code>FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin captura sin excepciones y expectativas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existen bloqueos "normales" en el modelo </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Si ya solicit贸 un bloqueo, espere. Si no desea esperar ( </font></font><code>NOWAIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>statement_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>lock_timeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) - aqu铆 es una excepci贸n "</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este enfoque interfiere en gran medida dentro de la transacci贸n, porque entonces debe implementar un bloque </font></font><code>BEGIN-EXCEPTION-END</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para procesar o revertir ( </font></font><code>ROLLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) la transacci贸n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La 煤nica forma de evitar este comportamiento es usar el dise帽o </font></font><code>SELECT ... SKIP LOCKED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que viene con la versi贸n 9.5. Desafortunadamente, con este m茅todo, las opciones "no ten铆an en absoluto qu茅 bloquear" y "estaba, pero ya estaba bloqueado" se vuelven indistinguibles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los bloqueos recomendados causados por las </font><font style="vertical-align: inherit;">funciones de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prueba</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simplemente regresan </font></font><code>TRUE/FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No confunda </font></font><code>pg_advisory_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font><font style="vertical-align: inherit;">- la primera funci贸n </font><b><font style="vertical-align: inherit;">esperar谩</font></b><font style="vertical-align: inherit;"> hasta que reciba un bloqueo, y la segunda simplemente regresar谩 de inmediato </font><font style="vertical-align: inherit;">si es imposible capturarla "en este momento".</font></font><code>pg_<i><b>try</b></i>_advisory_lock</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>FALSE</code><font style="vertical-align: inherit;"></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bloqueos dentro y despu茅s de la transacci贸n.</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como mencion茅 anteriormente, los bloqueos de objetos est谩n "adjuntos" al proceso y existen solo como parte de la transacci贸n actual en 茅l. </font><font style="vertical-align: inherit;">Incluso para imponer, no tendr谩 茅xito:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">LOCK</span> <span class="hljs-keyword">TABLE</span> tbl;
<span class="hljs-comment">-- ERROR:  LOCK TABLE can only be used in transaction blocks</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En consecuencia, al final de la transacci贸n, se eliminan todos los bloqueos impuestos. </font><font style="vertical-align: inherit;">Por el contrario, los bloqueos de aviso se dise帽aron originalmente con la capacidad de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mantener bloqueos y fuera del alcance de una transacci贸n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-number">1</span>);
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_locks <span class="hljs-keyword">WHERE</span> pid = pg_backend_pid() <span class="hljs-keyword">AND</span> locktype = <span class="hljs-string">'advisory'</span>;</code></pre><br>
<pre><code class="plaintext hljs">-[ RECORD 1 ]------+--------------<font></font>
locktype           | advisory<font></font>
database           | 263911484<font></font>
relation           |<font></font>
page               |<font></font>
tuple              |<font></font>
virtualxid         |<font></font>
transactionid      |<font></font>
classid            | 0 &lt;--  int4 #1    int8<font></font>
objid              | 1 &lt;--  int4 #2    int8<font></font>
objsubid           | 1<font></font>
virtualtransaction | 416/475768<font></font>
pid                | 29264<font></font>
mode               | ExclusiveLock<font></font>
granted            | t<font></font>
fastpath           | f</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero ya desde la versi贸n 9.1, han </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aparecido</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> versiones </font><b><font style="vertical-align: inherit;">xact</font></b><font style="vertical-align: inherit;"> de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funciones</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">asesoramiento</font></a><font style="vertical-align: inherit;"> que le permiten implementar el comportamiento de bloqueos "ordinarios" que se liberan autom谩ticamente cuando se completa la transacci贸n que los impuso.</font></font><br>
<br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplos de uso en VLSI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En realidad, como cualquier otra cerradura, el asesoramiento sirve para garantizar la singularidad del procesamiento de un recurso. </font><font style="vertical-align: inherit;">En nuestro pa铆s, dichos recursos suelen ser la tabla completa o un registro espec铆fico de la tabla, que por alguna raz贸n no quiere "bloquearse".</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monoprocesamiento de trabajadores</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la necesidad de procesar algunos datos en la base de datos se desencadena por un evento externo, pero el procesamiento multiproceso es redundante o puede conducir a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">una condici贸n de carrera</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es razonable permitir que solo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un proceso</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> trabaje en estos datos </font><b><font style="vertical-align: inherit;">a la vez</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer esto, intentaremos bloquear con el identificador de la tabla como primer par谩metro y la identificaci贸n de procesamiento de la aplicaci贸n espec铆fica como el segundo:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_try_advisory_lock(
  <span class="hljs-string">'processed_table'</span>::regclass::<span class="hljs-keyword">oid</span>
, <span class="hljs-number">-1</span> <span class="hljs-comment">--   worker'</span>
);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si regresamos </font></font><code>FALSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, entonces alguien m谩s ya est谩 sosteniendo ese bloqueo, y espec铆ficamente este proceso no necesita hacer nada, pero es mejor que termine en silencio. </font><font style="vertical-align: inherit;">As铆 es como, por ejemplo, funciona el proceso de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c谩lculo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> din谩mico </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">del costo de los bienes en un almac茅n</font></a><font style="vertical-align: inherit;"> , </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">de forma</font></a><font style="vertical-align: inherit;"> aislada para cada esquema de cliente individual.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procesamiento simult谩neo de colas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora la tarea es "lo opuesto": queremos que las </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tareas en alguna tabla de cola se</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> procesen lo m谩s r谩pido posible, multiproceso, tolerante a fallas e incluso desde diferentes l贸gicas comerciales (bueno, carecemos del poder de una), por ejemplo, como hace nuestro operador sobre la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transferencia de informes electr贸nicos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a agencias gubernamentales o al </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servicio OFD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que los BL de "procesamiento" son servidores diferentes, ya no se puede colgar mutex. No es seguro se帽alar a un coordinador de proceso especial de distribuci贸n de tareas, "morir", y todo aumentar谩. Y resulta que es m谩s eficiente distribuir tareas directamente en el nivel de la base de datos, y ese m茅todo existe: en la antig眉edad, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dmitry Koterov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> espiaba honestamente el modelo </font><font style="vertical-align: inherit;">y luego lo modificaba creativamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este caso, imponemos un bloqueo en la tabla ID y PK de un registro particular:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span><font></font>
  *<font></font>
<span class="hljs-keyword">FROM</span><font></font>
  queue_table<font></font>
<span class="hljs-keyword">WHERE</span>
  pg_try_advisory_lock(<span class="hljs-string">'queue_table'</span>::regclass::<span class="hljs-keyword">oid</span>, pk_id)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><font></font>
  pk_id<font></font>
<span class="hljs-keyword">LIMIT</span> <span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, el proceso recibir谩 de la mesa el primer registro que a煤n no ha sido bloqueado por sus hermanos competidores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, si PK no consiste en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(entero)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sino en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(entero, entero)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (como en el mismo c谩lculo de costo, por ejemplo), puede imponer un bloqueo directamente en este par; es poco probable que ocurra una intersecci贸n con el "competidor". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
隆Importante! </font><font style="vertical-align: inherit;">隆No olvide </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mantener</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peri贸dicamente </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">su tabla de colas correctamente</font></a><font style="vertical-align: inherit;"> !</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procesamiento exclusivo de documentos</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se utiliza en todas partes en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soluciones de gesti贸n de documentos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">De hecho, en un sistema web distribuido, se puede abrir el mismo documento para que lo vean diferentes usuarios al mismo tiempo, pero solo se puede procesar (cambiar su estado, etc.) en cualquier momento por uno solo.</font></font><br>
<br>
<h2><font color="#004080"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemas tradicionales</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donde sin ellos! </font><font style="vertical-align: inherit;">Casi todo se reduce a una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cosa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><b><font style="vertical-align: inherit;">no desbloquearon lo que bloquearon</font></b><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Superposici贸n m煤ltiple de una cerradura de aviso</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTFM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , como dicen:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si se reciben varias solicitudes de bloqueo a la vez, se acumulan, por lo que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si un recurso se ha bloqueado tres veces, debe desbloquearse tres veces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para estar disponible en otras sesiones.</font></font></blockquote><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pon demasiadas cerraduras a la vez</font></font></h4><br>
<img src="https://habrastorage.org/webt/c-/q5/19/c-q519tdomjwjhoofqaljskvcxa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Miles de ellos! </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lea el manual</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nuevamente </font><font style="vertical-align: inherit;">:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tanto los bloqueos de aviso como los normales se almacenan en el 谩rea de memoria compartida, cuyo tama帽o est谩 determinado por los par谩metros de configuraci贸n </font></font><code>max_locks_per_transaction</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>max_connections</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es importante que esta memoria sea suficiente, porque de lo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contrario el servidor no podr谩 emitir </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ning煤n</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bloqueo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Por lo tanto, el n煤mero de bloqueos recomendados que puede emitir un servidor generalmente se limita a decenas o cientos de miles, seg煤n la configuraci贸n del servidor.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, si surge una situaci贸n en la que desea imponer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">varios miles de bloqueos de aviso</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (incluso si los elimina correctamente m谩s adelante), piense muy bien d贸nde se ejecutar谩 cuando se levante el servidor.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fugas al filtrar registros</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu铆 tomamos la solicitud anterior y agregamos una condici贸n inofensiva, como la ID de verificaci贸n de paridad </font></font><code>AND pk_id % 2 = 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">隆Ambas condiciones</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para cada entrada </font><font style="vertical-align: inherit;">ser谩n verificadas </font><font style="vertical-align: inherit;">! </font><font style="vertical-align: inherit;">Como resultado, se </font></font><code>pg_try_advisory_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complet贸, el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloqueo se superpuso y luego el registro se filtr贸</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> por paridad. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x1/vo/jc/x1vojcx77r-yh1i_j4ygddkfqrg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O una opci贸n del manual:</font></font><br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">FROM</span> foo <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">12345</span>; <span class="hljs-comment">-- ok</span>
<span class="hljs-keyword">SELECT</span> pg_advisory_lock(<span class="hljs-keyword">id</span>) <span class="hljs-keyword">FROM</span> foo <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &gt; <span class="hljs-number">12345</span> <span class="hljs-keyword">LIMIT</span> <span class="hljs-number">100</span>; <span class="hljs-comment">-- !</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es todo: el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloqueo permanece</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero no somos conscientes de esto. </font><font style="vertical-align: inherit;">Se trata con las solicitudes correctas, en el peor de los casos </font></font><code>pg_advisory_unlock_all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oh confundido!</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cl谩sicos del g茅nero ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Confundir </font><font style="vertical-align: inherit;">y </font><font style="vertical-align: inherit;">preguntarse por qu茅 funciona durante tanto tiempo. </font><font style="vertical-align: inherit;">Pero porque la versi贸n sin prueba est谩 </font><b><font style="vertical-align: inherit;">esperando</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">
Confunda </font><font style="vertical-align: inherit;">y </font><font style="vertical-align: inherit;">preg煤ntese a d贸nde se fue la cerradura, y "termin贸" con la transacci贸n. </font><font style="vertical-align: inherit;">Y la transacci贸n consisti贸 en una solicitud, porque en ninguna parte se declar贸 "expl铆citamente", s铆.</font></font><code>pg_<i><b>try</b></i>_advisory_lock</code><font style="vertical-align: inherit;"></font><code>pg_advisory_lock</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><code>pg_try_advisory_lock</code><font style="vertical-align: inherit;"></font><code>pg_try_advisory_<i><b>xact</b></i>_lock</code><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trabaja a trav茅s de pgbouncer</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es una fuente separada de dolor para muchos cuando, en aras del rendimiento, trabajar con la base de datos pasa por </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pgbouncer en modo de transacci贸n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto significa que dos de sus transacciones vecinas que se ejecutan en la misma conexi贸n a la base de datos (que en realidad pasa por el pgbouncer) se pueden ejecutar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en diferentes conexiones "f铆sicas"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el lado base. </font><font style="vertical-align: inherit;">Y tienen sus propias cerraduras ... Cada </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ec/l6/h0/ecl6h02_l0hbh4kspdrba2g0a5c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
una </font><font style="vertical-align: inherit;">tiene </font><font style="vertical-align: inherit;">algunas opciones:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o ir a trabajar a trav茅s de una conexi贸n directa a la base de datos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o invente un algoritmo para que todos los bloqueos de aviso solo est茅n dentro de la transacci贸n (xact)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eso es todo por ahora.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es488010/index.html">Herramientas de dise帽o controladas por dominio</a></li>
<li><a href="../es488012/index.html">Estacionamiento para sus contras</a></li>
<li><a href="../es488014/index.html">9. Fortinet Getting Started v6.0. Registro e informes</a></li>
<li><a href="../es488018/index.html">CAPTCHA, caso especial: rompemos una red neuronal con treinta l铆neas de c贸digo</a></li>
<li><a href="../es488020/index.html">Vivaldi 2.11 - One Touch Beauty</a></li>
<li><a href="../es488026/index.html">Joyer铆a, impresora 3D Formlabs y cuidado del medio ambiente</a></li>
<li><a href="../es488028/index.html">C贸mo comenzar a hacer un juego en UE4</a></li>
<li><a href="../es488030/index.html">C贸mo organizar skins en Symfony</a></li>
<li><a href="../es488034/index.html">驴Qu茅 se puede hacer en 48 horas? Entrevista con el ganador del hackathon de bioinform谩tica BioHack 2019</a></li>
<li><a href="../es488036/index.html">El dominio corp.com est谩 a la venta. Es peligroso para cientos de miles de computadoras corporativas que ejecutan Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>