<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>↕️ 🙇🏼 ☢️ CPythonでの文字列型の実装 🥐 🧖 👷🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CPythonでの基本的な型の実装のゆったりとした分析を続けます。以前は考慮されていた辞書と整数です。それらの実装に興味深く、狡猾なものは何もないと考える人は、これらの記事に参加することをお勧めします。 CPythonには多くの興味深い機能と実装機能が含まれていることをすでに読んでいる人は知っていま...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CPythonでの文字列型の実装</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480324/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPythonでの基本的な型の実装のゆったりとした分析を続け</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">以前は考慮されていた</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">辞書</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">整数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。それらの実装に興味深く、狡猾なものは何もないと考える人は、これらの記事に参加することをお勧めします。 CPythonには多くの興味深い機能と実装機能が含まれていることをすでに読んでいる人は知っています。これらは、スクリプトを作成するときに知っておくと役立つ場合や、アーキテクチャおよびアルゴリズムソリューションのガイドとして役立つ場合があります。ここでも行は例外ではありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3m/lq/kc/3mlqkcmwvt31uagvuvhdqek1rp4.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
歴史について少し脱線してみましょう。 Pythonは1990-91年に登場しました。最初は、Pythonでベースエンコーディングを開発するときに、シングルバイトの古き良きASCIIがありました。しかし、ほぼ同時に（少し遅れて）、人類はエンコーディングの「動物園」の扱いにうんざりしており、1991年にUnicode標準が提案されました。しかし、初めてでもうまくいきませんでした。 2バイトエンコーディングの導入が始まりましたが、すぐに2バイトでは十分ではないことが明らかになり、4バイトエンコーディングが提案されました。残念ながら、各文字に4バイトを割り当てると、特に1バイトASCIIで十分だった国では、ディスク領域とメモリの浪費のように見えました。より多くの文字をサポートするために、いくつかの松葉杖が2バイトエンコーディングに切り取られました。これはすべて、エンコーディングの「動物園」で以前の状況に似始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、1993年にutf-8が導入されました。これは妥協点でした。asciiはutf-8の有効なサブセットでした。他のすべての文字がそれを拡張しましたが、この可能性をサポートするために、各文字の固定長で分割する必要がありました。しかし、</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">誰</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もが正確にUnicode、つまりほとんどのファイルが格納されているほとんどのプログラムでサポートされる単一のエンコーディングになるように決定する</font><font style="vertical-align: inherit;">運命にあったのは彼でした</font><font style="vertical-align: inherit;">。 Webページは通常utf-8のみを使用していたため、これは特にインターネットの開発の影響を受けました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このエンコーディングのサポートは、Pythonなどのutf-8より前に開発されたプログラミング言語に徐々に導入されたため、他のエンコーディングを使用していました。</font><font style="vertical-align: inherit;">Unicodeサポートを論じた素敵な番号100の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PEP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があり</font><font style="vertical-align: inherit;">ます。そして</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PEP-0263に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ソースファイルのエンコーディングを宣言する機能があります。 ascodingは依然としてベースエンコーディングであり、Unicode文字列を宣言するために `u`プレフィックスが使用されていましたが、それらを使用することはまだ便利でなく、十分に自然ではありませんでした。しかし、次の異端を作成する機会が生じました：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> 비빔밥:</span>
    _ = <span class="hljs-number">2</span><font></font>
<font></font>
א = 비빔밥()<font></font>
print(א)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2008年12月3日、歴史的なイベントがpythonコミュニティ全体（そしてこの言語が現在、世界全体に広まったことを考えると）で開催されました-python 3がリリースされました。多くのエンコーディング、したがって、Unicodeがベースエンコーディングになっています。しかし、エンコーディングは複雑で、最初はうまくいかないことを覚えています。今回もうまくいきませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
utf-8の大きな欠点は、文字の長さが固定されないことです。これは、要素のオフセットが事前にわからないため、インデックスにアクセスするなどの単純な操作で複雑さO（N）が発生することに加え、バッファーのサイズがわかっているためです。文字列を格納するために割り当てられている場合、文字数を計算することはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pythonでのこれらすべての問題を回避するために、2および4バイトのエンコーディングを使用することが決定されました（プラットフォームによって異なります）。</font><font style="vertical-align: inherit;">インデックスの処理が簡略化されました。インデックスに2または4を掛けるだけで十分でしたが、これにより問題が発生していました。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各プラットフォームには独自のエンコーディングがあり、コードの移植性に問題が発生する可能性がありました</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2バイトに収まらないトリッキーな文字によるメモリ消費および/またはエンコードの問題の増加</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの問題の解決策は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PEP-393</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">提案されまし</font><font style="vertical-align: inherit;">た。これについて話します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インデックスやその他の操作によるアクセスを容易にするために、行を文字の配列として残すことが決定されましたが、文字の長さが変化し始めました。文字列を作成するとき、インタプリタはすべての文字をスキャンし、「最大」の文字を格納するために必要なバイト数ごとに割り当てます。つまり、ASCII文字列を宣言すると、すべての文字が1バイトになりますが、文字列に1文字を追加する場合キリル文字から、すべての文字はすでに2バイトになります。可能なオプションは3つあります。1文字あたり1、2、4バイトです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
文字列型（PyUnicodeObject）は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のように</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宣言さ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">れています</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Strings allocated through PyUnicode_FromUnicode(NULL, len) use the
   PyUnicodeObject structure. The actual string data is initially in the wstr
   block, and copied into the data block using _PyUnicode_Ready. */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span><font></font>
    PyCompactUnicodeObject _base;<font></font>
    <span class="hljs-keyword">union</span> {
        <span class="hljs-keyword">void</span> *any;<font></font>
        Py_UCS1 *latin1;<font></font>
        Py_UCS2 *ucs2;<font></font>
        Py_UCS4 *ucs4;<font></font>
    } data;                     <span class="hljs-comment">/* Canonical, smallest-form Unicode buffer */</span><font></font>
} PyUnicodeObject;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、PyCompactUnicodeObjectは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次の構造を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">（いくつかの簡略化と私のコメントが提供されています）。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/*    ascii  */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span><font></font>
    PyASCIIObject _base;<font></font>
    Py_ssize_t utf8_length;     <span class="hljs-comment">/*    utf-8  ( 
                                            \0 )*/</span>
    <span class="hljs-keyword">char</span> *utf8;                 <span class="hljs-comment">/* UTF-8  ( \0 )*/</span>
    Py_ssize_t wstr_length;     <span class="hljs-comment">/*  code point  wstr. */</span><font></font>
} PyCompactUnicodeObject;<font></font>
<font></font>
<span class="hljs-comment">/*   ascii  */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    PyObject_HEAD     <span class="hljs-comment">/*   (     ) */</span>
    Py_ssize_t length;          <span class="hljs-comment">/*  code point   */</span>
    Py_hash_t hash;             <span class="hljs-comment">/*   -1,      */</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
        <span class="hljs-comment">/*
           SSTATE_NOT_INTERNED (0)
           SSTATE_INTERNED_MORTAL (1)
           SSTATE_INTERNED_IMMORTAL (2)
         */</span>
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> interned:<span class="hljs-number">2</span>;
        <span class="hljs-comment">/*  :
           - PyUnicode_WCHAR_KIND (0):
             * wchar_t (16  32 ,     ( ))
           - PyUnicode_1BYTE_KIND (1):
           - PyUnicode_2BYTE_KIND (2):
           - PyUnicode_4BYTE_KIND (4):
         */</span>
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> kind:<span class="hljs-number">3</span>;
        <span class="hljs-comment">/*   
          ( ,        ,
	    -  data   ). */</span>
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> compact:<span class="hljs-number">1</span>;
        <span class="hljs-comment">/*       U+0000-U+007F (ASCII) */</span>
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> ascii:<span class="hljs-number">1</span>;
        <span class="hljs-comment">/* ,    ,
               */</span>
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> ready:<span class="hljs-number">1</span>;
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> :<span class="hljs-number">24</span>;<font></font>
    } state;<font></font>
    <span class="hljs-keyword">wchar_t</span> *wstr;              <span class="hljs-comment">/* wchar_t  (  \0 ) */</span><font></font>
} PyASCIIObject;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、4行の表現が可能です。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レガシー文字列、準備完了</font></font><br>
 <br>
 <pre><code class="markdown hljs"><span class="hljs-bullet">        *</span> structure = PyUnicodeObject structure
<span class="hljs-bullet">        *</span>   : !PyUnicode<span class="hljs-emphasis">_IS_</span>COMPACT(op) &amp;&amp; kind != PyUnicode<span class="hljs-emphasis">_WCHAR_</span>KIND
<span class="hljs-bullet">        *</span> kind = PyUnicode<span class="hljs-emphasis">_1BYTE_</span>KIND, PyUnicode<span class="hljs-emphasis">_2BYTE_</span>KIND or
<span class="hljs-code">         PyUnicode_4BYTE_KIND
        * compact = 0
        * ready = 1
        * data.any is not NULL
        * utf8   data.any  utf8_length = length  ascii = 1
        * utf8_length = 0  utf8 is NULL
        * wstr   with data.any  wstr_length = length
          kind=PyUnicode_2BYTE_KIND and sizeof(wchar_t)=2
         or if kind=PyUnicode_4BYTE_KIND and sizeof(wchar_4)=4
        * wstr_length = 0  wstr is NULL
    </span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レガシー文字列、準備ができていません</font></font><br>
 <br>
 <pre><code class="markdown hljs"><span class="hljs-bullet">         *</span> structure = PyUnicodeObject
<span class="hljs-bullet">         *</span>   : kind == PyUnicode<span class="hljs-emphasis">_WCHAR_</span>KIND
<span class="hljs-bullet">         *</span> length = 0 (use wstr<span class="hljs-emphasis">_length)
         * hash = -1
         * kind = PyUnicode_</span>WCHAR<span class="hljs-emphasis">_KIND
         * compact = 0
         * ascii = 0
         * ready = 0
         * interned = SSTATE_</span>NOT<span class="hljs-emphasis">_INTERNED
         * wstr is not NULL
         * data.any is NULL
         * utf8 is NULL
         * utf8_</span>length = 0
  </code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパクトアスキー</font></font><br>
<br>
<pre><code class="markdown hljs"><span class="hljs-bullet">         *</span> structure = PyASCIIObject
<span class="hljs-bullet">         *</span>   : PyUnicode<span class="hljs-emphasis">_IS_</span>COMPACT<span class="hljs-emphasis">_ASCII(op)
         * kind = PyUnicode_</span>1BYTE<span class="hljs-emphasis">_KIND
         * compact = 1
         * ascii = 1
         * ready = 1
         * (length —  utf8  wstr )
         * (data    )
         * (  ascii    utf8 string   data)
  </span></code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパクト</font></font><br>
<br>
<pre><code class="markdown hljs"><span class="hljs-bullet">         *</span> structure = PyCompactUnicodeObject
<span class="hljs-bullet">         *</span>   : PyUnicode<span class="hljs-emphasis">_IS_</span>COMPACT(op) &amp;&amp; !PyUnicode<span class="hljs-emphasis">_IS_</span>ASCII(op)
<span class="hljs-bullet">         *</span> kind = PyUnicode<span class="hljs-emphasis">_1BYTE_</span>KIND, PyUnicode<span class="hljs-emphasis">_2BYTE_</span>KIND or
<span class="hljs-code">           PyUnicode_4BYTE_KIND
         * compact = 1
         * ready = 1
         * ascii = 0
         * utf8  data 
         * utf8_length = 0  utf8 is NULL
         * wstr   data  wstr_length=length
            kind=PyUnicode_2BYTE_KIND and sizeof(wchar_t)=2
           or if kind=PyUnicode_4BYTE_KIND and sizeof(wchar_t)=4
         * wstr_length = 0  wstr is NULL
         * (data    )
  </span></code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python 3は、 `u`プレフィックスを介してUnicode文字列を宣言する構文もサポートしていることに注意してください。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span>b = <span class="hljs-string">u""</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>b
<span class="hljs-string">''</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機能は</font><font style="vertical-align: inherit;">、2012年2月にPython 3.3の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PEP-414</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の2番目のバージョンから3番目のバージョンへのコードの移植を容易にするために追加されました。</font><font style="vertical-align: inherit;">2008年12月にpython 3がリリースされましたが、誰も移行を急いでいませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この知識と標準のctypesモジュールで武装して、文字列の内部フィールドにアクセスできます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> ctypes
<span class="hljs-keyword">import</span> enum
<span class="hljs-keyword">import</span> sys<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Interned</span>(<span class="hljs-params">enum.Enum</span>):</span>
    <span class="hljs-comment">#            SSTATE_NOT_INTERNED (0)</span>
    <span class="hljs-comment">#            SSTATE_INTERNED_MORTAL (1)</span>
    <span class="hljs-comment">#            SSTATE_INTERNED_IMMORTAL (2)</span>
    <span class="hljs-comment">#            If interned != SSTATE_NOT_INTERNED, the two references from the</span>
    <span class="hljs-comment">#            dictionary to this object are *not* counted in ob_refcnt.</span>
    SSTATE_NOT_INTERNED = <span class="hljs-number">0</span>
    SSTATE_INTERNED_MORTAL = <span class="hljs-number">1</span>
    SSTATE_INTERNED_IMMORTAL = <span class="hljs-number">2</span><font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Kind</span>(<span class="hljs-params">enum.Enum</span>):</span>
    PyUnicode_WCHAR_KIND = <span class="hljs-number">0</span>
    PyUnicode_1BYTE_KIND = <span class="hljs-number">1</span>
    PyUnicode_2BYTE_KIND = <span class="hljs-number">2</span>
    PyUnicode_4BYTE_KIND = <span class="hljs-number">4</span><font></font>
<font></font>
<font></font>
<span class="hljs-comment"># PyUnicodeObject</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StrStruct</span>(<span class="hljs-params">ctypes.Structure</span>):</span>
    _fields_ = [(<span class="hljs-string">"refcnt"</span>, ctypes.c_long),<font></font>
                (<span class="hljs-string">"type"</span>, ctypes.c_void_p),<font></font>
                (<span class="hljs-string">"length"</span>, ctypes.c_long),<font></font>
                (<span class="hljs-string">"hash"</span>, ctypes.c_void_p),  <span class="hljs-comment"># ascii fields</span>
                (<span class="hljs-string">"_interned"</span>, ctypes.c_uint, <span class="hljs-number">2</span>),<font></font>
                (<span class="hljs-string">"_kind"</span>, ctypes.c_uint, <span class="hljs-number">3</span>),<font></font>
                (<span class="hljs-string">"compact"</span>, ctypes.c_uint, <span class="hljs-number">1</span>),<font></font>
                (<span class="hljs-string">"ascii"</span>, ctypes.c_uint, <span class="hljs-number">1</span>),<font></font>
                (<span class="hljs-string">"ready"</span>, ctypes.c_uint, <span class="hljs-number">1</span>),<font></font>
                (<span class="hljs-string">"_rest_state"</span>, ctypes.c_uint, <span class="hljs-number">16</span>),  <span class="hljs-comment"># for future use</span>
                (<span class="hljs-string">"wstr"</span>, ctypes.c_wchar_p),
                <span class="hljs-comment"># PyCompactUnicodeObject</span>
                (<span class="hljs-string">"utf8_length"</span>, ctypes.c_ssize_t),  <span class="hljs-comment"># Number of bytes in utf8, excluding the terminating \0.</span>
                (<span class="hljs-string">"utf8"</span>, ctypes.c_char_p),<font></font>
                (<span class="hljs-string">"wstr_length"</span>, ctypes.c_ssize_t),  <span class="hljs-comment"># Number of code points</span>
                (<span class="hljs-string">"data"</span>, ctypes.c_void_p)  <span class="hljs-comment"># canonical, smallest-form Unicode buffer</span><font></font>
                ]<font></font>
    _printable_fields = (<span class="hljs-string">"refcnt"</span>, <span class="hljs-string">"length"</span>, <span class="hljs-string">"hash"</span>, <span class="hljs-string">"interned"</span>, <span class="hljs-string">"kind"</span>, <span class="hljs-string">"compact"</span>, <span class="hljs-string">"ascii"</span>, <span class="hljs-string">"ready"</span>, <span class="hljs-string">"wstr"</span>,
                         <span class="hljs-string">"utf8_length"</span>, <span class="hljs-string">"utf8"</span>, <span class="hljs-string">"wstr_length"</span>, <span class="hljs-string">"data"</span>)<font></font>
<font></font>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">interned</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> Interned(self._interned)<font></font>
<font></font>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">kind</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> Kind(self._kind)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span>
        new_line = <span class="hljs-string">'\n'</span>  <span class="hljs-comment"># f-string expression part cannot include a backslash</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"StrStruct(<span class="hljs-subst">{new_line.join(<span class="hljs-string">f'<span class="hljs-subst">{key}</span>=<span class="hljs-subst">{getattr(self, key)}</span>'</span> <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> self._printable_fields)}</span>)"</span><font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    string = sys.argv[<span class="hljs-number">1</span>]<font></font>
    s = StrStruct.from_address(id(string))<font></font>
    print(s)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前の部分で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行ったように、インタプリタを「壊す」ことさえできます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
免責事項：次のコードは現状のまま提供されます。このコードを実行した後、作者は一切の責任を負わず、通訳の状態およびあなたとあなたの同僚のメンタルヘルスを保証できません。コードはcpythonバージョン3.7でテストされており、残念ながらASCII文字列では動作しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、上記のコードを次のように変更します。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_some_magic</span>(<span class="hljs-params">str1, str2</span>):</span><font></font>
    s1 = StrStruct.from_address(id(str1))<font></font>
    s2 = StrStruct.from_address(id(str2))<font></font>
    s2.data = s1.data<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    string = <span class="hljs-string">"비빔밥"</span>
    string2 = <span class="hljs-string">"háč"</span>
    print(string == string2)          <span class="hljs-comment"># False</span><font></font>
    make_some_magic(string, string2)<font></font>
    print(string == string2)          <span class="hljs-comment"># True</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの例では、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python 3.6で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追加された文字列補間を使用しています</font><font style="vertical-align: inherit;">。 Pythonは、文字列を出力するこのメソッドにすぐには来ませんでした：％構文、フォーマット、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perlに似たもの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を試してみました</font><font style="vertical-align: inherit;">（例の詳細な説明は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらく、この期間の変更（ `：=`演算子を使用したpython 3.8以前）は、最も物議を醸したものでした。議論（と非難）は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reddit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PEP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の形式の</font><font style="vertical-align: inherit;">両方で行われ</font><font style="vertical-align: inherit;">ました</font><font style="vertical-align: inherit;">。改善・修正のアイディアを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">iライン</font></a><font style="vertical-align: inherit;">を追加する形で表現</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ユーザーがパーサーを記述して、制御を強化し、SQLインジェクションやその他の問題を回避できます。ただし、この変更は延期されたので、人々はFラインに慣れ、問題があればそれを特定できるようになりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fラインには1つの特性（欠点）があります。たとえば、 '\ n' '\ t'のように、スラッシュを含む特殊文字を指定することはできません。ただし、これは、上記の例で行ったように、特殊文字を含む別の行を宣言してf-lineに渡すことで簡単に回避できますが、ネストされた角括弧を使用できます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">&gt;&gt;&gt; </span>number = <span class="hljs-number">2</span>
<span class="hljs-meta">&gt;&gt;&gt; </span>precision = <span class="hljs-number">3</span>
<span class="hljs-meta">&gt;&gt;&gt; </span> <span class="hljs-string">f"<span class="hljs-subst">{number:.{precision}</span>f}"</span>
<span class="hljs-number">2.000</span>
<span class="hljs-comment"># , format    </span>
<span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-string">"{:{}f}"</span>.format(number, precision)
<span class="hljs-number">2.000</span>    
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、文字列はハッシュを格納</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://webcache.googleusercontent.com/search%3Fq%3Dcache:C_P5w-PDr8oJ:" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">してい</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。この値</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://webcache.googleusercontent.com/search%3Fq%3Dcache:C_P5w-PDr8oJ:" rel="nofollow"><font style="vertical-align: inherit;">を</font></a><font style="vertical-align: inherit;">使用して文字列を比較する</font><font style="vertical-align: inherit;">という</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://webcache.googleusercontent.com/search%3Fq%3Dcache:C_P5w-PDr8oJ:" rel="nofollow"><font style="vertical-align: inherit;">提案</font></a><font style="vertical-align: inherit;">があり</font><font style="vertical-align: inherit;">ました。単純なルールに基づいています。文字列が同じである場合、それらは同じハッシュを持ち、ハッシュが異なる文字列は同じではないということになります。</font><font style="vertical-align: inherit;">しかし、それは満たされていないままでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つの文字列を比較するとき、文字列へのポインタが同じアドレスを参照しているかどうかがチェックされ、そうでない場合は、これが許容される場合は文字ごとの比較またはmemcmpが開始されます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span>
<span class="hljs-title">PyUnicode_Compare</span><span class="hljs-params">(PyObject *left, PyObject *right)</span>
</span>{
    <span class="hljs-keyword">if</span> (PyUnicode_Check(left) &amp;&amp; PyUnicode_Check(right)) {
        <span class="hljs-keyword">if</span> (PyUnicode_READY(left) == <span class="hljs-number">-1</span> ||<font></font>
            PyUnicode_READY(right) == <span class="hljs-number">-1</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
<font></font>
        <span class="hljs-comment">/*     */</span>
        <span class="hljs-keyword">if</span> (left == right)
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
<font></font>
        <span class="hljs-keyword">return</span> unicode_compare(left, right);  <span class="hljs-comment">//    memcmp</span><font></font>
    }<font></font>
     <font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、ハッシュ値は間接的に比較に影響します。</font><font style="vertical-align: inherit;">実際のところ、cpythonでは文字列がインターンされます。つまり、文字列は1つの辞書に格納されます。</font><font style="vertical-align: inherit;">これはすべての文字列に当てはまるわけではなく、すべての定数、ディクショナリキー、フィールドと変数、および長さが20未満のASCII文字列がインターンされます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    string = sys.argv[<span class="hljs-number">1</span>]<font></font>
    string2 = sys.argv[<span class="hljs-number">2</span>]<font></font>
    print(id(string) == id(string2))<font></font>
</code></pre><br>
<pre><code class="plaintext hljs">$ python check_interned.py a a<font></font>
True<font></font>
$ python check_interned.py 비빔밥 비빔밥<font></font>
False<font></font>
$ python check_interned.py aaaaaaaaaaaaaaaaaaaaaaaaaaaaa aaaaaaaaaaaaaaaaaaaaaaaaaaaaa<font></font>
False<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして空の文字列は一般的にシングルトンです</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> PyUnicodeObject *<font></font>
_PyUnicode_New(Py_ssize_t length)<font></font>
{<font></font>
    PyUnicodeObject *unicode;<font></font>
    <span class="hljs-keyword">size_t</span> new_size;<font></font>
<font></font>
    <span class="hljs-comment">/* Optimization for empty strings */</span>
    <span class="hljs-keyword">if</span> (length == <span class="hljs-number">0</span> &amp;&amp; unicode_empty != <span class="hljs-literal">NULL</span>) {<font></font>
        Py_INCREF(unicode_empty);<font></font>
        <span class="hljs-keyword">return</span> (PyUnicodeObject*)unicode_empty;<font></font>
    }<font></font>
    ...<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のように、cpythonは文字列型の単純でありながら効率的な実装を作成できました。</font><font style="vertical-align: inherit;">文字ごとの操作ではなく、memcmp、memcpy関数のおかげで、場合によっては使用メモリを削減し、操作を高速化することができました。</font><font style="vertical-align: inherit;">ご覧のとおり、文字列型は、最初に思われるほど実装が簡単ではありません。</font><font style="vertical-align: inherit;">しかし、cpython開発者は非常に巧みに彼らのビジネスに取り組みました、そしてそれ故に私達はそれを使うことができて、内部で何が起こっているのかさえ考えることさえできません。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja480306/index.html">なぜ閉じた扉を打ち負かしたのですか？</a></li>
<li><a href="../ja480310/index.html">ハブラ探偵：ニュース編集者の秘密</a></li>
<li><a href="../ja480316/index.html">wifiモジュールの消費を10倍以上削減する方法</a></li>
<li><a href="../ja480318/index.html">モスクワのデベロッパー向けの今後の無料イベントの選択＃3（12月16〜24日）</a></li>
<li><a href="../ja480320/index.html">ロシアでのONYXの10年間-この間、テクノロジー、読者、市場はどのように変化したか</a></li>
<li><a href="../ja480326/index.html">F5 Networks Corporationは、NGINXの現在の状況について顧客に通知する手紙を顧客に送信します</a></li>
<li><a href="../ja480328/index.html">PyTorchとC ++の友達を作る方法。TorchScriptの使用</a></li>
<li><a href="../ja480330/index.html">理想的な従業員評価ツール</a></li>
<li><a href="../ja480332/index.html">モスクワ市下院における2019ブロックチェーン投票データの分析</a></li>
<li><a href="../ja480334/index.html">QtQML /クイック相関パネル</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>