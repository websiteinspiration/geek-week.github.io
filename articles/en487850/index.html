<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç£ üè∞ ‚òîÔ∏è Case Studies for Using Network Anomaly Analysis Tools: DNSpionage Campaign Discovery üíÉüèø ‚õÑÔ∏è üë©üèø‚Äçü§ù‚Äçüë®üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to review cases for network traffic analysis (NTA) systems for cybersecurity goals. Today we will see how such solutions can be used to de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Case Studies for Using Network Anomaly Analysis Tools: DNSpionage Campaign Discovery</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/cisco/blog/487850/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We continue to review cases for network traffic analysis (NTA) systems for cybersecurity goals. </font><font style="vertical-align: inherit;">Today we will see how such solutions can be used to detect very complex, targeted and very effective campaigns called DNSpionage and Sea Turtle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But before that, I will briefly recall how the Domain Name System (DNS), which underlies the interaction on the Internet, works. The human brain is so arranged that it is unable to memorize many numbers and numbers that a person does not associate with anything familiar. And the number of memorable combinations of numbers and numbers is in any case small. Therefore, in order not to memorize and store in the notebook hundreds and thousands of IP addresses of the sites we are interested in, a DNS system was invented that translates the symbolic addresses of sites that are more understandable to humans into their IP addresses. If I need to get to any site, then I send a DNS query with the name of the site to the DNS server, which returns me its IP address, which I go to.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/_h/qa/sd_hqaa3za1u2yk51zof_p6x0yi.png" alt="image"><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you dive a little more into the details, then the scheme looks more complicated. If the DNS server closest to me does not know the IP address of the site that interests me, it directs me to the root server, which then directs me to the DNS server of the zone in which the site of interest to me is located (for example, ‚Äú.ru‚Äù), and further along the chain until I reach a DNS server that knows the IP address I need.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1u/ev/vz/1uevvz_3p_mvln6p7tn_4z7i828.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that we trust the DNS servers that send us the IP addresses of the sites we want to visit. And if someone breaks into a DNS server and spoofs a record for matching a symbolic name and IP address? What if we are directed to a fake site that looks like a real one and that can steal our logins and passwords, as well as other confidential information about us? This spoofing is called DNS Redirection and is used by cybercriminals in especially dangerous attacks.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c8/ye/tb/c8yetbb4kae4bljgha9nrwqscrg.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 2009, the ‚ÄúIranian Cyber ‚Äã‚ÄãArmy‚Äù thus replaced twitter.com. In 2011, 186 domains were replaced by Turkish hackers, including HSBC, Vodafone, Acer, and others. In 2013-2014, the Syrian Electronic Army replaced the sites NYT, Twitter, Huffingtin Post (the attempt failed against Facebook). In the same year, similar actions were carried out against WhatsApp, AVG, Avira. A year later, Vietnamese and Malaysian Google sites were replaced, as well as the domain of the Federal Reserve Bank of St. Louis. In 2016, a certain amount of cryptocurrency was stolen from blockchain.info in this way. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, there are more DNS attack vectors, but today we‚Äôll only look at those related to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DNSpionage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sea Turtle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> campaigns </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/br/en/4n/bren4nxhs7lc3q-b-9amxefwdlk.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that we‚Äôve got a quick look at how DNS works and how you can use it to the detriment, we can turn directly to the DNSpionage and Sea Turtle campaigns, starting with the first one. In 2018, the Cisco Talos division encountered it in several countries in the Middle East. It consisted of two parts - infection of users and DNS Redirection, which were not always related, but for a number of signs, we concluded that the same group is most likely behind both parts.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a4/ke/ct/a4kectwab8uvix5-roevs-xfaly.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the first case, victim users received job offers through LinkedIn and other job search sites. All vacancies led to fake sites on which tempting vacancies were posted. Two sites were recorded - hr-wipro [.] Com and hr-suncor [.] Com, which redirected users to the legal wipro.com and suncor.com. The links placed files in MS Word format with embedded macros, each of which worked when the document was opened and closed, respectively.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/u1/m5/6o/u1m56oezwvzjqkyxh657_crei8s.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first macro decoded the PE file and saved it at the address ‚Äù% UserProfile% \. OracleServices \ svshost_serv.doc‚Äù. The second macro renamed ‚Äúsvshost_serv.doc‚Äù to ‚Äúsvshost_serv.exe‚Äù. Then the macro created the ‚Äúchromium updater v 37.5.0‚Äù task, which ran the executable file and repeated it every minute. This malware performed the functions of RAT (remote administration tool), which was called DNSpionage. It interacted with a specially created domain, requesting / receiving commands that it executed. Among these commands are requesting directory contents, scanning the network, copying files, using remote utilities (WinSSHD, Putty, mimikatz), etc. Commands from the command server, as well as the results of the work, were sent in one of two modes - HTTP or DNS. The second option is usually simpler, since there is a high probabilitythat you do not have a full-fledged inspection of DNS traffic and you simply don‚Äôt notice the DNSpionage malicious code communicating with the command server.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most interesting thing begins at the moment the client and server parts of the malware communicate. The client sends the following obfuscated DNS query to 0ffice36o [.] Com (the first character is zero and the last letter is ‚Äúo‚Äù): RoyNGBDVIAA0 [.] 0ffice36o [.] Com, where the first 4 bytes are randomly generated and the rest (GBDVIAA0 ) are a base32 encoded request (for each victim, their own base64 / dase32 alphabet was selected). Deciphering it gives us ‚Äú0GT \ x00‚Äù, where GT is the identifier of the victim, and \ x00 is the request number. The command server answers us in the form of an IP address, which is not always correct, for example, 0.1.0.3 (the DNS protocol allows this). The second DNS query looks like this: t0qIGBDVIAI0 [.] 0ffice36o [.] Com. The command server returns us the IP address: 100.105.114.0, which is 4 characters in regular ASCII encoding,which in this case means the executable command ‚Äúdir \ x00‚Äù. In response, the client side of DNSpionage sends:</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[.] [.] gLtAGJDVIAJAKZXWY000 0ffice36o com -&gt; GJDVIAJAKZXWY000 -&gt; "2gt \ x01 Vol¬ª </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[.] TwGHGJDVIATVNVSSA000 0ffice36o com [.] -&gt; GJDVIATVNVSSA000 -&gt; ¬´2gt \ x02 ume¬ª </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[.] 1QMUGJDVIA3JNYQGI000 0ffice36o com [.] - &gt; GJDVIA3JNYQGI000 -&gt; "2GT \ x03 in d" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
iucCGJDVIBDSNF3GK000 [.] 0ffice36o [.] Com -&gt; GJDVIBDSNF3GK000 -&gt; "2GT \ x04 rive" </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
viLxGJDVIBJAIMQGQ36 [Q] [2]] 2JTQQJQQJQQ [J] 0] [J] 0. h "</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As part of the second part of the DNSpionage campaign, the administrator of the DNS server administrator was stolen, the corresponding DNS records were changed, and certificates were created using LetsEncrypt, which will be used later in the ‚Äúsite in the middle‚Äù attack. It is on such a site that the previously described DNS Redirection attack will send selected victims (in just 2 years of this campaign, we were able to identify 25 redirects, which indicates not a massive, but a targeted attack). Please note that both your own DNS server (if you have one) and third-party DNS servers that you already do not control can be attacked.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As part of their activities, the attackers were able to intercept all traffic that went to the indicated domains of the government bodies of Lebanon and the United Arab Emirates (the Ministry of Finance, the police, the Ministry of Communications and Telecommunications, the airline, etc.), including email and VPN, which could allow them to gather additional information about their victims. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Cisco Talos Sea Turtle campaign was even more complicated than DNSpionage, as attackers attacked not only DNS servers, but also TLD servers (including ccTLDs and gTLDs), </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dn/cq/d6/dncqd6jglxgcen7krr5h3ha7naw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
which allowed unknown hackers to attack state and military organizations in the Middle East and North Africa, as well as special services and oil and gas companies.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/r6/tr/d1/r6trd1zsobqmfdzjk3qiwxrighe.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now back to the original task and see how network traffic analysis systems can help identify the mentioned campaigns. It should be noted right away that given their complexity and the fact that they can be directed against external DNS servers, NTA class systems will not always help us. But in those cases when it comes to the DNS-mode of DNSpionage or an attack on local DNS servers within the framework of DNSpionage or Sea Turtle, we can use Netflow to see all the signs of an attack we need and block them in a timely manner.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we need to define our internal DNS servers and add them to one group. This is where the introduction of almost any anomaly monitoring system begins. To understand whether we encountered anomalies in network traffic or not, we first need to decide what is normal and legitimate. And only after that the system begins to work in full force. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yz/7j/xf/yz7jxfj_hi5yatj6vn3vtmxk74k.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This can be done manually, but it is better to use the function of classifying nodes by type of traffic, which allows you to identify all nodes, even those that we don‚Äôt know about, but which function as DNS servers. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tc/sn/lk/tcsnlktrq9ufitfyfiiquzxzrgy.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, we found 5 servers:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8d/lo/vt/8dlovtovjuua5mgq2oclorteeig.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After we have decided on the legal DNS servers, we can only monitor all the DNS traffic, which is anomalous, that is, beyond what is allowed. For example, this is how we can describe a rule for identifying internal illegally working DNS servers: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_6/fs/8n/_6fs8neufdjlgvdgp8wii7mzw7w.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And this rule will look like this, which shows that for some reason we have 2 DNS servers in our network, one of which is located in the confidential server segment , and the second in the segment of user devices. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nq/oi/d-/nqoid-kfwr9umo4tdeuizttrvsi.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following rule allows us to identify external suspicious DNS servers that interact directly with internal hosts, which may indicate that the DNSpionage command server works with infected corporate devices: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rn/aw/65/rnaw654ohhi-lk7reigqaf5v8vw.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we find examples of such interaction:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4h/xe/dp/4hxedpbytb_3jktf7gxmdlz6ade.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In a similar way, we can configure the network anomaly detection system (and this article uses Cisco Stealthwatch as an example) to detect unauthorized attempts to access internal nodes to the local DNS server (this may indicate a DNSpionage or Sea Turtle is working), as well as active interaction internal hosts with external hosts using the DNS protocol (this will record the operation of DNSpionage in DNS mode). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having fixed the corresponding anomalies and security policy violations, we must develop rules that allow us to signal any future attempts to connect internal nodes, excluding local DNS servers, to external DNS servers (and vice versa).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/da/u5/lq/dau5lqybrkndi_vgnx8x1xju49s.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second rule allows us to record any attempts to interact using DNS traffic within the corporate network, excluding local DNS servers. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rh/cv/ru/rhcvruxhxrjyk0pssluyl8g9gcu.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is how monitoring Netflow (as well as other flow protocols) allows us to identify individual stages of fairly complex attacks that can harm modern corporations and government agencies.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487836/index.html">Interactive upload of files to the server using RxJS</a></li>
<li><a href="../en487838/index.html">Data Validation: A Different Approach</a></li>
<li><a href="../en487842/index.html">2 SIM for a country router - is it a lot or a little?</a></li>
<li><a href="../en487844/index.html">The smell reveals</a></li>
<li><a href="../en487846/index.html">The Ember Times - Issue 133</a></li>
<li><a href="../en487854/index.html">How Namibia protects wild animals + IoT collars</a></li>
<li><a href="../en487858/index.html">Practical use of the Strategy template</a></li>
<li><a href="../en487862/index.html">How much to be Nyasha?</a></li>
<li><a href="../en487864/index.html">Electronic passports: join the world practice or get the risk of personal data leakage?</a></li>
<li><a href="../en487868/index.html">Document scanning and text recognition with VisionKit and Vision Framework on iOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>