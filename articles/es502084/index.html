<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëºüèæ üèùÔ∏è üöÑ Verificaci√≥n del portal de servicios p√∫blicos regionales bajo carga a trav√©s de titiritero üçî üõ∑ üë®üèº‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Usted, curiosamente, est√° viendo la "epopeya del Salvaje Oeste estadounidense sobre la distribuci√≥n de las parcelas de tierra: vaya primero...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Verificaci√≥n del portal de servicios p√∫blicos regionales bajo carga a trav√©s de titiritero</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502084/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Habr! Usted, curiosamente, est√° viendo la "epopeya del Salvaje Oeste estadounidense sobre la distribuci√≥n de las parcelas de tierra: vaya primero y pegue una bandera para apostar" o quiz√°s incluso participe en ella. M√°s precisamente en su versi√≥n moderna: sea el primero en solicitar servicios p√∫blicos para recibir dinero para los ni√±os u obtener un pase para salir de la casa. Mirando todo esto, me gustar√≠a compartir la experiencia de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nuestro equipo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en las pruebas y participar en la preparaci√≥n de un portal regional de servicios para la prestaci√≥n del servicio "Registro de primera clase". Tambi√©n es muy similar al efecto habra y, creo, estuvo cerca de lo que sucedi√≥ hace un par de d√≠as con el portal federal gosuslugi.ru, pero a escala regional.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Superamos este desaf√≠o en Khabarovsk en enero de este a√±o y recientemente participamos en la preparaci√≥n de un servicio similar para emitir permisos de caza en otra regi√≥n. A continuaci√≥n se muestra una peque√±a experiencia que le dar√° la oportunidad de analizar el tema de la preparaci√≥n del trabajo de los portales de servicios p√∫blicos regionales para los per√≠odos pico desde otra perspectiva. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y para empezar, una foto de un autob√∫s negro, que estuvo de servicio en la escuela durante tres d√≠as las 24 horas, en el que el autor de estas l√≠neas confirm√≥ su turno entre sus padres hace tres a√±os. Al menos nuestros padres se han unido. Ver en invierno en Khabarovsk a -30 grados sigue siendo un placer.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o8/vh/rb/o8vhrboqvtrufnftfwxsxb1rgm4.png" alt="imagen"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el proceso de preparaci√≥n para el registro m√°ximo en el primer grado, varios equipos trabajaron, porque </font><font style="vertical-align: inherit;">participa de una forma u otra: el operador del centro de datos, el operador y el desarrollador del sistema de informaci√≥n del portal regional, el operador y el desarrollador del sistema de informaci√≥n educativo integrado, soporte t√©cnico para los usuarios del portal regional. </font><font style="vertical-align: inherit;">En </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iondv</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> realizamos la √∫ltima tarea, monitoreando independientemente el estado del portal y </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">brindando</font></a><font style="vertical-align: inherit;"> soporte a los usuarios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestro papel en la preparaci√≥n es organizar pruebas y recomendaciones sobre configuraciones de almacenamiento en cach√© en nginx, bueno, tambi√©n preparamos instrucciones para los usuarios con el "comportamiento" recomendado.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para aquellos que no conocen el problema de la escritura en el 1er grado</font></font></b>
                        <div class="spoiler_text">         ,    .  .          ,     ,   -     (      ,   ‚Äî      ),    ,  -     ,   ,            .  ,       ,      ,     ‚Äì    ,        .           .<br>
<br>
     1-          ,    .           0:00 ,        10:00 26 . ,    ‚Äì       .        10:00 ,       ‚Äî    ,      - .<br>
<br>
            .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"></a>    .   2017 .     .         ,    ,    .          .<br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un servicio para un recurso demandado como tarea t√©cnica.</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema en servicios como "escribir a 1er grado" en el indicador integral de la carga (o probabilidad de consultas) que tiende a la "funci√≥n delta" (funci√≥n Œ¥, funci√≥n Dirac) es claramente visible en los gr√°ficos en forma de picos. En este momento, hay un aumento m√∫ltiple de llamadas en un corto per√≠odo de tiempo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0l/uc/c6/0lucc67w9pr4uh2ig1swg5tgtq0.png" alt="Funci√≥n Œ¥ y estad√≠sticas de consulta pico"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestra experiencia dice que la tarea principal de la capacitaci√≥n no es aumentar los recursos. La tarea es minimizar el n√∫mero potencial de solicitudes por segundo, estirarlas durante un per√≠odo y preparar el sistema para la carga restante. En este caso, es necesario encontrar y acelerar los cuellos de botella; esto dar√° el mayor efecto de acuerdo con los principios de la teor√≠a de sistemas acotados (principios de Goldratt). Y de lo contrario, es el cuello de botella que fallar√°. Todo el sistema deber√≠a funcionar de √©l: el principio de "drum-buffer-rope".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es f√≠sicamente imposible derramar todo el volumen en 10 minutos de reloj de arena en 1 minuto; es obvio que colapsar√°n. </font><font style="vertical-align: inherit;">Del mismo modo para la prestaci√≥n de servicios. </font><font style="vertical-align: inherit;">No sorprende a nadie, cuando es el turno del MFC y los esc√°ndalos de recibir servicios, pero sorprende a todos, por qu√© el portal se cay√≥. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existen diferentes patrones de comportamiento de manejo de carga de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la teor√≠a de colas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede poner a los usuarios en espera, es decir </font><font style="vertical-align: inherit;">aumentar la cola;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simplemente puede negarse a atender a los que vinieron despu√©s, por ejemplo, hasta que se procesen los anteriores;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Puede intentar aumentar sin fin la productividad.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La experiencia est√° en alg√∫n punto intermedio. De hecho, para un servicio con un recurso limitado proporcionado por una regi√≥n o estado, no solo la velocidad es importante, sino, en primer lugar, la preservaci√≥n de la justicia social, es decir, condiciones iguales para todos. Al mismo tiempo, si el usuario no ha recibido lo que necesita, inicia una nueva solicitud. En este caso, las solicitudes crecen en una avalancha, formando un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modelo de ataque "</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> efecto de acumulaci√≥n de perros </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">"</font></a><font style="vertical-align: inherit;"> (efecto de acumulaci√≥n de perros, estampida de cach√©, tormenta de aciertos): el usuario ya cancel√≥ la solicitud e inici√≥ una nueva, mientras que la anterior a√∫n est√° en la cola para ser procesada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este proceso refuerza el hecho de que familias enteras participan en la presentaci√≥n: pap√° y mam√° llenan las solicitudes al mismo tiempo, y a menudo env√≠an solicitudes varias veces para mayor confiabilidad. </font><font style="vertical-align: inherit;">Y adem√°s, a menudo tambi√©n en varias pesta√±as y varios navegadores. </font><font style="vertical-align: inherit;">Por lo tanto, la carga m√°xima esperada generalmente tiene sentido multiplicarse por 2-3 veces, del n√∫mero de aquellos que realmente solicitan dichos servicios.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retiro de justicia</font></font></b>
                        <div class="spoiler_text">,   ¬´¬ª,            .   ?  ¬´¬ª    ,    .   .     ‚Äî        ,     .        ¬´ ¬ª.        .          .<br>
</div>
                    </div><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organizaci√≥n de la prestaci√≥n de servicios.</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Calculamos el n√∫mero esperado de solicitantes con base en una combinaci√≥n de datos sobre el n√∫mero total de solicitudes presentadas el a√±o pasado y datos por minuto para otras regiones. </font><font style="vertical-align: inherit;">Por lo general, el pico de aplicaciones cae en 5-10 minutos, incluso porque los portales casi no responden durante los primeros tres a cinco minutos, y los usuarios posteriores completan el formulario de 1 a 5 minutos (no se sorprendan, muchos lo completan desde el tel√©fono incluso en condiciones "nerviosas") . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un modelo de c√°lculo aproximado para las 1000 aplicaciones condicionales por hora es el siguiente:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pico de 5 a 10 minutos desde el inicio y el 80% de las solicitudes se presentar√°n bajo la regla de Paretto</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Convencionalmente, planificamos 160 aplicaciones por minuto o 3 aplicaciones por segundo.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De hecho, la primera presentaci√≥n se produjo despu√©s de un minuto y 45 segundos, y el pico de solicitudes pas√≥ de 4 minutos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para reducir la carga en ESIA y en el sistema al generar sesiones de autorizaci√≥n, las instrucciones sugieren que los usuarios inicien sesi√≥n con anticipaci√≥n y alarguen la vida √∫til de la sesi√≥n. </font><font style="vertical-align: inherit;">De hecho, 50% fueron autorizados en 1 hora y ~ 90% en media hora. </font><font style="vertical-align: inherit;">Descubrimos anteriormente que los usuarios comenzaron a iniciar sesi√≥n en el portal 10 minutos antes del inicio del servicio, y la autorizaci√≥n comenz√≥ a funcionar de manera inestable. </font><font style="vertical-align: inherit;">Es dif√≠cil decir por qu√©. </font><font style="vertical-align: inherit;">Quiz√°s la raz√≥n es que cuando el trabajo t√©cnico se lleva a cabo en Mosc√∫ por la noche, en Khabarovsk tenemos apenas el comienzo de la jornada laboral.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retiro sobre instrucci√≥n y arreglos organizacionales</font></font></b>
                        <div class="spoiler_text">            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"></a>.<br>
<br>
         ,    ¬´ ¬ª     . ..      .       ,   -   .. <br>
<br>
    ,        ,         ,    .        -        .      ,       ,      .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es imposible eliminar la "funci√≥n delta" cuando el formulario se vuelve a cargar a las 00:00. El objetivo de este procedimiento es que el servicio aparece en un momento dado. Pero puede intentar reducir el n√∫mero de solicitudes del navegador en todas las rutas de usuario esperadas y, por lo tanto, dejar la carga en el sistema solo de las necesarias: formulario, directorios din√°micos y env√≠o de aplicaciones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La configuraci√≥n de nginx en s√≠ misma es bastante est√°ndar. Aqu√≠ es m√°s importante elegir las limitaciones que el sistema puede soportar. Rec√≥gelos, es decir comenzar√° a poner en cola las solicitudes cuando se espera que el servidor llegue al l√≠mite de sus capacidades.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, y lo m√°s importante, forzamos el almacenamiento en cach√© (proxy_cache) y aumentamos la vida √∫til de los datos "caduca" en nginx para todas las rutas est√°ticas y, cuando sea posible, las p√°ginas din√°micas en las que no hay sesiones. Por cierto, este es un error com√∫n al almacenar en cach√©: escribir en los datos de cach√© (a veces incluso est√°ticos) en los que se almacena la sesi√≥n de otra persona, el resultado suele ser eliminar estas cookies de los encabezados si el servidor no puede separar los tipos de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el navegador para el usuario, parece actualizar p√°ginas de archivos descargados del disco o memoria. Pero incluso cuando el usuario los obtiene del servidor, se toman del cach√© nginx. Los directorios mismos, por supuesto, se almacenan en cach√© en el propio sistema.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qi/oq/nv/qioqnv0ofdjd5e0ygculnetdta4.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto redujo el n√∫mero de solicitudes potenciales de 89 solicitudes a 14 y el volumen de 2.1 MB (para 1000 usuarios que actualizaron la p√°gina, este es un pico potencial de 4-8 Gbit / s) a 38 Kb (todos recordamos webpack, pero para plataformas empresariales esto no es siempre f√°cil de hacer). Seg√∫n los resultados del pasaje, a√∫n era necesario almacenar en cach√© no solo en el sistema, sino tambi√©n en nginx algunos de los directorios de los clasificadores de formularios y din√°micos que no se utilizan en el momento pico y para forzar la vida √∫til de los mismos. Y con un aumento en la carga, generalmente tiene sentido colocar en la p√°gina principal totalmente est√°tica con el enrutamiento de los usuarios al servicio deseado o crear un recurso separado para el servicio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para reducir la carga en el env√≠o, se desactivaron los borradores y el llenado autom√°tico de datos para el ni√±o. Todos los usuarios tienen diferentes velocidades de entrada de datos, lo que elimina la apariencia de un formulario que est√° completamente listo para enviar y evita la funci√≥n delta para enviar aplicaciones, todas 1000 en un minuto. Al mismo tiempo, se mantiene la justicia social, aunque, por supuesto, aparecen quejas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No describir√© la optimizaci√≥n del sistema en s√≠ mismo: durante las pruebas de carga, se identificaron cuellos de botella, principalmente en las consultas DBMS y los √≠ndices y consultas en s√≠ se optimizaron. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Probablemente la optimizaci√≥n m√°s importante es simplificar el formulario. ¬øQu√© afecta m√°s a la velocidad cuando se implementa en un formulario?</font></font><br>
<br>
<ul>
<li>   ‚Äî   ,        ,      .    ‚Äî       5-10 (   iPhone         )   5-       375 /  (1       10 ,     <code>application/x-www-form-urlencoded </code>‚Äì  20 ),  100      625 /.           100/      ‚Äî        .   ,      ¬´  ¬ª.    ‚Äî     ?     ,     .    ,      ?</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gu√≠as sofisticados. </font><font style="vertical-align: inherit;">La carga generalmente aumenta al usar el directorio de direcciones FIAS o CLADR. </font><font style="vertical-align: inherit;">Los problemas aqu√≠ se deben al tama√±o: FIAS ocupa hasta 40 GB en la base de datos y lleva tiempo buscarlo. </font><font style="vertical-align: inherit;">D√©cimas de segundo, pero multiplicado por 1000 solicitudes simult√°neas, cargue cualquier sistema. </font><font style="vertical-align: inherit;">Sin una preparaci√≥n especial, posiblemente en forma de un servicio web separado y en un recurso separado, es dif√≠cil soportar la carga; por lo tanto, a menudo usan un campo de texto sin formato para la direcci√≥n.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, pasemos a las pruebas.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prueba de carga en preparaci√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las pruebas se realizaron a trav√©s de titiriteros, emulando las acciones del usuario en el navegador Crominium. </font><font style="vertical-align: inherit;">Yanedeks.tank y JMeter superaron la protecci√≥n contra ataques, ya que generan muchas de las mismas solicitudes. </font><font style="vertical-align: inherit;">Adem√°s, estas pruebas coinciden d√©bilmente con el perfil de consultas reales al cambiar el comportamiento del sistema bajo carga. </font><font style="vertical-align: inherit;">Adem√°s, los servidores almacenan en cach√© las solicitudes, y es dif√≠cil reproducir parte de los procesos en ellos (por ejemplo, autorizaci√≥n). </font><font style="vertical-align: inherit;">Por cierto, de uno de los seminarios </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devDV</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tenemos una presentaci√≥n con una presentaci√≥n sobre el uso del titiritero para las pruebas, que incluye </font><font style="vertical-align: inherit;">cargar, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">enlace al video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para comenzar, compilamos un perfil de comportamiento del usuario y dividimos el procedimiento en etapas clave:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> autorizaci√≥n masiva en ESIA</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> actualizaci√≥n √∫nica del formulario de servicio,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alimentaci√≥n masiva </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cada una de las etapas hicimos una prueba por separado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El a√±o pasado, hubo dificultades en la etapa de autorizaci√≥n en ESIA, pero probarlo a gran escala es dif√≠cil. El sistema es externo, se activa la protecci√≥n contra ataques y prohibiciones de autorizaci√≥n. Sin embargo, es posible formular un perfil de prueba para probar con precisi√≥n los cuellos de botella del sistema bajo prueba; por lo general, este es el n√∫mero de sesiones autorizadas simult√°neamente y los valores de autorizaci√≥n planificados por minuto, que pueden regularse mediante recomendaciones.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la prueba, el contenedor es importante para organizar varios hilos, utilizamos el 'puppeteer-cluster'. Pero generalmente es m√°s complicado manejar excepciones y cambiar el comportamiento del portal bajo carga: a menudo se revelan elementos de dise√±o que aparecen dos veces. O los elementos no aparecen si algunos datos no se cargaron como se esperaba. Estos son todos los errores que los usuarios ver√°n y volver√°n a cargar la p√°gina, lo que significa que crear√°n una carga adicional. Hay dos formas: implementar el manejo de excepciones en la prueba. O modificar el portal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La prueba en s√≠ es simple. A continuaci√≥n se muestra un fragmento de hacer clic en el bot√≥n "Iniciar sesi√≥n" en el portal de servicios para ingresar datos en ESIA.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">await</span> page.waitForSelector(AUTH_AVAIL,{<span class="hljs-attr">timeout</span>:OPT_ELEM_WAIT_TIME});
<span class="hljs-keyword">const</span> needAuth = <span class="hljs-keyword">await</span> page.$(ELEM_AUTH_IN);
<span class="hljs-keyword">if</span> (!needAuth) <span class="hljs-keyword">throw</span> (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`  `</span>));<font></font>
        <font></font>
<span class="hljs-keyword">await</span> page.waitForSelector(AUTH_BUT, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">await</span> page.click(AUTH_BUT);
<span class="hljs-keyword">await</span> waitNewUrl(page, <span class="hljs-string">'https://esia.gosuslugi.ru/idp/rlogin?cc=bp'</span>, OPT_PAGE_WAIT_TIME);
<span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#mobileOrEmail'</span>, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">let</span> text = <span class="hljs-keyword">await</span> elemGetText(page, <span class="hljs-string">'#authnFrm &gt; div.login-slils-box &gt; div &gt; div.detected &gt; div.left &gt; div.this-user'</span>);
<span class="hljs-keyword">if</span> (text) <font></font>
   text = text.replace(<span class="hljs-regexp">/ -\(\)/g</span>, <span class="hljs-string">''</span>);        
<span class="hljs-keyword">if</span> (text &amp;&amp; text.indexOf(user) === <span class="hljs-number">-1</span>) {
  <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'div.click-to-another &gt; a'</span>);
  <span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#authnFrm &gt; div.login-slils-box &gt; div &gt;'</span> +
                <span class="hljs-string">' div.detected &gt; div.left &gt; div.this-user'</span>, OPT_ELEMENT_INVISIBLE);<font></font>
}<font></font>
<span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#password'</span>, OPT_ELEMENT_VISIBLE);
<span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'#mobileOrEmail'</span>, user);
<span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'#password'</span>, pwd);
<span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#loginByPwdButton'</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verificaci√≥n de la actualizaci√≥n del formulario de solicitud de usuarios pendientes "abriendo el registro". La prueba de reinicio es esencialmente un paso, pero es importante verificar los tipos de errores devueltos: la red es un problema, un error de nginx, un error del servidor y si el formulario cumple con los criterios. Y la dificultad es generar el volumen m√°ximo de solicitudes en la menor cantidad de tiempo y no caer bajo las restricciones de protecci√≥n (sin embargo, durante las pruebas se puede cambiar, por otro lado, tambi√©n es una verificaci√≥n de la configuraci√≥n de infraestructura de red y servidor y WAF). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tales pruebas en titiriteros requieren muchos recursos para funcionar. De hecho, result√≥ que necesita al menos 2 n√∫cleos contra el primer n√∫cleo del subsistema front-end y un canal muy amplio. Pero al alquilarlos en la nube, esto es bastante asequible. Utilizamos Yandex.cloud.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la prueba, la autorizaci√≥n se implementa primero en ESIA para cada flujo por separado. </font><font style="vertical-align: inherit;">Despu√©s de eso, se inicia un navegador separado para cada hilo y en el marco de una instancia se lleva a cabo un n√∫mero determinado de actualizaciones. </font><font style="vertical-align: inherit;">Despu√©s de eso, la instancia se reinicia. </font><font style="vertical-align: inherit;">La verificaci√≥n en s√≠ misma puede incluir una ruta t√≠pica, por ejemplo, la p√°gina principal, la forma del servicio. </font><font style="vertical-align: inherit;">Pero m√°s a menudo es suficiente solo actualizar completamente el servicio y verificar el directorio necesario para que el servicio se pueda enviar, todo como en las instrucciones para los usuarios. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/oe/8w/vk/oe8wvknrrkkw1hn3vb4ke0oh8sw.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un fragmento de la prueba para abrir la p√°gina principal y actualizar la p√°gina.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">await</span> page.setViewport(PUP_OPT);
  <span class="hljs-keyword">await</span> page.goto(BASE_URL);
  <span class="hljs-keyword">await</span> page.setCookie(...cookies[worker.id]);
  <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/nd/lk/form/dnv.htm`</span>);<font></font>
  rdyRefresh++;<font></font>
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#       <span class="hljs-subst">${data}</span>: <span class="hljs-subst">${err.message}</span>`</span>);<font></font>
  getErr++;<font></font>
  <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
}<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; AMOUNT_REFRESH - <span class="hljs-number">1</span>; i++) {
  <span class="hljs-keyword">const</span> filenameIter = path.join(BASE_DIR, PIC_DIR, <span class="hljs-string">`<span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>.png`</span>);
   <span class="hljs-keyword">try</span> {
       <span class="hljs-keyword">await</span> page.reload({<span class="hljs-attr">waitUntil</span>: [<span class="hljs-string">"networkidle0"</span>, <span class="hljs-string">"domcontentloaded"</span>]});<font></font>
        rdyRefresh++;<font></font>
    } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">if</span> (!err.message.includes(<span class="hljs-string">'Navigation failed because browser'</span>)) {
           <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#     <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);<font></font>
           getErr++;<font></font>
           <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filenameIter});<font></font>
        }<font></font>
   }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para la carga mediante el env√≠o de aplicaciones, se implement√≥ todo el ciclo de verificaci√≥n, con una recarga del formulario y la verificaci√≥n de la entrada de todos los datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fragmento.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; AMOUNT_RESEND; i++) {
   <span class="hljs-keyword">const</span> filename = path.join(BASE_DIR, PIC_DIR, <span class="hljs-string">`<span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>.png`</span>);
  <span class="hljs-keyword">try</span> {
     <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">'https://uslugi27.ru/nd/lk/form/dnv.htm'</span>);<font></font>
  } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#      1  <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
      <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
      getErr++;<font></font>
      <span class="hljs-keyword">continue</span>;<font></font>
 }<font></font>
 <span class="hljs-keyword">try</span> {
     <span class="hljs-keyword">const</span> FORM_PREF = <span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; '</span>;
     <span class="hljs-keyword">await</span> clickDelayed(page,<span class="hljs-string">`<span class="hljs-subst">${FORM_PREF}</span>fieldset.petgroup.ungroupped-attrs &gt; div &gt; div:nth-child(4) &gt; div.col-md-9.attr-data`</span>);
<span class="hljs-comment">// &lt;‚Ä¶&gt;</span>
     <span class="hljs-keyword">await</span> page.type(<span class="hljs-string">`<span class="hljs-subst">${FORM_PREF}</span>fieldset:nth-child(2) &gt; div &gt; div:nth-child(1) &gt; div.col-md-9.attr-data &gt; input`</span>, <span class="hljs-string">''</span>);
<span class="hljs-comment">// &lt;‚Ä¶&gt;</span>
  } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#      <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
      <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});
     <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div.col_100.controls &gt; button.btn.btn-primary.pull-right.next'</span>);
      <span class="hljs-keyword">await</span> clickDelayed(page,<span class="hljs-string">`#createForm &gt; div:nth-child(5) &gt; fieldset &gt; div &gt; div:nth-child(1) &gt; div &gt; div`</span>);
       <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div:nth-child(5) &gt; fieldset &gt; div &gt; div:nth-child(2) &gt; div &gt; div'</span>);
       <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#createForm &gt; div.col_100.controls &gt; button.btn.btn-success.pull-right.submit'</span>);<font></font>
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`#     <span class="hljs-subst">${data}</span>-<span class="hljs-subst">${i}</span>: <span class="hljs-subst">${err.message}</span>`</span>);
    <span class="hljs-keyword">await</span> page.screenshot({<span class="hljs-attr">path</span>: filename});<font></font>
    sendErr++;<font></font>
    <span class="hljs-keyword">continue</span>;<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por cierto, la prueba puede acelerarse si ingresa todos los datos no del titiritero mediante el constructo page.type de wait, pero transfiere esta l√≥gica al navegador en s√≠. Pero luego aumenta la complejidad de los errores de captura. Al igual que</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; fieldset.petgroup.ungroupped-attrs &gt; div &gt; div:nth-child(4) &gt; div.col-md-9.attr-data'</span>).click();
 <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#createForm &gt; div:nth-child(4) &gt; fieldset:nth-child(2) &gt; div &gt; div:nth-child(1) &gt; div.col-md-9.attr-data &gt; input'</span>).value = <span class="hljs-string">''</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante las pruebas, proporcionamos varios miles de autorizaciones de ESIA y unas 16 mil solicitudes enviadas. ¬øC√≥mo fue la restauraci√≥n de un sistema productivo de informaci√≥n educativa despu√©s de tantas declaraciones? Ni siquiera pregunte. Esta es una historia completamente diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El principal resultado visible de este proceso fue que los medios locales estaban aburridos ahora en los d√≠as de inscripci√≥n en primer grado. El servicio ha abandonado el √°rea de medios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Paralelamente, creamos un panel para monitorear el desempe√±o del formulario basado en Grafana: la cantidad de aplicaciones, la cantidad de llamadas, las m√©tricas de Yandex, etc. Pero dejaremos este tema para la pr√≥xima vez.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, me gustar√≠a felicitar a todos los que est√°n relacionados con el tema de mejorar la calidad de la prestaci√≥n de servicios estatales y municipales en forma electr√≥nica. </font><font style="vertical-align: inherit;">Este trabajo preparatorio sin fin no fue en vano; despu√©s de todo, en abril y mayo, el n√∫mero de solicitudes presentadas aument√≥ significativamente.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es502068/index.html">110 voltios en tu computadora</a></li>
<li><a href="../es502070/index.html">La historia de Pentax (art√≠culo m√°s video)</a></li>
<li><a href="../es502072/index.html">Acoplando la ISS usando JavaScript y br√∫jula</a></li>
<li><a href="../es502076/index.html">Trolley Robot 2.0. Parte 1. Navegaci√≥n aut√≥noma de un robot dom√©stico basado en ROS</a></li>
<li><a href="../es502080/index.html">M√©todo Kanban: Ejemplo PNZ No. 1, el proceso de estudio de medici√≥n en una startup</a></li>
<li><a href="../es502086/index.html">Configurar Minio para que el usuario solo pueda trabajar con su cubo</a></li>
<li><a href="../es502088/index.html">Una historia de exceso y tiempo perdido. De acuerdo con py3</a></li>
<li><a href="../es502092/index.html">Soporte tecnol√≥gico y regulatorio para servicios de confianza digital en la Federaci√≥n Rusa</a></li>
<li><a href="../es502098/index.html">C√≥mo construimos B2B</a></li>
<li><a href="../es502102/index.html">AutoML es genial y poderoso</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>