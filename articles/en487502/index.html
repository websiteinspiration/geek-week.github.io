<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö† üë©üèæ‚Äçü§ù‚Äçüë©üèº üìã Polling print devices using SNMP while the printer is printing ‚òòÔ∏è üì∫ üêá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I‚Äôll tell you my experience in creating an application that collects statistics about printing devices using the SNMP protocol. In total, more than 10...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Polling print devices using SNMP while the printer is printing</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487502/"><img src="https://habrastorage.org/webt/m7/p_/tn/m7p_tnkupco_afrfr-lcd3uvujg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I‚Äôll tell you my experience in creating an application that collects statistics about printing devices using the SNMP protocol. </font><font style="vertical-align: inherit;">In total, more than 1000 devices and the survey is performed in real time while the printer is printing. </font><font style="vertical-align: inherit;">How this is all implemented, you will learn from the article.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gu/3h/xv/gu3hxv_pl5cyzydt5kxkwmjws0o.png"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNMP is a standard Internet protocol for managing devices in IP networks based on TCP / UDP architectures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using SNMP does not collect information about the user who sent the file to print. </font><font style="vertical-align: inherit;">In addition, SNMP cannot be used for local printers connected via USB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve these problems, you need to create a client that must collect information and send all statistics to the server. </font><font style="vertical-align: inherit;">The organization was so established that the same Linux OS was installed on all client machines. </font><font style="vertical-align: inherit;">Accordingly, the client for collecting print statistics is written in the Linux system as a daemon (an analogue of the service in Windows).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Print Information Collection Client</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The print collection client (written in Python) performs the following tasks:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intercepts messages from the CUPS print service</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">saves print information to a CSV file</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sends CSV files to a folder on the server via FTP</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The CSV file contains the following fields:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Date and time of print job</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP address or domain name of the computer from which the document was sent to print</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP address or host of the print device</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cups Job ID - Job ID from the CUPS Print Service</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Job name - this is most often the file name</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Name of user who sent to print</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Number of pages</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Print job size (Job size in KB)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Print Status (Job Status)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Number of copies (Number of copies)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The number of copies on the job file - is used to more accurately determine the number of copies;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Number of pages by SNMP protocol - used to more accurately determine the number of pages</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SNMP is available - this is a sign that the device should be continuously polled using the SNMP protocol while the document is being printed</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The counter of the printing device at the time of printing start (SNMP variable value) is the verification counter that determines the start of SNMP polling by the server</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The client does not have a GUI interface, all settings are registered in the configuration file</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration File Example</font></font></b><div class="spoiler_text"><pre><code class="plaintext hljs">[main]<font></font>
#    <font></font>
app_directory = /opt/printwatcher<font></font>
<font></font>
#  .    <font></font>
#        )<font></font>
stat_file_directory = /opt/printwatcher/data<font></font>
<font></font>
# ,      <font></font>
state_file = /opt/printwatcher/data/state.pickle<font></font>
<font></font>
# ,       <font></font>
command_state_file = /opt/printwatcher/data/command.state<font></font>
<font></font>
#    <font></font>
#   :<font></font>
#  datetime -     ISO 8601<font></font>
#  random -    8 <font></font>
stat_filename_template = {random}_print_jobs.csv<font></font>
<font></font>
#      <font></font>
# (    )<font></font>
max_stat_file_size_mb = 10<font></font>
<font></font>
#  CSV.  : TAB, SPACE, SEMICOLON, COMMA<font></font>
csv_delimiter = SEMICOLON<font></font>
<font></font>
#      <font></font>
start_service = start<font></font>
<font></font>
<font></font>
[logging]<font></font>
<font></font>
#   (DEBUG, INFO, TRACE)<font></font>
level = DEBUG<font></font>
<font></font>
#  <font></font>
log_file = /var/log/printwatcher.log<font></font>
<font></font>
#      <font></font>
restart_log_file = /var/log/printwatcher-restart.log<font></font>
<font></font>
#   <font></font>
# (  /   logrotate)<font></font>
max_log_file_size_mb = 10<font></font>
<font></font>
<font></font>
[cups]<font></font>
<font></font>
# ,      CUPS<font></font>
spool_directory = /var/spool/cups/<font></font>
<font></font>
#    CUPS    <font></font>
# ( )<font></font>
job_file_lifetime_hours = 48<font></font>
<font></font>
#           <font></font>
# ( )<font></font>
job_info_lifetime_hours = 48<font></font>
<font></font>
<font></font>
#  FTP<font></font>
[ftp]<font></font>
<font></font>
host = 192.168.1.39<font></font>
user = ftpuser<font></font>
password = P@ssw0rd<font></font>
port = 21<font></font>
<font></font>
#         FTP<font></font>
# ( )<font></font>
connection_retry_seconds = 10<font></font>
<font></font>
#  ,       FTP<font></font>
# ( )<font></font>
connection_timeout_seconds = 3600<font></font>
<font></font>
#        FTP <font></font>
# ( )<font></font>
polling_interval = 30<font></font>
<font></font>
#     ftp-<font></font>
management_directory = /management<font></font>
<font></font>
#       ftp-<font></font>
response_directory = /management<font></font>
<font></font>
#   <font></font>
update_directory = /update<font></font>
<font></font>
#      <font></font>
data_directory = /data<font></font>
<font></font>
#  SNMP<font></font>
[snmp]<font></font>
#      SNMP<font></font>
retrieve_snmp_info = false<font></font>
community = public<font></font>
oid = 1.3.6.1.2.1.43.10.2.1.4.1.1<font></font>
port = 161<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the client is written, now we need a server that will not only collect information from all clients, but also the server must monitor emergency situations - pause printing, missing or jammed paper, etc.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Print Information Collection Server Architecture</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The server is written in C #, the DBMS is MSSQL.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Database Configurator is a GUI application that allows you to create and delete a database. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The database is maximally normalized so that there are no text fields in the main statistics table to save disk space.</font></font></li>
<li>   ,  GUI        SNMP-,  OID,         .<br>
<br>
<img src="https://habrastorage.org/webt/kx/hz/5v/kxhz5v9e6xtlox2xg0yaqmmisdy.png"><br>
<br>
<img src="https://habrastorage.org/webt/gc/xa/ov/gcxaovdmwjx5mr0z9kuvysazbuc.png"></li>
<li>      ( Windows)</li>
</ol><br>
<h2>    </h2><br>
<h3> </h3><br>
<ol>
<li>        CSV-</li>
<li>     CSV </li>
<li> CSV-       </li>
<li>  CSV-   ( ) [  ]</li>
<li> CSV-  </li>
<li>  </li>
<li>    OID'</li>
<li>      ,    </li>
</ol><br>
<h3>     </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Before the service will monitor printing in real time, it is necessary to parse the old CSV files (which accumulated until the server was working) and save the information in the database. We will call this point ‚Äúthe first reading of the CSV file directory‚Äù, which can help quickly collect statistics of the old print and save it to the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then the service switches to constant monitoring of the appearance of CSV files in a folder in a separate stream with an interval of 1 second. Each CSV file is processed in a separate stream.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If there are a lot of CSV files in the folder, then in this case there is a limit on the number of simultaneous read streams of files so that the application works stably. When the service starts, there can be a lot of CSV files in the folder and these files are processed without SNMP polling; accordingly, the first reading of the directory has a separate limit on the number of CSV file processing threads (it was experimentally established that the number of threads on the first reading of CSV files should be much smaller than the number of threads after processing a large number of files).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The algorithm provides for determining the IP address by the device name and vice versa (determining the device name by IP address) using the System.Net.Dns.GetHostEntry () method. </font><font style="vertical-align: inherit;">If there is no connection with the device, the System.Net.Dns.GetHostEntry () method takes a very long time, in connection with this, the client that provides this information to CSV has been finalized. </font><font style="vertical-align: inherit;">But this check remained on the server and the System.Net.Dns.GetHostEntry () method is still a bottleneck.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saving information in the database</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to information about printing, the database stores information for statistics:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SNMP polling start and end time</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">total number of lines in the CSV file</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The number of lines with SNMP polling enabled.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A list of devices that should not be polled is provided for, so-called exceptions for which nothing is stored in the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After reading the entire CSV file, information about all print jobs is collected in the List object, which should be monitored by SNMP polling. </font><font style="vertical-align: inherit;">After reading the CSV file, it is transferred to the archive, if specified by the settings, and then the CSV file is deleted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the CSV file is fully read, it is checked that the polling settings are configured using the SNMP protocol, then the devices are sorted by priority:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The default group, in which there are all devices of the ricoh_dmnx base, is the name of the database of the monitoring system from the manufacturer Ricoh, from which we take the list of devices to be polled.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devices that are in the ricoh_dmnx database, but not in groups</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devices that are in the ricoh_dmnx database and are in groups</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devices that are not in the ricoh_dmnx database, but are in our service database</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each device has a print queue so that at one point in time, an SNMP poll works with only one print job. </font><font style="vertical-align: inherit;">Thus, while the device is being interrogated using the SNMP protocol, the user can send another file for printing and a new CSV file can be received on the server, which is saved immediately in the database, but the poll will be performed after the current document. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNMP polling tracks changes in the print counter, device status, and a sign of a device error during printing. </font><font style="vertical-align: inherit;">The latency between SNMP polls is 300 ms.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Underwater rocks</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The server algorithm has been constantly improved, as there were many different situations in which the counter was considered incorrectly. </font><font style="vertical-align: inherit;">Here are some tips from personal experience: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Do not continue polling while the device is in an error state (for example: paper is jammed) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) A printer error may change over time, so the SNMP polling timeout should not work if the error changes (for example, the printer ran out of paper, but after adding paper to the tray, the printer status changed) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) If several jobs are sent to the print device at the same time, then the counter after printing the first job: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - does not change the status </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - changes the counter</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System OIDs of Printing Devices</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Based on the analysis of these three OIDs, my application for polling SNMP devices was written: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) [1.3.6.1.2.1.43.10.2.1.4.1.1] - Total device counter </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) [1.3.6.1.2.1.25.3.5.1 .1.1] - Device status </font></font><br>
<br>
<img src="https://habrastorage.org/webt/md/gt/7r/mdgt7rbnzogchqygr-_iyr0ec4c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) [1.3.6.1.2.1.25.3.2.1.5.1] - Device error during printing</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reports</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reports are implemented using SQL Server Reporting Services.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monthly Print Comparison Report</font></font></h3><br>
<img src="https://habrastorage.org/webt/aj/uc/oi/ajucoihntgrwcqysizhwilpzkvg.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Printed Jobs by User</font></font></h3><br>
<img src="https://habrastorage.org/webt/zt/dv/gk/ztdvgknlvk9pfzg_dva1hlgqucc.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SNMP Request Summary Report</font></font></h3><br>
<img src="https://habrastorage.org/webt/8f/gk/di/8fgkdiwstqceb-uhloijctrdkz4.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SNMP Request Statistics</font></font></h3><br>
<img src="https://habrastorage.org/webt/us/8h/vl/us8hvlzbso5j8cr5w1bxoqeofji.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was glad to share my experience in implementing one of my most complex applications, which has been successfully operating since 2018. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A peculiarity in the implementation of the print collection project was that I did not have a single printer with me. </font><font style="vertical-align: inherit;">Worked through an </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">emulator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that can be quickly installed and configured (it is enough to have a MIB file for the settings of the printing device). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the future, I will write about how the management of print agents was done.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en487502/">https://habr.com/ru/post/en487502/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487470/index.html">Calibry: 3D Breakthrough Price Breakthrough</a></li>
<li><a href="../en487486/index.html">Sega Dreamcast Anatomy: Console Second Life</a></li>
<li><a href="../en487488/index.html">Cases for applying network anomaly analysis tools: detecting the spread of malicious code</a></li>
<li><a href="../en487490/index.html">XSL transformation on MS SQL without CLR</a></li>
<li><a href="../en487498/index.html">Choosing a database for analytics</a></li>
<li><a href="../en487504/index.html">By the Day of Russian Science, the best achievements of domestic scientists of 2019 are named</a></li>
<li><a href="../en487508/index.html">Measuring distance to objects using RealSense D435</a></li>
<li><a href="../en487510/index.html">Radioactive products. Gamma spectrometer. Part 1</a></li>
<li><a href="../en487512/index.html">How to implement ignore blocked users in Telegram groups?</a></li>
<li><a href="../en487514/index.html">Qrator Labs Annual Network Security and Availability Report</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>