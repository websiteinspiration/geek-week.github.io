<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👰🏽 🛀 🕴🏽 mcrouterを使用してmemcachedを水平方向にスケーリングする 🤬 🍛 👨‍👧‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="任意の言語で高負荷のプロジェクトを開発するには、特別なアプローチと特別なツールの使用が必要ですが、PHPのアプリケーションに関しては、状況が悪化して、たとえば独自のアプリケーションサーバーを開発する必要があります。この記事では、セッションの分散ストレージとmemcachedにデータをキャッシュするこ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>mcrouterを使用してmemcachedを水平方向にスケーリングする</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/457510/"><img src="https://habrastorage.org/webt/au/eb/x9/auebx9o2ubzy-xbzporaylovqr0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
任意の言語で高負荷のプロジェクトを開発するには、特別なアプローチと特別なツールの使用が必要ですが、PHPのアプリケーションに関しては、状況が悪化して、たとえば</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">独自のアプリケーションサーバー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を開発する必要があり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。この記事では、セッションの分散ストレージとmemcachedにデータをキャッシュすることで誰もが知っている痛みと、1つの「ワード」プロジェクトでこれらの問題をどのように解決したかについて説明します。</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この機会の主人公は、symfony 2.3フレームワークに基づくPHPアプリケーションであり、ビジネスプランにはまったく含まれていません。完全に標準的なセッションストレージに加えて、プロジェクトで</font><font style="vertical-align: inherit;">は、データベースとAPIサーバーへのクエリへの応答、さまざまなフラグ、コード実行の同期のためのロックなど、memcached </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のすべてのキャッシュを</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最大限に</font><font style="vertical-align: inherit;">活用しまし</font><b><font style="vertical-align: inherit;">た</font></b><font style="vertical-align: inherit;">。この状況では、アプリケーションが機能するためにmemcachedの障害が致命的になります。さらに、キャッシュの喪失は深刻な結果につながります。DBMSが継ぎ目、APIサービス-禁止要求などで亀裂を開始します。状況の安定には数十分かかる場合があり、このときサービスはひどく遅くなるか、完全にアクセスできなくなります。</font><b><font style="vertical-align: inherit;">低血液でアプリケーションを水平方向にスケーリングする機能</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
を提供する必要がありました</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、つまり </font><font style="vertical-align: inherit;">ソースコードへの最小限の変更と機能の完全な維持。</font><font style="vertical-align: inherit;">キャッシュをフォールトトレラントにするだけでなく、キャッシュによるデータ損失を最小限に抑えるようにしてください。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memcached自体の何が問題になっていますか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般に、PHPのmemcached拡張機能はそのまま使用でき、データとセッションの分散ストレージをサポートします。一貫したキーハッシュメカニズムにより、多くのサーバーにデータを均等に分散し、各キーをグループ内の特定のサーバーに明確にアドレス指定できます。フェイルオーバーの組み込みツールは、キャッシングサービスの高可用性を提供します（ただし、残念ながら</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><b><font style="vertical-align: inherit;">はありません</font></b><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セッションストレージの方が少し優れています。それを構成できます。</font></font><code>memcached.sess_number_of_replicas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">その結果、データは複数のサーバーに一度に保存され、1つのmemcachedインスタンスで障害が発生した場合、データは他のインスタンスから送信されます。ただし、サーバーがデータなしでサービスに戻った場合（通常、再起動後）、キーの一部が再配布されます。これは実際には</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">失敗</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">した場合に別のレプリカに「移動」する方法がないため</font><b><font style="vertical-align: inherit;">、セッションデータの損失</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
標準ライブラリツールは主に</font><b><font style="vertical-align: inherit;">水平方向</font></b><font style="vertical-align: inherit;">を対象としています</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スケーリング：キャッシュを巨大なサイズに増やし、さまざまなサーバーでホストされているコードからキャッシュにアクセスできるようにします。ただし、この状況では、格納されるデータの量は数ギガバイトを超えず、1つまたは2つのノードのパフォーマンスで十分です。したがって、有用な通常の手段から、少なくとも1つのキャッシュインスタンスを動作状態に維持しながらmemcachedの可用性を確保することしかできませんでした。ただし、この機会を利用することもできませんでした。ここでは、プロジェクトで使用されているフレームワークの古さを思い出してください。これにより、アプリケーションをサーバープールで動作させることができなくなりました。また、セッションデータが失われることも忘れないでください。顧客のユーザーから大量にログアウトすると目がぴくぴくと動きます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理想的に必要</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memcachedでレコードを複製</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、ミスやエラーが発生した場合に</font><b><font style="vertical-align: inherit;">レプリカをバイパスする </font></b></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mcrouter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、この戦略の実装を支援しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マクローター</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、Facebookが問題を解決するために開発したmemcachedルーターです。</font><font style="vertical-align: inherit;">memcachedテキストプロトコルをサポートしているため、memcached </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インストール</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を非常識なサイズ</font><font style="vertical-align: inherit;">に</font><b><font style="vertical-align: inherit;">スケーリング</font></b><font style="vertical-align: inherit;">できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">mcrouterの詳細な説明は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この発表にあり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">他の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">幅広い機能の中で、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それは私たちが必要とするものにすることができます：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> レコードを複製します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> エラーが発生した場合は、グループの他のサーバーにフォールバックします。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原因に！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マクローター構成</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は直接設定に行きます：</font></font><br>
<br>
<pre><code class="json hljs">{
 <span class="hljs-attr">"pools"</span>: {
   <span class="hljs-attr">"pool00"</span>: {
     <span class="hljs-attr">"servers"</span>: [
       <span class="hljs-string">"mc-0.mc:11211"</span>,
       <span class="hljs-string">"mc-1.mc:11211"</span>,
       <span class="hljs-string">"mc-2.mc:11211"</span><font></font>
   },<font></font>
   <span class="hljs-string">"pool01"</span>: {
     <span class="hljs-attr">"servers"</span>: [
       <span class="hljs-string">"mc-1.mc:11211"</span>,
       <span class="hljs-string">"mc-2.mc:11211"</span>,
       <span class="hljs-string">"mc-0.mc:11211"</span><font></font>
   },<font></font>
   <span class="hljs-string">"pool02"</span>: {
     <span class="hljs-attr">"servers"</span>: [
       <span class="hljs-string">"mc-2.mc:11211"</span>,
       <span class="hljs-string">"mc-0.mc:11211"</span>,
       <span class="hljs-string">"mc-1.mc:11211"</span><font></font>
 },<font></font>
 <span class="hljs-string">"route"</span>: {
   <span class="hljs-attr">"type"</span>: <span class="hljs-string">"OperationSelectorRoute"</span>,
   <span class="hljs-attr">"default_policy"</span>: <span class="hljs-string">"AllMajorityRoute|Pool|pool00"</span>,
   <span class="hljs-attr">"operation_policies"</span>: {
     <span class="hljs-attr">"get"</span>: {
       <span class="hljs-attr">"type"</span>: <span class="hljs-string">"RandomRoute"</span>,
       <span class="hljs-attr">"children"</span>: [
         <span class="hljs-string">"MissFailoverRoute|Pool|pool02"</span>,
         <span class="hljs-string">"MissFailoverRoute|Pool|pool00"</span>,
         <span class="hljs-string">"MissFailoverRoute|Pool|pool01"</span><font></font>
       ]<font></font>
     }<font></font>
   }<font></font>
 }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜ3つのプールがあるのですか？</font><font style="vertical-align: inherit;">サーバーが繰り返されるのはなぜですか？</font><font style="vertical-align: inherit;">それがどのように機能するか見てみましょう。</font></font><br>
<br>
<ul>
<li>    mcrouter  ,         .      <code>OperationSelectorRoute</code>.</li>
<li> GET-    <code>RandomRoute</code>,           <code>children</code>.          <code>MissFailoverRoute</code>,       ,      ,     .</li>
<li>      <code>MissFailoverRoute</code>     ,          memcached,        ,   .      <b>     </b>,                 .</li>
<li>    (  )    <code>AllMajorityRoute</code>.           ,  ,  N/2 + 1  .   <code>AllSyncRoute</code>     ,         <b></b>   —      <code>SERVER_ERROR</code>.    mcrouter      ,    PHP <b> </b>   notice. <code>AllMajorityRoute</code>              .</li>
</ul><br>
<b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このスキーム</font><b><font style="vertical-align: inherit;">の主な欠点は</font></b><font style="vertical-align: inherit;">、キャッシュに実際にデータがない場合、クライアントからの各リクエストに対して、memcachedへのN個のリクエストが実行されることです- </font><font style="vertical-align: inherit;">プール内の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバー</font><font style="vertical-align: inherit;">に対して</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">たとえば、プール内のサーバーの数を2つに減らすことができます。信頼性の</font><font style="vertical-align: inherit;">高い</font><font style="vertical-align: inherit;">ストレージを犠牲に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことで、速度が向上し、キーがない場合の要求に対するストレスが軽減されます。</font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki内のドキュメント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトの問題</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（閉じたものを含む）は、さまざまな構成の倉庫全体を表しており、</font><font style="vertical-align: inherit;">マクローターの学習に役立つリンクになります</font><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mcrouterをビルドして実行する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーション（およびmemcached自体）は、それぞれ同じ場所とmcrouterのKubernetesで動作します。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテナー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">構築するには、</font></b><font style="vertical-align: inherit;">次のような構成の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：記事のリストは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flant / mcrouterリポジトリーで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公開されてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<pre><code class="plaintext hljs">configVersion: 1<font></font>
project: mcrouter<font></font>
deploy:<font></font>
 namespace: '[[ env ]]'<font></font>
 helmRelease: '[[ project ]]-[[ env ]]'<font></font>
---<font></font>
image: mcrouter<font></font>
from: ubuntu:16.04<font></font>
mount:<font></font>
- from: tmp_dir<font></font>
 to: /var/lib/apt/lists<font></font>
- from: build_dir<font></font>
 to: /var/cache/apt<font></font>
ansible:<font></font>
 beforeInstall:<font></font>
 - name: Install prerequisites<font></font>
   apt:<font></font>
     name: [ 'apt-transport-https', 'tzdata', 'locales' ]<font></font>
     update_cache: yes<font></font>
 - name: Add mcrouter APT key<font></font>
   apt_key:<font></font>
     url: https://facebook.github.io/mcrouter/debrepo/xenial/PUBLIC.KEY<font></font>
 - name: Add mcrouter Repo<font></font>
   apt_repository:<font></font>
     repo: deb https://facebook.github.io/mcrouter/debrepo/xenial xenial contrib<font></font>
     filename: mcrouter<font></font>
     update_cache: yes<font></font>
 - name: Set timezone<font></font>
   timezone:<font></font>
     name: "Europe/Moscow"<font></font>
 - name: Ensure a locale exists<font></font>
   locale_gen:<font></font>
     name: en_US.UTF-8<font></font>
     state: present<font></font>
 install:<font></font>
 - name: Install mcrouter<font></font>
   apt:<font></font>
     name: [ 'mcrouter' ]</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">werf.yaml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
...そして</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Helmチャート</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をスローし</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">興味深いことに-レプリカの数には構成ジェネレーターしかありません</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（誰かがより簡潔でエレガントなオプションを持っている場合-コメントで共有してください）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">{{- $count := (pluck .Values.global.env .Values.memcached.replicas | first | default .Values.memcached.replicas._default | int) -}}<font></font>
{{- $pools := dict -}}<font></font>
{{- $servers := list -}}<font></font>
{{- /*      : "0 1 2 0 1 2" */ -}}<font></font>
{{- range until 2 -}}<font></font>
 {{- range $i, $_ := until $count -}}<font></font>
   {{- $servers = append $servers (printf "mc-%d.mc:11211" $i) -}}<font></font>
 {{- end -}}<font></font>
{{- end -}}<font></font>
{{- /*   ,  N : "[0 1 2] [1 2 0] [2 0 1]" */ -}}<font></font>
{{- range $i, $_ := until $count -}}<font></font>
 {{- $pool := dict "servers" (slice $servers $i (add $i $count)) -}}<font></font>
 {{- $_ := set $pools (printf "MissFailoverRoute|Pool|pool%02d" $i) $pool -}}<font></font>
{{- end -}}<font></font>
---<font></font>
apiVersion: v1<font></font>
kind: ConfigMap<font></font>
metadata:<font></font>
 name: mcrouter<font></font>
data:<font></font>
 config.json: |<font></font>
   {<font></font>
     "pools": {{- $pools | toJson | replace "MissFailoverRoute|Pool|" "" -}},<font></font>
     "route": {<font></font>
       "type": "OperationSelectorRoute",<font></font>
       "default_policy": "AllMajorityRoute|Pool|pool00",<font></font>
       "operation_policies": {<font></font>
         "get": {<font></font>
           "type": "RandomRoute",<font></font>
           "children": {{- keys $pools | toJson }}<font></font>
         }<font></font>
       }<font></font>
     }<font></font>
   }</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10-mcrouter.yaml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
テスト環境に</font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ロール</font></a></i><font style="vertical-align: inherit;">アウトして確認します。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-comment"># php -a</span><font></font>
Interactive mode enabled<font></font>
<font></font>
php &gt; <span class="hljs-comment">#    </span>
php &gt; $m = <span class="hljs-keyword">new</span> Memcached();<font></font>
php &gt; $m-&gt;addServer(<span class="hljs-string">'mcrouter'</span>, <span class="hljs-number">11211</span>);<font></font>
php &gt; var_dump($m-&gt;set(<span class="hljs-string">'test'</span>, <span class="hljs-string">'value'</span>));
<span class="hljs-keyword">bool</span>(<span class="hljs-literal">true</span>)<font></font>
php &gt; var_dump($m-&gt;get(<span class="hljs-string">'test'</span>));
<span class="hljs-keyword">string</span>(<span class="hljs-number">5</span>) <span class="hljs-string">"value"</span>
php &gt; <span class="hljs-comment"># !   :</span>
php &gt; ini_set(<span class="hljs-string">'session.save_handler'</span>, <span class="hljs-string">'memcached'</span>);<font></font>
php &gt; ini_set(<span class="hljs-string">'session.save_path'</span>, <span class="hljs-string">'mcrouter:11211'</span>);<font></font>
php &gt; var_dump(session_start());<font></font>
PHP Warning:  Uncaught <span class="hljs-built_in">Error</span>: Failed to create session ID: memcached (path: mcrouter:<span class="hljs-number">11211</span>) in php shell code:<span class="hljs-number">1</span><font></font>
Stack trace:<font></font>
<span class="hljs-comment">#0 php shell code(1): session_start()</span>
<span class="hljs-comment">#1 {main}</span>
  thrown in php shell code on line <span class="hljs-number">1</span>
php &gt; <span class="hljs-comment">#  …   session_id:</span>
php &gt; session_id(<span class="hljs-string">"zzz"</span>);<font></font>
php &gt; var_dump(session_start());<font></font>
PHP Warning:  session_start(): Cannot send session cookie - headers already sent by (output started at php shell code:<span class="hljs-number">1</span>) in php shell code on line <span class="hljs-number">1</span>
PHP Warning:  session_start(): Failed to write session lock: UNKNOWN READ FAILURE in php shell code on line <span class="hljs-number">1</span>
PHP Warning:  session_start(): Failed to write session lock: UNKNOWN READ FAILURE in php shell code on line <span class="hljs-number">1</span>
PHP Warning:  session_start(): Failed to write session lock: UNKNOWN READ FAILURE in php shell code on line <span class="hljs-number">1</span>
PHP Warning:  session_start(): Failed to write session lock: UNKNOWN READ FAILURE in php shell code on line <span class="hljs-number">1</span>
PHP Warning:  session_start(): Failed to write session lock: UNKNOWN READ FAILURE in php shell code on line <span class="hljs-number">1</span>
PHP Warning:  session_start(): Failed to write session lock: UNKNOWN READ FAILURE in php shell code on line <span class="hljs-number">1</span>
PHP Warning:  session_start(): Unable to clear session lock record in php shell code on line <span class="hljs-number">1</span>
PHP Warning:  session_start(): Failed to read session data: memcached (path: mcrouter:<span class="hljs-number">11211</span>) in php shell code on line <span class="hljs-number">1</span>
<span class="hljs-keyword">bool</span>(<span class="hljs-literal">false</span>)<font></font>
php &gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テキスト内の検索ではエラーは返されませんでしたが、「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mcrouter php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」の</font><font style="vertical-align: inherit;">リクエストにより</font><font style="vertical-align: inherit;">、最古の閉じられていないプロジェクトの問題が最前線に現れました</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">-memcached</font></a><font style="vertical-align: inherit;">バイナリプロトコルの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サポート</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">欠如</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：memcachedのASCIIプロトコルはバイナリよりも低速であり、一貫したキーハッシュの通常の手段はバイナリプロトコルでのみ機能します。しかし、これは特定のケースで問題を引き起こしません。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
事は帽子の中にあります：それはASCIIプロトコルに切り替えるだけで残り、動作します....ただし、この場合、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">php.net</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ドキュメントで</font></a><font style="vertical-align: inherit;">回答を探すという習慣は</font><font style="vertical-align: inherit;">残酷な冗談でした。ここで正しい答えは見つかりません...もちろん、最後までスクロールしない限り、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ユーザーによる投稿」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セクションに</font><i><font style="vertical-align: inherit;">あり</font></i><font style="vertical-align: inherit;">ます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不当に気になる答え</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、正しいオプション名は</font></font><code>memcached.sess_binary_protocol</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">無効にする必要があります。その後、セッションが機能し始めます。</font><font style="vertical-align: inherit;">PHPでポッドにmcrouterのコンテナーを置くだけです！</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、インフラストラクチャの変更のみを使用して、問題を解決することができました。memcachedのフォールトトレランスの問題が解決され、キャッシュストレージの信頼性が向上しました。</font><font style="vertical-align: inherit;">これにより、アプリケーションの明らかな利点に加えて、プラットフォームで作業するときに操作の余地ができました。すべてのコンポーネントに予備がある場合、管理者の人生は大幅に簡素化されます。</font><font style="vertical-align: inherit;">はい、この方法には欠点もあります。「松葉杖」のように見えるかもしれませんが、お金を節約できる場合は、問題を埋めて新しい問題を引き起こさないようにしてください。なぜでしょうか。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのブログも読んでください：</font></font><br>
<br>
<ul>
<li> «  dapp» <i>(  symfony-demo)</i>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 1 (  )</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> 2 ( Docker-  Kubernetes   Helm)</a>;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   Kubernetes:  HTTP-   </a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja457494/index.html">「そして、もし私が数学を知らなければ、私は絶望的ですか？」-専門家は、データサイエンスの専門職に関するよくある質問に回答します</a></li>
<li><a href="../ja457496/index.html">「5つの違いを見つける。」スケーラブルで世代の違い-新しいテスト</a></li>
<li><a href="../ja457500/index.html">サービスステーションの自動操縦方法</a></li>
<li><a href="../ja457504/index.html">2019年にReact Data Gridを作成する理由</a></li>
<li><a href="../ja457508/index.html">子育てvs機械学習：若い母親を比較する</a></li>
<li><a href="../ja457512/index.html">PostgreSQLのバージョン間の論理レプリケーション</a></li>
<li><a href="../ja457514/index.html">ネバンゲル</a></li>
<li><a href="../ja457516/index.html">脅威モデルの作成</a></li>
<li><a href="../ja457518/index.html">ブロックチェーンのスケーラビリティトリレンマの解決策としてのプラズマキャッシュチェーン</a></li>
<li><a href="../ja457522/index.html">メーリングリストサービスを向上させるか、既成のソリューションを使用しますか？UniSenderで5年間に学んだこと</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>