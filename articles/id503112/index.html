<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎩 🎡 🚴🏽 Kisah Dukungan Awan DNS Tidak Ada dari Google Cloud 🍺 👩🏾‍🎨 🌑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dari Editor Blog Google: Pernahkah Anda bertanya-tanya bagaimana insinyur Google Cloud Technical Solutions (TSE) menangani panggilan dukungan teknis A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kisah Dukungan Awan DNS Tidak Ada dari Google Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/503112/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dari Editor Blog Google:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pernahkah Anda bertanya-tanya bagaimana insinyur Google Cloud Technical Solutions (TSE) menangani panggilan dukungan teknis Anda? Tanggung jawab Insinyur Dukungan Teknis TSE adalah untuk mendeteksi dan menyelesaikan sumber masalah yang diidentifikasi oleh pengguna. Beberapa masalah ini cukup sederhana, tetapi kadang-kadang Anda menemukan permintaan yang membutuhkan perhatian dari beberapa insinyur sekaligus. Dalam artikel ini, salah satu karyawan TSE akan memberi tahu kami tentang satu masalah yang sangat rumit dari praktiknya baru-baru ini - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kasus paket DNS yang hilang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dalam perjalanan cerita ini, kita akan melihat bagaimana para insinyur berhasil menyelesaikan situasi, dan hal-hal baru apa yang mereka pelajari selama menghilangkan kesalahan. Kami berharap kisah ini tidak hanya akan memberi tahu Anda tentang bug yang mengakar dalam, tetapi juga memberikan pemahaman tentang proses yang terjadi ketika mengirimkan permintaan untuk mendukung Google Cloud.</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/_6/_r/hh/_6_rhhetn5m7cydp0wpyweduawo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pemecahan masalah adalah ilmu dan seni. Semuanya dimulai dengan membangun hipotesis tentang penyebab perilaku non-standar sistem, setelah itu diuji kekuatannya. Namun, sebelum merumuskan hipotesis, kita harus secara jelas mengidentifikasi dan merumuskan masalah secara akurat. Jika pertanyaannya terdengar terlalu kabur maka Anda harus menganalisis semuanya dengan benar; ini adalah "seni" pemecahan masalah.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam konteks Google Cloud, proses semacam itu kadang-kadang rumit, karena Google Cloud berjuang untuk menjamin privasi penggunanya. </font><font style="vertical-align: inherit;">Karena itu, insinyur TSE tidak memiliki akses untuk mengedit sistem Anda, atau kemampuan untuk melihat konfigurasi seluas pengguna. </font><font style="vertical-align: inherit;">Karena itu, untuk menguji hipotesis kami, kami (insinyur) tidak dapat dengan cepat memodifikasi sistem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beberapa pengguna percaya bahwa kami akan memperbaiki segala sesuatu seolah-olah mekanisme dalam layanan mobil, dan cukup mengirimkan kepada kami id dari mesin virtual, sedangkan dalam kenyataannya proses berlangsung dalam format percakapan: mengumpulkan informasi, menghasilkan dan mengkonfirmasi (atau menyangkal) hipotesis, dan, pada akhirnya, menyelesaikan masalah dibangun berdasarkan komunikasi dengan klien.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalah sedang dipertimbangkan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hari ini kita punya cerita dengan akhir yang bagus. </font><font style="vertical-align: inherit;">Salah satu alasan keberhasilan penyelesaian kasus yang diusulkan adalah deskripsi masalah yang sangat terperinci dan akurat. </font><font style="vertical-align: inherit;">Di bawah ini Anda dapat melihat salinan tiket pertama (diedit, untuk menyembunyikan informasi rahasia): </font></font><br>
<img src="https://habrastorage.org/webt/_y/ug/qo/_yugqouzqk51y1z9gqx_nv_n-qa.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pesan ini memiliki banyak informasi berguna bagi kami:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VM yang ditentukan</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masalahnya ditunjukkan - DNS tidak berfungsi</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diindikasikan di mana masalah memanifestasikan dirinya - VM dan wadah</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Langkah-langkah yang diambil pengguna untuk mengidentifikasi masalah ditunjukkan.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Banding didaftarkan sebagai "P1: Dampak Penting - Layanan Tidak Dapat Digunakan dalam produksi", yang berarti pemantauan terus-menerus terhadap situasi 24/7 menurut skema "Ikuti Matahari" (tautan dapat dibaca secara lebih rinci tentang </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prioritas panggilan pengguna</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), dengan transmisi dari satu tim dukungan teknis ke yang lain di setiap pergeseran zona waktu. </font><font style="vertical-align: inherit;">Bahkan, pada saat masalahnya mencapai tim kami di Zurich, dia berhasil mengelilingi dunia. </font><font style="vertical-align: inherit;">Pada saat ini, pengguna mengambil langkah-langkah untuk mengurangi konsekuensi, tetapi takut akan pengulangan situasi pada produksi, karena alasan utama masih belum ditemukan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat tiket mencapai Zurich, kami sudah memiliki informasi berikut:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kandungan </font></font><code>/etc/hosts</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kandungan </font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan </font></font><code>iptables-save</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File </font></font><code>ngrep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pcap </font><font style="vertical-align: inherit;">dikompilasi oleh perintah</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan data ini, kami siap untuk memulai tahap "investigasi" dan pemecahan masalah.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Langkah pertama kami</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama-tama, kami memeriksa log dan status server metadata dan memastikan bahwa itu berfungsi dengan benar. </font><font style="vertical-align: inherit;">Server metadata merespons dengan alamat IP 169.254.169.254 dan, antara lain, bertanggung jawab untuk mengendalikan nama domain. </font><font style="vertical-align: inherit;">Kami juga memeriksa ulang bahwa firewall berfungsi dengan baik dengan VM dan tidak memblokir paket. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Itu adalah masalah aneh: tes nmap membantah hipotesis utama kami tentang hilangnya paket UDP, jadi kami secara mental menyimpulkan beberapa opsi dan cara untuk memeriksanya:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apakah paket hilang secara selektif? </font><font style="vertical-align: inherit;">=&gt; Periksa aturan iptables</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apakah </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MTU</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> terlalu kecil </font><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">=&gt; Periksa output</font></font><code>ip a show</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apakah masalahnya hanya mempengaruhi paket UDP atau TCP? </font><font style="vertical-align: inherit;">=&gt; Mengemudi</font></font><code>dig +tcp</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apakah paket penggalian yang dihasilkan dikembalikan? </font><font style="vertical-align: inherit;">=&gt; Mengemudi</font></font><code>tcpdump</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apakah libdns berfungsi dengan benar? </font><font style="vertical-align: inherit;">=&gt; Mengusir </font></font><code>strace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">untuk memverifikasi transfer paket di kedua arah</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di sini kami memutuskan untuk menelepon pengguna untuk memecahkan masalah secara langsung. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selama panggilan, kami berhasil memverifikasi beberapa hal:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setelah beberapa pemeriksaan, kami mengecualikan aturan iptables dari daftar alasan.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memeriksa antarmuka jaringan dan tabel perutean, dan memeriksa ulang MTU</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menemukan bahwa </font></font><code>dig +tcp google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(TCP) berfungsi sebagaimana mestinya, tetapi </font></font><code>dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UDP) tidak berfungsi</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setelah </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dijalankan saat berfungsi </font></font><code>dig</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, kami menemukan bahwa paket UDP sedang dikembalikan</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menjalankan </font></font><code>strace dig google.com</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan melihat bagaimana menggali panggilan dengan benar </font></font><code>sendmsg()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan </font></font><code>recvms()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, bagaimanapun, yang kedua terganggu oleh batas waktu</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sayangnya, perubahan akan segera berakhir dan kami terpaksa memindahkan masalah ke zona waktu berikutnya. Seruan tersebut, bagaimanapun, membangkitkan minat pada tim kami, dan seorang kolega menyarankan untuk membuat paket sumber DNS dengan modul Python yang tidak sopan.</font></font><br>
<pre><code class="bash hljs">from scapy.all import *<font></font>
<font></font>
answer = sr1(IP(dst=<span class="hljs-string">"169.254.169.254"</span>)/UDP(dport=53)/DNS(rd=1,qd=DNSQR(qname=<span class="hljs-string">"google.com"</span>)),verbose=0)
<span class="hljs-built_in">print</span> (<span class="hljs-string">"169.254.169.254"</span>, answer[DNS].summary())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fragmen ini membuat paket DNS dan mengirimkan permintaan ke server metadata. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengguna menjalankan kode, respons DNS dikembalikan, dan aplikasi menerimanya, yang menegaskan tidak adanya masalah di tingkat jaringan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Setelah "perjalanan keliling dunia" berikutnya, banding kembali ke tim kami, dan saya sepenuhnya menerjemahkannya ke diri saya sendiri, percaya bahwa itu akan lebih nyaman bagi pengguna jika banding berhenti berputar dari satu tempat ke tempat lain. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sementara itu, pengguna setuju untuk memberikan snapshot dari gambar sistem. Ini adalah berita yang sangat bagus: kemampuan untuk menguji sistem Anda sendiri secara signifikan mempercepat pemecahan masalah, karena Anda tidak perlu lagi meminta pengguna untuk menjalankan perintah, mengirim saya hasil dan menganalisisnya, saya bisa melakukan semuanya sendiri!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rekan kerja mulai sedikit iri padaku. </font><font style="vertical-align: inherit;">Saat makan siang, kami membahas banding, tetapi tidak ada yang tahu apa yang sedang terjadi. </font><font style="vertical-align: inherit;">Untungnya, pengguna itu sendiri telah mengambil langkah-langkah mitigasi dan tidak terburu-buru, jadi kami punya waktu untuk menyiapkan masalah. </font><font style="vertical-align: inherit;">Dan karena kita memiliki gambar, kita dapat melakukan tes apa pun yang menarik bagi kita. </font><font style="vertical-align: inherit;">Baik!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kembali satu langkah</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Salah satu pertanyaan paling populer dalam wawancara untuk seorang insinyur sistem adalah: "Apa yang terjadi ketika Anda melakukan ping </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.google.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ?" </font><font style="vertical-align: inherit;">Pertanyaannya adalah mewah, karena kandidat perlu dijelaskan dari shell ke ruang pengguna, ke inti sistem dan lebih jauh ke jaringan. </font><font style="vertical-align: inherit;">Saya tersenyum: kadang-kadang pertanyaan wawancara juga berguna dalam kehidupan nyata ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memutuskan untuk menerapkan pertanyaan eychar ini untuk masalah saat ini. </font><font style="vertical-align: inherit;">Secara kasar, ketika Anda mencoba menentukan nama DNS, hal berikut terjadi:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplikasi memanggil pustaka sistem, misalnya libdns</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns memeriksa konfigurasi sistem yang harus digunakan server DNS (dalam diagram adalah 169.254.169.254, server metadata)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libdns menggunakan panggilan sistem untuk membuat soket UDP (SOKET_DGRAM) dan mengirim paket UDP dengan permintaan DNS di kedua arah</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dengan menggunakan antarmuka sysctl, Anda dapat mengkonfigurasi tumpukan UDP tingkat kernel</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kernel berinteraksi dengan perangkat keras untuk mengirimkan paket melalui jaringan melalui antarmuka jaringan</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hypervisor menangkap dan meneruskan paket ke server metadata ketika kontak dengannya</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server metadata menentukan nama DNS dengan sihirnya dan mengembalikan jawabannya dengan cara yang sama</font></font></li>
</ol><br>
<img src="https://habrastorage.org/webt/iq/sx/nk/iqsxnkobn1stcxrcbnpiuaovl_w.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Biarkan saya mengingatkan Anda hipotesis mana yang sudah berhasil kita pertimbangkan: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hipotesis: Perpustakaan yang rusak</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tes 1: jalankan strace di sistem, periksa penggalian yang menyebabkan panggilan sistem yang benar</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: panggilan sistem yang benar dipanggil</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tes 2: melalui srapy untuk memeriksa apakah kita dapat menentukan nama yang melewati pustaka sistem</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: kita bisa</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tes 3: jalankan rpm –V pada paket libdns dan file library md5sum</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: kode perpustakaan benar-benar identik dengan kode di sistem operasi yang berfungsi</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uji 4: pasang gambar sistem root pengguna di VM tanpa perilaku ini, jalankan chroot, lihat apakah DNS berfungsi</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: DNS berfungsi dengan benar</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan berdasarkan tes:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> masalahnya bukan di perpustakaan </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hipotesis: Ada kesalahan dalam pengaturan DNS</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tes 1: periksa tcpdump dan lihat apakah paket DNS dikirim dan dikembalikan dengan benar setelah menjalankan penggalian</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: paket dikirimkan dengan benar</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tes 2: periksa kembali di server </font></font><code>/etc/nsswitch.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan</font></font><code>/etc/resolv.conf</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: semuanya benar</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan Berbasis Tes:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Masalahnya Tidak Ada dalam </font><b><font style="vertical-align: inherit;">Hipotesis</font></b><font style="vertical-align: inherit;"> Konfigurasi DNS </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Kernel Rusak</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uji: pasang kernel baru, verifikasi tandatangan, restart</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: perilaku serupa</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan berdasarkan tes:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kernel tidak rusak </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hipotesis: perilaku yang salah dari jaringan pengguna (atau antarmuka jaringan hypervisor)</font></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tes 1: periksa pengaturan firewall</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: firewall melewati paket DNS pada host dan GCP</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tes 2: mencegat lalu lintas dan melacak kebenaran transfer dan pengembalian permintaan DNS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: tcpdump mengakui penerimaan paket kembali oleh tuan rumah</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan Berbasis Tes:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Masalahnya </font><b><font style="vertical-align: inherit;">adalah</font></b><font style="vertical-align: inherit;"> Offline</font></font><br>
<br>
<b><font style="vertical-align: inherit;"></font></b><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tes 1: periksa log server metadata untuk mencari anomali</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: tidak ada anomali di log</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tes 2: memotong server metadata melalui </font></font><code>dig @8.8.8.8</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil: izin dilanggar bahkan tanpa menggunakan server metadata</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kesimpulan berbasis pengujian:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> masalahnya bukan pada server metadata </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intinya:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kami menguji semua subsistem kecuali </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pengaturan runtime!</font></font></b><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Menyelam ke pengaturan kernel runtime</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengkonfigurasi runtime kernel, Anda dapat menggunakan opsi baris perintah (grub) atau antarmuka sysctl. </font><font style="vertical-align: inherit;">Saya melihat ke dalam </font></font><code>/etc/sysctl.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dan berpikir saja, saya menemukan beberapa pengaturan khusus. </font><font style="vertical-align: inherit;">Merasa seperti telah meraih sesuatu, saya mengabaikan semua pengaturan non-jaringan atau non-tcp, yang tersisa dari pengaturan gunung </font></font><code>net.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Kemudian saya beralih ke tempat di mana VM memiliki izin host dan mulai menerapkan satu demi satu, pengaturan satu demi satu dengan VM yang rusak, sampai saya mencapai penjahat:</font></font><br>
<pre><code class="bash hljs">net.core.rmem_default = 2147483647</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini dia, konfigurasi pemecah DNS! Saya menemukan alat kejahatan. Tetapi mengapa ini terjadi? Saya masih membutuhkan motif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pengaturan ukuran dasar buffer paket DNS terjadi </font></font><code>net.core.rmem_default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Nilai tipikal bervariasi di suatu tempat dalam 200KiB, namun jika server Anda menerima banyak paket DNS, Anda dapat meningkatkan ukuran buffer. Jika buffer penuh saat paket baru tiba, misalnya, karena aplikasi tidak memprosesnya dengan cukup cepat, maka Anda akan mulai kehilangan paket. Klien kami meningkatkan ukuran buffer dengan benar karena ia takut kehilangan data, karena ia menggunakan aplikasi untuk mengumpulkan metrik melalui paket DNS. Nilai yang dia tetapkan adalah maksimum yang dimungkinkan: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1 (jika Anda menetapkan 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , kernel akan mengembalikan "INVALID ARGUMENT").</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tiba-tiba, saya menyadari mengapa nmap dan scapy bekerja dengan benar: mereka menggunakan soket mentah! Soket mentah berbeda dari soket biasa: soket ini berfungsi memotong iptables, dan tidak ada buffer! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi mengapa "buffer terlalu besar" menyebabkan masalah? Jelas tidak berfungsi sebagaimana dimaksud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada titik ini, saya dapat mereproduksi masalah pada banyak core dan beberapa distribusi. Masalahnya telah memanifestasikan dirinya dalam kernel 3.x dan sekarang juga memanifestasikan dirinya dalam kernel 5.x. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Memang saat startup</font></font><br>
<pre><code class="bash hljs">sysctl -w net.core.rmem_default=$((<span class="hljs-number">2</span>**<span class="hljs-number">31</span>-<span class="hljs-number">1</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DNS telah berhenti bekerja. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya mulai mencari nilai-nilai yang bekerja melalui algoritma pencarian biner sederhana dan menemukan bahwa sistem bekerja dengan 2147481343, namun angka ini adalah seperangkat angka yang tidak berarti bagi saya. Saya mengundang klien untuk mencoba nomor ini, dan dia menjawab bahwa sistem bekerja dengan google.com, tetapi masih memberikan kesalahan dengan domain lain, jadi saya melanjutkan penyelidikan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya memasang </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dropwatch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , alat yang seharusnya saya gunakan sebelumnya: ini menunjukkan di mana tepatnya paket masuk ke kernel. Fungsi itu bersalah </font></font><code>udp_queue_rcv_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Saya mengunduh sumber kernel dan menambahkan beberapa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fungsi</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>printk</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk melacak di mana paket mendapatkan secara khusus. Saya segera menemukan kondisi yang tepat</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, dan untuk sementara waktu hanya menatapnya, karena pada saat itulah semuanya akhirnya datang bersama dalam satu gambar: 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -1, angka yang tidak berarti, domain yang tidak digunakan ... Itu adalah sepotong kode di </font></font><code>__udp_enqueue_schedule_skb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-keyword">if</span> (rmem &gt; (size + sk-&gt;sk_rcvbuf))<font></font>
		goto uncharge_drop;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
catatan:</font></font><br>
<ul>
<li><code>rmem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> memiliki tipe int</font></font></li>
<li><code>size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah tipe u16 (unsigned sixteen bit int) dan menyimpan ukuran paket</font></font></li>
<li><code>sk-&gt;sk_rcybuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah tipe int dan menyimpan ukuran buffer, yang menurut definisi sama dengan nilai dalam </font></font><code>net.core.rmem_default</code></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat </font></font><code>sk_rcvbuf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mendekati 2 </font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">31</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , menjumlahkan ukuran paket dapat menyebabkan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">overflow integer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Dan karena itu adalah int, nilainya menjadi negatif, sehingga kondisinya menjadi benar ketika harus salah (lebih lanjut tentang ini dapat ditemukan dengan </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">referensi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kesalahan diperbaiki dengan cara sepele: dengan casting ke </font></font><code>unsigned int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Saya menerapkan tambalan dan memulai kembali sistem, setelah itu DNS mulai bekerja kembali.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rasa kemenangan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya meneruskan temuan saya ke klien dan mengirim </font><font style="vertical-align: inherit;">patch kernel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LKML</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Saya puas: setiap bagian puzzle menyatu menjadi satu, saya dapat menjelaskan dengan tepat mengapa kami mengamati apa yang kami amati, dan yang paling penting, kami dapat menemukan solusi untuk masalah tersebut dengan bekerja bersama! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Patut diakui bahwa kasus ini ternyata jarang, dan untungnya, panggilan kompleks seperti itu jarang diterima dari pengguna dari kami.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><img src="https://habrastorage.org/webt/0i/q1/3c/0iq13ceb1rqhy6ymre4-xvedsfu.jpeg"><br>
</a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id503096/index.html">Mengapa manajer ingin pekerja mendaur ulang?</a></li>
<li><a href="../id503100/index.html">Kepala internet</a></li>
<li><a href="../id503106/index.html">Intisari penemuan non-standar: silsilah tanaman predator, jamur di Twitter dan gas tertawa dari guano</a></li>
<li><a href="../id503108/index.html">Delapan warna pelangi: tentang warna dalam hal matematika</a></li>
<li><a href="../id503110/index.html">Epidemi Digital: CoronaVirus vs CoViper</a></li>
<li><a href="../id503118/index.html">David Yang - tentang non-invasif, krisis dan bumi hangus</a></li>
<li><a href="../id503126/index.html">Likbez tentang VPS: cara mengkonfigurasi remote desktop jika Anda adalah pengguna Win</a></li>
<li><a href="../id503128/index.html">Bagaimana cara menanamkan ColorPicker di JavaScript Gantt untuk mengubah warna tugas</a></li>
<li><a href="../id503132/index.html">Apache Parket Berkecepatan Tinggi dalam Python dengan Apache Arrow</a></li>
<li><a href="../id503134/index.html">Manajemen = Tim + Produk. Kami mengungkapkan formula tahun ini: yang paling berguna tentang orang-orang dan untuk orang-orang di DUMP 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>