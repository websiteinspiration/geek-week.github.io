<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔓 🤑 👩‍🍳 Pourquoi avez-vous besoin d'une réplication semi-synchrone? 🙌🏽 📡 ⏮️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous. En contact avec Vladislav Rodin. J'enseigne actuellement des cours sur l'architecture logicielle et l'architecture logicielle à haute ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pourquoi avez-vous besoin d'une réplication semi-synchrone?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/491106/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour à tous. </font><font style="vertical-align: inherit;">En contact avec Vladislav Rodin. </font><font style="vertical-align: inherit;">J'enseigne actuellement des cours sur l'architecture logicielle et l'architecture logicielle à haute charge sur le portail OTUS. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En prévision du début d'un nouveau volet du cours </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">«Architecte de fortes charges»,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> j'ai décidé d'écrire un petit matériel d'auteur, que je souhaite partager avec vous.</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/pi/ad/dp/piaddproyjjd7sel38p94k6p_qe.png"><br>
<hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En raison du fait que seules 400 à 700 opérations par seconde peuvent être effectuées sur le disque dur (ce qui est incomparable avec les rps typiques qui tombent sur un système lourdement chargé), la base de données de disques classique est un col étroit d'architecture. </font><font style="vertical-align: inherit;">Par conséquent, une attention particulière doit être accordée aux modèles de mise à l'échelle de ce référentiel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À l'heure actuelle, il existe 2 modèles de mise à l'échelle de base: la réplication et le partitionnement. </font><font style="vertical-align: inherit;">Le partage permet de mettre à l'échelle l'opération d'écriture et, par conséquent, de réduire les rps d'enregistrement pour un serveur de votre cluster. </font><font style="vertical-align: inherit;">La réplication vous permet de faire de même, mais avec des opérations de lecture. </font><font style="vertical-align: inherit;">Cet article est consacré à ce modèle même.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La réplication</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous regardez la réplication à un niveau très élevé, c'est une chose simple: vous aviez un serveur, les données s'y trouvaient, puis ce serveur s'est arrêté de faire face à la charge de lecture de ces données. </font><font style="vertical-align: inherit;">Vous ajoutez quelques serveurs supplémentaires, synchronisez les données sur tous les serveurs et l'utilisateur peut lire à partir de n'importe quel serveur de votre cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgré l'apparente simplicité, il existe plusieurs options pour classer les différentes implémentations de ce schéma:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par rôles dans le cluster (maître-maître ou maître-esclave)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par objets transférés (basés sur des lignes, basés sur des instructions ou mixtes)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selon le mécanisme de synchronisation des nœuds</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, nous traiterons du 3ème point. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment la transaction est-elle engagée</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce sujet ne se rapporte pas directement à la réplication, un article séparé peut y être écrit, cependant, car sans une meilleure compréhension du mécanisme de validation des transactions, une lecture supplémentaire est inutile, permettez-moi de vous rappeler les choses les plus élémentaires. </font><font style="vertical-align: inherit;">Une transaction est engagée en 3 étapes:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écriture d'une transaction dans le journal de la base de données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application d'une transaction dans un moteur de base de données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retourner la confirmation au client de la bonne application de la transaction.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des nuances peuvent survenir dans diverses bases de données de cet algorithme: par exemple, dans le moteur InnoDB de la base de données MySQL, il y a 2 journaux: un pour la réplication (journal binaire) et l'autre pour maintenir ACID (annuler / rétablir le journal), tandis que dans PostgreSQL, il y a un journal exécutant les deux fonctions (écrire le journal d'avance = WAL). </font><font style="vertical-align: inherit;">Mais au-dessus, c'est précisément le concept général qui permet d'ignorer de telles nuances.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réplication synchrone (sync)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutons la logique de réplication des modifications reçues à l'algorithme de validation de transaction:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écriture d'une transaction dans le journal de la base de données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application d'une transaction dans un moteur de base de données.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de données à toutes les répliques.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recevez une confirmation de toutes les répliques sur la transaction.</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retourner la confirmation au client de la bonne application de la transaction.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec cette approche, nous obtenons un certain nombre d'inconvénients: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le client attend que les modifications soient appliquées à toutes les répliques.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">à mesure que le nombre de nœuds dans le cluster augmente, nous réduisons la probabilité que l'opération d'écriture réussisse.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tout est plus ou moins clair avec le 1er paragraphe, alors les raisons du 2e paragraphe doivent être clarifiées. </font><font style="vertical-align: inherit;">Si, pendant la réplication synchrone, nous n'obtenons pas de réponse d'au moins un nœud, nous annulons la transaction. </font><font style="vertical-align: inherit;">Ainsi, en augmentant le nombre de nœuds dans le cluster, vous augmentez la probabilité que l'opération d'écriture échoue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pouvons-nous attendre la confirmation uniquement à partir d'une certaine fraction de nœuds, par exemple à partir de 51% (quorum)? </font><font style="vertical-align: inherit;">Oui, nous le pouvons, mais dans la version classique, une confirmation est requise de tous les nœuds, car c'est ainsi que nous pouvons assurer la cohérence complète des données dans le cluster, ce qui est un avantage incontestable de ce type de réplication.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réplication asynchrone</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifions l'algorithme précédent. </font><font style="vertical-align: inherit;">Nous enverrons les données aux répliques «un peu plus tard», et «un peu plus tard» les modifications seront appliquées sur les répliques:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écriture d'une transaction dans le journal de la base de données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application d'une transaction dans un moteur de base de données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retourner la confirmation au client de la bonne application de la transaction.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de données à des répliques et application de modifications à celles-ci.</font></font></b></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette approche conduit au fait que le cluster est rapide, car nous ne gardons pas le client en attente que les données atteignent les répliques et soient même communiquées. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais la condition de déposer des données dans des répliques «un peu plus tard» peut entraîner la perte de la transaction et la perte de la transaction confirmée à l'utilisateur, car si les données n'ont pas eu le temps de se répliquer, une confirmation a été envoyée au client concernant le succès de l'opération et le nœud vers lequel les modifications sont arrivées s'est envolé. Disque dur, nous perdons la transaction, ce qui peut entraîner des conséquences très désagréables.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réplication semi-sync</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enfin, nous sommes arrivés à la réplication semi-synchrone. </font><font style="vertical-align: inherit;">Ce type de réplication est peu connu et peu répandu, mais il présente un intérêt considérable, car il peut combiner les avantages de la réplication synchrone et asynchrone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayons de combiner les 2 approches précédentes. </font><font style="vertical-align: inherit;">Nous ne garderons pas le client longtemps, mais nous exigeons que les données soient répliquées:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écriture d'une transaction dans le journal de la base de données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application d'une transaction dans un moteur de base de données.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de données à des répliques.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réception d'une confirmation de la réplique concernant la réception des modifications (elles seront appliquées «un peu plus tard»).</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retourner la confirmation au client de la bonne application de la transaction.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Veuillez noter qu'avec cet algorithme, la perte de transaction se produit uniquement en cas de chute du nœud acceptant les modifications et des nœuds de réplique. </font><font style="vertical-align: inherit;">La probabilité d'un tel dysfonctionnement est considérée comme faible et ces risques sont acceptés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais avec cette approche, le risque de lectures fantômes est possible. </font><font style="vertical-align: inherit;">Imaginez le scénario suivant: à l'étape 4, nous n'avons reçu de confirmation d'aucune réplique. </font><font style="vertical-align: inherit;">Nous devons annuler cette transaction et ne pas retourner la confirmation au client. </font><font style="vertical-align: inherit;">Étant donné que les données ont été appliquées à l'étape 2, il existe un intervalle de temps entre la fin de l'étape 2 et l'annulation de transaction, pendant lequel les transactions parallèles peuvent voir les modifications qui ne devraient pas figurer dans la base de données.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réplication semi-synchrone sans perte</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous réfléchissez un peu, vous ne pouvez modifier les étapes de l'algorithme que par endroits pour résoudre le problème des lectures fantômes dans ce scénario:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écriture d'une transaction dans le journal de la base de données.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Envoi de données de réplique.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réception d'une confirmation de la réplique concernant la réception des modifications (elles seront appliquées «un peu plus tard»).</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Application d'une transaction dans un moteur de base de données.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Retourner la confirmation au client de la bonne application de la transaction.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous n'engageons les modifications que si elles sont répliquées. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme toujours, il n'y a pas de solutions parfaites, il existe un ensemble de solutions, chacune ayant ses propres avantages et inconvénients et convenant à la résolution de différentes classes de problèmes. </font><font style="vertical-align: inherit;">Cela est également vrai pour le choix d'un mécanisme de synchronisation des données d'une base de données répliquée. </font><font style="vertical-align: inherit;">L'ensemble des avantages de la réplication semi-synchrone est suffisamment solide et intéressant pour être considéré comme méritant l'attention, malgré sa faible prévalence. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est tout. </font><font style="vertical-align: inherit;">Rendez-vous sur le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parcours</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr491092/index.html">Comment Crash Bandicoot a piraté Playstation</a></li>
<li><a href="../fr491094/index.html">Installation de Firebird 3 sur les versions Linux modernes: CentOS8 et Ubuntu 19</a></li>
<li><a href="../fr491100/index.html">Sur Wanhao 5S, ils ont imprimé une poupée avec une taille d'une personne</a></li>
<li><a href="../fr491102/index.html">Comment développer un service en présence de concurrents coriaces</a></li>
<li><a href="../fr491104/index.html">Comment j'ai trouvé un problème matériel sur ma tablette Lenovo MiiX 2 10</a></li>
<li><a href="../fr491108/index.html">Organisation des déploiements dans de nombreux environnements K8 à l'aide de Helmfile</a></li>
<li><a href="../fr491110/index.html">Convertir rtf en xml en C #</a></li>
<li><a href="../fr491112/index.html">Le chemin vers l'innocence du réseau - Cisco DNA</a></li>
<li><a href="../fr491114/index.html">Relocalisation intelligente ou comment choisir une entreprise pour travailler et ne pas le regretter</a></li>
<li><a href="../fr491116/index.html">Normes d'identification modernes: OAuth 2.0, OpenID Connect, WebAuthn</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>