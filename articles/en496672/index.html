<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç≤ ü¶ã ‚èÆÔ∏è Introduction to exploiting and reversing using IDA FREE and other free tools. Chapter 2 ü§ôüèª ü§∂ üíáüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part, we installed several tools that will be useful for us to take this course. Their feature is that they are all free. We will not use...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Introduction to exploiting and reversing using IDA FREE and other free tools. Chapter 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496672/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the first part, we installed several tools that will be useful for us to take this course. </font><font style="vertical-align: inherit;">Their feature is that they are all free. </font><font style="vertical-align: inherit;">We will not use any paid tool, and of those that have a paid version, such as IDA or PYCHARM, we will use the FREE or COMMUNITY version.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at some concepts before we get started with the exercises. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is a BAG? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BAG is the result of a failure or lack in the process of creating computer programs (software) or a computer. The specified failure can occur at any stage of the software life cycle, although the most obvious failure occurs at the development and programming stage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As I always say, a programmer can make mistakes, and these errors can cause program crashes or bugs. So far, I have not said anything new. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The question is to know the difference between BAG and VULNERABILITY, so let's see what VULNERABILITY is. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is VULNERABILITY?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VULNERABILITY is a certain type of bug in a program that allows using it to violate the security of a computer system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, vulnerabilities allow you to perform actions for which the program was not intended, and abuse them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In other words, vulnerability is a certain type of bug, a subset between them. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ve/xv/dz/vexvdzddt1ik8nomu0jbz2yxjyi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, there are many types of vulnerabilities. </font><font style="vertical-align: inherit;">We are going to focus on the study and exploitation of vulnerabilities in WINDOWS.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is EXPLOIT?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EXPLOIT is a computer program that tries to exploit some vulnerability of another program. The ultimate goal of an exploit can be malicious, for example, as destroying or shutting down an attacked system, although it is usually a violation of security measures in order to gain access to information in an unauthorized way and use it in their own interests or as a source of other attacks on third parties. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abuse of the vulnerability can lead to the failure of the application or the system itself, the execution of native code on local or remote machines. Its operation and complexity depend on the vulnerability itself, the environment and the measures that the goal has during the operation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first type of vulnerabilities we will examine will be buffer overflows. </font><font style="vertical-align: inherit;">We will start with the simplest examples, and then we will gradually increase the complexity. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first, the system‚Äôs security features will not be activated, but gradually we will activate them to find out how we can deal with them and in what situations.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a BUFFER?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BUFFER is a memory space of a certain size reserved for data storage and management. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A basic example is a 20 liter jar, which I have for storing contents. </font><font style="vertical-align: inherit;">It can be less than or equal to 20 liters, which is the maximum size. </font><font style="vertical-align: inherit;">If you want to store more in one tank, you must find a way to increase the size of the buffer, otherwise when you try to save, for example, 40 liters in a 20-liter can, it will overflow.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a BUFFER OVERFILL?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BUFFER OVERFLOW occurs when a computer program exceeds the amount of memory reserved for it by writing data to a contiguous memory block. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.welivesecurity.com/la-es/tag/buffer-overflow-la-es</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In truth, a buffer overflow occurs in an application when it does not have the necessary security checks in its program code, such as measuring the amount of data which will be copied to the buffer and which do not exceed the buffer size. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most common types of buffer overflows are stack buffer overflows and heap buffer overflows.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we see the definition of buffer overflow, and in our previous example, if I try to pour 40 liters into a 20 liter tank, it will overflow, as we understand it. </font><font style="vertical-align: inherit;">This is an overflow that causes a buffer overflow, i.e. </font><font style="vertical-align: inherit;">overflow of my tank when its maximum capacity is exceeded. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now explain the difference between the stack and the heap.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a STACK?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STACK is used to store local function variables that are needed only as long as the function is executed. </font><font style="vertical-align: inherit;">In most programming languages, it is important that we know at compile time how large a variable is if we want to keep it on the stack.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is a LOT?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heap is used to reserve dynamic memory, the useful life of which is not known in advance, but it is expected that it will last some time. If we do not know its size or it is determined at runtime, the size must be calculated and reserved on the heap. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The heap is also used for objects that vary in size because we do not know at compile time how long they will be used. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have been working in our company for more than 13 years as the author of exploits, and the first thing we do with all the hired people even did to me when I joined was to try to unravel the stacks and heaps of the famous GERARDO RICHART. He is one of the founders of CORE SECURITY and an exploit analysis guru.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will start slowly with the simplest stacks. Of course, as I said, they are compiled at the moment with minimal protection and are 32-bit in order to facilitate operation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at the source code for the STACK1 task. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://drive.google.com/open?id=16btJAetpa1V5yHDZE2bnnFWTQNpsUR4H</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We see a folder with exercises, and inside is the source code STACK1 called STACK1_VS_2017.CPP.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#define _CRT_SECURE_NO_WARNINGS</span>
<span class="hljs-comment">#define _CRT_SECURE_NO_DEPRECATE</span><font></font>
<font></font>
<span class="hljs-comment">#include &lt;stdlib.h&gt;</span>
<span class="hljs-comment">#include  &lt;stdio.h&gt; </span>
<span class="hljs-comment">#include "Windows.h"</span><font></font>
<font></font>
<font></font>
int main(int argc, char **argv) <font></font>
{<font></font>
<font></font>
<font></font>
	MessageBoxA((HWND)<span class="hljs-number">-0</span>, (LPCSTR) <span class="hljs-string">"Imprimir You win..\n"</span>, (LPCSTR)<span class="hljs-string">"Vamosss"</span>, (UINT)<span class="hljs-number">0</span>);<font></font>
<font></font>
	int cookie;<font></font>
	char buf[<span class="hljs-number">80</span>];<font></font>
<font></font>
	printf(<span class="hljs-string">"buf: %08x cookie: %08x\n"</span>, &amp;buf, &amp;cookie);<font></font>
	gets(buf);<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cookie == <span class="hljs-number">0x41424344</span>) printf(<span class="hljs-string">"you win!\n"</span>);<font></font>
<font></font>
}<font></font>
<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will try to understand this code and see where the buffer overflow may occur, and whether it will be a buffer overflow on the stack or on the heap. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The MessageBoxA function call was added to the STACK1 source code to show us a small message prompting us to solve it. This is just an addition that does not affect anything. This is a standard call to the specified WINDOWS function, which we will not analyze here. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Who needs information on this function, you can get it here.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We know that inside the function, if there are local variables, you must reserve a place for them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So we are left with this source code created by GERARDO RICHART.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> 
</span>{<font></font>
<font></font>
	<span class="hljs-keyword">int</span> cookie;
	<span class="hljs-keyword">char</span> buf[<span class="hljs-number">80</span>];<font></font>
<font></font>
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"buf: %08x cookie: %08x\n"</span>, &amp;buf, &amp;cookie);<font></font>
	gets(buf);<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cookie == <span class="hljs-number">0x41424344</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">"you win!\n"</span>);<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see in red the first part of the program, where reserved space for local variables. In this case, there are two local variables, COOKIE and BUF. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can see the data types in the table</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Other types of variables are also located there. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code will be compiled into 32 bits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the COOKIE variable will be of type INT, so 4 bytes of memory will be reserved for this variable. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1x/xh/qr/1xxhqrcrft6amjldaqun6yvffro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of the BUF variable, we see that it is an array or a string of characters (character size = 1 byte). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5j/0f/py/5j0fpyugggmbrkvzktqjibwstuk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Those. it will be an array of 80 characters, i.e. its length will be 80x1 = 80 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anyone who does not know what an array can read about it here: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.programiz.com/c-programming/c-arrays</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, an array can store many values ‚Äã‚Äãof the same data type. </font><font style="vertical-align: inherit;">You just have to tell him what type of data will be and how much there will be. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e8/do/ab/e8doabufhyuyqjdwz95qlikvcim.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the first example, this is an array of integers, i.e. </font><font style="vertical-align: inherit;">it will be 100 bytes, and since each integer takes 4 bytes, the length of the array will be 100 x 4 = 400 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the second example, FLOAT takes 4 bytes, so it will be an array of 5 FLOAT, so its length will be 5 x 4 = 20 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we analyze the array at a low level, we will see that it is a reserved memory space or buffer. </font><font style="vertical-align: inherit;">This is not the only way to reserve memory space. </font><font style="vertical-align: inherit;">There are other types of variable data that also require reserve space in memory that will be buffers for storing their contents.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Returning to our exercise: </font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> buf[<span class="hljs-number">80</span>];</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is an array of characters 80 x 1 = 80 bytes long, i.e. it looks like our 20 liter jar. If we try to store more than 80 bytes, the bank will overflow. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's see where the BUF buffer is used. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kp/ac/nt/kpacnt_0dfwci5pzs4ubozc4tou.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the buffer is used in two places marked with red arrows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first instruction has a PRINTF function, which is used to display a message in the console, which will be a quoted string.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-string">"buf: %08x cookie: %08x\n"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But the PRINTF function not only prints the string in quotation marks, but it also prints the string in the specified format. The percentages inside tell us that an output line will be created. We see that the string is only the first argument to the function. The output format and other arguments may be several (there will be one for each argument% in the format). In our case, there are two of them. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hq/j5/ol/hqj5ollvpzgitrc29p3ywimufvm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, we have two% X formats, so if I refer to the PRINTF format table: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vn/bt/b7/vnbtb7zfdmzy19wtmyd6mzxkit4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the function will take these integers (INT) and insert them into the output line with the base of the number system 16, i.e. in hexadecimal format. 08 indicates that if the number contains less than 8 digits, the function will fill it with spaces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The output for ‚Äúbuf:% 31x‚Äù, &amp; buf will be like this</font></font><br>
<br>
<pre><code class="cpp hljs">buf:             <span class="hljs-number">19F</span>ED4 
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that in this example are filled with spaces before the number. There are several modifiers to show the output. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All possible cases are listed here: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.cplusplus.com/reference/cstdio/printf/</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Our case is this: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tf/pa/g_/tfpag_nbzmhvrzf1gzsqczecfw4.png"><br>
<br>
<img src="https://habrastorage.org/webt/ja/yq/wo/jayqwocmor7ctp0y1tnykptorle.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the result is not truncated, it is filled with spaces only if the length of the argument to insert is less than the value before X. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we know that the function prints two hexadecimal numbers, which are obtained from two arguments.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">printf</span>(<span class="hljs-string">"buf: %08x cookie: %08x\n"</span>, &amp;buf, &amp;cookie);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We know that a variable has a memory address and a value that can be stored. </font><font style="vertical-align: inherit;">It looks like our 20 liter jar. </font><font style="vertical-align: inherit;">It has its content or meaning, i.e. </font><font style="vertical-align: inherit;">liters stored inside, but also if I have a garage full of similar cans I need some way to determine where the can I want is among all the ones that I have. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The &amp; symbol indicates this. </font><font style="vertical-align: inherit;">It returns the address or location of the jar, not its contents or value.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Definition of AMPERSAND</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AMPERSAND is used to indicate the memory address of the variable in which data will be stored. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, if I run the executable file in the console, I will see, for example, that when it executes the PRINTF function, it will print: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ry/bs/g6/rybsg6crsldpimnhgfopd2-oddq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The addresses may change on your PC, but since the lower address of both addresses matches the BUF address, we see that they are located in this way: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xf/-j/yc/xf-jycqtfpqcdyu_5tfsuv19uae.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The BUF address is less than the COOKIE address, so it will increase. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And what do these variable addresses tell us? (In my case, &amp; BUF = 0x19FED4 and &amp; COOKIE = 0x19FF24) </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6s/xy/8a/6sxy8am2y6d2skgyu7pmsz-wd7i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Both are in hexadecimal format. Remember this was the% X format? So I put 0x ahead to distinguish decimal numbers that we will represent without any additions.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If I do a subtraction in the PYTHON console or in PYCHARM: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rd/-u/hw/rd-uhwhszxlontfjic1tl7cqmvo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We get a result of 80 bytes, since the COOKIE variable supposedly starts exactly where the BUF buffer ends, so the difference gives us the size of the buffer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Often, when we make this type of variable based on source code, it may happen that the compiler gives us a larger size than the one that is reserved in the source code. The compiler guarantees that it will reserve at least 80 bytes, i.e. he can reserve more, not less. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact is that we already know something about the code, the size of the variables and their location due to the fact that it has the PRINTF function.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now let's look at another place where the BUF buffer is used, because now the program only prints its address, but does not use it to store data in it.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> 
</span>{<font></font>
<font></font>
	<span class="hljs-keyword">int</span> cookie;
	<span class="hljs-keyword">char</span> buf[<span class="hljs-number">80</span>];<font></font>
<font></font>
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"buf: %08x cookie: %08x\n"</span>, &amp;buf, &amp;cookie);<font></font>
	gets(buf);<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cookie == <span class="hljs-number">0x41424344</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">"you win!\n"</span>);<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, on the red line, GET is a function for entering data from the keyboard. Data will be entered until I press Enter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The program cannot limit the amount of data entered by the user, and there is also no way to verify this data. Everything that is entered before pressing the ENTER key is copied to the BUF buffer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the problem. We said that BUF can only store 80 bytes maximum, so if we enter more, we will create a buffer overflow, and here are all the conditions for this, because if the user writes more than 80 bytes, then our tank will overflow and the liquid will drip down . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pr/tv/0e/prtv0eh97rud78cpbrvpqmn7vd4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact is that under the BUF is the COOKIE variable, so the overflow will overwrite and fill it with a value that you can control.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, if someone who prints writes 80 * A and 4 * B, 80 * A will fill in BUF, and 4 * B will fill in COOKIE, and as we know, when someone prints a character in the console, the value will remain low. ASCII. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bx/ff/lh/bxfflhk6qfthec5v64o3kr90ey8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the cookie will be filled with four letters B, which are equivalent to a value of 0x42, we can guarantee that the cookie value will be 0x42424242, i.e. on my computer, the cookie address 0x19FF24 will have 0x42424242 as the content. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x19FF24 =&gt; 42424242 </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mn/zl/zb/mnzlzbrka2otg0rszogmqu3xwmo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact is that we have already seen how to overflow and control the COOKIE value.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> 
</span>{<font></font>
<font></font>
	<span class="hljs-keyword">int</span> cookie;
	<span class="hljs-keyword">char</span> buf[<span class="hljs-number">80</span>];<font></font>
<font></font>
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"buf: %08x cookie: %08x\n"</span>, &amp;buf, &amp;cookie);<font></font>
	gets(buf);<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cookie == <span class="hljs-number">0x41424344</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">"you win!\n"</span>);<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You must print ‚Äúyou win‚Äù to complete the exercise. For this, the COOKIE must be equal to the value 0x41424344, and if there were no overflow, this would be impossible, since the COOKIE value has never changed from the very beginning of the program. We won‚Äôt be able to print ‚Äúyou win‚Äù, and for this we use a buffer overflow, which says that this can cause the program to perform some action other than what was programmed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, you can never type ‚Äúyou win‚Äù, only overflow will allow you to do this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AAAAAAAA </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In other words, instead of passing, for example, 80 * A and 4 * B, to print ‚Äúyou win‚Äù, you must pass 80 * A and then the letters DCBA, as this will cause the values ‚Äã‚Äãto be stored in the COOKIE ASCII. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
44434241</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.arumeinformatica.es/blog/los-formatos-big-endian-y-little-endian/</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The format in which data is stored is LITTLE ENDIAN. In other words, the data in memory is stored in reverse order, to put it simply. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/91/jh/wo/91jhwoo4rj058xjbp9jdp089vw4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And if the sequence 0x41424344 is saved, the system will save it in memory as: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
44 43 42 41 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For this reason, when copying to memory, copying will occur as we type, so we must write the value in the reverse order so that when reading from memory it was in the right shape. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can run the executable in the console. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wn/sn/yo/wnsnyolnlocppvkl573pmu-luva.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the cursor will flash, as the GET function asks me to enter the input. Carefully type 80 characters A and then DCBA.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the PYTHON or PYCHARM console, I can print the line, copy it without quotes and paste it into the console so as not to print it like crazy, and then press the ENTER key to enter it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/um/9n/bh/um9nbhsmtv_w2cko2d1lwvelqwq.png"><br>
<br>
<img src="https://habrastorage.org/webt/rm/nr/be/rmnrbe4pvbxovetmml_n85dwc4q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that we got ‚Äúyou win‚Äù. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can see this in the debugger. For this we will use X64DBG. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/el/2x/db/el2xdbqsgxwi5rh22txd_hqnnx0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I choose the 32 bit version. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ly/ep/e2/lyepe2znpbsedu8edqur13iocau.png"><br>
<br>
<img src="https://habrastorage.org/webt/ux/4u/pt/ux4upt903tftde_hfpteze3irho.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we stop at the NTDLL.DLL library, we press RUN again with F9. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the debugger stops at the first instruction of the STACK1 module, which is called ENTRY POINT or the first instruction executed by the module.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/va/y-/qf/vay-qf4tqfkxmlik0892lukku7g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviously this is not like our source code. You must understand that the compiler adds a lot of code to make the executable work and run correctly. We will try to find our main function. We can orient ourselves by looking at the lines of the program. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pg/hv/c9/pghvc9kf8f8xjzdpk4yigw5w5vy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We selected only search in the current region. We know that the lines will be in the same section. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/a3/fj/qc/a3fjqcvl8iqrupyr4oz2trl0viw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we see that there are program lines and others that the compiler added. We double click on one of our lines. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ua/fc/b6/uafcb61zxgu6jbg2yraawefum50.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you can see a lot more. We see a call to the MessageBoxA, PRINTF, GETS function and a comparison with the value 0x41424344.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, we are adding a plugin for decompiling SNOWMAN. We can try to see how it decompiles the code, i.e. how he is trying to get the source code or something as similar as possible from the compiled file. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r0/hs/-w/r0hs-w2cpoquwejdry_pogmxlpu.png"><br>
<br>
<img src="https://habrastorage.org/webt/8h/ib/j_/8hibj_rzmyn_5gwvlg-bqhg4upk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that this is not perfect, but it is better than what it was. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I am going to put BP at the beginning of the function and press F9 until the debugger stops. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9j/wz/em/9jwzemcr76ij1vfdvy9pcdx9gaa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For those who do not know what a function argument is. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rt/su/31/rtsu317d7gmqo_u7parcbcxfagg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, the main function has arguments, but they are not used inside the function.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> 
</span>{<font></font>
<font></font>
	<span class="hljs-keyword">int</span> cookie;
	<span class="hljs-keyword">char</span> buf[<span class="hljs-number">80</span>];<font></font>
<font></font>
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"buf: %08x cookie: %08x\n"</span>, &amp;buf, &amp;cookie);<font></font>
	gets(buf);<font></font>
<font></font>
	<span class="hljs-keyword">if</span> (cookie == <span class="hljs-number">0x41424344</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">"you win!\n"</span>);<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we see that there are two arguments, and they are passed through the stack when the executable is compiled into 32 bits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just before the function call, the arguments will be stored on the stack. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we stop at the beginning of the function, the first value on the stack will be RETURN ADDRESS, i.e. where the function will return after the function completes, and below this value will be the arguments of this function. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If I right-click on RETURN ADDRESS and select FOLLOW DWORD IN DISASSEMBLER, I will see where the debugger should return after the function completes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9o/jb/1s/9ojb1skptq9fvde0hlbque803qs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
He will come back here. This means that the main function was called from a call that is higher. I can put BP here, restart the exercise and make sure that it is.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8w/8c/sc/8w8cscopqchym1ubcx2zuazrohq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will put BP a little earlier and reboot the program. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/w8/hc/te/w8hctep2w06vcaqzx_ouz4zguws.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The debugger will stop here. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hy/mk/3h/hymk3hx1u-myzmmlnygmmeadmww.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is going to save the arguments to the main function using these PUSH instructions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Below is a link for those who want to know more about the function arguments: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://publications.gbdirect.co.uk/c_book/chapter10/arguments_to_main.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This is not very difficult. The first argument to ARGC is INT, which indicates the number of console parameters used to execute the program, including the path to the executable, and ARGV is an array of pointers to strings. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that if I change the command line, I will pass more arguments and reload.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_a/1o/jc/_a1ojcg0g9lie1le3ouoyuyrtxo.png"><br>
<br>
<img src="https://habrastorage.org/webt/9f/pb/uy/9fpbuygn9gtz4osszzcffsurz9m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here the debugger stops when it is about to save arguments using the PUSH instruction. The first argument that is stored is the farthest, and the last that you save will be the first argument to the function. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I trace and each PUSH instruction saves the arguments. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1u/yj/rp/1uyjrps22gzfc0re25uhcu-p8a8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here I can see the arguments of the function. Above is the first argument to ARGC. It is 3, as it marks the number of arguments that are passed to the console. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vk/il/0i/vkil0istebtffechadwuwyqt2u8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here are 3 arguments. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we press F7 to do STEP INTO and enter the function. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we see that when entering the CALL, the debugger saves the RETURN ADDRESS to the stack.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gp/xc/fw/gpxcfwbg8jr538d3c45oyrqke6e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, as we said when entering the function, the first thing that will be saved on the stack is RETURN ADDRESS (in 32-bit compilation), and below are the arguments to the function, first the first argument, and then the rest in sequence. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qk/s4/bi/qks4bikctvy6i3oxg7sy2ipop_o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second argument, as we saw, is an array of pointers. Here we see in memory that there are three pointers to three lines that are passed as arguments. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c5/f3/kn/c5f3knt9kreq8r5kmfzqgvnv2zw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we stopped at the beginning of the function, a little lower we have RETURN ADDRESSES and ARGUMENTS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We clarify that the file is compiled in 32-bit, because in the 64-bit version, the arguments are passed in a different way. We will see it later. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then the function begins to execute. The first thing is the so-called PROLOGUE, which stores the EBP value of the function that called ours.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ka/ss/9k/kass9k6zty8_-nxgxomh2zb6iui.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This will keep the EBP value just above the return address. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uo/da/gi/uodagirflnltomk1uqlo9dawbjo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If I follow the instructions using F7. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I see that the EBP GUARDADO value is on the stack above the return address. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gw/ml/wi/gwmlwilzarr_u67xp_-6dg5-m0w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following instruction in PROLOGUE: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MOV EBP, ESP </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It sets the EBP value for the current function that was saved and was the parent function that calls ours (In this case, my main function is the EBP-based function, in other cases it may be different, and we see them later) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By placing the current ESP value in EBP, we ensure that we create a frame for our current function.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bw/d0/8u/bwd08ut1gamkdw-5m9y58cqmdrw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, since this function is based on EBP or EBP BASED, the EBP value will be stored inside the function and it will be accepted as a reference, and the ESP will change. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/31/fm/rm/31fmrm3jsa9gz0dwzonyf4lh4wa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This EBP value is taken as the base. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In EBP-based functions, variables and arguments can be named by their distance from this address, which will be stored in the EBP value until its epilogue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can see several variables in the list that are referred to as EBP-4 or EBP-54, referring to the EBP value that it is currently accepting.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can say that as soon as the EBP takes on its value after the PROLOGUE, it will look like a drain, so the arguments will always go in that direction, therefore EBP + XXX refers to the arguments (the stored EBP and the RETURN ADDRESS are also lower, but will not have links in the code), while the variables, as we will see, will be above this address, so the link to EBP-XXX refers to some local variable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, in EBP-based functions: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EBP + XXXX = arguments passed to the function </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
EBP - XXXX = local function variables</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After PROLOGUE there will be some way to reserve space for variables. In our case, this is done by moving the ESP up so that the remaining space below is reserved for the sum of all variable lengths and, sometimes, a little more just in case, which depends on the compiler. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
00401043 | 83EC 54 | SUB ESP, 54 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the ESP is located above the EBP, which will remain the link, and that 0x54 converted to decimal is 84, which is the sum of the BUF and COOKIE lengths. Remember that they were 80 and 4 respectively. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hx/h8/sz/hxh8sz1xa-15otyztxyu8dl6g34.png"><br>
<br>
<img src="https://habrastorage.org/webt/1a/84/bv/1a84bvou8z1bdrr0rkcjyqvqvg8.png"><br>
<br>
<img src="https://habrastorage.org/webt/yv/sh/tv/yvshtvouwajuyoqcvfptuhfa7oa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On execution, a space is created for the BUF and COOKIE variables of 84 bytes in size. You can click the first column in the horizontal direction and look at the EBP value and find that value on the stack. Obviously, now it will be lower.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/w1/eg/vc/w1egvc6xx-pgpprzf6pfvcuicn0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I double click here. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gl/1s/i2/gl1si2koeosh8u7seukoagohri4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, we will have values ‚Äã‚Äãregarding EBP also on the stack. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, EBP-4 matches the listing, -4 is displayed in the first column of the stack, and in the explanation, is also displayed as EBP-4. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pw/_w/2l/pw_w2lyzbza2xlwmthujrqsdado.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If I trace, we see that from the place where the ESP was located to reserve the variables, it will always move up, because it must take into account the space allocated for the variables. When performing 4 PUSHs for MessageBoxA, the debugger places the variables above the reserved space and increases the ESP. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ny/sm/cn/nysmcnqbcdrmrl-q4nbtfi85r_8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If I look at the stack, I see 4 green arguments that I add over the reserved space marked in red. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dg/-t/ty/dg-ttymvnjmjq3u-68oeoixwcgw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you enter the MessageBoxA function, the RETURN ADDRESS of this function is stored on the stack.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/gb/kg/acgbkgp58eatqpqgducvgxoqzca.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is the return address of MessageBoxA. When I get to the RET of this function by tracing with F8, and I execute MessageBoxA. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/nb/qm/vvnbqmlpj06asy7qqwuwipvvzjq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the debugger will go back just below the MessageBoxA call. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fm/ct/do/fmctdoieugal4uiig_pzcvvwfr8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And the PUSH values ‚Äã‚Äãthat you passed for the MessageBoxA function and the RETURN ADDRESS for this function have already been used, and the ESP is again just above the reserved area, as before any function was called. The same thing will happen with calling the PRINTF function. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After you pass the PRINTF function, the BUF and COOKIE addresses will be printed. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qo/tj/8z/qotj8zivsh5xnhiglbkibu53dh4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The BUF address on my machine will be 0x19FED4, and the COOKIE address will be 0x19FF24. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, the program reads the BUF address to pass it to the GETS function and populate the BUF. We can check if the address matches what the 0x19FED4 console shows.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6b/kg/-l/6bkg-lgioczisxsz0s9mlp1omz0.png"><br>
<br>
<img src="https://habrastorage.org/webt/sg/qp/e1/sgqpe1ypgqar2o_5plt8tjlcb0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we see that it is EBP-54. If I double-click on the stack where it shows -54, it will show that the address is BUF = 0x19FED4 on my machine. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d2/ff/wh/d2ffwhnayhtqxh8h1vgknmubaji.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, when I will save the entered data at this address, I can put them in a dump to see how bytes are stored there. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fu/mz/9h/fumz9hojfwk_mzv4fwhx9rjzfjw.png"><br>
<br>
<img src="https://habrastorage.org/webt/r6/hx/lm/r6hxlmsrelhvlr-tjfdss11mulm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here they are. Moreover, nothing is displayed below, since there is no data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When I call the GETS function using F8, I will need to go to the console, type and press ENTER to fill the BUF buffer and rewrite the COOKIE. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z2/ye/e6/z2yee6bmvi02vjrqpz5-dscio0a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the COOKIE variable was at 19FF24 on my machine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, the program compares the cookie with 0x41424344. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/am/p4/ja/amp4ja-l9lkyf8trocairpbj3e0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that EBP-4 says it is a COOKIE, in addition to the address, if we set the HORIZON to the EBP value, as before.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p4/uo/0u/p4uo0ufah0vdsro_ngyrym3txxm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I double click here. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that EBP-4 is a COOKIE, since the variable is at the -4 stack level, zeroing out the HORIZON. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x2/gu/kx/x2gukxgn7arw1lk9_w9fj3y3qbu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the program will not jump and will show us you win! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0e/qv/cl/0eqvclf1uxc7dg8hmgp22ka_3sm.png"><br>
<br>
<img src="https://habrastorage.org/webt/5b/fs/mj/5bfsmjqijpcan7zdmidh-pqj6eg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So we manually achieve the goal that you win! Says. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We dynamically analyzed STACK1 using X64DBG, which is a debugger and does not allow us to analyze the program without starting it. To do this, we must use other tools, such as IDA PRO, GHIDRA or RADARE. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I can make a script model for operating the exercise from PYTHON.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> subprocess <span class="hljs-keyword">import</span> Popen, PIPE<font></font>
<font></font>
payload = <span class="hljs-string">b"A"</span> * <span class="hljs-number">80</span> + <span class="hljs-string">b"\x44\x43\x42\x41"</span><font></font>
<font></font>
p1 = Popen(<span class="hljs-string">r"C:\Users\ricardo\Desktop\abos y stack nuevos\STACK1_VS_2017.exe"</span>, stdin=PIPE)
<span class="hljs-keyword">print</span> (<span class="hljs-string">"PID: %s"</span> % hex(p1.pid))
<span class="hljs-keyword">print</span> (<span class="hljs-string">"Enter para continuar"</span>)<font></font>
p1.communicate(payload)<font></font>
p1.wait()<font></font>
input()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the case of PYTHON 3, I have to put parentheses in the PRINT function and be careful when adding lines that should be bytes (put b in front of the lines in PYTHON 2). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I check that the path is correct and when I run the file. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5b/fs/mj/5bfsmjqijpcan7zdmidh-pqj6eg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Good. We already have a script model for PYTHON 3 for operating STACK1. In the next part, we will continue the static analysis in IDA, RADARE and GHIDRA. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xg/65/w_/xg65w_m85xv1anv5a7uhbuvatuc.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Please note that in addition to the STACK1 task, there are also versions 2, 3 and 4. You can try to solve them. They are very simple and similar to STACK1, so don't be bored. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the next part we will see IDA FREE, RADARE and GHIDRA. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
See you in the next part 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ricardo Narvaha </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
25/10/2019 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS # 1</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A beautiful PDF can be downloaded on my home page - yasha.su </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS # 2 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soon I will write a continuation of the article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://habr.com/en/post/464117/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about how I collected help for Father Chris Kaspersky and what of this happened. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not get bored.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496652/index.html">How to add real-time notifications to Laravel using Pusher</a></li>
<li><a href="../en496654/index.html">Issue # 35: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../en496664/index.html">Different jobs, black, white, red</a></li>
<li><a href="../en496666/index.html">We study the Mediastreamer2 VoIP engine. Part 8</a></li>
<li><a href="../en496670/index.html">Will society change after a pandemic?</a></li>
<li><a href="../en496674/index.html">How do we generate consolidated financial statements?</a></li>
<li><a href="../en496680/index.html">Industry 4.1: Robot Ownership, Neural Networks, and Open Source Monetization</a></li>
<li><a href="../en496682/index.html">How to stay professional in demand</a></li>
<li><a href="../en496686/index.html">How Traffic Analysis Systems Detect Hacker Tactics by MITER ATT & CK, Part 4</a></li>
<li><a href="../en496690/index.html">Coronavirus Control Technologies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>