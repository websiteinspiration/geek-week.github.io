<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçº üåΩ üï∞Ô∏è Project deployment methodology used by Slack üó£Ô∏è üçì üßëüèΩ‚Äçü§ù‚Äçüßëüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Conclusion of a new project release into production requires careful balancing between the speed of deployment and the reliability of the solution. Sl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Project deployment methodology used by Slack</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/496838/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion of a new project release into production requires careful balancing between the speed of deployment and the reliability of the solution. Slack appreciates fast iterations, short feedback loops, and responsiveness to user requests. In addition, the company has hundreds of programmers who strive for the highest possible productivity.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/t6/zj/yk/t6zjykbpoemnwblp_6vgyeuehiq.jpeg"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The authors of the material, the translation of which we publish today, say that a company that seeks to adhere to such values ‚Äã‚Äãand at the same time grows should constantly improve its project deployment system. </font><font style="vertical-align: inherit;">The company needs to invest in the transparency and reliability of work processes, in order to ensure that these processes correspond to the scope of the project. </font><font style="vertical-align: inherit;">Here we will talk about the work processes that have developed in Slack, and about some of the solutions that led the company to use the project deployment system that exists today.</font></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How project deployment processes work today</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each PR (pull request) in Slack must be subjected to a code review and must pass all tests successfully. Only after these conditions are met, can a programmer merge his code with the master branch of the project. However, the deployment of such a code is performed only during business hours according to North American time. As a result, we, due to the fact that our employees are at work, are fully prepared to solve any unexpected problems.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Every day we complete about 12 planned deployments. </font><font style="vertical-align: inherit;">During each deployment, the programmer, who is designated as the main deployment, is responsible for bringing the new assembly to production. </font><font style="vertical-align: inherit;">This is a multi-step process, which provides a smooth conclusion of the assembly in working mode. </font><font style="vertical-align: inherit;">Thanks to this approach, we can detect errors before they affect all our users. </font><font style="vertical-align: inherit;">If there are too many errors, the deployment of the assembly can be rolled back. </font><font style="vertical-align: inherit;">If a particular problem is detected after the release, a fix can be easily released for it.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2e7/8e5/b7a/2e78e5b7a21c45b4b8c11cb611b560eb.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The interface of the Checkpoint system used by Slack to deploy projects.</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The process of deploying a new release in production can be represented in four steps.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç1. </font><font style="vertical-align: inherit;">Creating a release branch</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each release begins with a new release branch, from the moment in our Git history. </font><font style="vertical-align: inherit;">This allows you to assign tags to the release and provides a place where you can make operational corrections for errors found in the process of preparing the release for release in production.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç2. </font><font style="vertical-align: inherit;">Intermediate deployment</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to deploy the assembly to staging servers and run an automatic test for the overall performance of the project (smoke test). </font><font style="vertical-align: inherit;">An intermediate environment is a production environment in which external traffic does not fall. </font><font style="vertical-align: inherit;">In this environment, we conduct additional manual testing. </font><font style="vertical-align: inherit;">This gives us additional confidence that the modified project is working correctly. </font><font style="vertical-align: inherit;">Automated tests alone are not enough to gain such confidence.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç3. </font><font style="vertical-align: inherit;">Deployment in dogfood and canary environments</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deployment in production begins with a dogfood environment represented by a set of hosts that serve our internal Slack workspaces. </font><font style="vertical-align: inherit;">Since we are very active users of Slack, using this approach has helped to detect many errors in the early stages of deployment. </font><font style="vertical-align: inherit;">After we make sure that the basic functionality of the system is not broken, the assembly is deployed in a canary environment. </font><font style="vertical-align: inherit;">It is a system that receives about 2% of production traffic.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñç4. </font><font style="vertical-align: inherit;">Gradual Conclusion in Production</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the monitoring indicators of the new release turn out to be stable, and if after deploying the project in the canary environment we have not received any complaints, we continue the gradual transfer of production servers to the new release. </font><font style="vertical-align: inherit;">The deployment process is divided into the following stages: 10%, 25%, 50%, 75% and 100%. </font><font style="vertical-align: inherit;">As a result, we can slowly transfer production traffic to a new system release. </font><font style="vertical-align: inherit;">At the same time, we have time to investigate the situation in case of revealing some anomalies.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñçWhat if something went wrong during the deployment?</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Making modifications to the code is always a risk. </font><font style="vertical-align: inherit;">But we can cope with this thanks to our well-trained ‚Äúdeployment managers‚Äù who manage the process of introducing a new release into production, monitor the monitoring performance and coordinate the work of programmers who release the code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the event that something really went wrong, we try to detect the problem as early as possible. </font><font style="vertical-align: inherit;">We investigate the problem, find the PR that causes the errors, roll it back, carefully analyze it and create a new assembly. </font><font style="vertical-align: inherit;">True, sometimes the problem goes unnoticed before the project is put into production. </font><font style="vertical-align: inherit;">In such a situation, the most important thing is to restore the service. </font><font style="vertical-align: inherit;">Therefore, before starting the investigation of the problem, we immediately roll back to the previous working assembly.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deployment Building Blocks</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the technologies underlying our project deployment system.</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñçFast deployments</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The workflow described above may seem, in retrospect, to be something completely obvious. </font><font style="vertical-align: inherit;">But our deployment system did not become so far right away. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the company was significantly smaller, our entire application could run on 10 Amazon EC2 instances. </font><font style="vertical-align: inherit;">Deploying a project in this situation meant using rsync to quickly synchronize all servers. </font><font style="vertical-align: inherit;">Previously, the new code was separated from production by just one step, represented by an intermediate environment. </font><font style="vertical-align: inherit;">Assemblies were created and tested in such an environment, and then went straight into production. </font><font style="vertical-align: inherit;">Understanding such a system was very simple; it allowed any programmer to deploy the code he wrote at any time.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But as the number of our customers grew, so did the scale of the infrastructure necessary to ensure the operation of the project. Soon, given the constant growth of the system, our deployment model, based on sending new code to the servers, ceased to cope with its task. Namely, the addition of each new server meant an increase in the time required to complete the deployment. Even strategies based on the parallel use of rsync have certain limitations.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we solved this problem by switching to a fully parallel deployment system, which is not arranged like the old system. </font><font style="vertical-align: inherit;">Namely, now we did not send the code to the servers using the synchronization script. </font><font style="vertical-align: inherit;">Now each server independently downloaded a new assembly, learning that it needed to be done, thanks to observing the Consul key change. </font><font style="vertical-align: inherit;">The servers downloaded the code in parallel. </font><font style="vertical-align: inherit;">This allowed us to maintain a high deployment speed even in an environment of constant system growth.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c9e/e38/643/c9ee3864307cec2cf4d9927c1201909c.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Production servers monitor the Consul key. </font><font style="vertical-align: inherit;">2. The key is changing, this tells the servers that they need to start downloading new code. </font><font style="vertical-align: inherit;">3. Servers upload tarball files with application code</font></font></font></i><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñçAtomic deployments</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another solution that helped us get to a multi-level deployment system was atomic deployment. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prior to using atomic deployments, each deployment could result in a large number of error messages. The fact is that the process of copying new files to production servers was not atomic. This led to the existence of a short time span when the code in which the new functions were called was available before the functions themselves became available. When such code was called, it returned internal errors. This was manifested in unsuccessful API requests and in broken web pages.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The team that dealt with this problem solved it by introducing the concept of ‚Äúhot‚Äù (hot) and ‚Äúcold‚Äù (cold) directories. </font><font style="vertical-align: inherit;">The code in the "hot" directory is responsible for processing production traffic. </font><font style="vertical-align: inherit;">And in the ‚Äúcold‚Äù directories, the code, while the system is running, is only getting ready for use. </font><font style="vertical-align: inherit;">During the deployment, the new code is copied to the unused ‚Äúcold‚Äù directory. </font><font style="vertical-align: inherit;">Then, when there are no active processes on the server, the directories are switched instantly.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b23/cf4/201/b23cf4201e703afc4716d9fe793b2b0d.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Unpacking the application code into a ‚Äúcold‚Äù directory. </font><font style="vertical-align: inherit;">2. Switching the system to a ‚Äúcold‚Äù directory, which becomes ‚Äúhot‚Äù (atomic operation)</font></font></font></i><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bottom line: a shift in emphasis on reliability</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 2018, the project grew to such a scale that very rapid deployment began to harm the stability of the product. We had a very advanced deployment system in which we invested a lot of time and effort. We only needed to restructure and improve the deployment organization processes. We have become a fairly large company, the development of which was used all over the world to organize uninterrupted communication and to solve important problems. Therefore, the focus of our attention was reliability.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We needed to make the process of deploying new Slack releases more secure. This need led us to improve our deployment system. As a matter of fact, above we discussed this improved system. In the bowels of the system, we continue to use technologies of fast and atomic deployment. Changed how exactly the deployment is performed. Our new system is designed to gradually deploy new code at different levels, in different environments. Now we use more advanced than before, auxiliary tools and tools for monitoring the system. This gives us the opportunity to catch and eliminate errors long before they get a chance to reach the end user.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But we are not going to stop there. </font><font style="vertical-align: inherit;">We are constantly improving this system using more advanced auxiliary tools and automation tools. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dear readers! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How is the process of deploying new project releases where you work?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496826/index.html">Million sprites at 120+ fps</a></li>
<li><a href="../en496828/index.html">Where to find freelance that will be fun? (Spoiler: not Upwork)</a></li>
<li><a href="../en496830/index.html">What is Emergent Communication and why you need to know</a></li>
<li><a href="../en496832/index.html">Photo tour: what are they doing in the laboratory of hybrid nanophotonics and optoelectronics of the New Physics Institute ITMO</a></li>
<li><a href="../en496836/index.html">QSerializer: solution for simple JSON / XML serialization</a></li>
<li><a href="../en496840/index.html">Musk believes that 12 thousand satellites will not interfere with astronomers. His opinion is not consistent with the model</a></li>
<li><a href="../en496842/index.html">A simple epidemic model with basic Python tools</a></li>
<li><a href="../en496846/index.html">Language mechanics of stacks and pointers</a></li>
<li><a href="../en496848/index.html">The digest of interesting materials for the mobile # 340 developer (on April 6 - 12)</a></li>
<li><a href="../en496850/index.html">Maven plugin for JPackage from Java 14</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>