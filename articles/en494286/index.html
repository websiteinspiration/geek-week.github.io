<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëäüèº üë• üìá Embox RTOS on Raspberry Pi üåÇ üå∑ ‚úñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 
 We are often asked if Embox supports Raspberry Pi. Yes there is. Description of how to run now here . In this article I want to talk a litt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Embox RTOS on Raspberry Pi</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/embox/blog/494286/"><img src="https://habrastorage.org/files/c92/874/069/c92874069b4e49d4ae65eb48e6d6af19.png" alt="image" align="right"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are often asked if </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Embox</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> supports Raspberry Pi. </font><font style="vertical-align: inherit;">Yes there is. </font><font style="vertical-align: inherit;">Description of how to run now </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In this article I want to talk a little more about this.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We had bought the Raspberry Pi Model B rev 2.0 board for a long time (this is the first Rpi 1) and even took the first steps in porting: the UART, interrupt controller, timer, and even framebuffer were implemented in some form. But the data on how to start it was lost, so I had to remember / understand it again. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firstly, they launched on the QEMU emulator. Regular QEMU has raspi2 machine support, but no raspi. But when there was a porting process, just raspi support was added. We still have the version in our repository, though we had to draft commits to compile it to the modern environment, but in the end we got a version of the QEMU emulator which has rpi1 support - the ‚Äú-M raspi‚Äù machine (you can see how to run it on our </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">As a result, Embox was launched there and drew a gradient in the video memory. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There was a question about starting on iron. </font><font style="vertical-align: inherit;">How to boot was not clear at first, so we decided to try the standard Raspbian. </font><font style="vertical-align: inherit;">2020-02-13-raspbian-buster-lite.img is downloaded </font><font style="vertical-align: inherit;">from the official </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">All downloads occur from a microSD card, so we prepare it - copy the resulting image</font></font><pre><code class="bash hljs">dd bs=4M <span class="hljs-keyword">if</span>=2020-02-13-raspbian-buster-lite.img of=/dev/sdb conv=fsync</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where ‚Äú/ dev / sdb‚Äù is the SD card. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you look at lsblk now, there will be something like this:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
sdb      8:16   1  14,6G  0 disk <font></font>
‚îú‚îÄsdb1   8:17   1   256M  0 part <font></font>
‚îî‚îÄsdb2   8:18   1  14,3G  0 part<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's mount sdb1 and see what lies there:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ sudo mount /dev/sdb1 /mnt<font></font>
$ ls /mnt/<font></font>
bcm2708-rpi-b.dtb       bcm2710-rpi-3-b.dtb       COPYING.linux  fixup_db.dat      start_db.elf<font></font>
bcm2708-rpi-b-plus.dtb  bcm2710-rpi-3-b-plus.dtb  fixup4cd.dat   fixup_x.dat       start.elf<font></font>
bcm2708-rpi-cm.dtb      bcm2710-rpi-cm3.dtb       fixup4.dat     issue.txt         start_x.elf<font></font>
bcm2708-rpi-zero.dtb    bcm2711-rpi-4-b.dtb       fixup4db.dat   kernel.img<font></font>
bcm2708-rpi-zero-w.dtb  bootcode.bin              fixup4x.dat    LICENCE.broadcom<font></font>
bcm2709-rpi-2-b.dtb     cmdline.txt               fixup_cd.dat   overlays<font></font>
bcm2710-rpi-2-b.dtb     config.txt                fixup.dat      start_cd.elf<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you can see, there is a whole set of * .dtb for all occasions - for different versions of Raspberry. </font><font style="vertical-align: inherit;">We also see the bootloader - bootcode.bin, and kernel.img is Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We connected the monitor via HDMI to the board, booted up, saw Raspbian, everything is fine. </font><font style="vertical-align: inherit;">Next, we need to copy our binary with Embox to kernel.img so that the bootloader loads it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Build Embox:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
make confload-arm/rpi1-model-b<font></font>
make<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Copy the resulting binary:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
cp build/base/bin/embox.bin /mnt/kernel.img<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We insert the SD card back into Rpi and turn on the power - on the monitor, the square that should have been drawn by the Embox did not appear. </font><font style="vertical-align: inherit;">Well, let's try to connect via the serial port and debug our binary. </font><font style="vertical-align: inherit;">To do this, use the RDC1-USB-UART adapter. </font><font style="vertical-align: inherit;">We connect it to the board as follows:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
RDC1      Rapi<font></font>
<font></font>
GND &lt;---&gt; GND<font></font>
5V  &lt;---&gt; 5V<font></font>
RX  &lt;---&gt; TXD0/GPIO14<font></font>
TX  &lt;---&gt; RXD0/GPIO15<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can see the pinout in the picture so that it is forgiven. Now it turns out that the power to the USB adapter comes from the USB hub of the PC, and the power to the Rpi, in turn, is supplied from the USB adapter. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/un/ro/_l/unro_lw0ym064oh8harvubx6fhy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Turn on. Connect via minicom:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
sudo minicom -d /dev/ttyUSB0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No conclusion is visible. There must be some kind of problem with the serial port driver. We try to disable register initialization, and use what was configured by the bootloader, fill in a new image on the SD card - the output has appeared. Everything is clear, it means it was connected correctly, but the serial port driver is not programmable correctly. I will not talk about how we repaired the PL011 serial port driver, but I will note a couple of points that may be useful when developing for this platform. Firstly, the base addresses on Rpi are computed somehow confusing, they can‚Äôt be found immediately in the documentation, so a good way to check the base address of the registers is to look at them in Linux:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
pi@raspberrypi:~$ ls /sys/bus/amba/devices/20201000.serial<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see that the address is 0x20201000. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second point is that there is Linux modified for Rpi, which can be assembled and copied to kernel.img - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.raspberrypi.org/documentation/linux/kernel/building.md</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In the case of the serial port, it really helped to understand the input frequency UARTCLK, necessary for programming baud rate - just insert printk () in the right place in drivers / tty / serial / amba-pl011.c. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, without any significant changes, we managed to launch the same image as for QEMU on iron.</font></font><img src="https://habrastorage.org/webt/gm/wm/k8/gmwmk81lk6v4yuxsqvwyfidytj0.jpeg" align="right"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That‚Äôs probably all, since it makes no sense to disassemble the driver sources, because you can just study them in our repository. In general, it seems that under Raspberry there are very few ports of other non-Linux OS. For example, I did not find either FreeRTOS (it turned out that some kind of repository is on GitHub, but not in official releases), neither for NuttX, or anything like that. Yes, and discussions on the forums suggest that RTOS is supposedly not needed there and take a better place to play Arduino - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.raspberrypi.org/forums/viewtopic.php?t=201540 The Osdev </font></font></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example turned</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> out to be inoperative, so if someone wants something- then do it on bare metal, then see better examples from us :)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Full support for the new Rpi 2/3/4 is still in our plans. </font><font style="vertical-align: inherit;">But some support will most likely be delivered as part of GSoC 2020, one of the most popular ideas among students. </font><font style="vertical-align: inherit;">Actually, for GSoC, we restored Rpi1 support in Embox. </font><font style="vertical-align: inherit;">If someone has thoughts about why they need Rpi RTOS, write in the comments, we will be happy :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, if you study the sources of RaPi or just </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Embox,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we will be happy to answer the questions: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Newsletter: embox-ru@googlegroups.com </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Telegram chat: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/embox_chat</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494270/index.html">Antiquities: Remote Work on 1998 Devices</a></li>
<li><a href="../en494272/index.html">Creating an IT startup business plan: step-by-step detailed structure</a></li>
<li><a href="../en494274/index.html">E-commerce autotest system</a></li>
<li><a href="../en494278/index.html">EF Core + Oracle: how to make migrations idempotent</a></li>
<li><a href="../en494284/index.html">Homemade antiseptic from what is in the pharmacy. We make alcohol from vodka without a moonshine in the old-fashioned way</a></li>
<li><a href="../en494290/index.html">#YAMYWork. A decision that may be right</a></li>
<li><a href="../en494292/index.html">Wrike: 5 years with OKR</a></li>
<li><a href="../en494294/index.html">3D printing certified for the oil and gas and marine industries</a></li>
<li><a href="../en494296/index.html">Xiaomi Gateway (eu version - Lumi.gateway.mieu01) Hacked</a></li>
<li><a href="../en494298/index.html">Envoy for the little ones</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>