<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖐🏽 🥪 ☑️ Évaluation des métriques de charge du serveur intégré ✋ 👨🏿‍🔬 🛀🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Travaillant dans l'une des plus grandes banques du pays, j'ai dû faire face à la tâche d'évaluer l'efficacité de l'utilisation des ressources d'enviro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Évaluation des métriques de charge du serveur intégré</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498360/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travaillant dans l'une des plus grandes banques du pays, j'ai dû faire face à la tâche d'évaluer l'efficacité de l'utilisation des ressources d'environ 16 000 serveurs. </font><font style="vertical-align: inherit;">La tâche a été formulée très simplement - il était nécessaire de développer une méthodologie pour évaluer les métriques de charge du serveur pendant une période. </font><font style="vertical-align: inherit;">Idéalement, la charge du serveur par période doit être estimée en utilisant un ou plusieurs (pas plus de 8) nombres.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelques mots sur les fonctionnalités d'utilisation des serveurs virtuels</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les grandes organisations (en particulier les banques) ont un zoo hétéroclite d'applications héritées déployées sur différents serveurs à l'aide d'une variété de technologies de virtualisation. Un cloud privé est une technologie prometteuse, mais en réalité, les grandes organisations utiliseront longtemps diverses plates-formes de virtualisation pour déployer une variété d'applications.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À mesure que les plateformes de virtualisation évoluent, il arrive un moment où personne dans l'entreprise ne peut comprendre l'efficacité avec laquelle les ressources sont utilisées. Même les outils de surveillance les plus avancés ne fournissent pas de réponse à cette question en raison de divers scénarios d'utilisation du serveur. Par exemple, un service peut avoir un serveur de rapports qui ne sera entièrement chargé que pendant une période de temps limitée. Dites 3-4 heures à la fin du mois. Dans des scénarios réels, personne n'alloue dynamiquement des ressources pour de tels serveurs - c'est difficile techniquement et organisationnellement. Les ressources sont allouées spécifiquement pour la charge de serveur périodique maximale, bien que cela arrive rarement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En résumé, dans les grandes organisations, les ressources de la batterie virtuelle sont dépensées de manière extrêmement inefficace.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ci-dessous, je propose une méthodologie avec laquelle vous pouvez facilement justifier l'augmentation et la diminution des ressources allouées au serveur virtuel, quel que soit le scénario.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Méthodologie</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour évaluer la charge des ressources, il est nécessaire de collecter des statistiques de différents compteurs; pour évaluer la charge des ressources, différentes métriques seront utilisées. Classiquement, les compteurs peuvent être divisés en 2 types (selon le taux de changement): «rapide» et «lent». Un bon exemple de compteur «rapide» est le compteur de charge du processeur (% CPU). Un exemple de compteur lent est le pourcentage d'espace libre sur le disque dur (% FreeSpace). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'évaluation des compteurs lents consiste à calculer la valeur extrême (minimum ou maximum) de la métrique pour la période. Cette approche permet (par exemple, lors de l'évaluation de l'espace libre sur le disque) d'estimer la ressource disponible et, si nécessaire, d'allouer des volumes supplémentaires ou de réduire les volumes actuels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les compteurs rapides, une approche différente est utilisée. Les inconvénients de l'utilisation de métriques intégrales simples (moyenne, maximum, minimum et médiane) pour évaluer la dynamique de tels compteurs sont bien décrits </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Les inconvénients communs incluent le manque d'informations sur l'augmentation des charges (moyennes et maximales). Si nous prenons la valeur maximale de la période comme une métrique intégrale, la présence de valeurs aberrantes (par exemple, le chargement instantané du processeur jusqu'à 100% au démarrage du programme) ne donnera pas d'informations objectives. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est proposé d'utiliser le quantile de 0,9 pour estimer la métrique rapide (il s'agit d'une valeur qui indique le niveau en dessous duquel se situe la valeur observée dans 90% des échantillons). Avec une charge de serveur uniforme selon cette métrique, nous pouvons estimer correctement la charge moyenne du processeur. Mais cette approche présente les mêmes inconvénients - le manque d'informations sur l'augmentation des charges (moyennes et maximales). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ci-dessous, à titre d'illustration, le graphique hebdomadaire et quotidien du compteur% CPU. La valeur maximale du compteur sur les graphiques était de 100%.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ym/al/xi/ymalxitgoyqlsthnyhs0cjttbie.png"><br>
<br>
<img src="https://habrastorage.org/webt/wj/xk/aj/wjxkajy2y3enm93easqblqnl-x8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le graphique montre que dans la période indiquée, il y a une augmentation de la charge, qui dure environ 3 heures. Pour ce compteur, diverses mesures ont été calculées pour la semaine. La figure 2 montre que la médiane (ligne verte, valeur 5%), la moyenne (jaune, valeur 12%) et le quantile 0,9 (rouge, valeur 27%) filtrent le changement de charge et les informations le concernant sont perdues. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En tant que développement de l'idée des quantiles, je voudrais proposer l'idée de déplacer les quantiles. Il s'agit d'un analogue de la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">moyenne mobile.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais le quantile 0.9 est utilisé comme fonction de fenêtre. </font><font style="vertical-align: inherit;">De plus, nous utiliserons 2 quantiles glissants pour estimer le niveau du contre - rapide avec une courte période (1 heure) et lent avec une longue période (24 heures). </font><font style="vertical-align: inherit;">Un quantile rapide filtrera les émissions instantanées et fournira des informations sur les pics de charge. </font><font style="vertical-align: inherit;">Un quantile lent vous permettra d'estimer la charge moyenne. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir sur les graphiques, les quantiles mobiles de 0,9 sont des caractéristiques dynamiques (marron - rapide, violet - lent). </font><font style="vertical-align: inherit;">Par souci de simplicité, il est proposé d'utiliser le statut du compteur en tant que métriques:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la valeur quantile maximale avec une période de 1 heure, qui indique la charge maximale continue du serveur pour la période,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la valeur quantile moyenne avec une période de 24 heures, qui montre la charge moyenne du serveur pour la période.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le graphique, la valeur maximale du quantile rapide est la ligne noire à 85%, la valeur moyenne du quantile lent est la ligne rose à 30%. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, lors de l'analyse de la charge des ressources du serveur (selon le compteur% CPU), si nous prenons la moyenne du mois (12%) comme métrique, nous pouvons prendre une décision erronée de réduire les ressources allouées. </font><font style="vertical-align: inherit;">La double mesure quantile à déplacement rapide / lent (85 et 30%) montre qu'il y a suffisamment de ressources allouées, mais pas d'excédents.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Décision</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mise en œuvre de l'évaluation de l'efficacité de l'utilisation des ressources a été décomposée en 3 tâches:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">collecte de données </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">élaboration d'une méthodologie d'évaluation </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mise en œuvre de la méthodologie dans l'architecture actuelle </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ci-dessus, j'ai examiné la tâche 2 de cette implémentation, ci-dessous nous parlerons un peu de la troisième tâche. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les données ont été collectées dans la base de données ClickHouse. Cette colonne SGBD est idéale pour stocker des données de séries chronologiques. Cela a été discuté en détail lors </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du Meetup ClickHouse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> du 5 septembre 2019. Une comparaison de ClickHouse avec d'autres SGBD de séries chronologiques peut être trouvée </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la suite de la collecte des données, nous avons formé plusieurs tableaux dans lesquels les données étaient organisées ligne par ligne (les valeurs de chaque compteur étaient écrites sur une ligne distincte). Et, bien sûr, il y avait des problèmes avec les données brutes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le premier problème est l'inégalité des intervalles entre les entrées de compteur. Par exemple, si la période d'enregistrement standard du compteur était de 5 minutes, il y avait parfois des lacunes et l'enregistrement suivant était supérieur à 5 minutes (jusqu'à 20 minutes) du précédent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxième problème est que parfois les données du compteur arrivent 2 fois ou plus (avec des valeurs différentes) avec le même horodatage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le troisième problème - ClickHouse n'a pas de fonctions de fenêtre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour résoudre le premier problème, vous pouvez utiliser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASOF JOIN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. L'idée est assez simple - pour chaque compteur de chaque serveur, créer une table uniformément avec des intervalles de temps également remplis. L'utilisation d'ASOF JOIN permet de remplir les valeurs de la nouvelle table avec les valeurs les plus proches de la table de données brutes (des options de remplissage similaires à ffill et bfill peuvent être configurées). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La solution au deuxième problème est l'agrégation avec le choix de la valeur maximale à un instant donné.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour résoudre le troisième problème, plusieurs solutions ont été envisagées. </font><font style="vertical-align: inherit;">Tout d'abord, le script Python a été rejeté en raison de performances insuffisantes. </font><font style="vertical-align: inherit;">La deuxième solution - copier des données brutes dans une base de données MSSQL, calculer des métriques et recopier - semblait trop compliquée à mettre en œuvre. </font><font style="vertical-align: inherit;">MSSQL possède également des fonctions de fenêtre, mais aucune fonction d'agrégation n'est requise. </font><font style="vertical-align: inherit;">On pourrait être perplexe et écrire votre propre fonction SQL CLR. </font><font style="vertical-align: inherit;">Mais cette option a été rejetée en raison d'une complexité excessive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une solution de travail pourrait être un script SQL pour ClickHouse. </font><font style="vertical-align: inherit;">Un exemple de ce script est donné ci-dessous. </font><font style="vertical-align: inherit;">Par souci de simplicité, j'ai cherché à calculer uniquement le quantile rapide pour un seul compteur pour plusieurs serveurs. </font><font style="vertical-align: inherit;">La solution n'a pas l'air très simple et pas très pratique, mais ça marche.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, un rapport de test a été créé dans PowerBI pour démontrer la méthodologie. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/qk/t9/kgqkt92tcilmz8h9gqieermwz3w.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/c_/m5/tk/c_m5tk-r1ehlvrdhh_dbsj3rzie.jpeg"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conclusion, je voudrais spéculer sur le développement de la solution. </font><font style="vertical-align: inherit;">Si vous regardez la solution du point de vue des entrepôts de données, vous pouvez voir que la tâche de créer un entrepôt de données (entrepôt de données) à partir d'une couche de données brutes (zone de transit) est ainsi résolue. </font><font style="vertical-align: inherit;">Vous pouvez discuter de l'architecture, mais pour ClickHouse en tant que base de données de colonnes, la normalisation n'est pas critique (ou peut-être même nuisible). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La poursuite du développement du référentiel se traduit par la création de tables agrégées (jour \ semaine \ mois) avec différentes durées de vie (TTL). </font><font style="vertical-align: inherit;">Cela évitera un gonflement excessif du stockage. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'étape suivante peut consister à utiliser les données pour l'analyse prédictive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code et les données pour les tests sont affichés </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr498346/index.html">GoLand 2020.1 - Prise en charge améliorée des modules Go, beaucoup de complétion automatique et bien plus encore</a></li>
<li><a href="../fr498350/index.html">Le meilleur matériel pour les entretiens d'embauche et les recherches d'emploi</a></li>
<li><a href="../fr498352/index.html">SHISHUA: le générateur de nombres pseudo-aléatoires le plus rapide au monde</a></li>
<li><a href="../fr498354/index.html">Comment traduire «liste de souhaits» en «matériel» ou semi-semi-mobile semi-idéal</a></li>
<li><a href="../fr498358/index.html">Apprenez le français ou comment obtenir un adaptateur universel à partir d'un scanner de diagnostic PSA</a></li>
<li><a href="../fr498362/index.html">Kingston conserve son leadership dans les livraisons de SSD: comment faire?</a></li>
<li><a href="../fr498366/index.html">Quels algorithmes les développeurs Yandex implémentent-ils chaque jour</a></li>
<li><a href="../fr498368/index.html">L'histoire d'un interrupteur</a></li>
<li><a href="../fr498370/index.html">SAP UI5 et Windows de confirmation: encore une fois sur le contexte</a></li>
<li><a href="../fr498372/index.html">Tutoriel de simulateur de réseau ns-3. Chapitre 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>