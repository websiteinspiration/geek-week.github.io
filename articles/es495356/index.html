<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚¨ÜÔ∏è üë©üèº ‚öïÔ∏è Implementaci√≥n del algoritmo de consenso RAFT para almacenamiento distribuido de KV en Java ü§πüèΩ üë©üèº‚Äçüéì üë®‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola de nuevo. Hace unos d√≠as, comenz√≥ la capacitaci√≥n en un nuevo grupo sobre el curso "Arquitecto de software" , y hoy nos gustar√≠a compartir un art...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Implementaci√≥n del algoritmo de consenso RAFT para almacenamiento distribuido de KV en Java</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/495356/"><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola de nuevo. Hace unos d√≠as, comenz√≥ la capacitaci√≥n en un nuevo grupo sobre el curso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Arquitecto de software"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y hoy nos gustar√≠a compartir un art√≠culo escrito por uno de los estudiantes del curso, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anton Pleshakov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (jefe de desarrollo de Log√≠stica de programas y cofundador de Clusterra).</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/pb/5h/qq/pb5hqqeunfv8gkvyvspmegwuj4w.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actualmente, los sistemas de microservicios distribuidos se han convertido pr√°cticamente en el est√°ndar de la industria, y no solo en el mundo empresarial. Los beneficios del uso de sistemas distribuidos se han descrito y discutido m√°s de una vez. Las ventajas de los microservicios han sido conocidas por todos desde hace mucho tiempo: tecnolog√≠as para la tarea, componibilidad, escalabilidad, escalamiento de desarrollo, reducci√≥n de TTM, etc. Es obvio que el desarrollo de aplicaciones distribuidas proporciona m√°s opciones para una respuesta oportuna a las crecientes demandas comerciales y la digitalizaci√≥n de todo lo que hay a su alrededor.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n es importante tener en cuenta que en este momento un factor muy importante que influye en la elecci√≥n de una estrategia de desarrollo a favor de los microservicios es la disponibilidad de todo tipo de soluciones de infraestructura preparadas que se encargan de la soluci√≥n de problemas asociados con los costos adicionales de operar un sistema distribuido. Estamos hablando de sistemas de orquestaci√≥n de contenedores, mash de servicios, medios de rastreo distribuido, monitoreo, registro, etc. Se puede afirmar con seguridad que la mayor√≠a de los factores mencionados anteriormente como los inconvenientes del enfoque de microservicio en la actualidad no tienen tanta influencia como hace un par de a√±os.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basado en las realidades modernas, la mayor√≠a de los desarrolladores buscan la primera oportunidad para cambiar de una estructura monol√≠tica a una de microservicio. Uno de los primeros pasos que se pueden tomar sin recurrir a la refactorizaci√≥n total y la descomposici√≥n grave es lograr un sistema de escalabilidad horizontal. Es decir, convertir su aplicaci√≥n monol√≠tica en un cl√∫ster, posiblemente incluso formado por los mismos monolitos, pero que le permite variar din√°micamente su n√∫mero.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se trata de lograr la escalabilidad horizontal, surge la cuesti√≥n de la sincronizaci√≥n de datos dentro de un cl√∫ster de manera muy r√°pida y muy aguda. Afortunadamente, todos los DBMS modernos admiten la replicaci√≥n de datos entre nodos de una forma u otra. El desarrollador solo necesita seleccionar el DBMS para la tarea y decidir qu√© propiedades del sistema (seg√∫n el teorema de CAP) necesita, CP o AP, y el problema se resuelve. En el caso de que se requiera CP y los requisitos de consistencia sean altos, uno de los m√©todos para resolver el problema de sincronizaci√≥n de datos es usar un cl√∫ster que admita el algoritmo de consenso RAFT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este algoritmo bastante nuevo (desarrollado en 2012) ofrece una alta garant√≠a de consistencia y es muy popular. Decid√≠ averiguar c√≥mo funciona y escrib√≠ mi implementaci√≥n de un repositorio de valores clave consistente en Java (Spring Boot).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øTiene sentido implementar alg√∫n algoritmo distribuido usted mismo? Est√° claro que puede tomar una implementaci√≥n lista para usar de cualquier algoritmo distribuido, y con el mayor grado de probabilidad, esta implementaci√≥n ser√° mejor que una "bicicleta" casera. Por ejemplo, puede usar un DBMS que mantenga el nivel de consistencia requerido. O puede implementar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zookeeper</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O puede encontrar un marco adecuado para su idioma. Para Java, existe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atomix</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que resuelve perfectamente los problemas de sincronizaci√≥n de datos distribuidos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero del otro lado. Si toma una soluci√≥n llave en mano, el uso de una aplicaci√≥n externa generalmente agrega un punto adicional de falla a su sistema. Y los marcos pueden ser redundantes o dif√≠ciles de operar y aprender, o pueden no existir en absoluto para su lenguaje de programaci√≥n. Adem√°s, la implementaci√≥n independiente del algoritmo de consenso es una tarea de ingenier√≠a extremadamente interesante que ampl√≠a sus horizontes y brinda una comprensi√≥n de c√≥mo resolver los problemas que surgen cuando los servicios interact√∫an en un cl√∫ster utilizando el m√©todo m√°s √≥ptimo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que la especificaci√≥n del algoritmo contiene un conjunto de medidas para mantener la integridad de los datos, puede usar el conocimiento adquirido e incluso usar el algoritmo en su totalidad. Cualquier parte del algoritmo puede ser √∫til en la vida real. Supongamos que tiene un conjunto de trabajadores para analizar archivos en paralelo. Los trabajadores son equivalentes, pero desea designar a uno de los trabajadores como coordinador, y cuando el trabajador coordinador se caiga, asigne a cualquier otro trabajador libre como coordinador. La primera mitad del algoritmo RAFT, que describe c√≥mo elegir un l√≠der entre nodos equivalentes, lo ayudar√° con esto. O, por ejemplo, si solo tiene dos nodos en relaci√≥n con maestro-esclavo, puede usar las reglas de replicaci√≥n descritas en la especificaci√≥n RAFT para organizar el intercambio de datos en su caso m√°s simple.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El art√≠culo es esencialmente una gu√≠a pr√°ctica sobre c√≥mo implementar RAFT usted mismo. </font><font style="vertical-align: inherit;">El algoritmo en s√≠ y los aspectos te√≥ricos de su trabajo no ser√°n entendidos. </font><font style="vertical-align: inherit;">Puede leer una breve descripci√≥n aqu√≠ en este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excelente art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o estudiar la especificaci√≥n completa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">All√≠ puede encontrar una visualizaci√≥n muy clara del algoritmo.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descripci√≥n general de la soluci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La parte del c√≥digo que est√° directamente relacionada con la implementaci√≥n del algoritmo se analiza en el art√≠culo. </font><font style="vertical-align: inherit;">Al final del art√≠culo hay un enlace al repositorio, donde puede ver el c√≥digo completo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tarea fue la siguiente. </font><font style="vertical-align: inherit;">Desarrolle un sistema distribuido que le permita almacenar datos en una base de datos de valores clave. </font><font style="vertical-align: inherit;">Los datos de cada nodo deben ser consistentes, es decir, si los datos cayeron en la base de datos de un nodo y la mayor√≠a de los nodos confirmaron que tambi√©n recibieron estos datos, tarde o temprano estos datos estar√°n en la base de datos de cada nodo. </font><font style="vertical-align: inherit;">Cuando una parte del cl√∫ster se desconecta y cuando se vuelve a conectar, los nodos que estaban fuera del cl√∫ster deben ponerse al d√≠a con el cl√∫ster principal y sincronizarse. </font><font style="vertical-align: inherit;">Cada nodo proporciona una API REST para escribir y leer datos de la base de datos. </font><font style="vertical-align: inherit;">El sistema consta de dos m√≥dulos para dos tipos de nodos: cliente y servidor. </font><font style="vertical-align: inherit;">A continuaci√≥n consideramos las caracter√≠sticas de la implementaci√≥n del servidor en s√≠. </font><font style="vertical-align: inherit;">El c√≥digo del cliente est√° en el repositorio. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un nodo de servidor puede operar en tres estados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seguidor (seguidor). </font><font style="vertical-align: inherit;">Acepta solicitudes de lectura del cliente. </font><font style="vertical-align: inherit;">Toma un latido del l√≠der</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Candidato (candidato). </font><font style="vertical-align: inherit;">Acepta solicitudes de lectura del cliente. </font><font style="vertical-align: inherit;">Env√≠a solicitudes de voto a otros nodos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√≠der </font><font style="vertical-align: inherit;">Acepta solicitudes de lectura y escritura. </font><font style="vertical-align: inherit;">Env√≠a solicitudes de latidos a otros nodos. </font><font style="vertical-align: inherit;">Env√≠a datos de solicitudes de anexos a otros nodos.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El per√≠odo de "liderazgo" de uno de los nodos se llama ronda (t√©rmino). </font><font style="vertical-align: inherit;">Un nuevo candidato abre una nueva ronda.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Almacenamiento de datos</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada nodo proporciona acceso al repositorio del registro de operaciones, en el que las operaciones para cambiar datos se registran secuencialmente.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/operations/OperationsLog.java<br>
</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OperationsLog</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">append</span><span class="hljs-params">(Operation operation)</span></span>;
   <span class="hljs-function">Operation <span class="hljs-title">get</span><span class="hljs-params">(Integer index)</span></span>;
   <span class="hljs-function">List&lt;Operation&gt; <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
   <span class="hljs-function">Long <span class="hljs-title">getTerm</span><span class="hljs-params">(Integer index)</span></span>;
   <span class="hljs-function">Integer <span class="hljs-title">getLastIndex</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">Long <span class="hljs-title">getLastTerm</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">removeAllFromIndex</span><span class="hljs-params">(<span class="hljs-keyword">int</span> newOperationIndex)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada operaci√≥n, adem√°s de los datos y el tipo (insertar, cambiar, eliminar), contiene el n√∫mero de la ronda en la que se cre√≥. Adem√°s, cada operaci√≥n tiene un √≠ndice que aumenta secuencialmente. Es importante que todas las operaciones se inserten en los registros de seguidores en el mismo orden en que se insertan en el registro del l√≠der. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada nodo tiene acceso a una base de datos en la que los datos se almacenan directamente.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/storage/Storage.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Storage</span> </span>{
   <span class="hljs-function">List&lt;Entry&gt; <span class="hljs-title">all</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">String <span class="hljs-title">get</span><span class="hljs-params">(Long key)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(Long key, String val)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Long key, String val)</span></span>;
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">delete</span><span class="hljs-params">(Long key)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la implementaci√≥n actual, las soluciones integradas en memoria se utilizan tanto para el registro como para la base de datos (Lista y Mapa competitivo ordinario). Si es necesario, simplemente puede implementar la interfaz adecuada para admitir otros tipos de almacenamiento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La aplicaci√≥n de operaciones desde el registro a la base de datos se lleva a cabo mediante una m√°quina de estado distribuida. Una m√°quina de estado es un mecanismo que es responsable de cambiar el estado de un cl√∫ster, restringiendo el uso de cambios incorrectos (operaciones fuera de servicio o un nodo desconectado que se considera un l√≠der). Para que los cambios se consideren v√°lidos y para que se apliquen a la base de datos, deben pasar una serie de comprobaciones y cumplir con ciertos criterios, que es precisamente lo que proporciona la m√°quina de estados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para un l√≠der, una operaci√≥n se aplica a la base de datos si la mayor√≠a de los nodos han confirmado el hecho de que la operaci√≥n tambi√©n se replica en su registro. </font><font style="vertical-align: inherit;">Para un seguidor, la operaci√≥n se aplica a la base de datos si se recibe una se√±al del l√≠der que ella ingres√≥ a su base de datos.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temporizadores </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada nodo proporciona intercambio de datos con otros nodos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se admiten dos tipos de consultas:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">votar cuando se realiza una ronda de votaci√≥n</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anexe, tambi√©n conocido como latido del coraz√≥n (si no tiene datos), para replicar los datos de registro a los seguidores y evitar el inicio de una nueva ronda de votaci√≥n.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El hecho del inicio de un evento est√° determinado por el temporizador. </font><font style="vertical-align: inherit;">Se lanzan dos tipos de temporizadores en el nodo:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">votar. </font><font style="vertical-align: inherit;">Para comenzar una ronda de votaci√≥n. </font><font style="vertical-align: inherit;">Cada nodo tiene su propio intervalo, despu√©s del cual intentar√° iniciar una nueva votaci√≥n. </font><font style="vertical-align: inherit;">La cuenta regresiva comienza de nuevo cuando recibe un latido del l√≠der.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">latido del coraz√≥n. </font><font style="vertical-align: inherit;">Para enviar una solicitud a los seguidores por parte del l√≠der adjunto. </font><font style="vertical-align: inherit;">Si el nodo no recibe un latido y el temporizador de votaci√≥n ha expirado, se convierte en candidato e inicia elecciones, aumenta el n√∫mero de la ronda de votaci√≥n y env√≠a solicitudes de votaci√≥n a otros nodos. </font><font style="vertical-align: inherit;">Si el nodo recoge la mayor√≠a de los votos, se convierte en el l√≠der y comienza a enviar latidos.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El estado actual del nodo.</font></font></h3> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada nodo almacena datos sobre el estado actual.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/context/Context.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Context</span> </span>{
   <span class="hljs-function">Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//    </span>
   <span class="hljs-function">State <span class="hljs-title">getState</span><span class="hljs-params">()</span></span>;<span class="hljs-comment">//: , ,  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getVotedFor</span><span class="hljs-params">()</span></span>; 
               <span class="hljs-comment">//          </span>
   <span class="hljs-function">Long <span class="hljs-title">getCurrentTerm</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getCommitIndex</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//    </span>
   <span class="hljs-function">List&lt;Peer&gt; <span class="hljs-title">getPeers</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//      </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un nodo l√≠der tambi√©n almacena metadatos para los nodos a los que replica datos.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/pleshakoff/raft/blob/master/server/src/main/java/com/raft/server/node/peers/Peer.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Peer</span> </span>{
   <span class="hljs-function">Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  </span>
   <span class="hljs-function">Integer <span class="hljs-title">getNextIndex</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//  ,    </span>
   <span class="hljs-function">Integer <span class="hljs-title">getMatchIndex</span><span class="hljs-params">()</span></span>;<span class="hljs-comment">//   </span>
   <span class="hljs-function">Boolean <span class="hljs-title">getVoteGranted</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">//     </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El l√≠der actualiza los metadatos del nodo cuando recibe respuestas de los seguidores. </font><font style="vertical-align: inherit;">El l√≠der los utiliza para determinar qu√© pr√≥xima operaci√≥n de √≠ndice el seguidor est√° listo para aceptar y qu√© operaciones ya se han agregado al registro del seguidor.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Votaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La clase </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">ElectionService</font></a><font style="vertical-align: inherit;"> es responsable de votar</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ElectionService</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">processElection</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">AnswerVoteDTO <span class="hljs-title">vote</span><span class="hljs-params">(RequestVoteDTO requestVoteDTO)</span></span>;<font></font>
} </code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviar una solicitud de votaci√≥n </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si el nodo es un seguidor y no recibe un latido durante el per√≠odo establecido para la espera, entonces aumenta su ronda actual, se declara candidato y comienza a enviar solicitudes de voto a otros nodos. </font><font style="vertical-align: inherit;">Si logra reunir un qu√≥rum y la mayor√≠a de los nodos emiten su voto, se convertir√° en el nuevo l√≠der. </font><font style="vertical-align: inherit;">En t√©rminos RAFT, el qu√≥rum es m√°s de la mitad de todos los nodos (51%). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analicemos el m√©todo de </font></font><code>processElection</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clase </font></font><code>ElectionServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que es llamado por el temporizador de votaci√≥n cuando expira la votaci√≥n y env√≠a a los nodos una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicitud de votaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
 <br>
<pre><code class="java hljs"><span class="hljs-comment">//1</span><font></font>
context.setState(CANDIDATE); <font></font>
Long term = context.incCurrentTerm(); <font></font>
context.setVotedFor(context.getId()); <font></font>
<font></font>
List&lt;Integer&gt; peersIds = context.getPeers().stream().map(Peer::getId).collect(Collectors.toList());<font></font>
<span class="hljs-keyword">long</span> voteGrantedCount = <span class="hljs-number">1L</span>;
<span class="hljs-keyword">long</span> voteRevokedCount = <span class="hljs-number">0L</span>;<font></font>
<font></font>
<span class="hljs-comment">//2</span>
<span class="hljs-keyword">while</span> (checkCurrentElectionStatus(term)) {<font></font>
   List&lt;AnswerVoteDTO&gt; answers = getVoteFromAllPeers(term, peersIds);<font></font>
   peersIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
   <span class="hljs-keyword">for</span> (AnswerVoteDTO answer : answers) {
       <span class="hljs-comment">//3</span>
       <span class="hljs-keyword">if</span> (answer.getStatusCode().equals(OK)) {
           <span class="hljs-comment">//4</span>
           <span class="hljs-keyword">if</span> (answer.getTerm()&gt;context.getCurrentTerm()) {<font></font>
               context.setTermGreaterThenCurrent(answer.getTerm());<font></font>
               <span class="hljs-keyword">return</span>;<font></font>
           }<font></font>
           <span class="hljs-keyword">if</span> (answer.isVoteGranted()) {
               <span class="hljs-comment">//5 </span>
               context.getPeer(answer.getId()).setVoteGranted(<span class="hljs-keyword">true</span>);<font></font>
               voteGrantedCount++;<font></font>
           } <span class="hljs-keyword">else</span>
               <span class="hljs-comment">//6 </span><font></font>
               voteRevokedCount++;<font></font>
       } <span class="hljs-keyword">else</span> {<font></font>
          peersIds.add(answer.getId());<font></font>
       }<font></font>
   }<font></font>
  <span class="hljs-comment">//7</span>
  <span class="hljs-keyword">if</span> (voteGrantedCount &gt;= context.getQuorum()) {<font></font>
       winElection(term);<font></font>
       <span class="hljs-keyword">return</span>;<font></font>
   } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (voteRevokedCount &gt;= context.getQuorum()) {<font></font>
       loseElection(term);<font></font>
       <span class="hljs-keyword">return</span>;<font></font>
   } </code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establecer el estado de "Candidato". </font><font style="vertical-align: inherit;">Eleve el n√∫mero redondo y vote por nosotros mismos.</font></font></li>
<li>  ,       (    ).  -  ,        ,           heartbeat                 .</li>
<li> -  ,    .    ,      ,     -. </li>
<li>       ,                            .     ,      heartbeat     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°El nodo vot√≥ por nosotros! </font><font style="vertical-align: inherit;">Aumentamos el n√∫mero de nodos que emiten votos por nosotros y corregimos que este nodo vot√≥ por nosotros.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Votados no por nosotros, tambi√©n creemos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si se re√∫ne el qu√≥rum y el nodo gana la elecci√≥n, establecemos el estado de "L√≠der". </font><font style="vertical-align: inherit;">De lo contrario, nos convertimos en seguidores y esperamos.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n debe tenerse en cuenta que cuando un nodo se convierte en un l√≠der, el siguiente √≠ndice se establece para cada nodo en la lista de nodos almacenados en el l√≠der, que es igual al √∫ltimo √≠ndice en el registro del l√≠der m√°s 1. A partir de este √≠ndice, el l√≠der intentar√° actualizar los registros del seguidor. </font><font style="vertical-align: inherit;">De hecho, este √≠ndice almacenado por el l√≠der puede no corresponder con el √≠ndice real del registro del seguidor y el valor real se obtendr√° solo al intercambiar datos con el seguidor y se ajustar√°. </font><font style="vertical-align: inherit;">Pero </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necesita alg√∫n </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">punto de partida</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="java hljs">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">winElection</span><span class="hljs-params">(Long term)</span> </span>{<font></font>
       context.setState(LEADER);<font></font>
       context.getPeers().forEach(peer -&gt;<font></font>
               peer.setNextIndex(operationsLog.getLastIndex()+<span class="hljs-number">1</span>)<font></font>
<font></font>
       );<font></font>
   }</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procesamiento de solicitud de votaci√≥n </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al votar, cada nodo recibe una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solicitud del</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> siguiente </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">formulario</font></a><font style="vertical-align: inherit;"> del candidato </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestVoteDTO</span> </span>{
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long term; <span class="hljs-comment">//     </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer candidateId; <span class="hljs-comment">//  </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer lastLogIndex; <span class="hljs-comment">//     </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long lastLogTerm; <span class="hljs-comment">//       </span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora veamos el procedimiento de </font></font><code>vote</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clase </font></font><code>ElectionServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, procesa la solicitud de voto del candidato y devuelve una decisi√≥n con respecto a su candidatura para el papel de l√≠der.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/election/ElectionServiceImpl.java#L178 <br>
</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> AnswerVoteDTO <span class="hljs-title">vote</span><span class="hljs-params">(RequestVoteDTO dto)</span> </span>{<font></font>
   <font></font>
       <span class="hljs-keyword">boolean</span> termCheck;
       <span class="hljs-comment">//1</span>
       <span class="hljs-keyword">if</span> (dto.getTerm() &lt; context.getCurrentTerm())
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerVoteDTO(context.getId(),context.getCurrentTerm(),<span class="hljs-keyword">false</span>);
       <span class="hljs-keyword">else</span> <span class="hljs-comment">//2</span>
       <span class="hljs-keyword">if</span> (dto.getTerm().equals(context.getCurrentTerm())) {<font></font>
           termCheck = (context.getVotedFor() == <span class="hljs-keyword">null</span>||<font></font>
                          context.getVotedFor().equals(dto.getCandidateId()));<font></font>
       }<font></font>
       <span class="hljs-keyword">else</span>
       {   <span class="hljs-comment">//3</span>
           termCheck = <span class="hljs-keyword">true</span>;<font></font>
             context.setTermGreaterThenCurrent(dto.getTerm());<font></font>
       }<font></font>
<font></font>
       <span class="hljs-comment">//4  </span>
       <span class="hljs-keyword">boolean</span> logCheck = !((operationsLog.getLastTerm() &gt; dto.getLastLogTerm()) ||<font></font>
               ((operationsLog.getLastTerm().equals(dto.getLastLogTerm())) &amp;&amp;<font></font>
                       (operationsLog.getLastIndex() &gt; dto.getLastLogIndex())));<font></font>
<font></font>
<font></font>
       <span class="hljs-keyword">boolean</span> voteGranted = termCheck&amp;&amp;logCheck;<font></font>
<font></font>
       <span class="hljs-comment">//5</span>
       <span class="hljs-keyword">if</span> (voteGranted) {<font></font>
           context.setVotedFor(dto.getCandidateId());<font></font>
       }<font></font>
       <span class="hljs-comment">//6   </span>
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerVoteDTO(context.getId(),context.getCurrentTerm(),voteGranted);<font></font>
   }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al recibir una solicitud de un candidato, el nodo realiza dos verificaciones: verifica la ronda del candidato y la longitud de su registro. </font><font style="vertical-align: inherit;">Si la ronda del candidato es m√°s alta y su registro es m√°s largo o igual, entonces el nodo le da un voto al candidato.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la ronda actual del nudo es mayor que la ronda del candidato, nos negamos, porque esta es una solicitud de alg√∫n nudo rezagado, que, aparentemente, estuvo fuera del grupo durante alg√∫n tiempo y comenz√≥ el proceso de elecci√≥n porque no vio al l√≠der titular. </font></font></li>
<li>   ,   , ,           ,        ,     ,       ;       .              ‚Äî    .</li>
<li>     ,     </li>
<li> .                   ,            ,  ,        ,     .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con un resultado positivo, arreglamos el hecho de que el nodo particip√≥ en las elecciones y vot√≥ por el candidato.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviar el resultado al candidato</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seguramente, las condiciones podr√≠an escribirse algo m√°s cortas y m√°s elegantes, pero dej√© una opci√≥n m√°s "ingenua" para no confundirme y no confundir a nadie. </font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replicaci√≥n </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El l√≠der del temporizador env√≠a seguidores de latidos a todos los nodos para restablecer sus temporizadores de votaci√≥n. Como el l√≠der almacena en sus √≠ndices de metadatos las √∫ltimas operaciones de todos los seguidores, puede evaluar si es necesario enviar la operaci√≥n a los nodos. Si el registro de operaciones del l√≠der se vuelve m√°s largo que el registro de cualquier seguidor, entonces √©l, junto con los latidos del coraz√≥n, le env√≠a secuencialmente las operaciones que faltan. Llamarlo anexar solicitud. Si la mayor√≠a de los nodos confirman la recepci√≥n de nuevas operaciones, el l√≠der aplica estas operaciones a su base de datos y aumenta el √≠ndice de la √∫ltima operaci√≥n aplicada. Este √≠ndice tambi√©n se env√≠a a los seguidores junto con una solicitud de latido. Y si el √≠ndice l√≠der es m√°s alto que el √≠ndice seguidor, entonces el seguidor tambi√©n aplica operaciones a su base de datos para igualar los √≠ndices. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este tipo de solicitud de anexos que el l√≠der env√≠a al seguidor</font></font></a><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestAppendDTO</span> </span>{
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long term; <span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer leaderId; <span class="hljs-comment">//   </span><font></font>
<font></font>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer prevLogIndex;<span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long prevLogTerm;<span class="hljs-comment">//   </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer leaderCommit;<span class="hljs-comment">//      </span>
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Operation operation; <span class="hljs-comment">//</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay implementaciones en las que las operaciones se transfieren en lotes de varios por solicitud. </font><font style="vertical-align: inherit;">En la implementaci√≥n actual, solo se puede transmitir una operaci√≥n por </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
solicitud. La clase responde al env√≠o y procesamiento de la solicitud heartbeat-append:</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/replication/ReplicationService.java</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ReplicationService</span> </span>{
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">appendRequest</span><span class="hljs-params">()</span></span>;
   <span class="hljs-function">AnswerAppendDTO <span class="hljs-title">append</span><span class="hljs-params">(RequestAppendDTO requestAppendDTO)</span></span>;<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviar una solicitud de cambio de datos </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considere un fragmento de un </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">m√©todo de</font></a></font><code>sendAppendForOnePeer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> clase </font></font><code>ReplicationServiceImpl</code><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. El m√©todo es responsable de generar una solicitud al seguidor y enviarla</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> CompletableFuture&lt;AnswerAppendDTO&gt; <span class="hljs-title">sendAppendForOnePeer</span><span class="hljs-params">(Integer id)</span> </span>{
   <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
       <span class="hljs-keyword">try</span> {
           <span class="hljs-comment">//1</span><font></font>
           Peer peer = context.getPeer(id);<font></font>
<font></font>
           Operation operation;<font></font>
           Integer prevIndex;<font></font>
           <span class="hljs-comment">//2    </span>
           <span class="hljs-keyword">if</span> (peer.getNextIndex() &lt;= operationsLog.getLastIndex()) {<font></font>
               operation = operationsLog.get(peer.getNextIndex());<font></font>
               prevIndex = peer.getNextIndex() - <span class="hljs-number">1</span>;<font></font>
           } <span class="hljs-keyword">else</span> 
           <span class="hljs-comment">//3  </span><font></font>
           {<font></font>
               operation = <span class="hljs-keyword">null</span>;<font></font>
               prevIndex = operationsLog.getLastIndex();<font></font>
           }<font></font>
<font></font>
<font></font>
           RequestAppendDTO requestAppendDTO = <span class="hljs-keyword">new</span> RequestAppendDTO(<font></font>
                   context.getCurrentTerm(), <span class="hljs-comment">//   </span>
                   context.getId(), <span class="hljs-comment">//  </span>
                   prevIndex,<span class="hljs-comment">//      </span>
                   operationsLog.getTerm(prevIndex),<span class="hljs-comment">//  </span><font></font>
                   context.getCommitIndex(),<font></font>
                               <span class="hljs-comment">//      </span>
                   Operation <span class="hljs-comment">//</span><font></font>
           );<font></font>
<font></font>
...<font></font>
<span class="hljs-comment">/*   http     */</span>
}</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metadatos del seguidor</font></font></li>
<li>   ,   .             (      ),          ,      ,  ,   .    ,       ,    ,   ,     </li>
<li>   ,    ,       ;        ,     ,       ,  </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, considere el m√©todo de </font></font><code>appendRequest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clase </font></font><code>ReplicationServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que es responsable de enviar la solicitud de anexo y procesar el resultado a todos los seguidores.</font></font><br>
<br>
<code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/pleshakoff/raft/blob/eba5ea1984e2623702f4c299cf1b0af7a6ba0d14/server/src/main/java/com/raft/server/replication/ReplicationServiceImpl.java#L109</a></code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">appendRequest</span><span class="hljs-params">()</span> </span>{<font></font>
       List&lt;Integer&gt; peersIds = context.getPeers().stream().map(Peer::getId).collect(Collectors.toList());<font></font>
<font></font>
       <span class="hljs-comment">//1 </span>
       <span class="hljs-keyword">while</span> (peersIds.size() &gt; <span class="hljs-number">0</span>) {
           <span class="hljs-comment">//2 </span><font></font>
           List&lt;AnswerAppendDTO&gt; answers = sendAppendToAllPeers(peersIds);<font></font>
           peersIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
           <span class="hljs-keyword">for</span> (AnswerAppendDTO answer : answers) {
               <span class="hljs-comment">//3</span>
               <span class="hljs-keyword">if</span> (answer.getStatusCode().equals(OK)) {
                   <span class="hljs-comment">//4</span>
                   <span class="hljs-keyword">if</span> (answer.getTerm() &gt; context.getCurrentTerm()) {<font></font>
                        context.setTermGreaterThenCurrent(answer.getTerm());<font></font>
                       <span class="hljs-keyword">return</span>;<font></font>
                   }<font></font>
                   Peer peer = context.getPeer(answer.getId());<font></font>
                   <span class="hljs-comment">//5     </span>
                   <span class="hljs-keyword">if</span> (answer.getSuccess()) {                      <font></font>
                       peer.setNextIndex(answer.getMatchIndex() + <span class="hljs-number">1</span>);<font></font>
                       peer.setMatchIndex(answer.getMatchIndex());<font></font>
                       <span class="hljs-keyword">if</span> (peer.getNextIndex() &lt;= operationsLog.getLastIndex())<font></font>
                           peersIds.add(answer.getId());<font></font>
                   <span class="hljs-comment">//6      </span>
                   } <span class="hljs-keyword">else</span> {<font></font>
                       peer.decNextIndex();<font></font>
                       peersIds.add(answer.getId());<font></font>
                   }<font></font>
               }<font></font>
           }<font></font>
           <span class="hljs-comment">//7</span><font></font>
           tryToCommit();<font></font>
       }<font></font>
}<font></font>
</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repetimos la solicitud hasta que recibamos una respuesta de todos los seguidores de que la replicaci√≥n fue exitosa. </font><font style="vertical-align: inherit;">Dado que se env√≠a una operaci√≥n por solicitud, puede llevar varias iteraciones sincronizar los registros de seguidores</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviar solicitudes a todos los seguidores y obtener una lista con respuestas </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consideramos respuestas solo de seguidores disponibles</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si resulta que la ronda de uno de los seguidores es m√°s que la ronda del l√≠der, detenemos todo y nos convertimos en seguidores. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si el seguidor respondi√≥ que todo fue exitoso, actualizamos los metadatos del seguidor: guardamos el √∫ltimo √≠ndice del registro del seguidor y el √≠ndice de la pr√≥xima operaci√≥n esperada por el seguidor. </font></font></li>
<li>  ,    ,  ,           ,           .  ,                  ,      .     ,         .    ,          .</li>
<li>        ,      .     . </li>
</ol><br>
<h3>     </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora veamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥mo procesa exactamente el seguidor la solicitud de adici√≥n del l√≠der. </font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
M√©todo de </font></font><code>append</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clase</font></font><code>ReplicationServiceImpl</code><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">public</span> AnswerAppendDTO <span class="hljs-title">append</span><span class="hljs-params">(RequestAppendDTO dto)</span> </span>{<font></font>
     <font></font>
       <span class="hljs-comment">//1     </span>
       <span class="hljs-keyword">if</span> (dto.getTerm() &lt; context.getCurrentTerm()) {
           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(),context.getCurrentTerm(),<span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<font></font>
       } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dto.getTerm() &gt; context.getCurrentTerm()) {
           <span class="hljs-comment">//2 </span><font></font>
           context.setCurrentTerm(dto.getTerm());<font></font>
           context.setVotedFor(<span class="hljs-keyword">null</span>);<font></font>
       }<font></font>
       <span class="hljs-comment">//3  </span>
       applicationEventPublisher.publishEvent(<span class="hljs-keyword">new</span> ResetElectionTimerEvent(<span class="hljs-keyword">this</span>));<font></font>
<font></font>
       <span class="hljs-keyword">if</span> (!context.getState().equals(FOLLOWER)) {<font></font>
           context.setState(FOLLOWER);<font></font>
       }<font></font>
        <font></font>
       <span class="hljs-comment">//4  </span>
       <span class="hljs-keyword">if</span> ((dto.getPrevLogIndex() &gt; operationsLog.getLastIndex()) ||                                                                                        !dto.getPrevLogTerm().equals(operationsLog.getTerm(dto.getPrevLogIndex()))) {
                      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<font></font>
       }<font></font>
<font></font>
<font></font>
       Operation newOperation = dto.getOperation();<font></font>
       <span class="hljs-keyword">if</span> (newOperation != <span class="hljs-keyword">null</span>) {
           <span class="hljs-keyword">int</span> newOperationIndex = dto.getPrevLogIndex() + <span class="hljs-number">1</span>;<font></font>
           <font></font>
         <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) {
               <span class="hljs-comment">//5</span>
               <span class="hljs-keyword">if</span> ((newOperationIndex &lt;= operationsLog.getLastIndex()) &amp;&amp;<font></font>
                      (!newOperation.getTerm().equals(operationsLog.getTerm(newOperationIndex)))){<font></font>
                   operationsLog.removeAllFromIndex(newOperationIndex);<font></font>
               }<font></font>
               <span class="hljs-comment">//6</span>
               <span class="hljs-keyword">if</span> (newOperationIndex &lt;= operationsLog.getLastIndex())<font></font>
               {<font></font>
                 <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">true</span>,      operationsLog.getLastIndex());<font></font>
               }<font></font>
               <span class="hljs-comment">//7</span><font></font>
               operationsLog.append(newOperation);<font></font>
           }<font></font>
        }<font></font>
        <span class="hljs-comment">//8 </span>
        <span class="hljs-keyword">if</span> (dto.getLeaderCommit() &gt; context.getCommitIndex()) {<font></font>
           context.setCommitIndex(Math.min(dto.getLeaderCommit(), operationsLog.getLastIndex()));<font></font>
       }<font></font>
<font></font>
                 <font></font>
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnswerAppendDTO(context.getId(), context.getCurrentTerm(), <span class="hljs-keyword">true</span>, operationsLog.getLastIndex());<font></font>
   }</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la ronda del l√≠der es menor que la ronda del seguidor, entonces enviamos al l√≠der una ronda y una se√±al de que su solicitud ha sido rechazada. </font><font style="vertical-align: inherit;">Tan pronto como el l√≠der reciba una ronda m√°s grande que la suya en respuesta, se convertir√° en un seguidor.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la ronda del l√≠der es m√°s que la ronda del seguidor, establezca esta ronda para el seguidor.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dado que la solicitud fue recibida del l√≠der, independientemente de si hay datos all√≠ o no, restablecemos el temporizador de votaci√≥n y, si no √©ramos seguidores, nos convertimos en √©l. </font></font></li>
<li>   ,   ,            ,  ,   ,    ,   .        ,    ,      </li>
<li>              ,   .            .   ,     , - ,   ,      ,      ,      .             ,    .</li>
<li>  ,   .  ,    </li>
<li>  ,     </li>
<li>        ,   ,       ,    . </li>
</ol><br>
<h3>   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solo queda descubrir c√≥mo el l√≠der aplica las operaciones desde el registro a la base de datos. En el proceso de enviar operaciones a los seguidores y procesar las respuestas de ellos, el l√≠der actualiza los metadatos de los nodos. Tan pronto como el n√∫mero de nodos cuyo √≠ndice de la √∫ltima operaci√≥n en el registro es mayor que el √≠ndice de la √∫ltima operaci√≥n aplicada a la base de datos por el l√≠der se vuelve igual al qu√≥rum, podemos afirmar que la mayor√≠a de los nodos recibieron la operaci√≥n y podemos aplicarlo a la base de datos del l√≠der. En otras palabras, si un l√≠der envi√≥ una operaci√≥n a sus seguidores y la mayor√≠a de ellos lo insert√≥ en su registro y respondi√≥ al l√≠der, entonces podemos aplicar esta operaci√≥n a la base de datos del l√≠der y aumentar el √≠ndice de la √∫ltima operaci√≥n aplicada. Este √≠ndice con la pr√≥xima solicitud append-heartbeat volar√° al seguidor y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aplicar√° la operaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con el mismo √≠ndice desde su registro a su base de datos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analicemos el m√©todo de la </font></font><code>tryToCommit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">clase.</font></font><code>ReplicationServiceImpl</code><br>
<br>
<pre><code class="java hljs">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tryToCommit</span><span class="hljs-params">()</span> </span>{
       <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
           <span class="hljs-comment">//1</span>
           <span class="hljs-keyword">int</span> N = context.getCommitIndex() + <span class="hljs-number">1</span>;
           <span class="hljs-comment">//2</span><font></font>
           Supplier&lt;Long&gt; count = () -&gt;<font></font>
               context.getPeers().stream().map(Peer::getMatchIndex).<font></font>
                       filter(matchIndex -&gt; matchIndex &gt;= N).count() + <span class="hljs-number">1</span>;<font></font>
<font></font>
           <span class="hljs-comment">//3 </span>
           <span class="hljs-keyword">if</span> (operationsLog.getLastIndex() &gt;= N &amp;&amp;<font></font>
                   operationsLog.getTerm(N).equals(context.getCurrentTerm())&amp;&amp;<font></font>
                      count.get()&gt;=context.getQuorum()<font></font>
           )<font></font>
           {<font></font>
               context.setCommitIndex(N);<font></font>
           } <span class="hljs-keyword">else</span>
               <span class="hljs-keyword">return</span>;<font></font>
       }<font></font>
   }</code></pre><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenemos el siguiente √≠ndice de la operaci√≥n aplicada a la base de datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contamos cu√°ntos seguidores tienen una operaci√≥n con dicho √≠ndice en sus registros, y no olvidemos agregar un l√≠der </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si el n√∫mero de seguidores es qu√≥rum y la operaci√≥n con dicho √≠ndice est√° en el registro del l√≠der, y la ronda de esta operaci√≥n es equivalente a la actual, entonces el l√≠der aplica la operaci√≥n a la base de datos y aumenta el √≠ndice de la √∫ltima operaci√≥n aplicada. </font><font style="vertical-align: inherit;">Las operaciones de la ronda anterior no pueden aplicarse, porque otro l√≠der fue responsable de ellas y podr√≠a surgir un conflicto. </font><font style="vertical-align: inherit;">Cada l√≠der aplica operaciones solo de su ronda actual.</font></font></li>
</ol><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cualquier algoritmo distribuido, el representante de la familia de los cuales es RAFT, es una poderosa soluci√≥n integrada que garantiza el logro del resultado, sujeto a todas las reglas descritas en la especificaci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay muchos algoritmos distribuidos y son diferentes. Existe ZAB, que se implementa en Zookeeper y se utiliza, por ejemplo, para sincronizar datos en Kafka. Existen algoritmos con requisitos de consistencia menos estrictos, por ejemplo, la gran cantidad de implementaciones del protocolo Gossip que se utilizan en los sistemas AP. Existen algoritmos que siguen los principios de RAFT y, al mismo tiempo, utilizan el protocolo de chismes para intercambiar registros como MOKKA, que tambi√©n utiliza cifrado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Creo que tratar de descubrir cualquiera de estos algoritmos es extremadamente √∫til para cualquier desarrollador, y como mencion√© anteriormente, las soluciones pueden ser interesantes tanto de manera integral como en partes separadas. </font><font style="vertical-align: inherit;">Y, obviamente, definitivamente debe buscar en esta direcci√≥n a aquellos cuyas actividades est√°n relacionadas con el desarrollo de sistemas distribuidos y con respecto a la sincronizaci√≥n de datos, incluso si usan soluciones industriales est√°ndar.</font></font><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referencias</font></font></h3><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repositorio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Especificaci√≥n</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Breve descripci√≥n</font></font></a></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esperamos que el material te haya sido √∫til. </font><font style="vertical-align: inherit;">Y si quieres </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tomar un curso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puedes hacerlo ahora mismo.</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es495342/index.html">Liquidaci√≥n de tarjetas bancarias en el comercio: creaci√≥n de un conjunto de datos abierto e infograf√≠a en Google Data Studio</a></li>
<li><a href="../es495344/index.html">Unif√≠quelo: c√≥mo Lamoda hace que sus servicios Go sean consistentes</a></li>
<li><a href="../es495346/index.html">De error a alerta con acciones</a></li>
<li><a href="../es495350/index.html">Servidor web de inicio o su propio proveedor de alojamiento</a></li>
<li><a href="../es495354/index.html">¬øC√≥mo lanzar productos continuamente en 20 idiomas y no morir?</a></li>
<li><a href="../es495360/index.html">C√≥mo automatizamos la portabilidad de productos de C # a C ++</a></li>
<li><a href="../es495362/index.html">Autoaislamiento y programa: c√≥mo no volverse loco en casa y pasar el tiempo de manera √∫til</a></li>
<li><a href="../es495364/index.html">API Style Guide, o no hagas que los usuarios piensen</a></li>
<li><a href="../es495366/index.html">16 tipos de programadores o desarrolladores no son los mismos robots</a></li>
<li><a href="../es495370/index.html">Lo p√∫blico es malo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>