<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛒 🚵🏽 👴🏽 パート5/2ビル。1：RocketChip Avenueの交差点と滑りやすい計装トラック 🐯 🧕 👩‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前の4つの部分では、RISC-V RocketChipコアの実験、つまりこのコアをアルテラFPGA（現在のIntel）を搭載した「非標準」ボードに移植するための準備が行われました。最後に、最後の部分では、このボードでLinuxを実行することが判明しました。これについて私を何が面白がったか知っています...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>パート5/2ビル。1：RocketChip Avenueの交差点と滑りやすい計装トラック</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461577/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前の4つの部分では、RISC-V RocketChipコアの実験、つまりこのコアをアルテラFPGA（現在のIntel）を搭載した「非標準」ボードに移植するための準備が行われました。</font><font style="vertical-align: inherit;">最後に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後の部分では</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、このボードでLinuxを実行することが判明しました。</font><font style="vertical-align: inherit;">これについて私を何が面白がったか知っていますか？</font><font style="vertical-align: inherit;">同時に、アセンブラーRISC-V、C、およびScalaを操作する必要があり、それらすべての中で、Scalaは最低レベルの言語でした（プロセッサーがそれに書かれているため）。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、Cも不快にしないようにしましょう。</font><font style="vertical-align: inherit;">さらに、Scala + Chiselバンドルが</font><font style="vertical-align: inherit;">ハードウェアを明示的に記述するための</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドメイン固有言語</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">としてのみ使用されていた</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">場合</font></a><font style="vertical-align: inherit;">、今日では、単純なC関数を命令の形でプロセッサーに「プル」する方法を学びます。</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終的な目標は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QInst</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">との</font><font style="vertical-align: inherit;">類推によるAFLに似た簡単なインストルメンテーションの簡単な実装で</font><font style="vertical-align: inherit;">あり、独立した命令の実装は副産物にすぎません。</font></font></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">商用のOpenCLからRTLへのコンバーターがある（1つではない）ことは明らかです。</font><font style="vertical-align: inherit;">私はまた、RISC-Vの特定のCOPILOTプロジェクトに関する情報に出くわしましたが、同様の目標（はるかに高度な目標）を持っていますが、何かがひどくググっとなっていて、しかもそれはおそらく商用製品でもあります。</font><font style="vertical-align: inherit;">私は主にオープンソースソリューションに興味を持っていますが、たとえそうであったとしても、これを自分で実装するのは楽しいです。</font></font></p><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">免責事項</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（「消火器で踊る」に関する通常の警告に加えて）：結果のソフトウェアコア、特に信頼できないデータを不注意に適用することは強くお勧めしません。これまでのところ、処理されているデータを処理できない理由を理解するほど自信がありません。プロセスとコアの間の境界ケースでの「フロー」。まあ、データが「打つ」ことができるという事実については、私は思うので、それは明らかです。一般的に、まだ検証と検証があります...</font></font></p><br>
<p> ,    « »?        ,      (  )       .        () ,  «» .       —        ,    , «»     ,    side effect-   . <em>       ,         .</em></p><br>
<h2 id="uchimsya-ponimat-c-na-samom-dele-net">  C (  , )</h2><br>
<p>   ,     C? ,  —      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> ELF-</a>:       C / Rust / -   eBPF-,    .    ,   Scala    <code>elf.h</code>    . , ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">JNAerator</a> —          —   ,        JNA (   JNI).                  .        case class-:</p><br>
<pre><code class="scala hljs"><span class="hljs-keyword">sealed</span> <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">SectionKind</span></span>
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">RegularSection</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SectionKind</span></span>
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">SymtabSection</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SectionKind</span></span>
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">StrtabSection</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SectionKind</span></span>
<span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">RelSection</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SectionKind</span></span><font></font>
<font></font>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Elf64Header</span>(<span class="hljs-params">
    sectionHeaders: <span class="hljs-type">Seq</span>[<span class="hljs-type">ByteBuffer</span>],
    sectionStringTableIndex: <span class="hljs-type">Int</span>
</span>)</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Elf64Section</span>(<span class="hljs-params">
    data: <span class="hljs-type">ByteBuffer</span>,
    linkIndex: <span class="hljs-type">Int</span>,
    infoIndex: <span class="hljs-type">Int</span>,
    kind: <span class="hljs-type">SectionKind</span>
</span>)</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Symbol</span>(<span class="hljs-params">
    name: <span class="hljs-type">String</span>,
    value: <span class="hljs-type">Int</span>,
    size: <span class="hljs-type">Int</span>,
    shndx: <span class="hljs-type">Int</span>,
    isInstrumenter: <span class="hljs-type">Boolean</span>
</span>)</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Relocation</span>(<span class="hljs-params">
    relocatedSection: <span class="hljs-type">Int</span>,
    offset: <span class="hljs-type">Int</span>,
    symbol: <span class="hljs-type">Symbol</span>
</span>)</span><font></font>
<font></font>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BpfInsn</span>(<span class="hljs-params">
    opcode: <span class="hljs-type">Int</span>,
    dst: <span class="hljs-type">Int</span>,
    src: <span class="hljs-type">Int</span>,
    offset: <span class="hljs-type">Int</span>,
    imm: <span class="hljs-type">Either</span>[<span class="hljs-type">Long</span>, <span class="hljs-type">Symbol</span>]
</span>)</span>
<span class="hljs-keyword">final</span> <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BpfProg</span>(<span class="hljs-params">
    name: <span class="hljs-type">String</span>,
    insns: <span class="hljs-type">Seq</span>[<span class="hljs-type">BpfInsn</span>]
</span>)</span></code></pre><br>
<p>       —        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><code>java.nio.ByteBuffer</code></a> —       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">   ELF-</a>.    ,     <code>opcode == 0x18</code> (   64-bit immediate ),      8-  (,     ,       ),       ,   ,    . , <code>__builtin_popcountl</code>   64- <strong></strong> <code>0x0101010101010101</code>.     «»      —         (  ),      <code>COMMON</code>                ( ,     / <code>UInt</code>).</p><br>
<h2 id="stroim-hardware-po-naboru-instrukciy"> hardware   </h2><br>
<p>,  ,          ,  ,      ,      .         (     ),     ,      load/store  .  ,           .  :       <code>UInt</code>,   <code>(UInt, Bool)</code>:    —  ,   —   .         ,   ,      .</p><br>
<p>  eBPF       64- ,     16- (  ) 64- .    :</p><br>
<ul>
<li>  ,    <code>r1</code>  <code>r2</code>   ,   — ,   (,   «»  )</li>
<li>  - ,   -  ,       ,        <code>(data1 op data2, valid1 &amp;&amp; valid2)</code></li>
<li>  ,     :   ,   </li>
<li>      , - :   callback,  ,    <code>valid</code>         .     AND-   <code>globalValid</code>,       .           <code>valid</code>,       .</li>
</ul><br>
<p> ,      ,    .     ,             ,   , UB. .. <code>*addr += 1</code> —  ,    ,     ( ,     ,  ),   <code>*addr += 1; return *addr;</code>      <strong></strong>  - . ,      (,   -   ),            ,   ,       ,       <code>valid</code>    .          .</p><br>
<p>     <code>BpfCircuitConstructor</code>,     <code>doMemLoad</code>, <code>doMemStore</code>  <code>resolveSymbol</code>:</p><br>
<pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">BpfCircuitConstructor</span> </span>{
<span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LdStType</span>(<span class="hljs-params">val lgsize: <span class="hljs-type">Int</span></span>) </span>{
    <span class="hljs-keyword">val</span> byteSize = <span class="hljs-number">1</span> &lt;&lt; lgsize
    <span class="hljs-keyword">val</span> bitSize = byteSize * <span class="hljs-number">8</span>
    <span class="hljs-keyword">val</span> mask: <span class="hljs-type">UInt</span> = <span class="hljs-keyword">if</span> (bitSize == <span class="hljs-number">64</span>) mask64 <span class="hljs-keyword">else</span> ((<span class="hljs-number">1</span>l &lt;&lt; bitSize) - <span class="hljs-number">1</span>).<span class="hljs-type">U</span><font></font>
  }<font></font>
  <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">u8</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title">LdStType</span>(<span class="hljs-params">0</span>)</span>
  <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">u16</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LdStType</span>(<span class="hljs-params">1</span>)</span>
  <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">u32</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LdStType</span>(<span class="hljs-params">2</span>)</span>
  <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">u64</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LdStType</span>(<span class="hljs-params">3</span>)</span><font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">doMemLoad</span></span>(addr: <span class="hljs-type">UInt</span>, tpe: <span class="hljs-type">LdStType</span>, valid: <span class="hljs-type">Bool</span>): (<span class="hljs-type">UInt</span>, <span class="hljs-type">Bool</span>)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">doMemStore</span></span>(addr: <span class="hljs-type">UInt</span>, tpe: <span class="hljs-type">LdStType</span>, data: <span class="hljs-type">UInt</span>, valid: <span class="hljs-type">Bool</span>): <span class="hljs-type">Bool</span><font></font>
<font></font>
  <span class="hljs-keyword">sealed</span> <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Resolved</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">asPlainValue</span></span>: <span class="hljs-type">UInt</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load</span></span>(ctx: <span class="hljs-type">Context</span>, offset: <span class="hljs-type">Int</span>, tpe: <span class="hljs-type">LdStType</span>, valid: <span class="hljs-type">Bool</span>): <span class="hljs-type">LazyData</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">store</span></span>(offset: <span class="hljs-type">Int</span>, tpe: <span class="hljs-type">LdStType</span>, data: <span class="hljs-type">UInt</span>, valid: <span class="hljs-type">Bool</span>): <span class="hljs-type">Bool</span><font></font>
  }<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolveSymbol</span></span>(sym: <span class="hljs-type">BpfLoader</span>.<span class="hljs-type">Symbol</span>): <span class="hljs-type">Resolved</span>
<span class="hljs-comment">// ...</span>
}</code></pre><br>
<h2 id="integraciya-s-processornym-yadrom">   </h2><br>
<p>      :        RoCC (Rocket Custom Coprocessor).   ,       RISC-V- ,    Rocket  BOOM (Berkeley Out-of-Order Machine),     upstream   ,       <code>custom0</code> — <code>custom3</code>,    .</p><br>
<p>  ,     Rocket/BOOM     RoCC ,   ,    :</p><br>
<p><strong>Configs.scala:</strong></p><br>
<pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WithRoccExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Config</span>(<span class="hljs-params">(site, here, up</span>) <span class="hljs-title">=&gt;</span> </span>{
  <span class="hljs-keyword">case</span> <span class="hljs-type">BuildRoCC</span> =&gt; <span class="hljs-type">List</span>(<font></font>
    (p: <span class="hljs-type">Parameters</span>) =&gt; {
        <span class="hljs-keyword">val</span> accumulator = <span class="hljs-type">LazyModule</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">AccumulatorExample</span>(<span class="hljs-type">OpcodeSet</span>.custom0, n = <span class="hljs-number">4</span>)(p))<font></font>
        accumulator<font></font>
    },<font></font>
    (p: <span class="hljs-type">Parameters</span>) =&gt; {
        <span class="hljs-keyword">val</span> translator = <span class="hljs-type">LazyModule</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">TranslatorExample</span>(<span class="hljs-type">OpcodeSet</span>.custom1)(p))<font></font>
        translator<font></font>
    },<font></font>
    (p: <span class="hljs-type">Parameters</span>) =&gt; {
        <span class="hljs-keyword">val</span> counter = <span class="hljs-type">LazyModule</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">CharacterCountExample</span>(<span class="hljs-type">OpcodeSet</span>.custom2)(p))<font></font>
        counter<font></font>
    })<font></font>
})</code></pre><br>
<p>     <code>LazyRoCC.scala</code>.</p><br>
<p>          :         <code>LazyRoCC</code>,  —  <code>LazyRoCCModuleImp</code>.     <code>io</code>  <code>RoCCIO</code>,      <code>cmd</code>,   <code>resp</code>,    L1D- <code>mem</code>,  <code>busy</code>  <code>interrupt</code>   <code>exception</code>.    page table walker  FPU,  , ,    (   eBPF   ).           -,  <code>interrupt</code>    .  ,   ,  TileLink-     ,         .</p><br>
<h2 id="uporyadochivatel-zaprosov"> </h2><br>
<p>,        ,   .    ,  , ,  -  (  -      )   -   , ,   .   ,       . ,          , ,   ,  , ,     (,  ,    ), -  <strong></strong>    (    )   .    - ,  «»       .</p><br>
<p>   :       (7-  <code>funct</code>   RoCC)     (      ,       ,      ,   Fmax,  , ).    «»/«»   .    ,  .           —     <strong>  </strong>. ,       (  , ,    ,     ,  ,   —       - ).    <code>PeekPokeTester</code>  -      .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">- </a>.</p><br>
<p>   :</p><br>
<pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Serializer</span>(<span class="hljs-params">isComputing: <span class="hljs-type">Bool</span>, next: <span class="hljs-type">Bool</span></span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">monotonic</span></span>(x: <span class="hljs-type">Bool</span>): <span class="hljs-type">Bool</span> = {
    <span class="hljs-keyword">val</span> res = <span class="hljs-type">WireInit</span>(<span class="hljs-literal">false</span>.<span class="hljs-type">B</span>)
    <span class="hljs-keyword">val</span> prevRes = <span class="hljs-type">RegInit</span>(<span class="hljs-literal">false</span>.<span class="hljs-type">B</span>)<font></font>
    prevRes := res &amp;&amp; isComputing<font></font>
    res := (x || prevRes) &amp;&amp; isComputing<font></font>
    res<font></font>
  }<font></font>
  <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">noone</span></span>(bs: <span class="hljs-type">Seq</span>[<span class="hljs-type">Bool</span>]): <span class="hljs-type">Bool</span> = !bs.foldLeft(<span class="hljs-literal">false</span>.<span class="hljs-type">B</span>)(_ || _)<font></font>
<font></font>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> previousReqs = <span class="hljs-type">ArrayBuffer</span>[<span class="hljs-type">Bool</span>]()
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">nextReq</span></span>(x: <span class="hljs-type">Bool</span>): (<span class="hljs-type">Bool</span>, <span class="hljs-type">Int</span>) = {
    <span class="hljs-keyword">val</span> enable = monotonic(x)
    <span class="hljs-keyword">val</span> result = <span class="hljs-type">RegInit</span>(<span class="hljs-literal">false</span>.<span class="hljs-type">B</span>)
    <span class="hljs-keyword">val</span> retired = <span class="hljs-type">RegInit</span>(<span class="hljs-literal">false</span>.<span class="hljs-type">B</span>)
    <span class="hljs-keyword">val</span> doRetire = result &amp;&amp; next
    <span class="hljs-keyword">val</span> thisReq = enable &amp;&amp; !retired &amp;&amp; !doRetire
    <span class="hljs-keyword">val</span> reqWon = thisReq &amp;&amp; noone(previousReqs)<font></font>
    when (isComputing) {<font></font>
      when(reqWon) {<font></font>
        result := <span class="hljs-literal">true</span>.<span class="hljs-type">B</span><font></font>
      }<font></font>
      when(doRetire) {<font></font>
        result := <span class="hljs-literal">false</span>.<span class="hljs-type">B</span>
        retired := <span class="hljs-literal">true</span>.<span class="hljs-type">B</span><font></font>
      }<font></font>
    } otherwise {<font></font>
      result := <span class="hljs-literal">false</span>.<span class="hljs-type">B</span>
      retired := <span class="hljs-literal">false</span>.<span class="hljs-type">B</span><font></font>
    }<font></font>
    previousReqs += thisReq<font></font>
    (result, previousReqs.length - <span class="hljs-number">1</span>)<font></font>
  }<font></font>
}</code></pre><br>
<p> ,            Scala.  ,    <code>ArrayBuffer</code>,      (<code>Boolean</code> —   Scala, <code>Bool</code> —  ,  « »,   -     boolean).</p><br>
<h2 id="rabota-s-l1d-keshom">  L1D-</h2><br>
<p>          <code>io.mem.req</code>    <code>io.mem.resp</code>.        <code>ready</code>  <code>valid</code>:       ,     ,        ,   <code>valid &amp;&amp; resp</code>   .       «»      <code>true</code>      <code>valid &amp;&amp; resp</code> (       <code>fire()</code>).</p><br>
<p>  <code>resp</code>,   ,    <code>valid</code>,          :    « »,  <code>fire()</code>   <code>valid</code>.</p><br>
<p>,    ,     :   ---,     ,          - .       <code>Serializer</code>,       ,       : <code>next = io.mem.req.fire()</code>.    ,   «»   ,     —     .      <code>holdUnless</code>.      :</p><br>
<pre><code class="scala hljs">  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Constructor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BpfCircuitConstructor</span> </span>{
    <span class="hljs-keyword">val</span> serializer = <span class="hljs-keyword">new</span> <span class="hljs-type">Serializer</span>(isComputing, io.mem.req.fire())
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">doMemLoad</span></span>(addr: <span class="hljs-type">UInt</span>, tpe: <span class="hljs-type">LdStType</span>, valid: <span class="hljs-type">Bool</span>): (<span class="hljs-type">UInt</span>, <span class="hljs-type">Bool</span>) = {
      <span class="hljs-keyword">val</span> (doReq, thisTag) = serializer.nextReq(valid)<font></font>
      when (doReq) {<font></font>
        io.mem.req.bits.addr := addr<font></font>
        require((<span class="hljs-number">1</span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag)<font></font>
        io.mem.req.bits.tag := thisTag.<span class="hljs-type">U</span>
        io.mem.req.bits.cmd := <span class="hljs-type">M_XRD</span>
        io.mem.req.bits.typ := (<span class="hljs-number">4</span> | tpe.lgsize).<span class="hljs-type">U</span>
        io.mem.req.bits.data := <span class="hljs-number">0.</span><span class="hljs-type">U</span>
        io.mem.req.valid := <span class="hljs-literal">true</span>.<span class="hljs-type">B</span><font></font>
      }<font></font>
<font></font>
      <span class="hljs-keyword">val</span> doResp = isComputing &amp;&amp;<font></font>
        serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) &amp;&amp;<font></font>
        io.mem.resp.valid &amp;&amp;<font></font>
        io.mem.resp.bits.tag === thisTag.<span class="hljs-type">U</span> &amp;&amp;<font></font>
        io.mem.resp.bits.cmd === <span class="hljs-type">M_XRD</span><font></font>
<font></font>
      (io.mem.resp.bits.data holdUnless doResp, serializer.monotonic(doResp))<font></font>
    }<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">doMemStore</span></span>(addr: <span class="hljs-type">UInt</span>, tpe: <span class="hljs-type">LdStType</span>, data: <span class="hljs-type">UInt</span>, valid: <span class="hljs-type">Bool</span>): <span class="hljs-type">Bool</span> = {
      <span class="hljs-keyword">val</span> (doReq, thisTag) = serializer.nextReq(valid)<font></font>
      when (doReq) {<font></font>
        io.mem.req.bits.addr := addr<font></font>
        require((<span class="hljs-number">1</span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag)<font></font>
        io.mem.req.bits.tag := thisTag.<span class="hljs-type">U</span>
        io.mem.req.bits.cmd := <span class="hljs-type">M_XWR</span>
        io.mem.req.bits.typ := (<span class="hljs-number">4</span> | tpe.lgsize).<span class="hljs-type">U</span><font></font>
        io.mem.req.bits.data := data<font></font>
        io.mem.req.valid := <span class="hljs-literal">true</span>.<span class="hljs-type">B</span><font></font>
      }<font></font>
      serializer.monotonic(doReq &amp;&amp; io.mem.req.fire())<font></font>
    }<font></font>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolveSymbol</span></span>(sym: <span class="hljs-type">BpfLoader</span>.<span class="hljs-type">Symbol</span>): <span class="hljs-type">Resolved</span> = sym <span class="hljs-keyword">match</span> {
      <span class="hljs-keyword">case</span> <span class="hljs-type">BpfLoader</span>.<span class="hljs-type">Symbol</span>(symName, _, size, <span class="hljs-type">ElfConstants</span>.<span class="hljs-type">Elf64_Shdr</span>.<span class="hljs-type">SHN_COMMON</span>, <span class="hljs-literal">false</span>) <span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">8</span> =&gt;
        <span class="hljs-type">RegisterReference</span>(regs.getOrElseUpdate(symName, <span class="hljs-type">RegInit</span>(<span class="hljs-number">0.</span><span class="hljs-type">U</span>(<span class="hljs-number">64.</span><span class="hljs-type">W</span>))))<font></font>
    }<font></font>
  }</code></pre><br>
<p>       .</p><br>
<h2 id="ne-vsyo-to-v-kuche-chto-globalnaya-peremennaya">    ,   </h2><br>
<p>,    ?      ? ,  AFL!       :</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint8_t</span> *__afl_area_ptr;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">uint64_t</span> prev;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">inst_branch</span><span class="hljs-params">(<span class="hljs-keyword">uint64_t</span> tag)</span>
</span>{<font></font>
    __afl_area_ptr[((prev &gt;&gt; <span class="hljs-number">1</span>) ^ tag) &amp; <span class="hljs-number">0xFFFF</span>] += <span class="hljs-number">1</span>;<font></font>
    prev = tag;<font></font>
}</code></pre><br>
<p>  ,    -     (   — )    <code>__afl_area_ptr</code>,     <code>prev</code> -  !</p><br>
<p>      <code>Resolved</code>:       ,      .  ,         1, 2, 4  8 ,     ,         .      ,  <code>prev</code>         ,    .</p><br>
<h2 id="a-teper-instrumentaciya">  </h2><br>
<p> -      -     RoCC.   ?      ,    ?  ,    ,               <code>funct</code>.  ,     :     SignalTap,      ,          (   bootrom —   ) —   .</p><br>
<p>        «»     ,         ,      RoCC   ,   long latency    ,        .</p><br>
<p>  ,   —   ([   ], [ ,   data path  ]). , <code>default</code> ( )   (    <code>IDecode.scala</code>,    ,  , ):</p><br>
<pre><code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">default</span></span>: <span class="hljs-type">List</span>[<span class="hljs-type">BitPat</span>] =
                <span class="hljs-comment">//           jal                                                                   renf1             fence.i</span>
                <span class="hljs-comment">//   val     | jalr                                                                | renf2           |</span>
                <span class="hljs-comment">//   | fp_val| | renx2                                                             | | renf3         |</span>
                <span class="hljs-comment">//   | | rocc| | | renx1       s_alu1                          mem_val             | | | wfd         |</span>
                <span class="hljs-comment">//   | | | br| | | |   s_alu2  |       imm    dw     alu       | mem_cmd   mem_type| | | | mul       |</span>
                <span class="hljs-comment">//   | | | | | | | |   |       |       |      |      |         | |           |     | | | | | div     | fence</span>
                <span class="hljs-comment">//   | | | | | | | |   |       |       |      |      |         | |           |     | | | | | | wxd   | | amo</span>
                <span class="hljs-comment">//   | | | | | | | | scie      |       |      |      |         | |           |     | | | | | | |     | | | dp</span>
                <span class="hljs-type">List</span>(<span class="hljs-type">N</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">A2_X</span>,   <span class="hljs-type">A1_X</span>,   <span class="hljs-type">IMM_X</span>, <span class="hljs-type">DW_X</span>,  <span class="hljs-type">FN_X</span>,     <span class="hljs-type">N</span>,<span class="hljs-type">M_X</span>,        <span class="hljs-type">MT_X</span>, <span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">CSR</span>.<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>,<span class="hljs-type">X</span>)</code></pre><br>
<p>…    <em>  </em>  Rocket core   :</p><br>
<pre><code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IDecode</span>(<span class="hljs-params">implicit val p: <span class="hljs-type">Parameters</span></span>) <span class="hljs-keyword">extends</span> <span class="hljs-title">DecodeConstants</span></span><font></font>
{<font></font>
  <span class="hljs-keyword">val</span> table: <span class="hljs-type">Array</span>[(<span class="hljs-type">BitPat</span>, <span class="hljs-type">List</span>[<span class="hljs-type">BitPat</span>])] = <span class="hljs-type">Array</span>(
    <span class="hljs-type">BNE</span>-&gt;       <span class="hljs-type">List</span>(<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">A2_RS2</span>, <span class="hljs-type">A1_RS1</span>, <span class="hljs-type">IMM_SB</span>,<span class="hljs-type">DW_X</span>,  <span class="hljs-type">FN_SNE</span>,   <span class="hljs-type">N</span>,<span class="hljs-type">M_X</span>,        <span class="hljs-type">MT_X</span>, <span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">CSR</span>.<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>),
    <span class="hljs-type">BEQ</span>-&gt;       <span class="hljs-type">List</span>(<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">A2_RS2</span>, <span class="hljs-type">A1_RS1</span>, <span class="hljs-type">IMM_SB</span>,<span class="hljs-type">DW_X</span>,  <span class="hljs-type">FN_SEQ</span>,   <span class="hljs-type">N</span>,<span class="hljs-type">M_X</span>,        <span class="hljs-type">MT_X</span>, <span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">CSR</span>.<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>),
    <span class="hljs-type">BLT</span>-&gt;       <span class="hljs-type">List</span>(<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">A2_RS2</span>, <span class="hljs-type">A1_RS1</span>, <span class="hljs-type">IMM_SB</span>,<span class="hljs-type">DW_X</span>,  <span class="hljs-type">FN_SLT</span>,   <span class="hljs-type">N</span>,<span class="hljs-type">M_X</span>,        <span class="hljs-type">MT_X</span>, <span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">CSR</span>.<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>),
    <span class="hljs-type">BLTU</span>-&gt;      <span class="hljs-type">List</span>(<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">A2_RS2</span>, <span class="hljs-type">A1_RS1</span>, <span class="hljs-type">IMM_SB</span>,<span class="hljs-type">DW_X</span>,  <span class="hljs-type">FN_SLTU</span>,  <span class="hljs-type">N</span>,<span class="hljs-type">M_X</span>,        <span class="hljs-type">MT_X</span>, <span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">CSR</span>.<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>),
    <span class="hljs-type">BGE</span>-&gt;       <span class="hljs-type">List</span>(<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">A2_RS2</span>, <span class="hljs-type">A1_RS1</span>, <span class="hljs-type">IMM_SB</span>,<span class="hljs-type">DW_X</span>,  <span class="hljs-type">FN_SGE</span>,   <span class="hljs-type">N</span>,<span class="hljs-type">M_X</span>,        <span class="hljs-type">MT_X</span>, <span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">CSR</span>.<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>),
    <span class="hljs-type">BGEU</span>-&gt;      <span class="hljs-type">List</span>(<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">Y</span>,<span class="hljs-type">N</span>,<span class="hljs-type">A2_RS2</span>, <span class="hljs-type">A1_RS1</span>, <span class="hljs-type">IMM_SB</span>,<span class="hljs-type">DW_X</span>,  <span class="hljs-type">FN_SGEU</span>,  <span class="hljs-type">N</span>,<span class="hljs-type">M_X</span>,        <span class="hljs-type">MT_X</span>, <span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">CSR</span>.<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>,<span class="hljs-type">N</span>),
<span class="hljs-comment">// ...</span></code></pre><br>
<p>  ,   RISC-V (   RocketChip,      )    ISA    I ( ),    M (   ), A (atomics)  ..</p><br>
<p>   </p><br>
<pre><code class="scala hljs">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode</span></span>(inst: <span class="hljs-type">UInt</span>, table: <span class="hljs-type">Iterable</span>[(<span class="hljs-type">BitPat</span>, <span class="hljs-type">List</span>[<span class="hljs-type">BitPat</span>])]) = {
    <span class="hljs-keyword">val</span> decoder = <span class="hljs-type">DecodeLogic</span>(inst, <span class="hljs-keyword">default</span>, table)
    <span class="hljs-keyword">val</span> sigs = <span class="hljs-type">Seq</span>(legal, fp, rocc, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2,<font></font>
                   sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type,<font></font>
                   rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp)<font></font>
    sigs zip decoder map {<span class="hljs-keyword">case</span>(s,d) =&gt; s := d}<font></font>
<font></font>
    <span class="hljs-keyword">this</span>
}</code></pre><br>
<p>  </p><br>
<div class="spoiler"><b class="spoiler_title"> ,          rocc</b><div class="spoiler_text"><pre><code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode</span></span>(inst: <span class="hljs-type">UInt</span>, table: <span class="hljs-type">Iterable</span>[(<span class="hljs-type">BitPat</span>, <span class="hljs-type">List</span>[<span class="hljs-type">BitPat</span>])], handlers: <span class="hljs-type">Seq</span>[<span class="hljs-type">OpcodeHandler</span>]) = {
    <span class="hljs-keyword">val</span> decoder = <span class="hljs-type">DecodeLogic</span>(inst, <span class="hljs-keyword">default</span>, table)
    <span class="hljs-keyword">val</span> sigs=<span class="hljs-type">Seq</span>(legal, fp, rocc_explicit, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2,<font></font>
                   sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type,<font></font>
                   rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp)<font></font>
    sigs zip decoder map {<span class="hljs-keyword">case</span>(s,d) =&gt; s := d}<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (handlers.isEmpty) {<font></font>
      handler_rocc := <span class="hljs-literal">false</span>.<span class="hljs-type">B</span>
      handler_rocc_funct := <span class="hljs-number">0.</span><span class="hljs-type">U</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">val</span> handlerTable: <span class="hljs-type">Seq</span>[(<span class="hljs-type">BitPat</span>, <span class="hljs-type">List</span>[<span class="hljs-type">BitPat</span>])] = handlers.map {
        <span class="hljs-keyword">case</span> <span class="hljs-type">OpcodeHandler</span>(pattern, funct) =&gt; pattern -&gt; <span class="hljs-type">List</span>(<span class="hljs-type">Y</span>, <span class="hljs-type">BitPat</span>(funct.<span class="hljs-type">U</span>))<font></font>
      }<font></font>
      <span class="hljs-keyword">val</span> handlerDecoder = <span class="hljs-type">DecodeLogic</span>(inst, <span class="hljs-type">List</span>(<span class="hljs-type">N</span>, <span class="hljs-type">BitPat</span>(<span class="hljs-number">0.</span><span class="hljs-type">U</span>)), handlerTable)
      <span class="hljs-type">Seq</span>(handler_rocc, handler_rocc_funct) zip handlerDecoder map { <span class="hljs-keyword">case</span> (s,d) =&gt; s:=d }<font></font>
    }<font></font>
<font></font>
    rocc := rocc_explicit || handler_rocc<font></font>
<font></font>
    <span class="hljs-keyword">this</span>
  }</code></pre></div></div><br>
<p>      , ,  :</p><br>
<pre><code class="diff hljs">   io.rocc.exception := wb_xcpt &amp;&amp; csr.io.status.xs.orR<font></font>
   io.rocc.cmd.bits.status := csr.io.status<font></font>
   io.rocc.cmd.bits.inst := new RoCCInstruction().fromBits(wb_reg_inst)<font></font>
<span class="hljs-addition">+  when (wb_ctrl.handler_rocc) {</span>
<span class="hljs-addition">+    io.rocc.cmd.bits.inst.opcode := 0x0b.U // custom0</span>
<span class="hljs-addition">+    io.rocc.cmd.bits.inst.funct := wb_ctrl.handler_rocc_funct</span>
<span class="hljs-addition">+    io.rocc.cmd.bits.inst.xd := false.B</span>
<span class="hljs-addition">+    io.rocc.cmd.bits.inst.rd := 0.U</span>
<span class="hljs-addition">+  }</span><font></font>
   io.rocc.cmd.bits.rs1 := wb_reg_wdata<font></font>
   io.rocc.cmd.bits.rs2 := wb_reg_rs2</code></pre><br>
<p>,        :      ,  <code>funct</code>  ,   .       :   ,         (   —   ?),   ,    ,    <code>opcode == custom0</code> (, ,    !).</p><br>
<h2 id="proverka"></h2><br>
<p>  ,     ,          - production-.  ,       (  )   .   ,    -    :</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdint.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">uint64_t</span> counter;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint64_t</span> <span class="hljs-title">funct1</span><span class="hljs-params">(<span class="hljs-keyword">uint64_t</span> x, <span class="hljs-keyword">uint64_t</span> y)</span>
</span>{
  <span class="hljs-keyword">return</span> __builtin_popcountl(x);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint64_t</span> <span class="hljs-title">funct2</span><span class="hljs-params">(<span class="hljs-keyword">uint64_t</span> x, <span class="hljs-keyword">uint64_t</span> y)</span>
</span>{
  <span class="hljs-keyword">return</span> (x + y) * (x - y);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">uint64_t</span> <span class="hljs-title">instMUL</span><span class="hljs-params">()</span>
</span>{<font></font>
  counter += <span class="hljs-number">1</span>;<font></font>
  *((<span class="hljs-keyword">uint64_t</span> *)<span class="hljs-number">0x81005000</span>) = counter;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br>
<p>   <code>bootrom/sdboot/sd.c</code>  <code>main</code> </p><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"/path/to/freedom-u-sdk/riscv-pk/machine/encoding.h"</span></span><font></font>
<font></font>
<span class="hljs-comment">// ...</span><font></font>
<font></font>
<span class="hljs-comment">////    -   RoCC</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STR1(x) #x</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> STR(x) STR1(x)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> EXTRACT(a, size, offset) (((~(~0 <span class="hljs-meta-string">&lt;&lt; size) &lt;&lt; offset) &amp; a) &gt;&gt; offset)</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CUSTOMX_OPCODE(x) CUSTOM_##x</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CUSTOM_0 0b0001011</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CUSTOM_1 0b0101011</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CUSTOM_2 0b1011011</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CUSTOM_3 0b1111011</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CUSTOMX(X, rd, rs1, rs2, funct) \
  CUSTOMX_OPCODE(X)                   | \
  (rd                   &lt;&lt; (7))       | \
  (0x7                  &lt;&lt; (7+5))     | \
  (rs1                  &lt;&lt; (7+5+3))   | \
  (rs2                  &lt;&lt; (7+5+3+5)) | \
  (EXTRACT(funct, 7, 0) &lt;&lt; (7+5+3+5+5))</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CUSTOMX_R_R_R(X, rd, rs1, rs2, funct)           \
  asm (<span class="hljs-meta-string">"mv a4, %[_rs1]\n\t"</span>                             \
       <span class="hljs-meta-string">"mv a5, %[_rs2]\n\t"</span>                             \
       <span class="hljs-meta-string">".word "</span>STR(CUSTOMX(X, 15, 14, 15, funct))<span class="hljs-meta-string">"\n\t"</span> \
       <span class="hljs-meta-string">"mv %[_rd], a5"</span>                                  \
       : [_rd] <span class="hljs-meta-string">"=r"</span> (rd)                                \
       : [_rs1] <span class="hljs-meta-string">"r"</span> (rs1), [_rs2] <span class="hljs-meta-string">"r"</span> (rs2)             \
       : <span class="hljs-meta-string">"a4"</span>, <span class="hljs-meta-string">"a5"</span>);</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
<span class="hljs-comment">// ...</span><font></font>
<font></font>
  <span class="hljs-comment">//  RoCC extension</span>
  write_csr(mstatus, MSTATUS_XS &amp; (MSTATUS_XS &gt;&gt; <span class="hljs-number">1</span>));<font></font>
<font></font>
  <span class="hljs-comment">//   bootrom      </span>
  <span class="hljs-keyword">uint64_t</span> res;<font></font>
  CUSTOMX_R_R_R(<span class="hljs-number">0</span>, res, <span class="hljs-number">0xabcdef</span>, <span class="hljs-number">0x123456</span>, <span class="hljs-number">1</span>);<font></font>
  CUSTOMX_R_R_R(<span class="hljs-number">0</span>, res, <span class="hljs-number">0xabcdef</span>, <span class="hljs-number">0x123456</span>, <span class="hljs-number">2</span>);<font></font>
<font></font>
  <span class="hljs-comment">// ...    </span>
  <span class="hljs-keyword">uint64_t</span> x = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">123</span>; ++i) x *= *(<span class="hljs-keyword">volatile</span> <span class="hljs-keyword">uint8_t</span> *)<span class="hljs-number">0x80000000</span>;<font></font>
  kputc(<span class="hljs-string">'0'</span> + x % <span class="hljs-number">10</span>); <span class="hljs-comment">//   !!!</span>
<span class="hljs-comment">// ...</span>
}</code></pre><br>
<p> <code>write_csr</code> ,     <code>custom0</code>-<code>custom3</code>.      ,   illegal instruction,  ,  , ,   .   <code>define</code>-     - ,   «» binutils  <code>customX</code>      RocketChip,  ,   ,   .</p><br>
<p>    sdboot  ,       ,      .</p><br>
<p> :</p><br>
<pre><code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q  -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf<font></font>
Reading symbols from builds/zeowaa-e115/sdboot.elf...done.<font></font>
Remote debugging using :3333<font></font>
0x0000000000000000 in ?? ()<font></font>
(gdb) x/d 0x81005000<font></font>
0x81005000:     123<font></font>
(gdb) set variable $pc=0x10000<font></font>
(gdb) c<font></font>
Continuing.<font></font>
^C<font></font>
Program received signal SIGINT, Interrupt.<font></font>
0x0000000000010488 in crc16_round (data=&lt;optimized out&gt;, crc=&lt;optimized out&gt;) at sd.c:151<font></font>
151             crc ^= data;<font></font>
(gdb) x/d 0x81005000<font></font>
0x81005000:     246</code></pre><br>
<div class="spoiler"><b class="spoiler_title"> funct1</b><div class="spoiler_text"><pre><code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q  -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf<font></font>
Reading symbols from builds/zeowaa-e115/sdboot.elf...done.<font></font>
Remote debugging using :3333<font></font>
0x0000000000010194 in main () at sd.c:247<font></font>
247             CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1);<font></font>
(gdb) set variable $a5=0<font></font>
(gdb) set variable $pc=0x10194<font></font>
(gdb) set variable $a4=0xaa<font></font>
(gdb) display/10i $pc-10<font></font>
1: x/10i $pc-10<font></font>
   0x1018a &lt;main+46&gt;:   sw      a3,124(a3)<font></font>
   0x1018c &lt;main+48&gt;:   addiw   a0,a0,1110<font></font>
   0x10190 &lt;main+52&gt;:   mv      a4,s0<font></font>
   0x10192 &lt;main+54&gt;:   mv      a5,a0<font></font>
=&gt; 0x10194 &lt;main+56&gt;:   0x2f7778b<font></font>
   0x10198 &lt;main+60&gt;:   mv      s0,a5<font></font>
   0x1019a &lt;main+62&gt;:   lbu     a5,0(a1)<font></font>
   0x1019e &lt;main+66&gt;:   addiw   a3,a3,-1<font></font>
   0x101a0 &lt;main+68&gt;:   mul     a2,a2,a5<font></font>
   0x101a4 &lt;main+72&gt;:   bnez    a3,0x1019a &lt;main+62&gt;<font></font>
(gdb) display/x $a5<font></font>
2: /x $a5 = 0x0<font></font>
(gdb) si<font></font>
0x0000000000010198      247             CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1);<font></font>
1: x/10i $pc-10<font></font>
   0x1018e &lt;main+50&gt;:   li      a0,25<font></font>
   0x10190 &lt;main+52&gt;:   mv      a4,s0<font></font>
   0x10192 &lt;main+54&gt;:   mv      a5,a0<font></font>
   0x10194 &lt;main+56&gt;:   0x2f7778b<font></font>
=&gt; 0x10198 &lt;main+60&gt;:   mv      s0,a5<font></font>
   0x1019a &lt;main+62&gt;:   lbu     a5,0(a1)<font></font>
   0x1019e &lt;main+66&gt;:   addiw   a3,a3,-1<font></font>
   0x101a0 &lt;main+68&gt;:   mul     a2,a2,a5<font></font>
   0x101a4 &lt;main+72&gt;:   bnez    a3,0x1019a &lt;main+62&gt;<font></font>
   0x101a6 &lt;main+74&gt;:   li      a5,10<font></font>
2: /x $a5 = 0x4<font></font>
(gdb) set variable $a4=0xaabc<font></font>
(gdb) set variable $pc=0x10194<font></font>
(gdb) si<font></font>
0x0000000000010198      247             CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1);<font></font>
1: x/10i $pc-10<font></font>
   0x1018e &lt;main+50&gt;:   li      a0,25<font></font>
   0x10190 &lt;main+52&gt;:   mv      a4,s0<font></font>
   0x10192 &lt;main+54&gt;:   mv      a5,a0<font></font>
   0x10194 &lt;main+56&gt;:   0x2f7778b<font></font>
=&gt; 0x10198 &lt;main+60&gt;:   mv      s0,a5<font></font>
   0x1019a &lt;main+62&gt;:   lbu     a5,0(a1)<font></font>
   0x1019e &lt;main+66&gt;:   addiw   a3,a3,-1<font></font>
   0x101a0 &lt;main+68&gt;:   mul     a2,a2,a5<font></font>
   0x101a4 &lt;main+72&gt;:   bnez    a3,0x1019a &lt;main+62&gt;<font></font>
   0x101a6 &lt;main+74&gt;:   li      a5,10<font></font>
2: /x $a5 = 0x9</code></pre></div></div><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja461565/index.html">TypeScript開発者の5つの戒め</a></li>
<li><a href="../ja461567/index.html">SQL 面白いパズル</a></li>
<li><a href="../ja461569/index.html">フロントエンドに関する注意：テスト前に確認すべきこと</a></li>
<li><a href="../ja461571/index.html">実際のSVG。Yandexレポート</a></li>
<li><a href="../ja461575/index.html">OpenStackと互換性のあるホスティングで3CXクラウドベースのPBXを作成する</a></li>
<li><a href="../ja461579/index.html">WebMoneyは新しいWMPウォレットを導入し、ゲームのルールを変更します</a></li>
<li><a href="../ja461583/index.html">構造製品のテストに役立つPython</a></li>
<li><a href="../ja461587/index.html">10ステップでのアプリケーションのローカリゼーション</a></li>
<li><a href="../ja461589/index.html">チックタックトー：コンテンツサイクル</a></li>
<li><a href="../ja461593/index.html">F＃のAPI。役割ベースのアプリケーションモジュールへのアクセス</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>