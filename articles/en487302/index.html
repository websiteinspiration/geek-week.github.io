<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëåüèæ üíáüèΩ üöï Monitoring errors and events in the PostgreSQL log (grok_exporter) üí∞ üö• üñïüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, colleagues and habretchiki! Today, I would like to share with you a small note on how you can organize operational monitoring of error...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Monitoring errors and events in the PostgreSQL log (grok_exporter)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487302/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Good afternoon, colleagues and habretchiki! </font><font style="vertical-align: inherit;">Today, I would like to share with you a small note on how you can organize operational monitoring of errors and events that appear in the PostgreSQL log using Prometheus and the exporter of metrics grok_exporter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I must say right away that this is of course a special case of using this exporter. </font><font style="vertical-align: inherit;">So why is it needed and who might be interested?</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Who needs this?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If Prometheus is already present in your infrastructure and creating a separate infrastructure for collecting and analyzing logs, such as ELK or Greylog, is expensive and impractical (if there is no Prometheus, it‚Äôs not a problem, it‚Äôs easy and quick to install). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The tool will be useful not only for DBAs, but also for application administrators, in general, for all those who somehow work with application logs. </font><font style="vertical-align: inherit;">It allows you to quickly obtain information about freelance behavior and have a certain reference point for further analysis of the situation.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is all this for?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monitoring logs will allow you to have a more complete picture and respond more quickly to emerging problems, be it: authorization attempts (including unsuccessful ones), various errors, or specific events. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a good list here, formed by event categories (See the Log Event Categories section), it can be used to create rules in Prometheus.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grok_exporter</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The metric exporter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grok_exporter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allows </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">you</font></a><font style="vertical-align: inherit;"> to read unstructured data from the source, converting it to structured data, according to the rules, and give it away as metrics in a format that Prometheus understands. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The exporter was created in the image of a plug-in in ELK </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=http://" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plugins-filters-grok</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which allows you to use a set of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plugins-filters-grok templates</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as they are.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installation is straightforward and simple. </font><font style="vertical-align: inherit;">To do this, just follow the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and download the version you like (and yes they are all pre-release, and the latest versions are still in the release candidate stage) and unzip the resulting archive. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we get the following set:</font></font><br>
<br>
<pre><code class="plaintext hljs">grok_exporter-1.0.0.RC3.linux-amd64<font></font>
‚îú‚îÄ‚îÄ patterns<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ ruby<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ redis<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ rails<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ postgresql<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ nagios<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ mongodb<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ mcollective-patterns<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ mcollective<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ linux-syslog<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ junos<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ java<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ haproxy<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ grok-patterns<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ firewalls<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ exim<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ bro<font></font>
‚îÇ&nbsp;&nbsp; ‚îú‚îÄ‚îÄ bacula<font></font>
‚îÇ&nbsp;&nbsp; ‚îî‚îÄ‚îÄ aws<font></font>
‚îú‚îÄ‚îÄ grok_exporter<font></font>
‚îî‚îÄ‚îÄ example<font></font>
    ‚îú‚îÄ‚îÄ exim-rejected-RCPT-examples.log<font></font>
    ‚îú‚îÄ‚îÄ config.yml<font></font>
    ‚îî‚îÄ‚îÄ config_logstash_http_input_ipv6.yml<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
where:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grok_exporter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - exporter executable</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patterns</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - contains a set of patterns</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">example</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - contains a test data set and an example configuration file</font></font></li>
</ul><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To start the exporter, just run the executable file. </font><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">config.yml</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configuration </font><b><font style="vertical-align: inherit;">file</font></b><font style="vertical-align: inherit;"> is searched in the directory from where the application is launched or its location is specified by the </font><b><font style="vertical-align: inherit;">-config</font></b><font style="vertical-align: inherit;"> option</font></font><b><font style="vertical-align: inherit;"></font></b></p><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Setup and preparation for work</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></h3><br>
<p>,      PostgreSQL.  :</p><br>
<ol>
<li>     grok_exporter    .    ,   pg_reload_conf. <br>
<br>
<ul>
<li> <pre><code class="sql hljs"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_directory <span class="hljs-keyword">to</span> <span class="hljs-string">'/var/log/postgresql'</span>; </code></pre></li>
<li> <pre><code class="sql hljs"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_file_mode <span class="hljs-keyword">to</span> <span class="hljs-string">'0644'</span>;</code></pre> </li>
</ul></li>
<li> log_line_prefix,  .      ,    .  : <br>
<br>
<pre><code class="sql hljs"> <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> log_line_prefix <span class="hljs-keyword">to</span> <span class="hljs-string">'%t datname:%d,client:%h,app:%a,usename:%u,session:%c '</span>;</code></pre></li>
</ol><br>
<h3>grok_exporter</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we will edit the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patterns / postgresql</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> template </font><font style="vertical-align: inherit;">in accordance with the format of our log file and add auxiliary constructions. </font><font style="vertical-align: inherit;">I emphasize once again that the syntax of the templates is fully consistent with that used in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plugins-filters-grok</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , therefore, for all issues related to the syntax, you can and should go to its documentation. </font><font style="vertical-align: inherit;">So, let's bring our template for PostgreSQL to the form (the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patterns / grok-patterns</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">already contains a large set of basic templates):</font></font><br>
<br>
<pre><code class="plaintext hljs">#     - postgresql<font></font>
PG_TIMESTAMP %{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{HOUR}:%{MINUTE}:%{SECOND} [A-Z]{3,4}<font></font>
<font></font>
#    <font></font>
PG_ERROR_PATTERN (ERROR|WARNING|FATAL|PANIC)<font></font>
<font></font>
# log_line_prefix   - PostgreSQL<font></font>
PG_PREFIX %{PG_TIMESTAMP} datname:(%{DATA:datname})?,client:(%{DATA:client_host})?,app:(%{DATA:app_name})?,usename:(%{USER:usename})?,session:(%{DATA:session})?<font></font>
<font></font>
#    log_level     <font></font>
PG_ERROR_LEVEL %{PG_ERROR_PATTERN:log_level}:<font></font>
<font></font>
#    <font></font>
PG_EVENT_AUTH LOG:  connection authorized:<font></font>
<font></font>
#      SIGHUP,   <font></font>
PG_EVENT_RELOAD LOG:  received SIGHUP, reloading configuration files<font></font>
</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The design </font></font><code>()?</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to indicate that the value is optional.</font></font></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here, in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sufficient detail, with examples, the process of creating a configuration file is described. </font><font style="vertical-align: inherit;">Below, only what will be used is given.</font></font></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A brief description of the configuration file (from the documentation)</font></font></b>
                        <div class="spoiler_text">      YAML     :<br>
<br>
<ol>
<li><b>global</b> ‚Äî  <br>
<ul>
<li><b>config_version</b> ‚Äî   .    grok_exporter,   ‚â• 1.0.0.RC3,   3<br>
 <b>retention_check_interval</b> ‚Äî    .    ,   .<br>
</li>
</ul><br>
</li>
<li><b>input</b> ‚Äî         .<br>
<br>
<ul>
<li><b>type</b> ‚Äî   .  : file, stdin, webhook.   ,    <b>file</b>;</li>
<li><b>path|paths</b> ‚Äî c      -(-).   ;</li>
<li><b>readall</b> ‚Äî ,       .<br>
  <b>true</b> ‚Äî     ,     .       Prometheus . <br>
  <b>false</b> ‚Äî      ,        grok_exporter;</li>
<li><b>fail_on_missing_logfile</b> ‚Äî       -.  <b>true</b> ‚Äî    ,    ;</li>
</ul></li>
<li><b>imports</b> ‚Äî ,   ,          .    2,    ,   <b>grok</b>.<br>
<br>
<ul>
<li><b>type</b> ‚Äî     <b>grok_patterns</b> ()  metrics ();</li>
<li><b>file|dir</b> ‚Äî  .          , .</li>
</ul><br>
</li>
<li><b>grok_patterns</b> ‚Äî ,         .</li>
<li><b>metrics</b> ‚Äî    .   ‚Äî counter, gauge, histogram, or summary.</li>
<li><b>server</b> ‚Äî    <br>
<br>
<pre><code class="plaintext hljs">  protocol: https<font></font>
  host: localhost<font></font>
  port: 9144<font></font>
  path: /metrics<font></font>
  cert: /path/to/cert<font></font>
  key: /path/to/key<font></font>
</code></pre><br>
 </li>
</ol><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the syntax of the 3rd version of the configuration file, it became possible to import metrics from individual files, this will allow you to group metrics by purpose. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, create the base </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">config.yml</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configuration </font><b><font style="vertical-align: inherit;">file</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In it, we: set the path to the PostgreSQL log files by mask; </font><font style="vertical-align: inherit;">import templates from the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patterns</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory </font><font style="vertical-align: inherit;">and metrics from the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">metrics.d</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory </font><font style="vertical-align: inherit;">; </font><font style="vertical-align: inherit;">we indicate by what protocol and on which port it is necessary to apply for metrics.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">config.yml</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">  config_version: 3<font></font>
  retention_check_interval: 10s<font></font>
input:<font></font>
  type: file<font></font>
  path: /var/log/postgresql/postgresql-*.log<font></font>
  readall: false<font></font>
imports:<font></font>
- type: grok_patterns<font></font>
  dir: ./patterns<font></font>
- type: metrics<font></font>
  dir: ./metrics.d<font></font>
server:<font></font>
  protocol: http<font></font>
  port: 9144<font></font>
</code></pre><br>
</div>
                    </div><br>
<p>,   <b>metrics.d</b>      <b>postgresql.yml</b>,       .<br>
<br>
 ,       , ..       (  retention, - 2  30 )    ,    .        <b>retention_check_interval</b>.<br>
<br>
 ,  :<br>
<br>
</p><ul>
<li>       ,        ;</li>
<li>     ‚Äî   GAUGE  COUNTER,   . ..     GAUGE,         ;</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If cumulative is set to true, the values ‚Äã‚Äãof the metrics with the same set of labels will be summed, which is the expected behavior. </font><font style="vertical-align: inherit;">An unexpected situation may arise when, at the second request, you can get the sum of the values ‚Äã‚Äãin the request plus the previous value.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If cumulative is set to false, if there are metrics with the same set of labels, only the last value will be displayed;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turned out a lot of letters, confusing and incomprehensible in places, but I will try to disclose this in the examples below. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so, we have a configuration file that can return four metrics, three counters and one arbitrary value. </font><font style="vertical-align: inherit;">In fact, the first three consider the number of matches of the match template field with the strings received from the source, the fourth - displays the sum of the values.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgresql.yaml</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">#  - <font></font>
- type:   counter<font></font>
  name:   pg_grok_error_count<font></font>
  help:   Count of line error<font></font>
  match:  '%{PG_PREFIX} %{PG_ERROR_LEVEL}  %{GREEDYDATA:message}'<font></font>
  labels:<font></font>
    log_level:   '{{.log_level}}'<font></font>
    usename:     '{{.usename}}'<font></font>
    datname:     '{{.datname}}'<font></font>
    app_name:    '{{.app_name}}'<font></font>
    client_host: '{{.client_host}}'<font></font>
    message:     '{{.message}}'<font></font>
<font></font>
#   <font></font>
- type:   counter<font></font>
  name:   pg_grok_auth_succes_count<font></font>
  help:   Count of connections authorized<font></font>
  match:  '%{PG_PREFIX} %{PG_EVENT_AUTH}'<font></font>
  labels:<font></font>
    usename:     '{{.usename}}'<font></font>
    datname:     '{{.datname}}'<font></font>
    app_name:    '{{.app_name}}'<font></font>
    client_host: '{{.client_host}}'<font></font>
<font></font>
#   <font></font>
- type:   counter<font></font>
  name:   pg_grok_reload_conf_count<font></font>
  help:   Count of call pg_reload_conf<font></font>
  match:  '%{PG_PREFIX} %{PG_EVENT_RELOAD}'<font></font>
  labels:<font></font>
    session:     '{{.session}}'<font></font>
<font></font>
#   <font></font>
- type:       gauge<font></font>
  name:       pg_grok_tpm_file_size_bytes<font></font>
  help:       Size of tmp file created by time<font></font>
  match:      '%{PG_PREFIX} %{PG_EVENT_TMP_FILE}'<font></font>
  value:      '{{.size}}'<font></font>
  cumulative: true<font></font>
  retention:  5s<font></font>
  labels:<font></font>
    static:     'temp_file'<font></font>
</code></pre><br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Practice</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_error_count</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The metric counts the number of events ERROR, WARNING, FATAL and PANIC, according to the pattern. </font><font style="vertical-align: inherit;">It can be useful for monitoring and warning in case of emergency. </font><font style="vertical-align: inherit;">For example, you can configure an alert in the following cases: attempts of unsuccessful authorization, exceeding the threshold of the number of errors per unit of time, or when the database is in a recovery state after a failure, and much more ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Log Event Categories</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we‚Äôll set up an alert about failed authorization attempts. </font><font style="vertical-align: inherit;">An example of an unsuccessful login attempt in the PostgreSQL log file looks like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-20 23:34:53 AEST datname:test,client:127.0.0.1,app:[unknown],usename:test_user,session:5e9da4fd.733 FATAL:  password authentication failed for user "test_user"<font></font>
2020-04-20 23:34:53 AEST datname:test,client:127.0.0.1,app:[unknown],usename:test_user,session:5e9da4fd.733 DETAIL:  Password does not match for user "test_user".<font></font>
        Connection matched pg_hba.conf line 86: "host    all             all             127.0.0.1/32            md5"<font></font>
</code></pre><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the output of grok_exporter, failed authentication attempts can be identified by the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">message</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> label </font><font style="vertical-align: inherit;">containing the substring </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">password authentication failed for ...</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
</p><pre><code class="plaintext hljs">pg_grok_error_count{app_name="[unknown]",client_host="127.0.0.1",datname="postgres",log_level="FATAL",message="password authentication failed for user "postgres"", usename="postgres"} 15<font></font>
pg_grok_error_count{app_name="[unknown]",client_host="127.0.0.1",datname="test",log_level="FATAL",message="password authentication failed for user \"test_user\"",usename="test_user"} 5<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The data obtained will help to formulate a rule for Prometheus. </font><font style="vertical-align: inherit;">Sensitivity can be adjusted based on your own realities.</font></font><br>
<br>
<pre><code class="plaintext hljs">groups:<font></font>
- name: AuthAlert<font></font>
  rules:<font></font>
  - alert: AuthFail<font></font>
    expr: sum(rate(pg_grok_error_count{message=~"password authentication failed for user.*"}[1m])) by (instance) &gt; 0.1<font></font>
    for: 30s<font></font>
    labels:<font></font>
      severity: warning<font></font>
    annotations:<font></font>
      summary: Too many fail authorization for {{ $labels.instance }}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_reload_conf_count</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Similarly, you can track the execution of the pg_reload_conf command. </font><font style="vertical-align: inherit;">Moreover, it is worth paying attention to the list of labels, or rather, the fact that only one session label is used. </font><font style="vertical-align: inherit;">This is due to the fact that the event is created as part of the server process, and not the user session. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the PostgreSQL log file, this event looks like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-21 01:20:26 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  received SIGHUP, reloading configuration files
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Those. </font><font style="vertical-align: inherit;">it can be seen that the labels used in the previous example are empty. </font><font style="vertical-align: inherit;">In this case, we will use the session identifier for identification, and it will not change until the instance of PostgreSQL is stopped or restarted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A similar situation will be for other similar cases, for example, stopping an instance:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-21 01:32:52 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  received fast shutdown request<font></font>
2020-04-21 01:32:53 AEST datname:,client:,app:,usename:,session:5e9d9371.564 LOG:  database system is shut down<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the output of grok_exporter, we get:</font></font><br>
<br>
<pre><code class="plaintext hljs"># HELP pg_grok_reload_conf_count Count of call pg_reload_conf<font></font>
# TYPE pg_grok_reload_conf_count counter<font></font>
pg_grok_reload_conf_count{session="5e9d9371.564"} 5<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The rule for notification, there is no point in bringing it up, it will be similar to that discussed above.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_grok_tpm_file_size_bytes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I‚Äôll immediately make a reservation that this example is from the category of ‚Äúspherical horse in a vacuum‚Äù and is given to a greater extent in order to show how you can change the behavior of metrics. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The behavior of </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gauge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> metrics can be influenced by changing the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retention</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cumulative</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameters </font><font style="vertical-align: inherit;">. Indeed, unlike a regular counter, which considers the number of lines matching the match pattern, gauge allows you to operate on data from the log file. It turns out that we can accumulate it by increasing or decreasing by the obtained value, or use it as an arbitrarily changing value. Thus, in the first case, we will be interested in the magnitude of the increment, in the second - the value in itself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at a few examples:</font></font><br>
<br>
<ol>
<li>    ,     (<b>cumulative: true</b>).      ,    ,     .     ,  <b>retention_check_interval + retention &lt;= scrape_interval</b> ‚Äî        Prometheus.<br>
<br>
        - PostgreSQL  :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 02:51:15 AEST datname:,client:,app:,usename:,session:5e9dd2f3.1278 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4728.0", size 46931968<font></font>
2020-04-21 02:51:15 AEST datname:,client:,app:,usename:,session:5e9dd2f3.1279 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4729.0", size 46276608<font></font>
2020-04-21 02:51:15 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.14", size 47194112<font></font>
</code></pre><br>
,      :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.40402688e+08
</code></pre><br>
               .<br>
<br>
,       :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.1911168e+07
</code></pre><br>
     :      ,    .</li>
<li><p> ,       ,       (<b>retention</b>)    (<b>cumulative: true</b>)<br>
    ,  - PostgreSQL :</p><br>
<pre><code class="plaintext hljs">2020-04-21 03:03:40 AEST datname:,client:,app:,usename:,session:5e9dd5dc.12c6 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4806.0", size 46260224<font></font>
2020-04-21 03:03:40 AEST datname:,client:,app:,usename:,session:5e9dd5dc.12c5 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4805.0", size 46833664<font></font>
2020-04-21 03:03:40 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.15", size 47316992<font></font>
</code></pre><br>
   :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 1.40402688e+08
</code></pre><br>
   ,  . :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 03:10:40 AEST datname:,client:,app:,usename:,session:5e9dd76e.1325 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4901.0", size 46776320<font></font>
2020-04-21 03:10:40 AEST datname:,client:,app:,usename:,session:5e9dd76e.1324 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4900.0", size 45768704<font></font>
2020-04-21 03:10:40 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.18", size 47841280<font></font>
</code></pre><br>
    :<br>
<br>
<pre><code class="plaintext hljs">pg_grok_tpm_file_size_bytes{static="temp_file"} 2.80772608e+08
</code></pre><br>
          ,     .       ,    .</li>
<li>     ,   <b>cumulative</b>  <b>false</b>    ,  .<br>
<br>
  :<br>
<br>
<pre><code class="plaintext hljs">2020-04-21 03:41:04 AEST datname:,client:,app:,usename:,session:5e9ddea4.1393 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp5011.0", size 11763712<font></font>
2020-04-21 03:41:04 AEST datname:,client:,app:,usename:,session:5e9ddea4.1392 LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp5010.0", size 11501568<font></font>
2020-04-21 03:41:04 AEST datname:postgres,client:[local],app:psql,usename:postgres,session:5e9dc0a8.112c LOG:  temporary file: path "base/pgsql_tmp/pgsql_tmp4396.19", size 11911168<font></font>
</code></pre><br>
 :<br>
<br>
<pre><code class="plaintext hljs"># HELP pg_grok_tpm_file_size_bytes Size of tmp file created by time<font></font>
# TYPE pg_grok_tpm_file_size_bytes gauge<font></font>
pg_grok_tpm_file_size_bytes{static="temp_file"} 1.1911168e+07<font></font>
</code></pre><br>
 ,       .  ,            .</li>
</ol><br>
<h1></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Undoubtedly grok_exporter is the right tool for monitoring applications. </font><font style="vertical-align: inherit;">It allows you to look into the "difficult to access", for monitoring systems, places and enrich the monitoring with additional (control) metrics, while remaining quite simple, functional and lightweight. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, it will be useful for developers as well, since it gives at least indirect access to application logs through a monitoring system. </font><font style="vertical-align: inherit;">Where you can correlate metrics from various sources. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another positive point is that the project is developing and acquires new functionality. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In turn, I hope that this short note will be useful, including for the project itself. </font><font style="vertical-align: inherit;">More stars, more fun work! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thanks to all!</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en487302/">https://habr.com/ru/post/en487302/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487288/index.html">How Atari Challenged Apple to the 1980s Home PC Field</a></li>
<li><a href="../en487290/index.html">Samsung remotely blocks its ‚Äúgray‚Äù Smart TV in Russia. UPD - Samsung Statement</a></li>
<li><a href="../en487294/index.html">Playwright - Microsoft Playwright and New Testing Tool</a></li>
<li><a href="../en487296/index.html">Experience creating a web application with Pony ORM</a></li>
<li><a href="../en487298/index.html">The Impact of Ethernet on Network Technology in 2020</a></li>
<li><a href="../en487308/index.html">Java Records (JEP 359)</a></li>
<li><a href="../en487310/index.html">How to calculate the financial model of a loyalty program</a></li>
<li><a href="../en487314/index.html">The burden of white-collar workers (about discrimination in IT)</a></li>
<li><a href="../en487318/index.html">Introduction to mutual authentication of services in Java with TLS / SSL</a></li>
<li><a href="../en487322/index.html">Visualization of science: illustrations and infographics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>