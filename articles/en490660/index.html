<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëàüèΩ ‚úçüèº üë®‚Äçüë©‚Äçüëß‚Äçüëß How did we ensure the growth of CityMobile ü§¶üèΩ ü§æ üè©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My name is Ivan, I‚Äôm the head of server development in Citimobil. Today I will talk about what this very server development is, what problems we encou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How did we ensure the growth of CityMobile</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/citymobil/blog/490660/"><img src="https://habrastorage.org/webt/zp/vs/q8/zpvsq8dn-snye4kfqv2ktymbip8.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My name is Ivan, I‚Äôm the head of server development in Citimobil. </font><font style="vertical-align: inherit;">Today I will talk about what this very server development is, what problems we encountered and how we plan to develop.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start of growth</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Few people know that CityMobile has existed for a long time, 13 years. Once it was a small company that worked only in Moscow. There were very few developers, and they well knew how the system worked - because they themselves created it. The taxi market was just starting to develop then, the loads were penny. We did not even have the task of providing fault tolerance and scaling.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In 2018, Mail.Ru Group invested in CityMobile, and we began to grow rapidly. There was no time to rewrite the platform, or at least significant refactoring, it was necessary to develop its functional capabilities in order to catch up with our main competitor, and quickly hire people. When I joined the company, only 20 developers were involved in the backend, and almost all of them were on trial. Therefore, we decided to ‚Äúpluck low-hanging fruit‚Äù: to make simple changes that give a huge result. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At that time, we had a monolith in PHP and three services on Go, as well as one master base in MySQL that the monolith was accessing (the services were used as repositories of Redis and EasticSearch). And gradually, with increasing load, heavy system requests began to slow down the base. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What could be done with this?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we took the obvious step: put a slave in production. But if many heavy requests come to him, will he stand it? It was also obvious that with an abundance of requests for analytical reports, the slave would begin to lag. A strong backlog of slaves could adversely affect the performance of the entire CityMobile. As a result, we put another slave for analysts. Its lag never leads to problems on the prod. But even this seemed to us not enough. We wrote a table replicator from MySQL in Clickhouse. And today, analytics lives on its own, using a stack that is more designed for OLAP.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this form, the system worked for some time, then functions began to appear that were more demanding on the hardware. </font><font style="vertical-align: inherit;">There were more and more requests with each week: not even a week passed without a new record. </font><font style="vertical-align: inherit;">In addition, we put a time bomb under our system. </font><font style="vertical-align: inherit;">Previously, we had only one point of failure - the MySQL master base, but with the addition of a slave there were two such points: the master and the slave. </font><font style="vertical-align: inherit;">Failure of any of these machines would lead to a complete failure of the system. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To protect against this, we began to use a local proxy to perform health check slaves. </font><font style="vertical-align: inherit;">This allowed us to use many slaves without changing the code. </font><font style="vertical-align: inherit;">We introduced regular automatic checks of the status of each slave and its general metrics:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">slave lag;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">port availability;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">number of locks, etc.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If a certain threshold is exceeded, the system removes the slave from the load. </font><font style="vertical-align: inherit;">But at the same time, no more than half of the slaves can be withdrawn, so that, due to the increase in the load on the remaining ones, they can‚Äôt arrange a downtime for themselves. </font><font style="vertical-align: inherit;">As a proxy, we used HAProxy and immediately included a plan for switching to ProxySQL in the backlog. </font><font style="vertical-align: inherit;">The choice was somewhat strange, but our admins already had good experience working with HAProxy, and the problem was acute and required an early solution. </font><font style="vertical-align: inherit;">Thus, we created a fail-safe system for slaves, which scaled easily enough. </font><font style="vertical-align: inherit;">For all her simplicity, she never let us down.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further growth</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As the business developed, we found another bottleneck in our system. With changes in external conditions - for example, rainfall began in a large region - the number of taxi orders grew rapidly. In such situations, drivers did not have time to react quickly enough, and there was a shortage of cars. While orders were distributed, they created a load on MySQL slaves in a loop. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We found a successful solution - Tarantool. It was hard to rewrite the system for it, so we solved the problem differently: using the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">mysql-tarantool-replication</font></a><font style="vertical-align: inherit;"> tool</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">made replication of some tables from MySQL to Tarantool. All the reading requests that arose during the shortage of cars, we began to broadcast in Tarantool and since then we are no longer concerned about thunderstorms and hurricanes! And we solved the problem with the point of failure even easier: we immediately installed several replicas that we access healthcheck through HAProxy. Each Tarantool instance is replicated by a separate replicator. As a pleasant bonus, we also solved the problem of lagging slaves in this section of code: replication from MySQL to Tarantool works much faster than from MySQL to MySQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, our master base was still a point of failure and did not scale on recording operations. We began to solve this problem in this way.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firstly, at that time we had already begun to actively create new services (for example, antifraud, about which my colleagues </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">have already written</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Moreover, the services immediately required scalability of storage. For Redis, we started using only Redis-cluster, and for Tarantool - Vshard. Where we use MySQL, we started to use </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vitess</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for new logic </font><font style="vertical-align: inherit;">. Such databases are immediately shardable, so there are almost no problems with recording, and if they suddenly arise, it will be easy to solve them by adding servers. Now we use Vitess only for non-critical services and study the pitfalls, but, in the future, it will be on all MySQL databases.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secondly, since it was hard and long to implement Vitess for the already existing logic, we went in a simpler, albeit less universal way: we began to distribute the master base on different servers, table by table. We were very lucky: it turned out that the main load on the record is created by tables that are not critical for the main functionality. And when we make such tables, we do not create additional points of business failure. The main enemy for us was the strong connectedness of the tables in the code using JOINs (there were JOINs and 50-60 tables each). We cut them mercilessly. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now it's time to recall two very important patterns for designing highload systems:</font></font><br>
<br>
<ul>
<li>Graceful degradation.   ,       -   . ,   ,      ,       ,     ..    ,             .</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Circuit breaker</a>.    ,    . ,    ,    ,        .    ?      (        - graceful degradation).  ,   FPM-  ,     .  -  ( )     ,       .           ,      - ,       ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we began to scale at the very least, but there were still points of failure. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we decided to turn to semi-synchronous replication (and successfully implemented it). What is its feature? If during normal asynchronous replication the cleaner in the data center pours a bucket of water on the server, then the last transactions will not have time to replicate to the slaves and will be lost. And we must be sure that in this case we will not have serious problems after one of the slaves becomes a new master. As a result, we decided not to lose transactions at all, and for this we used semi-synchronous replication. Now the slaves can lag, but even if the master database server is destroyed, information about all transactions will be stored on at least one slave.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This was the first step towards success. </font><font style="vertical-align: inherit;">The second step was to use the orchestrator utility. </font><font style="vertical-align: inherit;">We also constantly monitor all MySQL in the system. </font><font style="vertical-align: inherit;">If the master base fails, then the automation will make the master the latest slave (and taking into account semi-synchronous replication it will contain all transactions) and switch the entire write load to it. </font><font style="vertical-align: inherit;">So we are now able to relive the story of a cleaning lady and a bucket of water. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What's next? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When I came to CityMobile, we had three services and a monolith. </font><font style="vertical-align: inherit;">Today there are more than 20 of them. And the main thing that holds back our growth is that we still have a single master base. </font><font style="vertical-align: inherit;">We heroically fight this and divide it into separate bases.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How do we develop further?</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expand the set of microservices.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This will solve many of the problems facing us today. For example, the team no longer has a single person who knows the device of the entire system. And since due to the rapid growth, we do not always have up-to-date documentation, and it is very difficult to maintain it, it is difficult for beginners to delve into the course of affairs. And if the system will consist of numerous services, then writing documentation for each of them will be incomparably easier. And the amount of code for a one-time study is greatly reduced. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go to Go.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I really love this language, but I always believed that it was not practical to rewrite working code from one language to another. But recently, experience has shown that PHP libraries, even the standard and most popular ones, are not of the highest quality. That is, we patch many libraries. Let's say the SRE team patched the standard library for interacting with RabbitMQ: it turned out that such a basic function as time out did not work. And the deeper the SRE team and I understand these problems, the more it becomes clear that few people think about timeouts in PHP, few people care about testing libraries, few people think about locks. Why is this becoming a problem for us? Because Go solutions are much easier to maintain.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What else impresses me with Go? Oddly enough, writing on it is very simple. In addition, Go makes it easy to create a variety of platform solutions. This language has a very powerful set of standard tools. If for some reason our backend starts to slow down suddenly, just go to a specific URL and you can see all the statistics - the memory allocation diagram, to understand where the process is idle. And in PHP it's more difficult to identify performance problems. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, Go has very good linters - programs that automatically find the most common errors for you. Most of them are described in the article ‚Äú50 shades of Go,‚Äù and linters perfectly detect them. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continue sharding the bases.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We will switch to Vitess on all services. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translation of a PHP monolith into redis-cluster.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In our services, redis-cluster proved to be excellent. </font><font style="vertical-align: inherit;">Unfortunately, implementing it in PHP is more difficult. </font><font style="vertical-align: inherit;">The monolith uses commands that are not supported by redis-cluster (which is good, such commands bring more problems than benefits). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will investigate the problems of RabbitMQ. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is believed that RabbitMQ is not the most reliable software. </font><font style="vertical-align: inherit;">We will study this issue, find and solve problems. </font><font style="vertical-align: inherit;">Perhaps we‚Äôll think about switching to Kafka or Tarantool.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490648/index.html">Using Kata Containers in Kubernetes</a></li>
<li><a href="../en490650/index.html">The main mistakes in compiling a CV by beginner IT specialists</a></li>
<li><a href="../en490652/index.html">Logistics. Introduction Just about complicated</a></li>
<li><a href="../en490654/index.html">Dotting over MQ Series gas sensors - deep understanding of datasheet and tuning</a></li>
<li><a href="../en490656/index.html">Camunda external tasks - a powerful tool for building applications with resilient and scalable architecture</a></li>
<li><a href="../en490664/index.html">PHP: array_key_exists searches 500 times faster than in_array</a></li>
<li><a href="../en490668/index.html">The history of the transformation from product to project and vice versa (using the example of Goodness in the Moscow region)</a></li>
<li><a href="../en490670/index.html">How to make a car write tests from code for you</a></li>
<li><a href="../en490674/index.html">Habr Wickley # 41 / More autonomous cars, prof. Fortran, Yandex, the pain of the robot, how to block a competitor‚Äôs site</a></li>
<li><a href="../en490676/index.html">Unit testing, science and math</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>