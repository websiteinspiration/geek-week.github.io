<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍✈️ 🧙🏼 🕶️ Bildlaufleiste, die fehlgeschlagen ist 👡 🤲🏼 🐷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kürzlich wurde eine neue Version von Windows Terminal veröffentlicht. Alles wäre in Ordnung, aber die Leistung ihrer Bildlaufleiste ließ zu wünschen ü...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bildlaufleiste, die fehlgeschlagen ist</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/493040/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/b6/xe/uj/b6xeuj-pps_cnuo5ky22sr0yl5o.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kürzlich wurde eine neue Version von Windows Terminal veröffentlicht. </font><font style="vertical-align: inherit;">Alles wäre in Ordnung, aber die Leistung ihrer Bildlaufleiste ließ zu wünschen übrig. </font><font style="vertical-align: inherit;">Deshalb ist es Zeit, einen kleinen Stock an ihn zu kleben und Tamburin zu spielen.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was machen Benutzer normalerweise mit der neuen Version einer Anwendung? </font><font style="vertical-align: inherit;">Genau das haben Tester nicht getan. </font><font style="vertical-align: inherit;">Daher begann ich nach einer kurzen Nutzung des Terminals für den vorgesehenen Zweck, schreckliche Dinge damit zu tun. </font><font style="vertical-align: inherit;">Okay, okay, ich habe gerade Kaffee auf die Tastatur geschüttet und versehentlich die &lt;Eingabetaste&gt; geklemmt, als ich sie abgewischt habe. </font><font style="vertical-align: inherit;">Was ist am Ende passiert?</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/tq/ev/at/tqevatebkqh9qhtc7meqb8gd9y8.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ja, es sieht nicht sehr beeindruckend aus, aber beeile dich nicht, Steine ​​auf mich zu werfen. </font><font style="vertical-align: inherit;">Achten Sie auf die rechte Seite. </font><font style="vertical-align: inherit;">Versuchen Sie zuerst herauszufinden, was mit ihr los ist. </font><font style="vertical-align: inherit;">Hier ist ein Screenshot für einen Hinweis:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/33/g5/nz/33g5nz7ix7fpgot21hpt-flsw0m.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Natürlich war der Titel des Artikels ein ernsthafter Spoiler. :) Es </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gibt also ein Problem mit der Bildlaufleiste. Wenn Sie nach dem Überschreiten des unteren Randes mehrmals zu einer neuen Zeile wechseln, wird normalerweise eine Bildlaufleiste angezeigt, und Sie können nach oben scrollen. Dies geschieht jedoch erst, wenn wir einen Befehl mit der Ausgabe von etwas schreiben. Sagen wir einfach, das Verhalten ist seltsam. Dies wäre jedoch möglicherweise nicht so kritisch gewesen, wenn die Bildlaufleiste funktioniert hätte ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich ein wenig getestet hatte, stellte ich fest, dass das Wechseln zu einer neuen Zeile den Puffer nicht erhöht. Dies macht nur die Ausgabe von Befehlen. Das obige </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Whoami</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erhöht also den Puffer um nur eine Zeile. Aus diesem Grund werden wir im Laufe der Zeit viel Geschichte verlieren, besonders nach dem </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clear.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das erste, was mir in den Sinn kam, war, unseren Analysator zu verwenden und zu sehen, was darin steht:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/hf/dt/op/hfdtop2yyl-2hnm0fdzu2bg6jmo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Fazit ist natürlich von beeindruckender Größe, daher werde ich die </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Möglichkeit nutzen,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> alles außer dem mit der </font><i><font style="vertical-align: inherit;">ScrollBar zu</font></i><font style="vertical-align: inherit;"> filtern und </font><i><font style="vertical-align: inherit;">zuzuschneiden</font></i><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/kb/k9/nh/kbk9nhstx9w90yxa5q8sm542fvk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich kann nicht sagen, dass es viele Nachrichten gibt ... Nun, vielleicht gibt es dann etwas, das mit dem Puffer zusammenhängt?</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/js/ym/u0/jsymu0ehvgbwmldkhi30tkr8duw.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Analysator versagte nicht und fand etwas Interessantes. </font><font style="vertical-align: inherit;">Ich habe diese Warnung oben hervorgehoben. </font><font style="vertical-align: inherit;">Mal sehen, was dort falsch ist: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V501</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Links und rechts vom Operator '-' befinden sich identische Unterausdrücke: bufferHeight - bufferHeight TermControl.cpp 592</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(bufferHeight - bufferHeight); <span class="hljs-comment">// &lt;=  </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Code wird von einem Kommentar begleitet: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Richten Sie die Höhe des ScrollViewer und des Rasters ein, mit dem wir unsere Bildlaufhöhe vortäuschen." </font></font></i> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Simulation der Bildlaufhöhe ist natürlich gut, aber warum setzen wir maximal 0? </font><font style="vertical-align: inherit;">In der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wurde deutlich, dass der Code nicht sehr verdächtig ist. </font><font style="vertical-align: inherit;">Verstehen Sie mich nicht falsch: Das Subtrahieren einer Variablen von sich selbst ist natürlich verdächtig, aber wir erhalten am Ausgang eine Null, was uns nicht schadet. </font><font style="vertical-align: inherit;">In jedem Fall habe ich versucht, den </font><font style="vertical-align: inherit;">Standardwert (1) </font><font style="vertical-align: inherit;">im Feld </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maximum</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> anzugeben </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/my/pz/-r/mypz-rza0bhmadv3_q32c5oklkc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Bildlaufleiste wurde angezeigt, funktioniert aber auch nicht:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/_n/ii/xg/_niixgvkmgqfoy_fmiyaouu6rog.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn überhaupt, habe ich die &lt;Eingabetaste&gt; 30 Sekunden lang geklemmt. Anscheinend ist dies nicht das Problem. Lassen wir es also so, wie es war, außer indem </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wir bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bufferHeight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durch 0 </font><font style="vertical-align: inherit;">ersetzen </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">bool</span> TermControl::_InitializeTerminal()<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">auto</span> bottom = _terminal-&gt;GetViewport().BottomExclusive();
  <span class="hljs-keyword">auto</span> bufferHeight = bottom;<font></font>
<font></font>
  ScrollBar().Maximum(<span class="hljs-number">0</span>); <span class="hljs-comment">// &lt;=   </span>
  ScrollBar().Minimum(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().Value(<span class="hljs-number">0</span>);<font></font>
  ScrollBar().ViewportSize(bufferHeight);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sind also nicht besonders nahe daran, das Problem zu lösen. In Ermangelung eines besseren Angebots für eine Debatte. Zuerst könnten wir einen Haltepunkt auf die geänderte Linie setzen, aber ich bezweifle, dass es uns irgendwie helfen wird. Daher müssen wir zuerst das Fragment finden, das für den Versatz des Ansichtsfensters relativ zum Puffer verantwortlich ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein wenig darüber, wie die lokale (und höchstwahrscheinlich jede andere) Bildlaufleiste funktioniert. Wir haben einen großen Puffer, der die gesamte Ausgabe speichert. Um damit zu interagieren, wird eine Art Abstraktion verwendet, um auf dem Bildschirm zu zeichnen, in diesem Fall das </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansichtsfenster</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesen beiden Grundelementen können wir verstehen, was unser Problem ist. Das Wechseln zu einer neuen Zeile erhöht den Puffer nicht, und aus diesem Grund können wir einfach nirgendwo hingehen. Daher liegt das Problem darin.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit diesem alltäglichen Wissen bewaffnet, setzen wir unsere heroische Debatte fort. </font><font style="vertical-align: inherit;">Nach einem kleinen Rundgang durch die Funktion machte ich auf dieses Fragment aufmerksam:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem wir die </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScrollBar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oben </font><font style="vertical-align: inherit;">konfiguriert </font><font style="vertical-align: inherit;">haben, konfigurieren </font><font style="vertical-align: inherit;">wir verschiedene Rückruffunktionen und führen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__connection.Start ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> für unser neu geprägtes Fenster aus. </font><font style="vertical-align: inherit;">Danach wird das obige Lambda genannt. </font><font style="vertical-align: inherit;">Da dies das erste Mal ist, dass wir etwas in den Puffer schreiben, empfehle ich, unser Debug von dort aus zu starten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir setzen einen Haltepunkt innerhalb des Lambda und schauen in </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_terminal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/0z/lz/rb/0zlzrbnxlr94nbnb2jkgnmmf1sq.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt haben wir zwei Variablen, die für uns extrem wichtig sind - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_buffer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_mutableViewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Setzen Sie Haltepunkte auf sie und finden Sie heraus, wo sie sich ändern. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Richtig</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mit </font><i><font style="vertical-align: inherit;">_viewport</font></i><font style="vertical-align: inherit;"> werde ich </font><i><font style="vertical-align: inherit;">ein</font></i><font style="vertical-align: inherit;"> wenig </font><i><font style="vertical-align: inherit;">schummeln</font></i><font style="vertical-align: inherit;"> und einen Haltepunkt nicht für die Variable selbst, sondern für das </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oberste</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Feld setzen </font><font style="vertical-align: inherit;">(wir brauchen ihn nur). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Klicken Sie nun auf &lt;F5&gt; und nichts passiert ... Nun, dann drücken wir ein paar Dutzend Mal &lt;Eingabe&gt;. Nichts ist passiert. Anscheinend </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">haben</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wir </font><font style="vertical-align: inherit;">auf </font><i><font style="vertical-align: inherit;">_buffer</font></i><font style="vertical-align: inherit;"> einen Haltepunkt zu rücksichtslos gesetzt, und </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> blieb erwartungsgemäß oben im Puffer, der nicht größer wurde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In diesem Fall ist es sinnvoll, einen Befehl einzugeben, damit der Scheitelpunkt aktualisiert wird.</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_viewport</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Danach haben wir uns einen sehr interessanten Code ausgedacht:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe auf einen Kommentar hingewiesen, in dem wir aufgehört haben. </font><font style="vertical-align: inherit;">Wenn Sie sich den Kommentar zum Fragment ansehen, wird klar, dass wir der Lösung näher sind als je zuvor. </font><font style="vertical-align: inherit;">An dieser Stelle wird der sichtbare Teil relativ zum Puffer verschoben, und wir haben die Möglichkeit, einen Bildlauf durchzuführen. </font><font style="vertical-align: inherit;">Nachdem ich das Verhalten ein wenig beobachtet hatte, bemerkte ich einen interessanten Punkt: Beim Verschieben in eine neue Zeile entspricht der Wert der Variablen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dem Wert des </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansichtsfensters</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , sodass wir ihn nicht weglassen und nichts funktioniert. </font><font style="vertical-align: inherit;">Darüber hinaus gibt es ein ähnliches Problem mit der Variablen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">newViewTop</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Erhöhen wir daher den Wert von </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursorPosAfter.Y</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> um eins und sehen, was passiert ist:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y + <span class="hljs-number">1</span> &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y + <span class="hljs-number">1</span> - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....); <span class="hljs-comment">// &lt;=</span>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und das Startergebnis:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/6g/7d/xc/6g7dxcp_8o_uw-jzmlx6qxy6xjy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wunder! </font><font style="vertical-align: inherit;">Ich habe ne Menge eingegeben und die Bildlaufleiste funktioniert. </font><font style="vertical-align: inherit;">Richtig, bis wir etwas vorstellen ... Um die Datei zu demonstrieren, werde ich ein GIF anhängen:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/cl/ed/8y/cled8yrho-rrvtihhjf7uoo7ybq.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anscheinend machen wir ein paar zusätzliche Sprünge zu einer neuen Linie. </font><font style="vertical-align: inherit;">Versuchen wir dann, unsere Übergänge mithilfe der X-Koordinate zu begrenzen. Wir verschieben die Linie nur, wenn </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0 ist:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">void</span> Terminal::_AdjustCursorPosition(<span class="hljs-keyword">const</span> COORD proposedPosition)<font></font>
{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (   proposedCursorPosition.X == <span class="hljs-number">0</span><font></font>
      &amp;&amp; proposedCursorPosition.Y == _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    proposedCursorPosition.Y++;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-comment">// Update Cursor Position</span><font></font>
  ursor.SetPosition(proposedCursorPosition);<font></font>
<font></font>
  <span class="hljs-keyword">const</span> COORD cursorPosAfter = cursor.GetPosition();<font></font>
<font></font>
  <span class="hljs-comment">// Move the viewport down if the cursor moved below the viewport.</span>
  <span class="hljs-keyword">if</span> (cursorPosAfter.Y &gt; _mutableViewport.BottomInclusive())<font></font>
  {<font></font>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> newViewTop =
      <span class="hljs-built_in">std</span>::max(<span class="hljs-number">0</span>, cursorPosAfter.Y - (_mutableViewport.Height() - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">if</span> (newViewTop != _mutableViewport.Top())<font></font>
    {<font></font>
      _mutableViewport = Viewport::FromDimensions(....);<font></font>
      notifyScroll = <span class="hljs-literal">true</span>;<font></font>
    }<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das oben geschriebene Fragment verschiebt die </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Koordinate </font><font style="vertical-align: inherit;">für den Cursor. </font><font style="vertical-align: inherit;">Dann aktualisieren wir die Cursorposition. </font><font style="vertical-align: inherit;">Theoretisch sollte das funktionieren ... Was ist passiert?</font></font><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/7i/kc/xs/7ikcxsonvzc4h99f-6obibt1o8u.gif"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na klar besser. </font><font style="vertical-align: inherit;">Es gibt jedoch ein Problem darin, dass wir den Ausgabepunkt verschieben, aber den Puffer nicht verschieben. </font><font style="vertical-align: inherit;">Daher sehen wir zwei Aufrufe desselben Befehls. </font><font style="vertical-align: inherit;">Es mag natürlich scheinen, dass ich weiß, was ich tue, aber das ist nicht so. </font><font style="vertical-align: inherit;">:) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zu diesem Zeitpunkt habe ich beschlossen, den Inhalt des Puffers zu überprüfen, und bin zu dem Punkt zurückgekehrt, an dem ich das Debugging gestartet habe:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// This event is explicitly revoked in the destructor: does not need weak_ref</span>
<span class="hljs-keyword">auto</span> onReceiveOutputFn = [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">const</span> hstring str) {<font></font>
  _terminal-&gt;Write(str);<font></font>
};<font></font>
_connectionOutputEventToken = _connection.TerminalOutput(onReceiveOutputFn);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich setzte einen Haltepunkt an derselben Stelle wie beim letzten Mal und begann, den Inhalt der Variablen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str zu untersuchen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Beginnen wir mit dem, was ich auf meinem Bildschirm gesehen habe:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/ha/ll/4c/hall4czp0c9scl5ybzmduvpa2iy.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was denken Sie , </font><font style="vertical-align: inherit;">in der sein </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">str</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> String , </font><font style="vertical-align: inherit;">wenn ich &lt;Enter&gt; drücken?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zeichenfolge </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"LANGE BESCHREIBUNG"</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der gesamte Puffer, den wir jetzt sehen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der gesamte Puffer, jedoch ohne die erste Zeile.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde nicht schmachten - den gesamten Puffer, aber ohne die erste Zeile. </font><font style="vertical-align: inherit;">Und das ist ein erhebliches Problem, denn gerade deshalb verlieren wir darüber hinaus punktuell die Geschichte. </font><font style="vertical-align: inherit;">Dies ist , </font><font style="vertical-align: inherit;">wie unsere </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hilfe</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ausgabe Fragment aussehen wird </font><font style="vertical-align: inherit;">nach gehen in eine neue Zeile:</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/rc/n8/d9/rcn8d94h6tyf1qtscqyqvfvtn24.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit einem Pfeil markierte ich die Stelle, an der sich </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">„LONG DESCRIPTOIN“ befand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Vielleicht dann den Puffer mit einem Versatz von einer Zeile überschreiben? </font><font style="vertical-align: inherit;">Dies würde funktionieren, wenn dieser Rückruf nicht bei jedem Niesen aufgerufen würde. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe mindestens drei Situationen entdeckt, in denen es heißt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn wir ein Zeichen eingeben;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn wir uns durch die Geschichte bewegen;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn wir den Befehl ausführen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Problem ist, dass Sie den Puffer nur verschieben müssen, wenn wir den Befehl ausführen, oder &lt;Eingabe&gt; eingeben. </font><font style="vertical-align: inherit;">In anderen Fällen ist dies eine schlechte Idee. </font><font style="vertical-align: inherit;">Wir müssen also irgendwie bestimmen, was verschoben werden muss.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/yo/ij/pbyoijjc9y4dezbt9wizjxrwnb0.png" alt="Bild 18"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Artikel war ein Versuch zu zeigen, wie geschickt PVS-Studio fehlerhaften Code finden konnte, der zu dem Fehler führte, den ich bemerkte. </font><font style="vertical-align: inherit;">Die Botschaft zum Thema Subtrahieren einer Variablen von sich selbst hat mich stark motiviert, und ich habe den Text energisch geschrieben. </font><font style="vertical-align: inherit;">Aber wie Sie sehen, war meine Freude verfrüht und alles stellte sich als viel komplizierter heraus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also beschloss ich aufzuhören. </font><font style="vertical-align: inherit;">Man könnte noch ein paar Abende verbringen, aber je länger ich das tat, desto mehr Probleme traten auf. </font><font style="vertical-align: inherit;">Ich kann den Windows Terminal-Entwicklern nur viel Glück bei der Behebung dieses Fehlers wünschen. </font><font style="vertical-align: inherit;">:) :)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich hoffe, ich habe den Leser nicht enttäuscht, dass ich die Recherche nicht abgeschlossen habe, und es war interessant für mich, einen Spaziergang durch das Innere des Projekts zu machen. Als Ausgleich empfehle ich die Verwendung des # WindowsTerminal-Promo-Codes, mit dem Sie eine Demoversion von PVS-Studio nicht für eine Woche, sondern sofort für einen Monat erhalten. Wenn Sie den statischen Analysator PVS-Studio in der Praxis nicht ausprobiert haben, ist dies ein guter Grund, genau das zu tun. Geben Sie einfach "#WindowsTerminal" in das Feld "Nachricht" auf </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der Download-Seite ein</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei dieser Gelegenheit möchte ich Sie auch daran erinnern, dass es bald eine Version von C # -Analysator geben wird, die unter Linux und MacOS funktioniert. Und jetzt können Sie sich für Vorversuche anmelden.</font></font><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png"></a></div><p></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie diesen Artikel einem englischsprachigen Publikum zugänglich machen möchten, verwenden Sie bitte den Link zur Übersetzung: Maxim Zvyagintsev. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die kleine Bildlaufleiste, die nicht konnte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de493026/index.html">Testen auf Produkt: Canary Deployment</a></li>
<li><a href="../de493032/index.html">5. Check Point Maestro Häufig gestellte Fragen (FAQ)</a></li>
<li><a href="../de493034/index.html">COVID-19: Vorhersage der Anzahl der Patienten mit Coronavirus</a></li>
<li><a href="../de493036/index.html">Ich verdrehe und verdrehe, ich möchte verwirren: Manipulationen mit zweischichtigem Graphen</a></li>
<li><a href="../de493038/index.html">Über Unternehmenskultur für verteilte Teams und nicht nur</a></li>
<li><a href="../de493042/index.html">Marktpublikumsdatensegment für Online-Werbung und Marketing. Teil. 1. Gesetzesänderungen</a></li>
<li><a href="../de493046/index.html">So planen Sie die Eröffnung eines Cafés oder schreiben Sie Ihren eigenen Planer für die Eröffnung von Einrichtungen</a></li>
<li><a href="../de493050/index.html">Suche ist nicht das, was zu finden ist</a></li>
<li><a href="../de493052/index.html">Problem</a></li>
<li><a href="../de493060/index.html">Fernarbeit als Chance, den Projektmanager zu enthüllen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>