<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéñÔ∏è üë®üèº üë®‚Äçüîß Clustering in Proxmox VE üéöÔ∏è ü•© üç£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In past articles, we started talking about what Proxmox VE is and how it works. Today we will talk about how you can use the clustering feature and sh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Clustering in Proxmox VE</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/selectel/blog/489914/"><img src="https://habrastorage.org/webt/ba/4_/p0/ba4_p0pjj8nlzulpcdlsdbez4mo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In past articles, we started talking about what Proxmox VE is and how it works. </font><font style="vertical-align: inherit;">Today we will talk about how you can use the clustering feature and show what advantages it gives.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is a cluster and why is it needed? </font><font style="vertical-align: inherit;">A cluster (from the English cluster) is a group of servers connected by high-speed communication channels, working and representing the user as a whole. </font><font style="vertical-align: inherit;">There are several basic scenarios for using a cluster:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Providing fault tolerance</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (High-availability).</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Load balancing</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Load Balancing).</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Increased Productivity</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (High Performance).</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Performing</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Distributed Computing</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each scenario presents its own requirements for cluster components. </font><font style="vertical-align: inherit;">For example, for a cluster performing distributed computing, the main requirement is a high speed of floating point operations and low latency of the network. </font><font style="vertical-align: inherit;">Such clusters are often used for research purposes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we touched on the topic of distributed computing, I want to note that there is still such a thing as a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grid system</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(from the English. grid - lattice, network). </font><font style="vertical-align: inherit;">Despite the general similarity, do not confuse the grid system and the cluster. </font><font style="vertical-align: inherit;">Grid is not a cluster in the usual sense. </font><font style="vertical-align: inherit;">In contrast to the cluster, the nodes included in the grid are most often heterogeneous and are characterized by low availability. </font><font style="vertical-align: inherit;">This approach simplifies the solution of distributed computing problems, but does not allow creating a single whole from nodes.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A striking example of a grid system is the popular computing platform </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BOINC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Berkeley Open Infrastructure for Network Computing). </font><font style="vertical-align: inherit;">This platform was originally created for the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SETI @ home project</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Search for Extra-Terrestrial Intelligence at Home), which deals with the problem of searching for extraterrestrial intelligence by analyzing radio signals.</font></font></blockquote><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How it works</font></font></b><div class="spoiler_text">  ,   ,     ,      - (  SETI@home      ).              SETI.       ,        .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that we have a clear understanding of what a cluster is, we suggest considering how it can be created and deployed. </font><font style="vertical-align: inherit;">We will use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proxmox VE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> open source virtualization system </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before starting to create a cluster, it is especially important to clearly understand the limitations and system requirements of Proxmox, namely:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the maximum number of nodes in a cluster is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">32</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">all nodes must have the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">same version of Proxmox</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (there are exceptions, but they are not recommended for production);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if in the future it is planned to use the High Availability functionality, then the cluster must have </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at least 3 nodes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the nodes to communicate with each other, the ports </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UDP / 5404</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UDP / 5405</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for corosync and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP / 22</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for SSH </font><font style="vertical-align: inherit;">must be open </font><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the network delay between nodes should not exceed </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 ms</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster Creation</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important! </font><font style="vertical-align: inherit;">The configuration below is a test one. </font><font style="vertical-align: inherit;">Be sure to check the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">official</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Proxmox VE </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">documentation</font></a><font style="vertical-align: inherit;"> . </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to start the test cluster, we took three servers with the Proxmox hypervisor installed of the same configuration (2 cores, 2 GB of RAM).</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want to know how to install Proxmox, we recommend that you read our previous article - The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Magic of Virtualization: An Introductory Course in Proxmox VE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initially, after installing the OS, a single server runs in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Standalone-mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
 <br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2l/b9/1x/2lb91xdrokvieydn63rr9fb7ndo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a cluster by clicking the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create Cluster</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">in the corresponding section.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4k/sr/me/4ksrmekzntmzfig-2ymdwx7oahs.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We name the future cluster and select the active network connection.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cy/ww/bt/cywwbtaea7ogttm77ebrwtwo7f8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Click the Create button. </font><font style="vertical-align: inherit;">The server will generate a 2048-bit key and write it together with the parameters of the new cluster to the configuration files.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qv/r3/wy/qvr3wyzqfxrgscstbwz0mzxztv0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The inscription </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TASK OK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indicates a successful operation. </font><font style="vertical-align: inherit;">Now, looking at the general information about the system, it is clear that the server has switched to cluster mode. </font><font style="vertical-align: inherit;">So far, the cluster consists of only one node, that is, while it does not have the capabilities for which the cluster is needed.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/cv/zl/17/cvzl17xrzcnv4tbjlgcgutbd6vc.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Joining a cluster</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before connecting to the created cluster, we need to get information to complete the connection. </font><font style="vertical-align: inherit;">To do this, go to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> section </font><font style="vertical-align: inherit;">and click the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Join Information</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/7g/se/mi/7gsemira1cy79g3f9yxopfxc_mo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the window that opens, we are interested in the contents of the field of the same name. </font><font style="vertical-align: inherit;">It will need to be copied.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/rw/-i/7h/rw-i7hhyo_yqrqy-o9oh2jxmi9g.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All necessary connection parameters are encoded here: server address for connection and fingerprint. </font><font style="vertical-align: inherit;">We pass to the server which needs to be included in a cluster. </font><font style="vertical-align: inherit;">Click the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Join Cluster</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">and in the window that opens, paste the copied content.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/bt/fh/0v/btfh0vp9foxegb2lcca-d-kww1c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peer Address</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fingerprint</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fields </font><font style="vertical-align: inherit;">will be filled in automatically. </font><font style="vertical-align: inherit;">Enter the root password from node number 1, select the network connection and click the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Join</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/v-/um/i3/v-umi3rqffairr3yhnn2tz2uafi.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you join a cluster, the GUI web page may stop updating. </font><font style="vertical-align: inherit;">This is normal, just reload the page. </font><font style="vertical-align: inherit;">In exactly the same way we add one more node and as a result we receive a full-fledged cluster of 3 working nodes.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/tc/wb/mx/tcwbmxrp1umdagapsce7tv4qfie.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can control all cluster nodes from one GUI.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/e4/at/cb/e4atcbt-_ihvdai9jjjmiamgrds.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">High Availability Organization</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Proxmox out of the box supports HA organization functionality for both virtual machines and LXC containers. </font><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ha-manager</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><font style="vertical-align: inherit;">detects and processes errors and failures by performing a failover from a failed node to a working one. </font><font style="vertical-align: inherit;">For the mechanism to work correctly, it is necessary that the virtual machines and containers have a common file storage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the High Availability functionality is activated, the ha-manager software stack will begin to continuously monitor the status of the virtual machine or container and asynchronously interact with other nodes in the cluster.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attach shared storage</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, we deployed a small NFS file storage at 192.168.88.18. </font><font style="vertical-align: inherit;">So that all the nodes of the cluster can use it, you need to do the following manipulations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We select in the menu of the web interface </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datacenter - Storage - Add - NFS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vr/pd/3u/vrpd3uedlwasqpg0m19g8pvtb2o.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fill in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fields </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Export</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> drop-down list, </font><font style="vertical-align: inherit;">select the desired directory from the available ones and in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Content</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> list </font><font style="vertical-align: inherit;">, the necessary data types. </font><font style="vertical-align: inherit;">After clicking the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button, the </font><font style="vertical-align: inherit;">storage will be connected to all nodes of the cluster.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/6d/mu/fy/6dmufyavxpq4dcxaqxarozuughm.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When creating virtual machines and containers on any of the nodes, we specify our </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">storage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as storage.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Customize HA</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, create a container with Ubuntu 18.04 and configure High Availability for it. </font><font style="vertical-align: inherit;">After creating and launching the container, go to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Datacenter - HA - Add</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> section </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In the field that opens, specify the ID of the virtual machine / container and the maximum number of attempts to restart and move between nodes.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If this amount is exceeded, the hypervisor will mark the VM as failed and will transfer it to the Error state, after which it will cease to perform any actions with it.</font></font></blockquote><div style="text-align:center;"><img src="https://habrastorage.org/webt/p4/h9/ng/p4h9nglzk5gtsojtebmvlny9cvq.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After clicking the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> button, the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ha-manager</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility will </font><font style="vertical-align: inherit;">notify all the cluster nodes that the VM with the specified ID is now being monitored and if it falls, it must be restarted on another node.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ni/6x/q5/ni6xq5soctxwt3-abx9bs0gvo8o.png"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Make a crash</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to see how the switching mechanism works, let‚Äôs pay off abnormally node1 power supply. </font><font style="vertical-align: inherit;">We look from another node what happens to the cluster. </font><font style="vertical-align: inherit;">We see that the system recorded a failure.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/df/wc/ve/dfwcve9i2iplppnbexfsomn0w40.png"></div><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The operation of the HA mechanism does not mean the continued operation of the VM. </font><font style="vertical-align: inherit;">As soon as the node has "fallen", VM operation is temporarily stopped until the automatic restart on another node.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And here ‚Äúmagic‚Äù begins - the cluster automatically reassigned the node to run our VM and within 120 seconds the work was automatically restored.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/sl/ep/j6/slepj6ytjfwkdkfx--i7kvrxega.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We extinguish node2 on nutrition. </font><font style="vertical-align: inherit;">Let's see if the cluster can withstand and the VM will return to working state automatically.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/7c/ge/k6/7cgek6uuanswhta3osmoshozk10.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alas, as we see, we had a problem with the fact that the only surviving node has no more quorum, which automatically disables HA. </font><font style="vertical-align: inherit;">We give the command to force quorum installation in the console.</font></font><br>
<br>
<pre><code class="plaintext hljs">pvecm expected 1</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qk/n6/jw/qkn6jwdgtovfx9ns7kt2veahb0w.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After 2 minutes, the HA mechanism worked correctly and not finding node2, launched our VM on node3.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/6s/z2/xm/6sz2xmx1djx-_rm6k_y3uz6xcpu.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As soon as we turned node1 and node2 back on, the cluster was fully restored. </font><font style="vertical-align: inherit;">Note that the VM does not migrate back to node1, but this can be done manually.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To summarize</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We told you about how the clustering mechanism in Proxmox works, and also showed how HA is configured for virtual machines and containers. </font><font style="vertical-align: inherit;">The proper use of clustering and HA greatly improves the reliability of the infrastructure, and also provides disaster recovery. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before creating a cluster, you need to immediately plan for what purposes it will be used and how much it will need to be scaled in the future. </font><font style="vertical-align: inherit;">You also need to check the network infrastructure for availability with minimal delays so that the future cluster works without failures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tell us - do you use clustering capabilities in Proxmox? </font><font style="vertical-align: inherit;">See you in the comments. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Previous articles on the Proxmox VE hypervisor:</font></font></i><br>
<br>
<ul>
<li><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Magic of Virtualization: An Introductory Course in Proxmox VE</font></font></a></i></li>
<li><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About backups in Proxmox VE</font></font></a></i></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489900/index.html">PostgreSQL Antipatterns: changing data bypassing a trigger</a></li>
<li><a href="../en489902/index.html">How to measure the effectiveness of an investment portfolio: 3 practical approaches</a></li>
<li><a href="../en489904/index.html">Why and how are we testing the update</a></li>
<li><a href="../en489906/index.html">Virtual fitting room in OpenCV</a></li>
<li><a href="../en489912/index.html">The pain and suffering when debugging microservices in web development</a></li>
<li><a href="../en489916/index.html">Protobuf or JSON structured front-end communication protocol?</a></li>
<li><a href="../en489918/index.html">How we implemented the virtual fuel card project</a></li>
<li><a href="../en489920/index.html">Sites, go to IPv6, two</a></li>
<li><a href="../en489924/index.html">Where does Elasticsearch start</a></li>
<li><a href="../en489926/index.html">Black Friday: a look at the load through the eyes of the developer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>