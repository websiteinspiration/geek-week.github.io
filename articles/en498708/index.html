<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ôüèø üë§ üîÇ CoreData model from the code. Or ‚ÄúHow to Do Without .XCDataModel‚Äù (Part 1) üôéüèª üöÜ üîë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If for some reason you don‚Äôt like the process of creating a coreData model using the Xcode GUI, or you are as crazy a programmer as I want your applic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>CoreData model from the code. Or ‚ÄúHow to Do Without .XCDataModel‚Äù (Part 1)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/498708/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If for some reason you don‚Äôt like the process of creating a coreData model using the Xcode GUI, or you are as crazy a programmer as I want your application to get rid of .XCDataModel files and run a little faster, then welcome to cat.</font></font></p><a name="habracut"></a><br>
<h2 id="kratkaya-predystoriya"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Brief Background</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About half a year ago I‚Äôve been developing my own application for iOS, and until recently, the development process went smoothly and without any problems in the field of data storage.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But recently, the coreData model has grown to sizes that are indecent from my point of view, and since I am blind, it‚Äôs physically difficult for me to work with a large amount of semi-visual data, I decided to transfer everything that concerns coreData to the code.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is very little material on "non-visual" work with coreData, so half of my conclusions and developments are based on insane experiments on Playgrounds and no less insane attempts to google missing information. </font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, let's go!</font></font></p><br>
<h2 id="nachnyom-s-klassov"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's start with the classes.</font></font></h2><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If in standard work with coreData we describe all entities and the relationships between them in a separate file with the model, then in our case we will need classes that describe those entities first (it will be easier to understand what we are working with, and Xcode will help, prompting the names of already created classes).</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, below we will use a strange postscript at the end of each class, "MO" - Managed Object. </font><font style="vertical-align: inherit;">This is not to be confused with other, possibly similar, classes, but not related to coreData.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will describe the following situation:</font></font></p><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a company (described by the class CompanyMO);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are employees (described by the WorkerMO class);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each employee can work only in one company (or not work at all);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each company can have any number of employees (including no employees at all).</font></font></li>
</ul><br>
<pre><code class="swift hljs"><span class="hljs-meta">@objc</span>(<span class="hljs-type">CompanyMO</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompanyMO</span>: <span class="hljs-title">NSManagedObject</span> </span>{
<span class="hljs-meta">@NSManaged</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> companyName: <span class="hljs-type">String</span>
<span class="hljs-meta">@NSManaged</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> workers: <span class="hljs-type">NSSet</span><font></font>
}<font></font>
<font></font>
<span class="hljs-meta">@objc</span>(<span class="hljs-type">WorkerMO</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkerMO</span>: <span class="hljs-title">NSManagedObject</span> </span>{
<span class="hljs-meta">@NSManaged</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> firstname: <span class="hljs-type">String</span>
<span class="hljs-meta">@NSManaged</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> lastname: <span class="hljs-type">String</span>
<span class="hljs-meta">@NSManaged</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> company: <span class="hljs-type">CompanyMO?</span>
}</code></pre><br>
<p>    .</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link">objc</a>() ‚Äî ,       ,            .</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link">objc</a>(CompanyMO)    CompanyMO   ,     CompanyMO   Objective-C    CompanyMO.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link">objc</a>(NameOfClass)        Objective-C.</p><br>
<p>  ‚Äî @NSManaged    .</p><br>
<p>@NSManaged ,  ,               .       ,    (  Apple, ),  <em>@NSManaged      coreData.</em></p><br>
<h2 id="podgotovimsya-k-sozdaniyu-modeli">   </h2><br>
<p>     ‚Äî   ,       .</p><br>
<p>  ,    ,      extension      .</p><br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">NSEntityDescription</span> </span>{
<span class="hljs-keyword">convenience</span> <span class="hljs-keyword">init</span>(from classType: <span class="hljs-type">AnyClass</span>) {
<span class="hljs-keyword">self</span>.<span class="hljs-keyword">init</span>()
<span class="hljs-keyword">self</span>.name = <span class="hljs-type">NSStringFromClass</span>(classType)
<span class="hljs-keyword">self</span>.managedObjectClassName = <span class="hljs-type">NSStringFromClass</span>(classType)<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addProperty</span><span class="hljs-params">(<span class="hljs-number">_</span> property: NSPropertyDescription)</span></span> {
<span class="hljs-keyword">self</span>.properties.append(property)<font></font>
}<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">NSAttributeDescription</span> </span>{
<span class="hljs-keyword">convenience</span> <span class="hljs-keyword">init</span>(name: <span class="hljs-type">String</span>, ofType: <span class="hljs-type">NSAttributeType</span>, isOptional: <span class="hljs-type">Bool</span> = <span class="hljs-literal">false</span>) {
<span class="hljs-keyword">self</span>.<span class="hljs-keyword">init</span>()
<span class="hljs-keyword">self</span>.name = name
<span class="hljs-keyword">self</span>.attributeType = ofType
<span class="hljs-keyword">self</span>.isOptional = isOptional<font></font>
}<font></font>
}</code></pre><br>
<p>      .</p><br>
<p> NSEntityDescription ‚Äî   coreData,   (, ).      ( ,         )    (managedObjectClassName),      ,   (,     ‚Äî CompanyMO, WorkerMO   ).</p><br>
<p>     ,         :</p><br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> company = <span class="hljs-type">NSEntityDescription</span>()<font></font>
company.name = <span class="hljs-string">"CompanyMO"</span>
company.managedObjectClassName = <span class="hljs-string">"CompanyMO"</span></code></pre><br>
<p>  ,    ,        NSEntityDescription. ,  :</p><br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> company = <span class="hljs-type">NSEntityDescription</span>(from: <span class="hljs-type">CompanyMO</span>.<span class="hljs-keyword">self</span>)
<span class="hljs-keyword">let</span> worker = <span class="hljs-type">NSEntityDescription</span>(from: <span class="hljs-type">WorkerMO</span>.<span class="hljs-keyword">self</span>)</code></pre><br>
<p>,    ,      .</p><br>
<h2 id="pereydyom-k-opisaniyu-samoy-modeli">    </h2><br>
<p>     (    ,        ),         .</p><br>
<pre><code class="swift hljs"><span class="hljs-keyword">var</span> model: <span class="hljs-type">NSManagedObjectModel</span> {
<span class="hljs-keyword">let</span> _model = <span class="hljs-type">NSManagedObjectModel</span>()<font></font>
<font></font>
<span class="hljs-keyword">let</span> companyEntity = <span class="hljs-type">NSEntityDescription</span>(from: <span class="hljs-type">CompanyMO</span>.<span class="hljs-keyword">self</span>)<font></font>
companyEntity.addProperty(<span class="hljs-type">NSAttributeDescription</span>(name: <span class="hljs-string">"companyName"</span>, ofType: .stringAttributeType))
<span class="hljs-comment">//      CompanyMO.workers,         </span>
<span class="hljs-keyword">let</span> workerEntity = <span class="hljs-type">NSEntityDescription</span>(from: <span class="hljs-type">WorkerMO</span>.<span class="hljs-keyword">self</span>)<font></font>
workerEntity.addProperty(<span class="hljs-type">NSAttributeDescription</span>(name: <span class="hljs-string">"firstname"</span>, ofType: .stringAttributeType))<font></font>
workerEntity.addPropertyNSAttributeDescription((name: <span class="hljs-string">"lastname"</span>, ofType: .stringAttributeType))<font></font>
<font></font>
_model.entities = [companyEntity, workerEntity]<font></font>
<span class="hljs-keyword">return</span> _model<font></font>
}</code></pre><br>
<p>   .</p><br>
<p>  NSManagedObjectModel   entities,    NSEntityDescription.</p><br>
<pre><code class="swift hljs"><span class="hljs-type">NSManagedObjectModel</span>.entities: [<span class="hljs-type">NSEntityDescription</span>]</code></pre><br>
<p> NSEntityDescription     .     ,      ,    - .    ,    ,      .</p><br>
<p>  NSEntityDescription ,    companyEntity  workerEntity    companyEntity.properties  workerEntity.properties,      NSPropertyDescription.</p><br>
<p> NSPropertyDescription    NSAttributeDescription (  ,  , )  NSRelationshipDescription (   ).</p><br>
<p> NSRelationshipDescription       .</p><br>
<p>,   :</p><br>
<ol>
<li>   CompanyMO  WorkerMO;</li>
<li>       ,  .  companyEntity  companyName ( workers   ),   workerEntity  firstname  lastname.</li>
<li>  entities        "" .</li>
</ol><br>
<p>    .</p><br>
<p>  .</p><br>
<h2 id="sozdayom-konteyner"> </h2><br>
<p>   NSPersistentStore  NSPersistentStoreCoordinator      NSPersistentContainer (,       .     ).</p><br>
<p>    coreData            .</p><br>
<p>          ,  ( )            .</p><br>
<p>  persistentContainer    .</p><br>
<pre><code class="swift hljs"><span class="hljs-built_in">lazy</span> <span class="hljs-keyword">var</span> persistentContainer: <span class="hljs-type">NSPersistentContainer</span> {
<span class="hljs-keyword">let</span> _container = <span class="hljs-type">NSPersistentContainer</span>(name: <span class="hljs-string">"CyrmaxModel"</span>, managedObjectModel: model)<font></font>
_container.loadPersistentStores {<font></font>
(description, error) <span class="hljs-keyword">in</span>
<span class="hljs-comment">//  ,  -</span><font></font>
}<font></font>
<span class="hljs-keyword">return</span> _container<font></font>
}</code></pre><br>
<p> ,         ( )  ,       .</p><br>
<p>  persistentContainer     coreData   ,       .</p><br>
<h2 id="plyusy-opisaniya-modeli-v-kode">    </h2><br>
<ol>
<li>         ,      ;</li>
<li>    (- - ,     );</li>
<li>        (    ,      "?",   ).</li>
</ol><br>
<h2 id="sokraschaem-kolichestvo-koda">  </h2><br>
<p>       ,   ,       , , ,   .</p><br>
<p>        ,   .</p><br>
<p>      ,         .</p><br>
<p>    WorkerMO,      .</p><br>
<pre><code class="swift hljs"><span class="hljs-meta">@objc</span>(<span class="hljs-type">WorkerMO</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkerMO</span>: <span class="hljs-title">NSManagedObject</span> </span>{
<span class="hljs-meta">@NSManaged</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> firstname: <span class="hljs-type">String</span>
<span class="hljs-meta">@NSManaged</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> lastname: <span class="hljs-type">String</span><font></font>
<font></font>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _entityDescription: <span class="hljs-type">NSEntityDescription?</span>
<span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">entityDescription</span><span class="hljs-params">()</span></span> -&gt; <span class="hljs-type">NSEntityDescription</span> {
<span class="hljs-keyword">guard</span> <span class="hljs-keyword">self</span>._entityDescription == <span class="hljs-literal">nil</span> <span class="hljs-keyword">else</span> {
<span class="hljs-keyword">return</span> _entityDescription!<font></font>
}<font></font>
<span class="hljs-keyword">let</span> des = <span class="hljs-type">NSEntityDescription</span>(from: <span class="hljs-keyword">self</span>)<font></font>
des.addProperty(<span class="hljs-type">NSAttributeDescription</span>(name: <span class="hljs-string">"firstname"</span>, ofType: .stringAttributeType))<font></font>
des.addProperty(<span class="hljs-type">NSAttributeDescription</span>(name: <span class="hljs-string">"lastname"</span>, ofType: .stringAttributeType))
<span class="hljs-keyword">self</span>._entityDescription = des
<span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>._entityDescription!<font></font>
}<font></font>
}</code></pre><br>
<p>     CompanyMO (      ).</p><br>
<p>   .</p><br>
<p>     _entityDescription     ,        ?</p><br>
<p>       ,           NSRelationshipDescription   .</p><br>
<p>   ,  ,  CompanyMO.entityDescription()  <em>      NSEntityDescription</em>,    .</p><br>
<h2 id="zaklyuchenie"></h2><br>
<p> coreData-   ‚Äî        .       ,      .       (  ,    StoryBoard,    ),                    .</p><br>
<p>        - ,   ,         StoryBoard,    XCDataModel.</p><br>
<h2 id="ochen-rekomenduyu-izuchit">  </h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">NSManagedObjectModel</a>;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">NSEntityDescription</a>;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">NSPropertyDescription</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow">NSAttributeDescription</a>;</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optional, but you can still read about </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NSPersistentContainer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and its </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">init (name: managedObjectModel :)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> initializer.</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498694/index.html">Hybrid printing centers: how we materialize millions of letters every day</a></li>
<li><a href="../en498696/index.html">What problems did IT people face when they were forced to switch to remote work?</a></li>
<li><a href="../en498700/index.html">IT is a middle class with a stretch. And how NOT to interview the programmer</a></li>
<li><a href="../en498702/index.html">Svelte, a disappearing framework that will not disappear</a></li>
<li><a href="../en498706/index.html">Series of product webinars from Lenovo Data Center Group experts</a></li>
<li><a href="../en498712/index.html">The soul of the future: why everyone, including Tim Cook, invests in Nebia</a></li>
<li><a href="../en498716/index.html">Quick Deploy vm ESXi with Terraform</a></li>
<li><a href="../en498720/index.html">What is wrong with railroad car schemes</a></li>
<li><a href="../en498724/index.html">How to maintain eye health: a guide for programmers</a></li>
<li><a href="../en498726/index.html">How to learn Data Science and Business Intelligence for free? Talk at the Open House Day at Ozon Masters</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>