<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥üèø üë©üèæ‚ÄçüöÄ üôÜ Organization of code in microservices and my approach of using hexagonal architecture and DDD üëé üßíüèø üí™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! In the Monolith, all the code should be in the same style, and in different microservices you can use different approaches, programming l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Organization of code in microservices and my approach of using hexagonal architecture and DDD</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493426/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ak/h6/c_/akh6c_safonprea6vtagzdaoy58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello, Habr! In the Monolith, all the code should be in the same style, and in different microservices you can use different approaches, programming languages ‚Äã‚Äãand frameworks. For simple microservices with 1 to 2 controllers and 1 to 10 actions, there is no particular sense in blocking layers of abstractions. For complex microservices with different states and the logic of transition between them, on the contrary, it is better not to be lazy initially. I want to talk about my experience with organizing code and using the DDD, Ports, and Adapters approaches for both cases. There is a brief summary of the article: June - writes code in the controller. Middle - writes a bunch of abstractions. Senior - knows when to write code in the controller, and when abstractions are needed.</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here you need to immediately put an end to I - Ports in C # are interface or abstract, and Adapters are concrete implementations (class, struct). </font><font style="vertical-align: inherit;">For reference, I recommend reading this translation of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDD, Hexagonal, Onion, Clean, CQRS ... how I put it all together</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and this article of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clean Architecture misconception</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Here, just keep in mind that the approach is described for a large and complex monolith. </font><font style="vertical-align: inherit;">I want to talk about the variations of this approach in microservices 80 percent of which are simple and 20 medium or high complexity.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terminology</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) PrimaryAdapters </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Introduce a user-friendly interface for an external </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calling</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> system. </font><font style="vertical-align: inherit;">Call and use SecondaryApdapters and Logic. </font><font style="vertical-align: inherit;">They tell the application to do something. </font><font style="vertical-align: inherit;">Entry points to your code. </font><font style="vertical-align: inherit;">Typical representatives: ItemsService, CreateItemCommandHandler. </font><font style="vertical-align: inherit;">Use Logic and SecondaryAdapters for their work.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) SecondaryAdapters </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Provides an interface to an external </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">called</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> system convenient for use by our system. </font><font style="vertical-align: inherit;">He receives commands from the application. </font><font style="vertical-align: inherit;">Typical representatives: ItemsRepository, EmailSender, Logger, DistributedCache. </font><font style="vertical-align: inherit;">They use libraries and frameworks like EntityFramework for their work.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) Logic</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1) Entities</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Combine data and logic. </font><font style="vertical-align: inherit;">Typical OOP objects. </font><font style="vertical-align: inherit;">Item, Money, User. </font><font style="vertical-align: inherit;">There are also ValueObjects and Events. </font><font style="vertical-align: inherit;">Only other objects from the Entities layer are used. </font><font style="vertical-align: inherit;">In theory, this layer is the core of the application that does not depend on anyone. </font><font style="vertical-align: inherit;">All depend on him.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2) DomainServices</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naked computing. </font><font style="vertical-align: inherit;">They are needed for logic that cannot be attached to one specific entity. </font><font style="vertical-align: inherit;">Use Entities or other DomainServices. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> not use PrimaryAdapters (they always do themselves all use) and SecondaryAdapters. </font><font style="vertical-align: inherit;">Usually this is all sorts of AmountCalculator, Validator and more. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code call flow should always be in one direction PrimaryAdapters -&gt; Logic and SecondaryAdapters.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Domain</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the subject area for which the system is being developed. </font><font style="vertical-align: inherit;">For example, for the Domain Online Store, this is E-Commerce.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boundedcontext</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BoundedContext is used to split the system into isolated parts with a certain responsibility. One of the ways to success in system design is to find and highlight all of its BoundedContexts in it. In a microservice architecture, 1 microservice = 1 BoundedContext. For example: An online store may have a BoundedContext Shopping Cart and BoundedContext working with orders, BoundedContext working with files. And one big BoundedContext can be broken into small pieces inside. For example, for the BoundedContext of the basket of goods, you can make a division into the context of adding goods to the basket and the context of removing goods from the basket. In monolith 1, a large BoundedContext is one Module. Here it is necessary to make a remark that all Entities live within a specific context i.e.Item from the context of the basket of goods and Item from the context of the showcase of goods, these can be different classes with different fields and methods. In a monolith, they simply map into each other and use some ItemDto that EF passes to work with the database and which has fields that are common to all, that is, if Item from the context (module) of the Basket has the property Property1, and Item from the context of the storefront of goods has property Property2 then ItemDto will have both Property1 and Property2. In each context there will be its own repository which will pull out the Item, which is already characteristic of this context, from the database. In microservices, this is easy. Each has its own database and its own essence. Each world service has its own classes. SimplyIn a monolith, they simply map into each other and use some ItemDto that EF passes to work with the database and which has fields that are common to all, that is, if Item from the context (module) of the Basket has the property Property1, and Item from the context of the storefront of goods has property Property2 then ItemDto will have both Property1 and Property2. In each context there will be its own repository which will pull out the Item, which is already characteristic of this context, from the database. In microservices, this is easy. Each has its own database and its own essence. Each world service has its own classes. SimplyIn a monolith, they simply map into each other and use some ItemDto that EF passes to work with the database and which has fields that are common to all, that is, if Item from the context (module) of the Basket has the property Property1, and Item from the context of the storefront of goods has property Property2 then ItemDto will have both Property1 and Property2. In each context there will be its own repository which will pull out the Item, which is already characteristic of this context, from the database. In microservices, this is easy. Each has its own database and its own essence. Each world service has its own classes. SimplyIn each context there will be its own repository which will pull out the Item, which is already characteristic of this context, from the database. In microservices, this is easy. Each has its own database and its own essence. Each world service has its own classes. SimplyIn each context there will be its own repository which will pull out the Item, which is already characteristic of this context, from the database. In microservices, this is easy. Each has its own database and its own essence. Each world service has its own classes. Simply</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remember</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that Item and ItemsRepository from different BoundedContext can be different objects with different methods and properties. </font><font style="vertical-align: inherit;">Often, BoundedContext in microservices is violated by the introduction of some common libraries. </font><font style="vertical-align: inherit;">The result is a class that has several dozen methods or properties and each microservice uses 1 - 2 only that it needs, so you need to be careful with shared libraries in microservices.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dependencies between layers</font></font></h3><br>
<img src="https://habrastorage.org/webt/8g/kb/4y/8gkb4yjeoduvybjcxsyo77apjre.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option for simple microservices of which Pareto law 80 percent</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Throw away the layer PrimaryAdatapters and SecondaryAdapters. Leave only the Logic layer. More precisely, in a typical ASP.NET application we use - PimaryAdater is Controller, and SecondaryAdapter is DbContext from EF. If the Controller suddenly becomes too large, then we cut it into pieces using partial. This is much better than breeding unnecessary abstractions and spending time on them. For example, Microsoft did this for the BasketMicrotservice in the example of its EShop application on docker containers. Yes, just write the code to the controller. Just do not write spaghetti code. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">remember that the Logic layer remains with us and we still use Entities with their logic and DomainServices with their calculations and not just write a wall of spaghetti code in the controller. </font><font style="vertical-align: inherit;">We just throw away the typical ItemService and ItemRepository. </font><font style="vertical-align: inherit;">The good old ItemValidator, ItemMapper, AmountCalculator, etc. in this spirit still remain with us. </font><font style="vertical-align: inherit;">Since we still have a formed Logic layer, we can switch to a more complicated option at any time by wrapping additional abstractions with ItemsService, ItemsRepository.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A service that calculates the final price of a product at a discount. </font><font style="vertical-align: inherit;">In theory, it is part of the Domain Online Store and represents its BoundedContext product catalog. </font><font style="vertical-align: inherit;">For simplicity, I skipped all the validation logic. </font><font style="vertical-align: inherit;">It can be described in some sort of ItemValidator and DiscountValidator. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Logic folder: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.1) Entities folder: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Discount:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Discount</span><font></font>
    {<font></font>
        [<span class="hljs-meta">Key</span>]
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Value { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Money:</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">Owned</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Money</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Amount { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Money <span class="hljs-title">Apply</span>(<span class="hljs-params">Discount discount</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> amount = Amount * (<span class="hljs-number">1</span> - discount.Value);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Money()<font></font>
            {<font></font>
                Amount = amount<font></font>
            };<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Product:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Item</span><font></font>
    {<font></font>
        [<span class="hljs-meta">Key</span>]
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Money Price { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span> Money();<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.2) DomainServices folder Product </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
price calculator, including discounts:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IPriceCalculator</span><font></font>
    {<font></font>
        <span class="hljs-function">Money <span class="hljs-title">WithDiscounts</span>(<span class="hljs-params">Item item, IEnumerable&lt;Discount&gt; discounts</span>)</span>;<font></font>
    }<font></font>
<font></font>
     <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PriceCalculator</span>:<span class="hljs-title">IPriceCalculator</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Money <span class="hljs-title">WithDiscounts</span>(<span class="hljs-params">Item item, IEnumerable&lt;Discount&gt; discounts</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> discounts.Aggregate(item.Price, (m, d) =&gt; m.Apply(d));<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) DbContext </font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsDbContext</span> : <span class="hljs-title">DbContext</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsDbContext</span>(<span class="hljs-params">DbContextOptions&lt;ItemsDbContext&gt; options</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span><font></font>
        {<font></font>
<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Item&gt; Items { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Discount&gt; Discounts { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Controller</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/items"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPriceCalculator _priceCalculator;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsController</span>(<span class="hljs-params">ItemsDbContext context, IPriceCalculator priceCalculator</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
            _priceCalculator = priceCalculator;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}/price-with-discounts"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _context.Items.FindAsync(id);
            <span class="hljs-keyword">var</span> discounts = <span class="hljs-keyword">await</span> _context.Discounts.ToListAsync();
            <span class="hljs-keyword">return</span> _priceCalculator.WithDiscounts(item, discounts).Amount;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option for complex microservices of which 20 percent and for most monoliths</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we use a standard approach with maximum isolation of the layers from each other. </font><font style="vertical-align: inherit;">Add a class for PrimaryAdapter (ItemService) and for SecondaryAdapter (ItemRepository). </font><font style="vertical-align: inherit;">In the Logic folder, everything remains as it was before.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Example</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) SecondaryAdapters folder</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IItemsRepository</span><font></font>
    {<font></font>
        <span class="hljs-function">Task&lt;Item&gt; <span class="hljs-title">Get</span>(<span class="hljs-params">Guid id</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsRepository</span> : <span class="hljs-title">IItemsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsRepository</span>(<span class="hljs-params">ItemsDbContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;Item&gt; <span class="hljs-title">Get</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _context.Items.FindAsync(id);
            <span class="hljs-keyword">return</span> item;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IDiscountsRepository</span><font></font>
    {<font></font>
        Task&lt;List&lt;Discount&gt;&gt; Get();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DiscountsRepository</span> : <span class="hljs-title">IDiscountsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DiscountsRepository</span>(<span class="hljs-params">ItemsDbContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Task&lt;List&lt;Discount&gt;&gt; Get()<font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> _context.Discounts.ToListAsync();<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) PrimaryAdapters folder</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IItemService</span><font></font>
    {<font></font>
        <span class="hljs-function">Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemService</span> : <span class="hljs-title">IItemService</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IItemsRepository _items;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IDiscountsRepository _discounts;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPriceCalculator _priceCalculator;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemService</span>(<span class="hljs-params">IItemsRepository items, IDiscountsRepository discounts, IPriceCalculator priceCalculator</span>)</span><font></font>
        {<font></font>
            _items = items;<font></font>
            _discounts = discounts;<font></font>
            _priceCalculator = priceCalculator;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _items.Get(id);
            <span class="hljs-keyword">var</span> discounts = <span class="hljs-keyword">await</span> _discounts.Get();
            <span class="hljs-keyword">return</span> _priceCalculator.WithDiscounts(item, discounts).Amount;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our controller now uses our IItemService</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/items"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IItemService _service;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsController</span>(<span class="hljs-params">IItemService service</span>)</span><font></font>
        {<font></font>
            _service = service;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}/price-with-discounts"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _service.GetPriceWithDiscount(id);
            <span class="hljs-keyword">return</span> result;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Added a lot of additional code. Instead, increased system flexibility. Now it‚Äôs easier to change the Contoller and generally ASP.NET Core to something else or change the DbContext and EntityFramework Core to something else or add caching to Redis. The first approach wins in simple microservices and very simple and small monoliths. The second in all other cases, when you will need to add and finish this code for more than a year. Well, in the second approach, in addition to Entity Item and Discount, it is useful to make separate DTOs that will use DbContex EF and separate DTOs (Models) that ASP.NET Controller will use i.e. ItemDto and ItemModel. This will make domain models even more independent. And finally, an example of a simple application that I wrote using the 2nd </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">TestRuvds</font></a><font style="vertical-align: inherit;"> approach</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In fact, he is redundant here, and all these abstractions are here for an example.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementation example</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualServersModule</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acknowledgments</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
thank </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">canxes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AndrewDemb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for grammatical errors found.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493412/index.html">Games with Wifi on ESP32</a></li>
<li><a href="../en493416/index.html">IDA Pro and reverse engineering techniques</a></li>
<li><a href="../en493418/index.html">Why machine learning uses ‚Äúsynthetic" data</a></li>
<li><a href="../en493420/index.html">My way to introduce junior high school students to Python</a></li>
<li><a href="../en493424/index.html">We implement Python code conversions</a></li>
<li><a href="../en493428/index.html">"We will not give rise to conspiracy theories." Talk about ML conferences with people from science and IT companies</a></li>
<li><a href="../en493430/index.html">Net Architecture for Web Applications</a></li>
<li><a href="../en493432/index.html">Why not start a career in a small non-IT company</a></li>
<li><a href="../en493436/index.html">Program for changing access rights and register of file / directory names on Bash</a></li>
<li><a href="../en493438/index.html">Display search results and performance issues</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>