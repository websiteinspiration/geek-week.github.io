<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë®üèæ üî´ üé° Armazenamento em cache. Parte 2: 60 dias antes do lan√ßamento üêÉ ‚ùóÔ∏è üçÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°! Eu j√° escrevi para voc√™ sobre como promover iniciativas em uma corpora√ß√£o. Mais precisamente, como (√†s vezes) isso √© bem-sucedido e que dificulda...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Armazenamento em cache. Parte 2: 60 dias antes do lan√ßamento</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sportmaster_lab/blog/504400/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√°! </font><font style="vertical-align: inherit;">Eu j√° escrevi para voc√™ sobre como promover iniciativas em uma corpora√ß√£o. </font><font style="vertical-align: inherit;">Mais precisamente, como (√†s vezes) isso √© bem-sucedido e que dificuldades podem surgir: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma retrospectiva do rake. </font><font style="vertical-align: inherit;">Como uma solu√ß√£o feita por voc√™ acabou sendo mais fria que a paga</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como escolhemos um sistema de cache. </font><font style="vertical-align: inherit;">Parte 1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje, quero continuar e falar sobre o momento psicologicamente mais estressante desse projeto, sobre o qual os dois primeiros artigos - quando o resultado do projeto foi determinado n√£o tanto pelas habilidades t√©cnicas da equipe quanto pela confian√ßa em seus c√°lculos e vontade de chegar ao fim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tenho que dizer - eu acho que para levar o projeto a um momento t√£o intenso - √© um erro muito usado </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sobre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lshaya do que qualquer hero√≠smo, estendendo o projeto para esse problema ...</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas n√£o escondo essa experi√™ncia e a compartilho de bom grado - porque considero:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">precisamente √°reas problem√°ticas s√£o pontos de crescimento</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">os maiores problemas "chegam" precisamente de onde voc√™ n√£o espera</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A combina√ß√£o desses pontos - apenas obriga a compartilhar a maravilhosa experi√™ncia de "como ganhar uma sarjeta do nada". </font><font style="vertical-align: inherit;">Mas, deve-se notar, uma situa√ß√£o semelhante √© excepcional na empresa Sportmaster. </font><font style="vertical-align: inherit;">Ou seja, √© poss√≠vel que essa situa√ß√£o ocorra novamente - planejamento e defini√ß√£o de responsabilidade agora - em um n√≠vel completamente diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, parece que a introdu√ß√£o √© suficiente, se voc√™ estiver pronto - bem-vindo ao gato.</font></font><br>
 <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/sa/3o/8k/sa3o8kskmgz_ptdsflpadmiycra.png"></a><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Junho 2017 </font><font style="vertical-align: inherit;">Estamos modificando o painel de administra√ß√£o. </font><font style="vertical-align: inherit;">O painel de administra√ß√£o n√£o √© apenas um conjunto de formul√°rios e tabelas na interface da Web - os valores inseridos precisam ser colados com dezenas de outros dados que obtemos de sistemas de terceiros. </font><font style="vertical-align: inherit;">Al√©m disso, de alguma forma, transforme e, finalmente, envie para os consumidores (o principal deles √© o site ElasticSearch da Sportmaster). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A principal dificuldade √© apenas para converter e enviar. </font><font style="vertical-align: inherit;">Nomeadamente:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voc√™ precisa fornecer dados na forma de json, que pesa 100 KB cada, e alguns aparecem por 10 MB (verifique a disponibilidade e os crit√©rios de entrega de mercadorias √†s lojas)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">json com uma estrutura que possui anexos recursivos de qualquer n√≠vel de aninhamento (por exemplo, um menu dentro de um item de menu, no qual h√° itens de menu novamente, etc.)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a declara√ß√£o final n√£o √© aprovada e est√° em constante mudan√ßa (por exemplo, o trabalho com mercadorias por modelos √© substitu√≠do por uma abordagem quando trabalhamos por modelos coloridos). </font><font style="vertical-align: inherit;">Constantemente - isso √© v√°rias vezes por semana, com uma taxa de pico de 2 vezes por dia durante uma semana.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se os dois primeiros pontos s√£o puramente t√©cnicos e s√£o ditados pela pr√≥pria tarefa, ent√£o com o terceiro ponto, √© claro, voc√™ precisa lidar com isso organizacionalmente. </font><font style="vertical-align: inherit;">Mas, como o mundo real est√° longe do ideal, trabalhamos com o que temos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, eles descobriram como rebitar rapidamente formul√°rios da web e seus objetos no lado do servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma pessoa da equipe foi nomeada para o papel de um "tapa de formul√°rio" profissional e, usando componentes da Web preparados, lan√ßou uma demonstra√ß√£o para a interface do usu√°rio mais rapidamente do que os analistas corrigiram os desenhos dessa interface. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, para mudar o esquema das transforma√ß√µes, a complexidade surgiu aqui.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, seguimos o caminho usual - para realizar a transforma√ß√£o na consulta sql para Oracle. Havia um especialista em DB na equipe. Ele durou at√© o momento em que a solicita√ß√£o era de 2 p√°ginas de texto sql cont√≠nuo. Eu podia continuar, mas quando as mudan√ßas vieram dos analistas - objetivamente, a coisa mais dif√≠cil foi encontrar o lugar onde fazer as mudan√ßas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analistas expressaram regra nos regimes, que, apesar de terem sido pintadas em algo separado do c√≥digo (uma esp√©cie de visio / draw.io / Gliffy), mas n√£o foram </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semelhante a quadrados e setas nos sistemas ETL (por exemplo, Pentaho Kettle, que na √©poca era usado para fornecer dados ao site da Sportmaster). Agora, se n√£o tiv√©ssemos uma consulta SQL, mas um esquema ETL! Em seguida, a instru√ß√£o e a solu√ß√£o seriam expressas topologicamente de forma id√™ntica, o que significa que a edi√ß√£o do c√≥digo pode levar tanto tempo quanto a edi√ß√£o da instru√ß√£o!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas com sistemas ETL, h√° outra dificuldade. A mesma Pentaho Kettle - √© √≥tima quando voc√™ precisa criar um novo √≠ndice no ElasticSearch, no qual escrever todos os dados colados de v√°rias fontes (observa√ß√£o: na verdade, √© a Pentaho Kettle que n√£o funciona muito bem, porque n√£o usa javascript nas transforma√ß√µes relacionado a classes java atrav√©s das quais o consumidor acessa dados - por isso, √© poss√≠vel anotar algo que n√£o pode ser transformado nos objetos necess√°rios do pojo, mas esse √© um t√≥pico separado, longe do curso principal do artigo). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o que fazer quando, no painel de administra√ß√£o, o usu√°rio corrigiu um campo em um documento? Para entregar essa altera√ß√£o no site ElasticSearch da Sportmaster, n√£o crie um novo √≠ndice no qual preencher todos os documentos desse tipo, incluindo um atualizado!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queria que, quando um objeto nos dados de entrada fosse alterado, enviasse uma atualiza√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ElasticSearch do site </font><i><font style="vertical-align: inherit;">apenas</font></i><font style="vertical-align: inherit;"> para o documento de sa√≠da correspondente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, o pr√≥prio documento de entrada, mas, afinal, de acordo com o esquema de transforma√ß√£o, ele pode ser anexado a documentos de um tipo diferente por meio da jun√ß√£o! Portanto, √© necess√°rio analisar o esquema de transforma√ß√£o e calcular quais documentos de sa√≠da ser√£o afetados pela altera√ß√£o nos dados nas fontes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A busca de produtos in a box para solucionar esse problema n√£o levou a nada. N√£o encontrado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E quando se desesperavam por descobrir, descobriram, mas como deveria funcionar por dentro e como isso pode ser feito? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A id√©ia surgiu imediatamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o ETL final puder ser dividido em suas partes constituintes, cada uma com um tipo espec√≠fico de um conjunto finito (por exemplo, filtro, jun√ß√£o etc.), ser√° poss√≠vel criar o mesmo conjunto finito de n√≥s especiais que correspondem aos originais, mas com a diferen√ßa de que eles trabalham n√£o com os dados em si, mas com a mudan√ßa deles? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em grandes detalhes, com exemplos e pontos-chave na implementa√ß√£o, nossa solu√ß√£o - quero abordar em um artigo separado. Para lidar com posi√ß√µes de apoio - isso exigir√° uma imers√£o s√©ria, a capacidade de pensar abstratamente e confiar no que ainda n√£o foi manifestado. De fato, ser√° interessante precisamente do ponto de vista matem√°tico e √© interessante apenas para os habrovitas interessados ‚Äã‚Äãem </font><font style="vertical-align: inherit;">detalhes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√©cnicos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui s√≥ posso dizer que criamos um modelo matem√°tico no qual descrevemos 7 tipos de n√≥s e mostramos que esse sistema est√° completo - ou seja, usando esses 7 tipos de n√≥s e as conex√µes entre eles - qualquer esquema de transforma√ß√£o de dados pode ser expresso. </font><font style="vertical-align: inherit;">A implementa√ß√£o √© baseada no uso ativo de obter e registrar dados por chave (ou seja, por chave, sem condi√ß√µes adicionais). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, nossa solu√ß√£o teve um ponto forte em rela√ß√£o a todas as dificuldades introdut√≥rias:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">os dados devem ser fornecidos na forma de json -&gt; trabalhamos com objetos pojo (objeto java antigo simples, se algu√©m n√£o encontrou os hor√°rios em que essa designa√ß√£o estava em uso), que s√£o f√°ceis de ultrapassar no json</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">existe json com uma estrutura que possui incorpora√ß√µes recursivas de qualquer n√≠vel de aninhamento -&gt; novamente, pojo (o principal √© que n√£o h√° loops, mas quantos n√≠veis de aninhamento n√£o s√£o importantes, √© f√°cil processar em java atrav√©s da recurs√£o)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a declara√ß√£o final est√° constantemente mudando -&gt; excelente, pois estamos mudando o esquema de transforma√ß√£o mais rapidamente do que os analistas elaboram (nos diagramas) os desejos de experimentos</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dos momentos de risco, apenas um - n√≥s escrevemos a solu√ß√£o do zero, por conta pr√≥pria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, as armadilhas n√£o demoraram a chegar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Momento especial N1. </font><font style="vertical-align: inherit;">Armadilha. </font><font style="vertical-align: inherit;">"Bem extrapolado"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra surpresa de natureza organizacional foi que, ao mesmo tempo em que o nosso desenvolvimento, o reposit√≥rio principal principal estava sendo transferido para uma nova vers√£o e o formato no qual esse reposit√≥rio fornece dados foi alterado. E seria bom se nosso sistema funcionasse imediatamente com o novo armazenamento, e n√£o com o antigo. Mas o novo armazenamento ainda n√£o est√° pronto. Mas, ent√£o, as estruturas de dados s√£o conhecidas e elas podem nos fornecer um suporte de demonstra√ß√£o no qual uma pequena quantidade de dados relacionados ser√° derramada. Est√° indo? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui na abordagem do produto, ao trabalhar com o fluxo de fornecimento de valor, um aviso √© inequivocamente martelado em todos os otimistas: existe um bloqueador -&gt; a tarefa n√£o funciona, ponto final.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, ent√£o, essa depend√™ncia nem sequer levantou suspeitas. De fato, ficamos euf√≥ricos com o sucesso do prot√≥tipo de processador Delta - um sistema para processar dados sobre deltas (implementa√ß√£o de um modelo matem√°tico quando as altera√ß√µes nos dados de sa√≠da s√£o calculadas usando o esquema de transforma√ß√£o como resposta a uma altera√ß√£o nos dados de entrada). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entre todos os esquemas de transforma√ß√£o, um era o mais importante. Al√©m do fato de o circuito em si ser o maior e mais complexo, havia tamb√©m um requisito estrito para que a transforma√ß√£o fosse realizada de acordo com esse circuito - um prazo para a execu√ß√£o de toda a quantidade de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, a transforma√ß√£o deve ser realizada 15 minutos e n√£o mais um segundo. A entrada principal √© uma tabela com 5,5 milh√µes de registros. No est√°gio de desenvolvimento, a tabela ainda n√£o est√° preenchida. Mais precisamente, ele √© preenchido com um pequeno conjunto de dados de teste no valor de 10 mil linhas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, vamos come√ßar. Na primeira implementa√ß√£o, o processador Delta trabalhou no HashMap como o armazenamento de valor-chave (deixe-me lembr√°-lo, precisamos ler e escrever objetos muito por chave). Obviamente, nos volumes de produ√ß√£o, todos os objetos intermedi√°rios n√£o cabem na mem√≥ria - portanto, em vez do HashMap, passamos para o Hazelcast. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que exatamente Hazelcast - ent√£o, porque este produto era familiar, foi usado no back-end do site do Sportmaster. Al√©m disso, este √© um sistema distribu√≠do e, como nos pareceu - se um amigo faz algo errado com o desempenho - adicionamos mais inst√¢ncias a algumas m√°quinas e o problema foi resolvido. Em casos extremos - uma d√∫zia de carros. Escala horizontal e tudo mais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E assim, estamos lan√ßando nosso processador Delta para uma transforma√ß√£o direcionada. Funciona quase instantaneamente. Isso √© compreens√≠vel - os dados s√£o de apenas 10 mil em vez de 5,5 milh√µes, portanto multiplicamos o tempo medido por 550 e obtemos o resultado: algo em torno de 2 minutos. Bem! De fato - uma vit√≥ria! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso foi no in√≠cio do trabalho do projeto - exatamente quando voc√™ precisa decidir sobre a arquitetura, confirmar as hip√≥teses (realizar testes que as confirmam), integrar a solu√ß√£o piloto verticalmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como os testes mostraram um excelente resultado - ou seja, confirmamos todas as hip√≥teses, revertemos rapidamente o piloto - montamos um "esqueleto" verticalmente integrado para uma pequena parte da funcionalidade. E eles come√ßaram a codifica√ß√£o principal - enchendo o "esqueleto com carne".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que com sucesso e vigorosamente envolvidos. At√© aquele belo dia, quando um </font><font style="vertical-align: inherit;">conjunto </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de dados </font><font style="vertical-align: inherit;">foi carregado na loja principal </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute o teste neste conjunto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s 2 minutos n√£o funcionou. Tamb√©m n√£o trabalhei ap√≥s 5, 10, 15 minutos. Ou seja, eles n√£o se encaixavam na estrutura necess√°ria. Mas, com quem isso n√£o acontece, ser√° necess√°rio ajustar algo em detalhes e em forma. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o teste n√£o funcionou uma hora depois. E mesmo depois de duas horas, havia esperan√ßa de que ele funcionasse, e procuraremos o que apertar. Restos de esperan√ßa foram mesmo ap√≥s 5 horas. Mas, depois de 10 horas, quando eles foram para casa, mas o teste ainda n√£o deu certo - n√£o havia mais esperan√ßa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema era que, no dia seguinte, quando chegaram ao escrit√≥rio, o teste ainda continuava diligentemente a funcionar. Como resultado, rolou por 30 horas, n√£o esperou, desligou.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cat√°strofe! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema foi localizado com rapidez suficiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Hazelcast - ao trabalhar com uma pequena quantidade de dados - rolou tudo na mem√≥ria. </font><font style="vertical-align: inherit;">Mas quando foi necess√°rio despejar dados em um disco, o desempenho caiu milhares de vezes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A programa√ß√£o seria uma ocupa√ß√£o chata e sem gosto, se n√£o fosse pelas autoridades e pela obriga√ß√£o de entregar o produto acabado. </font><font style="vertical-align: inherit;">Ent√£o, literalmente, um dia depois, depois de recebermos um conjunto completo de dados - precisamos ir √†s autoridades com um relat√≥rio sobre como passou o teste nos volumes de produ√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta √© uma escolha muito s√©ria e dif√≠cil:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diga "como est√°" = abandone o projeto</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diga "como eu gostaria" = arriscar, talvez, n√£o se saiba se podemos resolver o problema</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender quais sentimentos surgem nesse caso, s√≥ √© poss√≠vel investir totalmente na id√©ia, realizar o plano por meio ano, criar um produto que ajude os colegas a resolver uma enorme camada de problemas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E assim, desistir de sua amada cria√ß√£o √© muito dif√≠cil. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© caracter√≠stico de todas as pessoas - n√≥s amamos aquilo em que colocamos muito esfor√ßo. Portanto, √© dif√≠cil ouvir cr√≠ticas - voc√™ deve conscientemente fazer esfor√ßos para perceber adequadamente o feedback.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, decidimos que ainda existem muitos sistemas diferentes que podem ser usados ‚Äã‚Äãcomo armazenamento de valor-chave e, se o Hazelcast n√£o se encaixar, algo definitivamente funcionar√°. </font><font style="vertical-align: inherit;">Ou seja, eles decidiram arriscar. </font><font style="vertical-align: inherit;">Para nossa justificativa, podemos dizer que ainda n√£o era um "prazo sangrento" - em geral, ainda havia uma margem de tempo para "mudar" para uma solu√ß√£o de backup. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naquela reuni√£o com os chefes, nosso gerente indicou que "o teste mostrou que o sistema trabalha de forma est√°vel em volumes de produ√ß√£o, n√£o falha". </font><font style="vertical-align: inherit;">De fato, o sistema funcionou de maneira est√°vel. </font><u><font style="vertical-align: inherit;">60</font></u><font style="vertical-align: inherit;"> dias </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
para liberar </font><font style="vertical-align: inherit;">.</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Momento especial N2. </font><font style="vertical-align: inherit;">N√£o √© uma armadilha, mas n√£o √© uma descoberta. </font><font style="vertical-align: inherit;">"Menos √© mais"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para encontrar um substituto para o Hazelcast pela fun√ß√£o de data warehouse de valor-chave, compilamos uma lista de todos os candidatos - obtivemos uma lista de 31 produtos. Isso √© tudo o que eu consegui pesquisar no google e descobrir com meus amigos. Al√©m disso, o Google forneceu algumas op√ß√µes absolutamente obscenas, como o trabalho de um estudante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para testar os candidatos mais rapidamente, preparamos um pequeno teste que, em alguns minutos de lan√ßamento, mostrava desempenho nos volumes certos. E eles paralelizaram o trabalho - todos pegaram o pr√≥ximo sistema da lista, configuraram, executaram o teste, fizeram o pr√≥ximo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eles trabalharam rapidamente, instalaram v√°rios sistemas por dia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No 18¬∫ sistema, ficou claro que isso n√£o fazia sentido. Sob o nosso perfil de carga - nenhum desses sistemas √© aprimorado. Eles t√™m muitos babados e rever√™ncias para facilitar o uso, muitas abordagens bonitas para o dimensionamento horizontal - mas isso n√£o nos d√° nenhum lucro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Precisamos de um sistema que _fast_ salve a chave em um objeto no disco e leia rapidamente a chave. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, descrevemos o algoritmo de como isso pode ser implementado. Em geral, parece bastante vi√°vel - se ao mesmo tempo: a) sacrificar a quantidade de dados que ocupar√° o disco, b) tiver estimativas aproximadas da quantidade e tamanho caracter√≠stico dos dados em cada tabela. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algo no estilo, aloque mem√≥ria (em disco) para objetos com margem, partes de um volume m√°ximo fixo. Em seguida, usando as tabelas de √≠ndice ... e assim por diante ...</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foi uma sorte que n√£o tenha chegado a isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A salva√ß√£o veio na forma de RocksDB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este √© um produto do Facebook desenvolvido para leitura r√°pida e salvamento de uma matriz de bytes em disco. Ao mesmo tempo, o acesso aos arquivos √© fornecido por meio de uma interface semelhante ao armazenamento do Key-Value. De fato, a chave √© uma matriz de bytes, o valor √© uma matriz de bytes. Otimizado para fazer esse trabalho de maneira r√°pida e confi√°vel. Todos. Se voc√™ precisar de algo mais bonito e de alto n√≠vel - enrosque-se. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exatamente o que precisamos!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O RocksDB, respons√°vel pelo armazenamento de Key-Value - elevou o indicador de teste de destino ao n√≠vel de 5 horas. </font><font style="vertical-align: inherit;">Estava longe de 15 minutos, mas o principal foi feito. </font><font style="vertical-align: inherit;">O principal era entender o que estava acontecendo, entender que gravar no disco era o mais r√°pido poss√≠vel, mais r√°pido do que imposs√≠vel. </font><font style="vertical-align: inherit;">No SSD, em testes refinados, o RocksDB espremeu 400 Mb / s, e isso foi suficiente para a nossa tarefa. </font><font style="vertical-align: inherit;">Atrasos - em algum lugar do nosso, em um c√≥digo de liga√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nosso</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> c√≥digo, o que significa que podemos lidar com isso. </font><font style="vertical-align: inherit;">Vamos desmont√°-lo, mas podemos lidar com isso.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Momento especial N3. </font><font style="vertical-align: inherit;">Apoio, suporte. </font><font style="vertical-align: inherit;">"C√°lculo te√≥rico"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos um algoritmo e entrada. Tomamos o intervalo de dados de entrada, calculamos quantas a√ß√µes o sistema deve executar, como essas a√ß√µes s√£o expressas nos custos de tempo de execu√ß√£o da JVM (atribuir um valor a uma vari√°vel, inserir um m√©todo, criar um objeto, copiar um conjunto de bytes etc.), al√©m de quantas chamadas para RocksDB deve ser mantido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acordo com os c√°lculos, eles devem cumprir 2 minutos (aproximadamente, como o teste do HashMap mostrou no in√≠cio, mas isso √© apenas uma coincid√™ncia - o algoritmo mudou desde ent√£o). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, no entanto, o teste √© executado por 5 horas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora, antes do lan√ßamento de </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta √© uma data especial - agora ser√° imposs√≠vel recolher - n√£o teremos tempo para mudar para a op√ß√£o de backup.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â claro que, neste dia, o gerente de projeto √© convocado √†s autoridades. A quest√£o √© a mesma - tenha tempo, est√° tudo bem? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ip/ci/ps/ipcipst6tfldoo7vmigaxcmsmta.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° a melhor maneira de descrever essa situa√ß√£o - uma imagem de capa estendida para este artigo. Ou seja, os chefes s√£o mostrados na parte da imagem que √© renderizada no t√≠tulo. Mas, na realidade - assim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora, na realidade, √© claro - n√£o √©ramos nada engra√ßados. E diga que "est√° tudo bem!" - isso √© poss√≠vel apenas para uma pessoa com uma habilidade muito forte de autodom√≠nio. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grande, enorme respeito pelo gerente, por acreditar e confiar nos desenvolvedores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C√≥digo realmente dispon√≠vel - mostra 5 horas. Um c√°lculo te√≥rico - mostra 2 minutos. Como isso pode ser acreditado?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas √© poss√≠vel se: o modelo for formulado claramente, como contar √© compreens√≠vel e que valores substituir tamb√©m s√£o compreens√≠veis. Ou seja, o fato de que, na realidade, a execu√ß√£o leva mais tempo significa que, na realidade, n√£o √© exatamente o c√≥digo que esperamos executar l√° que est√° sendo executado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa central √© encontrar "lastro" no c√≥digo. Ou seja, algumas a√ß√µes s√£o executadas al√©m do fluxo principal de cria√ß√£o dos dados finais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apressado. Testes unit√°rios, composi√ß√µes funcionais, fragmenta√ß√£o de fun√ß√µes e localiza√ß√£o de locais com uma quantidade desproporcional de tempo gasto na execu√ß√£o. Muitas coisas foram feitas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao longo do caminho, formulamos esses lugares onde voc√™ pode apertar seriamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, serializa√ß√£o. </font><font style="vertical-align: inherit;">Utilizado pela primeira vez o java.io padr√£o. </font><font style="vertical-align: inherit;">Mas se apertarmos o Cryo, no nosso caso, obteremos um aumento de 2,5 vezes na velocidade de serializa√ß√£o e uma redu√ß√£o de 3 vezes na quantidade de dados serializados (o que significa que o IO √© 3 vezes menor, o que consome apenas os principais recursos). </font><font style="vertical-align: inherit;">Mas, com mais detalhes, este √© um t√≥pico para um artigo t√©cnico separado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o ponto chave, ou "onde o elefante se escondeu" - tentarei descrever em um par√°grafo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ponto especial 4. Recep√ß√£o para encontrar uma solu√ß√£o. </font><font style="vertical-align: inherit;">"Problema = solu√ß√£o"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando obtemos / configuramos por chave - nos c√°lculos, ela foi executada como 1 opera√ß√£o, afeta IO no volume igual a chave + valor do objeto (na forma serializada, √© claro). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas e se o pr√≥prio objeto no qual chamamos get / set for um Mapa, que tamb√©m obtemos por get / set do disco. Quanto o IO ser√° feito neste caso? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em nossos c√°lculos, esse recurso n√£o foi levado em considera√ß√£o. Ou seja, foi considerado como 1 IO para chave + valor do objeto. Mas de fato?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, no armazenamento de Valor-Chave, pela chave-1, h√° um objeto obj-1 com o tipo Map, no qual um determinado objeto obj-2 deve ser armazenado na chave chave-2. Aqui pensamos que a opera√ß√£o exigiria um IO para a chave 2 + obj-2. Mas, na realidade, voc√™ precisa considerar o obj-1, manipul√°-lo e envi√°-lo para IO: chave-1 + obj-1. E se for um mapa no qual existem 1000 objetos, o consumo de IO ser√° cerca de 1000 vezes mais. E se 10.000 objetos, ent√£o ... Foi assim que eles conseguiram o "lastro". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando um problema √© identificado, a solu√ß√£o geralmente √© √≥bvia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nosso caso, isso se tornou uma estrutura especial para manipula√ß√µes dentro do Mapa aninhado. </font><font style="vertical-align: inherit;">Ou seja, esse valor-chave, que para obter / definir leva duas chaves ao mesmo tempo, que devem ser aplicadas seq√ºencialmente: chave-1, chave-2 - ou seja, para o primeiro n√≠vel e para o aninhado. </font><font style="vertical-align: inherit;">Como implementar essa estrutura - vou contar detalhadamente com prazer, mas novamente, em um artigo t√©cnico separado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, neste epis√≥dio, enfatizo e promovo esse recurso: um problema extremamente detalhado √© uma boa solu√ß√£o.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, tentei mostrar os pontos e armadilhas organizacionais que podem surgir. </font><font style="vertical-align: inherit;">Tais armadilhas s√£o muito claramente vis√≠veis ‚Äúde lado‚Äù ou ao longo do tempo, mas √© muito f√°cil entrar nelas quando voc√™ se encontra ao lado delas. </font><font style="vertical-align: inherit;">Espero que algu√©m se lembre dessa descri√ß√£o e, no momento certo, o lembrete funcione: "Eu j√° ouvi algo assim em algum lugar antes". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, o mais importante - agora que tudo √© contado sobre o processo, sobre os momentos psicol√≥gicos, sobre os organizacionais. </font><font style="vertical-align: inherit;">Agora que temos uma id√©ia de quais tarefas e sob quais condi√ß√µes o sistema foi criado. </font><font style="vertical-align: inherit;">Agora - voc√™ pode e deve falar sobre o sistema do lado t√©cnico - que tipo de modelo matem√°tico √© esse, e quais truques no c√≥digo que criamos e quais solu√ß√µes inovadoras pensamos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre isso no pr√≥ximo artigo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enquanto isso, Happy New Code!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt504374/index.html">Passagem de gr√°fico simples: pesquisa em profundidade e amplitude usando JavaScript como exemplo</a></li>
<li><a href="../pt504382/index.html">Como eu (PhD Neurobiology) me tornei um cientista de dados em 6 meses</a></li>
<li><a href="../pt504384/index.html">Introduzir gradualmente o TypeScript no seu projeto React</a></li>
<li><a href="../pt504386/index.html">Vassbotn H. Vari√°veis ‚Äã‚Äãvirtuais de classe</a></li>
<li><a href="../pt504392/index.html">Quantos programadores e palavras voc√™ precisa para reconhecer um passaporte escrito √† m√£o?</a></li>
<li><a href="../pt504402/index.html">29 de maio - Java Digest</a></li>
<li><a href="../pt504408/index.html">Modelo de estrutura de teste simples e conveniente no selenide para autotestes da interface do usu√°rio</a></li>
<li><a href="../pt504412/index.html">Campeonato de programa√ß√£o on-line "Finais Abertos de Treinamento em Moscou"</a></li>
<li><a href="../pt504414/index.html">Como a Microsoft matou o AppGet</a></li>
<li><a href="../pt504420/index.html">Escrevendo uma arena PvP baseada em turnos com movimentos simult√¢neos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>