<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🤝‍👨🏾 🔫 🎡 Armazenamento em cache. Parte 2: 60 dias antes do lançamento 🐃 ❗️ 🍀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Olá! Eu já escrevi para você sobre como promover iniciativas em uma corporação. Mais precisamente, como (às vezes) isso é bem-sucedido e que dificulda...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Armazenamento em cache. Parte 2: 60 dias antes do lançamento</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sportmaster_lab/blog/504400/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Olá! </font><font style="vertical-align: inherit;">Eu já escrevi para você sobre como promover iniciativas em uma corporação. </font><font style="vertical-align: inherit;">Mais precisamente, como (às vezes) isso é bem-sucedido e que dificuldades podem surgir: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma retrospectiva do rake. </font><font style="vertical-align: inherit;">Como uma solução feita por você acabou sendo mais fria que a paga</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como escolhemos um sistema de cache. </font><font style="vertical-align: inherit;">Parte 1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoje, quero continuar e falar sobre o momento psicologicamente mais estressante desse projeto, sobre o qual os dois primeiros artigos - quando o resultado do projeto foi determinado não tanto pelas habilidades técnicas da equipe quanto pela confiança em seus cálculos e vontade de chegar ao fim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tenho que dizer - eu acho que para levar o projeto a um momento tão intenso - é um erro muito usado </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sobre</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lshaya do que qualquer heroísmo, estendendo o projeto para esse problema ...</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas não escondo essa experiência e a compartilho de bom grado - porque considero:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">precisamente áreas problemáticas são pontos de crescimento</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">os maiores problemas "chegam" precisamente de onde você não espera</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A combinação desses pontos - apenas obriga a compartilhar a maravilhosa experiência de "como ganhar uma sarjeta do nada". </font><font style="vertical-align: inherit;">Mas, deve-se notar, uma situação semelhante é excepcional na empresa Sportmaster. </font><font style="vertical-align: inherit;">Ou seja, é possível que essa situação ocorra novamente - planejamento e definição de responsabilidade agora - em um nível completamente diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Então, parece que a introdução é suficiente, se você estiver pronto - bem-vindo ao gato.</font></font><br>
 <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/sa/3o/8k/sa3o8kskmgz_ptdsflpadmiycra.png"></a><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Junho 2017 </font><font style="vertical-align: inherit;">Estamos modificando o painel de administração. </font><font style="vertical-align: inherit;">O painel de administração não é apenas um conjunto de formulários e tabelas na interface da Web - os valores inseridos precisam ser colados com dezenas de outros dados que obtemos de sistemas de terceiros. </font><font style="vertical-align: inherit;">Além disso, de alguma forma, transforme e, finalmente, envie para os consumidores (o principal deles é o site ElasticSearch da Sportmaster). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A principal dificuldade é apenas para converter e enviar. </font><font style="vertical-align: inherit;">Nomeadamente:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">você precisa fornecer dados na forma de json, que pesa 100 KB cada, e alguns aparecem por 10 MB (verifique a disponibilidade e os critérios de entrega de mercadorias às lojas)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">json com uma estrutura que possui anexos recursivos de qualquer nível de aninhamento (por exemplo, um menu dentro de um item de menu, no qual há itens de menu novamente, etc.)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a declaração final não é aprovada e está em constante mudança (por exemplo, o trabalho com mercadorias por modelos é substituído por uma abordagem quando trabalhamos por modelos coloridos). </font><font style="vertical-align: inherit;">Constantemente - isso é várias vezes por semana, com uma taxa de pico de 2 vezes por dia durante uma semana.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se os dois primeiros pontos são puramente técnicos e são ditados pela própria tarefa, então com o terceiro ponto, é claro, você precisa lidar com isso organizacionalmente. </font><font style="vertical-align: inherit;">Mas, como o mundo real está longe do ideal, trabalhamos com o que temos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ou seja, eles descobriram como rebitar rapidamente formulários da web e seus objetos no lado do servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma pessoa da equipe foi nomeada para o papel de um "tapa de formulário" profissional e, usando componentes da Web preparados, lançou uma demonstração para a interface do usuário mais rapidamente do que os analistas corrigiram os desenhos dessa interface. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, para mudar o esquema das transformações, a complexidade surgiu aqui.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, seguimos o caminho usual - para realizar a transformação na consulta sql para Oracle. Havia um especialista em DB na equipe. Ele durou até o momento em que a solicitação era de 2 páginas de texto sql contínuo. Eu podia continuar, mas quando as mudanças vieram dos analistas - objetivamente, a coisa mais difícil foi encontrar o lugar onde fazer as mudanças. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analistas expressaram regra nos regimes, que, apesar de terem sido pintadas em algo separado do código (uma espécie de visio / draw.io / Gliffy), mas não foram </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tão</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">semelhante a quadrados e setas nos sistemas ETL (por exemplo, Pentaho Kettle, que na época era usado para fornecer dados ao site da Sportmaster). Agora, se não tivéssemos uma consulta SQL, mas um esquema ETL! Em seguida, a instrução e a solução seriam expressas topologicamente de forma idêntica, o que significa que a edição do código pode levar tanto tempo quanto a edição da instrução!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas com sistemas ETL, há outra dificuldade. A mesma Pentaho Kettle - é ótima quando você precisa criar um novo índice no ElasticSearch, no qual escrever todos os dados colados de várias fontes (observação: na verdade, é a Pentaho Kettle que não funciona muito bem, porque não usa javascript nas transformações relacionado a classes java através das quais o consumidor acessa dados - por isso, é possível anotar algo que não pode ser transformado nos objetos necessários do pojo, mas esse é um tópico separado, longe do curso principal do artigo). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o que fazer quando, no painel de administração, o usuário corrigiu um campo em um documento? Para entregar essa alteração no site ElasticSearch da Sportmaster, não crie um novo índice no qual preencher todos os documentos desse tipo, incluindo um atualizado!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queria que, quando um objeto nos dados de entrada fosse alterado, enviasse uma atualização </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ElasticSearch do site </font><i><font style="vertical-align: inherit;">apenas</font></i><font style="vertical-align: inherit;"> para o documento de saída correspondente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, o próprio documento de entrada, mas, afinal, de acordo com o esquema de transformação, ele pode ser anexado a documentos de um tipo diferente por meio da junção! Portanto, é necessário analisar o esquema de transformação e calcular quais documentos de saída serão afetados pela alteração nos dados nas fontes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A busca de produtos in a box para solucionar esse problema não levou a nada. Não encontrado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E quando se desesperavam por descobrir, descobriram, mas como deveria funcionar por dentro e como isso pode ser feito? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A idéia surgiu imediatamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o ETL final puder ser dividido em suas partes constituintes, cada uma com um tipo específico de um conjunto finito (por exemplo, filtro, junção etc.), será possível criar o mesmo conjunto finito de nós especiais que correspondem aos originais, mas com a diferença de que eles trabalham não com os dados em si, mas com a mudança deles? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em grandes detalhes, com exemplos e pontos-chave na implementação, nossa solução - quero abordar em um artigo separado. Para lidar com posições de apoio - isso exigirá uma imersão séria, a capacidade de pensar abstratamente e confiar no que ainda não foi manifestado. De fato, será interessante precisamente do ponto de vista matemático e é interessante apenas para os habrovitas interessados ​​em </font><font style="vertical-align: inherit;">detalhes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">técnicos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui só posso dizer que criamos um modelo matemático no qual descrevemos 7 tipos de nós e mostramos que esse sistema está completo - ou seja, usando esses 7 tipos de nós e as conexões entre eles - qualquer esquema de transformação de dados pode ser expresso. </font><font style="vertical-align: inherit;">A implementação é baseada no uso ativo de obter e registrar dados por chave (ou seja, por chave, sem condições adicionais). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, nossa solução teve um ponto forte em relação a todas as dificuldades introdutórias:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">os dados devem ser fornecidos na forma de json -&gt; trabalhamos com objetos pojo (objeto java antigo simples, se alguém não encontrou os horários em que essa designação estava em uso), que são fáceis de ultrapassar no json</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">existe json com uma estrutura que possui incorporações recursivas de qualquer nível de aninhamento -&gt; novamente, pojo (o principal é que não há loops, mas quantos níveis de aninhamento não são importantes, é fácil processar em java através da recursão)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a declaração final está constantemente mudando -&gt; excelente, pois estamos mudando o esquema de transformação mais rapidamente do que os analistas elaboram (nos diagramas) os desejos de experimentos</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dos momentos de risco, apenas um - nós escrevemos a solução do zero, por conta própria. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, as armadilhas não demoraram a chegar.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Momento especial N1. </font><font style="vertical-align: inherit;">Armadilha. </font><font style="vertical-align: inherit;">"Bem extrapolado"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra surpresa de natureza organizacional foi que, ao mesmo tempo em que o nosso desenvolvimento, o repositório principal principal estava sendo transferido para uma nova versão e o formato no qual esse repositório fornece dados foi alterado. E seria bom se nosso sistema funcionasse imediatamente com o novo armazenamento, e não com o antigo. Mas o novo armazenamento ainda não está pronto. Mas, então, as estruturas de dados são conhecidas e elas podem nos fornecer um suporte de demonstração no qual uma pequena quantidade de dados relacionados será derramada. Está indo? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui na abordagem do produto, ao trabalhar com o fluxo de fornecimento de valor, um aviso é inequivocamente martelado em todos os otimistas: existe um bloqueador -&gt; a tarefa não funciona, ponto final.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas, então, essa dependência nem sequer levantou suspeitas. De fato, ficamos eufóricos com o sucesso do protótipo de processador Delta - um sistema para processar dados sobre deltas (implementação de um modelo matemático quando as alterações nos dados de saída são calculadas usando o esquema de transformação como resposta a uma alteração nos dados de entrada). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entre todos os esquemas de transformação, um era o mais importante. Além do fato de o circuito em si ser o maior e mais complexo, havia também um requisito estrito para que a transformação fosse realizada de acordo com esse circuito - um prazo para a execução de toda a quantidade de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, a transformação deve ser realizada 15 minutos e não mais um segundo. A entrada principal é uma tabela com 5,5 milhões de registros. No estágio de desenvolvimento, a tabela ainda não está preenchida. Mais precisamente, ele é preenchido com um pequeno conjunto de dados de teste no valor de 10 mil linhas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, vamos começar. Na primeira implementação, o processador Delta trabalhou no HashMap como o armazenamento de valor-chave (deixe-me lembrá-lo, precisamos ler e escrever objetos muito por chave). Obviamente, nos volumes de produção, todos os objetos intermediários não cabem na memória - portanto, em vez do HashMap, passamos para o Hazelcast. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por que exatamente Hazelcast - então, porque este produto era familiar, foi usado no back-end do site do Sportmaster. Além disso, este é um sistema distribuído e, como nos pareceu - se um amigo faz algo errado com o desempenho - adicionamos mais instâncias a algumas máquinas e o problema foi resolvido. Em casos extremos - uma dúzia de carros. Escala horizontal e tudo mais.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E assim, estamos lançando nosso processador Delta para uma transformação direcionada. Funciona quase instantaneamente. Isso é compreensível - os dados são de apenas 10 mil em vez de 5,5 milhões, portanto multiplicamos o tempo medido por 550 e obtemos o resultado: algo em torno de 2 minutos. Bem! De fato - uma vitória! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso foi no início do trabalho do projeto - exatamente quando você precisa decidir sobre a arquitetura, confirmar as hipóteses (realizar testes que as confirmam), integrar a solução piloto verticalmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como os testes mostraram um excelente resultado - ou seja, confirmamos todas as hipóteses, revertemos rapidamente o piloto - montamos um "esqueleto" verticalmente integrado para uma pequena parte da funcionalidade. E eles começaram a codificação principal - enchendo o "esqueleto com carne".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que com sucesso e vigorosamente envolvidos. Até aquele belo dia, quando um </font><font style="vertical-align: inherit;">conjunto </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de dados </font><font style="vertical-align: inherit;">foi carregado na loja principal </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Execute o teste neste conjunto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Após 2 minutos não funcionou. Também não trabalhei após 5, 10, 15 minutos. Ou seja, eles não se encaixavam na estrutura necessária. Mas, com quem isso não acontece, será necessário ajustar algo em detalhes e em forma. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o teste não funcionou uma hora depois. E mesmo depois de duas horas, havia esperança de que ele funcionasse, e procuraremos o que apertar. Restos de esperança foram mesmo após 5 horas. Mas, depois de 10 horas, quando eles foram para casa, mas o teste ainda não deu certo - não havia mais esperança. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema era que, no dia seguinte, quando chegaram ao escritório, o teste ainda continuava diligentemente a funcionar. Como resultado, rolou por 30 horas, não esperou, desligou.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Catástrofe! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema foi localizado com rapidez suficiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Hazelcast - ao trabalhar com uma pequena quantidade de dados - rolou tudo na memória. </font><font style="vertical-align: inherit;">Mas quando foi necessário despejar dados em um disco, o desempenho caiu milhares de vezes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A programação seria uma ocupação chata e sem gosto, se não fosse pelas autoridades e pela obrigação de entregar o produto acabado. </font><font style="vertical-align: inherit;">Então, literalmente, um dia depois, depois de recebermos um conjunto completo de dados - precisamos ir às autoridades com um relatório sobre como passou o teste nos volumes de produção. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta é uma escolha muito séria e difícil:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diga "como está" = abandone o projeto</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diga "como eu gostaria" = arriscar, talvez, não se saiba se podemos resolver o problema</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para entender quais sentimentos surgem nesse caso, só é possível investir totalmente na idéia, realizar o plano por meio ano, criar um produto que ajude os colegas a resolver uma enorme camada de problemas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E assim, desistir de sua amada criação é muito difícil. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso é característico de todas as pessoas - nós amamos aquilo em que colocamos muito esforço. Portanto, é difícil ouvir críticas - você deve conscientemente fazer esforços para perceber adequadamente o feedback.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, decidimos que ainda existem muitos sistemas diferentes que podem ser usados ​​como armazenamento de valor-chave e, se o Hazelcast não se encaixar, algo definitivamente funcionará. </font><font style="vertical-align: inherit;">Ou seja, eles decidiram arriscar. </font><font style="vertical-align: inherit;">Para nossa justificativa, podemos dizer que ainda não era um "prazo sangrento" - em geral, ainda havia uma margem de tempo para "mudar" para uma solução de backup. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naquela reunião com os chefes, nosso gerente indicou que "o teste mostrou que o sistema trabalha de forma estável em volumes de produção, não falha". </font><font style="vertical-align: inherit;">De fato, o sistema funcionou de maneira estável. </font><u><font style="vertical-align: inherit;">60</font></u><font style="vertical-align: inherit;"> dias </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
para liberar </font><font style="vertical-align: inherit;">.</font></font><u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Momento especial N2. </font><font style="vertical-align: inherit;">Não é uma armadilha, mas não é uma descoberta. </font><font style="vertical-align: inherit;">"Menos é mais"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para encontrar um substituto para o Hazelcast pela função de data warehouse de valor-chave, compilamos uma lista de todos os candidatos - obtivemos uma lista de 31 produtos. Isso é tudo o que eu consegui pesquisar no google e descobrir com meus amigos. Além disso, o Google forneceu algumas opções absolutamente obscenas, como o trabalho de um estudante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para testar os candidatos mais rapidamente, preparamos um pequeno teste que, em alguns minutos de lançamento, mostrava desempenho nos volumes certos. E eles paralelizaram o trabalho - todos pegaram o próximo sistema da lista, configuraram, executaram o teste, fizeram o próximo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eles trabalharam rapidamente, instalaram vários sistemas por dia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No 18º sistema, ficou claro que isso não fazia sentido. Sob o nosso perfil de carga - nenhum desses sistemas é aprimorado. Eles têm muitos babados e reverências para facilitar o uso, muitas abordagens bonitas para o dimensionamento horizontal - mas isso não nos dá nenhum lucro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Precisamos de um sistema que _fast_ salve a chave em um objeto no disco e leia rapidamente a chave. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesse caso, descrevemos o algoritmo de como isso pode ser implementado. Em geral, parece bastante viável - se ao mesmo tempo: a) sacrificar a quantidade de dados que ocupará o disco, b) tiver estimativas aproximadas da quantidade e tamanho característico dos dados em cada tabela. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algo no estilo, aloque memória (em disco) para objetos com margem, partes de um volume máximo fixo. Em seguida, usando as tabelas de índice ... e assim por diante ...</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foi uma sorte que não tenha chegado a isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A salvação veio na forma de RocksDB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este é um produto do Facebook desenvolvido para leitura rápida e salvamento de uma matriz de bytes em disco. Ao mesmo tempo, o acesso aos arquivos é fornecido por meio de uma interface semelhante ao armazenamento do Key-Value. De fato, a chave é uma matriz de bytes, o valor é uma matriz de bytes. Otimizado para fazer esse trabalho de maneira rápida e confiável. Todos. Se você precisar de algo mais bonito e de alto nível - enrosque-se. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exatamente o que precisamos!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O RocksDB, responsável pelo armazenamento de Key-Value - elevou o indicador de teste de destino ao nível de 5 horas. </font><font style="vertical-align: inherit;">Estava longe de 15 minutos, mas o principal foi feito. </font><font style="vertical-align: inherit;">O principal era entender o que estava acontecendo, entender que gravar no disco era o mais rápido possível, mais rápido do que impossível. </font><font style="vertical-align: inherit;">No SSD, em testes refinados, o RocksDB espremeu 400 Mb / s, e isso foi suficiente para a nossa tarefa. </font><font style="vertical-align: inherit;">Atrasos - em algum lugar do nosso, em um código de ligação. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nosso</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> código, o que significa que podemos lidar com isso. </font><font style="vertical-align: inherit;">Vamos desmontá-lo, mas podemos lidar com isso.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Momento especial N3. </font><font style="vertical-align: inherit;">Apoio, suporte. </font><font style="vertical-align: inherit;">"Cálculo teórico"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Temos um algoritmo e entrada. Tomamos o intervalo de dados de entrada, calculamos quantas ações o sistema deve executar, como essas ações são expressas nos custos de tempo de execução da JVM (atribuir um valor a uma variável, inserir um método, criar um objeto, copiar um conjunto de bytes etc.), além de quantas chamadas para RocksDB deve ser mantido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De acordo com os cálculos, eles devem cumprir 2 minutos (aproximadamente, como o teste do HashMap mostrou no início, mas isso é apenas uma coincidência - o algoritmo mudou desde então). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, no entanto, o teste é executado por 5 horas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora, antes do lançamento de </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dias. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta é uma data especial - agora será impossível recolher - não teremos tempo para mudar para a opção de backup.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
É claro que, neste dia, o gerente de projeto é convocado às autoridades. A questão é a mesma - tenha tempo, está tudo bem? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ip/ci/ps/ipcipst6tfldoo7vmigaxcmsmta.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui está a melhor maneira de descrever essa situação - uma imagem de capa estendida para este artigo. Ou seja, os chefes são mostrados na parte da imagem que é renderizada no título. Mas, na realidade - assim. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora, na realidade, é claro - não éramos nada engraçados. E diga que "está tudo bem!" - isso é possível apenas para uma pessoa com uma habilidade muito forte de autodomínio. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grande, enorme respeito pelo gerente, por acreditar e confiar nos desenvolvedores. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Código realmente disponível - mostra 5 horas. Um cálculo teórico - mostra 2 minutos. Como isso pode ser acreditado?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas é possível se: o modelo for formulado claramente, como contar é compreensível e que valores substituir também são compreensíveis. Ou seja, o fato de que, na realidade, a execução leva mais tempo significa que, na realidade, não é exatamente o código que esperamos executar lá que está sendo executado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa central é encontrar "lastro" no código. Ou seja, algumas ações são executadas além do fluxo principal de criação dos dados finais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apressado. Testes unitários, composições funcionais, fragmentação de funções e localização de locais com uma quantidade desproporcional de tempo gasto na execução. Muitas coisas foram feitas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao longo do caminho, formulamos esses lugares onde você pode apertar seriamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, serialização. </font><font style="vertical-align: inherit;">Utilizado pela primeira vez o java.io padrão. </font><font style="vertical-align: inherit;">Mas se apertarmos o Cryo, no nosso caso, obteremos um aumento de 2,5 vezes na velocidade de serialização e uma redução de 3 vezes na quantidade de dados serializados (o que significa que o IO é 3 vezes menor, o que consome apenas os principais recursos). </font><font style="vertical-align: inherit;">Mas, com mais detalhes, este é um tópico para um artigo técnico separado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas o ponto chave, ou "onde o elefante se escondeu" - tentarei descrever em um parágrafo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ponto especial 4. Recepção para encontrar uma solução. </font><font style="vertical-align: inherit;">"Problema = solução"</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando obtemos / configuramos por chave - nos cálculos, ela foi executada como 1 operação, afeta IO no volume igual a chave + valor do objeto (na forma serializada, é claro). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas e se o próprio objeto no qual chamamos get / set for um Mapa, que também obtemos por get / set do disco. Quanto o IO será feito neste caso? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em nossos cálculos, esse recurso não foi levado em consideração. Ou seja, foi considerado como 1 IO para chave + valor do objeto. Mas de fato?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, no armazenamento de Valor-Chave, pela chave-1, há um objeto obj-1 com o tipo Map, no qual um determinado objeto obj-2 deve ser armazenado na chave chave-2. Aqui pensamos que a operação exigiria um IO para a chave 2 + obj-2. Mas, na realidade, você precisa considerar o obj-1, manipulá-lo e enviá-lo para IO: chave-1 + obj-1. E se for um mapa no qual existem 1000 objetos, o consumo de IO será cerca de 1000 vezes mais. E se 10.000 objetos, então ... Foi assim que eles conseguiram o "lastro". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando um problema é identificado, a solução geralmente é óbvia.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No nosso caso, isso se tornou uma estrutura especial para manipulações dentro do Mapa aninhado. </font><font style="vertical-align: inherit;">Ou seja, esse valor-chave, que para obter / definir leva duas chaves ao mesmo tempo, que devem ser aplicadas seqüencialmente: chave-1, chave-2 - ou seja, para o primeiro nível e para o aninhado. </font><font style="vertical-align: inherit;">Como implementar essa estrutura - vou contar detalhadamente com prazer, mas novamente, em um artigo técnico separado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, neste episódio, enfatizo e promovo esse recurso: um problema extremamente detalhado é uma boa solução.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusão</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, tentei mostrar os pontos e armadilhas organizacionais que podem surgir. </font><font style="vertical-align: inherit;">Tais armadilhas são muito claramente visíveis “de lado” ou ao longo do tempo, mas é muito fácil entrar nelas quando você se encontra ao lado delas. </font><font style="vertical-align: inherit;">Espero que alguém se lembre dessa descrição e, no momento certo, o lembrete funcione: "Eu já ouvi algo assim em algum lugar antes". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, o mais importante - agora que tudo é contado sobre o processo, sobre os momentos psicológicos, sobre os organizacionais. </font><font style="vertical-align: inherit;">Agora que temos uma idéia de quais tarefas e sob quais condições o sistema foi criado. </font><font style="vertical-align: inherit;">Agora - você pode e deve falar sobre o sistema do lado técnico - que tipo de modelo matemático é esse, e quais truques no código que criamos e quais soluções inovadoras pensamos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobre isso no próximo artigo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enquanto isso, Happy New Code!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt504374/index.html">Passagem de gráfico simples: pesquisa em profundidade e amplitude usando JavaScript como exemplo</a></li>
<li><a href="../pt504382/index.html">Como eu (PhD Neurobiology) me tornei um cientista de dados em 6 meses</a></li>
<li><a href="../pt504384/index.html">Introduzir gradualmente o TypeScript no seu projeto React</a></li>
<li><a href="../pt504386/index.html">Vassbotn H. Variáveis ​​virtuais de classe</a></li>
<li><a href="../pt504392/index.html">Quantos programadores e palavras você precisa para reconhecer um passaporte escrito à mão?</a></li>
<li><a href="../pt504402/index.html">29 de maio - Java Digest</a></li>
<li><a href="../pt504408/index.html">Modelo de estrutura de teste simples e conveniente no selenide para autotestes da interface do usuário</a></li>
<li><a href="../pt504412/index.html">Campeonato de programação on-line "Finais Abertos de Treinamento em Moscou"</a></li>
<li><a href="../pt504414/index.html">Como a Microsoft matou o AppGet</a></li>
<li><a href="../pt504420/index.html">Escrevendo uma arena PvP baseada em turnos com movimentos simultâneos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>