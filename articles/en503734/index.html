<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úåüèΩ üö¶ üõê Say poor word for LINQ ‚õé üëÉ üõÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All my short life as a c # programmer, I thought that LINQ is not primarily about the performance of the code, but about the performance of the progra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Say poor word for LINQ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503734/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All my short life as a c # programmer, I thought that LINQ is not primarily about the performance of the code, but about the performance of the programmer, how fast he writes the code, and not how fast the processor executes this code. </font><font style="vertical-align: inherit;">And the performance problems of both the code and the programmer are resolved after identifying the bottlenecks. </font><font style="vertical-align: inherit;">Therefore, I often write </font></font><code>var groupedByDate = lst.GroupBy(item =&gt; item.IssueTime.Date).Select(‚Ä¶).ToList()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and do this not because of harm or malicious intent, but it‚Äôs just easier to debug the code. </font><font style="vertical-align: inherit;">For the list, just place the mouse cursor over the text of the variable and you can immediately see if there is something there or not.</font></font></p><a name="habracut"></a><br>
<h4 id="nachalo"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start</font></font></h4><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After reading the article ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsuccessful article about accelerating reflection</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù and calming down emotions about ‚Äúsomeone is wrong on the Internet‚Äù, I wondered if it is possible to make ‚ÄúLINQ to Objects‚Äù code close in performance to ‚Äúmanual‚Äù. </font><font style="vertical-align: inherit;">Why exactly LINQ to Objects? </font><font style="vertical-align: inherit;">In my work, I often use only the LINQ to Objects and LINQ to Entities providers. </font><font style="vertical-align: inherit;">The performance of LINQ to Entities is not critical for me; </font><font style="vertical-align: inherit;">it is critical how optimal the generated SQL query will be for the target database server and how quickly the server will execute it.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a basis, I decided to use the project of the author of the article. </font><font style="vertical-align: inherit;">In contrast to the examples from the Internet, where a code is mainly compared like </font></font><code>integerList.Where(item =&gt; item &gt; 5).Sum()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a ‚Äúmanual‚Äù code containing </font></font><code>foreach</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and so on, the example from the article seemed interesting and vital to me.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first thing I did was use a single string comparison function. </font><font style="vertical-align: inherit;">In the source code, in methods that perform the same function, but located in opposite corners of the ring, different methods are used, in one case </font></font><code>variable0.Equals(constant0, StringComparison.InvariantCultureIgnoreCase)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and in another </font></font><code>variable0.ToUpperInvariant() ==constant0.ToUpperInvariant()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is especially annoying for the constant that each method call is converted to uppercase. </font><font style="vertical-align: inherit;">I chose the third option using in both cases </font></font><code>variable0.ToUpperInvariant() ==constant0InUpperCaseInvariant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then all the code that was not directly related to comparing LINQ performance and manual code was thrown out. </font><font style="vertical-align: inherit;">The first to be caught was the code that creates and initializes the class object </font></font><code>Mock&lt;HabraDbContext&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">What is the point of creating a database connection for each test, once is enough? </font><font style="vertical-align: inherit;">It has been moved beyond performance tests.</font></font></p><br>
<pre><code class="cs hljs">IStorage _db;<font></font>
<font></font>
[<span class="hljs-meta">GlobalSetup</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Setup</span>(<span class="hljs-params"></span>)</span><font></font>
{<font></font>
    _db = MockHelper.InstanceDb();<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">private</span> IStorage DBInstance =&gt; _db;</code></pre><br>
<p>    ‚Ä¶  ‚Äî , !    Linq      ¬´¬ª !</p><br>
<p><img src="https://habrastorage.org/webt/nf/g3/n7/nfg3n7ucmeox6i0kdhzh9bk_mqu.png" alt="image"></p><br>
<p>   ¬´      -  ¬ª   .  LINQ .     ,    ‚Äî .</p><br>
<h4 id="celi-menyayutsya"> </h4><br>
<p>       ,     ,     LINQ vs ¬´¬ª .        .         .      .</p><br>
<p> ,            ,   ,          (<code>[Params(1, 10, 100, 1000)]</code>).      .           .        .     <code>StatisticColumnRelStdDev</code>.</p><br>
<p>     ‚Äî    <code>FastHydrationLinq</code>,        <code>ManualHydrationLinq</code> ‚Äî     .  ,   ,  (Fast)(Manual)(Slow)HydrationLinq vs (Fast)(Manual)(Slow)Hydration,        <code>ManualHydrationLinq</code>.  <code>FastHydrationLinq</code>   -    .     .</p><br>
<p>           <code>ToArray</code>, <code>ToDictionary</code>     <code>IEnumerable&lt;T&gt;</code>       .   ,     <code>FastContactHydrator2</code>.         -  <code>Action&lt;Contact, string&gt;</code> c <code>ConcurrentDictionary&lt;string, Action&lt;Contact, string&gt;&gt;</code>  <code>IEnumerable&lt;KeyValuePair&lt;string, Action&lt;Contact, string&gt;&gt;&gt;</code>.    <code>GetContact2</code>,    <code>Sum</code>,       .</p><br>
<pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> Contact <span class="hljs-title">GetContact2</span>(<span class="hljs-params">IEnumerable&lt;PropertyToValueCorrelation&gt; correlations</span>)</span><font></font>
{<font></font>
    <span class="hljs-keyword">var</span> contact = <span class="hljs-keyword">new</span> Contact();
    <span class="hljs-keyword">int</span> dummySum = _propertySettersArray.Join(correlations, propItem =&gt; propItem.Key, corrItem =&gt; corrItem.PropertyName, (prop, corr) =&gt; { prop.Value(contact, corr.Value); <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>; }).Sum();
    <span class="hljs-keyword">return</span> contact;<font></font>
}</code></pre><br>
<p> <code>ParseWithLinq</code>   </p><br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IEnumerable&lt;KeyValuePair&lt;<span class="hljs-keyword">string</span>, <span class="hljs-keyword">string</span>&gt;&gt; ParseWithLinq2(<span class="hljs-keyword">string</span> rawData, <span class="hljs-keyword">string</span> keyValueDelimiter = <span class="hljs-string">":"</span>, <span class="hljs-keyword">string</span> pairDelimiter = <span class="hljs-string">";"</span>)<font></font>
    =&gt; rawData.Split(pairDelimiter)<font></font>
    .Select(x =&gt; x.Split(keyValueDelimiter, StringSplitOptions.RemoveEmptyEntries))<font></font>
    .Select(x =&gt; x.Length == <span class="hljs-number">2</span> ? <span class="hljs-keyword">new</span> KeyValuePair&lt;<span class="hljs-keyword">string</span>, <span class="hljs-keyword">string</span>&gt;(x[<span class="hljs-number">0</span>].Trim(), x[<span class="hljs-number">1</span>].Trim())<font></font>
                                : <span class="hljs-keyword">new</span> KeyValuePair&lt;<span class="hljs-keyword">string</span>, <span class="hljs-keyword">string</span>&gt;(_unrecognizedKey, x[<span class="hljs-number">0</span>].Trim()));</code></pre><br>
<p>   .</p><br>
<p>     <code>FastContactHydrator2</code>,     ,  ,               ,        -,      ( <code>ParseWithLinq</code>  <code>ParseWithoutLinq</code>).        .      ,   ,   <code>ToArray</code>.       10   <code>var result = new List&lt;PropertyToValueCorrelation&gt;(10)</code>.  10?  42   ,   10  .       Fair  .</p><br>
<p>     .           .    <code>GetFakeData</code>    .   ,      .<br>
      ,       ,        ¬´ ¬ª (RelStdDev).     <code>N=1000</code>.</p><br>
<p>    :</p><br>
<pre><code class="plaintext hljs">-  `ManualHydration`, `SlowHydration`, `FastHydration`, `ManualHydrationLinq`, `SlowHydrationLinq`, `FastHydrationLinq` -     ,  ;</code></pre><br>
<ul>
<li> <code>ManualHydrationFair</code>, <code>ManualHydrationFairLinq</code>, <code>FastHydrationFairLinq</code> ‚Äî     ,      ;</li>
<li> <code>FastHydrationLinq2</code> ‚Äî        , , - ,         LINQ;</li>
<li> <code>N</code>    ,     ;</li>
<li> <code>Ratio</code>           <code>FastHydrationLinq2</code>.</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/li/kh/jn/likhjnapsei7x-unzwduff1ivwq.png" alt="image"><br>
<em>Linq-   </em></p><br>
<p>   ?   ‚Äî  <code>FastHydrationLinq2</code>    <code>ManualHydrationLinq</code>   <code>Ratio</code>.    26,361.37 Œºs  26,422.17 Œºs   <code>N=1000</code>.    /     <code>N</code>.     <code>ManualHydrationFairLinq</code>,    8% ,        .     <code>FastHydrationFairLinq</code>,     1%  -.</p><br>
<p>     Fair-.     ,  <code>ManualHydrationFairLinq</code>  8%     .  <code>FastHydrationFairLinq</code>   <code>FastHydrationLinq</code> 12%.    Linq       .</p><br>
<p>     ,  .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>          .   ,          <code>MockHelper.InstanceDb()</code>   <code>Setup</code>,         .          ‚Äî      ,       <code>GetFakeData</code>,        .  ,     ‚Äî    .    <code>MockHelper.InstanceDb()</code>    .</p><br>
<p>    <code>N</code>,   <code>MakeGarbage</code>.   <code>False</code>     , <code>True</code> ‚Äî      .</p><br>
<p><img src="https://habrastorage.org/webt/no/bl/lh/nobllhj80burrhvb3udycfq5hkg.png" alt="image"><br>
<em>    </em></p><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">      N</b>
                        <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ak/0y/a7/ak0ya7v5fldvc-krutvw53rb7fu.png" alt="image"></p></div>
                    </div><br>
<p>Voil√†,       ,             .    ‚Äî             <code>N=1</code>.    10%      82%    .</p><br>
<p>‚Ä¶    .</p><br>
<h4 id="v-pogone-za-neulovimym-dzho">    </h4><br>
<p>       ,      ,      ¬´¬ª  ‚Äî Linq-,             :</p><br>
<p><img src="https://habrastorage.org/webt/vm/ui/__/vmui__wnkqlox2jky12xm28cx5g.png" alt="image"><br>
<em> <code>N=1</code>  <code>MakeGarbage=True</code>     ¬´¬ª </em></p><br>
<p>  ,     ,   ,    LINQ     .<br>
  ¬´Gen X¬ª  ¬´Allocated¬ª  <code>N=1</code>  <code>MakeGarbage=True</code>     o ,   <code>FastHydrationLinq2</code> </p><br>
<pre><code class="plaintext hljs">|                                |      Gen 0 |   Gen 1 | Gen 2 |   Allocated |<font></font>
|¬´¬ª     |    20.5078 |  0.4883 |     - |    63.95 KB |<font></font>
|Linq-        |    20.7520 |       - |     - |    63.69 KB |</code></pre><br>
<p>     <code>ManualHydrationFairLinq</code>  .</p><br>
<p>            .       ,   ,            ‚Äî  .<br>
        ,       ?      .   ,     <code>N</code>  <code>[Params(1, 100)]</code>  <code>MakeGargabe=True</code>.     ¬´¬ª ‚Äî Linq-,          .    ‚Äî     ,   ‚Äî    Linq-,    Linq ‚Äî  ‚Äî  ‚Äî Linq.    ‚Äî   .       .</p><br>
<p>  ,         ,     ‚Äî Linq-  .   ,  .          paint.net,       .       paint.net    ‚Äî            paint.net   .  paint.net ‚Äî ¬´¬ª  ,   ‚Äî Linq-   .</p><br>
<p>     ‚Äî  <code>N</code>   1, 10, 100, 1000   <code>MakeGarbage</code>   <code>[ParamsAllValues]</code>.  paint.net,   ‚Äî ¬´¬ª  .      ‚Äî  Linq-   .    paint.net  Visual Studio ‚Äî ¬´¬ª    .      ,    80-    .    ,            Linq-  2%.</p><br>
<h4 id="vyvody"></h4><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After writing the tests and analyzing the results, my opinion about LINQ has not changed - using it my productivity in writing code is higher than without it; </font><font style="vertical-align: inherit;">LINQ to Objects performance is fine. </font><font style="vertical-align: inherit;">Using delayed execution of LINQ code as a means of improving performance does not make much sense.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If in a project there are performance problems due to the garbage collector - the .net birth injury, then probably choosing this technology was not the best solution.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My test code is available </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en503724/index.html">Wi-Fi or twisted pair - which is better?</a></li>
<li><a href="../en503726/index.html">6 ways to significantly speed up pandas with a couple of lines of code. Part 1</a></li>
<li><a href="../en503728/index.html">Researchers: hackers are increasingly carrying out brute force attacks on financial services</a></li>
<li><a href="../en503730/index.html">Free Data Science Courses from Harvard University</a></li>
<li><a href="../en503732/index.html">JUG Ru Group # 3 Online Stream Week</a></li>
<li><a href="../en503742/index.html">Poly Studio Video Bar Test (video)</a></li>
<li><a href="../en503744/index.html">Three cases of workstation inventory in remote work conditions</a></li>
<li><a href="../en503746/index.html">GitHub: Zabbix template for monitoring data collection tasks in MaxPatrol SIEM</a></li>
<li><a href="../en503758/index.html">Experience in preparing for certification Professional Scrum Master II (Scrum.org)</a></li>
<li><a href="../en503760/index.html">Coronavirus cyberattacks: all salt in social engineering</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>