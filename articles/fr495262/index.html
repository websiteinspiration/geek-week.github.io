<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏵️ 👨🏿‍⚕️ 🌽 Pratique de mise à niveau de la version PostgreSQL. Andrey Salnikov 👩‍💼 👎🏾 🈺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je vous suggère de vous familiariser avec le décodage du rapport 2018 d'Andrei Salnikov, "La pratique de la mise à jour des versions de PostgreSQL"
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Pratique de mise à niveau de la version PostgreSQL. Andrey Salnikov</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495262/"><p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je vous suggère de vous familiariser avec le décodage du rapport 2018 d'Andrei Salnikov, "La pratique de la mise à jour des versions de PostgreSQL"</font></font></strong></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour la plupart, les administrateurs système et le DBA ont peur d'effectuer des mises à jour majeures des versions de la base de données (RDBMS) comme un incendie, surtout si cette base de données est en fonctionnement et a une charge assez élevée. </font><font style="vertical-align: inherit;">La raison principale en est un certain temps d'arrêt de la base de données, qui est toujours impliqué dans la planification d'un tel travail.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En pratique, ce type de mise à niveau prend assez de temps et souvent les administrateurs peu expérimentés dans de telles opérations doivent revenir à l'ancienne version des bases de données en raison des erreurs plutôt banales qui auraient pu être évitées lors de la préparation.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans Data Egret, nous avons accumulé une vaste expérience dans la réalisation de mises à niveau majeures de PostgreSQL dans des projets où il n'y a pas de place pour l'erreur. Je partagerai mon expérience et parlerai des prochaines étapes du processus: comment se préparer à la mise à niveau de PostgreSQL? Que faut-il faire au stade de la préparation? Comment planifier la séquence d'actions pour la mise à niveau elle-même? comment mener à bien la procédure de mise à niveau, sans revenir à la version précédente de la base de données? comment minimiser ou même éviter les temps d'arrêt de l'ensemble du système lors de la mise à niveau? Quelles étapes dois-je effectuer après une mise à niveau réussie de PostgreSQL? Je parlerai également des deux procédures de mise à niveau de PostgreSQL les plus populaires - pg_upgrade et pg_dump / pg_restore, les avantages et les inconvénients de chaque méthode et parlerai de tous les problèmes typiques à toutes les étapes de cette procédure, et comment les éviter.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le rapport sera intéressant à la fois pour les débutants et les administrateurs de base de données qui travaillent depuis longtemps avec PostgreSQL, mais qui souhaitent en savoir plus sur la façon de planifier et d'effectuer correctement la mise à niveau le plus indolore possible.</font></font></p><br>
<p><img src="https://habrastorage.org/webt/qh/px/xd/qhpxxdul2aseoxu2_ohgojxftpu.png"></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">salut! </font><font style="vertical-align: inherit;">Je travaille chez Data Egret. </font><font style="vertical-align: inherit;">Nous nous engageons à prendre en charge les serveurs PostgreSQL et à fournir des services de conseil PostgreSQL. </font><font style="vertical-align: inherit;">Et la pratique a montré que très peu de gens mettent à jour la base de données. </font><font style="vertical-align: inherit;">Ils ont lancé le projet, installé la version actuelle à ce moment-là et fonctionnent toujours.</font></font></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le rapport comprendra trois parties. </font><font style="vertical-align: inherit;">Le premier est une introduction afin d'arriver à une terminologie commune. </font><font style="vertical-align: inherit;">La seconde concerne les mises à jour mineures. </font><font style="vertical-align: inherit;">Et le troisième sera majeur.</font></font></p><br>
<p><img src="https://habrastorage.org/webt/yb/wk/bv/ybwkbvbiywdppdk19sky8vxd_vk.png"></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le rapport a pour objet de répondre aux questions.</font></font></p><br>
<ul>
<li>  ?   ,  Postgres    .     ,  - .            ,  .       ,    .    .</li>
<li>,       . </li>
<li> ,             ,   .</li>
<li>  ,   : «         ?».   . </li>
<li>       ,          .     ,     production   .</li>
</ul><br>
<p>     ,         Postgres.</p><br>
<p><img src="https://habrastorage.org/webt/9n/6v/uo/9n6vuovta77udhortpo17qcbhqw.png"></p><br>
<p>    ,   ,    .  10        .   ,  ,    ,   –   .</p><br>
<p><img src="https://habrastorage.org/webt/zz/ua/ku/zzuakuky0bgkb0_8pnyuxv56f3q.png"></p><br>
<p>  10-      .     ,  .   –    ,   –   . </p><br>
<p><img src="https://habrastorage.org/webt/o9/rg/d6/o9rgd6cwxfxj2ysv6rrnskysrt8.png"></p><br>
<p>    ?</p><br>
<p> .   ,    –       .      9.6      ,  ,  ,    .    .   . </p><br>
<p> 10-     .   ,      .</p><br>
<p> .    .                ,   . </p><br>
<p>        .             . </p><br>
<p>     –  ,     .  6.    .     ,        . . .    9.2.    ,   ,  9.2  .     9.2,     .</p><br>
<p>       :     .</p><br>
<p><img src="https://habrastorage.org/webt/mk/mj/fo/mkmjfozpligyczlzq19b4u7pudw.png"></p><br>
<p>  .   ,         ,       production :</p><br>
<ul>
<li>    release notes.     ? ,     release notes,   release notes    ,      .   ,    .   - .      ,              ,          .  ,         10- ,     -.   ,  ,   .</li>
<li>       ?  .  ,          .     release notes,      . ,      -  .  , Postgres      ,  ,  .         ,       Postgres,   .</li>
<li>    - ,        ,     ,        ,       production .</li>
<li> ,             –  ,      .    —  ,     ,          ,    .      .</li>
</ul><br>
<p> ,   ,  , .</p><br>
<p><img src="https://habrastorage.org/webt/ft/wd/sx/ftwdsxjongoxcwtzmofeol4flxs.png"></p><br>
<p>    .            .</p><br>
<p>   ,        .         ,      Postgres.     Postgres.</p><br>
<p>  :</p><br>
<ul>
<li>     PostgreSQL.    ,     -  ,   ,  , Postgres   .      .             .         ,   .  Ubuntu, ,       ,  .   start.conf.          .      .</li>
<li>    PostgreSQL  .      ,           ,  common-       .   .</li>
<li> – checkpoint.    checkpoint?      ,        .         ,      ,    ,   .      ,  ,       , , 250 GB,         .         checkpoint,                 Postgres.</li>
<li>  ?    pgbouncer,             ,          .    pgbouncer,  pgbouncer    .  pgbouncer’    –    ,      -       .       latency   . . .     ,      pgbouncer,     .     checkpoint,   pgbouncer,                .</li>
<li>   ,      .            .     ,      .</li>
<li> ,     extensions,    -  extensions.    –          extensions    .   .       .     .      .     . </li>
<li>    (  ,     release notes)      release notes.         –    -  . ,     9.6.1  9.6.6,   ,     release notes  9.6.2 – 9.6.6.      - ,    ,       ,       .</li>
<li>    standby ,   ,          .     ,      14-  ,    2.3     .     .       ,     .    .</li>
</ul><br>
<p>   ,    release notes.</p><br>
<p><img src="https://habrastorage.org/webt/r7/po/fw/r7pofwu2d6pd3sfzov_zbnw-lsq.png"></p><br>
<p>      Postgres.org.    9.6.2.      ,         .</p><br>
<p>    ?        ,                 ,              .           ,                   .         .</p><br>
<p>         .       .  . , , release notes.   .</p><br>
<p><img src="https://habrastorage.org/webt/tp/fm/y4/tpfmy4cemzde9czdxxsr0pljldm.png"></p><br>
<p>    ,      .       . ,  ,     9.6.5.         9.6.1.     ,      .    -   .      ,   –    .     –   .</p><br>
<p>  ,     . . .    bash- ,         .     alter extension, update     .</p><br>
<p><img src="https://habrastorage.org/webt/r0/r8/ek/r0r8ekgtztzazijacgoii-0qpss.png"></p><br>
<p>   ?</p><br>
<ul>
<li> .     .   ,           ,           . </li>
<li>      . ,        ,        ,   release notes.</li>
<li>      . ,     - ,     .    .   .       . </li>
<li>   , . .        .   ,     checkpoint,         30   . </li>
</ul><br>
<p><img src="https://habrastorage.org/webt/ga/ph/cc/gaphcci6ovprvx85tkdq4ahzvve.png"></p><br>
<p>      –   .</p><br>
<p>    .   ,    .       .</p><br>
<ul>
<li>Pg_dump  restore –      .       ,      .     -    .</li>
<li>Pg_upgrade –    ,   , ,  95 % ,      .      . </li>
<li>     .</li>
</ul><br>
<p>       .</p><br>
<p><img src="https://habrastorage.org/webt/nv/6c/6t/nv6c6tqljcr8ergpes79hmwrjrg.png"></p><br>
<p>   pg_dump      ?</p><br>
<ul>
<li>     .     ,     .   9.5,  ,   10.  Ubuntu   ,  RedHat     –   Postgres.  ,        .</li>
<li>      locale,       .</li>
<li>   Postgres,  ,    ,  ,  ,         .</li>
<li>    ,            pg_dumop.       PostgreSQL.     ?   pg_dump    ,      ,   ,           .    ,             ,       .       .    PostgreSQL, . .  ,  .    ,    .</li>
<li>     .     pg_dump,         .         .    ,       .</li>
<li>        .               .</li>
<li>  ,       ,   ,        PostgreSQL.</li>
</ul><br>
<p>   ,   ,      ,  .</p><br>
<p><img src="https://habrastorage.org/webt/yg/wy/_z/ygwy_zlxpezpbldwtlfbzkfb_ce.png"></p><br>
<p>  pg_dump:</p><br>
<ul>
<li>      .   – .      .</li>
<li>  .    .</li>
<li>   .   :   ,   ,   .    ,    .</li>
<li>      ,      ,              .     .</li>
<li>     .     ,      .       .    SSD-,  SSD-  .                ,     ,  .       .</li>
<li>    .    ,              .        ,   . ,   ,  .     ,          ,       .     .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/0_/qe/9o/0_qe9onjahbwmv3gajs4i5gdbus.png"></p><br>
<p>     ,  pg_upgrade.</p><br>
<ul>
<li>Pg_upgrade        .       , . . ,    .   .</li>
<li>        .       , ,     .</li>
<li>     PostgreSQL.         -,        .</li>
<li>    .      .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/j_/wo/jc/j_wojcl1m25krfsyc4qkq_fjmdo.png"></p><br>
<p> ,   pg_upgrade.        : ,         ,   .</p><br>
<p>,    pg_upgrade,       ,             ,            .    ,     ,         .      .</p><br>
<p>   ,     – pg_upgrade  dump  restore ,   pg_dump, restore     ,       ,      ,      .   .</p><br>
<p>       .      ,       ,           8.4.  Postgres        .</p><br>
<p>    ,            (, 9.0  10)      -.       ,       ,       .      .      ,     .</p><br>
<p><img src="https://habrastorage.org/webt/7l/9t/6a/7l9t6aqjizxpby0hca5onk0d4ci.png"></p><br>
<p>    ,         production. . .      ,    –      .</p><br>
<ul>
<li>     PostgreSQL.</li>
<li>     locace.   .</li>
<li> pg_upgrade.    «check». Check   ,      .   ,     -    ,      ,   , ,                .       ,     .      ,         .</li>
<li>Pg_dumpall — schema-only.     check   .       pg_dumpall – schema-only,     .     ,       .    ,    ,  check      ,  dump .</li>
<li>   extensions   .    –  PostGIS,   PostGIS    Postgres.  extension      Postgres,    Postgres.   changelog   –      ,  pg_upgrade ,         .    dump restore .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/3g/4x/f7/3g4xf7lyqcnvv3hi-bs0fra4wj4.png"></p><br>
<p>  ,  ,   ,  .</p><br>
<ul>
<li><p>    locale,    pg_dumpall only, restore.</p><br>
</li>
<li><p>   .      ,  pgbouncer       , . .    ,   .</p><br>
</li>
<li><p>   checkpoints,          ,     .</p><br>
</li>
<li><p>     pg_upgrade.     ,      .               .      45 .       ,    45 ,    .        15 ,     .         .</p><br>
<p><img src="https://habrastorage.org/webt/et/sy/er/etsyeryqtvdimdjivvq0jx_lrjw.png"></p><br>
</li>
<li><p>   ,       .    hard links.        .</p><br>
<p><img src="https://habrastorage.org/webt/cs/eo/sc/cseoscbeymrk5pjlzwbj9grk_rm.png"></p><br>
</li>
<li><p>    PostgreSQL.        .          PostgreSQL?     .  , pg_upgrade    .</p><br>
</li>
<li><p>     .</p><br>
</li>
<li><p>        .            10 .      ,    .</p><br>
</li>
</ul><br>
<p>     :</p><br>
<ul>
<li><p> pg_upgrade     .    ,          :   ,  10     .</p><br>
</li>
<li><p>         ,       ,   .</p><br>
</li>
<li><p>   9.5     .    ,                .</p><br>
<p><img src="https://habrastorage.org/webt/gi/dm/uk/gidmuk_tnbcrxet3qoghxfvpkd4.png"></p><br>
</li>
<li><p>    .    .        ,    ,     .   ,    vacuumdb    1, 10 .         ,      .  -      .  - .    ,     ,     .</p><br>
</li>
<li><p>    .         ,     .      - .     ,     ,  .         ,  ,         .</p><br>
</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/kr/dh/y9/krdhy9toj4rsxvmlbokhhjaahno.png"></p><br>
<p>     .</p><br>
<p><img src="https://habrastorage.org/webt/o0/-v/_-/o0-v_-tammgsfm23g7spto9w080.png"></p><br>
<ul>
<li>Pg_upgrade   extensions.    ,   .</li>
<li>   release notes  .</li>
<li> ,   ,      extensions      – alter extension EXTENSION_NAME update.  .    pg_stat_statements,   -     .    pg_upgrade,         pg_stat_statements.      .     .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/ri/50/6n/ri506n_tl93nkyy_m1-9gtrdtt4.png"></p><br>
<p>    –   ?   :</p><br>
<ul>
<li>  -  - .</li>
<li>  ,     ,    ,    ,  ,  .      .  ,   ,           .</li>
<li>   ?     Postgres.       .     . ,  , , 10  .</li>
<li>          PostgreSQL.</li>
<li> pg_basebackup        .      .</li>
<li>     PostgreSQL.</li>
<li>   ,       rsync,       .   , ,  ,            .   rsync   ,   .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/fe/s_/_i/fes__isx8gdxhkejzomqabxytxc.png"></p><br>
<p>    .   :</p><br>
<ul>
<li>-,        PostgreSQL.</li>
<li>    .   .</li>
</ul><br>
<p>  9.4    .     .   ,    10   11        .</p><br>
<p>   ,   .  Slony-l, Londiste, Bucardo  . .   .</p><br>
<p><img src="https://habrastorage.org/webt/uy/yn/rd/uyynrdnjuv8_go1ttq3rsmsn2ns.png"></p><br>
<p>       ?</p><br>
<ul>
<li>    PostgreSQL.</li>
<li>-         Postgres    Postgres.</li>
<li>  ,  ,        .       .</li>
<li> ,        .    .    ,         Postgres.   ,     , . .     .    ,    .</li>
<li>      Postgres, ,     .</li>
<li>         Postgres,    . ,  ,    .     -  .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/8g/tv/of/8gtvofu-acouuounr5zfnjozen4.png"></p><br>
<p>     ?</p><br>
<ul>
<li>        ,      .  -  .</li>
<li> ,    .     . . . ,    .</li>
<li>     sequences,       -.</li>
<li>    DDL,    .   DDL  ,  ,  .          ,  .</li>
<li>     ,         ,  .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/2a/db/rv/2adbrv0193cxs8sglbod0f8jfnu.png"></p><br>
<p>   ,            .     pg_upgrade      ,      .</p><br>
<p>   ?  ,     3 TB,       2 SSD RAID  3 TB.    .         .</p><br>
<p>         .    .</p><br>
<p> ,    ,      99  - 9-  .    15 .       15    .  .        - .</p><br>
<p><img src="https://habrastorage.org/webt/bq/sl/ie/bqsliego7mt3nyx__tfzyrrlwb8.png"></p><br>
<p>     ,       pg_upgrade.      .         .</p><br>
<p>    .</p><br>
<p></p><br>
<p><em> !    pgbouncer     ,       , , ,    ,   .      ?</em></p><br>
<p>       ,        SSD  .         SSD   , . .     .       . , , ,  ,    .  ,     ,      .    ,      Postgres.      ,   .</p><br>
<p><em>   pg_worm  pg_hibernate,    ?</em></p><br>
<p> ,       ,      .</p><br>
<p><em>  !        pg_upgrade?</em></p><br>
<p> , .        ,   .       ,    .    ,     ,  -  ,    .        ,     ,    .        ,    .</p><br>
<p><em>  rsync -?</em></p><br>
<p>  rsync? Rsync     .  ,       ,   , , .    ?      pg_upgrate   .  ,  .     – pg_start_backup.     rsync    .     -  ,    rsync   ,   .   ,          , ,  tablespace  HDD,  rsync  ,      .     –  ,  .    ,         .  –  pg_basebackup.</p><br>
<p><em>  !   ,     …</em></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela s'applique aux mises à jour mineures.</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495248/index.html">Le rôle de l'auto-isolement et du lavage des mains</a></li>
<li><a href="../fr495250/index.html">Les manettes de jeu ont-elles un avenir?</a></li>
<li><a href="../fr495254/index.html">Simulation de cyberattaques ciblées, Red Team, Pentest, analyse de vulnérabilité. Avantages et inconvénients de diverses méthodes</a></li>
<li><a href="../fr495256/index.html">À propos des ports et du chiffrement dans les serveurs de messagerie</a></li>
<li><a href="../fr495258/index.html">Comment Zoom est devenu l'entreprise la plus importante à l'ère des coronavirus</a></li>
<li><a href="../fr495266/index.html">E-learning de la Renaissance. Pourquoi 2020 montrera tous les avantages de l'enseignement à distance</a></li>
<li><a href="../fr495268/index.html">Cas UI / UX: automatisation du stationnement dans les aéroports</a></li>
<li><a href="../fr495272/index.html">Emulateurs SNES à quelques pixels de la perfection absolue</a></li>
<li><a href="../fr495274/index.html">Comment réparer les fuites de route</a></li>
<li><a href="../fr495276/index.html">Et démontrer, ou comment nous avons réussi l'audit de durabilité opérationnelle à l'Uptime Institute</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>