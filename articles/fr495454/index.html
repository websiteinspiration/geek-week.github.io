<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕐 👇🏻 🙆🏻 Brève introduction à BPF et eBPF 🤞🏻 ♟️ 😼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Nous vous informons que nous nous apprêtons à sortir le livre " Linux Observability with BPF ".
 
 
 Alors que la machine virtuelle BPF...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Brève introduction à BPF et eBPF</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/495454/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font><font style="vertical-align: inherit;">Nous vous informons que nous nous apprêtons à sortir le livre " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux Observability with BPF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pw/bv/rl/pwbvrl5-5goay7zxvi8tb3fisrc.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors que la machine virtuelle BPF continue d'évoluer et est activement appliquée dans la pratique, nous avons traduit pour vous un article qui décrit ses principales fonctionnalités et son état actuel.</font></font><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces dernières années, les outils et techniques de programmation ont commencé à gagner en popularité, conçus pour compenser les limitations du noyau Linux dans les cas où un traitement de package hautes performances est requis. L'une des méthodes les plus populaires de ce type est appelée </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contournement du noyau</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (contournement du noyau) et permet aux cœurs de couche réseau qui passent d'effectuer tout le traitement des paquets à partir de l'espace utilisateur. Le contournement du noyau implique également la gestion de la carte réseau à partir de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'espace utilisateur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En d'autres termes, lorsque vous travaillez avec une carte réseau, nous nous appuyons sur le pilote de l' </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">espace utilisateur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En transférant le contrôle total sur la carte réseau au programme depuis l'espace utilisateur, nous réduisons les coûts associés au noyau (contexte de commutation, traitement du niveau réseau, interruptions, etc.), ce qui est assez important lorsque vous travaillez à des vitesses de 10 Gb / s ou plus. Le contournement du noyau et une combinaison d'autres fonctionnalités ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">traitement par lots</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) et un réglage précis des performances ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comptabilité NUMA</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isolation du processeur</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc.) correspondent aux bases du traitement réseau hautes performances dans l'espace utilisateur. </font><font style="vertical-align: inherit;">Le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DPDK</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><i><font style="vertical-align: inherit;">Data Plane Development Kit) d'</font></i><font style="vertical-align: inherit;"> Intel </font><font style="vertical-align: inherit;">est peut-être un exemple modèle de cette nouvelle approche du traitement </font><font style="vertical-align: inherit;">des </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">packages</font></a><font style="vertical-align: inherit;"> .</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), bien qu'il existe d'autres outils et techniques bien connus, notamment VPP de Cisco (Vector Packet Processing), Netmap et, bien sûr, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snabb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'organisation des interactions réseau dans l'espace utilisateur présente un certain nombre d'inconvénients:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le noyau du système d'exploitation est le niveau d'abstraction des ressources matérielles. </font><font style="vertical-align: inherit;">Étant donné que les programmes de l'espace utilisateur doivent gérer leurs ressources directement, ils doivent également gérer leur propre matériel. </font><font style="vertical-align: inherit;">Cela signifie souvent que vous devez programmer vos propres pilotes.</font></font></li>
<li>      ,        ,  .        , , ,      .</li>
<li>    ,               .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En substance, lors de l'organisation des interactions réseau dans l'espace utilisateur, une productivité accrue est obtenue en transférant le traitement des paquets du noyau vers l'espace utilisateur. XDP fait exactement le contraire: déplace les programmes réseau de l'espace utilisateur (filtres, convertisseurs, routage, etc.) vers la zone du noyau. XDP nous permet d'effectuer une fonction réseau dès que le paquet arrive à l'interface réseau et avant qu'il ne commence à remonter dans le sous-système réseau du noyau. Par conséquent, la vitesse de traitement des paquets augmente considérablement. Cependant, comment le noyau permet-il à l'utilisateur d'exécuter ses programmes dans l'espace noyau? Avant de répondre à cette question, regardons ce qu'est BPF. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF et eBPF</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malgré le nom peu clair BPF (Packet Filtering, Berkeley), il s'agit en fait d'un modèle de machine virtuelle. </font><font style="vertical-align: inherit;">Cette machine virtuelle a été initialement conçue pour gérer le filtrage de paquets, d'où son nom. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'un des outils les plus connus utilisant BPF est </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Lors de la capture de paquets avec, l' </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilisateur peut spécifier une expression pour filtrer les paquets. </font><font style="vertical-align: inherit;">Seuls les paquets correspondant à cette expression seront capturés. </font><font style="vertical-align: inherit;">Par exemple, l'expression « </font></font><code>tcp dst port 80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">» s'applique à tous les paquets TCP arrivant au port 80. Le compilateur peut raccourcir cette expression en la convertissant en bytecode BPF. </font><font style="vertical-align: inherit;">
Voici essentiellement ce que fait le programme ci-dessus:</font></font><br>
<br>
<code>$ sudo tcpdump -d "tcp dst port 80"<br>
(000) ldh [12]<br>
(001) jeq #0x86dd jt 2 jf 6<br>
(002) ldb [20]<br>
(003) jeq #0x6 jt 4 jf 15<br>
(004) ldh [56]<br>
(005) jeq #0x50 jt 14 jf 15<br>
(006) jeq #0x800 jt 7 jf 15<br>
(007) ldb [23]<br>
(008) jeq #0x6 jt 9 jf 15<br>
(009) ldh [20]<br>
(010) jset #0x1fff jt 15 jf 11<br>
(011) ldxb 4*([14]&amp;0xf)<br>
(012) ldh [x + 16]<br>
(013) jeq #0x50 jt 14 jf 15<br>
(014) ret #262144<br>
(015) ret #0</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instruction (000): télécharge un paquet à décalage 12 en tant que mot de 16 bits dans la batterie. </font><font style="vertical-align: inherit;">Un décalage de 12 correspond à un paquet de type éther.</font></font></li>
<li> (001):      0x86dd,  ,  ethertype-  IPv6.    true,       (002),    –   (006).</li>
<li> (006):    0x800 (ethertype-  IPv4).   true,     (007),   –   (015).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ainsi de suite, jusqu'à ce que le programme de filtrage de paquets renvoie un résultat. Il s'agit généralement d'un Bulean. Le retour d'une valeur non nulle (instruction (014)) signifie que le paquet s'est approché, et le retour de zéro (instruction (015)) signifie que le paquet n'est pas arrivé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La machine virtuelle BPF et son bytecode ont été proposés par Steve McCann et Van Jacobson à la fin de 1992 lorsque leur article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BSD Packet Filter: A New Architecture for Packet Capture at the User Level</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a été présenté pour la première fois lors d'une conférence Usenix à l'hiver 1993.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Étant donné que BPF est une machine virtuelle, elle définit l'environnement dans lequel les programmes s'exécutent. En plus du bytecode, il définit également un modèle de mémoire par lots (les instructions de démarrage sont implicitement appliquées au package), les registres (A et X; batterie et registres d'index), le stockage de la mémoire de travail et un compteur de programme implicite. Fait intéressant, le bytecode BPF a été calqué sur le Motorola 6502 ISA. Comme Steve McCann l'a rappelé lors de sa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conférence plénière</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> au Sharkfest '11, il connaissait la version 6502 depuis le lycée lorsqu'il a programmé dans Apple II, et cette connaissance a influencé son travail sur la conception du bytecode BPF.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La prise en charge de BPF est implémentée dans le noyau Linux dans la version v2.5 et supérieure, ajoutée principalement par les efforts de Jay Schullist. Le code BPF est resté inchangé jusqu'en 2011, date à laquelle Eric Dumazett a repensé l'interpréteur BPF pour fonctionner en mode JIT (Source: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JIT pour les filtres de paquets</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Après cela, le noyau, au lieu d'interpréter le code d'octet BPF, pourrait convertir directement les programmes BPF en architecture cible: x86, ARM, MIPS, etc.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus tard, en 2014, Alexey Starovoitov a proposé un nouveau mécanisme JIT pour BPF. </font><font style="vertical-align: inherit;">En fait, ce nouveau JIT est devenu la nouvelle architecture basée sur BPF et s'appelle eBPF. </font><font style="vertical-align: inherit;">Je pense que pendant un certain temps, les deux machines virtuelles ont coexisté, mais actuellement le filtrage de paquets est mis en œuvre sur la base d'eBPF. </font><font style="vertical-align: inherit;">En fait, dans de nombreux exemples de documentation moderne, BPF est censé signifier eBPF, et BPF classique est maintenant connu sous le nom de cBPF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eBPF étend la machine virtuelle BPF classique de plusieurs manières:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basé sur des architectures 64 bits modernes. </font><font style="vertical-align: inherit;">eBPF utilise des registres 64 bits et augmente le nombre de registres disponibles de 2 (batterie et X) à 10. eBPF fournit également des codes de fonctionnement supplémentaires (BPF_MOV, BPF_JNE, BPF_CALL ...).</font></font></li>
<li>    . BPF      .      ,     ,   . ,   eBPF            . ,   eBPF    tracepoint   kprobe.      eBPF,            .   eBPF    : kernel/bpf.</li>
<li>     .  –    «-»,         .  eBPF    .</li>
<li> .  ,   ,      .            .  ,   eBPF    .</li>
<li> .    eBPF  4096 .      eBPF    eBPF-       (     32 ).</li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF: un exemple</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Il existe plusieurs exemples pour eBPF dans les sources du noyau Linux. </font><font style="vertical-align: inherit;">Ils sont disponibles sur samples / bpf /. </font><font style="vertical-align: inherit;">Pour compiler ces exemples, entrez simplement: </font></font><br>
<br>
<code>$ sudo make samples/bpf/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'écrirai pas moi-même un nouvel exemple pour eBPF, mais j'utiliserai l'un des exemples disponibles dans samples / bpf /. </font><font style="vertical-align: inherit;">Je vais regarder certaines sections du code et expliquer comment cela fonctionne. </font><font style="vertical-align: inherit;">À titre d'exemple, j'ai choisi un programme </font></font><code>tracex4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En général, chacun des exemples dans samples / bpf / se compose de deux fichiers. </font><font style="vertical-align: inherit;">Dans ce cas:</font></font><br>
<br>
<ul>
<li><code>tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, contient le code source qui doit être exécuté dans le noyau en tant que bytecode eBPF.</font></font></li>
<li><code>tracex4_user.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, contient un programme de l'espace utilisateur.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, nous devons compiler l' </font></font><code> tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF en bytecode. </font><font style="vertical-align: inherit;">Il n'y a actuellement </font></font><code>gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aucune partie serveur pour eBPF. </font><font style="vertical-align: inherit;">Heureusement, il </font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">peut émettre un bytecode eBPF. </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Makefile</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilise </font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour compiler </font></font><code>tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un fichier objet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai mentionné ci-dessus que l'une des caractéristiques les plus intéressantes des eBPF est les cartes. </font><font style="vertical-align: inherit;">tracex4_kern définit une carte:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pair</span> {</span><font></font>
    u64 val;<font></font>
    u64 ip;<font></font>
};  <font></font>
<font></font>
<span class="hljs-function">struct bpf_map_def <span class="hljs-title">SEC</span><span class="hljs-params">(<span class="hljs-string">"maps"</span>)</span> my_map </span>= {<font></font>
    .type = BPF_MAP_TYPE_HASH,<font></font>
    .key_size = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>),<font></font>
    .value_size = <span class="hljs-keyword">sizeof</span>(struct pair),<font></font>
    .max_entries = <span class="hljs-number">1000000</span>,<font></font>
};</code></pre><br>
<code>BPF_MAP_TYPE_HASH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- L'un des nombreux types de cartes proposés par eBPF. </font><font style="vertical-align: inherit;">Dans ce cas, c'est juste un hachage. </font><font style="vertical-align: inherit;">Vous avez peut-être également remarqué une annonce </font></font><code>SEC("maps")</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">SEC est une macro utilisée pour créer une nouvelle section d'un fichier binaire. </font><font style="vertical-align: inherit;">En fait, l'exemple </font></font><code>tracex4_kern</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">définit deux autres sections:</font></font><br>
<br>
<pre><code class="cpp hljs">SEC(<span class="hljs-string">"kprobe/kmem_cache_free"</span>)
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bpf_prog1</span><span class="hljs-params">(struct pt_regs *ctx)</span>
</span>{   
    <span class="hljs-keyword">long</span> ptr = PT_REGS_PARM2(ctx);<font></font>
<font></font>
    bpf_map_delete_elem(&amp;my_map, &amp;ptr); <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
    <font></font>
SEC(<span class="hljs-string">"kretprobe/kmem_cache_alloc_node"</span>) 
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bpf_prog2</span><span class="hljs-params">(struct pt_regs *ctx)</span>
</span>{
    <span class="hljs-keyword">long</span> ptr = PT_REGS_RC(ctx);
    <span class="hljs-keyword">long</span> ip = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  ip-   kmem_cache_alloc_node() </span><font></font>
    BPF_KRETPROBE_READ_RET_IP(ip, ctx);<font></font>
<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pair</span> <span class="hljs-title">v</span> = {</span><font></font>
        .val = bpf_ktime_get_ns(),<font></font>
        .ip = ip,<font></font>
    };<font></font>
    <font></font>
    bpf_map_update_elem(&amp;my_map, &amp;ptr, &amp;v, BPF_ANY);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}   </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ces deux fonctions vous permettent de supprimer une entrée de la carte ( </font></font><code>kprobe/kmem_cache_free</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) et d'ajouter un nouvel enregistrement ( </font></font><code>kretprobe/kmem_cache_alloc_node</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">à la carte </font><font style="vertical-align: inherit;">. Tous les noms de fonction écrits en majuscules correspondent aux macros définies dans </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bpf_helpers.h</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si je produis un vidage de sections du fichier objet, je dois voir que ces nouvelles sections sont déjà définies: </font><font style="vertical-align: inherit;">
Toujours là </font><font style="vertical-align: inherit;">, le programme principal. Fondamentalement, ce programme écoute les événements </font><font style="vertical-align: inherit;">. Lorsqu'un tel événement se produit, le code eBPF correspondant est exécuté. Le code stocke l'attribut IP de l'objet dans la carte, puis cet objet est affiché cycliquement dans le programme principal. Exemple: </font><font style="vertical-align: inherit;">
Comment le programme d'espace utilisateur et le programme eBPF sont-ils liés? À l'initialisation, il </font><font style="vertical-align: inherit;">charge un fichier objet à l' </font><font style="vertical-align: inherit;">aide d'une fonction </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<code>$ objdump -h tracex4_kern.o<br>
<br>
tracex4_kern.o: file format elf64-little<br>
<br>
Sections:<br>
Idx Name Size VMA LMA File off Algn<br>
 0 .text 00000000 0000000000000000 0000000000000000 00000040 2**2<br>
 CONTENTS, ALLOC, LOAD, READONLY, CODE<br>
 1 kprobe/kmem_cache_free 00000048 0000000000000000 0000000000000000 00000040 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE<br>
 2 kretprobe/kmem_cache_alloc_node 000000c0 0000000000000000 0000000000000000 00000088 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE<br>
 3 maps 0000001c 0000000000000000 0000000000000000 00000148 2**2<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 4 license 00000004 0000000000000000 0000000000000000 00000164 2**0<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 5 version 00000004 0000000000000000 0000000000000000 00000168 2**2<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 6 .eh_frame 00000050 0000000000000000 0000000000000000 00000170 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</code><br>
<br><font style="vertical-align: inherit;"></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tracex4_user.c</a></code><font style="vertical-align: inherit;"></font><code>kmem_cache_alloc_node</code><font style="vertical-align: inherit;"></font><br>
<br>
<code>$ sudo ./tracex4<br>
obj 0xffff8d6430f60a00 is 2sec old was allocated at ip ffffffff9891ad90<br>
obj 0xffff8d6062ca5e00 is 23sec old was allocated at ip ffffffff98090e8f<br>
obj 0xffff8d5f80161780 is 6sec old was allocated at ip ffffffff98090e8f</code><br>
<br><font style="vertical-align: inherit;"></font><code>tracex4_user.c</code><font style="vertical-align: inherit;"></font><code>tracex4_kern.o</code><font style="vertical-align: inherit;"></font><code>load_bpf_file</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> ac, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span> <span class="hljs-title">r</span> = {</span>RLIM_INFINITY, RLIM_INFINITY};
    <span class="hljs-keyword">char</span> filename[<span class="hljs-number">256</span>];
    <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
    <span class="hljs-built_in">snprintf</span>(filename, <span class="hljs-keyword">sizeof</span>(filename), <span class="hljs-string">"%s_kern.o"</span>, argv[<span class="hljs-number">0</span>]);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (setrlimit(RLIMIT_MEMLOCK, &amp;r)) {<font></font>
        perror(<span class="hljs-string">"setrlimit(RLIMIT_MEMLOCK, RLIM_INFINITY)"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (load_bpf_file(filename)) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, bpf_log_buf);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; ; i++) {<font></font>
        print_old_objects(map_fd[<span class="hljs-number">1</span>]);<font></font>
        sleep(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois exécutées, les </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">load_bpf_file</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sondes définies dans le fichier eBPF sont ajoutées à </font></font><code>/sys/kernel/debug/tracing/kprobe_events</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Maintenant, nous écoutons ces événements et notre programme peut faire quelque chose quand ils se produisent. </font><font style="vertical-align: inherit;">
Tous les autres programmes de sample / bpf / sont structurés de manière similaire. </font><font style="vertical-align: inherit;">Ils ont toujours deux fichiers:</font></font><br>
<br>
<code>$ sudo cat /sys/kernel/debug/tracing/kprobe_events<br>
p:kprobes/kmem_cache_free kmem_cache_free<br>
r:kprobes/kmem_cache_alloc_node kmem_cache_alloc_node</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><code>XXX_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: programme eBPF.</font></font></li>
<li><code>XXX_user.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: programme principal.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le programme eBPF définit les cartes et les fonctions associées à la section. </font><font style="vertical-align: inherit;">Lorsque le noyau lance un événement d'un certain type (par exemple, </font></font><code>tracepoint</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), les fonctions liées sont exécutées. </font><font style="vertical-align: inherit;">Les cartes permettent l'échange de données entre le programme du noyau et le programme de l'espace utilisateur. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Cet article décrit BPF et eBPF. </font><font style="vertical-align: inherit;">Je sais qu'aujourd'hui il y a beaucoup d'informations et de </font><font style="vertical-align: inherit;">ressources sur EBPF, donc je recommande quelques autres matériaux pour une étude plus approfondie je. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recommande la </font><font style="vertical-align: inherit;">lecture:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF: la machine virtuelle universelle dans le noyau par</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jonathan Corbett. </font><font style="vertical-align: inherit;">Une introduction à BPF et comment il est devenu eBPF.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">A thorough introduction to eBPF</a>  .    LWN.net.      eBPF           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>.</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Notes on BPF &amp; eBPF</a>  .      “The BSD Packet Filter: A New Architecture for User-level Packet Capture”.        .</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">eBPF, part1: Past, Present and Future</a>  .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>,   .      eBPF,   .</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495438/index.html">Langue R pour les utilisateurs d'Excel (cours vidéo gratuit)</a></li>
<li><a href="../fr495446/index.html">L'antigravité n'est pas ce que vous pensiez</a></li>
<li><a href="../fr495448/index.html">Mitaps en ligne pour toute la semaine sur le dos, le devant, QA, PM, DevOps et un peu sur les robots, à partir du 3 avril</a></li>
<li><a href="../fr495450/index.html">Débogage des applications Golang lourdement chargées ou comment nous avons cherché un problème dans Kubernetes qui n'était pas là</a></li>
<li><a href="../fr495452/index.html">Comment préparer un site pour la croissance de la charge</a></li>
<li><a href="../fr495456/index.html">Examen de 14 nouveaux plugins pour Figma qui aideront à augmenter la productivité pendant que nous tous</a></li>
<li><a href="../fr495458/index.html">Comment écrire du code lorsque les enfants courent autour de vous et demandent: «Pour quoi travaillerez-vous?»</a></li>
<li><a href="../fr495460/index.html">Une bulle de gaz de 22 000 fois la taille de la Terre a explosé sur Uranus</a></li>
<li><a href="../fr495462/index.html">.NET Core: intrinsèque x86_64 sur les machines virtuelles</a></li>
<li><a href="../fr495464/index.html">Message d'information 404 - non seulement une erreur, mais aussi des vacances</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>