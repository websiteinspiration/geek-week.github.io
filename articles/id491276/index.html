<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😊 👨🏿‍💼 👩🏽‍💼 Bagaimana saya menghindari larangan pada API Pesan melalui dokumentasi Vkontakte 👩🏾‍⚖️ 🖐🏽 🍴</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo seluruh komunitas Habro. Bagi saya, artikel pertama ini ditulis di bawah euforia tertentu, jadi tolong jangan menilai artikel ini terlalu ketat u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Bagaimana saya menghindari larangan pada API Pesan melalui dokumentasi Vkontakte</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491276/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Halo seluruh komunitas Habro. </font><font style="vertical-align: inherit;">Bagi saya, artikel pertama ini ditulis di bawah euforia tertentu, jadi tolong jangan menilai artikel ini terlalu ketat untuk bagian sastra. </font><font style="vertical-align: inherit;">Tapi yah, lebih sedikit kata dan mulai berbisnis.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bagaimana semua ini dimulai</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kita semua tahu bahwa VC memiliki API, dan saya yakin sebagian besar orang mencoba menggunakannya untuk tujuan mereka sendiri. </font><font style="vertical-align: inherit;">Secara pribadi, saya punya banyak proyek yang terkait dengannya: potongan-potongan 5 bot kuat, kompilasi dataset skala besar dari posting grup, dll. </font><font style="vertical-align: inherit;">Dan tidak mengherankan bahwa teman-teman saya bertanya kepada saya beberapa kali untuk mengunduh lagu dari lampiran dialog, foto, atau menyimpan teks korespondensi dengan beberapa orang dalam file terpisah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi begitu "itu" datang, dan sejak saat itu implementasi permintaan kecil seperti itu tidak lagi menjadi tugas sepele: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/c41/913/d6c/c41913d6cfb47f8acff5c3145502c4e5.jpg" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, beberapa hari yang lalu, untuk menghilangkan masalah ini sekali dan untuk semua, saya memutuskan untuk menulis pembungkus saya melalui permintaan http, berpura-pura menjadi pengguna biasa, sehingga memiliki alat kuat yang sama dengan API resmi untuk bagian pesan.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mari kita mulai bisnis</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, saya mulai dengan otorisasi. </font><font style="vertical-align: inherit;">Berbekal sniffer https dan Firefox, saya dapat melewati semua "langkah" otorisasi dan mendapatkan cookie final. </font><font style="vertical-align: inherit;">Mulai sekarang, hanya tinggal memahami bagaimana pertanyaan dibuat. </font><font style="vertical-align: inherit;">Ditemukan bahwa sebagian besar data diterima oleh permintaan POST dari </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://vk.com/wkview.php</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , hanya parameter untuk situasi yang berbeda berubah setiap kali. </font><font style="vertical-align: inherit;">Saya berhasil menulis fungsi untuk memompa sepenuhnya semua jenis investasi, tetapi kami tidak akan membahasnya secara terperinci, karena pada suatu saat semuanya berubah secara dramatis.</font></font><br>
<blockquote><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tautan ke file untuk menerima cookie otorisasi (saya menulisnya hanya untuk otentikasi dua faktor, karena biayanya kebanyakan orang)</font></font></a></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penemuan tak terduga</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya sedang mengerjakan laptop ketika seorang teman mendatangi saya dan bertanya apa yang saya lakukan. Karena saya tidak bisa menjelaskan kepadanya seluruh masalah dengan cepat di jari saya, saya membuka dokumentasi resmi di bagian pesan, dan tertegun ketika saya melihat apa yang ada di bawah deskripsi utama dari metode "terlarang" ini: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e14/077/91c/e1407791c9c79301b94f9f73c58fe5dd.jpg" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tidak, Anda mengerti saya dengan benar, saya bukan yang pertama lihat saja peluang ini. Saya menggunakannya berkali-kali dengan metode lain, tetapi saya bahkan tidak bisa berpikir bahwa fungsi "permintaan sampel" akan tetap dengan metode bagian pesan. Dan yang lebih kuat lagi adalah kejutan saya ketika saya mengacaukan lalu lintas. Ini hanya permintaan API biasa, hanya di situs, yang hanya sedikit berbeda dengan nama parameter dalam formulir web dan memiliki semacam hash-ID.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/39d/68c/a1b/39d68ca1b65fec086d6f3be18578ef91.jpg" alt="gambar"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam beberapa menit, saya menyadari bahwa hash-ID hanyalah sebuah string yang terletak di atribut hash data dari tag tombol, dan setelah beberapa menit saya sudah berusaha keras untuk mengimplementasikan emulasi "permintaan pengujian" dan tidak sepenuhnya percaya bahwa itu akan berhasil. </font><font style="vertical-align: inherit;">Setelah semua, pasti permintaan ini memiliki semacam batasan pada jumlah atau sesuatu seperti itu. </font><font style="vertical-align: inherit;">Tapi apa yang mengejutkan saya ketika skrip 30 baris ini (tidak termasuk penerimaan cookie), yang ditulis di atas lutut saya, mampu memompa satu setengah ribu gambar dari lampiran dialog dalam 4 menit.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2f8/d30/555/2f8d3055586c0d8a63f6898c1173319e.jpg" alt="gambar"><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya menerapkan kode yang digunakan</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> requests, pickle, re, json<font></font>
<font></font>
<span class="hljs-keyword">with</span> open(<span class="hljs-string">'cookies_vk_auth.pickle'</span>, <span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> handle:<font></font>
    cookies_final = pickle.load(handle)<font></font>
<font></font>
session = requests.Session()<font></font>
peer_id = int(input(<span class="hljs-string">'  :  '</span>))<font></font>
<font></font>
response = session.get(<span class="hljs-string">f'https://vk.com/dev/messages.getHistoryAttachments'</span>, cookies=cookies_final)<font></font>
hash_data =  re.findall(<span class="hljs-string">r'data-hash="(\S*)"'</span>, response.text)[<span class="hljs-number">0</span>]<font></font>
<font></font>
session = requests.Session()<font></font>
response = session.post(<span class="hljs-string">f'https://vk.com/dev'</span>,<font></font>
            data=<span class="hljs-string">f'act=a_run_method&amp;al=1&amp;hash=<span class="hljs-subst">{hash_data}</span>&amp;method=messages.getHistoryAttachments&amp;param_count=20&amp;param_max_forwards_level=45&amp;param_media_type=photo&amp;param_peer_id=<span class="hljs-subst">{peer_id}</span>&amp;param_photo_sizes=0&amp;param_preserve_order=0&amp;param_v=5.103'</span>, cookies=cookies_final)<font></font>
<font></font>
count=<span class="hljs-number">20</span><font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">200</span>):<font></font>
    response_json = json.loads(json.loads(response.text[<span class="hljs-number">4</span>:])[<span class="hljs-string">'payload'</span>][<span class="hljs-number">1</span>][<span class="hljs-number">0</span>])[<span class="hljs-string">'response'</span>][<span class="hljs-string">'items'</span>]<font></font>
<font></font>
    <span class="hljs-keyword">for</span> photo <span class="hljs-keyword">in</span> response_json:<font></font>
        ph = photo[<span class="hljs-string">'attachment'</span>][<span class="hljs-string">'photo'</span>][<span class="hljs-string">'sizes'</span>][<span class="hljs-number">-1</span>][<span class="hljs-string">'url'</span>]<font></font>
        r = session.get(ph, timeout=<span class="hljs-number">10</span>)<font></font>
        <font></font>
        <span class="hljs-keyword">if</span> r.status_code == <span class="hljs-number">200</span>:
            <span class="hljs-keyword">with</span> open(<span class="hljs-string">f'D://dev/'</span>+str(ph.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">-1</span>]), <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> f:<font></font>
                f.write(r.content)<font></font>
<font></font>
    m_id = photo[<span class="hljs-string">'message_id'</span>]<font></font>
    response = session.post(<span class="hljs-string">f'https://vk.com/dev'</span>,<font></font>
            data=<span class="hljs-string">f'act=a_run_method&amp;al=1&amp;hash=<span class="hljs-subst">{hash_data}</span>&amp;method=messages.getHistoryAttachments&amp;param_count=20&amp;param_start_from=<span class="hljs-subst">{m_id}</span>&amp;param_max_forwards_level=45&amp;param_media_type=photo&amp;param_peer_id=<span class="hljs-subst">{peer_id}</span>&amp;param_photo_sizes=0&amp;param_preserve_order=0&amp;param_v=5.103'</span>, cookies=cookies_final)
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya sangat terkesan bahwa pada titik ini saya memutuskan untuk menenangkan diri dan mencoba menerapkan beberapa metode lain (tiba-tiba saya keliru). </font><font style="vertical-align: inherit;">Saya mengambil metode Sejarah dan hasilnya mirip. </font><font style="vertical-align: inherit;">Hanya saya harus mengatur penundaan 0,1 detik sehingga server tidak memberikan kesalahan tentang terlalu banyak permintaan. </font><font style="vertical-align: inherit;">(Jika seseorang mengulangi, harap diingat bahwa ketika mengubah metode Anda juga perlu mengubah url ke dokumentasi, dari mana data hash berasal). </font><font style="vertical-align: inherit;">Artinya, metode ini sangat memungkinkan untuk mengakses bagian pesan melalui dokumentasi resmi, hanya menggunakan kata sandi dan login pengguna. </font><font style="vertical-align: inherit;">Untuk keandalan, saya mencoba melakukan langkah yang sama pada akun lain dan mendapatkan hasil yang sama.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk meringkas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, saya pikir, semua orang telah menyadari bahwa ini adalah pelanggaran dalam perlindungan data pribadi kami, yang telah menggantung dalam dokumentasi selama setahun dan tidak diketahui berapa banyak orang yang telah menggunakannya. </font><font style="vertical-align: inherit;">Selain itu, celah ini sangat besar, dan harus segera ditutup. </font><font style="vertical-align: inherit;">Dan untuk membuktikan sekali lagi bahwa ini seharusnya tidak bekerja dengan cara ini, saya akan mengutip pengembang VK sendiri:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika Anda berencana untuk mulai mengembangkan messenger, setelah 15 Februari 2019, Anda perlu mendapatkan akses tes di Dukungan, yang menyiratkan pekerjaan metode bagian Pesan dengan kunci administrator dari aplikasi Standalone Anda.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Artinya, bahkan untuk mendapatkan token aplikasi internal yang akan memiliki akses ke korespondensi pengguna, Anda memerlukan izin pribadi dari VK, apalagi akses dengan kata sandi dan login biasa. </font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pendapat pribadi saya</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Larangan bagian pesan tidak membawa perubahan mendasar pada keamanan pengguna. </font><font style="vertical-align: inherit;">Dia hanya menunjuk perbatasan dan memotong sekelompok "peretas" yang, tanpa mengerti apa yang sedang mereka lakukan, bisa mendapatkan akses penuh ke data. </font><font style="vertical-align: inherit;">Bagi orang-orang lain, lebih berpengalaman dalam pemrograman, mendapatkan akses ke korespondensi hanyalah masalah waktu. </font><font style="vertical-align: inherit;">Dan di bagian pertama artikel, saya buktikan dengan contoh saya sendiri, setelah membuat program untuk memompa lampiran, bahwa kemunculan perpustakaan yang bisa berpura-pura menjadi pengguna tidak jauh. </font><font style="vertical-align: inherit;">Mungkin saya sendiri yang akan mengakhiri, dan pengembang VK harus siap untuk ini dan menemukan cara untuk mengenali aktivitas pengguna yang terlalu mencurigakan jika privasi data kami benar-benar penting bagi mereka.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></b><div class="spoiler_text">       ,      )     ,       .<br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id491262/index.html">Mata untuk mata. Masalah Biometrik</a></li>
<li><a href="../id491264/index.html">Pengantar SSD. Bagian 4. Fisik</a></li>
<li><a href="../id491266/index.html">SurfingAttack: kompromi smartphone dengan asisten suara [+ video]</a></li>
<li><a href="../id491268/index.html">Metode Monte Carlo untuk Rantai Markov (MCMC). pengantar</a></li>
<li><a href="../id491272/index.html">Pengembangan situs web dalam pascal (backend)</a></li>
<li><a href="../id491278/index.html">CLRium # 7: Laporan, Latihan, Mentor</a></li>
<li><a href="../id491280/index.html">Kisah bagaimana saya mengembangkan bahasa pemrograman</a></li>
<li><a href="../id491282/index.html">Cara meningkatkan produktivitas tim (dan mengurangi kesalahan) menggunakan aksi unjuk rasa</a></li>
<li><a href="../id491284/index.html">Analisis: apa itu analisis fundamental</a></li>
<li><a href="../id491286/index.html">IPv6 hanya jaringan di pemerintahan AS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>