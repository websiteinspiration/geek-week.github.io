<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🚀 🧔🏾 🧓🏼 Project Loom: los hilos virtuales de Java están cerca 👩🏼‍🌾 👩🏾‍🎨 📧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace unos días, Ron Pressler dio a luz un artículo en State of Loom , que solo el javista más vago no pudo encontrar. El artículo es realmente bueno, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Project Loom: los hilos virtuales de Java están cerca</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503412/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hace unos días, Ron Pressler dio a luz un artículo en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">State of Loom</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que solo el javista más vago no pudo encontrar. </font><font style="vertical-align: inherit;">El artículo es realmente bueno, hay muchas metáforas interesantes en él, que tengo la intención de usar descaradamente ahora sin referencia a la fuente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por mi parte, inadvertidamente me permití expresar algo de escepticismo, pero cuando con este Project Loom finalmente se puede trabajar realmente. </font><font style="vertical-align: inherit;">Literalmente, una hora después, recibió una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">respuesta del propio Ron: "¡y tú lo intentas!" </font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Bueno, tuve que intentarlo.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo que se requería para el experimento:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JDK15 incluyendo Project Loom</font></font></a> </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terminal, ya que IntelliJ y Gradle se negaron rotundamente a trabajar con ese juego</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para empezar, decidí ver cómo sería un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejemplo clásico con secuencias de la documentación de Kotlin Coroutine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El ejemplo está escrito en Kotlin, pero reescribirlo en Java no es difícil:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
        <span class="hljs-keyword">var</span> c = <span class="hljs-keyword">new</span> AtomicLong();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1_000_000</span>; i++) {
            <span class="hljs-keyword">new</span> Thread(() -&gt; {<font></font>
                c.incrementAndGet();<font></font>
            }).start();<font></font>
        }<font></font>
<font></font>
        System.out.println(c.get());<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzamos y nos aseguramos de que el ejemplo todavía se cuelgue, como antes:</font></font><br>
<br>
<pre><code class="bash hljs">javac Main.java &amp;&amp; java Main
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora reescribe el ejemplo usando los hilos virtuales que Project Loom nos proporciona:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1_000_000</span>; i++) {<font></font>
    Thread.startVirtualThread(() -&gt; {<font></font>
        c.incrementAndGet();<font></font>
    });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado no se hace esperar:</font></font><br>
<br>
<pre><code class="bash hljs">1000000
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Cuánto tiempo?</font></font></b>
                        <div class="spoiler_text">     ,    . <br>
-,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">Gil Tene,   —    </a>. <br>
-,       Project Loom,     . ,     —  .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero en sí mismo no me impresionó demasiado. </font><font style="vertical-align: inherit;">Al final, con las corutinas en Kotlin, se logra fácilmente el mismo resultado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ron en su artículo observa correctamente que Kotlin tuvo que introducir la función delay (), que permite que la rutina se "duerma", ya que Thread.sleep () no envía la rutina actual a dormir, sino el hilo del planificador actual, del cual no hay muchos, generalmente por el número UPC </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Qué hay de Project Loom?</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1_000_000</span>; i++) {<font></font>
  Thread.startVirtualThread(() -&gt; {<font></font>
    c.incrementAndGet();<font></font>
    <span class="hljs-keyword">try</span> {<font></font>
        Thread.sleep(<span class="hljs-number">1_000</span>);<font></font>
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {<font></font>
        e.printStackTrace();<font></font>
    }<font></font>
  });<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resultado:</font></font><br>
<br>
<pre><code class="bash hljs">- 400K
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡Pero esto ya es interesante! </font><font style="vertical-align: inherit;">Con Project Loom, la llamada a Thread.sleep () puede distinguir si está en un hilo normal o en un hilo virtual, y funciona de manera diferente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto en sí mismo es muy bueno. </font><font style="vertical-align: inherit;">Pero profundicemos un poco más:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">var</span> threads = <span class="hljs-keyword">new</span> ArrayList&lt;Thread&gt;();
<span class="hljs-keyword">var</span> cores = <span class="hljs-number">10</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; cores; i++) {
    <span class="hljs-keyword">var</span> t = Thread.startVirtualThread(() -&gt; {
        <span class="hljs-keyword">var</span> bestUUID = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1_000_000</span>; j++) {
            <span class="hljs-keyword">var</span> currentUUID = UUID.randomUUID().toString();
            <span class="hljs-keyword">if</span> (currentUUID.compareTo(bestUUID) &gt; <span class="hljs-number">0</span>) {<font></font>
                bestUUID = currentUUID;<font></font>
            }<font></font>
        }<font></font>
        System.out.println(<span class="hljs-string">"Best slow UUID is "</span> + bestUUID);<font></font>
    });<font></font>
    threads.add(t);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; cores; i++) {
    <span class="hljs-keyword">var</span> t = Thread.startVirtualThread(() -&gt; {
        <span class="hljs-keyword">var</span> bestUUID = UUID.randomUUID().toString();<font></font>
        System.out.println(<span class="hljs-string">"Best fast UUID is "</span> + bestUUID);<font></font>
    });<font></font>
    threads.add(t);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">for</span> (Thread t : threads) {<font></font>
    t.join();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aquí ejecutamos 10 tareas lentas y 10 tareas rápidas. Las tareas rápidas son más rápidas que las lentas un millón de veces, por lo que sería lógico suponer que se completan antes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero no estaba allí:</font></font><br>
<br>
<pre><code class="bash hljs">Best slow UUID is fffffde4-8c70-4ce6-97af-6a1779c206e1<font></font>
Best slow UUID is ffffe33b-f884-4206-8e00-75bd78f6d3bd<font></font>
Best slow UUID is fffffeb8-e972-4d2e-a1f8-6ff8aa640b70<font></font>
Best fast UUID is e13a226a-d335-4d4d-81f5-55ddde69e554<font></font>
Best fast UUID is ec99ed73-23b8-4ab7-b2ff-7942442a13a9<font></font>
Best fast UUID is c0cbc46d-4a50-433c-95e7-84876a338212<font></font>
Best fast UUID is c7672507-351f-4968-8cd2-2f74c754485c<font></font>
Best fast UUID is d5ae642c-51ce-4b47-95db-abb6965d21c2<font></font>
Best fast UUID is f2f942e3-f475-42b9-8f38-93d89f978578<font></font>
Best fast UUID is 469691ee-da9c-4886-b26e-dd009c8753b8<font></font>
Best fast UUID is 0ceb9554-a7e1-4e37-b477-064c1362c76e<font></font>
Best fast UUID is 1924119e-1b30-4be9-8093-d5302b0eec5f<font></font>
Best fast UUID is 94fe1afc-60aa-43ce-a294-f70f3011a424<font></font>
Best slow UUID is fffffc24-28c5-49ac-8e30-091f1f9b2caf<font></font>
Best slow UUID is fffff303-8ec1-4767-8643-44051b8276ca<font></font>
Best slow UUID is ffffefcb-614f-48e0-827d-5e7d4dea1467<font></font>
Best slow UUID is fffffed1-4348-456c-bc1d-b83e37d953df<font></font>
Best slow UUID is fffff6d6-6250-4dfd-8d8d-10425640cc5a<font></font>
Best slow UUID is ffffef57-c3c3-46f5-8ac0-6fad83f9d4d6<font></font>
Best slow UUID is fffff79f-63a6-4cfa-9381-ee8959a8323d<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La intuición funciona solo mientras el número de tareas lentas sea menor que el número de núcleos de su CPU. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La razón es simple: en este momento, Project Loom utiliza el habitual ForkJoinPool. Como resultado, a pesar de que la documentación y la idea indican que los hilos virtuales son "preventivos", en este momento se comportan de manera "cooperativa". Como las corutinas en Kotlin, en realidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cabe señalar que en el artículo antes mencionado, Ron menciona que también reflexiona sobre el comportamiento de prematura forzada, como en los hilos normales. Pero hasta ahora esto no se ha implementado, ya que no está completamente claro cómo tal comportamiento es útil cuando puede haber decenas de miles de hilos. Sin embargo, en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go 1.14, la prematura forzada se introdujo en silencio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una llamada de función, a diferencia de Go, no da como resultado un cambio de contexto. </font><font style="vertical-align: inherit;">Suspender, como en Kotlin, tampoco fue entregado. </font><font style="vertical-align: inherit;">Pero puede hacerlo con Thread.yield (), o llamando a cualquier función Java IO: System.out.println (""), por ejemplo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El cálculo es simple: la mayoría de los programas reales usan IO de bloqueo con bastante frecuencia. </font><font style="vertical-align: inherit;">Y es su uso de Project Loom lo que busca resolver en primer lugar.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algunas conclusiones:</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tengo que admitir que a pesar de mi escepticismo inicial, Project Loom me impresionó positivamente. </font><font style="vertical-align: inherit;">Para los usuarios normales de Java, promete multihilo ligero sin la necesidad de cambiar a otro idioma, utilizando una biblioteca o marco. </font><font style="vertical-align: inherit;">Lo que ya suena bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero la principal revolución, como espero, este proyecto se realizará entre los desarrolladores de bibliotecas que todavía tienen que resolver el problema de concurrencia una y otra vez. </font><font style="vertical-align: inherit;">Ahora, con la distribución de JDK15, este problema puede transferirse a la JVM, ya que solían transferir la optimización de la memoria (GC) y el código (JIT) a la JVM. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enlace a mi artículo original</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si prefiere leer en inglés.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es503402/index.html">Cómo recordar a todos en persona, o una búsqueda efectiva de rostros en una gran base de datos</a></li>
<li><a href="../es503404/index.html">Sistemas digitales semánticos</a></li>
<li><a href="../es503406/index.html">Semántica y actividad</a></li>
<li><a href="../es503408/index.html">Blazor Client Side Online Store: Parte 7: actualizado a la versión 3.2.0 y pantalla de imagen agregada</a></li>
<li><a href="../es503410/index.html">Polígonos Otro Mundo: Sega Genesis</a></li>
<li><a href="../es503414/index.html">Hack The Box. Tutorial de cuerda. PWN Formatear cadenas y ROP usando pwntools</a></li>
<li><a href="../es503420/index.html">Lematizarlo más rápido (PyMorphy2, PyMystem3 y algo de magia)</a></li>
<li><a href="../es503426/index.html">44.2 Tb / s sobre fibra: ¿cómo funciona?</a></li>
<li><a href="../es503428/index.html">Cómo mejorar el inglés escrito para la comunicación en el extranjero: proyecto empresarial Linguix</a></li>
<li><a href="../es503430/index.html">MS Remote Desktop Gateway, HAProxy y contraseña de adivinanzas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>