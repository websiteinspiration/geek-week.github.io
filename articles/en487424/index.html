<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëáüèΩ üÄÑÔ∏è ‚ûï How to scale from 1 to 100,000 users ü§¶üèø üë©üèΩ‚Äçüîß üèûÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many startups went through this: crowds of new users are registered every day, and the development team is struggling to support the work of the servi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How to scale from 1 to 100,000 users</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dcmiran/blog/487424/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Many startups went through this: crowds of new users are registered every day, and the development team is struggling to support the work of the service. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is a nice problem, but there is little clear information on the Web about how to accurately scale a web application from zero to hundreds of thousands of users. Usually there are either fire solutions or the elimination of bottlenecks (and often both). Therefore, people use fairly stereotyped tricks to scale their amateur project into something really serious. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's try to filter out the information and write down the main formula. We are going to step by step scale our new Graminsta photo sharing site from 1 to 100,000 users.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will write down what specific actions need to be done when increasing the audience to 10, 100, 1000, 10 000 and 100 000 people.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 user: 1 car</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Almost every application, whether it‚Äôs a website or a mobile application, has three key components: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API </font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">database</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">client (mobile application or website itself)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The database stores persistent data. </font><font style="vertical-align: inherit;">The API serves requests for and around this data. </font><font style="vertical-align: inherit;">The client transfers the data to the user. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I came to the conclusion that it is much easier to talk about scaling an application if, from the point of view of architecture, client entities and APIs are completely separated. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we first start creating an application, all three components can be run on the same server. </font><font style="vertical-align: inherit;">In a way, this reminds us of our development environment: one engineer runs the database, API, and client on the same computer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Theoretically, we could deploy it in the cloud on one instance of DigitalOcean Droplet or AWS EC2, as shown below:</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/233/84f/2d3/23384f2d3d2626483572d1b97f5c22f9.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With that said, if the site has more than one user, it almost always makes sense to highlight the database level.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 users: taking the database to a separate level</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dividing a database into managed services such as Amazon RDS or the Digital Ocean Managed Database will serve us well for a long time. </font><font style="vertical-align: inherit;">This is a bit more expensive than self-hosting on a single machine or an EC2 instance, but with these services out of the box you get many useful extensions that will come in handy in the future: multi-region backups, read replicas, automatic backups and much more. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is how the system now looks:</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d54/259/16d/d5425916de31d36d6e628397af39fbe4.png"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100 users: taking the client to a separate level</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, our app really liked the first users. Traffic is becoming more stable, so it's time to move the client to a separate level. It should be noted that </font><font style="vertical-align: inherit;">entity </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">separation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a key aspect of building a scalable application. Since one part of the system receives more traffic, we can divide it so as to control the scaling of the service based on specific traffic patterns. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's why I like to represent the client separately from the API. This makes it very easy to talk about development for several platforms: web, mobile web, iOS, Android, desktop applications, third-party services, etc. All of them are just clients using the same API.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, now our users most often ask to release a mobile application. </font><font style="vertical-align: inherit;">Separating client entities and APIs makes it easier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's what the system looks like:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c24/6b0/3a6/c246b03a6b0d1cdbb9a4e16c2667d1fd.png"></div><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000 users: add load balancer</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Things are going well. Graminsta users are uploading more and more photos. The number of registrations is also growing. Our lone API server has difficulty managing all traffic. Need more iron! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Load balancer is a very powerful concept. The key idea is that we put the balancer in front of the API, and it distributes the traffic among individual service instances. This is the way of horizontal scaling, that is, we add more servers with the same code, increasing the number of requests that we can process. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are going to place separate load balancers in front of the web client and in front of the API. This means that you can run multiple instances that execute the API code and the web client code. The load balancer will forward requests to that server which is less loaded.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we get another important advantage - redundancy. When one instance fails (possibly overloads or crashes), we still have others that still respond to incoming requests. If a single instance worked, then in the event of a failure the whole system would fall. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The load balancer also provides automatic scaling. We can configure it to increase the number of instances before the peak load, and reduce when all users sleep. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With a load balancer, the API level can be scaled to infinity, we just add new instances as the number of requests increases.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d34/c58/0b1/d34c580b17685fc7d816260b6f77979e.png"></div><br>
<blockquote><i>.         ,      PaaS,   Heroku   Elastic Beanstalk  AWS (   ). Heroku     ,          -   API.   ,   Heroku        ‚Äî       .</i></blockquote><br>
<h1>10 000 : CDN</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps it should have been done from the very beginning. Processing requests and taking new photos are starting to load our servers too much. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this stage, you need to use a cloud service for storing static content - images, videos and much more (AWS S3 or Digital Ocean Spaces). In general, our API should avoid processing things like uploading images and uploading images to a server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another advantage of cloud hosting is its CDN (in AWS, this add-on is called Cloudfront, but many cloud storage services offer it out of the box). CDN automatically caches our images in various data centers around the world.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although our main data center can be located in Ohio, but if someone requests an image from Japan, the cloud provider will make a copy and save it in their Japanese data center. </font><font style="vertical-align: inherit;">The next person to request this image in Japan will receive it much faster. </font><font style="vertical-align: inherit;">This is important when we work with large files, like photos or videos that take a long time to upload and transmit across the planet.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/de8/a5e/8b4/de8a5e8b451731be8ad41f3e38818b84.png"></div><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100,000 users: data level scaling</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CDN really helped: traffic is growing at full speed. The famous video blogger, Maid Mobrick, has just registered with us and posted his story, as they say. Thanks to the load balancer, the level of CPU and memory usage on the API servers is kept low (ten API instances are running), but we are starting to get many timeouts for requests ... where did these delays come from? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After a little digging in the metrics, we see that the CPU on the database server is 80-90% loaded. We are on the limit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Scaling the data layer is probably the hardest part of the equation. API servers serve stateless requests, so we just add more API instances. But with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">most</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">databases do not succeed. </font><font style="vertical-align: inherit;">We will discuss the popular relational database management systems (PostgreSQL, MySQL, etc.).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caching</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the easiest ways to increase the performance of our database is to introduce a new component: the cache level. </font><font style="vertical-align: inherit;">The most common caching method is to store key-value records in RAM, such as Redis or Memcached. </font><font style="vertical-align: inherit;">Most clouds have a managed version of these services: Elasticache on AWS and Memorystore on Google Cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The cache is useful when a service makes many repeated calls to the database to get the same information. </font><font style="vertical-align: inherit;">In fact, we access the database only once, save the information in the cache - and do not touch it anymore.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, in our Graminsta service, every time someone goes to the Mobric star profile page, the API server requests information from his profile in the database. </font><font style="vertical-align: inherit;">It happens over and over again. </font><font style="vertical-align: inherit;">Since Mobrick‚Äôs profile information does not change with every request, it‚Äôs great for caching. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will cache the results from the database in Redis by key </font></font><code>user:id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a validity period of 30 seconds. </font><font style="vertical-align: inherit;">Now, when someone enters Mobrick‚Äôs profile, we first check Redis, and if the data is there, we simply transfer it directly from Redis. </font><font style="vertical-align: inherit;">Now, queries to the most popular profile on the site practically do not load our database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another advantage of most caching services is that they are easier to scale than database servers. </font><font style="vertical-align: inherit;">Redis has a built-in Redis Cluster cluster mode. </font><font style="vertical-align: inherit;">Like a load balancer</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></sup></a><a name="1_1"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it allows you to distribute the Redis cache across multiple machines (across thousands of servers, if necessary). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Almost all large-scale applications use caching; this is an absolutely integral part of the fast API. </font><font style="vertical-align: inherit;">Faster request processing and more productive code - all this is important, but without a cache it is almost impossible to scale the service to millions of users.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reading replicas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the number of queries to the database has increased significantly, we can do one more thing - add read replicas in the database management system. </font><font style="vertical-align: inherit;">Using the managed services described above, this can be done in one click. </font><font style="vertical-align: inherit;">The read replica will remain relevant in the main database and is available to SELECT statements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is our system now:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/787/d35/735/787d357359a0685cd00c4675cadb8372.png"></div><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further actions</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As the application continues to scale, we will continue to separate services to scale them independently. For example, if we start using Websockets, it makes sense to pull the Websockets processing code into a separate service. We can place it on new instances behind our own load balancer, which can scale up and down depending on the open Websockets connections and regardless of the number of HTTP requests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We also continue to fight against restrictions at the database level. It is at this stage that the time has come to study the partitioning and sharding of the database. Both approaches require additional overhead, but they allow you to scale the database almost to infinity.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We also want to install a monitoring and analytics service like New Relic or Datadog. </font><font style="vertical-align: inherit;">This will identify slow queries and understand where improvement is needed. </font><font style="vertical-align: inherit;">As we scale, we want to focus on finding bottlenecks and resolving them - often using some ideas from the previous sections.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This post is inspired by one of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">my favorite high scalability posts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">I wanted to concretize the article a bit for the initial stages of projects and untie it from one vendor. </font><font style="vertical-align: inherit;">Be sure to read if you are interested in this topic.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Footnotes</font></font></h3><br>
<font color="gray"><a name="1"></a><ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despite the similarities in terms of load balancing across multiple instances, the basic implementation of the Redis cluster is very different from the load balancer. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[to return]</font></font></a></li>
</ol></font> <br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/eo/dx/cq/eodxcqr_jt4-i2h7pybvhg_n7gq.jpeg"></a></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en487424/">https://habr.com/ru/post/en487424/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487414/index.html">Computer quests as an awesome tool for learning English words</a></li>
<li><a href="../en487416/index.html">Getting out of dependency hell in QlikView</a></li>
<li><a href="../en487418/index.html">What is SAP?</a></li>
<li><a href="../en487420/index.html">Sound War Z. Testing MusicDealer speakers and headphones</a></li>
<li><a href="../en487422/index.html">Salesforce Administrator Responsibilities: What Should Be Done and When</a></li>
<li><a href="../en487426/index.html">Flexibility determines success.</a></li>
<li><a href="../en487428/index.html">Under the hood of the Yandex.Music bot client</a></li>
<li><a href="../en487430/index.html">What skills are needed to create an iOS application? Yandex Report</a></li>
<li><a href="../en487432/index.html">In the footsteps of DevConf and CfgMgmtCamp or what you can learn by going to the speaker at 2 international conferences in 2 weeks</a></li>
<li><a href="../en487438/index.html">How to create an IT company from scratch - without experience in this field and programming skills?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>