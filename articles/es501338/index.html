<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§öüèæ üë©‚Äçüëß‚Äçüëß üôãüèø Dentro de la m√°quina virtual Python. Parte 1 ü§∑üèø üê¥ üßùüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos. Finalmente decid√≠ averiguar c√≥mo funciona el int√©rprete de Python. Para hacer esto, comenz√≥ a estudiar un libro de art√≠culos y concibi√≥ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Dentro de la m√°quina virtual Python. Parte 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501338/"><img src="https://habrastorage.org/webt/jm/9r/uc/jm9rucormi1lrcussoajjremszi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hola a todos. </font><font style="vertical-align: inherit;">Finalmente decid√≠ averiguar c√≥mo funciona el int√©rprete de Python. </font><font style="vertical-align: inherit;">Para hacer esto, comenz√≥ a estudiar un libro de art√≠culos y concibi√≥ al mismo tiempo para traducirlo al ruso. </font><font style="vertical-align: inherit;">El hecho es que las traducciones no le permiten perder una oraci√≥n incomprensible y la calidad de la asimilaci√≥n del material aumenta).</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pido disculpas de antemano por posibles inexactitudes. </font><font style="vertical-align: inherit;">Siempre trato de traducir lo m√°s correctamente posible, pero uno de los principales problemas: simplemente no se mencionan algunos t√©rminos en el equivalente ruso.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota de traducci√≥n</font></font></b>
                        <div class="spoiler_text"> Python   ,  ¬´code object¬ª,  (  )     .    ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">  </a>   .<br>
<br>
<b> </b> ‚Äî   Python,    -   ,     :   ,    ,  ( !    )  ,    ,     - (     )  .. ‚Äî    ()  -   str (,  Python3, bytes).<br>
</div>
                    </div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El lenguaje de programaci√≥n Python ha existido por bastante tiempo. </font><font style="vertical-align: inherit;">El desarrollo de la primera versi√≥n fue iniciado por Guido Van Rossum en 1989, y desde entonces el idioma ha crecido y se ha convertido en uno de los m√°s populares. </font><font style="vertical-align: inherit;">Python se usa en varias aplicaciones: desde interfaces gr√°ficas hasta aplicaciones de an√°lisis de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El prop√≥sito de este art√≠culo es ir detr√°s de escena del int√©rprete y proporcionar una visi√≥n general conceptual de c√≥mo se ejecuta un programa escrito en Python. </font><font style="vertical-align: inherit;">CPython se considerar√° en el art√≠culo, porque al momento de escribir, es la implementaci√≥n Python m√°s popular y b√°sica.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python y CPython se usan como sin√≥nimos en este texto, pero cualquier menci√≥n de Python significa CPython (la versi√≥n de Python implementada en C). </font><font style="vertical-align: inherit;">Otras implementaciones incluyen PyPy (python implementado en un subconjunto limitado de Python), Jython (implementaci√≥n en la m√°quina virtual Java), etc.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me gusta dividir la ejecuci√≥n de un programa Python en dos o tres pasos principales (enumerados a continuaci√≥n), dependiendo de c√≥mo se llame al int√©rprete. </font><font style="vertical-align: inherit;">Estos pasos se cubrir√°n en diversos grados en este art√≠culo:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicializaci√≥n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : este paso implica la configuraci√≥n de las diversas estructuras de datos requeridas por el proceso de Python. </font><font style="vertical-align: inherit;">Lo m√°s probable es que esto suceda cuando el programa se ejecute en modo no interactivo a trav√©s del int√©rprete de comandos.</font></font></li>
<li><b></b> ‚Äî     , :       ,    ,       .</li>
<li><b></b> ‚Äî         .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El mecanismo para generar √°rboles de "an√°lisis", as√≠ como √°rboles de sintaxis abstracta (ASD), es independiente del lenguaje. Por lo tanto, no cubriremos mucho este tema, porque los m√©todos utilizados en Python son similares a los m√©todos de otros lenguajes de programaci√≥n. Por otro lado, el proceso de construcci√≥n de tablas de s√≠mbolos y objetos de c√≥digo a partir de ADS en Python es m√°s espec√≠fico, por lo tanto, merece especial atenci√≥n. Tambi√©n analiza la interpretaci√≥n de los objetos de c√≥digo compilados y todas las dem√°s estructuras de datos. Los temas cubiertos por nosotros incluir√°n, entre otros: el proceso de construir tablas de s√≠mbolos y crear objetos de c√≥digo, objetos de Python, objetos de marco, objetos de c√≥digo, objetos funcionales, c√≥digos de operaci√≥n, bucles de int√©rprete, generadores y clases de usuario.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este material est√° destinado a cualquier persona interesada en aprender c√≥mo funciona la m√°quina virtual CPython. Se supone que el usuario ya est√° familiarizado con Python y comprende los conceptos b√°sicos del lenguaje. Al estudiar la estructura de una m√°quina virtual, encontraremos una cantidad significativa de c√≥digo C, por lo que un usuario que tenga una comprensi√≥n b√°sica del lenguaje C le resultar√° m√°s f√°cil entender el material. Entonces, b√°sicamente, lo que necesita para familiarizarse con este material: el deseo de aprender m√°s sobre la m√°quina virtual CPython. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este art√≠culo es una versi√≥n extendida de notas personales realizadas en el estudio del trabajo interno del int√©rprete. Hay muchas cosas de calidad en los </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">videos de PyCon</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , las conferencias escolares y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este blog.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mi trabajo no se habr√≠a completado sin estas fant√°sticas fuentes de conocimiento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al final de este libro, el lector podr√° comprender las complejidades de c√≥mo el int√©rprete de Python ejecuta su programa. </font><font style="vertical-align: inherit;">Esto incluye las diversas etapas de ejecuci√≥n del programa y las estructuras de datos que son cr√≠ticas en el programa. </font><font style="vertical-align: inherit;">Para comenzar, tomaremos una vista panor√°mica de lo que sucede cuando se ejecuta un programa trivial, cuando el nombre del m√≥dulo se pasa al int√©rprete en la l√≠nea de comando. </font><font style="vertical-align: inherit;">El c√≥digo ejecutable de CPython se puede instalar desde la fuente, siguiendo la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gu√≠a del desarrollador de Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este libro usa la versi√≥n Python 3.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vista de 30,000 pies</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este cap√≠tulo habla sobre c√≥mo el int√©rprete ejecuta un programa Python. En los siguientes cap√≠tulos, examinaremos las diversas partes de este "rompecabezas" y proporcionaremos una descripci√≥n m√°s detallada de cada parte. Independientemente de la complejidad de un programa escrito en Python, este proceso es siempre el mismo. La excelente explicaci√≥n dada por Yaniv Aknin en su </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serie de art√≠culos sobre Python Internal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> establece el tema para nuestra discusi√≥n.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El m√≥dulo fuente test.py se puede ejecutar desde la l√≠nea de comandos (cuando se pasa como argumento al programa de int√©rprete de Python en forma de $ python test.py). Esta es solo una forma de invocar el ejecutable de Python. Tambi√©n podemos lanzar un int√©rprete interactivo, ejecutar l√≠neas de un archivo como c√≥digo, etc. Pero este y otros m√©todos no nos interesan. Es la transferencia del m√≥dulo como argumento (dentro de la l√≠nea de comando) al archivo ejecutable (Figura 2.1) que mejor refleja el flujo de varias acciones que est√°n involucradas en la ejecuci√≥n real del c√≥digo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/bw/i5/tlbwi5onywd5j1xmkmyv7ni_lgm.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figura 2.1: Transmisi√≥n en tiempo de ejecuci√≥n.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El ejecutable de Python es un programa normal de C, por lo que cuando se lo llama, se producen procesos similares a los que existen, por ejemplo, en el kernel de Linux o en el programa simple hello world. </font><font style="vertical-align: inherit;">T√≥mese un minuto de su tiempo para comprender: el ejecutable de Python es solo otro programa que lanza el suyo. </font><font style="vertical-align: inherit;">Tales "relaciones" existen entre el lenguaje C y el ensamblador (o llvm). </font><font style="vertical-align: inherit;">El proceso de inicializaci√≥n est√°ndar (que depende de la plataforma donde se lleva a cabo la ejecuci√≥n) comienza cuando se llama al ejecutable de Python con el nombre del m√≥dulo como argumento.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este art√≠culo asume que est√° utilizando un sistema operativo basado en Unix, por lo que algunas caracter√≠sticas pueden variar en Windows.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El lenguaje </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el inicio ejecuta toda su "magia" de inicializaci√≥n: carga bibliotecas, verifica / establece variables de entorno, y despu√©s de eso, el m√©todo principal del ejecutable de Python se inicia como cualquier otro programa en C. El archivo ejecutable principal de Python se encuentra en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Programs/python.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y realiza una inicializaci√≥n (como hacer copias de los argumentos de la l√≠nea de comando del programa que se pasaron al m√≥dulo). La funci√≥n principal llama a la funci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Main</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ubicada en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Modules/main.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Procesa el proceso de inicializaci√≥n del int√©rprete: analiza los argumentos de la l√≠nea de comandos, establece indicadores, lee variables de entorno, ejecuta enlaces, aleatoriza funciones hash, etc. Tambi√©n llamado</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Initialize</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pylifecycle.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que maneja la inicializaci√≥n de las estructuras de datos del estado del int√©rprete y el flujo, son dos estructuras de datos muy importantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al examinar las declaraciones de las estructuras de datos del int√©rprete y los estados de flujo, queda claro por qu√© son necesarias. El estado del int√©rprete y la secuencia son solo estructuras con punteros a campos que contienen la informaci√≥n necesaria para ejecutar el programa. Los datos de estado del int√©rprete se crean a trav√©s de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typedef</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (solo piense en esta palabra clave en C como una definici√≥n de tipo, aunque esto no es del todo cierto). El c√≥digo para esta estructura se muestra en el Listado 2.1.</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-number">1</span>     <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">is</span> {</span>
 <span class="hljs-number">2</span> 
 <span class="hljs-number">3</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">is</span> *<span class="hljs-title">next</span>;</span>
 <span class="hljs-number">4</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">tstate_head</span>;</span>
 <span class="hljs-number">5</span> 
 <span class="hljs-number">6</span>         PyObject *modules;
 <span class="hljs-number">7</span>         PyObject *modules_by_index;
 <span class="hljs-number">8</span>         PyObject *sysdict;
 <span class="hljs-number">9</span>         PyObject *builtins;
<span class="hljs-number">10</span>         PyObject *importlib;
<span class="hljs-number">11</span> 
<span class="hljs-number">12</span>         PyObject *codec_search_path;
<span class="hljs-number">13</span>         PyObject *codec_search_cache;
<span class="hljs-number">14</span>         PyObject *codec_error_registry;
<span class="hljs-number">15</span>         <span class="hljs-keyword">int</span> codecs_initialized;
<span class="hljs-number">16</span>         <span class="hljs-keyword">int</span> fscodec_initialized;
<span class="hljs-number">17</span> 
<span class="hljs-number">18</span>         PyObject *builtins_copy;
<span class="hljs-number">19</span>     } PyInterpreterState;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listado de C√≥digo 2.1: Estructura de datos del estado del int√©rprete</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Cualquiera que haya usado el lenguaje de programaci√≥n Python durante mucho tiempo puede reconocer varios campos mencionados en esta estructura (sysdict, builtins, codec).</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">*</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> campo </font><b><font style="vertical-align: inherit;">siguiente</font></b><font style="vertical-align: inherit;"> es una referencia a otra instancia del int√©rprete, ya que pueden existir varios int√©rpretes de Python dentro del mismo proceso.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">campo * tstate_head</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indica el hilo principal de ejecuci√≥n (si el programa es multiproceso, entonces el int√©rprete es com√∫n para todos los hilos creados por el programa). </font><font style="vertical-align: inherit;">Discutiremos esto con m√°s detalle en breve.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modules, modules_by_index, sysdict, builtins</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">importlib</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hablan por s√≠ mismos. </font><font style="vertical-align: inherit;">Todos ellos se definen como instancias de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que es el tipo ra√≠z para todos los objetos en la m√°quina virtual Python. </font><font style="vertical-align: inherit;">Los objetos de Python se discutir√°n con m√°s detalle en los siguientes cap√≠tulos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los campos relacionados con el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥dec *</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contienen informaci√≥n que ayuda a descargar codificaciones. </font><font style="vertical-align: inherit;">Esto es muy importante para decodificar bytes.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La ejecuci√≥n del programa debe ocurrir en un hilo. </font><font style="vertical-align: inherit;">La estructura de estado de la secuencia contiene toda la informaci√≥n que la secuencia necesita para ejecutar alg√∫n objeto de c√≥digo. </font><font style="vertical-align: inherit;">Parte de la estructura de datos de flujo se muestra en el Listado 2.2.</font></font><br>
<br>
<pre><code class="cpp hljs"> <span class="hljs-number">1</span>     <span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> {</span>
 <span class="hljs-number">2</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">prev</span>;</span>
 <span class="hljs-number">3</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">ts</span> *<span class="hljs-title">next</span>;</span>
 <span class="hljs-number">4</span>         PyInterpreterState *interp;
 <span class="hljs-number">5</span> 
 <span class="hljs-number">6</span>         <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">frame</span> *<span class="hljs-title">frame</span>;</span>
 <span class="hljs-number">7</span>         <span class="hljs-keyword">int</span> recursion_depth;
 <span class="hljs-number">8</span>         <span class="hljs-keyword">char</span> overflowed; 
 <span class="hljs-number">9</span>                         
<span class="hljs-number">10</span>         <span class="hljs-keyword">char</span> recursion_critical; 
<span class="hljs-number">11</span>         <span class="hljs-keyword">int</span> tracing;
<span class="hljs-number">12</span>         <span class="hljs-keyword">int</span> use_tracing;
<span class="hljs-number">13</span> 
<span class="hljs-number">14</span>         Py_tracefunc c_profilefunc;
<span class="hljs-number">15</span>         Py_tracefunc c_tracefunc;
<span class="hljs-number">16</span>         PyObject *c_profileobj;
<span class="hljs-number">17</span>         PyObject *c_traceobj;
<span class="hljs-number">18</span> 
<span class="hljs-number">19</span>         PyObject *curexc_type;
<span class="hljs-number">20</span>         PyObject *curexc_value;
<span class="hljs-number">21</span>         PyObject *curexc_traceback;
<span class="hljs-number">22</span> 
<span class="hljs-number">23</span>         PyObject *exc_type;
<span class="hljs-number">24</span>         PyObject *exc_value;
<span class="hljs-number">25</span>         PyObject *exc_traceback;
<span class="hljs-number">26</span> 
<span class="hljs-number">27</span>         PyObject *dict;  <span class="hljs-comment">/* Stores per-thread state */</span>
<span class="hljs-number">28</span>         <span class="hljs-keyword">int</span> gilstate_counter;
<span class="hljs-number">29</span> 
<span class="hljs-number">30</span>         ... 
<span class="hljs-number">31</span>     } PyThreadState;</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Listado 2.2: Parte de la</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
estructura de </font><i><font style="vertical-align: inherit;">datos del estado del flujo</font></i><font style="vertical-align: inherit;"> Las estructuras de </font><i><font style="vertical-align: inherit;">datos del</font></i><font style="vertical-align: inherit;"> int√©rprete y los estados del flujo se discuten con m√°s detalle en los siguientes cap√≠tulos. El proceso de inicializaci√≥n tambi√©n establece mecanismos de importaci√≥n, as√≠ como un nivel b√°sico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de completar toda la inicializaci√≥n, Py_Main llama a la funci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run_file</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (tambi√©n ubicada en el m√≥dulo main.c). La siguiente es una serie de llamadas a funciones: PyRun_AnyFileExFlags -&gt; PyRun_SimpleFileExFlags -&gt; PyRun_FileExFlags -&gt; PyParser_ASTFromFileObject. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyRun_SimpleFileExFlags</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crea el espacio de nombres __principal__ en el que se ejecutar√° el contenido del archivo. Tambi√©n comprueba si existe la versi√≥n pyc del archivo (el archivo pyc es un archivo simple que contiene una versi√≥n ya compilada del c√≥digo fuente). Si existe una versi√≥n de pyc, se intentar√° leerlo como un archivo binario y luego ejecutarlo. Si falta el archivo pyc, se llama a PyRun_FileExFlags, etc. La funci√≥n PyParser_ASTFromFileObject llama a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyParser_ParseFileObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que lee el contenido del m√≥dulo y crea √°rboles de an√°lisis a partir de √©l. Luego, el √°rbol creado se pasa a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyParser_ASTFromNodeObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que crea un √°rbol de sintaxis abstracta a partir de √©l.</font></font><br>
<br>
<blockquote>     ,     Py_INCREF  Py_DECREF.    ,     . CPython        :  ,      ,    Py_INCREF. ,      ,       Py_DECREF.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AST se genera cuando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> llama </font><b><font style="vertical-align: inherit;">run_mod</font></b><font style="vertical-align: inherit;"> . Esta funci√≥n llama a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyAST_CompileObject</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que crea objetos de c√≥digo a partir de AST. Tenga en cuenta que el c√≥digo de bytes generado durante la llamada PyAST_CompileObject se pasa a trav√©s del optimizador de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mirilla</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> simple </font><font style="vertical-align: inherit;">, que realiza una optimizaci√≥n baja del c√≥digo de </font><font style="vertical-align: inherit;">bytes </font><font style="vertical-align: inherit;">generado antes de crear objetos de c√≥digo. La funci√≥n run_mod continuaci√≥n, se aplica la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyEval_EvalCode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funci√≥n </font><font style="vertical-align: inherit;">de la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ceval.c</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> archivo </font><font style="vertical-align: inherit;">al objeto c√≥digo. Esto lleva a otra serie de llamadas a funciones: PyEval_EvalCode -&gt; PyEval_EvalCode -&gt; _PyEval_EvalCodeWithName -&gt; _PyEval_EvalFrameEx. El objeto de c√≥digo se pasa como argumento a la mayor√≠a de estas funciones de una forma u otra. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_PyEval_EvalFrameEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Este es un bucle de int√©rprete normal que maneja la ejecuci√≥n de objetos de c√≥digo. Sin embargo, se llama no solo con el objeto de c√≥digo como argumento, sino con el objeto de marco, que tiene como atributo un campo que se refiere al objeto de c√≥digo. Este marco proporciona el contexto para la ejecuci√≥n del objeto de c√≥digo. En palabras simples: el bucle de int√©rprete lee continuamente la siguiente instrucci√≥n indicada por el contador de instrucciones del conjunto de instrucciones. Luego ejecuta esta instrucci√≥n: agrega o elimina objetos de la pila de valores en el proceso hasta que se vac√≠a en la matriz de instrucciones que se ejecutar√°n (bueno, o sucede algo excepcional que interrumpe el ciclo).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python proporciona un conjunto de funciones que puede usar para examinar objetos de c√≥digo real. Por ejemplo, un programa simple puede compilarse en un objeto de c√≥digo y desmontarse para obtener c√≥digos de operaci√≥n que son ejecutados por la m√°quina virtual de Python. Esto se muestra en el Listado 2.3.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-number">1</span>         &gt;&gt;&gt; <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">square</span>(<span class="hljs-params">x</span>):</span>
<span class="hljs-number">2</span>         ...     <span class="hljs-keyword">return</span> x*x
<span class="hljs-number">3</span>         ... 
<span class="hljs-number">4</span> 
<span class="hljs-number">5</span>         &gt;&gt;&gt; dis(square)
<span class="hljs-number">6</span>         <span class="hljs-number">2</span>           <span class="hljs-number">0</span> LOAD_FAST                <span class="hljs-number">0</span> (x)
<span class="hljs-number">7</span>                     <span class="hljs-number">2</span> LOAD_FAST                <span class="hljs-number">0</span> (x)
<span class="hljs-number">8</span>                     <span class="hljs-number">4</span> BINARY_MULTIPLY     
<span class="hljs-number">9</span>                     <span class="hljs-number">6</span> RETURN_VALUE        </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Listado de C√≥digo 2.3: Desmontaje de una funci√≥n en Python El </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
archivo de encabezado </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">./Include/opcodes.h</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contiene una lista completa de todas las instrucciones / </font><b><font style="vertical-align: inherit;">c√≥digos de operaci√≥n</font></b><font style="vertical-align: inherit;"> para la m√°quina virtual Python. Los c√≥digos de operaci√≥n son bastante simples. Tome nuestro ejemplo en el Listado 2.3, que tiene un conjunto de cuatro instrucciones. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LOAD_FAST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> carga el valor de su argumento (en este caso x) </font><b><font style="vertical-align: inherit;">en la</font></b><font style="vertical-align: inherit;"> pila de valores. La m√°quina virtual de Python se basa en la pila, por lo que los valores para las operaciones de c√≥digo de operaci√≥n se "extraen" de la pila, y los resultados del c√°lculo se vuelven a colocar en la pila para que otros c√≥digos de operaci√≥n los utilicen. Luego, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BINARY_MULTIPLY extrae</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dos elementos de la pila, realiza la multiplicaci√≥n binaria de ambos valores y empuja el resultado nuevamente </font><b><font style="vertical-align: inherit;">a la</font></b><font style="vertical-align: inherit;"> pila. Instrucci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor de retorno</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recupera un valor de la pila, establece el valor de retorno para el objeto en este valor y sale del bucle de int√©rprete. </font><font style="vertical-align: inherit;">Si observa el Listado 2.3, est√° claro que esta es una simplificaci√≥n bastante s√≥lida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La explicaci√≥n actual del bucle de int√©rprete no tiene en cuenta una serie de detalles, que se discutir√°n en cap√≠tulos posteriores. </font><font style="vertical-align: inherit;">Por ejemplo, estas son las preguntas a las que no recibimos respuesta:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øDe d√≥nde provienen los valores cargados por la declaraci√≥n LOAD_FAST?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øDe d√≥nde vienen los argumentos, que se usan como parte de las instrucciones?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øC√≥mo se manejan las llamadas a funciones y m√©todos anidados?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øC√≥mo maneja el bucle de int√©rprete las excepciones?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de completar todas las instrucciones, la funci√≥n Py_Main contin√∫a la ejecuci√≥n, pero esta vez comienza el proceso de limpieza. </font><font style="vertical-align: inherit;">Si </font><font style="vertical-align: inherit;">se llama a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_Initialize</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para realizar la inicializaci√≥n durante el inicio del int√©rprete, </font><font style="vertical-align: inherit;">se llama a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Py_FinalizeEx</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para realizar la limpieza. </font><font style="vertical-align: inherit;">Este proceso incluye esperar la salida de los subprocesos, llamar a los controladores de salida, as√≠ como liberar la memoria a√∫n utilizada asignada por el int√©rprete.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y as√≠, miramos la descripci√≥n de "alto nivel" de los procesos que ocurren en el ejecutable de Python cuando se ejecuta un script. </font><font style="vertical-align: inherit;">Como se se√±al√≥ anteriormente, quedan muchas preguntas por responder. </font><font style="vertical-align: inherit;">En el futuro, profundizaremos en el estudio del int√©rprete y consideraremos en detalle cada una de las etapas. </font><font style="vertical-align: inherit;">Y comenzaremos describiendo el proceso de compilaci√≥n en el pr√≥ximo cap√≠tulo.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es501326/index.html">C√≥mo convertirse en ingeniero de DevOps en seis meses o incluso m√°s r√°pido. Parte 3. Versiones</a></li>
<li><a href="../es501328/index.html">Presentaci√≥n de Visual Studio Codespaces: desarrollo en la nube, donde sea que se encuentre</a></li>
<li><a href="../es501330/index.html">Microservicios en C ++. ¬øFicci√≥n o realidad?</a></li>
<li><a href="../es501332/index.html">Las reuniones son f√°ciles. Tres consejos de pr√°ctica diaria</a></li>
<li><a href="../es501336/index.html">FOSS News No. 15: una revisi√≥n de las noticias gratuitas y de c√≥digo abierto del 4 al 10 de mayo de 2020</a></li>
<li><a href="../es501340/index.html">¬øPor qu√© est√° ganando Flutter?</a></li>
<li><a href="../es501342/index.html">Certificaci√≥n en l√≠nea de Microsoft - Notas de campo</a></li>
<li><a href="../es501344/index.html">Suministro de ventilaci√≥n combinada con aire acondicionado por conductos (parte 1 - el√©ctrico)</a></li>
<li><a href="../es501346/index.html">Descripci√≥n general del teclado mec√°nico Vortex Core RGB</a></li>
<li><a href="../es501352/index.html">Kafka contraataca</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>