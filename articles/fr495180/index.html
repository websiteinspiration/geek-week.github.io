<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¶üèº üë®üèΩ‚Äçüè≠ üßëüèΩ‚Äçü§ù‚Äçüßëüèº We pump Ikea: comment transformer la musique l√©g√®re en Big Brother üë®üèæ‚Äçüöí üë©üèª‚Äçüç≥ üö±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="introduction
 Ikea est un magasin curieux. M√™me si vous y √™tes entr√© avec l'intention d'acheter une chose sp√©cifique et de ne pas √™tre distrait par to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We pump Ikea: comment transformer la musique l√©g√®re en Big Brother</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495180/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/g-/1c/b3/g-1cb35ov13g0bc7demuvnxiqla.gif"></div><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ikea est un magasin curieux. M√™me si vous y √™tes entr√© avec l'intention d'acheter une chose sp√©cifique et de ne pas √™tre distrait par tout le reste de la camelote, vous sortirez en achetant trois fois plus que n√©cessaire. Pour nous les pirates, cet effet est particuli√®rement √©vident dans le d√©partement Ikea avec des c√¢bles d'alimentation ou des batteries. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour moi, le dernier cas d'une telle folie s'est produit aux Pays-Bas. J'√©tais sur un voyage pr√©vu, pr√©voyant de passer seulement quelques semaines dans le pays. Cependant, c'√©tait au tout d√©but de 2020 et la catastrophe de COVID-19 ... J'ai d√ª rester loin de mon laboratoire beaucoup plus longtemps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et quand j'ai vu la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gamme de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> produits √©lectroniques de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Frekevens</font></a><font style="vertical-align: inherit;"> chez Ikea </font><font style="vertical-align: inherit;">, je n'ai pas pu m'en emp√™cher et j'ai tout achet√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ceux qui ne le savent pas: la ligne Ikea Frekvens devrait devenir un analogue moderne de l'ensemble Hi-Fi old-school plus l'ensemble de musique l√©ger hexagonal, qui semble √™tre dans les maisons de la moiti√© des adolescents des ann√©es 90. Dans ce cas, la gamme d'appareils connect√©s les uns aux autres se compose d'un haut-parleur Bluetooth pour la sortie audio et d'un projecteur LED (compl√©t√© par diverses buses) qui scintillent au rythme de la musique, ainsi qu'un affichage √† cube LED pouvant afficher des animations qui se d√©placent √©galement dans la musique. Ikea se targue que cette ligne a √©t√© d√©velopp√©e en collaboration avec Teenage Engineering, connue pour sa s√©rie Pocket Operator de synth√©tiseurs portables "jouets".</font></font><br>
<a name="habracut"></a><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f4d/8b4/e60/f4d8b4e60e7812b5b979850a18d3926c.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme le montre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la vid√©o promotionnelle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ikea, l'achat final de dizaines d'appareils devrait ressembler √† un carnaval scintillant insupportable, ce que mon adolescent de 15 ans ne voudrait pas organiser dans sa chambre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'√©tais particuli√®rement int√©ress√© par l'affichage LED cube: c'est un appareil int√©gr√© de haute qualit√© qui fonctionne sur le secteur. Sur le panneau avant se trouve une matrice de 16 lignes et 16 colonnes de LED blanches tr√®s lumineuses, soit un total de 256 LED. Les animations int√©gr√©es √† l'appareil √©taient assez simples, mais elles m'ont amen√© √† l'id√©e que le fer peut r√©ellement contr√¥ler chaque LED individuellement. Cependant, pour cette raison, la petite bo√Æte √©tait assez ch√®re: ma poche √©tait vide d'environ 40 euros. Pour ce montant, vous obtenez une bo√Æte avec des LED et un c√¢ble d'alimentation. Comme il est suppos√© que vous devez acheter ce produit avec d'autres produits Frekvens, vous recevez √©galement des √©l√©ments de connexion suppl√©mentaires: un c√¢ble d'alimentation d'extension pour une alimentation de bout en bout du secteur aux autres bo√Ætiers,ainsi qu'un ensemble de vis et de tampons en plastique avec lesquels vous pouvez fixer m√©caniquement le bo√Ætier les uns aux autres.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D√®s que je suis rentr√© chez moi, j'ai connect√© l'appareil et ... pour √™tre honn√™te, j'ai √©t√© un peu d√©√ßu de ce qu'ils ont fait avec le fer √† repasser. </font><font style="vertical-align: inherit;">L'appareil avait plusieurs animations qui pouvaient √™tre s√©lectionn√©es en appuyant sur un bouton √† l'arri√®re du bo√Ætier; </font><font style="vertical-align: inherit;">un petit microphone est install√© dans le bo√Ætier - chaque fois qu'il reconna√Æt le bruit, le cadre de l'animation change. </font><font style="vertical-align: inherit;">Les animations ne sont pas tr√®s int√©ressantes: elles ne comportent que quatre √† cinq images, et les images elles-m√™mes sont uniquement en noir et blanc, sans nuances de gris. </font><font style="vertical-align: inherit;">Si vous √™tes curieux, j'ai enregistr√© une courte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vid√©o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec toutes les animations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√âvidemment, cela ne me convenait pas. </font><font style="vertical-align: inherit;">Piratons l'appareil - voyons ce qui le fait fonctionner et est-il possible de rendre son comportement un peu plus int√©ressant.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autopsie</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour d√©monter Frekvens, un tournevis pour une fente en forme de croix et, √©ventuellement, un couteau suffiront. </font><font style="vertical-align: inherit;">Vous aurez √©galement besoin d'une bonne part de pers√©v√©rance, car l'appareil n'est pas facile √† d√©monter: la conception est compliqu√©e et certains √©l√©ments sont remplis de silicone, probablement pour se d√©barrasser des vibrations et simplifier la fabrication.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/71d/6e9/925/71d6e9925d31cbce7d1da4cf492948de.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le d√©montage de l'affaire Frekvens commence par derri√®re. </font><font style="vertical-align: inherit;">Le bo√Ætier a des trous de vis sur tous les c√¥t√©s, √† l'exception de l'avant; </font><font style="vertical-align: inherit;">gr√¢ce au jeu de vis et de couvercles du kit de l'appareil, il peut √™tre connect√© √† d'autres gadgets Frekvens. </font><font style="vertical-align: inherit;">Cependant, les trous arri√®re pour les vis sont un peu plus profonds et sous eux se trouvent des vis qui fixent le bo√Ætier.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebf/2c5/8e2/ebf2c58e270c942b8e360a744f0ff6ea.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir retir√© le couvercle arri√®re, nous voyons que tous les trous de vis ont des inserts m√©talliques filet√©s dans lesquels les vis peuvent √™tre viss√©es. </font><font style="vertical-align: inherit;">Hou la la! </font><font style="vertical-align: inherit;">Cela devrait fournir aux trous une marge de s√©curit√© suffisante. </font><font style="vertical-align: inherit;">Il est possible que cela complique grandement la fabrication ou le d√©montage; </font><font style="vertical-align: inherit;">ce dernier est compliqu√© par le fait que nous devons d'abord couper les gouttes de compos√© de silicone durci.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ca/78c/bf2/4ca78cbf2e1f533658a361fd998a933a.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les inserts sont en fait fix√©s avec d'autres inserts en plastique; </font><font style="vertical-align: inherit;">ils doivent d'abord √™tre supprim√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai pas d'autres photos du processus de d√©montage, mais apr√®s cette √©tape, vous verrez quatre vis qui doivent √™tre d√©viss√©es, puis le processus se poursuit comme auparavant. </font><font style="vertical-align: inherit;">Comprenez quelle pi√®ce en plastique retient tout le reste, coupez le compos√© de silicone, retirez les attaches en plastique. </font><font style="vertical-align: inherit;">Continuez jusqu'√† ce que vous puissiez retirer la carte de circuit imprim√©.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e40/8c0/346/e408c0346ddbea872aa6100a7c37c303.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le voici: l'envers de la carte de circuit imprim√©. Comme il s'est av√©r√©, il est assembl√© √† partir de deux cartes de circuits imprim√©s: la blanche a deux c√¥t√©s - √† l'arri√®re il y a tous les pilotes de LED (et une autre carte y est attach√©e), et √† l'avant il y a les LED elles-m√™mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le circuit imprim√© blanc est plut√¥t bien con√ßu: au lieu d'une matrice de LED, il y a 16 pilotes de LED </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SCT2024</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">travaillant √† partir d'un courant continu. Ces pilotes de LED ont 16 canaux, c'est-√†-dire que chaque LED est directement contr√¥l√©e. Les pilotes de LED peuvent uniquement allumer ou √©teindre compl√®tement les LED; les pilotes eux-m√™mes n'ont pas de support natif en niveaux de gris. En fait, ils effectuent un d√©calage de registre en utilisant des sorties contr√¥l√©es par le courant, et ils commutent tous s√©quentiellement; L'interface de connexion PCB verte se compose de son bus de synchronisation et de ses donn√©es, d'une ligne d'activation par enclenchement, d'une ligne de sortie, d'une mise √† la terre et d'une alimentation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur ce tableau vert se trouve le petit cerveau de l'appareil: un microcontr√¥leur, dont l'article est introuvable sur Google, et un amplificateur op√©rationnel pour le microphone. </font><font style="vertical-align: inherit;">Fait int√©ressant, il y a des indices que l'appareil devrait avoir plus de fonctionnalit√©s: il y a probablement une place pour I2C EEPROM 24Cxx et un indice que dans le projet d'origine, il y avait un r√©cepteur IR sur le panneau avant. </font><font style="vertical-align: inherit;">Peut-√™tre √©tait-il suppos√© que l'appareil serait livr√© avec une t√©l√©commande qui vous permet de cr√©er vos propres mod√®les? </font><font style="vertical-align: inherit;">Cela peut expliquer que les animations existantes semblent si ennuyeuses.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/40f/a7a/1d9/40fa7a1d95a60af223eb12a5f5db7ba6.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le devant du tableau blanc se trouvent toutes les LED. </font><font style="vertical-align: inherit;">Un minuscule microphone plat lui est √©galement soud√©. </font><font style="vertical-align: inherit;">Au d√©but, je pensais qu'il √©tait soud√© au tableau vert et d√©passait par le trou du tableau blanc, mais en fait, il est tout simplement plat.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2bb/613/620/2bb6136207e5ce1cf78895a6827a8dfd.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les autres appareils √©lectroniques sont situ√©s √† l'arri√®re de la carte. </font><font style="vertical-align: inherit;">Il ne suffit pas l√†-bas: seulement une alimentation sous la marque Ikea, d√©livrant 4 V. Sous l'alimentation, il y a une petite carte de circuit imprim√© sur laquelle il y a deux commutateurs tactiles pour les boutons √† l'arri√®re du bo√Ætier. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, si nous voulons ¬´optimiser¬ª la conception, nous avons alors une faiblesse √©vidente: il vaut mieux remplacer une petite carte verte par un processeur avec quelque chose de plus puissant.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous modifions le fer</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai pens√© qu'il serait possible de remplacer l'√©quipement par une ESP-Cam. Il s'agit d'une carte tr√®s bon march√© (10 euros environ) avec une puce ESP32 WiFi / BT, plusieurs m√©gaoctets de PSRAM et un module de cam√©ra. Je ne suis pas tr√®s int√©ress√© par la musique l√©g√®re, je voulais que l'appareil r√©ponde √† quelque chose de visuel. Comme il y avait d√©j√† un trou √† l'avant pour le r√©cepteur, j'ai pens√© que je pouvais l'utiliser sous la cam√©ra. Je devrai √©galement percer un trou dans le tableau blanc o√π se trouve le microphone; heureusement, outre ces pistes de microphone d√©sormais inutiles, cela ne d√©truira qu'une seule piste de la LED. J'ai perc√© un trou et restaur√© la piste. En remettant temporairement la carte en place et en allumant le cube, je me suis assur√© que toutes les LED fonctionnent toujours.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ed1/c45/456/ed1c454569bc1fa6734a8c16bdfed1ae.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, j'avais une planche avec un trou perc√©, et je ne pouvais que connecter et connecter m√©caniquement l'ESP-Cam. Les concepteurs ont aimablement indiqu√© le but de tous les tampons sur la s√©rigraphie du tableau vert, donc je devais presque ne rien deviner. √âtant donn√© que l'alimentation ne fournit que 4 V, je l'ai connect√©e directement √† l'entr√©e 3,3 V de la puce ESP-CAM. Je devais le faire, car lorsque je l'ai connect√© √† la broche Vin 5V, la puce ne voulait pas d√©marrer ... Tr√®s probablement, le r√©gulateur LDO a une chute de tension l√©g√®rement √©lev√©e. Pour en revenir, je pense maintenant que cela valait la peine d'essayer de connecter la diode en s√©rie avec une source 4 V pour obtenir 3,3-3,4 V, mais ma solution a fonctionn√©; ESP32 est assez sans pr√©tention.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/021/93d/abe/02193dabe8880ceeea91807ec0a16d2f.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soudant tous les connecteurs, j'ai quand m√™me d√ª m'occuper de la m√©canique. </font><font style="vertical-align: inherit;">C'√©tait un projet ¬´rapide et sale¬ª, et j'avais d√©j√† soud√© les connecteurs ESP-Cam auparavant, donc pour aligner la cam√©ra avec le trou, vous pourriez le faire avec plusieurs joints et beaucoup d'√©poxy.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e62/f14/364/e62f143645504bfd1636cab8fdb3cdf8.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cette op√©ration, le dernier probl√®me est rest√©: les LED √† c√¥t√© de la cam√©ra ont brill√© sur sa fen√™tre de cadre, provoquant toutes sortes d'artefacts √©tranges. </font><font style="vertical-align: inherit;">Tout d'abord, pour les √©liminer, j'ai d√©coup√© une petite lunette dans une bande d'aluminium pour prot√©ger l'appareil photo de la lumi√®re directe.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fa7/1a8/1bb/fa71a81bb0a3131132885840f8186e85.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxi√®me √©tape a √©t√© l'application de peinture acrylique. </font><font style="vertical-align: inherit;">Il s'agit d'un insert en plastique sur lequel se trouvent tous les diffuseurs, √† travers lequel les LED brillent. </font><font style="vertical-align: inherit;">J'ai d√©j√† agrandi le trou qu'il avait pour le microphone afin de cr√©er une fen√™tre de cadre plus large pour la cam√©ra, mais cela a conduit √† un autre probl√®me - le trou √©tait trop visible et trop de lumi√®re diffuse tombait sur la cam√©ra. </font><font style="vertical-align: inherit;">Une tache de peinture acrylique noire a plut√¥t bien fonctionn√© sur les deux points; </font><font style="vertical-align: inherit;">la cam√©ra recevait encore beaucoup de lumi√®re des LED, mais maintenant elle ne l'inondait pas compl√®tement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, la transplantation c√©r√©brale est termin√©e et le corps est pr√™t pour l'assemblage. </font><font style="vertical-align: inherit;">Vous pouvez d√©marrer le logiciel.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logiciel</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons au logiciel. Tout d'abord, nous devons prendre le contr√¥le des pilotes LED. Ce n'est pas difficile: les signaux du pilote sont presque directement coh√©rents avec l'interface p√©riph√©rique SPI de la puce ESP32: le pad CLK sur la carte se connecte √† l'interface CLK p√©riph√©rique SPI, le pad DA sur la carte se connecte au MOSI du signal SPI. Cela vous permettra de synchroniser 256 bits avec une cha√Æne de pilotes de LED: chaque bit synchronis√© contr√¥le l'allumage ou l'extinction de la LED correspondante. De plus, il y a une entr√©e LAK. Si le signal est faible, la LED conserve sa valeur pr√©c√©dente, ind√©pendamment de ce qui a √©t√© transf√©r√© aux registres √† d√©calage; si le signal est √©lev√©, alors ils basculent tous simultan√©ment sur les valeurs qui sont actuellement dans le registre √† d√©calage. Enfin, il existe une entr√©e EN qui allume ou √©teint toutes les LED;Je ne l'ai pas connect√© √† GPIO et j'allume toujours les LED par programmation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, je peux maintenant allumer et √©teindre des LED individuelles, obtenant un affichage en noir et blanc. Cependant, j'ai besoin d'autre chose. Avec une puissance de calcul suffisante, l'√©cran devrait √©galement √™tre capable d'afficher des nuances de gris - pour cela, il vous suffit d'allumer / √©teindre les LED plus rapidement que l'≈ìil ne le voit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour impl√©menter cela avec une seule LED, j'utilise g√©n√©ralement PWM, mais dans le cas de 256 LED, cela occupera une partie importante du processeur ESP32. Au lieu de cela, j'ai d√©cid√© d'utiliser la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modulation de code binaire</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (√©galement appel√©e modulation d'angle de bit). Il s'agit d'une technique qui vous permet d'obtenir des nuances de gris avec moins de puissance CPU. Je l'ai d√©j√† utilis√© avec succ√®s dans d' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autres projets</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , j'√©tais donc s√ªr que cela fonctionnerait.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e99/009/265/e990092656bfd3db2032718f55e7e086.jpg"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et √ßa a march√©. J'ai √©galement ajout√© une table de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conversion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">convertir la luminosit√© CIE en PWM</font></a><font style="vertical-align: inherit;"> , car l'≈ìil r√©pond essentiellement √† la luminosit√© des LED de mani√®re non lin√©aire; La table de recherche r√©sout ce probl√®me. Au final, j'ai r√©ussi √† obtenir une quantit√© suffisante de nuances de gris et une mise √† l'√©chelle lin√©aire de la luminosit√© optique en fonction de la valeur de pixel que j'ai d√©finie.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La mise en ≈ìuvre du projet de cam√©ra n'a pas √©t√© difficile: il existe un composant ESP-IDF qui peut √™tre ajout√© au projet; il se chargera de configurer la cam√©ra et d'√©changer des donn√©es avec elle, il vous suffit de sp√©cifier les param√®tres dont vous avez besoin, puis de demander le bitmap que la cam√©ra voit. La seule chose que je ne pouvais pas utiliser dans le r√©glage standard √©tait que l'alignement automatique et l'exposition automatique √©taient activ√©s par d√©faut, ce qui interf√©rait √† peu pr√®s avec ma fa√ßon de contr√¥ler les LED: selon la partie de la s√©quence de modulation du code binaire que l'image a √©t√© cr√©√©e, la cam√©ra a plut√¥t augment√© ou diminu√© de fa√ßon al√©atoire l'alignement et l'exposition. J'ai r√©solu le probl√®me en commutant l'appareil photo sur l'alignement manuel et la vitesse d'obturation; le code lui-m√™me examine l'image et d√©termine si ces param√®tres n√©cessitent une compensation.Gr√¢ce √† un tel traitement manuel, j'ai √©galement r√©ussi √† exclure les pixels qui regardaient directement les LED afin de les supprimer compl√®tement de l'√©quation. Cela a √©galement grandement aid√© √† obtenir une image stable.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai maintenant un appareil photo et une toile 16x16 dans des tons de gris. Que dois-je en faire? J'ai eu une id√©e: √† l'√©poque des tout premiers ordinateurs Macintosh, il y avait une extension populaire qui n'ajoutait que quelques yeux de dessin anim√© √† la barre de menus. Ces yeux suivaient simplement le curseur. (Une variante de ce th√®me pour Linux / Unix appel√©e "xeyes" existe toujours.) Et si j'essaie de le r√©p√©ter dans la vraie vie?</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6d1/c9e/0a1/6d1c9e0a114c84f246c051c4358cdcc7.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, j'avais besoin de quelques images des yeux. Je ne pensais pas que je pouvais dessiner quelque chose de valable, alors j'ai d√©cid√© d'utiliser mes propres yeux comme images de base; regarder une courte vid√©o dans laquelle je regarde et clignote dans toutes les directions. Il convient de noter qu'en raison de la situation actuelle, je disposais de tr√®s peu d'outils professionnels: je m'allonge par terre pour maximiser l'√©clairage tombant des lampes fluorescentes au plafond et obtenir une image lisible; Toute la vid√©o a √©t√© tourn√©e sur le smartphone que je tiens dans mes mains.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme les donn√©es initiales √©taient plut√¥t b√¢cl√©es, j'ai d√ª travailler dur sur le post-traitement. J'ai commenc√© par d√©couper un fragment qui √©tait approximativement autour de mon ≈ìil droit. J'ai ensuite converti chaque image de la vid√©o en une image et supprim√© toutes les images redondantes; √† la fin, j'avais une bonne s√©lection d'images de moi regardant dans des directions diff√©rentes, ainsi que quelques images avec un clin d'≈ìil. Cependant, puisque j'ai utilis√© un t√©l√©phone portable pour l'enregistrement, la vid√©o s'est av√©r√©e un peu tremblante et les images ont saut√©. Pour r√©soudre ce probl√®me, j'ai transmis un ensemble d'images via le programme de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">collage d'</font></a><font style="vertical-align: inherit;"> images </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hugin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui est g√©n√©ralement utilis√© pour les panoramas et les images HDR; √† la sortie, j'ai obtenu des photos id√©alement centr√©es sur cette partie de mon visage. Maintenant, je ne pouvais que marquer dans quelle direction je regardais et si je clignais des yeux. J'ai fait cela en convertissant d'abord toutes les images en nuances de gris puis en les t√©l√©chargeant sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gimp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Dans chaque image, j'ai utilis√© un point rouge pour indiquer l'emplacement du centre de la pupille, plus un point rouge dans le coin gauche ou droit pour indiquer si je cligne des yeux, et si je cligne des yeux, alors mon ≈ìil est √† moiti√© ouvert ou ferm√©.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bb6/112/a73/bb6112a73c7b9fbdb619afaff1b971c9.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir marqu√© chaque image de cette mani√®re, il est devenu tr√®s simple d'√©crire un script pour obtenir l'emplacement de la pupille, ainsi que l'√©tat de clignotement. Le script a √©galement mis √† l'√©chelle les images en 16 x 16 et les a enregistr√©es sous forme de donn√©es binaires brutes, pr√™tes √† √™tre √©crites dans le micrologiciel du module ESP-CAM. En fin de compte, j'ai obtenu un ensemble d'images et un index de l'endroit o√π se trouve la pupille et dans quel √©tat de cligner les yeux.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'ESP-Cam a un composant de biblioth√®que de cam√©ras assez facile √† utiliser pour l'ESP-IDF, donc obtenir des images √©tait facile. J'ai configur√© la capture d'images 120x160 dans des tons de gris, car elles sont les plus faciles √† traiter, et je n'ai pas eu besoin de beaucoup de r√©solution, car le r√©sultat final devrait √™tre affich√© sur un √©cran 16x16. Cependant, j'ai toujours eu un probl√®me mat√©riel: la cam√©ra est encore trop proche des LED.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cb1/d78/621/cb1d786213e7450791968f0e7da4d6c3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au d√©but, j'ai essay√© de le r√©soudre par calibrage: au d√©marrage de l'appareil, il prend deux photos: une avec une LED proche de l'objectif de la cam√©ra, et une seule avec une LED situ√©e loin de la cam√©ra. En soustrayant une image d'une autre, vous pouvez comprendre quels pixels sont affect√©s par les LED. Ces pixels sont stock√©s dans le masque; les pixels marqu√©s dans le masque sont ensuite ignor√©s. L'image ci-dessus montre deux plans et un masque.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec une image plus nette, je pouvais passer √† la reconnaissance de mouvement. Je l'ai impl√©ment√© en r√©cup√©rant une image de la cam√©ra et en soustrayant l'image pr√©c√©dente de celle-ci. Ensuite, j'ai pu calculer la quantit√© de mouvement en additionnant tous les pixels r√©sultants. De plus, il a √©t√© possible de calculer l'emplacement de la concentration de mouvement en prenant la moyenne des coordonn√©es de tous les pixels pond√©r√©e par la diff√©rence d'images dans ce pixel. En fin de compte, la magie du filtrage est effectu√©e de mani√®re √† ce que l'appareil ne ressemble pas √† un jack Russell Terrier atteint de TDAH: pour attirer son attention, les objets doivent se d√©placer plus uniform√©ment ou se d√©placer assez loin.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y avait qu'un seul probl√®me: quand il faisait tr√®s sombre, l'algorithme de reconnaissance de mouvement travaillait parfois sur la r√©flexion des LED sur des objets brillants dans la pi√®ce: si l'≈ìil clignait des yeux, alors faites attention √† sa propre r√©flexion. </font><font style="vertical-align: inherit;">Ce n'est pas tout √† fait ce que je voulais, j'ai donc contourn√© ce probl√®me en rendant l'algorithme de reconnaissance de mouvement ¬´aveugle¬ª lors du changement d'image sur les LED; </font><font style="vertical-align: inherit;">j'ai donc arr√™t√© ce comportement. </font><font style="vertical-align: inherit;">De plus, c'est aussi un peu plus r√©aliste: lorsque vous clignez des yeux, vous ne pouvez pas voir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le firmware dispose de plusieurs modes de d√©bogage qui illustrent l'ensemble du processus. </font><font style="vertical-align: inherit;">Voici une courte vid√©o illustrant cela:</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/bR-CpMdz02I" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors maintenant j'ai un appareil qui me suit ... pas vraiment utile, je suis d'accord. </font><font style="vertical-align: inherit;">Mais c'√©tait int√©ressant pour moi de le cr√©er, et si jamais je trouve quelque chose de plus utile qui peut √™tre impl√©ment√© sur un √©cran LED 16x16, alors je peux le faire, car j'ai d√©j√† un code de contr√¥le. </font><font style="vertical-align: inherit;">En parlant de code: vous pouvez t√©l√©charger gratuitement mon r√©sultat brut √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partir d'ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">J'esp√®re que vous avez appr√©ci√© et faites attention.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/UCPUPO21Cwk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495168/index.html">Une forme alternative de l'op√©rateur ternaire Python</a></li>
<li><a href="../fr495170/index.html">Ce qui semble temporairement disparu de nos vies, et dont le retour ne vaut pas la peine d'attendre - une discussion</a></li>
<li><a href="../fr495174/index.html">Freelance professionnel</a></li>
<li><a href="../fr495176/index.html">Correction de la s√©rialisation des objets dans Kotlin une fois pour toutes</a></li>
<li><a href="../fr495178/index.html">Il est temps pour les sites gratuits</a></li>
<li><a href="../fr495184/index.html">Les difficult√©s de la substitution des importations: un outil pour les soci√©t√©s d'√âtat est supprim√© du registre des logiciels nationaux</a></li>
<li><a href="../fr495188/index.html">Difficult√©s dans l'enseignement des langues √©trang√®res (je recommanderais √©galement aux √©tudiants)</a></li>
<li><a href="../fr495192/index.html">Le script de lancement de serveur Minecraft parfait</a></li>
<li><a href="../fr495194/index.html">Carte audio minimale STM-32</a></li>
<li><a href="../fr495196/index.html">Si l'IB avait un ¬´Darwin Award¬ª, ou 7 histoires sur la stupidit√©, les ordures, la cr√©dulit√© et leurs cons√©quences</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>