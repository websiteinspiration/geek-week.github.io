<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìû ü§ΩüèΩ üëåüèª O ESP-NOW √© um protocolo de comunica√ß√£o alternativo para o ESP8266 e o ‚Äã‚ÄãESP32. Conceitos B√°sicos ü§≥üèø üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø üéå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O ESP-NOW √© um protocolo WiFi simplificado para transfer√™ncia de pacotes curtos entre pares de dispositivos emparelhados, desenvolvido e lan√ßado pela ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>O ESP-NOW √© um protocolo de comunica√ß√£o alternativo para o ESP8266 e o ‚Äã‚ÄãESP32. Conceitos B√°sicos</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502260/"><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ESP-NOW √© um protocolo WiFi simplificado para transfer√™ncia de pacotes curtos entre pares de dispositivos emparelhados, desenvolvido e lan√ßado pela </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espressif</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em 2016.07 para os microcontroladores ESP8266 e ESP32. </font><font style="vertical-align: inherit;">Ao mesmo tempo, procedimentos adicionais relacionados ao suporte ao protocolo WiFi n√£o s√£o usados, o que acelera o processo de troca de pacotes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ESP-NOW pode ser usado na Internet das Coisas para controlar fontes de luz inteligentes, rel√©s, soquetes e outros dispositivos de controle remoto, receber informa√ß√µes de sensores e outras aplica√ß√µes.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O ESP-NOW suporta os seguintes recursos</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comunica√ß√£o criptografada e n√£o criptografada entre dispositivos emparelhados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comunica√ß√£o mista criptografada e n√£o criptografada entre dispositivos emparelhados. </font></font><br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transfira at√© 250 bytes de informa√ß√µes √∫teis.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configurando uma fun√ß√£o de retorno de chamada para informar a camada de aplicativo, em particular, sobre o sucesso ou falha da transmiss√£o.</font></font></li>
</ul><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O ESP-NOW tamb√©m possui os seguintes recursos e limita√ß√µes.</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Velocidade de transmiss√£o - n√£o mais que 1 Mbps a uma frequ√™ncia de 2,4 GHz, ou seja, </font><font style="vertical-align: inherit;">O ESP-NOW opera na mesma frequ√™ncia e canais do seu roteador WiFi.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protocolo WiFi n√£o usado</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semelhante ao protocolo de baixa energia usado em um mouse sem fio de 2,4 GHz.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Somente o emparelhamento inicial √© necess√°rio.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s o emparelhamento, a conex√£o n√£o quebra.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A transmiss√£o n√£o √© suportada - apenas v√°rias distribui√ß√µes para pares de dispositivos emparelhados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No m√°ximo 20 pares, incluindo os criptografados, s√£o suportados em um dispositivo, incluindo pares criptografados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No m√°ximo 10 pares criptografados s√£o suportados no modo Esta√ß√£o.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√°ximo 6 no modo SoftAP ou SoftAP + Station.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A criptografia multicast n√£o √© suportada.</font></font></li>
</ul><br>
<u><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seguran√ßa</font></font></h2></u><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O ESP-NOW adota a tecnologia de quadro IEEE802.11 Action Vendor com a fun√ß√£o IE desenvolvida pela tecnologia de criptografia Espressif e CCMP, fornecendo uma solu√ß√£o de comunica√ß√£o segura e sem conex√£o. </font><font style="vertical-align: inherit;">Um dispositivo Wi-Fi suporta uma chave mestra principal (PMK) e v√°rias chaves mestras locais (LMK)</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O PMK √©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usado para criptografar o LMK usando o algoritmo AES-128.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dispositivo emparelhado com </font><b><font style="vertical-align: inherit;">LMK</font></b><font style="vertical-align: inherit;"> √© usado para criptografar informa√ß√µes do usu√°rio usando o CCMP. </font><font style="vertical-align: inherit;">O n√∫mero m√°ximo de LMKs diferentes √© 6. Se nenhum LMK estiver definido para o dispositivo emparelhado, os dados do usu√°rio n√£o ser√£o criptografados.</font></font></li>
</ul><br>
<u><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um n√≠vel b√°sico de</font></font></h2></u><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No n√≠vel inferior do protocolo ESP_NOW, √© mantida uma lista vinculada contendo informa√ß√µes sobre o dispositivo local e o dispositivo emparelhado, incluindo endere√ßos e chaves MAC. </font><font style="vertical-align: inherit;">O ESP-NOW tamb√©m armazena dados freq√ºentemente usados ‚Äã‚Äãpara a camada de aplicativo para evitar a sobrecarga de reprocessar a lista vinculada. </font><font style="vertical-align: inherit;">As informa√ß√µes sobre dispositivos s√£o usadas para enviar e receber dados e incluem </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">informa√ß√µes sobre o dispositivo local:</font></font></u> <br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PMK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 16 bytes - a chave principal principal usada para criptografar a chave no dispositivo conectado (KOK na API) ESP_NOW suporta PMK por padr√£o, portanto, nenhuma configura√ß√£o √© necess√°ria. </font><font style="vertical-align: inherit;">Se necess√°rio, voc√™ pode verificar se o valor PMK corresponde ao dispositivo local.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 1 byte - o modo do dispositivo local que define a interface WiFi de transmiss√£o (SoftAP ou STA) ESP-NOW. </font><font style="vertical-align: inherit;">O modo de dispositivo emparelhado n√£o afeta nenhuma fun√ß√£o, mas salva apenas as informa√ß√µes do modo para a camada de aplicativo. </font><font style="vertical-align: inherit;">No modo STA WiFi, apenas a Esta√ß√£o √© aplic√°vel e o SoftAP WiFi √© apenas o SoftAP.</font></font><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modos de opera√ß√£o do dispositivo local ESP_NOW</font></font></b>
                        <div class="spoiler_text"><blockquote><div class="scrollable-table"><table>
<tbody><tr>
<th></th>
<th></th>
<th> WiFi</th>
</tr>
<tr>
<td><b>IDLE</b></td>
<td> </td>
<td>   </td>
</tr>
<tr>
<td><b>CONTROLLER</b></td>
<td></td>
<td>STA</td>
</tr>
<tr>
<td><b>SLAVE</b></td>
<td></td>
<td>SoftAP‚Ä®</td>
</tr>
<tr>
<td><b>COMBO</b></td>
<td>&amp;</td>
<td>SoftAP</td>
</tr>
</tbody></table></div></blockquote><br>
</div>
                    </div></li>
</ul><br>
<u><font style="vertical-align: inherit;"></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Informa√ß√µes do </font><u><font style="vertical-align: inherit;">dispositivo emparelhado</font></u><font style="vertical-align: inherit;"> (incluindo informa√ß√µes usadas com frequ√™ncia e outras informa√ß√µes do usu√°rio):</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LMK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 16 bytes - uma chave principal local usada para criptografar a chave de informa√ß√µes √∫teis durante a comunica√ß√£o neste par.</font></font></li>
<li><b>MAC-</b>: 6  ‚Äî   ,    . ,     Station, MAC-     Station.</li>
<li><b></b>: 1  ‚Äî       (SoftAP  STA) ESP-NOW.</li>
<li><b></b>: 1  ‚Äî ,     ,   .   0..255.       ,         .    . , 0 ,    ; 1 ~ 14   ;       ,    .</li>
</ul><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Espressif</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o recomenda o uso de opera√ß√µes demoradas nas fun√ß√µes de retorno de chamada ao enviar / enviar pacotes, o que provavelmente est√° relacionado √† implementa√ß√£o de algoritmos usando o mecanismo de interrup√ß√£o. </font><font style="vertical-align: inherit;">Essa suposi√ß√£o tamb√©m √© suportada pelos problemas associados √† aloca√ß√£o din√¢mica de mem√≥ria nas fun√ß√µes de retorno de chamada, resolvidas pelo uso preferencial de vari√°veis ‚Äã‚Äãest√°ticas, bem como pela ambiguidade de usar o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mecanismo de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exce√ß√£o </font><i><font style="vertical-align: inherit;">MicroPython</font></i><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A implementa√ß√£o da assincronia dos processos de in√≠cio / fim, emparelhamento, recebimento / transmiss√£o de pacotes </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espressif</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n√£o </font><font style="vertical-align: inherit;">√© </font><font style="vertical-align: inherit;">descrita, o que tamb√©m n√£o facilita a aplica√ß√£o da ideologia </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ass√≠ncrona</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MicroPython</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formato do pacote ESP-NOW</font></font></h4><br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cabe√ßalho MAC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 24 bytes.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Categoria</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 1 byte indicando a categoria do criador do pacote. </font><font style="vertical-align: inherit;">O valor est√° definido (127).</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID da organiza√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 3 bytes, cont√©m um identificador exclusivo, que √© os tr√™s primeiros bytes do endere√ßo MAC usado pelo Espressif. </font><font style="vertical-align: inherit;">Definir valor (0x18fe34)</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Valor aleat√≥rio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 4 bytes, usado para proteger os dados.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dados do criador do pacote</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 7-255Bytes</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dados do criador do pacote cont√™m os seguintes campos:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 1 byte, defina como (221).</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comprimento</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 1 byte, comprimento total do ID da organiza√ß√£o, tipo, vers√£o e dados do usu√°rio.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID da organiza√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 3 bytes, cont√©m um identificador exclusivo, que √© os tr√™s primeiros bytes do endere√ßo MAC usado pelo Espressif. </font><font style="vertical-align: inherit;">Definir valor (0x18fe34)</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 1 byte, protocolo ESP-NOW. </font><font style="vertical-align: inherit;">Valor ajustado (4)</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vers√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 1 byte, vers√£o atual do ESP-NOW. </font><font style="vertical-align: inherit;">Instalado (1)</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conte√∫do</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 0-250 bytes de dados do usu√°rio.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FCS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 4 bytes, soma de verifica√ß√£o</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como o ESP-NOW n√£o usa WiFi, o cabe√ßalho MAC √© um pouco diferente do cabe√ßalho do pacote padr√£o. </font><font style="vertical-align: inherit;">Os bits FromDS e ToDS do campo FrameControl s√£o 0. O endere√ßo de destino √© especificado no primeiro campo de endere√ßo. </font><font style="vertical-align: inherit;">O segundo campo de endere√ßo mostra o endere√ßo de origem. </font><font style="vertical-align: inherit;">O terceiro campo de endere√ßo √© definido como o endere√ßo de broadcast (0xff: 0xff: 0xff: 0xff: 0xff: 0xff).</font></font><br>
<br>
<u><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algoritmo b√°sico de aplica√ß√£o</font></font></h2></u><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In√≠cio e fim</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de usar o ESP-NOW, √© recomend√°vel que voc√™ defina a interface Wi-Fi no modo desejado. </font><font style="vertical-align: inherit;">Normalmente, a interface Station √© definida para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CONTROLLER</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a interface SoftAP para </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SLAVE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COMBO</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tamb√©m √© aconselh√°vel interromper o Wi-Fi depois de usar o ESP-NOW. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para iniciar o ESP-NOW, chame </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_init ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_deinit ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para concluir. </font><font style="vertical-align: inherit;">Quando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_deinit ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© chamado </font><font style="vertical-align: inherit;">, todas as informa√ß√µes sobre dispositivos emparelhados s√£o exclu√≠das.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fun√ß√µes de retorno de chamada vinculativas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o de processamento de chamadas ao enviar o pacote </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_register_send_cb ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser usada para informar o n√≠vel do aplicativo da parte remetente em um par sobre o sucesso ou falha da transmiss√£o, por exemplo, se as informa√ß√µes na subcamada MAC forem transmitidas com √™xito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao usar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_register_send_cb ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , considere o seguinte: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em um par vinculado:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a camada de aplicativo n√£o recebeu o pacote, mas a fun√ß√£o de retorno de chamada retornou "sucesso", o motivo pode ser: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - ataques de um dispositivo fraudulento </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - erros de instala√ß√£o de chave criptografada </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - perda de pacote no n√≠vel do aplicativo Espressif</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a camada de aplica√ß√£o recebeu o pacote, mas a fun√ß√£o de retorno de chamada retorna um erro, a causa pode ser: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - O canal est√° ocupado e o ACK n√£o √© recebido.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com v√°rias comunica√ß√µes com todos os pares do dispositivo local:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o retorno de chamada retornar "sucesso", significa que o pacote foi enviado com sucesso.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a fun√ß√£o de retorno de chamada retornar um erro, significa que o pacote n√£o foi enviado com sucesso.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o de processamento de chamadas ap√≥s o recebimento do pacote </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_register_receive_cb ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retorna informa√ß√µes, incluindo o endere√ßo MAC do dispositivo remetente em um par e informa√ß√µes √∫teis. </font><font style="vertical-align: inherit;">Tamb√©m pode ser usado para informar a camada de aplica√ß√£o do dispositivo de envio emparelhado com o receptor que o pacote foi recebido com sucesso.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicionando um par de dispositivos emparelhados</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de enviar dados, voc√™ deve adicionar o dispositivo √† lista de pares de dispositivos emparelhados chamando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_add_peer ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Antes de enviar dados para um grupo de pares estabelecidos, voc√™ deve adicionar um dispositivo com um endere√ßo MAC multicast. </font><font style="vertical-align: inherit;">O intervalo de canais de dispositivos emparelhados √© de 0 a 14. Se o canal estiver definido como 0, os dados ser√£o enviados no canal atual. </font><font style="vertical-align: inherit;">Caso contr√°rio, o canal deve ser definido como o canal no qual o dispositivo local est√° localizado.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seguran√ßa</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se a chave precisar ser criptografada, voc√™ pode chamar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_set_pmk ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para configur√°-la </font><font style="vertical-align: inherit;">para definir o PMK. </font><font style="vertical-align: inherit;">Se o PMK n√£o estiver instalado, o PMK ser√° usado por padr√£o e selecione a mesma chave para todos os dispositivos. </font><font style="vertical-align: inherit;">Defina tamb√©m o LMK para os pares selecionados.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviando dados com pacotes ESP-NOW</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_send ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para enviar dados do ESP-NOW </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ao mesmo tempo, a fun√ß√£o definida anteriormente em </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_register_send_cb ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornar√° </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP_NOW_SEND_SUCCESS</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ao enviar uma fun√ß√£o de retorno de chamada se os dados foram recebidos com √™xito no n√≠vel MAC. </font><font style="vertical-align: inherit;">Caso contr√°rio, o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ESP_NOW_SEND_FAIL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> retornar√° </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">V√°rios motivos podem fazer com que o ESP-NOW n√£o consiga enviar dados. </font><font style="vertical-align: inherit;">Em particular,</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dispositivo de destino n√£o existe;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">os canais do dispositivo n√£o coincidem;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">os dados s√£o perdidos durante a transmiss√£o.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o √© garantido que a camada de aplica√ß√£o aceite necessariamente dados. Se necess√°rio, voc√™ pode enviar uma confirma√ß√£o ao receber dados do ESP-NOW. Se ocorrer um tempo limite de confirma√ß√£o, a transmiss√£o de dados ESP-NOW deve ser repetida. Um n√∫mero de sequ√™ncia tamb√©m pode ser atribu√≠do aos dados do ESP-NOW para remover dados duplicados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao enviar dados do ESP-NOW via </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esp_now_send (),</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> observe que n√£o √© poss√≠vel enviar mais de 250 bytes de informa√ß√µes por vez.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ATEN√á√ÉO! Um intervalo muito curto entre o envio de dois pacotes ESP-NOW pode levar a erros na execu√ß√£o da fun√ß√£o de retorno de chamada; portanto, √© recomend√°vel enviar o pr√≥ximo pacote de dados ESP-NOW ap√≥s a fun√ß√£o de retorno de chamada concluir com √™xito o processamento do envio anterior. A fun√ß√£o de retorno de chamada √© enviada a partir de uma tarefa Wi-Fi de alta prioridade. Portanto, n√£o √© recomend√°vel executar opera√ß√µes longas na fun√ß√£o de retorno de chamada. Em vez disso, voc√™ pode colocar os dados necess√°rios em uma fila est√°tica e process√°-los a partir de um processo com prioridade mais baixa.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se a fun√ß√£o de envio retornar um endere√ßo MAC, ela ser√° enviada para o dispositivo com este endere√ßo MAC. </font><font style="vertical-align: inherit;">Se a fun√ß√£o de envio retornar NULL, o pacote ser√° enviado a todos os dispositivos conectados ao dispositivo de envio, o que pode levar √† falha ou atraso na transmiss√£o devido ao congestionamento da rede.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receber dados ESP-NOW</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A fun√ß√£o de retorno de chamada tamb√©m inicia em uma tarefa de Wi-Fi. </font><font style="vertical-align: inherit;">Portanto, n√£o √© recomend√°vel executar opera√ß√µes longas na fun√ß√£o de retorno de chamada. </font><font style="vertical-align: inherit;">Em vez disso, voc√™ pode colocar os dados necess√°rios em uma fila est√°tica e process√°-los com um processo de prioridade mais baixa.</font></font><br>
<br>
<u><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em conclus√£o, o que precede</font></font></h2></u><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Minha experi√™ncia na cria√ß√£o do </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espressif IDE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MicroPython</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com ESP-NOW, descrevendo os erros que encontrei durante a montagem </font><font style="vertical-align: inherit;">e </font><i><font style="vertical-align: inherit;">corrigindo</font></i><font style="vertical-align: inherit;"> -os depois de obter um resultado est√°vel. Depois, fa√ßo uma descri√ß√£o da biblioteca ESP-NOW no MicroPython com os erros detectados e maneiras de resolv√™-los. Infelizmente, devido ao fato de o c√≥digo fonte do ESP-NOW ser fechado e distribu√≠do apenas em formato bin√°rio, o entendimento dos algoritmos do protocolo ESP-NOW √© emp√≠rico e existem v√°rios problemas que j√° foram identificados, para os quais nem sempre h√° op√ß√µes para super√°-los logicamente, mas em geral o ESP -NOW foi aplicado com sucesso na comunidade de usu√°rios C e Pythonists com base em mais de 300 aplicativos apresentados no GitHub. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descri√ß√£o da biblioteca ESP-NOW C da </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espressif</font></font></i></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descri√ß√£o e fontes abertas do </font><i><font style="vertical-align: inherit;">MicroPython</font></i><font style="vertical-align: inherit;"> ESP-NOW</font></font><i><font style="vertical-align: inherit;"></font></i></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt502248/index.html">Um novo GOST para recursos digitais entrou em vigor: todas as plataformas devem estar acess√≠veis para pessoas com defici√™ncia</a></li>
<li><a href="../pt502250/index.html">Avia√ß√£o Civil Hoje: Aspectos Importantes e Desafios do Treinamento</a></li>
<li><a href="../pt502252/index.html">Controle remoto e drones</a></li>
<li><a href="../pt502254/index.html">PostgreSQL: Programa√ß√£o do lado do servidor na linguagem humana (PL / Perl, PL / Python, PL / v8)</a></li>
<li><a href="../pt502256/index.html">Como visualizar um gr√°fico de integra√ß√£o de primavera usando o Neo4j?</a></li>
<li><a href="../pt502262/index.html">Por que AIOps e monitoramento abrangente para o banco ou sobre o que s√£o constru√≠das as rela√ß√µes com os clientes</a></li>
<li><a href="../pt502264/index.html">Infraestrutura de chave p√∫blica. Emiss√£o de certificados em condi√ß√µes de auto-isolamento</a></li>
<li><a href="../pt502266/index.html">Aurora na plataforma Intel. Amanhecer da Era Exaflops</a></li>
<li><a href="../pt502268/index.html">HackTheBox. Patentes de passagem. XXE via DOCX, LFI para RCE, GIT e arquivos de cadeia ROP</a></li>
<li><a href="../pt502272/index.html">N√£o diga "eu me sinto", e outras regras em ingl√™s que causam estupor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>