<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßö ‚óªÔ∏è üë®üèæ‚Äçüíª Un aper√ßu de la fiabilit√© des services Facebook üôÜüèΩ üë®üèæ‚Äçüî¨ üë©üèø‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lorsque Facebook ¬´ment¬ª, les gens pensent que c'est √† cause des pirates ou des attaques DDoS, mais ce n'est pas le cas. Toutes les ¬´chutes¬ª au cours d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Un aper√ßu de la fiabilit√© des services Facebook</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/489204/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lorsque Facebook ¬´ment¬ª, les gens pensent que c'est √† cause des pirates ou des attaques DDoS, mais ce n'est pas le cas. Toutes les ¬´chutes¬ª au cours des derni√®res ann√©es ont √©t√© caus√©es par des changements ou des pannes internes. Afin d'enseigner aux nouveaux employ√©s √† ne pas casser Facebook avec des exemples, tous les incidents majeurs re√ßoivent des noms, par exemple, ¬´Appelez les flics¬ª ou ¬´CAPSLOCK¬ª. Le premier a √©t√© nomm√© parce qu'un jour o√π le r√©seau social est tomb√©, les utilisateurs ont appel√© la police de Los Angeles et ont demand√© √† le r√©parer, et le sh√©rif d√©sesp√©r√© sur Twitter a demand√© de ne pas les d√©ranger √† ce sujet. Lors du deuxi√®me incident sur les machines de cache, l'interface r√©seau est tomb√©e en panne et n'a pas augment√©, et toutes les machines ont red√©marr√© √† la main. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elina Lobanova</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">travaille sur Facebook depuis 4 ans au sein de l'√©quipe Web Foundation. Les membres de l'√©quipe sont appel√©s ing√©nieurs de production et surveillent la fiabilit√© et les performances de l'ensemble du backend, √©teignent Facebook lorsqu'il est allum√©, √©crivent la surveillance et l'automatisation pour leur faciliter la vie et celle des autres. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jf/9x/nj/jf9xnjbzmqg3ufk-km_bqmgkrya.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans un article bas√© sur le rapport d'Elina sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HighLoad ++ 2019</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">montrerons</font></a><font style="vertical-align: inherit;"> comment les ing√©nieurs de production surveillent le backend Facebook, quels outils ils utilisent, qui provoquent des plantages majeurs et comment y faire face.</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/wuV5DLiUuaI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je m'appelle Elina, il y a presque 5 ans, j'ai √©t√© appel√©e sur Facebook en tant que d√©veloppeur ordinaire, o√π j'ai rencontr√© pour la premi√®re fois des syst√®mes tr√®s charg√©s - ce n'est pas enseign√© dans les instituts. </font><font style="vertical-align: inherit;">L'entreprise n'engage pas une √©quipe, mais un bureau, donc je suis arriv√© √† Londres, j'ai choisi une √©quipe qui surveille le travail de facebook.com et faisait partie des ing√©nieurs de production.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ing√©nieurs de production</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, je vais vous dire ce que nous faisons et pourquoi nous sommes appel√©s ing√©nieurs de production, et non SRE comme Google, par exemple.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2009. SRE</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le mod√®le standard qui est encore utilis√© dans de nombreuses entreprises est "d√©veloppeurs - testeurs - exploitation". </font><font style="vertical-align: inherit;">Ils sont souvent divis√©s: ils sont assis √† diff√©rents √©tages, parfois m√™me dans diff√©rents pays, et ne communiquent pas entre eux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2009, Facebook avait d√©j√† SRE. </font><font style="vertical-align: inherit;">Chez Google, SRE a commenc√© plus t√¥t, ils savent comment r√©aliser DevOps et l'ont √©crit dans leur livre ¬´ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Site Reliability Engineering</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6h/o6/1l/6ho61luejwigg_bb6v_7441tlty.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur Facebook en 2009, il n'y avait rien de tel. </font><font style="vertical-align: inherit;">Nous nous appelions SRE, mais nous avons fait le m√™me travail que les Ops dans le reste du monde: travail manuel, pas d'automatisation, d√©ploiement de tous les services avec vos mains, surveillance en quelque sorte, oncall pour tout, un ensemble de scripts shell.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2010. SRO et AppOps</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela n'a pas √©volu√©, car le nombre d'utilisateurs √† cette √©poque augmentait 3 fois par an, et le nombre de services a augment√© en cons√©quence. </font><font style="vertical-align: inherit;">En 2010, la d√©cision volontariste d'Ops a √©t√© divis√©e en deux groupes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le premier groupe est </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SRO</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o√π ¬´O¬ª est ¬´op√©rations¬ª, engag√© dans le d√©veloppement, l'automatisation et la surveillance du site. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxi√®me groupe est </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AppOps</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ils ont √©t√© int√©gr√©s en √©quipes, chacune pour de grands services. </font><font style="vertical-align: inherit;">AppOps est d√©j√† proche de l'id√©e de DevOps. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La s√©paration pendant un certain temps a sauv√© tout le monde.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2012. Ing√©nieurs de production</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En 2012, AppOps a simplement renomm√© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les ing√©nieurs de production</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En plus du nom, rien n'a chang√©, mais il est devenu plus confortable. </font><font style="vertical-align: inherit;">Comme vous appelez un yacht, il naviguera et nous ne voulions pas naviguer comme Ops. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les OAR existaient toujours, Facebook se d√©veloppait et surveiller tous les services √† la fois √©tait difficile. </font><font style="vertical-align: inherit;">Une personne qui √©tait sur appel n'a m√™me pas √©t√© autoris√©e √† aller aux toilettes: il a demand√© √† quelqu'un de le remplacer, car il br√ªlait constamment.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2014. Cl√¥ture des OAR</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä un moment donn√©, les autorit√©s ont transf√©r√© tout le monde en appel. </font><font style="vertical-align: inherit;">¬´Tout le monde¬ª signifie aussi les d√©veloppeurs: √©crivez votre code, vous y √™tes et r√©pondez pour ce code! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les ing√©nieurs de production ont d√©j√† √©t√© int√©gr√©s dans les √©quipes les plus importantes pour obtenir de l'aide, et les autres n'ont pas de chance. </font><font style="vertical-align: inherit;">Nous avons commenc√© avec de grandes √©quipes et en quelques ann√©es, nous avons transf√©r√© tout le monde sur Facebook vers oncall. </font><font style="vertical-align: inherit;">Parmi les d√©veloppeurs, il y avait une grande excitation: quelqu'un a d√©missionn√©, quelqu'un a √©crit de mauvais articles. </font><font style="vertical-align: inherit;">Mais tout s'est calm√© et en 2014, le SRO a √©t√© ferm√© car il n'√©tait plus n√©cessaire. </font><font style="vertical-align: inherit;">Nous vivons donc √† ce jour. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le mot ¬´SRE¬ª dans l'entreprise est notoire, mais nous ressemblons √† SRE sur Google. </font><font style="vertical-align: inherit;">Il y a des diff√©rences.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous sommes </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toujours int√©gr√©s dans des √©quipes. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous n'avons pas de recherche SRE en g√©n√©ral, comme dans Google, c'est pour chaque service de recherche s√©par√©ment.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne sommes pas dans les produits</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , seulement dans l'infrastructure que le produit g√®re lui-m√™me.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous sommes en </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contact</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec les d√©veloppeurs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons un peu plus d'exp√©rience dans les syst√®mes et les r√©seaux, nous nous </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">concentrons donc sur la surveillance</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et l'extinction des services lorsqu'ils br√ªlent fortement. </font><font style="vertical-align: inherit;">Nous corrigeons √† l'avance les erreurs qui pourraient entra√Æner des plantages et influencer l'architecture des nouveaux services d√®s le d√©but, afin qu'ils fonctionnent plus tard en douceur.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">surveillance</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est le plus important. </font><font style="vertical-align: inherit;">Comment faisons-nous cela? </font><font style="vertical-align: inherit;">Comme tout le monde: sans magie noire, dans leur propre maison. </font><font style="vertical-align: inherit;">Mais le diable, comme d'habitude, vous en parlera en d√©tail.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UN HAUT</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par le bas. Tout le monde conna√Æt TOP sous Linux, et nous utilisons ATOP, o√π ¬´A¬ª est ¬´avanc√©¬ª - un moniteur de performances syst√®me. Le principal avantage d'ATOP est qu'il stocke l'historique: vous pouvez le configurer pour enregistrer des instantan√©s sur le disque. Notre ATOP fonctionne sur toutes les machines toutes les 5 secondes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici un exemple de serveur ex√©cutant le backend PHP pour facebook.com. Nous avons √©crit notre machine virtuelle pour ex√©cuter du code PHP, elle s'appelle </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HHVM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (HipHop Virtual Machine). Selon les m√©triques export√©es, nous avons constat√© que plusieurs machines ne traitaient pas presque une seule demande en une minute. Voyons pourquoi, ouvrez ATOP 30 secondes avant qu'il ne se bloque.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p2/vt/wf/p2vtwfqsucdo-shyennmf64opy8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On peut voir qu'avec les probl√®mes de processeur, on le charge trop. </font><font style="vertical-align: inherit;">Il y a aussi des probl√®mes de m√©moire, il ne reste que 1,5 Go dans le cache et apr√®s 5 secondes, seulement 800 Mo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dz/q-/_x/dzq-_x7xjizrcgynj3gdayuh8u0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s encore 5 secondes, le CPU est lib√©r√©, rien n'est ex√©cut√©. </font><font style="vertical-align: inherit;">ATOP dit regardez la ligne du bas, nous √©crivons sur le disque, mais quoi? </font><font style="vertical-align: inherit;">Il s'av√®re que nous √©crivons swap. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4z/-j/v1/4z-jv12mgthgjnezqlvbznu6ync.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qui fait √ßa? </font><font style="vertical-align: inherit;">Processus extraits de la m√©moire 0,5 Go et mis en swap. </font><font style="vertical-align: inherit;">√Ä leur place, deux processus Python suspects sont apparus, qui peuvent ensuite √™tre consid√©r√©s comme une ligne de commande.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8y/ej/uk/8yejuk2y3eeswlw7astqbiaaste.jpeg"><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ATOP est magnifique, nous l'utilisons constamment.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si vous ne l'avez pas, je vous recommande fortement de l'utiliser. </font><font style="vertical-align: inherit;">N'ayez pas peur pour le lecteur, ATOP ne mange que 200-300 Mo par jour toutes les 5 secondes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Malloc HTTP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aux Bahamas et aux grands incidents, nous donnons des noms. Il y a un bug amusant li√© √† ATOP appel√© Malloc HTTP. Nous l'avons fait ses d√©buts avec ATOP et strace. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons Thrift partout comme RPC. Dans les premi√®res versions de son analyseur, il y avait un bug incroyable qui fonctionnait comme ceci: un message est arriv√© dans lequel les 4 premiers octets sont la taille des donn√©es, puis les donn√©es elles-m√™mes et les premiers octets sont ajout√©s au message suivant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais une fois que l' </font><font style="vertical-align: inherit;">un des programmes plut√¥t que d'aller au service de Thrift, je suis all√© √† HTTP, et a </font><font style="vertical-align: inherit;">re√ßu une r√©ponse ¬´HTTP Bad la demande¬ª: </font></font><code>HTTP/1.1 400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir pris HTTP et allou√© en utilisant malloc HTTP le nombre d'octets.</font></font><br>
<br>
<pre><code class="bash hljs">Thrift message<font></font>
HTTP/1.1 400<font></font>
<span class="hljs-string">"HTTP"</span> == 0x48545450</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est bon, nous avons un sur-engagement, allouons plus de m√©moire! </font><font style="vertical-align: inherit;">Nous avons allou√© avec malloc, et jusqu'√† ce que nous √©crivions et lisions l√†-bas, ils ne nous donneraient pas de m√©moire r√©elle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais ce n'√©tait pas l√†! </font><font style="vertical-align: inherit;">Si nous voulons bifurquer, le fork renverra une erreur - il n'y a pas assez de m√©moire.</font></font><br>
<br>
<pre><code class="bash hljs">malloc(<span class="hljs-string">"HTTP"</span>)<font></font>
pid = fork(); // errno = ENOMEM</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais pourquoi, y a-t-il un souvenir? </font><font style="vertical-align: inherit;">En comprenant les manuels, nous avons constat√© que tout est tr√®s simple: la configuration actuelle de sur-engagement est telle que c'est une heuristique magique, et le noyau lui-m√™me d√©cide quand beaucoup et quand non:</font></font><br>
<br>
<pre><code class="bash hljs">malloc(<span class="hljs-string">"HTTP"</span>)<font></font>
pid = fork(); // errno = ENOMEM<font></font>
<font></font>
// 0: heuristic overcommit<font></font>
vm.overcommit_memory = 0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour un processus de travail, c'est normal, vous pouvez s√©lectionner malloc jusqu'√† TB, mais pour un nouveau processus - non. </font><font style="vertical-align: inherit;">Et une partie de la surveillance chez nous √©tait li√©e au fait que le processus principal a engendr√© de petits scripts pour la collecte de donn√©es. </font><font style="vertical-align: inherit;">En cons√©quence, notre partie de surveillance est tomb√©e en panne, car nous ne pouvions plus bifurquer.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FB303</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le FB303 est notre syst√®me de surveillance de base. </font><font style="vertical-align: inherit;">Il a √©t√© nomm√© d'apr√®s le synth√©tiseur de basse standard de 1982. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/t2/x3/f4/t2x3f4of3j794hnfskzti5lk3va.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le principe est simple, il fonctionne donc toujours: chaque service impl√©mente l'interface Thrift getCounters.</font></font><br>
<br>
<pre><code class="php hljs">Service FacebookService {<font></font>
    map&lt;<span class="hljs-keyword">string</span>, i64&gt; getCounters()<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, il ne l'impl√©mente pas, car les biblioth√®ques sont d√©j√† √©crites, tout se fait dans le code </font></font><code>increment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>set</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="php hljs">incrementCounter(<span class="hljs-keyword">string</span>&amp; key);<font></font>
<font></font>
setCounter(<span class="hljs-keyword">string</span>&amp; key, int64_t value);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, chaque service exporte des compteurs sur le port qu'il enregistre aupr√®s de Service Discovery. Voici un exemple d'une machine qui g√©n√®re un fil d'actualit√©s et exporte environ 5,5 mille paires (cha√Æne, nombre): m√©moire, production, n'importe quoi. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sl/sb/fj/slsbfj9kapkaqsi3quo_do4q64a.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque machine ex√©cute un processus binaire qui passe par tous les services autour, recueille ces compteurs et les met en stockage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici √† quoi ressemble l' </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface graphique de stockage</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sh/lt/li/shltlimradfvsovwo1vp1xzudmu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tr√®s similaire √† Prom√©th√©e et Grafana, mais ce n'est pas le cas. La premi√®re entr√©e du FB303 sur GitHub a eu lieu en 2009, et Prometheus en 2012. C'est une explication de tous les ¬´bricoleurs¬ª de Facebook: nous les avons fait quand il n'y avait rien de normal en Open Source. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, il y a une recherche des noms des compteurs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vb/b3/ya/vbb3yabg-lhlypl1y7_zwf9dolw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les graphiques eux-m√™mes ressemblent √† ceci.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b7/td/lj/b7tdljhxpmw6d5rt1fpguoon3ru.jpeg"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une photo du groupe int√©rieur dans laquelle nous affichons de beaux graphismes. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une diff√©rence importante entre notre pile de surveillance et Prometheus et Grafana est que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous stockons les donn√©es pour toujours</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Notre surveillance va r√©√©chantillonner les donn√©es, et apr√®s 2 semaines, nous aurons un point pour toutes les 5 minutes, et apr√®s un an pour chaque heure. </font><font style="vertical-align: inherit;">Par cons√©quent, ils peuvent √™tre stock√©s tellement. </font><font style="vertical-align: inherit;">Automatiquement, cela n'est configur√© nulle part. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais si nous parlons des caract√©ristiques de la surveillance de Facebook, je le d√©crirais avec un mot anglais ¬´ </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">observabilit√©¬ª</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observabilit√©</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a une "bo√Æte noire", il y a une "bo√Æte blanche", et nous avons une "bo√Æte" en verre transparent. </font><font style="vertical-align: inherit;">Cela signifie que lorsque nous √©crivons du code, nous √©crivons tout ce qui est possible dans les journaux, et non de mani√®re s√©lective. </font><font style="vertical-align: inherit;">L'√©chantillonnage est bien r√©gl√© partout, donc le backend pour le stockage, les compteurs et tout le reste fonctionne bien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le m√™me temps, nous pouvons d√©j√† construire nos tableaux de bord sur des compteurs existants. </font><font style="vertical-align: inherit;">Dans le cas de l'√©tude de ces tableaux de bord, ce n'est pas le point final avec 10 graphiques, mais le premier, √† partir duquel nous allons √† notre interface utilisateur et y trouvons tout ce qui est possible.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scaphandre autonome</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est le point culminant de l'id√©e d'observabilit√©. Ceci est notre pile ELK. Le principe est le m√™me: nous √©crivons en JSON sans sch√©ma sp√©cifique, puis nous demandons sous la forme d'un </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tableau</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , d'une s√©rie chronologique de donn√©es ou de 10 options de visualisation suppl√©mentaires. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Scuba se connecte de l'ordre de centaines de gigaoctets par seconde. Tout est demand√© tr√®s rapidement, car ce n'est pas Elasticsearch, et tout est en m√©moire sur des machines puissantes. Oui, de l'argent y est d√©pens√©, mais comme c'est merveilleux! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, sous Scuba UI, une des tables les plus populaires y est ouverte, dans laquelle tous les clients de tous les services Thrift √©crivent des journaux. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dj/ah/ad/djahadigvrtru4luney67766slw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le graphique montre qu'en fin de compte, quelque chose s'est mal pass√© dans le service. Pour conna√Ætre le d√©lai, acc√©dez √† la liste des compteurs, s√©lectionnez le d√©lai, l'agr√©gation, cliquez sur "Plong√©e". </font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/c-/y8/m2c-y8pfnqyrz4hivxhxyszwvnw.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La r√©ponse vient en 2 secondes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j6/ac/kg/j6ackggq0o7xk93vejg0yfbyrhi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On peut voir qu'√† ce moment quelque chose s'est produit et que le retard a augment√© de mani√®re significative. </font><font style="vertical-align: inherit;">Pour en savoir plus, vous pouvez regrouper selon diff√©rents param√®tres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe des centaines de ces tableaux.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un tableau qui montre les versions des fichiers binaires, des packages, la quantit√© de m√©moire consomm√©e sur des millions de machines. </font><font style="vertical-align: inherit;">Sur chaque h√¥te, un PS est effectu√© une fois par heure et envoy√© √† Scuba.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tous les dmesg, tous les vidages de m√©moire, sont envoy√©s √† d'autres tables. </font><font style="vertical-align: inherit;">Nous ex√©cutons Perf toutes les 10 minutes sur chaque machine, nous savons donc quelles traces de pile nous avons sur le noyau et ce que le processeur global peut charger.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©bogage PHP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Scuba fournit √©galement un backend pour notre outil de d√©bogage PHP de base. Des milliers d'ing√©nieurs √©crivent du code PHP et, d'une mani√®re ou d'une autre, vous devez enregistrer le r√©f√©rentiel global des mauvaises choses. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment √ßa marche? PHP √©crit √©galement une trace de pile dans chaque journal. Scuba (notre Elasticsearch) ne peut tout simplement pas prendre en charge la trace de pile de tous les journaux de toutes les machines. Avant de mettre le journal dans Scuba, nous convertissons la trace de la pile en hachage, √©chantillonnons par hachage et n'enregistrons que ceux-ci. Les traces de pile elles-m√™mes sont envoy√©es √† Memcached. Ensuite, dans l'outil interne, vous pouvez extraire une trace de pile sp√©cifique de Memcached assez rapidement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ch/w_/im/chw_im8wjuue2nolmyzgcfappnq.jpeg"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visualisation avec regroupement de hachage √† partir des journaux et des traces de pile.</font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nous d√©boguons le code en utilisant la m√©thode de </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">filtrage</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ouvrez Scuba, voyez √† quoi ressemble le graphique d'erreur.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nd/op/nx/ndopnxibxeidsb8cmyy0rokasjm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On passe √† LogView, l√† les erreurs sont d√©j√† regroup√©es par traces de pile. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yx/0f/t3/yx0ft3lf_mnoskzxba7oqw3wtai.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une trace de pile est charg√©e √† partir de Memcached, et d√©j√† sur celle-ci, vous pouvez trouver diff (commit dans le r√©f√©rentiel PHP), qui a √©t√© publi√© √† peu pr√®s au m√™me moment, et la restaurer. </font><font style="vertical-align: inherit;">Tout le monde peut revenir en arri√®re et s'engager avec nous, aucune autorisation n'est n√©cessaire pour cela.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kh/eu/ck/kheuck1w2losbdhiyasysemlvnk.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tableaux de bord</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je terminerai le sujet de surveillance avec des tableaux de bord. Nous en avons peu - seulement deux pour trois indicateurs. Le tableau de bord lui-m√™me est plut√¥t inhabituel. J'aimerais parler davantage de lui. Voici un tableau de bord standard avec un ensemble de graphiques. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kh/eu/ck/kheuck1w2losbdhiyasysemlvnk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Malheureusement, ce n'est pas si simple avec lui. Le fait est que la ligne violette sur un graphique est le m√™me service auquel la ligne bleue correspond sur l'autre graphique, et un autre graphique peut √™tre en un jour et un autre en un mois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utilisons notre tableau de bord bas√© sur </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cubism</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - la biblioth√®que Open Source JS. Il a √©t√© √©crit sur Square et publi√© sous la licence Apache. Ils ont un support int√©gr√© pour Graphite et Cube. Mais il est facile √† √©tendre, ce que nous avons fait.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le tableau de bord ci-dessous montre un jour √† un pixel par minute. </font><font style="vertical-align: inherit;">Chaque ligne est une r√©gion: des centres de donn√©es √† proximit√©. </font><font style="vertical-align: inherit;">Ils affichent le nombre de journaux que le backend Facebook √©crit en octets par seconde. </font><font style="vertical-align: inherit;">Ci-dessous sont des annotations pour les √©quipes en Am√©rique pour voir ce que nous avons d√©j√† corrig√© de ce qui s'est pass√© pendant la journ√©e. </font><font style="vertical-align: inherit;">Il est facile de rechercher une corr√©lation sur cette image. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fx/3u/8f/fx3u8f42urcs2ernp8cu_gvxj6q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ci-dessous, le nombre d'erreurs 500. Ce qui √† gauche n'a pas d'importance pour les utilisateurs, et √©videmment ils n'aimaient pas la bande vert fonc√© au centre. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jy/dp/g1/jydpg1dmhrcxiirkeba3dhmtxcs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vient ensuite la latence du 99e centile. </font><font style="vertical-align: inherit;">En m√™me temps, comme dans le graphique ci-dessus, on peut voir que la latence a baiss√©. </font><font style="vertical-align: inherit;">Pour retourner une erreur, il n'est pas n√©cessaire de passer beaucoup de temps.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/og/4w/it/og4witypnhr2n091yaiwzjqctsg.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment √ßa fonctionne</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur un graphique de 120 pixels de haut, tout est visible. Mais beaucoup d'entre eux ne peuvent pas √™tre plac√©s sur un seul tableau de bord, nous allons </font></font><br>
<br>
<img src="https://habrastorage.org/webt/48/-t/-2/48-t-2gfcbcmotwnkifz2tln_9u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
donc passer </font><font style="vertical-align: inherit;">√† 30. </font><font style="vertical-align: inherit;">Malheureusement, nous obtenons alors une sorte de boa constrictor. Revenons en arri√®re et voyons ce que le cubisme en fait. Il casse le graphique en 4 parties: le plus haut, le plus sombre, puis s'effondre. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zg/s-/48/zgs-48iqemvyyyyxuh1g949aoji.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons maintenant le m√™me calendrier qu'auparavant, mais tout est clairement visible: plus le vert est sombre, pire c'est. Maintenant, ce qui se passe est beaucoup plus clair. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur la gauche, vous pouvez voir la vague au fur et √† mesure qu'elle montait, et au centre, o√π elle est vert fonc√©, tout est tr√®s mauvais. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ql/0f/xu/ql0fxubdkifq0ax-mwhbn00ndxi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le cubisme n'est qu'un d√©but. Il est n√©cessaire pour la visualisation, afin de comprendre si tout va bien maintenant ou non. Pour chaque tableau, il existe d√©j√† des tableaux de bord avec des graphiques d√©taill√©s.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_p/zx/u-/_pzxu-sbu9xc5p2gpoyrekvbybc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La surveillance en elle-m√™me aide √† comprendre l'√©tat du syst√®me et √† r√©agir en cas de panne. </font><font style="vertical-align: inherit;">Sur Facebook, chaque employ√© oncall doit pouvoir tout r√©parer. </font><font style="vertical-align: inherit;">S'il br√ªle, alors tout s'allume, mais surtout les ing√©nieurs de production avec l'exp√©rience d'un administrateur syst√®me, car ils savent comment r√©soudre le probl√®me rapidement.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quand Facebook √©tait couch√©</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parfois, des incidents se produisent et Facebook ment. Habituellement, les gens pensent que Facebook ment en raison des attaques DDoS ou des pirates informatiques, mais en 5 ans, cela ne s'est jamais produit. La raison a toujours √©t√© nos ing√©nieurs. Ils ne sont pas intentionnels: les syst√®mes sont tr√®s complexes et peuvent tomber en panne l√† o√π vous n'attendez pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous donnons des noms √† tous les incidents majeurs afin qu'il soit commode de les mentionner et d'en parler aux nouveaux venus afin de ne pas r√©p√©ter les erreurs √† l'avenir. Le champion du nom le plus dr√¥le est l'incident </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Call the Cops</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Les gens ont appel√© la police de Los Angeles et ont demand√© de r√©parer Facebook parce qu'il mentait. Le sh√©rif de Los Angeles en avait tellement marre qu'il a tweet√©: "S'il vous pla√Æt, ne nous appelez pas!" Nous n'en sommes pas responsables! ¬ª </font></font><br>
<br>
<img src="https://habrastorage.org/webt/4p/tl/nv/4ptlnvj0sppjmmmdt3zjowumd-u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mon incident pr√©f√©r√© auquel j'ai particip√© s'appelait </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CAPSLOCK.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il est int√©ressant en ce qu'il montre que tout peut arriver. Et c'est ce qui est arriv√©. Elle adresse obychnyyIP: </font></font><code>fd3b:5679:92eb:9ce4::1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Facebook utilise Chef pour personnaliser le syst√®me d'exploitation. L'inventaire des services stocke la configuration de l'h√¥te dans sa base de donn√©es et Chef re√ßoit un fichier de configuration du service. Une fois que le service a chang√© de version, il a commenc√© √† lire les adresses IP de la base de donn√©es imm√©diatement au format MySQL et √† les mettre dans un fichier. La nouvelle adresse est maintenant √©crit dans le </font><font style="vertical-align: inherit;">capital: </font></font><code>FD3B:5679:92EB:9CE4::1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Shef regarde le nouveau fichier et constate que l'adresse IP a ¬´chang√©¬ª car elle compare, non pas sous forme binaire, mais avec une cha√Æne. L'adresse IP est ¬´nouvelle¬ª, ce qui signifie que vous devez abaisser l'interface et la relever. Sur tous les millions de voitures en 15 minutes, l'interface est mont√©e et descendue.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semblerait que ce soit correct - la capacit√© a diminu√© alors que le r√©seau reposait sur certaines machines. </font><font style="vertical-align: inherit;">Mais un bug s'est soudainement ouvert dans le pilote r√©seau de nos cartes r√©seau personnalis√©es: au d√©marrage, elles n√©cessitaient 0,5 Go de m√©moire physique s√©quentielle. </font><font style="vertical-align: inherit;">Sur les machines de cache, ces 0,5 Go ont disparu pendant que nous baissions et augmentions l'interface. </font><font style="vertical-align: inherit;">Par cons√©quent, sur les machines de cache, l'interface r√©seau est tomb√©e en panne et n'a pas augment√©, et rien ne fonctionne sans caches. </font><font style="vertical-align: inherit;">Nous nous sommes assis et avons red√©marr√© ces machines avec nos mains. </font><font style="vertical-align: inherit;">C'√©tait amusant.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portail du gestionnaire d'incidents</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque Facebook ¬´br√ªle¬ª, il est n√©cessaire d'organiser le travail des ¬´pompiers¬ª et, surtout, de comprendre o√π il br√ªle, car dans une grande entreprise, il peut ¬´sentir l'odeur de br√ªl√©¬ª √† un endroit, mais le probl√®me sera √† un autre. </font><font style="vertical-align: inherit;">L'outil d'interface utilisateur appel√© </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incident Manager Portal</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nous y aide </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il a √©t√© √©crit par des ing√©nieurs de production et est ouvert √† tous. </font><font style="vertical-align: inherit;">D√®s qu'il se passe quelque chose, on y d√©clenche un incident: nom, d√©but, description.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hj/px/sm/hjpxsmys_lbno7lkm9r9osacq7o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons une personne sp√©cialement form√©e - Incident Manager On-Call (IMOC). </font><font style="vertical-align: inherit;">Ce n'est pas un poste permanent, les managers changent r√©guli√®rement. </font><font style="vertical-align: inherit;">En cas de grands incendies, IMOC organise et coordonne les personnes √† r√©parer, mais n'a pas √† les r√©parer elles-m√™mes. </font><font style="vertical-align: inherit;">D√®s qu'un incident avec un haut niveau de danger est cr√©√©, IMOC re√ßoit un SMS et commence √† aider √† tout organiser. </font><font style="vertical-align: inherit;">Dans un grand syst√®me, ces personnes ne peuvent √™tre dispens√©es.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La pr√©vention</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Facebook n'est pas si courant. </font><font style="vertical-align: inherit;">La plupart du temps, nous n'√©teignons pas et ne red√©marrons pas les machines de cache, mais nous corrigeons les bogues √† l'avance et, si possible, pour tout le monde √† la fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que nous avons trouv√© et corrig√© le ¬´probl√®me de file d'attente¬ª. </font><font style="vertical-align: inherit;">Le nombre de demandes augmente de 50%, et les erreurs de 100%, car personne ne limite la mise en ≈ìuvre √† l'avance, surtout dans les petits services. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons trouv√© un exemple de plusieurs services et d√©fini grossi√®rement un mod√®le de comportement.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sous charge normale, la demande arrive, est trait√©e et renvoy√©e au client.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec une charge √©lev√©e, les demandes sont en attente dans une file d'attente car tous les threads de traitement des demandes sont occup√©s. </font><font style="vertical-align: inherit;">Le retard augmente, mais jusqu'√† pr√©sent tout va bien.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La ligne grandit, la charge augmente. </font><font style="vertical-align: inherit;">√Ä un certain point, tout ce que le serveur ex√©cute sur le client se termine par un d√©lai de r√©ponse et le client tombe avec une erreur. </font><font style="vertical-align: inherit;">√Ä ce stade, le r√©sultat du serveur peut simplement √™tre jet√©.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/0b/c1/b1/0bc1b11xgg49wz266m-tvoximls.jpeg"><br>
<em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le d√©lai d'expiration du client est surlign√© en rouge. </font></font></em><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le client r√©p√®te encore! </font><font style="vertical-align: inherit;">Il s'av√®re que toutes les demandes que nous ex√©cutons sont jet√©es √† la poubelle et que personne n'en a plus besoin. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment r√©soudre ce probl√®me pour tout le monde √† la fois? </font><font style="vertical-align: inherit;">Introduisez une limite de d√©lai d'attente de file d'attente. </font><font style="vertical-align: inherit;">Si la demande est dans la file d'attente plus que pr√©vu, nous la jetons et ne la traitons pas sur le serveur, nous ne gaspillons pas le processeur dessus. </font><font style="vertical-align: inherit;">Nous obtenons un jeu honn√™te: nous jetons tout ce que nous ne pouvons pas traiter et tout ce que nous pouvons traiter.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La restriction a permis, tout en augmentant la charge de 50% au-dessus du maximum, de traiter encore 66% des demandes et de ne recevoir que 33% des erreurs. </font><font style="vertical-align: inherit;">Les d√©veloppeurs du framework pour Dispatch l'ont impl√©ment√© c√¥t√© serveur, et nous, les ing√©nieurs de production, avons doucement r√©gl√© le d√©lai d'expiration de 100 ms dans la file d'attente pour tout le monde. </font><font style="vertical-align: inherit;">Ainsi, tous les services ont imm√©diatement obtenu une limitation de base bon march√©.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outils</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'id√©ologie de SRE dit que si vous avez une grande flotte de voitures, un tas de services et rien √† voir avec vos mains, alors vous devez automatiser. </font><font style="vertical-align: inherit;">Par cons√©quent, la moiti√© du temps, nous √©crivons du code et cr√©ons des outils.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cubisme</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> int√©gr√© </font><font style="vertical-align: inherit;">dans le syst√®me.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le FBAR est un ¬´bourreau de travail¬ª qui vient r√©parer, donc personne ne s'inqui√®te d'une voiture cass√©e. </font><font style="vertical-align: inherit;">C'est la t√¢che principale du FBAR, mais maintenant il a encore plus de t√¢ches.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coredumper</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que nous avons √©crit avec deux coll√®gues </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il surveille les coredumps sur toutes les machines et les d√©pose au m√™me endroit avec les traces de pile avec toutes les informations sur l'h√¥te: o√π il se trouve, comment trouver quelle taille. </font><font style="vertical-align: inherit;">Mais surtout, les traces de pile sont gratuites, sans d√©marrer GDB √† l'aide des programmes BPF.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les sondages</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La derni√®re chose que nous faisons est de parler aux gens, de les interviewer. </font><font style="vertical-align: inherit;">Il nous semble que c'est tr√®s important. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un sondage utile concerne la fiabilit√©. </font><font style="vertical-align: inherit;">Nous posons des questions sur les services d√©j√† en cours d'ex√©cution dans les citations cl√©s de notre questionnaire:</font></font><br>
<blockquote><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"La principale responsabilit√© du logiciel syst√®me doit √™tre de continuer √† fonctionner. </font><font style="vertical-align: inherit;">La prestation de services doit √™tre consid√©r√©e comme un effet secondaire b√©n√©fique d'une exploitation continue ¬ª</font></font></em></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela signifie que le principal devoir du syst√®me est de continuer √† fonctionner, et le fait qu'il fournit une sorte de service est un bonus suppl√©mentaire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les enqu√™tes ne concernent que les services moyens, les grands eux-m√™mes le comprennent. </font><font style="vertical-align: inherit;">Nous donnons un questionnaire dans lequel nous posons des questions de base sur l'architecture, SLO, les tests, par exemple.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Que se passe-t-il si votre syst√®me re√ßoit 10% de la charge?" </font><font style="vertical-align: inherit;">Quand les gens pensent: "Mais vraiment, quoi?" </font><font style="vertical-align: inherit;">- des id√©es apparaissent et beaucoup gouvernent m√™me leurs syst√®mes. </font><font style="vertical-align: inherit;">Auparavant, ils n'y pensaient pas, mais apr√®s la question, il y a une raison.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Qui est le premier √† remarquer g√©n√©ralement des probl√®mes avec votre service - vous ou vos utilisateurs?" </font><font style="vertical-align: inherit;">Les d√©veloppeurs commencent √† se rappeler quand cela s'est produit et: "... Vous devez peut-√™tre ajouter des alertes."</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Quelle est votre plus grande douleur d'appel?" </font><font style="vertical-align: inherit;">Ceci est inhabituel pour les d√©veloppeurs, en particulier pour les nouveaux. </font><font style="vertical-align: inherit;">Ils disent imm√©diatement: ¬´Nous avons de nombreuses alertes! </font><font style="vertical-align: inherit;">Nettoyons-les et enlevons ceux qui ne sont pas le cas. ¬ª</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Quelle est la fr√©quence de vos sorties?" </font><font style="vertical-align: inherit;">D'abord, ils se souviennent qu'ils le lib√®rent avec leurs mains, puis ils ont leur propre d√©ploiement personnalis√©.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il n'y a pas de codage dans le questionnaire, il est standardis√© et change tous les six mois. </font><font style="vertical-align: inherit;">Il s'agit d'un document de deux pages que nous aidons √† remplir en 2-3 semaines. </font><font style="vertical-align: inherit;">Et puis nous organisons un rallye de deux heures et trouvons des solutions √† de nombreuses douleurs. </font><font style="vertical-align: inherit;">Cet outil simple fonctionne bien avec nous et peut vous aider.</font></font><br>
<br>
<blockquote>6-7         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Saint HighLoad++</a>,          .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>   (,   ,  ). <br>
   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">telegram-</a>  .   !</blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr489192/index.html">Smart Engines est entr√© dans le top 3 du classement FWCI parmi les organisations de base de FizTech</a></li>
<li><a href="../fr489194/index.html">Comment OpenShift modifie la structure organisationnelle d'une organisation informatique. L'√©volution des mod√®les organisationnels lors du passage au PaaS</a></li>
<li><a href="../fr489196/index.html">Magic Smoke: microcontr√¥leurs vs r√©gulateurs lin√©aires</a></li>
<li><a href="../fr489198/index.html">Comment ne pas se tirer une balle dans le pied avec Liquibase</a></li>
<li><a href="../fr489200/index.html">Ce que les startups recherchent Y Combinator en 2020</a></li>
<li><a href="../fr489210/index.html">Test de performance du code Linux avec des exemples</a></li>
<li><a href="../fr489212/index.html">1C-Bitrix emp√™che la d√©sinscription √† la newsletter par l'obligation de soumettre leurs donn√©es personnelles</a></li>
<li><a href="../fr489214/index.html">Approche moderne pour tester la localisation sur iOS</a></li>
<li><a href="../fr489218/index.html">C'est na√Øf. Super: code et architecture d'un jeu simple</a></li>
<li><a href="../fr489226/index.html">M√©thodes d'optimisation des requ√™tes LINQ en C # .NET</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>