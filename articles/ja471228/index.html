<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👢 🌡️ 🤖 Grokay PyTorch 🆒 🤾🏼 ⛔️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！
 
 プレオーダーでは、待望のPyTorchライブラリーの本が登場しました。
 
 
 
 この本からPyTorchに必要なすべての基本的な資料を学習するので、学習したいトピックの「グロッキング」または「詳細な理解」と呼ばれるプロセスの利点 を思い出します。今日の投稿では、カイ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Grokay PyTorch</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/471228/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プレオーダーでは、待望</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のPyTorchライブラリーの本が登場しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/am/vl/btamvlvzqw01qwk-_2mq08t-sh4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この本からPyTorchに必要なすべての基本的な資料</font><font style="vertical-align: inherit;">を学習するので、学習したいトピックの「グロッキング」または「詳細な理解」と呼ばれる</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">プロセス</font></a><font style="vertical-align: inherit;">の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">利点</font></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を思い出します</font><font style="vertical-align: inherit;">。今日の投稿では、カイアルルクマランがPyTorchを非難した方法を説明します（写真なし）。猫へようこそ。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyTorch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、動的ニューラルネットワーク（つまり、命令</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">やループ</font><font style="vertical-align: inherit;">などの動的フロー制御を使用するネットワーク）を使用してオブジェクトを自動的に区別する柔軟なディープラーニングフレームワークです</font></font><code>while</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 PyTorchは、GPUアクセラレーション、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分散トレーニング</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、さまざまなタイプの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、その他多くの優れた機能をサポートしています。ここでは、私の意見では、PyTorchをどのように使用すべきかについていくつかの考えを示しました。ライブラリのすべての側面と推奨される方法についてはここでは取り上げませんが、このテキストが役立つことを願っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ニューラルネットワークは、計算グラフのサブクラスです。コンピューティンググラフはデータを入力として受け取り、このデータは処理されるノードでルーティングされます（変換できます）。深層学習では、ニューロン（ノード）は通常、パラメーターと微分可能な関数を適用してデータを変換するため、勾配降下法によるパラメーターを最適化して損失を最小限に抑えることができます。広い意味では、関数は確率的であり、グラフは動的である可能性があることに注意します。したがって、ニューラルネットワークパラダイムは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログラミングデータストリーム</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（データフロープログラミング）に</font><font style="vertical-align: inherit;">よく適合し</font><font style="vertical-align: inherit;">ますが、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">命令型プログラミング</font></a><font style="vertical-align: inherit;">へのAPI PyTorch指向のパラダイム</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、そして作成されたプログラムを解釈するこの方法ははるかによく知られています。そのため、PyTorchコードは読みやすく、複雑なプログラムの設計を判断するのも簡単ですが、パフォーマンスに深刻な妥協は必要ありません。実際、PyTorchは十分に高速であり、エンドユーザーとしてはまったく心配することができない多くの最適化を提供します。 （しかし、あなたが本当にそれらに興味があるなら、少し深く掘り下げてそれらを知ることができます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事の残りの部分は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、MNISTデータセットの公式例の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析です</font><font style="vertical-align: inherit;">。ここでは</font><font style="vertical-align: inherit;">PyTorch </font><font style="vertical-align: inherit;">を</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プレイしている</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ので、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">公式の初心者向けマニュアル</font></a><font style="vertical-align: inherit;">をよく理解してから記事を理解することをお勧めします</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">便宜上、コードはコメント付きの小さなフラグメントの形式で表示されます。つまり、純粋なモジュラーコードで見慣れている別の関数/ファイルにコードが配布されることはありません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">輸入</font></font></h4><br>
<pre><code class="plaintext hljs">import argparse<font></font>
import os<font></font>
import torch<font></font>
from torch import nn, optim<font></font>
from torch.nn import functional as F<font></font>
from torch.utils.data import DataLoader<font></font>
from torchvision import datasets, transforms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらはすべて非常に標準的なインポートですが、</font></font><code>torchvision</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンピュータービジョンに関連するタスクを解決するために特にアクティブに使用される</font><font style="vertical-align: inherit;">モジュールは例外です</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスタマイズ</font></font></h4><br>
<pre><code class="python hljs">parser = argparse.ArgumentParser(description=<span class="hljs-string">'PyTorch MNIST Example'</span>)<font></font>
parser.add_argument(<span class="hljs-string">'--batch-size'</span>, type=int, default=<span class="hljs-number">64</span>, metavar=<span class="hljs-string">'N'</span>,<font></font>
                    help=<span class="hljs-string">'input batch size for training (default: 64)'</span>)<font></font>
parser.add_argument(<span class="hljs-string">'--epochs'</span>, type=int, default=<span class="hljs-number">10</span>, metavar=<span class="hljs-string">'N'</span>,<font></font>
                    help=<span class="hljs-string">'number of epochs to train (default: 10)'</span>)<font></font>
parser.add_argument(<span class="hljs-string">'--lr'</span>, type=float, default=<span class="hljs-number">0.01</span>, metavar=<span class="hljs-string">'LR'</span>,<font></font>
                    help=<span class="hljs-string">'learning rate (default: 0.01)'</span>)<font></font>
parser.add_argument(<span class="hljs-string">'--momentum'</span>, type=float, default=<span class="hljs-number">0.5</span>, metavar=<span class="hljs-string">'M'</span>,<font></font>
                    help=<span class="hljs-string">'SGD momentum (default: 0.5)'</span>)<font></font>
parser.add_argument(<span class="hljs-string">'--no-cuda'</span>, action=<span class="hljs-string">'store_true'</span>, default=<span class="hljs-literal">False</span>,<font></font>
                    help=<span class="hljs-string">'disables CUDA training'</span>)<font></font>
parser.add_argument(<span class="hljs-string">'--seed'</span>, type=int, default=<span class="hljs-number">1</span>, metavar=<span class="hljs-string">'S'</span>,<font></font>
                    help=<span class="hljs-string">'random seed (default: 1)'</span>)<font></font>
parser.add_argument(<span class="hljs-string">'--save-interval'</span>, type=int, default=<span class="hljs-number">10</span>, metavar=<span class="hljs-string">'N'</span>,<font></font>
                    help=<span class="hljs-string">'how many batches to wait before checkpointing'</span>)<font></font>
parser.add_argument(<span class="hljs-string">'--resume'</span>, action=<span class="hljs-string">'store_true'</span>, default=<span class="hljs-literal">False</span>,<font></font>
                    help=<span class="hljs-string">'resume training from checkpoint'</span>)<font></font>
args = parser.parse_args()<font></font>
<font></font>
use_cuda = torch.cuda.is_available() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> args.no_cuda<font></font>
device = torch.device(<span class="hljs-string">'cuda'</span> <span class="hljs-keyword">if</span> use_cuda <span class="hljs-keyword">else</span> <span class="hljs-string">'cpu'</span>)<font></font>
torch.manual_seed(args.seed)<font></font>
<span class="hljs-keyword">if</span> use_cuda:<font></font>
  torch.cuda.manual_seed(args.seed)</code></pre><br>
<code>argparse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、Pythonでコマンドライン引数を処理する標準的な方法です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さまざまなデバイスで動作するように設計されたコードを作成する必要がある場合（利用可能な場合はGPUアクセラレーションを使用するが、CPUでのコンピューティングにロールバックされない場合）、</font></font><code>torch.device</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テンソルを格納する場所を決定できる</font><font style="vertical-align: inherit;">適切なものを選択して保存します</font><font style="vertical-align: inherit;">。このようなコードの作成の詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式ドキュメントを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照してください</font><font style="vertical-align: inherit;">。 PyTorchのアプローチは、ユーザー制御の下でデバイスを選択することです。これは、単純な例では望ましくないように見える場合があります。ただし、このアプローチは、テンソルを処理する必要がある場合の作業を大幅に簡略化します。これは、a）デバッグに便利ですb）デバイスを手動で効率的に使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実験の再現性のために、乱数生成を使用してすべてのコンポーネントのランダムな初期値を確立する必要があり</font><font style="vertical-align: inherit;">ます（使用する場合は</font><font style="vertical-align: inherit;">、</font></font><code>random</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><code>numpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用）。</font><font style="vertical-align: inherit;">注意：cuDNNは非決定的アルゴリズムを使用し、オプションでを使用して無効化されます</font></font><code>torch.backends.cudnn.enabled = False</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ</font></font></h4><br>
<pre><code class="python hljs">data_path = os.path.join(os.path.expanduser(<span class="hljs-string">'~'</span>), <span class="hljs-string">'.torch'</span>, <span class="hljs-string">'datasets'</span>, <span class="hljs-string">'mnist'</span>)<font></font>
train_data = datasets.MNIST(data_path, train=<span class="hljs-literal">True</span>, download=<span class="hljs-literal">True</span>,<font></font>
                            transform=transforms.Compose([<font></font>
                              transforms.ToTensor(),<font></font>
                              transforms.Normalize((<span class="hljs-number">0.1307</span>,), (<span class="hljs-number">0.3081</span>,))]))<font></font>
test_data = datasets.MNIST(data_path, train=<span class="hljs-literal">False</span>, transform=transforms.Compose([<font></font>
                             transforms.ToTensor(),<font></font>
                             transforms.Normalize((<span class="hljs-number">0.1307</span>,), (<span class="hljs-number">0.3081</span>,))]))<font></font>
<font></font>
train_loader = DataLoader(train_data, batch_size=args.batch_size,<font></font>
                          shuffle=<span class="hljs-literal">True</span>, num_workers=<span class="hljs-number">4</span>, pin_memory=<span class="hljs-literal">True</span>)<font></font>
test_loader = DataLoader(test_data, batch_size=args.batch_size,<font></font>
                         num_workers=<span class="hljs-number">4</span>, pin_memory=<span class="hljs-literal">True</span>)</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
モデル</font></font><code>torchvision</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はに保存されているため</font></font><code>~/.torch/models/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、データセット</font><font style="vertical-align: inherit;">はに保存する</font><font style="vertical-align: inherit;">ことをお勧め</font></font><code>torchvision</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し</font></font><code>~/.torch/datasets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。これは私の著作権契約ですが、MNIST、CIFAR-10などに基づいて開発されたプロジェクトで使用すると非常に便利です。一般に、複数のデータセットを再利用する場合は、データセットをコードとは別に保存する必要があります。</font></font><br>
<br>
<code>torchvision.transforms</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">には、トリミングや正規化など、個々の画像に便利な変換オプションが多数含まれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そこ</font></font><code>DataLoader</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に多くのオプションがありますが、に加えて</font></font><code>batch_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><code>shuffle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、あなたも心に留めておく必要があります</font></font><code>num_workers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、</font></font><code>pin_memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">彼らは効率を高めるのに役立ち、。</font></font><code> num_workers &gt; 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非同期データの読み込みにサブプロセスを使用しますが、メインプロセスをブロックしません。</font><font style="vertical-align: inherit;">典型的な使用例は、ディスクからデータ（たとえば、イメージ）をロードし、場合によってはそれらを変換することです。</font><font style="vertical-align: inherit;">これはすべて、ネットワークデータ処理と並行して行うことができます。</font><font style="vertical-align: inherit;">処理の程度を調整して、a）従業員の数を最小限に抑え、結果として使用されるCPUとRAMの量を減らす必要があります（各従業員は、部分に含まれる個々のサンプルではなく、個別の部分をロードします）b）ネットワーク上のデータの待機時間を最小限に抑えます。</font><font style="vertical-align: inherit;">（スワップメモリ​​ではなく）</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ピンメモリを</font></a></font><code>pin_memory</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">して、RAMからGPUへのデータ転送操作を高速化します（CPU固有のコードでは何もしません）。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">型番</font></font></h4><br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Net</span>(<span class="hljs-params">nn.Module</span>):</span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><font></font>
    super(Net, self).__init__()<font></font>
    self.conv1 = nn.Conv2d(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, kernel_size=<span class="hljs-number">5</span>)<font></font>
    self.conv2 = nn.Conv2d(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, kernel_size=<span class="hljs-number">5</span>)<font></font>
    self.conv2_drop = nn.Dropout2d()<font></font>
    self.fc1 = nn.Linear(<span class="hljs-number">320</span>, <span class="hljs-number">50</span>)<font></font>
    self.fc2 = nn.Linear(<span class="hljs-number">50</span>, <span class="hljs-number">10</span>)<font></font>
<font></font>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span>(<span class="hljs-params">self, x</span>):</span>
    x = F.relu(F.max_pool2d(self.conv1(x), <span class="hljs-number">2</span>))<font></font>
    x = F.relu(F.max_pool2d(self.conv2_drop(self.conv2(x)), <span class="hljs-number">2</span>))<font></font>
    x = x.view(<span class="hljs-number">-1</span>, <span class="hljs-number">320</span>)<font></font>
    x = F.relu(self.fc1(x))<font></font>
    x = self.fc2(x)<font></font>
    <span class="hljs-keyword">return</span> F.log_softmax(x, dim=<span class="hljs-number">1</span>)<font></font>
<font></font>
model = Net().to(device)<font></font>
optimiser = optim.SGD(model.parameters(), lr=args.lr, momentum=args.momentum)<font></font>
<font></font>
<span class="hljs-keyword">if</span> args.resume:<font></font>
  model.load_state_dict(torch.load(<span class="hljs-string">'model.pth'</span>))<font></font>
  optimiser.load_state_dict(torch.load(<span class="hljs-string">'optimiser.pth'</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークの初期化は通常、メンバー変数、学習パラメーターを含むレイヤー、そして場合によっては個々の学習パラメーターとトレーニングされていないバッファーにまで及びます。次に、直接パスを使用して</font></font><code>F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、パラメーターを含まない純粋に機能的な関数</font><font style="vertical-align: inherit;">と組み合わせて使用​​し</font><font style="vertical-align: inherit;">ます。一部の人々は、純粋に機能的なネットワーク（たとえば、パラメーターを保持して</font></font><code>F.conv2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代わりに</font><font style="vertical-align: inherit;">使用</font></font><code>nn.Conv2d</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）または完全にレイヤーで構成されるネットワーク（たとえば、</font></font><code>nn.ReLU</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代わりに</font></font><code>F.relu</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を使用することを好みます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<code>.to(device)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-必要に応じて、デバイスパラメータ（およびバッファ）をGPUに送信する便利な方法</font></font><code>device</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それ以外の場合（CPUがデバイスとして設定されている場合）は何も行われないため、GPUが設定されます。オプティマイザに渡す前に、デバイスパラメータを適切なデバイスに転送することが重要です。そうしないと、オプティマイザはパラメータを正しく追跡できなくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ニューラルネットワーク（</font></font><code>nn.Module</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）とオプティマイザー（</font></font><code>optim.Optimizer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）は</font><font style="vertical-align: inherit;">どちらも</font><font style="vertical-align: inherit;">内部状態を保存して読み込むことができます。これを行うには、ヘルプを使用することをお勧めします</font></font><code>.load_state_dict(state_dict)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。以前に保存した状態辞書に基づいてトレーニングを再開するには、両方の状態を再読み込みする必要があります。オブジェクト全体を保存する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、エラーが発生する場合があり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。テンソルをGPUに保存し、それらをCPUまたは別のGPUにロードする場合、最も簡単な方法は、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">オプション</font></a><font style="vertical-align: inherit;">を使用してテンソルを直接CPUにロードすることです。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a> <code>map_location</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例：</font></font><code>torch.load('model.pth'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>map_location='cpu'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここには表示されていませんが、注目に値する他のいくつかのポイントがあります。ダイレクトパスを使用すると、制御フローを使用できます（たとえば、命令の実行は</font></font><code>if</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、メンバー変数またはデータ自体に依存する場合があります。さらに、プロセスの途中で出力することも完全に許容されます（</font></font><code>print</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）テンソル。これにより、デバッグが大幅に簡略化されます。最後に、直接パスを使用すると、多くの引数を使用できます。特定のアイデアに結び付けられていない短いリストで、この点を説明します。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span>(<span class="hljs-params">self, x, hx, drop=False</span>):</span><font></font>
  hx2 = self.rnn(x, hx)<font></font>
  print(hx.mean().item(), hx.var().item())<font></font>
  <span class="hljs-keyword">if</span> hx.max.item() &gt; <span class="hljs-number">10</span> <span class="hljs-keyword">or</span> self.can_drop <span class="hljs-keyword">and</span> drop:
    <span class="hljs-keyword">return</span> hx
  <span class="hljs-keyword">else</span>:
    <span class="hljs-keyword">return</span> hx2</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレーニング</font></font></h4><br>
<pre><code class="python hljs">model.train()<font></font>
train_losses = []<font></font>
<font></font>
<span class="hljs-keyword">for</span> i, (data, target) <span class="hljs-keyword">in</span> enumerate(train_loader):<font></font>
  data = data.to(device=device, non_blocking=<span class="hljs-literal">True</span>)<font></font>
  target = target.to(device=device, non_blocking=<span class="hljs-literal">True</span>)<font></font>
  optimiser.zero_grad()<font></font>
  output = model(data)<font></font>
  loss = F.nll_loss(output, target)<font></font>
  loss.backward()<font></font>
  train_losses.append(loss.item())<font></font>
  optimiser.step()<font></font>
<font></font>
  <span class="hljs-keyword">if</span> i % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>:<font></font>
    print(i, loss.item())<font></font>
    torch.save(model.state_dict(), <span class="hljs-string">'model.pth'</span>)<font></font>
    torch.save(optimiser.state_dict(), <span class="hljs-string">'optimiser.pth'</span>)<font></font>
    torch.save(train_losses, <span class="hljs-string">'train_losses.pth'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークモジュールはデフォルトでトレーニングモードに設定されます-これは、ある程度、モジュールの操作に影響を与えます-とりわけ、間引きとバッチ正規化。いずれにせよ</font></font><code>.train()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、トレーニングフラグがすべての子モジュールに漏れるようにして、</font><font style="vertical-align: inherit;">手動で設定することをお勧めし</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、このメソッド</font></font><code>.to()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はデバイスを受け入れるだけでなく、もインストールします</font></font><code>non_blocking=True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これにより、固定メモリからGPUへのデータの非同期コピーが保証され、データ転送中もCPUが動作し続けることができます。そうでなければ、それは</font></font><code>non_blocking=True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単に選択肢ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
を使用して新しい勾配セットを作成し</font></font><code>loss.backward()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、を使用して逆伝播を実行する前</font></font><code>optimiser.step()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に、最適化されたパラメーターの勾配を手動でリセットする必要があります。</font></font><code>optimiser.zero_grad()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。デフォルトでは、PyTorchはグラデーションを蓄積します。これは、1つのパスで必要なすべてのグラデーションを計算するための十分なリソースがない場合に非常に便利です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PyTorchは、自動勾配の「テープ」システムを使用します。テンソルで実行された操作と順序に関する情報を収集し、逆方向に再生して、逆の順序で微分を行います（逆モード微分）。そのため、非常に柔軟であり、任意の計算グラフを使用できます。これらのテンソルのどれも勾配を必要としない場合（それを確立する必要があります</font></font><code>requires_grad=True</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この目的のためにテンソルを作成する）、グラフは保存されません！ただし、ネットワークには通常、勾配を必要とするパラメーターがあるため、ネットワーク出力に基づいて実行される計算はグラフに保存されます。したがって、このステップの結果であるデータを保存したい場合は、手動でグラデーションをオフにするか、（より一般的な方法）この情報をPython番号（</font></font><code>.item()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スカラーでPyTorchを</font><font style="vertical-align: inherit;">使用</font><font style="vertical-align: inherit;">）または配列</font><font style="vertical-align: inherit;">として保存する必要があります</font></font><code>numpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。詳しく</font></font><code>autograd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式ドキュメント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をご覧ください</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
計算グラフを削減する1つの方法は、</font></font><code>.detach()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">隠れた状態が、逆伝播時間の切り捨てられたバージョンでRNNトレーニング中に渡されたとき。コンポーネントの1つが別のネットワークの出力である場合、損失を区別するときにも便利ですが、この他のネットワークは損失に関して最適化されるべきではありません。例として、GANでの作業時に生成される出力資料の差別的な部分、または目的関数をベース関数として使用するアクタークリティカルアルゴリズムのポリシートレーニング（A2Cなど）について説明します。勾配の計算を防止する別の手法は、GANのトレーニング（判別材料での生成部分のトレーニング）に効果的であり、微調整の典型は、指定されたネットワークパラメーターの循環列挙です</font></font><code>param.requires_grad = False</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
念のため、コンソール/ログファイルに結果を記録するだけでなく、モデルパラメータ（およびオプティマイザの状態）にブレークポイントを設定することも重要です。</font><font style="vertical-align: inherit;">また、これ</font></font><code>torch.save()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用し</font><font style="vertical-align: inherit;">て通常のPythonオブジェクトを保存したり、別の標準ソリューション（組み込みのもの）を使用したりする</font><font style="vertical-align: inherit;">こともでき</font><font style="vertical-align: inherit;">ます</font></font><code>pickle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト中</font></font></h4><br>
<pre><code class="python hljs">model.eval()<font></font>
test_loss, correct = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><font></font>
<font></font>
<span class="hljs-keyword">with</span> torch.no_grad():
  <span class="hljs-keyword">for</span> data, target <span class="hljs-keyword">in</span> test_loader:<font></font>
    data = data.to(device=device, non_blocking=<span class="hljs-literal">True</span>)<font></font>
    target = target.to(device=device, non_blocking=<span class="hljs-literal">True</span>)<font></font>
    output = model(data)<font></font>
    test_loss += F.nll_loss(output, target, reduction=<span class="hljs-string">'sum'</span>).item()<font></font>
    pred = output.argmax(<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)<font></font>
    correct += pred.eq(target.view_as(pred)).sum().item()<font></font>
<font></font>
test_loss /= len(test_data)<font></font>
acc = correct / len(test_data)<font></font>
print(acc, test_loss)</code></pre><br><font style="vertical-align: inherit;"></font><code>.train()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークに</font><font style="vertical-align: inherit;">
応じて、</font><font style="vertical-align: inherit;">を使用して明示的に評価モードに変換する必要があります</font></font><code>.eval()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のように、ネットワークを使用する場合、計算グラフは通常コンパイルされます。</font><font style="vertical-align: inherit;">これが起こらないようにするには、でコンテキストマネージャ</font></font><code>no_grad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用します</font></font><code>with torch.no_grad()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">もうちょっと</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは追加のセクションです。このセクションでは、さらにいくつかの有用な余談を行いました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、</font><font style="vertical-align: inherit;">メモリの操作を説明する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式のドキュメント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CUDAエラー？それらを修正することは困難であり、通常、それらは論理的な不整合に接続されており、GPUよりもCPUに表示される方がわかりやすいエラーメッセージに基づいています。何よりも、GPUを使用する場合は、CPUとGPUをすばやく切り替えることができます。より一般的な開発のヒントは、本格的なタスクを開始する前にすばやく確認できるようにコードを整理することです。たとえば、小規模なデータセットまたは合成データセットを準備し、1つの元号トレイン+テストを実行します。問題がCUDAエラーであるか、まったくCPUに切り替えられない場合は、CUDA_LAUNCH_BLOCKING = 1を設定します。これにより、CUDAカーネルが同期して起動し、より正確なエラーメッセージが表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
についての発言</font></font><code>torch.multiprocessing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または、ほぼ同時に複数のPyTorchスクリプトを実行するだけです。</font><font style="vertical-align: inherit;">PyTorchはマルチスレッドBLASライブラリを使用して、CPUでの線形代数計算を高速化するため、通常、いくつかのコアが関与します。</font><font style="vertical-align: inherit;">マルチスレッド処理または複数のスクリプトを使用して、同時に複数の処理を実行する場合は、環境変数</font></font><code>OMP_NUM_THREADS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を1または別の低い値に</font><font style="vertical-align: inherit;">設定して、それらの数を手動で減らすことをお勧めし</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">したがって、プロセッサがスリップする可能性が低くなります。</font><font style="vertical-align: inherit;">公式ドキュメントには、マルチスレッド処理に関する他のコメントがあります。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja471212/index.html">VueJSで最高の開発者になるための10のヒントとコツ</a></li>
<li><a href="../ja471216/index.html">ガイドの長い歴史-スマートハイキングコースのサービスを5年間どのように書いたか</a></li>
<li><a href="../ja471220/index.html">コックピット-便利なWebインターフェースを使用してLinuxの一般的な管理タスクを簡素化</a></li>
<li><a href="../ja471222/index.html">アプリケーションとサービスのプライバシーポリシーを理解すると、ニューラルネットワークに役立ちます</a></li>
<li><a href="../ja471226/index.html">Linuxには多くの面があります。どのディストリビューションで作業するか</a></li>
<li><a href="../ja471230/index.html">ユーザーによる暗号トークンのUsbipベースの共有</a></li>
<li><a href="../ja471232/index.html">LPS331APをOmega Onion2に接続した経験</a></li>
<li><a href="../ja471236/index.html">Seryozhaの線量計。パートIII。国立放射計</a></li>
<li><a href="../ja471240/index.html">「Bitchy Betty」と最新のオーディオインターフェース：なぜ女性の声で話すのですか？</a></li>
<li><a href="../ja471242/index.html">Bash Shellの概要</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>