<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👘 👋🏽 🤐 AWX、Ansible、haproxy、CROC CloudによるDIY自動スケーリング 👏🏻 🙅🏿 📇</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- (Agentless) . CloudWatch AWS API. . — , (AWS Resource Tagging API) service discovery. .
 

 -: DNS -> 2 -> 2 backend. . "" , , , backend. backend . ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>AWX、Ansible、haproxy、CROC CloudによるDIY自動スケーリング</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/croccloudteam/blog/456826/"><p><img src="https://habrastorage.org/webt/6f/nt/tj/6fnttjgdk8vat9bbsahsnck_rfa.jpeg" alt="画像"></p><br>
<p>-      (Agentless)     .   CloudWatch  AWS   API.        .        —      ,          (AWS Resource Tagging API)   service discovery.       .</p><a name="habracut"></a><br>
<p>    -: DNS -&gt; 2  -&gt; 2 backend.             .       ""    , , ,   backend.     backend        .     .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>.</p><br>
<h3 id="bazovaya-infrastruktura"> </h3><br>
<p>         ,  ,   .       Terraform.       (VPC, Subnet, Security Group, VMs)       .</p><br>
<p>    :</p><br>
<div class="spoiler"><b class="spoiler_title">main.tf</b><div class="spoiler_text"><pre><code class="bash hljs">variable <span class="hljs-string">"ec2_url"</span> {}<font></font>
variable <span class="hljs-string">"access_key"</span> {}<font></font>
variable <span class="hljs-string">"secret_key"</span> {}<font></font>
variable <span class="hljs-string">"region"</span> {}<font></font>
variable <span class="hljs-string">"vpc_cidr_block"</span> {}<font></font>
variable <span class="hljs-string">"instance_type"</span> {}<font></font>
variable <span class="hljs-string">"big_instance_type"</span> {}<font></font>
variable <span class="hljs-string">"az"</span> {}<font></font>
variable <span class="hljs-string">"ami"</span> {}<font></font>
variable <span class="hljs-string">"client_ip"</span> {}<font></font>
variable <span class="hljs-string">"material"</span> {}<font></font>
<font></font>
provider <span class="hljs-string">"aws"</span> {<font></font>
    endpoints {<font></font>
        ec2 = <span class="hljs-string">"<span class="hljs-variable">${var.ec2_url}</span>"</span><font></font>
    }<font></font>
    skip_credentials_validation = <span class="hljs-literal">true</span>
    skip_requesting_account_id = <span class="hljs-literal">true</span>
    skip_region_validation = <span class="hljs-literal">true</span><font></font>
<font></font>
    access_key = <span class="hljs-string">"<span class="hljs-variable">${var.access_key}</span>"</span>
    secret_key = <span class="hljs-string">"<span class="hljs-variable">${var.secret_key}</span>"</span>
    region = <span class="hljs-string">"<span class="hljs-variable">${var.region}</span>"</span><font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_vpc"</span> <span class="hljs-string">"vpc"</span> {<font></font>
    cidr_block = <span class="hljs-string">"<span class="hljs-variable">${var.vpc_cidr_block}</span>"</span><font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_subnet"</span> <span class="hljs-string">"subnet"</span> {<font></font>
    availability_zone = <span class="hljs-string">"<span class="hljs-variable">${var.az}</span>"</span>
    vpc_id = <span class="hljs-string">"<span class="hljs-variable">${aws_vpc.vpc.id}</span>"</span>
    cidr_block = <span class="hljs-string">"<span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span>"</span><font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_security_group"</span> <span class="hljs-string">"sg"</span> {<font></font>
    name = <span class="hljs-string">"auto-scaling"</span>
    vpc_id = <span class="hljs-string">"<span class="hljs-variable">${aws_vpc.vpc.id}</span>"</span><font></font>
<font></font>
    ingress {<font></font>
        from_port = 22<font></font>
        to_port = 22<font></font>
        protocol = <span class="hljs-string">"tcp"</span>
        cidr_blocks = [<span class="hljs-string">"0.0.0.0/0"</span>]<font></font>
    }<font></font>
<font></font>
    ingress {<font></font>
        from_port = 80<font></font>
        to_port = 80<font></font>
        protocol = <span class="hljs-string">"tcp"</span>
        cidr_blocks = [<span class="hljs-string">"<span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span>"</span>]<font></font>
    }<font></font>
<font></font>
    ingress {<font></font>
        from_port = 8080<font></font>
        to_port = 8080<font></font>
        protocol = <span class="hljs-string">"tcp"</span>
        cidr_blocks = [<span class="hljs-string">"<span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span>"</span>]<font></font>
    }<font></font>
<font></font>
    egress {<font></font>
      from_port = 0<font></font>
      to_port = 0<font></font>
      protocol = <span class="hljs-string">"-1"</span>
      cidr_blocks = [<span class="hljs-string">"0.0.0.0/0"</span>]<font></font>
    }<font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_key_pair"</span> <span class="hljs-string">"key"</span> {<font></font>
  key_name   = <span class="hljs-string">"auto-scaling-new"</span>
  public_key = <span class="hljs-string">"<span class="hljs-variable">${var.material}</span>"</span><font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_instance"</span> <span class="hljs-string">"compute"</span> {<font></font>
  count             =  5<font></font>
  ami               = <span class="hljs-string">"<span class="hljs-variable">${var.ami}</span>"</span>
  instance_type     = <span class="hljs-string">"<span class="hljs-variable">${count.index == 0 ? var.big_instance_type : var.instance_type}</span>"</span>
  key_name          = <span class="hljs-string">"<span class="hljs-variable">${aws_key_pair.key.key_name}</span>"</span>
  subnet_id         = <span class="hljs-string">"<span class="hljs-variable">${aws_subnet.subnet.id}</span>"</span>
  availability_zone = <span class="hljs-string">"<span class="hljs-variable">${var.az}</span>"</span>
  security_groups   = [<span class="hljs-string">"<span class="hljs-variable">${aws_security_group.sg.id}</span>"</span>]<font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_eip"</span> <span class="hljs-string">"pub_ip"</span> {<font></font>
  instance = <span class="hljs-string">"<span class="hljs-variable">${aws_instance.compute.0.id}</span>"</span>
  vpc      = <span class="hljs-literal">true</span><font></font>
}<font></font>
<font></font>
output <span class="hljs-string">"awx"</span> {<font></font>
  value = <span class="hljs-string">"<span class="hljs-variable">${aws_eip.pub_ip.public_ip}</span>"</span><font></font>
}<font></font>
<font></font>
output <span class="hljs-string">"haproxy_id"</span> {<font></font>
    value = [<span class="hljs-string">"<span class="hljs-variable">${slice(aws_instance.compute.*.id, 1, 3)}</span>"</span>]<font></font>
}<font></font>
<font></font>
output <span class="hljs-string">"awx_id"</span> {<font></font>
  value = <span class="hljs-string">"<span class="hljs-variable">${aws_instance.compute.0.id}</span>"</span><font></font>
}<font></font>
<font></font>
output <span class="hljs-string">"backend_id"</span> {<font></font>
  value = [<span class="hljs-string">"<span class="hljs-variable">${slice(aws_instance.compute.*.id, 3, 5)}</span>"</span>]<font></font>
}</code></pre></div></div><br>
<p> ,    , ,       . ,        ,     — terraform.tfvars:</p><br>
<div class="spoiler"><b class="spoiler_title">terraform.tfvars</b><div class="spoiler_text"><pre><code class="bash hljs">ec2_url = <span class="hljs-string">"https://api.cloud.croc.ru"</span>
access_key = <span class="hljs-string">"project:user@customer"</span>
secret_key = <span class="hljs-string">"secret-key"</span>
region = <span class="hljs-string">"croc"</span>
az = <span class="hljs-string">"ru-msk-vol51"</span>
instance_type = <span class="hljs-string">"m1.2small"</span>
big_instance_type = <span class="hljs-string">"m1.large"</span>
vpc_cidr_block = <span class="hljs-string">"10.10.0.0/16"</span>
ami = <span class="hljs-string">"cmi-3F5B011E"</span></code></pre></div></div><br>
<p> Terraform:</p><br>
<div class="spoiler"><b class="spoiler_title">terraform apply</b><div class="spoiler_text"><pre><code class="bash hljs">yes yes | terraform apply -var client_ip=<span class="hljs-string">"<span class="hljs-subst">$(curl -s ipinfo.io/ip)</span>/32"</span> -var material=<span class="hljs-string">"<span class="hljs-subst">$(cat &lt;ssh_publick_key_path&gt;)</span>"</span></code></pre></div></div><br>
<h3 id="nastroyka-monitoringa"> </h3><br>
<p>      .           .            .</p><br>
<p>            .   .       -     —    .          CPU,            :   (/pps),   (/iops).</p><br>
<div class="spoiler"><b class="spoiler_title">cloudwatch put-metric-alarm</b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-built_in">export</span> CLOUDWATCH_URL=https://monitoring.cloud.croc.ru
<span class="hljs-keyword">for</span> instance_id <span class="hljs-keyword">in</span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword">do</span> \<font></font>
        aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable">$CLOUDWATCH_URL</span> \<font></font>
            cloudwatch put-metric-alarm \<font></font>
                --alarm-name <span class="hljs-string">"scaling-low_<span class="hljs-variable">$instance_id</span>"</span> \<font></font>
                --dimensions Name=InstanceId,Value=<span class="hljs-string">"<span class="hljs-variable">$instance_id</span>"</span> \<font></font>
                --namespace <span class="hljs-string">"AWS/EC2"</span> --metric-name CPUUtilization --statistic Average \<font></font>
                --period 60 --evaluation-periods 3 --threshold 15 --comparison-operator LessThanOrEqualToThreshold; <span class="hljs-keyword">done</span><font></font>
<font></font>
<span class="hljs-keyword">for</span> instance_id <span class="hljs-keyword">in</span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword">do</span> \<font></font>
        aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable">$CLOUDWATCH_URL</span> \<font></font>
            cloudwatch put-metric-alarm\<font></font>
            --alarm-name <span class="hljs-string">"scaling-high_<span class="hljs-variable">$instance_id</span>"</span> \<font></font>
            --dimensions Name=InstanceId,Value=<span class="hljs-string">"<span class="hljs-variable">$instance_id</span>"</span> \<font></font>
            --namespace <span class="hljs-string">"AWS/EC2"</span> --metric-name CPUUtilization --statistic Average\<font></font>
            --period 60 --evaluation-periods 3 --threshold 80 --comparison-operator GreaterThanOrEqualToThreshold; <span class="hljs-keyword">done</span></code></pre><br>
<p>  ,    :</p><br>
<p>--profile —   aws-cli,   ~/.aws/config.        .</p><br>
<p>--dimensions —        ,    —       $instance_id.</p><br>
<p>--namespace —  ,      .</p><br>
<p>--metric-name —   .</p><br>
<p>--statistic —     .</p><br>
<p>--period —       .</p><br>
<p>--evaluation-periods —  ,    .</p><br>
<p>--threshold —       .</p><br>
<p>--comparison-operator — ,         .</p></div></div><br>
<p>     backend    . Scaling-low-&lt;instance-id&gt;    Alarm   CPU  15%   3 . Scaling-high-&lt;instance-id&gt;    Alarm   CPU  80%   3 .</p><br>
<h3 id="nastroyka-tegov"> </h3><br>
<p>        —      (service discovery).   - ,      backend ,      .         , , consul  consul template    .      .     .      (describe-tags),   ,            id.    id     hostname.   DNS   VPC  id/hostname    ip .</p><br>
<p>   backend   :</p><br>
<div class="spoiler"><b class="spoiler_title">ec2 create-tags</b><div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-built_in">export</span> EC2_URL=<span class="hljs-string">"https://api.cloud.croc.ru"</span>
aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable">$EC2_URL</span> \<font></font>
        ec2 create-tags --resources <span class="hljs-string">"&lt;awx_instance_id&gt;"</span> \<font></font>
        --tags Key=env,Value=auto-scaling Key=role,Value=awx<font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword">do</span> \<font></font>
        aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable">$EC2_URL</span> \<font></font>
        ec2 create-tags --resources <span class="hljs-string">"<span class="hljs-variable">$i</span>"</span> \ <font></font>
        --tags Key=env,Value=auto-scaling Key=role,Value=backend ; <span class="hljs-keyword">done</span>; <font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> &lt;haproxy_instance_ids&gt;; <span class="hljs-keyword">do</span> \ <font></font>
        aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable">$EC2_URL</span> \<font></font>
        ec2 create-tags --resources <span class="hljs-string">"<span class="hljs-variable">$i</span>"</span> \ <font></font>
        --tags Key=env,Value=auto-scaling Key=role,Value=haproxy; <span class="hljs-keyword">done</span>;</code></pre><br>
<p>:</p><br>
<p>--resources —   ,    .</p><br>
<p>--tags —   -.</p></div></div><br>
<p> describe-tags   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a>  .</p><br>
<h3 id="nastroyka-avtoskeylinga"> </h3><br>
<p>    ,      ,           .    ,           / .      .    AWX. AWX —  open-source   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">Ansible Tower</a>,     Ansible-.   —    ansible playbook.</p><br>
<p>   AWX     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">wiki</a>   .  AWX     Ansible Tower.   AWX    playbook,   ,   :</p><br>
<ul>
<li>redentials  :<br>
<em> — AWS credentials —   ,    .<br>
</em> — Machine credentials — ssh       .<br>
 — SCM credentials —      .</li>
<li>Project — ,   git   playbook.</li>
<li>Scripts —  dynamic inventory  ansible.</li>
<li>Inventory — ,     dynamic inventory   playbook.</li>
<li>Template —    playbook,    Credentials, Inventory  playbook  Project.</li>
<li>Workflow —   playbooks.</li>
</ul><br>
<p>      :</p><br>
<ul>
<li>scale_up —        high ;</li>
<li>scale_down —  ,     low .</li>
</ul><br>
<p>  scale_up   :</p><br>
<ul>
<li>      high    "Alarm";</li>
<li>  scale_up,   high     "OK";</li>
<li>      (tag, subnet, security_group  ..);</li>
<li> high  low    ;</li>
<li>      (      nginx   );</li>
<li>  haproxy,  ,       .</li>
</ul><br>
<div class="spoiler"><b class="spoiler_title">create-instance.yaml</b><div class="spoiler_text"><pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: get alarm statuses<font></font>
  describe_alarms:<font></font>
    region: "croc"<font></font>
    alarm_name_prefix: "scaling-high"<font></font>
    alarm_state: "alarm"<font></font>
  register: describe_alarms_query<font></font>
<font></font>
- name: stop if no alarms fired<font></font>
  fail: <font></font>
    msg: zero high alarms in alarm state<font></font>
  when: describe_alarms_query.meta | length == 0<font></font>
<font></font>
- name: create instance<font></font>
  ec2:<font></font>
    region: "croc"<font></font>
    wait: yes<font></font>
    state: present<font></font>
    count: 1<font></font>
    key_name: "{{ hostvars[groups['tag_role_backend'][0]].ec2_key_name }}"<font></font>
    instance_type: "{{ hostvars[groups['tag_role_backend'][0]].ec2_instance_type }}"<font></font>
    image: "{{ hostvars[groups['tag_role_backend'][0]].ec2_image_id }}"<font></font>
    group_id: "{{ hostvars[groups['tag_role_backend'][0]].ec2_security_group_ids }}"<font></font>
    vpc_subnet_id: "{{ hostvars[groups['tag_role_backend'][0]].ec2_subnet_id }}"<font></font>
    user_data: |<font></font>
      #!/bin/sh<font></font>
      sudo yum install epel-release -y<font></font>
      sudo yum install nginx -y<font></font>
      cat &lt;&lt;EOF &gt; /etc/nginx/conf.d/dummy.conf<font></font>
      server {<font></font>
      listen 8080;<font></font>
        location / {<font></font>
          return 200 '{"message": "$HOSTNAME is up"}';<font></font>
          }<font></font>
       }<font></font>
      EOF<font></font>
      sudo systemctl restart nginx<font></font>
  loop: "{{ hostvars[groups['tag_role_backend'][0]] }}"<font></font>
  register: new <font></font>
<font></font>
- name: create tag entry<font></font>
  ec2_tag: <font></font>
    ec2_url: "https://api.cloud.croc.ru"<font></font>
    region: croc<font></font>
    state: present<font></font>
    resource: "{{ item.id }}"<font></font>
    tags:<font></font>
      role: backend<font></font>
  loop: "{{ new.instances }}"<font></font>
<font></font>
- name: create low alarms<font></font>
  ec2_metric_alarm:<font></font>
    state: present<font></font>
    region: croc<font></font>
    name: "scaling-low_{ item.id }}"<font></font>
    metric: "CPUUtilization"<font></font>
    namespace: "AWS/EC2"<font></font>
    statistic: Average<font></font>
    comparison: "&lt;="<font></font>
    threshold: 15<font></font>
    period: 300<font></font>
    evaluation_periods: 3<font></font>
    unit: "Percent"<font></font>
    dimensions: {'InstanceId':"{{ item.id }}"}<font></font>
  loop: "{{ new.instances }}"<font></font>
<font></font>
- name: create high alarms<font></font>
  ec2_metric_alarm:<font></font>
    state: present<font></font>
    region: croc<font></font>
    name: "scaling-high_{{ item.id }}"<font></font>
    metric: "CPUUtilization"<font></font>
    namespace: "AWS/EC2"<font></font>
    statistic: Average<font></font>
    comparison: "&gt;="<font></font>
    threshold: 80.0<font></font>
    period: 300<font></font>
    evaluation_periods: 3<font></font>
    unit: "Percent"<font></font>
    dimensions: {'InstanceId':"{{ item.id }}"}<font></font>
  loop: "{{ new.instances }}"</code></pre></div></div><br>
<p> create-instance.yaml :     ,       .   user-data      nginx. User-data   cloud-init,         ,       .</p><br>
<p> update-lb.yaml   /etc/haproxy/haproxy.cfg   haproxy   reload haproxy :</p><br>
<div class="spoiler"><b class="spoiler_title">update-lb.yaml</b><div class="spoiler_text"><pre><code class="plaintext hljs">- name: update haproxy configs<font></font>
  template:<font></font>
    src: haproxy.cfg.j2<font></font>
    dest: /etc/haproxy/haproxy.cfg<font></font>
<font></font>
- name: add new backend host to haproxy<font></font>
  systemd:<font></font>
    name: haproxy<font></font>
    state: restarted</code></pre></div></div><br>
<p> haproxy.cfg.j2 —     haproxy:</p><br>
<div class="spoiler"><b class="spoiler_title">haproxy.cfg.j2</b><div class="spoiler_text"><pre><code class="plaintext hljs"># {{ ansible_managed }}<font></font>
global<font></font>
    log /dev/log    local0<font></font>
    log /dev/log    local1 notice<font></font>
    chroot /var/lib/haproxy<font></font>
    stats timeout 30s<font></font>
    user haproxy<font></font>
    group haproxy<font></font>
    daemon<font></font>
<font></font>
defaults<font></font>
    log     global<font></font>
    mode    http<font></font>
    option  httplog<font></font>
    option  dontlognull<font></font>
    timeout connect 5000<font></font>
    timeout client  50000<font></font>
    timeout server  50000<font></font>
<font></font>
frontend loadbalancing<font></font>
    bind *:80<font></font>
    mode http<font></font>
    default_backend backendnodes<font></font>
<font></font>
backend backendnodes<font></font>
    balance roundrobin<font></font>
    option httpchk HEAD /<font></font>
    {% for host in groups['tag_role_backend'] %}<font></font>
    server {{hostvars[host]['ec2_id']}}  {{hostvars[host]['ec2_private_ip_address']}}:8080 check<font></font>
    {% endfor %}</code></pre></div></div><br>
<p>    backend  haproxy   option httpchk,  haproxy     backend        health check.</p><br>
<p> scale_down  :</p><br>
<ul>
<li>  low ;</li>
<li>   play,   low    "Alarm";</li>
<li>  ,   low alarm    "Alarm";</li>
<li>    ,        "Alarm";</li>
<li>   load balancer ,   .</li>
</ul><br>
<div class="spoiler"><b class="spoiler_title">destroy-instance.yaml</b><div class="spoiler_text"><pre><code class="plaintext hljs">- name: look for alarm status<font></font>
  describe_alarms:<font></font>
    region: "croc"<font></font>
    alarm_name_prefix: "scaling-low"<font></font>
    alarm_state: "alarm"<font></font>
  register: describe_alarms_query<font></font>
<font></font>
- name: count alarmed instances<font></font>
  set_fact:<font></font>
    alarmed_count: "{{ describe_alarms_query.meta | length }}"<font></font>
    alarmed_ids: "{{ describe_alarms_query.meta }}"<font></font>
<font></font>
- name: stop if no alarms<font></font>
  fail:<font></font>
    msg: no alarms fired<font></font>
  when: alarmed_count | int == 0<font></font>
<font></font>
- name: count all described instances<font></font>
  set_fact: <font></font>
    all_count: "{{ groups['tag_role_backend'] | length }}"<font></font>
<font></font>
- name: fail if last two instance remaining<font></font>
  fail:<font></font>
    msg: cant destroy last two instances<font></font>
  when: all_count | int == 2<font></font>
<font></font>
- name: destroy tags for marked instances<font></font>
  ec2_tag:<font></font>
    ec2_url: "https://api.cloud.croc.ru"<font></font>
    region: croc<font></font>
    resource: "{{ alarmed_ids[0].split('_')[1] }}"<font></font>
    state: absent<font></font>
    tags:<font></font>
      role: backend<font></font>
<font></font>
- name: destroy instances<font></font>
  ec2:<font></font>
    region: croc<font></font>
    state: absent<font></font>
    instance_ids: "{{ alarmed_ids[0].split('_')[1] }}"<font></font>
<font></font>
- name: destroy low alarms<font></font>
  ec2_metric_alarm:<font></font>
    state: absent<font></font>
    region: croc<font></font>
    name: "scaling-low_{{ alarmed_ids[0].split('_')[1] }}"<font></font>
<font></font>
- name: destroy high alarms<font></font>
  ec2_metric_alarm:<font></font>
    state: absent<font></font>
    region: croc<font></font>
    name: "scaling-high_{{ alarmed_ids[0].split('_')[1] }}"</code></pre></div></div><br>
<p> destroy-instance.yaml   ,     ,      .</p><br>
<p>          ,                .<br>
AWX. </p><br>
<h3 id="nastroyka-zadach-shablonov"> , </h3><br>
<p>  tasks     AWX:</p><br>
<div class="spoiler"><b class="spoiler_title">awx-configure.yaml</b><div class="spoiler_text"><pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: Create tower organization<font></font>
  tower_organization:<font></font>
    name: "scaling-org"<font></font>
    description: "scaling-org organization"<font></font>
    state: present<font></font>
<font></font>
- name: Add tower cloud credential<font></font>
  tower_credential:<font></font>
    name: cloud<font></font>
    description: croc cloud api creds<font></font>
    organization: scaling-org<font></font>
    kind: aws<font></font>
    state: present<font></font>
    username: "{{ croc_user }}"<font></font>
    password: "{{ croc_password }}"<font></font>
<font></font>
- name: Add tower github credential<font></font>
  tower_credential:<font></font>
    name: ghe<font></font>
    organization: scaling-org<font></font>
    kind: scm<font></font>
    state: present<font></font>
    username: "{{ ghe_user }}"<font></font>
    password: "{{ ghe_password }}"<font></font>
<font></font>
- name: Add tower ssh credential<font></font>
  tower_credential:<font></font>
    name: ssh<font></font>
    description: ssh creds<font></font>
    organization: scaling-org<font></font>
    kind: ssh<font></font>
    state: present<font></font>
    username: "ec2-user"<font></font>
    ssh_key_data: "{{ lookup('file', 'private.key') }}"<font></font>
<font></font>
- name: Add tower project<font></font>
  tower_project:<font></font>
    name: "auto-scaling"<font></font>
    scm_type: git<font></font>
    scm_credential: ghe<font></font>
    scm_url: &lt;repo-name&gt;<font></font>
    organization: "scaling-org"<font></font>
    scm_branch: master<font></font>
    state: present <font></font>
<font></font>
- name: create inventory<font></font>
  tower_inventory:<font></font>
    name: dynamic-inventory<font></font>
    organization: "scaling-org"<font></font>
    state: present<font></font>
<font></font>
- name: copy inventory script to awx<font></font>
  copy: <font></font>
    src: "{{ role_path }}/files/ec2.py"<font></font>
    dest: /root/ec2.py<font></font>
<font></font>
- name: create inventory source<font></font>
  shell: |<font></font>
    export SCRIPT=$(tower-cli inventory_script create -n "ec2-script" --organization "scaling-org" --script @/root/ec2.py | grep ec2 | awk '{print $1}')<font></font>
    tower-cli inventory_source create --update-on-launch True --credential cloud --source custom --inventory dynamic-inventory -n "ec2-source" --source-script $SCRIPT --source-vars '{"EC2_URL":"api.cloud.croc.ru","AWS_REGION": "croc"}' --overwrite True<font></font>
<font></font>
- name: Create create-instance template<font></font>
  tower_job_template:<font></font>
    name: "create-instance"<font></font>
    job_type: "run"<font></font>
    inventory: "dynamic-inventory"<font></font>
    credential: "cloud"<font></font>
    project: "auto-scaling"<font></font>
    playbook: "create-instance.yaml"<font></font>
    state: "present"<font></font>
  register: create_instance<font></font>
<font></font>
- name: Create update-lb template<font></font>
  tower_job_template:<font></font>
    name: "update-lb"<font></font>
    job_type: "run"<font></font>
    inventory: "dynamic-inventory"<font></font>
    credential: "ssh"<font></font>
    project: "auto-scaling"<font></font>
    playbook: "update-lb.yaml"<font></font>
    credential: "ssh"<font></font>
    state: "present"<font></font>
  register: update_lb<font></font>
<font></font>
- name: Create destroy-instance template<font></font>
  tower_job_template:<font></font>
    name: "destroy-instance"<font></font>
    job_type: "run"<font></font>
    inventory: "dynamic-inventory"<font></font>
    project: "auto-scaling"<font></font>
    credential: "cloud"<font></font>
    playbook: "destroy-instance.yaml"<font></font>
    credential: "ssh"<font></font>
    state: "present"<font></font>
  register: destroy_instance<font></font>
<font></font>
- name: create workflow<font></font>
  tower_workflow_template:<font></font>
    name: auto_scaling<font></font>
    organization: scaling-org<font></font>
    schema: "{{ lookup('template', 'schema.j2')}}"<font></font>
<font></font>
- name: set scheduling<font></font>
  shell: |<font></font>
    tower-cli schedule create -n "3min" --workflow "auto_scaling" --rrule "DTSTART:$(date +%Y%m%dT%H%M%SZ) RRULE:FREQ=MINUTELY;INTERVAL=3"</code></pre></div></div><br>
<p>    template     ansible playbook'.  template   playbook   credentials  inventory.</p><br>
<p> pipe   playbook'  workflow template.  workflow    :</p><br>
<div class="spoiler"><b class="spoiler_title">schema.j2</b><div class="spoiler_text"><pre><code class="plaintext hljs">- failure_nodes:<font></font>
  - id: 101<font></font>
    job_template: {{ destroy_instance.id }}<font></font>
    success_nodes:<font></font>
    - id: 102<font></font>
      job_template: {{ update_lb.id }}<font></font>
  id: 103<font></font>
  job_template: {{ create_instance.id }}<font></font>
  success_nodes:<font></font>
  - id: 104<font></font>
    job_template: {{ update_lb.id }}</code></pre></div></div><br>
<p>     workflow, ..   template'.   workflow    (success_nodes)        .   workflow   :<br>
<img src="https://habrastorage.org/webt/po/l-/vb/pol-vbfpulv4hoimk99mvbtig-u.png" alt="ワークフロー"></p><br>
<p>     workflow,   create-instace playbook ,     , destroy-instance / update-lb playbook'.  workflow     .       ,         .</p><br>
<h3 id="testirovanie-raboty"> </h3><br>
<p>    .    wrk-  http .</p><br>
<div class="spoiler"><b class="spoiler_title">wrk install</b><div class="spoiler_text"><pre><code class="bash hljs">ssh -A ec2-user@&lt;aws_instance_ip&gt;<font></font>
sudo su - <font></font>
<span class="hljs-built_in">cd</span> /opt<font></font>
yum groupinstall <span class="hljs-string">'Development Tools'</span><font></font>
yum install -y openssl-devel git <font></font>
git <span class="hljs-built_in">clone</span> https://github.com/wg/wrk.git wrk
<span class="hljs-built_in">cd</span> wrk<font></font>
make<font></font>
install wrk /usr/<span class="hljs-built_in">local</span>/bin
<span class="hljs-built_in">exit</span></code></pre></div></div><br>
<p>           :</p><br>
<div class="spoiler"><b class="spoiler_title">monitoring</b><div class="spoiler_text"><pre><code class="plaintext hljs">function CPUUtilizationMonitoring() {<font></font>
    local AWS_CLI_PROFILE="&lt;aws_cli_profile&gt;"<font></font>
    local CLOUDWATCH_URL="https://monitoring.cloud.croc.ru"<font></font>
    local API_URL="https://api.cloud.croc.ru"<font></font>
    local STATS=""<font></font>
    local ALARM_STATUS=""<font></font>
    local IDS=$(aws --profile $AWS_CLI_PROFILE --endpoint-url $API_URL ec2 describe-instances --filter Name=tag:role,Values=backend | grep -i instanceid | grep -oE 'i-[a-zA-Z0-9]*' | tr '\n' ' ') <font></font>
    for instance_id in $IDS; do<font></font>
        STATS="$STATS$(aws --profile $AWS_CLI_PROFILE --endpoint-url $CLOUDWATCH_URL cloudwatch get-metric-statistics --dimensions Name=InstanceId,Value=$instance_id --namespace "AWS/EC2" --metric CPUUtilization --end-time  $(date --iso-8601=minutes) --start-time $(date -d "$(date --iso-8601=minutes) - 1 min" --iso-8601=minutes) --period 60 --statistics Average | grep -i average)";<font></font>
        ALARMS_STATUS="$ALARMS_STATUS$(aws --profile $AWS_CLI_PROFILE --endpoint-url $CLOUDWATCH_URL cloudwatch describe-alarms --alarm-names scaling-high-$instance_id | grep -i statevalue)"<font></font>
    done<font></font>
    echo $STATS | column  -s ',' -o '|' -N $(echo $IDS | tr ' ' ',') -t<font></font>
    echo $ALARMS_STATUS | column  -s ',' -o '|' -N $(echo $IDS | tr ' ' ',') -t<font></font>
}<font></font>
export -f CPUUtilizationMonitoring<font></font>
watch -n 60 bash -c CPUUtilizationMonitoring</code></pre></div></div><br>
<p>    60        CPUUtilization         backend .</p><br>
<p>   wrk      backend   :</p><br>
<div class="spoiler"><b class="spoiler_title">wrk run</b><div class="spoiler_text"><pre><code class="bash hljs">ssh -A ec2-user@&lt;awx_instance_ip&gt;<font></font>
wrk -t12 -c100 -d500s http://&lt;haproxy_instance_id&gt;<font></font>
<span class="hljs-built_in">exit</span></code></pre></div></div><br>
<p>     500 ,  12    100 http .</p><br>
<p>      ,         CPUUtilization       300%.  180      StateValue     Alarm.       autoscaling workflow.  ,    workflow .         workflow           .      wrk     ,  high   backend      OK.    wrk scale_down workflow   backend    .</p><br>
<p>   :</p><br>
<div class="spoiler"><b class="spoiler_title">monitoring results</b><div class="spoiler_text"><pre><code class="plaintext hljs"># start test<font></font>
i-43477460        |i-AC5D9EE0<font></font>
"Average": 0.0    | "Average": 0.0<font></font>
i-43477460        |i-AC5D9EE0<font></font>
"StateValue": "ok"| "StateValue": "ok"<font></font>
<font></font>
# start http load<font></font>
i-43477460        |i-AC5D9EE0<font></font>
"Average": 267.0  | "Average": 111.0<font></font>
i-43477460        |i-AC5D9EE0<font></font>
"StateValue": "ok"| "StateValue": "ok"<font></font>
<font></font>
# alarm state<font></font>
i-43477460           |i-AC5D9EE0<font></font>
"Average": 267.0     | "Average": 282.0<font></font>
i-43477460           |i-AC5D9EE0<font></font>
"StateValue": "alarm"| "StateValue": "alarm"<font></font>
<font></font>
# two new instances created<font></font>
i-1E399860                       |i-F307FB00                        |i-43477460            |i-AC5D9EE0<font></font>
"Average": 185.0                 | "Average": 215.0                 | "Average": 245.0     |<font></font>
i-1E399860                       |i-F307FB00                        |i-43477460            |i-AC5D9EE0<font></font>
"StateValue": "insufficient_data"| "StateValue": "insufficient_data"| "StateValue": "alarm"| "StateValue": "alarm"<font></font>
<font></font>
# only two instances left after load has been stopped<font></font>
i-935BAB40        |i-AC5D9EE0<font></font>
"Average": 0.0    | "Average": 0.0<font></font>
i-935BAB40        |i-AC5D9EE0<font></font>
"StateValue": "ok"| "StateValue": "ok"</code></pre></div></div><br>
<p>                 .</p><br>
<p>        .</p><br>
<h3 id="zaklyuchenie"></h3><br>
<p>   , ,  ,       (  ).       API,       ,  ,    ,   : Terraform, ansible, aws-cli  .</p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja456810/index.html">最初のもの。テスラフリーの物語</a></li>
<li><a href="../ja456812/index.html">ITMO大学の現状-ITフェスティバル、ハッカソン、会議、オープンセミナー</a></li>
<li><a href="../ja456818/index.html">近づきがたい会社のシステム管理者。存在の耐え難い負担？</a></li>
<li><a href="../ja456820/index.html">粘土→レンガ→ストーブ</a></li>
<li><a href="../ja456824/index.html">確率とは何か、そしてそれをどのように計算するか</a></li>
<li><a href="../ja456828/index.html">プリント基板の調整ビア</a></li>
<li><a href="../ja456830/index.html">Vivaldi 2.6 — Летние радости</a></li>
<li><a href="../ja456836/index.html">選択：あなたが知らなかったかもしれない5つの明白でない競合分析ツール</a></li>
<li><a href="../ja456840/index.html">SDL 2レッスン：レッスン6-プリミティブ</a></li>
<li><a href="../ja456842/index.html">PS2 / PSPエミュレーター+ゲームプレイストリーミング（YouTube、Facebook、Twitch）=新しいバージョンのOmega Red</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>