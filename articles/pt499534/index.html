<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìø ü§≥üèø üíº Guia de desenvolvimento de servi√ßos de back-end do Python üë®üèæ‚Äçüíª üçØ üò∞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, meu nome √© Alexander Vasin, sou desenvolvedor de back-end na Edadil. A id√©ia desse material come√ßou com o fato de que eu queria analisar a tarefa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Guia de desenvolvimento de servi√ßos de back-end do Python</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/499534/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√°, meu nome √© Alexander Vasin, sou desenvolvedor de back-end na Edadil. A id√©ia desse material come√ßou com o fato de que eu queria analisar a tarefa introdut√≥ria ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya.Disk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) na Escola de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Desenvolvimento de Backend</font></a><font style="vertical-align: inherit;"> Yandex. Comecei a descrever todas as sutilezas da escolha de certas tecnologias, a metodologia de teste ... Acabou n√£o havendo an√°lise, mas um guia muito detalhado sobre como escrever backends em Python. Desde a ideia inicial, havia apenas requisitos para o servi√ßo, no exemplo dos quais √© conveniente desmontar ferramentas e tecnologias. Como resultado, acordei com cem mil caracteres. Exatamente era necess√°rio muito para considerar tudo em grandes detalhes. Portanto, o programa para os pr√≥ximos 100 kilobytes: como criar um back-end de servi√ßo, desde a escolha das ferramentas at√© a implanta√ß√£o. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pm/sz/r2/pmszr288srjaplio0w_utpnb4ym.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TL; DR:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aqui est√° </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um representante do GitHub com o aplicativo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, e quem ama longreads (reais) - por favor, sob cat.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos desenvolver e testar o servi√ßo da API REST em Python, empacot√°-lo em um cont√™iner Docker leve e implant√°-lo usando o Ansible.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode implementar o servi√ßo da API REST de maneiras diferentes usando ferramentas diferentes. </font><font style="vertical-align: inherit;">A solu√ß√£o descrita n√£o √© a √∫nica correta. Escolhi a implementa√ß√£o e as ferramentas com base em minha experi√™ncia e prefer√™ncias pessoais.</font></font></blockquote><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que n√≥s fazemos?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quais ferramentas escolher?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desenvolvimento</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que voc√™ precisa come√ßar com o setup.py?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como especificar vers√µes de depend√™ncia?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de dados</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s projetamos o esquema</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descreva o esquema em SQLAlchemy</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personalizar Alambique</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geramos migra√ß√µes</font></font></a></li>
</ul></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inscri√ß√£o</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serializa√ß√£o de dados</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipuladores</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importa√ß√µes</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidad√£o</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / importa√ß√µes / $ import_id / cidad√£o / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidad√£os / anivers√°rios</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidades / stat / percentil / idade</font></font></a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipuladores</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidad√£o</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importa√ß√µes</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / importa√ß√µes / $ import_id / cidad√£o / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidad√£os / anivers√°rios</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidades / stat / percentil / idade</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migra√ß√µes</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montagem</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implantar</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste de estresse</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que mais pode ser feito?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente</font></font></a></li>
</ul><br>
<a name="task"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que n√≥s fazemos?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine que uma loja de presentes online planeja iniciar uma a√ß√£o em diferentes regi√µes. </font><font style="vertical-align: inherit;">Para que uma estrat√©gia de vendas seja eficaz, √© necess√°ria uma an√°lise de mercado. </font><font style="vertical-align: inherit;">A loja possui um fornecedor que envia regularmente (por exemplo, por correio) o descarregamento de dados com informa√ß√µes sobre os residentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos desenvolver um servi√ßo de API REST Python que analisar√° os dados fornecidos e identificar√° a demanda por presentes de residentes de diferentes faixas et√°rias em diferentes cidades por m√™s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Implementamos os seguintes manipuladores no servi√ßo:</font></font><br>
<br>
<ul>
<li> <code>POST /imports</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adiciona um novo upload com dados;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Retorna os residentes da descarga especificada;</font></font><br>
 </li>
<li> <code>PATCH /imports/$import_id/citizens/$citizen_id</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Altera informa√ß√µes sobre o residente (e seus parentes) na descarga especificada;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens/birthdays</code><br>
  ,        ( ),   ;<br>
 </li>
<li> <code>GET /imports/$import_id/towns/stat/percentile/age</code><br>
 50-, 75-  99-   ( )      .<br>
 </li>
</ul><br>
<a name="tools"></a><h1>  ?</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, estamos escrevendo um servi√ßo em Python usando estruturas familiares, bibliotecas e DBMS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 palestras do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> curso em v√≠deo, v√°rios DBMSs e seus recursos s√£o descritos. Para minha implementa√ß√£o, escolhi o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DBMS </font><font style="vertical-align: inherit;">, que se estabeleceu como uma solu√ß√£o confi√°vel, com excelente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documenta√ß√£o em russo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , uma forte comunidade russa (voc√™ sempre pode encontrar a resposta para uma pergunta em russo) e at√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursos gratuitos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . O modelo relacional √© bastante vers√°til e bem compreendido por muitos desenvolvedores. Embora o mesmo possa ser feito em qualquer DBMS NoSQL, neste artigo consideraremos o PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O principal objetivo do servi√ßo - transmiss√£o de dados pela rede entre o banco de dados e os clientes - n√£o implica uma grande carga no processador, mas requer a capacidade de processar v√°rias solicita√ß√µes ao mesmo tempo. Em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 palestras</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> consideradas abordagem ass√≠ncrona. Ele permite que voc√™ atenda com efici√™ncia v√°rios clientes no mesmo processo do sistema operacional (ao contr√°rio, por exemplo, do modelo pr√©-fork usado no Flask / Django, que cria v√°rios processos para processar solicita√ß√µes de usu√°rios, cada um deles consome mem√≥ria, mas fica ocioso na maioria das vezes ) Portanto, como uma biblioteca para escrever o servi√ßo, escolhi o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ass√≠ncrono </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
A </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">5¬™ palestra do</font></a><font style="vertical-align: inherit;"> curso em v√≠deo informa que </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">SQLAlchemy</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/or/rj/pn/orrjpnx6upvsipcqbsql7f36vzc.png"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite decompor consultas complexas em partes, reutiliz√°-las, gerar consultas com um conjunto din√¢mico de campos (por exemplo, o processador PATCH permite atualiza√ß√£o parcial dos residentes com campos arbitr√°rios) e se concentrar diretamente na l√≥gica comercial. O driver </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpg pode</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lidar com essas solicita√ß√µes e transferir os dados o mais r√°pido poss√≠vel </font><font style="vertical-align: inherit;">, e o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpgsa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> os ajudar√° a fazer amigos </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Minha ferramenta favorita para gerenciar o estado do banco de dados e trabalhar com migra√ß√µes √© o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . A prop√≥sito, recentemente falei sobre isso em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moscow Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A l√≥gica da valida√ß√£o foi descrita sucintamente pelos esquemas de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Marshmallow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (incluindo checagens de v√≠nculos familiares). Usando o m√≥dulo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://github.com/maximdanilchenko/aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp-spec</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vinculei manipuladores aiohttp e esquemas para valida√ß√£o de dados, e o b√¥nus foi gerar documenta√ß√£o no formato </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swagger</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e exibi-la em uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface gr√°fica</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para escrever provas, eu escolhi </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais sobre isso em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 palestras</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para depurar e criar um perfil desse projeto, usei o depurador PyCharm ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aula 9</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7, a palestra</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> descreve como qualquer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> computador </font><font style="vertical-align: inherit;">(ou mesmo em SO diferente) pode ser executado empacotado sem precisar ajustar o ambiente do aplicativo para iniciar e f√°cil instalar / atualizar / excluir o aplicativo no servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para a implanta√ß√£o, escolhi o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansible</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ele permite descrever declarativamente o estado desejado do servidor e seus servi√ßos, funciona via ssh e n√£o requer software especial.</font></font><br>
<br>
<a name="development"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desenvolvimento</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidi dar um nome ao pacote Python </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e usar a seguinte estrutura: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ox/ly/wt/oxlywtje20xt5ceou8pbtfp8an8.png" width="550"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No arquivo </font></font><code>analyzer/__init__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, publiquei informa√ß√µes gerais sobre o pacote: descri√ß√£o ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documenta√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), vers√£o, licen√ßa, contatos do desenvolvedor.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pode ser visualizado com a ajuda integrada</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python<font></font>
&gt;&gt;&gt; import analyzer<font></font>
&gt;&gt;&gt; <span class="hljs-built_in">help</span>(analyzer)<font></font>
<font></font>
Help on package analyzer:<font></font>
<font></font>
NAME<font></font>
    analyzer<font></font>
<font></font>
DESCRIPTION<font></font>
      REST API,    .<font></font>
<font></font>
PACKAGE CONTENTS<font></font>
    api (package)<font></font>
    db (package)<font></font>
    utils (package)<font></font>
<font></font>
DATA<font></font>
    __all__ = (<span class="hljs-string">'__author__'</span>, <span class="hljs-string">'__email__'</span>, <span class="hljs-string">'__license__'</span>, <span class="hljs-string">'__maintainer__'</span>,...<font></font>
    __email__ = <span class="hljs-string">'alvassin@yandex.ru'</span>
    __license__ = <span class="hljs-string">'MIT'</span>
    __maintainer__ = <span class="hljs-string">'Alexander Vasin'</span><font></font>
<font></font>
VERSION<font></font>
    0.0.1<font></font>
<font></font>
AUTHOR<font></font>
    Alexander Vasin<font></font>
<font></font>
FILE<font></font>
    /Users/alvassin/Work/backendschool2019/analyzer/__init__.py</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O pacote possui dois pontos de entrada - o servi√ßo da API REST ( </font></font><code>analyzer/api/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) e o utilit√°rio de gerenciamento de estado do banco de dados ( </font></font><code>analyzer/db/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Os arquivos s√£o chamados </font></font><code>__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por um motivo - em primeiro lugar, esse nome atrai a aten√ß√£o, deixa claro que o arquivo √© um ponto de entrada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em segundo lugar, gra√ßas a esta abordagem dos pontos de entrada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>     python -m</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># REST API</span>
$ python -m analyzer.api --<span class="hljs-built_in">help</span><font></font>
<font></font>
<span class="hljs-comment">#    </span>
$ python -m analyzer.db --<span class="hljs-built_in">help</span></code></pre><br>
<a name="setuppy"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por que voc√™ precisa come√ßar com o setup.py?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No futuro, pensaremos em como distribuir o aplicativo: ele pode ser empacotado em um arquivo zip (al√©m de roda / ovo), um pacote rpm, um arquivo pkg para macOS e instalado em um computador remoto, em uma m√°quina virtual, em um MacBook ou em Docker. recipiente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O principal objetivo do arquivo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>setup.py</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© descrever o pacote com o aplicativo </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
O arquivo deve conter informa√ß√µes gerais sobre o pacote (nome, vers√£o, autor etc.), mas tamb√©m nele voc√™ pode especificar os m√≥dulos necess√°rios para o trabalho, depend√™ncias "extras" (por exemplo, para teste), pontos de entrada (por exemplo, comandos execut√°veis) ) e requisitos para o int√©rprete. </font><font style="vertical-align: inherit;">
Os plugins Setuptools permitem coletar artefato do pacote descrito. Existem plugins integrados: zip, egg, rpm, macOS pkg. Os plugins restantes s√£o distribu√≠dos via PyPI: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">wheel</font></a><font style="vertical-align: inherit;"> ,</font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">distutils</a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">setuptools</a></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final das contas, descrevendo um arquivo, temos grandes oportunidades. </font><font style="vertical-align: inherit;">√â por isso que o desenvolvimento de um novo projeto deve come√ßar </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na fun√ß√£o, os </font></font><code>setup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√≥dulos dependentes s√£o indicados por uma lista:</font></font><br>
<br>
<pre><code class="python hljs">setup(..., install_requires=[<span class="hljs-string">"aiohttp"</span>, <span class="hljs-string">"SQLAlchemy"</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas descrevi as depend√™ncias em arquivos separados </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cujo conte√∫do √© usado </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Parece-me mais flex√≠vel, al√©m de haver um segredo: mais tarde, voc√™ poder√° criar uma imagem do Docker mais rapidamente. </font><font style="vertical-align: inherit;">As depend√™ncias ser√£o definidas como uma etapa separada antes da instala√ß√£o do pr√≥prio aplicativo e, ao reconstruir o cont√™iner do Docker, ele estar√° no cache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">poder ler as depend√™ncias dos arquivos </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a fun√ß√£o est√° gravada:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â interessante notar que </font></font><code>setuptools</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quando a distribui√ß√£o fonte montagem padr√£o inclui apenas os arquivos de montagem </font></font><code>.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.cpp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Para um arquivo de depend√™ncia </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bater no saco, eles devem ser claramente especificados no arquivo </font></font><code>MANIFEST.in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inteiramente setup.py</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> importlib.machinery <span class="hljs-keyword">import</span> SourceFileLoader<font></font>
<font></font>
<span class="hljs-keyword">from</span> pkg_resources <span class="hljs-keyword">import</span> parse_requirements
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> find_packages, setup<font></font>
<font></font>
module_name = <span class="hljs-string">'analyzer'</span><font></font>
<font></font>
<span class="hljs-comment"># ,     (   ), </span>
<span class="hljs-comment">#   __init__.py   machinery.</span><font></font>
module = SourceFileLoader(<font></font>
    module_name, os.path.join(module_name, <span class="hljs-string">'__init__.py'</span>)<font></font>
).load_module()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements<font></font>
<font></font>
setup(<font></font>
    name=module_name,<font></font>
    version=module.__version__,<font></font>
    author=module.__author__,<font></font>
    author_email=module.__email__,<font></font>
    license=module.__license__,<font></font>
    description=module.__doc__,<font></font>
    long_description=open(<span class="hljs-string">'README.rst'</span>).read(),<font></font>
    url=<span class="hljs-string">'https://github.com/alvassin/backendschool2019'</span>,<font></font>
    platforms=<span class="hljs-string">'all'</span>,<font></font>
    classifiers=[<font></font>
        <span class="hljs-string">'Intended Audience :: Developers'</span>,
        <span class="hljs-string">'Natural Language :: Russian'</span>,
        <span class="hljs-string">'Operating System :: MacOS'</span>,
        <span class="hljs-string">'Operating System :: POSIX'</span>,
        <span class="hljs-string">'Programming Language :: Python'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.8'</span>,
        <span class="hljs-string">'Programming Language :: Python :: Implementation :: CPython'</span><font></font>
    ],<font></font>
    python_requires=<span class="hljs-string">'&gt;=3.8'</span>,<font></font>
    packages=find_packages(exclude=[<span class="hljs-string">'tests'</span>]),<font></font>
    install_requires=load_requirements(<span class="hljs-string">'requirements.txt'</span>),<font></font>
    extras_require={<span class="hljs-string">'dev'</span>: load_requirements(<span class="hljs-string">'requirements.dev.txt'</span>)},<font></font>
    entry_points={<font></font>
        <span class="hljs-string">'console_scripts'</span>: [
            <span class="hljs-comment"># f-strings  setup.py   - </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-comment">#   ,     Python 3.8, </span>
            <span class="hljs-comment"># source distribution       </span>
            <span class="hljs-comment">#   Python.     </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-string">'{0}-api = {0}.api.__main__:main'</span>.format(module_name),
            <span class="hljs-string">'{0}-db = {0}.db.__main__:main'</span>.format(module_name)<font></font>
        ]<font></font>
    },<font></font>
    include_package_data=<span class="hljs-literal">True</span>
)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode instalar um projeto no modo de desenvolvimento usando o seguinte comando (no modo edit√°vel, o Python n√£o instalar√° o pacote inteiro em uma pasta </font></font><code>site-packages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas apenas criar√° links, para que quaisquer altera√ß√µes feitas nos arquivos do pacote sejam vis√≠veis imediatamente):</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#      extra- "dev"</span>
pip install -e <span class="hljs-string">'.[dev]'</span><font></font>
<font></font>
<span class="hljs-comment">#      </span>
pip install -e .</code></pre><br>
<a name="requirements"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como especificar vers√µes de depend√™ncia?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â √≥timo quando os desenvolvedores est√£o trabalhando ativamente em seus pacotes - os bugs est√£o sendo ativamente corrigidos, novas funcionalidades aparecem e o feedback pode ser obtido mais rapidamente. √Äs vezes, por√©m, as altera√ß√µes nas bibliotecas dependentes n√£o s√£o compat√≠veis com vers√µes anteriores e podem levar a erros no seu aplicativo, se voc√™ n√£o pensar nisso antes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cada pacote dependente, voc√™ pode especificar uma vers√£o espec√≠fica, por exemplo </font></font><code>aiohttp==3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Em seguida, ser√° garantido que o aplicativo seja constru√≠do especificamente com as vers√µes das bibliotecas dependentes com as quais foi testado. Mas essa abordagem tem uma desvantagem - se os desenvolvedores corrigirem um bug cr√≠tico em um pacote dependente que n√£o afeta a compatibilidade com vers√µes anteriores, essa corre√ß√£o n√£o entra no aplicativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existe uma abordagem para o controle de vers√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semantic Versioning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o que sugere o envio da vers√£o no formato </font></font><code>MAJOR.MINOR.PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - aumenta quando s√£o adicionadas altera√ß√µes incompat√≠veis com vers√µes anteriores;</font></font></li>
<li><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Aumenta ao adicionar nova funcionalidade com suporte para compatibilidade com vers√µes anteriores;</font></font></li>
<li><code>PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - aumenta ao adicionar corre√ß√µes de erros com suporte √† compatibilidade com vers√µes anteriores.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se um pacote dependente segue esta abordagem (dos quais os autores s√£o geralmente relatados nos arquivos LEIA-ME e changelog), √© suficiente para corrigir o valor de </font></font><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e para limitar o valor m√≠nimo para PATCH-vers√£o: </font></font><code>&gt;= MAJOR.MINOR.PATCH, == MAJOR.MINOR.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse requisito pode ser implementado usando o operador </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ =</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por exemplo, </font></font><code>aiohttp~=3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permitir√° que o PIP seja instalado na </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vers√£o 3.6.3, mas n√£o na 3.7. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ especificar o intervalo de vers√µes de depend√™ncia, isso dar√° mais uma vantagem - n√£o haver√° conflitos de vers√£o entre bibliotecas dependentes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ estiver desenvolvendo uma biblioteca que exija um pacote de depend√™ncia diferente, permita que ela n√£o seja uma vers√£o espec√≠fica, mas um intervalo. </font><font style="vertical-align: inherit;">Ent√£o ser√° muito mais f√°cil para os usu√°rios da sua biblioteca us√°-la (de repente, o aplicativo deles exige o mesmo pacote de depend√™ncia, mas de uma vers√£o diferente). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O versionamento sem√¢ntico √© apenas um acordo entre autores e consumidores de pacotes. </font><font style="vertical-align: inherit;">N√£o garante que os autores escrevam c√≥digo sem erros e n√£o possam cometer erros na nova vers√£o do seu pacote.</font></font><br>
<br>
<a name="db"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base de dados</font></font></h2><br>
<a name="dbstructure"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s projetamos o esquema</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A descri√ß√£o do manipulador POST / imports fornece um exemplo de descarregamento com informa√ß√µes sobre residentes:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo de Upload</font></font></b>
                        <div class="spoiler_text"><pre><code class="json hljs">{
  <span class="hljs-attr">"citizens"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"26.12.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">2</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"01.04.1997"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">1</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"2"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">11</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"23.11.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"female"</span>,
      <span class="hljs-attr">"relatives"</span>: []<font></font>
    },<font></font>
    ...<font></font>
  ]<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro pensamento foi armazenar todas as informa√ß√µes sobre o residente em uma tabela </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, onde o relacionamento seria representado por um campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forma de uma lista de n√∫meros inteiros</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas esse m√©todo tem v√°rias desvantagens</font></font></b>
                        <div class="spoiler_text"><ol>
<li>   <code>GET /imports/$import_id/citizens/birthdays</code>   ,      ,     <code>citizens</code>   .          <code>relatives</code>    <code>UNNEST</code>.<br>
<br>
     ,  <b>    10- </b>:<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
    relations.citizen_id, <font></font>
    relations.relative_id, <font></font>
    date_part(<span class="hljs-string">'month'</span>, relatives.birth_date) <span class="hljs-keyword">as</span> relative_birth_month
<span class="hljs-keyword">FROM</span> (
	<span class="hljs-keyword">SELECT</span><font></font>
        citizens.import_id, <font></font>
        citizens.citizen_id,<font></font>
        <span class="hljs-keyword">UNNEST</span>(citizens.relatives) <span class="hljs-keyword">as</span> relative_id
	<span class="hljs-keyword">FROM</span> citizens
    <span class="hljs-keyword">WHERE</span> import_id = <span class="hljs-number">1</span>
) <span class="hljs-keyword">as</span> relations
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> citizens <span class="hljs-keyword">as</span> relatives <span class="hljs-keyword">ON</span>
    relations.import_id = relatives.import_id <span class="hljs-keyword">AND</span><font></font>
    relations.relative_id = relatives.citizen_id<font></font>
</code></pre><br>
 </li>
<li>    <b>    <code>relatives</code>   PostgreSQL</b>,   :    <code>relatives</code>     ,      .       (     )         .</li>
</ol></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, decidi trazer todos os dados necess√°rios para o trabalho para uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terceira forma normal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e a seguinte estrutura foi obtida:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/pf/px/dipfpxxw142kafiect0yhrtt4uo.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tabela de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">importa√ß√µes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> consiste em uma coluna de incremento autom√°tico </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">√â necess√°rio criar uma verifica√ß√£o de chave estrangeira na tabela </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tabela de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cidad√£os</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> armazena </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dados escalares</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre o residente (todos os campos, exceto informa√ß√µes sobre relacionamentos familiares). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um par ( </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">√© usado como chave prim√°ria </font><font style="vertical-align: inherit;">, garantindo a exclusividade dos residentes </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dentro da estrutura </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma chave estrangeira </font></font><code>citizens.import_id -&gt; imports.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">garante que o campo </font></font><code>citizens.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contenha apenas descargas existentes.</font></font><br>
 </li>
<li>  <b>relations</b>    <b> </b>. <br>
<br>
<b>     </b> (     ):           <code>citizens</code>  <code>relations</code>     .<br>
     (<code>import_id</code>, <code>citizen_id</code>, <code>relative_id</code>)  ,      <code>import_id</code>   <code>citizen_id</code>   c  <code>relative_id</code>. <br>
<br>
       : <code>(relations.import_id, relations.citizen_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>  <code>(relations.import_id, relations.relative_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>, ,        <code>citizen_id</code>   <code>relative_id</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa estrutura garante a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">integridade dos dados usando o PostgreSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , permite que voc√™ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obtenha com efici√™ncia residentes com parentes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do banco de dados, mas est√° </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sujeita a uma condi√ß√£o de corrida</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ao atualizar informa√ß√µes sobre residentes com consultas competitivas (veremos mais de perto a implementa√ß√£o do manipulador PATCH).</font></font><br>
<br>
<a name="do_sqlalchemy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descreva o esquema em SQLAlchemy</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cap√≠tulo 5,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> falei sobre como criar consultas usando SQLAlchemy, voc√™ precisa descrever o esquema do banco de dados usando objetos especiais: as tabelas s√£o descritas usando </font></font><code>sqlalchemy.Table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e vinculadas a um registro </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que armazena todas as metainforma√ß√µes sobre o banco de dados. A prop√≥sito, o registro </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode n√£o apenas armazenar as meta-informa√ß√µes descritas em Python, mas tamb√©m representar o estado real do banco de dados na forma de objetos SQLAlchemy. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse recurso tamb√©m permite que o Alembic compare condi√ß√µes e gere um c√≥digo de migra√ß√£o automaticamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, cada banco de dados tem seu pr√≥prio esquema de nomenclatura de restri√ß√µes padr√£o. </font><font style="vertical-align: inherit;">Para que voc√™ n√£o perca tempo nomeando novas restri√ß√µes ou pesquisando / lembrando que restri√ß√£o est√° prestes a remover, o SQLAlchemy sugere o uso de padr√µes de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nomea√ß√£o de conven√ß√µes de nomenclatura</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Eles podem ser definidos no registro </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie um registro MetaData e passe padr√µes de nomenclatura para ele</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> MetaData<font></font>
<font></font>
convention = {<font></font>
    <span class="hljs-string">'all_column_names'</span>: <span class="hljs-keyword">lambda</span> constraint, table: <span class="hljs-string">'_'</span>.join([<font></font>
        column.name <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> constraint.columns.values()<font></font>
    ]),<font></font>
<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-string">'ix'</span>: <span class="hljs-string">'ix__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'uq'</span>: <span class="hljs-string">'uq__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#  CHECK-constraint-</span>
    <span class="hljs-string">'ck'</span>: <span class="hljs-string">'ck__%(table_name)s__%(constraint_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'fk'</span>: <span class="hljs-string">'fk__%(table_name)s__%(all_column_names)s__%(referred_table_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'pk'</span>: <span class="hljs-string">'pk__%(table_name)s'</span><font></font>
}<font></font>
metadata = MetaData(naming_convention=convention)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ especificar padr√µes de nomea√ß√£o, o Alembic os utilizar√° durante a gera√ß√£o autom√°tica de migra√ß√µes e nomear√° todas as restri√ß√µes de acordo com eles. </font><font style="vertical-align: inherit;">No futuro, o registro criado </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser√° necess√°rio para descrever as tabelas:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descrevemos o esquema do banco de dados com objetos SQLAlchemy</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<font></font>
<font></font>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> (<font></font>
    Column, Date, Enum <span class="hljs-keyword">as</span> PgEnum, ForeignKey, ForeignKeyConstraint, Integer,<font></font>
    String, Table<font></font>
)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@unique</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gender</span>(<span class="hljs-params">Enum</span>):</span>
    female = <span class="hljs-string">'female'</span>
    male = <span class="hljs-string">'male'</span><font></font>
<font></font>
<font></font>
imports_table = Table(<font></font>
    <span class="hljs-string">'imports'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>)<font></font>
)<font></font>
<font></font>
citizens_table = Table(<font></font>
    <span class="hljs-string">'citizens'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, ForeignKey(<span class="hljs-string">'imports.import_id'</span>),<font></font>
           primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'town'</span>, String, nullable=<span class="hljs-literal">False</span>, index=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'street'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'building'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'apartment'</span>, Integer, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'name'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'birth_date'</span>, Date, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'gender'</span>, PgEnum(Gender, name=<span class="hljs-string">'gender'</span>), nullable=<span class="hljs-literal">False</span>),<font></font>
)<font></font>
<font></font>
relations_table = Table(<font></font>
    <span class="hljs-string">'relations'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'relative_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'citizen_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'relative_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
)<font></font>
</code></pre></div>
                    </div><br>
<a name="db_alembic"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Personalizar Alambique</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o esquema do banco de dados √© descrito, √© necess√°rio gerar migra√ß√µes, mas para isso voc√™ precisa primeiro configurar o Alembic, que tamb√©m √© discutido no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cap√≠tulo 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para usar o comando </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, voc√™ deve executar as seguintes etapas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instalar pacote: </font></font><code>pip install alembic</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicializar Alambique: </font></font><code>cd analyzer &amp;&amp; alembic init db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este comando criar√° um arquivo de configura√ß√£o </font></font><code>analyzer/alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e uma pasta </font></font><code>analyzer/db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com o seguinte conte√∫do:</font></font><br>
 <ul>
<li> <code>env.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Ligado toda vez que voc√™ inicia o Alambique. </font><font style="vertical-align: inherit;">Conecta-se ao registro Alembic </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com uma descri√ß√£o do estado desejado do banco de dados e cont√©m instru√ß√µes para iniciar as migra√ß√µes.</font></font><br>
 </li>
<li><code>script.py.mako</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - o modelo com base no qual as migra√ß√µes s√£o geradas.</font></font></li>
<li><code>versions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a pasta na qual o Alembic pesquisar√° (e gerar√°) migra√ß√µes.</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Especifique o endere√ßo do banco de dados no arquivo alembic.ini:</font></font><br>
<br>
<pre><code class="plaintext hljs">; analyzer/alembic.ini<font></font>
[alembic] <font></font>
sqlalchemy.url = postgresql://user:hackme@localhost/analyzer</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Especifique uma descri√ß√£o do estado desejado do banco de dados (registro </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) para que o Alembic possa gerar migra√ß√µes automaticamente:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/alembic/env.py</span>
<span class="hljs-keyword">from</span> analyzer.db <span class="hljs-keyword">import</span> schema<font></font>
target_metadata = schema.metadata</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Alembic est√° configurado e j√° pode ser usado, mas, no nosso caso, essa configura√ß√£o tem v√°rias desvantagens:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O utilit√°rio </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pesquisa </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no diret√≥rio de trabalho atual. </font><font style="vertical-align: inherit;">Voc√™ </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode especificar o </font><font style="vertical-align: inherit;">caminho para o </font><font style="vertical-align: inherit;">argumento da linha de comando, mas isso √© inconveniente: desejo poder chamar o comando de qualquer pasta sem par√¢metros adicionais.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para configurar o Alembic para funcionar com um banco de dados espec√≠fico, voc√™ precisa alterar o arquivo </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Seria muito mais conveniente especificar as configura√ß√µes do banco de dados para a vari√°vel de ambiente e / ou um argumento de linha de comando, por exemplo </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O nome do utilit√°rio </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o se correlaciona muito bem com o nome do nosso servi√ßo (e o usu√°rio pode realmente n√£o ter o Python e n√£o sabe nada sobre o Alembic). </font><font style="vertical-align: inherit;">Seria muito mais conveniente para o usu√°rio final se todos os comandos execut√°veis ‚Äã‚Äãdo servi√ßo tivessem um prefixo comum, por exemplo </font></font><code>analyzer-*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esses problemas s√£o resolvidos com um pequeno inv√≥lucro. </font></font><code>analyzer/db/__main__.py:</code><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Alembic usa um m√≥dulo padr√£o para processar argumentos de linha de comando </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">argparse</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Permite adicionar um argumento opcional </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com um valor padr√£o de uma vari√°vel de ambiente </font></font><code>ANALYZER_PG_URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    alembic.parser.add_argument(<font></font>
        <span class="hljs-string">'--pg-url'</span>, default=os.getenv(<span class="hljs-string">'ANALYZER_PG_URL'</span>, DEFAULT_PG_URL),<font></font>
        help=<span class="hljs-string">'Database URL [env var: ANALYZER_PG_URL]'</span><font></font>
    )<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#   sqlalchemy.url   Alembic</span>
    config.set_main_option(<span class="hljs-string">'sqlalchemy.url'</span>, options.pg_url)<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O caminho para o arquivo </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode ser calculado em rela√ß√£o ao local do arquivo execut√°vel, e n√£o ao diret√≥rio de trabalho atual do usu√°rio.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<font></font>
<font></font>
<font></font>
PROJECT_PATH = Path(__file__).parent.parent.resolve()<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#     (alembic.ini),   </span>
    <span class="hljs-comment">#    </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(options.config):<font></font>
        options.config = os.path.join(PROJECT_PATH, options.config)<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#      alembic   (,  alembic</span>
    <span class="hljs-comment">#   env.py,       )</span>
    alembic_location = config.get_main_option(<span class="hljs-string">'script_location'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(alembic_location):<font></font>
        config.set_main_option(<span class="hljs-string">'script_location'</span>,<font></font>
                               os.path.join(PROJECT_PATH, alembic_location))<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilit√°rio para gerenciar o estado do banco de dados</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° pronto, ele pode ser registrado </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como um comando execut√°vel com um nome compreens√≠vel para o usu√°rio final, por exemplo </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registre um comando execut√°vel em setup.py</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup<font></font>
<font></font>
setup(..., entry_points={<font></font>
    <span class="hljs-string">'console_scripts'</span>: [
        <span class="hljs-string">'analyzer-db = analyzer.db.__main__:main'</span><font></font>
    ]<font></font>
})<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s a reinstala√ß√£o do m√≥dulo, um arquivo ser√° gerado </font></font><code>env/bin/analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e o comando </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ficar√° dispon√≠vel:</font></font><br>
<br>
<pre><code class="bash hljs">$ pip install -e <span class="hljs-string">'.[dev]'</span></code></pre><br>
<a name="db_alembic_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geramos migra√ß√µes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para gerar migra√ß√µes, s√£o necess√°rios dois estados: o estado desejado (que descrevemos com objetos SQLAlchemy) e o estado real (o banco de dados, no nosso caso, est√° vazio). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidi que a maneira mais f√°cil de gerar o Postgres com o Docker era adicionar um comando </font></font><code>make postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que executa um cont√™iner com o PostgreSQL na porta 5432 em segundo plano:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Levante o PostgreSQL e gere migra√ß√£o</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ make postgres<font></font>
...<font></font>
$ analyzer-db revision --message=<span class="hljs-string">"Initial"</span> --autogenerate<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'imports'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'citizens'</span>
INFO  [alembic.autogenerate.compare] Detected added index <span class="hljs-string">'ix__citizens__town'</span> on <span class="hljs-string">'['</span>town<span class="hljs-string">']'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'relations'</span>
  Generating /Users/alvassin/Work/backendschool2019/analyzer/db/alembic/versions/d5f704ed4610_initial.py ...  <span class="hljs-keyword">done</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Alembic geralmente faz um bom trabalho de rotina para gerar migra√ß√µes, mas eu gostaria de chamar a aten√ß√£o para o seguinte:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os tipos de dados do usu√°rio especificados nas tabelas criadas s√£o criados automaticamente (no nosso caso - </font></font><code>gender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mas o c√≥digo para exclu√≠-los </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o </font><font style="vertical-align: inherit;">√© </font><font style="vertical-align: inherit;">gerado. </font><font style="vertical-align: inherit;">Se voc√™ aplicar, reverter e aplicar a migra√ß√£o novamente, isso causar√° um erro porque o tipo de dados especificado j√° existe.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exclua o tipo de dados de g√™nero no m√©todo de downgrade</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic <span class="hljs-keyword">import</span> op
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Enum<font></font>
<font></font>
GenderType = Enum(<span class="hljs-string">'female'</span>, <span class="hljs-string">'male'</span>, name=<span class="hljs-string">'gender'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upgrade</span>():</span><font></font>
    ...<font></font>
    <span class="hljs-comment">#      GenderType   </span>
    op.create_table(<span class="hljs-string">'citizens'</span>, ...,<font></font>
                    Column(<span class="hljs-string">'gender'</span>, GenderType, nullable=<span class="hljs-literal">False</span>))<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
    op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
<font></font>
    <span class="hljs-comment">#       </span>
    GenderType.drop(op.get_bind())</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No m√©todo, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">algumas a√ß√µes podem √†s vezes ser removidas (se excluirmos a tabela inteira, voc√™ n√£o poder√° excluir seus √≠ndices separadamente):</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por exemplo</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
op.drop_table(<span class="hljs-string">'relations'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      citizens,    </span>
<span class="hljs-comment">#    </span>
op.drop_index(op.f(<span class="hljs-string">'ix__citizens__town'</span>), table_name=<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'imports'</span>)</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando a migra√ß√£o est√° fixa e pronta, aplicamos:</font></font><br>
<br>
<pre><code class="bash hljs">$ analyzer-db upgrade head<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.runtime.migration] Running upgrade  -&gt; d5f704ed4610, Initial</code></pre><br>
<a name="application"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inscri√ß√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de come√ßar a criar manipuladores, voc√™ deve configurar o aplicativo aiohttp.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ observar o in√≠cio r√°pido do aiohttp, poder√° escrever algo como isto</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    logging.basicConfig(level=logging.DEBUG)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = web.Application()<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app.router.add_route(...)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    web.run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este c√≥digo levanta uma s√©rie de perguntas e possui v√°rias desvantagens:</font></font><br>
<br>
<ul>
<li> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como configurar o aplicativo? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No m√≠nimo, voc√™ deve especificar o host e a porta para conectar clientes, al√©m de informa√ß√µes para conectar-se ao banco de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gosto muito de resolver esse problema com a ajuda do m√≥dulo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>ConfigArgParse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: ele estende o padr√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>argparse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e permite o uso de argumentos de linha de comando, vari√°veis ‚Äã‚Äãde ambiente (indispens√°veis ‚Äã‚Äãpara a configura√ß√£o de cont√™ineres do Docker) e at√© arquivos de configura√ß√£o (al√©m de combinar esses m√©todos) para a configura√ß√£o. </font><font style="vertical-align: inherit;">Com </font></font><code>ConfigArgParse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ele, voc√™ tamb√©m pode validar os valores dos par√¢metros de configura√ß√£o do aplicativo.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um exemplo de processamento de par√¢metros usando ConfigArgParse</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser, ArgumentDefaultsHelpFormatter<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.argparse <span class="hljs-keyword">import</span> positive_int<font></font>
<font></font>
parser = ArgumentParser(<font></font>
    <span class="hljs-comment">#        ANALYZER_,</span>
    <span class="hljs-comment">#  ANALYZER_API_ADDRESS  ANALYZER_API_PORT</span>
    auto_env_var_prefix=<span class="hljs-string">'ANALYZER_'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#     </span><font></font>
    formatter_class=ArgumentDefaultsHelpFormatter<font></font>
)<font></font>
<font></font>
parser.add_argument(<span class="hljs-string">'--api-address'</span>, default=<span class="hljs-string">'0.0.0.0'</span>,<font></font>
                    help=<span class="hljs-string">'IPv4/IPv6 address API server would listen on'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
parser.add_argument(<span class="hljs-string">'--api-port'</span>, type=positive_int, default=<span class="hljs-number">8081</span>,<font></font>
                    help=<span class="hljs-string">'TCP port API server would listen on'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#   ,     </span>
    <span class="hljs-comment">#  ,    </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#       </span><font></font>
    app = web.Application()<font></font>
    web.run_app(app, host=args.api_address, port=args.api_port)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div><br>
, <code>ConfigArgParse</code>,   <code>argparse</code>,           (     <code>-h</code>  <code>--help</code>).       :<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python __main__.py --<span class="hljs-built_in">help</span><font></font>
usage: __main__.py [-h] [--api-address API_ADDRESS] [--api-port API_PORT]<font></font>
<font></font>
If an arg is specified <span class="hljs-keyword">in</span> more than one place, <span class="hljs-keyword">then</span> commandline values override environment variables <span class="hljs-built_in">which</span> override defaults.<font></font>
<font></font>
optional arguments:<font></font>
  -h, --<span class="hljs-built_in">help</span>            show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span><font></font>
  --api-address API_ADDRESS<font></font>
                        IPv4/IPv6 address API server would listen on [env var: ANALYZER_API_ADDRESS] (default: 0.0.0.0)<font></font>
  --api-port API_PORT   TCP port API server would listen on [env var: ANALYZER_API_PORT] (default: 8081)</code></pre></div>
                    </div></li>
<li>             ‚Äî ,    ¬´¬ª     .          ,  <strong>     </strong>. <br>
<br>
    <code>os.environ.clear()</code>,  Python            (,      <code>asyncio</code>?),        ,   <code>ConfigArgParser</code>.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Callable
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
ENV_VAR_PREFIX = <span class="hljs-string">'ANALYZER_'</span><font></font>
<font></font>
parser = ArgumentParser(auto_env_var_prefix=ENV_VAR_PREFIX)<font></font>
parser.add_argument(<span class="hljs-string">'--pg-url'</span>, type=URL, default=URL(DEFAULT_PG_URL),<font></font>
                   help=<span class="hljs-string">'URL to use to connect to the database'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_environ</span>(<span class="hljs-params">rule: Callable</span>):</span>
    <span class="hljs-string">"""
      ,     
     rule
    """</span>
    <span class="hljs-comment">#   os.environ    tuple,    </span>
    <span class="hljs-comment"># os.environ   </span>
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> filter(rule, tuple(os.environ)):<font></font>
        os.environ.pop(name)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#      ANALYZER_</span>
    clear_environ(<span class="hljs-keyword">lambda</span> i: i.startswith(ENV_VAR_PREFIX))<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = create_app(args)<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li> <strong>   stderr/      .</strong><br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> 9</a> ,    <code>logging.basicConfig()</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>   stderr</code></a>.<br>
<br>
       ,       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>   aiomisc.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    aiomisc</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiomisc.log <span class="hljs-keyword">import</span> basic_config<font></font>
<font></font>
basic_config(logging.DEBUG, buffered=<span class="hljs-literal">True</span>)    
</code></pre></div>
                    </div></li>
<li> <strong>  ,     </strong>    ?    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>fork</code></a>     ,           (,  Windows   ).<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv<font></font>
<font></font>
<span class="hljs-keyword">import</span> forklib
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket
<span class="hljs-keyword">from</span> setproctitle <span class="hljs-keyword">import</span> setproctitle<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8081</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
    setproctitle(<span class="hljs-string">f'[Master] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span>():</span>
        setproctitle(<span class="hljs-string">f'[Worker] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
        app = Application()<font></font>
        run_app(app, sock=sock)<font></font>
<font></font>
    forklib.fork(os.cpu_count(), worker, auto_restart=<span class="hljs-literal">True</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()<font></font>
</code></pre></div>
                    </div></li>
<li>    <strong>   -    </strong>?  ,      (   ‚Äî    )    ,      <code>nobody</code>.      ‚Äî     .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> pwd<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8085</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
<font></font>
    user = pwd.getpwnam(<span class="hljs-string">'nobody'</span>)<font></font>
    os.setgid(user.pw_gid)<font></font>
    os.setuid(user.pw_uid)<font></font>
<font></font>
    app = create_app(...)<font></font>
    run_app(app, sock=sock)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li>            <code>create_app</code>,         .</li>
</ul><br>
<a name="serialization"></a><h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas as respostas bem-sucedidas do manipulador ser√£o retornadas no formato JSON. </font><font style="vertical-align: inherit;">Tamb√©m seria conveniente que os clientes recebessem informa√ß√µes sobre erros em um formato serializado (por exemplo, para ver quais campos n√£o passaram na valida√ß√£o). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A documenta√ß√£o </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oferece um m√©todo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://docs.aio"><code>json_response</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que pega um objeto, o serializa em JSON e retorna um novo objeto </font></font><code>aiohttp.web.Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com um cabe√ßalho </font></font><code>Content-Type: application/json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e dados serializados.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como serializar dados usando json_response</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, View, run_app
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> json_response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> json_response({<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas h√° outra maneira: o aiohttp permite registrar um serializador arbitr√°rio para um tipo espec√≠fico de dados de resposta no registro </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Por exemplo, voc√™ pode especificar um serializador </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para objetos do tipo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapeamento</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste caso, ser√° suficiente para o manipulador para retornar um objeto </font></font><code>Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com os dados de resposta no par√¢metro </font></font><code>body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O aiohttp encontrar√° um serializador que corresponda ao tipo de dados e serialize a resposta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m do fato de a serializa√ß√£o de objetos ser descrita em um s√≥ lugar, essa abordagem tamb√©m √© mais flex√≠vel - permite implementar solu√ß√µes muito interessantes (consideraremos um dos casos de uso no manipulador </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como serializar dados usando aiohttp.PAYLOAD_REGISTRY</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> MappingProxyType
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Mapping<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> PAYLOAD_REGISTRY, JsonPayload
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app, Application, Response, View<font></font>
<font></font>
PAYLOAD_REGISTRY.register(JsonPayload, (Mapping, MappingProxyType))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> Response(body={<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â importante entender que </font></font><code>json_response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, assim </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, eles usam um </font><font style="vertical-align: inherit;">m√©todo </font><font style="vertical-align: inherit;">padr√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>json.dumps</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que n√£o pode serializar tipos de dados complexos, por exemplo, </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou </font></font><code>asyncpg.Record</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>asyncpg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorna registros do banco de dados como inst√¢ncias desta classe). </font><font style="vertical-align: inherit;">Al√©m disso, alguns objetos complexos podem conter outros: em um registro do banco de dados pode haver um campo de tipo </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os desenvolvedores de Python resolveram esse problema: o m√©todo </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite que voc√™ use o argumento </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para especificar uma fun√ß√£o que √© chamada quando √© necess√°rio serializar um objeto desconhecido. </font><font style="vertical-align: inherit;">A fun√ß√£o deve converter um objeto desconhecido em um tipo que pode serializar o m√≥dulo json.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como estender o JsonPayload para serializar objetos arbitr√°rios</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial, singledispatch
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Any<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.payload <span class="hljs-keyword">import</span> JsonPayload <span class="hljs-keyword">as</span> BaseJsonPayload
<span class="hljs-keyword">from</span> aiohttp.typedefs <span class="hljs-keyword">import</span> JSONEncoder<font></font>
<font></font>
<span class="hljs-meta">@singledispatch</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert</span>(<span class="hljs-params">value</span>):</span>
    <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">f'Unserializable value: <span class="hljs-subst">{value!r}</span>'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(Record)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_asyncpg_record</span>(<span class="hljs-params">value: Record</span>):</span>
    <span class="hljs-string">"""
        , 
    asyncpg
    """</span>
    <span class="hljs-keyword">return</span> dict(value)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(date)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_date</span>(<span class="hljs-params">value: date</span>):</span>
    <span class="hljs-string">"""
       date      ‚Äî  
      .     
      ..
    """</span>
    <span class="hljs-keyword">return</span> value.strftime(<span class="hljs-string">'%d.%m.%Y'</span>)<font></font>
    <font></font>
 <font></font>
dumps = partial(json.dumps, default=convert)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JsonPayload</span>(<span class="hljs-params">BaseJsonPayload</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,
                 value: Any,
                 encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 dumps: JSONEncoder = dumps,
                 *args: Any,
                 **kwargs: Any</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        super().__init__(value, encoding, content_type, dumps, *args, **kwargs)</code></pre></div>
                    </div><br>
<a name="handlers"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipuladores</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
o aiohttp permite implementar manipuladores com fun√ß√µes e classes ass√≠ncronas. </font><font style="vertical-align: inherit;">As classes s√£o mais extens√≠veis: em primeiro lugar, o c√≥digo pertencente a um manipulador pode ser colocado em um √∫nico local e, em segundo lugar, as classes permitem que voc√™ use a heran√ßa para se livrar da duplica√ß√£o de c√≥digo (por exemplo, cada manipulador requer uma conex√£o com o banco de dados).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Classe base do manipulador</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_urldispatcher <span class="hljs-keyword">import</span> View
<span class="hljs-keyword">from</span> asyncpgsa <span class="hljs-keyword">import</span> PG<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseView</span>(<span class="hljs-params">View</span>):</span><font></font>
    URL_PATH: str<font></font>
<font></font>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pg</span>(<span class="hljs-params">self</span>) -&gt; PG:</span>
        <span class="hljs-keyword">return</span> self.request.app[<span class="hljs-string">'pg'</span>]
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como √© dif√≠cil ler um arquivo grande, decidi dividir os manipuladores em arquivos. </font><font style="vertical-align: inherit;">Arquivos pequenos incentivam a conectividade fraca e, se, por exemplo, houver importa√ß√µes de anel dentro de manipuladores, isso significa que algo pode estar errado com a composi√ß√£o das entidades.</font></font><br>
<br>
<a name="imports_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importa√ß√µes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manipulador de entrada recebe json com dados sobre residentes. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O tamanho m√°ximo permitido da solicita√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no aiohttp √© controlado pela op√ß√£o </font></font><code>client_max_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://docs.aiohttp.org/en/stable/web_reference.html&amp;usg=ALkJrhjppQ24uj8YUSKLWguKSVpYnztRDw#aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tem 2 MB por padr√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Se o limite for excedido, aiohttp retornar√° uma resposta HTTP com o status 413: Solicitar erro muito grande da entidade. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, o json correto com as linhas e os n√∫meros mais longos pesar√° ~ 63 megabytes, portanto, as restri√ß√µes no tamanho da solicita√ß√£o precisam ser expandidas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, voc√™ precisa </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verificar e desserializar os dados</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Se estiverem incorretos, voc√™ precisar√° retornar uma resposta HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu precisava de dois esquemas </font></font><code>Marhsmallow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O primeiro </font></font><code>CitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, verifica os dados de cada residente individual e tamb√©m desserializa a sequ√™ncia de feliz anivers√°rio no objeto </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipo de dados, formato e disponibilidade de todos os campos obrigat√≥rios;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Falta de campos desconhecidos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A data de nascimento deve ser indicada no formato </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e n√£o pode ter qualquer significado no futuro;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A lista de parentes de cada residente deve conter identificadores exclusivos de residentes existentes neste upload.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo esquema </font></font><code>ImportSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,, verifica a descarga como um todo:</font></font><br>
<br>
<ul>
<li><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cada residente na descarga deve ser √∫nico;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os la√ßos familiares devem ser de m√£o dupla (se o residente n¬∫ 1 tiver um residente n¬∫ 2 na lista de parentes, o residente n¬∫ 2 tamb√©m dever√° ter um n¬∫ 1 relativo).</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se os dados estiverem corretos, eles dever√£o ser adicionados ao banco de dados</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com um novo e exclusivo </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para adicionar dados, voc√™ precisa executar v√°rias consultas em tabelas diferentes. </font><font style="vertical-align: inherit;">Para evitar dados parcialmente parcialmente adicionados ao banco de dados em caso de erro ou exce√ß√£o (por exemplo, ao desconectar um cliente que n√£o recebeu uma resposta completa, o aiohttp </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=http://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lan√ßar√° uma exce√ß√£o CancelledError</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voc√™ deve usar uma transa√ß√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â necess√°rio adicionar dados √†s tabelas em partes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pois em uma consulta ao PostgreSQL n√£o pode haver mais que 32.767 argumentos. </font><font style="vertical-align: inherit;">Existem </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 campos </font><font style="vertical-align: inherit;">na tabela </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Portanto, para uma consulta, apenas 32.767 / 9 = 3.640 linhas podem ser inseridas nessa tabela e em um upload pode haver at√© 10.000 habitantes.</font></font><br>
<br>
<a name="citizens_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidad√£o</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manipulador retorna todos os residentes para descarregar com o especificado </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Se o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">upload</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> especificado </font><b><font style="vertical-align: inherit;">n√£o existir</font></b><font style="vertical-align: inherit;"> , voc√™ dever√° retornar a resposta HTTP 404: N√£o Encontrado. </font><font style="vertical-align: inherit;">Esse comportamento parece ser comum para manipuladores que precisam de um descarregamento existente, por isso puxei o c√≥digo de verifica√ß√£o para uma classe separada.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Classe base para manipuladores com descarregamentos</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_exceptions <span class="hljs-keyword">import</span> HTTPNotFound
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, exists<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> imports_table<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseImportView</span>(<span class="hljs-params">BaseView</span>):</span>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">import_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> int(self.request.match_info.get(<span class="hljs-string">'import_id'</span>))<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_import_exists</span>(<span class="hljs-params">self</span>):</span><font></font>
        query = select([<font></font>
            exists().where(imports_table.c.import_id == self.import_id)<font></font>
        ])<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">await</span> self.pg.fetchval(query):
            <span class="hljs-keyword">raise</span> HTTPNotFound()
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para obter uma lista de parentes para cada residente, voc√™ precisar√° executar </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de tabela </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em tabela </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, agregando o campo </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agrupado por </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o residente n√£o tiver parentes, ele </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornar√° o </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor </font><font style="vertical-align: inherit;">para ele no campo </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e, como resultado da agrega√ß√£o, a lista de parentes ser√° semelhante </font></font><code>[NULL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para corrigir esse valor incorreto, usei a fun√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_remove</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O banco de dados armazena a data em um formato </font></font><code>YYYY-MM-DD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas precisamos de um formato </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tecnicamente, voc√™ pode formatar a data com uma consulta SQL ou no lado Python no momento de serializar a resposta com </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(asyncpg retorna o valor do campo </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como uma inst√¢ncia da classe</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu escolhi a serializa√ß√£o no lado do Python, pois ele </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© o √∫nico objeto </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no projeto com um √∫nico formato (consulte a se√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúSerializando dados‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apesar de o processador executar duas solicita√ß√µes (verificar a exist√™ncia de uma descarga e uma solicita√ß√£o de uma lista de residentes), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o √© necess√°rio usar uma transa√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por padr√£o, o PostgreSQL usa o n√≠vel de isolamento </font></font><code>READ COMMITTED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font><font style="vertical-align: inherit;">, </font><font style="vertical-align: inherit;">mesmo em uma transa√ß√£o, todas as altera√ß√µes em outras transa√ß√µes conclu√≠das com sucesso ser√£o vis√≠veis (adicionando novas linhas, alterando as existentes).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O maior upload em uma exibi√ß√£o de texto pode levar ~ 63 megabytes - isso √© bastante, especialmente considerando que v√°rias solicita√ß√µes para recebimento de dados podem chegar ao mesmo tempo. </font><font style="vertical-align: inherit;">Existe uma maneira bastante interessante </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de obter dados do banco de dados usando o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e envi√°-los ao cliente em partes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, precisamos implementar dois objetos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um objeto de </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tipo </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que retorna registros do banco de dados. </font><font style="vertical-align: inherit;">Na primeira chamada, ele se conecta ao banco de dados, abre uma transa√ß√£o e cria um cursor; durante uma itera√ß√£o adicional, ele retorna registros do banco de dados. </font><font style="vertical-align: inherit;">√â retornado pelo manipulador.</font></font><br>
 <br>
 <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo SelectQuery</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> AsyncIterable
<span class="hljs-keyword">from</span> asyncpgsa.transactionmanager <span class="hljs-keyword">import</span> ConnectionTransactionContextManager
<span class="hljs-keyword">from</span> sqlalchemy.sql <span class="hljs-keyword">import</span> Select<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelectQuery</span>(<span class="hljs-params">AsyncIterable</span>):</span>
    <span class="hljs-string">"""
    ,     PostgreSQL   
    ,  ,    
    """</span>
    PREFETCH = <span class="hljs-number">500</span><font></font>
<font></font>
    __slots__ = (<font></font>
        <span class="hljs-string">'query'</span>, <span class="hljs-string">'transaction_ctx'</span>, <span class="hljs-string">'prefetch'</span>, <span class="hljs-string">'timeout'</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, query: Select,
                 transaction_ctx: ConnectionTransactionContextManager,
                 prefetch: int = None,
                 timeout: float = None</span>):</span><font></font>
        self.query = query<font></font>
        self.transaction_ctx = transaction_ctx<font></font>
        self.prefetch = prefetch <span class="hljs-keyword">or</span> self.PREFETCH<font></font>
        self.timeout = timeout<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aiter__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.transaction_ctx <span class="hljs-keyword">as</span> conn:<font></font>
            cursor = conn.cursor(self.query, prefetch=self.prefetch,<font></font>
                                 timeout=self.timeout)<font></font>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
                <span class="hljs-keyword">yield</span> row
</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um serializador </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que pode iterar sobre geradores ass√≠ncronos, serializar dados de um gerador ass√≠ncrono para JSON e enviar dados para clientes em partes. </font><font style="vertical-align: inherit;">√â registrado </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como um serializador de objetos </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo AsyncGenJSONListPayload</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> Payload<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># ,    JSON  asyncpg.Record  datetime.date</span>
dumps = partial(json.dumps, default=convert, ensure_ascii=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncGenJSONListPayload</span>(<span class="hljs-params">Payload</span>):</span>
    <span class="hljs-string">"""
       AsyncIterable,     
     JSON   
    """</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, value, encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 root_object: str = <span class="hljs-string">'data'</span>,
                 *args, **kwargs</span>):</span><font></font>
        self.root_object = root_object<font></font>
        super().__init__(value, content_type=content_type, encoding=encoding,<font></font>
                         *args, **kwargs)<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">self, writer</span>):</span>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<font></font>
            (<span class="hljs-string">'{"%s":['</span> % self.root_object).encode(self._encoding)<font></font>
        )<font></font>
<font></font>
        first = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> self._value:
            <span class="hljs-comment">#      </span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> first:
                <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b','</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                first = <span class="hljs-literal">False</span><font></font>
<font></font>
            <span class="hljs-keyword">await</span> writer.write(dumps(row).encode(self._encoding))<font></font>
<font></font>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b']}'</span>)</code></pre></div>
                    </div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, no manipulador, ser√° poss√≠vel criar um objeto </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, passar uma consulta SQL e uma fun√ß√£o para abrir a transa√ß√£o e retorn√°-lo para </font></font><code>Response body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo do manipulador</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/api/handlers/citizens.py</span>
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> Response
<span class="hljs-keyword">from</span> aiohttp_apispec <span class="hljs-keyword">import</span> docs, response_schema<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.schema <span class="hljs-keyword">import</span> CitizensResponseSchema
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> citizens_table <span class="hljs-keyword">as</span> citizens_t
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> SelectQuery<font></font>
<font></font>
<span class="hljs-keyword">from</span> .query <span class="hljs-keyword">import</span> CITIZENS_QUERY
<span class="hljs-keyword">from</span> .base <span class="hljs-keyword">import</span> BaseImportView<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CitizensView</span>(<span class="hljs-params">BaseImportView</span>):</span>
    URL_PATH = <span class="hljs-string">r'/imports/{import_id:\d+}/citizens'</span><font></font>
<font></font>
<span class="hljs-meta">    @docs(summary='    ')</span>
<span class="hljs-meta">    @response_schema(CitizensResponseSchema())</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">await</span> self.check_import_exists()<font></font>
<font></font>
        query = CITIZENS_QUERY.where(<font></font>
            citizens_t.c.import_id == self.import_id<font></font>
        )<font></font>
        body = SelectQuery(query, self.pg.transaction())<font></font>
        <span class="hljs-keyword">return</span> Response(body=body)
</code></pre></div>
                    </div><br>
<code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ele detecta um </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serializador </font><font style="vertical-align: inherit;">registrado </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para objetos do tipo </font><font style="vertical-align: inherit;">no registro </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Em seguida, o serializador ir√° percorrer o objeto </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e enviar dados para o cliente. Na primeira chamada, o objeto </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recebe uma conex√£o com o banco de dados, abre uma transa√ß√£o e cria um cursor; durante uma itera√ß√£o adicional, ele recebe dados do banco de dados com o cursor e os retorna linha por linha. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa abordagem permite n√£o alocar mem√≥ria para toda a quantidade de dados com cada solicita√ß√£o, mas tem uma peculiaridade: o aplicativo n√£o poder√° retornar o status HTTP correspondente ao cliente se ocorrer um erro (afinal, o status HTTP, os cabe√ßalhos j√° foram enviados ao cliente e os dados est√£o sendo gravados).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando ocorre uma exce√ß√£o, n√£o h√° mais nada a n√£o ser desconectar. </font><font style="vertical-align: inherit;">Uma exce√ß√£o, √© claro, pode ser protegida, mas o cliente n√£o ser√° capaz de entender exatamente qual erro ocorreu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por outro lado, uma situa√ß√£o semelhante pode surgir, mesmo que o processador receba todos os dados do banco de dados, mas a rede pisca enquanto transmite dados para o cliente - ningu√©m est√° seguro disso.</font></font><br>
<br>
<a name="update_citizen_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / importa√ß√µes / $ import_id / cidad√£o / $ citizen_id</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manipulador recebe o identificador da descarga </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o residente </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e o json com os novos dados sobre o residente. </font><font style="vertical-align: inherit;">No caso de um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descarregamento inexistente ou um residente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , uma resposta HTTP deve ser retornada </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dados transmitidos pelo cliente devem ser </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verificados e desserializados</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se estiverem incorretos, voc√™ deve retornar uma resposta HTTP </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eu implementei um esquema de marshmallow </font></font><code>PatchCitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que verifica:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O tipo e formato dos dados para os campos especificados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data de nascimento. </font><font style="vertical-align: inherit;">Ele deve ser especificado em um formato </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e n√£o pode ser significativo no futuro.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma lista de parentes de cada residente. </font><font style="vertical-align: inherit;">Ele deve ter identificadores exclusivos para os residentes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A exist√™ncia dos parentes indicados no campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o pode ser verificada separadamente: se um </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">residente inexistente for </font><font style="vertical-align: inherit;">adicionado √† tabela, o </font><font style="vertical-align: inherit;">PostgreSQL retornar√° um erro </font></font><code>ForeignKeyViolationError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que pode ser processado e o status HTTP pode ser retornado </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qual status deve ser retornado se o cliente enviar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dados incorretos para um residente ou descarregamento inexistente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? √â semanticamente mais correto verificar primeiro a exist√™ncia de um descarregador e um residente (se n√£o houver nenhum, retornar </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) e somente depois se o cliente enviou os dados corretos (se n√£o, retornar </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Na pr√°tica, geralmente √© mais barato verificar os dados primeiro e, somente se estiverem corretos, acessar o banco de dados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ambas as op√ß√µes s√£o aceit√°veis, mas decidi escolher uma segunda op√ß√£o mais barata, pois, em qualquer caso, o resultado da opera√ß√£o √© um erro que n√£o afeta nada (o cliente corrige os dados e tamb√©m descobre que o residente n√£o existe). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se os dados estiverem corretos, √© necess√°rio </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atualizar as informa√ß√µes sobre o residente no banco de dados</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . No manipulador, voc√™ precisar√° fazer v√°rias consultas para tabelas diferentes. Se ocorrer um erro ou exce√ß√£o, as altera√ß√µes no banco de dados devem ser desfeitas, portanto, as </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consultas devem ser executadas em uma transa√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√©todo </font></font><code>PATCH</code> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite transferir apenas alguns campos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para um residente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manipulador deve ser gravado de forma a n√£o falhar ao acessar dados que o cliente n√£o especificou e tamb√©m n√£o executa consultas em tabelas nas quais os dados n√£o foram alterados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o cliente especificou o campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, √© necess√°rio obter uma lista de parentes existentes. Se tiver sido alterado, determine quais registros da tabela </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devem ser exclu√≠dos e quais adicionar, a fim de alinhar o banco de dados com a solicita√ß√£o do cliente. Por padr√£o, o PostgreSQL usa isolamento de transa√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code> READ COMMITTED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Isso significa que, como parte da transa√ß√£o atual, as altera√ß√µes ser√£o vis√≠veis aos registros existentes (e novos) de outras transa√ß√µes conclu√≠das. Isso pode levar a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uma condi√ß√£o de corrida entre solicita√ß√µes competitivas</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que haja uma descarga com os residentes</font></font><code>#1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>#2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>#3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sem parentesco. O servi√ßo recebe duas solicita√ß√µes simult√¢neas para alterar o residente n¬∫ 1: </font></font><code><nobr>{"relatives": [2]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code><nobr>{"relatives": [3]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O aiohttp criar√° dois manipuladores que recebem simultaneamente o estado atual do residente do PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada manipulador n√£o detectar√° um √∫nico relacionamento relacionado e decidir√° adicionar um novo relacionamento com o parente especificado. Como resultado, o residente n¬∫ 1 tem o mesmo campo que os parentes </font></font><code>[2,3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/bk/mz/gobkmzuhzr47rfzgvtygkxb1stm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse comportamento n√£o pode ser chamado de √≥bvio. Espera-se duas op√ß√µes para decidir o resultado da corrida: concluir apenas a primeira solicita√ß√£o e a segunda retornar uma resposta HTTP </font></font><br>
<code>409: Conflict</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(para que o cliente repita a solicita√ß√£o) ou executar solicita√ß√µes sucessivamente (a segunda solicita√ß√£o ser√° processada somente ap√≥s a conclus√£o da primeira). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A primeira op√ß√£o pode ser implementada ativando o modo de isolamento</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>SERIALIZABLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Se durante o processamento da solicita√ß√£o algu√©m j√° conseguiu alterar e confirmar os dados, uma exce√ß√£o ser√° lan√ßada, que poder√° ser processada e o status HTTP correspondente retornado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A desvantagem desta solu√ß√£o - um grande n√∫mero de bloqueios no PostgreSQL, </font></font><code>SERIALIZABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lan√ßar√° uma exce√ß√£o, mesmo que consultas competitivas alterem os registros de residentes de diferentes descarregamentos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ tamb√©m pode usar o mecanismo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bloqueio de recomenda√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Se voc√™ obtiver esse bloqueio </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, solicita√ß√µes competitivas para diferentes descarregamentos poder√£o ser executadas em paralelo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para processar solicita√ß√µes competitivas em um upload, voc√™ pode implementar o comportamento de qualquer uma das op√ß√µes: a fun√ß√£o </font></font><code>pg_try_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tenta obter um bloqueio e</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
retorna o resultado booleano imediatamente (se n√£o foi poss√≠vel obter o bloqueio - uma exce√ß√£o pode ser lan√ßada), mas </font></font><code>pg_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguarda at√© que o </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
recurso fique dispon√≠vel para bloqueio (nesse caso, as solicita√ß√µes ser√£o executadas sequencialmente, decidi por essa op√ß√£o). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, o manipulador deve </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornar as informa√ß√µes atuais sobre o residente atualizado</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Foi poss√≠vel limitar-nos a retornar dados de sua solicita√ß√£o ao cliente (j√° que estamos retornando uma resposta ao cliente, isso significa que n√£o houve exce√ß√µes e todas as solicita√ß√µes foram conclu√≠das com √™xito). Ou - use a palavra-chave RETURNING em consultas que modificam o banco de dados e geram uma resposta a partir dos resultados. Mas essas duas abordagens n√£o nos permitiriam ver e testar o caso com a corrida dos estados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o havia requisitos de alta carga para o servi√ßo, ent√£o decidi solicitar todos os dados sobre o residente novamente e retornar ao cliente um resultado honesto do banco de dados. </font></font><br>
<br>
<a name="citizen_birthdays_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidad√£os / anivers√°rios</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manipulador calcula o n√∫mero de presentes que cada residente da descarga receber√° de seus parentes (primeira ordem). </font><font style="vertical-align: inherit;">O n√∫mero √© agrupado por m√™s para upload com o especificado </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">No caso de um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">upload inexistente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , uma resposta HTTP deve ser retornada </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem duas op√ß√µes de implementa√ß√£o:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenha dados de residentes com parentes no banco de dados e, no lado do Python, agregue dados por m√™s e gere listas para os meses para os quais n√£o h√° dados no banco de dados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compile uma solicita√ß√£o json no banco de dados e adicione stubs para os meses ausentes.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu decidi pela primeira op√ß√£o - visualmente, parece mais compreens√≠vel e suportado. O n√∫mero de anivers√°rios em um determinado m√™s pode ser obtido fazendo </font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">da tabela com la√ßos familiares ( </font></font><code>relations.citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- o residente para quem consideramos o anivers√°rio dos parentes) na tabela </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(contendo a data de nascimento a partir da qual voc√™ deseja obter o m√™s). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os valores do m√™s n√£o devem conter zeros √† esquerda. O m√™s obtido do campo </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usando a fun√ß√£o </font></font><code>date_part</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode conter um zero √† esquerda. Para remov√™-lo, eu realizada </font></font><code>cast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para </font></font><code>integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na consulta SQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apesar de o manipulador precisar atender a duas solicita√ß√µes (verifique a exist√™ncia de descarregamento e obtenha informa√ß√µes sobre anivers√°rios e presentes), uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transa√ß√£o n√£o √© necess√°ria</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por padr√£o, o PostgreSQL usa o modo READ COMMITTED, no qual todos os registros novos (adicionados por outras transa√ß√µes) e os existentes (modificados por outras transa√ß√µes) s√£o vis√≠veis na transa√ß√£o atual depois de conclu√≠dos com √™xito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, se um novo upload for adicionado no momento do recebimento dos dados, ele n√£o afetar√° os existentes. Se, no momento do recebimento dos dados, uma solicita√ß√£o para alterar o residente for atendida, os dados ainda n√£o estar√£o vis√≠veis (se a transa√ß√£o que est√° alterando os dados n√£o tiver sido conclu√≠da) ou a transa√ß√£o ser√° conclu√≠da completamente e todas as altera√ß√µes ser√£o imediatamente vis√≠veis. A integridade obtida do banco de dados n√£o ser√° violada.</font></font><br>
<br>
<a name="town_age_stat_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidades / stat / percentil / idade</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manipulador calcula os percentis 50, 75 e 99 das idades (anos completos) de residentes por cidade na amostra com o import_id especificado. </font><font style="vertical-align: inherit;">No caso de um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">upload inexistente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , uma resposta HTTP deve ser retornada </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apesar de o processador executar duas solicita√ß√µes (verificar a exist√™ncia de descarregamento e obter uma lista de residentes), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o √© necess√°rio usar uma transa√ß√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Existem duas op√ß√µes de implementa√ß√£o:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenha a idade dos residentes no banco de dados, agrupados por cidade e, em seguida, no lado do Python, calcule os percentis usando numpy (que √© especificado como refer√™ncia na tarefa) e arredonde at√© duas casas decimais.</font></font></li>
<li>     PostgreSQL:  percentile_cont     ,             SQL-,  numpy   .</li>
</ol> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda op√ß√£o requer a transfer√™ncia de menos dados entre o aplicativo e o PostgreSQL, mas n√£o possui uma armadilha muito √≥bvia: no PostgreSQL, o arredondamento √© matem√°tico ( </font></font><code>SELECT ROUND(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornos 3) e, em Python - accounting, para o n√∫mero inteiro mais pr√≥ximo ( </font></font><code>round(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retornos 2). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para testar o manipulador, a implementa√ß√£o deve ser a mesma no PostgreSQL e no Python (parece mais f√°cil implementar uma fun√ß√£o com arredondamento matem√°tico no Python). Vale ressaltar que, ao calcular percentis, o numpy e o PostgreSQL podem retornar n√∫meros ligeiramente diferentes, mas, considerando o arredondamento, essa diferen√ßa n√£o ser√° percept√≠vel.</font></font><br>
<br>
<a name="testing"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O que precisa ser verificado nesta aplica√ß√£o? Primeiro, que os manipuladores atendam aos requisitos e executem o trabalho necess√°rio em um ambiente o mais pr√≥ximo poss√≠vel do ambiente de combate. Em segundo lugar, migra√ß√µes que alteram o estado do banco de dados funcionam sem erros. Em terceiro lugar, h√° v√°rias fun√ß√µes auxiliares que tamb√©m podem ser corretamente cobertas por testes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidi usar a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estrutura pytest devido</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √† sua flexibilidade e facilidade de uso. Oferece um mecanismo poderoso para preparar o ambiente para testes - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">equipamentos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , isto √©, funcionam com um decorador</font></font><code>pytest.mark.fixture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cujos nomes podem ser especificados pelo par√¢metro no teste. </font><font style="vertical-align: inherit;">Se o pytest detectar um par√¢metro com um nome de aparelho na anota√ß√£o de teste, ele executar√° esse aparelho e passar√° o resultado no valor desse par√¢metro. </font><font style="vertical-align: inherit;">E se o dispositivo el√©trico for um gerador, o par√¢metro test assumir√° o valor retornado </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e, ap√≥s o t√©rmino do teste, a segunda parte do </font><font style="vertical-align: inherit;">dispositivo ser√° </font><font style="vertical-align: inherit;">executada, o que pode limpar recursos ou fechar conex√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para a maioria dos testes, precisamos de um banco de dados PostgreSQL. </font><font style="vertical-align: inherit;">Para isolar testes um do outro, voc√™ pode criar um banco de dados separado antes de cada teste e exclu√≠-lo ap√≥s a execu√ß√£o.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crie um banco de dados de dispositivo el√©trico para cada teste</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">from</span> sqlalchemy_utils <span class="hljs-keyword">import</span> create_database, drop_database
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
PG_URL = os.getenv(<span class="hljs-string">'CI_ANALYZER_PG_URL'</span>, DEFAULT_PG_URL)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">postgres</span>():</span>
    tmp_name = <span class="hljs-string">'.'</span>.join([uuid.uuid4().hex, <span class="hljs-string">'pytest'</span>])<font></font>
    tmp_url = str(URL(PG_URL).with_path(tmp_name))<font></font>
    create_database(tmp_url)<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#      postgres  -</span>
        <span class="hljs-keyword">yield</span> tmp_url
    <span class="hljs-keyword">finally</span>:<font></font>
        drop_database(tmp_url)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_db</span>(<span class="hljs-params">postgres</span>):</span>
    <span class="hljs-string">"""
     ,  PostgreSQL
    """</span><font></font>
    engine = create_engine(postgres)<font></font>
    <span class="hljs-keyword">assert</span> engine.execute(<span class="hljs-string">'SELECT 1'</span>).scalar() == <span class="hljs-number">1</span>
    engine.dispose()</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O m√≥dulo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sqlalchemy_utils</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fez um √≥timo trabalho nessa tarefa </font><font style="vertical-align: inherit;">, levando em considera√ß√£o os recursos de diferentes bancos de dados e drivers. Por exemplo, o PostgreSQL n√£o permite a execu√ß√£o </font></font><code>CREATE DATABASE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em um bloco de transa√ß√£o. Ao criar um banco de dados, ele </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">converte </font></font><code>psycopg2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(que geralmente executa todas as solicita√ß√µes em uma transa√ß√£o) no modo de confirma√ß√£o autom√°tica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra caracter√≠stica importante: se pelo menos um cliente estiver conectado ao PostgreSQL, o banco de dados n√£o poder√° ser exclu√≠do, mas </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desconectar√° todos os clientes antes de excluir o banco de dados. O banco de dados ser√° exclu√≠do com √™xito, mesmo se algum teste com conex√µes ativas travar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Precisamos do PostgreSQL em diferentes estados: para testar migra√ß√µes, precisamos de um banco de dados limpo, enquanto os manipuladores exigem que todas as migra√ß√µes sejam aplicadas. </font><font style="vertical-align: inherit;">Voc√™ pode alterar programaticamente o estado de um banco de dados usando comandos Alembic, pois eles exigem que o objeto de configura√ß√£o Alembic os chame.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Criar um objeto de configura√ß√£o de Alambique</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> SimpleNamespace<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> make_alembic_config<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alembic_config</span>(<span class="hljs-params">postgres</span>):</span>
    cmd_options = SimpleNamespace(config=<span class="hljs-string">'alembic.ini'</span>, name=<span class="hljs-string">'alembic'</span>,<font></font>
                                  pg_url=postgres, raiseerr=<span class="hljs-literal">False</span>, x=<span class="hljs-literal">None</span>)
    <span class="hljs-keyword">return</span> make_alembic_config(cmd_options)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que os aparelhos </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√™m um par√¢metro </font></font><code>postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">permite n√£o apenas indicar a depend√™ncia do teste em aparelhos, mas tamb√©m as depend√™ncias entre os aparelhos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esse mecanismo permite separar de forma flex√≠vel a l√≥gica e escrever c√≥digos muito concisos e reutiliz√°veis.</font></font><br>
<br>
<a name="testing_handlers"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipuladores</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os manipuladores de teste requerem um banco de dados com tabelas e tipos de dados criados. Para aplicar migra√ß√µes, voc√™ deve chamar programaticamente o comando upgrade Alembic. Para cham√°-lo, voc√™ precisa de um objeto com a configura√ß√£o Alembic, que j√° definimos com acess√≥rios </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O banco de dados com migra√ß√µes parece uma entidade completamente independente e pode ser representado como um dispositivo el√©trico:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic.command <span class="hljs-keyword">import</span> upgrade<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrated_postgres</span>(<span class="hljs-params">alembic_config, postgres</span>):</span>
    upgrade(alembic_config, <span class="hljs-string">'head'</span>)
    <span class="hljs-comment">#  DSN  ,    </span>
    <span class="hljs-keyword">return</span> postgres</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando h√° muitas migra√ß√µes no projeto, seu aplicativo para cada teste pode levar muito tempo. Para acelerar o processo, voc√™ pode </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">criar um banco de dados com migra√ß√µes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uma vez </font><font style="vertical-align: inherit;">e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">us√°-lo como modelo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m do banco de dados para testar manipuladores, voc√™ precisar√° de um aplicativo em execu√ß√£o, bem como de um cliente configurado para trabalhar com esse aplicativo. Para facilitar o teste do aplicativo, coloquei sua cria√ß√£o em uma fun√ß√£o </font></font><code>create_app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que utiliza par√¢metros para execu√ß√£o: um banco de dados, uma porta para a API REST e outros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os argumentos para iniciar o aplicativo tamb√©m podem ser representados como um acess√≥rio separado. Para cri√°-los, voc√™ precisar√° determinar a porta livre para executar o aplicativo de teste e o endere√ßo para o banco de dados tempor√°rio migrado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para determinar a porta livre, usei o equipamento </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do pacote aiomisc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um equipamento padr√£o </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tamb√©m seria bom, mas retorna uma fun√ß√£o para determinar as portas livres, enquanto </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorna imediatamente o n√∫mero da porta. </font><font style="vertical-align: inherit;">Para nosso aplicativo, precisamos determinar apenas uma porta livre, por isso decidi n√£o escrever uma linha de c√≥digo extra com uma chamada </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arguments</span>(<span class="hljs-params">aiomisc_unused_port, migrated_postgres</span>):</span>
    <span class="hljs-keyword">return</span> parser.parse_args(<font></font>
        [<font></font>
            <span class="hljs-string">'--log-level=debug'</span>,
            <span class="hljs-string">'--api-address=127.0.0.1'</span>,
            <span class="hljs-string">f'--api-port=<span class="hljs-subst">{aiomisc_unused_port}</span>'</span>,
            <span class="hljs-string">f'--pg-url=<span class="hljs-subst">{migrated_postgres}</span>'</span><font></font>
        ]<font></font>
    )</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos os testes com manipuladores implicam solicita√ß√µes para a API REST; </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o </font><font style="vertical-align: inherit;">√© </font><font style="vertical-align: inherit;">necess√°rio </font><font style="vertical-align: inherit;">trabalhar diretamente com o aplicativo </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Portanto, criei um equipamento que inicia o aplicativo e, usando a f√°brica, </font></font><code>aiohttp_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cria e retorna um cliente de teste padr√£o conectado ao aplicativo </font></font><code>aiohttp.test_utils.TestClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">api_client</span>(<span class="hljs-params">aiohttp_client, arguments</span>):</span><font></font>
    app = create_app(arguments)<font></font>
    client = <span class="hljs-keyword">await</span> aiohttp_client(app, server_kwargs={
        <span class="hljs-string">'port'</span>: arguments.api_port<font></font>
    })<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> client
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> client.close()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, se voc√™ especificar o dispositivo el√©trico nos par√¢metros de teste </font></font><code>api_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o seguinte acontecer√°:</font></font><br>
<br>
<ol>
<li> <code>postgres</code>    (  <code>migrated_postgres</code>).</li>
<li> <code>alembic_config</code>    Alembic,      (  <code>migrated_postgres</code>).</li>
<li> <code>migrated_postgres</code>   (  <code>arguments</code>).</li>
<li> <code>aiomisc_unused_port</code>    (  <code>arguments</code>).</li>
<li> <code>arguments</code>     (  <code>api_client</code>).</li>
<li> <code>api_client</code>          .</li>
<li> .</li>
<li> <code>api_client</code>     .</li>
<li> <code>postgres</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As lumin√°rias permitem evitar a duplica√ß√£o de c√≥digo, mas al√©m de preparar o ambiente nos testes, h√° outro local em potencial em que haver√° muitas das mesmas solicita√ß√µes de aplicativo de c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Primeiro, ao fazer uma solicita√ß√£o, esperamos obter um determinado status HTTP. Em segundo lugar, se o status corresponder ao esperado, antes de trabalhar com os dados, √© necess√°rio garantir que eles tenham o formato correto. √â f√°cil cometer um erro aqui e escrever um manipulador que fa√ßa os c√°lculos corretos e </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorne o resultado correto, mas n√£o passa na valida√ß√£o autom√°tica devido ao formato de resposta incorreto</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (por exemplo, esque√ßa de envolver a resposta em um dicion√°rio com uma chave </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Todas essas verifica√ß√µes podem ser feitas em um s√≥ lugar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No m√≥dulo</font></font><code>analyzer.testing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eu preparei para cada manipulador uma fun√ß√£o auxiliar que verifica o status do HTTP, bem como o formato de resposta usando o Marshmallow. </font></font><br>
<br>
<a name="test_citizens_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidad√£o</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidi come√ßar com um manipulador que retorna residentes, porque √© muito √∫til para verificar os resultados de outros manipuladores que alteram o estado do banco de dados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intencionalmente, n√£o usei c√≥digo que adiciona dados ao banco de dados do manipulador </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, embora n√£o seja dif√≠cil transform√°-lo em uma fun√ß√£o separada. </font><font style="vertical-align: inherit;">O c√≥digo do manipulador tem a propriedade de alterar e, se houver algum erro no c√≥digo adicionado ao banco de dados, √© poss√≠vel que o teste pare de funcionar como pretendido e implicitamente para os desenvolvedores parem de mostrar erros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para este teste, defini os seguintes conjuntos de dados de teste:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarregando com v√°rios parentes. </font><font style="vertical-align: inherit;">Verifica se, para cada residente, uma lista com identificadores de parentes ser√° formada corretamente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarregando com um morador sem parentes. </font><font style="vertical-align: inherit;">Verifica se o campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© uma lista vazia (devido </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√† consulta SQL, a lista de parentes pode ser igual </font></font><code>[None]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarregando com um residente que √© parente dele mesmo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga vazia. </font><font style="vertical-align: inherit;">Verifica se o manipulador permite adicionar descarregamento vazio e n√£o falha com um erro.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para executar o mesmo teste separadamente em cada upload, usei outro mecanismo pytest muito poderoso - a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parametriza√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esse mecanismo permite agrupar a fun√ß√£o de teste no decorador </font></font><code>pytest.mark.parametrize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e descrever nele quais par√¢metros a fun√ß√£o de teste deve ter para cada caso de teste individual.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como parametrizar um teste</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
datasets = [<font></font>
    <span class="hljs-comment">#    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">3</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   </span><font></font>
    [<font></font>
        generate_citizen(relatives=[])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   ,    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, name=<span class="hljs-string">''</span>, gender=<span class="hljs-string">'male'</span>,<font></font>
                         birth_date=<span class="hljs-string">'17.02.2020'</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    [],<font></font>
]<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.mark.parametrize('dataset', datasets)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_citizens</span>(<span class="hljs-params">api_client, dataset</span>):</span>
    <span class="hljs-string">"""
        4 ,    
    """</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, o teste adicionar√° o upload ao banco de dados e, usando uma solicita√ß√£o ao manipulador, ele receber√° informa√ß√µes sobre os residentes e comparar√° o upload de refer√™ncia com o recebido. Mas como voc√™ compara os residentes? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada residente consiste em campos escalares e um campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- uma lista de identificadores de parentes. Uma lista no Python √© um tipo ordenado e, ao comparar a ordem dos elementos de cada lista, importa, mas ao comparar listas com irm√£os, a ordem n√£o deve importar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ trouxer </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para o conjunto antes da compara√ß√£o, ao compar√°-lo, n√£o funcionar√° para encontrar uma situa√ß√£o em que um dos habitantes do campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tenha duplicatas. Se voc√™ classificar a lista com os identificadores de parentes, isso contornar√° o problema de ordem diferente de identificadores de parentes, mas ao mesmo tempo detectar√° duplicatas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao comparar duas listas com residentes, pode-se encontrar um problema semelhante: tecnicamente, a ordem dos residentes na descarga n√£o √© importante, mas √© importante detectar se h√° dois residentes com os mesmos identificadores em uma descarga e n√£o na outra. </font><font style="vertical-align: inherit;">Portanto, al√©m de organizar a lista com parentes, os parentes de cada residente precisam organizar os residentes em cada descarga. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como a tarefa de comparar residentes surgir√° mais de uma vez, implementei duas fun√ß√µes: uma para comparar dois residentes e a segunda para comparar duas listas com residentes:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comparar residentes</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Iterable, Mapping<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize_citizen</span>(<span class="hljs-params">citizen</span>):</span>
    <span class="hljs-string">"""
         
    """</span>
    <span class="hljs-keyword">return</span> {**citizen, <span class="hljs-string">'relatives'</span>: sorted(citizen[<span class="hljs-string">'relatives'</span>])}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizens</span>(<span class="hljs-params">left: Mapping, right: Mapping</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
      
    """</span>
    <span class="hljs-keyword">return</span> normalize_citizen(left) == normalize_citizen(right)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizen_groups</span>(<span class="hljs-params">left: Iterable, right: Iterable</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
          ,   
      
    """</span>
    left = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> left]<font></font>
    left.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])<font></font>
<font></font>
    right = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> right]<font></font>
    right.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])
    <span class="hljs-keyword">return</span> left == right
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para garantir que esse manipulador n√£o retorne residentes de outras descargas, decidi adicionar uma descarga adicional a um habitante antes de cada teste.</font></font><br>
<br>
<a name="test_imports_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / importa√ß√µes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu defini os seguintes conjuntos de dados para testar o manipulador:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dados corretos, com expectativa de serem adicionados com sucesso ao banco de dados.</font></font></b><br>
 <br>
<ul>
<li>    ( ).<br>
<br>
      .    ,     ,    insert    ,    .</li>
<li>   ( , ).<br>
<br>
,            .<br>
 </li>
<li>    .<br>
<br>
     ,       . :)<br>
 </li>
<li>    <br>
<br>
,  aiohttp             PostgreSQL    32 767  (    ).<br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga vazia </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manipulador deve levar em considera√ß√£o esse caso e n√£o cair, tentando executar uma inser√ß√£o vazia na tabela com os habitantes.</font></font><br>
 </li>
</ul><br>
 </li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dados com erros, espere uma resposta HTTP 400: Solicita√ß√£o incorreta.</font></font></b><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A data de nascimento est√° incorreta (futuro).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citizen_id n√£o √© exclusivo no upload.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um parentesco √© indicado incorretamente (existe apenas de um residente para outro, mas n√£o h√° feedback).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O residente tem um parente inexistente na descarga.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os la√ßos familiares n√£o s√£o √∫nicos.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o processador funcionou com sucesso e os dados foram adicionados, √© necess√°rio adicionar os residentes ao banco de dados e compar√°-los com o descarregamento padr√£o. </font><font style="vertical-align: inherit;">Para obter residentes, usei o manipulador j√° testado </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e, para compara√ß√£o, uma fun√ß√£o </font></font><code>compare_citizen_groups</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="test_update_citizen_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / importa√ß√µes / $ import_id / cidad√£o / $ citizen_id</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A valida√ß√£o dos dados √©, de v√°rias maneiras, semelhante √† descrita no manipulador, </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com algumas exce√ß√µes: existe apenas um residente e o cliente pode passar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apenas os campos que ele deseja</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decidi usar os seguintes conjuntos com dados incorretos para verificar se o manipulador retornar√° uma resposta HTTP </font></font><code>400: Bad request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O campo est√° especificado, mas possui um tipo e / ou formato de dados incorretos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A data de nascimento est√° incorreta (hora futura).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cont√©m um parente que n√£o existe na descarga.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tamb√©m √© necess√°rio verificar se o manipulador atualiza corretamente as informa√ß√µes sobre o residente e seus parentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, crie um upload com tr√™s habitantes, dois dos quais s√£o parentes, e envie uma solicita√ß√£o com novos valores para todos os campos escalares e um novo identificador relativo no campo </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para garantir que o manipulador fa√ßa a distin√ß√£o entre residentes de descarregamentos diferentes antes do teste (e, por exemplo, n√£o altere residentes com os mesmos identificadores de outro descarregamento), criei um descarregamento adicional com tr√™s residentes com os mesmos identificadores.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manipulador deve salvar os novos valores dos campos escalares, adicionar um novo parente especificado e remover o relacionamento com um parente antigo n√£o especificado. </font><font style="vertical-align: inherit;">Todas as mudan√ßas no parentesco devem ser bilaterais. </font><font style="vertical-align: inherit;">N√£o deve haver altera√ß√µes em outras descargas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como esse manipulador pode estar sujeito √†s condi√ß√µes de corrida (isso foi discutido na se√ß√£o Desenvolvimento), adicionei </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dois testes adicionais</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Um reproduz o problema com o estado da corrida (estende a classe do manipulador e remove a trava), o segundo prova que o problema com o estado da corrida n√£o √© reproduzido.</font></font><br>
<br>
<a name="test_citizen_birthdays_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidad√£os / anivers√°rios</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para testar esse manipulador, selecionei os seguintes conjuntos de dados:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma descarga na qual um residente tem um parente em um m√™s e dois parentes em outro.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarregando com um morador sem parentes. </font><font style="vertical-align: inherit;">Verifica se o manipulador n√£o leva isso em considera√ß√£o nos c√°lculos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarga vazia. </font><font style="vertical-align: inherit;">Verifica se o manipulador n√£o falhar√° e retornar√° o dicion√°rio correto com 12 meses na resposta.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descarregando com um residente que √© parente dele mesmo. </font><font style="vertical-align: inherit;">Verifica se um residente comprar√° um presente para o m√™s de seu nascimento.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O manipulador deve retornar todos os meses na resposta, mesmo se n√£o houver anivers√°rios nesses meses. </font><font style="vertical-align: inherit;">Para evitar duplica√ß√£o, criei uma fun√ß√£o para a qual voc√™ pode passar o dicion√°rio para complement√°-lo com valores para meses ausentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para garantir que o manipulador fa√ßa a distin√ß√£o entre residentes de descarregamentos diferentes, adicionei um descarregamento adicional com dois parentes. </font><font style="vertical-align: inherit;">Se o manipulador os usar erroneamente nos c√°lculos, os resultados estar√£o incorretos e o manipulador cair√° com um erro.</font></font><br>
<br>
<a name="test_town_age_stat_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / importa√ß√µes / $ import_id / cidades / stat / percentil / idade</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A peculiaridade desse teste √© que os resultados de seu trabalho dependem da hora atual: a idade dos habitantes √© calculada com base na data atual. </font><font style="vertical-align: inherit;">Para garantir que os resultados do teste n√£o sejam alterados ao longo do tempo, a data atual, as datas de nascimento dos residentes e os resultados esperados devem ser registrados. </font><font style="vertical-align: inherit;">Isso facilitar√° a reprodu√ß√£o de casos at√© iguais. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qual √© a melhor data de corre√ß√£o? </font><font style="vertical-align: inherit;">O manipulador usa a fun√ß√£o PostgreSQL para calcular a idade dos residentes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>AGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que assume o primeiro par√¢metro como a data para a qual √© necess√°rio calcular a idade e o segundo como a data base (definida por uma constante </font></font><code>TownAgeStatView.CURRENT_DATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Substitu√≠mos a data base no manipulador pelo tempo de teste</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@patch('analyzer.api.handlers.TownAgeStatView.CURRENT_DATE', new=CURRENT_DATE)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_ages</span>(<span class="hljs-params">...</span>):</span>
    ...</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para testar o manipulador, selecionei os seguintes conjuntos de dados (para todos os residentes, indiquei uma cidade, porque o manipulador agrega os resultados por cidade):</font></font><br>
<br>
<ul>
<li>   ,      ( ‚Äî    364 ). ,         .</li>
<li>  ,      ( ‚Äî   ).    ‚Äî  ,     ,       1 .</li>
<li> .      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A </font></font><code>numpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">refer√™ncia </font><font style="vertical-align: inherit;">para o c√°lculo de percentis - </font><font style="vertical-align: inherit;">com interpola√ß√£o linear e os resultados da refer√™ncia para o teste que eu calculei para eles. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ tamb√©m precisa arredondar os valores do percentil fracion√°rio para duas casas decimais. Se voc√™ usou o PostgreSQL para arredondar no manipulador e o Python para calcular os dados de refer√™ncia, pode notar que o </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arredondamento no Python 3 e no PostgreSQL pode fornecer resultados diferentes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por exemplo</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs"># Python 3<font></font>
round(2.5)<font></font>
&gt; 2<font></font>
<font></font>
-- PostgreSQL<font></font>
SELECT ROUND(2.5)<font></font>
&gt; 3<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O fato √© que o Python usa arredondamento de banco </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para o par mais pr√≥ximo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e o PostgreSQL </font><font style="vertical-align: inherit;">usa </font><font style="vertical-align: inherit;">matem√°tica (metade). </font><font style="vertical-align: inherit;">Caso os c√°lculos e arredondamentos sejam realizados no PostgreSQL, seria correto usar o arredondamento matem√°tico tamb√©m nos testes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No come√ßo, descrevi conjuntos de dados com datas de nascimento em formato de texto, mas era inconveniente ler um teste nesse formato: cada vez que eu precisava calcular a idade de cada habitante em minha mente para lembrar o que um conjunto de dados espec√≠fico estava verificando. </font><font style="vertical-align: inherit;">√â claro que voc√™ pode se dar bem com os coment√°rios no c√≥digo, mas decidi ir um pouco mais longe e escrevi uma fun√ß√£o </font></font><code>age2date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que permite descrever a data de nascimento na forma de idade: o n√∫mero de anos e dias.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por exemplo, assim</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">age2date</span>(<span class="hljs-params">years: int, days: int = <span class="hljs-number">0</span>, base_date=CURRENT_DATE</span>) -&gt; str:</span><font></font>
    birth_date = copy(base_date).replace(year=base_date.year - years)<font></font>
    birth_date -= timedelta(days=days)<font></font>
    <span class="hljs-keyword">return</span> birth_date.strftime(BIRTH_DATE_FORMAT)<font></font>
<font></font>
<span class="hljs-comment">#    ?  ,     ?</span>
generate_citizen(birth_date=<span class="hljs-string">'17.02.2009'</span>)<font></font>
<font></font>
<span class="hljs-comment">#   11       </span>
generate_citizen(birth_date=age2date(years=<span class="hljs-number">11</span>))
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para garantir que o manipulador fa√ßa a distin√ß√£o entre residentes de descarregamentos diferentes, adicionei um descarregamento adicional a um residente de outra cidade: se o manipulador o usar por engano, uma cidade extra aparecer√° nos resultados e o teste ser√° interrompido.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um fato interessante: quando eu escrevi esse teste em 29 de fevereiro de 2020, de repente parei de gerar descargas com moradores </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">devido a um bug no Faker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2020 √© um ano bissexto, e outros anos que Faker escolheu nem sempre foram bissextos tamb√©m) n√£o era 29 de fevereiro). </font><font style="vertical-align: inherit;">Lembre-se de registrar datas e testar casos de ponta!</font></font></blockquote><br>
<a name="test_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migra√ß√µes</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä primeira vista, o c√≥digo de migra√ß√£o parece √≥bvio e menos propenso a erros. Por que test√°-lo? √â um erro muito perigoso: os erros mais insidiosos das migra√ß√µes podem se manifestar no momento mais inoportuno. Mesmo que eles n√£o estraguem os dados, eles podem causar tempo de inatividade desnecess√°rio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A </font><font style="vertical-align: inherit;">migra√ß√£o </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inicial</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> existente no projeto </font><font style="vertical-align: inherit;">altera a estrutura do banco de dados, mas n√£o altera os dados. Quais erros comuns podem ser protegidos contra essas migra√ß√µes?</font></font><br>
<br>
<ul>
<li>  <code>downgrade</code>           (     ,      ,     ).<br>
<br>
   ,        (--):         ,        ‚Äî    .<br>
 </li>
<li>C   .</li>
<li>    ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A maioria desses erros ser√° detectada pelo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">teste</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">escada</font></a><font style="vertical-align: inherit;"> . Sua id√©ia - para usar uma √∫nica migra√ß√£o, consistentemente realizar os modos </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para cada migra√ß√£o. Esse teste √© suficiente para ser adicionado ao projeto uma vez, n√£o requer apoio e ser√° fiel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas se a migra√ß√£o, al√©m da estrutura, alterasse os dados, seria necess√°rio escrever pelo menos um teste separado, verificando se os dados mudam corretamente no m√©todo </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e retornam ao estado inicial em </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Apenas no caso: um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">projeto com exemplos de teste de diferentes migra√ß√µes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que eu preparei para um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">relat√≥rio sobre Alambique</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no Moscow Python.</font></font><br>
<br>
<a name="build"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montagem</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O artefato final que vamos implantar e que queremos obter como resultado da montagem √© uma imagem do Docker. Para construir, voc√™ deve </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selecionar a imagem base</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com o Python. A imagem oficial </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>python:latest</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pesa ~ 1 GB e, se usada como imagem de base, a imagem com o aplicativo ser√° enorme. Existem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imagens baseadas no Alpine OS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cujo tamanho √© muito menor. Por√©m, com um n√∫mero crescente de pacotes instalados, o tamanho da imagem final aumentar√° e, como resultado, mesmo a imagem coletada com base no Alpine n√£o ser√° t√£o pequena. Eu escolhi o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">snakepacker / python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como a imagem base </font><font style="vertical-align: inherit;">- ele pesa um pouco mais do que as imagens alpinas, mas √© baseado no Ubuntu, que oferece uma grande variedade de pacotes e bibliotecas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra maneira</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduza o tamanho da imagem com o aplicativo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - n√£o inclua na imagem final o compilador, bibliotecas e arquivos com cabe√ßalhos para a montagem, que n√£o s√£o necess√°rios para o funcionamento do aplicativo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para fazer isso, voc√™ pode usar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conjunto de v√°rias etapas do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Docker:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando uma imagem "pesada" </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 1 GB, ~ 500 MB compactado), crie um ambiente virtual, instale todas as depend√™ncias e o pacote de aplicativos nele. </font><font style="vertical-align: inherit;">Esta imagem √© necess√°ria exclusivamente para montagem, pode conter um compilador, todas as bibliotecas e arquivos necess√°rios com cabe√ßalhos.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#   </span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/*</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copiamos o ambiente virtual finalizado em uma imagem "leve" </font></font><code>snakepacker/python:3.8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 100 MB, compactada ~ 50 MB), que cont√©m apenas o int√©rprete da vers√£o exigida do Python. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Importante: em um ambiente virtual, caminhos absolutos s√£o usados, portanto, eles devem ser copiados para o mesmo endere√ßo em que foram montados no cont√™iner do coletor.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#       builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduzir o tempo necess√°rio para construir a imagem</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , os m√≥dulos dependentes do aplicativo podem ser instalados antes de serem instalados no ambiente virtual. </font><font style="vertical-align: inherit;">O Docker os armazenar√° em cache e n√£o ser√° reinstalado se n√£o tiverem sido alterados.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile inteiramente</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">###############      ################</span>
<span class="hljs-comment">#  ‚Äî ¬´¬ª (~1 ,    ~500 )    </span>
<span class="hljs-comment">#    </span>
FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#      pip</span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
RUN /usr/share/python3/app/bin/pip install -U pip<font></font>
<font></font>
<span class="hljs-comment">#   ,  .   </span>
<span class="hljs-comment"># Docker   ,  requirements.txt  </span><font></font>
COPY requirements.txt /mnt/<font></font>
RUN /usr/share/python3/app/bin/pip install -Ur /mnt/requirements.txt<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/* \<font></font>
    &amp;&amp; /usr/share/python3/app/bin/pip check<font></font>
<font></font>
<span class="hljs-comment">###########################   ############################</span>
<span class="hljs-comment">#    ¬´¬ª (~100 ,    ~50 )   Python</span>
FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#         builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para facilitar a montagem, adicionei um comando </font></font><code>make upload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que coleta a imagem do Docker e a carrega no hub.docker.com.</font></font><br>
<br>
<a name="ci"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora que o c√≥digo est√° coberto de testes e podemos criar uma imagem do Docker, √© hora de automatizar esses processos. A primeira coisa que vem √† mente: execute testes para criar solicita√ß√µes de pool e, ao adicionar altera√ß√µes na ramifica√ß√£o principal, colete uma nova imagem do Docker e fa√ßa o upload para o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pacotes do GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , se voc√™ n√£o distribuir a imagem publicamente). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resolvi esse problema com as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a√ß√µes do GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Para isso, foi necess√°rio criar um arquivo YAML em uma pasta </font></font><code>.github/workflows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e descrever nele um fluxo de trabalho (com duas tarefas: </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que eu nomeei </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© executada sempre que o fluxo de trabalho √© iniciado </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servi√ßos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pega um cont√™iner com o PostgreSQL, espera que ele fique dispon√≠vel e √© iniciado </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no cont√™iner </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A tarefa </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© executada apenas se as altera√ß√µes foram adicionadas √† ramifica√ß√£o </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e se a tarefa </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">foi bem-sucedida. </font><font style="vertical-align: inherit;">Ele coleta a distribui√ß√£o de origem pelo cont√™iner </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, depois coleta e carrega a imagem do Docker </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>docker/build-push-action@v1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descri√ß√£o completa do fluxo de trabalho</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">name: CI<font></font>
<font></font>
# Workflow      <font></font>
#   -  master<font></font>
on:<font></font>
  push:<font></font>
    branches: [ master ]<font></font>
  pull_request:<font></font>
    branches: [ master ]<font></font>
<font></font>
jobs:<font></font>
  #       workflow<font></font>
  test:<font></font>
    runs-on: ubuntu-latest<font></font>
<font></font>
    services:<font></font>
      postgres:<font></font>
        image: docker://postgres<font></font>
        ports:<font></font>
          - 5432:5432<font></font>
        env:<font></font>
          POSTGRES_USER: user<font></font>
          POSTGRES_PASSWORD: hackme<font></font>
          POSTGRES_DB: analyzer<font></font>
<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: test<font></font>
        uses: docker://snakepacker/python:all<font></font>
        env:<font></font>
          CI_ANALYZER_PG_URL: postgresql://user:hackme@postgres/analyzer<font></font>
        with:<font></font>
          args: /bin/bash -c "pip install -U '.[dev]' &amp;&amp; pylama &amp;&amp; wait-for-port postgres:5432 &amp;&amp; pytest -vv --cov=analyzer --cov-report=term-missing tests"<font></font>
<font></font>
  #    Docker-  <font></font>
  publish:<font></font>
    #        master<font></font>
    if: github.event_name == 'push' &amp;&amp; github.ref == 'refs/heads/master'<font></font>
    # ,   test   <font></font>
    needs: test<font></font>
    runs-on: ubuntu-latest<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: sdist<font></font>
        uses: docker://snakepacker/python:all<font></font>
        with:<font></font>
          args: make sdist<font></font>
<font></font>
      - name: build-push<font></font>
        uses: docker/build-push-action@v1<font></font>
        with:<font></font>
          username: ${{ secrets.REGISTRY_LOGIN }}<font></font>
          password: ${{ secrets.REGISTRY_TOKEN }}<font></font>
          repository: alvassin/backendschool2019<font></font>
          target: api<font></font>
          tags: 0.0.1, latest<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, ao adicionar altera√ß√µes ao mestre na guia A√ß√µes no GitHub, voc√™ pode ver o in√≠cio dos testes, a montagem e o carregamento da imagem do Docker: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/qx/pm/r5qxpmy7mlttqniibfvxadvzitw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E ao criar uma solicita√ß√£o de pool na ramifica√ß√£o mestre, os resultados da tarefa tamb√©m ser√£o exibidos </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pz/d9/nk/pzd9nkmxq7a75fnlcw2tx37i308.png"><br>
<br>
<a name="deployment"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implantar</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implantar o aplicativo no servidor fornecido, √© necess√°rio instalar o Docker, Docker Compose, iniciar os cont√™ineres com o aplicativo e o PostgreSQL e aplicar as migra√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essas etapas podem ser automatizadas usando o sistema de gerenciamento de configura√ß√£o da Ansible. Est√° escrito em Python, n√£o requer agentes especiais (se conecta diretamente via ssh), usa modelos jinja e permite descrever declarativamente o estado desejado nos arquivos YAML. A abordagem declarativa permite que voc√™ n√£o pense no estado atual do sistema e nas a√ß√µes necess√°rias para levar o sistema ao estado desejado. Todo esse trabalho repousa sobre os ombros dos m√≥dulos Ansible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Ansible permite agrupar tarefas relacionadas logicamente em </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fun√ß√µes</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e reutiliz√°-las. Vamos precisar de dois pap√©is:</font></font><code>docker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(instala e configura o Docker) e </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(instala e configura o aplicativo). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A fun√ß√£o</font></font><code>docker</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adiciona um reposit√≥rio com o Docker ao sistema, instala e configura pacotes </font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Opcionalmente, voc√™ pode definir a API REST para reiniciar automaticamente ap√≥s a reinicializa√ß√£o do servidor. O Ubuntu permite que voc√™ resolva esse problema com a ajuda de um sistema de inicializa√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>systemd</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ele controla unidades que representam v√°rios recursos (daemons, soquetes, pontos de montagem e outros). Para adicionar uma nova unidade ao systemd, voc√™ deve descrever sua configura√ß√£o em um arquivo .service separado e colocar esse arquivo em uma das pastas especiais, por exemplo, em </font></font><code>/etc/systemd/system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Em seguida, a unidade pode ser lan√ßada e ativar o carregamento autom√°tico para ela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pacote</font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">durante a instala√ß√£o, ele criar√° automaticamente um arquivo com a configura√ß√£o da unidade - voc√™ s√≥ precisa garantir que esteja em execu√ß√£o e ligado quando o sistema for iniciado. </font><font style="vertical-align: inherit;">Para o Docker Compose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>  docker-compose@.service</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ser√° criado pelo Ansible. </font><font style="vertical-align: inherit;">O s√≠mbolo </font></font><code>@</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no nome indica ao sistema que a unidade √© um modelo. </font><font style="vertical-align: inherit;">Isso permite que voc√™ inicie o servi√ßo </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com um par√¢metro - por exemplo, com o nome do nosso servi√ßo, que ser√° substitu√≠do em vez de </font></font><code>%i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no arquivo de configura√ß√£o da unidade:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=%i service with docker compose<font></font>
Requires=docker.service<font></font>
After=docker.service<font></font>
<font></font>
[Service]<font></font>
Type=oneshot<font></font>
RemainAfterExit=true<font></font>
WorkingDirectory=/etc/docker/compose/%i<font></font>
ExecStart=/usr/local/bin/docker-compose up -d --remove-orphans<font></font>
ExecStop=/usr/local/bin/docker-compose down<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A fun√ß√£o</font></font><code>analyzer</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gerar√° um arquivo a partir do modelo </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no endere√ßo </font></font><code>/etc/docker/compose/analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, registrar√° o aplicativo como um servi√ßo iniciado automaticamente </font></font><code>systemd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e aplicar√° a migra√ß√£o. </font><font style="vertical-align: inherit;">Quando as fun√ß√µes estiverem prontas, voc√™ precisar√° descrever o manual.</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: Gathering facts<font></font>
  hosts: all<font></font>
  become: yes<font></font>
  gather_facts: yes<font></font>
<font></font>
- name: Install docker<font></font>
  hosts: docker<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - docker<font></font>
<font></font>
- name: Install analyzer<font></font>
  hosts: api<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A lista de hosts, bem como as vari√°veis ‚Äã‚Äãusadas nas fun√ß√µes, podem ser especificadas no arquivo de invent√°rio </font></font><code>hosts.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">[api]<font></font>
130.193.51.154<font></font>
<font></font>
[docker:children]<font></font>
api<font></font>
<font></font>
[api:vars]<font></font>
analyzer_image = alvassin/backendschool2019<font></font>
analyzer_pg_user = user<font></font>
analyzer_pg_password = hackme<font></font>
analyzer_pg_dbname = analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois que todos os arquivos Ansible estiverem prontos, execute-o:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ansible-playbook -i hosts.ini deploy.yml</code></pre><br>
<a name="load_testing"></a><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre o teste de estresse</font></font></b>
                        <div class="spoiler_text">,   ,     .      ,      -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>.     :      ,    ‚Äî   ,         10 . ,         (, ,   CI-):           .<br>
<br>
,     ,      ,        10 .   ?  ,          ,   .  ,     ,       .<br>
<br>
          RPS,      :      . ,    ,     <code>import_id</code>,    <code>POST /imports</code>      .      . <br>
<br>
,       Python 3,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Locust</a>. <br>
<br>
   ,      <code>locustfile.py</code>     <code>locust</code>.         -     .<br>
<br>
 Locust   .    ,        .       <br>
 <code>self.round</code>           .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    locustfile.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># locustfile.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> http <span class="hljs-keyword">import</span> HTTPStatus<font></font>
<font></font>
<span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpLocust, constant, task, TaskSet
<span class="hljs-keyword">from</span> locust.exception <span class="hljs-keyword">import</span> RescheduleTask<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.handlers <span class="hljs-keyword">import</span> (<font></font>
    CitizenBirthdaysView, CitizensView, CitizenView, TownAgeStatView<font></font>
)<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen, generate_citizens, url_for<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnalyzerTaskSet</span>(<span class="hljs-params">TaskSet</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        super().__init__(*args, **kwargs)<font></font>
        self.round = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_dataset</span>(<span class="hljs-params">self</span>):</span><font></font>
        citizens = [<font></font>
            <span class="hljs-comment">#     .   </span>
            <span class="hljs-comment"># PATCH-  relatives    </span>
            <span class="hljs-comment"># ,     - </span>
            <span class="hljs-comment"># (     ,    </span>
            <span class="hljs-comment"># ).</span>
            generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>]),<font></font>
            generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
            *generate_citizens(citizens_num=<span class="hljs-number">9998</span>, relations_num=<span class="hljs-number">1000</span>,<font></font>
                               start_citizen_id=<span class="hljs-number">3</span>)<font></font>
        ]<font></font>
        <span class="hljs-keyword">return</span> {citizen[<span class="hljs-string">'citizen_id'</span>]: citizen <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> citizens}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">request</span>(<span class="hljs-params">self, method, path, expected_status, **kwargs</span>):</span>
        <span class="hljs-keyword">with</span> self.client.request(<font></font>
                method, path, catch_response=<span class="hljs-literal">True</span>, **kwargs<font></font>
        ) <span class="hljs-keyword">as</span> resp:
            <span class="hljs-keyword">if</span> resp.status_code != expected_status:<font></font>
                resp.failure(<span class="hljs-string">f'expected status <span class="hljs-subst">{expected_status}</span>, '</span>
                             <span class="hljs-string">f'got <span class="hljs-subst">{resp.status_code}</span>'</span>)<font></font>
            logging.info(<font></font>
                <span class="hljs-string">'round %r: %s %s, http status %d (expected %d), took %rs'</span>,<font></font>
                self.round, method, path, resp.status_code, expected_status,<font></font>
                resp.elapsed.total_seconds()<font></font>
            )<font></font>
            <span class="hljs-keyword">return</span> resp<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_import</span>(<span class="hljs-params">self, dataset</span>):</span>
        resp = self.request(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/imports'</span>, HTTPStatus.CREATED,<font></font>
                            json={<span class="hljs-string">'citizens'</span>: list(dataset.values())})
        <span class="hljs-keyword">if</span> resp.status_code != HTTPStatus.CREATED:
            <span class="hljs-keyword">raise</span> RescheduleTask
        <span class="hljs-keyword">return</span> resp.json()[<span class="hljs-string">'data'</span>][<span class="hljs-string">'import_id'</span>]<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_citizens</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizensView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_citizen</span>(<span class="hljs-params">self, import_id</span>):</span>
        url = url_for(CitizenView.URL_PATH, import_id=import_id, citizen_id=<span class="hljs-number">1</span>)<font></font>
        self.request(<span class="hljs-string">'PATCH'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/{citizen_id}'</span>,<font></font>
                     json={<span class="hljs-string">'relatives'</span>: [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>)]})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_birthdays</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizenBirthdaysView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/birthdays'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_town_stats</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(TownAgeStatView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/towns/stat/percentile/age'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @task</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">workflow</span>(<span class="hljs-params">self</span>):</span>
        self.round += <span class="hljs-number">1</span><font></font>
        dataset = self.make_dataset()<font></font>
<font></font>
        import_id = self.create_import(dataset)<font></font>
        self.get_citizens(import_id)<font></font>
        self.update_citizen(import_id)<font></font>
        self.get_birthdays(import_id)<font></font>
        self.get_town_stats(import_id)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsiteUser</span>(<span class="hljs-params">HttpLocust</span>):</span><font></font>
    task_set = AnalyzerTaskSet<font></font>
    wait_time = constant(<span class="hljs-number">1</span>)</code></pre></div>
                    </div><br>
 100  c  ,  ,        :<br>
<br>
<img src="https://habrastorage.org/webt/qx/ri/b3/qxrib3jily9gzmexxhupu35tipa.png"><br>
<br>
       ,           ( ‚Äî 95 ,  ‚Äî ).        .<br>
<br>
<img src="https://habrastorage.org/webt/dn/px/fn/dnpxfn5ly7vttziqnnfpvvdsl9g.png"><br>
<br>
      ‚Äî     Ansible       ~20.15  ~20.30    Locust.<br>
<br>
<img src="https://habrastorage.org/webt/om/1e/ok/om1eoknqvzqmyez-plpgykhz8io.png"></div>
                    </div><br>
<a name="whatelse"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que mais pode ser feito?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A cria√ß√£o de perfil do aplicativo mostrou que cerca de um quarto do tempo total de execu√ß√£o da consulta √© gasto na serializa√ß√£o e desserializa√ß√£o de JSON: h√° muitos dados enviados e recebidos do servi√ßo. </font><font style="vertical-align: inherit;">Esses processos podem ser significativamente acelerados usando a biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orjson</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas o servi√ßo precisar√° ser preparado um pouco - </font></font><code>orjson</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o √© um substituto para o m√≥dulo </font></font><code>json</code> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
padr√£o.Em geral, a produ√ß√£o requer v√°rias c√≥pias do servi√ßo para garantir a toler√¢ncia a falhas e lidar com a carga. </font><font style="vertical-align: inherit;">Para gerenciar um grupo de servi√ßos, voc√™ precisa de uma ferramenta que mostre se uma c√≥pia do servi√ßo est√° "ativa". </font><font style="vertical-align: inherit;">Esse problema pode ser resolvido por um manipulador </font></font><code>/health</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que pesquisa todos os recursos necess√°rios para o trabalho, no nosso caso, um banco de dados. </font><font style="vertical-align: inherit;">E se</font></font><code>SELECT 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">executado em menos de um segundo, o servi√ßo est√° ativo. Caso contr√°rio, voc√™ precisa prestar aten√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando um aplicativo trabalha intensivamente com uma rede, o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uvloop</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode aumentar de maneira interessante o desempenho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um fator importante √© a legibilidade do c√≥digo. Um dos meus colegas, Yuri Shikanov, escreveu um m√≥dulo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cinza</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que combina v√°rias ferramentas </font><font style="vertical-align: inherit;">para verifica√ß√£o e execu√ß√£o autom√°ticas de c√≥digo, f√°ceis de adicionar a um </font></font><code>pre-commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gancho Git, configurado com um √∫nico arquivo de configura√ß√£o ou vari√°veis ‚Äã‚Äãde ambiente. Gray permite classificar importa√ß√µes ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isort</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), otimiza express√µes python de acordo com as novas vers√µes da linguagem ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pyupgrade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), adiciona v√≠rgulas no final das chamadas de fun√ß√£o, importa√ß√µes, listas, etc. (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add-trailing-v√≠rgula</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e tamb√©m aspas para um √∫nico formul√°rio ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unificar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<a name="final"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* * *</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso √© tudo para mim: desenvolvemos, cobertos com testes, montamos e implantamos o servi√ßo e tamb√©m realizamos testes de carga.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agradecimentos</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gostaria de expressar minha profunda gratid√£o aos rapazes que se dedicaram a escrever este artigo, revisar o c√≥digo, apresentar minhas id√©ias e coment√°rios: a Maria Zelenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zelma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vladimir Solomatin </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leenr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anastasia Semenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">morkov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yuri Shikanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dizballanze</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mikhail Shushpanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mishush</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pavel Mosein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pavkazzz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e especialmente para Dmitry Orlov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orlovdl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499518/index.html">A videoconfer√™ncia agora √© um mercado e novas tecnologias. Longrid, parte um</a></li>
<li><a href="../pt499522/index.html">–í—Å–µ –Ω–æ–≤–æ–≤–≤–µ–¥–µ–Ω–∏—è Windows 10 2004 (20H1)</a></li>
<li><a href="../pt499524/index.html">Quarkus: atualiza√ß√µes de aplicativos com o helloworld do JBoss EAP Quickstart</a></li>
<li><a href="../pt499528/index.html">Uma ponte matem√°tica "impressionante" que se estende al√©m do Grande Teorema de Fermat</a></li>
<li><a href="../pt499532/index.html">Palavras em n√∫meros: an√°lise de blog gr√°tis habravebinary com Yandex.Metrica</a></li>
<li><a href="../pt499536/index.html">Growbox como um m√©todo de conhecer a si mesmo</a></li>
<li><a href="../pt499540/index.html">Como funciona a renderiza√ß√£o de jogos em 3D: texturiza√ß√£o e filtragem de textura</a></li>
<li><a href="../pt499542/index.html">Top Fakapov Cyan</a></li>
<li><a href="../pt499544/index.html">Aprenda redes neurais no Planilhas Google</a></li>
<li><a href="../pt499546/index.html">Desenvolvimento de firmware para uma c√¢mera de v√≠deo anal√≥gica EVR-Y2022F</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>