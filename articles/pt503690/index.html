<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎎 🗃️ 🧛🏽 Melhores práticas do Kubernetes. Atualização de cluster de tempo de inatividade zero do Kubernetes 👨🏼‍🎤 🔠 👂🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Melhores práticas do Kubernetes. Criando 
 práticas recomendadas para Kubernetes de contêineres pequenos. Organização Kubernetes com o namespace Kuber...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Melhores práticas do Kubernetes. Atualização de cluster de tempo de inatividade zero do Kubernetes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/503690/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Melhores práticas do Kubernetes. Criando </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">práticas recomendadas para Kubernetes de </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">contêineres </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">pequenos. Organização Kubernetes com o namespace Kubernetes </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Best Practices. Teste de viabilidade Kubernetes com testes de prontidão e vida </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Práticas recomendadas de </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Kubernetes </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">. Definindo consultas e limites de </font></a></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recursos Melhores práticas do Kubernetes. Corrigir </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encerrar desativando as práticas recomendadas de Kubernetes. Mapeando serviços externos</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Todo mundo sabe como é bom manter seus aplicativos atualizados. O Kubernetes e o Docker podem facilitar muito o processo de atualização, para que você possa criar um novo contêiner com dependências atualizadas e implantá-lo facilmente. Além de atualizar as dependências do aplicativo, o Kubernetes está atualizando constantemente os recursos e as políticas de segurança.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, os nós de base e a infraestrutura do Kubernetes devem estar atualizados. Nesta série, aprenderemos como o Google Kubernetes Engine pode atualizar facilmente o cluster Kubernetes.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, ao atualizar um cluster, você precisa atualizar os assistentes e nós, e os assistentes devem ser atualizados primeiro. Vamos ver como atualizar os dois elementos usando o Google Kubernetes Engine. Este sistema atualiza automaticamente o assistente à medida que libera pontos. No entanto, como regra, ele não será atualizado para a nova versão, por exemplo, 1.7-1.8, automaticamente. Quando você estiver pronto para atualizar para a nova versão, basta clicar no link Atualizar disponível no console do GKE, após o qual uma caixa de diálogo aparecerá na tela. Ele contém um aviso de que a alteração da versão principal pode levar alguns minutos, durante os quais você não pode editar este cluster, enquanto durante a atualização do assistente, suas implantações e serviços continuarão funcionando normalmente. No entanto, toda a infraestrutura que precisa da API do Kubernetes não funcionará.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o1/q5/uo/o1q5uoo8kjqvi9jrgezw2pvmrwo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso significa que o QPTL e todos os aplicativos que usam a API Kubernetes para obter informações do cluster serão desativados e você não poderá fazer alterações no cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos ver como você pode resolver esse problema atualizando o assistente com zero tempo de inatividade. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6m/un/uc/6munuchpuwh-8_1be6o0bjvdlsm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enquanto o cluster de zonas GKE padrão suporta apenas um assistente, você pode criar clusters regionais que fornecem assistentes de alta disponibilidade com várias zonas. Portanto, ao criar seu cluster, escolha uma opção regional. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seus nós e assistentes serão criados automaticamente em três zonas e os assistentes terão endereços IP com balanceamento de carga. Isso manterá a API do Kubernetes funcionando sem problemas durante a atualização.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao atualizar nós, existem várias estratégias diferentes que você pode usar. Quero focar sua atenção em duas coisas - atualizações sem interrupção e migração usando pools de nós. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A maneira mais fácil de atualizar os nós do Kubernetes é usar a atualização sem interrupção, o mecanismo de atualização padrão que o GKE usa para atualizar seus nós. Funciona da seguinte maneira.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yu/hy/af/yuhyafeiliwyv-mhlkiu9mdpbti.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os nós da versão antiga são desativados um após o outro para que todos os módulos deixem de funcionar neles. Em seguida, esses nós são excluídos e, em vez deles, novos nós da versão atualizada do Kubernetes aparecem um após o outro. Depois que um nó começa a funcionar, o outro continua com o processo de atualização, e isso continua até que todos os nós sejam atualizados. Você pode permitir que o GKE gerencie esse processo ativando a atualização automática de nós no pool de nós, selecionando Ativado. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/2w/jz/vy/2wjzvyfqeymrrmhtabzv4fwu85k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Caso contrário, o painel do GKE avisará quando uma nova atualização estiver disponível. Nesse caso, para executar a atualização, você precisa clicar no link Atualizações automáticas do nó e seguir as instruções.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zi/an/_z/zian_zvgqnwnsetfizdgguuh2pw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, é muito importante garantir que seus pods sejam controlados usando o conjunto de réplicas, um conjunto com estado ou algo semelhante. Em seguida, os lares autônomos não serão reestruturados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Embora as atualizações contínuas sejam bastante fáceis de fazer com o GKE, ainda existem algumas desvantagens. Uma delas é que, quando você atualiza, a capacidade do seu cluster diminui em um nó. Essa desvantagem é facilmente eliminada escalando o conjunto de nós, adicionando capacidade adicional e reduzindo-o após a atualização.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Além disso, a natureza totalmente automatizada das atualizações contínuas facilita a atualização, mas deixa você com menos controle sobre o processo. Se algo der errado e você precisar reverter para a versão antiga, levará um tempo para interromper as atualizações e descartar as alterações que já foram feitas. Vamos ver como você pode usar conjuntos de vários nós para atualizar seu cluster. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dl/rv/wo/dlrvwo1wdrdhzsggce76vokdonu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, em vez de atualizar o pool ativo de nós usando atualizações contínuas, crie um pool de nós completamente novo, aguarde o início de todos os nós e transfira as cargas de trabalho um nó por vez. À medida que você executa esses comandos, você ganha mais controle sobre o processo de migração, enquanto o GKE continua a gerenciar seus nós.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suponha que um cluster Kubernetes consista em 3 máquinas virtuais. Você pode visualizar os nós usando o comando get nodes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xe/z2/r4/xez2r4j71qjxvmvviw0-af-7q5o.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para criar um novo pool de nós chamado pool-two, você precisa usar o comando apropriado, configurando-o exatamente da mesma maneira que o comando para o pool antigo. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mw/me/kl/mwmeklsu7fc4l-zudw9f4a7is2m.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Opcionalmente, você também pode usar a GUI para criar um novo pool de nós. Para obter mais informações, use o link de criação do pool de nós localizado abaixo deste vídeo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se você verificar o número de nós novamente, encontrará três novos nós com o nome do conjunto dois - no entanto, os pods ainda estarão nos nós antigos.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/v8/nb/rm/v8nbrmgfnwaddhn2fn0_wlrba9e.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos movê-los para um novo pool de nós, movendo um nó de cada vez no modo contínuo. Para fazer isso, use o comando cordon para cada nó antigo para protegê-los e impedir a formação de novos lares neles. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v0/iq/5a/v0iq5azeontfui94okav_lgacra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim que todos os nós antigos forem protegidos, a criação de lares será planejada apenas em novos nós. Isso significa que você pode começar a remover os pods dos nós antigos, e o Kubernetes planejará automaticamente criá-los em novos nós. Então você precisa "drenar" cada nó, o que levará à remoção de todas as lareiras no nó.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qy/y7/yb/qyy7ybf-b05k7t28ludwpluo5f0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de fazer isso para um nó, verifique se os novos pods estão prontos e já estão funcionando e depois passe para o próximo nó. Se você teve algum problema durante a migração, execute uncordon para o pool antigo e execute cordon and drain para o novo pool. Nesse caso, os pods serão automaticamente transferidos de volta para o pool antigo. Depois que todos os pods tiverem sido transferidos com segurança, você poderá excluir o pool antigo. Para fazer isso, substitua o pool padrão pelo pool que você deseja excluir.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/n_/vx/f8/n_vxf83r2fw4skngg1ijihr25ly.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Google Kubernetes Engine permite que você mantenha seu cluster Kubernetes atualizado com apenas alguns cliques. Eu recomendo o uso de clusters regionais do GKE para assistentes de alta disponibilidade e atualizações automáticas de nós para garantir atualizações corretas e sem problemas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se você precisar de controle adicional sobre o processo de atualização do nó, poderá fornecer a ajuda de pools, sem abrir mão das vantagens da plataforma de gerenciamento fornecida pelo GKE.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se você não estiver usando o GKE, use o método de atualização sem interrupção ou os nós do conjunto de nós para atualizar os nós do seu cluster. </font><font style="vertical-align: inherit;">Mas lembre-se de que, nesse caso, você precisa adicionar manualmente novos nós ao cluster e executar atualizações críticas por conta própria, o que pode não ser muito simples. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para continuar em breve ...</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/fvpq4jqtuZ8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco de publicidade :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obrigado por ficar com a gente. Você gosta dos nossos artigos? Deseja ver materiais mais interessantes? Ajude-nos fazendo um pedido ou recomendando aos seus amigos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPS baseado em nuvem para desenvolvedores a partir de US $ 4,99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analógico exclusivo de servidores </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">básicos </font></font></a><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">que foi inventado por nós para você: </font></b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Toda a verdade sobre o VPS (KVM) E5-2697 v3 (6 núcleos) 10 GB DDR4 480 GB SSD 1 Gbps de US $ 19 ou como dividir o servidor?</font></a><font style="vertical-align: inherit;"> (as opções estão disponíveis com RAID1 e RAID10, até 24 núcleos e até 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 vezes mais barato no data center Equinix Tier IV em Amsterdã?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Somente nós temos </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 TVs Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV a partir de US $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> na Holanda!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - a partir de US $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leia sobre</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como criar um prédio de infraestrutura. </font><font style="vertical-align: inherit;">classe c usando servidores Dell R730xd E5-2650 v4 que custam 9.000 euros por um centavo?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt503676/index.html">Três projetos nerds para o Geek Pride Day</a></li>
<li><a href="../pt503678/index.html">Vuex quebra o encapsulamento</a></li>
<li><a href="../pt503680/index.html">DBA: em busca de fechaduras voadoras</a></li>
<li><a href="../pt503682/index.html">Snom Exchange A para Z</a></li>
<li><a href="../pt503688/index.html">Joel Spolsky: O que significa ser desenvolvedor de software (prefácio de codificador a desenvolvedor)</a></li>
<li><a href="../pt503696/index.html">Gears of war: quando computadores analógicos mecânicos dominavam o mar</a></li>
<li><a href="../pt503698/index.html">Contabilidade remota - como um benefício comercial</a></li>
<li><a href="../pt503700/index.html">Criando formulários de reação em 2020</a></li>
<li><a href="../pt503702/index.html">Usando dados brutos no Google Analytics na prática</a></li>
<li><a href="../pt503704/index.html">Em vez de 100 lançamentos de aplicativos - um autoteste ou como salvar um engenheiro de controle de qualidade 20 anos de vida</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>