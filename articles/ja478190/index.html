<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🎤 🛶 👒 危険なstdの話:: enable_shared_from_this、またはアンチパターン「ゾンビ」-報告 🤷🏿 ☮️ 🎤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、「ゾンビ」アンチパターンを排除するためのオプションの分析について説明します。これは、最初のパートで説明されています：危険なstdの物語:: enable_shared_from_this、または「ゾンビ」アンチパターン。
 
 前書き
 記事に記載されているすべてのコードは、ブランチの...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>危険なstdの話:: enable_shared_from_this、またはアンチパターン「ゾンビ」-報告</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478190/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、「ゾンビ」アンチパターンを排除するためのオプションの分析について説明します。これは、最初のパートで説明されています：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">危険なstd</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">物語:: enable_shared_from_this、または「ゾンビ」アンチパターン</font></a><font style="vertical-align: inherit;">。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事に記載されているすべてのコード</font><font style="vertical-align: inherit;">は、ブランチの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">公開されて</font><font style="vertical-align: inherit;">います。</font><font style="vertical-align: inherit;">コードはいくつかのC ++ 17の革新を使用します-weak_from_this（）、initステートメントのあるステートメントの場合、おそらく他の何かは小さいです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事の最初の部分の例では、問題のあるコードの発生の連鎖は次のとおりです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">長いプロセスの非同期（非ブロッキング）実行のクラスが考えられます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別個の実行スレッド（std :: thread）を使用して、プロセスを非同期にします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 便宜上、プロセスが機能するために必要なすべてのデータがクラスフィールドに追加されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスデストラクタには、クラスインスタンスが破壊された場合にプロセスを早期に終了する必要があることをスレッドに通知するためのセマフォが用意されています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行スレッドは、クラスインスタンスの有効性を保証する必要があります。これには、強力なリンクshared_from_thisのキャプチャが使用されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スレッドオブジェクトはクラスデータフィールドです。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
循環リンクがあります。</font><font style="vertical-align: inherit;">クラスのインスタンスへのすべての強い参照のより高いビジネスロジックによる破壊は、そのデストラクタの呼び出しにはつながりません。</font><font style="vertical-align: inherit;">開発者にとって予期せず、RAIIに従ってプロセスを途中で終了させようとしても機能しません。</font><font style="vertical-align: inherit;">スレッドは引き続き機能します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（常に）リソースの漏出を検出するのは困難です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未定義の動作（アプリケーションによって異なります）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高レベルのロジック障害（アプリケーションによって異なります）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この状況は解かれます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法が明白、または弱い</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アンチパターン「ゾンビ」の主要な要素の1つは、円形のリンクです。</font><font style="vertical-align: inherit;">これを防ぐための標準的な手法は、std :: weak_ptrを使用することです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドの考え方：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のスレッドで実行されて</font><b><font style="vertical-align: inherit;">いる</font></b><font style="vertical-align: inherit;">ラムダは、shared_from_this（）ではなく、weak_from_this（）をキャプチャする必要があります。</font><font style="vertical-align: inherit;">ゾンビのみを変更し、大規模なリファクタリングは行いません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplezomby</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうだった：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()](){
        <span class="hljs-keyword">while</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは次のようになりました：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([whis = weak_from_this()](){
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">auto</span> shis = whis.lock()) {
            <span class="hljs-keyword">if</span> (shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
                shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));
                <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
            }<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N11SimpleZomby5ZombyE::~Zomby<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コード</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">修正された</font><b><font style="vertical-align: inherit;">ようです</font></b><font style="vertical-align: inherit;"> -ゾンビは正しく停止します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、セマフォは不要になりました（実際には機能していませんでした）。停止する必要があることをフローに通知する機能をstd :: shared_ptrアトミックリンクカウンターに割り当てることができました。</font><font style="vertical-align: inherit;">セマフォの唯一の利点は、runOnce関数の繰り返し呼び出しに対する保護ですが、たとえば、_listenerのチェックにシフトすることもできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セマフォを削除した後：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([whis = weak_from_this()](){
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">auto</span> shis = whis.lock()) {
            <span class="hljs-keyword">if</span> (shis-&gt;_listener) {<font></font>
                shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));
                <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
            }<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、詳しく調べてみると、ラムダの本体では、長い間、長いsleep_for操作が実行されている間は常に、強いリンクが不当に保持されていることが明らかになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような何かが修正されています：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([whis = weak_from_this()](){
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">auto</span> shis = whis.lock()) {
            <span class="hljs-keyword">if</span> (shis-&gt;_listener) {<font></font>
                shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));<font></font>
                shis.reset();<font></font>
                <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
            }<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
またはこのように：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([whis = weak_from_this()](){
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> shis = whis.lock(); shis &amp;&amp; shis-&gt;_listener) {<font></font>
                shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));<font></font>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、次の例に進みますか？</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どんなに！</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでレースがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それを示す最も簡単な方法は、伝票を機密性の高い場所に転送することです。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([whis = weak_from_this()](){
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> shis = whis.lock(); shis &amp;&amp; shis-&gt;_listener) {
<span class="hljs-comment">/*!!!*/</span>         <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
                shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));<font></font>
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">break</span>;<font></font>
            }<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
SimpleZomby is alive!<br>
N11SimpleZomby5ZombyE::~Zomby<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが起こったことです：</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メインスレッド</font></font></th>
<th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゾンビスレッド</font></font></th>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">runOnceを呼び出す</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ラムダ関数のクラスインスタンスへの弱いリンクをキャプチャします</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のスレッドで実行するラムダ関数を開始します</font></font></td>
<td></td>
</tr>
<tr>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果を確認しながらクラスのインスタンスへの強い参照を取得しようとします。</font><font style="vertical-align: inherit;">検証は成功しました</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単一の外部ストロングリンクを破棄します</font></font></td>
<td></td>
</tr>
<tr>
<td></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メッセージをクラスインスタンスデータフィールドに送信します-リスナー</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゾンビは止まりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、それでもまだ手遅れです。破壊されたゾンビからのメッセージが1つありました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションに応じて、この動作は許容可能であるか、予期しない一連のアクションのトリガーとして機能します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データがリスナーに到着するのが予期しないのはなぜですか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ゾンビはフィールドで唯一のプレイヤーではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼が期待するデータの到着には、おそらくさらなる処理（復号化、解析、画面への表示など）が含まれます。ゾンビビジネスロジックが破壊されると、このタイプのデータ処理メカニズムも破壊される可能性があります。破壊されたメカニズムに処理のためのデータを転送すると、未定義の動作が発生する恐れがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、ゾンビからのメッセージは、高レベルの応答を示唆している可能性があります。</font><b><font style="vertical-align: inherit;">「キャンセル」ボタンを</font></b><font style="vertical-align: inherit;">クリックした後、</font><b><font style="vertical-align: inherit;">「</font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功しました」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">というメッセージが表示されてユーザーが喜ぶことはまずありません</font><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステッピングゾンビ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうだった：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SteppingZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SteppingZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()](){
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;resolveDnsName();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;connectTcp();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;establishSsl();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;sendHttpRequest();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;readHttpReply();<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>N13SteppingZomby5ZombyE::resolveDnsName started<br>
N13SteppingZomby5ZombyE::resolveDnsName finished<br>
N13SteppingZomby5ZombyE::connectTcp started<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N13SteppingZomby5ZombyE::connectTcp finished<br>
N13SteppingZomby5ZombyE::establishSsl started<br>
N13SteppingZomby5ZombyE::establishSsl finished<br>
N13SteppingZomby5ZombyE::sendHttpRequest started<br>
N13SteppingZomby5ZombyE::sendHttpRequest finished<br>
N13SteppingZomby5ZombyE::readHttpReply started<br>
N13SteppingZomby5ZombyE::readHttpReply finished<br>
N13SteppingZomby5ZombyE::~Zomby<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のようになりました（不要なセマフォチェックをすぐに削除します）。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SteppingZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SteppingZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([whis = weak_from_this()](){
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> shis = whis.lock(); shis &amp;&amp; shis-&gt;_listener) {<font></font>
            shis-&gt;resolveDnsName();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> shis = whis.lock(); shis &amp;&amp; shis-&gt;_listener) {<font></font>
            shis-&gt;connectTcp();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> shis = whis.lock(); shis &amp;&amp; shis-&gt;_listener) {<font></font>
            shis-&gt;establishSsl();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> shis = whis.lock(); shis &amp;&amp; shis-&gt;_listener) {<font></font>
            shis-&gt;sendHttpRequest();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> shis = whis.lock(); shis &amp;&amp; shis-&gt;_listener) {<font></font>
            shis-&gt;readHttpReply();<font></font>
        }<font></font>
    });<font></font>
}</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>N13SteppingZomby5ZombyE::resolveDnsName started<br>
N13SteppingZomby5ZombyE::resolveDnsName finished<br>
N13SteppingZomby5ZombyE::connectTcp started<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N13SteppingZomby5ZombyE::connectTcp finished<br>
N13SteppingZomby5ZombyE::~Zomby<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SimpleZombyの例のように：</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どうやら</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゾンビを止めることができたようです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">強力なリンクが長すぎます-resolveDnsName、connectTcp、EstablishSsl、sendHttpRequest、readHttpReplyの各関数は、クラスインスタンスの有効な状態を必要とします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">競合状態が存在します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開始されたステップは常に最後まで実行され、常にリスナーに結果を送信しますが</font><font style="vertical-align: inherit;">、ほとんどの場合、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステップ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><b><font style="vertical-align: inherit;">チェーンは</font></b><font style="vertical-align: inherit;">上位のビジネスロジックによって中断される可能性が</font><b><font style="vertical-align: inherit;">あります</font></b><font style="vertical-align: inherit;"> -レースの場合を除いて、外部の強いリンクが破壊された後も次のステップを開始できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスのプライベートメソッドをリファクタリングすると、強力なリンクの保持時間が短縮されますが、競合状態が完全に解消されるわけではありません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boozdedzomby</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうだった：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BoozdedZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"BoozdedZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()]() {
        <span class="hljs-keyword">while</span> (shis &amp;&amp; shis-&gt;_semaphore &amp;&amp; shis-&gt;_listener) {
            <span class="hljs-keyword">auto</span> handler = [shis](<span class="hljs-keyword">auto</span> errorCode) {
                <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; errorCode == boozd::azzio::io_context::error_code::no_error) {
                    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
                    buf &lt;&lt; <span class="hljs-string">"BoozdedZomby has got a fresh data: "</span>;
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> <span class="hljs-keyword">const</span> &amp;elem; : shis-&gt;_buffer)<font></font>
                        buf &lt;&lt; elem &lt;&lt; <span class="hljs-string">' '</span>;<font></font>
                    buf &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
                    shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
                }<font></font>
            };<font></font>
            shis-&gt;_buffer.clear();<font></font>
            shis-&gt;_context.async_read(shis-&gt;_stream, shis-&gt;_buffer, handler);<font></font>
            shis-&gt;_context.run();<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>BoozdedZomby has got a fresh data: 1144108930 101027544 1458777923 1115438165 74243042 <br>
BoozdedZomby has got a fresh data: 143542612 1131570933 <br>
BoozdedZomby has got a fresh data: 893351816 563613512 704877633 <br>
BoozdedZomby has got a fresh data: 1551901393 1399125485 1899894091 937186357 590357944 357571490 <br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
BoozdedZomby has got a fresh data: 1927702196 130060903 1083454666 2118797801 2035308228 824938981 <br>
BoozdedZomby has got a fresh data: 2020739063 1635339425 34075629 <br>
BoozdedZomby has got a fresh data: 2146319451 500782188 1269406752 884936716 892053144 <br>
BoozdedZomby has got a fresh data: 330111137 1723153177 1070477904 <br>
BoozdedZomby has got a fresh data: 343098142 280090412 589673557 889688008 2014119113 388471006 <br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは次のようになりました：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BoozdedZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"BoozdedZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([whis = weak_from_this()]() {
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">auto</span> shis = whis.lock()) {
            <span class="hljs-keyword">if</span> (shis-&gt;_semaphore &amp;&amp; shis-&gt;_listener) {
                <span class="hljs-keyword">auto</span> handler = [whis](<span class="hljs-keyword">auto</span> errorCode) {
                    <span class="hljs-keyword">auto</span> shis = whis.lock();
                    <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; errorCode == boozd::azzio::io_context::error_code::no_error) {
                        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
                        buf &lt;&lt; <span class="hljs-string">"BoozdedZomby has got a fresh data: "</span>;
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> <span class="hljs-keyword">const</span> &amp;elem; : shis-&gt;_buffer)<font></font>
                            buf &lt;&lt; elem &lt;&lt; <span class="hljs-string">' '</span>;<font></font>
                        buf &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
                        shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
                    }<font></font>
                };<font></font>
                shis-&gt;_buffer.clear();<font></font>
                shis-&gt;_context.async_read(shis-&gt;_stream, shis-&gt;_buffer, handler);<font></font>
                shis-&gt;_context.run();<font></font>
            }<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>BoozdedZomby has got a fresh data: 1144108930 101027544 1458777923 1115438165 74243042 <br>
BoozdedZomby has got a fresh data: 143542612 1131570933 <br>
BoozdedZomby has got a fresh data: 893351816 563613512 704877633 <br>
BoozdedZomby has got a fresh data: 1551901393 1399125485 1899894091 937186357 590357944 357571490 <br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
BoozdedZomby has got a fresh data: 1927702196 130060903 1083454666 2118797801 2035308228 824938981 <br>
N12BoozdedZomby5ZombyE::~Zomby<br>
N5boozd5azzio10io_contextE::~io_context<br>
N5boozd5azzio13random_streamE::~random_stream<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゾンビスレッドは、関数boozd :: azzio :: io_context :: run（）を制御します。</font><font style="vertical-align: inherit;">この場合、run（）から戻るまで、データソース、バッファ、およびコールバック関数の有効性を確認する必要があります。</font><font style="vertical-align: inherit;">コールバック関数は、クラスの有効なインスタンスで呼び出されます-つまり、リスナーを使用できるようになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じ欠陥がコードに存在し、それらはより顕著になります。BoozdedZombyは開始された操作を最後まで変更し、外部コードは次の繰り返しのみをキャンセルできます。</font><font style="vertical-align: inherit;">この場合、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドが機能しなかったと言え</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">次の操作ではなく、現在の操作を停止する必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">弱い方法による結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
shared_from_thisのキャプチャーをweak_from_thisのキャプチャーに置き換えるという点でのみゾンビのみの変更：</font></font><br>
<br>
<ul>
<li>      (   ,    );</li>
<li>     (        ,      listener    -).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゾンビが機能するためには、強力なリンクを少なくとも短時間キャプチャする必要があります。現時点では、すべての外部リンクが破壊されても停止することはありません。</font><font style="vertical-align: inherit;">場合によっては、強力なリンクが長時間保持されるため、この方法は実際には適用できなくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オブジェクトの有効性は、作業を続行するための唯一の条件としてはあまり適していません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、レースの問題はゾンビからデータを送信する方法の選択に関連しており、より適切な転送方法を選択するとき、またはより寛容な受信者の存在下で解決できることに注意してください（この問題に戻ります）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドは正直、またはuse_count</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドのアイデア：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> shared_from_this </font><b><font style="vertical-align: inherit;">を</font></b><font style="vertical-align: inherit;">引き続きキャプチャしますが、同時にstd :: shared_ptr :: use_count（）を確認します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜ正直なのか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
weak_from_thisを使用すると、自分の寿命に影響を与えることを拒否するような錯覚が生じます。</font><font style="vertical-align: inherit;">そして、このバージョンでは-自己欺瞞はありません、クラスのインスタンスはまだ</font><font style="vertical-align: inherit;">それ自身の寿命を</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">制御</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">します。</font><font style="vertical-align: inherit;">しかし同時に、外部の強力なリンクがない状況を検出します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplezomby</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうだった：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()](){
        <span class="hljs-keyword">while</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは次のようになりました：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()](){
        <span class="hljs-keyword">while</span> (shis &amp;&amp; shis.use_count() &gt; <span class="hljs-number">1</span> &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N11SimpleZomby5ZombyE::~Zomby<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この変更のプロパティは、weakメソッドのプロパティと正確に一致します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セマフォは終了条件で冗長になりました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゾンビは停止しましたが、競合状態があります（ゾンビストリームでのuse_count（）チェックが成功した場合、最後の外部リンクが破棄された後でもデータが送信されます）。</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステッピングゾンビ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうだった：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SteppingZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SteppingZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()](){
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;resolveDnsName();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;connectTcp();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;establishSsl();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;sendHttpRequest();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;readHttpReply();<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>N13SteppingZomby5ZombyE::resolveDnsName started<br>
N13SteppingZomby5ZombyE::resolveDnsName finished<br>
N13SteppingZomby5ZombyE::connectTcp started<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N13SteppingZomby5ZombyE::connectTcp finished<br>
N13SteppingZomby5ZombyE::establishSsl started<br>
N13SteppingZomby5ZombyE::establishSsl finished<br>
N13SteppingZomby5ZombyE::sendHttpRequest started<br>
N13SteppingZomby5ZombyE::sendHttpRequest finished<br>
N13SteppingZomby5ZombyE::readHttpReply started<br>
N13SteppingZomby5ZombyE::readHttpReply finished<br>
N13SteppingZomby5ZombyE::~Zomby<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは次のようになりました：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SteppingZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SteppingZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()](){
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis.use_count() &gt; <span class="hljs-number">1</span> &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;resolveDnsName();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis.use_count() &gt; <span class="hljs-number">1</span> &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;connectTcp();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis.use_count() &gt; <span class="hljs-number">1</span> &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;establishSsl();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis.use_count() &gt; <span class="hljs-number">1</span> &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;sendHttpRequest();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis.use_count() &gt; <span class="hljs-number">1</span> &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;readHttpReply();<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>N13SteppingZomby5ZombyE::resolveDnsName started<br>
N13SteppingZomby5ZombyE::resolveDnsName finished<br>
N13SteppingZomby5ZombyE::connectTcp started<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N13SteppingZomby5ZombyE::connectTcp finished<br>
N13SteppingZomby5ZombyE::~Zomby<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが弱い方法のようです。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boozdedzomby</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうだった：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BoozdedZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"BoozdedZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()]() {
        <span class="hljs-keyword">while</span> (shis &amp;&amp; shis-&gt;_semaphore &amp;&amp; shis-&gt;_listener) {
            <span class="hljs-keyword">auto</span> handler = [shis](<span class="hljs-keyword">auto</span> errorCode) {
                <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; errorCode == boozd::azzio::io_context::error_code::no_error) {
                    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
                    buf &lt;&lt; <span class="hljs-string">"BoozdedZomby has got a fresh data: "</span>;
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> <span class="hljs-keyword">const</span> &amp;elem; : shis-&gt;_buffer)<font></font>
                        buf &lt;&lt; elem &lt;&lt; <span class="hljs-string">' '</span>;<font></font>
                    buf &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
                    shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
                }<font></font>
            };<font></font>
            shis-&gt;_buffer.clear();<font></font>
            shis-&gt;_context.async_read(shis-&gt;_stream, shis-&gt;_buffer, handler);<font></font>
            shis-&gt;_context.run();<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>BoozdedZomby has got a fresh data: 1144108930 101027544 1458777923 1115438165 74243042 <br>
BoozdedZomby has got a fresh data: 143542612 1131570933 <br>
BoozdedZomby has got a fresh data: 893351816 563613512 704877633 <br>
BoozdedZomby has got a fresh data: 1551901393 1399125485 1899894091 937186357 590357944 357571490 <br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
BoozdedZomby has got a fresh data: 1927702196 130060903 1083454666 2118797801 2035308228 824938981 <br>
BoozdedZomby has got a fresh data: 2020739063 1635339425 34075629 <br>
BoozdedZomby has got a fresh data: 2146319451 500782188 1269406752 884936716 892053144 <br>
BoozdedZomby has got a fresh data: 330111137 1723153177 1070477904 <br>
BoozdedZomby has got a fresh data: 343098142 280090412 589673557 889688008 2014119113 388471006 <br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは次のようになりました：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BoozdedZomby :: Zomby :: runOnce</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"BoozdedZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()]() {
        <span class="hljs-keyword">while</span> (shis &amp;&amp; shis.use_count() &gt; <span class="hljs-number">1</span> &amp;&amp; shis-&gt;_semaphore &amp;&amp; shis-&gt;_listener) {
            <span class="hljs-keyword">auto</span> handler = [&amp;shis;](<span class="hljs-keyword">auto</span> errorCode) {
                <span class="hljs-keyword">if</span> (shis &amp;&amp; shis.use_count() &gt; <span class="hljs-number">1</span> &amp;&amp; shis-&gt;_listener &amp;&amp; errorCode == boozd::azzio::io_context::error_code::no_error) {
                    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
                    buf &lt;&lt; <span class="hljs-string">"BoozdedZomby has got a fresh data: "</span>;
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> <span class="hljs-keyword">const</span> &amp;elem; : shis-&gt;_buffer)<font></font>
                        buf &lt;&lt; elem &lt;&lt; <span class="hljs-string">' '</span>;<font></font>
                    buf &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
                    shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
                }<font></font>
            };<font></font>
            shis-&gt;_buffer.clear();<font></font>
            shis-&gt;_context.async_read(shis-&gt;_stream, shis-&gt;_buffer, handler);<font></font>
            shis-&gt;_context.run();<font></font>
        }<font></font>
    });<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>BoozdedZomby has got a fresh data: 1144108930 101027544 1458777923 1115438165 74243042 <br>
BoozdedZomby has got a fresh data: 143542612 1131570933 <br>
BoozdedZomby has got a fresh data: 893351816 563613512 704877633 <br>
BoozdedZomby has got a fresh data: 1551901393 1399125485 1899894091 937186357 590357944 357571490 <br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N12BoozdedZomby5ZombyE::~Zomby<br>
N5boozd5azzio10io_contextE::~io_context<br>
N5boozd5azzio13random_streamE::~random_stream<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、弱いメソッドよりもはるかに優れています。クラスインスタンスの有効性は、データをリスナーに転送する十分な理由とは見なされず、少なくとも1つの外部の強いリンクの存在も必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメソッドを実装するときは、細心の注意を払う必要があります。ゾンビ内に追加の強力なコピーを作成することは非常に誤りです（現在、shisは値ではなく参照によってコールバック関数にキャプチャされることに注意してください）。</font><font style="vertical-align: inherit;">また、チェックに適した場所を選択する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
競合状態はまだ存在しています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use_countメソッドの出力</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
shared_from_thisキャプチャを保存しながら、use_countチェックを終了条件に追加すると、weakメソッドと比較して無効な状態にアクセスするリスクが軽減されます。</font><font style="vertical-align: inherit;">同時に、ゾンビが上位のビジネスロジックによって破壊された後も、データをリスナーに送信するリスクがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
use_countメソッドとweakメソッドは、データ転送メソッドを適切に調整して実際に使用するのに適しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのような適応は次のようなものです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最終的なリスナーからの信頼できる切断を保証するゾンビプロキシリスナーを提供します（ただし、この方法は単純でもエレガントでもありません。リポジトリの例を見ることができます。fixes/ weak_with_ProxyListenerブランチ）;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qt Signals＆Slotsなどの複雑なシステムの使用（ただし、ここではセキュリティの代わりにセキュリティの幻想を得るのは簡単です）。</font></font></li>
<li>  event-driven    —        ,              . </li>
</ul><br>
<h2> ,  this</h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドの考え方：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> std :: shared_from_thisからの継承</font><b><font style="vertical-align: inherit;">を</font></b><font style="vertical-align: inherit;">拒否します。</font><font style="vertical-align: inherit;">自分の人生の時間を管理することで汚いトリックはありません。</font><font style="vertical-align: inherit;">コードにノードがありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ラムダ関数はこれをキャプチャします。</font><font style="vertical-align: inherit;">スレッドの存続期間は、クラスインスタンスの存続期間と同期されます。</font><font style="vertical-align: inherit;">デストラクタでは、std :: thread :: detach（）の代わりにstd :: thread :: join（）が呼び出されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゾンビが溶けます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
代わりに、疑似非同期クラスが発生します。デストラクタを除いて、そのすべてのメソッドは非ブロッキングです。</font><font style="vertical-align: inherit;">破壊は無期限に継続する可能性があります-非同期のプロパティを与えようとしたプロセスの期間のオーダーです。</font><font style="vertical-align: inherit;">実際には、それは単位または数十秒になる可能性があり、外部要因（HTTP要求への応答のサイズ、ネットワークパケット損失など）に応じて可能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうだった：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Manager.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Listener</span>;</span>
} <span class="hljs-comment">// namespace Common</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Zomby</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> Common::Manager, <span class="hljs-keyword">public</span> <span class="hljs-built_in">std</span>::enable_shared_from_this&lt;Zomby&gt;<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">create</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    ~Zomby() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span> <span class="hljs-keyword">override</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:<font></font>
    Zomby();<font></font>
<font></font>
    <span class="hljs-keyword">using</span> Semaphore = <span class="hljs-built_in">std</span>::atomic&lt;<span class="hljs-keyword">bool</span>&gt;;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; _listener;<font></font>
    Semaphore _semaphore = <span class="hljs-literal">false</span>;
    <span class="hljs-built_in">std</span>::thread _thread;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimpleZomby.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Listener.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">Zomby::create</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt;(<span class="hljs-keyword">new</span> Zomby());<font></font>
}<font></font>
<font></font>
Zomby::Zomby() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
Zomby::~Zomby()<font></font>
{<font></font>
    _semaphore = <span class="hljs-literal">false</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_thread.joinable()) {<font></font>
        _thread.detach();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_listener) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
        _listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()](){
        <span class="hljs-keyword">while</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
        }<font></font>
    });<font></font>
}<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは次のようになりました：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Manager.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Listener</span>;</span>
} <span class="hljs-comment">// namespace Common</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Zomby</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> Common::Manager<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">create</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    ~Zomby() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span> <span class="hljs-keyword">override</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:<font></font>
    Zomby();<font></font>
<font></font>
    <span class="hljs-keyword">using</span> Semaphore = <span class="hljs-built_in">std</span>::atomic&lt;<span class="hljs-keyword">bool</span>&gt;;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; _listener;<font></font>
    Semaphore _semaphore = <span class="hljs-literal">false</span>;
    <span class="hljs-built_in">std</span>::thread _thread;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimpleZomby.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Listener.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">Zomby::create</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt;(<span class="hljs-keyword">new</span> Zomby());<font></font>
}<font></font>
<font></font>
Zomby::Zomby() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
Zomby::~Zomby()<font></font>
{<font></font>
    _semaphore = <span class="hljs-literal">false</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_thread.joinable()) {<font></font>
        _thread.join();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_listener) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
        _listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([<span class="hljs-keyword">this</span>](){
        <span class="hljs-keyword">while</span> (_listener &amp;&amp; _semaphore) {<font></font>
            _listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
        }<font></font>
    });<font></font>
}<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
N11SimpleZomby5ZombyE::~Zomby<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、これまでのところ、ゾンビデストラクタ（実際にはゾンビではありませんが）が</font><font style="vertical-align: inherit;">「</font><font style="vertical-align: inherit;">ゾンビ</font><font style="vertical-align: inherit;">が殺された」の出力の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に呼び出された唯一の例</font><font style="vertical-align: inherit;">です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セマフォは最終的に最初に割り当てられた役割を果たしましたが、_listenerの検証で置き換えることができます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスのインスタンスをstd :: shared_ptrに排他的に格納する必要がなくなり、静的関数create（）を削除して、コンストラクターをクラスのパブリックセクションに移動できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これをラムダ関数に取り込むには、クラスインスタンスをメモリに保持する必要があります。Common:: Managerから継承されたコピーおよび移動のセマンティクスの禁止は依然として重要です。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、SteppingZombyとBoozdedZombyの変更は完全に似ているため、記事にそれらを含めても意味がありません。</font><font style="vertical-align: inherit;">誰にとって興味深いのか-リポジトリの修正/このブランチを見てください。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この方法による結論</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメソッドは、ブロッキングデストラクタを除くすべてのユーザーに適しています。</font><font style="vertical-align: inherit;">GUIスレッドを数秒間ブロックすると、オペレーティングシステムでプロセスがハングしたと見なされる可能性があります。</font><font style="vertical-align: inherit;">この形では、この方法は実際の使用にはほとんど適していない。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">適切なメソッド、またはsemaphore_done_right</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これまでに検討したすべての例で、クラスは、別のスレッドが機能するために必要なデータのアグリゲーターとして使用されました。</font><font style="vertical-align: inherit;">これにより、実行中のスレッドの有効期間を超えて、クラスインスタンスの有効期間を確保する必要が生じました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はい、クラスにデータを集約すると便利です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、これが一連の複雑な問題につながらない場合に限ります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドの考え方：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスとストリーム間の責任</font><b><font style="vertical-align: inherit;">の</font></b><font style="vertical-align: inherit;">正しい分割。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クラスの義務：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ストリームの開始。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デストラクタでセマフォを禁止状態に変換します。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フローチャージ：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セマフォが無効な状態のときは、作業を続行しないでください。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データに基づく通信（共有セマフォを除く）、存続期間の要件はありません（特に、基になるストリームから上にあるクラスへ）。</font><font style="vertical-align: inherit;">ラムダでのクラスインスタンスのキャプチャはありません-生のポインタの形式またはスマートなポインタの形式のいずれか。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
weakメソッドとuse_countメソッドで発生する競合を排除するには、ミューテックスを使用した同期を使用する必要があります。</font><font style="vertical-align: inherit;">デストラクタは、セマフォの値が変更されている間はmutexをキャプチャし、リスナーへのデータ転送操作の間は別のスレッドをキャプチャします。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デストラクタは、スレッドの終了を待たずにstd :: thread :: detach（）を呼び出します（後でこの質問に戻ります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そうだった：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Manager.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Listener</span>;</span>
} <span class="hljs-comment">// namespace Common</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Zomby</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> Common::Manager, <span class="hljs-keyword">public</span> <span class="hljs-built_in">std</span>::enable_shared_from_this&lt;Zomby&gt;<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">create</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    ~Zomby() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span> <span class="hljs-keyword">override</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:<font></font>
    Zomby();<font></font>
<font></font>
    <span class="hljs-keyword">using</span> Semaphore = <span class="hljs-built_in">std</span>::atomic&lt;<span class="hljs-keyword">bool</span>&gt;;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; _listener;<font></font>
    Semaphore _semaphore = <span class="hljs-literal">false</span>;
    <span class="hljs-built_in">std</span>::thread _thread;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimpleZomby.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Listener.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">Zomby::create</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt;(<span class="hljs-keyword">new</span> Zomby());<font></font>
}<font></font>
<font></font>
Zomby::Zomby() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
Zomby::~Zomby()<font></font>
{<font></font>
    _semaphore = <span class="hljs-literal">false</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_thread.joinable()) {<font></font>
        _thread.detach();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_listener) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
        _listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()](){
        <span class="hljs-keyword">while</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
        }<font></font>
    });<font></font>
}<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それは次のようになりました：</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Manager.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Listener</span>;</span>
} <span class="hljs-comment">// namespace Common</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Zomby</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> Common::Manager<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">create</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    ~Zomby() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span> <span class="hljs-keyword">override</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:<font></font>
    Zomby();<font></font>
<font></font>
    <span class="hljs-keyword">using</span> Semaphore = <span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-built_in">std</span>::mutex, <span class="hljs-keyword">bool</span>&gt;;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; _listener;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Semaphore&gt; _semaphore;
    <span class="hljs-built_in">std</span>::thread _thread;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimpleZomby.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Listener.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">Zomby::create</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt;(<span class="hljs-keyword">new</span> Zomby());<font></font>
}<font></font>
<font></font>
Zomby::Zomby() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
Zomby::~Zomby()<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">std</span>::this_thread::get_id() != _thread.get_id()) {
            <span class="hljs-keyword">auto</span> guard = <span class="hljs-built_in">std</span>::lock_guard(_semaphore-&gt;first);<font></font>
            _semaphore-&gt;second = <span class="hljs-literal">false</span>;<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            _semaphore-&gt;second = <span class="hljs-literal">false</span>;<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_thread.joinable()) {<font></font>
        _thread.detach();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_listener) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
        _listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    <span class="hljs-comment">// two separate lines needed because of absence of std::mutex move c-tor</span>
    _semaphore = <span class="hljs-built_in">std</span>::make_shared&lt;Semaphore&gt;();<font></font>
    _semaphore-&gt;second = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([listener, semaphore = _semaphore](){
        <span class="hljs-keyword">while</span> (listener &amp;&amp; semaphore) {<font></font>
            {<font></font>
                <span class="hljs-keyword">auto</span> guard = <span class="hljs-built_in">std</span>::lock_guard(semaphore-&gt;first);
                <span class="hljs-keyword">if</span> (!semaphore-&gt;second) {
                    <span class="hljs-keyword">break</span>;<font></font>
                }<font></font>
                listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));<font></font>
            }<font></font>
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
        }<font></font>
    });<font></font>
}<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
N11SimpleZomby5ZombyE::~Zomby<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SteppingZombyとBoozdedZombyの変更は類似しています（fixs / semaphore_done_rightブランチを参照）-BoozdedZombyクラスの宣言がSimpleZombyクラスの宣言と一致するように類似しており、SteppingZombyには、フリー関数に変換できる追加の静的関数のみがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメソッドのプロパティ：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デストラクタの実行時間は外部要因に依存しなくなりました。mutexの競合のみがあり、処理へのデータ転送の非常に高速な操作を保護しました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ミューテックスを使用した正確な作業により、競合状態を取り除くことができました-デストラクタが完了した後、正しく記述されたラムダ関数がリスナーにデータを送信しないことが保証されます。</font></font></li>
<li>   deadlock'          (       —   );</li>
<li>      std::shared_ptr  ,   create()        public- ;</li>
<li> copy-  move-,   Common::Manager,  ;</li>
<li>listener -     —       ,        ;</li>
<li>     ,     ,      ;</li>
<li>     detached-    .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の点は、次の理由で潜在的に問題があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のスレッドで実行される関数を終了する条件でエラーをマスクします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メインスレッドが完了するまで、別のスレッドが存続する可能性があります。その後、システムによって誤ってクリーンアップされ、初期化解除に失敗します。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後のメソッド、またはsemaphore_done_right_with_ThreadJoiner</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スレッドのdetach（）が問題を引き起こす可能性がある場合は、そのスレッドに対して何らかの</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">処置を行ってください（古いスレッドが完了するのを非同期的に待機する新しいスレッドを開始します</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドのアイデア：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">費やされたスレッドに責任を持つことができる新しいエンティティ（ThreadJoiner）が必要です（おそらく、そのようなエンティティのより適切な名前はThreadSanitizerですが、すでに使用されています）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のサービススレッド内のThreadJoinerは、std :: thread :: join（）が責任を負ったすべてのスレッドに対して順次処理されるのを待ちます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThreadJoinerデストラクタは、担当するすべてのスレッドが完了するまで実行をブロックします。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
抽象インターフェース：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThreadJoiner.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadJoiner</span>
{</span>
<span class="hljs-keyword">public</span>:<font></font>
    ThreadJoiner() = <span class="hljs-keyword">default</span>;<font></font>
    ThreadJoiner(<span class="hljs-keyword">const</span> ThreadJoiner&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ThreadJoiner(ThreadJoiner&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ThreadJoiner&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-keyword">const</span> ThreadJoiner&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ThreadJoiner&amp; <span class="hljs-keyword">operator</span>=(ThreadJoiner&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
<font></font>
    <span class="hljs-keyword">virtual</span> ~ThreadJoiner() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">join</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::thread&amp;&amp;)</span> </span>= <span class="hljs-number">0</span>;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace Common</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定の非同期実装：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThreadJoinerAsync.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;queue&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mutex&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;optional&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;condition_variable&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/ThreadJoiner.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadJoinerAsync</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> ThreadJoiner<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:<font></font>
    ThreadJoinerAsync();<font></font>
    ThreadJoinerAsync(<span class="hljs-keyword">const</span> ThreadJoinerAsync&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ThreadJoinerAsync(ThreadJoinerAsync&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ThreadJoinerAsync&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-keyword">const</span> ThreadJoinerAsync&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ThreadJoinerAsync&amp; <span class="hljs-keyword">operator</span>=(ThreadJoinerAsync&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
<font></font>
    ~ThreadJoinerAsync() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">join</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::thread&amp;&amp;)</span> <span class="hljs-keyword">override</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">using</span> Data = <span class="hljs-built_in">std</span>::<span class="hljs-built_in">queue</span>&lt;<span class="hljs-built_in">std</span>::thread&gt;;
    <span class="hljs-keyword">using</span> Semaphore = <span class="hljs-built_in">std</span>::atomic&lt;<span class="hljs-keyword">bool</span>&gt;;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::mutex _mutex;<font></font>
    Data _data;<font></font>
    Semaphore _semaphore;<font></font>
    <span class="hljs-built_in">std</span>::condition_variable _cv;
    <span class="hljs-built_in">std</span>::thread _thread;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">threadFn</span><span class="hljs-params">()</span></span>;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace Common</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThreadJoinerAsync.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"ThreadJoinerAsync.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {<font></font>
ThreadJoinerAsync::ThreadJoinerAsync()<font></font>
    : _semaphore(<span class="hljs-literal">true</span>)<font></font>
    , _thread(&amp;ThreadJoinerAsync::threadFn, <span class="hljs-keyword">this</span>)<font></font>
{<font></font>
}<font></font>
<font></font>
ThreadJoinerAsync::~ThreadJoinerAsync()<font></font>
{<font></font>
    _semaphore = <span class="hljs-literal">false</span>;<font></font>
    _cv.notify_one();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_thread.joinable()) {<font></font>
        _thread.join();<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ThreadJoinerAsync::join</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::thread&amp;&amp; thread)</span>
</span>{<font></font>
    {<font></font>
        <span class="hljs-keyword">auto</span> lock = <span class="hljs-built_in">std</span>::lock_guard(_mutex);<font></font>
        _data.push(<span class="hljs-built_in">std</span>::move(thread));<font></font>
    }<font></font>
<font></font>
    _cv.notify_one();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ThreadJoinerAsync::threadFn</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">auto</span> lock = <span class="hljs-built_in">std</span>::unique_lock(_mutex);<font></font>
        _cv.wait(lock, [<span class="hljs-keyword">this</span>](){ <span class="hljs-keyword">return</span> !_semaphore || !_data.empty(); });<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (!_semaphore &amp;&amp; _data.empty()) {
            <span class="hljs-keyword">return</span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">auto</span> threadToJoin = <span class="hljs-built_in">std</span>::move(_data.front());<font></font>
        _data.pop();<font></font>
<font></font>
        lock.unlock();<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (threadToJoin.joinable()) {<font></font>
            threadToJoin.join();<font></font>
        }<font></font>
    }<font></font>
}<font></font>
} <span class="hljs-comment">// namespace Common</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SimpleZombyでThreadJoinerを使用する：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Manager.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Listener</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadJoiner</span>;</span>
} <span class="hljs-comment">// namespace Common</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Zomby</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> Common::Manager<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:<font></font>
    Zomby(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::ThreadJoiner&gt;);<font></font>
<font></font>
    ~Zomby() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span> <span class="hljs-keyword">override</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:<font></font>
<font></font>
    <span class="hljs-keyword">using</span> Semaphore = <span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-built_in">std</span>::mutex, <span class="hljs-keyword">bool</span>&gt;;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; _listener;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Semaphore&gt; _semaphore;
    <span class="hljs-built_in">std</span>::thread _thread;
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::ThreadJoiner&gt; _joiner;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimpleZomby.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Listener.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/ThreadJoiner.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {<font></font>
Zomby::Zomby(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::ThreadJoiner&gt; joiner)<font></font>
    : _joiner(joiner)<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (!_joiner) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"An empty joiner in SimpleZomby::Zomby::Zomby"</span>);<font></font>
    }<font></font>
}<font></font>
<font></font>
Zomby::~Zomby()<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">std</span>::this_thread::get_id() != _thread.get_id()) {
            <span class="hljs-keyword">auto</span> guard = <span class="hljs-built_in">std</span>::lock_guard(_semaphore-&gt;first);<font></font>
            _semaphore-&gt;second = <span class="hljs-literal">false</span>;<font></font>
        } <span class="hljs-keyword">else</span> {<font></font>
            _semaphore-&gt;second = <span class="hljs-literal">false</span>;<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_thread.joinable()) {<font></font>
        _joiner-&gt;join(<span class="hljs-built_in">std</span>::move(_thread));<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_listener) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
        _listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    <span class="hljs-comment">// two separate lines needed because of absence of std::mutex move c-tor</span>
    _semaphore = <span class="hljs-built_in">std</span>::make_shared&lt;Semaphore&gt;();<font></font>
    _semaphore-&gt;second = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([listener, semaphore = _semaphore](){
        <span class="hljs-keyword">while</span> (listener &amp;&amp; semaphore) {<font></font>
            {<font></font>
                <span class="hljs-keyword">auto</span> guard = <span class="hljs-built_in">std</span>::lock_guard(semaphore-&gt;first);
                <span class="hljs-keyword">if</span> (!semaphore-&gt;second) {
                    <span class="hljs-keyword">break</span>;<font></font>
                }<font></font>
                listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));<font></font>
            }<font></font>
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
        }<font></font>
    });<font></font>
}<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;chrono&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Impl/WriteToConsoleListener.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Impl/ThreadJoinerAsync.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimpleZomby/SimpleZomby.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">auto</span> writeToConsoleListener = Common::WriteToConsoleListener::instance();
    <span class="hljs-keyword">auto</span> joiner = <span class="hljs-built_in">std</span>::make_shared&lt;Common::ThreadJoinerAsync&gt;();<font></font>
<font></font>
    {<font></font>
        <span class="hljs-keyword">auto</span> simpleZomby = SimpleZomby::Zomby(joiner);<font></font>
        simpleZomby.runOnce(writeToConsoleListener);<font></font>
<font></font>
        <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">4500</span>));<font></font>
    } <span class="hljs-comment">// Zomby should be killed here</span><font></font>
<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-string">"============================================================\n"</span>
            &lt;&lt; <span class="hljs-string">"|                      Zomby was killed                    |\n"</span>
            &lt;&lt; <span class="hljs-string">"============================================================\n"</span>;
        <span class="hljs-keyword">if</span> (writeToConsoleListener) {<font></font>
            writeToConsoleListener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">5000</span>));<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
N11SimpleZomby5ZombyE::~Zomby<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ThreadJoinerコードは表面的にテストされました。</font><font style="vertical-align: inherit;">彼を本番環境にドラッグすることにした場合-それは私のせいではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この方法の利点：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThreadJoinerが担当していたすべてのスレッドが正しく終了することが保証されています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のスレッドからの終了状態でのエラー検出が保証され、無限の実行につながります-メインスレッドは完了時にフリーズします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThreadJoinerは、別のスレッドからの終了の状態でそれほど重要でないエラー（スレッドの有限の過度の実行時間につながるエラー）の識別を簡素化する診断メッセージで補足できます。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更SteppingZombyとBoozdedZombyは完全に類似しています（fixes / semaphore_done_right_with_ThreadJoinerブランチを参照）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式ブーストの例について一言</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事の最初の部分では、公式のboostドキュメントの2つの例を示してい</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://www.boost.org/doc/libs/master/libs/beast/example/http/client/async/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。HTTPクライアントの</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例Websocketクライアントの例</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
main（）でioc.run（）を呼び出すと、いずれかのイベントが発生するまで制御がブロックされます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェーン全体の開発の成功。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラー。</font></font></li>
</ul><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提示されたコードの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
セッションクラスのインスタンスの上流のビジネスロジックによる早期の破棄</font><b><font style="vertical-align: inherit;">は</font></b><font style="vertical-align: inherit;">不可能です。</font><font style="vertical-align: inherit;">これだけでも、セッションクラスのフィールドに集約されたデータの十分な寿命が保証されます。</font><font style="vertical-align: inherit;">どうやら、この方法で変更された場合でも、提示されたコードは正常に動作します。</font><font style="vertical-align: inherit;">この場合のshared_from_thisの使用は冗長であり、生のthisポインタを取得するだけです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そのときからshared_from_thisはどこから来たのですか？</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらく、接続を破棄して接続を停止するためのスクリプトを提供する、より現実的なコードからのものでしょう。</font><font style="vertical-align: inherit;">そしてもちろん、自分自身の寿命を制御できないことにより、未定義の動作が発生しました（「クラッシュする」と読みます）。</font><font style="vertical-align: inherit;">クラッシュはゾンビと交換され、ゾンビはコピー貼り付け業者に提示されました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事に記載されているソリューションは特定のものです。</font><font style="vertical-align: inherit;">これらは、非同期プロセスの結果が送信される方法を含む、元のコードの機能を考慮に入れています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、例を分析した結果、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アーキテクチャソリューションが問題の原因</font><font style="vertical-align: inherit;">となっているか</font><b><font style="vertical-align: inherit;">が</font></b><font style="vertical-align: inherit;">判明しました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単一責任の原則の違反-クラスには、非同期で実行中のプロセスに停止の必要性を通知する機能と、このプロセスのデータストレージ機能が割り当てられていました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここから、基になるエンティティから上にあるエンティティへの要件が発生しました-非同期プロセスは、クラスインスタンスの有効性を一定期間保証するために必要です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">したがって、std :: enable_shared_from_this手法を使用して、自身の寿命を制御する必要があります。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も正しいコードは</font><font style="vertical-align: inherit;">std :: enable_shared_from_this </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font><b><font style="vertical-align: inherit;">せず</font></b><font style="vertical-align: inherit;">に取得されました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私があなたに望むこと。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478178/index.html">Windows Terminal Preview 0.7がリリースされました</a></li>
<li><a href="../ja478182/index.html">Intel Myriad Xチップとニューラルネットワーク推論におけるスケーラビリティ</a></li>
<li><a href="../ja478184/index.html">マウスの代わりのKDE接続、または最初の接続の落とし穴</a></li>
<li><a href="../ja478186/index.html">既製のビジネスを合法的に失う方法の物語</a></li>
<li><a href="../ja478188/index.html">PowerShellを使用してインシデント情報を収集する</a></li>
<li><a href="../ja478192/index.html">夕日の美しさの予測</a></li>
<li><a href="../ja478196/index.html">OpenStreetMap No. 487の世界からのニュース（11/12/2019-11/18/2019）</a></li>
<li><a href="../ja478198/index.html">Raspberry Pi Apocalypse Survival Computer</a></li>
<li><a href="../ja478200/index.html">一般的なスクラム製品の所有者の間違い</a></li>
<li><a href="../ja478202/index.html">英国のデジタルタレントビザ：個人的な経験</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>