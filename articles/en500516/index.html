<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖖🏾 🔑 🎿 Fast transfer from instant messengers - QIWI Android Wallet 💅🏿 👩 🧛🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 
 My name is Alex, I'm a developer at QIWI. 
 
 TL; DR
 
 How to transfer from the messenger directly to the payment form:
 
 

1. In the man...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Fast transfer from instant messengers - QIWI Android Wallet</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qiwi/blog/500516/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My name is Alex, I'm a developer at QIWI. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TL; DR</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
How to transfer from the messenger directly to the payment form:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the manifest we put an empty Activity c of the </font></font><code>intent-filter </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">type </font></font><code>ACTION_VIEW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code> ACTION_DIAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the scheme “tel”.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In activity, we transfer to the payment form through the existing deeplink, enriching it with data from the original</font></font><code> intent- “tel:XXXXX”</code></li>
</ol><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/8k/j_/il/8kj_ilpgmgyxhelzbnj0nmo8wim.jpeg"></a><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Profit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : by clicking on the highlighted phone number in the messenger, a person gets on the transfer form with the completed field of the transfer recipient. </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : I’ll tell you how beautifully to enable this feature, without being able to change the intent-filter list in the manifest in runtime.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What for?</font></font></h2><br>
<a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suppose a person has the task of transferring money for a collective birthday present. The receiving party can choose convenient transfer options: transfer to a card, electronic wallet, direct transfer to an account or something else. Many companies providing translation services accept a phone number as a secondary or primary user identifier. In order to avoid erroneous transfers, the recipient can convey his phone number via text message: email, instant messenger or SMS. The message also indicates the necessary system for translation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A typical user path is to copy the phone number from the messenger and paste it into the application for translation. </font><font style="vertical-align: inherit;">This way involves switching between applications, possibly accessing the desktop and even searching among the installed applications of the translation service provider. </font><font style="vertical-align: inherit;">Is it possible to shorten this path by reducing the number of steps? </font><font style="vertical-align: inherit;">There is an option.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Theory</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many instant messengers in smartphones recognize phone numbers and highlight them in the form of a hyperlink. By default, there is an application for processing this kind of links on any mobile device with a GSM module. Usually it is called “Phone”. In Android, the ability to process a shared phone number is declared in AndroidManifest. Examples of applications: “Phone”, Viber, Skype. If you intercept these events, you can immediately provide the user with a list of possible actions with a phone number. In our case, this will be a transfer offer through QIWI Wallet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We are interested in events with types </font></font><code>Intent.ACTION_VIEW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Intent.ACTION_DIAL,</code><code> Intent.ACTION_CALL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the tel scheme. Event</font></font><code>Intent.ACTION_CALL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It has restrictions on the Android security policy and its initialization requires permission from the user starting from the version of Marshmallow inclusive. According to our research messengers using more general </font></font><code>Intent.ACTION_VIEW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Intent.ACTION_DIAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are several similar types specifically for emergency phones, but this is clearly not our case. The intent body has the form “tel: 12345678”. This kind of intent cannot be processed </font></font><code>android.content.UriMatcher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, because host is missing here. The easiest way to handle this kind of Uri is to ask it </font></font><code>schemeSpecificPart </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and check if it is a valid phone number.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The list of intent-filters must be specified in AndroidManifest, it is impossible to change it during the execution of the application. How to remotely disable this feature? The first option is to repulse the user’s request at the time the Activity was opened - with a message or just close the application. From our point of view, this is not the best UX, since we will interrupt the flow of the user in the middle. It is better if we do not let a person choose our application at all, if the functionality is disabled. It is easier to disable the component with the intent-filter list in runtime, this will not give the user any false promises in the system interface. When using the PackageManager, note that checking for component inclusion is not very reliable. It is preferable to </font></font><code>enabled </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">force a component’s </font><font style="vertical-align: inherit;">flag </font><font style="vertical-align: inherit;">without relying on its current state using values</font></font><code>COMPONENT_ENABLED_STATE_ENABLED </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>COMPONENT_ENABLED_STATE_DISABLED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Changes made through the PackageManager are saved until the application is uninstalled from the device.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Practice</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to disable the feature, we need an Android component to disable it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The easiest way is to use an empty Activity, which we will do. </font><font style="vertical-align: inherit;">If you decide to use Service with a similar set of intent-filters, check out the Google guides, which specifically say </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“do not declare intent filters for your services”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Please note that by default the component is disabled:</font></font><code>android:enabled="false"</code><br>
<br>
<pre><code class="javascript hljs">  &lt;activity
            <span class="hljs-attr">android</span>:name=<span class="hljs-string">".messengerP2P.view.MessengerP2PActivity"</span>
            <span class="hljs-attr">android</span>:configChanges=<span class="hljs-string">"orientation"</span>
            <span class="hljs-attr">android</span>:label=<span class="hljs-string">"@string/title_activity_messenger_p2_p"</span>
            <span class="hljs-attr">android</span>:enabled=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">android</span>:screenOrientation=<span class="hljs-string">"portrait"</span>&gt;<font></font>
            &lt;!-- Open shared telephone number <span class="hljs-keyword">as</span> dial application --&gt;
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>

                <span class="hljs-attr">android:label</span>=<span class="hljs-string">"@string/title_activity_messenger_p2_p"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.action.VIEW"</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.action.DIAL"</span> /&gt;</span>

                <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.intent.category.DEFAULT"</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">data</span> <span class="hljs-attr">android:scheme</span>=<span class="hljs-string">"tel"</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span></span>
        &lt;/activity&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The activity itself simply redirects to the form of payment through existing diplinks.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessengerP2PActivity</span> : <span class="hljs-title">Activity</span>() </span>{<font></font>
<font></font>
    override fun onCreate(savedInstanceState: Bundle?) {<font></font>
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        <span class="hljs-keyword">var</span> phoneNumberFromDial: <span class="hljs-built_in">String</span>? = intent?.data?.schemeSpecificPart<font></font>
        phoneNumberFromDial?.let {<font></font>
            <span class="hljs-keyword">if</span> (ru.mw.utils.Utils<font></font>
                    .isPhoneNumber(phoneNumberFromDial)) {<font></font>
                val phoneNumberFromDialLink = PaymentActivity.getUriForProviderId(<font></font>
                        resources.getInteger(R.integer.providerIdQiwiWallet).toLong(), <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)<font></font>
                    .buildUpon()<font></font>
                    .appendQueryParameter(PaymentActivity.QUERY_PARAM_ACCOUNT, phoneNumberFromDial)<font></font>
                startActivity(<font></font>
                    Intent(Intent.ACTION_VIEW, phoneNumberFromDialLink.build()))<font></font>
            }<font></font>
        }<font></font>
        finish()<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The android: enabled flag can be controlled by this helper class.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> android.content.ComponentName
<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.content.pm.PackageManager<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessengerP2PUtils</span> </span>{<font></font>
<font></font>
    companion object {<font></font>
        private <span class="hljs-keyword">const</span> val componentName = <span class="hljs-string">"ru.mw.messengerP2P.view.MessengerP2PActivity"</span><font></font>
<font></font>
        private fun switchMessengerP2P(enabled: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span>, <span class="hljs-attr">packageName</span>: <span class="hljs-built_in">String</span>, <span class="hljs-attr">packageManager</span>: PackageManager) {<font></font>
            val compName = ComponentName(packageName, componentName)<font></font>
            packageManager.setComponentEnabledSetting(<font></font>
                compName,<font></font>
                when (enabled) {<font></font>
                    <span class="hljs-literal">true</span> -&gt; PackageManager.COMPONENT_ENABLED_STATE_ENABLED
                    <span class="hljs-keyword">else</span> -&gt; PackageManager.COMPONENT_ENABLED_STATE_DISABLED<font></font>
                },<font></font>
                PackageManager.DONT_KILL_APP)<font></font>
        }<font></font>
<font></font>
        fun enableMessengerP2P(applicationContext: Context) {<font></font>
            val packageName = applicationContext.packageName<font></font>
            val packageManager = applicationContext.packageManager<font></font>
            switchMessengerP2P(enabled = <span class="hljs-literal">true</span>, packageName = packageName, packageManager = packageManager);<font></font>
        }<font></font>
<font></font>
        fun disableMessengerP2P(applicationContext: Context) {<font></font>
            val packageName = applicationContext.packageName<font></font>
            val packageManager = applicationContext.packageManager<font></font>
            switchMessengerP2P(enabled = <span class="hljs-literal">false</span>, packageName = packageName, packageManager = packageManager);<font></font>
        }<font></font>
<font></font>
        fun isMessengerP2PEnabled(packageName: <span class="hljs-built_in">String</span>, <span class="hljs-attr">packageManager</span>: PackageManager): <span class="hljs-built_in">Boolean</span> {<font></font>
            val state = packageManager.getComponentEnabledSetting(ComponentName(packageName, componentName))<font></font>
            <span class="hljs-keyword">return</span> state == PackageManager.COMPONENT_ENABLED_STATE_ENABLED || state == PackageManager.COMPONENT_ENABLED_STATE_DEFAULT<font></font>
        }<font></font>
<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The “isMessengerP2PEnabled” method is not used here to check the current state of the component, since during testing it produced unreliable results. If you decide to use it, carefully check its operation in the conditions of asynchronous business logic and when downloading the application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The time for changing the flag value is </font></font><code>enabled </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not very important, we chose the moment when the feature flags configuration was fully loaded. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So that when you click on the phone number in the messengers there is a system dialogue of choice, you need to provide the user with instructions on how to throw off the default settings for intent-a “tel: XXXXX”. For example: “If you can only make a call when you click on a number, go to Smartphone settings → select Phone in the application list → reset the“ Open by default. ”</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pu/jd/ak/pujdakr-lmquupnkjgmt5urzrng.png" width="400"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you disable the component on the go, when the user is shown this system dialog, nothing bad will happen. </font><font style="vertical-align: inherit;">The corresponding item will instantly disappear from the list, in our case “Transfer money”. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An interesting behavior will begin if the user processes the links through our application by default. </font><font style="vertical-align: inherit;">To do this, it is enough to poke the item “Remember selection” or “Always”. </font><font style="vertical-align: inherit;">If you disable the component, then the user will be given a choice of which application to use, and the first time there is no “Remember choice” item. </font><font style="vertical-align: inherit;">After enabling features, the entire flow will be restored, the user will be transferred to the application directly.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea of ​​this feature came to us a long time ago, the original ticket was created in 2017. </font><font style="vertical-align: inherit;">The idea has not lost its relevance even now, I could not find a banking application with similar functionality. </font><font style="vertical-align: inherit;">We released “transfers from the messenger” on April 29, on the first day almost 8,000 unique users took advantage of them. </font><font style="vertical-align: inherit;">If business indicators in the near future will satisfy us, we will develop this feature further. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What do you think, how many more interesting intent-s of Android are peacefully waiting for their business application?</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en500504/index.html">SRE Observability: Namespaces and Metric Structure</a></li>
<li><a href="../en500506/index.html">Designing a bounded context with a Bounded Context Canvas: workshop recipe</a></li>
<li><a href="../en500508/index.html">Sofa Experts Competition</a></li>
<li><a href="../en500510/index.html">Security Week 19: bruteforce attacks on RDP</a></li>
<li><a href="../en500512/index.html">Snom D785 IP Phone Review</a></li>
<li><a href="../en500518/index.html">Iterations of introducing scrum in a company</a></li>
<li><a href="../en500520/index.html">How to make your applications use around the world: 10 tips from CEO Wachanga</a></li>
<li><a href="../en500528/index.html">About the translation of "practice" / "practicality" without practice / practical</a></li>
<li><a href="../en500530/index.html">Canvas API Memo</a></li>
<li><a href="../en500538/index.html">Podcasts Rusbase, Medusa and KinoPoisk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>