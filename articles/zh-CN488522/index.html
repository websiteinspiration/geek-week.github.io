<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙌🏾 👐🏻 👩🏿‍🚒 JOOQ和他的兔子洞。如何在没有冬眠的情况下生存 👩🏽‍🏭 ❗️ 👴🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在本文中，我不会淹没JOOQ。我更喜欢Hibernate及其背后的所有Spring Data JPA功能。但是本文将不涉及它们。
 
 
 
 当我们使用Hibernate和Spring Data JPA时，我们不需要考虑内部流程-了解注释并在存储库中编写正确的方法名称-这两个怪物将为您完成其余工作...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>JOOQ和他的兔子洞。如何在没有冬眠的情况下生存</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488522/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在本文中，我不会淹没JOOQ。</font><font style="vertical-align: inherit;">我更喜欢Hibernate及其背后的所有Spring Data JPA功能。</font><font style="vertical-align: inherit;">但是本文将不涉及它们。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wt/-0/co/wt-0condklmkd6zkb2ag_a46vb4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当我们使用Hibernate和Spring Data JPA时，我们不需要考虑内部流程-了解注释并在存储库中编写正确的方法名称-这两个怪物将为您完成其余工作。</font><font style="vertical-align: inherit;">对于JOOQ而言，不幸的是，对于许多人来说，这将花费一些精力，并且要比</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findAllByUserId（Long userId）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编写更多内容</font><font style="vertical-align: inherit;">。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">什么是JOOQ？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们编写一个简单的SQL查询：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> countries c <span class="hljs-keyword">where</span> c.population &gt; <span class="hljs-number">10000000</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们可以在控制台中执行此请求。</font><font style="vertical-align: inherit;">好的 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们感觉好像不在控制台中。</font><font style="vertical-align: inherit;">我们希望我们的应用程序发送此请求。</font><font style="vertical-align: inherit;">它不是一次性脚本，并且至少已针对语法进行了验证。</font><font style="vertical-align: inherit;">我们通过Spring Data JPA做到这一点：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">List&lt;Country&gt; <span class="hljs-title">findAllByPopulationAfter</span><span class="hljs-params">(Long amount)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
与上面相同的请求被执行，但是由Spring执行。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这种方法的明显优势是什么？</font><font style="vertical-align: inherit;">它由功能强大的框架执行；它还验证对错误的请求。</font><font style="vertical-align: inherit;">但是查询管理负责框架。</font><font style="vertical-align: inherit;">我们希望同时完全管理该请求，以便完全验证该请求。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
采用</font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">询问</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Query("select c from Country c where c.population &gt; :amount")</span>
<span class="hljs-function">List&lt;Country&gt; <span class="hljs-title">findAllPopulationGreaterThan</span><span class="hljs-params">(<span class="hljs-meta">@Param("amount")</span> Long amount)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在SQL和DSL之间进行这种折衷也很好。</font><font style="vertical-align: inherit;">但是，如果我们不想弄乱SQL，我们将很高兴看到以下内容：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(COUNTRIES)<font></font>
                .where(COUNTRIES.POPULATION.greaterThan(amount))<font></font>
                .fetch();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一些库都适合这样的：</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QueryDSL </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JOOQ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Speedment</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
关于QueryDSL我</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个写了</font></font></u></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">几年前。</font><font style="vertical-align: inherit;">我没有研究Speedment，但它似乎不仅仅是一个简单的DSL生成器，而且我还必须学习他们加密SQL查询命令的方法。</font><font style="vertical-align: inherit;">一般来说，今天我们将讨论JOOQ。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JOOQ查询</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
是的，我们已经在上面看到了以下查询之一：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(COUNTRIES)<font></font>
                .where(COUNTRIES.POPULATION.greaterThan(amount))<font></font>
                .fetch();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还有什么？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，一个简单的get请求：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
或插入请求：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(Countries.COUNTRIES.NAME, country.getName())<font></font>
                .set(Countries.COUNTRIES.POPULATION, country.getPopulation())<font></font>
                .set(Countries.COUNTRIES.GOVERNMENT_FORM, nameOrNull(country.getGovernmentForm()))<font></font>
                .returning()<font></font>
                .fetchOne();</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如您所见，一切都清楚了，仅此而已。</font><font style="vertical-align: inherit;">但这只是乍看之下。</font><font style="vertical-align: inherit;">找出这个兔子洞有多深可能需要几个星期。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，让我们从头开始。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是的，它将成为专家</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我更喜欢Gradle。</font><font style="vertical-align: inherit;">但是出于某种原因，JOOQ开发人员对Gradle的关注度降低了，他们选择了第三方插件。</font><font style="vertical-align: inherit;">好的，培训项目将在Maven上进行。</font><font style="vertical-align: inherit;">但是，亲爱的读者，如果您在github的深处翻阅，并且准备在Gradle上展示一个完全自定义的项目，请写信给我，您将成为本文的合著者。</font><font style="vertical-align: inherit;">H2同样适用（培训项目将在PostgreSQL上）。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么我在Gradle和H2上没有成功</font></font></b><div class="spoiler_text">    ,      Gradle.           jooq-generator .          H2,  «  »   H2         ,   ,  ,     .<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要的Maven依赖项：</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Spring Starters --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jooq<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Database --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.flywaydb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flyway-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- Helpers --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${commons.lang3.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!--Test --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
        <span class="hljs-comment">&lt;!-- JOOQ Generator --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-meta<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-codegen<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><font></font>
<font></font>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Spring已经有一个JOOQ启动器，它将根据application.yml中的指定设置自配置DataSource。</font><font style="vertical-align: inherit;">但是对于JOOQ的全部工作来说，这还不够。</font><font style="vertical-align: inherit;">必须产生实体。</font><font style="vertical-align: inherit;">是的，是的，我们不编写实体，而是生成它们。</font><font style="vertical-align: inherit;">所谓表优先的方法。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
专注于使用数据库的常规应用程序结构如下：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c-/pz/tp/c-pztpdxbkn5kxot-s_08tzlzbk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在服务层之前，数据以平面模型（DTO）的形式在应用程序中传播。</font><font style="vertical-align: inherit;">此外，当服务需要使用数据库时，它将DTO转换为实体，将其发送到存储库，并且该DTO已经将其保存到数据库。</font><font style="vertical-align: inherit;">JOOQ开发人员对事物的看法有所不同：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/wy/4b/vvwy4bbp1ox57f4j0edmulfe7ni.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正如我们所看到的，在JOOQ中，他们认真修改了标准模式并决定走自己的路。</font><font style="vertical-align: inherit;">差异非常明显：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DTO转换为实体已经在存储库中进行。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们不会这样写实体。</font><font style="vertical-align: inherit;">它是由JOOQ生成器为我们编写的。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
已经足以得出结论，JOOQ并不是那么简单。</font><font style="vertical-align: inherit;">高度可定制的生成实体，DTO中难以理解的映射以及其他困难将吓跑许多人。</font><font style="vertical-align: inherit;">但是，在无处可去的情况下，对JOOQ的这些方面进行定向研究可能会严重带走并花费数天甚至数周。</font><font style="vertical-align: inherit;">我相信我的帖子将大大节省您的时间。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将介绍与JOOQ合作的以下方面：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实体生成。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编写CRUD查询。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化CRUD请求。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">还有另一个CRUD请求优化。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用标准的JOOQ库映射实体。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并讨论为什么所有这些都是必要的。 </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们走吧。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们写什么？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们的项目将有两个实体：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
国家/地区：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Country</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> GovernmentForm governmentForm;
    <span class="hljs-keyword">private</span> Integer population;<font></font>
<font></font>
    <span class="hljs-keyword">private</span> List&lt;City&gt; cities;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
市：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">City</span> </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> Long countryId;
    <span class="hljs-keyword">private</span> String name;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一对多关系。</font><font style="vertical-align: inherit;">国家包含许多相关的城市。</font><font style="vertical-align: inherit;">城市包含countryId。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Flyway迁移看起来像这样：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> countries<font></font>
(<font></font>
    <span class="hljs-keyword">id</span>              bigserial primary <span class="hljs-keyword">key</span>,
    <span class="hljs-keyword">name</span>            <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>),<font></font>
    government_form <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>),<font></font>
    population      <span class="hljs-built_in">int</span><font></font>
);<font></font>
<font></font>
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> cities<font></font>
(<font></font>
    <span class="hljs-keyword">id</span>         bigserial primary <span class="hljs-keyword">key</span>,<font></font>
    country_id <span class="hljs-built_in">bigint</span>,
    <span class="hljs-keyword">name</span>       <span class="hljs-built_in">varchar</span>(<span class="hljs-number">255</span>)<font></font>
);</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们从实体生成开始。</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正如我所说，实体是分别生成的。</font><font style="vertical-align: inherit;">有两种方法可以做到这一点。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过Maven插件。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用Java代码编写。 </font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Maven中生成实体</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当项目生成时，Maven启动生成器并生成实体。</font><font style="vertical-align: inherit;">您可以在任何方便的时间调用生成器并生成实体。</font><font style="vertical-align: inherit;">例如，当基座的结构发生变化时，这是必需的。</font><font style="vertical-align: inherit;">Maven中的插件如下所示：</font></font><br>
<br>
<pre><code class="xml hljs">            <span class="hljs-comment">&lt;!-- JOOQ Generator Plugin --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jooq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jooq-codegen-maven<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${jooq.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>generate-sources<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>generate<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">jdbc</span>&gt;</span>  <span class="hljs-comment">&lt;!--    --&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">driver</span>&gt;</span>${db.driver}<span class="hljs-tag">&lt;/<span class="hljs-name">driver</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>${db.url}<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">user</span>&gt;</span>${db.username}<span class="hljs-tag">&lt;/<span class="hljs-name">user</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>${db.password}<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">jdbc</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">generator</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">database</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>.*<span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>  <span class="hljs-comment">&lt;!--     --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span>  <span class="hljs-comment">&lt;!--     --&gt;</span><font></font>
                                flyway_schema_history<font></font>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">inputSchema</span>&gt;</span>public<span class="hljs-tag">&lt;/<span class="hljs-name">inputSchema</span>&gt;</span>  <span class="hljs-comment">&lt;!--  --&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">database</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">generate</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">records</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">records</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">generate</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>
                            <span class="hljs-comment">&lt;!--      --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">packageName</span>&gt;</span>ru.xpendence.jooqexample.domain<span class="hljs-tag">&lt;/<span class="hljs-name">packageName</span>&gt;</span>
                            <span class="hljs-comment">&lt;!--  .    target. --&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>target/generated-sources/jooq<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">generator</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您正确执行了所有操作，请更新Maven，然后在插件中看到jooq-codegen。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1n/ch/pv/1nchpvafnxml7qle_dfsq1zsuje.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行。它将为您生成实体。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cs/kf/la/cskfla2pzxfkm-vkot_dcggqoia.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些是用于访问数据库的实体。第一个麻烦：它们是一成不变的。也就是说，它们是可变的，但是类型更改以一种人为设计的方式发生，因此该过程描述将被拉到单独的文章中。因此，尝试在表生成阶段考虑数据类型。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实体看起来很奇怪。例如，这是CountrysRecord类的签名：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountriesRecord</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UpdatableRecordImpl</span>&lt;<span class="hljs-title">CountriesRecord</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Record4</span>&lt;<span class="hljs-title">Long</span>, <span class="hljs-title">String</span>, <span class="hljs-title">String</span>, <span class="hljs-title">Integer</span>&gt; </span>{
    <span class="hljs-comment">//...</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如我们所见，CountryRecord实现了Record4，它由4种类型来键入。</font><font style="vertical-align: inherit;">国家表有4列，因此为Record4。</font><font style="vertical-align: inherit;">城市中有3列，因此为Record3。</font><font style="vertical-align: inherit;">我不知道为什么这样发明。</font><font style="vertical-align: inherit;">JOOQ库中有22个这样的记录，即Record1 ... Record22。</font><font style="vertical-align: inherit;">从中可以得出结论，JOOQ的功能仅限于处理最多22列的表，但事实并非如此。</font><font style="vertical-align: inherit;">我有包含数十列的表，JOOQ只是立即实现Record。</font><font style="vertical-align: inherit;">好吧，... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
用Java代码生成JOOQ实体看起来像这样：</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AfterStartupApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationListener</span>&lt;<span class="hljs-title">ContextRefreshedEvent</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.driver-class-name}")</span>
    <span class="hljs-keyword">private</span> String driver;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.url}")</span>
    <span class="hljs-keyword">private</span> String url;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.username}")</span>
    <span class="hljs-keyword">private</span> String username;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${spring.datasource.password}")</span>
    <span class="hljs-keyword">private</span> String password;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.name}")</span>
    <span class="hljs-keyword">private</span> String databaseName;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.with-includes}")</span>
    <span class="hljs-keyword">private</span> String databaseWithIncludes;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.database.with-input-schema}")</span>
    <span class="hljs-keyword">private</span> String databaseWithInputSchema;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.target.package-name}")</span>
    <span class="hljs-keyword">private</span> String targetPackageName;<font></font>
<font></font>
    <span class="hljs-meta">@Value("${jooq.generator.target.directory}")</span>
    <span class="hljs-keyword">private</span> String targetDirectory;<font></font>
<font></font>
    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onApplicationEvent</span><span class="hljs-params">(ContextRefreshedEvent contextRefreshedEvent)</span> </span>{
        <span class="hljs-keyword">new</span> GenerationTool().run(configureGenerator());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> Configuration <span class="hljs-title">configureGenerator</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Configuration()<font></font>
                .withJdbc(<span class="hljs-keyword">new</span> Jdbc()<font></font>
                        .withDriver(driver)<font></font>
                        .withUrl(url)<font></font>
                        .withUser(username)<font></font>
                        .withPassword(password))<font></font>
                .withGenerator(<span class="hljs-keyword">new</span> Generator()<font></font>
                        .withDatabase(<span class="hljs-keyword">new</span> Database()<font></font>
                                .withName(databaseName)<font></font>
                                .withIncludes(databaseWithIncludes)<font></font>
                                .withExcludes(<span class="hljs-string">""</span>)<font></font>
                                .withInputSchema(databaseWithInputSchema))<font></font>
                        .withTarget(<span class="hljs-keyword">new</span> Target()<font></font>
                                .withPackageName(targetPackageName)<font></font>
                                .withDirectory(targetDirectory)));<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就我而言，当所有新的迁移都汇总并且数据库是最新的时，生成器将在应用程序完全启动后启动。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们有模型，有实体，有基础。</font><font style="vertical-align: inherit;">现在该创建存储库并编写查询了。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建存储库</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有请求都通过DslContext。</font><font style="vertical-align: inherit;">重复DslContext。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Repository</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CrudRepository</span>&lt;<span class="hljs-title">Country</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DSLContext dsl;<font></font>
<font></font>
} </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
存储库已准备就绪。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编写CRUD查询</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">插</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果使用SQL，则添加另一个国家/地区的请求将是：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> countries(<span class="hljs-keyword">name</span>, government_form, population)
<span class="hljs-keyword">values</span> (<span class="hljs-string">' -'</span>, <span class="hljs-string">'UNITARY'</span>, <span class="hljs-number">100500</span>) <span class="hljs-keyword">returning</span> *;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在JOOQ中，查询尽可能接近SQL语法：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insertValues</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)  <span class="hljs-comment">//insert into countries</span>
                .values(country.getId(), country.getName(), country.getPopulation(), nameOrNull(country.getGovernmentForm()))  <span class="hljs-comment">//values (? ? ? ?)</span>
                .returning()  <span class="hljs-comment">//returning</span>
                .fetchOne()  <span class="hljs-comment">//*</span><font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如我们所见，没有什么复杂的。</font><font style="vertical-align: inherit;">但是，这样的请求不适合我们，因为在我们的情况下，ID是在数据库中生成的，因此我们必须考虑到这一点。</font><font style="vertical-align: inherit;">如果我们这样写：</font></font><br>
<br>
<pre><code class="java hljs">.values(<span class="hljs-keyword">null</span>, country.getName(), country.getPopulation(), nameOrNull(country.getGovernmentForm()))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们会得到 </font></font><br>
<br>
<pre><code class="java hljs">org.postgresql.util.PSQLException: :     <span class="hljs-string">"id"</span>   NOT NULL</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，如果我们在应用程序端生成了ID，那么这样的请求将是一个旅程。</font><font style="vertical-align: inherit;">我们将不得不重写请求，为每个字段指定一个特定值。</font><font style="vertical-align: inherit;">所以你可以：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insert</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(Countries.COUNTRIES.NAME, country.getName())<font></font>
                .set(Countries.COUNTRIES.POPULATION, country.getPopulation())<font></font>
                .set(Countries.COUNTRIES.GOVERNMENT_FORM, nameOrNull(country.getGovernmentForm()))<font></font>
                .returning()<font></font>
                .fetchOne()<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这种情况下，我们在字段中手动设置对象。</font><font style="vertical-align: inherit;">这个选项很有效，但是更好。</font><font style="vertical-align: inherit;">像Spring Data JPA一样，发送整个对象进行保存是理想的：</font></font><br>
<br>
<pre><code class="java hljs">repository.save(country);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可能是这样。</font><font style="vertical-align: inherit;">为此，我们需要将我们的模型映射到extended Record实体并将其发送以进行保存：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insert</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))  <span class="hljs-comment">//   </span><font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于不需要配置映射的情况，此方法是最简单且最容易理解的。</font><font style="vertical-align: inherit;">但是映射设置会更低。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
正如我们注意到的，此查询返回整个实体。</font><font style="vertical-align: inherit;">您可以在fetch（）方法中确定确切需要返回的内容。</font><font style="vertical-align: inherit;">看起来像这样：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">insertAndReturnId</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))<font></font>
                .returning(Countries.COUNTRIES.ID) <span class="hljs-comment">//  Record    - id</span><font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .get(Countries.COUNTRIES.ID); <span class="hljs-comment">// id</span>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有点麻烦，但是又要比较一下。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将编写其余的CRUD方法。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新资料</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL查询：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">update</span> countries
<span class="hljs-keyword">set</span> <span class="hljs-keyword">name</span>            = <span class="hljs-string">''</span>,<font></font>
    government_form = <span class="hljs-string">'CONFEDERATE'</span>,<font></font>
    population      = <span class="hljs-number">100500</span>
<span class="hljs-keyword">where</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">1</span>
<span class="hljs-keyword">returning</span> *;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JOOQ请求：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">update</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.update(Countries.COUNTRIES)<font></font>
                .set(dsl.newRecord(Countries.COUNTRIES, country))<font></font>
                .where(Countries.COUNTRIES.ID.eq(country.getId()))<font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error updating entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选择</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL中的查询为：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">select</span> *
<span class="hljs-keyword">from</span> countries c
<span class="hljs-keyword">where</span> <span class="hljs-keyword">id</span> = ?;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在JOOQ中，查询将相应地显示：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">find</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES) <span class="hljs-comment">//select * from countries</span>
                .where(Countries.COUNTRIES.ID.eq(id))  <span class="hljs-comment">//where id = ?</span>
                .fetchAny()  <span class="hljs-comment">// ,    </span><font></font>
                .into(Country.class);<font></font>
    }</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">删除</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在有些请求中，我们没有任何退货。</font><font style="vertical-align: inherit;">此类查询返回受影响的行数。</font><font style="vertical-align: inherit;">在删除中，我们什么也没退，但是我们收到的信息仍然对我们有用。</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">delete</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.deleteFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .execute() == <span class="hljs-number">1</span>;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们删除一行。</font><font style="vertical-align: inherit;">因此，SQL查询将返回类似以下内容的内容：</font></font><br>
<br>
<pre><code class="sql hljs">1 row affected in 5 ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
收到这样的答案后，我们肯定知道该行已被删除。</font><font style="vertical-align: inherit;">这足以宣布操作成功。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这不是童话。</font><font style="vertical-align: inherit;">那只是润滑剂。</font><font style="vertical-align: inherit;">使用常规映射器在Record中对实体进行瘦映射，反之亦然</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“好吧，”读者对读者说，“一对多在哪里？我没有看到乡村随众多城市一起成长的那一刻。” </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
你会是对的。这不是休眠；在这里您必须手动进行。您所需要做的就是获取ID = country.getId（）的城市列表。我已经展示了into（）方法，该方法使用常规映射器将Record映射到实体。但是JOOQ还有一个map（）方法，使我们可以对Record进行任何操作。让我们看一下它的功能并添加城市：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">find</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny()<font></font>
                .map(r -&gt; {<font></font>
                    Country country = r.into(Country.class);<font></font>
                    country.setCities(cityRepository.findAll(Cities.CITIES.COUNTRY_ID.eq(country.getId())));<font></font>
                    <span class="hljs-keyword">return</span> country;<font></font>
                });<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如我们所见，现在我们首先映射“国家/地区中的记录”，然后再在城市中提出另一个请求，我们获得了该国家/地区的所有城市并将其设置为实质。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是可以有数十个这样的集合，这意味着可以有数十个请求。</font><font style="vertical-align: inherit;">并直接在方法中描述这些请求就是这样。</font><font style="vertical-align: inherit;">正确的解决方案是编写一个单独的映射器，并将所有这些请求放在此处。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRecordMapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RecordMapper</span>&lt;<span class="hljs-title">CountriesRecord</span>, <span class="hljs-title">Country</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CityRepository cityRepository;<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">map</span><span class="hljs-params">(CountriesRecord record)</span> </span>{<font></font>
        Country country = record.into(Country.class);<font></font>
        country.setCities(cityRepository.findAll(Cities.CITIES.COUNTRY_ID.eq(country.getId())));<font></font>
        <span class="hljs-keyword">return</span> country;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在查询将如下所示：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">findWithCustomMapper</span><span class="hljs-params">(Long id)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.selectFrom(Countries.COUNTRIES)<font></font>
                .where(Countries.COUNTRIES.ID.eq(id))<font></font>
                .fetchAny()<font></font>
                .map(r -&gt; countryRecordMapper.map((CountriesRecord) r));<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它更加简洁，并且不包含其他逻辑。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">好的，我们学习了如何将Record映射到实体，但是如何微调Record中实体的映射呢？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
到目前为止，我们已经有了以下设计：</font></font><br>
<br>
<pre><code class="java hljs">.set(dsl.newRecord(Countries.COUNTRIES, country))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
已经很好了，但是如果我们需要专门绘制一个字段怎么办？</font><font style="vertical-align: inherit;">例如，我们在那里有LocalDateTime，而诸如Timestamp之类的PostgreSQL生成器生成了OffsetDateTime。</font><font style="vertical-align: inherit;">在这种情况下，该字段将不会被映射，也不会记录在数据库中。</font><font style="vertical-align: inherit;">在这种情况下，我们将需要另一个映射器执行相同的操作，但方向相反。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是的，对于每个映射器，我们都没有映射器</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他被称为。</font><font style="vertical-align: inherit;">让我们写他的继承人。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountryRecordUnmapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RecordUnmapper</span>&lt;<span class="hljs-title">Country</span>, <span class="hljs-title">CountriesRecord</span>&gt; </span>{<font></font>
<font></font>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DSLContext dsl;<font></font>
<font></font>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> CountriesRecord <span class="hljs-title">unmap</span><span class="hljs-params">(Country country)</span> <span class="hljs-keyword">throws</span> MappingException </span>{<font></font>
        CountriesRecord record = dsl.newRecord(Countries.COUNTRIES, country);<font></font>
        record.setPopulation(-<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> record;<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
插入及其应用程序将如下所示：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> Country <span class="hljs-title">insertWithUnmapper</span><span class="hljs-params">(Country country)</span> </span>{
        <span class="hljs-keyword">return</span> dsl.insertInto(Countries.COUNTRIES)<font></font>
                .set(countryRecordUnmapper.unmap(country))<font></font>
                .returning()<font></font>
                .fetchOptional()<font></font>
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> DataAccessException(<span class="hljs-string">"Error inserting entity: "</span> + country.getId()))<font></font>
                .into(Country.class);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如我们所见，也相当。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论与结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就个人而言，我更喜欢休眠。</font><font style="vertical-align: inherit;">对于90％以上的应用程序，可能更合理。</font><font style="vertical-align: inherit;">但是，如果您（读者）想要控制每个请求，则JOOQ或其他类似的库更适合您。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一如既往，我发布了培训项目。</font><font style="vertical-align: inherit;">他躺在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这里</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN488504/index.html">我们在Zabbix中连接生产日历</a></li>
<li><a href="../zh-CN488514/index.html">Android Remote Debugger-远程调试Android应用程序</a></li>
<li><a href="../zh-CN488516/index.html">全面的iframe广告代码指南</a></li>
<li><a href="../zh-CN488518/index.html">电子书ONYX BOOX Livingstone和亚马逊Kindle Paperwhite的比较评论（2018）</a></li>
<li><a href="../zh-CN488520/index.html">loop子和花体。2</a></li>
<li><a href="../zh-CN488528/index.html">在Android平台上使用PKCS＃11加密令牌机制</a></li>
<li><a href="../zh-CN488530/index.html">什么是反应性？</a></li>
<li><a href="../zh-CN488534/index.html">DIY紫外线灯400-405 nm，用于3D光聚合物模型的聚合</a></li>
<li><a href="../zh-CN488536/index.html">在将Docker-in-Docker用于CI或测试环境之前，请仔细考虑。</a></li>
<li><a href="../zh-CN488540/index.html">Пушка Гаусса</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>