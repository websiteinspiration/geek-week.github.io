<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🎗️ 🐐 👴🏼 GitHubアクションとPythonを使用したホームCI / CDの作成 🏡 👧🏾 ✍️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ある晩、仕事から帰宅したとき、少し宿題をすることにしました。私はいくつかの編集を行い、すぐにそれらを試したいと思いました。しかし、実験の前に、VPSに移動し、変更をプッシュし、コンテナーを再構築して実行する必要がありました。それから私は、継続的なデリバリーに対処する時が来たと判断しました。
 
 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>GitHubアクションとPythonを使用したホームCI / CDの作成</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476368/"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ある晩、仕事から帰宅したとき、少し宿題をすることにしました。</font><font style="vertical-align: inherit;">私はいくつかの編集を行い、すぐにそれらを試したいと思いました。</font><font style="vertical-align: inherit;">しかし、実験の前に、VPSに移動し、変更をプッシュし、コンテナーを再構築して実行する必要がありました。</font><font style="vertical-align: inherit;">それから私は、継続的なデリバリーに対処する時が来たと判断しました。</font></font><br>
<img src="https://habrastorage.org/webt/xa/l4/dm/xal4dmowtxwpuoxxrutujwwy4fm.jpeg"></p><a name="habracut"></a><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初は、Circle CI、Travis、Jenkinsのいずれかを選択しました。このような強力なツールが必要ないため、私はJenkinsをほぼ即座に除外しました。トラビスについてすぐに読んだところ、組み立ててテストするのは便利だという結論に達しましたが、それを使っての配信は想像できません。 Circle CIについてYouTubeの煩わしい広告から学びました。私は例で実験を始めましたが、ある時点で間違いを犯し、永遠のテストが行​​われたため、多くの貴重な組み立て時間がかかりました（一般に、心配するのに十分な制限がありますが、それは私を襲いました）。もう一度検索してみたところ、Githubアクションに出くわしました。入門の例を試してみて、良い印象を受けました。ドキュメントをざっと見てみたところ、組み立ての秘密を守ることができるのはとてもクールだという結論に達しました。プロジェクトを1か所に集めて実際に展開する。光る目で、彼はすぐに望ましい計画を描きました、そしてギアは回転しました。</font></font></p><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/h1/fp/rv/h1fprvm3jru4em3vj0ae6xruu5i.jpeg" alt="予定"></div><br>
<p>    .          Flask  2 :</p><br>
<div class="spoiler"><b class="spoiler_title">   </b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> request, jsonify<font></font>
<font></font>
app = Flask(__name__)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validate_post_data</span>(<span class="hljs-params">data: dict</span>) -&gt; bool:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isinstance(data, dict):
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data.get(<span class="hljs-string">'name'</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> isinstance(data[<span class="hljs-string">'name'</span>], str):
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">if</span> data.get(<span class="hljs-string">'age'</span>) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> isinstance(data[<span class="hljs-string">'age'</span>], int):
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
<span class="hljs-meta">@app.route('/', methods=['GET'])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hello</span>():</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'Hello World!'</span><font></font>
<font></font>
<span class="hljs-meta">@app.route('/api', methods=['GET', 'POST'])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">api</span>():</span>
    <span class="hljs-string">"""
    /api entpoint
    GET - returns json= {'status': 'test'}
    POST -  {
            name - str not null
            age - int optional
            }
    :return:
    """</span>
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">'GET'</span>:
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'status'</span>: <span class="hljs-string">'test'</span>})
    <span class="hljs-keyword">elif</span> request.method == <span class="hljs-string">'POST'</span>:
        <span class="hljs-keyword">if</span> validate_post_data(request.json):
            <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'status'</span>: <span class="hljs-string">'OK'</span>})
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'status'</span>: <span class="hljs-string">'bad input'</span>}), <span class="hljs-number">400</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8080</span>)<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div></div><br>
<p>  :</p><br>
<div class="spoiler"><b class="spoiler_title">   </b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> unittest
<span class="hljs-keyword">import</span> app <span class="hljs-keyword">as</span> tested_app
<span class="hljs-keyword">import</span> json<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlaskAppTests</span>(<span class="hljs-params">unittest.TestCase</span>):</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setUp</span>(<span class="hljs-params">self</span>):</span>
        tested_app.app.config[<span class="hljs-string">'TESTING'</span>] = <span class="hljs-literal">True</span><font></font>
        self.app = tested_app.app.test_client()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_hello_endpoint</span>(<span class="hljs-params">self</span>):</span>
        r = self.app.get(<span class="hljs-string">'/'</span>)<font></font>
        self.assertEqual(r.data, <span class="hljs-string">b'Hello World!'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_post_hello_endpoint</span>(<span class="hljs-params">self</span>):</span>
        r = self.app.post(<span class="hljs-string">'/'</span>)<font></font>
        self.assertEqual(r.status_code, <span class="hljs-number">405</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_api_endpoint</span>(<span class="hljs-params">self</span>):</span>
        r = self.app.get(<span class="hljs-string">'/api'</span>)<font></font>
        self.assertEqual(r.json, {<span class="hljs-string">'status'</span>: <span class="hljs-string">'test'</span>})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_correct_post_api_endpoint</span>(<span class="hljs-params">self</span>):</span>
        r = self.app.post(<span class="hljs-string">'/api'</span>,<font></font>
                          content_type=<span class="hljs-string">'application/json'</span>,<font></font>
                          data=json.dumps({<span class="hljs-string">'name'</span>: <span class="hljs-string">'Den'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">100</span>}))<font></font>
        self.assertEqual(r.json, {<span class="hljs-string">'status'</span>: <span class="hljs-string">'OK'</span>})<font></font>
        self.assertEqual(r.status_code, <span class="hljs-number">200</span>)<font></font>
<font></font>
        r = self.app.post(<span class="hljs-string">'/api'</span>,<font></font>
                          content_type=<span class="hljs-string">'application/json'</span>,<font></font>
                          data=json.dumps({<span class="hljs-string">'name'</span>: <span class="hljs-string">'Den'</span>}))<font></font>
        self.assertEqual(r.json, {<span class="hljs-string">'status'</span>: <span class="hljs-string">'OK'</span>})<font></font>
        self.assertEqual(r.status_code, <span class="hljs-number">200</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_not_dict_post_api_endpoint</span>(<span class="hljs-params">self</span>):</span>
        r = self.app.post(<span class="hljs-string">'/api'</span>,<font></font>
                          content_type=<span class="hljs-string">'application/json'</span>,<font></font>
                          data=json.dumps([{<span class="hljs-string">'name'</span>: <span class="hljs-string">'Den'</span>}]))<font></font>
        self.assertEqual(r.json, {<span class="hljs-string">'status'</span>: <span class="hljs-string">'bad input'</span>})<font></font>
        self.assertEqual(r.status_code, <span class="hljs-number">400</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_no_name_post_api_endpoint</span>(<span class="hljs-params">self</span>):</span>
        r = self.app.post(<span class="hljs-string">'/api'</span>,<font></font>
                          content_type=<span class="hljs-string">'application/json'</span>,<font></font>
                          data=json.dumps({<span class="hljs-string">'age'</span>: <span class="hljs-number">100</span>}))<font></font>
        self.assertEqual(r.json, {<span class="hljs-string">'status'</span>: <span class="hljs-string">'bad input'</span>})<font></font>
        self.assertEqual(r.status_code, <span class="hljs-number">400</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_bad_age_post_api_endpoint</span>(<span class="hljs-params">self</span>):</span>
        r = self.app.post(<span class="hljs-string">'/api'</span>,<font></font>
                          content_type=<span class="hljs-string">'application/json'</span>,<font></font>
                          data=json.dumps({<span class="hljs-string">'name'</span>: <span class="hljs-string">'Den'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-string">'100'</span>}))<font></font>
        self.assertEqual(r.json, {<span class="hljs-string">'status'</span>: <span class="hljs-string">'bad input'</span>})<font></font>
        self.assertEqual(r.status_code, <span class="hljs-number">400</span>)<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    unittest.main()</code></pre></div></div><br>
<p> :</p><br>
<pre><code class="plaintext hljs">coverage report<font></font>
Name                                           Stmts   Miss  Cover<font></font>
------------------------------------------------------------------<font></font>
src/app.py                                        28      2    93%<font></font>
src/tests.py                                      37      0   100%<font></font>
------------------------------------------------------------------<font></font>
TOTAL                                             65      2    96%</code></pre><br>
<p>    action,    .         :</p><br>
<pre><code class="bash hljs">$ mkdir -p .github/workflows<font></font>
$ touch .github/workflows/test_on_push.yaml</code></pre><br>
<p> ,           ,   (,      ):</p><br>
<pre><code class="plaintext hljs">on:<font></font>
 push:<font></font>
   tags:<font></font>
     - '!refs/tags/*'<font></font>
   branches:<font></font>
     - '*'</code></pre><br>
<p>   ,      Ubuntu   :</p><br>
<pre><code class="plaintext hljs">jobs:<font></font>
 run_tests:<font></font>
   runs-on: [ubuntu-latest]</code></pre><br>
<p>     ,  ,  ,     :</p><br>
<pre><code class="plaintext hljs">steps:<font></font>
  #  <font></font>
 - uses: actions/checkout@master<font></font>
   #  python  <font></font>
 - uses: actions/setup-python@v1<font></font>
   with:<font></font>
     python-version: '3.8'<font></font>
     architecture: 'x64'<font></font>
 - name: Install requirements<font></font>
   #  <font></font>
   run: pip install -r requirements.txt<font></font>
 - name: Run tests<font></font>
   run: coverage run src/tests.py<font></font>
 - name: Tests report<font></font>
   run: coverage report</code></pre><br>
<div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><pre><code class="plaintext hljs">name: Run tests on any Push event<font></font>
#    push    ,    .<font></font>
#     <font></font>
on:<font></font>
  push:<font></font>
    tags:<font></font>
      - '!refs/tags/*'<font></font>
    branches:<font></font>
      - '*'<font></font>
jobs:<font></font>
  run_tests:<font></font>
    runs-on: [ubuntu-latest]<font></font>
    steps:<font></font>
      #  <font></font>
      - uses: actions/checkout@master<font></font>
      #  python  <font></font>
      - uses: actions/setup-python@v1<font></font>
        with:<font></font>
          python-version: '3.8'<font></font>
          architecture: 'x64'<font></font>
      - name: Install requirements<font></font>
        #  <font></font>
        run: pip install -r requirements.txt<font></font>
      - name: Run tests<font></font>
        run: coverage run src/tests.py<font></font>
      - name: Tests report<font></font>
        run: coverage report</code></pre></div></div><br>
<p>        .<br>
<img src="https://habrastorage.org/webt/qy/v7/by/qyv7byybfnvpnkurriqvydsp_xk.png"><br>
<em>    Actions</em></p><br>
<p>,         !         :<br>
<img src="https://habrastorage.org/webt/dr/vn/_s/drvn_sgrq-esw6sgxjiylhhy02w.png"><br>
<em>    Actions</em> </p><br>
<p> .         .   ! 3  8      .     ,   docker images. </p><br>
<p><strong>!      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></strong></p><br>
<p>   Dockerfile      . </p><br>
<div class="spoiler"><b class="spoiler_title">Dockerfile</b><div class="spoiler_text"><pre><code class="plaintext hljs">#    <font></font>
FROM python:3.8-alpine<font></font>
#        /app <font></font>
COPY ./ /app<font></font>
#   <font></font>
RUN apk update &amp;&amp; pip install -r /app/requirements.txt --no-cache-dir<font></font>
#   (  Distutils)<font></font>
RUN pip install -e /app<font></font>
#     <font></font>
EXPOSE 8080<font></font>
#      <font></font>
CMD web_server<font></font>
<font></font>
#    distutils     <font></font>
#CMD python /app/src/app.py</code></pre></div></div><br>
<p>         ,                  GitHub .       ,     *.yaml,    .         ,       .</p><br>
<p><img src="https://habrastorage.org/webt/2c/h8/5t/2ch85tdbuovsc7ywejh5gmrmvgw.png"><br>
<em>  GitHub</em> </p><br>
<p>DOCKER_LOGIN —   hub.docker.com<br>
DOCKER_PWD — <br>
DOCKER_NAME —       (  )</p><br>
<p>,  ,     action:</p><br>
<pre><code class="bash hljs">$ touch .github/workflows/pub_on_release.yaml</code></pre><br>
<p>         (     ).     “  ”:</p><br>
<pre><code class="plaintext hljs">on:<font></font>
 release:<font></font>
   types: [published]</code></pre><br>
<p><strong>!      on.event</strong><br>
  on.release   types,       2 : published  created.      2  .</p><br>
<p>           :</p><br>
<pre><code class="plaintext hljs">build_and_pub:<font></font>
  needs: [run_tests]</code></pre><br>
<p>needs —   ,     ,    run_tests</p><br>
<p><strong>!       ,              .</strong>      ,    .    needs             .</p><br>
<p>  ,     :</p><br>
<pre><code class="plaintext hljs">env:<font></font>
 LOGIN: ${{ secrets.DOCKER_LOGIN }}<font></font>
 NAME: ${{ secrets.DOCKER_NAME }}</code></pre><br>
<p>   ,       ,       registry:</p><br>
<pre><code class="plaintext hljs">steps:<font></font>
 - name: Login to docker.io<font></font>
   run:  echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin<font></font>
 - uses: actions/checkout@master<font></font>
 - name: Build image<font></font>
   run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile .<font></font>
 - name: Push image to docker.io<font></font>
   run: docker push $LOGIN/$NAME:${GITHUB_REF:11}</code></pre><br>
<p>${GITHUB_REF:11} —   ,            ( ,   ..),      "v0.0.0"     11 ,   "0.0.0".</p><br>
<p>     .    ,          registry,       .</p><br>
<p><img src="https://habrastorage.org/webt/mg/yt/i-/mgyti-mww_fcqsmbiqk6zli7swo.png"><br>
<em>      Actions</em> </p><br>
<p> :</p><br>
<p><img src="https://habrastorage.org/webt/ut/nw/vd/utnwvdtcprbqfpavnnirqmqim0s.png"><br>
<em>  docker hub </em> </p><br>
<p> ,      — deployment.    VPS   IP          .     VPS        ,         ,       .      .        ip.   ,    -  Flask c  API.<br>
 ,   1  “/”.<br>
GET   json      .<br>
POST —    :</p><br>
<pre><code class="json hljs">{
    <span class="hljs-attr">"owner"</span>: <span class="hljs-string">"  "</span>,
    <span class="hljs-attr">"repository"</span>: <span class="hljs-string">"  "</span>,
    <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"v0.0.1"</span>,  #   
    <span class="hljs-attr">"ports"</span>: {<span class="hljs-attr">"8080"</span>: <span class="hljs-number">8080</span>, “443”: <span class="hljs-number">443</span>} #     <font></font>
}</code></pre><br>
<p>     :</p><br>
<ol>
<li>  json    image</li>
<li>  </li>
<li>   ,      </li>
<li>  ,    ( -p)</li>
</ol><br>
<p>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">docker-py</a></p><br>
<p>              ,     API-KEY,      ,     header’ {Authorization: CI_TOKEN}</p><br>
<div class="spoiler"><b class="spoiler_title"> -  </b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># coding=utf-8</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> logging.config
<span class="hljs-keyword">import</span> logging.handlers<font></font>
<font></font>
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> request, jsonify
<span class="hljs-keyword">import</span> docker<font></font>
<font></font>
log = logging.getLogger(__name__)<font></font>
app = Flask(__name__)<font></font>
docker_client = docker.from_env()<font></font>
MY_AUTH_TOKEN = os.getenv(<span class="hljs-string">'CI_TOKEN'</span>, <span class="hljs-literal">None</span>)  <span class="hljs-comment">#      </span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_logging</span>():</span>
    <span class="hljs-string">"""
     
    :return:
    """</span>
    log_format = <span class="hljs-string">f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s"</span>
    formatters = {<span class="hljs-string">'basic'</span>: {<span class="hljs-string">'format'</span>: log_format}}<font></font>
    handlers = {<span class="hljs-string">'stdout'</span>: {<span class="hljs-string">'class'</span>: <span class="hljs-string">'logging.StreamHandler'</span>,
                           <span class="hljs-string">'formatter'</span>: <span class="hljs-string">'basic'</span>}}<font></font>
    level = <span class="hljs-string">'INFO'</span>
    handlers_names = [<span class="hljs-string">'stdout'</span>]<font></font>
    loggers = {<font></font>
        <span class="hljs-string">''</span>: {
            <span class="hljs-string">'level'</span>: level,
            <span class="hljs-string">'propagate'</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">'handlers'</span>: handlers_names<font></font>
        },<font></font>
    }<font></font>
    logging.basicConfig(level=<span class="hljs-string">'INFO'</span>, format=log_format)<font></font>
    log_config = {<font></font>
        <span class="hljs-string">'version'</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">'disable_existing_loggers'</span>: <span class="hljs-literal">False</span>,
        <span class="hljs-string">'formatters'</span>: formatters,
        <span class="hljs-string">'handlers'</span>: handlers,
        <span class="hljs-string">'loggers'</span>: loggers<font></font>
    }<font></font>
    logging.config.dictConfig(log_config)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_active_containers</span>():</span>
    <span class="hljs-string">"""
       
    :return:
    """</span><font></font>
    containers = docker_client.containers.list()<font></font>
    result = []<font></font>
    <span class="hljs-keyword">for</span> container <span class="hljs-keyword">in</span> containers:<font></font>
        result.append({<font></font>
            <span class="hljs-string">'short_id'</span>: container.short_id,
            <span class="hljs-string">'container_name'</span>: container.name,
            <span class="hljs-string">'image_name'</span>: container.image.tags,
            <span class="hljs-string">'created'</span>:  container.attrs[<span class="hljs-string">'Created'</span>],
            <span class="hljs-string">'status'</span>:  container.status,
            <span class="hljs-string">'ports'</span>:  container.ports,<font></font>
        })<font></font>
    <span class="hljs-keyword">return</span> result<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_container_name</span>(<span class="hljs-params">item: dict</span>) -&gt; [str, str]:</span>
    <span class="hljs-string">"""
      image  POST 
    :param item:
    :return:
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isinstance(item, dict):
        <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
    owner = item.get(<span class="hljs-string">'owner'</span>)<font></font>
    repository = item.get(<span class="hljs-string">'repository'</span>)<font></font>
    tag = item.get(<span class="hljs-string">'tag'</span>, <span class="hljs-string">'latest'</span>).replace(<span class="hljs-string">'v'</span>, <span class="hljs-string">''</span>)
    <span class="hljs-keyword">if</span> owner <span class="hljs-keyword">and</span> repository <span class="hljs-keyword">and</span> tag:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f'<span class="hljs-subst">{owner}</span>/<span class="hljs-subst">{repository}</span>:<span class="hljs-subst">{tag}</span>'</span>, repository
    <span class="hljs-keyword">if</span> repository <span class="hljs-keyword">and</span> tag:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f'<span class="hljs-subst">{repository}</span>:<span class="hljs-subst">{tag}</span>'</span>, repository
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>, <span class="hljs-string">''</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">kill_old_container</span>(<span class="hljs-params">container_name: str</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
       ,  
    :param container_name:
    :return:
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#   </span><font></font>
        container = docker_client.containers.get(container_name)<font></font>
        <span class="hljs-comment"># </span><font></font>
        container.kill()<font></font>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment">#      </span>
        log.warning(<span class="hljs-string">f'Error while delete container <span class="hljs-subst">{container_name}</span>, <span class="hljs-subst">{e}</span>'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment">#   ,    </span><font></font>
        log.debug(docker_client.containers.prune())<font></font>
    log.info(<span class="hljs-string">f'Container deleted. container_name = <span class="hljs-subst">{container_name}</span>'</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">deploy_new_container</span>(<span class="hljs-params">image_name: str, container_name: str, ports: dict = None</span>):</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#   image  docker hub'a</span>
        log.info(<span class="hljs-string">f'pull <span class="hljs-subst">{image_name}</span>, name=<span class="hljs-subst">{container_name}</span>'</span>)<font></font>
        docker_client.images.pull(image_name)<font></font>
        log.debug(<span class="hljs-string">'Success'</span>)<font></font>
        kill_old_container(container_name)<font></font>
        log.debug(<span class="hljs-string">'Old killed'</span>)
        <span class="hljs-comment">#   </span>
        docker_client.containers.run(image=image_name, name=container_name, detach=<span class="hljs-literal">True</span>, ports=ports)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
        log.error(<span class="hljs-string">f'Error while deploy container <span class="hljs-subst">{container_name}</span>, \n<span class="hljs-subst">{e}</span>'</span>)
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'status'</span>: <span class="hljs-literal">False</span>, <span class="hljs-string">'error'</span>: str(e)}, <span class="hljs-number">400</span>
    log.info(<span class="hljs-string">f'Container deployed. container_name = <span class="hljs-subst">{container_name}</span>'</span>)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">'status'</span>: <span class="hljs-literal">True</span>}, <span class="hljs-number">200</span><font></font>
<font></font>
<span class="hljs-meta">@app.route('/', methods=['GET', 'POST'])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">MainHandler</span>():</span>
    <span class="hljs-string">"""
    GET -     
    POST -   
      :
    {
        "owner": "gonfff",
        "repository": "ci_example",
        "tag": "v0.0.1",
         "ports": {"8080": 8080}
    }
    :return:
    """</span>
    <span class="hljs-keyword">if</span> request.headers.get(<span class="hljs-string">'Authorization'</span>) != MY_AUTH_TOKEN:
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'message'</span>: <span class="hljs-string">'Bad token'</span>}), <span class="hljs-number">401</span>
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">'GET'</span>:
        <span class="hljs-keyword">return</span> jsonify(get_active_containers())
    <span class="hljs-keyword">elif</span> request.method == <span class="hljs-string">'POST'</span>:<font></font>
        log.debug(<span class="hljs-string">f'Recieved <span class="hljs-subst">{request.data}</span>'</span>)<font></font>
        image_name, container_name = get_container_name(request.json)<font></font>
        ports = request.json.get(<span class="hljs-string">'ports'</span>) <span class="hljs-keyword">if</span> request.json.get(<span class="hljs-string">'ports'</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><font></font>
        result, status = deploy_new_container(image_name, container_name, ports)<font></font>
        <span class="hljs-keyword">return</span> jsonify(result), status<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    init_logging()<font></font>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> MY_AUTH_TOKEN:<font></font>
        log.error(<span class="hljs-string">'There is no auth token in env'</span>)<font></font>
        sys.exit(<span class="hljs-number">1</span>)<font></font>
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">5000</span>)<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div></div><br>
<p>       setup.py     .     :</p><br>
<pre><code class="bash hljs">$ python3 setup.sy install</code></pre><br>
<p>           .<br>
              ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">systemd</a><br>
   :</p><br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=Deployment web server<font></font>
After=network-online.target<font></font>
<font></font>
[Service]<font></font>
Type=simple<font></font>
RestartSec=3<font></font>
ExecStart=/usr/local/bin/ci_example<font></font>
Environment=CI_TOKEN=#&lt;I generate it with $(openssl rand -hex 20)&gt;<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target<font></font>
</code></pre><br>
<p>   :</p><br>
<pre><code class="bash hljs">$ sudo systemctl daemon-reload<font></font>
$ sudo systemctl <span class="hljs-built_in">enable</span> ci_example.service<font></font>
$ sudo systemctl start ci_example.service</code></pre><br>
<p>         </p><br>
<pre><code class="bash hljs">$ sudo systemctl status ci_example.service</code></pre><br>
<p>  ,      .      ip-    CI_TOKEN      .<br>
        curl   github,   ,      POST       json.     ,       ubuntu (    ) curl’,      ,       :</p><br>
<pre><code class="plaintext hljs">deploy:<font></font>
  needs: [build_and_pub]<font></font>
  runs-on: [ubuntu-latest]<font></font>
  steps:<font></font>
    - name: Set tag to env<font></font>
       run: echo ::set-env name=TAG::$(echo ${GITHUB_REF:11})<font></font>
    - name: Send webhook for deploy<font></font>
run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.TAG }}\", \"ports\": {\"8080\": 8080}}'"<font></font>
</code></pre><br>
<p><strong>:     --fail,      ,       . </strong><br>
  ,     ,     ,       GITHUB_REF -       ,     .     ,  .</p><br>
<div class="spoiler"><b class="spoiler_title">Action   </b><div class="spoiler_text"><pre><code class="plaintext hljs">name: Publish on Docker Hub and Deploy<font></font>
<font></font>
on:<font></font>
  release:<font></font>
    types: [published]<font></font>
  #      <font></font>
<font></font>
jobs:<font></font>
  run_tests:<font></font>
    #         <font></font>
    runs-on: [ubuntu-latest]<font></font>
    steps:<font></font>
      #  <font></font>
      - uses: actions/checkout@master<font></font>
      #  python  <font></font>
      - uses: actions/setup-python@v1<font></font>
        with:<font></font>
          python-version: '3.8'<font></font>
          architecture: 'x64'<font></font>
      - name: Install requirements<font></font>
        #  <font></font>
        run: pip install -r requirements.txt<font></font>
      - name: Run tests<font></font>
        #  <font></font>
        run: coverage run src/tests.py<font></font>
      - name: Tests report<font></font>
        run: coverage report<font></font>
<font></font>
  build_and_pub:<font></font>
    #     <font></font>
    needs: [run_tests]<font></font>
    runs-on: [ubuntu-latest]<font></font>
    env:<font></font>
      LOGIN: ${{ secrets.DOCKER_LOGIN }}<font></font>
      NAME: ${{ secrets.DOCKER_NAME }}<font></font>
    steps:<font></font>
      - name: Login to docker.io<font></font>
        #     docker.io<font></font>
        run:  echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin<font></font>
        #  <font></font>
      - uses: actions/checkout@master<font></font>
      - name: Build image<font></font>
        #  image        hub.docker .. login/repository:version<font></font>
        run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile .<font></font>
      - name: Push image to docker.io<font></font>
        #    registry<font></font>
        run: docker push $LOGIN/$NAME:${GITHUB_REF:11}<font></font>
<font></font>
  deploy:<font></font>
    #         registry,     <font></font>
    #    curl  <font></font>
    needs: [build_and_pub]<font></font>
    runs-on: [ubuntu-latest]<font></font>
    steps:<font></font>
      - name: Set tag to env<font></font>
        run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:11})<font></font>
      - name: Send webhook for deploy<font></font>
        run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.RELEASE_VERSION }}\", \"ports\": {\"8080\": 8080}}'"</code></pre></div></div><br>
<p>,    ,        .<br>
<img src="https://habrastorage.org/webt/07/dn/5q/07dn5qrqodyyfaulm6gpey7w8my.png"><br>
<em>     Actions</em> </p><br>
<p>   GET     (     ):<br>
<img src="https://habrastorage.org/webt/gq/1w/yg/gq1wygbewjefugj8itjchn2ucki.png"><br>
<em>  VPS </em> </p><br>
<p>      :<br>
<img src="https://habrastorage.org/webt/hs/9x/hz/hs9xhzawrwliyoptcccjd-48bco.png"><br>
<em>GET    </em> </p><br>
<img src="https://habrastorage.org/webt/jf/fy/xc/jffyxcdf8zyzfylylyufv8wlcp0.png" alt="デプロイされたコンテナへのPOSTリクエスト"><br>
<p><em>POST    </em></p><br>
<p><strong></strong><br>
GitHub Actions     ,       ,      .     .<br>
       services.<br>
        webhook       .<br>
           helm charts       k8s</p><br>
<p>       ,  GitHub Actions       .</p><br>
<p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a><br>
  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="></a></p><cut text=" "></cut></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja476346/index.html">Goの機能的パラダイム：基本的なテクニック</a></li>
<li><a href="../ja476348/index.html">州立大学の化学者がITの原則を仕事に取り入れ、チームリーダーになった方法</a></li>
<li><a href="../ja476352/index.html">フィールドサービス管理とフィールドサービス。ロシアはフィールドサービスエンジニアの管理に熟成しましたか？</a></li>
<li><a href="../ja476358/index.html">マイクロサービスのサービスメッシュ。パートI</a></li>
<li><a href="../ja476366/index.html">屋根が通りました：セラピストの時間だと理解する方法と、彼を見つける方法</a></li>
<li><a href="../ja476370/index.html">JetBrainsの公式ウェブサイトがロシア語で利用可能になりました</a></li>
<li><a href="../ja476372/index.html">カテゴリー理論は数学が等式を放棄することを可能にします</a></li>
<li><a href="../ja476374/index.html">ライト兄弟：最初の特許トロール</a></li>
<li><a href="../ja476378/index.html">CUDAを簡単に-Intelがデータセンター向け7nm GPUを発表</a></li>
<li><a href="../ja476382/index.html">14個のパッチパネルを備えたサーバーキャビネットまたはサーバーで5日間使用</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>