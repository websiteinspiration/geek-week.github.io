<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍🏭 ⤵️ 🔳 危険なstdの話:: enable_shared_from_this、またはアンチパターン「ゾンビ」 🚍 👩‍🍳 👩🏼‍🔬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、std :: enable_shared_from_thisを使用すると自然に発生する危険なアンチパターン「ゾンビ」について説明しています。この資料は、最新のC ++テクノロジとアーキテクチャの接点にあります。
 
 前書き
 C ++ 11は、メモリを操作するための素晴らしいツールを...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>危険なstdの話:: enable_shared_from_this、またはアンチパターン「ゾンビ」</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471326/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この記事では、std :: enable_shared_from_thisを使用すると自然に発生する危険なアンチパターン「ゾンビ」について説明しています。</font><font style="vertical-align: inherit;">この資料は、最新のC ++テクノロジとアーキテクチャの接点にあります。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C ++ 11は、メモリを操作するための素晴らしいツールを開発者に提供しました-スマートポインターstd :: unique_ptrおよびstd :: shared_ptr + std :: weak_ptrの束。</font><font style="vertical-align: inherit;">利便性と安全性のためのスマートポインターの使用は、生のポインターの使用をはるかに上回ります。</font><font style="vertical-align: inherit;">スマートポインターは、実際に広く使用されています。</font><font style="vertical-align: inherit;">開発者が動的に作成されたエンティティの作成/削除の正確さを追跡するよりも高いレベルの問題に集中できるようにします。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
std :: enable_shared_from_thisクラステンプレートも標準の一部であり、最初に出会ったときはかなり奇妙に見えます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、それを使用する方法について説明します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">教育プログラム</font></font></h2><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAIIとスマートポインタ</font></font></b><div class="spoiler_text">    —   <b>  </b>,   .     RAII (Resource acquisition is initialization),            ,     ,  :<br>
 — ;<br>
 —    ;<br>
 —   (http, websockets);<br>
 —   (threads);<br>
 — ;<br>
 —  (   ).<br>
      (        ,    deleter —      ), :<br>
 —      ;<br>
 —   ,<br>
  «»            —  (std::shared_ptr)   (std::unique_ptr).    « RAII»:    /  ,  /     .<br>
std::shared_ptr    .      (    std::shared_ptr)     (    std::weak_ptr,     std::shared_ptr).       ,     .   std::shared_ptr         ,           .                  .<br>
RAII     ,    delete/delete[]/free/close/reset/unlock, ..:<br>
 —     ;<br>
 —        ;<br>
 —        ;<br>
 —     c++      ,        .<br>
     ,  -        .<br>
     :<br>
 —        (     );<br>
 —    ,        .<br>
              .<br>
      :<br>
 —       —     ,      —         ;<br>
 —        (Valgrind, Clang LeakSanitizer  ..);<br>
 — «    »;<br>
 — «   »;<br>
 — «    ».<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">std :: enable_shared_from_this</font></font></b><div class="spoiler_text"> C++11    std::enable_shared_from_this.  ,     std::enable_shared_from_this,       .<br>
   std::enable_shared_from_this?<br>
  - ,     std::shared_ptr,    (shared_from_this())   (weak_from_this(),   C++17)   std::shared_ptr,     .  shared_from_this()  weak_from_this()     .<br>
<br>
<b>  ?     std::shared_ptr&lt;T&gt;(this)</b><br>
, .  std::shared_ptr',        ,      .      .<br>
<br>
   std::enable_shared_from_this       std::shared_ptr.   ,    ,   std::unique_ptr —    .    std::shared_ptr.<br>
<br>
<b>         ?</b><br>
, .    -:<br>
 —      ,    std::shared_ptr;<br>
 —    private  protected;<br>
 —  copy-  move-.<br>
   ,        —           std::shared_ptr,        .<br>
      ,      .<br>
 ,    PIMPL:     —  —      std::shared_ptr,         .<br>
<br>
std::enable_shared_from_this     ,       .<br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要点をつかむ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事で提供されているすべてのコード例は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">githubで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公開されてい</font><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードは、現代のC ++の通常の安全な使用を装った悪いテクニックを示しています</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">単環式</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題を予告するものは何もないようです。</font><font style="vertical-align: inherit;">クラス宣言は単純で簡単に見えます。</font><font style="vertical-align: inherit;">1つの「小さな」詳細を除いて-何らかの理由でstd :: enable_shared_from_thisからの継承が適用されます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleCyclic.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;functional&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleCyclic {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cyclic</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> <span class="hljs-built_in">std</span>::enable_shared_from_this&lt;Cyclic&gt;<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Cyclic&gt; <span class="hljs-title">create</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    Cyclic(<span class="hljs-keyword">const</span> Cyclic&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    Cyclic(Cyclic&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    Cyclic&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-keyword">const</span> Cyclic&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    Cyclic&amp; <span class="hljs-keyword">operator</span>=(Cyclic&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
<font></font>
    ~Cyclic();<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:<font></font>
    Cyclic();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-keyword">void</span>(<span class="hljs-keyword">void</span>)&gt; _fn;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace SimpleCyclic</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして実装では：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleCyclic.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimpleCyclic.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleCyclic {<font></font>
Cyclic::Cyclic() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
Cyclic::~Cyclic()<font></font>
{<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Cyclic&gt; <span class="hljs-title">Cyclic::create</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Cyclic&gt;(<span class="hljs-keyword">new</span> Cyclic);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Cyclic::doSomething</span><span class="hljs-params">()</span>
</span>{<font></font>
    _fn = [shis = shared_from_this()](){};<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
}<font></font>
} <span class="hljs-comment">// namespace SimpleCyclic</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimpleCyclic/SimpleCyclic.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">auto</span> simpleCyclic = SimpleCyclic::Cyclic::create();<font></font>
    simpleCyclic-&gt;doSomething();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>N12SimpleCyclic6CyclicE::doSomething<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
doSomething（）関数の本体では、クラスインスタンス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自体が</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、配置されたstd :: shared_ptrの追加の強力なコピーを作成します。次に、一般化されたキャプチャを使用して、このコピーは、無害なstd ::関数を装ってクラスデータフィールドに割り当てられたラムダ関数に配置されます。 doSomething（）を呼び出すと循環参照が発生し、外部の強力なリンクがすべて破棄された後でも、クラスインスタンスは破棄されなくなります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリリークがあります。 SimpleCyclic :: Cyclic ::〜Cyclicデストラクタは呼び出されません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラスインスタンスはそれ自体を「保持」します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードが結びついてしまいました。</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/xp/jj/_a/xpjj_atj4bf0av8kar46ebxqqew.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここからの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像</font><font style="vertical-align: inherit;">）</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、これは「ゾンビ」アンチパターンですか？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
いいえ、これは単なるトレーニングです。最も興味深いものはまだありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜ開発者はこれを書いたのですか？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
合成例。</font><font style="vertical-align: inherit;">このようなコードが調和して取得される状況については、私は知りません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、動的コード分析はサイレントですか？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
いいえ、Valgrindは正直にメモリリークを報告しました：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポストValgrind</font></font></b><div class="spoiler_text"><blockquote>96 (64 direct, 32 indirect) bytes in 1 blocks are <b>definitely lost</b> in loss record 29 of 46<br>
 in SimpleCyclic::Cyclic::create() in /Users/User/Projects/Zomby_antipattern_concept/SimpleCyclic/SimpleCyclic.cpp:15<br>
 1: malloc in /usr/local/Cellar/valgrind/HEAD-60ab74a/lib/valgrind/vgpreload_memcheck-amd64-darwin.so<br>
 2: operator new(unsigned long) in /usr/lib/libc++abi.dylib<br>
 3: SimpleCyclic::Cyclic::create() in /Users/User/Projects/Zomby_antipattern_concept/SimpleCyclic/SimpleCyclic.cpp:15<br>
 4: main in /Users/User/Projects/Zomby_antipattern_concept/SimpleCyclic/main.cpp:5<br>
</blockquote><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">二環式</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、ヘッダーファイルは完全に正しく簡潔に見えます。</font><font style="vertical-align: inherit;">特定の実装をstd :: shared_ptrに格納するファサードを宣言しました。</font><font style="vertical-align: inherit;">前の例とは異なり、継承-from std :: enable_shared_from_this-がありません。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pimplcyclic.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> PimplCyclic {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cyclic</span>
{</span>
<span class="hljs-keyword">public</span>:<font></font>
    Cyclic();<font></font>
    ~Cyclic();<font></font>
<font></font>
<span class="hljs-keyword">private</span>:
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Impl</span>;</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Impl&gt; _impl;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace PimplCyclic</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして実装では：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pimplcyclic.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;functional&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"PimplCyclic.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> PimplCyclic {<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cyclic</span>:</span>:Impl : <span class="hljs-keyword">public</span> <span class="hljs-built_in">std</span>::enable_shared_from_this&lt;Cyclic::Impl&gt;<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:<font></font>
    ~Impl()<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span>
    </span>{<font></font>
        _fn = [shis = shared_from_this()](){};<font></font>
<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }<font></font>
<font></font>
<span class="hljs-keyword">private</span>:
    <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-keyword">void</span>(<span class="hljs-keyword">void</span>)&gt; _fn;<font></font>
};<font></font>
<font></font>
Cyclic::Cyclic()<font></font>
    : _impl(<span class="hljs-built_in">std</span>::make_shared&lt;Impl&gt;())<font></font>
{<font></font>
    <span class="hljs-keyword">if</span> (_impl) {<font></font>
        _impl-&gt;doSomething();<font></font>
    }<font></font>
}<font></font>
<font></font>
Cyclic::~Cyclic()<font></font>
{<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
}<font></font>
} <span class="hljs-comment">// namespace PimplCyclic</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"PimplCyclic/PimplCyclic.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">auto</span> pimplCyclic = PimplCyclic::Cyclic();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>N11PimplCyclic6Cyclic4ImplE::doSomething<br>
N11PimplCyclic6CyclicE::~Cyclic<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Impl :: doSomething（）を呼び出すと、Implクラスのインスタンスに循環参照が作成されます。</font><font style="vertical-align: inherit;">ファサードは正しく破壊されていますが、実装はリークしています。</font><font style="vertical-align: inherit;">デストラクタPimplCyclic :: Cyclic :: Impl ::〜Implは呼び出されません。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例は再び合成されていますが、今回はより危険です-悪い機器はすべて実装内にあり、広告には表示されません。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、ユーザーコードから循環リンクを作成するために、構築以外のアクションは必要ありませんでした。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Valgrindに直面した動的分析で、今回はリークが明らかになりました。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ポストValgrind</font></font></b><div class="spoiler_text"><blockquote>96 bytes in 1 blocks are <b>definitely lost</b> in loss record 29 of 46<br>
 in PimplCyclic::Cyclic::Cyclic() in /Users/User/Projects/Zomby_antipattern_concept/PimplCyclic/PimplCyclic.cpp:28<br>
 1: malloc in /usr/local/Cellar/valgrind/HEAD-60ab74a/lib/valgrind/vgpreload_memcheck-amd64-darwin.so<br>
 2: operator new(unsigned long) in /usr/lib/libc++abi.dylib<br>
 3: std::__1::__libcpp_allocate(unsigned long, unsigned long) in /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/include/c++/v1/new:252<br>
 4: std::__1::allocator&lt;std::__1::__shared_ptr_emplace&lt;PimplCyclic::Cyclic::Impl, std::__1::allocator&lt;PimplCyclic::Cyclic::Impl&gt; &gt; &gt;::allocate(unsigned long, void const*) in /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/include/c++/v1/memory:1813<br>
 5: std::__1::shared_ptr&lt;PimplCyclic::Cyclic::Impl&gt; std::__1::shared_ptr&lt;PimplCyclic::Cyclic::Impl&gt;::make_shared&lt;&gt;() in /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/include/c++/v1/memory:4326<br>
 6: _ZNSt3__1L11make_sharedIN11PimplCyclic6Cyclic4ImplEJEEENS_9enable_ifIXntsr8is_arrayIT_EE5valueENS_10shared_ptrIS5_EEE4typeEDpOT0_ in /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/include/c++/v1/memory:4706<br>
 7: PimplCyclic::Cyclic::Cyclic() in /Users/User/Projects/Zomby_antipattern_concept/PimplCyclic/PimplCyclic.cpp:28<br>
 8: PimplCyclic::Cyclic::Cyclic() in /Users/User/Projects/Zomby_antipattern_concept/PimplCyclic/PimplCyclic.cpp:29<br>
 9: main in /Users/User/Projects/Zomby_antipattern_concept/PimplCyclic/main.cpp:5<br>
</blockquote><br>
</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実装がstd :: shared_ptrに格納されているPimplを見るのは少し疑わしいです。</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
生のポインタに基づく古典的なPimplは古すぎるので、std :: unique_ptrには、コピーセマンティクスの禁止をファサードに拡張するという副作用があります。</font><font style="vertical-align: inherit;">このようなファサードは、所有権のイディオムを実装しますが、これはアーキテクチャのアイデアに対応していない場合があります。</font><font style="vertical-align: inherit;">std :: shared_ptrを使用して実装を格納することから、クラスは共有所有権を提供するように設計されていると結論付けます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは従来のリークとどのように異なりますか？後続の削除なしで明示的にnewを呼び出すことによってメモリを割り当てますか？</font><font style="vertical-align: inherit;">同じように、インターフェースと実装のすべてが美しくなります-バグ。</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは</font><font style="vertical-align: inherit;">足元に自分を撃つための</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現代的な</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法を</font><font style="vertical-align: inherit;">議論してい</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アンチパターン「ゾンビ」</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、上記の資料から明らかです：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -スマートポインターをノードに結び付けることができます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -std :: enable_shared_from_thisの使用は、これに貢献できます。</font><font style="vertical-align: inherit;">クラスのインスタンスをノードに結びつけることができ、外部の助けはほとんど必要ありません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして今-注意-記事の重要な質問：スマートポインターに包まれたリソースの種類は重要ですか？</font><font style="vertical-align: inherit;">非同期実行のHTTPS接続について、RAIIファイルのケアとRAIIのケアに違いはありますか？</font></font></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplezomby</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゾンビの後続のすべての例に共通のコードは、共通ライブラリに移動されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ささやかな名前のマ​​ネージャーと抽象的なゾンビインターフェイス：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共通/ Manager.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Listener</span>;</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Manager</span>
{</span>
<span class="hljs-keyword">public</span>:<font></font>
    Manager() = <span class="hljs-keyword">default</span>;<font></font>
    Manager(<span class="hljs-keyword">const</span> Manager&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    Manager(Manager&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    Manager&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-keyword">const</span> Manager&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    Manager&amp; <span class="hljs-keyword">operator</span>=(Manager&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
<font></font>
    <span class="hljs-keyword">virtual</span> ~Manager() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span> </span>= <span class="hljs-number">0</span>;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace Common</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リスナーの抽象インターフェース。テキストをスレッドセーフに受け入れる準備ができています。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共通/ Listener.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Listener</span>
{</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">virtual</span> ~Listener() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
    <span class="hljs-keyword">using</span> Data = <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>;<font></font>
<font></font>
    <span class="hljs-comment">// thread-safe</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processData</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-keyword">const</span> Data&gt; data)</span> </span>= <span class="hljs-number">0</span>;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace Common</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンソールにテキストを表示するリスナー。</font><font style="vertical-align: inherit;">私の記事「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Singletonを呼び出すときに未定義の動作を回避するためのテクニック」の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SingletonSharedコンセプトを実装し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共通/ Impl / WriteToConsoleListener.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;mutex&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Listener.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WriteToConsoleListener</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> Listener<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:<font></font>
    WriteToConsoleListener(<span class="hljs-keyword">const</span> WriteToConsoleListener&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    WriteToConsoleListener(WriteToConsoleListener&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    WriteToConsoleListener&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-keyword">const</span> WriteToConsoleListener&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    WriteToConsoleListener&amp; <span class="hljs-keyword">operator</span>=(WriteToConsoleListener&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
<font></font>
    ~WriteToConsoleListener() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;WriteToConsoleListener&gt; <span class="hljs-title">instance</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    <span class="hljs-comment">// blocking</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">processData</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-keyword">const</span> Data&gt; data)</span> <span class="hljs-keyword">override</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:<font></font>
    WriteToConsoleListener();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::mutex _mutex;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace Common</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">共通/ Impl / WriteToConsoleListener.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"WriteToConsoleListener.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {<font></font>
WriteToConsoleListener::WriteToConsoleListener() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
WriteToConsoleListener::~WriteToConsoleListener()<font></font>
{<font></font>
    <span class="hljs-keyword">auto</span> lock = <span class="hljs-built_in">std</span>::lock_guard(_mutex);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;WriteToConsoleListener&gt; <span class="hljs-title">WriteToConsoleListener::instance</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> inst = <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;WriteToConsoleListener&gt;(<span class="hljs-keyword">new</span> WriteToConsoleListener);
    <span class="hljs-keyword">return</span> inst;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">WriteToConsoleListener::processData</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-keyword">const</span> Data&gt; data)</span>
</span>{
    <span class="hljs-keyword">if</span> (data) {
        <span class="hljs-keyword">auto</span> lock = <span class="hljs-built_in">std</span>::lock_guard(_mutex);
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; *data &lt;&lt; <span class="hljs-built_in">std</span>::flush;<font></font>
    }<font></font>
}<font></font>
<font></font>
} <span class="hljs-comment">// namespace Common</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に、最初のゾンビは、最もシンプルで最も独創的です。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Manager.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Listener</span>;</span>
} <span class="hljs-comment">// namespace Common</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Zomby</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> Common::Manager, <span class="hljs-keyword">public</span> <span class="hljs-built_in">std</span>::enable_shared_from_this&lt;Zomby&gt;<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">create</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    ~Zomby() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span> <span class="hljs-keyword">override</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:<font></font>
    Zomby();<font></font>
<font></font>
    <span class="hljs-keyword">using</span> Semaphore = <span class="hljs-built_in">std</span>::atomic&lt;<span class="hljs-keyword">bool</span>&gt;;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; _listener;<font></font>
    Semaphore _semaphore = <span class="hljs-literal">false</span>;
    <span class="hljs-built_in">std</span>::thread _thread;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SimpleZomby.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimpleZomby.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Listener.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SimpleZomby {
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">Zomby::create</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt;(<span class="hljs-keyword">new</span> Zomby());<font></font>
}<font></font>
<font></font>
Zomby::Zomby() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
Zomby::~Zomby()<font></font>
{<font></font>
    _semaphore = <span class="hljs-literal">false</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_thread.joinable()) {<font></font>
        _thread.detach();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_listener) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
        _listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SimpleZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()](){
        <span class="hljs-keyword">while</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(<span class="hljs-string">"SimpleZomby is alive!\n"</span>));
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::seconds(<span class="hljs-number">1</span>));<font></font>
        }<font></font>
    });<font></font>
}<font></font>
} <span class="hljs-comment">// namespace SimpleZomby</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゾンビはラムダ関数を別のスレッドで実行し、定期的に文字列をリスナーに送信します。仕事用のラムダ関数には、ゾンビクラスのフィールドであるセマフォとリスナーが必要です。ラムダ関数はそれらを個別のフィールドとしてキャプチャしませんが、オブジェクトをアグリゲーターとして使用します。ラムダ関数が完了する前にゾンビクラスのインスタンスを破棄すると、未定義の動作が発生します。これを回避するために、ラムダ関数はshared_from_this（）の強力なコピーをキャプチャします。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゾンビデストラクタでは、セマフォがfalseに設定され、その後、ストリームに対してdetach（）が呼び出されます。セマフォを設定すると、スレッドにシャットダウンが指示されます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デストラクタでは、detach（）ではなく、join（）を呼び出す必要がありました。</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
...そして、許容できないかもしれない無期限に実行をブロックするデストラクタを取得します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">したがって、これはRAIIの違反です。</font><font style="vertical-align: inherit;">RAIIは、リソースを解放した後でのみデストラクタを終了することになっていた！</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
厳密に言えば-はい、ゾンビはデストラクタではなく</font><font style="vertical-align: inherit;">、リソースのリリースを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行</font></font></b><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">し、リリースが行われることを</font></b><font style="vertical-align: inherit;">唯一の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">保証</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">いつか生産された-多分すぐに、または多分本当にではない。</font><font style="vertical-align: inherit;">そして、メインが早く作業を終了する可能性さえあります-その後、スレッドはオペレーティングシステムによって強制的にクリアされます。</font><font style="vertical-align: inherit;">しかし実際には、「正しい」RAIIと「間違った」RAIIの間の線は非常に細い場合があります。たとえば、一時ファイルのデストラクタでstd :: filesystem :: remove（）を呼び出す「正しい」RAIIは、その制御を返す可能性があります。書き込みコマンドがまだ揮発性キャッシュのいずれかにあり、正直にハードディスクの磁気ディスクに書き込まれない瞬間。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;chrono&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Impl/WriteToConsoleListener.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SimpleZomby/SimpleZomby.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">auto</span> writeToConsoleListener = Common::WriteToConsoleListener::instance();<font></font>
<font></font>
    {<font></font>
        <span class="hljs-keyword">auto</span> simpleZomby = SimpleZomby::Zomby::create();<font></font>
        simpleZomby-&gt;runOnce(writeToConsoleListener);<font></font>
<font></font>
        <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">4500</span>));<font></font>
    } <span class="hljs-comment">// Zomby should be killed here</span><font></font>
<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-string">"============================================================\n"</span>
            &lt;&lt; <span class="hljs-string">"|                      Zomby was killed                    |\n"</span>
            &lt;&lt; <span class="hljs-string">"============================================================\n"</span>;
        <span class="hljs-keyword">if</span> (writeToConsoleListener) {<font></font>
            writeToConsoleListener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">5000</span>));<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
SimpleZomby is alive!<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログラムの出力からわかるように、</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -ゾンビはスコープを離れた後でも機能し続けました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -ゾンビまたはWriteToConsoleListenerのいずれに対してもデストラクタが呼び出されませんでした。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリリークが発生しました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リソースリークがありました。</font><font style="vertical-align: inherit;">そして、この場合のリソースは実行のスレッドです。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
停止するはずだったコードは、引き続き別のスレッドで機能しました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WriteToConsoleListenerリークは、私の記事「</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Singletonを呼び出すときに不確定な動作を回避</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">する」のSingletonWeakテクニックを使用することで防ぐことができましたが</font><font style="vertical-align: inherit;">、私は意図的にしませんでした。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mg/qu/e3/mgque3fstboi4ot2hvdwniafixe.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここからの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像</font><font style="vertical-align: inherit;">）</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜ「ゾンビ」？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼が殺されたので、彼はまだ生きています。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、前の例の循環参照とどのように異なりますか？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
失われたリソースは単なるメモリの一部ではなく、それを起動したスレッドとは無関係に独立してコードを実行するものです。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ゾンビ」を破壊することは可能ですか？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
スコープを離れた後（つまり、ゾンビに対する外部の強い参照と弱い参照をすべて破棄した後）-不可能です。ゾンビは、自分自身を破壊することを決定したときに破壊されます（そうです、それは活発な行動を伴うものです）。アプリケーションの終了時にオペレーティングシステムがクリーンアップするまで存続します。もちろん、ユーザーコードはゾンビコードの終了条件に何らかの影響を与える可能性がありますが、この影響は間接的で実装に依存します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして、スコープを離れる前に？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ゾンビデストラクタを明示的に呼び出すことはできますが、スマートポインタデストラクタによってオブジェクトが繰り返し破棄されるため、未定義の動作を回避することはできません。これはRAIIとの戦いです。または、明示的な初期化解除の機能を追加することもできます-これはRAIIの拒否です。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、スレッドを開始してからdetach（）を実行するだけの場合とどう違うのですか？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ゾンビの場合、detach（）の単純な呼び出しとは対照的に、フローを停止するという考えがあります。それだけでは機能しません。適切なアイデアがあると、問題を隠すのに役立ちます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例はまだ合成ですか？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
部分的に。</font><font style="vertical-align: inherit;">この単純な例では、shared_from_this（）を使用する十分な理由がありませんでした。たとえば、weak_from_this（）をキャプチャしたり、クラスのすべての必要なフィールドをキャプチャしたりできます。</font><font style="vertical-align: inherit;">ただし、タスクが複雑な場合、バランスは</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
shared_from_this（）に</font><font style="vertical-align: inherit;">シフトする可能性があり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Valgrind、Valgrind！</font><font style="vertical-align: inherit;">ゾンビに対する追加の防衛線があります！</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
悲しいかなああ-しかし、Valgrindはメモリリークを明らかにしませんでした。</font><font style="vertical-align: inherit;">なぜ私は知りません。</font><font style="vertical-align: inherit;">診断では、</font><font style="vertical-align: inherit;">システム機能を示す</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「失われた可能性のある」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エントリのみが存在し</font><font style="vertical-align: inherit;">ます—空のメインを実行するときとほぼ同じ量です。</font><font style="vertical-align: inherit;">ユーザーコード参照はありません。</font><font style="vertical-align: inherit;">他の動的分析ツールの方が優れている場合がありますが、それでも信頼できる場合は、このまま読み進めてください。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステッピングゾンビ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例のコードは、ステップresolveDnsName ---&gt; connectTcp ---&gt; establishedSsl ---&gt; sendHttpRequest ---&gt; readHttpReplyを実行し、非同期実行でのクライアントHTTPS接続の動作をシミュレートします。</font><font style="vertical-align: inherit;">各ステップには約1秒かかります。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Steppingzomby.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Manager.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Listener</span>;</span>
} <span class="hljs-comment">// namespace Common</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SteppingZomby {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Zomby</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> Common::Manager, <span class="hljs-keyword">public</span> <span class="hljs-built_in">std</span>::enable_shared_from_this&lt;Zomby&gt;<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">create</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    ~Zomby() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span> <span class="hljs-keyword">override</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:<font></font>
    Zomby();<font></font>
<font></font>
    <span class="hljs-keyword">using</span> Semaphore = <span class="hljs-built_in">std</span>::atomic&lt;<span class="hljs-keyword">bool</span>&gt;;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; _listener;<font></font>
    Semaphore _semaphore = <span class="hljs-literal">false</span>;
    <span class="hljs-built_in">std</span>::thread _thread;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">resolveDnsName</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">connectTcp</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">establishSsl</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendHttpRequest</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">readHttpReply</span><span class="hljs-params">()</span></span>;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace SteppingZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Steppingzomby.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SteppingZomby.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Listener.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> {
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(Common::Listener&amp; listener, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp;&amp; callingFunctionName)</span>
</span>{<font></font>
    listener.processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(callingFunctionName + <span class="hljs-string">" started\n"</span>));
    <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">1000</span>));<font></font>
    listener.processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(callingFunctionName + <span class="hljs-string">" finished\n"</span>));<font></font>
}<font></font>
} <span class="hljs-comment">// namespace</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> SteppingZomby {<font></font>
Zomby::Zomby() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">Zomby::create</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt;(<span class="hljs-keyword">new</span> Zomby());<font></font>
}<font></font>
<font></font>
Zomby::~Zomby()<font></font>
{<font></font>
    _semaphore = <span class="hljs-literal">false</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_thread.joinable()) {<font></font>
        _thread.detach();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_listener) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
        _listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"SteppingZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()](){
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;resolveDnsName();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;connectTcp();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;establishSsl();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;sendHttpRequest();<font></font>
        }<font></font>
        <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; shis-&gt;_semaphore) {<font></font>
            shis-&gt;readHttpReply();<font></font>
        }<font></font>
    });<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::resolveDnsName</span><span class="hljs-params">()</span>
</span>{<font></font>
    doSomething(*_listener, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name()) + <span class="hljs-string">"::"</span> + __func__);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::connectTcp</span><span class="hljs-params">()</span>
</span>{<font></font>
    doSomething(*_listener, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name()) + <span class="hljs-string">"::"</span> + __func__);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::establishSsl</span><span class="hljs-params">()</span>
</span>{<font></font>
    doSomething(*_listener, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name()) + <span class="hljs-string">"::"</span> + __func__);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::sendHttpRequest</span><span class="hljs-params">()</span>
</span>{<font></font>
    doSomething(*_listener, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name()) + <span class="hljs-string">"::"</span> + __func__);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::readHttpReply</span><span class="hljs-params">()</span>
</span>{<font></font>
    doSomething(*_listener, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name()) + <span class="hljs-string">"::"</span> + __func__);<font></font>
}<font></font>
} <span class="hljs-comment">// namespace SteppingZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;chrono&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"SteppingZomby/SteppingZomby.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Impl/WriteToConsoleListener.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">auto</span> writeToConsoleListener = Common::WriteToConsoleListener::instance();<font></font>
<font></font>
    {<font></font>
        <span class="hljs-keyword">auto</span> steppingZomby = SteppingZomby::Zomby::create();<font></font>
        steppingZomby-&gt;runOnce(writeToConsoleListener);<font></font>
<font></font>
        <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">1500</span>));<font></font>
    } <span class="hljs-comment">// Zombies should be killed here</span><font></font>
<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-string">"============================================================\n"</span>
            &lt;&lt; <span class="hljs-string">"|                      Zomby was killed                    |\n"</span>
            &lt;&lt; <span class="hljs-string">"============================================================\n"</span>;
        <span class="hljs-keyword">if</span> (writeToConsoleListener) {<font></font>
            writeToConsoleListener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">5000</span>));<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>N13SteppingZomby5ZombyE::resolveDnsName started<br>
N13SteppingZomby5ZombyE::resolveDnsName finished<br>
N13SteppingZomby5ZombyE::connectTcp started<br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
N13SteppingZomby5ZombyE::connectTcp finished<br>
N13SteppingZomby5ZombyE::establishSsl started<br>
N13SteppingZomby5ZombyE::establishSsl finished<br>
N13SteppingZomby5ZombyE::sendHttpRequest started<br>
N13SteppingZomby5ZombyE::sendHttpRequest finished<br>
N13SteppingZomby5ZombyE::readHttpReply started<br>
N13SteppingZomby5ZombyE::readHttpReply finished<br>
N13SteppingZomby5ZombyE::~Zomby<br>
N6Common22WriteToConsoleListenerE::~WriteToConsoleListener<br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前の例のように、runOnce（）を呼び出すと循環参照が発生しました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、今回はZombyおよびWriteToConsoleListenerデストラクタ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼び出されました。アプリケーションが終了するまで、すべてのリソースが正しく解放されました。メモリリークは発生していません。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それで問題は何ですか？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
問題は、ゾンビの寿命が長すぎることです。ゾンビへの外部の強いリンクと弱いリンクがすべて破壊されてから約3秒半です。彼が生きるべきだったよりも約3秒長い。そしてこれまでずっと、彼はHTTPS接続の実装を促進することに従事していました。結果が必要なくなったという事実にもかかわらず。優れたビジネスロジックがゾンビを阻止しようとしたという事実にもかかわらず。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まあ、それについて考えてください、私たちはあなたが必要としない答えを得ました...</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
クライアントのHTTPS接続の場合、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちの側</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の結果</font><font style="vertical-align: inherit;">は次のようになるかもしれません：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -メモリ消費; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -CPU消費。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -TCPポートの消費。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -通信チャネルの帯域幅（要求と応答の両方がメガバイトのボリュームになる場合があります）。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -予期しないデータは、より高いビジネスロジックの動作を混乱させる可能性があります-間違った実行ブランチへの遷移または未定義の動作まで応答処理メカニズムはすでに破壊されている可能性があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、リモート側</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（忘れないでください-HTTPSリクエストは誰かを対象としたものです）-まったく同じリソースの浪費であり、それが可能です：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -企業のウェブサイトで猫の写真を公開する。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -キッチンの床暖房を無効にする。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -取引所での取引注文の実行; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -アカウントからの送金。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -大陸間弾道ミサイルの発射。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスロジックは、ゾンビへの強いリンクと弱いリンクをすべて削除して、ゾンビを阻止しようとしました。 HTTPS要求の進行の停止が</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発生</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するはずでした-遅すぎず、アプリケーションレベルのデータはまだ送信されていませんでした。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、ゾンビは独自の方法で決定しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビジネスロジックは、ゾンビの代わりに新しいオブジェクトを作成し、それらを再度破壊して、リソースの浪費を増大させる可能性があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
継続的なプロセス（Websocket接続など）の場合、リソースの浪費は数時間続く可能性があり、接続が切断されたときに実装に自動再接続メカニズムが存在する場合、通常はプログラムが停止するまで続きます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヴァルグリンド？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チャンスは無い。</font><font style="vertical-align: inherit;">すべてが正しく解放され、クリーンアップされます。</font><font style="vertical-align: inherit;">メインスレッドからではなく後期ですが、完全に正しいです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boozdedzomby</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、boost :: asioを模倣したboozd :: azzioライブラリを使用しています。</font><font style="vertical-align: inherit;">模造品はかなり粗雑であるという事実にもかかわらず、問題の本質を示すことができます。</font><font style="vertical-align: inherit;">ライブラリには関数io_context :: async_read（オリジナルでは無料ですが、本質は変更しません）があり、以下を受け入れます。- </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 データの送信元となるストリーム。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -このデータを蓄積できるバッファ。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -データの読み取りが完了すると呼び出されるコールバック関数。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
io_context :: async_read関数は即座に実行され、実行の結果がすでにわかっている場合（たとえば、エラー）であっても、コールバックを呼び出すことはありません。</font><font style="vertical-align: inherit;">コールバックは、ブロッキング関数io_context :: run（）からのみ呼び出されます（オリジナルには、データの準備ができるとすぐにコールバックを呼び出すように設計された他の関数があります）。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">buffer.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;vector&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> boozd::azzio {
<span class="hljs-keyword">using</span> buffer = <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">int</span>&gt;;<font></font>
} <span class="hljs-comment">// namespace boozd::azzio</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stream.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;optional&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> boozd::azzio {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">stream</span>
{</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">virtual</span> ~stream() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-built_in">std</span>::optional&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace boozd::azzio</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io_context.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;functional&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;optional&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"buffer.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> boozd::azzio {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">stream</span>;</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">io_context</span>
{</span>
<span class="hljs-keyword">public</span>:<font></font>
    ~io_context();<font></font>
<font></font>
    <span class="hljs-keyword">enum</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">error_code</span> {</span>no_error, good_error, bad_error, unknown_error, known_error, well_known_error};
    <span class="hljs-keyword">using</span> handler = <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-keyword">void</span>(error_code)&gt;;<font></font>
<font></font>
    <span class="hljs-comment">// Start an asynchronous operation to read a certain amount of data from a stream.</span>
    <span class="hljs-comment">// This function is used to asynchronously read a certain number of bytes of data from a stream.</span>
    <span class="hljs-comment">// The function call always returns immediately.</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">async_read</span><span class="hljs-params">(stream&amp; s, buffer&amp; b, handler&amp;&amp; handler)</span></span>;<font></font>
<font></font>
    <span class="hljs-comment">// Run the io_context object's event processing loop.</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">using</span> pack = <span class="hljs-built_in">std</span>::tuple&lt;stream&amp;, buffer&amp;&gt;;
    <span class="hljs-keyword">using</span> pack_optional = <span class="hljs-built_in">std</span>::optional&lt;pack&gt;;
    <span class="hljs-keyword">using</span> handler_optional = <span class="hljs-built_in">std</span>::optional&lt;handler&gt;;<font></font>
<font></font>
    pack_optional _pack_optional;<font></font>
    handler_optional _handler_optional;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace boozd::azzio</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io_context.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;chrono&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"io_context.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"stream.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> boozd::azzio {<font></font>
io_context::~io_context()<font></font>
{<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_context::async_read</span><span class="hljs-params">(stream&amp; s, buffer&amp; b, io_context::handler&amp;&amp; handler)</span>
</span>{<font></font>
    _pack_optional.emplace(s, b);<font></font>
    _handler_optional.emplace(<span class="hljs-built_in">std</span>::move(handler));<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_context::run</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (_pack_optional &amp;&amp; _handler_optional) {
        <span class="hljs-keyword">auto</span>&amp; [s, b] = *_pack_optional;
        <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> <span class="hljs-built_in">std</span>::chrono;
        <span class="hljs-keyword">auto</span> start = steady_clock::now();
        <span class="hljs-keyword">while</span> (duration_cast&lt;milliseconds&gt;(steady_clock::now() - start).count() &lt; <span class="hljs-number">1000</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> read = s.read())<font></font>
                b.emplace_back(*read);<font></font>
            <span class="hljs-built_in">std</span>::this_thread::sleep_for(milliseconds(<span class="hljs-number">100</span>));<font></font>
        }<font></font>
<font></font>
        (*_handler_optional)(error_code::no_error);<font></font>
    }<font></font>
}<font></font>
} <span class="hljs-comment">// namespace boozd::azzio</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ランダムデータを生成する唯一のboozd :: azzio ::ストリームインターフェイスの実装：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">impl / random_stream.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"boozd/azzio/stream.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> boozd::azzio {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">random_stream</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> stream<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:<font></font>
    ~random_stream() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-built_in">std</span>::optional&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span></span>;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace boozd::azzio</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">impl / random_stream.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"random_stream.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> boozd::azzio {<font></font>
boozd::azzio::random_stream::~random_stream()<font></font>
{<font></font>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-built_in">std</span>::optional&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">random_stream::read</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (!(rand() &amp; <span class="hljs-number">0x1</span>))
        <span class="hljs-keyword">return</span> rand();<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::nullopt;<font></font>
}<font></font>
} <span class="hljs-comment">// namespace boozd::azzio</span>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BoozdedZombyは、ラムダ関数を別のスレッドで実行します。</font><font style="vertical-align: inherit;">ラムダ関数は、async_read（）を呼び出してハンドラーを登録し、その後、run（）を使用してboozd :: azzioの内部メカニズムを制御します。</font><font style="vertical-align: inherit;">その後、boozd :: azzioの内部メカニズムは、コールバック関数を呼び出す前であればいつでもバッファーとストリーム（データソース）を呼び出すことができます。</font><font style="vertical-align: inherit;">クラスのインスタンスに集約された多くのオブジェクトの有効性を保証するために、ラムダ関数はshared_from_thisをキャプチャします。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BoozdedZomby.h</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> once</span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;atomic&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Manager.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"boozd/azzio/buffer.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"boozd/azzio/io_context.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"boozd/azzio/impl/random_stream.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> Common {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Listener</span>;</span>
} <span class="hljs-comment">// namespace Common</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> BoozdedZomby {
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Zomby</span> <span class="hljs-title">final</span> :</span> <span class="hljs-keyword">public</span> Common::Manager, <span class="hljs-keyword">public</span> <span class="hljs-built_in">std</span>::enable_shared_from_this&lt;Zomby&gt;<font></font>
{<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">create</span><span class="hljs-params">()</span></span>;<font></font>
<font></font>
    ~Zomby() <span class="hljs-keyword">override</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span> <span class="hljs-keyword">override</span></span>;<font></font>
<font></font>
<span class="hljs-keyword">private</span>:<font></font>
    Zomby();<font></font>
<font></font>
    <span class="hljs-keyword">using</span> Semaphore = <span class="hljs-built_in">std</span>::atomic&lt;<span class="hljs-keyword">bool</span>&gt;;<font></font>
<font></font>
    Semaphore _semaphore = <span class="hljs-literal">false</span>;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; _listener;<font></font>
    boozd::azzio::random_stream _stream;<font></font>
    boozd::azzio::buffer _buffer;<font></font>
    boozd::azzio::io_context _context;<font></font>
    <span class="hljs-built_in">std</span>::thread _thread;<font></font>
};<font></font>
} <span class="hljs-comment">// namespace BoozdedZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boozdedzomby.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"boozd/azzio/impl/random_stream.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"BoozdedZomby.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Listener.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> BoozdedZomby {<font></font>
Zomby::Zomby() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt; <span class="hljs-title">Zomby::create</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Zomby&gt;(<span class="hljs-keyword">new</span> Zomby());<font></font>
}<font></font>
<font></font>
Zomby::~Zomby()<font></font>
{<font></font>
    _semaphore = <span class="hljs-literal">false</span>;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_thread.joinable()) {<font></font>
        _thread.detach();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (_listener) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-keyword">typeid</span>(*<span class="hljs-keyword">this</span>).name() &lt;&lt; <span class="hljs-string">"::"</span> &lt;&lt; __func__ &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
        _listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Zomby::runOnce</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Common::Listener&gt; listener)</span>
</span>{
    <span class="hljs-keyword">if</span> (_semaphore) {
        <span class="hljs-keyword">throw</span> <span class="hljs-built_in">std</span>::runtime_error(<span class="hljs-string">"BoozdedZomby::Zomby::runOnce() called twice"</span>);<font></font>
    }<font></font>
<font></font>
    _listener = listener;<font></font>
    _semaphore = <span class="hljs-literal">true</span>;<font></font>
<font></font>
    _thread = <span class="hljs-built_in">std</span>::thread([shis = shared_from_this()]() {
        <span class="hljs-keyword">while</span> (shis &amp;&amp; shis-&gt;_semaphore &amp;&amp; shis-&gt;_listener) {
            <span class="hljs-keyword">auto</span> handler = [shis](<span class="hljs-keyword">auto</span> errorCode) {
                <span class="hljs-keyword">if</span> (shis &amp;&amp; shis-&gt;_listener &amp;&amp; errorCode == boozd::azzio::io_context::error_code::no_error) {
                    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
                    buf &lt;&lt; <span class="hljs-string">"BoozdedZomby has got a fresh data: "</span>;
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> <span class="hljs-keyword">const</span> &amp;elem : shis-&gt;_buffer)<font></font>
                        buf &lt;&lt; elem &lt;&lt; <span class="hljs-string">' '</span>;<font></font>
                    buf &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
<font></font>
                    shis-&gt;_listener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
                }<font></font>
            };<font></font>
            shis-&gt;_buffer.clear();<font></font>
            shis-&gt;_context.async_read(shis-&gt;_stream, shis-&gt;_buffer, handler);<font></font>
            shis-&gt;_context.run();<font></font>
        }<font></font>
    });<font></font>
}<font></font>
} <span class="hljs-comment">// namespace BoozdedZomby</span>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.cpp</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;chrono&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sstream&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"BoozdedZomby/BoozdedZomby.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Common/Impl/WriteToConsoleListener.h"</span></span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">auto</span> writeToConsoleListener = Common::WriteToConsoleListener::instance();<font></font>
<font></font>
    {<font></font>
        <span class="hljs-keyword">auto</span> boozdedZomby = BoozdedZomby::Zomby::create();<font></font>
        boozdedZomby-&gt;runOnce(writeToConsoleListener);<font></font>
<font></font>
        <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">4500</span>));<font></font>
    } <span class="hljs-comment">// Zombies should be killed here</span><font></font>
<font></font>
    {<font></font>
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">ostringstream</span> buf;<font></font>
        buf &lt;&lt; <span class="hljs-string">"============================================================\n"</span>
            &lt;&lt; <span class="hljs-string">"|                      Zomby was killed                    |\n"</span>
            &lt;&lt; <span class="hljs-string">"============================================================\n"</span>;
        <span class="hljs-keyword">if</span> (writeToConsoleListener) {<font></font>
            writeToConsoleListener-&gt;processData(<span class="hljs-built_in">std</span>::make_shared&lt;Common::Listener::Data&gt;(buf.str()));<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::this_thread::sleep_for(<span class="hljs-built_in">std</span>::chrono::milliseconds(<span class="hljs-number">5000</span>));<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソール出力</font></font></b><div class="spoiler_text"><blockquote>BoozdedZomby has got a fresh data: 1144108930 101027544 1458777923 1115438165 74243042 <br>
BoozdedZomby has got a fresh data: 143542612 1131570933 <br>
BoozdedZomby has got a fresh data: 893351816 563613512 704877633 <br>
BoozdedZomby has got a fresh data: 1551901393 1399125485 1899894091 937186357 590357944 357571490 <br>
============================================================<br>
| Zomby was killed |<br>
============================================================<br>
BoozdedZomby has got a fresh data: 1927702196 130060903 1083454666 2118797801 2035308228 824938981 <br>
BoozdedZomby has got a fresh data: 2020739063 1635339425 34075629 <br>
BoozdedZomby has got a fresh data: 2146319451 500782188 1269406752 884936716 892053144 <br>
BoozdedZomby has got a fresh data: 330111137 1723153177 1070477904 <br>
BoozdedZomby has got a fresh data: 343098142 280090412 589673557 889688008 2014119113 388471006 <br>
</blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
run_once（）を呼び出した結果、循環参照が発生しました。</font><font style="vertical-align: inherit;">ゾンビは視界を離れた後も働き続けました。</font><font style="vertical-align: inherit;">プログラム中に作成された多くのオブジェクトに対してデストラクタは呼び出されませんでした：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -boozdedZomby; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -writeToConsoleListener; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 -ゾンビデータフィールド。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリリークが発生しました。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リソースリークがありました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この例は前の例とどう違うのですか？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際のコードにかなり近いです。</font><font style="vertical-align: inherit;">これはもはや合成例ではありません。</font><font style="vertical-align: inherit;">このようなコードは、boost :: asioを使用すると自然に発生する可能性があります。</font><font style="vertical-align: inherit;">さらに、弱いリンクを優先して強いリンクをキャプチャすることを拒否するだけでは修正できません。これにより、バッファとストリーム（データソース）の有効性が妨げられます。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヴァルグリンド？</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
沿って。</font><font style="vertical-align: inherit;">リークを検出することだったようですが。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">野生のゾンビ</font></font></h2><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題ははるかに困難です！</font><font style="vertical-align: inherit;">だから誰も書いていない！</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼が書いているように。</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://www.boost.org/doc/libs/master/libs/beast/example/http/client/async/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPクライアントの</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例Websocket </font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://www.boost.org/doc/libs/master/libs/beast/example/http/client/async/"><font style="vertical-align: inherit;">クライアントの</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">例</font></a></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
公式のブーストドキュメントでは、BoozdedZomby + SteppingZombyハイブリッドの記述方法を説明しています。</font><font style="vertical-align: inherit;">彼を止めることは不可能ですが、誰も試みていません。</font><font style="vertical-align: inherit;">具体的には、デモコードでは、ゾンビのメインプロパティは表示されませんが、これをプロダクションに転送する必要があります。これで、エッジに沿って、おそらくダークサイドでさえ歩いていることになります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boost :: asio :: io_contextインスタンスを破壊することで、ゾンビを止めることができます！</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...途中で、このコンテキストに住んでいる別のnエンティティ（おそらくゾンビではない）を破壊します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その他の例：</font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サードパーティのリソースでの同様の例を次に示します。</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここでは、人がstackoverflowについて質問し、コードをよりゾンビにする方法を示しています</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、彼の最愛のゾンビが機能しない理由を尋ねる別のものです。</font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ゾンビを操作しているときのメモリリークに関するメッセージを怖がっている男性がいます</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、記事ではアンチパターン「ゾンビ」のすべての種類について説明しているわけではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のタイプのハイブリッドの形でも、新しい独立したタイプの形でも見つけることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アンチパターンは、コード内でstd ::スレッドが起動されたときだけでなく、サードパーティのマルチスレッドライブラリが作業のこの部分を引き継ぐ可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
循環リンクは、例よりも長くなる場合があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーキテクチャは、イベント駆動型、または定期的なポーリングベースのポーリングに基づくことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはすべてそれほど重要ではありません。</font><b><font style="vertical-align: inherit;">常に</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
重要です</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アンチパターンは、クラスのインスタンスがそれ自体への強い参照を取得することから始まります。これは、ほとんどの場合std :: enable_shared_from_thisを使用して生成されますが、外部から提供することもできます（弱いリンクとして含めることもできます-クラス自体が強力にすることができます）。おそらく、このルールにはエキゾチックな例外が1つだけあります。外部コードがクラスのインスタンスへの強い参照または弱い参照をそのデータフィールドの1つに提供する場合です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
動的コード分析では、このアンチパターン、特にそのバージョンのSteppingZombyを検出できない場合があります。静的分析の希望もほとんどありません-shared_from_thisの正しい使用と誤った使用の間には非常に細い線があります（この記事に記載されているすべてのコード例は、非常に小さな修正を加えることで修正できます-合計1行から6行のコード）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動テストはそれを特定し、除去の正しさをチェックするのに役立ちますが、そのためには何を探すべきかを知る必要があります。</font><font style="vertical-align: inherit;">絶対に知っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アンチパターンをあちこちで検索するには、手動で行う必要があります。</font><font style="vertical-align: inherit;">このためには、std :: enable_shared_from_thisのすべての使用法を再考する必要があります-それらは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">危険です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS：投票結果によると-アンチパターンを排除するためのオプションについての議論を含む別の記事を準備します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja471310/index.html">ITの教育だけでなく、専門家についての私の主観的な意見</a></li>
<li><a href="../ja471312/index.html">Spring Professional認定の準備。春ブーツ</a></li>
<li><a href="../ja471318/index.html">9月の機械学習と人工知能のニュースダイジェスト</a></li>
<li><a href="../ja471320/index.html">ソフトウェア開発者向けのツール：オープンフレームワークと機械学習ライブラリ</a></li>
<li><a href="../ja471324/index.html">ニューラルネットワークはモナリザを夢見ますか？</a></li>
<li><a href="../ja471330/index.html">月面コンピューターのストーリー。パート2</a></li>
<li><a href="../ja471332/index.html">月面コンピューターのストーリー。パート3</a></li>
<li><a href="../ja471334/index.html">覚えるが、詰め込まない-「カードで」学ぶ</a></li>
<li><a href="../ja471336/index.html">ホリバー。ルネットの歴史。パート6.ロック：Lurk、Tape、282ndおよびChineseパス</a></li>
<li><a href="../ja471340/index.html">Drimsim vs Mate 20 Proラウンド！しかし、誰のために？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>