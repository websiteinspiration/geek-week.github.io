<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>➡️ 🤘🏾 🧑🏻‍🤝‍🧑🏻 Swift：ARCとメモリ管理 👼🏼 👨🏼 ☺️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最新の高水準言語であるため、Swiftは基本的にアプリケーションのメモリ管理を担当し、メモリの割り当てと解放を行います。これは、自動参照カウント、または略してARCと呼ばれるメカニズムによるものです。このガイドでは、ARCの仕組みと、Swiftでメモリを適切に管理する方法について学びます。このメカニ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Swift：ARCとメモリ管理</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451130/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最新の高水準言語であるため、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swiftは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">基本的にアプリケーションのメモリ管理を担当し、メモリの割り当てと解放を行います。</font><font style="vertical-align: inherit;">これは</font><font style="vertical-align: inherit;">、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動参照カウント</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、または略して</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ばれるメカニズムによるもの</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">このガイドでは、ARCの仕組みと、Swiftでメモリを適切に管理する方法について学びます。</font><font style="vertical-align: inherit;">このメカニズムを理解すると、ヒープに置かれたオブジェクト（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">heap</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">の寿命に影響を与えることができ</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このガイドでは、SwiftとARCの知識に基づいて、次のことを学びます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARCのしくみ</font></font></li>
<li><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照サイクル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">は何か、</font><font style="vertical-align: inherit;">それらを正しく修正する方法</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンクループの例を作成する方法</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xcodeが提供するビジュアルツールを使用してリンクループを見つける方法</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照型と値型の扱い方</font></font></li>
</ul><a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">入門</font></font></h2><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース資料を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ダウンロードし</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ます。</font></a></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cycles / Starter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォルダーでプロジェクトを開きます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">このガイドの最初の部分では、主要な概念を理解し、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MainViewController.swif</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> t </font><font style="vertical-align: inherit;">ファイルのみを扱います</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MainViewController.swiftの下部にこのクラスを追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
  <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span><font></font>
  <font></font>
  <span class="hljs-keyword">init</span>(name: <span class="hljs-type">String</span>) {
    <span class="hljs-keyword">self</span>.name = name
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"User \(name) was initialized"</span>)<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">deinit</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Deallocating user named: \(name)"</span>)<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
クラスはここ</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">定義され</font><font style="vertical-align: inherit;">ており、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">print</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ステートメントを</font><font style="vertical-align: inherit;">使用して、クラスインスタンスの初期化と解放について通知します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、MainViewControllerの上部にUserクラスのインスタンスを作成します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">viewDidLoad（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドの前に配置します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> user = <span class="hljs-type">User</span>(name: <span class="hljs-string">"John"</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリを起動します。</font><font style="vertical-align: inherit;">Xcodeコンソールを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Command-Shift-Y</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で表示して、printステートメントの出力を確認します。</font><b><font style="vertical-align: inherit;">ユーザーJohnが初期化さ</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
れましたが、コンソール</font><font style="vertical-align: inherit;">に表示されましたが、</font><b><font style="vertical-align: inherit;">deinit</font></b><font style="vertical-align: inherit;">内の印刷ステートメント</font><font style="vertical-align: inherit;">は実行されませんでした。</font><font style="vertical-align: inherit;">つまり、このオブジェクトは</font><b><font style="vertical-align: inherit;">スコープ</font></b><font style="vertical-align: inherit;">から外れなかったため、解放されませんでした</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
つまり、このオブジェクトを含むビューコントローラがスコープ外になるまで、オブジェクトは解放されません。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">彼は範囲内ですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メソッドでUserクラスのインスタンスをラップすることにより、それがスコープ外に出ることを許可し、それによってARCがそれを解放できるようにします。</font><b><font style="vertical-align: inherit;">MainViewController</font></b><font style="vertical-align: inherit;">クラス内に</font><b><font style="vertical-align: inherit;">runScenario（）</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
メソッドを作成し</font><font style="vertical-align: inherit;">、Userクラスインスタンスの初期化をその中に移動します。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">runScenario</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">let</span> user = <span class="hljs-type">User</span>(name: <span class="hljs-string">"John"</span>)<font></font>
}    <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
runScenario（）は、Userインスタンスのスコープを定義します。</font><font style="vertical-align: inherit;">このゾーンを出るとき、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は解放される必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
runScenario（）を呼び出して、viewDidLoad（）の最後にこれを追加します。</font></font><br>
<br>
<pre><code class="swift hljs">runScenario()</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリを起動します。</font><font style="vertical-align: inherit;">コンソールの出力は、次のようになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーJohnが初期化</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
されました名前の割り当て解除ユーザー：John </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、スコープを離れたオブジェクトを解放したことを意味します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オブジェクトの寿命</font></font></h2><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オブジェクトの存在は、5つの段階に分かれています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メモリ割り当て：スタックまたはヒープから</font></font></li>
<li>:    init</li>
<li></li>
<li>:    deinit</li>
<li> :       </li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メモリの割り当てと解放の手順を直接追跡する方法はありませんが、initおよびdeinit内のコードを使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
参照カウント（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照カウント</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）は、「</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用回数</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」（</font><b><font style="vertical-align: inherit;">使用カウント</font></b><font style="vertical-align: inherit;">）と</font><font style="vertical-align: inherit;">も呼ばれ</font><font style="vertical-align: inherit;">、オブジェクトが不要になる時期を決定します。このカウンタは、このオブジェクトを「使用」した人の数を示します。使用カウンタがゼロの場合、オブジェクトは不要になります。次に、オブジェクトは初期化解除されて解放されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/b5/oo/78/b5oo78ealf173ey0ayz7rngnszk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザオブジェクトが初期化されるときので、その参照カウントは1であり、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザー</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">定数は</font><font style="vertical-align: inherit;">、このオブジェクトを指します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
runScenario（）の最後に、ユーザーはスコープから外れ、参照カウントが0に減少します。その結果、ユーザーは初期化されずに解放されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参照サイクル</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどの場合、ARCは正常に機能します。</font><font style="vertical-align: inherit;">未使用のオブジェクトが無期限に割り当てられないままである場合、開発者は通常メモリリークについて心配する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかしいつもではない！</font><font style="vertical-align: inherit;">メモリリークの可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはどうして起こりますか？</font><font style="vertical-align: inherit;">2つのオブジェクトが使用されなくなったが、それぞれが他方を参照している状況を想像してみてください。</font><font style="vertical-align: inherit;">各リンク数は0ではないため、解放されるリンクはありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hd/zp/ff/hdzpffk1eh3rug0fgmgnlghnb3q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">強い参照サイクル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">この状況はARCを混乱させ、メモリをクリアすることを許可しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご覧のとおり、最後の参照カウントは0ではなく、オブジェクトはもう必要ありませんが、object1とobject2は解放されません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのリンクをチェックしてください</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらすべてを実際にテストするには、MainViewController.swiftのUserクラスの後に次のコードを追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Phone</span> </span>{
  <span class="hljs-keyword">let</span> model: <span class="hljs-type">String</span>
  <span class="hljs-keyword">var</span> owner: <span class="hljs-type">User?</span><font></font>
  <font></font>
  <span class="hljs-keyword">init</span>(model: <span class="hljs-type">String</span>) {
    <span class="hljs-keyword">self</span>.model = model
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Phone \(model) was initialized"</span>)<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">deinit</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Deallocating phone named: \(model)"</span>)<font></font>
  }<font></font>
}    </code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードは</font><font style="vertical-align: inherit;">、モデル用と所有者用の2つのプロパティ、およびinitメソッドとdeinitメソッド</font><font style="vertical-align: inherit;">を持つ新しい</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phone</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラス</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">追加し</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">スマートフォンに所有者がいない場合があるため、所有者の所有物はオプションです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、この行をrunScenario（）に追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> iPhone = <span class="hljs-type">Phone</span>(model: <span class="hljs-string">"iPhone Xs"</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、Phoneクラスのインスタンスが作成されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">携帯電話を握る</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードをUserクラスのnameプロパティの直後に追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">private</span>(<span class="hljs-keyword">set</span>) <span class="hljs-keyword">var</span> phones: [<span class="hljs-type">Phone</span>] = []<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(phone: Phone)</span></span> {<font></font>
  phones.append(phone)<font></font>
  phone.owner = <span class="hljs-keyword">self</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーが所有する電話の配列を追加します。</font><font style="vertical-align: inherit;">セッターはプライベートとしてマークされているため、add（phone :)を使用する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリを起動します。</font><font style="vertical-align: inherit;">ご覧のとおり、PhoneおよびUserオブジェクトクラスのインスタンスは必要に応じて解放されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーJohnが初期化されました</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電話iPhone XSが初期化</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
されました次の名前の電話の</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
割り当てを解除します</font><font style="vertical-align: inherit;">：iPhone Xs次の</font><font style="vertical-align: inherit;">名前のユーザーの割り当てを解除します：John </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次にrunScenario（）の最後にこれを追加します：</font></font><br>
<pre><code class="swift hljs">user.add(phone: iPhone)</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、iPhoneを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が所有する電話のリストに追加し、電話</font><font style="vertical-align: inherit;">の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">owner</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロパティ</font><font style="vertical-align: inherit;">を ' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 'に設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションを再度実行します。</font><font style="vertical-align: inherit;">ユーザーオブジェクトとiPhoneオブジェクトが解放されていないことがわかります。</font><font style="vertical-align: inherit;">それらの間の強いリンクのサイクルは、ARCがそれらを解放することを防ぎます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lo/az/mu/loazmuamyoww2ttr7wnwcd8_n4w.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンクが弱い </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
強い参照の循環を断ち切るために、オブジェクト間の関係を弱い（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weak</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">としてマークできます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デフォルトでは、すべてのリンクが強力であり、割り当てにより参照カウントが増加します。弱参照を使用する場合、参照カウントは増加しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">弱いリンクはオブジェクトのライフマネジメントに影響を与えません</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。弱いリンクは常に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプションとして</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宣言され</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。これにより、参照カウントが0になったときにリンクをnilに設定できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/qd/kc/tiqdkcyfstrndd8xswpf8zfebfo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この図では、破線は弱いリンクを示しています。 variable1が参照しているため、参照カウンターobject1は1であることに注意してください。 variable2とobject1が参照しているため、object2の参照カウントは2です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
object2もobject1を参照しますが、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WEAKは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、object1の参照カウントに影響を与えないことを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
variable1とvariable2が解放されると、object1の参照カウントは0になり、解放されます。</font><font style="vertical-align: inherit;">これにより、object2への強い参照が解放され、すでに解放されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Phoneクラスで、所有者プロパティ宣言を次のように変更します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> owner: <span class="hljs-type">User?</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ownerプロパティ参照を「weak」として宣言することにより、UserクラスとPhoneクラス間の強いリンクのループを解消します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ym/ax/_m/ymax_mv9cvlpi8xqwnxmb14vr2g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリを起動します。</font><font style="vertical-align: inherit;">現在、ユーザーと電話は正しく解放されています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有されていないリンク</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
参照カウントを増加させない別のリンク修飾子もあります：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unowned</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><b><font style="vertical-align: inherit;">unowned</font></b><font style="vertical-align: inherit;">と</font><b><font style="vertical-align: inherit;">weakの</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
違いは何</font><font style="vertical-align: inherit;">ですか？弱参照は常にオプションであり、参照オブジェクトが解放されると自動的にnilになります。</font><font style="vertical-align: inherit;">
これが、弱いプロパティを型のオプション変数として宣言する必要がある理由です。このプロパティは変更する必要があります。</font><font style="vertical-align: inherit;">
対照的に、所有されていないリンクは決してオプションではありません。解放されたオブジェクトを参照する所有されていないプロパティにアクセスしようとすると、nil変数を含む強制アンラップ（強制アンラップ）のようなエラーが発生します。</font><b><font style="vertical-align: inherit;">所有していないものを</font></b><font style="vertical-align: inherit;"> 
適用してみましょう</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
新しいクラスを追加</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/i9/hf/bc/i9hfbcizzk2eg38s_hidjq3evju.png"><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MainViewController.swift</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の最後にある</font><b><font style="vertical-align: inherit;">CarrierSubscription</font></b><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CarrierSubscription</span> </span>{
  <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>
  <span class="hljs-keyword">let</span> countryCode: <span class="hljs-type">String</span>
  <span class="hljs-keyword">let</span> number: <span class="hljs-type">String</span>
  <span class="hljs-keyword">let</span> user: <span class="hljs-type">User</span><font></font>
              <font></font>
  <span class="hljs-keyword">init</span>(name: <span class="hljs-type">String</span>, countryCode: <span class="hljs-type">String</span>, number: <span class="hljs-type">String</span>, user: <span class="hljs-type">User</span>) {
    <span class="hljs-keyword">self</span>.name = name
    <span class="hljs-keyword">self</span>.countryCode = countryCode
    <span class="hljs-keyword">self</span>.number = number
    <span class="hljs-keyword">self</span>.user = user<font></font>
    <font></font>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"CarrierSubscription \(name) is initialized"</span>)<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">deinit</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Deallocating CarrierSubscription named: \(name)"</span>)<font></font>
  }<font></font>
}        </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CarrierSubscriptionには4つのプロパティがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名前：プロバイダー名。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CountryCode：国コード。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
番号：電話番号。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザー：ユーザーへのリンク。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたのプロバイダーは誰ですか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これをUserクラスのnameプロパティの後に追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">var</span> subscriptions: [<span class="hljs-type">CarrierSubscription</span>] = []</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、ユーザープロバイダーの配列を保持しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、これをPhoneクラスのownerプロパティの後に追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">var</span> carrierSubscription: <span class="hljs-type">CarrierSubscription?</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">provision</span><span class="hljs-params">(carrierSubscription: CarrierSubscription)</span></span> {
  <span class="hljs-keyword">self</span>.carrierSubscription = carrierSubscription<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">decommission</span><span class="hljs-params">()</span></span> {<font></font>
  carrierSubscription = <span class="hljs-literal">nil</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、オプションのCarrierSubscriptionプロパティと、プロバイダーへの電話の登録と登録解除のための2つのメソッドが追加されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、printステートメントの直前のinitメソッド内にCarrierSubscriptionクラスを追加します。</font></font><br>
<br>
<pre><code class="swift hljs">user.subscriptions.append(<span class="hljs-keyword">self</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CarrierSubscriptionをユーザープロバイダーの配列に追加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、これをrunScenario（）メソッドの最後に追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> subscription = <span class="hljs-type">CarrierSubscription</span>(<font></font>
  name: <span class="hljs-string">"TelBel"</span>, <font></font>
  countryCode: <span class="hljs-string">"0032"</span>,<font></font>
  number: <span class="hljs-string">"31415926"</span>, <font></font>
  user: user)<font></font>
iPhone.provision(carrierSubscription: subscription)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーのプロバイダーへのサブスクリプションを作成し、それに電話を接続します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリを起動します。</font><font style="vertical-align: inherit;">コンソールに次のように表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーJohnが初期化されました</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電話iPhone Xsが初期化されました</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CarrierSubscription TelBelが初期化されました</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして再びリンクサイクルです！</font><font style="vertical-align: inherit;">ユーザー、iPhone、サブスクリプションは最後に解放されませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題を見つけることができますか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uu/fg/eq/uufgeqkvqa31jwwlsnlikc-iob8.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">鎖を断ち切る</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ループを解消するには、ユーザーからサブスクリプションへのリンクまたはサブスクリプションからユーザーへのリンクのいずれかを所有していない必要があります。</font><font style="vertical-align: inherit;">問題は、どのオプションを選択するかです。</font><font style="vertical-align: inherit;">構造を見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーはプロバイダーへのサブスクリプションを所有しますが、逆も同様です-いいえ、プロバイダーへのサブスクリプションはユーザーを所有しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、CarrierSubscriptionは、それを所有するユーザーを参照せずに存在しても意味がありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ユーザーへのリンクは所有されていない必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CarrierSubscriptionのユーザー宣言を変更します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">unowned</span> <span class="hljs-keyword">let</span> user: <span class="hljs-type">User</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、ユーザーが所有者ではなくなりました。これにより、リンクのループが解消され、すべてのオブジェクトを解放できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/en/vx/cu/envxcuihbevfcfqv1cyg-kc3lo4.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クロージャーのリンクをループする</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オブジェクトのリンクサイクルは、オブジェクトが相互に参照するプロパティを持っている場合に発生します。オブジェクトと同様に、クロージャーは参照型であり、参照ループにつながる可能性があります。クロージャは、使用するオブジェクトをキャプチャします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、クラスのプロパティにクロージャを割り当て、このクロージャが同じクラスのプロパティを使用する場合、リンクループが発生します。つまり、オブジェクトは、プロパティを介してクロージャへのリンクを保持します。クロージャには、取得されたselfの値によるオブジェクトへの参照が含まれています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/z-/lh/ow/z-lhowlkfyvy4ycusafxhygjisw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコードをユーザープロパティの直後のCarrierSubscriptionに追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-built_in">lazy</span> <span class="hljs-keyword">var</span> completePhoneNumber: () -&gt; <span class="hljs-type">String</span> = {
  <span class="hljs-keyword">self</span>.countryCode + <span class="hljs-string">" "</span> + <span class="hljs-keyword">self</span>.number<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このクロージャは完全な電話番号を計算して返します。</font><font style="vertical-align: inherit;">プロパティは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lazy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">として宣言さ</font><font style="vertical-align: inherit;">れ、最初の使用時に割り当てられます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、初期化コードが実行されるまで使用できないself.countryCodeおよびself.numberを使用するために必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後にrunScenario（）を追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-built_in">print</span>(subscription.completePhoneNumber())</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
completePhoneNumber（）を呼び出すと、クロージャーが実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションを起動すると、ユーザーとiPhoneが解放されていることがわかりますが、CarrierSubscriptionは解放されていません。これは、オブジェクトとクロージャー間の強いリンクのサイクルが原因です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7t/rb/ax/7trbaxtrrhtadtm29-dvqwehzo4.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャプチャリスト</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Swiftは、クロージャー内の強力なリンクのループを解消するシンプルでエレガントな方法を提供します。</font><font style="vertical-align: inherit;">クロージャーとキャプチャーするオブジェクトの間の関係を定義するキャプチャーリストを宣言します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キャプチャリストを示すために、次のコードを検討してください。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">var</span> x = <span class="hljs-number">5</span>
<span class="hljs-keyword">var</span> y = <span class="hljs-number">5</span><font></font>
<font></font>
<span class="hljs-keyword">let</span> someClosure = { [x] <span class="hljs-keyword">in</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"\(x), \(y)"</span>)<font></font>
}<font></font>
x = <span class="hljs-number">6</span>
y = <span class="hljs-number">6</span><font></font>
<font></font>
someClosure()        <span class="hljs-comment">// Prints 5, 6</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\(x), \(y)"</span>)  <span class="hljs-comment">// Prints 6, 6</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
xはクロージャキャプチャリストにあるため、xの値はクロージャ定義にコピーされます。</font><font style="vertical-align: inherit;">値によってキャプチャされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
yはキャプチャリストにありません。参照によってキャプチャされます。</font><font style="vertical-align: inherit;">つまり、yの値は、回路が呼び出されたときと同じになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ロックリストは、ループ内でキャプチャされたオブジェクトに関して、弱い相互作用または所有されていない相互作用を識別するのに役立ちます。</font><font style="vertical-align: inherit;">私たちの場合、CarrierSubscriptionインスタンスが解放されるとクロージャが存在しないため、適切な選択は所有されていません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自分をつかむ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
completePhoneNumber定義をCarrierSubscription ::に置き換えます。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-built_in">lazy</span> <span class="hljs-keyword">var</span> completePhoneNumber: () -&gt; <span class="hljs-type">String</span> = { [<span class="hljs-keyword">unowned</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.countryCode + <span class="hljs-string">" "</span> + <span class="hljs-keyword">self</span>.number<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、追加</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[所有されていない自己]を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">閉鎖キャプチャリストに。</font><font style="vertical-align: inherit;">これは</font><font style="vertical-align: inherit;">、強いリンクではなく</font><font style="vertical-align: inherit;">、</font><b><font style="vertical-align: inherit;">所有さ</font></b><font style="vertical-align: inherit;">れてい</font><b><font style="vertical-align: inherit;">ない</font></b><font style="vertical-align: inherit;">リンク</font><font style="vertical-align: inherit;">として</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自分自身</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">取得</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">した</font><font style="vertical-align: inherit;">ことを意味し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションを起動すると、CarrierSubscriptionがリリースされたことがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、上記の構文は、新しい変数が現れる、より長くてより完全な構文の短い形式です。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">var</span> closure = { [<span class="hljs-keyword">unowned</span> newID = <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
  <span class="hljs-comment">// Use unowned newID here...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、newIDは所有されていない自己のコピーです。</font><font style="vertical-align: inherit;">閉鎖を超えて、自分自身が残ります。</font><font style="vertical-align: inherit;">前述の短い形式では</font><font style="vertical-align: inherit;">、クロージャー内の既存のselfを覆い隠す</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しい変数self</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><b><font style="vertical-align: inherit;">作成します</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unownedを慎重に使用する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードでは、selfとcompletePhoneNumberの関係が非所有として指定されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クロージャで使用されているオブジェクトが解放されないことが確実な場合は、unownedを使用できます。</font><font style="vertical-align: inherit;">もしそうなら、あなたは困っています！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MainViewController.swiftの最後に次のコードを追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WWDCGreeting</span> </span>{
  <span class="hljs-keyword">let</span> who: <span class="hljs-type">String</span><font></font>
  <font></font>
  <span class="hljs-keyword">init</span>(who: <span class="hljs-type">String</span>) {
    <span class="hljs-keyword">self</span>.who = who<font></font>
  }<font></font>
<font></font>
  <span class="hljs-built_in">lazy</span> <span class="hljs-keyword">var</span> greetingMaker: () -&gt; <span class="hljs-type">String</span> = { [<span class="hljs-keyword">unowned</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello \(self.who)."</span><font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これでrunScenario（）の終わりです：</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> greetingMaker: () -&gt; <span class="hljs-type">String</span><font></font>
<font></font>
<span class="hljs-keyword">do</span> {
  <span class="hljs-keyword">let</span> mermaid = <span class="hljs-type">WWDCGreeting</span>(who: <span class="hljs-string">"caffeinated mermaid"</span>)<font></font>
  greetingMaker = mermaid.greetingMaker<font></font>
}<font></font>
<font></font>
<span class="hljs-built_in">print</span>(greetingMaker()) <span class="hljs-comment">// !        </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションを起動すると、クラッシュとコンソールに何かが表示されます：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーザーJohnが初期化されました</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電話iPhone XSが初期化されました</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CarrierSubscription TelBelが初期化されました</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0032 31415926 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
致命的エラー：所有されていない参照を読み取ろうとしましたが、オブジェクト0x600000f0de30はすでに割り当て解除されていました2019-02-24 12： 29：40.744248-0600サイクル[33489：5926466]致命的エラー：所有されていない参照を読み込もうとしましたが、オブジェクト0x600000f0de30はすでに割り当て解除</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
されていましたdoブロックの最後でスコープ外です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例は指から吸い込まれたように見えるかもしれませんが、そのようなことが起こります。</font><font style="vertical-align: inherit;">たとえば、クロージャを使用して、たとえばネットワークの非同期呼び出しが終了した後など、後で何かを開始する場合です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">罠を解除する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WWDCGreetingクラスのGreetingMakerを次のように置き換えます。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-built_in">lazy</span> <span class="hljs-keyword">var</span> greetingMaker: () -&gt; <span class="hljs-type">String</span> = { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello \(self?.who)."</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは2つのことを行いました。最初に、所有していないものを弱いものに置き換えました。</font><font style="vertical-align: inherit;">第二に、自己は衰弱しているので、私たちは自己を通してwhoプロパティにアクセスしますか。</font><font style="vertical-align: inherit;">Xcodeの警告は無視してください。すぐに修正します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションはクラッシュしなくなりましたが、実行すると「Hello nil」という面白い結果が得られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
おそらく結果はかなり受け入れられますが、オブジェクトが解放された場合は、しばしば何かをする必要があります。</font><font style="vertical-align: inherit;">これは、guardステートメントを使用して行うことができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クロージャテキストを次のように置き換えます。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-built_in">lazy</span> <span class="hljs-keyword">var</span> greetingMaker: () -&gt; <span class="hljs-type">String</span> = { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
  <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> = <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"No greeting available."</span><font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello \(self.who)."</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ガードステートメントは、弱い自己から取得した自己を割り当てます。</font><font style="vertical-align: inherit;">selfがnilの場合、クロージャーは「グリーティングはありません」を返します。</font><font style="vertical-align: inherit;">それ以外の場合、自己は強い参照になるため、オブジェクトはクロージャの最後まで存続することが保証されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xcode 10でリンクループを探す</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ARCのしくみ、リンクループとは何か、それらを解除する方法を理解したところで、実際のアプリケーションの例を見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
連絡先フォルダにあるスタータープロジェクトを開きます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリを起動します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a8/ce/l1/a8cel1rgbdkm_fel_d880f2swf4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは最も簡単な連絡先管理ツールです。連絡先をクリックして、新しい連絡先をいくつか追加してみてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルの目的：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ContactsTableViewController：すべての連絡先を表示します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DetailViewController：選択した連絡先の詳細情報を表示します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NewContactViewController：新しい連絡先を追加できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ContactTableViewCell：連絡先の詳細を示すテーブルセル。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
連絡先：連絡先モデル。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
番号：電話番号モデル。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、このプロジェクトのすべてが悪い：ここにリンクのサイクルがあります。</font><font style="vertical-align: inherit;">最初は、リークするメモリのサイズが小さいため、リークを見つけるのが難しいのと同じ理由で、ユーザーは問題に気付かないでしょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸い、Xcode 10には、最小のメモリリークを見つけるための組み込みツールがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションを再度起動します。</font><font style="vertical-align: inherit;">左へのスワイプと削除ボタンを使用して、3〜4の連絡先を削除します。</font><font style="vertical-align: inherit;">完全に消えたみたいですね。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xu/d9/qf/xud9qf3rcyaf5ot_08l8vauizto.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どこに流れますか？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションが実行されている状態で、[デバッグメモリグラフ]ボタンをクリックします</font></font><br>
<br>
<img src="https://habrastorage.org/webt/la/na/km/lanakmzc0d2ousrcf5jwkpu-ova.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。デバッグナビゲーターで実行時の問題を確認します。</font><font style="vertical-align: inherit;">それらは内側に白い感嘆符が付いた紫色の四角でマークさ</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uc/ko/vj/uckovjp_eqoplopih79xuz1jl7e.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
れています。ナビゲーターで問題のある連絡先オブジェクトの1つを選択します。</font><font style="vertical-align: inherit;">サイクルははっきりと見えます。ContactオブジェクトとNumberオブジェクトは、お互いを参照して保持されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7f/wi/os/7fwios8n7zdk4ww7bj81p4kvgle.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードを調べる必要があるようです。</font><font style="vertical-align: inherit;">連絡先は番号がなくても存在できますが、その逆はできないことに注意してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このループをどのように解決しますか？</font><font style="vertical-align: inherit;">連絡先から番号へのリンク、または番号から連絡先へのリンク？</font><font style="vertical-align: inherit;">弱いまたは所有されていない？</font><font style="vertical-align: inherit;">まず自分で試してみてください！</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたが助けを必要とする場合 ...</font></font></b><div class="spoiler_text"> 2  :     Contact  Number weak,   Number  Contact unowned.<br>
<br>
 Apple ,        «» —  .  ,    Contact    Number,  Number — unowned   Contact:<br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Number</span> </span>{
  <span class="hljs-keyword">unowned</span> <span class="hljs-keyword">var</span> contact: <span class="hljs-type">Contact</span>
  <span class="hljs-comment">// Other code...</span><font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Contact</span> </span>{
  <span class="hljs-keyword">var</span> number: <span class="hljs-type">Number?</span>
  <span class="hljs-comment">// Other code...</span>
}</code></pre><br>
</div></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">おまけ：参照型と値型のループ。</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Swiftには参照型（クラスとクロージャー）と値型（構造体、列挙型）があります。</font><font style="vertical-align: inherit;">値タイプは渡されるときにコピーされ、参照タイプはリンクを使用して同じ値を共有します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、値タイプの場合、循環がないことを意味します。</font><font style="vertical-align: inherit;">ループが発生するには、少なくとも2つの参照型が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cyclesプロジェクトに戻り、このコードをMainViewController.swiftの最後に追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Node</span> </span>{ <span class="hljs-comment">// Error</span>
  <span class="hljs-keyword">var</span> payload = <span class="hljs-number">0</span>
  <span class="hljs-keyword">var</span> next: <span class="hljs-type">Node?</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
動作しないでしょう！</font><font style="vertical-align: inherit;">構造体は値型であり、それ自体のインスタンスに対して再帰を持つことはできません。</font><font style="vertical-align: inherit;">そうでなければ、そのような構造は無限のサイズになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構造をクラスに変更します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Node</span> </span>{
  <span class="hljs-keyword">var</span> payload = <span class="hljs-number">0</span>
  <span class="hljs-keyword">var</span> next: <span class="hljs-type">Node?</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それ自体への参照は、クラス（参照タイプ）で完全に受け入れられるため、コンパイラーに問題はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これをMainViewController.swiftの最後に追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{
  <span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span>
  <span class="hljs-keyword">var</span> friends: [<span class="hljs-type">Person</span>] = []
  <span class="hljs-keyword">init</span>(name: <span class="hljs-type">String</span>) {
    <span class="hljs-keyword">self</span>.name = name
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"New person instance: \(name)"</span>)<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">deinit</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Person instance \(name) is being deallocated"</span>)<font></font>
  }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、これはrunScenario（）の最後です。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">do</span> {
  <span class="hljs-keyword">let</span> ernie = <span class="hljs-type">Person</span>(name: <span class="hljs-string">"Ernie"</span>)
  <span class="hljs-keyword">let</span> bert = <span class="hljs-type">Person</span>(name: <span class="hljs-string">"Bert"</span>)<font></font>
  <font></font>
  ernie.friends.append(bert) <span class="hljs-comment">// Not deallocated</span>
  bert.friends.append(ernie) <span class="hljs-comment">// Not deallocated</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリを起動します。</font><font style="vertical-align: inherit;">注意：ernieもbertもリリースされていません。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンクと意味</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、リンクのループを引き起こした参照タイプと値タイプの組み合わせの例です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
配列自体は値型ですが、ernieとbertはリリースされないままで、お互いをフレンド配列に保持しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
友達のアーカイブを非所有者として作成しようとすると、Xcodeはエラーを表示します。非所有者はクラスにのみ適用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このループを修正するには、ラッパーオブジェクトを作成し、それを使用して配列にインスタンスを追加する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Personクラスの前に次の定義を追加します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Unowned</span>&lt;<span class="hljs-title">T</span>: <span class="hljs-title">AnyObject</span>&gt; </span>{
  <span class="hljs-keyword">unowned</span> <span class="hljs-keyword">var</span> value: <span class="hljs-type">T</span>
  <span class="hljs-keyword">init</span> (<span class="hljs-number">_</span> value: <span class="hljs-type">T</span>) {
    <span class="hljs-keyword">self</span>.value = value<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、Personクラスのフレンド定義を変更します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">var</span> friends: [<span class="hljs-type">Unowned</span>&lt;<span class="hljs-type">Person</span>&gt;] = []</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、runScenario（）のdoブロックの内容を置き換えます。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">do</span> {
  <span class="hljs-keyword">let</span> ernie = <span class="hljs-type">Person</span>(name: <span class="hljs-string">"Ernie"</span>)
  <span class="hljs-keyword">let</span> bert = <span class="hljs-type">Person</span>(name: <span class="hljs-string">"Bert"</span>)<font></font>
  <font></font>
  ernie.friends.append(<span class="hljs-type">Unowned</span>(bert))<font></font>
  bert.friends.append(<span class="hljs-type">Unowned</span>(ernie))<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションを起動すると、アーニーとバートが正しくリリースされます！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
friends配列はPersonオブジェクトのコレクションではなくなりました。</font><font style="vertical-align: inherit;">これは現在、</font><font style="vertical-align: inherit;">Personインスタンスのラッパーとして機能する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unownedオブジェクトのコレクションです</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UnownedからPersonオブジェクトを取得するには、valueプロパティを使用します。</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-keyword">let</span> firstFriend = bert.friends.first?.value <span class="hljs-comment">// get ernie </span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、Swiftのメモリ管理を十分に理解し、ARCがどのように機能するかを理解できました。</font><font style="vertical-align: inherit;">この出版物がお役に立てば幸いです。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アップル：自動参照カウント</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja451116/index.html">共有要素の移行に苦労し、初めてのオープンソースライブラリを作成した方法</a></li>
<li><a href="../ja451118/index.html">テストは初心者向けではありません</a></li>
<li><a href="../ja451120/index.html">デッドセルをモバイルプラットフォームに移植する際の課題について</a></li>
<li><a href="../ja451124/index.html">Pythonとトランスクリプトを使用したクラウドでのタンパク質の開発または360ドルで任意のタンパク質を作成する方法</a></li>
<li><a href="../ja451126/index.html">研究者向けツールボックス-第1号：自己組織化とデータ視覚化</a></li>
<li><a href="../ja451132/index.html">消費者主導の契約またはGitlab CI Eyed QAテスト自動化</a></li>
<li><a href="../ja451136/index.html">.NET 5で導入</a></li>
<li><a href="../ja451138/index.html">Symfony CLI-新しいローカル開発ツール</a></li>
<li><a href="../ja451144/index.html">骨董品：テレビ広告のテクニック</a></li>
<li><a href="../ja451146/index.html">Webpackを使用したWebアプリケーションビルドの高速化</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>