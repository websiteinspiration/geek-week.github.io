<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¶üèº üëâüèº üë®üèº‚Äçüé§ Acelere su b√∫squeda en ¬øMe han llevado a 49 microsegundos (C ++) üà∫ üñïüèª üë®üèº‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace tiempo que conozco el sitio Have I Been Pwned (HIBP) . Es cierto, hasta hace poco, nunca hab√≠a estado all√≠. Siempre tuve dos contrase√±as. Uno de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Acelere su b√∫squeda en ¬øMe han llevado a 49 microsegundos (C ++)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490920/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/fu/rg/hn/furghncw9u08teobuskqawx2y7u.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace tiempo que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conozco el sitio Have I Been Pwned (HIBP)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es cierto, hasta hace poco, nunca hab√≠a estado all√≠. Siempre tuve dos contrase√±as. Uno de ellos fue usado repetidamente para correo basura y un par de cuentas en sitios extra√±os. Pero tuve que rechazarlo, porque el correo fue pirateado. Y para ser honesto, estoy agradecido con el hacker porque este evento me hizo revisar mis contrase√±as, la forma en que las uso y las guardo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, cambi√© las contrase√±as en todas las cuentas donde hab√≠a una contrase√±a comprometida. Luego me pregunt√© si la contrase√±a filtrada estaba en la base de datos HIBP. No quer√≠a ingresar la contrase√±a en el sitio, as√≠ que descargu√© la base de datos (</font></font><code>pwned-passwords-sha1-ordered-by-count-v5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">La base es muy impresionante. </font><font style="vertical-align: inherit;">Este es un archivo de texto de 22.8 GB con un conjunto de hashes SHA-1, uno en cada l√≠nea con un contador, cu√°ntas veces se produjo la contrase√±a con este hash en fugas. </font><font style="vertical-align: inherit;">Descubr√≠ el SHA-1 de mi contrase√±a descifrada e intent√© encontrarla.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contenido</font></font></h1><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[G] rep</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estructura Trie</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√∫squeda binaria</font></font></a><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clasificaci√≥n</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© fusionarse de nuevo?</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paralelismo</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No seas un bastardo ego√≠sta</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B3</font></font></a><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipo de inserci√≥n</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øSeparado o no?</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Propiedades del √°rbol HIBP</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo de salida</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puntos de referencia</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">okon - biblioteca y CLI</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enlaces y discusi√≥n</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gracias por leer</font></font></a></li>
</ul><br>
<a name="1"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[G] rep</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos un archivo de texto con un hash en cada l√≠nea. </font><font style="vertical-align: inherit;">Probablemente el mejor lugar para ir es grep. </font></font><br>
<br>
<code>grep -m 1 '^XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX' pwned-passwords-sha1-ordered-by-count-v5.txt</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mi contrase√±a estaba en la parte superior de la lista con una frecuencia de m√°s de 1,500 veces, por lo que realmente apesta. </font><font style="vertical-align: inherit;">En consecuencia, los resultados de b√∫squeda regresaron casi al instante. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero no todos tienen contrase√±as d√©biles. </font><font style="vertical-align: inherit;">Quer√≠a comprobar cu√°nto tiempo llevar√≠a encontrar el peor de los casos: el √∫ltimo hash del archivo: </font></font><br>
<br>
<code>time grep -m 1 '^4541A1E4605EEBF3F4C166329C18502DF75D348A' pwned-passwords-sha1-ordered-by-count-v5.txt</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resultado: </font></font><code>33,35s user 23,39s system 41% cpu 2:15,35 total</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es triste. </font><font style="vertical-align: inherit;">Despu√©s de todo, dado que mi correo fue pirateado, quer√≠a verificar la presencia de todas mis contrase√±as antiguas y nuevas en la base de datos. </font><font style="vertical-align: inherit;">Pero un grep de dos minutos simplemente no te permite hacer esto c√≥modamente. </font><font style="vertical-align: inherit;">Por supuesto, podr√≠a escribir un script, ejecutarlo e ir a caminar, pero esta no es una opci√≥n. </font><font style="vertical-align: inherit;">Quer√≠a encontrar una mejor soluci√≥n y aprender algo.</font></font><br>
<br>
<a name="2"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estructura Trie</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La primera idea fue utilizar una estructura de datos trie. La estructura parece ideal para almacenar hash SHA-1. El alfabeto es peque√±o, por lo que los nodos tambi√©n ser√°n peque√±os, al igual que el archivo resultante. ¬øQuiz√°s incluso cabe en la RAM? La b√∫squeda clave debe ser muy r√°pida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces implement√© esta estructura. Luego tom√≥ los primeros 1,000,000 hashes de la base de datos de origen para construir el archivo resultante y verificar si todo est√° en el archivo creado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S√≠, pude encontrar todo en el archivo, por lo que la estructura funcion√≥ bien. El problema fue diferente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo resultante se lanz√≥ en tama√±o 2283686592B (2,2 GB). Esto no est√° bien. Vamos a contar y ver qu√© pasa. Un nodo es una estructura simple de diecis√©is valores de 32 bits. Los valores son "punteros" a los siguientes nodos con el s√≠mbolo hash SHA-1 especificado. Entonces, un nodo toma 16 * 4 bytes = 64 bytes. Parece ser un poco? Pero si lo piensa, un nodo representa un car√°cter en un hash. Por lo tanto, en el peor de los casos, el hash SHA-1 tomar√° 40 * 64 bytes = 2560 bytes. Esto es mucho peor que, por ejemplo, una representaci√≥n textual de un hash que ocupa solo 40 bytes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La estructura trie tiene la ventaja de reutilizar nodos. Si tiene dos palabras </font></font><code>aaa</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>abb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, entonces el nodo para los primeros caracteres se reutiliza, porque los caracteres son iguales - </font></font><code>a</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Volvamos a nuestro problema. </font><font style="vertical-align: inherit;">Calculemos cu√°ntos nodos se almacenan en el archivo resultante: </font></font><code>file_size / node_size = 2283686592 / 64 = 35682603</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ahora veamos cu√°ntos nodos se crear√°n en el peor de los casos a partir de un mill√≥n de hashes: por lo </font></font><code>1000000 * 40 = 40000000</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tanto, la estructura trie reutiliza solo </font></font><code>40000000 - 35682603 = 4317397</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nodos, que es el 10.8% del peor de los casos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con tales indicadores, el archivo resultante para toda la base de datos HIBP tomar√≠a 1421513361920 bytes (1.02 TB). </font><font style="vertical-align: inherit;">Ni siquiera tengo suficiente disco duro para verificar la velocidad de b√∫squeda clave. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ese d√≠a, descubr√≠ que la estructura del trie no es adecuada para datos relativamente aleatorios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Busquemos otra soluci√≥n.</font></font><br>
<br>
<a name="3"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√∫squeda binaria</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los hash SHA-1 tienen dos caracter√≠sticas agradables: son comparables entre s√≠ y son todos del mismo tama√±o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias a esto, podemos procesar la base de datos HIBP original y crear un archivo a partir de los valores SHA-1 ordenados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero, ¬øc√≥mo ordenar un archivo de 22 GB? </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pregunta. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© ordenar el archivo fuente? </font><font style="vertical-align: inherit;">HIBP devuelve un archivo con cadenas ya ordenadas por hashes. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responder. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplemente no lo pens√©. </font><font style="vertical-align: inherit;">En ese momento no sab√≠a sobre el archivo ordenado.</font></font></i> <br>
<br>
<a name="4"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Clasificaci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ordenar todos los hashes en RAM no es una opci√≥n; no tengo mucha RAM. </font><font style="vertical-align: inherit;">La soluci√≥n fue esta:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Divide un archivo grande en archivos m√°s peque√±os que quepan en la RAM.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descargue datos de archivos peque√±os, ordene en RAM y vuelva a escribir en los archivos.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combina todos los archivos peque√±os y ordenados en uno grande.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con un archivo ordenado grande, puede buscar nuestro hash utilizando una b√∫squeda binaria. </font><font style="vertical-align: inherit;">El acceso al disco duro es importante. </font><font style="vertical-align: inherit;">Calculemos cu√°ntos resultados se requieren en una b√∫squeda binaria: </font></font><code>log2(555278657) = 29.0486367039</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es decir, 30 resultados. </font><font style="vertical-align: inherit;">No es tan malo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la primera etapa, se puede realizar la optimizaci√≥n. </font><font style="vertical-align: inherit;">Convierte hashes de texto en datos binarios. </font><font style="vertical-align: inherit;">Esto reducir√° el tama√±o de los datos resultantes a la mitad: de 22 a 11 GB. </font><font style="vertical-align: inherit;">Multa.</font></font><br>
<br>
<a name="5"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øPor qu√© fusionarse de nuevo?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En ese momento, me di cuenta de que puedes hacerlo de manera m√°s inteligente. </font><font style="vertical-align: inherit;">¬øQu√© sucede si no combina archivos peque√±os en uno grande, sino que realiza una b√∫squeda binaria en archivos peque√±os ordenados en RAM? </font><font style="vertical-align: inherit;">El problema es c√≥mo encontrar el archivo deseado en el que buscar la clave. </font><font style="vertical-align: inherit;">La soluci√≥n es muy simple. </font><font style="vertical-align: inherit;">Nuevo enfoque:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cree 256 archivos con los nombres "00" ... "FF".</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando lea hashes de un archivo grande, escriba hash que comiencen con ‚Äú00 ..‚Äù en un archivo llamado ‚Äú00‚Äù, hash que comiencen con ‚Äú01 ..‚Äù - en un archivo ‚Äú01‚Äù y as√≠ sucesivamente.</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descargue datos de archivos peque√±os, ordene en RAM y vuelva a escribir en los archivos.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo es muy simple. </font><font style="vertical-align: inherit;">Adem√°s, aparece otra opci√≥n de optimizaci√≥n. </font><font style="vertical-align: inherit;">Si el hash est√° almacenado en el archivo "00", entonces sabemos que comienza con "00". </font><font style="vertical-align: inherit;">Si el hash se almacena en el archivo "F2", comienza con "F2". </font><font style="vertical-align: inherit;">Por lo tanto, al escribir hash en archivos peque√±os, ¬°podemos omitir el primer byte de cada hash! </font><font style="vertical-align: inherit;">Este es el 5% de todos los datos. </font><font style="vertical-align: inherit;">555 MB se guardan en total.</font></font><br>
<br>
<a name="6"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Paralelismo</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La separaci√≥n en archivos m√°s peque√±os ofrece otra oportunidad para la optimizaci√≥n. </font><font style="vertical-align: inherit;">Los archivos son independientes entre s√≠, por lo que podemos ordenarlos en paralelo. </font><font style="vertical-align: inherit;">Recordamos que a todos sus procesadores les gusta sudar al mismo tiempo;)</font></font><br>
<br>
<a name="7"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No seas un bastardo ego√≠sta</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando implement√© la soluci√≥n anterior, me di cuenta de que otras personas probablemente ten√≠an un problema similar. Probablemente muchos otros tambi√©n descarguen y busquen en la base de datos HIBP. Entonces decid√≠ compartir mi trabajo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de eso, una vez m√°s revis√© mi enfoque y encontr√© un par de problemas que me gustar√≠a solucionar antes de publicar el c√≥digo y las herramientas en Github. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En primer lugar, como usuario final, no quisiera utilizar una herramienta que crea muchos archivos extra√±os con nombres extra√±os, en los que no est√° claro qu√© est√° almacenado, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bueno, esto se puede resolver combinando los archivos "00" .. "FF" en Un gran archivo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desafortunadamente, tener un archivo grande para ordenar plantea un nuevo problema. </font><font style="vertical-align: inherit;">¬øQu√© sucede si quiero insertar un hash en este archivo? </font><font style="vertical-align: inherit;">Solo un hash. </font><font style="vertical-align: inherit;">Esto es solo 20 bytes. </font><font style="vertical-align: inherit;">Oh, el hash comienza con "000000000 ..". </font><font style="vertical-align: inherit;">Bueno. </font><font style="vertical-align: inherit;">Liberemos espacio para √©l moviendo 11 GB de otros hashes ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entiende cu√°l es el problema. </font><font style="vertical-align: inherit;">Insertar datos en el medio de un archivo no es la operaci√≥n m√°s r√°pida. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Otro inconveniente de este enfoque es que necesita almacenar los primeros bytes nuevamente: son 555 MB de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y por √∫ltimo, pero no menos importante, una b√∫squeda binaria en los datos almacenados en un disco duro es mucho m√°s lenta que acceder a la RAM. </font><font style="vertical-align: inherit;">Quiero decir, esto es 30 lecturas de disco versus 0 lecturas de disco.</font></font><br>
<br>
<a name="8"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B3</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De nuevo. </font><font style="vertical-align: inherit;">Lo que tenemos y lo que queremos lograr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenemos 11 GB de valores binarios. </font><font style="vertical-align: inherit;">Todos los valores son comparables y tienen el mismo tama√±o. </font><font style="vertical-align: inherit;">Queremos averiguar si una clave particular est√° presente en los datos almacenados, y tambi√©n queremos cambiar la base de datos. </font><font style="vertical-align: inherit;">Y para que todo funcione r√°pidamente. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/18c/851/d23/18c851d23c6bbe290fcccb763c6f09eb.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B-√°rbol? </font><font style="vertical-align: inherit;">Derecha </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El √°rbol B le permite minimizar el acceso al disco cuando busca, modifica, etc. Tiene muchas m√°s funciones, pero necesitamos estas dos.</font></font><br>
<br>
<a name="9"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipo de inserci√≥n</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer paso es convertir los datos del archivo fuente HIBP al √°rbol B. Esto significa que debe extraer todos los hashes a su vez e insertarlos en la estructura. El algoritmo de inserci√≥n habitual es adecuado para esto. Pero en nuestro caso, puedes hacerlo mejor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Insertar una gran cantidad de datos en bruto en un √°rbol B es un escenario bien conocido. Las personas sabias han inventado un mejor enfoque para esto que el inserto habitual. En primer lugar, debe ordenar los datos. Esto se puede hacer como se describi√≥ anteriormente (dividir el archivo en archivos m√°s peque√±os y ordenarlos en RAM). Luego inserte los datos en el √°rbol.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el algoritmo habitual, si encuentra el nodo hoja donde desea insertar el valor y se llena, entonces crea un nuevo nodo (a la derecha) y distribuye uniformemente los valores entre los dos nodos, izquierdo y derecho (m√°s un valor va al nodo principal pero no es importante aqu√≠). En resumen, los valores en el nodo izquierdo son siempre menores que los valores en el derecho. El hecho es que cuando inserta los datos ordenados, sabe que los valores m√°s peque√±os ya no se insertar√°n en el √°rbol, por lo tanto, no m√°s valores ir√°n al nodo izquierdo. El nodo izquierdo permanece medio vac√≠o todo el tiempo. Adem√°s, si inserta suficientes valores, puede encontrar que el nodo derecho est√° lleno, por lo que debe mover la mitad de los valores al nuevo nodo derecho. El nodo dividido permanece medio vac√≠o, como en el caso anterior. Etc ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, despu√©s de todas las inserciones, obtienes un √°rbol en el que casi todos los nodos est√°n medio vac√≠os. </font><font style="vertical-align: inherit;">Este no es un uso muy eficiente del espacio. </font><font style="vertical-align: inherit;">Podemos hacerlo mejor.</font></font><br>
<br>
<a name="10"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øSeparado o no?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el caso de insertar datos ordenados, puede realizar una peque√±a modificaci√≥n en el algoritmo de inserci√≥n. </font><font style="vertical-align: inherit;">Si el nodo en el que desea pegar el valor est√° lleno, no lo rompa. </font><font style="vertical-align: inherit;">Simplemente cree un nuevo nodo vac√≠o y pegue el valor en el nodo principal. </font><font style="vertical-align: inherit;">Luego, cuando inserta los siguientes valores (que son m√°s grandes que los anteriores), los inserta en un nodo nuevo y vac√≠o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para preservar las propiedades del √°rbol B, despu√©s de todas las inserciones, es necesario ordenar los nodos m√°s a la derecha en cada capa del √°rbol (excepto la ra√≠z) y dividir equitativamente los valores de este nodo extremo y su vecino izquierdo. </font><font style="vertical-align: inherit;">Entonces obtienes el √°rbol m√°s peque√±o posible.</font></font><br>
<br>
<a name="11"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Propiedades del √°rbol HIBP</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al dise√±ar un √°rbol B, debe elegir su orden. </font><font style="vertical-align: inherit;">Muestra cu√°ntos valores se pueden almacenar en un nodo, as√≠ como cu√°ntos hijos puede tener el nodo. </font><font style="vertical-align: inherit;">Al manipular este par√°metro, podemos manipular la altura del √°rbol, el tama√±o binario del nodo, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En HIBP, tenemos </font></font><code>555278657</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hashes. </font><font style="vertical-align: inherit;">Supongamos que queremos un √°rbol de tres en altura (por lo que no necesitamos m√°s de tres operaciones de lectura para verificar la presencia de un hash). </font><font style="vertical-align: inherit;">Necesitamos encontrar un valor de M tal que </font></font><code>logM(555278657) &lt; 3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eleg√≠ 1024. Este no es el valor m√°s peque√±o posible, pero permite insertar m√°s hashes y preservar la altura del √°rbol.</font></font><br>
<br>
<a name="12"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archivo de salida</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El archivo fuente HIBP tiene un tama√±o de 22.8 GB. </font><font style="vertical-align: inherit;">El archivo de salida con el √°rbol B es de 12,4 GB. </font><font style="vertical-align: inherit;">Se tarda unos 11 minutos en crearlo en mi m√°quina (Intel Core i7-6700, 3,4 GHz, 16 GB de RAM), disco duro (no SSD).</font></font><br>
<br>
<a name="13"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puntos de referencia</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La opci√≥n B-tree muestra un resultado bastante bueno:</font></font><br>
<br>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El | </font><font style="vertical-align: inherit;">El | </font><font style="vertical-align: inherit;">tiempo [Œºs] | </font><font style="vertical-align: inherit;">% |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
| -----------------: | ------------: | ------------: |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El | </font><font style="vertical-align: inherit;">okon | </font><font style="vertical-align: inherit;">49 </font><font style="vertical-align: inherit;">100</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El | </font><font style="vertical-align: inherit;">grep '^ hash' | </font><font style="vertical-align: inherit;">135'350'000 | </font><font style="vertical-align: inherit;">276'224'489 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El | </font><font style="vertical-align: inherit;">grep | </font><font style="vertical-align: inherit;">135'480'000 | </font><font style="vertical-align: inherit;">276'489'795 |</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El | </font><font style="vertical-align: inherit;">C ++ l√≠nea por l√≠nea | </font><font style="vertical-align: inherit;">135'720'201 | </font><font style="vertical-align: inherit;">276'980'002 |</font></font></pre><br>
<a name="14"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">okon - biblioteca y CLI</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como dije, quer√≠a compartir mi trabajo con el mundo. Implement√© una biblioteca y una interfaz de l√≠nea de comandos para procesar la base de datos HIBP y buscar r√°pidamente hashes. La b√∫squeda es tan r√°pida que puede, por ejemplo, integrarse en un administrador de contrase√±as y dar retroalimentaci√≥n al usuario cada vez que se presiona una tecla. Hay muchos usos posibles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La biblioteca tiene una interfaz C, por lo que se puede usar en casi todas partes. CLI es un CLI. Simplemente puede compilar y ejecutar (: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo est√° en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mi repositorio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Descargo de responsabilidad: okon a√∫n no proporciona una interfaz para insertar valores en el √°rbol B creado. </font><font style="vertical-align: inherit;">Solo puede procesar el archivo HIBP, crear un √°rbol B y buscar en √©l. </font><font style="vertical-align: inherit;">Estas funciones funcionan bastante bien, as√≠ que decid√≠ compartir el c√≥digo y continuar trabajando en la inserci√≥n y otras funciones posibles.</font></font><br>
<br>
<a name="15"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enlaces y discusi√≥n</font></font></h1><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estructura Trie</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Årbol B</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El sitio web me ha enviado</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repositorio de c√≥digo</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r / cpp</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r / seguridad</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noticias de hackers</font></font></a></li>
</ul><br>
<a name="16"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gracias por leer</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(:</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es490906/index.html">Yandex lanz√≥ una versi√≥n beta de un Aura independiente: aura.top. ¬øEs superior?</a></li>
<li><a href="../es490908/index.html">Zona de almacenamiento de datos</a></li>
<li><a href="../es490912/index.html">C√≥mo en Sportmaster elegimos un sistema de almacenamiento en cach√©. Parte 1</a></li>
<li><a href="../es490916/index.html">Problemas de interacci√≥n con equipos externos en grandes proyectos.</a></li>
<li><a href="../es490918/index.html">Andrei Zaretsky, Alexander Trukhanov (continuaci√≥n): "No ten√≠amos un nombre, pero hab√≠a arrogancia"</a></li>
<li><a href="../es490924/index.html">¬øQu√© es Windows PowerShell y qu√© come? Parte 2: Introducci√≥n al lenguaje de programaci√≥n.</a></li>
<li><a href="../es490926/index.html">Trayectoria de la bola de la unidad 2d para principiantes</a></li>
<li><a href="../es490932/index.html">[Pron√≥stico] Motornet - una red de intercambio de datos para veh√≠culos rob√≥ticos</a></li>
<li><a href="../es490936/index.html">Crea ML en iOS</a></li>
<li><a href="../es490938/index.html">Escribimos miles de archivos de registro a la vez</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>