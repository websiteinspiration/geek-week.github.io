<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîâ üíÖüèΩ üß£ DEVOXX UK. Kubernetes en production: d√©ploiement bleu / vert, mise √† l'√©chelle automatique et automatisation du d√©ploiement. Partie 2 üëãüèæ üí≥ üíü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kubernetes est un excellent outil pour ex√©cuter des conteneurs Docker dans un environnement de production en cluster. Cependant, il existe des t√¢ches ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>DEVOXX UK. Kubernetes en production: d√©ploiement bleu / vert, mise √† l'√©chelle automatique et automatisation du d√©ploiement. Partie 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/504672/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes est un excellent outil pour ex√©cuter des conteneurs Docker dans un environnement de production en cluster. Cependant, il existe des t√¢ches que Kubernetes n'est pas en mesure de r√©soudre. Avec des d√©ploiements fr√©quents dans un environnement de production, nous avons besoin d'un d√©ploiement bleu / vert enti√®rement automatis√© pour √©viter les temps d'arr√™t dans ce processus, qui n√©cessite √©galement des requ√™tes HTTP externes et un t√©l√©chargement SSL. Cela n√©cessite une int√©gration avec un √©quilibreur de charge tel que ha-proxy. Une autre t√¢che est la mise √† l'√©chelle semi-automatique du cluster Kubernetes lui-m√™me lorsque vous travaillez dans le cloud, par exemple, la r√©duction partielle de l'√©chelle du cluster la nuit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que Kubernetes ne dispose pas de ces fonctionnalit√©s, il fournit une API qui peut √™tre utilis√©e pour r√©soudre de tels probl√®mes. Les outils de d√©ploiement et de mise √† l'√©chelle automatis√©s du cluster Kubernetes bleu / vert ont √©t√© d√©velopp√©s dans le cadre du projet open source Cloud RTI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette transcription vid√©o d√©crit comment configurer Kubernetes avec d'autres composants open source pour obtenir un environnement pr√™t pour la production qui accepte le code de la modification git commit sans interruption de production.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cy/4y/jm/cy4yjm9zwmpfpvtfwhwfigavpkw.jpeg"><a name="habracut"></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DEVOXX UK. Kubernetes en production: d√©ploiement bleu / vert, mise √† l'√©chelle automatique et automatisation du d√©ploiement. Partie 1</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Donc, apr√®s avoir acc√©d√© √† vos applications depuis le monde ext√©rieur, vous pouvez commencer √† configurer compl√®tement l'automatisation, c'est-√†-dire l'amener au stade o√π vous pouvez ex√©cuter git commit et vous assurer que ce git commit se termine en production. Naturellement, dans la mise en ≈ìuvre de ces √©tapes, dans la mise en ≈ìuvre du d√©ploiement, nous ne voulons pas faire face √† des temps d'arr√™t. Ainsi, toute automatisation dans Kubernetes commence par une API.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/5q/w4/ng/5qw4ngl2hrnecjzk4sfvhhepx_k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes n'est pas un outil qui peut √™tre utilis√© ¬´pr√™t √† l'emploi¬ª de mani√®re productive. Bien s√ªr, vous pouvez le faire, utiliser kubectl et ainsi de suite, mais l'API est toujours la chose la plus int√©ressante et utile de cette plate-forme. En utilisant l'API comme un ensemble de fonctionnalit√©s, vous pouvez acc√©der √† presque tout ce que vous voulez faire dans Kubernetes. Kubectl lui-m√™me utilise √©galement l'API REST.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit de REST, vous pouvez donc utiliser n'importe quel langage et outil pour travailler avec cette API, mais les biblioth√®ques utilisateur vous faciliteront grandement la vie. Mon √©quipe a √©crit 2 biblioth√®ques de ce type: une pour Java / OSGi et une pour Go. La seconde n'est pas souvent utilis√©e, mais en tout cas, ces choses utiles sont √† votre disposition. Il s'agit d'un projet open source partiellement sous licence. Il existe de nombreuses biblioth√®ques de ce type pour diff√©rentes langues, vous pouvez donc choisir la plus appropri√©e.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ej/bj/ey/ejbjeyepppr2tet3aupem789num.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, avant de vous lancer dans l'automatisation du d√©ploiement, vous devez vous assurer que ce processus n'est soumis √† aucun temps d'arr√™t. Par exemple, notre √©quipe effectue le d√©ploiement de la production au milieu de la journ√©e, lorsque les gens tirent le meilleur parti de leurs applications, il est donc tr√®s important d'√©viter les retards dans ce processus. Afin d'√©viter les temps d'arr√™t, 2 m√©thodes sont utilis√©es: d√©ploiement bleu / vert ou mise √† jour continue mise √† jour continue. Dans ce dernier cas, si vous avez 5 r√©pliques de l'application en cours d'ex√©cution, elles sont mises √† jour s√©quentiellement l'une apr√®s l'autre. Cette m√©thode fonctionne tr√®s bien, mais elle ne fonctionne pas si vous ex√©cutez diff√©rentes versions de l'application en m√™me temps pendant le processus de d√©ploiement. Dans ce cas, vous pouvez mettre √† jour l'interface utilisateur pendant que le backend fonctionnera avec l'ancienne version et l'application cessera de fonctionner.Par cons√©quent, du point de vue de la programmation, travailler dans de telles conditions est plut√¥t difficile.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est l'une des raisons pour lesquelles nous pr√©f√©rons utiliser le d√©ploiement bleu / vert pour automatiser le d√©ploiement de nos applications. Avec cette m√©thode, vous devez vous assurer qu'√† un certain moment, une seule version de l'application est active. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le m√©canisme de d√©ploiement bleu / vert est le suivant. Nous obtenons du trafic pour nos applications via ha-proxy, qui le dirige vers l'ex√©cution de r√©pliques d'applications de la m√™me version.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsqu'un nouveau d√©ploiement est effectu√©, nous utilisons Deployer, qui est fourni avec de nouveaux composants, et il d√©ploie la nouvelle version. Le d√©ploiement d'une nouvelle version d'une application signifie qu'un nouvel ensemble de r√©pliques "augmente", apr√®s quoi ces r√©pliques de la nouvelle version sont lanc√©es dans un nouveau pod distinct. Cependant, ha-proxy ne sait rien √† leur sujet et ne leur a jusqu'√† pr√©sent envoy√© aucune charge de travail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, tout d'abord, il est n√©cessaire de v√©rifier la sant√© des nouvelles versions de sant√© cheking pour vous assurer que les r√©pliques sont pr√™tes √† servir la charge.</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dx/qk/vd/dxqkvdwkbon86_g0l0plg-dqezu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les composants de d√©ploiement doivent prendre en charge une certaine forme de contr√¥le de sant√©. Cela peut √™tre une v√©rification HTTP tr√®s simple avec un appel lorsque vous recevez un code avec un statut de 200, ou une v√©rification plus approfondie, dans laquelle vous v√©rifiez la connexion des r√©pliques avec la base de donn√©es et d'autres services, la stabilit√© des connexions de l'environnement dynamique, si tout d√©marre et fonctionne correctement. Ce processus peut √™tre assez compliqu√©. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lr/9t/o4/lr9to4uiafxnxpjfbuyzd3ubtgo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que le syst√®me a v√©rifi√© que toutes les r√©pliques mises √† jour sont op√©rationnelles, Deployer mettra √† jour la configuration et transmettra le bon confd, qui reconfigurera ha-proxy. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kw/q1/s7/kwq1s7fkzffaby-ajt6jyrg2vra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce n'est qu'apr√®s que le trafic sera dirig√© vers le dessous avec des r√©pliques de la nouvelle version, et l'ancienne dispara√Ætra.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wa/q5/c6/waq5c6mmixf0j3twtrhetjjdvx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce m√©canisme n'est pas une fonctionnalit√© de Kubernetes. Le concept de d√©ploiement bleu / vert existe depuis un certain temps et il a toujours utilis√© un √©quilibreur de charge. Tout d'abord, vous dirigez tout le trafic vers l'ancienne version de l'application, et apr√®s la mise √† niveau, transf√©rez-le compl√®tement vers la nouvelle version. Ce principe est utilis√© non seulement dans Kubernetes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je vais maintenant vous pr√©senter un nouveau composant de d√©ploiement - Deployer, qui effectue un bilan de sant√©, reconfigure les proxys, etc. Il s'agit d'un concept qui ne s'applique pas au monde ext√©rieur et qui existe √† l'int√©rieur de Kubernetes. Je vais vous montrer comment cr√©er votre propre concept Deployer √† l'aide d'outils open-source.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, la premi√®re chose que Deployer fait est de cr√©er un contr√¥leur de r√©plication RC √† l'aide de l'API Kubernetes. Cette API cr√©e des modules et des services pour un d√©ploiement ult√©rieur, c'est-√†-dire qu'elle cr√©e un cluster compl√®tement nouveau pour nos applications. Une fois que le CR a v√©rifi√© que les r√©pliques ont commenc√©, il v√©rifie leur bilan de sant√©. Pour ce faire, Deployer utilise la commande GET / health. Il lance les composants de v√©rification correspondants et v√©rifie tous les √©l√©ments qui assurent le fonctionnement du cluster.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/km/lr/8u/kmlr8uloqusoeejhd-7dquyzu7q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que tous les pods ont signal√© leur ¬´sant√©¬ª, Deployer cr√©e un nouvel √©l√©ment de configuration - le stockage distribu√©, etc., qui est utilis√© dans Kubernetes, y compris pour stocker la configuration de l'√©quilibreur de charge. Nous √©crivons des donn√©es dans etcd, et un petit outil, confd, surveille etcd pour les nouvelles donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'il trouve des modifications dans la configuration initiale, il g√©n√®re un nouveau fichier de param√®tres et le transmet √† ha-proxy. Dans ce cas, ha-proxy red√©marre sans perdre de connexion et traite la charge avec de nouveaux services qui fournissent la nouvelle version de nos applications.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h2/1k/os/h21kosweevmblkultqa8kspeuri.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, malgr√© l'abondance de composants, il n'y a rien de compliqu√©. </font><font style="vertical-align: inherit;">Vous avez juste besoin de pr√™ter plus d'attention √† l'API et etcd. </font><font style="vertical-align: inherit;">Je veux vous parler du d√©ployeur open-source que nous utilisons nous-m√™mes - c'est Amdatu Kubernetes Deployer. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ir/oj/vt/irojvt6tjy6vgckfsizgnycysdm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'un outil d'orchestration de d√©ploiement Kubernetes avec les fonctionnalit√©s suivantes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©ploiement bleu / vert</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mise en place d'un √©quilibreur de charge externe;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestion des descripteurs de d√©ploiement</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gestion r√©elle du d√©ploiement</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contr√¥les d'int√©grit√© pendant le d√©ploiement</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">impl√©mentation de variables d'environnement dans les pods.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cr√©√© au-dessus de l'API Kubernetes, ce d√©ployeur fournit une API REST pour g√©rer les descripteurs et les d√©ploiements, ainsi qu'une API Websocket pour les journaux de flux pendant le d√©ploiement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il place les donn√©es de configuration de l'√©quilibreur de charge dans etcd, vous ne pouvez donc pas utiliser ha-proxy avec une prise en charge "pr√™te √† l'emploi", mais il est facile d'utiliser votre propre fichier de configuration de l'√©quilibreur. Amdatu Deployer est √©crit en Go, tout comme Kubernetes lui-m√™me, et sous licence Apache. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant d'utiliser cette version du d√©ployeur, j'ai utilis√© le descripteur de d√©ploiement suivant, qui sp√©cifie les param√®tres dont j'ai besoin.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_p/fr/ht/_pfrhtrtusrz0ua6480jo3acqvo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'un des param√®tres importants de ce code est d'activer l'indicateur ¬´useHealthCheck¬ª. Nous devons indiquer qu'un bilan de sant√© est requis pendant le processus de d√©ploiement. Cette option peut √™tre d√©sactiv√©e lorsque le d√©ploiement utilise des conteneurs tiers qui n'ont pas besoin d'√™tre v√©rifi√©s. Ce descripteur indique √©galement le nombre de r√©pliques et l'URL frontale dont ha-proxy a besoin. √Ä la fin se trouve l'indicateur de sp√©cification du pod podspec, qui appelle Kubernetes pour obtenir des informations sur la configuration du port, l'image, etc. Il s'agit d'un descripteur assez simple au format JSON.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre outil qui fait partie du projet open source Amdatu est Deploymentctl. Il poss√®de une interface utilisateur pour configurer le d√©ploiement, stocke l'historique du d√©ploiement et contient des webhooks pour les rappels par des utilisateurs et des d√©veloppeurs tiers. Vous ne pouvez pas utiliser l'interface utilisateur, car Amdatu Deployer lui-m√™me est une API REST, mais cette interface peut vous faciliter le d√©ploiement sans impliquer d'API. Deploymentctl est √©crit en OSGi / Vertx en utilisant Angular 2. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, je vais d√©montrer ce qui pr√©c√®de √† l'√©cran en utilisant un enregistrement pr√©-fait, vous n'avez donc pas √† attendre. Nous d√©ploierons une application simple sur Go. Ne vous inqui√©tez pas, si vous n'avez jamais rencontr√© Go auparavant, il s'agit d'une application tr√®s simple, vous devez donc tout comprendre.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ad/rq/ih/adrqihjjsirswywycn8zcm_ypsy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous cr√©ons un serveur HTTP qui ne r√©pond qu'√† / health, donc cette application ne v√©rifie que le bilan de sant√© et rien d'autre. Si la v√©rification r√©ussit, la structure JSON illustr√©e ci-dessous est invoqu√©e. Il contient la version de l'application qui sera d√©ploy√©e par le d√©ployeur, le message que vous voyez en haut du fichier et le type de donn√©es logique bool√©en - que notre application fonctionne ou non. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai un peu trich√© avec la derni√®re ligne, car j'ai plac√© une valeur bool√©enne fixe en haut du fichier, ce qui m'aidera √† l'avenir √† d√©ployer m√™me une application ¬´malsaine¬ª. Nous y reviendrons plus tard.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, commen√ßons. Tout d'abord, nous v√©rifions les pods en cours d'ex√©cution √† l'aide de la commande ~ kubectl get pods, et s'il n'y a pas de r√©ponse de l'URL frontend, nous nous assurons qu'aucun d√©ploiement n'est en cours. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qa/vs/kx/qavskxpsjbdy93vis6wd4xp6tas.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, √† l'√©cran, vous voyez l'interface Deploymentctl que j'ai mentionn√©e, dans laquelle les param√®tres de d√©ploiement sont d√©finis: espace de noms, nom d'application, version de d√©ploiement, nombre de r√©pliques, URL frontale, nom du conteneur, image, limites de ressources, num√©ro de port pour v√©rifier le contr√¥le de sant√©, etc. . Les limites de ressources sont tr√®s importantes, car elles vous permettent d'utiliser la quantit√© maximale possible de "fer". Vous pouvez √©galement voir le journal de d√©ploiement du journal de d√©ploiement ici.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/g_/fk/wb/g_fkwbqrgrbuaii4xmoqhmds3lu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous r√©p√©tez la commande ~ kubectl get pods maintenant, vous pouvez voir que le syst√®me "se bloque" pendant 20 secondes, pendant lesquelles la reconfiguration ha-proxy se produit. Apr√®s cela, il d√©marre sous et notre r√©plique peut √™tre vue dans le journal de d√©ploiement. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vm/eb/kb/vmebkbw-zpzs2yjjex70jyiz2gg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai coup√© une attente de 20 secondes dans la vid√©o, et maintenant vous voyez √† l'√©cran que la premi√®re version de l'application est d√©ploy√©e. Tout cela n'a √©t√© fait qu'avec l'aide de l'interface utilisateur. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bt/nw/dq/btnwdq4bpxvs3xloqvdfo01nwla.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayons maintenant la deuxi√®me version. Pour ce faire, je modifie le message de l'application par "Bonjour, Kubernetes!" √† "Bonjour, Deployer!", le syst√®me cr√©e cette image et la place dans le registre Docker, apr√®s quoi nous cliquons simplement sur le bouton "D√©ployer" dans la fen√™tre Deploymentctl. Dans ce cas, le journal de d√©ploiement est automatiquement lanc√© de la m√™me mani√®re que lors du d√©ploiement de la premi√®re version de l'application.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7f/fb/hx/7ffbhx4jbq_bwxyxskyfbhqg0cy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La commande ~ kubectl get pods montre que 2 versions de l'application sont en cours d'ex√©cution, mais le front-end montre que nous ex√©cutons toujours la version 1. L' </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gu/xz/xg/guxzxgf4t6g8xxruexeuptcebze.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√©quilibreur de charge attend jusqu'√† ce que le contr√¥le d'int√©grit√© soit effectu√©, puis redirige le trafic vers la nouvelle version. Apr√®s 20 secondes, nous passons en curl et constatons que nous avons maintenant d√©ploy√© la version 2 de l'application et que la premi√®re est supprim√©e. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/cq/jp/0k/cqjp0kwmkhlufezt-hzs-80fezq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'√©tait le d√©ploiement d'une application ¬´saine¬ª - saine -. Voyons ce qui se passe si, pour la nouvelle version de l'application, je change la valeur du param√®tre Healthy de true en false, c'est-√†-dire que j'essaierai de d√©ployer une application malsaine qui n'a pas pass√© le bilan de sant√©. Cela peut se produire si, au stade du d√©veloppement, des erreurs de configuration ont √©t√© commises dans l'application et qu'elles sont entr√©es en production sous cette forme.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, le d√©ploiement passe par toutes les √©tapes ci-dessus, et ~ kubectl get pods montre que les deux pods sont en cours d'ex√©cution. Mais contrairement au d√©ploiement pr√©c√©dent, le journal affiche l'√©tat du d√©lai d'expiration. Autrement dit, en raison du fait que le bilan de sant√© n'a pas r√©ussi, la nouvelle version de l'application ne peut pas √™tre d√©ploy√©e. Par cons√©quent, vous voyez que le syst√®me a recommenc√© √† utiliser l'ancienne version de l'application et que la nouvelle version a simplement √©t√© supprim√©e.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/iv/qz/kqivqzsf3ghxznqksadtfobhzfm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La bonne chose √† ce sujet est que m√™me si vous avez un grand nombre de demandes simultan√©es entrant dans l'application, elles ne remarqueront m√™me pas les temps d'arr√™t pendant la mise en ≈ìuvre de la proc√©dure de d√©ploiement. Si vous testez cette application √† l'aide du framework Gatling, qui lui envoie le nombre maximal de requ√™tes possible, aucune de ces requ√™tes ne sera supprim√©e. Cela signifie que nos utilisateurs ne remarqueront m√™me pas les mises √† jour de version en temps r√©el. S'il √©choue, le travail se poursuivra sur l'ancienne version; s'il r√©ussit, les utilisateurs passeront √† la nouvelle version.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une seule chose peut entra√Æner un √©chec: si le contr√¥le d'int√©grit√© a r√©ussi et que l'application s'est bloqu√©e d√®s qu'elle a re√ßu la charge de travail, c'est-√†-dire que l'effondrement ne se produit qu'une fois le d√©ploiement termin√©. Dans ce cas, vous devrez revenir manuellement √† l'ancienne version. Nous avons donc examin√© comment utiliser Kubernetes avec ses outils open-source. Le processus de d√©ploiement sera beaucoup plus simple si vous int√©grez ces outils dans les pipelines de cr√©ation / d√©ploiement de pipelines Build / Deploy. Dans le m√™me temps, pour d√©marrer le d√©ploiement, vous pouvez utiliser √† la fois l'interface utilisateur et automatiser enti√®rement ce processus, en appliquant, par exemple, la validation au ma√Ætre.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/4w/s6/xp4ws6tpk0katzykjamtvd1tuz8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre serveur de build Build Server cr√©era une image Docker, la collera dans le Docker Hub ou dans tout autre registre que vous utilisez. Le hub Docker prend en charge le webhook, nous pouvons donc d√©marrer le d√©ploiement √† distance via Deployer, comme indiqu√© ci-dessus. Ainsi, vous pouvez enti√®rement automatiser le d√©ploiement de l'application en production potentielle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons au sujet suivant - la mise √† l'√©chelle du cluster Kubernetes. Je note que la commande kubectl est une commande de mise √† l'√©chelle. Avec l'aide d'un autre, vous pouvez facilement augmenter le nombre de r√©pliques dans notre cluster. Cependant, dans la pratique, nous voulons g√©n√©ralement augmenter le nombre de n≈ìuds, pas de n≈ìuds.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gh/za/t9/ghzat9sqpdai1jdgg3wabhrfeka.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le m√™me temps, pendant les heures de travail, vous devrez peut-√™tre augmenter, et la nuit, pour r√©duire le co√ªt des services Amazon, diminuer le nombre d'instances en cours d'ex√©cution de l'application. Cela ne signifie pas que seul le nombre de pods sera suffisamment √©volutif, car m√™me si l'un des n≈ìuds n'est pas occup√©, vous devez toujours payer Amazon pour cela. Autrement dit, en plus de faire √©voluer les foyers, vous devez mettre √† l'√©chelle le nombre de machines utilis√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cela peut √™tre d√©licat car, que nous utilisions Amazon ou un autre service cloud, Kubernetes ne sait rien du nombre de machines utilis√©es. Il manque un outil qui vous permet de faire √©voluer le syst√®me au niveau des n≈ìuds.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/h8/6d/js/h86djs8fjx9qwpqos9lwpoknxno.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous devrons donc prendre soin des n≈ìuds et des pods. Nous pouvons facilement adapter le lancement de nouveaux n≈ìuds √† l'aide de l'API AWS et des machines de groupe de mise √† l'√©chelle pour configurer le nombre de n≈ìuds de travail Kubernetes. Vous pouvez √©galement utiliser cloud-init ou un script similaire pour enregistrer des n≈ìuds dans un cluster Kubernetes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La nouvelle machine d√©marre dans le groupe de mise √† l'√©chelle, s'initie en tant que n≈ìud, s'inscrit dans le registre de l'assistant et d√©marre le travail. Apr√®s cela, vous pouvez augmenter le nombre de r√©pliques √† utiliser sur les n≈ìuds r√©sultants. La r√©duction de l'√©chelle n√©cessite plus d'efforts, car vous devez vous assurer qu'une telle √©tape n'entra√Ænera pas la destruction des applications d√©j√† en cours d'ex√©cution apr√®s l'arr√™t des machines "inutiles". Pour √©viter ce sc√©nario, vous devez amener les n≈ìuds √† l'√©tat ¬´non programmable¬ª. Cela signifie que le planificateur par d√©faut lors de la planification des pods DaemonSet ignorera ces n≈ìuds. Le planificateur ne supprimera rien de ces serveurs, mais il n'y lancera √©galement aucun nouveau conteneur. L'√©tape suivante consiste √† d√©placer le n≈ìud de vidange, c'est-√†-dire √† transf√©rer les foyers de travail de celui-ci vers une autre machine, ou d'autres n≈ìuds qui ont une capacit√© suffisante pour cela.Apr√®s avoir v√©rifi√© qu'il n'y a plus de conteneurs sur ces n≈ìuds, vous pouvez les supprimer de Kubernetes. Apr√®s cela, pour Kubernetes, ils cessent simplement d'exister. Ensuite, vous devez utiliser l'API AWS pour d√©sactiver les n≈ìuds ou machines inutiles.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez utiliser Amdatu Scalerd, un autre outil de mise √† l'√©chelle open-source similaire √† l'API AWS. Il fournit une CLI pour ajouter ou supprimer des n≈ìuds dans un cluster. Sa fonctionnalit√© int√©ressante est la possibilit√© de configurer le planificateur √† l'aide du fichier json suivant. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/0b/8z/e1/0b8ze13eeahulvu7j2cbuu2m8fe.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code affich√© r√©duit de moiti√© la capacit√© du cluster la nuit. Il est configur√© comme le nombre de r√©plicas disponibles et la capacit√© souhait√©e du cluster Amazon. L'utilisation de ce planificateur r√©duira automatiquement le nombre de n≈ìuds la nuit et les augmentera le matin, √©conomisant ainsi le co√ªt d'utilisation des n≈ìuds d'un service cloud comme Amazon. Cette fonctionnalit√© n'est pas int√©gr√©e √† Kubernetes, mais l'utilisation de Scalerd vous permettra de faire √©voluer cette plateforme √† votre guise.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je veux attirer votre attention sur le fait que beaucoup de gens me disent: "Tout cela est bien, mais qu'en est-il de ma base de donn√©es, qui est g√©n√©ralement dans un √©tat statique?" Comment puis-je ex√©cuter quelque chose comme √ßa dans un environnement dynamique comme Kubernetes? √Ä mon avis, vous ne devriez pas faire cela, ne devriez pas essayer d'organiser le fonctionnement de l'entrep√¥t de donn√©es √† Kubernetes. Techniquement, c'est possible, et il existe des manuels sur Internet √† ce sujet, mais cela va s√©rieusement compliquer votre vie.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oui, le concept de stockage persistant existe dans Kubernetes, et vous pouvez essayer d'ex√©cuter des entrep√¥ts de donn√©es tels que Mongo ou MySQL, mais c'est une t√¢che assez longue. Cela est d√ª au fait que les entrep√¥ts de donn√©es ne prennent pas pleinement en charge l'interaction avec un environnement dynamique. La plupart des bases de donn√©es n√©cessitent un r√©glage important, y compris la configuration manuelle du cluster, n'aiment pas la mise √† l'√©chelle automatique et d'autres choses similaires. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par cons√©quent, ne compliquez pas votre vie lorsque vous essayez de d√©marrer un entrep√¥t de donn√©es dans Kubernetes. Organisez leur travail de mani√®re traditionnelle en utilisant des services familiers et donnez simplement √† Kubernetes la possibilit√© de les utiliser.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jt/ae/w4/jtaew4lftz8i845qgy8pa6bculm.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la fin du sujet, je veux vous pr√©senter la plate-forme Cloud RTI bas√©e sur Kubernetes, sur laquelle mon √©quipe travaille. Il fournit une journalisation centralis√©e, surveille les applications et les clusters, et poss√®de de nombreuses autres fonctionnalit√©s utiles qui vous sont utiles. Il utilise divers outils open source tels que Grafana pour afficher la surveillance.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/oo/uj/mz/ooujmzx3ukdhlcqyxxwqszgelts.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/ec/cd/5j/eccd5j4rch3uhdrqey516jdxnva.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La question a √©t√© pos√©e, pourquoi utiliser l'√©quilibreur de charge ha-proxy avec Kubernetes. Bonne question, car il existe actuellement 2 niveaux d'√©quilibrage de charge. Les services Kubernetes sont toujours situ√©s sur des adresses IP virtuelles. Vous ne pouvez pas les utiliser pour les ports h√¥tes externes, car si Amazon red√©marre son h√¥te cloud, l'adresse changera. C'est pourquoi nous pla√ßons les services ha-proxy devant les services - pour cr√©er une structure plus statique pour une interaction fluide du trafic avec Kubernetes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre bonne question est de savoir comment puis-je prendre soin de modifier le sch√©ma de la base de donn√©es pendant le d√©ploiement bleu / vert? </font><font style="vertical-align: inherit;">Le fait est que, quelle que soit l'utilisation de Kubernetes, la modification du sch√©ma de la base de donn√©es est une t√¢che complexe. </font><font style="vertical-align: inherit;">Vous devez vous assurer de la compatibilit√© de l'ancien et du nouveau sch√©ma, apr√®s quoi vous pouvez mettre √† jour la base de donn√©es, puis mettre √† jour les applications elles-m√™mes. </font><font style="vertical-align: inherit;">Vous pouvez √©changer √† chaud la base de donn√©es, puis mettre √† niveau les applications. </font><font style="vertical-align: inherit;">Je connais des gens qui ont t√©l√©charg√© un tout nouveau cluster de bases de donn√©es avec un nouveau sch√©ma, c'est une option si vous avez une base de donn√©es sans sch√©ma comme Mongo, mais en tout cas ce n'est pas une t√¢che facile. </font><font style="vertical-align: inherit;">S'il n'y a plus de questions, merci de votre attention!</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/-Ci4vd4rh4M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un peu de publicit√© :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merci de rester avec nous. Aimez-vous nos articles? Vous voulez voir des mat√©riaux plus int√©ressants? Soutenez-nous en passant une commande ou en recommandant √† vos amis </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des VPS bas√©s sur le cloud pour les d√©veloppeurs √† partir de 4,99 $</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analogue unique de serveurs d'entr√©e de gamme que nous avons invent√©s pour vous: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toute la v√©rit√© sur les VPS (KVM) E5-2697 v3 (6 c≈ìurs) 10 Go DDR4 480 Go SSD 1 Gbit / s √† partir de 19 $ ou comment diviser le serveur?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (les options sont disponibles avec RAID1 et RAID10, jusqu'√† 24 c≈ìurs et jusqu'√† 40 Go de DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 fois moins cher au centre de donn√©es Equinix Tier IV √† Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nous avons seulement </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV √† partir de 199 $</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aux Pays-Bas!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - √† partir de 99 $! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En savoir plus sur la</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cr√©ation d'un b√¢timent d'infrastructure. </font><font style="vertical-align: inherit;">classe c utilisant des serveurs Dell R730xd E5-2650 v4 co√ªtant 9 000 euros pour un sou?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr504660/index.html">Princess Frog 2.0 alias Pelophylax ridibundus</a></li>
<li><a href="../fr504662/index.html">Dessiner de la musique: danse du cercueil dans Pure Data</a></li>
<li><a href="../fr504664/index.html">Ajout intelligent de groupes musicaux √† Google Sheets via VK API, Tampermonkey et Telegram bot</a></li>
<li><a href="../fr504668/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 346 (25 - 31 mai)</a></li>
<li><a href="../fr504670/index.html">Examen d'√âtat unifi√© en informatique ou en souffrance</a></li>
<li><a href="../fr504674/index.html">Base pour un grand SPA modulaire sur Laravel + Vue + ElementUI avec g√©n√©rateur CRUD</a></li>
<li><a href="../fr504676/index.html">Ajoutez une pinc√©e de hasard √† votre jeu</a></li>
<li><a href="../fr504678/index.html">ITMO Research_ podcast: comment aborder la synchronisation du contenu AR avec le spectacle √† l'√©chelle de l'ensemble du stade</a></li>
<li><a href="../fr504680/index.html">Pr√©sentation de la biblioth√®que NLP de SpaL</a></li>
<li><a href="../fr504682/index.html">Nostalgia Post: j2me, Gravity Defied, 64kb</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>