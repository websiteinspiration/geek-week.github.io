<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéë ü§úüèæ ü§Ø How we built dynamic reports at SSRS 2014 üòç ‚úä üëáüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We already talked about how we helped one manufacturing company transform the processes of corporate training and personnel development. Employees of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How we built dynamic reports at SSRS 2014</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/487704/"><img src="https://habrastorage.org/webt/_q/hb/qb/_qhbqb8irkmfwui-lrqaktkhe8q.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">already talked about</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> how we helped one manufacturing company transform the processes of corporate training and personnel development. </font><font style="vertical-align: inherit;">Employees of the customer, who were drowning in paper documents and Excel spreadsheets, received a convenient iPad-application and a web portal. </font><font style="vertical-align: inherit;">One of the most important functions of this product is the creation of dynamic reports by which managers judge the work of employees ‚Äúin the field‚Äù. </font><font style="vertical-align: inherit;">These are huge documents with dozens of fields and average sizes of 3000 * 1600 pixels.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article, we will talk about how to deploy this beauty based on Microsoft SQL Server Reporting Services, why such a backend can be bad friends with the web portal and what tricks will help to establish their relationship. </font><font style="vertical-align: inherit;">The entire business part of the solution has already been described in the previous article, so here we focus on technical issues. </font><font style="vertical-align: inherit;">Let's get started!</font></font><br>
<br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formulation of the problem</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have a portal with which several hundred users work. </font><font style="vertical-align: inherit;">They are arranged in a stepwise hierarchy, where each user has a supervisor of a rank higher. </font><font style="vertical-align: inherit;">This differentiation of rights is necessary so that users can create events with any subordinate employees. </font><font style="vertical-align: inherit;">You can jump over steps, i.e. </font><font style="vertical-align: inherit;">the user can start activity with an employee of any rank lower than himself. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What events are meant here? </font><font style="vertical-align: inherit;">This can be training, support or certification of an employee of a trading company, which the supervisor conducts at a point of sale. </font><font style="vertical-align: inherit;">The result of such an event is a questionnaire filled in on an iPad with employee ratings for professional qualities and skills. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to the questionnaires, you can prepare statistics, for example:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How many events with his subordinates of this kind did Vasya Ivanov create in a month? </font><font style="vertical-align: inherit;">How many of them are completed?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is the percentage of satisfactory ratings? </font><font style="vertical-align: inherit;">What questions do merchandisers answer the worst? </font><font style="vertical-align: inherit;">Which manager is worse at taking tests?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such statistics are contained in </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reports</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that can be created via the web interface, in XLS, PDF, DOCX formats, and printed. </font><font style="vertical-align: inherit;">All these functions are designed for managers at different levels. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The content and design of the reports are defined in the </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">templates</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , allowing you to set the necessary parameters. </font><font style="vertical-align: inherit;">If in future users will need new types of reports, the system has the ability to create templates, specify modifiable parameters and add a template to the portal. </font><font style="vertical-align: inherit;">All this - without interfering with the source code and work processes of the product.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Specifications and Limitations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The portal runs on a microservice architecture, the front is written in Angular 5. The resource uses JWT authorization, supports Google Chrome, Firefox, Microsoft Edge and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IE 11</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> browsers </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All data is stored on MS SQL Server 2014. SQL Server Reporting Services (SSRS) is installed on the server, the customer uses it and is not going to refuse. </font><font style="vertical-align: inherit;">Hence the most important limitation: access to SSRS is closed from the outside, so you can access the web interface and SOAP only from the local network through NTLM authorization.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A few words about SSRS</font></font></b><div class="spoiler_text"><b>SSRS </b>‚Äì    ,        ,     .     docs.microsoft.com,  SSRS        (API)    ( Report Server,  -    HTTP). <br>
</div></div><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attention, the question: how to complete the task without manual methods, with minimal resources and maximum benefits for the customer? </font></font></b></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the customer has SSRS on a dedicated server, let SSRS do all the dirty work of generating and exporting reports. </font><font style="vertical-align: inherit;">Then we don‚Äôt have to write our own reporting service, export modules to XLS, PDF, DOCX, HTML and the corresponding API. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the task was to make SSRS friends with the portal and ensure the operation of the functions specified in the task. </font><font style="vertical-align: inherit;">So let's go through the list of these scenarios - interesting subtleties were found in almost every point.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution structure</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we already have SSRS, there are all the tools for managing report templates: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Report Server - responsible for the entire logic of working with reports, their storage, generation, management and much more.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Report Manager - a service with a web interface for managing reports. </font><font style="vertical-align: inherit;">Here you can upload templates created in SQL Server Data Tools to the server, configure access rights, data sources and parameters (including those that can be changed when reporting requests). </font><font style="vertical-align: inherit;">He is able to generate reports on downloaded templates and upload them to various formats, including XLS, PDF, DOCX and HTML.</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Total:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> we create templates in SQL Server Data Tools, with the help of Report Manager we fill them on Report Server, we configure - and it is ready. </font><font style="vertical-align: inherit;">We can generate reports, change their parameters. </font></font><br>
<br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next question: how to request the generation of reports on specific templates through the portal and get the result to the front for output to the UI or download in the desired format?</font></font></i></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reporting from SSRS to the portal</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As we said above, SSRS has its own API to access reports. But we do not want to give its functions out for security and digital hygiene reasons - we only need to request data from SSRS in the right form and transmit the result to the user. Report management will be handled by specially trained customer staff. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since access to SSRS is only from the local network, the data exchange between the server and the portal is through a proxy service. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/kz/f5/9x/kzf59xp7_ltztohtag_orirmn5i.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exchange of data between the portal and the server</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Let's see how it works and why ReportProxy is here. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, on the portal side, we have a ReportService, which the portal accesses for reports. The service checks the authorization of the user, the level of his rights, converts data from SSRS into the desired form under the contract.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ReportService API contains only 2 methods, which are quite enough for us:</font></font><br>
<br>
<ol>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetReports</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - provides the identifiers and names of all templates that the current user can receive;</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetReportData (format, params)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - gives ready-made, exported report data in the specified format, with a given set of parameters.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you need these 2 methods to be able to communicate with SSRS and take the necessary data from it in the right form. </font><font style="vertical-align: inherit;">From the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation it is known</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that we can access the report server via HTTP using the SOAP API. </font><font style="vertical-align: inherit;">It seems that the puzzle is developing ... But in fact, a surprise awaits us here. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since SSRS is closed to the outside world and you can reach it only through NTLM authentication, it is not available directly from the SOAP portal. </font><font style="vertical-align: inherit;">There are also our own wishes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Give access only to the required set of functions, and even prohibit the change;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you have to switch to another reporting system, the edits in the ReportService should be minimal, and better not be required at all.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is where ReportProxy helps us, which is located on the same machine as SSRS and is responsible for proxying requests from ReportService to SSRS. </font><font style="vertical-align: inherit;">Request processing is as follows:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the service receives a request from ReportService, checks JWT authorization;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in accordance with the API method, the proxy goes through the SOAP protocol in SSRS for the necessary data, logging in through NTLM along the way;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data received from SSRS is sent back to ReportService in response to the request.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, ReportProxy is an adapter between SSRS and ReportService. </font></font><div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The controller is as follows:</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs">[BasicAuthentication]<font></font>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReportProxyController</span> : <span class="hljs-title">ApiController</span>
</span>{<font></font>
    [HttpGet()]<font></font>
    public List&lt;ReportItem&gt; Get(string rootPath)<font></font>
    {<font></font>
        <span class="hljs-comment">//  ...</span><font></font>
    }<font></font>
<font></font>
    public HttpResponseMessage Post([FromBody]ReportRequest request)<font></font>
    {<font></font>
        <span class="hljs-comment">//  ...</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br>
  BasicAuthentication   :<br>
<br>
<pre><code class="javascript hljs">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicAuthenticationAttribute</span> : <span class="hljs-title">AuthorizationFilterAttribute</span>
</span>{<font></font>
    public override <span class="hljs-keyword">void</span> OnAuthorization(HttpActionContext actionContext)<font></font>
    {<font></font>
        <span class="hljs-keyword">var</span> authHeader = actionContext.Request.Headers.Authorization;<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (authHeader != <span class="hljs-literal">null</span>)<font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> authenticationToken = actionContext.Request.Headers.Authorization.Parameter;
            <span class="hljs-keyword">var</span> tokenFromBase64 = Convert.FromBase64String(authenticationToken);
            <span class="hljs-keyword">var</span> decodedAuthenticationToken = Encoding.UTF8.GetString(tokenFromBase64);
            <span class="hljs-keyword">var</span> usernamePasswordArray = decodedAuthenticationToken.Split(<span class="hljs-string">':'</span>);
            <span class="hljs-keyword">var</span> userName = usernamePasswordArray[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">var</span> password = usernamePasswordArray[<span class="hljs-number">1</span>];<font></font>
<font></font>
            <span class="hljs-keyword">var</span> isValid = userName == BasiAuthConf.Login &amp;&amp; password == BasiAuthConf.Password;<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (isValid)<font></font>
            {<font></font>
                <span class="hljs-keyword">var</span> principal = <span class="hljs-keyword">new</span> GenericPrincipal(<span class="hljs-keyword">new</span> GenericIdentity(userName), <span class="hljs-literal">null</span>);<font></font>
                Thread.CurrentPrincipal = principal;<font></font>
<font></font>
                <span class="hljs-keyword">return</span>;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        HandleUnathorized(actionContext);<font></font>
    }<font></font>
<font></font>
    private <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> HandleUnathorized(HttpActionContext actionContext)<font></font>
    {<font></font>
        actionContext.Response = actionContext.Request.CreateResponse(<font></font>
            HttpStatusCode.Unauthorized<font></font>
        );<font></font>
<font></font>
        actionContext.Response.Headers.Add(<font></font>
            <span class="hljs-string">"WWW-Authenticate"</span>, <span class="hljs-string">"Basic Scheme='Data' location = 'http://localhost:"</span><font></font>
        );<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the process looks like this:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The front sends an http request to ReportService;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReportService sends an http request to ReportProxy;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReportProxy through the SOAP interface receives data from SSRS and sends the result to ReportService;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReportService brings the result in accordance with the contract and gives it to the client.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We got a working system that requests a list of available templates, goes to SSRS for reports, and gives them to the front in any supported formats. </font><font style="vertical-align: inherit;">Now you need to display the generated reports on the front in accordance with the specified parameters, give the opportunity to upload them to XLS, PDF, DOCX files and print. </font><font style="vertical-align: inherit;">Let's start with the display.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Working with SSRS Reports in the Portal</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first glance, it‚Äôs an everyday matter - the report comes in HTML-format, so we can do whatever we want with it! </font><font style="vertical-align: inherit;">We‚Äôll embed it in the page, tint it with design styles, and the thing is in the hat. </font><font style="vertical-align: inherit;">In fact, it turned out that there were enough pitfalls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to the design concept, the section of reports on the portal should consist of two pages: </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) a list of templates where we can:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View statistics on activities for the entire portal;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">see all the templates available to us;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">click on the desired template and go to the corresponding report generator.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/yx/tp/1h/yxtp1h3tvvpujymptptca2gcyew.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) a report generator that allows us to:</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">set template parameters and create a report on them;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">view what happened as a result;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select the output file format, download it;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">print the report in a convenient and visual form.</font></font></li>
</ul><br>
 <img src="https://habrastorage.org/webt/au/ct/2f/auct2fiklpvvfad6vpbovv0xat0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were no special problems with the first page, so we will not consider it further. </font><font style="vertical-align: inherit;">And the report generator forced us to turn on the engineer, so that it would be convenient for real people to use all the functions on TK.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem number 1. </font><font style="vertical-align: inherit;">Giant tables</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to the design concept, this page should have a viewing area so that the user can see his report before exporting. If the report does not fit into the window, you can scroll horizontally and vertically. At the same time, a typical report can reach sizes of several screens, which means we need sticking blocks with the names of rows and columns. Without this, users will have to constantly return to the top of the table to remember what a particular cell means. Or in general it will be easier to print a report and constantly keep the necessary leaves in front of your eyes, but then the table on the screen simply loses its meaning. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, sticking blocks cannot be avoided. And SSRS 2014 does not know how to fix rows and columns in an MHTML document - only in its own web interface.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we recall that modern browsers support the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSS sticky property</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which just provides the function we need. We put position: sticky on the marked block, specify the indent on the left or on the top (left, top properties), and the block will remain in place during horizontal and vertical scrolling. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You need to find a parameter that CSS can catch on to. Native cell values ‚Äã‚Äãthat allow SSRS 2014 to capture them in the web interface are lost when exporting to HTML. OK, we will mark them ourselves - we would only understand how.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After several hours of reading documentation and discussions with colleagues, it seemed that there were no options. And here, by all laws of the plot, the ToolTip field turned up for us, which allows us to specify tooltips for cells. It turned out that it is thrown into the exported HTML code in the tooltip attribute - exactly on the tag that belongs to the custom cell in SQL Server Data Tools. There was no choice - we did not find another way to mark cells for fixation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, you need to build marking rules and forward markers in HTML via ToolTip. Then, using JS, we change the tooltip attribute to the CSS class at the specified marker.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are only two ways to fix cells: vertically (fixed-column) and horizontally (fixed-row). </font><font style="vertical-align: inherit;">It makes sense to put another marker on the corner cells, which remain in place when scrolling in both directions - fixed-both. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to do the UI. </font><font style="vertical-align: inherit;">When you receive an HTML document, you need to find all the HTML elements with markers in it, recognize the values, set the appropriate CSS class and remove the tooltip attribute so that it does not come out when you hover over it. </font><font style="vertical-align: inherit;">It should be noted that the resulting markup consists of nested tables (table tags).</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View code</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs">type FixationType = <span class="hljs-string">'row'</span> | <span class="hljs-string">'column'</span> | <span class="hljs-string">'both'</span>;<font></font>
<font></font>
init(reportHTML: HTMLElement) {<font></font>
    <span class="hljs-comment">//    </span><font></font>
<font></font>
    <span class="hljs-comment">// -  </span>
    <span class="hljs-keyword">const</span> rowsFixed: NodeList = reportHTML.querySelectorAll(<span class="hljs-string">'[title^="RowFixed"]'</span>);
    <span class="hljs-comment">// -  </span>
    <span class="hljs-keyword">const</span> columnFixed: NodeList = reportHTML.querySelectorAll(<span class="hljs-string">'[title^="ColumnFixed"]'</span>);
    <span class="hljs-comment">// -    </span>
    <span class="hljs-keyword">const</span> bothFixed: NodeList = reportHTML.querySelectorAll(<span class="hljs-string">'[title^="BothFixed"]'</span>);<font></font>
<font></font>
    <span class="hljs-keyword">this</span>.prepare(rowsFixed, <span class="hljs-string">'row'</span>);
    <span class="hljs-keyword">this</span>.prepare(columnFixed, <span class="hljs-string">'column'</span>);
    <span class="hljs-keyword">this</span>.prepare(bothFixed, <span class="hljs-string">'both'</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">//    </span>
prepare(nodeList: NodeList, <span class="hljs-attr">fixingType</span>: FixationType) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; nodeList.length; i++) {
        <span class="hljs-keyword">const</span> element: HTMLElement = nodeList[i];
        <span class="hljs-comment">//   -</span>
        element.classList.add(fixingType + <span class="hljs-string">'-fixed'</span>);<font></font>
<font></font>
        element.removeAttribute(<span class="hljs-string">'title'</span>);<font></font>
        element.removeAttribute(<span class="hljs-string">'alt'</span>); <span class="hljs-comment">//   SSRS</span><font></font>
<font></font>
        element.parentElement.classList.add(fixingType  + <span class="hljs-string">'-fixed-parent'</span>);<font></font>
<font></font>
        <span class="hljs-comment">//     ,     </span>
        element.style.width = element.getBoundingClientRect().width  + <span class="hljs-string">'px'</span>;
        <span class="hljs-comment">//     ,     </span>
        element.style.height = element.getBoundingClientRect().height  + <span class="hljs-string">'px'</span>;<font></font>
<font></font>
        <span class="hljs-comment">//  </span>
        <span class="hljs-keyword">this</span>.calculateCellCascadeParams(element, fixingType);<font></font>
    }<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is a new problem: with cascading behavior, when several blocks moving in one direction are fixed at once in the table, the cells going one after another will be layered. </font><font style="vertical-align: inherit;">At the same time, it is not clear how much each next block should retreat - the indents will have to be calculated via JavaScript based on the height of the block in front of it. </font><font style="vertical-align: inherit;">All this applies to both vertical and horizontal anchors.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The correction script solved the problem.</font></font></b><div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-comment">//      </span>
calculateCellCascadeParams(cell: HTMLElement, <span class="hljs-attr">fixationType</span>: FixationType) {
    <span class="hljs-keyword">const</span> currentTD: HTMLTableCellElement = cell.parentElement;
    <span class="hljs-keyword">const</span> currentCellIndex = currentTD.cellIndex;<font></font>
<font></font>
    <span class="hljs-comment">//   </span>
    currentTD.style.left = <span class="hljs-string">''</span>;<font></font>
    currentTD.style.top = <span class="hljs-string">''</span>;<font></font>
<font></font>
    <span class="hljs-keyword">const</span> currentTDStyles = getComputedStyle(currentTD);<font></font>
<font></font>
    <span class="hljs-comment">//  </span>
    <span class="hljs-keyword">if</span> (fixationType === <span class="hljs-string">'row'</span> || fixationType === <span class="hljs-string">'both'</span>) {
        <span class="hljs-keyword">const</span> parentRow: HTMLTableRowElement = currentTD.parentElement;<font></font>
<font></font>
        <span class="hljs-comment">//        </span>
        <span class="hljs-comment">//    .</span>
        <span class="hljs-comment">//   ,    .</span>
        <span class="hljs-keyword">let</span> previousRow: HTMLTableRowElement = parentRow;
        <span class="hljs-keyword">let</span> topOffset = <span class="hljs-number">0</span>;<font></font>
<font></font>
        <span class="hljs-keyword">while</span> (previousRow = previousRow.previousElementSibling) {
            <span class="hljs-keyword">let</span> previousCellIndex = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">let</span> cellIndexBulk = <span class="hljs-number">0</span>;<font></font>
<font></font>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; previousRow.cells.length; i++) {
                <span class="hljs-keyword">if</span> (previousRow.cells[i].colSpan &gt; <span class="hljs-number">1</span>) {<font></font>
                    cellIndexBulk += previousRow.cells[i].colSpan;<font></font>
                } <span class="hljs-keyword">else</span> {<font></font>
                    cellIndexBulk += <span class="hljs-number">1</span>;<font></font>
                }<font></font>
<font></font>
                <span class="hljs-keyword">if</span> ((cellIndexBulk - <span class="hljs-number">1</span>) &gt;= currentCellIndex) {<font></font>
                    previousCellIndex = i;<font></font>
                    <span class="hljs-keyword">break</span>;<font></font>
                }<font></font>
            }<font></font>
<font></font>
            <span class="hljs-keyword">const</span> previousCell = previousRow.cells[previousCellIndex];<font></font>
<font></font>
            <span class="hljs-keyword">if</span> (previousCell.classList.contains(fixationType + <span class="hljs-string">'_fixed_parent'</span>)) {<font></font>
                topOffset += previousCell.getBoundingClientRect().height;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">if</span> (topOffset &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span> (currentTDStyles.top) {<font></font>
                topOffset += &lt;any&gt;currentTDStyles.top.replace('px', '') - 0;<font></font>
            }<font></font>
<font></font>
            currentTD.style.top = topOffset + 'px';<font></font>
        }<font></font>
    }<font></font>
<font></font>
    //  <font></font>
    if (fixationType === 'column' || fixationType === 'both') {<font></font>
        //       <font></font>
        //     .<font></font>
        //   ,    .<font></font>
        let previousCell: HTMLTableCellElement = currentTD;<font></font>
        let leftOffset = 0;<font></font>
<font></font>
        while (previousCell = previousCell.previousElementSibling) {<font></font>
            if (previousCell.classList.contains(fixationType + '_fixed_parent')) {<font></font>
                leftOffset += previousCell.getBoundingClientRect().width;<font></font>
            }<font></font>
        }<font></font>
<font></font>
        if (leftOffset &gt; 0) {<font></font>
            if (currentTDStyles.left) {<font></font>
                leftOffset += &lt;any&gt;currentTDStyles.left.replace('px', '') - 0;<font></font>
            }<font></font>
<font></font>
            currentTD.style.left = leftOffset + 'px';<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The code checks the tags of marked elements and adds the parameters of the fixed cells to the indent value. </font><font style="vertical-align: inherit;">In the case of adherent rows, their height is added up, for columns, their width. </font></font><br>
 <br>
<img src="https://habrastorage.org/webt/vj/ix/bf/vjixbfnbewh6_pb3smfcogdpevc.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of a report with a sticky top line.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As a result, the process looks like this:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We get the markup from SSRS and paste it in the right place in the DOM;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recognize markers;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adjust the parameters for cascading behavior.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the sticking behavior is fully implemented through CSS, and JS is involved only in the preparation of the incoming document, the solution works quickly enough and without lags. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unfortunately, for IE, sticking blocks had to be disabled because </font><font style="vertical-align: inherit;">it does not support the position: sticky property. </font><font style="vertical-align: inherit;">The rest - Safari, Mozilla Firefox and Chrome - do an excellent job. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Move on.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem number 2. </font><font style="vertical-align: inherit;">Report Export</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To pull a report out of the system, you must (1) access the SSRS via ReportService for a Blob object, (2) get a link to the object via the interface using the window.URL.createObjectURL method, (3) put the link in the tag and simulate a click for file upload. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This works in Firefox, Safari and in all versions of Chrome except Apple. So that IE, Edge and Chrome for iOS also supported the function, I had to throw my brains back.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In IE and Edge, the event simply will not trigger a browser request to download the file. These browsers have such a feature that in order to simulate a click, confirmation of the user to download is required, as well as a clear indication of further actions. The solution was found in the window.navigator.msSaveOrOpenBlob () method, which is available in both IE and Edge. He just knows how to ask the user's permission for the operation and clarify what to do next. So, we determine whether the window.navigator.msSaveOrOpenBlob method exists, and act on the situation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chrome on iOS didn‚Äôt have such a hack, and instead of a report, we got just a blank page. </font><font style="vertical-align: inherit;">Wandering around the Web, we found a similar story, judging by which in iOS 13 this bug should have been fixed. </font><font style="vertical-align: inherit;">Unfortunately, we wrote the application back in the days of iOS 12, so in the end we decided not to waste any more time and simply turned off the button in Chrome for iOS. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now about what the final export process to UI looks like. </font><font style="vertical-align: inherit;">There is a button in the Angular report component that launches a chain of steps:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">through the event parameters, the handler receives the identifier of the export format (for example, ‚ÄúPDF‚Äù);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sends a request to ReportService to receive a Blob-object for the specified format;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">checks if the browser is IE or Edge;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">when the answer comes from ReportService:</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if it is IE or Edge, it calls window.navigator.msSaveOrOpenBlob (fileStream, fileName);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otherwise, it calls the this.exportDownload (fileStream, fileName) method, where fileStream is the Blob obtained from the request to ReportService, and fileName is the name of the file to save. </font><font style="vertical-align: inherit;">The method creates a hidden tag with a link to window.URL.createObjectURL (fileStream), simulates a click and removes the tag.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this sorted out, the last adventure remained.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem number 3. </font><font style="vertical-align: inherit;">Printout</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we can see the report on the portal and export it to XLS, PDF, DOCX formats. </font><font style="vertical-align: inherit;">It remains to implement the printing of the document in order to get an accurate multi-page report. </font><font style="vertical-align: inherit;">If the table turned out to be divided into pages, each of them should contain headings - the same sticky blocks that we talked about in the section before last. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The easiest option is to take the current page with the displayed report, hide everything superfluous using CSS and send it to print using the window.print () method. </font><font style="vertical-align: inherit;">This method does not work immediately for several reasons:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non-standard viewing area - the report itself is contained in a separately scrollable area so that the page does not stretch to incredible horizontal dimensions. </font><font style="vertical-align: inherit;">Using window.print () trims content that does not fit the screen;</font></font></li>
<li>   ,      ;</li>
<li>     ,       .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All this can be fixed using JS and CSS, but we decided to save developers time and look for an alternative to window.print (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SSRS can immediately give us a ready-made PDF with a presentable pagination. This saves us from all the difficulties of the previous version, the only question is, can we print the PDF through a browser? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Because PDF is a third-party standard, browsers support it through various viewer plugins. No plug-in - no cartoons, so again we need an alternative option. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And if you put the PDF on the page as an image, and send this page to print? There are already libraries and components for Angular that provide such rendering. Searched, experimented, implemented.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order not to deal with the data that we do not want to print, it was decided to transfer the rendered content to a new page, and there already execute window.print (). </font><font style="vertical-align: inherit;">As a result, the whole process is as follows:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Request ReportService to export the report in PDF format;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We get the Blob-object, convert it to a URL (URL.createObjectURL (fileStream)), give the URL to the PDF viewer for rendering;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We take images from the PDF viewer;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open a new page and add a little markup there (title, a little indentation);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add the image from the PDF viewer to the markup, call window.print ().</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After several checks, a JS code also appeared on the page, which, before printing, checks that all images have loaded. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the entire appearance of the document is determined by the parameters of the SSRS template, and the UI does not interfere with this process. </font><font style="vertical-align: inherit;">This reduces the number of possible bugs. </font><font style="vertical-align: inherit;">Since images are being transferred for printing, we are insured against any damage or deformation of the layout. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are also disadvantages:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a large report will weigh a lot, which will adversely affect mobile platforms;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the design does not update automatically - colors, fonts and other design elements need to be installed at the template level.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In our case, the frequent addition of new templates was not expected, so the solution was acceptable. </font><font style="vertical-align: inherit;">Mobile performance has been taken for granted.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The last word</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is how a regular project once again makes us look for simple solutions for non-trivial tasks. </font><font style="vertical-align: inherit;">The final product fully meets the design requirements and looks beautiful. </font><font style="vertical-align: inherit;">And most importantly, although we did not have to look for the most obvious implementation methods, the task was completed faster than if we took on the original report module with all the consequences. </font><font style="vertical-align: inherit;">And in the end, we were able to focus on the business goals of the project.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487690/index.html">PHP Digest No. 173 (January 27 - February 10, 2020)</a></li>
<li><a href="../en487694/index.html">How Yandex.Cloud is hosted by Virtual Private Cloud and how our users help us implement useful features</a></li>
<li><a href="../en487696/index.html">Digital events in Moscow from February 10 to 16</a></li>
<li><a href="../en487698/index.html">Digital events in St. Petersburg from February 10 to 16</a></li>
<li><a href="../en487702/index.html">A selection of articles on machine learning: case studies, guides and research for January 2020</a></li>
<li><a href="../en487706/index.html">Service Discovery in distributed systems using the Consul example. Alexander Sigachev</a></li>
<li><a href="../en487716/index.html">Perfect SAST. Parser</a></li>
<li><a href="../en487720/index.html">On competitive corutinism (using reactive programming as an example)</a></li>
<li><a href="../en487724/index.html">BlazingPizza: Blazor app from start to finish. Part 2. Add a component</a></li>
<li><a href="../en487728/index.html">@Pythonetc compilation, January 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>