<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äçüöí üëàüèª ‚öõÔ∏è Int√©gration d'API Aviasales avec Amazon Kinesis et simplicit√© sans serveur ‚õìÔ∏è üà¥ üëÉüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 
 
 Aimez-vous piloter des avions? J'adore √ßa, mais sur l'auto-isolement, j'ai aussi aim√© analyser les donn√©es sur les billets d'avion ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Int√©gration d'API Aviasales avec Amazon Kinesis et simplicit√© sans serveur</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500382/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aimez-vous piloter des avions? </font><font style="vertical-align: inherit;">J'adore √ßa, mais sur l'auto-isolement, j'ai aussi aim√© analyser les donn√©es sur les billets d'avion d'une ressource bien connue - Aviasales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, nous analyserons le travail d'Amazon Kinesis, construirons un syst√®me de streaming avec des analyses en temps r√©el, placerons la base de donn√©es Amazon DynamoDB NoSQL comme entrep√¥t de donn√©es principal et configurerons des alertes SMS pour les tickets int√©ressants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les d√©tails sous la coupe! </font><font style="vertical-align: inherit;">Aller!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/-n/qn/yn/-nqnynmwzv61pmiq2ocatoxseme.jpeg"></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, nous devons avoir acc√®s √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'API Aviasales</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L'acc√®s √† celui-ci est gratuit et sans restriction, il vous suffit de vous inscrire dans la section "D√©veloppeurs" pour obtenir votre token API pour acc√©der aux donn√©es.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'objectif principal de cet article est de donner une compr√©hension g√©n√©rale de l'utilisation des informations de streaming dans AWS, nous faisons en sorte que les donn√©es renvoy√©es par l'API utilis√©e ne soient pas strictement pertinentes et soient transf√©r√©es √† partir du cache, qui est g√©n√©r√© √† partir des recherches des utilisateurs des sites Aviasales.ru et Jetradar.com pour derni√®res 48 heures. </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les donn√©es des billets d'avion de l'agent Kinesis re√ßues via l'API install√©e sur la machine du producteur seront automatiquement analys√©es et transf√©r√©es vers le flux souhait√© via Kinesis Data Analytics. </font><font style="vertical-align: inherit;">Une version non trait√©e de ce flux sera √©crite directement dans le r√©f√©rentiel. </font><font style="vertical-align: inherit;">D√©ploy√© dans le stockage DynamoDB des donn√©es brutes permettra une analyse plus approfondie des tickets via des outils de BI, tels qu'AWS Quick Sight. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous consid√©rerons deux options pour d√©ployer l'ensemble de l'infrastructure:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manuel - via AWS Management Console;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infrastructure √† partir du code Terraform - pour les ing√©nieurs d'automatisation paresseux;</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture du syst√®me en cours de d√©veloppement</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vt/ss/mx/vtssmx0accvfcphkjvmzwdf4udg.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Composants utilis√©s:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API Aviasales</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - les donn√©es renvoy√©es par cette API seront utilis√©es pour tous les travaux ult√©rieurs;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EC2 Producer Instance</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une machine virtuelle ordinaire dans le cloud sur laquelle le flux de donn√©es d'entr√©e sera g√©n√©r√©:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kinesis Agent</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une application Java install√©e localement qui fournit un moyen simple de collecter et d'envoyer des donn√©es √† Kinesis (Kinesis Data Streams ou Kinesis Firehose). </font><font style="vertical-align: inherit;">L'agent surveille en permanence un ensemble de fichiers dans les r√©pertoires sp√©cifi√©s et envoie de nouvelles donn√©es √† Kinesis;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script de l'API de l'appelant</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - un script Python qui fait des demandes d'API et place la r√©ponse dans un dossier surveill√© par l'agent Kinesis;</font></font></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b>Kinesis Data Streams</b></a> ‚Äî            ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b>Kinesis Analytics</b></a> ‚Äî  ,        . Amazon Kinesis Data Analytics              ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b>AWS Lambda</b></a> ‚Äî ,        .        ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b>Amazon DynamoDB</b></a> ‚Äî    ¬´‚Äë¬ª  ,     10      .   DynamoDB    - ,       . DynamoDB   ,        .       ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b>Amazon SNS</b></a> ‚Äî        ¬´ ‚Äî ¬ª (Pub/Sub),      ,     . SNS           push-, SMS-   .</li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formation initiale</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour √©muler le flux de donn√©es, j'ai d√©cid√© d'utiliser les informations sur les billets d'avion renvoy√©es par l'API Aviasales. </font><font style="vertical-align: inherit;">La </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation contient une</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> liste assez compl√®te de diff√©rentes m√©thodes, prenez l'une d'entre elles - le ¬´Calendrier des prix pour le mois¬ª, qui renvoie les prix pour chaque jour du mois, regroup√©s par nombre de transferts. </font><font style="vertical-align: inherit;">Si vous ne transmettez pas le mois de recherche dans la demande, les informations seront retourn√©es pour le mois suivant celui en cours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, inscrivez-vous, obtenez votre jeton. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple de demande ci-dessous:</font></font><br>
<br>
<pre><code class="bash hljs">http://api.travelpayouts.com/v2/prices/month-matrix?currency=rub&amp;origin=LED&amp;destination=HKT&amp;show_to_affiliates=<span class="hljs-literal">true</span>&amp;token=TOKEN_API</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La m√©thode ci-dessus pour recevoir des donn√©es de l'API avec le jeton dans la demande fonctionnera, mais je pr√©f√®re passer le jeton d'acc√®s via l'en-t√™te, nous allons donc utiliser cette m√©thode dans le script api_caller.py. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple de r√©ponse:</font></font><br>
<br>
<pre><code class="json hljs">{{
   <span class="hljs-attr">"success"</span>:<span class="hljs-literal">true</span>,
   <span class="hljs-attr">"data"</span>:[{
      <span class="hljs-attr">"show_to_affiliates"</span>:<span class="hljs-literal">true</span>,
      <span class="hljs-attr">"trip_class"</span>:<span class="hljs-number">0</span>,
      <span class="hljs-attr">"origin"</span>:<span class="hljs-string">"LED"</span>,
      <span class="hljs-attr">"destination"</span>:<span class="hljs-string">"HKT"</span>,
      <span class="hljs-attr">"depart_date"</span>:<span class="hljs-string">"2015-10-01"</span>,
      <span class="hljs-attr">"return_date"</span>:<span class="hljs-string">""</span>,
      <span class="hljs-attr">"number_of_changes"</span>:<span class="hljs-number">1</span>,
      <span class="hljs-attr">"value"</span>:<span class="hljs-number">29127</span>,
      <span class="hljs-attr">"found_at"</span>:<span class="hljs-string">"2015-09-24T00:06:12+04:00"</span>,
      <span class="hljs-attr">"distance"</span>:<span class="hljs-number">8015</span>,
      <span class="hljs-attr">"actual"</span>:<span class="hljs-literal">true</span><font></font>
   }]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exemple de r√©ponse API ci-dessus montre un billet de Saint-P√©tersbourg √† Phuk ... Oh, de quoi r√™ver ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque je viens de Kazan et que Phuket "r√™ve tout simplement de nous" maintenant, nous chercherons des billets de Saint-P√©tersbourg √† Kazan.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est suppos√© que vous disposez d√©j√† d'un compte AWS. </font><font style="vertical-align: inherit;">Je veux tout de suite faire particuli√®rement attention √† ce que Kinesis et l'envoi de notifications par SMS ne soient pas inclus dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">niveau gratuit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> annuel </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">(utilisation gratuite)</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais malgr√© cela, avec quelques dollars en t√™te, il est tout √† fait possible de construire le syst√®me propos√© et de jouer avec. </font><font style="vertical-align: inherit;">Et, bien s√ªr, n'oubliez pas de supprimer toutes les ressources lorsqu'elles deviennent inutiles.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Heureusement, les fonctions DynamoDb et lambda seront des partagiciels pour nous si vous respectez les limites mensuelles gratuites. </font><font style="vertical-align: inherit;">Par exemple, pour DynamoDB: 25 Go de stockage, 25 WCU / RCU et 100 millions de demandes. </font><font style="vertical-align: inherit;">Et un million d'appels aux fonctions lambda par mois.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Syst√®me de d√©ploiement manuel</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration des flux de donn√©es Kinesis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acc√©dez au service Kinesis Data Streams et cr√©ez deux nouveaux flux, un fragment pour chacun.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qu'un √©clat?</font></font></b>
                        <div class="spoiler_text"> ‚Äî       Amazon Kinesis.         1 /       2 /.     1000  PUT  .         . ,       .          2 /       4 /    2000  PUT  .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus il y a d'√©clats dans votre flux, plus son d√©bit est important. </font><font style="vertical-align: inherit;">En principe, les flux sont mis √† l'√©chelle de cette fa√ßon en ajoutant des fragments. </font><font style="vertical-align: inherit;">Mais plus vous avez d'√©clats, plus le prix est √©lev√©. </font><font style="vertical-align: inherit;">Chaque fragment co√ªte 1,5 centime par heure et 1,4 centime suppl√©mentaire pour chaque million d'unit√©s de charge utile PUT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cr√©ez un nouveau thread avec le nom </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flight_tickets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , 1 fragment suffira pour cela:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f8/5p/jg/f85pjg59pxlsbjio2_yzpz1wng4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cr√©ez maintenant un autre flux appel√© </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">special_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4l/_t/eo/4l_teoxvvwv5pablkpfnv-tlnac.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©glage du producteur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En tant que producteur de donn√©es pour analyser une t√¢che, il suffit d'utiliser une instance EC2 standard. </font><font style="vertical-align: inherit;">Il n'est pas n√©cessaire que ce soit une machine virtuelle puissante et co√ªteuse; le spot t2.micro convient parfaitement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque importante: par exemple, vous devez utiliser l'image - Amazon Linux AMI 2018.03.0, avec elle, il y a moins de param√®tres pour lancer rapidement l'agent Kinesis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acc√©dez au service EC2, cr√©ez une nouvelle machine virtuelle, s√©lectionnez l'AMI souhait√©e avec le type t2.micro, qui est inclus dans Free Tier:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3q/rg/gt/3qrggtrxqistnkvgzn0bwkfdvbk.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que la machine virtuelle nouvellement cr√©√©e puisse interagir avec le service Kinesis, vous devez lui en donner le droit. </font><font style="vertical-align: inherit;">La meilleure fa√ßon de proc√©der consiste √† attribuer un r√¥le IAM. </font><font style="vertical-align: inherit;">Par cons√©quent, sur l'√©cran √âtape 3: Configurer les d√©tails de l'instance, s√©lectionnez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©er un nouveau r√¥le IAM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation de r√¥les IAM pour EC2</font></font></b>
                        <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/_p/rm/xv/_prmxvgp0iv148grjwdpunwaela.jpeg"></div><br>
  , ,      EC2     Permissions:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/as/nn/zvasnnl8ootjsr6rojjfhmjtfiw.jpeg"></div><br>
             ,     : AmazonKinesisFullAccess  CloudWatchFullAccess.<br>
<br>
 -     , : EC2-KinesisStreams-FullAccess.  ,     ,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jh/rj/38/jhrj38s8czngu9ri77mu26lh_o0.jpeg"></div><br>
    ,         :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yn/he/23/ynhe23lg4gfpfbjvlphntvfypyw.jpeg"></div><br>
           . <br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez laisser les param√®tres du disque dur par d√©faut, les balises aussi (bien qu'il soit recommand√© d'utiliser des balises, donnez au moins le nom de l'instance et sp√©cifiez l'environnement). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes maintenant sur l'onglet √âtape 6: Configurer le groupe de s√©curit√©, o√π vous devez en cr√©er un nouveau ou sp√©cifier votre groupe de s√©curit√© existant, ce qui vous permet de vous connecter via ssh (port 22) √† l'instance. </font><font style="vertical-align: inherit;">S√©lectionnez Source -&gt; Mon IP l√†-bas et vous pouvez ex√©cuter l'instance.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y7/cd/z9/y7cdz9fllra7haynrf6gyu0jkdq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois qu'il entre en √©tat de fonctionnement, vous pouvez essayer de vous y connecter via ssh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour pouvoir travailler avec Kinesis Agent, apr√®s une connexion r√©ussie √† la machine, vous devez entrer les commandes suivantes dans le terminal:</font></font><br>
<br>
<pre><code class="bash hljs">sudo yum -y update<font></font>
sudo yum install -y python36 python36-pip<font></font>
sudo /usr/bin/pip-3.6 install --upgrade pip<font></font>
sudo yum install -y aws-kinesis-agent<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cr√©ez un dossier pour enregistrer les r√©ponses de l'API:</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir /var/<span class="hljs-built_in">log</span>/airline_tickets</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de d√©marrer l'agent, vous devez configurer sa configuration:</font></font><br>
<br>
<pre><code class="bash hljs">sudo vim /etc/aws-kinesis/agent.json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le contenu du fichier agent.json doit ressembler √† ceci:</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"cloudwatch.emitMetrics"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">"kinesis.endpoint"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-attr">"firehose.endpoint"</span>: <span class="hljs-string">""</span>,<font></font>
<font></font>
  <span class="hljs-attr">"flows"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"filePattern"</span>: <span class="hljs-string">"/var/log/airline_tickets/*log"</span>,
      <span class="hljs-attr">"kinesisStream"</span>: <span class="hljs-string">"airline_tickets"</span>,
      <span class="hljs-attr">"partitionKeyOption"</span>: <span class="hljs-string">"RANDOM"</span>,
      <span class="hljs-attr">"dataProcessingOptions"</span>: [<font></font>
         {<font></font>
            <span class="hljs-attr">"optionName"</span>: <span class="hljs-string">"CSVTOJSON"</span>,
            <span class="hljs-attr">"customFieldNames"</span>: [<span class="hljs-string">"cost"</span>,<span class="hljs-string">"trip_class"</span>,<span class="hljs-string">"show_to_affiliates"</span>,
                <span class="hljs-string">"return_date"</span>,<span class="hljs-string">"origin"</span>,<span class="hljs-string">"number_of_changes"</span>,<span class="hljs-string">"gate"</span>,<span class="hljs-string">"found_at"</span>,
                <span class="hljs-string">"duration"</span>,<span class="hljs-string">"distance"</span>,<span class="hljs-string">"destination"</span>,<span class="hljs-string">"depart_date"</span>,<span class="hljs-string">"actual"</span>,<span class="hljs-string">"record_id"</span>]<font></font>
         }<font></font>
      ]<font></font>
    }<font></font>
  ]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir dans le fichier de configuration, l'agent surveillera les fichiers avec l'extension .log dans le r√©pertoire / var / log / airlines_tickets /, les analysera et les transf√©rera vers le flux de airlines_tickets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous red√©marrons le service et nous assurons qu'il d√©marre et fonctionne:</font></font><br>
<br>
<pre><code class="bash hljs">sudo service aws-kinesis-agent restart</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
T√©l√©chargez maintenant le script Python qui demandera des donn√©es √† l'API:</font></font><br>
<br>
<pre><code class="bash hljs">REPO_PATH=https://raw.githubusercontent.com/igorgorbenko/aviasales_kinesis/master/producer<font></font>
<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/api_caller.py -P /home/ec2-user/<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/requirements.txt -P /home/ec2-user/<font></font>
sudo chmod a+x /home/ec2-user/api_caller.py<font></font>
sudo /usr/<span class="hljs-built_in">local</span>/bin/pip3 install -r /home/ec2-user/requirements.txt
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le script api_caller.py demande des donn√©es √† Aviasales et enregistre la r√©ponse re√ßue dans le r√©pertoire analys√© par l'agent Kinesis. </font><font style="vertical-align: inherit;">L'impl√©mentation de ce script est assez standard, il existe une classe TicketsApi, elle vous permet d'extraire l'API de mani√®re asynchrone. </font><font style="vertical-align: inherit;">Dans cette classe, nous passons l'en-t√™te avec le jeton et les param√®tres de requ√™te:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsApi</span>:</span>
    <span class="hljs-string">"""Api caller class."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, headers</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.base_url = BASE_URL<font></font>
        self.headers = headers<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">self, data</span>):</span>
        <span class="hljs-string">"""Get the data from API query."""</span><font></font>
        response_json = {}<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(headers=self.headers) <span class="hljs-keyword">as</span> session:
            <span class="hljs-keyword">try</span>:<font></font>
                response = <span class="hljs-keyword">await</span> session.get(self.base_url, data=data)<font></font>
                response.raise_for_status()<font></font>
                LOGGER.info(<span class="hljs-string">'Response status %s: %s'</span>,<font></font>
                            self.base_url, response.status)<font></font>
                response_json = <span class="hljs-keyword">await</span> response.json()
            <span class="hljs-keyword">except</span> HTTPError <span class="hljs-keyword">as</span> http_err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! HTTP error occurred: %s'</span>, str(http_err))
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! An error ocurred: %s'</span>, str(err))
            <span class="hljs-keyword">return</span> response_json<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepare_request</span>(<span class="hljs-params">api_token</span>):</span>
    <span class="hljs-string">"""Return the headers and query fot the API request."""</span>
    headers = {<span class="hljs-string">'X-Access-Token'</span>: api_token,
               <span class="hljs-string">'Accept-Encoding'</span>: <span class="hljs-string">'gzip'</span>}<font></font>
<font></font>
    data = FormData()<font></font>
    data.add_field(<span class="hljs-string">'currency'</span>, CURRENCY)<font></font>
    data.add_field(<span class="hljs-string">'origin'</span>, ORIGIN)<font></font>
    data.add_field(<span class="hljs-string">'destination'</span>, DESTINATION)<font></font>
    data.add_field(<span class="hljs-string">'show_to_affiliates'</span>, SHOW_TO_AFFILIATES)<font></font>
    data.add_field(<span class="hljs-string">'trip_duration'</span>, TRIP_DURATION)
    <span class="hljs-keyword">return</span> headers, data<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-string">"""Get run the code."""</span>
    <span class="hljs-keyword">if</span> len(sys.argv) != <span class="hljs-number">2</span>:<font></font>
        print(<span class="hljs-string">'Usage: api_caller.py &lt;your_api_token&gt;'</span>)<font></font>
        sys.exit(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span>
    api_token = sys.argv[<span class="hljs-number">1</span>]<font></font>
    headers, data = prepare_request(api_token)<font></font>
<font></font>
    api = TicketsApi(headers)<font></font>
    response = <span class="hljs-keyword">await</span> api.get_data(data)
    <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'success'</span>, <span class="hljs-literal">None</span>):<font></font>
        LOGGER.info(<span class="hljs-string">'API has returned %s items'</span>, len(response[<span class="hljs-string">'data'</span>]))
        <span class="hljs-keyword">try</span>:<font></font>
            count_rows = log_maker(response)<font></font>
            LOGGER.info(<span class="hljs-string">'%s rows have been saved into %s'</span>,<font></font>
                        count_rows,<font></font>
                        TARGET_FILE)<font></font>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
            LOGGER.error(<span class="hljs-string">'Oops! Request result was not saved to file. %s'</span>,<font></font>
                         str(e))<font></font>
    <span class="hljs-keyword">else</span>:<font></font>
        LOGGER.error(<span class="hljs-string">'Oops! API request was unsuccessful %s!'</span>, response)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tester les param√®tres et l'op√©rabilit√© corrects de l'agent, nous allons effectuer un test de test du script api_caller.py:</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/u8/17/rr/u817rrbmcgutepqlpx-aa7k2mo4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous examinons le r√©sultat du travail dans les journaux de l'agent et sur l'onglet Surveillance dans le flux de donn√©es de airlines_tickets:</font></font><br>
<br>
<pre><code class="bash hljs">tail -f /var/<span class="hljs-built_in">log</span>/aws-kinesis-agent/aws-kinesis-agent.log</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/5r/oy/ep5royv-vndczuzfhaufx2duuau.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/g3/pi/ya/g3piyaltiksnogpxwm0temjdpz4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, tout fonctionne et l'agent Kinesis envoie avec succ√®s des donn√©es au flux. </font><font style="vertical-align: inherit;">Configurez maintenant le consommateur.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de Kinesis Data Analytics</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons au composant central de tout le syst√®me - cr√©ons une nouvelle application dans Kinesis Data Analytics appel√©e kinesis_analytics_airlines_app:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dp/0s/4a/dp0s4aesniewnc3j7envuvi2lqa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kinesis Data Analytics permet une analyse en temps r√©el des donn√©es de Kinesis Streams √† l'aide de SQL. </font><font style="vertical-align: inherit;">Il s'agit d'un service enti√®rement auto-√©volutif (contrairement √† Kinesis Streams), qui:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous permet de cr√©er de nouveaux flux (flux de sortie) en fonction des requ√™tes sur les donn√©es source;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fournit un flux avec des erreurs survenues pendant le fonctionnement de l'application (flux d'erreurs);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il peut d√©terminer automatiquement le sch√©ma de donn√©es d'entr√©e (il peut √™tre red√©fini manuellement si n√©cessaire).</font></font></li>
</ol><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'agit d'un service co√ªteux - 0,11 USD par heure, vous devez donc l'utiliser avec soin et le retirer lorsque vous avez termin√© le travail.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connectez l'application √† la source de donn√©es:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/sc/g6/2xscg6tquygvrr4dxhjofyxjx-m.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S√©lectionnez le flux auquel vous souhaitez vous connecter (billets_a√©riens):</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/c7/ma/y1c7ma8a_9n3wwwokqleszry-qa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez attacher le nouveau r√¥le IAM afin que l'application puisse lire dans le flux et √©crire dans le flux. </font><font style="vertical-align: inherit;">Pour ce faire, il suffit de ne rien changer dans le bloc Autorisations d'acc√®s:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dg/96/wq/dg96wq1hgmmd0ouhxpxs8r0tjss.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous demandons la d√©couverte du sch√©ma de donn√©es dans le flux, pour cela nous cliquons sur le bouton "D√©couvrir le sch√©ma". </font><font style="vertical-align: inherit;">En cons√©quence, le r√¥le IAM sera mis √† jour (un nouveau sera cr√©√©) et la d√©couverte du sch√©ma √† partir des donn√©es d√©j√† arriv√©es dans le flux sera lanc√©e:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5e/co/6r/5eco6ro21kgrevovywr-2ulfysw.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, vous devez aller dans l'√©diteur SQL. </font><font style="vertical-align: inherit;">Lorsque vous cliquez sur ce bouton, une fen√™tre avec une question sur le lancement de l'application appara√Ætra - choisissez ce que nous voulons ex√©cuter:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kt/oc/ta/ktoctaokxjgsxbosk5eu8-yw_e0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la fen√™tre de l'√©diteur SQL, ins√©rez une requ√™te aussi simple et cliquez sur Enregistrer et ex√©cuter SQL:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> STREAM <span class="hljs-string">"DESTINATION_SQL_STREAM"</span> (<span class="hljs-string">"cost"</span> <span class="hljs-keyword">DOUBLE</span>, <span class="hljs-string">"gate"</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">16</span>));<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> PUMP <span class="hljs-string">"STREAM_PUMP"</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"DESTINATION_SQL_STREAM"</span>
<span class="hljs-keyword">SELECT</span> STREAM <span class="hljs-string">"cost"</span>, <span class="hljs-string">"gate"</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"SOURCE_SQL_STREAM_001"</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-string">"cost"</span> &lt; <span class="hljs-number">5000</span>
    <span class="hljs-keyword">and</span> <span class="hljs-string">"gate"</span> = <span class="hljs-string">'Aeroflot'</span>;
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans les bases de donn√©es relationnelles, vous travaillez avec des tables √† l'aide d'instructions INSERT pour ajouter des enregistrements et d'une instruction SELECT pour interroger des donn√©es. </font><font style="vertical-align: inherit;">Dans Amazon Kinesis Data Analytics, vous travaillez avec des flux (STREAM) et des ¬´pompes¬ª (PUMP) - des demandes d'insertion continues qui ins√®rent des donn√©es d'un flux d'une application dans un autre flux.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la requ√™te SQL ci-dessus, les billets Aeroflot sont recherch√©s √† des prix inf√©rieurs √† cinq mille roubles. </font><font style="vertical-align: inherit;">Tous les enregistrements qui tombent dans ces conditions seront plac√©s dans le flux DESTINATION_SQL_STREAM.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l7/zk/8l/l7zk8ltrlivhjnmj3u1xcvazwai.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le bloc Destination, s√©lectionnez le flux de flux sp√©cial et dans la liste d√©roulante Nom du flux int√©gr√© √† l'application DESTINATION_SQL_STREAM:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5r/5s/7r/5r5s7rpwfezpiyjokrby1jkmcly.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la suite de toutes les manipulations, quelque chose de similaire √† l'image ci-dessous devrait se produire:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/o3/_b/4co3_blpb57-arskyc7jwsc2d_i.jpeg"></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation et abonnement √† la rubrique SNS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Acc√©dez au service de notification simple et cr√©ez un nouveau sujet nomm√© Airlines:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/su/ur/zr/suurzrkeqmmm7jk3-j5iuqaiar8.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous souscrivons √† ce sujet, nous y indiquons le num√©ro de t√©l√©phone mobile auquel les notifications SMS seront envoy√©es:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/gc/sz/epgcszgapjrsl4-jhx7vktgi7fi.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation d'une table dans DynamoDB</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour stocker les donn√©es brutes de leur flux airlines_tickets, cr√©ez une table dans DynamoDB avec le m√™me nom. </font><font style="vertical-align: inherit;">Comme cl√© primaire, nous utiliserons record_id:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/t7/td/4e/t7td4eq2asrdur1arxzbmsuthdk.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation d'une fonction de collecteur lambda</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cr√©ons une fonction lambda appel√©e Collector, dont la t√¢che est d'interroger le flux airlines_tickets et, s'il y a de nouveaux enregistrements, d'ins√©rer ces enregistrements dans la table DynamoDB. </font><font style="vertical-align: inherit;">De toute √©vidence, en plus des droits par d√©faut, ce lambda doit avoir acc√®s pour lire le flux de donn√©es Kinesis et √©crire dans DynamoDB.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation d'un r√¥le IAM pour une fonction de collecteur lambda</font></font></b>
                        <div class="spoiler_text">    IAM      Lambda-TicketsProcessingRole:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s9/sv/_f/s9sv_fh7p4flqdklnzh5rohd9ws.jpeg"></div><br>
       AmazonKinesisReadOnlyAccess  AmazonDynamoDBFullAccess,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/v0/zy/f_v0zyuhd3h9y5e9tiuurfbpqnq.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/78/db/ge/78dbgeqrxjuuh6rzlqd-k1qdgee.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce lambda doit √™tre d√©clench√© par un d√©clencheur Kinesis lorsque de nouvelles entr√©es atteignent le flux airlines_stream, vous devez donc ajouter un nouveau d√©clencheur:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qt/h0/gg/qth0ggplzpl1afpad4shlgl_tbu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/we/2c/ip/we2cipjv713dvyo10ry4wmyrdi0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste √† ins√©rer le code et √† sauvegarder le lambda.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-string">"""Parsing the stream and inserting into the DynamoDB table."""</span>
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> decimal <span class="hljs-keyword">import</span> Decimal<font></font>
<font></font>
DYNAMO_DB = boto3.resource(<span class="hljs-string">'dynamodb'</span>)<font></font>
TABLE_NAME = <span class="hljs-string">'airline_tickets'</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsParser</span>:</span>
    <span class="hljs-string">"""Parsing info from the Stream."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, table_name, records</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.table = DYNAMO_DB.Table(table_name)<font></font>
        self.json_data = TicketsParser.get_json_data(records)<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_json_data</span>(<span class="hljs-params">records</span>):</span>
        <span class="hljs-string">"""Return deserialized data from the stream."""</span>
        decoded_record_data = ([base64.b64decode(record[<span class="hljs-string">'kinesis'</span>][<span class="hljs-string">'data'</span>])
                                <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> records])<font></font>
        json_data = ([json.loads(decoded_record)<font></font>
                      <span class="hljs-keyword">for</span> decoded_record <span class="hljs-keyword">in</span> decoded_record_data])
        <span class="hljs-keyword">return</span> json_data<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_item_from_json</span>(<span class="hljs-params">json_item</span>):</span>
        <span class="hljs-string">"""Pre-process the json data."""</span><font></font>
        new_item = {<font></font>
            <span class="hljs-string">'record_id'</span>: json_item.get(<span class="hljs-string">'record_id'</span>),
            <span class="hljs-string">'cost'</span>: Decimal(json_item.get(<span class="hljs-string">'cost'</span>)),
            <span class="hljs-string">'trip_class'</span>: json_item.get(<span class="hljs-string">'trip_class'</span>),
            <span class="hljs-string">'show_to_affiliates'</span>: json_item.get(<span class="hljs-string">'show_to_affiliates'</span>),
            <span class="hljs-string">'origin'</span>: json_item.get(<span class="hljs-string">'origin'</span>),
            <span class="hljs-string">'number_of_changes'</span>: int(json_item.get(<span class="hljs-string">'number_of_changes'</span>)),
            <span class="hljs-string">'gate'</span>: json_item.get(<span class="hljs-string">'gate'</span>),
            <span class="hljs-string">'found_at'</span>: json_item.get(<span class="hljs-string">'found_at'</span>),
            <span class="hljs-string">'duration'</span>: int(json_item.get(<span class="hljs-string">'duration'</span>)),
            <span class="hljs-string">'distance'</span>: int(json_item.get(<span class="hljs-string">'distance'</span>)),
            <span class="hljs-string">'destination'</span>: json_item.get(<span class="hljs-string">'destination'</span>),
            <span class="hljs-string">'depart_date'</span>: json_item.get(<span class="hljs-string">'depart_date'</span>),
            <span class="hljs-string">'actual'</span>: json_item.get(<span class="hljs-string">'actual'</span>)<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> new_item<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">"""Batch insert into the table."""</span>
        <span class="hljs-keyword">with</span> self.table.batch_writer() <span class="hljs-keyword">as</span> batch_writer:
            <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.json_data:<font></font>
                dynamodb_item = TicketsParser.get_item_from_json(item)<font></font>
                batch_writer.put_item(dynamodb_item)<font></font>
<font></font>
        print(<span class="hljs-string">'Has been added '</span>, len(self.json_data), <span class="hljs-string">'items'</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-string">"""Parse the stream and insert into the DynamoDB table."""</span>
    print(<span class="hljs-string">'Got event:'</span>, event)<font></font>
    parser = TicketsParser(TABLE_NAME, event[<span class="hljs-string">'Records'</span>])<font></font>
    parser.run()<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©ation d'un notificateur de fonction lambda</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxi√®me fonction lambda, qui surveillera le deuxi√®me flux (flux_ sp√©cial) et enverra une notification √† SNS, est cr√©√©e de la m√™me mani√®re. </font><font style="vertical-align: inherit;">Par cons√©quent, ce lambda doit avoir un acc√®s en lecture depuis Kinesis et envoyer des messages √† la rubrique SNS sp√©cifi√©e, qui est ensuite envoy√©e par le service SNS √† tous les abonn√©s de cette rubrique (e-mail, SMS, etc.).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cr√©er des r√¥les IAM</font></font></b>
                        <div class="spoiler_text">  IAM  Lambda-KinesisAlarm   ,         alarm_notifier:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zm/fn/ru/zmfnru75p-tp0y1fqzxaoea2xos.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yp/vp/u0/ypvpu0jl74aak54hl-d4wf7r1kc.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce lambda devrait fonctionner en fonction du d√©clencheur pour que de nouvelles entr√©es entrent dans le flux sp√©cial, vous devez donc configurer le d√©clencheur de la m√™me mani√®re que nous l'avons fait pour le lambda Collector. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour la commodit√© de la configuration de cette lambda, nous introduisons une nouvelle variable d'environnement - TOPIC_ARN, o√π nous pla√ßons le sujet ANR (Amazon Recourse Names) de Airlines:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/43/nn/qf/43nnqfmsnahbfu30k5mqadhbuhi.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ins√©rez le code lambda, c'est tr√®s simple:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> os<font></font>
<font></font>
SNS_CLIENT = boto3.client(<span class="hljs-string">'sns'</span>)<font></font>
TOPIC_ARN = os.environ[<span class="hljs-string">'TOPIC_ARN'</span>]<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-keyword">try</span>:<font></font>
        SNS_CLIENT.publish(TopicArn=TOPIC_ARN,<font></font>
                           Message=<span class="hljs-string">'Hi! I have found an interesting stuff!'</span>,<font></font>
                           Subject=<span class="hljs-string">'Airline tickets alarm'</span>)<font></font>
        print(<span class="hljs-string">'Alarm message has been successfully delivered'</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
        print(<span class="hljs-string">'Delivery failure'</span>, str(err))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semble que cela termine la configuration manuelle du syst√®me. </font><font style="vertical-align: inherit;">Il ne reste plus qu'√† tester et √† s'assurer que nous avons tout configur√© correctement.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©ployer √† partir du code Terraform</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©paration n√©cessaire</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un outil open source tr√®s pratique pour d√©ployer l'infrastructure √† partir du code. </font><font style="vertical-align: inherit;">Il a sa propre syntaxe qui est facile √† apprendre et de nombreux exemples de comment et quoi d√©ployer. </font><font style="vertical-align: inherit;">Il existe de nombreux plugins pratiques dans l'√©diteur de code Atom ou Visual Studio qui facilitent le travail avec Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez t√©l√©charger le kit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> distribution </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ici</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Une analyse d√©taill√©e de toutes les fonctionnalit√©s de Terraform d√©passe le cadre de cet article, nous nous limiterons donc aux points principaux.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment commencer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de projet complet est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans mon r√©f√©rentiel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous clonons un r√©f√©rentiel pour nous-m√™mes. </font><font style="vertical-align: inherit;">Avant de commencer, vous devez vous assurer que vous avez install√© et configur√© l'AWS CLI, comme </font><font style="vertical-align: inherit;">Terraform recherchera les informations d'identification dans le fichier ~ / .aws / credentials. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est recommand√© de d√©ployer l'int√©gralit√© de l'infrastructure avant de lancer la commande plan pour voir ce que Terraform cr√©e pour nous dans le cloud:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe plan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous serez invit√© √† entrer un num√©ro de t√©l√©phone pour lui envoyer des notifications. </font><font style="vertical-align: inherit;">√Ä ce stade, il est facultatif.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/e3/-i/ps/e3-ipsgvy03inzbw_26haktayk4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir analys√© le plan de travail du programme, nous pouvons commencer la cr√©ation de ressources:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe apply</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s l'envoi de cette commande, il vous sera √† nouveau demand√© de saisir un num√©ro de t√©l√©phone, tapez ¬´oui¬ª lorsque la question sur l'ex√©cution r√©elle des actions s'affiche. </font><font style="vertical-align: inherit;">Cela vous permettra d'augmenter l'ensemble de l'infrastructure, d'effectuer tous les r√©glages n√©cessaires pour EC2, de d√©ployer des fonctions lambda, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que toutes les ressources ont √©t√© cr√©√©es avec succ√®s via le code Terraform, vous devez entrer dans les d√©tails de l'application Kinesis Analytics (malheureusement, je n'ai pas trouv√© comment le faire directement √† partir du code). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lancez l'application:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/ns/qc/qxnsqcjpbkiaradzqomahtxzhnu.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, vous devez d√©finir explicitement le nom du flux dans l'application en choisissant dans la liste d√©roulante:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ki/m5/pl/kim5plwariaz8bp-qo-qonli4yu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hg/69/kf/hg69kfwwtwhwkzxlpnb7g3k2ctm.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, tout est pr√™t.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test d'application</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelle que soit la fa√ßon dont vous avez d√©ploy√© le syst√®me, manuellement ou via le code Terraform, il fonctionnera de la m√™me mani√®re. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous passons par SSH √† la machine virtuelle EC2 o√π Kinesis Agent est install√© et ex√©cutons le script api_caller.py</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reste √† attendre un SMS sur votre num√©ro: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/98/ui/mc/98uimcirxv_n6pglm2qz5jtkvf4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SMS - le message arrive sur le t√©l√©phone en presque 1 minute: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kg/u7/dj/kgu7djc9xgex84h349dlpfukivg.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste √† voir si les enregistrements sont sauvegard√©s dans la base de donn√©es DynamoDB pour une analyse ult√©rieure plus d√©taill√©e. </font><font style="vertical-align: inherit;">Le tableau des billets d'avion contient quelque chose comme ceci:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/dj/vc/gqdjvcmx0q45o_sgqc_l5po_l-c.jpeg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours du travail effectu√©, un syst√®me de traitement des donn√©es en ligne bas√© sur Amazon Kinesis a √©t√© construit. </font><font style="vertical-align: inherit;">Nous avons examin√© les options d'utilisation de Kinesis Agent en conjonction avec Kinesis Data Streams et l'analyse en temps r√©el de Kinesis Analytics √† l'aide de commandes SQL, ainsi que l'interaction d'Amazon Kinesis avec d'autres services AWS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons d√©ploy√© le syst√®me ci-dessus de deux mani√®res: suffisamment longue et manuelle √† partir du code Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'int√©gralit√© du code source du projet est disponible </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans mon r√©f√©rentiel sur GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , je vous sugg√®re de vous familiariser avec celui-ci. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je suis pr√™t √† discuter de l'article avec plaisir, j'attends vos commentaires. </font><font style="vertical-align: inherit;">J'esp√®re des critiques constructives. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Te souhaite du succ√®s!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr500364/index.html">Extension du portail d'apprentissage scolaire sur Moodle et BigBlueButton</a></li>
<li><a href="../fr500368/index.html">G√©n√©rer des s√©quences al√©atoires pr√©visibles: une approche diff√©rente de la permutation</a></li>
<li><a href="../fr500370/index.html">10 podcasts en anglais utiles pour les programmeurs qui m√©ritent d'√™tre abonn√©s en 2020</a></li>
<li><a href="../fr500378/index.html">Recherche d'informations efficace au travail</a></li>
<li><a href="../fr500380/index.html">Traitement √† distance des donn√©es personnelles: risques et cons√©quences possibles</a></li>
<li><a href="../fr500384/index.html">Pixar Studio Pioneers a re√ßu le prix Turing et 1 million de dollars</a></li>
<li><a href="../fr500386/index.html">Adapter votre solution commerciale existante pour SwiftUI. Partie 2</a></li>
<li><a href="../fr500390/index.html">Mod√®les r√©els de localisation linguistique dans le domaine de l'informatique et des communications num√©riques. Partie 1</a></li>
<li><a href="../fr500396/index.html">Probl√®mes des syst√®mes de contr√¥le d'acc√®s autonomes - O√π ils ne s'attendaient pas</a></li>
<li><a href="../fr500398/index.html">Remote Marathon Week 3: Processus inop√©rants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>