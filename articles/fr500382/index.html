<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🚒 👈🏻 ⚛️ Intégration d'API Aviasales avec Amazon Kinesis et simplicité sans serveur ⛓️ 🈴 👃🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 
 
 Aimez-vous piloter des avions? J'adore ça, mais sur l'auto-isolement, j'ai aussi aimé analyser les données sur les billets d'avion ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Intégration d'API Aviasales avec Amazon Kinesis et simplicité sans serveur</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500382/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aimez-vous piloter des avions? </font><font style="vertical-align: inherit;">J'adore ça, mais sur l'auto-isolement, j'ai aussi aimé analyser les données sur les billets d'avion d'une ressource bien connue - Aviasales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, nous analyserons le travail d'Amazon Kinesis, construirons un système de streaming avec des analyses en temps réel, placerons la base de données Amazon DynamoDB NoSQL comme entrepôt de données principal et configurerons des alertes SMS pour les tickets intéressants. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les détails sous la coupe! </font><font style="vertical-align: inherit;">Aller!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/-n/qn/yn/-nqnynmwzv61pmiq2ocatoxseme.jpeg"></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, nous devons avoir accès à </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">l'API Aviasales</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L'accès à celui-ci est gratuit et sans restriction, il vous suffit de vous inscrire dans la section "Développeurs" pour obtenir votre token API pour accéder aux données.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'objectif principal de cet article est de donner une compréhension générale de l'utilisation des informations de streaming dans AWS, nous faisons en sorte que les données renvoyées par l'API utilisée ne soient pas strictement pertinentes et soient transférées à partir du cache, qui est généré à partir des recherches des utilisateurs des sites Aviasales.ru et Jetradar.com pour dernières 48 heures. </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les données des billets d'avion de l'agent Kinesis reçues via l'API installée sur la machine du producteur seront automatiquement analysées et transférées vers le flux souhaité via Kinesis Data Analytics. </font><font style="vertical-align: inherit;">Une version non traitée de ce flux sera écrite directement dans le référentiel. </font><font style="vertical-align: inherit;">Déployé dans le stockage DynamoDB des données brutes permettra une analyse plus approfondie des tickets via des outils de BI, tels qu'AWS Quick Sight. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous considérerons deux options pour déployer l'ensemble de l'infrastructure:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manuel - via AWS Management Console;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infrastructure à partir du code Terraform - pour les ingénieurs d'automatisation paresseux;</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture du système en cours de développement</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vt/ss/mx/vtssmx0accvfcphkjvmzwdf4udg.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Composants utilisés:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API Aviasales</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - les données renvoyées par cette API seront utilisées pour tous les travaux ultérieurs;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EC2 Producer Instance</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une machine virtuelle ordinaire dans le cloud sur laquelle le flux de données d'entrée sera généré:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kinesis Agent</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une application Java installée localement qui fournit un moyen simple de collecter et d'envoyer des données à Kinesis (Kinesis Data Streams ou Kinesis Firehose). </font><font style="vertical-align: inherit;">L'agent surveille en permanence un ensemble de fichiers dans les répertoires spécifiés et envoie de nouvelles données à Kinesis;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script de l'API de l'appelant</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - un script Python qui fait des demandes d'API et place la réponse dans un dossier surveillé par l'agent Kinesis;</font></font></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b>Kinesis Data Streams</b></a> —            ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b>Kinesis Analytics</b></a> —  ,        . Amazon Kinesis Data Analytics              ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b>AWS Lambda</b></a> — ,        .        ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b>Amazon DynamoDB</b></a> —    «‑»  ,     10      .   DynamoDB    - ,       . DynamoDB   ,        .       ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><b>Amazon SNS</b></a> —        « — » (Pub/Sub),      ,     . SNS           push-, SMS-   .</li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formation initiale</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour émuler le flux de données, j'ai décidé d'utiliser les informations sur les billets d'avion renvoyées par l'API Aviasales. </font><font style="vertical-align: inherit;">La </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation contient une</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> liste assez complète de différentes méthodes, prenez l'une d'entre elles - le «Calendrier des prix pour le mois», qui renvoie les prix pour chaque jour du mois, regroupés par nombre de transferts. </font><font style="vertical-align: inherit;">Si vous ne transmettez pas le mois de recherche dans la demande, les informations seront retournées pour le mois suivant celui en cours. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors, inscrivez-vous, obtenez votre jeton. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple de demande ci-dessous:</font></font><br>
<br>
<pre><code class="bash hljs">http://api.travelpayouts.com/v2/prices/month-matrix?currency=rub&amp;origin=LED&amp;destination=HKT&amp;show_to_affiliates=<span class="hljs-literal">true</span>&amp;token=TOKEN_API</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La méthode ci-dessus pour recevoir des données de l'API avec le jeton dans la demande fonctionnera, mais je préfère passer le jeton d'accès via l'en-tête, nous allons donc utiliser cette méthode dans le script api_caller.py. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exemple de réponse:</font></font><br>
<br>
<pre><code class="json hljs">{{
   <span class="hljs-attr">"success"</span>:<span class="hljs-literal">true</span>,
   <span class="hljs-attr">"data"</span>:[{
      <span class="hljs-attr">"show_to_affiliates"</span>:<span class="hljs-literal">true</span>,
      <span class="hljs-attr">"trip_class"</span>:<span class="hljs-number">0</span>,
      <span class="hljs-attr">"origin"</span>:<span class="hljs-string">"LED"</span>,
      <span class="hljs-attr">"destination"</span>:<span class="hljs-string">"HKT"</span>,
      <span class="hljs-attr">"depart_date"</span>:<span class="hljs-string">"2015-10-01"</span>,
      <span class="hljs-attr">"return_date"</span>:<span class="hljs-string">""</span>,
      <span class="hljs-attr">"number_of_changes"</span>:<span class="hljs-number">1</span>,
      <span class="hljs-attr">"value"</span>:<span class="hljs-number">29127</span>,
      <span class="hljs-attr">"found_at"</span>:<span class="hljs-string">"2015-09-24T00:06:12+04:00"</span>,
      <span class="hljs-attr">"distance"</span>:<span class="hljs-number">8015</span>,
      <span class="hljs-attr">"actual"</span>:<span class="hljs-literal">true</span><font></font>
   }]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exemple de réponse API ci-dessus montre un billet de Saint-Pétersbourg à Phuk ... Oh, de quoi rêver ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque je viens de Kazan et que Phuket "rêve tout simplement de nous" maintenant, nous chercherons des billets de Saint-Pétersbourg à Kazan.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est supposé que vous disposez déjà d'un compte AWS. </font><font style="vertical-align: inherit;">Je veux tout de suite faire particulièrement attention à ce que Kinesis et l'envoi de notifications par SMS ne soient pas inclus dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">niveau gratuit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> annuel </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">(utilisation gratuite)</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais malgré cela, avec quelques dollars en tête, il est tout à fait possible de construire le système proposé et de jouer avec. </font><font style="vertical-align: inherit;">Et, bien sûr, n'oubliez pas de supprimer toutes les ressources lorsqu'elles deviennent inutiles.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Heureusement, les fonctions DynamoDb et lambda seront des partagiciels pour nous si vous respectez les limites mensuelles gratuites. </font><font style="vertical-align: inherit;">Par exemple, pour DynamoDB: 25 Go de stockage, 25 WCU / RCU et 100 millions de demandes. </font><font style="vertical-align: inherit;">Et un million d'appels aux fonctions lambda par mois.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Système de déploiement manuel</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration des flux de données Kinesis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accédez au service Kinesis Data Streams et créez deux nouveaux flux, un fragment pour chacun.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-ce qu'un éclat?</font></font></b>
                        <div class="spoiler_text"> —       Amazon Kinesis.         1 /       2 /.     1000  PUT  .         . ,       .          2 /       4 /    2000  PUT  .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plus il y a d'éclats dans votre flux, plus son débit est important. </font><font style="vertical-align: inherit;">En principe, les flux sont mis à l'échelle de cette façon en ajoutant des fragments. </font><font style="vertical-align: inherit;">Mais plus vous avez d'éclats, plus le prix est élevé. </font><font style="vertical-align: inherit;">Chaque fragment coûte 1,5 centime par heure et 1,4 centime supplémentaire pour chaque million d'unités de charge utile PUT. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez un nouveau thread avec le nom </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flight_tickets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , 1 fragment suffira pour cela:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f8/5p/jg/f85pjg59pxlsbjio2_yzpz1wng4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez maintenant un autre flux appelé </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">special_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4l/_t/eo/4l_teoxvvwv5pablkpfnv-tlnac.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Réglage du producteur</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En tant que producteur de données pour analyser une tâche, il suffit d'utiliser une instance EC2 standard. </font><font style="vertical-align: inherit;">Il n'est pas nécessaire que ce soit une machine virtuelle puissante et coûteuse; le spot t2.micro convient parfaitement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remarque importante: par exemple, vous devez utiliser l'image - Amazon Linux AMI 2018.03.0, avec elle, il y a moins de paramètres pour lancer rapidement l'agent Kinesis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accédez au service EC2, créez une nouvelle machine virtuelle, sélectionnez l'AMI souhaitée avec le type t2.micro, qui est inclus dans Free Tier:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3q/rg/gt/3qrggtrxqistnkvgzn0bwkfdvbk.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que la machine virtuelle nouvellement créée puisse interagir avec le service Kinesis, vous devez lui en donner le droit. </font><font style="vertical-align: inherit;">La meilleure façon de procéder consiste à attribuer un rôle IAM. </font><font style="vertical-align: inherit;">Par conséquent, sur l'écran Étape 3: Configurer les détails de l'instance, sélectionnez </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créer un nouveau rôle IAM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Création de rôles IAM pour EC2</font></font></b>
                        <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/_p/rm/xv/_prmxvgp0iv148grjwdpunwaela.jpeg"></div><br>
  , ,      EC2     Permissions:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/as/nn/zvasnnl8ootjsr6rojjfhmjtfiw.jpeg"></div><br>
             ,     : AmazonKinesisFullAccess  CloudWatchFullAccess.<br>
<br>
 -     , : EC2-KinesisStreams-FullAccess.  ,     ,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jh/rj/38/jhrj38s8czngu9ri77mu26lh_o0.jpeg"></div><br>
    ,         :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yn/he/23/ynhe23lg4gfpfbjvlphntvfypyw.jpeg"></div><br>
           . <br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez laisser les paramètres du disque dur par défaut, les balises aussi (bien qu'il soit recommandé d'utiliser des balises, donnez au moins le nom de l'instance et spécifiez l'environnement). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sommes maintenant sur l'onglet Étape 6: Configurer le groupe de sécurité, où vous devez en créer un nouveau ou spécifier votre groupe de sécurité existant, ce qui vous permet de vous connecter via ssh (port 22) à l'instance. </font><font style="vertical-align: inherit;">Sélectionnez Source -&gt; Mon IP là-bas et vous pouvez exécuter l'instance.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y7/cd/z9/y7cdz9fllra7haynrf6gyu0jkdq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois qu'il entre en état de fonctionnement, vous pouvez essayer de vous y connecter via ssh. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour pouvoir travailler avec Kinesis Agent, après une connexion réussie à la machine, vous devez entrer les commandes suivantes dans le terminal:</font></font><br>
<br>
<pre><code class="bash hljs">sudo yum -y update<font></font>
sudo yum install -y python36 python36-pip<font></font>
sudo /usr/bin/pip-3.6 install --upgrade pip<font></font>
sudo yum install -y aws-kinesis-agent<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créez un dossier pour enregistrer les réponses de l'API:</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir /var/<span class="hljs-built_in">log</span>/airline_tickets</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de démarrer l'agent, vous devez configurer sa configuration:</font></font><br>
<br>
<pre><code class="bash hljs">sudo vim /etc/aws-kinesis/agent.json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le contenu du fichier agent.json doit ressembler à ceci:</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"cloudwatch.emitMetrics"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">"kinesis.endpoint"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-attr">"firehose.endpoint"</span>: <span class="hljs-string">""</span>,<font></font>
<font></font>
  <span class="hljs-attr">"flows"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"filePattern"</span>: <span class="hljs-string">"/var/log/airline_tickets/*log"</span>,
      <span class="hljs-attr">"kinesisStream"</span>: <span class="hljs-string">"airline_tickets"</span>,
      <span class="hljs-attr">"partitionKeyOption"</span>: <span class="hljs-string">"RANDOM"</span>,
      <span class="hljs-attr">"dataProcessingOptions"</span>: [<font></font>
         {<font></font>
            <span class="hljs-attr">"optionName"</span>: <span class="hljs-string">"CSVTOJSON"</span>,
            <span class="hljs-attr">"customFieldNames"</span>: [<span class="hljs-string">"cost"</span>,<span class="hljs-string">"trip_class"</span>,<span class="hljs-string">"show_to_affiliates"</span>,
                <span class="hljs-string">"return_date"</span>,<span class="hljs-string">"origin"</span>,<span class="hljs-string">"number_of_changes"</span>,<span class="hljs-string">"gate"</span>,<span class="hljs-string">"found_at"</span>,
                <span class="hljs-string">"duration"</span>,<span class="hljs-string">"distance"</span>,<span class="hljs-string">"destination"</span>,<span class="hljs-string">"depart_date"</span>,<span class="hljs-string">"actual"</span>,<span class="hljs-string">"record_id"</span>]<font></font>
         }<font></font>
      ]<font></font>
    }<font></font>
  ]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir dans le fichier de configuration, l'agent surveillera les fichiers avec l'extension .log dans le répertoire / var / log / airlines_tickets /, les analysera et les transférera vers le flux de airlines_tickets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous redémarrons le service et nous assurons qu'il démarre et fonctionne:</font></font><br>
<br>
<pre><code class="bash hljs">sudo service aws-kinesis-agent restart</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Téléchargez maintenant le script Python qui demandera des données à l'API:</font></font><br>
<br>
<pre><code class="bash hljs">REPO_PATH=https://raw.githubusercontent.com/igorgorbenko/aviasales_kinesis/master/producer<font></font>
<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/api_caller.py -P /home/ec2-user/<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/requirements.txt -P /home/ec2-user/<font></font>
sudo chmod a+x /home/ec2-user/api_caller.py<font></font>
sudo /usr/<span class="hljs-built_in">local</span>/bin/pip3 install -r /home/ec2-user/requirements.txt
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le script api_caller.py demande des données à Aviasales et enregistre la réponse reçue dans le répertoire analysé par l'agent Kinesis. </font><font style="vertical-align: inherit;">L'implémentation de ce script est assez standard, il existe une classe TicketsApi, elle vous permet d'extraire l'API de manière asynchrone. </font><font style="vertical-align: inherit;">Dans cette classe, nous passons l'en-tête avec le jeton et les paramètres de requête:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsApi</span>:</span>
    <span class="hljs-string">"""Api caller class."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, headers</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.base_url = BASE_URL<font></font>
        self.headers = headers<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">self, data</span>):</span>
        <span class="hljs-string">"""Get the data from API query."""</span><font></font>
        response_json = {}<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(headers=self.headers) <span class="hljs-keyword">as</span> session:
            <span class="hljs-keyword">try</span>:<font></font>
                response = <span class="hljs-keyword">await</span> session.get(self.base_url, data=data)<font></font>
                response.raise_for_status()<font></font>
                LOGGER.info(<span class="hljs-string">'Response status %s: %s'</span>,<font></font>
                            self.base_url, response.status)<font></font>
                response_json = <span class="hljs-keyword">await</span> response.json()
            <span class="hljs-keyword">except</span> HTTPError <span class="hljs-keyword">as</span> http_err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! HTTP error occurred: %s'</span>, str(http_err))
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! An error ocurred: %s'</span>, str(err))
            <span class="hljs-keyword">return</span> response_json<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepare_request</span>(<span class="hljs-params">api_token</span>):</span>
    <span class="hljs-string">"""Return the headers and query fot the API request."""</span>
    headers = {<span class="hljs-string">'X-Access-Token'</span>: api_token,
               <span class="hljs-string">'Accept-Encoding'</span>: <span class="hljs-string">'gzip'</span>}<font></font>
<font></font>
    data = FormData()<font></font>
    data.add_field(<span class="hljs-string">'currency'</span>, CURRENCY)<font></font>
    data.add_field(<span class="hljs-string">'origin'</span>, ORIGIN)<font></font>
    data.add_field(<span class="hljs-string">'destination'</span>, DESTINATION)<font></font>
    data.add_field(<span class="hljs-string">'show_to_affiliates'</span>, SHOW_TO_AFFILIATES)<font></font>
    data.add_field(<span class="hljs-string">'trip_duration'</span>, TRIP_DURATION)
    <span class="hljs-keyword">return</span> headers, data<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-string">"""Get run the code."""</span>
    <span class="hljs-keyword">if</span> len(sys.argv) != <span class="hljs-number">2</span>:<font></font>
        print(<span class="hljs-string">'Usage: api_caller.py &lt;your_api_token&gt;'</span>)<font></font>
        sys.exit(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span>
    api_token = sys.argv[<span class="hljs-number">1</span>]<font></font>
    headers, data = prepare_request(api_token)<font></font>
<font></font>
    api = TicketsApi(headers)<font></font>
    response = <span class="hljs-keyword">await</span> api.get_data(data)
    <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'success'</span>, <span class="hljs-literal">None</span>):<font></font>
        LOGGER.info(<span class="hljs-string">'API has returned %s items'</span>, len(response[<span class="hljs-string">'data'</span>]))
        <span class="hljs-keyword">try</span>:<font></font>
            count_rows = log_maker(response)<font></font>
            LOGGER.info(<span class="hljs-string">'%s rows have been saved into %s'</span>,<font></font>
                        count_rows,<font></font>
                        TARGET_FILE)<font></font>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
            LOGGER.error(<span class="hljs-string">'Oops! Request result was not saved to file. %s'</span>,<font></font>
                         str(e))<font></font>
    <span class="hljs-keyword">else</span>:<font></font>
        LOGGER.error(<span class="hljs-string">'Oops! API request was unsuccessful %s!'</span>, response)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tester les paramètres et l'opérabilité corrects de l'agent, nous allons effectuer un test de test du script api_caller.py:</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/u8/17/rr/u817rrbmcgutepqlpx-aa7k2mo4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et nous examinons le résultat du travail dans les journaux de l'agent et sur l'onglet Surveillance dans le flux de données de airlines_tickets:</font></font><br>
<br>
<pre><code class="bash hljs">tail -f /var/<span class="hljs-built_in">log</span>/aws-kinesis-agent/aws-kinesis-agent.log</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/5r/oy/ep5royv-vndczuzfhaufx2duuau.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/g3/pi/ya/g3piyaltiksnogpxwm0temjdpz4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir, tout fonctionne et l'agent Kinesis envoie avec succès des données au flux. </font><font style="vertical-align: inherit;">Configurez maintenant le consommateur.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de Kinesis Data Analytics</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Passons au composant central de tout le système - créons une nouvelle application dans Kinesis Data Analytics appelée kinesis_analytics_airlines_app:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dp/0s/4a/dp0s4aesniewnc3j7envuvi2lqa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kinesis Data Analytics permet une analyse en temps réel des données de Kinesis Streams à l'aide de SQL. </font><font style="vertical-align: inherit;">Il s'agit d'un service entièrement auto-évolutif (contrairement à Kinesis Streams), qui:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous permet de créer de nouveaux flux (flux de sortie) en fonction des requêtes sur les données source;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fournit un flux avec des erreurs survenues pendant le fonctionnement de l'application (flux d'erreurs);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il peut déterminer automatiquement le schéma de données d'entrée (il peut être redéfini manuellement si nécessaire).</font></font></li>
</ol><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il s'agit d'un service coûteux - 0,11 USD par heure, vous devez donc l'utiliser avec soin et le retirer lorsque vous avez terminé le travail.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connectez l'application à la source de données:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/sc/g6/2xscg6tquygvrr4dxhjofyxjx-m.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sélectionnez le flux auquel vous souhaitez vous connecter (billets_aériens):</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/c7/ma/y1c7ma8a_9n3wwwokqleszry-qa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, vous devez attacher le nouveau rôle IAM afin que l'application puisse lire dans le flux et écrire dans le flux. </font><font style="vertical-align: inherit;">Pour ce faire, il suffit de ne rien changer dans le bloc Autorisations d'accès:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dg/96/wq/dg96wq1hgmmd0ouhxpxs8r0tjss.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, nous demandons la découverte du schéma de données dans le flux, pour cela nous cliquons sur le bouton "Découvrir le schéma". </font><font style="vertical-align: inherit;">En conséquence, le rôle IAM sera mis à jour (un nouveau sera créé) et la découverte du schéma à partir des données déjà arrivées dans le flux sera lancée:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5e/co/6r/5eco6ro21kgrevovywr-2ulfysw.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, vous devez aller dans l'éditeur SQL. </font><font style="vertical-align: inherit;">Lorsque vous cliquez sur ce bouton, une fenêtre avec une question sur le lancement de l'application apparaîtra - choisissez ce que nous voulons exécuter:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kt/oc/ta/ktoctaokxjgsxbosk5eu8-yw_e0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la fenêtre de l'éditeur SQL, insérez une requête aussi simple et cliquez sur Enregistrer et exécuter SQL:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> STREAM <span class="hljs-string">"DESTINATION_SQL_STREAM"</span> (<span class="hljs-string">"cost"</span> <span class="hljs-keyword">DOUBLE</span>, <span class="hljs-string">"gate"</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">16</span>));<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> PUMP <span class="hljs-string">"STREAM_PUMP"</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"DESTINATION_SQL_STREAM"</span>
<span class="hljs-keyword">SELECT</span> STREAM <span class="hljs-string">"cost"</span>, <span class="hljs-string">"gate"</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"SOURCE_SQL_STREAM_001"</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-string">"cost"</span> &lt; <span class="hljs-number">5000</span>
    <span class="hljs-keyword">and</span> <span class="hljs-string">"gate"</span> = <span class="hljs-string">'Aeroflot'</span>;
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans les bases de données relationnelles, vous travaillez avec des tables à l'aide d'instructions INSERT pour ajouter des enregistrements et d'une instruction SELECT pour interroger des données. </font><font style="vertical-align: inherit;">Dans Amazon Kinesis Data Analytics, vous travaillez avec des flux (STREAM) et des «pompes» (PUMP) - des demandes d'insertion continues qui insèrent des données d'un flux d'une application dans un autre flux.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la requête SQL ci-dessus, les billets Aeroflot sont recherchés à des prix inférieurs à cinq mille roubles. </font><font style="vertical-align: inherit;">Tous les enregistrements qui tombent dans ces conditions seront placés dans le flux DESTINATION_SQL_STREAM.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l7/zk/8l/l7zk8ltrlivhjnmj3u1xcvazwai.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le bloc Destination, sélectionnez le flux de flux spécial et dans la liste déroulante Nom du flux intégré à l'application DESTINATION_SQL_STREAM:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5r/5s/7r/5r5s7rpwfezpiyjokrby1jkmcly.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la suite de toutes les manipulations, quelque chose de similaire à l'image ci-dessous devrait se produire:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/o3/_b/4co3_blpb57-arskyc7jwsc2d_i.jpeg"></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Création et abonnement à la rubrique SNS</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accédez au service de notification simple et créez un nouveau sujet nommé Airlines:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/su/ur/zr/suurzrkeqmmm7jk3-j5iuqaiar8.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous souscrivons à ce sujet, nous y indiquons le numéro de téléphone mobile auquel les notifications SMS seront envoyées:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/gc/sz/epgcszgapjrsl4-jhx7vktgi7fi.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Création d'une table dans DynamoDB</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour stocker les données brutes de leur flux airlines_tickets, créez une table dans DynamoDB avec le même nom. </font><font style="vertical-align: inherit;">Comme clé primaire, nous utiliserons record_id:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/t7/td/4e/t7td4eq2asrdur1arxzbmsuthdk.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Création d'une fonction de collecteur lambda</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créons une fonction lambda appelée Collector, dont la tâche est d'interroger le flux airlines_tickets et, s'il y a de nouveaux enregistrements, d'insérer ces enregistrements dans la table DynamoDB. </font><font style="vertical-align: inherit;">De toute évidence, en plus des droits par défaut, ce lambda doit avoir accès pour lire le flux de données Kinesis et écrire dans DynamoDB.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Création d'un rôle IAM pour une fonction de collecteur lambda</font></font></b>
                        <div class="spoiler_text">    IAM      Lambda-TicketsProcessingRole:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s9/sv/_f/s9sv_fh7p4flqdklnzh5rohd9ws.jpeg"></div><br>
       AmazonKinesisReadOnlyAccess  AmazonDynamoDBFullAccess,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/v0/zy/f_v0zyuhd3h9y5e9tiuurfbpqnq.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/78/db/ge/78dbgeqrxjuuh6rzlqd-k1qdgee.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce lambda doit être déclenché par un déclencheur Kinesis lorsque de nouvelles entrées atteignent le flux airlines_stream, vous devez donc ajouter un nouveau déclencheur:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qt/h0/gg/qth0ggplzpl1afpad4shlgl_tbu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/we/2c/ip/we2cipjv713dvyo10ry4wmyrdi0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste à insérer le code et à sauvegarder le lambda.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-string">"""Parsing the stream and inserting into the DynamoDB table."""</span>
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> decimal <span class="hljs-keyword">import</span> Decimal<font></font>
<font></font>
DYNAMO_DB = boto3.resource(<span class="hljs-string">'dynamodb'</span>)<font></font>
TABLE_NAME = <span class="hljs-string">'airline_tickets'</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsParser</span>:</span>
    <span class="hljs-string">"""Parsing info from the Stream."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, table_name, records</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.table = DYNAMO_DB.Table(table_name)<font></font>
        self.json_data = TicketsParser.get_json_data(records)<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_json_data</span>(<span class="hljs-params">records</span>):</span>
        <span class="hljs-string">"""Return deserialized data from the stream."""</span>
        decoded_record_data = ([base64.b64decode(record[<span class="hljs-string">'kinesis'</span>][<span class="hljs-string">'data'</span>])
                                <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> records])<font></font>
        json_data = ([json.loads(decoded_record)<font></font>
                      <span class="hljs-keyword">for</span> decoded_record <span class="hljs-keyword">in</span> decoded_record_data])
        <span class="hljs-keyword">return</span> json_data<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_item_from_json</span>(<span class="hljs-params">json_item</span>):</span>
        <span class="hljs-string">"""Pre-process the json data."""</span><font></font>
        new_item = {<font></font>
            <span class="hljs-string">'record_id'</span>: json_item.get(<span class="hljs-string">'record_id'</span>),
            <span class="hljs-string">'cost'</span>: Decimal(json_item.get(<span class="hljs-string">'cost'</span>)),
            <span class="hljs-string">'trip_class'</span>: json_item.get(<span class="hljs-string">'trip_class'</span>),
            <span class="hljs-string">'show_to_affiliates'</span>: json_item.get(<span class="hljs-string">'show_to_affiliates'</span>),
            <span class="hljs-string">'origin'</span>: json_item.get(<span class="hljs-string">'origin'</span>),
            <span class="hljs-string">'number_of_changes'</span>: int(json_item.get(<span class="hljs-string">'number_of_changes'</span>)),
            <span class="hljs-string">'gate'</span>: json_item.get(<span class="hljs-string">'gate'</span>),
            <span class="hljs-string">'found_at'</span>: json_item.get(<span class="hljs-string">'found_at'</span>),
            <span class="hljs-string">'duration'</span>: int(json_item.get(<span class="hljs-string">'duration'</span>)),
            <span class="hljs-string">'distance'</span>: int(json_item.get(<span class="hljs-string">'distance'</span>)),
            <span class="hljs-string">'destination'</span>: json_item.get(<span class="hljs-string">'destination'</span>),
            <span class="hljs-string">'depart_date'</span>: json_item.get(<span class="hljs-string">'depart_date'</span>),
            <span class="hljs-string">'actual'</span>: json_item.get(<span class="hljs-string">'actual'</span>)<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> new_item<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">"""Batch insert into the table."""</span>
        <span class="hljs-keyword">with</span> self.table.batch_writer() <span class="hljs-keyword">as</span> batch_writer:
            <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.json_data:<font></font>
                dynamodb_item = TicketsParser.get_item_from_json(item)<font></font>
                batch_writer.put_item(dynamodb_item)<font></font>
<font></font>
        print(<span class="hljs-string">'Has been added '</span>, len(self.json_data), <span class="hljs-string">'items'</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-string">"""Parse the stream and insert into the DynamoDB table."""</span>
    print(<span class="hljs-string">'Got event:'</span>, event)<font></font>
    parser = TicketsParser(TABLE_NAME, event[<span class="hljs-string">'Records'</span>])<font></font>
    parser.run()<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Création d'un notificateur de fonction lambda</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxième fonction lambda, qui surveillera le deuxième flux (flux_ spécial) et enverra une notification à SNS, est créée de la même manière. </font><font style="vertical-align: inherit;">Par conséquent, ce lambda doit avoir un accès en lecture depuis Kinesis et envoyer des messages à la rubrique SNS spécifiée, qui est ensuite envoyée par le service SNS à tous les abonnés de cette rubrique (e-mail, SMS, etc.).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créer des rôles IAM</font></font></b>
                        <div class="spoiler_text">  IAM  Lambda-KinesisAlarm   ,         alarm_notifier:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zm/fn/ru/zmfnru75p-tp0y1fqzxaoea2xos.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yp/vp/u0/ypvpu0jl74aak54hl-d4wf7r1kc.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce lambda devrait fonctionner en fonction du déclencheur pour que de nouvelles entrées entrent dans le flux spécial, vous devez donc configurer le déclencheur de la même manière que nous l'avons fait pour le lambda Collector. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour la commodité de la configuration de cette lambda, nous introduisons une nouvelle variable d'environnement - TOPIC_ARN, où nous plaçons le sujet ANR (Amazon Recourse Names) de Airlines:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/43/nn/qf/43nnqfmsnahbfu30k5mqadhbuhi.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et insérez le code lambda, c'est très simple:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> os<font></font>
<font></font>
SNS_CLIENT = boto3.client(<span class="hljs-string">'sns'</span>)<font></font>
TOPIC_ARN = os.environ[<span class="hljs-string">'TOPIC_ARN'</span>]<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-keyword">try</span>:<font></font>
        SNS_CLIENT.publish(TopicArn=TOPIC_ARN,<font></font>
                           Message=<span class="hljs-string">'Hi! I have found an interesting stuff!'</span>,<font></font>
                           Subject=<span class="hljs-string">'Airline tickets alarm'</span>)<font></font>
        print(<span class="hljs-string">'Alarm message has been successfully delivered'</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
        print(<span class="hljs-string">'Delivery failure'</span>, str(err))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semble que cela termine la configuration manuelle du système. </font><font style="vertical-align: inherit;">Il ne reste plus qu'à tester et à s'assurer que nous avons tout configuré correctement.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déployer à partir du code Terraform</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Préparation nécessaire</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un outil open source très pratique pour déployer l'infrastructure à partir du code. </font><font style="vertical-align: inherit;">Il a sa propre syntaxe qui est facile à apprendre et de nombreux exemples de comment et quoi déployer. </font><font style="vertical-align: inherit;">Il existe de nombreux plugins pratiques dans l'éditeur de code Atom ou Visual Studio qui facilitent le travail avec Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez télécharger le kit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> distribution </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ici</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Une analyse détaillée de toutes les fonctionnalités de Terraform dépasse le cadre de cet article, nous nous limiterons donc aux points principaux.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment commencer</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code de projet complet est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans mon référentiel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous clonons un référentiel pour nous-mêmes. </font><font style="vertical-align: inherit;">Avant de commencer, vous devez vous assurer que vous avez installé et configuré l'AWS CLI, comme </font><font style="vertical-align: inherit;">Terraform recherchera les informations d'identification dans le fichier ~ / .aws / credentials. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est recommandé de déployer l'intégralité de l'infrastructure avant de lancer la commande plan pour voir ce que Terraform crée pour nous dans le cloud:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe plan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous serez invité à entrer un numéro de téléphone pour lui envoyer des notifications. </font><font style="vertical-align: inherit;">À ce stade, il est facultatif.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/e3/-i/ps/e3-ipsgvy03inzbw_26haktayk4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après avoir analysé le plan de travail du programme, nous pouvons commencer la création de ressources:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe apply</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après l'envoi de cette commande, il vous sera à nouveau demandé de saisir un numéro de téléphone, tapez «oui» lorsque la question sur l'exécution réelle des actions s'affiche. </font><font style="vertical-align: inherit;">Cela vous permettra d'augmenter l'ensemble de l'infrastructure, d'effectuer tous les réglages nécessaires pour EC2, de déployer des fonctions lambda, etc. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois que toutes les ressources ont été créées avec succès via le code Terraform, vous devez entrer dans les détails de l'application Kinesis Analytics (malheureusement, je n'ai pas trouvé comment le faire directement à partir du code). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lancez l'application:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/ns/qc/qxnsqcjpbkiaradzqomahtxzhnu.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après cela, vous devez définir explicitement le nom du flux dans l'application en choisissant dans la liste déroulante:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ki/m5/pl/kim5plwariaz8bp-qo-qonli4yu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hg/69/kf/hg69kfwwtwhwkzxlpnb7g3k2ctm.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, tout est prêt.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test d'application</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelle que soit la façon dont vous avez déployé le système, manuellement ou via le code Terraform, il fonctionnera de la même manière. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous passons par SSH à la machine virtuelle EC2 où Kinesis Agent est installé et exécutons le script api_caller.py</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reste à attendre un SMS sur votre numéro: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/98/ui/mc/98uimcirxv_n6pglm2qz5jtkvf4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SMS - le message arrive sur le téléphone en presque 1 minute: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kg/u7/dj/kgu7djc9xgex84h349dlpfukivg.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il reste à voir si les enregistrements sont sauvegardés dans la base de données DynamoDB pour une analyse ultérieure plus détaillée. </font><font style="vertical-align: inherit;">Le tableau des billets d'avion contient quelque chose comme ceci:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/dj/vc/gqdjvcmx0q45o_sgqc_l5po_l-c.jpeg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au cours du travail effectué, un système de traitement des données en ligne basé sur Amazon Kinesis a été construit. </font><font style="vertical-align: inherit;">Nous avons examiné les options d'utilisation de Kinesis Agent en conjonction avec Kinesis Data Streams et l'analyse en temps réel de Kinesis Analytics à l'aide de commandes SQL, ainsi que l'interaction d'Amazon Kinesis avec d'autres services AWS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons déployé le système ci-dessus de deux manières: suffisamment longue et manuelle à partir du code Terraform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'intégralité du code source du projet est disponible </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans mon référentiel sur GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , je vous suggère de vous familiariser avec celui-ci. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je suis prêt à discuter de l'article avec plaisir, j'attends vos commentaires. </font><font style="vertical-align: inherit;">J'espère des critiques constructives. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Te souhaite du succès!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr500364/index.html">Extension du portail d'apprentissage scolaire sur Moodle et BigBlueButton</a></li>
<li><a href="../fr500368/index.html">Générer des séquences aléatoires prévisibles: une approche différente de la permutation</a></li>
<li><a href="../fr500370/index.html">10 podcasts en anglais utiles pour les programmeurs qui méritent d'être abonnés en 2020</a></li>
<li><a href="../fr500378/index.html">Recherche d'informations efficace au travail</a></li>
<li><a href="../fr500380/index.html">Traitement à distance des données personnelles: risques et conséquences possibles</a></li>
<li><a href="../fr500384/index.html">Pixar Studio Pioneers a reçu le prix Turing et 1 million de dollars</a></li>
<li><a href="../fr500386/index.html">Adapter votre solution commerciale existante pour SwiftUI. Partie 2</a></li>
<li><a href="../fr500390/index.html">Modèles réels de localisation linguistique dans le domaine de l'informatique et des communications numériques. Partie 1</a></li>
<li><a href="../fr500396/index.html">Problèmes des systèmes de contrôle d'accès autonomes - Où ils ne s'attendaient pas</a></li>
<li><a href="../fr500398/index.html">Remote Marathon Week 3: Processus inopérants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>