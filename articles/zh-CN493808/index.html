<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ‘©ğŸ» ğŸ¡ ğŸ” ç”¨corutinçº¿æ€§åŒ–å¼‚æ­¥ä»£ç  ğŸ§  ğŸŒ‹ ğŸ†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="é™¤äº†ä½¿ç”¨åç¨‹åˆ›å»ºç”Ÿæˆå™¨ä¹‹å¤–ï¼Œæ‚¨è¿˜å¯ä»¥å°è¯•ä½¿ç”¨å®ƒä»¬æ¥çº¿æ€§åŒ–ç°æœ‰çš„å¼‚æ­¥ä»£ç ã€‚è®©æˆ‘ä»¬å°è¯•é€šè¿‡ä¸€ä¸ªå°ä¾‹å­æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚é‡‡å–åœ¨actoræ¡†æ¶ä¸Šç¼–å†™çš„ä»£ç ï¼Œå¹¶åœ¨åç¨‹ä¸Šé‡å†™æ­¤ä»£ç çš„ä¸€ä¸ªåŠŸèƒ½ã€‚ä¸ºäº†æ„å»ºé¡¹ç›®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ªcoroutinesåˆ†æ”¯çš„gcc ã€‚
 
 æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä»é¢æ¡ä¸­è·å–å›è°ƒï¼š
 
 

 abAc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ç”¨corutinçº¿æ€§åŒ–å¼‚æ­¥ä»£ç </h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493808/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/98e/c7c/314/98ec7c314c49b57c2d8af8d53508b211.jpg" alt="å›¾ç‰‡"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é™¤äº†ä½¿ç”¨åç¨‹åˆ›å»ºç”Ÿæˆå™¨ä¹‹å¤–ï¼Œæ‚¨è¿˜å¯ä»¥å°è¯•ä½¿ç”¨å®ƒä»¬æ¥çº¿æ€§åŒ–ç°æœ‰çš„å¼‚æ­¥ä»£ç ã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬å°è¯•é€šè¿‡ä¸€ä¸ªå°ä¾‹å­æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</font><font style="vertical-align: inherit;">é‡‡å–åœ¨actoræ¡†æ¶ä¸Šç¼–å†™çš„ä»£ç ï¼Œå¹¶åœ¨åç¨‹ä¸Šé‡å†™æ­¤ä»£ç çš„ä¸€ä¸ªåŠŸèƒ½ã€‚</font><font style="vertical-align: inherit;">ä¸ºäº†æ„å»ºé¡¹ç›®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ª</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">coroutines</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ†æ”¯çš„gcc </font><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä»é¢æ¡ä¸­è·å–å›è°ƒï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">    abActor.getA(ABActor::GetACallback([<span class="hljs-keyword">this</span>](<span class="hljs-keyword">int</span> a) {<font></font>
        abActor.getB(ABActor::GetBCallback([a, <span class="hljs-keyword">this</span>](<span class="hljs-keyword">int</span> b) {<font></font>
            abActor.saveAB(a - b, a + b, ABActor::SaveABCallback([<span class="hljs-keyword">this</span>](){<font></font>
                abActor.getA(ABActor::GetACallback([<span class="hljs-keyword">this</span>](<span class="hljs-keyword">int</span> a) {<font></font>
                    abActor.getB(ABActor::GetBCallback([a, <span class="hljs-keyword">this</span>](<span class="hljs-keyword">int</span> b) {
                        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Result "</span> &lt;&lt; a &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; b &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
                    }));<font></font>
                }));<font></font>
            }));<font></font>
        }));<font></font>
    }));<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ‰ç‚¹ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> a = <span class="hljs-keyword">co_await</span> actor.abActor.getAAsync();
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> b = <span class="hljs-keyword">co_await</span> actor.abActor.getBAsync();
<span class="hljs-keyword">co_await</span> actor.abActor.saveABAsync(a - b, a + b);
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> newA = <span class="hljs-keyword">co_await</span> actor.abActor.getAAsync();
<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> newB = <span class="hljs-keyword">co_await</span> actor.abActor.getBAsync();
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Result "</span> &lt;&lt; newA &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; newB &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ¼”å‘˜ä»¬</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç®€å•çš„å‚ä¸è€…æ¡†æ¶ã€‚</font><font style="vertical-align: inherit;">åˆ›å»ºä¸€ä¸ªæˆç†Ÿçš„actoræ¡†æ¶æ˜¯ä¸€é¡¹è‰°å·¨è€Œè‰°å·¨çš„ä»»åŠ¡ï¼Œå› æ­¤æˆ‘ä»¬åªå®ç°å…¶ä¸­çš„ä¸€ç§ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªåŸºç±»ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Actor</span> {</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">using</span> Task = <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-keyword">void</span>()&gt;;
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">virtual</span> ~Actor();
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addTask</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Task &amp;task)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">tryRunTask</span><span class="hljs-params">()</span></span>;
<span class="hljs-keyword">private</span>:
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">queue</span>&lt;Task&gt; <span class="hljs-built_in">queue</span>;
    <span class="hljs-keyword">mutable</span> <span class="hljs-built_in">std</span>::mutex mutex;<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™ä¸ªæƒ³æ³•åŸºæœ¬ä¸Šå¾ˆç®€å•ï¼šå°†ä½œä¸ºåŠŸèƒ½å¯¹è±¡çš„ä»»åŠ¡æ”¾åœ¨é˜Ÿåˆ—ä¸­ï¼Œå½“æˆ‘ä»¬å°è¯•è¿è¡Œä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬å°è¯•å®Œæˆæ­¤ä»»åŠ¡ã€‚</font><font style="vertical-align: inherit;">è¯¥ç±»çš„å®ç°ç¡®è®¤äº†æˆ‘ä»¬çš„æ„å›¾ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">Actor::~Actor() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Actor::addTask</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Task &amp;task)</span> </span>{
    <span class="hljs-function"><span class="hljs-built_in">std</span>::lock_guard <span class="hljs-title">lock</span><span class="hljs-params">(mutex)</span></span>;
    <span class="hljs-built_in">queue</span>.push(task);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Actor::tryRunTask</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function"><span class="hljs-built_in">std</span>::unique_lock <span class="hljs-title">lock</span><span class="hljs-params">(mutex)</span></span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">queue</span>.empty()) {
        <span class="hljs-keyword">return</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">const</span> Task task = <span class="hljs-built_in">queue</span>.front();
    <span class="hljs-built_in">queue</span>.pop();<font></font>
    lock.unlock();<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::invoke(task);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸‹ä¸€ä¸ªç±»æ˜¯æˆ‘ä»¬çš„å‚ä¸è€…å°†æ‰€å±çš„â€œçº¿ç¨‹â€ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Actor</span>;</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ActorThread</span> {</span>
<span class="hljs-keyword">public</span>:<font></font>
    ~ActorThread();<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addActor</span><span class="hljs-params">(Actor &amp;actor)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>;
<span class="hljs-keyword">private</span>:
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-built_in">std</span>::reference_wrapper&lt;Actor&gt;&gt; actors;<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™é‡Œçš„ä¸€åˆ‡ä¹Ÿå¾ˆç®€å•ï¼šåœ¨ç¨‹åºçš„æœ€å¼€å§‹ï¼Œæˆ‘ä»¬ä½¿ç”¨addActoræ–¹æ³•å°†actorâ€œç»‘å®šâ€åˆ°çº¿ç¨‹ï¼Œç„¶åä½¿ç”¨runæ–¹æ³•å¯åŠ¨çº¿ç¨‹ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs">ActorThread::~ActorThread() = <span class="hljs-keyword">default</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ActorThread::addActor</span><span class="hljs-params">(Actor &amp;actor)</span> </span>{<font></font>
    actors.emplace_back(actor);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ActorThread::run</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">for</span> (Actor &amp;actor: actors) {<font></font>
            actor.tryRunTask();<font></font>
        }<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¯åŠ¨çº¿ç¨‹æ—¶ï¼Œæˆ‘ä»¬è¿›å…¥æ— é™å¾ªç¯ï¼Œå¹¶å°è¯•ä»æ¯ä¸ªå‚ä¸è€…æ‰§è¡Œä¸€é¡¹ä»»åŠ¡ã€‚</font><font style="vertical-align: inherit;">è¿™ä¸æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä½†å¯ä»¥ç”¨äºæ¼”ç¤ºã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ¼”å‘˜ç±»çš„ä»£è¡¨ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABActor</span>:</span> <span class="hljs-keyword">public</span> Actor {
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">using</span> GetACallback = Callback&lt;<span class="hljs-keyword">void</span>(<span class="hljs-keyword">int</span> result)&gt;;
    <span class="hljs-keyword">using</span> GetBCallback = Callback&lt;<span class="hljs-keyword">void</span>(<span class="hljs-keyword">int</span> result)&gt;;
    <span class="hljs-keyword">using</span> SaveABCallback = Callback&lt;<span class="hljs-keyword">void</span>()&gt;;
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getA</span><span class="hljs-params">(<span class="hljs-keyword">const</span> GetACallback &amp;callback)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getB</span><span class="hljs-params">(<span class="hljs-keyword">const</span> GetBCallback &amp;callback)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveAB</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">const</span> SaveABCallback &amp;callback)</span></span>;
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getAProcess</span><span class="hljs-params">(<span class="hljs-keyword">const</span> GetACallback &amp;callback)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getBProcess</span><span class="hljs-params">(<span class="hljs-keyword">const</span> GetBCallback &amp;callback)</span></span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">saveABProcess</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">const</span> SaveABCallback &amp;callback)</span></span>;
<span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">int</span> a = <span class="hljs-number">10</span>;
    <span class="hljs-keyword">int</span> b = <span class="hljs-number">20</span>;<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ­¤ç±»æœ¬èº«å­˜å‚¨2ä¸ªæ•°å­—-aå’Œbï¼Œå¹¶æ ¹æ®è¦æ±‚è¿”å›å…¶å€¼æˆ–è¦†ç›–å®ƒä»¬ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½œä¸ºå›è°ƒï¼Œå®ƒæ¥å—å¸¦æœ‰å¿…éœ€å‚æ•°çš„åŠŸèƒ½å¯¹è±¡ã€‚</font><font style="vertical-align: inherit;">ä½†æ˜¯ï¼Œè¯·æ³¨æ„ä¸€ä¸ªäº‹å®ï¼Œå³ä¸åŒçš„å‚ä¸è€…å¯ä»¥åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å¯åŠ¨ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œå¦‚æœåœ¨å·¥ä½œç»“æŸæ—¶æˆ‘ä»¬ä»…è°ƒç”¨ä¼ é€’ç»™è¯¥æ–¹æ³•çš„å›è°ƒï¼Œåˆ™å°†åœ¨å½“å‰çš„å¯æ‰§è¡Œçº¿ç¨‹ä¸­è°ƒç”¨æ­¤å›è°ƒï¼Œè€Œä¸æ˜¯åœ¨è°ƒç”¨æˆ‘ä»¬çš„æ–¹æ³•å¹¶åˆ›å»ºäº†æ­¤å›è°ƒçš„çº¿ç¨‹ä¸­è°ƒç”¨æ­¤å›è°ƒã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å›è°ƒä¸Šåˆ›å»ºä¸€ä¸ªåŒ…è£…å™¨ï¼Œä»¥è§£å†³è¿™ç§æƒ…å†µï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> C&gt;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Callback</span> {</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> Functor&gt;
    <span class="hljs-title">Callback</span><span class="hljs-params">(Actor &amp;sender, <span class="hljs-keyword">const</span> Functor &amp;callback)</span>
        : <span class="hljs-title">sender</span><span class="hljs-params">(sender)</span>
        , <span class="hljs-title">callback</span><span class="hljs-params">(callback)</span>
    </span>{}
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> ...Args&gt;
    <span class="hljs-keyword">void</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span> <span class="hljs-params">(Args&amp;&amp; ...args)</span> <span class="hljs-keyword">const</span> </span>{<font></font>
        sender.addTask(<span class="hljs-built_in">std</span>::bind(callback, <span class="hljs-built_in">std</span>::forward&lt;Args&gt;(args)...));<font></font>
    }<font></font>
<span class="hljs-keyword">private</span>:<font></font>
    Actor &amp;sender;<font></font>
    <span class="hljs-built_in">std</span>::function&lt;C&gt; callback;<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¯¥åŒ…è£…å™¨ä¼šè®°ä½åŸå§‹çš„actorï¼Œå¹¶ä¸”å½“æ‚¨å°è¯•æ‰§è¡Œè‡ªå·±æ—¶ï¼Œå®ƒåªä¼šå‘åŸå§‹actorçš„ä»»åŠ¡é˜Ÿåˆ—ä¸­æ·»åŠ çœŸæ­£çš„å›è°ƒã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç»“æœï¼ŒABActorç±»çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ABActor::getA</span><span class="hljs-params">(<span class="hljs-keyword">const</span> GetACallback &amp;callback)</span> </span>{<font></font>
    addTask(<span class="hljs-built_in">std</span>::bind(&amp;ABActor::getAProcess, <span class="hljs-keyword">this</span>, callback));<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ABActor::getAProcess</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ABActor::GetACallback &amp;callback)</span> </span>{
    <span class="hljs-built_in">std</span>::invoke(callback, a);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ABActor::getB</span><span class="hljs-params">(<span class="hljs-keyword">const</span> GetBCallback &amp;callback)</span> </span>{<font></font>
    addTask(<span class="hljs-built_in">std</span>::bind(&amp;ABActor::getBProcess, <span class="hljs-keyword">this</span>, callback));<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ABActor::getBProcess</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ABActor::GetBCallback &amp;callback)</span> </span>{
    <span class="hljs-built_in">std</span>::invoke(callback, b);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ABActor::saveAB</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">const</span> SaveABCallback &amp;callback)</span> </span>{<font></font>
    addTask(<span class="hljs-built_in">std</span>::bind(&amp;ABActor::saveABProcess, <span class="hljs-keyword">this</span>, a, b, callback));<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ABActor::saveABProcess</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">const</span> ABActor::SaveABCallback &amp;callback)</span> </span>{
    <span class="hljs-keyword">this</span>-&gt;a = a;
    <span class="hljs-keyword">this</span>-&gt;b = b;
    <span class="hljs-built_in">std</span>::invoke(callback);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨ç±»çš„æ¥å£æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä»…å°†ä¼ é€’çš„å‚æ•°ç»‘å®šåˆ°ç±»çš„ç›¸åº”â€œæ’æ§½â€ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶å°†æ­¤ä»»åŠ¡æ”¾å…¥æ­¤ç±»çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚</font><font style="vertical-align: inherit;">å½“ä»»åŠ¡çº¿ç¨‹å¼€å§‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå®ƒå°†å› æ­¤è°ƒç”¨æ­£ç¡®çš„â€œæ’æ§½â€ï¼Œè¯¥æ’æ§½å°†æ‰§è¡Œå…¶æ‰€éœ€çš„æ‰€æœ‰æ“ä½œå¹¶è°ƒç”¨å›è°ƒï¼Œåè€…åˆä¼šå°†çœŸæ­£çš„å›è°ƒå‘é€åˆ°å¯¼è‡´å®ƒçš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå°†ä½¿ç”¨ABActorç±»çš„actorï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABActor</span>;</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WokrerActor</span>:</span> <span class="hljs-keyword">public</span> Actor {
<span class="hljs-keyword">public</span>:<font></font>
    WokrerActor(ABActor &amp;actor)<font></font>
        : abActor(actor)<font></font>
    {}<font></font>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">work</span><span class="hljs-params">()</span></span>;
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">workProcess</span><span class="hljs-params">()</span></span>;
<span class="hljs-keyword">private</span>:<font></font>
    ABActor &amp;abActor;<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">WokrerActor::work</span><span class="hljs-params">()</span> </span>{<font></font>
    addTask(<span class="hljs-built_in">std</span>::bind(&amp;WokrerActor::workProcess, <span class="hljs-keyword">this</span>));<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">WokrerActor::workProcess</span><span class="hljs-params">()</span> </span>{<font></font>
    abActor.getA(ABActor::GetACallback(*<span class="hljs-keyword">this</span>, [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">int</span> a) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Result "</span> &lt;&lt; a &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    }));<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ”¾åœ¨ä¸€èµ·ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<font></font>
    ABActor abActor;<font></font>
    <span class="hljs-function">WokrerActor <span class="hljs-title">workerActor</span><span class="hljs-params">(abActor)</span></span>;<font></font>
<font></font>
    ActorThread thread;<font></font>
    thread.addActor(abActor);<font></font>
    thread.addActor(workerActor);<font></font>
<font></font>
    workerActor.work();<font></font>
<font></font>
    thread.run();<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬å…³æ³¨æ•´ä¸ªä»£ç é“¾ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºå¿…è¦çš„å¯¹è±¡å¹¶åœ¨å®ƒä»¬ä¹‹é—´å»ºç«‹è¿æ¥ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç„¶åï¼Œå°†workProcessä»»åŠ¡æ·»åŠ åˆ°actor Workerä»»åŠ¡é˜Ÿåˆ—ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å½“çº¿ç¨‹å¯åŠ¨æ—¶ï¼Œå®ƒå°†åœ¨é˜Ÿåˆ—ä¸­æ‰¾åˆ°æˆ‘ä»¬çš„ä»»åŠ¡å¹¶å¼€å§‹æ‰§è¡Œå®ƒã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ABActorç±»çš„getAæ–¹æ³•ï¼Œä»è€Œå°†ç›¸åº”çš„ä»»åŠ¡æ”¾å…¥ABActorç±»çš„é˜Ÿåˆ—ä¸­ï¼Œå¹¶å®Œæˆæ‰§è¡Œã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¥ä¸‹æ¥ï¼Œçº¿ç¨‹å°†ä»ABActorç±»ä¸­è·å–æ–°åˆ›å»ºçš„ä»»åŠ¡å¹¶æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œè¿™å°†å¯¼è‡´æ‰§è¡ŒgetAProcessä»£ç ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ­¤ä»£ç å°†è°ƒç”¨å›è°ƒï¼Œå¹¶å°†å¿…è¦çš„å‚æ•°ä¼ é€’ç»™å®ƒ-å˜é‡aã€‚ä½†æ˜¯ï¼Œç”±äºä»–æ‹¥æœ‰çš„å›è°ƒæ˜¯åŒ…è£…å™¨ï¼Œå› æ­¤ï¼Œå®é™…ä¸Šï¼Œå¸¦æœ‰å¡«å……å‚æ•°çš„çœŸå®å›è°ƒå°†æ”¾å…¥Workerç±»çš„é˜Ÿåˆ—ä¸­ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¹¶ä¸”ï¼Œåœ¨è¯¥å¾ªç¯çš„ä¸‹ä¸€ä¸ªè¿­ä»£ä¸­ï¼Œå½“çº¿ç¨‹é€€å‡ºå¹¶ä»Workerç±»æ‰§è¡Œå›è°ƒæ—¶ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°â€œç»“æœ10â€è¡Œçš„è¾“å‡ºã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actoræ¡†æ¶æ˜¯å°†åˆ†æ•£åœ¨ä¸åŒç‰©ç†æµä¸­çš„ç±»ç›¸äº’äº¤äº’çš„ä¸€ç§éå¸¸æ–¹ä¾¿çš„æ–¹æ³•ã€‚æ­£å¦‚æ‚¨åº”è¯¥ç¡®ä¿¡çš„é‚£æ ·ï¼Œç±»è®¾è®¡çš„ç‰¹æ®Šæ€§åœ¨äºï¼Œåœ¨æ¯ä¸ªå•ç‹¬çš„å‚ä¸è€…ä¸­ï¼Œæ‰€æœ‰åŠ¨ä½œéƒ½æ˜¯å®Œå…¨åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚æµçš„å”¯ä¸€åŒæ­¥ç‚¹æ˜¯åœ¨actoræ¡†æ¶çš„å®ç°ç»†èŠ‚ä¸­å®Œæˆçš„ï¼Œå¹¶ä¸”å¯¹äºç¨‹åºå‘˜è€Œè¨€æ˜¯ä¸å¯è§çš„ã€‚å› æ­¤ï¼Œç¨‹åºå‘˜å¯ä»¥ç¼–å†™å•çº¿ç¨‹ä»£ç ï¼Œè€Œä¸å¿…æ‹…å¿ƒåŒ…è£…äº’æ–¥ä½“å¹¶è·Ÿè¸ªç«äº‰æƒ…å†µï¼Œæ­»é”å’Œå…¶ä»–éº»çƒ¦ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç§è§£å†³æ–¹æ¡ˆæ˜¯æœ‰ä»£ä»·çš„ã€‚ç”±äºåªèƒ½ä»å›è°ƒä¸­è®¿é—®æ‰§è¡Œå¦ä¸€ä¸ªactorçš„ç»“æœï¼Œå› æ­¤actorä»£ç è¿Ÿæ—©ä¼šå˜æˆå¦‚ä¸‹æ‰€ç¤ºï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">    abActor.getA(ABActor::GetACallback(*<span class="hljs-keyword">this</span>, [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">int</span> a) {<font></font>
        abActor.getB(ABActor::GetBCallback(*<span class="hljs-keyword">this</span>, [a, <span class="hljs-keyword">this</span>](<span class="hljs-keyword">int</span> b) {<font></font>
            abActor.saveAB(a - b, a + b, ABActor::SaveABCallback(*<span class="hljs-keyword">this</span>, [<span class="hljs-keyword">this</span>](){<font></font>
                abActor.getA(ABActor::GetACallback(*<span class="hljs-keyword">this</span>, [<span class="hljs-keyword">this</span>](<span class="hljs-keyword">int</span> a) {<font></font>
                    abActor.getB(ABActor::GetBCallback(*<span class="hljs-keyword">this</span>, [a, <span class="hljs-keyword">this</span>](<span class="hljs-keyword">int</span> b) {
                        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Result "</span> &lt;&lt; a &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; b &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
                    }));<font></font>
                }));<font></font>
            }));<font></font>
        }));<font></font>
    }));<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦å¯ä»¥ä½¿ç”¨C ++ 20çš„åˆ›æ–°-åç¨‹é¿å…è¿™ç§æƒ…å†µã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†æ˜¯é¦–å…ˆï¼Œæˆ‘ä»¬å°†æŒ‡å®šé™åˆ¶ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è‡ªç„¶ï¼Œæˆ‘ä»¬ç»ä¸èƒ½æ›´æ”¹å‚ä¸è€…æ¡†æ¶çš„ä»£ç ã€‚</font><font style="vertical-align: inherit;">åŒæ ·ï¼Œæˆ‘ä»¬ä¸èƒ½æ›´æ”¹Actorç±»å®ä¾‹çš„å…¬å…±å’Œç§æœ‰æ–¹æ³•çš„ç­¾å-ABActorå’ŒWorkerActorã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦å¯ä»¥æ‘†è„±è¿™ç§æƒ…å†µã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åç¨‹ã€‚</font><font style="vertical-align: inherit;">ç¬¬1éƒ¨åˆ†ã€‚æœåŠ¡å‘˜</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
corutinçš„ä¸»è¦æ€æƒ³æ˜¯åœ¨åˆ›å»ºåç¨‹æ—¶ï¼Œä¼šåœ¨å †ä¸Šä¸ºå…¶åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å †æ ˆæ¡†æ¶ï¼Œæˆ‘ä»¬å¯ä»¥éšæ—¶ä»ä¸­é€€å‡ºï¼ŒåŒæ—¶ä¿æŒå½“å‰çš„æ‰§è¡Œä½ç½®ï¼Œå¤„ç†å™¨å¯„å­˜å™¨å’Œå…¶ä»–å¿…è¦ä¿¡æ¯ã€‚ç„¶åï¼Œæˆ‘ä»¬è¿˜å¯ä»¥éšæ—¶è¿”å›æš‚åœçš„åç¨‹çš„æ‰§è¡Œå¹¶å®Œæˆå®ƒï¼Œç›´åˆ°ç»“æŸæˆ–ä¸‹ä¸€æ¬¡æš‚åœä¸ºæ­¢ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
std :: coroutine_handle &lt;&gt;å¯¹è±¡è´Ÿè´£ç®¡ç†æ­¤æ•°æ®ï¼Œè¯¥æ•°æ®æœ¬è´¨ä¸Šè¡¨ç¤ºä¸€ä¸ªæŒ‡å‘å †æ ˆæ¡†æ¶çš„æŒ‡é’ˆï¼ˆå’Œå…¶ä»–å¿…è¦çš„æ•°æ®ï¼‰ï¼Œå¹¶å…·æœ‰ä¸€ä¸ªresumeæ–¹æ³•ï¼ˆæˆ–å…¶ç±»ä¼¼ç‰©ï¼Œè¿ç®—ç¬¦ï¼ˆï¼‰ï¼‰ï¼Œå¯å°†æˆ‘ä»¬è¿”å›åˆ°åç¨‹çš„æ‰§è¡Œã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åŸºäºæ­¤æ•°æ®ï¼Œæˆ‘ä»¬é¦–å…ˆç¼–å†™getAAsyncå‡½æ•°ï¼Œç„¶åå°è¯•è¿›è¡Œæ¦‚æ‹¬ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œå‡è®¾æˆ‘ä»¬å·²ç»æœ‰std :: coroutine_handle &lt;&gt; coroç±»çš„å®ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦åšä»€ä¹ˆï¼Ÿ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨å¿…é¡»è°ƒç”¨å·²ç»å­˜åœ¨çš„æ–¹æ³•ABActor :: getAï¼Œå®ƒå°†æ ¹æ®éœ€è¦è§£å†³æ­¤æƒ…å†µï¼Œä½†æ˜¯é¦–å…ˆæ‚¨éœ€è¦ä¸ºgetAæ–¹æ³•åˆ›å»ºä¸€ä¸ªå›è°ƒã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬å›æƒ³ä¸€ä¸‹ï¼Œå›è°ƒå·²è¿”å›åˆ°getAæ–¹æ³•å›è°ƒ-getAæ–¹æ³•çš„ç»“æœã€‚æ­¤å¤–ï¼Œæ­¤å›è°ƒåœ¨çº¿ç¨‹çš„å·¥ä½œçº¿ç¨‹ä¸­è°ƒç”¨ã€‚å› æ­¤ï¼Œä»æ­¤å›è°ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°ç»§ç»­æ‰§è¡Œåç¨‹ï¼Œåç¨‹ä»…ç”±Workerçº¿ç¨‹åˆ›å»ºï¼Œå¹¶å°†ç»§ç»­æ‰§è¡Œå…¶åŠ¨ä½œåºåˆ—ã€‚è€Œä¸”ï¼Œæˆ‘ä»¬å¿…é¡»å°†è¿”å›çš„ç»“æœä¿å­˜åœ¨æŸä¸ªåœ°æ–¹ï¼Œè¿™å½“ç„¶å¯¹æˆ‘ä»¬è¿›ä¸€æ­¥æœ‰ç”¨ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">auto</span> callback = GetACallback(returnCallbackActor, [&amp;value, coro](<span class="hljs-keyword">int</span> result) {<font></font>
        value = result;<font></font>
        <span class="hljs-built_in">std</span>::invoke(coro);<font></font>
 });<font></font>
getA(callback);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œç°åœ¨æ‚¨éœ€è¦ä»æŸä¸ªåœ°æ–¹è·å–ä¸€ä¸ªcoroutine_handleå¯¹è±¡çš„å®ä¾‹ä»¥åŠä¸€ä¸ªå¯ä»¥ä¿å­˜æˆ‘ä»¬çš„ç»“æœçš„é“¾æ¥ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å°†æ¥ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°è°ƒç”¨è¯¥å‡½æ•°å°†coroutine_handleä¼ é€’ç»™æˆ‘ä»¬ã€‚</font><font style="vertical-align: inherit;">å› æ­¤ï¼Œæˆ‘ä»¬æ‰€èƒ½åšçš„å°±æ˜¯å°†å…¶ä¼ é€’ç»™å…¶ä»–å‡½æ•°ã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬å°†æ­¤å‡½æ•°å‡†å¤‡ä¸ºlambdaã€‚</font><font style="vertical-align: inherit;">ï¼ˆæˆ‘ä»¬ä¼šå°†é“¾æ¥ä¼ é€’ç»™å˜é‡ï¼Œåœ¨è¯¥å˜é‡ä¸­å›è°ƒçš„ç»“æœå°†å­˜å‚¨åˆ°å…¬å¸ï¼‰ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">auto</span> storeCoroToQueue = [&amp;returnCallbackActor, <span class="hljs-keyword">this</span>](<span class="hljs-keyword">auto</span> &amp;value, <span class="hljs-built_in">std</span>::coroutine_handle&lt;&gt; coro) {
    <span class="hljs-keyword">auto</span> callback=GetACallback(returnCallbackActor, [&amp;value, coro](<span class="hljs-keyword">int</span> result){<font></font>
        value = result;<font></font>
        <span class="hljs-built_in">std</span>::invoke(coro);<font></font>
    });<font></font>
    getA(callback);<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€ä¸ªç±»ä¸­ä¿å­˜æ­¤å‡½æ•°ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ActorAwaiterSimple</span> {</span>
    <span class="hljs-keyword">int</span> value;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-keyword">void</span>(<span class="hljs-keyword">int</span> &amp;value,<span class="hljs-built_in">std</span>::coroutine_handle&lt;&gt;)&gt; forwardCoroToCallback;<font></font>
<font></font>
    ActorAwaiterSimple(<font></font>
        <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-keyword">void</span>(<span class="hljs-keyword">int</span> &amp;value, <span class="hljs-built_in">std</span>::coroutine_handle&lt;&gt;)&gt; &amp;forwardCoroToCallback<font></font>
    )<font></font>
        : forwardCoroToCallback(forwardCoroToCallback)<font></font>
    {}<font></font>
<font></font>
    ActorAwaiterSimple(<span class="hljs-keyword">const</span> ActorAwaiterSimple &amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ActorAwaiterSimple&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-keyword">const</span> ActorAwaiterSimple &amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ActorAwaiterSimple(ActorAwaiterSimple &amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ActorAwaiterSimple&amp; <span class="hljs-keyword">operator</span>=(ActorAwaiterSimple &amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
<font></font>
<span class="hljs-comment">// ...</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é™¤äº†åŠŸèƒ½å¯¹è±¡å¤–ï¼Œæˆ‘ä»¬è¿˜å°†åœ¨è¿™é‡Œä¿å­˜å›è°ƒä¸­ç­‰å¾…æˆ‘ä»¬ä½¿ç”¨çš„å€¼çš„å†…å­˜ï¼ˆä»¥å˜é‡å€¼çš„å½¢å¼ï¼‰ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç”±äºæˆ‘ä»¬å°†å†…å­˜ä¿ç•™åœ¨æ­¤å¤„çš„å€¼ä¸‹ï¼Œå› æ­¤æˆ‘ä»¬å‡ ä¹ä¸å¸Œæœ›å°†è¯¥ç±»çš„å®ä¾‹å¤åˆ¶æˆ–ç§»åŠ¨åˆ°æŸä¸ªä½ç½®ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œä¾‹å¦‚ï¼Œæœ‰äººå¤åˆ¶äº†è¯¥ç±»ï¼Œå°†å€¼ä¿å­˜åœ¨è¯¥ç±»çš„æ—§å®ä¾‹ä¸­çš„valueå˜é‡ä¸‹ï¼Œç„¶åå°è¯•ä»æ–°å®ä¾‹ä¸­è¯»å–å®ƒã€‚å®ƒè‡ªç„¶ä¸å­˜åœ¨ï¼Œå› ä¸ºå¤åˆ¶æ˜¯åœ¨ä¿å­˜ä¹‹å‰è¿›è¡Œçš„ã€‚ä¸æ„‰å¿«ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é€šè¿‡ç¦æ­¢æ„é€ å‡½æ•°ä»¥åŠå¤åˆ¶å’Œç§»åŠ¨è¿ç®—ç¬¦æ¥ä¿æŠ¤è‡ªå·±å…å—æ­¤éº»çƒ¦ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬ç»§ç»­å†™è¿™ä¸ªè¯¾ã€‚æˆ‘ä»¬éœ€è¦çš„ä¸‹ä¸€ä¸ªæ–¹æ³•æ˜¯ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">await_ready</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">noexcept</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»–å›ç­”äº†æˆ‘ä»¬çš„æ„æ€æ˜¯å¦å‡†å¤‡å‘å¸ƒçš„é—®é¢˜ã€‚</font><font style="vertical-align: inherit;">è‡ªç„¶ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬çš„ä»·å€¼å°šæœªå‡†å¤‡å¥½ï¼Œå°†æ¥æ²¡æœ‰äººä¼šé—®æˆ‘ä»¬è¿™ä¸ªé—®é¢˜ï¼Œå› æ­¤åªéœ€è¿”å›falseã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
coroutine_handleå®ä¾‹å°†é€šè¿‡void await_suspendæ–¹æ³•ï¼ˆstd :: coroutine_handle &lt;&gt; coroï¼‰ä¼ é€’ç»™æˆ‘ä»¬ï¼Œå› æ­¤è®©æˆ‘ä»¬åœ¨å…¶ä¸­è°ƒç”¨æˆ‘ä»¬å‡†å¤‡å¥½çš„å‡½å­ï¼Œå¹¶åœ¨å€¼ä¸‹é¢ä¼ é€’ä¸€ä¸ªå†…å­˜é“¾æ¥ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">await_suspend</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::coroutine_handle&lt;&gt; coro)</span> <span class="hljs-keyword">noexcept</span> </span>{
        <span class="hljs-built_in">std</span>::invoke(forwardCoroToCallback, <span class="hljs-built_in">std</span>::ref(value), coro);<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é€šè¿‡è°ƒç”¨await_resumeæ–¹æ³•ï¼Œå°†åœ¨æ­£ç¡®çš„æ—¶é—´è¯¢é—®å‡½æ•°æ‰§è¡Œçš„ç»“æœã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬ä¸ä¼šæ‹’ç»è¯·æ±‚è€…ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">await_resume</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>{
        <span class="hljs-keyword">return</span> value;<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œå¯ä»¥ä½¿ç”¨co_awaitå…³é”®å­—è°ƒç”¨æˆ‘ä»¬çš„æ–¹æ³•ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> a = <span class="hljs-keyword">co_await</span> actor.abActor.getAAsync(actor);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™é‡Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Œæˆ‘ä»¬å·²ç»å¤§è‡´ä»£è¡¨äº†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œå°†åˆ›å»ºä¸€ä¸ªç±»å‹ä¸ºActorAwaiterSimpleçš„å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°†è¢«ä¼ è¾“åˆ°co_awaitçš„â€œè¾“å…¥â€ä¸­ã€‚ä»–å°†é¦–å…ˆè¯¢é—®ï¼ˆé€šè¿‡è°ƒç”¨await_readyï¼‰æˆ‘ä»¬æ˜¯å¦æ„å¤–åœ°è·å¾—äº†ä¸€ä¸ªç»“æœï¼ˆæˆ‘ä»¬æ²¡æœ‰ï¼‰ï¼Œç„¶åè°ƒç”¨await_suspendï¼Œä¼ é€’äº†ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼ˆå®é™…ä¸Šæ˜¯æŒ‡å‘å½“å‰åç¨‹å †æ ˆæ¡†æ¶çš„æŒ‡é’ˆï¼‰å¹¶ä¸­æ–­äº†æ‰§è¡Œã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å°†æ¥ï¼Œå½“ABActor actorå®Œæˆå·¥ä½œå¹¶è°ƒç”¨ç»“æœå›è°ƒæ—¶ï¼Œæ­¤ç»“æœï¼ˆå·²åœ¨Workerçº¿ç¨‹çº¿ç¨‹ä¸­ï¼‰å°†ä¿å­˜åœ¨ActorAwaiterSimpleçš„å”¯ä¸€å®ä¾‹ï¼ˆä¿ç•™åœ¨åç¨‹å †æ ˆä¸­ï¼‰ï¼Œå¹¶ä¸”åç¨‹çš„ç»§ç»­å°†å¼€å§‹ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Corutinå°†ç»§ç»­æ‰§è¡Œï¼Œé€šè¿‡è°ƒç”¨await_resumeæ–¹æ³•è·å–ä¿å­˜çš„ç»“æœï¼Œå¹¶å°†è¯¥ç»“æœä¼ é€’ç»™å˜é‡a</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç›®å‰ï¼Œå½“å‰Awaiterçš„å±€é™æ€§åœ¨äºå®ƒåªèƒ½ä¸å¸¦æœ‰ä¸€ä¸ªintç±»å‹å‚æ•°çš„å›è°ƒä¸€èµ·ä½¿ç”¨ã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬å°è¯•æ‰©å±•Awaiterçš„åº”ç”¨ç¨‹åºï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span>... T&gt;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ActorAwaiter</span> {</span><font></font>
<font></font>
    <span class="hljs-built_in">std</span>::tuple&lt;T...&gt; values;<font></font>
<font></font>
    <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-keyword">void</span>(<span class="hljs-built_in">std</span>::tuple&lt;T...&gt; &amp;values, <span class="hljs-built_in">std</span>::coroutine_handle&lt;&gt;)&gt; storeHandler;<font></font>
<font></font>
    ActorAwaiter(<span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::function&lt;<span class="hljs-keyword">void</span>(<span class="hljs-built_in">std</span>::tuple&lt;T...&gt; &amp;values, <span class="hljs-built_in">std</span>::coroutine_handle&lt;&gt;)&gt; &amp;storeHandler)<font></font>
        : storeHandler(storeHandler)<font></font>
    {}<font></font>
<font></font>
    ActorAwaiter(<span class="hljs-keyword">const</span> ActorAwaiter &amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ActorAwaiter&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-keyword">const</span> ActorAwaiter &amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ActorAwaiter(ActorAwaiter &amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    ActorAwaiter&amp; <span class="hljs-keyword">operator</span>=(ActorAwaiter &amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">await_ready</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">noexcept</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">await_suspend</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::coroutine_handle&lt;&gt; coro)</span> <span class="hljs-keyword">noexcept</span> </span>{
        <span class="hljs-built_in">std</span>::invoke(storeHandler, <span class="hljs-built_in">std</span>::ref(values), coro);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   bool B  ,</span>
    <span class="hljs-comment">//   sfinae      </span>
    <span class="hljs-keyword">template</span>&lt;
        <span class="hljs-keyword">bool</span> B=<span class="hljs-literal">true</span>,<span class="hljs-keyword">size_t</span> len=<span class="hljs-keyword">sizeof</span>...(T),<span class="hljs-built_in">std</span>::<span class="hljs-keyword">enable_if_t</span>&lt;len==<span class="hljs-number">0</span> &amp;&amp; B, <span class="hljs-keyword">int</span>&gt;=<span class="hljs-number">0</span><font></font>
    &gt;<font></font>
    <span class="hljs-keyword">void</span> await_resume() <span class="hljs-keyword">noexcept</span> {<font></font>
<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   bool B  ,</span>
    <span class="hljs-comment">//   sfinae      </span>
    <span class="hljs-keyword">template</span>&lt;
        <span class="hljs-keyword">bool</span> B=<span class="hljs-literal">true</span>,<span class="hljs-keyword">size_t</span> len=<span class="hljs-keyword">sizeof</span>...(T),<span class="hljs-built_in">std</span>::<span class="hljs-keyword">enable_if_t</span>&lt;len==<span class="hljs-number">1</span> &amp;&amp; B, <span class="hljs-keyword">int</span>&gt;=<span class="hljs-number">0</span><font></font>
    &gt;<font></font>
    <span class="hljs-keyword">auto</span> await_resume() <span class="hljs-keyword">noexcept</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::get&lt;<span class="hljs-number">0</span>&gt;(values);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">//   bool B  ,</span>
    <span class="hljs-comment">//   sfinae      </span>
    <span class="hljs-keyword">template</span>&lt;
        <span class="hljs-keyword">bool</span> B=<span class="hljs-literal">true</span>,<span class="hljs-keyword">size_t</span> len=<span class="hljs-keyword">sizeof</span>...(T),<span class="hljs-built_in">std</span>::<span class="hljs-keyword">enable_if_t</span>&lt;len!=<span class="hljs-number">1</span> &amp;&amp; len!=<span class="hljs-number">0</span> &amp;&amp; B, <span class="hljs-keyword">int</span>&gt;=<span class="hljs-number">0</span><font></font>
    &gt;<font></font>
    <span class="hljs-built_in">std</span>::tuple&lt;T...&gt; await_resume() <span class="hljs-keyword">noexcept</span> {
        <span class="hljs-keyword">return</span> values;<font></font>
    }<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨std :: tupleä»¥ä¾¿èƒ½å¤Ÿä¸€æ¬¡ä¿å­˜å¤šä¸ªå˜é‡ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sfinaeè¢«å¼ºåŠ äºawait_resumeæ–¹æ³•ä¸Šï¼Œä»¥ä¾¿å¯èƒ½å¹¶éåœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½è¿”å›ä¸€ä¸ªå…ƒç»„ï¼Œè€Œæ˜¯å–å†³äºè¯¥å…ƒç»„ä¸­æ‰€åŒ…å«çš„å€¼çš„æ•°ç›®ï¼Œè¿”å›voidï¼Œæ­£å¥½ä¸º1ä¸ªå‚æ•°æˆ–æ•´ä¸ªå…ƒç»„ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨ï¼Œç”¨äºåˆ›å»ºAwaiteræœ¬èº«çš„åŒ…è£…ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> MakeCallback, <span class="hljs-keyword">typename</span>... ReturnArgs, <span class="hljs-keyword">typename</span> Func&gt;
<span class="hljs-keyword">static</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">makeCoroCallback</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Func &amp;func, Actor &amp;returnCallback)</span> </span>{
    <span class="hljs-keyword">return</span> [&amp;returnCallback, func](<span class="hljs-keyword">auto</span> &amp;values, <span class="hljs-built_in">std</span>::coroutine_handle&lt;&gt; coro) {
        <span class="hljs-keyword">auto</span> callback = MakeCallback(returnCallback, [&amp;values, coro](ReturnArgs&amp;&amp; ...result) {<font></font>
            values = <span class="hljs-built_in">std</span>::make_tuple(<span class="hljs-built_in">std</span>::forward&lt;ReturnArgs&gt;(result)...);
            <span class="hljs-built_in">std</span>::invoke(coro);<font></font>
        });<font></font>
        func(callback);<font></font>
    };<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> MakeCallback, <span class="hljs-keyword">typename</span>... ReturnArgs, <span class="hljs-keyword">typename</span> Func&gt;
<span class="hljs-keyword">static</span> ActorAwaiter&lt;ReturnArgs...&gt; <span class="hljs-title">makeActorAwaiter</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Func &amp;func, Actor &amp;returnCallback)</span> </span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> storeCoroToQueue = makeCoroCallback&lt;MakeCallback, ReturnArgs...&gt;(func, returnCallback);
    <span class="hljs-keyword">return</span> ActorAwaiter&lt;ReturnArgs...&gt;(storeCoroToQueue);<font></font>
}<font></font>
<font></font>
<span class="hljs-function">ActorAwaiter&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">ABActor::getAAsync</span><span class="hljs-params">(Actor &amp;returnCallback)</span> </span>{
    <span class="hljs-keyword">return</span> makeActorAwaiter&lt;GetACallback, <span class="hljs-keyword">int</span>&gt;(<span class="hljs-built_in">std</span>::bind(&amp;ABActor::getA, <span class="hljs-keyword">this</span>, _1), returnCallback);<font></font>
}<font></font>
<font></font>
<span class="hljs-function">ActorAwaiter&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">ABActor::getBAsync</span><span class="hljs-params">(Actor &amp;returnCallback)</span> </span>{
    <span class="hljs-keyword">return</span> makeActorAwaiter&lt;GetBCallback, <span class="hljs-keyword">int</span>&gt;(<span class="hljs-built_in">std</span>::bind(&amp;ABActor::getB, <span class="hljs-keyword">this</span>, _1), returnCallback);<font></font>
}<font></font>
<font></font>
<span class="hljs-function">ActorAwaiter&lt;&gt; <span class="hljs-title">ABActor::saveABAsync</span><span class="hljs-params">(Actor &amp;returnCallback, <span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span> </span>{
    <span class="hljs-keyword">return</span> makeActorAwaiter&lt;SaveABCallback&gt;(<span class="hljs-built_in">std</span>::bind(&amp;ABActor::saveAB, <span class="hljs-keyword">this</span>, a, b, _1), returnCallback);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç°åœ¨è®©æˆ‘ä»¬å¼„æ¸…æ¥šå¦‚ä½•åœ¨åç¨‹ä¸­ç›´æ¥ä½¿ç”¨åˆ›å»ºçš„ç±»å‹ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åç¨‹ã€‚</font><font style="vertical-align: inherit;">ç¬¬2éƒ¨åˆ†ã€‚å¯æ¢å¤</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»C ++çš„è§’åº¦æ¥çœ‹ï¼ŒåŒ…å«å•è¯co_awaitï¼Œco_yieldæˆ–co_returnçš„å‡½æ•°è¢«è§†ä¸ºåç¨‹ã€‚ä½†æ˜¯è¿™æ ·çš„å‡½æ•°ä¹Ÿåº”è¯¥è¿”å›æŸç§ç±»å‹ã€‚æˆ‘ä»¬åŒæ„ä¸ä¼šæ›´æ”¹å‡½æ•°çš„ç­¾åï¼ˆè¿™é‡Œæˆ‘çš„æ„æ€æ˜¯è¿”å›ç±»å‹ä¹ŸæŒ‡ä»£ç­¾åï¼‰ï¼Œå› æ­¤æˆ‘ä»¬å°†ä¸å¾—ä¸ä»¥æŸç§æ–¹å¼æ‘†è„±å®ƒã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªlambdaåç¨‹å¹¶ä»æˆ‘ä»¬çš„å‡½æ•°ä¸­è°ƒç”¨å®ƒï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">WokrerActor::workProcess</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> coroutine = [](WokrerActor &amp;actor) -&gt; ActorResumable {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> a = <span class="hljs-keyword">co_await</span> actor.abActor.getAAsync(actor);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> b = <span class="hljs-keyword">co_await</span> actor.abActor.getBAsync(actor);
        <span class="hljs-keyword">co_await</span> actor.abActor.saveABAsync(actor, a - b, a + b);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> newA = <span class="hljs-keyword">co_await</span> actor.abActor.getAAsync(actor);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> newB = <span class="hljs-keyword">co_await</span> actor.abActor.getBAsync(actor);
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Result "</span> &lt;&lt; newA &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; newB &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    };<font></font>
<font></font>
    coroutine(*<span class="hljs-keyword">this</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼ˆä¸ºä»€ä¹ˆä¸åœ¨lambdasçš„æ•è·åˆ—è¡¨ä¸­æ•è·å®ƒï¼Ÿç„¶åé‡Œé¢çš„æ‰€æœ‰ä»£ç ä¼šå˜å¾—å®¹æ˜“ä¸€äº›ã€‚ä½†æ˜¯ç¢°å·§ï¼Œæ˜¾ç„¶ç¼–è¯‘å™¨ä¸­çš„lambda-åç¨‹è¿˜æ²¡æœ‰å¾—åˆ°å®Œå…¨æ”¯æŒï¼Œå› æ­¤è¯¥ä»£ç å°†æ— æ³•å·¥ä½œã€‚ï¼‰</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„ä»£ç å¯æ€•çš„å›è°ƒä»£ç ç°åœ¨å·²ç»å˜æˆäº†éå¸¸ä¸é”™çš„çº¿æ€§ä»£ç ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å‰©ä¸‹çš„å°±æ˜¯å‘æ˜ActorResumableç±»ï¼Œ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ActorResumable</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">promise_type</span> {</span>
        <span class="hljs-keyword">using</span> coro_handle = <span class="hljs-built_in">std</span>::coroutine_handle&lt;promise_type&gt;;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">get_return_object</span><span class="hljs-params">()</span> </span>{ 
            <span class="hljs-comment">//  ,    ActorResumable   promise_type</span>
            <span class="hljs-keyword">return</span> coro_handle::from_promise(*<span class="hljs-keyword">this</span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">initial_suspend</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-comment">//      </span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::suspend_never();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">final_suspend</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-comment">//      . </span>
            <span class="hljs-comment">// ,     </span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::suspend_never();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unhandled_exception</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-comment">//   ,       </span>
            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">terminate</span>();<font></font>
        }<font></font>
    };<font></font>
<font></font>
    ActorResumable(<span class="hljs-built_in">std</span>::coroutine_handle&lt;promise_type&gt;) {}<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä»æˆ‘ä»¬çš„lambdaç”Ÿæˆçš„corutinçš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">ActorResumable <span class="hljs-title">coro</span><span class="hljs-params">()</span> </span>{<font></font>
    promise_type promise;<font></font>
    ActorResumable retobj = promise.get_return_object();<font></font>
    <span class="hljs-keyword">auto</span> intial_suspend = promise.initial_suspend();
    <span class="hljs-keyword">if</span> (initial_suspend == <span class="hljs-built_in">std</span>::suspend_always)  {
          <span class="hljs-comment">// yield</span><font></font>
    }<font></font>
    <span class="hljs-keyword">try</span> { 
        <span class="hljs-comment">//  .</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> a = <span class="hljs-keyword">co_await</span> actor.abActor.getAAsync(actor);
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Result "</span> &lt;&lt; a &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    } <span class="hljs-keyword">catch</span>(...) { <font></font>
        promise.unhandled_exception();<font></font>
    }<font></font>
final_suspend:<font></font>
    <span class="hljs-keyword">auto</span> final_suspend = promise.final_suspend();
    <span class="hljs-keyword">if</span> (final_suspend == <span class="hljs-built_in">std</span>::suspend_always)  {
         <span class="hljs-comment">// yield</span>
    } <span class="hljs-keyword">else</span> {<font></font>
         cleanup();<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è¿™åªæ˜¯ä¼ªä»£ç ï¼Œæœ‰äº›äº‹æƒ…æ˜¯æœ‰æ„ç®€åŒ–çš„ã€‚</font><font style="vertical-align: inherit;">å°½ç®¡å¦‚æ­¤ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªpromiseå’ŒActorResumableã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨initial_suspendï¼ˆï¼‰ä¹‹åï¼Œæˆ‘ä»¬ä¸ä¼šæš‚åœï¼Œè€Œæ˜¯ç»§ç»­å‰è¿›ã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å¼€å§‹æ‰§è¡Œè¯¥ç¨‹åºçš„ä¸»è¦éƒ¨åˆ†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å½“æˆ‘ä»¬åˆ°è¾¾co_awaitæ—¶ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬éœ€è¦æš‚åœã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬å·²ç»åœ¨ä¸Šä¸€èŠ‚ä¸­ç ”ç©¶äº†è¿™ç§æƒ…å†µï¼Œæ‚¨å¯ä»¥è¿”å›å¹¶è¿›è¡Œå®¡æŸ¥ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
åœ¨æˆ‘ä»¬ç»§ç»­æ‰§è¡Œå¹¶å°†ç»“æœæ˜¾ç¤ºåœ¨å±å¹•ä¸Šä¹‹åï¼Œåç¨‹æ‰§è¡Œç»“æŸã€‚</font><font style="vertical-align: inherit;">æˆ‘ä»¬æ£€æŸ¥final_suspendï¼Œå¹¶æ¸…é™¤åç¨‹çš„æ•´ä¸ªä¸Šä¸‹æ–‡ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åç¨‹ã€‚</font><font style="vertical-align: inherit;">ç¬¬3éƒ¨åˆ†ã€‚ä»»åŠ¡</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬è®°ä½æˆ‘ä»¬ç°åœ¨å¤„äºä»€ä¹ˆé˜¶æ®µã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">WokrerActor::workProcess</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> coroutine = [](WokrerActor &amp;actor) -&gt; ActorResumable {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> a = <span class="hljs-keyword">co_await</span> actor.abActor.getAAsync(actor);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> b = <span class="hljs-keyword">co_await</span> actor.abActor.getBAsync(actor);
        <span class="hljs-keyword">co_await</span> actor.abActor.saveABAsync(actor, a - b, a + b);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> newA = <span class="hljs-keyword">co_await</span> actor.abActor.getAAsync(actor);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> newB = <span class="hljs-keyword">co_await</span> actor.abActor.getBAsync(actor);
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Result "</span> &lt;&lt; newA &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; newB &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    };<font></font>
<font></font>
    coroutine(*<span class="hljs-keyword">this</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çœ‹èµ·æ¥ä¸é”™ï¼Œä½†æ˜¯å¾ˆå®¹æ˜“çœ‹åˆ°ä»£ç ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs">        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> a = <span class="hljs-keyword">co_await</span> actor.abActor.getAAsync(actor);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> b = <span class="hljs-keyword">co_await</span> actor.abActor.getBAsync(actor);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é‡å¤2æ¬¡ã€‚</font><font style="vertical-align: inherit;">æ˜¯å¦å¯ä»¥é‡æ„è¿™ä¸€åˆ»å¹¶å°†å…¶ç½®äºå•ç‹¬çš„å‡½æ•°ä¸­ï¼Ÿ</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è®©æˆ‘ä»¬å‹¾å‹’å‡ºå®ƒçš„å¤–è§‚ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">CoroTask&lt;<span class="hljs-built_in">std</span>::pair&lt;<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>&gt;&gt; <span class="hljs-title">WokrerActor::readAB</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> a = <span class="hljs-keyword">co_await</span> abActor.getAAsync2(*<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> b = <span class="hljs-keyword">co_await</span> abActor.getBAsync2(*<span class="hljs-keyword">this</span>);
    <span class="hljs-function"><span class="hljs-keyword">co_return</span> <span class="hljs-title">std::make_pair</span><span class="hljs-params">(a, b)</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">WokrerActor::workCoroProcess</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> coroutine = [](WokrerActor &amp;actor) -&gt; ActorResumable {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> [a, b] = <span class="hljs-keyword">co_await</span> actor.readAB();
        <span class="hljs-keyword">co_await</span> actor.abActor.saveABAsync2(actor, a - b, a + b);
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> [newA, newB] = <span class="hljs-keyword">co_await</span> actor.readAB();
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Result "</span> &lt;&lt; newA &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; newB &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; a &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; b &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<font></font>
    };<font></font>
<font></font>
    coroutine(*<span class="hljs-keyword">this</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æˆ‘ä»¬å‰©ä¸‹çš„å°±æ˜¯å‘æ˜CoroTaskç±»å‹ã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ã€‚</font><font style="vertical-align: inherit;">é¦–å…ˆï¼Œåœ¨readABå‡½æ•°å†…éƒ¨ä½¿ç”¨äº†co_returnï¼Œè¿™æ„å‘³ç€CoroTaskå¿…é¡»æ»¡è¶³Resumableæ¥å£ã€‚</font><font style="vertical-align: inherit;">è€Œä¸”ï¼Œæ­¤ç±»çš„å¯¹è±¡ç”¨äºè¾“å…¥å¦ä¸€ä¸ªåç¨‹çš„co_awaitã€‚</font><font style="vertical-align: inherit;">è¿™æ„å‘³ç€CoroTaskç±»è¿˜å¿…é¡»æ»¡è¶³Awaitableæ¥å£ã€‚</font><font style="vertical-align: inherit;">è®©æˆ‘ä»¬åœ¨CoroTaskç±»ä¸­å®ç°è¿™ä¸¤ä¸ªæ¥å£ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T = <span class="hljs-keyword">void</span>&gt;<font></font>
struct CoroTask {<font></font>
    struct promise_type {<font></font>
        T result;<font></font>
        <span class="hljs-built_in">std</span>::coroutine_handle&lt;&gt; waiter;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">get_return_object</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> CoroTask{*<span class="hljs-keyword">this</span>};<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">return_value</span><span class="hljs-params">(T value)</span> </span>{<font></font>
            result = value;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unhandled_exception</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">terminate</span>();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-built_in">std</span>::suspend_always <span class="hljs-title">initial_suspend</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> {};<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">final_suspend</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">final_awaiter</span> {</span>
                <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">await_ready</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
                }<font></font>
                <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">await_resume</span><span class="hljs-params">()</span> </span>{}
                <span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">await_suspend</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::coroutine_handle&lt;promise_type&gt; me)</span> </span>{
                    <span class="hljs-keyword">return</span> me.promise().waiter;<font></font>
                }<font></font>
            };<font></font>
            <span class="hljs-keyword">return</span> final_awaiter{};<font></font>
        }<font></font>
    };<font></font>
<font></font>
    CoroTask(CoroTask &amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    CoroTask&amp; <span class="hljs-keyword">operator</span>=(CoroTask&amp;&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    CoroTask(<span class="hljs-keyword">const</span> CoroTask&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
    CoroTask&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-keyword">const</span> CoroTask&amp;) = <span class="hljs-keyword">delete</span>;<font></font>
<font></font>
    ~CoroTask() {<font></font>
        <span class="hljs-keyword">if</span> (h) {<font></font>
            h.destroy();<font></font>
        }<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">CoroTask</span><span class="hljs-params">(promise_type &amp; p)</span>
        : <span class="hljs-title">h</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::coroutine_handle&lt;promise_type&gt;::from_promise(p))</span>
    </span>{}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">await_ready</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function">T <span class="hljs-title">await_resume</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">auto</span> &amp;result = h.promise().result;
        <span class="hljs-keyword">return</span> result;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">await_suspend</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::coroutine_handle&lt;&gt; waiter)</span> </span>{<font></font>
        h.promise().waiter = waiter;<font></font>
        h.resume();<font></font>
    }<font></font>
<span class="hljs-keyword">private</span>:
    <span class="hljs-built_in">std</span>::coroutine_handle&lt;promise_type&gt; h;<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ï¼ˆæˆ‘å¼ºçƒˆå»ºè®®æ‰“å¼€æ­¤æ–‡ç« çš„èƒŒæ™¯å›¾ç‰‡ã€‚å°†æ¥ï¼Œè¿™å°†å¯¹æ‚¨æœ‰å¾ˆå¤§å¸®åŠ©ã€‚ï¼‰</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å› æ­¤ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.è½¬åˆ°lambdaåç¨‹ï¼Œç„¶åç«‹å³åˆ›å»ºWokrerActor :: readABåç¨‹ã€‚ä½†æ˜¯ï¼Œåœ¨åˆ›å»ºæ­¤åç¨‹ä¹‹åï¼Œæˆ‘ä»¬å°±ä¸ä¼šå¼€å§‹æ‰§è¡Œå®ƒï¼ˆinitial_suspend == suspend_alwaysï¼‰ï¼Œè¿™è¿«ä½¿æˆ‘ä»¬ä¸­æ–­å¹¶è¿”å›åç¨‹lambdaã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. co_await lambdaæ£€æŸ¥readABæ˜¯å¦å‡†å¤‡å°±ç»ªã€‚ç»“æœå°šæœªå‡†å¤‡å¥½ï¼ˆawait_ready == falseï¼‰ï¼Œè¿™è¿«ä½¿å…¶å°†ä¸Šä¸‹æ–‡ä¼ é€’ç»™CoroTask :: await_suspendæ–¹æ³•ã€‚è¯¥ä¸Šä¸‹æ–‡ä¿å­˜åœ¨CoroTaskä¸­ï¼Œå¹¶å¯åŠ¨äº†readAB </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3 </font><font style="vertical-align: inherit;">åç¨‹çš„æ¢å¤</font><font style="vertical-align: inherit;">ã€‚readABåç¨‹å®Œæˆæ‰€æœ‰å¿…è¦çš„æ“ä½œåï¼Œåˆ°è¾¾ä»¥ä¸‹è¡Œï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">co_return</span> <span class="hljs-title">std::make_pair</span><span class="hljs-params">(a, b)</span></span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç»“æœï¼Œè°ƒç”¨äº†CoroTask :: promise_type :: return_valueæ–¹æ³•ï¼Œå¹¶ä¸”å°†åˆ›å»ºçš„æ•°å­—å¯¹ä¿å­˜åœ¨CoroTaskï¼špromise_type </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4ä¸­ã€‚ç”±äºè°ƒç”¨äº†co_returnæ–¹æ³•ï¼Œåç¨‹çš„æ‰§è¡Œç»“æŸäº†ï¼Œè¿™æ„å‘³ç€è¯¥è°ƒç”¨CoroTask :: promise_type :: final_suspendæ–¹æ³•äº†ã€‚æ­¤æ–¹æ³•è¿”å›ä¸€ä¸ªè‡ªå†™çš„ç»“æ„ï¼ˆä¸è¦å¿˜è®°çœ‹å›¾ç‰‡ï¼‰ï¼Œè¯¥ç»“æ„è¿«ä½¿æ‚¨è°ƒç”¨final_awaiter :: await_suspendæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›å­˜å‚¨åœ¨æ­¥éª¤2ä¸­çš„åç¨‹lambdaä¸Šä¸‹æ–‡ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½åªåœ¨è¿™é‡Œè¿”å›suspend_alwaysï¼Ÿæ¯•ç«Ÿï¼Œåœ¨æ­¤ç±»çš„initial_suspendæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æˆåŠŸäº†å—ï¼Ÿäº‹å®æ˜¯ï¼Œåœ¨initial_suspendä¸­æˆ‘ä»¬æˆåŠŸäº†ï¼Œå› ä¸ºæ­¤åç¨‹è¢«æˆ‘ä»¬çš„lambdaåç¨‹è°ƒç”¨ï¼Œç„¶åæˆ‘ä»¬è¿”å›äº†å®ƒã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬åˆ°è¾¾final_suspendè°ƒç”¨çš„é‚£ä¸€åˆ»ï¼Œæˆ‘ä»¬çš„åç¨‹å¾ˆå¯èƒ½ä»å¦ä¸€ä¸ªå †æ ˆç»§ç»­è¿›è¡Œï¼ˆç‰¹åˆ«æ˜¯ä»makeCoroCallbackå‡½æ•°å‡†å¤‡çš„lambdaç»§ç»­ï¼‰ï¼Œå¹¶ä¸”å¦‚æœæˆ‘ä»¬åœ¨æ­¤å¤„è¿”å›suspend_alwaysï¼Œæˆ‘ä»¬å°†è¿”å›åˆ°å®ƒï¼Œè€Œä¸æ˜¯workCoroProcessæ–¹æ³•ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5.ç”±äºfinal_awaiter :: await_suspendæ–¹æ³•å°†ä¸Šä¸‹æ–‡è¿”å›ç»™æˆ‘ä»¬ï¼Œå› æ­¤è¿™è¿«ä½¿ç¨‹åºç»§ç»­æ‰§è¡Œè¿”å›çš„ä¸Šä¸‹æ–‡ï¼Œå³åç¨‹lambdaã€‚ç”±äºæ‰§è¡Œè¿”å›åˆ°è¯¥ç‚¹ï¼š</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span> [a, b] = <span class="hljs-keyword">co_await</span> actor.readAB();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é‚£ä¹ˆæˆ‘ä»¬éœ€è¦é€šè¿‡è°ƒç”¨CoroTask :: await_resumeæ–¹æ³•æ¥éš”ç¦»ä¿å­˜çš„ç»“æœã€‚ç»“æœè¢«æ¥æ”¶ï¼Œä¼ é€’ç»™å˜é‡aå’Œbï¼Œç°åœ¨CoroTaskå®ä¾‹è¢«é”€æ¯äº†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. CoroTaskå®ä¾‹è¢«ç ´åäº†ï¼Œä½†æ˜¯WokrerActor :: readABä¸Šä¸‹æ–‡å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿå¦‚æœæˆ‘ä»¬ä»CoroTask :: promise_type :: final_suspendè¿”å›returnsuspended_neverï¼ˆæ›´ç¡®åˆ‡åœ°è¯´ï¼Œå°†å…¶è¿”å›åˆ°await_readyé—®é¢˜å°†è¿”å›trueï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶åç¨‹ä¸Šä¸‹æ–‡å°†è¢«æ¸…é™¤ã€‚ä½†æ˜¯ç”±äºæˆ‘ä»¬æ²¡æœ‰è¿™æ ·åšï¼Œå› æ­¤æ¸…é™¤ä¸Šä¸‹æ–‡çš„ä¹‰åŠ¡å·²è½¬ç§»ç»™æˆ‘ä»¬ã€‚æˆ‘ä»¬å°†åœ¨CoroTaskææ„å‡½æ•°ä¸­æ¸…é™¤æ­¤ä¸Šä¸‹æ–‡ï¼Œè¿™æ—¶å®ƒå·²ç»å¾ˆå®‰å…¨äº†ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7.æ‰§è¡Œåç¨‹readABï¼Œä»ä¸­è·å–ç»“æœï¼Œæ¸…é™¤ä¸Šä¸‹æ–‡ï¼Œlambdaåç¨‹ç»§ç»­è¿è¡Œ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ewï¼Œæœ‰ç‚¹æ•´ç†äº†ã€‚</font><font style="vertical-align: inherit;">æ‚¨è¿˜è®°å¾—ä»ABActor :: getAAsyncï¼ˆï¼‰ä¹‹ç±»çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªè‡ªå†™çš„ç»“æ„å—ï¼Ÿ</font><font style="vertical-align: inherit;">å®é™…ä¸Šï¼Œé€šè¿‡ç»„åˆä»CoroTaskå’ŒActorAwaiterç±»çš„å®ç°ä¸­è·å¾—çš„çŸ¥è¯†å¹¶è·å¾—ç±»ä¼¼ä»¥ä¸‹å†…å®¹çš„æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å°†getAAsyncæ–¹æ³•è½¬æ¢ä¸ºåç¨‹ã€‚</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">CoroTaskActor&lt;<span class="hljs-keyword">int</span>&gt; <span class="hljs-title">ABActor::getAAsync</span><span class="hljs-params">(Actor &amp;returnCallback)</span> </span>{
    <span class="hljs-keyword">co_return</span> makeCoroCallback&lt;GetACallback, <span class="hljs-keyword">int</span>&gt;(<span class="hljs-built_in">std</span>::bind(&amp;ABActor::getA, <span class="hljs-keyword">this</span>, _1), returnCallback);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½†è¿™æˆ‘å°†è¿›è¡Œè‡ªæˆ‘åˆ†æã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å‘ç°</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å¦‚æ‚¨æ‰€è§ï¼Œå€ŸåŠ©åç¨‹ï¼Œæ‚¨å¯ä»¥å¾ˆå¥½åœ°çº¿æ€§åŒ–å¼‚æ­¥å›è°ƒä»£ç ã€‚</font><font style="vertical-align: inherit;">çš„ç¡®ï¼Œç¼–å†™è¾…åŠ©ç±»å‹å’Œå‡½æ•°çš„è¿‡ç¨‹ä¼¼ä¹è¿˜ä¸å¤ªç›´è§‚ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‰€æœ‰ä»£ç éƒ½å¯ä»¥åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">èµ„æºåº“ä¸­</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰¾åˆ°ï¼Œ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">æˆ‘</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ä¹Ÿå»ºè®®æ‚¨æŸ¥çœ‹</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è¿™äº›è®²åº§</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œä»¥æ›´å…¨é¢åœ°äº†è§£è¯¥ä¸»é¢˜</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¥è‡ªåŒä¸€ä½œè€…çš„æœ‰å…³åç¨‹çš„å¤§é‡ç¤ºä¾‹åœ¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ­¤å¤„</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ‚¨ä¹Ÿå¯ä»¥è§‚çœ‹æ­¤</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">è®²åº§ã€‚</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN493796/index.html">ç”¨äºè‡ªåŠ¨åŒ–æµ‹è¯•çš„4ç§æœ€ä½³è®¾è®¡æ¨¡å¼ï¼ˆè¿˜æœ‰86ç§ï¼‰</a></li>
<li><a href="../zh-CN493798/index.html">1C UX / UIä¸­æ²¡æœ‰è®¾è®¡</a></li>
<li><a href="../zh-CN493800/index.html">ç»éªŒæ¦‚ç‡</a></li>
<li><a href="../zh-CN493802/index.html">äº†è§£launchMode Androidæ´»åŠ¨ï¼šæ ‡å‡†ï¼ŒsingleTopï¼ŒsingleTaskå’ŒsingleInstance</a></li>
<li><a href="../zh-CN493804/index.html">è¦†ç›†å­è¯´è¯çš„çƒå‘˜</a></li>
<li><a href="../zh-CN493810/index.html">äº”å¹´çš„æ–‡ä»¶è¯†åˆ«å¸‚åœºå¯†é›†å¼€å‘</a></li>
<li><a href="../zh-CN493814/index.html">æˆ‘ä»¬å¦‚ä½•åœ¨å·´å¡ç½—é‚£è¿›è¡Œé‡‡è®¿</a></li>
<li><a href="../zh-CN493816/index.html">GitæŒ‡å— ç¬¬1éƒ¨åˆ†ï¼šæœ‰å…³.gitç›®å½•çš„æ‰€æœ‰ä¿¡æ¯</a></li>
<li><a href="../zh-CN493818/index.html">GitæŒ‡å— éƒ¨åˆ†2ï¼šé»„é‡‘æ³•åˆ™å’Œå…¶ä»–åŸºç¡€åŸºç¡€</a></li>
<li><a href="../zh-CN493820/index.html">Kubernetesè´Ÿè½½å¹³è¡¡å’Œæ‰©å±•é•¿æœŸè¿æ¥</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>