<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>↪️ 👩🏽‍💻 🍵 WAL-G: Sauvegardes et restauration de bases de données PostgreSQL 👩🏼‍🍳 📃 👱</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On sait depuis longtemps que faire des sauvegardes dans des vidages SQL (en utilisant pg_dump ou pg_dumpall ) n'est pas une bonne idée. Pour sauvegard...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WAL-G: Sauvegardes et restauration de bases de données PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506610/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On sait depuis longtemps que faire des sauvegardes dans des </font><b><font style="vertical-align: inherit;">vidages</font></b><font style="vertical-align: inherit;"> SQL (en utilisant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dumpall</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) n'est pas une bonne idée. Pour sauvegarder PostgreSQL, il est préférable d'utiliser la commande </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_basebackup</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui crée une copie binaire des journaux WAL. Mais lorsque vous commencerez à étudier l'ensemble du processus de création d'une sauvegarde et d'une restauration, vous comprendrez que vous devez écrire au moins quelques tricycles pour que tout cela fonctionne et ne vous fasse pas mal d'en haut et d'en bas. Afin d'alléger les souffrances, WAL-G a été développé. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un outil écrit en Go pour sauvegarder et restaurer les bases de données PostgreSQL ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et plus récemment, MySQL / MariaDB, MongoDB et FoundationDB</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">Il prend en charge le travail avec les stockages Amazon S3 (et analogues, par exemple, Yandex Object Storage), ainsi que Google Cloud Storage, Azure Storage, Swift Object Storage et uniquement avec le système de fichiers. </font><font style="vertical-align: inherit;">L'ensemble de l'installation est réduit à de simples étapes, mais en raison du fait que les articles à ce sujet sont dispersés sur Internet, il n'y a pas de manuel complet qui inclurait toutes les étapes de et vers (il y a plusieurs articles sur Habré, mais de nombreux points manquent là).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9i/pq/ut/9ipqut4x24_-0192l8skbzkri6o.jpeg" alt="sauvegarde postgresql"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article est écrit principalement pour systématiser vos connaissances. </font><font style="vertical-align: inherit;">Je ne suis pas un DBA et je peux m'exprimer quelque part dans un langage de développement philistin, donc toute correction est la bienvenue! </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Séparément, je note que tout ce qui suit est pertinent et vérifié pour PostgreSQL 12.3 sur Ubuntu 18.04, toutes les commandes doivent être exécutées en tant qu'utilisateur privilégié.</font></font></i><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au moment d'écrire ces </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lignes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la version stable de WAL-G est la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">v0.2.15 (mars 2020)</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous allons l'utiliser ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais si vous voulez l'assembler vous-même à partir de la branche master, le référentiel github a toutes les instructions pour cela</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Pour télécharger et installer, vous devez faire:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
curl -L <span class="hljs-string">"https://github.com/wal-g/wal-g/releases/download/v0.2.15/wal-g.linux-amd64.tar.gz"</span> -o <span class="hljs-string">"wal-g.linux-amd64.tar.gz"</span><font></font>
tar -xzf wal-g.linux-amd64.tar.gz<font></font>
mv wal-g /usr/<span class="hljs-built_in">local</span>/bin/
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après cela, vous devez d'abord configurer WAL-G, puis PostgreSQL lui-même.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de WAL-G</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour un exemple de stockage de sauvegarde, Amazon S3 sera utilisé ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">car il est plus proche de mes serveurs et son utilisation est très bon marché</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Pour l'utiliser, vous avez besoin d'un «compartiment s3» et de clés d'accès. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les articles précédents sur WAL-G utilisaient la configuration à l'aide de variables d'environnement, mais à partir de cette version, les paramètres peuvent être situés dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier .walg.json</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">répertoire de base</font></a><font style="vertical-align: inherit;"> de l'utilisateur postgres. </font><font style="vertical-align: inherit;">Pour le créer, exécutez le script bash suivant:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
cat &gt; /var/lib/postgresql/.walg.json &lt;&lt; EOF<font></font>
{<font></font>
    <span class="hljs-string">"WALG_S3_PREFIX"</span>: <span class="hljs-string">"s3://your_bucket/path"</span>,
    <span class="hljs-string">"AWS_ACCESS_KEY_ID"</span>: <span class="hljs-string">"key_id"</span>,
    <span class="hljs-string">"AWS_SECRET_ACCESS_KEY"</span>: <span class="hljs-string">"secret_key"</span>,
    <span class="hljs-string">"WALG_COMPRESSION_METHOD"</span>: <span class="hljs-string">"brotli"</span>,
    <span class="hljs-string">"WALG_DELTA_MAX_STEPS"</span>: <span class="hljs-string">"5"</span>,
    <span class="hljs-string">"PGDATA"</span>: <span class="hljs-string">"/var/lib/postgresql/12/main"</span>,
    <span class="hljs-string">"PGHOST"</span>: <span class="hljs-string">"/var/run/postgresql/.s.PGSQL.5432"</span><font></font>
}<font></font>
EOF<font></font>
<span class="hljs-comment">#    :</span><font></font>
chown postgres: /var/lib/postgresql/.walg.json<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'expliquerai un peu à tous égards:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WALG_S3_PREFIX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le chemin vers votre </font><b><font style="vertical-align: inherit;">compartiment</font></b><font style="vertical-align: inherit;"> S3 où les sauvegardes seront versées (vous pouvez à la fois à la racine et dans le dossier);</font></font></li>
<li><b>AWS_ACCESS_KEY_ID</b> –    S3 (<i>      –     ReadOnly Policy!        </i>);<br>
</li>
<li><b>AWS_SECRET_ACCESS_KEY</b> –     S3;</li>
<li><b>WALG_COMPRESSION_METHOD</b> –  ,   Brotli (          /);</li>
<li><b>WALG_DELTA_MAX_STEPS</b> –  «»     (      ,      ,      );</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGDATA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le chemin vers le répertoire avec les données de votre base de données ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous pouvez le découvrir en exécutant la commande </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGHOST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - connexion à la base de données, avec une sauvegarde locale, il est préférable de le faire via unix-socket, comme dans cet exemple.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'autres paramètres peuvent être trouvés dans la documentation: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/wal-g/wal-g/blob/v0.2.15/PostgreSQL.md#configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de PostgreSQL</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que l'archiveur à l'intérieur de la base de données télécharge les journaux WAL dans le cloud et les récupère (si nécessaire), vous devez définir plusieurs paramètres dans le fichier de configuration </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postgresql/12/main/postgresql.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pour commencer, </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous devez vous assurer</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qu'aucun des paramètres ci-dessous n'est défini sur d'autres valeurs, de sorte que lorsque vous redémarrez la configuration, le SGBD ne tombe pas. </font><font style="vertical-align: inherit;">Vous pouvez ajouter ces paramètres en utilisant:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"wal_level=replica"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_mode=on"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_command='/usr/local/bin/wal-g wal-push \"%p\" &gt;&gt; /var/log/postgresql/archive_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> “archive_timeout=60” &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"restore_command='/usr/local/bin/wal-g wal-fetch \"%f\" \"%p\" &gt;&gt; /var/log/postgresql/restore_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf<font></font>
<font></font>
<span class="hljs-comment">#     SIGHUP    </span><font></font>
killall -s HUP postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Description des paramètres à régler:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal_level</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - combien d'informations à écrire dans les magazines WAL, "réplique" - pour tout écrire;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">active</font></b><font style="vertical-align: inherit;"> le téléchargement des journaux WAL à l'aide de la commande du paramètre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - commande pour archiver le journal WAL terminé;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_timeout</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - l'archivage des journaux n'est effectué que lorsqu'il est terminé, mais si votre serveur modifie / ajoute un peu de données à la base de données, il est logique de définir une limite en secondes ici, après quoi la commande d'archivage sera forcée ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j'ai une écriture intensive dans la base de données chaque seconde, donc J'ai refusé de régler ce paramètre en production</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restore_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une commande pour restaurer un journal WAL à partir d'une sauvegarde, elle sera utilisée si les dernières modifications de la base de données manquent dans la «sauvegarde complète» (sauvegarde de base).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez en savoir plus sur tous ces paramètres dans la traduction de la documentation officielle: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://postgrespro.ru/docs/postgresql/12/runtime-config-wal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration d'une planification de sauvegarde</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'on le veuille ou non, mais cron est le moyen le plus pratique pour commencer. </font><font style="vertical-align: inherit;">C'est ce que nous allons configurer pour créer des sauvegardes. </font><font style="vertical-align: inherit;">Commençons par la commande pour créer une sauvegarde complète: dans wal-g, c'est l'argument pour exécuter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backup-push</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais d'abord, il est préférable d'exécuter cette commande manuellement depuis l'utilisateur postgres pour s'assurer que tout va bien (et qu'il n'y a pas d'erreurs d'accès):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les arguments de début indiquent le chemin d'accès au répertoire de données - je vous rappelle que vous pouvez le reconnaître en exécutant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tout s'est bien passé et que les données ont été téléchargées dans le référentiel S3, vous pouvez configurer un lancement périodique dans crontab:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"15 4 * * *    /usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main &gt;&gt; /var/log/postgresql/walg_backup.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#       </span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet exemple, le processus de sauvegarde démarre tous les jours à 4 h 15 du matin.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supprimer les anciennes sauvegardes</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Très probablement, vous n'avez pas besoin de stocker absolument toutes les sauvegardes de l'ère mésozoïque, il sera donc utile de "nettoyer" périodiquement votre stockage (à la fois les "sauvegardes complètes" et les journaux WAL). </font><font style="vertical-align: inherit;">Nous le ferons également à travers la tâche cron:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"30 6 * * *    /usr/local/bin/wal-g delete before FIND_FULL <span class="hljs-subst">$(date -d '-10 days' '+%FT%TZ')</span> --confirm &gt;&gt; /var/log/postgresql/walg_delete.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#          (        )</span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cron effectuera cette tâche tous les jours à 6h30 du matin, supprimant tout (sauvegardes complètes, deltas et WAL) sauf les copies des 10 derniers jours, mais laissera au moins une sauvegarde </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avant la</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> date spécifiée afin que tout point </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">après la</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> date tombe dans PITR .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restore depuis une sauvergarde</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce n'est un secret pour personne que la garantie d'une base saine est la récupération et la vérification périodiques de l'intégrité des données à l'intérieur. Comment récupérer en utilisant WAL-G - Je le dirai dans cette section, et nous parlerons des vérifications plus tard. </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Séparément, il convient de noter</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que pour la récupération sur un environnement de test (tout ce qui n'est pas de la production) - vous devez utiliser un compte en lecture seule dans S3, afin de ne pas écraser accidentellement les sauvegardes. Dans le cas de WAL-G, vous devez définir l'utilisateur S3 les droits suivants dans la stratégie de groupe ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">effet: autoriser</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetObject</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: ListBucket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetBucketLocation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Et, bien sûr, n'oubliez pas de définir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode = off</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le fichier de paramètres </font><i><font style="vertical-align: inherit;">postgresql.conf</font></i><font style="vertical-align: inherit;"> au </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">préalable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afin que votre base de test ne veuille pas effectuer de sauvegarde silencieusement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La récupération est effectuée par un léger mouvement de la main avec la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suppression de toutes les données PostgreSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (y compris les utilisateurs), donc soyez extrêmement prudent lorsque vous exécutez les commandes suivantes.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#     (, pgbouncer),    ,       </span><font></font>
service pgbouncer stop<font></font>
<span class="hljs-comment">#   ,     (, monit),        (   pgsql12)</span><font></font>
monit stop pgsql12<font></font>
<span class="hljs-comment">#    </span><font></font>
service monit stop<font></font>
<span class="hljs-comment">#    </span><font></font>
service postgresql stop<font></font>
<span class="hljs-comment">#       (!!!);     ,      </span><font></font>
rm -rf /var/lib/postgresql/12/main<font></font>
<span class="hljs-comment">#      </span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-fetch /var/lib/postgresql/12/main LATEST'</span>
<span class="hljs-comment">#      -   (. https://postgrespro.ru/docs/postgresql/12/runtime-config-wal#RUNTIME-CONFIG-WAL-ARCHIVE-RECOVERY ),        postgres</span>
su - postgres -c <span class="hljs-string">'touch /var/lib/postgresql/12/main/recovery.signal'</span>
<span class="hljs-comment">#   ,     </span><font></font>
service postgresql start<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ceux qui veulent vérifier le processus de récupération - un petit morceau de bash-magic est préparé ci-dessous, de sorte qu'en cas de problèmes de récupération - le script se bloque avec un code de sortie non nul. </font><font style="vertical-align: inherit;">Dans cet exemple, 120 vérifications sont effectuées avec un délai d'attente de 5 secondes (seulement 10 minutes pour récupérer) pour savoir si le fichier de signal a été supprimé (cela signifie que la récupération a réussi):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
CHECK_RECOVERY_SIGNAL_ITER=0<font></font>
<span class="hljs-keyword">while</span> [ <span class="hljs-variable">${CHECK_RECOVERY_SIGNAL_ITER}</span> -le 120 ]
<span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal removed"</span>
        <span class="hljs-built_in">break</span>
    <span class="hljs-keyword">fi</span><font></font>
    sleep 5<font></font>
    ((CHECK_RECOVERY_SIGNAL_ITER+1))<font></font>
<span class="hljs-keyword">done</span><font></font>
<font></font>
<span class="hljs-comment">#        ,    </span>
<span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal still exists!"</span>
    <span class="hljs-built_in">exit</span> 17
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après une récupération réussie, n'oubliez pas de redémarrer tous les processus (pgbouncer / monit, etc.).</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vérification des données après récupération</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assurez-vous de vérifier l'intégrité de la base de données après la récupération, afin qu'il n'y ait aucune situation avec une sauvegarde cassée / tordue. </font><font style="vertical-align: inherit;">Et il vaut mieux le faire avec chaque archive créée, mais où et comment dépend de votre imagination (vous pouvez augmenter les serveurs individuels sur une base horaire ou exécuter un test dans CI). </font><font style="vertical-align: inherit;">Mais au moins - vous devez vérifier les données et les index de la base de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour vérifier les données, il suffit de les exécuter via le vidage, mais il est préférable que lors de la création de la base de données, les sommes de contrôle soient activées ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sommes de contrôle des données</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-keyword">if</span> ! su - postgres -c <span class="hljs-string">'pg_dumpall &gt; /dev/null'</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'pg_dumpall failed'</span>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour vérifier les indices - il existe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un module amcheck</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous allons prendre la requête sql pour cela à partir des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tests WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et construire un peu de logique autour:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#  sql-       </span><font></font>
cat &gt; /tmp/amcheck.sql &lt;&lt; EOF<font></font>
CREATE EXTENSION IF NOT EXISTS amcheck;<font></font>
SELECT bt_index_check(c.oid), c.relname, c.relpages<font></font>
FROM pg_index i<font></font>
JOIN pg_opclass op ON i.indclass[0] = op.oid<font></font>
JOIN pg_am am ON op.opcmethod = am.oid<font></font>
JOIN pg_class c ON i.indexrelid = c.oid<font></font>
JOIN pg_namespace n ON c.relnamespace = n.oid<font></font>
WHERE am.amname = <span class="hljs-string">'btree'</span>
AND c.relpersistence != <span class="hljs-string">'t'</span><font></font>
AND i.indisready AND i.indisvalid;<font></font>
EOF<font></font>
chown postgres: /tmp/amcheck.sql<font></font>
<font></font>
<span class="hljs-comment">#          </span>
<span class="hljs-comment"># (       – )</span><font></font>
cat &gt; /tmp/run_amcheck.sh &lt;&lt; EOF<font></font>
<span class="hljs-keyword">for</span> DBNAME <span class="hljs-keyword">in</span> \$(su - postgres -c <span class="hljs-string">'psql -q -A -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" '</span>)
<span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Database: \${DBNAME}"</span>
    su - postgres -c <span class="hljs-string">"psql -f /tmp/amcheck.sql -v 'ON_ERROR_STOP=1' \${DBNAME}"</span> &amp;&amp; EXIT_STATUS=\$? || EXIT_STATUS=\$?
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"\${EXIT_STATUS}"</span> -ne 0 ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"amcheck failed on DB: \${DBNAME}"</span>
        <span class="hljs-built_in">exit</span> 125
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span><font></font>
EOF<font></font>
chmod +x /tmp/run_amcheck.sh<font></font>
<font></font>
<span class="hljs-comment">#  </span><font></font>
/tmp/run_amcheck.sh &gt; /tmp/amcheck.log<font></font>
<font></font>
<span class="hljs-comment">#         exit code  grep’ </span>
<span class="hljs-keyword">if</span> grep <span class="hljs-string">'amcheck failed'</span> <span class="hljs-string">"/tmp/amcheck.log"</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'amcheck failed: '</span><font></font>
    cat /tmp/amcheck.log<font></font>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Résumer</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'exprime ma gratitude à Andrei Borodin pour son aide dans la préparation de la publication et je remercie tout spécialement sa contribution au développement de WAL-G! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur cette note a pris fin. </font><font style="vertical-align: inherit;">J'espère avoir pu transmettre la facilité de configuration et l'énorme potentiel d'utilisation de cet outil dans votre entreprise. </font><font style="vertical-align: inherit;">J'ai beaucoup entendu parler de WAL-G, mais je n'ai pas eu assez de temps pour m'asseoir et comprendre. </font><font style="vertical-align: inherit;">Et après l'avoir présenté à la maison, cet article est sorti de moi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par ailleurs, il convient de noter que WAL-G peut également fonctionner avec les SGBD suivants:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL / MariaDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FoundationDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et à en juger par les commits - quelques autres sont attendus!</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr506594/index.html">Redis Best Practices, Partie 3</a></li>
<li><a href="../fr506598/index.html">Microsoft: Rust является 'лучшим шансом' в отрасли программирования безопасных систем</a></li>
<li><a href="../fr506600/index.html">Le contrat de développement du site en termes de gestion de projet (théorie + échantillon)</a></li>
<li><a href="../fr506604/index.html">Concurrence et efficacité: Python vs FSM</a></li>
<li><a href="../fr506606/index.html">Création d'un clicker PIXI.js</a></li>
<li><a href="../fr506612/index.html">Comment augmenter l'exhaustivité de cours en ligne massifs</a></li>
<li><a href="../fr506620/index.html">Pensée créative: qu'est-ce que c'est, comment mesurer et augmenter votre potentiel</a></li>
<li><a href="../fr506624/index.html">FOSS News n ° 20 - revue des nouvelles gratuites et open source du 8 au 14 juin 2020</a></li>
<li><a href="../fr506626/index.html">Kamailio SBC ou pas SBC?</a></li>
<li><a href="../fr506628/index.html">Le condensé de matériaux intéressants pour le développeur mobile # 348 (du 8 au 14 juin)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>