<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚Ü™Ô∏è üë©üèΩ‚Äçüíª üçµ WAL-G: Sauvegardes et restauration de bases de donn√©es PostgreSQL üë©üèº‚Äçüç≥ üìÉ üë±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On sait depuis longtemps que faire des sauvegardes dans des vidages SQL (en utilisant pg_dump ou pg_dumpall ) n'est pas une bonne id√©e. Pour sauvegard...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WAL-G: Sauvegardes et restauration de bases de donn√©es PostgreSQL</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/506610/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On sait depuis longtemps que faire des sauvegardes dans des </font><b><font style="vertical-align: inherit;">vidages</font></b><font style="vertical-align: inherit;"> SQL (en utilisant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dumpall</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) n'est pas une bonne id√©e. Pour sauvegarder PostgreSQL, il est pr√©f√©rable d'utiliser la commande </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_basebackup</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui cr√©e une copie binaire des journaux WAL. Mais lorsque vous commencerez √† √©tudier l'ensemble du processus de cr√©ation d'une sauvegarde et d'une restauration, vous comprendrez que vous devez √©crire au moins quelques tricycles pour que tout cela fonctionne et ne vous fasse pas mal d'en haut et d'en bas. Afin d'all√©ger les souffrances, WAL-G a √©t√© d√©velopp√©. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un outil √©crit en Go pour sauvegarder et restaurer les bases de donn√©es PostgreSQL ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et plus r√©cemment, MySQL / MariaDB, MongoDB et FoundationDB</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">Il prend en charge le travail avec les stockages Amazon S3 (et analogues, par exemple, Yandex Object Storage), ainsi que Google Cloud Storage, Azure Storage, Swift Object Storage et uniquement avec le syst√®me de fichiers. </font><font style="vertical-align: inherit;">L'ensemble de l'installation est r√©duit √† de simples √©tapes, mais en raison du fait que les articles √† ce sujet sont dispers√©s sur Internet, il n'y a pas de manuel complet qui inclurait toutes les √©tapes de et vers (il y a plusieurs articles sur Habr√©, mais de nombreux points manquent l√†).</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9i/pq/ut/9ipqut4x24_-0192l8skbzkri6o.jpeg" alt="sauvegarde postgresql"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cet article est √©crit principalement pour syst√©matiser vos connaissances. </font><font style="vertical-align: inherit;">Je ne suis pas un DBA et je peux m'exprimer quelque part dans un langage de d√©veloppement philistin, donc toute correction est la bienvenue! </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©par√©ment, je note que tout ce qui suit est pertinent et v√©rifi√© pour PostgreSQL 12.3 sur Ubuntu 18.04, toutes les commandes doivent √™tre ex√©cut√©es en tant qu'utilisateur privil√©gi√©.</font></font></i><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installation</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au moment d'√©crire ces </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lignes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la version stable de WAL-G est la </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">v0.2.15 (mars 2020)</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Nous allons l'utiliser ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mais si vous voulez l'assembler vous-m√™me √† partir de la branche master, le r√©f√©rentiel github a toutes les instructions pour cela</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Pour t√©l√©charger et installer, vous devez faire:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
curl -L <span class="hljs-string">"https://github.com/wal-g/wal-g/releases/download/v0.2.15/wal-g.linux-amd64.tar.gz"</span> -o <span class="hljs-string">"wal-g.linux-amd64.tar.gz"</span><font></font>
tar -xzf wal-g.linux-amd64.tar.gz<font></font>
mv wal-g /usr/<span class="hljs-built_in">local</span>/bin/
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, vous devez d'abord configurer WAL-G, puis PostgreSQL lui-m√™me.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de WAL-G</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour un exemple de stockage de sauvegarde, Amazon S3 sera utilis√© ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">car il est plus proche de mes serveurs et son utilisation est tr√®s bon march√©</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font><font style="vertical-align: inherit;">Pour l'utiliser, vous avez besoin d'un ¬´compartiment s3¬ª et de cl√©s d'acc√®s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous les articles pr√©c√©dents sur WAL-G utilisaient la configuration √† l'aide de variables d'environnement, mais √† partir de cette version, les param√®tres peuvent √™tre situ√©s dans le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fichier .walg.json</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">r√©pertoire de base</font></a><font style="vertical-align: inherit;"> de l'utilisateur postgres. </font><font style="vertical-align: inherit;">Pour le cr√©er, ex√©cutez le script bash suivant:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
cat &gt; /var/lib/postgresql/.walg.json &lt;&lt; EOF<font></font>
{<font></font>
    <span class="hljs-string">"WALG_S3_PREFIX"</span>: <span class="hljs-string">"s3://your_bucket/path"</span>,
    <span class="hljs-string">"AWS_ACCESS_KEY_ID"</span>: <span class="hljs-string">"key_id"</span>,
    <span class="hljs-string">"AWS_SECRET_ACCESS_KEY"</span>: <span class="hljs-string">"secret_key"</span>,
    <span class="hljs-string">"WALG_COMPRESSION_METHOD"</span>: <span class="hljs-string">"brotli"</span>,
    <span class="hljs-string">"WALG_DELTA_MAX_STEPS"</span>: <span class="hljs-string">"5"</span>,
    <span class="hljs-string">"PGDATA"</span>: <span class="hljs-string">"/var/lib/postgresql/12/main"</span>,
    <span class="hljs-string">"PGHOST"</span>: <span class="hljs-string">"/var/run/postgresql/.s.PGSQL.5432"</span><font></font>
}<font></font>
EOF<font></font>
<span class="hljs-comment">#    :</span><font></font>
chown postgres: /var/lib/postgresql/.walg.json<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'expliquerai un peu √† tous √©gards:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WALG_S3_PREFIX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le chemin vers votre </font><b><font style="vertical-align: inherit;">compartiment</font></b><font style="vertical-align: inherit;"> S3 o√π les sauvegardes seront vers√©es (vous pouvez √† la fois √† la racine et dans le dossier);</font></font></li>
<li><b>AWS_ACCESS_KEY_ID</b> ‚Äì    S3 (<i>      ‚Äì     ReadOnly Policy!        </i>);<br>
</li>
<li><b>AWS_SECRET_ACCESS_KEY</b> ‚Äì     S3;</li>
<li><b>WALG_COMPRESSION_METHOD</b> ‚Äì  ,   Brotli (          /);</li>
<li><b>WALG_DELTA_MAX_STEPS</b> ‚Äì  ¬´¬ª     (      ,      ,      );</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGDATA</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - le chemin vers le r√©pertoire avec les donn√©es de votre base de donn√©es ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous pouvez le d√©couvrir en ex√©cutant la commande </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PGHOST</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - connexion √† la base de donn√©es, avec une sauvegarde locale, il est pr√©f√©rable de le faire via unix-socket, comme dans cet exemple.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
D'autres param√®tres peuvent √™tre trouv√©s dans la documentation: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/wal-g/wal-g/blob/v0.2.15/PostgreSQL.md#configuration</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration de PostgreSQL</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que l'archiveur √† l'int√©rieur de la base de donn√©es t√©l√©charge les journaux WAL dans le cloud et les r√©cup√®re (si n√©cessaire), vous devez d√©finir plusieurs param√®tres dans le fichier de configuration </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/postgresql/12/main/postgresql.conf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Pour commencer, </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous devez vous assurer</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qu'aucun des param√®tres ci-dessous n'est d√©fini sur d'autres valeurs, de sorte que lorsque vous red√©marrez la configuration, le SGBD ne tombe pas. </font><font style="vertical-align: inherit;">Vous pouvez ajouter ces param√®tres en utilisant:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"wal_level=replica"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_mode=on"</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"archive_command='/usr/local/bin/wal-g wal-push \"%p\" &gt;&gt; /var/log/postgresql/archive_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> ‚Äúarchive_timeout=60‚Äù &gt;&gt; /etc/postgresql/12/main/postgresql.conf
<span class="hljs-built_in">echo</span> <span class="hljs-string">"restore_command='/usr/local/bin/wal-g wal-fetch \"%f\" \"%p\" &gt;&gt; /var/log/postgresql/restore_command.log 2&gt;&amp;1' "</span> &gt;&gt; /etc/postgresql/12/main/postgresql.conf<font></font>
<font></font>
<span class="hljs-comment">#     SIGHUP    </span><font></font>
killall -s HUP postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Description des param√®tres √† r√©gler:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal_level</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - combien d'informations √† √©crire dans les magazines WAL, "r√©plique" - pour tout √©crire;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">active</font></b><font style="vertical-align: inherit;"> le t√©l√©chargement des journaux WAL √† l'aide de la commande du param√®tre </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - commande pour archiver le journal WAL termin√©;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_timeout</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - l'archivage des journaux n'est effectu√© que lorsqu'il est termin√©, mais si votre serveur modifie / ajoute un peu de donn√©es √† la base de donn√©es, il est logique de d√©finir une limite en secondes ici, apr√®s quoi la commande d'archivage sera forc√©e ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">j'ai une √©criture intensive dans la base de donn√©es chaque seconde, donc J'ai refus√© de r√©gler ce param√®tre en production</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> );</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">restore_command</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une commande pour restaurer un journal WAL √† partir d'une sauvegarde, elle sera utilis√©e si les derni√®res modifications de la base de donn√©es manquent dans la ¬´sauvegarde compl√®te¬ª (sauvegarde de base).</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez en savoir plus sur tous ces param√®tres dans la traduction de la documentation officielle: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://postgrespro.ru/docs/postgresql/12/runtime-config-wal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration d'une planification de sauvegarde</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'on le veuille ou non, mais cron est le moyen le plus pratique pour commencer. </font><font style="vertical-align: inherit;">C'est ce que nous allons configurer pour cr√©er des sauvegardes. </font><font style="vertical-align: inherit;">Commen√ßons par la commande pour cr√©er une sauvegarde compl√®te: dans wal-g, c'est l'argument pour ex√©cuter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backup-push</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Mais d'abord, il est pr√©f√©rable d'ex√©cuter cette commande manuellement depuis l'utilisateur postgres pour s'assurer que tout va bien (et qu'il n'y a pas d'erreurs d'acc√®s):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les arguments de d√©but indiquent le chemin d'acc√®s au r√©pertoire de donn√©es - je vous rappelle que vous pouvez le reconna√Ætre en ex√©cutant </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_lsclusters</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si tout s'est bien pass√© et que les donn√©es ont √©t√© t√©l√©charg√©es dans le r√©f√©rentiel S3, vous pouvez configurer un lancement p√©riodique dans crontab:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"15 4 * * *    /usr/local/bin/wal-g backup-push /var/lib/postgresql/12/main &gt;&gt; /var/log/postgresql/walg_backup.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#       </span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans cet exemple, le processus de sauvegarde d√©marre tous les jours √† 4 h 15 du matin.</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Supprimer les anciennes sauvegardes</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tr√®s probablement, vous n'avez pas besoin de stocker absolument toutes les sauvegardes de l'√®re m√©sozo√Øque, il sera donc utile de "nettoyer" p√©riodiquement votre stockage (√† la fois les "sauvegardes compl√®tes" et les journaux WAL). </font><font style="vertical-align: inherit;">Nous le ferons √©galement √† travers la t√¢che cron:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"30 6 * * *    /usr/local/bin/wal-g delete before FIND_FULL <span class="hljs-subst">$(date -d '-10 days' '+%FT%TZ')</span> --confirm &gt;&gt; /var/log/postgresql/walg_delete.log 2&gt;&amp;1"</span> &gt;&gt; /var/spool/cron/crontabs/postgres
<span class="hljs-comment">#          (        )</span><font></font>
chown postgres: /var/spool/cron/crontabs/postgres<font></font>
chmod 600 /var/spool/cron/crontabs/postgres<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cron effectuera cette t√¢che tous les jours √† 6h30 du matin, supprimant tout (sauvegardes compl√®tes, deltas et WAL) sauf les copies des 10 derniers jours, mais laissera au moins une sauvegarde </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avant la</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> date sp√©cifi√©e afin que tout point </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apr√®s la</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> date tombe dans PITR .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restore depuis une sauvergarde</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce n'est un secret pour personne que la garantie d'une base saine est la r√©cup√©ration et la v√©rification p√©riodiques de l'int√©grit√© des donn√©es √† l'int√©rieur. Comment r√©cup√©rer en utilisant WAL-G - Je le dirai dans cette section, et nous parlerons des v√©rifications plus tard. </font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">S√©par√©ment, il convient de noter</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que pour la r√©cup√©ration sur un environnement de test (tout ce qui n'est pas de la production) - vous devez utiliser un compte en lecture seule dans S3, afin de ne pas √©craser accidentellement les sauvegardes. Dans le cas de WAL-G, vous devez d√©finir l'utilisateur S3 les droits suivants dans la strat√©gie de groupe ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">effet: autoriser</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetObject</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: ListBucket</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s3: GetBucketLocation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Et, bien s√ªr, n'oubliez pas de d√©finir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">archive_mode = off</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans le fichier de param√®tres </font><i><font style="vertical-align: inherit;">postgresql.conf</font></i><font style="vertical-align: inherit;"> au </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√©alable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">afin que votre base de test ne veuille pas effectuer de sauvegarde silencieusement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La r√©cup√©ration est effectu√©e par un l√©ger mouvement de la main avec la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suppression de toutes les donn√©es PostgreSQL</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (y compris les utilisateurs), donc soyez extr√™mement prudent lorsque vous ex√©cutez les commandes suivantes.</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#     (, pgbouncer),    ,       </span><font></font>
service pgbouncer stop<font></font>
<span class="hljs-comment">#   ,     (, monit),        (   pgsql12)</span><font></font>
monit stop pgsql12<font></font>
<span class="hljs-comment">#    </span><font></font>
service monit stop<font></font>
<span class="hljs-comment">#    </span><font></font>
service postgresql stop<font></font>
<span class="hljs-comment">#       (!!!);     ,      </span><font></font>
rm -rf /var/lib/postgresql/12/main<font></font>
<span class="hljs-comment">#      </span>
su - postgres -c <span class="hljs-string">'/usr/local/bin/wal-g backup-fetch /var/lib/postgresql/12/main LATEST'</span>
<span class="hljs-comment">#      -   (. https://postgrespro.ru/docs/postgresql/12/runtime-config-wal#RUNTIME-CONFIG-WAL-ARCHIVE-RECOVERY ),        postgres</span>
su - postgres -c <span class="hljs-string">'touch /var/lib/postgresql/12/main/recovery.signal'</span>
<span class="hljs-comment">#   ,     </span><font></font>
service postgresql start<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ceux qui veulent v√©rifier le processus de r√©cup√©ration - un petit morceau de bash-magic est pr√©par√© ci-dessous, de sorte qu'en cas de probl√®mes de r√©cup√©ration - le script se bloque avec un code de sortie non nul. </font><font style="vertical-align: inherit;">Dans cet exemple, 120 v√©rifications sont effectu√©es avec un d√©lai d'attente de 5 secondes (seulement 10 minutes pour r√©cup√©rer) pour savoir si le fichier de signal a √©t√© supprim√© (cela signifie que la r√©cup√©ration a r√©ussi):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span><font></font>
CHECK_RECOVERY_SIGNAL_ITER=0<font></font>
<span class="hljs-keyword">while</span> [ <span class="hljs-variable">${CHECK_RECOVERY_SIGNAL_ITER}</span> -le 120 ]
<span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal removed"</span>
        <span class="hljs-built_in">break</span>
    <span class="hljs-keyword">fi</span><font></font>
    sleep 5<font></font>
    ((CHECK_RECOVERY_SIGNAL_ITER+1))<font></font>
<span class="hljs-keyword">done</span><font></font>
<font></font>
<span class="hljs-comment">#        ,    </span>
<span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"/var/lib/postgresql/12/main/recovery.signal"</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"recovery.signal still exists!"</span>
    <span class="hljs-built_in">exit</span> 17
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s une r√©cup√©ration r√©ussie, n'oubliez pas de red√©marrer tous les processus (pgbouncer / monit, etc.).</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√©rification des donn√©es apr√®s r√©cup√©ration</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assurez-vous de v√©rifier l'int√©grit√© de la base de donn√©es apr√®s la r√©cup√©ration, afin qu'il n'y ait aucune situation avec une sauvegarde cass√©e / tordue. </font><font style="vertical-align: inherit;">Et il vaut mieux le faire avec chaque archive cr√©√©e, mais o√π et comment d√©pend de votre imagination (vous pouvez augmenter les serveurs individuels sur une base horaire ou ex√©cuter un test dans CI). </font><font style="vertical-align: inherit;">Mais au moins - vous devez v√©rifier les donn√©es et les index de la base de donn√©es. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour v√©rifier les donn√©es, il suffit de les ex√©cuter via le vidage, mais il est pr√©f√©rable que lors de la cr√©ation de la base de donn√©es, les sommes de contr√¥le soient activ√©es ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sommes de contr√¥le des donn√©es</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-keyword">if</span> ! su - postgres -c <span class="hljs-string">'pg_dumpall &gt; /dev/null'</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'pg_dumpall failed'</span>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour v√©rifier les indices - il existe </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un module amcheck</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nous allons prendre la requ√™te sql pour cela √† partir des </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tests WAL-G</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et construire un peu de logique autour:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment">#  sql-       </span><font></font>
cat &gt; /tmp/amcheck.sql &lt;&lt; EOF<font></font>
CREATE EXTENSION IF NOT EXISTS amcheck;<font></font>
SELECT bt_index_check(c.oid), c.relname, c.relpages<font></font>
FROM pg_index i<font></font>
JOIN pg_opclass op ON i.indclass[0] = op.oid<font></font>
JOIN pg_am am ON op.opcmethod = am.oid<font></font>
JOIN pg_class c ON i.indexrelid = c.oid<font></font>
JOIN pg_namespace n ON c.relnamespace = n.oid<font></font>
WHERE am.amname = <span class="hljs-string">'btree'</span>
AND c.relpersistence != <span class="hljs-string">'t'</span><font></font>
AND i.indisready AND i.indisvalid;<font></font>
EOF<font></font>
chown postgres: /tmp/amcheck.sql<font></font>
<font></font>
<span class="hljs-comment">#          </span>
<span class="hljs-comment"># (       ‚Äì )</span><font></font>
cat &gt; /tmp/run_amcheck.sh &lt;&lt; EOF<font></font>
<span class="hljs-keyword">for</span> DBNAME <span class="hljs-keyword">in</span> \$(su - postgres -c <span class="hljs-string">'psql -q -A -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" '</span>)
<span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Database: \${DBNAME}"</span>
    su - postgres -c <span class="hljs-string">"psql -f /tmp/amcheck.sql -v 'ON_ERROR_STOP=1' \${DBNAME}"</span> &amp;&amp; EXIT_STATUS=\$? || EXIT_STATUS=\$?
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"\${EXIT_STATUS}"</span> -ne 0 ]
    <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"amcheck failed on DB: \${DBNAME}"</span>
        <span class="hljs-built_in">exit</span> 125
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span><font></font>
EOF<font></font>
chmod +x /tmp/run_amcheck.sh<font></font>
<font></font>
<span class="hljs-comment">#  </span><font></font>
/tmp/run_amcheck.sh &gt; /tmp/amcheck.log<font></font>
<font></font>
<span class="hljs-comment">#         exit code  grep‚Äô </span>
<span class="hljs-keyword">if</span> grep <span class="hljs-string">'amcheck failed'</span> <span class="hljs-string">"/tmp/amcheck.log"</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'amcheck failed: '</span><font></font>
    cat /tmp/amcheck.log<font></font>
    <span class="hljs-built_in">exit</span> 125
<span class="hljs-keyword">fi</span>
</code></pre><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R√©sumer</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'exprime ma gratitude √† Andrei Borodin pour son aide dans la pr√©paration de la publication et je remercie tout sp√©cialement sa contribution au d√©veloppement de WAL-G! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur cette note a pris fin. </font><font style="vertical-align: inherit;">J'esp√®re avoir pu transmettre la facilit√© de configuration et l'√©norme potentiel d'utilisation de cet outil dans votre entreprise. </font><font style="vertical-align: inherit;">J'ai beaucoup entendu parler de WAL-G, mais je n'ai pas eu assez de temps pour m'asseoir et comprendre. </font><font style="vertical-align: inherit;">Et apr√®s l'avoir pr√©sent√© √† la maison, cet article est sorti de moi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par ailleurs, il convient de noter que WAL-G peut √©galement fonctionner avec les SGBD suivants:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MySQL / MariaDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FoundationDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et √† en juger par les commits - quelques autres sont attendus!</font></font></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr506594/index.html">Redis Best Practices, Partie 3</a></li>
<li><a href="../fr506598/index.html">Microsoft: Rust —è–≤–ª—è–µ—Ç—Å—è '–ª—É—á—à–∏–º —à–∞–Ω—Å–æ–º' –≤ –æ—Ç—Ä–∞—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–∏—Å—Ç–µ–º</a></li>
<li><a href="../fr506600/index.html">Le contrat de d√©veloppement du site en termes de gestion de projet (th√©orie + √©chantillon)</a></li>
<li><a href="../fr506604/index.html">Concurrence et efficacit√©: Python vs FSM</a></li>
<li><a href="../fr506606/index.html">Cr√©ation d'un clicker PIXI.js</a></li>
<li><a href="../fr506612/index.html">Comment augmenter l'exhaustivit√© de cours en ligne massifs</a></li>
<li><a href="../fr506620/index.html">Pens√©e cr√©ative: qu'est-ce que c'est, comment mesurer et augmenter votre potentiel</a></li>
<li><a href="../fr506624/index.html">FOSS News n ¬∞ 20 - revue des nouvelles gratuites et open source du 8 au 14 juin 2020</a></li>
<li><a href="../fr506626/index.html">Kamailio SBC ou pas SBC?</a></li>
<li><a href="../fr506628/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 348 (du 8 au 14 juin)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>