<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñãÔ∏è ‚úîÔ∏è üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ Python integration of Gitlab, Jira and Confluence to automate release builds ü•ã ‚ôéÔ∏è üí≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, at a stand-up, a colleague made a rational proposal : to automate the release build, taking as a basis ready-made already practices for inte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Python integration of Gitlab, Jira and Confluence to automate release builds</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489944/"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recently, at a stand-up, a colleague made a rational proposal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : to automate the release build, taking as a basis ready-made already practices for interacting with Jira written in Python. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The deployment process is as follows: when a sufficient number of tasks that have been tested accumulate, they release a candidate candidate (RC) in each project affected by the tasks, then the tasks are tested as part of RC. After that, the RC is poured onto the staging server, where, in close proximity to the combat environment, it is still tested and a full regression is carried out. And then, after the necessary deployment actions, the fresh release is poured into the master.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Until recently, the entire assembly process was carried out manually by one of the developers. Which took an hour, two or more time and was, it seems to me, not a very interesting occupation. Now, when almost everything is ready, the release of 20 tasks, affecting 5 projects, is going to less than a minute. There remains, of course, conflict resolution, running missed tests, and more, but even taking into account this, the time of developers and testers, who have to wait until someone is the first to free themselves and create RC, is saved a lot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, I set about the task, and it turned out to be very interesting and fascinating. And what else is needed for the pleasure of work, if not exciting projects?</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I studied legacy: it turned out to use the Jira API directly, and it was written, it seemed to me, not optimal. For example, the list of release tasks was obtained as follows: all existing releases were downloaded from Jira, and then each of them by name was compared with the name of our release until the desired one was found:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_release_info</span>(<span class="hljs-params">config</span>):</span><font></font>
<font></font>
   <span class="hljs-keyword">try</span>:<font></font>
<font></font>
       release_input = sys.argv[<span class="hljs-number">1</span>]<font></font>
<font></font>
   <span class="hljs-keyword">except</span> IndexError:<font></font>
<font></font>
       <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">'Enter release name'</span>)<font></font>
<font></font>
   releases_json = requests.get(url=RELEASES_LIST_URL, auth=(login, jira_password).json()<font></font>
<font></font>
   <span class="hljs-keyword">for</span> release <span class="hljs-keyword">in</span> releases_json:<font></font>
<font></font>
       <span class="hljs-keyword">if</span> release[<span class="hljs-string">'name'</span>] == release_input:<font></font>
<font></font>
                ...</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, direct interaction with the API leads to not very readable code. And I didn‚Äôt want to invent a bicycle. My first search on Github led me to the JIRA Python Library, a fairly simple and powerful library. I initially planned to create Marge Requests using the GitPython library, also found on Github. But further study of the issue immediately led to the idea of ‚Äã‚Äãfinding something related not to git, but rather immediately to Gitlab. As a result, I settled on the most famous solution: Python GitLab. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I started by getting a list of tasks in the appropriate status for the release</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . I decided not to strongly alter the previous solution, but to make it more effective by immediately requesting the API of the task of the desired release:</font></font><br>
<br>
<pre><code class="python hljs">fix_issues = jira.search_issues(<span class="hljs-string">f'fixVersion=<span class="hljs-subst">{release_input}</span>'</span>)<font></font>
<font></font>
fix_id = jira.issue(fix_issues.iterable[<span class="hljs-number">0</span>]).fields.fixVersions[<span class="hljs-number">0</span>].id
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although most likely the same thing happens under the hood, however, it turned out to be more beautiful and optimal, but still not very readable. </font><font style="vertical-align: inherit;">Further, from the received tasks, it is necessary to collect links to merge requests. </font><font style="vertical-align: inherit;">I decided to store the found merge requests in namedtuple, they are great for this:</font></font><br>
<br>
<pre><code class="python hljs">Merge_request = namedtuple(<span class="hljs-string">'Merge_request'</span>, [<span class="hljs-string">'url'</span>, <span class="hljs-string">'iid'</span>, <span class="hljs-string">'project'</span>, <span class="hljs-string">'issue'</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merge requests were also received using the Jira API:</font></font><br>
<br>
<pre><code class="python hljs">projects = set()<font></font>
<font></font>
links_json = requests.get(url=REMOTE_LINK.format(issue_number),<font></font>
<font></font>
                            auth=login,jira_password).json()<font></font>
<font></font>
<span class="hljs-keyword">for</span> link <span class="hljs-keyword">in</span> links_json:<font></font>
<font></font>
   url_parts = link[<span class="hljs-string">'object'</span>][<span class="hljs-string">'url'</span>].split(<span class="hljs-string">'/'</span>)<font></font>
<font></font>
   project = <span class="hljs-string">f'<span class="hljs-subst">{url_parts[<span class="hljs-number">4</span>]}</span>'</span><font></font>
<font></font>
   iid = url_parts[<span class="hljs-number">6</span>]<font></font>
<font></font>
   projects.add(project)   </code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that, I decided where I could use the found libraries</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Then, perhaps, I will refactor these pieces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need to check, suddenly the right RC branches already exist, if there were already attempts to build, then they need to be deleted and new ones created. </font><font style="vertical-align: inherit;">I already did this using the Python GitLab library:</font></font><br>
<br>
<pre><code class="python hljs">gl = gitlab.Gitlab(<span class="hljs-string">'https://gitlab...ru/'</span>, private_token=GITLAB_PRIVATE_TOKEN)<font></font>
<font></font>
pr = gl.projects.get(project)<font></font>
<font></font>
<span class="hljs-keyword">try</span>:<font></font>
<font></font>
   rc = pr.branches.get(<span class="hljs-string">f'<span class="hljs-subst">{RC_name}</span>'</span>)<font></font>
<font></font>
   rc.delete()<font></font>
<font></font>
   pr.branches.create({<span class="hljs-string">'branch'</span>: <span class="hljs-string">f'<span class="hljs-subst">{RC_name}</span>'</span>, <span class="hljs-string">'ref'</span>: <span class="hljs-string">'master'</span>})<font></font>
<font></font>
<span class="hljs-keyword">except</span> gitlab.GitlabError:<font></font>
<font></font>
   pr.branches.create({<span class="hljs-string">'branch'</span>: <span class="hljs-string">f'<span class="hljs-subst">{RC_name}</span>'</span>, <span class="hljs-string">'ref'</span>: <span class="hljs-string">'master'</span>})</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that, you can start filling out the table in the Jira assembly task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The information in the table is contained in the following columns: No., Task, Priority, Merge requests from the task in RC, Status of the merge request (whether the tests passed in Gitlab, whether there are conflicts or not, is poured / not poured). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At this step, I encountered an unpleasant Gitlab flaw: if the changes were previously frozen in the destination branch of the merge request, then the Gitlab API, when requesting the status of the merge request, gives an answer about the presence of conflicts. In principle, this can be understood: if there is nothing to pour in, then it will not work, but why say that there is a conflict in this place? Gitlab forums have been asking people for several years, but there are no answers yet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In my case, this leads to a false conflict status and manually checking the merge request. I haven‚Äôt come up with anything yet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The logic when creating merge requests is as follows: if tests are not passed, or there is a conflict, merge requests are created, but they do not flow into RC, the corresponding statuses are put in the table. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To check the execution of the tests, we look for a list of suitable pipelines. </font><font style="vertical-align: inherit;">Gitlab emits them sorted by date in descending order, just as we need. </font><font style="vertical-align: inherit;">We take the first - it will be the one that is needed:</font></font><br>
<br>
<pre><code class="python hljs">pipelines = project.pipelines.list(ref=<span class="hljs-string">f'<span class="hljs-subst">{issue}</span>'</span>)<font></font>
<font></font>
<span class="hljs-keyword">if</span> pipelines:<font></font>
<font></font>
   pipelines = pipelines[<span class="hljs-number">0</span>]<font></font>
<font></font>
   <span class="hljs-keyword">if</span> pipelines.attributes[<span class="hljs-string">'status'</span>] != <span class="hljs-string">'success'</span>:<font></font>
<font></font>
       status = <span class="hljs-string">'(x)   !, '</span></code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then create the merge requests themselves</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We check for open ones, in case this is not the first attempt to build. </font><font style="vertical-align: inherit;">In the absence of the required merge request, create this:</font></font><br>
<br>
<pre><code class="python hljs">mr = project.mergerequests.list(<font></font>
<font></font>
 state=<span class="hljs-string">'opened'</span>,<font></font>
<font></font>
source_branch=source_branch,         target_branch=target_branch)<font></font>
<font></font>
<span class="hljs-keyword">if</span> mr:<font></font>
<font></font>
   mr = mr[<span class="hljs-number">0</span>]<font></font>
<font></font>
<span class="hljs-keyword">else</span>:<font></font>
<font></font>
   mr = project.mergerequests.create(<font></font>
<font></font>
{<span class="hljs-string">'source_branch'</span>: source_branch,<font></font>
<font></font>
           <span class="hljs-string">'target_branch'</span>: target_branch,<font></font>
<font></font>
           <span class="hljs-string">'title'</span>: <span class="hljs-string">f"<span class="hljs-subst">{(MR.issue).replace(<span class="hljs-string">'-'</span>, <span class="hljs-string">'_'</span>)}</span> -&gt; <span class="hljs-subst">{RC_name}</span>"</span>,<font></font>
<font></font>
           <span class="hljs-string">'target_project_id'</span>: PROJECTS_NAMES[MR.project],})<font></font>
<font></font>
status = mr.attributes[<span class="hljs-string">'merge_status'</span>]<font></font>
<font></font>
url = mr.attributes[<span class="hljs-string">'web_url'</span>]<font></font>
<font></font>
<span class="hljs-keyword">return</span> status, url, mr
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MR.issue.replace ('-', '_') - change the name of the task to get rid of Gitlaba's uninformative comments on the task in Jira. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, we look at the status of the received merge request</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : if there is no conflict, we pour it into RC. If there is a conflict, put down the appropriate statuses and leave for manual verification. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, by analogy, we create merge requests from RC to Staging and from Staging to Master for all projects. They will be poured after checking the entire release build in RC branches. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Two fields were added to the Jira task template: for pre-pre-post and post-de-post actions. For all the tasks involved, the algorithm collects a list of such actions and enters the assembly task in order not to forget anything. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And finally, the output in Jira is the creation of an assembly task</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="python hljs">existing_issue = jira.search_issues(<font></font>
<font></font>
<span class="hljs-string">f'project=PROJ AND summary ~ " <span class="hljs-subst">{release_name}</span>"'</span>)<font></font>
<font></font>
<span class="hljs-keyword">if</span> existing_issue:<font></font>
<font></font>
   existing_issue = existing_issue[<span class="hljs-number">0</span>]<font></font>
<font></font>
   existing_issue.update(fields={<font></font>
<font></font>
       <span class="hljs-string">'description'</span>: message,<font></font>
<font></font>
       <span class="hljs-string">'customfield_xxx'</span>: message_before_deploy,<font></font>
<font></font>
       <span class="hljs-string">'customfield_yyy'</span>: message_post_deploy,})<font></font>
<font></font>
<span class="hljs-keyword">else</span>:<font></font>
<font></font>
   issue_dict = {<font></font>
<font></font>
       <span class="hljs-string">"fixVersions"</span>: [{<span class="hljs-string">"name"</span>: release_name,}],<font></font>
<font></font>
       <span class="hljs-string">'project'</span>: {<span class="hljs-string">'key'</span>: <span class="hljs-string">'PROJ'</span>},<font></font>
<font></font>
       <span class="hljs-string">'summary'</span>: <span class="hljs-string">f" <span class="hljs-subst">{release_name}</span>"</span>,<font></font>
<font></font>
       <span class="hljs-string">'description'</span>: message,<font></font>
<font></font>
       <span class="hljs-string">'issuetype'</span>: {<span class="hljs-string">'name'</span>: <span class="hljs-string">'RC'</span>},  <span class="hljs-comment">#      </span><font></font>
<font></font>
       <span class="hljs-string">'customfield_xxx'</span>: message_before_deploy,<font></font>
<font></font>
       <span class="hljs-string">'customfield_yyy'</span>: message_post_deploy,}<font></font>
<font></font>
   new_issue = jira.create_issue(fields=issue_dict)</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further thoughts are as follows</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : running a script on Gitlab with a web hook from Jira. For example, you can make a webhook to create an assembly task (create a special type of task for it), or create a task with the word ‚ÄúAssembly‚Äù in the title. And Gitlab on this hook will either run a bash script that starts the whole process, or raise a Docker image with Python and run a script on it. Although the second option is already too complicated. Yes, and need technical accounts in Jira and Gitlab. In general, there is no final decision yet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After creating RC branches, you can also deploy a test bench on the necessary branches and run regression tests. Jenkins can handle this. But this is also in the plans for now.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This was all for the sake of accelerating the work of testers and freeing developers from routine work. However, the economic sense here is also quite specific: take an average developer (in a vacuum) with a hypothetical salary of 150,000 rubles for 8 hours of working time per day. For two years, we had about 700 releases - this is about the release per day. Some more, some less, but on average, I think, at least an hour of the developer‚Äôs time to build the release was gone. That is, the automation of this process saves the company a minimum of 150,000/8 = 18,750 rubles per month.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Along the way, I made a separate script for myself, showing statistics on the upcoming release: how many tasks, what projects are affected, etc. </font><font style="vertical-align: inherit;">Since if I do not have Developer status in any of the projects in Gitlab, there will be a denial of access when creating merge requests. </font><font style="vertical-align: inherit;">Also, it‚Äôs convenient to know in advance about deployment actions or to catch a task that fell into this release by mistake. </font><font style="vertical-align: inherit;">The distribution of release notifications was resolved using the SMTP and email modules. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I was pleased with the solution to this problem: it is always interesting to learn something new and put it into practice. </font><font style="vertical-align: inherit;">It will be nice if this experience is useful to someone.</font></font><cut></cut></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489932/index.html">Theater: construction and wrecking</a></li>
<li><a href="../en489936/index.html">Getting meterpreter sessions inside a NAT network using Chrome and Pivot machines</a></li>
<li><a href="../en489938/index.html">Satellites' Flaming and Ice Motors</a></li>
<li><a href="../en489940/index.html">Overview and setup of Kata Containers</a></li>
<li><a href="../en489942/index.html">Problems of preparing a sports reserve in computer sports (report)</a></li>
<li><a href="../en489946/index.html">The traumatic culture of crunch in the development studio of the Mortal Kombat series</a></li>
<li><a href="../en489948/index.html">News from the world of OpenStreetMap No. 499 (04.02.2020-10.02.2020)</a></li>
<li><a href="../en489952/index.html">Live and motivating desktop wallpapers</a></li>
<li><a href="../en489954/index.html">Seagate SkyHawk AI - huge and vindictive</a></li>
<li><a href="../en489956/index.html">We animate RecyclerView easily without switching to ViewPager2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>