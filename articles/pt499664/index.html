<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòò üëéüèΩ üë¥üèø Portando APIs para TypeScript como um solucionador de problemas üïµüèø üë®üèæ‚Äçü§ù‚Äçüë®üèΩ üçñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O frontend React do programa Execute foi convertido de JavaScript para TypeScript. Mas o back-end, escrito em Ruby, n√£o tocou. No entanto, os problema...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Portando APIs para TypeScript como um solucionador de problemas</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/499664/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O frontend React do programa Execute foi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">convertido</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de JavaScript para TypeScript. Mas o back-end, escrito em Ruby, n√£o tocou. No entanto, os problemas associados a esse back-end fizeram os desenvolvedores do projeto pensar em mudar do Ruby para o TypeScript. A tradu√ß√£o do material que estamos publicando hoje √© dedicada √† hist√≥ria de portar o back-end do Execute Program do Ruby para o TypeScript e a quais problemas isso ajudou a resolver.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/hu/xl/8o/huxl8onleza7_5gvfndf7s-6sxm.jpeg"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usando o back-end do Ruby, √†s vezes esquecemos que algumas propriedades da API armazenam uma matriz de seq√º√™ncias de caracteres, n√£o uma sequ√™ncia simples. √Äs vezes, alteramos um fragmento da API que era acessado em locais diferentes, mas esquecemos de atualizar o c√≥digo em um desses locais. Esses s√£o os problemas comuns de uma linguagem din√¢mica, caracter√≠sticos de qualquer sistema cujo c√≥digo n√£o √© 100% coberto por testes. (Embora menos comum, isso ocorre quando o c√≥digo √© totalmente coberto por testes.) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, esses problemas desapareceram do front-end desde que o trocamos para o TypeScript. Tenho mais experi√™ncia em programa√ß√£o de servidores do que em cliente, mas, apesar disso, cometi mais erros ao trabalhar com o back-end, e n√£o com o front-end. Tudo isso indicava que o back-end tamb√©m deveria ser convertido para TypeScript.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portamos o back-end do Ruby para o TypeScript em mar√ßo de 2019 em cerca de duas semanas. E tudo funcionou como deveria! Implantamos um novo c√≥digo em produ√ß√£o em 14 de abril de 2019. Era uma vers√£o beta dispon√≠vel para um n√∫mero limitado de usu√°rios. Depois disso, nada quebrou. Os usu√°rios nem perceberam nada. Aqui est√° um gr√°fico que ilustra o estado da nossa base de c√≥digo antes e imediatamente ap√≥s a transi√ß√£o. O eixo x representa o tempo (em dias), o eixo y representa o n√∫mero de linhas de c√≥digo.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b26/90c/6a7/b2690c6a794a02298ad7b124c812d9d5.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traduzindo o frontend de JavaScript para TypeScript e traduzindo o back-end de Ruby para TypeScript</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Durante o processo de portabilidade, escrevi uma grande quantidade de c√≥digo auxiliar. Portanto, temos nossa pr√≥pria ferramenta para executar testes com um volume de 200 linhas. Temos uma biblioteca de 120 linhas para trabalhar com o banco de dados, bem como uma biblioteca de roteamento maior para a API, vinculando o c√≥digo de front-end e back-end.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em nossa pr√≥pria infraestrutura, o mais interessante √© o roteador. √â um wrapper para o Express, garantindo a aplica√ß√£o correta dos tipos usados ‚Äã‚Äãno c√≥digo do cliente e do servidor. Isso significa que, quando uma parte da API √© alterada, a outra nem √© compilada sem fazer altera√ß√µes para eliminar as diferen√ßas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° um manipulador de back-end que retorna uma lista de postagens do blog. </font><font style="vertical-align: inherit;">Este √© um dos fragmentos de c√≥digo semelhantes mais simples do sistema:</font></font><br>
<br>
<pre><code class="javascript hljs">router.handleGet(api.blog, <span class="hljs-keyword">async</span> () =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">return</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">posts</span>: blog.posts,<font></font>
&nbsp;&nbsp;}<font></font>
})<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se mudarmos o nome da chave </font></font><code>posts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para </font></font><code>blogPosts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, obteremos um erro de compila√ß√£o, cujo texto √© mostrado abaixo (aqui, por quest√µes de brevidade, as informa√ß√µes sobre os tipos de objetos s√£o omitidas.)</font></font><br>
<br>
<pre><code class="javascript hljs">Property <span class="hljs-string">'posts'</span> is missing <span class="hljs-keyword">in</span> type <span class="hljs-string">'...'</span> but required <span class="hljs-keyword">in</span> type <span class="hljs-string">'...'</span>.
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada terminal √© definido por um objeto de visualiza√ß√£o </font></font><code>api.someNameHere</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Este objeto √© compartilhado pelo cliente e servidor. </font><font style="vertical-align: inherit;">Observe que os tipos n√£o s√£o mencionados diretamente na declara√ß√£o do manipulador. </font><font style="vertical-align: inherit;">Todos eles s√£o inferidos a partir do argumento </font></font><code>api.blog</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa abordagem funciona para terminais simples, como o terminal descrito acima </font></font><code>blog</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Mas √© adequado para terminais mais complexos. </font><font style="vertical-align: inherit;">Por exemplo, uma API de terminal para trabalhar com li√ß√µes possui uma chave profundamente aninhada de um tipo l√≥gico </font></font><code>.lesson.steps[index].isInteractive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Gra√ßas a tudo isso, agora √© imposs√≠vel cometer os seguintes erros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se tentarmos acessar </font></font><code>isinteractive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o cliente ou tentar retornar essa chave do servidor, o c√≥digo n√£o ser√° compilado. </font><font style="vertical-align: inherit;">O nome da chave deve ser parecido </font></font><code>isInteractive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com uma capital </font></font><code>I</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li>     <code>isInteractive</code>  ‚Äî   .</li>
<li>    <code>isInteractive</code>    <code>number</code>,  , ,  .</li>
<li>     API, ,  <code>isInteractive</code> ‚Äî  ,    , ,   ,           , , ,  .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe que tudo isso inclui gera√ß√£o de c√≥digo. Isso √© feito usando </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">io-ts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e algumas centenas de linhas de c√≥digo de nosso pr√≥prio roteador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Declarar tipos de API requer trabalho adicional, mas o trabalho √© simples. Ao alterar a estrutura da API, precisamos saber como a estrutura do c√≥digo muda. Fazemos altera√ß√µes nas declara√ß√µes da API e, em seguida, o compilador nos aponta para todos os locais onde o c√≥digo precisa ser corrigido.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â dif√≠cil apreciar a import√¢ncia desses mecanismos at√© voc√™ us√°-los por um tempo. Podemos mover objetos grandes de um lugar na API para outro, renomear as chaves, podemos dividir objetos grandes em partes, mesclar objetos pequenos em um objeto, dividir ou mesclar pontos de extremidade inteiros. E podemos fazer tudo isso sem nos preocupar com o fato de que esquecemos de fazer as altera√ß√µes apropriadas no c√≥digo do cliente ou servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui est√° um exemplo real. Recentemente, passei cerca de 20 horas em quatro dias reprojetando o API </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Execute Program</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Toda a estrutura da API foi alterada. Ao comparar o novo c√≥digo de cliente e servidor com o antigo, foram registradas dezenas de milhares de altera√ß√µes de linha. Redesenhei o c√≥digo de roteamento do servidor (como o acima</font></font><code>handleGet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) Reescrevi todas as declara√ß√µes de tipo para a API, fazendo muitas delas grandes mudan√ßas estruturais. Al√©m disso, reescrevi todas as partes do cliente nas quais as APIs alteradas foram chamadas. Durante este trabalho, 246 dos 292 arquivos de origem foram alterados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na maior parte deste trabalho, contei apenas com um sistema de tipos. Na √∫ltima hora deste caso de 20 horas, comecei a executar testes que, na maioria das vezes, foram conclu√≠dos com √™xito. No final, fizemos uma execu√ß√£o completa de testes e encontramos tr√™s pequenos erros. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos esses foram erros l√≥gicos: condi√ß√µes que acidentalmente levaram o programa ao lugar errado. Normalmente, um sistema de tipos n√£o ajuda a encontrar esses erros. Demorou alguns minutos para corrigir esses erros. Essa API reprojetada foi implantada h√° alguns meses atr√°s. Quando voc√™ l√™ algo sobre</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nosso site</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - √© essa API que emite materiais relevantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso n√£o significa que o sistema de tipo est√°tico garante que o c√≥digo esteja sempre correto. Este sistema n√£o permite prescindir de testes. Mas isso simplifica bastante a refatora√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou falar sobre a gera√ß√£o autom√°tica de c√≥digo. Ou seja, usamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esquemas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para gerar defini√ß√µes de tipo a partir da estrutura de nosso banco de dados. O sistema se conecta ao banco de dados do Postgres, analisa os tipos de coluna e grava as defini√ß√µes de tipo TypeScript correspondentes no arquivo regular </font></font><code>.d.ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usado pelo aplicativo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um arquivo com tipos de esquema de banco de dados √© atualizado por nosso script de migra√ß√£o toda vez que √© iniciado. Devido a isso, n√£o precisamos oferecer suporte manualmente a esses tipos. Os modelos usam defini√ß√µes de tipos de banco de dados para garantir que o c√≥digo do aplicativo acesse corretamente tudo o que est√° armazenado no banco de dados. N√£o h√° tabelas ausentes, colunas ausentes ou entradas </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em colunas n√£o suportadas </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Lembramos de processar corretamente </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nas colunas de suporte </font></font><code>null</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. E tudo isso √© verificado estaticamente no momento da compila√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo isso juntos cria uma cadeia de transfer√™ncia de informa√ß√µes com tipo estat√≠stico confi√°vel, estendendo-se do banco de dados √†s propriedades dos componentes React no frontend:</font></font><br>
<br>
<ul>
<li>      ,     (    API)     ,          .</li>
<li>     API    ,   API,      (     )  .</li>
<li>  React-   ,   API,     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enquanto trabalhava neste material, n√£o consegui lembrar de um √∫nico caso de inconsist√™ncia no c√≥digo associado √† API que passou na compila√ß√£o. N√£o tivemos falhas de produ√ß√£o devido ao fato de o c√≥digo do cliente e do servidor relacionado √† API ter id√©ias diferentes sobre o formul√°rio de dados. E tudo isso n√£o √© resultado de testes automatizados. N√≥s, para a pr√≥pria API, n√£o escrevemos testes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isso nos coloca em uma posi√ß√£o extremamente agrad√°vel: podemos nos concentrar nas partes mais importantes da aplica√ß√£o. Eu gasto muito pouco tempo fazendo convers√µes de tipo. Muito menos do que passei identificando as causas dos erros confusos que penetraram nas camadas de c√≥digo escritas em Ruby ou JavaScript e causaram estranhas exce√ß√µes em algum lugar muito longe da origem do erro.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â assim que o projeto cuida da tradu√ß√£o do back-end para o TypeScript. </font><font style="vertical-align: inherit;">Como voc√™ pode ver, muito c√≥digo foi escrito desde a transi√ß√£o. </font><font style="vertical-align: inherit;">Tivemos tempo suficiente para avaliar as consequ√™ncias da decis√£o.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/298/9b7/9ba/2989b79ba9dc2a646b7ebeac3ba834bd.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O TypeScript √© usado no front-end e no back-end do projeto, e</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
aqui n√£o levantamos a pergunta usual para essas publica√ß√µes, que √© obter os mesmos resultados n√£o atrav√©s da digita√ß√£o, mas atrav√©s do uso de testes. </font><font style="vertical-align: inherit;">Esses resultados n√£o podem ser alcan√ßados usando apenas testes. </font><font style="vertical-align: inherit;">N√≥s, possivelmente, falaremos mais sobre isso. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Queridos leitores! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ traduziu projetos escritos em outros idiomas para o TypeScript?</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt499652/index.html">Existe vida em desenvolvimento ap√≥s o decreto</a></li>
<li><a href="../pt499654/index.html">Como implementar o CRM em um site remoto e vencer?</a></li>
<li><a href="../pt499656/index.html">Simula√ß√£o do controlador de temperatura PID</a></li>
<li><a href="../pt499658/index.html">Um trabalhador em vez de um testador? Vale a pena estudar Selenium em 2020?</a></li>
<li><a href="../pt499662/index.html">Raiz de confian√ßa para IoT e outras tend√™ncias de seguran√ßa da IoT</a></li>
<li><a href="../pt499666/index.html">PEP 572 (Express√µes de atribui√ß√£o no python 3.8)</a></li>
<li><a href="../pt499668/index.html">Depend√™ncias do JavaScript do caminho para o inferno</a></li>
<li><a href="../pt499670/index.html">–Ø –ø–µ—Ä–µ—Ö–æ–∂—É –Ω–∞ JavaScript</a></li>
<li><a href="../pt499674/index.html">Outro passo para computadores √≥pticos</a></li>
<li><a href="../pt499676/index.html">Mais de 90 ferramentas √∫teis para o Kubernetes: implanta√ß√£o, gerenciamento, monitoramento, seguran√ßa e muito mais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>