<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ ๐ฉ๐ฝโ๐ ๐ค๐ฟ ุฏุนูุง ูุทูุฆ ุงููุฑุงุบ ุ! ุฃูููุณู ููุณููุณูู ๐จ๐พโ๐คโ๐จ๐ป ๐ฉ๐ฟโ๐ง โฑ๏ธ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูู ุชุดููุฑ ุชูุฑูุฑ 2018 ูู ูุจู ุฃูููุณู ููุณููุณูู "ุฏุนููุง ูููู ุงููุฑุงุบุ!"
 

ููุงุญุธุฉ ุงููุญุฑุฑ: ูุฌุจ ุฏุงุฆููุง ููุงุฑูุฉ ุฃู ุชูุตูุงุช ูุชุบููุฑ ุงููุนููุงุช ูู ุชูุงุฑูุฑ ุฃุฎุฑู.
 

ุบุงูุจ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ุฏุนูุง ูุทูุฆ ุงููุฑุงุบ ุ! ุฃูููุณู ููุณููุณูู</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501516/"><h4 id="rasshifrovka-doklada-2018-goda--alekseya-lesovskogo-davayte-otklyuchim-vacuum"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูู ุชุดููุฑ ุชูุฑูุฑ 2018 ูู ูุจู ุฃูููุณู ููุณููุณูู "ุฏุนููุง ูููู ุงููุฑุงุบุ!"</font></font></h4><br>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุงุญุธุฉ ุงููุญุฑุฑ: ูุฌุจ ุฏุงุฆููุง ููุงุฑูุฉ ุฃู ุชูุตูุงุช ูุชุบููุฑ ุงููุนููุงุช ูู ุชูุงุฑูุฑ ุฃุฎุฑู.</font></font></strong></p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุบุงูุจูุง ูุง ุชูุดุฃ ูุซู ูุฐู ุงูุฏุนูุฉ ุนูุฏูุง ุชูุดุฃ ูุดุงูู ูู PostgreSQL ุ ูุงููุดุชุจู ุจู ุงูุฑุฆูุณู ูู </font></font><code>vacuum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ูููุง ููู ุจุจุณุงุทุฉ "ุงููุฑุงุบ"). ูู ุงูุชุฌุฑุจุฉ ุ ูุฎุทู ุงูุนุฏูุฏ ูู ูุฐุง ุฃุดุนู ุงููุงุฑ ุ ูุฒููุงุฆู ูู Data Egret ุบุงูุจูุง ูุง ูุถุทุฑ ุฅูู ุชุณุฑูุน ุงูุนูุงูุจ ุ ูุฃู ูู ุดูุก ูุตุจุญ ุฃุณูุฃ. ูููู ุฅุฐุง ุงูุชุจูุช ุฅูู ุงููุฑุงุบ ููุณู ุ ูุฑุจูุง ูุง ููุฌุฏ ูุซู ูุฐุง ุงูุดุฎุต ุงูุฐู ุณูุณุชุฎุฏู Postgres ุ ููู ุงูููุช ููุณู ูู ููู ูุนุฑู ุดูุฆูุง ุนูู. ุจุนุฏ ูู ุดูุก ุ ูุจุฏุฃ ุชุงุฑูุฎ ุงููุฑุงุบ ููุฐ ูุชุฑุฉ ุทูููุฉ ูุณุจููุง ุ ูุนูู ุงูุฅูุชุฑูุช ููููู ุงูุนุซูุฑ ุนูู ุงููุซูุฑ ูู ุงูููุดูุฑุงุช ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ ุญูู ุงููุฑุงุบ ุ ูุงูููุงูุดุงุช ุงูุถุฎูุฉ ุนูู ุงูููุงุฆู ุงูุจุฑูุฏูุฉ. ุนูู ุงูุฑุบู ูู ุญูููุฉ ุฃู ููุถูุน ุงููุฑุงุบ ููุตูู ุจุงูุชูุตูู ูู ุงููุซุงุฆู ุงูุฑุณููุฉ ูู PostgreSQL ุ ุณุชุณุชูุฑ ุงููุดุงุฑูุงุช ุงูุฌุฏูุฏุฉ ูุงูููุงูุดุงุช ุงูุฌุฏูุฏุฉ ูู ุงูุธููุฑ. ููุนู ูุฐุง ูู ุณุจุจ ุงุฑุชุจุงุท ุงููุซูุฑ ูู ุงูุฎุฑุงูุงุช ูุงูุญูุงูุงุช ููุตุต ุงูุฑุนุจ ูุงูููุงููู ุงูุฎุงุทุฆุฉ ุจุงููุฑุงุบ. ููู ุงูููุช ููุณู ุ ูุนุฏ ุงููุฑุงุบ ุฃุญุฏ ุฃูู ููููุงุช PostgreSQL ุูุนููู ูุคุซุฑ ุจุดูู ูุจุงุดุฑ ุนูู ุงูุฅูุชุงุฌูุฉ. ูู ุงููุณุชุญูู ุฅุฎุจุงุฑ ูู ุดูุก ุนู ุงููุฑุงุบ ูู ุชูุฑูุฑ ูุงุญุฏ ุ ูููู ุฃูุฏ ุฃู ุฃูุดู ุนู ุงูููุงุท ุงูุฑุฆูุณูุฉ ุงููุชุนููุฉ ุจุงููุฑุงุบ ุ ูุซู ููููู ุงูุฏุงุฎูู ุ ูุงูููุฌ ุงูุฑุฆูุณูุฉ ูุถุจุทู ุ ููุฑุงูุจุฉ ุฃุฏุงุฆู ุ ููุฑุงูุจุชู ุ ููุงุฐุง ุฃูุนู ุนูุฏูุง ูููู ุงููุฑุงุบ ูู ุงูุดูุก ุงูุฑุฆูุณู ุงููุดุชุจู ููู ูู ุฌููุน ุงููุดุงูู. ุญุณููุง ุ ูุจุงูุทุจุน ุ ุฃุฑูุฏ ุฃู ุฃุจุฏุฏ ุงูุฃุณุงุทูุฑ ูุงูููุงููู ุงูุฎุงุทุฆุฉ ุงูุดุงุฆุนุฉ ุงููุฑุชุจุทุฉ ุจุงููุฑุงุบ.ุฃุฑูุฏ ุชุจุฏูุฏ ุงูุฎุฑุงูุงุช ูุงูููุงููู ุงูุฎุงุทุฆุฉ ุงูุดุงุฆุนุฉ ุงููุฑุชุจุทุฉ ุจุงููุฑุงุบ.ุฃุฑูุฏ ุชุจุฏูุฏ ุงูุฎุฑุงูุงุช ูุงูููุงููู ุงูุฎุงุทุฆุฉ ุงูุดุงุฆุนุฉ ุงููุฑุชุจุทุฉ ุจุงููุฑุงุบ.</font></font></p><br>
<p><img src="https://habrastorage.org/webt/fx/sv/3m/fxsv3mqxulmnu4rdh_eipwrvvdm.png"></p><a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/eaqnn67RYfU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<p> !   .      :  ,      . ,           .   ,   .  ,       - ,    .</p><br>
<p><img src="https://habrastorage.org/webt/k0/q0/k_/k0q0k_kbdrqxy8aamojouthl0xe.png"></p><br>
<p>   ,     ,      ,       .  ,     .  ,        ,    ,      .</p><br>
<p><img src="https://habrastorage.org/webt/0v/nw/uv/0vnwuvq_xpyl4z2f32zfkyragsg.png"></p><br>
<p> ,     ,   ?</p><br>
<p><img src="https://habrastorage.org/webt/3w/rp/kp/3wrpkpqbjqzuz6k3q8h_s3rzafy.png"></p><br>
<p>               : ยซ    ,  .  - . , ยป. </p><br>
<p>  ?  ,     .   ,      ,   ,  โ 100 % (  ).  ,    .     - . </p><br>
<p><img src="https://habrastorage.org/webt/r0/bi/6q/r0bi6qtbpbdhpmh95itmamo5fny.png"></p><br>
<p>  ,     .  postgresโ . ,   . ,     .  ,        .    .     - . </p><br>
<p><img src="https://habrastorage.org/webt/ki/zn/id/kiznid6nupp9ofsryuotcz9olsk.png"></p><br>
<p>   ,     .  -       ,    ,   , . .     . </p><br>
<p><img src="https://habrastorage.org/webt/7h/2u/3n/7h2u3nqb8mz019qfgwskfv3_23c.png"></p><br>
<p> -   / : ยซ ,     ยป.   ,       .     -  .</p><br>
<p><img src="https://habrastorage.org/webt/en/tn/lj/entnljkothqilsmlubxaxjmglsa.png"></p><br>
<p>     ,  , ,  <code>iotop</code>  ,       .   - .     .               .</p><br>
<p>     .                    .  ,     .</p><br>
<p><img src="https://habrastorage.org/webt/5p/uh/zo/5puhzov2cqvzyprnnt2qpprrnme.png"></p><br>
<p>    ?    , -   .   .   .   . </p><br>
<p><img src="https://habrastorage.org/webt/jg/vf/g3/jgvfg34k-xk3l2xryqvjukmixd4.png"></p><br>
<p>  -  - : ยซ  .       โ <code>autovacuum</code>.          ยป. </p><br>
<p><img src="https://habrastorage.org/webt/ed/ui/p6/eduip6msje8zxkrqnh4-8vabosg.png"></p><br>
<p> ,     , ,     :  ,   .      .      . </p><br>
<p>   ,          . </p><br>
<ul>
<li>    ( DBA)  โ  ,     .       ,        .       ,      . </li>
<li>    ,     .    .     .       . </li>
<li>   ,   <code>shared buffers</code>,          ( , ),   .       .     - ,            shared buffers. </li>
<li>         .   .       โ      . </li>
</ul><br>
<p><img src="https://habrastorage.org/webt/lc/do/dt/lcdodt4jbsygkgp8jx041vcbfsw.png"></p><br>
<p>    .         .      : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">https://github.com/lesovsky/ConferenceStuff/tree/master/2016.highload</a></p><br>
<p>    ?   <code>pgbench</code>      .  pgbench      .            .    ,      . . .      ,      . </p><br>
<p><img src="https://habrastorage.org/webt/cb/xd/97/cbxd97cteefhstwlddgwori2ajc.png"></p><br>
<p>     . ,       .  ,  ,    ,  -    .   ,     Postgres,     (         ,   ).             ,       .</p><br>
<p><img src="https://habrastorage.org/webt/we/ts/d9/wetsd9tb46ev3juckcwk9ezt2ta.png"></p><br>
<p>     ,   MVCC.</p><br>
<p>MVCC (Multi-Version Concurrency Control) โ  ""  ,  Postgres', . .                    .</p><br>
<ul>
<li>    .     .            .</li>
<li>            .</li>
<li> ,    ;     (     ).</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/eo/qt/lc/eoqtlcif0e8ox_ihwmuqclbgwew.png"></p><br>
<p>    ?     .       .     (snapshot).</p><br>
<p><img src="https://habrastorage.org/webt/d-/zx/ja/d-zxjayq6qlxhpcu2bfxythgtqm.png"></p><br>
<p>       :   ,    .              ,        ( COMMIT  ROLLBACK).</p><br>
<p><img src="https://habrastorage.org/webt/6z/ph/sb/6zphsbe6c9bckavrgr_fgbknwme.png"></p><br>
<p>     COMMIT,        ,        .       ,        "  ".   : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">   PostgreSQL</a>.</p><br>
<p>    .   ,  . -    ,     ยซdeleteยป, ยซupdateยป.     .. ""  โ <code>dead tuples</code>. </p><br>
<p><img src="https://habrastorage.org/webt/iw/kx/w0/iwkxw0lsgd6tagswlyis5m65ouu.png"></p><br>
<p>     .    โ    <code>xmin</code>.    ,    . . .    insert,    xmin   . </p><br>
<p>    ,             .       <code>xmax</code>    ,   .</p><br>
<p> delete.   .      โ   <code>xmax</code>     ,    .</p><br>
<p>              ,     ""   .   ,   xmax       .            โ            ,  Postgres         ,        .      -    -       , ..        ,          .</p><br>
<p><img src="https://habrastorage.org/webt/8i/-c/cg/8i-ccgu38dh9ydkg7ue9sk1qqn0.png"></p><br>
<p>     ,    ?    ,    ,                ,    . </p><br>
<p>       .     ,              .      .</p><br>
<p><img src="https://habrastorage.org/webt/7r/cq/f1/7rcqf1nzi4dtbmownh9rqfchbz4.png"></p><br>
<p>  ยซdeleteยป, ยซupdateยป   ,  /            .     ,       ,   -        .</p><br>
<p><img src="https://habrastorage.org/webt/fd/0h/fc/fd0hfcbvlzr83cdaf4ktpwlszoc.png"></p><br>
<p>    ,      .        .</p><br>
<p><img src="https://habrastorage.org/webt/xh/pu/mb/xhpumb0tkvun4urwv534i0s1gje.png"></p><br>
<p>      ,      ,   ,   . .</p><br>
<p><img src="https://habrastorage.org/webt/17/fu/kg/17fukg6fvv_ttf4jdwub_mk27ho.png"></p><br>
<p> :</p><br>
<ul>
<li>   ,    ,   ,   "",    ,      .</li>
<li>  shared buffers             . </li>
<li>   <code>bloat</code> , ..   โ               . </li>
</ul><br>
<p><img src="https://habrastorage.org/webt/5u/sn/se/5usnsewb85uihdn5nenam9yjf2c.png"></p><br>
<p>        .     ?</p><br>
<ul>
<li>-,   .</li>
<li>   Postgres,    .       .    .      ,      ,   -       ,   .</li>
<li>    .    .     .</li>
<li>     โ        .     .         .    ,         .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/ew/8v/dt/ew8vdtf5y49avskvvnunodanele.png"></p><br>
<ul>
<li>      -   . ,     Postgres      .      ,      .   ,      .</li>
<li>           ,     .</li>
<li>    ,    <code>  </code>.     32 , .    4294967296.       ,         .      ,    ,                  (        ).    .. <code>to prevent wraparound vacuum</code>,       .  wraparound vacuum     โ    .</li>
<li>    ,     ,    .          -   .           .        .          ,       .      ,      .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/oo/kv/w0/ookvw0ol3x-fulqpcltgnhw9zwe.png"></p><br>
<ul>
<li><strong>     .</strong>      Postgres ,  Postgres     ,    ,    Pentium,          -   , .     -  .  ,             ,  ,  <strong>    ,   -  .</strong>       .       .</li>
<li> Postgres      .              .       9.6.   ,       9.6     ,       9.6. (    ,     Postgres 12)</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/ob/n6/cn/obn6cnkpbariycrvnlrqxloa2se.png"></p><br>
<p>    - .      .</p><br>
<p><img src="https://habrastorage.org/webt/_w/bj/66/_wbj66wqi-nindu2znh5gsnjqna.png"></p><br>
<p>-,     ,          ..  โ <code>cost-based vacuum</code>.       . </p><br>
<p>  ,   :     .    ,        ( ) โ       .        .</p><br>
<p>      <em> </em>,      <em>  </em>.                 .</p><br>
<p>        .  <code>vacuum_cost_page_hit</code>, <code>vacuum_cost_page_miss</code>, <code>vacuum_cost_page_dirty</code>,   hit, miss, dirty.</p><br>
<p><strong>Hit</strong> โ   ,    ,    shared buffers, . .    .    ,               . </p><br>
<p><strong>Miss</strong> โ      shared buffers       .      .     ,       .     ,     shared buffers,          (page cache)   -  .    ,        .</p><br>
<p><strong>Dirty</strong> โ   ,     ,                .         .</p><br>
<p>         .       <strong>vacuum_cost_limit</strong>.                  .</p><br>
<p>    <strong>vacuum_cost_delay</strong>.   ,     cost limit          .    cost delay     .</p><br>
<p>      ,          ,    ,         .          .   . </p><br>
<p><img src="https://habrastorage.org/webt/km/tg/ci/kmtgcideecl9aqsljdkwouizedw.png"></p><br>
<p>-,    . -    ,    ,   .</p><br>
<ul>
<li>  ,        32  ,       . <strong>,   ,   autovacuum_max_workers   10-15 %     .</strong></li>
<li>  <strong>autovacuum_naptime</strong>.  ,       . <strong>    60 .     .     ,       1 </strong>.  ,              .     ,       โ     . . .    .  ,      .</li>
<li>    โ  ,   <strong>vacuum_cost_limit</strong>,     ,      ,     .    , <strong>vacuum_cost_limit</strong>     .</li>
</ul><br>
<p><img src="https://habrastorage.org/webt/oo/2e/47/oo2e47hrh4hxob8jvyjjucjc0ly.png"></p><br>
<p>-,           ,               .     ,         .           โ      .</p><br>
<p>   .                <strong>autovacuum_vacuum_scale_factor</strong>. scale factor   . -  scale_factor 0.2, . . 20 %.</p><br>
<p>     <strong>autovacuum_vacuum_threshold</strong>. - โ 50 .     ,          ,    .</p><br>
<p><img src="https://habrastorage.org/webt/63/en/ti/63enti4gfce93el_fce3twqvrso.png"></p><br>
<p> , -           20 %.              ,     <strong>autovacuum_vacuum_threshold</strong>   , , 1-2-5 %. </p><br>
<p><img src="https://habrastorage.org/webt/zi/1s/oq/zi1soqr-3vks3mqnxi1hcr1bsyo.png"></p><br>
<p>  ,     <strong>autovacuum_vacuum_scale_factor</strong>    .      .     ,   1 % โ     .     <strong>autovacuum_vacuum_scale_factor</strong>  0.    <strong>autovacuum_vacuum_threshold</strong>, . .  ,     ,    .      <strong>autovacuum_vacuum_scale_factor</strong>     ,       <strong>autovacuum_vacuum_threshold</strong>.</p><br>
<p><img src="https://habrastorage.org/webt/rm/jj/r3/rmjjr3cxwqz4cxutagmm9gcnujo.png"></p><br>
<p>     ,   .  4-5 ,  HDD    ,        .    HDD      .   ,     ,     .   , ,    ,  . </p><br>
<p> SSD    .      SSD        .   ,    . </p><br>
<p>  SSD     .  ,       .    ,    (, ),    .    โ    ,     .</p><br>
<p>    NVMe ,       ,      .    I/O    .     ,       . ,      -  โ   -       .    ,   IO,   ,  .</p><br>
<p><img src="https://habrastorage.org/webt/_w/ui/pp/_wuippkoa0tusm7tvz2tke2admk.png"></p><br>
<p>        -  .   <strong>vacuum_cost_delay</strong>  <strong>vacuum_cost_limit</strong>.        . . .     .        .  .  โ       .          .</p><br>
<p>  ,    .    ,     ,     . </p><br>
<p><img src="https://habrastorage.org/webt/il/wp/7r/ilwp7rhrlmrv9kmau_4z2__plca.png"></p><br>
<pre><code class="plaintext hljs">vacuum_cost_delay = 0<font></font>
vacuum_cost_page_hit = 0<font></font>
vacuum_cost_page_miss = 5<font></font>
vacuum_cost_page_dirty = 5<font></font>
vacuum_cost_limit = 200<font></font>
--<font></font>
autovacuum_max_workers = 10<font></font>
autovacuum_naptime = 1s<font></font>
autovacuum_vacuum_threshold = 50<font></font>
autovacuum_analyze_threshold = 50<font></font>
autovacuum_vacuum_scale_factor = 0.05<font></font>
autovacuum_analyze_scale_factor = 0.05<font></font>
autovacuum_vacuum_cost_delay = 5ms<font></font>
autovacuum_vacuum_cost_limit = -1</code></pre><br>
<p>      SSD ,      .  ,            ,     . </p><br>
<p><strong>   :    SSD.</strong></p><br>
<p><img src="https://habrastorage.org/webt/ix/sd/ob/ixsdobjhrykz7d6mzhdorx66_n0.png"></p><br>
<p>            .   -       ,  -  ""           ,       .</p><br>
<p>          ,    <code>storage parameters</code>.        <code>tablespaces</code>,      .        ,    .</p><br>
<p><img src="https://habrastorage.org/webt/tf/qp/pf/tfqppfseyswfcbfn4fvxsv-74d4.png"></p><br>
<p>  ,        โ    ,     ,               ,      Postgres. ,  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">pgcompacttable</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">pg_repack</a>.</p><br>
<p>   <code>bloat</code>     . </p><br>
<p>      ,         ,   .         โ   ,    (  ).          . </p><br>
<p><img src="https://habrastorage.org/webt/jj/ct/4r/jjct4rtt6pjarvfjpifbvfzt39i.png"></p><br>
<p>        ,   .  -  . </p><br>
<p> Postgres    ,   ,    . </p><br>
<p>   <code>pg_stat_activity</code>.   ,     (<code>view</code>)     ,        ,      .</p><br>
<p>       ,      ,    ,     . . .     pg_stat_atctivity   ().</p><br>
<p><img src="https://habrastorage.org/webt/ad/s1/r3/ads1r32i9l8xq6p0yplfgalwuv8.png"></p><br>
<p>  , ,       .         ,          <code>prevent wraparound</code> .      (<code>autovacuum_max_workers</code>)โ        .</p><br>
<p>       โ       .        , ,       ,                 .        โ          .          .</p><br>
<p><img src="https://habrastorage.org/webt/iv/kt/be/ivktbevhwtimzgspbkqf-x_y9we.png"></p><br>
<p> ,   ,  <code>pg_stat_progress_vacuum</code>      9.6.           .</p><br>
<p>      ,            ,    .    <code>pg_stat_activity</code>    ,    ,    , ,      <code>pg_stat_progress_vacuum</code>     .</p><br>
<p><img src="https://habrastorage.org/webt/rt/xk/fw/rtxkfw2t_nmyn3fuxgpa55eavag.png"></p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">https://github.com/lesovsky/uber-scripts/blob/master/postgresql/sql/vacuum_activity.sql</a></p><br>
<p> ,    ,   ,             .     ,       50 %         .        3 ,       3 .</p><br>
<p> โ         :     ,    .   ,    .</p><br>
<p><img src="https://habrastorage.org/webt/f8/bo/db/f8bodbtuoqugyofhyzvcqqlrv40.png"></p><br>
<p>      :</p><br>
<ul>
<li><strong>  .     .</strong> </li>
<li>   .   cost-based,     cost-. </li>
<li>  โ  .      ,      ,     .</li>
</ul><br>
<p></p><br>
<p><em>!   !   .  9.6       ,   .        ,  ,    ,   .    - ?  ,  -  ?</em></p><br>
<p> .  9.6  freeze-,            .    postgresโ  ,      wraparound vacuum.    ,     . ,  ,     .    , ,       .        ,        9.5  .    ,      .       ,          . </p><br>
<p><em>  ,           buffer cache,     read?</em></p><br>
<p>,  autovacuum worker ,    buffer-.       32 , -.   ,          . </p><br>
<p><em>     ?</em></p><br>
<p>, ,     buffer cache,        page cache,    ,     .     .    ,   page cache,   shared buffers        .</p><br>
<p><em>,    !  ,     .    ,      .  time   .  5  1 ,  .     .            ,      5     100 %   CPU,   storage.      .</em> </p><br>
<p>  โ    .   โ  .       CPU,  -   .      โ     ?       Ubuntu.   Ubuntu       <code>powersave</code>. . .,  ,     3,4 GHz,       โ 1,2.    .      performance  .      . , ,  ,     , ,   ,    .  ,     ,    . </p><br>
<p>              .    ,     , . .   -  ,           .   - bloat -     ,          .          . </p><br>
<p><em>  ! ,       .       :   .   -  autovacuum_vacuum_scale_factor  autovacuum_vacuum_threshold  .        ,     ,  ,     .    ,  naptime    ,    analyze.     Postgres        .    pg_class reltuples</em></p><br>
<p>.</p><br>
<p><em>    .      .</em> </p><br>
<p>. </p><br>
<p><em>         dead tuples  community   ,    2ndQuadrant.  โ .        analyze   reltuples   .</em></p><br>
<p>,  .   โ    .    . <strong>  ,       ยซidle in transactionsยป,     ,      .</strong>     -    .    , . .      ,    . </p><br>
<p><em> ,      ?</em></p><br>
<p>,    MVCC   .       -  ,    .</p><br>
<p><em>     reltuples?</em></p><br>
<p> .   . </p><br>
<p><em>( )   .   ,    .   : update, insert  . .        : ,     .     tuples.    .</em></p><br>
<p>, . .       ,    .        .  reltuples  .     ,    ,     ,    , . . .    -    โ    .      . </p><br>
<p><em>   ,      .         -    ?</em> </p><br>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุงู ูุธุงุฆู ูููุตูุฉ ูู ุฑูุฒ postgres ุชุฌูุน ุฅุญุตุงุกุงุช ุญูู ุชูุฒูุน ุงูุจูุงูุงุช ุฏุงุฎู ุงูุฌุฏุงูู. </font><font style="vertical-align: inherit;">ูุฐุง ูุธุงู ูุฑุนู ุฃูุชููุงุชููู ูููุตู. </font><font style="vertical-align: inherit;">ููุฑุฃ ุจูุงูุงุช ูููุฐุฌูุฉ ุฐุงุช ุญุฌู ูุญุฏูุฏ ูู ุงูุฌุฏูู. </font><font style="vertical-align: inherit;">ูุนูู ุฃุณุงุณู ูุจูู ุชูุฒูุน ุงูุจูุงูุงุช. </font><font style="vertical-align: inherit;">ููุญูุธ ูุฐู ุงููุนูููุงุช ูู ูุชุงููุฌ ุงููุธุงู </font></font><code>pg_statistic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฃู ูู ุทุฑููุฉ ุนุฑุถ ุงููุธุงู </font></font><code>pg_stats</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">ูุนูุฏูุง ูุจูู ุงููุฎุทุท ุฎุทุท ุงุณุชุนูุงู ุ ูุฅูู ููุฑุฃ ุงููุนูููุงุช ูู ูุฐุง ุงูุฏููู. </font><font style="vertical-align: inherit;">ูุนูู ุฃุณุงุณูุง ุชุถุน ุงูุฎุทุท. </font><font style="vertical-align: inherit;">ุซู ูุฎุชุงุฑ ุงูุฃูุถู.</font></font></p></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar501500/index.html">ุงูุฅุฎุชุฑุงู ุงูุจุตุฑู: ูุง ููุฏุฏ ูููู ุชุญูู ููุณู ูู ุงูุชุฌุณุณ</a></li>
<li><a href="../ar501502/index.html">ูุฎุชุจุฑ ุฑููู ุฌุฏูุฏ ููุชูููู ููุงุตู ูุชุงุจ ูุงุฑูุณ ููุณุงุนุฏ ูู ุตูุน ูุนุจุฉ ููุฏูู FPGA</a></li>
<li><a href="../ar501506/index.html">ุญูู ุชุณุฑุจุงุช GDI ูุฃูููุฉ ุงูุญุธ</a></li>
<li><a href="../ar501508/index.html">ูุนูุฉ CRM ุงููุฏููุฉ</a></li>
<li><a href="../ar501510/index.html">ูุธุฑุฉ ุฌุฏูุฏุฉ ุนูู ุชุทููุฑ Fullstack ูุน ุฅุทุงุฑ Ruby on Rails</a></li>
<li><a href="../ar501520/index.html">C # 8 ูุตูุงุญูุฉ ูุงุบูุฉ. ููู ูุนูุด ูุน ูุฐุง</a></li>
<li><a href="../ar501522/index.html">ูุฏูุงุช ูุฌุงููุฉ ุนูู Skillbox: ูุชุงุจุฉ ุงูุฃูุนุงุจ ูู PHP ู Unity ู Unreal Engine</a></li>
<li><a href="../ar501524/index.html">ุฃุณุฑุงุฑ ูุฒุงููุฉ ุงููุฌุงูุงุช ุงูููุฑููุบูุงุทูุณูุฉ ููุฃุฑุถ ูุงููุงุฆู ุงูุญู</a></li>
<li><a href="../ar501526/index.html">ููุงุฐุง ุชุนุชุจุฑ ุงููุบุฉ ุงูุฅูุฌููุฒูุฉ ุงูููุฏูุฉ "ูุฐุฑุฉ" ููุง ุนูุงูุฉ ูููู ุฑููุฒ ุจูุงุ</a></li>
<li><a href="../ar501528/index.html">ูุชุงุจ "ุจุงุด ูุงูุฃูู ุงูุณูุจุฑุงูู: ุงููุฌูู ูุงูุฏูุงุน ูุงูุชุญููู ูู ุณุทุฑ ุฃูุงูุฑ ููููุณ"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>