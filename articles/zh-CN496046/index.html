<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨‍👨‍👦 🎅🏾 👊🏾 STM32F103上的3D图形 🖐🏿 👨🏼‍🔧 ✒️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="关于如何使用既没有速度也没有内存的控制器处理不可编辑并显示实时三维图形的简短故事。
 
 回顾2017年（根据文件修改日期），我决定从AVR控制器切换到功能更强大的STM32。自然，第一个控制器是广为人知的F103。拒绝使用现成的调试板来支持按照其要求从头开始生产是很自然的。奇怪的是，几乎没有门框（...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>STM32F103上的3D图形</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496046/"><img src="https://habrastorage.org/getpro/habr/post_images/7e5/cf8/e1c/7e5cf8e1c0fbc2ee47c87c71d72e865f.jpg" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关于如何使用既没有速度也没有内存的控制器处理不可编辑并显示实时三维图形的简短故事。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
回顾2017年（根据文件修改日期），我决定从AVR控制器切换到功能更强大的STM32。自然，第一个控制器是广为人知的F103。拒绝使用现成的调试板来支持按照其要求从头开始生产是很自然的。奇怪的是，几乎没有门框（除了UART1应该带到普通的连接器上，而且不要在接线上扎手）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
与AVR相比，这款产品的特性相当不错：72 MHz的时钟（实际上，您可以超频至100 MHz，甚至更高，但后果自负！），20 kB的RAM和64 kB的闪存。另外，大量的外围设备在使用时，主要的问题就是不必担心这种丰富的情况，并且意识到不需要铲除所有十个寄存器来启动，只要在正确的寄存器中设置三个位就足够了。至少直到你想要一些奇怪的东西。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当拥有这种能力的第一个欣快感过去时，就产生了一种探索其极限的愿望。作为一个有效的示例，我选择了使用所有这些矩阵，照明，多边形模型以及在ili9341控制器上显示320x240的Z缓冲区来计算三维图形的方法。要解决的两个最明显的问题是速度和体积。每种颜色16位的320x240屏幕尺寸提供每帧150 kB。但是我们拥有的总RAM仅为20 kB ...而这150 kB必须每秒至少传输10次，也就是说，交换速率至少应为1.5 MB / s或12 MB / s，这看起来已经是内核上的一大负担。幸运的是，在该控制器中有一个RAP模块（直接内存访问，也称为直接内存访问，DMA），该模块不允许通过从空到空的输血操作来加载内核。也就是说，您可以准备缓冲区，告诉模块“这里有数据缓冲区，工作！”，这时准备数据以进行下一次传输。考虑到显示器在流中接收数据的能力，出现了以下算法：突出显示前缓冲区，DMA将数据从前缓冲区传输到显示器，进行渲染的后缓冲区，以及用于深度切割的Z缓冲区。缓冲区是显示的单行（或列，无论如何）。而不是150 kB，我们只需要1920字节（每行320像素* 3个缓冲区*每点2字节），非常适合内存。第二次破解是基于以下事实：无法对每一行执行变换矩阵和顶点坐标的计算，否则图像将以最奇怪的方式失真，并且在速度上不利。相反，“外部”计算也就是说，在每个帧上重新计算变换矩阵的乘积及其在顶点上的应用，然后将其转换为中间表示，该中间表示针对渲染为320x1图片进行了优化。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于流氓原因，该库从外部类似于OpenGL。就像在原始OpenGL中一样，渲染从形成转换矩阵开始-清除glLoadIdentity（）使当前矩阵成为单位，然后清除一组转换glRotateXY（...），glTranslate（...），每个转换都与当前矩阵相乘。由于这些计算每帧仅执行一次，因此没有特殊的速度要求；可以省去简单的浮点数，而无需对定点数进行变换。矩阵本身是一个float [4] [4]数组，映射到一维float [16]一维数组-实际上，此方法通常用于动态数组，但您也可以从静态数组中获得一些好处。另一个标准技巧：与其不断计算旋转矩阵中的许多正弦和余弦，预先数数并写在平板电脑上。为此，将整个圆分成256个部分，为每个部分计算正弦值，然后将其转储到sin_table []数组中。好吧，学校里的任何人都可以从正弦得到余弦。值得注意的是，旋转函数在减小到[0 ... 255]范围后，并非以弧度为单位，而是以一整圈的分数为单位。但是，已实现“诚实”功能，可在引擎盖下执行从角度到波瓣的转换。在引擎盖下执行从角度到波瓣的转换。在引擎盖下执行从角度到波瓣的转换。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当矩阵准备就绪时，您可以开始绘制图元。通常，在三维图形中，存在三种类型的图元-点，线和三角形。但是，如果我们对多边形模型感兴趣，则应仅注意三角形。它的“渲染”发生在函数glDrawTriangle（）或glDrawTriangleV（）中。单词“ rendering”用引号引起来，因为在此阶段没有渲染。我们只将原始图元的所有点乘以变换矩阵，然后从中提取边y = ky * x +的解析公式，从而可以找到三角形的所有三个边与当前输出线的交点。我们丢弃其中一个，因为它不位于顶点之间的间隔上，而是位于顶点的延续上。也就是说，要绘制框架，您只需要遍历所有线条，并为每一个绘制相交点之间的区域即可。但是，如果您“正面”应用此算法，则每个图元将与之前绘制的图元重叠。我们需要考虑Z坐标（深度），以使三角形完美地相交。与简单地逐点打印不同，我们将考虑其Z坐标，并与存储在深度缓冲区中的Z坐标进行比较，或者输出（更新Z缓冲区），或者忽略它。为了计算我们感兴趣的线的每个点的Z坐标，我们使用相同的直线公式z = kz * y + bz，该公式由相同的两个带边的交点计算。结果，“半成品”三角形结构glTriangle的对象由三个顶点的X坐标组成（没有存储Y和Z坐标的意义，它们将被计算）和k，b直接系数，好，堆的颜色。在这里，与转换矩阵的计算相反，速度至关重要，因此我们已经使用了定点数。此外，如果对于项b，与坐标（2个字节）相同的精度已足够，则因数k的精度越高越好，因此取4个字节。但不是浮点数，因为即使使用相同的大小，使用整数仍会更快。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，通过调用一堆glDrawTriangle（），我们准备了一个半成品三角形数组。在我的实现中，通过显式函数调用一次推导出一个三角形。实际上，用顶点地址组成的三角形数组是合乎逻辑的，但是在这里我决定不复杂化。无论如何，渲染功能是由机器人编写的，对于他们来说，填写一个常数数组还是编写三百个相同的调用都无关紧要。现在是时候将三角形的半成品转换为屏幕上的精美图片了。为此，将调用glSwapBuffers（）函数。如上所述，它经过显示的各行，搜索与所有三角形的每个交点，并根据深度过滤绘制线段。渲染每行之后，您需要将此行发送到显示器。为此，将启动DMA，它指示字符串的地址及其大小。同时，DMA有效，您可以切换到另一个缓冲区并渲染下一行。最重要的是，如果您突然提前完成渲染，不要忘记等待传输结束。为了可视化速度比，我在渲染结束后添加了一个红色LED，在DMA等待完成后添加了一个红色LED。事实证明，类似PWM的东西会根据延迟来调整亮度。从理论上讲，可以使用DMA中断代替“哑”等待，但是我不能使用它们，并且算法将变得更加复杂。对于演示程序，这是多余的。为了可视化速度比，我在渲染结束后添加了一个红色LED，在DMA等待完成后添加了一个红色LED。事实证明，类似PWM的东西会根据延迟来调整亮度。从理论上讲，可以使用DMA中断代替“哑”等待，但是我不能使用它们，并且算法将变得更加复杂。对于演示程序，这是多余的。为了可视化速度比，我在渲染结束后添加了一个红色LED，在DMA等待完成后添加了一个红色LED。事实证明，类似PWM的东西会根据延迟来调整亮度。从理论上讲，可以使用DMA中断，而不是“哑巴”的等待，但是我不能使用它们，算法将变得更加复杂。对于演示程序，这是多余的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上述过程的结果是旋转了三个不同颜色的相交平面的旋转图片，并且速度相当不错：红色LED的亮度很高，这表明内核性能有很大的提高。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
好吧，如果内核处于空闲状态，则需要加载它。我们将用更好的模型加载它。但是，请不要忘记内存仍然非常有限，因此控制器不会实际拉出太多的多边形。最简单的计算表明，减去行缓冲区之类的内存后，就有378个三角形的位置。如实践所示，古老但有趣的哥特式游戏中的模型非常适合此大小。实际上，从那里抽出了蛇和血蝇的模型（在撰写本文和glocoor时，已经在KDPV上炫耀了），然后控制器用尽了闪存。但是游戏模型不适合微控制器使用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假设它们包含动画，纹理等，这对我们没有用，也不适合存储在内存中。幸运的是，blender不仅允许将它们保存为* .obj（更易于解析），而且还可以根据需要减少多边形的数量。此外，借助简单的自写程序obj2arr * .obj，将文件分类为坐标，随后从中形成* .h文件以直接包含在固件中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但就目前而言，这些模型看起来就像普通的卷发污点。在测试模型上，这并没有打扰我们，因为所有的面孔都以自己的颜色绘制，但是没有为模型的每个多边形指定相同的颜色。不，您当然可以用随机的颜色绘制苍蝇，但我检查后看起来会很蓝。尤其是当每一帧的颜色也都发生变化时。...相反，应用另一滴矢量魔术并添加照明。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
原始形式的照明计算包括计算法线和光源方向的标量积，然后乘以面部的“本机”颜色。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们拥有三种模型-从游戏中的两种模型和一种测试中开始。要切换它们，我们将使用焊接在板上的两个按钮之一。同时，您可以添加对处理器的控制。我们已经有了一个控件-与DMA延迟相关联的红色LED。第二个绿色LED会在每次更新帧时闪烁-因此我们可以估算帧率。肉眼大约为15 fps。</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/afyTgpuA6sc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
总的来说，我对结果感到满意：实施一些根本无法解决的事情很不错。</font><font style="vertical-align: inherit;">当然，还有很多要优化和改进的地方，但是这没有什么意义。</font><font style="vertical-align: inherit;">客观地讲，三维图形的控制器很弱，甚至与速度无关，而与RAM有关。</font><font style="vertical-align: inherit;">但是，像任何演示场景样本一样，此项目的价值不在于结果，而在于过程。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果突然对某人感兴趣，可以</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">获得源代码</font><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN496032/index.html">三节点ZooKeeper集群配置和Apache Kafka代理</a></li>
<li><a href="../zh-CN496036/index.html">开源：用于Android的CI / CD和Avito测试基础架构</a></li>
<li><a href="../zh-CN496038/index.html">胆红素-引起黄疸的分子</a></li>
<li><a href="../zh-CN496040/index.html">10 Zen Lifehacks</a></li>
<li><a href="../zh-CN496044/index.html">航天器的发射和该地区的天气</a></li>
<li><a href="../zh-CN496050/index.html">老虎和狮子在纽约感染冠状病毒</a></li>
<li><a href="../zh-CN496052/index.html">服务公司如何避免客户罚款？过程自动化的几个明显优势</a></li>
<li><a href="../zh-CN496056/index.html">数字化：数字和术语如何欺骗我们</a></li>
<li><a href="../zh-CN496058/index.html">为什么要对农业联合收割机进行机械化，有哪些困难？两年内我们如何做到</a></li>
<li><a href="../zh-CN496064/index.html">激光“冲击波”操作模型</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>