<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüéì üêë üåπ Actualizaci√≥n de MySQL (Servidor Percona) de 5.7 a 8.0 üé∂ üì° üôáüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El progreso no se detiene, por lo que las razones para actualizar a las √∫ltimas versiones de MySQL son cada vez m√°s importantes. No hace mucho tiempo,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Actualizaci√≥n de MySQL (Servidor Percona) de 5.7 a 8.0</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/500706/"><img src="https://habrastorage.org/webt/gr/ty/r9/grtyr9g5ysbgx9woi8ldfpn91ac.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El progreso no se detiene, por lo que las razones para actualizar a las √∫ltimas versiones de MySQL son cada vez m√°s importantes. </font><font style="vertical-align: inherit;">No hace mucho tiempo, en uno de nuestros proyectos, era hora de actualizar los acogedores cl√∫steres de Percona Server 5.7 a la versi√≥n 8. </font><font style="vertical-align: inherit;">Todo esto sucedi√≥ en la plataforma Ubuntu Linux 16.04. </font><font style="vertical-align: inherit;">C√≥mo realizar una operaci√≥n similar con un tiempo de inactividad m√≠nimo y qu√© problemas encontramos durante la actualizaci√≥n: lea este art√≠culo.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formaci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cualquier actualizaci√≥n del servidor de la base de datos probablemente est√© relacionada con la migraci√≥n de la base de datos: cambios en los requisitos para los l√≠mites de los recursos del sistema y la correcci√≥n de las configuraciones de la base de datos, que deben eliminarse de las directivas obsoletas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de actualizar, definitivamente pasaremos a la documentaci√≥n oficial:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notas de la versi√≥n de MySQL 8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gu√≠a de actualizaci√≥n de MySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gu√≠a de actualizaci√≥n de Percona</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tutorial de MySQL sobre la actualizaci√≥n de r√©plicas y asistentes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y haz un plan de acci√≥n:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arregle los archivos de configuraci√≥n eliminando directivas obsoletas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verifique la compatibilidad con las utilidades.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actualice las bases de datos esclavas instalando el paquete </font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Actualice el asistente colocando el mismo paquete.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analizaremos cada elemento del plan y veremos qu√© puede salir mal. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°IMPORTANTE! </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El procedimiento de actualizaci√≥n del cl√∫ster MySQL basado en Galera tiene sus propias sutilezas que no se describen en el art√≠culo. </font><font style="vertical-align: inherit;">No debe usar estas instrucciones en este caso.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 1: Verificaci√≥n de configuraciones</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la versi√≥n 8, MySQL fue eliminado </font></font><code>query_cache</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">De hecho, se </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">declar√≥ obsoleto</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la versi√≥n 5.7, pero ahora est√° </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">completamente eliminado</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">En consecuencia, es necesario eliminar las directivas relacionadas. </font><font style="vertical-align: inherit;">Y para el almacenamiento en cach√© de consultas, ahora puede usar herramientas externas, por ejemplo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n se encontraron directivas pro obsoletas en la configuraci√≥n </font></font><code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si en MySQL 5.7 fue posible seleccionar el formato InnoDB, entonces la octava versi√≥n ya funciona </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solo con el formato Barracuda</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestro resultado es la eliminaci√≥n de las siguientes directivas:</font></font><br>
<br>
<ul>
<li> <code>query_cache_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>query_cache_limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y </font></font><code>query_cache_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li> <code>innodb_file_format</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>innodb_file_format_max</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para la verificaci√≥n, utilizaremos la imagen Docker del servidor Percona. </font><font style="vertical-align: inherit;">Pondremos la configuraci√≥n del servidor en el directorio </font></font><code>mysql_config_test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y luego crearemos los directorios para datos y registros. </font><font style="vertical-align: inherit;">Ejemplo de prueba de configuraci√≥n del servidor percona:</font></font><br>
<br>
<pre><code class="bash hljs">mkdir -p {mysql_config_test,mysql_data,mysql_logs}<font></font>
cp -r /etc/mysql/conf.d/* mysql_config_test/<font></font>
docker run  --name some-percona -v $(<span class="hljs-built_in">pwd</span>)/mysql_config_test:/etc/my.cnf.d/  -v $(<span class="hljs-built_in">pwd</span>)/mysql_data/:/var/lib/mysql/ -v $(<span class="hljs-built_in">pwd</span>)/mysql_logs/:/var/<span class="hljs-built_in">log</span>/mysql/ -e MYSQL_ROOT_PASSWORD=<span class="hljs-variable">${MYSQL_PASSWORD}</span> -d percona:8-centos</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resultado: en los registros de Docker o en el directorio con los registros, seg√∫n sus configuraciones, aparecer√° un archivo en el que se describir√°n las directivas del problema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ est√° lo que ten√≠amos:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-04-03T12:44:19.670831Z 0 [Warning] [MY-011068] [Server] The syntax 'expire-logs-days' is deprecated and will be removed in a future release. Please use binlog_expire_logs_seconds instead.<font></font>
2020-04-03T12:44:19.671678Z 0 [Warning] [MY-013242] [Server] --character-set-server: 'utf8' is currently an alias for the character set UTF8MB3, but will be an alias for UTF8MB4 in a future release. Please consider using UTF8MB4 in order to be unambiguous.<font></font>
2020-04-03T12:44:19.671682Z 0 [Warning] [MY-013244] [Server] --collation-server: 'utf8_general_ci' is a collation of the deprecated character set UTF8MB3. Please consider using UTF8MB4 with an appropriate collation instead.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, a√∫n ten√≠amos que lidiar con las codificaciones y reemplazar la directiva obsoleta </font></font><code>expire-logs-days</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 2: Verificaci√≥n de instalaciones en ejecuci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay 2 utilidades en la documentaci√≥n de actualizaci√≥n para verificar la compatibilidad de la base de datos. </font><font style="vertical-align: inherit;">Su uso ayuda al administrador a verificar la compatibilidad de la estructura de datos existente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comencemos con la cl√°sica utilidad mysqlcheck. </font><font style="vertical-align: inherit;">Simplemente ejecute:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlcheck -u root -p --all-databases --check-upgrade</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si no se detectan problemas, la utilidad saldr√° con el c√≥digo 0: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xc/f-/yk/xcf-yknfyh2puesxjqupkstv_qo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
adem√°s, la utilidad </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql-shell</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° disponible en versiones modernas de MySQL </font><font style="vertical-align: inherit;">(en el caso de Percona, este es un paquete </font></font><code>percona-mysql-shell</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Es un reemplazo para el cliente mysql cl√°sico y combina las funciones del cliente, el editor SQL y las herramientas de administraci√≥n MySQL. Para verificar el servidor antes de actualizar, puede ejecutar los siguientes comandos a trav√©s de √©l:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlsh -- util check-for-server-upgrade { --user=root --host=1.1.1.1 --port=3306 } --config-path=/etc/mysql/my.cnf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y aqu√≠ est√°n los comentarios que recibimos: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o_/nd/r5/o_ndr55tsfxrr0gbbu7zgala-vu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
en general, nada cr√≠tico, solo advertencias sobre codificaciones </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ver m√°s abajo)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">El resultado general de la implementaci√≥n: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/af/uy/xc/afuyxccks5gfu2w2bl1pgruvv-8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
decidimos que la actualizaci√≥n deber√≠a realizarse sin problemas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una nota sobre las advertencias anteriores que indican problemas de codificaci√≥n. </font><font style="vertical-align: inherit;">El hecho es que UTF-8 en MySQL hasta hace poco </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> era </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">un UTF-8 "real"</font></a><font style="vertical-align: inherit;"> , ya que solo almacenaba 3 bytes en lugar de 4. En MySQL 8, finalmente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decidieron arreglarlo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : el alias </font></font><code>utf8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pronto conducir√° a la codificaci√≥n </font></font><code>utf8mb4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y los antiguos las columnas en las tablas se convertir√°n </font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En el futuro, la codificaci√≥n </font></font><code>utf8mb3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se eliminar√°, pero no en esta versi√≥n. </font><font style="vertical-align: inherit;">Por lo tanto, decidimos arreglar las codificaciones que ya est√°n en una instalaci√≥n funcional del DBMS, despu√©s de actualizarlo.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte 3: actualizaciones del servidor</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øQu√© puede salir mal cuando hay un plan tan elegante? ... Sabiendo que los matices siempre ocurren, realizamos el primer experimento en el MySQL Dev-Cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como ya se mencion√≥, la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentaci√≥n oficial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> destaca el problema de actualizar los servidores MySQL con r√©plicas. La conclusi√≥n es que al principio vale la pena actualizar todas las r√©plicas (esclavas), ya que MySQL 8 puede replicar desde el asistente de la versi√≥n 5.7. Alguna dificultad radica en el hecho de que usamos el modo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maestro &lt;-&gt; maestro</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cuando el maestro remoto est√° en modo de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solo lectura</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Es decir, de hecho, el tr√°fico de combate ingresa a un centro de datos, y el segundo es el respaldo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La topolog√≠a es la siguiente: la </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uw/kx/j0/uwkxj0bwhbtjxd27brnug5iosaq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
actualizaci√≥n debe comenzar con las </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©plicas mysql replica dc 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysql master dc 2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><code>mysql replica dc 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y terminando con el servidor mysql master dc 1. Para una mayor confiabilidad, detuvimos las m√°quinas virtuales, las hicimos instant√°neas y detuvimos la replicaci√≥n con el comando justo antes de la actualizaci√≥n </font></font><code>STOP SLAVE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El resto de la actualizaci√≥n se ve as√≠:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cada r√©plica de reinicio, a√±adiendo la opci√≥n de configuraci√≥n 3: </font></font><code>skip-networking</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>skip-slave-start</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>skip-log-bin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El hecho es que la actualizaci√≥n de la base de datos genera registros binarios con la actualizaci√≥n de las tablas del sistema. </font><font style="vertical-align: inherit;">Estas directivas garantizan que no habr√° cambios en los datos de la aplicaci√≥n en la base de datos y que la informaci√≥n sobre la actualizaci√≥n de las tablas del sistema no entrar√° en los registros binarios. </font><font style="vertical-align: inherit;">Esto evitar√° problemas al reanudar la replicaci√≥n.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instala el paquete </font></font><code>percona-server-server</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es importante tener en cuenta que en MySQL 8, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necesita ejecutar el comando </font></font><code>mysqlupgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">despu√©s de actualizar el servidor.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Despu√©s de un inicio exitoso, reinicie el servidor nuevamente, ya sin los par√°metros que se agregaron en el primer p√°rrafo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nos aseguramos de que la replicaci√≥n funcione correctamente: verificamos </font></font><code>SHOW SLAVE STATUS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y vemos que las tablas con contadores en la base de datos de la aplicaci√≥n est√©n actualizadas.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todo esto parece bastante simple: la actualizaci√≥n del desarrollador fue exitosa. </font><font style="vertical-align: inherit;">Ok, puede planificar de forma segura una actualizaci√≥n nocturna para la producci√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No hubo tristeza - actualizamos productos</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin embargo, trasladar la exitosa experiencia de desarrollo a la producci√≥n no estuvo exenta de sorpresas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afortunadamente, el proceso de actualizaci√≥n en s√≠ comienza con las r√©plicas, por lo tanto, al encontrar dificultades, detuvimos el trabajo y restauramos la r√©plica de la instant√°nea. El estudio del problema fue reprogramado a la ma√±ana siguiente. Las siguientes entradas aparecieron en los registros:</font></font><br>
<br>
<pre><code class="plaintext hljs">2020-01-14T21:43:21.500563Z 2 [ERROR] [MY-012069] [InnoDB] table: t1 has 19 columns but InnoDB dictionary has 20 columns<font></font>
2020-01-14T21:43:21.500722Z 2 [ERROR] [MY-010767] [Server] Error in fixing SE data for db1.t1<font></font>
2020-01-14T21:43:24.208365Z 0 [ERROR] [MY-010022] [Server] Failed to Populate DD tables.<font></font>
2020-01-14T21:43:24.208658Z 0 [ERROR] [MY-010119] [Server] Aborting</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un estudio de los archivos de varias listas de correo en Google llev√≥ a la comprensi√≥n de que tal problema surge debido a un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error de MySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Aunque m√°s bien es incluso un error de utilidad </font></font><code>mysqlcheck</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>mysqlsh</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resulta que MySQL ha cambiado la forma en que se presentan los datos para los campos decimales (int, tinyint, etc.), por lo que se usa otra forma de almacenarlos dentro de mysql-server. Si su base de datos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estaba originalmente</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la versi√≥n 5.5 o 5.1, y luego actualiz√≥ a 5.7, es posible que deba producir </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">algunas tablas. Luego MySQL actualizar√° los archivos de datos, transfiri√©ndolos al formato de almacenamiento actual. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n puede verificar esto con la utilidad </font></font><code>mysqlfrm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs">mysqlfrm --diagnostic -vv /var/lib/mysql/db/table.frm<font></font>
...<font></font>
 <span class="hljs-string">'field_length'</span>: 8,
  <span class="hljs-string">'field_type'</span>: 246, <span class="hljs-comment">#  </span>
  <span class="hljs-string">'field_type_name'</span>: <span class="hljs-string">'decimal'</span>,
  <span class="hljs-string">'flags'</span>: 3,
  <span class="hljs-string">'flags_extra'</span>: 67,
  <span class="hljs-string">'interval_nr'</span>: 0,
 <span class="hljs-string">'name'</span>: <span class="hljs-string">'you_deciaml_column'</span>,<font></font>
...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si </font></font><code>field_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tiene 0, el tipo anterior se usa en la tabla; debe hacerse </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Sin embargo, si el valor es 246, ya tiene un nuevo tipo. Se puede encontrar m√°s informaci√≥n sobre los tipos en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem√°s, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este error</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> considera la segunda raz√≥n posible que nos ha pasado por alto: la falta de tablas InnoDB en la tabla del sistema </font></font><code>INNODB_SYS_TABLESPACES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, si ellas, tablas, se crearon en la versi√≥n 5.1. Para evitar problemas durante la actualizaci√≥n, puede usar el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">script SQL adjunto</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPor qu√© no tuvimos tales problemas en el desarrollo? La base se copia peri√≥dicamente all√≠ desde la producci√≥n, por lo tanto, las </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tablas se recrean</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desafortunadamente, en una base de datos grande que realmente funcione, no funcionar√° solo para tomar y realizar la ubicua </font></font><code>OPTIMIZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Percona-toolkit ayudar√° aqu√≠: la utilidad pt-online-schema-change es excelente para la operaci√≥n OPTIMIZE en l√≠nea. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El plan actualizado fue el siguiente:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Optimizar todas las tablas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Realizar una actualizaci√≥n de la base de datos.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para verificarlo y al mismo tiempo averiguar el tiempo de actualizaci√≥n, deshabilitamos una de las r√©plicas y para todas las tablas ejecutamos el siguiente comando:</font></font><br>
<br>
<pre><code class="bash hljs">pt-online-schema-change --critical-load Threads_running=150 --alter <span class="hljs-string">"ENGINE=InnoDB"</span> --execute --chunk-size 100 --quiet --alter-foreign-keys-method auto h=127.0.0.1,u=root,p=<span class="hljs-variable">${MYSQL_PASSWORD}</span>,D=db1,t=t1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las tablas se actualizan sin bloqueos largos debido al hecho de que la utilidad crea una nueva tabla temporal en la que copia los datos de la tabla principal. </font><font style="vertical-align: inherit;">En el momento en que ambas tablas son id√©nticas, la tabla original se bloquea y se reemplaza por una nueva. </font><font style="vertical-align: inherit;">En nuestro caso, una ejecuci√≥n de prueba mostr√≥ que la actualizaci√≥n de todas las tablas llevar√≠a aproximadamente un d√≠a, pero copiar los datos caus√≥ demasiada carga en los discos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para evitar esto, en producci√≥n agregamos un argumento </font></font><code>--sleep</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con un valor de 10 </font><font style="vertical-align: inherit;">al comando </font><font style="vertical-align: inherit;">: este par√°metro controla la duraci√≥n de la espera despu√©s de transferir un paquete de datos a una nueva tabla. </font><font style="vertical-align: inherit;">De esta forma, puede reducir la carga si una aplicaci√≥n realmente en ejecuci√≥n requiere tiempo de respuesta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de realizar la optimizaci√≥n, la actualizaci√≥n fue exitosa.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... pero no del todo!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Media hora despu√©s de la actualizaci√≥n, el cliente tuvo un problema. </font><font style="vertical-align: inherit;">La base funcion√≥ muy extra√±o: peri√≥dicamente, comenzaron las </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ca√≠das de conexi√≥n</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esto es lo que parec√≠a en el monitoreo: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hu/gn/7v/hugn7vq8clkacetlzfb-gli1bcw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
el gr√°fico de diente de sierra es visible en la captura de pantalla, debido al hecho de que parte de los hilos del servidor MySQL se ca√≠a peri√≥dicamente con un error. </font><font style="vertical-align: inherit;">Errores aparecieron en la aplicaci√≥n:</font></font><br>
<br>
<pre><code class="plaintext hljs">[PDOException] SQLSTATE[HY000] [2002] Connection refused</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una inspecci√≥n r√°pida de los registros revel√≥ que el demonio mysqld no pod√≠a obtener los recursos necesarios del sistema operativo. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al tratar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con los errores, encontramos en el sistema </font><b><font style="vertical-align: inherit;">archivos de pol√≠tica de apariencia "hu√©rfanos"</font></b><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># dpkg -S /etc/apparmor.d/cache/usr.sbin.mysqld</span><font></font>
dpkg-query: no path found matching pattern /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/local/usr.sbin.mysqld</span>
dpkg-query: no path found matching pattern /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld
<span class="hljs-comment"># dpkg -S /etc/apparmor.d/usr.sbin.mysqld</span><font></font>
mysql-server-5.7: /etc/apparmor.d/usr.sbin.mysqld<font></font>
<span class="hljs-comment"># dpkg -l mysql-server-5.7</span>
rc  mysql-server-5.7 5.7.23-0ubuntu0.16.04.1      amd64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estos archivos se formaron durante la actualizaci√≥n a MySQL 5.7 hace un par de a√±os y pertenecen al paquete remoto. </font><font style="vertical-align: inherit;">Eliminar archivos y reiniciar el servicio apparmor resolvi√≥ el problema:</font></font><br>
<br>
<pre><code class="bash hljs">systemctl stop apparmor<font></font>
rm /etc/apparmor.d/cache/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/<span class="hljs-built_in">local</span>/usr.sbin.mysqld<font></font>
rm /etc/apparmor.d/usr.sbin.mysqld<font></font>
systemctl start apparmor</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cualquiera, incluso la operaci√≥n m√°s simple, puede conducir a problemas inesperados. </font><font style="vertical-align: inherit;">E incluso tener un plan bien pensado no siempre garantiza el resultado esperado. </font><font style="vertical-align: inherit;">Ahora, en cualquier plan de actualizaci√≥n, nuestro equipo tambi√©n incluye la limpieza obligatoria de archivos adicionales que podr√≠an aparecer como resultado de acciones recientes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬°Y con este trabajo gr√°fico no tan profesional, me gustar√≠a agradecer a Percona por sus excelentes productos!</font></font><br>
<br>
<img height="75" width="75" src="https://habrastorage.org/webt/b1/af/mg/b1afmgyaozxjh0dqcbr3jrkdlk4.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PD</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lea tambi√©n en nuestro blog:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bases de datos y Kubernetes (revisi√≥n e informe de video)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consejos y trucos de Kubernetes: acelerar el arranque de grandes bases de datos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">" </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 historias pr√°cticas de nuestra vida cotidiana SRE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ";</font></font></li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">    Redis  K8s  -      </a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">  MongoDB  Kubernetes</a>¬ª.</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es500694/index.html">68 consejos no solicitados</a></li>
<li><a href="../es500696/index.html">C√≥mo los zapatos para correr est√°n tratando de adaptarse al pie femenino</a></li>
<li><a href="../es500698/index.html">Evgeny Katyshev: "OpenStreetMap no es adecuado para ninguna informaci√≥n"</a></li>
<li><a href="../es500700/index.html">Soporte para TLS1.3 y expansi√≥n de su cuenta personal: lo que se ha hecho para el primer trimestre de 2020</a></li>
<li><a href="../es500704/index.html">Los unicornios (Airbnb, Uber, Lyft, Careem) despiden a miles de empleados en medio de problemas durante la pandemia de coronavirus</a></li>
<li><a href="../es500708/index.html">Seguridad y DBMS: lo que necesita recordar al elegir herramientas de protecci√≥n</a></li>
<li><a href="../es500712/index.html">Coronavirus digital: una combinaci√≥n de ransomware e infostealer</a></li>
<li><a href="../es500718/index.html">EPAM en modo remoto: c√≥mo funciona</a></li>
<li><a href="../es500720/index.html">Nuevos est√°ndares de seguridad de la informaci√≥n: hacen la vida m√°s dif√≠cil para los atacantes</a></li>
<li><a href="../es500722/index.html">"Hornear hasta que est√© listo": qui√©n guarda grabaciones de cintas raras de una manera tan inusual</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>