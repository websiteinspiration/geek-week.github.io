<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ´ ğŸŒ‰ ğŸ¤¸ğŸ¾ Optimisation massive des requÃªtes PostgreSQL. Kirill Borovikov (Tenseur) ğŸ¡ ğŸ¤¦ğŸ½ ğŸ‘³</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le rapport prÃ©sente quelques approches qui vous permettent de surveiller les performances des requÃªtes SQL lorsqu'elles sont des millions par jour et ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Optimisation massive des requÃªtes PostgreSQL. Kirill Borovikov (Tenseur)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/487380/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le rapport prÃ©sente quelques approches qui vous permettent </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de surveiller les performances des requÃªtes SQL lorsqu'elles sont des millions par jour</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et des centaines de serveurs PostgreSQL contrÃ´lÃ©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelles solutions techniques nous permettent de traiter efficacement un tel volume d'informations et comment elles facilitent la vie d'un dÃ©veloppeur ordinaire.</font></font><br>
<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/5XKbFb-l5Do" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qui s'intÃ©resse Ã  l' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analyse de problÃ¨mes spÃ©cifiques et Ã  diverses techniques pour optimiser</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> les requÃªtes SQL et rÃ©soudre les problÃ¨mes DBA typiques dans PostgreSQL </font><font style="vertical-align: inherit;">? Vous </font><font style="vertical-align: inherit;">pouvez Ã©galement </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lire une sÃ©rie d'articles</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur ce sujet.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/rj/lq/ao/rjlqaolzkdl1dwerrz6q1f41exs.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je m'appelle Kirill Borovikov, je reprÃ©sente la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sociÃ©tÃ© "Tensor"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Plus prÃ©cisÃ©ment, je me spÃ©cialise dans le travail avec les bases de donnÃ©es de notre entreprise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aujourd'hui, je vais vous expliquer comment nous procÃ©dons Ã  l'optimisation des requÃªtes, lorsque vous n'avez pas besoin de Â«rÃ©cupÃ©rerÂ» les performances d'une seule demande, mais de rÃ©soudre le problÃ¨me en masse. Lorsqu'il y a des millions de demandes et que vous devez trouver des </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">approches pour rÃ©soudre</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ce gros problÃ¨me. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En gÃ©nÃ©ral, Â«TensorÂ» pour notre million de clients est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VLSI - notre application</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : un rÃ©seau social d'entreprise, des solutions de communication vidÃ©o, pour la gestion interne et externe des documents, des systÃ¨mes comptables pour la comptabilitÃ© et le stockage ... C'est-Ã -dire une telle Â«mÃ©ga-combinaisonÂ» pour une gestion d'entreprise intÃ©grÃ©e, ce qui reprÃ©sente plus de 100 projets internes diffÃ©rents.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour s'assurer qu'ils fonctionnent et se dÃ©veloppent tous normalement, nous avons 10 centres de dÃ©veloppement Ã  travers le pays, ils ont plus de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000 dÃ©veloppeurs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous travaillons avec PostgreSQL depuis 2008 et avons accumulÃ© une grande partie de ce que nous traitons - il s'agit de donnÃ©es clients, statistiques, analytiques, de donnÃ©es provenant de systÃ¨mes d'information externes - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plus de 400 To</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Seulement Â«en productionÂ», il y a environ 250 serveurs, et au total les serveurs de base de donnÃ©es que nous surveillons sont environ 1000. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dx/sb/ej/dxsbejtgor4d4qc7u1cpkmxptx8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SQL est un langage dÃ©claratif. Vous ne dÃ©crivez pas Â«commentÂ» quelque chose devrait fonctionner, mais Â«ce queÂ» vous voulez recevoir. Le SGBD sait mieux comment faire JOIN - comment connecter vos tablettes, quelles conditions imposer, ce qui se passera par index, quoi ne pas ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certains SGBD acceptent des indices: Â«Non, connectez ces deux tablettes dans telle ou telle file d'attenteÂ», mais PostgreSQL ne le fait pas. Telle est la position consciente des principaux dÃ©veloppeurs: "Mieux vaut terminer l'optimiseur de requÃªte que laisser les dÃ©veloppeurs utiliser une sorte d'indice." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais, malgrÃ© le fait que PostgreSQL ne permet pas Ã  "l'extÃ©rieur" de se contrÃ´ler, il vous permet parfaitement de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voir ce qui se passe "Ã  l'intÃ©rieur"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lorsque vous exÃ©cutez votre requÃªte et oÃ¹ elle a des problÃ¨mes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k_/wc/q0/k_wcq0dayliwb4tturtbl3dmyre.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En gÃ©nÃ©ral, avec quels problÃ¨mes classiques le dÃ©veloppeur [arrive-t-il Ã  DBA] habituellement? "Ici, nous avons rempli la demande, et </font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tout est lent</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , tout se bloque, quelque chose se passe ... Une sorte de problÃ¨me!" </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les raisons sont presque toujours les mÃªmes:</font></font><br>
<br>
<ul>
<li><b>  </b><br>
: Â«   SQL  10   JOIN...Â» â€”  ,       Â«Â»,     .    ,       (10    FROM)   - . [<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>]</li>
<li><b> </b><br>
     PostgreSQL,     Â«Â»  ,   â€”     Â«Â»  .       10 ,   10 ,  PostgreSQL      ,      . [<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>]</li>
<li><b>Â«Â»  </b><br>
          ,     , ,   .  â€¦ -   ,       .</li>
<li><b></b><br>
 ,         (INSERT, UPDATE, DELETE) â€”    .</li>
</ul><br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... Et pour tout le reste, nous avons </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">besoin d'un plan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! Nous devons voir ce qui se passe Ã  l'intÃ©rieur du serveur. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c8/ni/rt/c8nirti-tkun1t6z4sxgpnwfwbw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le plan d'exÃ©cution des requÃªtes pour PostgreSQL est un arbre de l'algorithme d'exÃ©cution des requÃªtes dans une reprÃ©sentation textuelle. C'est l'algorithme qui, Ã  la suite de l'analyse du planificateur, a Ã©tÃ© reconnu comme le plus efficace. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque nÅ“ud d'arborescence est une opÃ©ration: extraire des donnÃ©es d'une table ou d'un index, crÃ©er une image bitmap, joindre deux tables, joindre, croiser ou Ã©liminer des Ã©chantillons. La satisfaction de la demande est un passage Ã  travers les nÅ“uds de cet arbre. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour obtenir un plan de requÃªte, le moyen le plus simple consiste Ã  exÃ©cuter l'instruction </font></font><code>EXPLAIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Pour obtenir tous les attributs rÃ©els, c'est-Ã -dire exÃ©cuter rÃ©ellement une requÃªte basÃ©e sur - </font></font><code>EXPLAIN (ANALYZE, BUFFERS) SELECT ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le mauvais point: lorsque vous l'exÃ©cutez, cela se produit Â«ici et maintenantÂ», il ne convient donc qu'au dÃ©bogage local. Si vous prenez un serveur trÃ¨s chargÃ©, qui subit un flux important de modifications de donnÃ©es, et que vous voyez: Â«Ay! Ici, nous sommes plus lents Ã  </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xia</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> une demande. " Il y a une demi-heure, il y a une heure - pendant que vous exÃ©cutiez et rÃ©cupÃ©riez cette demande des journaux, en la transportant Ã  nouveau sur le serveur, votre ensemble de donnÃ©es et vos statistiques ont changÃ©. Vous l'exÃ©cutez pour dÃ©boguer - et il s'exÃ©cute rapidement! Et vous ne pouvez pas comprendre pourquoi, pourquoi </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c'Ã©tait</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lent. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y9/-t/fu/y9-tfu3qhvhayjt86xoy02qy4ju.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de comprendre ce qui se passait exactement au moment oÃ¹ la requÃªte est exÃ©cutÃ©e sur le serveur, des gens intelligents ont Ã©crit le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">module auto_explain</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il est prÃ©sent dans presque toutes les distributions PostgreSQL les plus courantes, et vous pouvez simplement l'activer dans le fichier de configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
S'il comprend qu'une demande est en cours d'exÃ©cution plus longtemps que la frontiÃ¨re que vous lui avez indiquÃ©e, il prend un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Â«instantanÃ©Â» du plan de cette demande et les Ã©crit ensemble dans un journal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qh/cs/c1/qhcsc15sgsaruhdj6ghcjggfz7c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout semble aller bien maintenant, nous allons dans le journal et voyons lÃ  ... [pas de texte]. Mais nous ne pouvons rien dire sur lui, Ã  part le fait que c'est un excellent plan, car il a fallu 11 ms pour terminer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout semble aller bien - mais rien n'est clair sur ce qui s'est rÃ©ellement passÃ©. En plus du temps total, on ne voit pas grand-chose. Parce que regarder un tel texte en clair "latuha" est gÃ©nÃ©ralement apprÃ©ciÃ©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais mÃªme s'il est aimÃ©, certes inconfortable, mais il y a des problÃ¨mes plus importants:</font></font><br>
<br>
<ul>
<li>   <b>    </b>  .     ,       Index Scan    â€” ,     -  .    ,    Â«Â»   , CTE â€”     Â« Â».</li>
<li> : ,    , â€”  <b>   </b>.      , ,    ,  ,      loops â€”   .         .    ,  ,        ,      â€” - Â« Â».</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ces circonstances, comprenez "Qui est le maillon le plus faible?" </font><font style="vertical-align: inherit;">presque irrÃ©aliste. </font><font style="vertical-align: inherit;">Par consÃ©quent, mÃªme les dÃ©veloppeurs eux-mÃªmes dans le "manuel" Ã©crivent que </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Comprendre le plan est un art qui doit Ãªtre appris, expÃ©rimentÃ© ..."</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous avons 1000 dÃ©veloppeurs, et chacun d'eux ne passera pas cette expÃ©rience dans leur tÃªte. </font><font style="vertical-align: inherit;">Moi, vous, il - ils le savent, et quelqu'un lÃ -bas - n'est plus lÃ . </font><font style="vertical-align: inherit;">Peut-Ãªtre qu'il apprendra, ou peut-Ãªtre pas, mais il doit travailler maintenant - et oÃ¹ obtiendrait-il cette expÃ©rience.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Visualisation du plan</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par consÃ©quent, nous avons rÃ©alisÃ© que pour faire face Ã  ces problÃ¨mes, nous avons besoin d'une </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bonne visualisation du plan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[article]</font></font></a><br>
<br>
<img src="https://habrastorage.org/webt/ev/nz/3g/evnz3gitzrva603ckfpd42ilzas.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Nous avons d'abord fait le tour du marchÃ© - regardons sur Internet ce qui existe en gÃ©nÃ©ral. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais, il s'est avÃ©rÃ© que des solutions relativement Â«liveÂ» qui sont plus ou moins dÃ©veloppÃ©es, il y en a trÃ¨s peu - littÃ©ralement, une chose: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expliquez.depesz.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> d'Hubert Lubaczewski. </font><font style="vertical-align: inherit;">A l'entrÃ©e du champ "nourrir" une reprÃ©sentation textuelle du plan, il vous montre une plaque avec les donnÃ©es analysÃ©es:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temps de travail du nÅ“ud appropriÃ©</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temps total sur tout le sous-arbre</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le nombre d'enregistrements qui ont Ã©tÃ© rÃ©cupÃ©rÃ©s et qui Ã©tait statistiquement attendu</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le corps du nÅ“ud lui-mÃªme</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce service a Ã©galement la possibilitÃ© de partager l'archive de liens. Vous avez lancÃ© votre plan lÃ -bas et dit: "HÃ©, Vasya, voici un lien pour toi, quelque chose ne va pas lÃ -bas." </font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/td/ik/odtdikeo22jwnlaxmizq2jodns0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais il y a quelques problÃ¨mes mineurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, une Ã©norme quantitÃ© de copier-coller. Vous prenez un morceau du journal, vous le mettez lÃ , et encore et encore. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DeuxiÃ¨mement, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'y a pas d'analyse de la quantitÃ© de donnÃ©es lues</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - les tampons mÃªmes qu'elle affiche </font></font><code>EXPLAIN (ANALYZE, BUFFERS)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ici nous ne les voyons pas. Il ne sait tout simplement pas comment les dÃ©monter, les comprendre et travailler avec eux. Lorsque vous lisez beaucoup de donnÃ©es et comprenez que vous pouvez "dÃ©composer" de maniÃ¨re incorrecte sur un disque et un cache en mÃ©moire, ces informations sont trÃ¨s importantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le troisiÃ¨me point nÃ©gatif est le trÃ¨s faible dÃ©veloppement de ce projet. Les commits sont trÃ¨s petits, c'est bon tous les six mois, et le code en Perl.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d9/zu/o6/d9zuo6g5etaeqqdpfsozjtzv09c.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais ce ne sont que des Â«parolesÂ», on pourrait en quelque sorte vivre avec, mais il y a une chose qui nous a dÃ©tournÃ©s de ce service. Ce sont des erreurs d'analyse Common Table Expression (CTE) et divers nÅ“uds dynamiques comme InitPlan / SubPlan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous croyez cette image, nous avons alors le temps d'exÃ©cution total de chaque nÅ“ud individuel est supÃ©rieur au temps d'exÃ©cution total de la demande entiÃ¨re. C'est simple - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le temps de gÃ©nÃ©ration de ce CTE n'a pas Ã©tÃ© soustrait du nÅ“ud CTE Scan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Par consÃ©quent, nous ne connaissons plus la bonne rÃ©ponse, combien a pris l'analyse CTE elle-mÃªme. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/uj/gt/8a/ujgt8auhv331ek_visf6ew7jslq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, nous avons rÃ©alisÃ© qu'il Ã©tait temps d'Ã©crire le nÃ´tre - hourra! Chaque dÃ©veloppeur dit: "Maintenant, nous allons Ã©crire le nÃ´tre, ce sera juste super!"</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils ont pris une pile de services Web typique: le noyau sur Node.js + Express, tirÃ© Bootstrap et pour de beaux diagrammes - D3.js. </font><font style="vertical-align: inherit;">Et nos attentes Ã©taient justifiÃ©es - nous avons reÃ§u le premier prototype en 2 semaines:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">propre analyseur de plan</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
C'est-Ã -dire que maintenant nous pouvons gÃ©nÃ©ralement analyser n'importe quel plan Ã  partir de ceux gÃ©nÃ©rÃ©s par PostgreSQL.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analyse correcte des nÅ“uds dynamiques</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - CTE Scan, InitPlan, SubPlan</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">analyse de la distribution des tampons</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - oÃ¹ les pages de donnÃ©es de la mÃ©moire sont lues, d'oÃ¹ du cache local, d'oÃ¹ du disque</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a reÃ§u une visibilitÃ©</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Pour qu'il ne soit pas Â«dans le journalÂ» qu'il Â«creuseÂ», mais que vous voyez le Â«maillon le plus faibleÂ» immÃ©diatement sur l'image.</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/ou/gb/jf/ougbjf30wnktdmvhpqtjj6feqto.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons obtenu quelque chose comme Ã§a - immÃ©diatement avec la coloration syntaxique. Mais gÃ©nÃ©ralement, nos dÃ©veloppeurs ne travaillent plus avec une prÃ©sentation complÃ¨te du plan, mais avec une prÃ©sentation plus courte. AprÃ¨s tout, nous avons dÃ©jÃ  analysÃ© tous les chiffres et les avons jetÃ©s Ã  gauche et Ã  droite, et au milieu, nous n'avons laissÃ© que la premiÃ¨re ligne: de quel type de nÅ“ud il s'agit: CTE Scan, gÃ©nÃ©ration CTE ou Seq Scan par un certain type d'Ã©tiquette. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette vue abrÃ©gÃ©e est ce que nous appelons le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modÃ¨le de plan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zg/do/j_/zgdoj_caxmbjnyiq_gkiy0cfniw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quoi d'autre serait pratique? Il serait commode de voir quelle proportion de quel nÅ“ud du temps total nous est allouÃ© - et de simplement Â«collerÂ» le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">graphique circulaire</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sur le cÃ´tÃ© </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pointons le nÅ“ud et voyons - avec nous, il s'avÃ¨re que Seq Scan a pris moins d'un quart du temps, et les 3/4 restants ont pris CTE Scan. Horreur! Ceci est une petite remarque sur la Â«cadence de tirÂ» de CTE Scan, si vous les utilisez activement dans vos requÃªtes. Ils ne sont pas trÃ¨s rapides - ils perdent mÃªme avec le scan de table habituel. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[article] </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[article]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Mais gÃ©nÃ©ralement, de tels diagrammes sont plus intÃ©ressants, plus compliquÃ©s lorsque nous pointons immÃ©diatement vers un segment, et nous voyons, par exemple, que plus de la moitiÃ© du temps certains Seq Scan Â«mangeaientÂ». De plus, il y avait une sorte de filtre Ã  l'intÃ©rieur, un tas d'enregistrements ont Ã©tÃ© dÃ©posÃ©s dessus ... Vous pouvez directement lancer cette image au dÃ©veloppeur et dire: Â«Vasya, tout va mal avec toi ici! Comprenez, regardez - quelque chose ne va pas! " </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ul/4i/2q/ul4i2q_4iasvokxfdcwp7jd9tj0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naturellement, il y avait un Â«rÃ¢teauÂ».</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premiÃ¨re chose sur laquelle ils Â«ont marchÃ©Â» est le problÃ¨me de l'arrondissement. Le temps de nÅ“ud de chaque individu dans le plan est indiquÃ© avec une prÃ©cision de 1 Î¼s. Et lorsque le nombre de cycles de nÅ“uds dÃ©passe, par exemple, 1000 - aprÃ¨s l'exÃ©cution, PostgreSQL l'a divisÃ© Â«jusqu'Ã Â», puis dans le calcul inverse, nous obtenons le temps total Â«quelque part entre 0,95 ms et 1,05 msÂ». Lorsque le compte est dÃ©pensÃ© en microsecondes - rien pour le moment, mais dÃ©jÃ  pendant [milli] secondes - il est nÃ©cessaire de prendre en compte ces informations lors du Â«dÃ©liementÂ» des ressources sur les nÅ“uds du plan Â«qui a combien consommÃ© quiÂ». </font></font><br>
<br>
<img src="https://habrastorage.org/webt/fp/ds/f9/fpdsf9qkt6t_0q810uqhmrivc-k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxiÃ¨me point, plus complexe, est la rÃ©partition des ressources (ces mÃªmes tampons) entre les nÅ“uds dynamiques. Cela nous a coÃ»tÃ© les 2 premiÃ¨res semaines sur le prototype plus le plus de la semaine 4.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour obtenir ce problÃ¨me est assez simple - nous faisons un CTE et nous y lisons quelque chose. En fait, PostgreSQL est intelligent et ne lira rien ici. Ensuite, nous en prenons le premier enregistrement, et les cent premiers du mÃªme CTE. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s5/fv/rg/s5fvrgut9bky4uqjgmawpm97ks4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous regardons le plan et comprenons - Ã©trange, nous avons 3 tampons (pages de donnÃ©es) qui ont Ã©tÃ© "consommÃ©s" dans Seq Scan, 1 autre dans CTE Scan et 2 autres dans le deuxiÃ¨me CTE Scan. Autrement dit, si tout est simplement rÃ©sumÃ©, nous obtenons 6, mais de la plaque, nous n'en lisons que 3! CTE Scan ne lit rien de n'importe oÃ¹, mais fonctionne directement avec la mÃ©moire de processus. Autrement dit, il y a clairement quelque chose de mal ici! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, il s'avÃ¨re qu'ici toutes ces 3 pages de donnÃ©es qui ont Ã©tÃ© demandÃ©es Ã  Seq Scan, 1 d'abord demandÃ© le 1er CTE Scan, puis le 2e, et ils en lisent encore 2. Autrement dit, 3 pages ont Ã©tÃ© lues au total donnÃ©es, pas 6.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/3q/5q/nh/3q5qnhygdtg3fh1os2fa-1kixhg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et cette image nous a fait comprendre que la mise en Å“uvre du plan n'est plus un arbre, mais juste une sorte de graphique acyclique. </font><font style="vertical-align: inherit;">Et nous avons obtenu un tableau comme celui-ci pour que nous comprenions "d'oÃ¹-il vient du tout". </font><font style="vertical-align: inherit;">Autrement dit, ici, nous avons crÃ©Ã© un CTE Ã  partir de pg_class, et l'avons demandÃ© deux fois, et presque tout le temps qu'il nous a fallu jusqu'Ã  la branche lorsque nous l'avons demandÃ© la deuxiÃ¨me fois. </font><font style="vertical-align: inherit;">Il est clair que la lecture du 101e record est beaucoup plus chÃ¨re que le 1er de la tablette. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yg/kx/3o/ygkx3o3reytihnn6mkhyys3j7l8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons expirÃ© pendant un moment. </font><font style="vertical-align: inherit;">Ils ont dit: Â«Maintenant, Neo, tu connais le kung-fu! </font><font style="vertical-align: inherit;">Maintenant, notre expÃ©rience est directement sur votre Ã©cran. </font><font style="vertical-align: inherit;">Maintenant, vous pouvez l'utiliser. " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[article]</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consolidation des journaux</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos 1000 dÃ©veloppeurs ont poussÃ© un soupir de soulagement. Mais nous avons compris que nous n'avons que des centaines de serveurs Â«de combatÂ», et tout ce Â«copier-collerÂ» par les dÃ©veloppeurs n'est pas du tout pratique. Nous avons rÃ©alisÃ© que nous devions le rÃ©cupÃ©rer nous-mÃªmes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jl/1t/od/jl1todhk17wci0h_ekudinbrruw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En gÃ©nÃ©ral, il existe un module rÃ©gulier qui peut collecter des statistiques, mais il doit Ã©galement Ãªtre activÃ© dans la configuration - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c'est le module pg_stat_statements</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Mais il ne nous convenait pas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, il attribue </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diffÃ©rents QueryId</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aux mÃªmes requÃªtes sur diffÃ©rents schÃ©mas au sein de la mÃªme base de donnÃ©es </font><font style="vertical-align: inherit;">. Autrement dit, si vous faites d'abord </font></font><code>SET search_path = '01'; SELECT * FROM user LIMIT 1;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puis </font></font><code>SET search_path = '02';</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la mÃªme demande, les statistiques de ce module auront des entrÃ©es diffÃ©rentes, et je ne serai pas en mesure de collecter des statistiques gÃ©nÃ©rales prÃ©cisÃ©ment dans le contexte de ce profil de demande, sans prendre en compte les schÃ©mas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxiÃ¨me point qui nous a empÃªchÃ© de l'utiliser est le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manque de plans</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Autrement dit, il n'y a pas de plan, il n'y a que la demande elle-mÃªme. Nous voyons ce qui ralentissait, mais nous ne comprenons pas pourquoi. Et nous revenons ici au problÃ¨me d'un ensemble de donnÃ©es en Ã©volution rapide. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le dernier point est le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manque de Â«faitsÂ»</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Autrement dit, il est impossible de traiter une instance spÃ©cifique d'exÃ©cution de requÃªte - elle n'est pas lÃ , il n'y a que des statistiques agrÃ©gÃ©es. Bien qu'il soit possible de travailler avec, c'est juste trÃ¨s difficile. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/7x/sr/ij/7xsrijw56i20-dz5oiw0hurx9aq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par consÃ©quent, nous avons dÃ©cidÃ© de lutter contre le Â«copier-collerÂ» et avons commencÃ© Ã  Ã©crire un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">collectionneur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le collecteur est connectÃ© via SSH, Â«tireÂ» une connexion sÃ©curisÃ©e au serveur avec la base de donnÃ©es Ã  l'aide du certificat et </font></font><code>tail -F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Â«s'y accrocheÂ» au fichier journal. Donc, dans cette session</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nous obtenons un Â«miroirÂ» complet de tout le fichier journal</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gÃ©nÃ©rÃ© par le serveur. La charge sur le serveur lui-mÃªme est minime, car nous n'y analysons rien, nous reflÃ©tons simplement le trafic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme nous avons dÃ©jÃ  commencÃ© Ã  Ã©crire l'interface sur Node.js, nous avons continuÃ© Ã  Ã©crire le collecteur dessus. Et cette technologie a portÃ© ses fruits, car il est trÃ¨s pratique d'utiliser JavaScript pour travailler avec des donnÃ©es texte mal formatÃ©es, qui est le journal. Et l'infrastructure Node.js elle-mÃªme en tant que plate-forme backend vous permet de travailler facilement et de maniÃ¨re pratique avec des connexions rÃ©seau, et en fait avec une sorte de flux de donnÃ©es.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En consÃ©quence, nous Â«tironsÂ» deux connexions: la premiÃ¨re consiste Ã  Â«Ã©couterÂ» le journal lui-mÃªme et Ã  le prendre pour nous-mÃªmes, et la seconde consiste Ã  demander pÃ©riodiquement la base de donnÃ©es. "Mais dans le journal, il est arrivÃ© que la plaque contenant lâ€™oid 123 Ã©tait bloquÃ©e", mais cela ne dit rien au dÃ©veloppeur, et ce serait bien de demander Ã  la base de donnÃ©es "Qu'est-ce que OID = 123 aprÃ¨s tout?" Et donc nous demandons pÃ©riodiquement Ã  la base quelque chose que nous ne savons pas encore chez nous. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/vi/ft/gtviftgv1xepi43a7dayhn5-kxy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"Vous n'avez tout simplement pas pris en compte, il y a une sorte d'abeilles ressemblant Ã  des Ã©lÃ©phants! ..." Nous avons commencÃ© Ã  dÃ©velopper ce systÃ¨me lorsque nous voulions surveiller 10 serveurs. Le plus critique dans notre comprÃ©hension, sur lequel il y avait des problÃ¨mes qui Ã©taient difficiles Ã  traiter. Mais au cours du premier trimestre, nous en avons eu une centaine Ã  surveiller - parce que le systÃ¨me Â«est entrÃ©Â», tout le monde le voulait, tout le monde Ã©tait Ã  l'aise.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout cela doit Ãªtre ajoutÃ©, le flux de donnÃ©es est volumineux, actif. En fait, nous surveillons ce que nous sommes capables de gÃ©rer - puis nous l'utilisons. Nous utilisons Ã©galement PostgreSQL comme entrepÃ´t de donnÃ©es. Mais rien n'est plus rapide pour Â«y verserÂ» des donnÃ©es qu'il </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n'y a encore aucun </font><font style="vertical-align: inherit;">opÃ©rateur </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais Â«verserÂ» les donnÃ©es n'est pas vraiment notre technologie. Parce que si vous avez environ 50 000 requÃªtes par seconde sur une centaine de serveurs, cela gÃ©nÃ©rera pour vous 100 Ã  150 Go de journaux par jour. Par consÃ©quent, nous avons dÃ» soigneusement Â«voirÂ» la base. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PremiÃ¨rement, nous avons fait le </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">partitionnement tous les jours</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , car, dans l'ensemble, personne n'est intÃ©ressÃ© par la corrÃ©lation entre les jours. Quelle est la diffÃ©rence que vous aviez hier, si ce soir vous dÃ©ployez une nouvelle version de l'application - et dÃ©jÃ  quelques nouvelles statistiques.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DeuxiÃ¨mement, nous avons appris (ont Ã©tÃ© contraints) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ã  Ã©crire trÃ¨s, trÃ¨s rapidement en utilisant</font></font><code>COPY</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Ce n'est pas seulement </font></font><code>COPY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parce qu'il est plus rapide que </font></font><code>INSERT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais encore plus rapide. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rm/ik/nj/rmiknjdu2ydi-yrbk7v369qe8eu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le troisiÃ¨me point - j'ai dÃ» </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abandonner les dÃ©clencheurs, respectivement, et des clÃ©s Ã©trangÃ¨res</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Autrement dit, nous n'avons pas d'intÃ©gritÃ© absolument rÃ©fÃ©rentielle. Parce que si vous avez une table sur laquelle il y a une paire de FK, et que vous dites dans la structure de la base de donnÃ©es que "voici une entrÃ©e de journal fait rÃ©fÃ©rence Ã  FK, par exemple, un groupe d'enregistrements", alors lorsque vous l'insÃ©rez, PostgreSQL n'a rien d'autre Ã  faire que comment prendre et exÃ©cuter honnÃªtement </font></font><code>SELECT 1 FROM master_fk1_table WHERE ...</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec l'identifiant que vous essayez d'insÃ©rer - juste pour vÃ©rifier que cette entrÃ©e est lÃ , que vous ne "cassez" pas cette clÃ© Ã©trangÃ¨re avec votre insert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous obtenons au lieu d'un enregistrement dans la table cible et ses indices, un autre avantage de la lecture de toutes les tables auxquelles il se rÃ©fÃ¨re. Et nous n'en avons pas du tout besoin - notre tÃ¢che est d'Ã©crire autant que possible et le plus rapidement possible avec le moins de charge possible. Alors FK - vers le bas! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le point suivant est l'agrÃ©gation et le hachage. Initialement, ils ont Ã©tÃ© implÃ©mentÃ©s dans notre base de donnÃ©es - aprÃ¨s tout, il est pratique de faire immÃ©diatement, quand un enregistrement arrive, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Â«plus unÂ»</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans une sorte de plaque </font><b><font style="vertical-align: inherit;">directement dans le dÃ©clencheur</font></b><font style="vertical-align: inherit;"> . C'est bien, c'est pratique, mais la mÃªme chose est mauvaise - insÃ©rez un enregistrement, mais vous Ãªtes obligÃ© de lire et d'Ã©crire autre chose Ã  partir d'une autre table. De plus, non seulement cela, lisez et Ã©crivez - et faites-le Ã  chaque fois. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginez maintenant que vous disposez d'une plaque dans laquelle vous comptez simplement le nombre de demandes transmises Ã  un hÃ´te particulier:</font></font><code>+1, +1, +1, ..., +1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Et vous, en principe, n'en avez pas besoin - tout cela peut Ãªtre </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rÃ©sumÃ© dans la mÃ©moire du collecteur</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et envoyÃ© Ã  la base de donnÃ©es Ã  la fois </font></font><code>+10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oui, votre intÃ©gritÃ© logique peut Â«s'effondrerÂ» en cas de problÃ¨mes, mais c'est presque un cas irrÃ©aliste - parce que vous avez un serveur normal, il a une batterie dans le contrÃ´leur, vous avez un journal des transactions, un journal sur le systÃ¨me de fichiers ... En gÃ©nÃ©ral, non Ã§a vaut le coup. Cela ne vaut pas la perte de productivitÃ© que vous obtenez en raison du travail des dÃ©clencheurs / FK, les coÃ»ts que vous encourez en mÃªme temps.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MÃªme chose avec le hachage. Une certaine demande vous parvient, vous calculez un certain identifiant Ã  partir de la base de donnÃ©es, vous Ã©crivez dans la base de donnÃ©es, puis vous le dites Ã  tout le monde. Tout va bien, jusqu'Ã  ce qu'au moment de l'enregistrement une deuxiÃ¨me personne vienne Ã  vous qui veut l'enregistrer - et vous avez un verrou, et c'est dÃ©jÃ  mauvais. Par consÃ©quent, si vous pouvez supprimer la gÃ©nÃ©ration de certains ID sur le client (par rapport Ã  la base de donnÃ©es), il est prÃ©fÃ©rable de le faire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous Ã©tions juste idÃ©alement adaptÃ©s pour utiliser MD5 Ã  partir du texte - une demande, un plan, un modÃ¨le, ... Nous le calculons du cÃ´tÃ© du collecteur et Â«versonsÂ» l'ID prÃªt Ã  l'emploi dans la base de donnÃ©es. La longueur du MD5 et le partitionnement quotidien nous permettent de ne pas nous inquiÃ©ter d'Ã©ventuelles collisions. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3c/yz/uz/3cyzuzpcxxmshllydd9cjcclc9i.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais pour enregistrer tout cela rapidement, nous devions modifier la procÃ©dure d'enregistrement elle-mÃªme.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment Ã©crivez-vous habituellement les donnÃ©es? Nous avons une sorte de jeu de donnÃ©es, nous le dÃ©composons en plusieurs tableaux, puis COPY - d'abord dans le premier, puis dans le second, dans le troisiÃ¨me ... C'est gÃªnant, car nous Ã©crivons un flux de donnÃ©es en trois Ã©tapes de maniÃ¨re sÃ©quentielle. DÃ©sagrÃ©able. Est-il possible de faire plus vite? Pouvez! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour ce faire, il suffit de dÃ©composer ces flux en parallÃ¨le les uns avec les autres. Il s'avÃ¨re que nous avons des erreurs, des requÃªtes, des modÃ¨les, des verrous, des vols dans des flux sÃ©parÃ©s ... - et nous Ã©crivons tout cela en parallÃ¨le. Pour ce faire, il suffit de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laisser le canal COPY ouvert en permanence sur chaque table cible individuelle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vv/v_/0z/vvv_0zw3lqqoqoznvaaqpvm19wq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, le collecteur a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">toujours un flux</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dans lequel je peux Ã©crire les donnÃ©es dont j'ai besoin. Mais pour que la base de donnÃ©es voit ces donnÃ©es, et que quelqu'un ne se bloque pas dans les verrous, en attendant que ces donnÃ©es soient Ã©crites, la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COPIE doit Ãªtre interrompue Ã  une certaine frÃ©quence</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pour nous, une pÃ©riode de l'ordre de 100 ms s'est avÃ©rÃ©e Ãªtre la plus efficace - fermez-la et ouvrez-la immÃ©diatement Ã  nouveau sur la mÃªme table. Et si nous nâ€™avons pas un flux Ã  certains pics, nous mettons en commun Ã  une certaine limite. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, nous avons dÃ©couvert que pour un tel profil de charge, toute agrÃ©gation lorsque les enregistrements sont collectÃ©s en paquets est mauvaise. Le mal classique </font></font><code>INSERT ... VALUES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dÃ©passe les 1000 records. Parce qu'Ã  ce moment, vous avez un pic d'enregistrement sur le support, et tous ceux qui essaient d'Ã©crire quelque chose sur le disque attendront.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour se dÃ©barrasser de telles anomalies, il suffit de ne rien agrÃ©ger, de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne pas du tout tamponner</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Et si la mise en mÃ©moire tampon sur le disque se produit (heureusement, l'API Stream dans Node.js vous permet de le savoir) - reporter cette connexion. </font><font style="vertical-align: inherit;">C'est alors que l'Ã©vÃ©nement vient Ã  vous qu'il est Ã  nouveau gratuit - Ã©crivez-le Ã  partir de la file d'attente accumulÃ©e. </font><font style="vertical-align: inherit;">En attendant, c'est occupÃ© - prenez le prochain gratuit de la piscine et Ã©crivez-y. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de mettre en Å“uvre cette approche de l'enregistrement des donnÃ©es, nous avions environ 4K opÃ©rations d'Ã©criture, et de cette faÃ§on, nous avons rÃ©duit la charge de 4 fois. </font><font style="vertical-align: inherit;">Maintenant, ils ont augmentÃ© encore 6 fois en raison de nouvelles bases observables - jusqu'Ã  100 Mo / s. </font><font style="vertical-align: inherit;">Et maintenant, nous stockons des journaux pour les 3 derniers mois pour un montant d'environ 10 Ã  15 To, en espÃ©rant qu'en seulement trois mois, tout dÃ©veloppeur puisse rÃ©soudre n'importe quel problÃ¨me.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous comprenons les problÃ¨mes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais la collecte de toutes ces donnÃ©es est bonne, utile, appropriÃ©e, mais pas suffisante - vous devez la comprendre. </font><font style="vertical-align: inherit;">Parce que c'est des millions de plans diffÃ©rents par jour. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j6/kw/jg/j6kwjgsvci1xw-p_vgxpnq6ynag.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais des millions sont incontrÃ´lables, vous devez d'abord faire Â«moinsÂ». </font><font style="vertical-align: inherit;">Et, tout d'abord, il est nÃ©cessaire de dÃ©cider comment vous allez organiser ce "plus petit". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons identifiÃ© pour nous-mÃªmes trois points clÃ©s:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qui a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> envoyÃ© cette demande, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
c'est-Ã -dire Ã  partir de quelle application il a "volÃ©": interface web, backend, systÃ¨me de paiement ou autre.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">oÃ¹</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est-ce arrivÃ© </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sur quel serveur particulier. </font><font style="vertical-align: inherit;">Parce que si vous avez plusieurs serveurs sous une seule application, et soudain un "Ã©moussÃ©" (parce que "le disque a pourri", "la fuite de mÃ©moire", un autre problÃ¨me), alors vous devez vous adresser spÃ©cifiquement au serveur.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment le</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> problÃ¨me s'est manifestÃ© d'une maniÃ¨re ou d'une autre</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour comprendre Â«quiÂ» nous a envoyÃ© la demande, nous utilisons un outil rÃ©gulier - dÃ©finir une variable de session: </font></font><code>SET application_name = '{bl-host}:{bl-method}';</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- envoyer le nom d'hÃ´te de la logique mÃ©tier Ã  partir de laquelle la demande est faite, et le nom de la mÃ©thode ou de l'application qui l'a initiÃ©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AprÃ¨s avoir passÃ© le Â«propriÃ©taireÂ» de la demande, elle doit Ãªtre affichÃ©e dans le journal - pour cela, nous configurons la variable </font></font><code>log_line_prefix = ' %m [%p:%v] [%d] %r %a'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Toute personne intÃ©ressÃ©e peut </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voir dans le manuel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ce que tout cela signifie. </font><font style="vertical-align: inherit;">Il s'avÃ¨re que nous voyons dans le journal:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">temps</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identificateurs de processus et de transaction</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nom de base</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP de la personne qui a envoyÃ© cette demande</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et nom de la mÃ©thode</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/9d/ms/_c/9dms_cgsmfbpgjiyndalqfyadf8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons alors rÃ©alisÃ© qu'il n'Ã©tait pas trÃ¨s intÃ©ressant de regarder la corrÃ©lation d'une requÃªte entre diffÃ©rents serveurs. Cela arrive rarement lorsque vous avez une application qui craque Ã©galement ici et lÃ . Mais mÃªme si c'est la mÃªme chose, regardez n'importe lequel de ces serveurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, la section </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Â«un serveur - un jourÂ»</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> s'est avÃ©rÃ©e suffisante pour toute analyse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premiÃ¨re section analytique est le trÃ¨s </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Â«modÃ¨leÂ»</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - une forme abrÃ©gÃ©e de prÃ©sentation du plan, dÃ©barrassÃ©e de tous les indicateurs numÃ©riques. La deuxiÃ¨me section est l'application ou la mÃ©thode, et la troisiÃ¨me est le nÅ“ud spÃ©cifique du plan qui nous a causÃ© des problÃ¨mes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous sommes passÃ©s d'instances spÃ©cifiques Ã  des modÃ¨les, nous avons immÃ©diatement reÃ§u deux avantages:</font></font><br>
<br>
<ul>
<li><b>     </b><br>
         ,    .</li>
<li><b></b><br>
 ,  Â«Â»   - ,       .     ,     -  , ,   ,    â€”   ,  ,     â€”     , ,      .    ,  ,  .</li>
</ul><br>
<br>
<img src="https://habrastorage.org/webt/_1/gb/is/_1gbissbzxhnibnhpb5kb5ebuuu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les mÃ©thodes restantes sont basÃ©es sur les indicateurs que nous extrayons du plan: combien de fois un tel modÃ¨le s'est produit, le temps total et moyen, combien de donnÃ©es ont Ã©tÃ© lues sur le disque et combien de la mÃ©moire ... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parce que, par exemple, vous accÃ©dez Ã  la page d'analyse par hÃ´te, voir - quelque chose de trop sur le disque pour lire le dÃ©but. Le disque du serveur ne rÃ©siste pas - et qui en lit? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et vous pouvez trier par n'importe quelle colonne et dÃ©cider de ce que vous allez traiter en ce moment - avec la charge sur le processeur ou le disque, ou avec le nombre total de demandes ... TriÃ©, semblÃ© "top", rÃ©parÃ© - a dÃ©ployÃ© une nouvelle version de l'application. </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[confÃ©rence vidÃ©o]</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Et tout de suite, vous pouvez voir diffÃ©rentes applications qui viennent avec le mÃªme modÃ¨le Ã  partir d'une demande comme</font></font><code>SELECT * FROM users WHERE login = 'Vasya'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Frontend, backend, processing ... Et vous vous demandez pourquoi l'utilisateur devrait lire le traitement s'il n'interagit pas avec lui. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La faÃ§on opposÃ©e est de voir immÃ©diatement Ã  partir de l'application ce qu'elle fait. Par exemple, un frontend est ceci, ceci, ceci et ceci une fois par heure (seule la chronologie aide). Et immÃ©diatement la question se pose - il semble que ce ne soit pas l'affaire du front-end de faire quelque chose une fois par heure ... </font></font><br>
<br>
<img src="https://habrastorage.org/webt/z7/z-/4n/z7z-4nvcqjd8xktjpl1ilja63eo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AprÃ¨s un certain temps, nous avons rÃ©alisÃ© que nous manquions de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">statistiques</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> agrÃ©gÃ©es </font><b><font style="vertical-align: inherit;">en termes de nÅ“uds de plan</font></b><font style="vertical-align: inherit;"> . Nous n'avons isolÃ© des plans que les nÅ“uds qui font quelque chose avec les donnÃ©es des tables elles-mÃªmes (les lire / Ã©crire par index ou non). En fait, par rapport Ã  l'image prÃ©cÃ©dente, un seul aspect est ajoutÃ©: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">le nombre d'enregistrements que ce nÅ“ud nous a apportÃ©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et le nombre qu'il a supprimÃ© (lignes supprimÃ©es par filtre).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous n'avez pas d'index appropriÃ© sur la plaque, vous en faites la demande, il passe devant l'index, tombe dans Seq Scan ... vous avez filtrÃ© tous les enregistrements sauf un. Et pourquoi avez-vous besoin de 100 millions d'enregistrements filtrÃ©s par jour, est-il prÃ©fÃ©rable de rouler l'index? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tk/bw/j9/tkbwj9b2v1gmeifbmblipiya86q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AprÃ¨s avoir examinÃ© tous les plans par nÅ“uds, nous nous sommes rendu compte que certaines structures typiques des plans semblaient trÃ¨s suspectes. Et ce serait bien de dire au dÃ©veloppeur: "Ami, ici tu lis d'abord par index, puis tu le tries, puis tu le coupes" - en rÃ¨gle gÃ©nÃ©rale, il y a un enregistrement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tous ceux qui ont Ã©crit des requÃªtes avec un tel modÃ¨le sont probablement tombÃ©s sur: "Donnez-moi la derniÃ¨re commande pour Vasya, sa date" Et si vous n'avez pas d'index par date, ou que l'index utilisÃ© n'a pas de date, alors allez exactement sur un tel "rÃ¢teau" et marchez dessus .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais nous savons que c'est un "rake" - alors pourquoi ne pas dire immÃ©diatement au dÃ©veloppeur ce qu'il doit faire. </font><font style="vertical-align: inherit;">En consÃ©quence, ouvrant le plan maintenant, notre dÃ©veloppeur voit immÃ©diatement une belle image avec des invites, oÃ¹ on lui dit immÃ©diatement: "Vous avez des problÃ¨mes ici et ici, mais ils sont rÃ©solus de cette faÃ§on et cela." </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En consÃ©quence, la quantitÃ© d'expÃ©rience qui Ã©tait nÃ©cessaire pour rÃ©soudre les problÃ¨mes au dÃ©but et a maintenant considÃ©rablement diminuÃ©. </font><font style="vertical-align: inherit;">Ici, nous avons un tel outil.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/si/1g/g6/si1gg6ffbtpgsb3q2ew_cgudqa4.jpeg"></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr487370/index.html">Analyse du marchÃ© immobilier basÃ©e sur les donnÃ©es de msgr.ru</a></li>
<li><a href="../fr487372/index.html">CertifiÃ© IBM Data Science Professional Certificate</a></li>
<li><a href="../fr487374/index.html">Paul Graham: problÃ¨mes Ã  la mode</a></li>
<li><a href="../fr487376/index.html">10 fonctionnalitÃ©s angulaires utiles que vous avez manquÃ©es</a></li>
<li><a href="../fr487378/index.html">Meilleurs serveurs pour petites entreprises en 2020</a></li>
<li><a href="../fr487384/index.html">Profession: dÃ©veloppeur front-end</a></li>
<li><a href="../fr487386/index.html">Liste de contrÃ´le de l'adaptation comme outil de saisie logicielle</a></li>
<li><a href="../fr487388/index.html">DÃ©veloppement naturel: comment passer de l'e-learning Ã  la gestion des connaissances</a></li>
<li><a href="../fr487390/index.html">Composants Web sans Shadow DOM</a></li>
<li><a href="../fr487392/index.html">Qu'est-ce que Magnet veut savoir sur ses clients?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>