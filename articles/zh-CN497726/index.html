<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍💻 👩🏽‍🎨 🐚 在Odnoklassniki扩展Android测试 😩 🕴🏿 🗒️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="你好！我的名字叫Roman Ivanitsky，我在Odnoklassniki测试自动化团队中工作。 OK是一项庞大的服务，拥有超过7000万用户。如果我们谈论移动设备，则大多数人在运行Android的智能手机上使用OK.RU。因此，我们非常认真地测试我们的Android应用程序。在本文中，我将讲述...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>在Odnoklassniki扩展Android测试</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/497726/"><img src="https://habrastorage.org/webt/dp/ei/lm/dpeilmobnwcglrby0p_rtptmgv8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
你好！我的名字叫Roman Ivanitsky，我在Odnoklassniki测试自动化团队中工作。 OK是一项庞大的服务，拥有超过7000万用户。如果我们谈论移动设备，则大多数人在运行Android的智能手机上使用OK.RU。因此，我们非常认真地测试我们的Android应用程序。在本文中，我将讲述我们公司自动测试开发的故事。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2012年，Odnoklassniki公司正经历着用户数量的积极增长和用户功能数量的增长。</font><font style="vertical-align: inherit;">为了满足业务目标，必须缩短发布周期，但是由于所有功能都是手动测试的事实而受到阻碍。</font><font style="vertical-align: inherit;">解决此问题的方法本身就是-我们需要自动测试。</font><font style="vertical-align: inherit;">因此，2012年在Odnoklassniki出现了一个测试自动化团队，第一步是开始编写测试。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一点历史</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Odnoklassniki中的第一个自动测试是用Selenium编写的，它们的发布引发了Jenkins，带有Selenium Hub的Selenium Grid和一组Selenium Node的出现。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
快速解决方案，快速启动，快速获利-完美。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
随着时间的流逝，测试的数量增加了，并且出现了辅助服务-例如，启动服务，报告服务，测试数据服务。到2014年底，我们进行了大约十五到二十分钟的一千次测试。这显然不适合我们，因为很明显，测试数量会增加，运行测试所需的时间也会增加。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当时，自动化测试基础架构如下所示：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/ou/7s/2qou7sruwzlvihxfhhq2fdcd9qm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，如果硒节点的数量大于或等于200，则集线器将无法应付负载。</font><font style="vertical-align: inherit;">现在已经研究了这个问题，这就是为什么出现诸如Zalenium或每个人都喜欢的Selenoid之类的工具的原因。</font><font style="vertical-align: inherit;">但是在2014年，尚无标准解决方案，因此我们决定自己制造。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
定义了服务必须满足的最低要求：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可扩展性。</font><font style="vertical-align: inherit;">我们不想依赖Selenium Hub的限制。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">稳定性。</font><font style="vertical-align: inherit;">2014年，Selenium Hub以稳定的运行而闻名。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">容错能力。</font><font style="vertical-align: inherit;">如果数据中心或任何服务器出现故障，我们需要有继续测试过程的能力。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，出现了我们的Selenium Grid缩放解决方案，它由一个协调器和Node-manager组成，在外观上与标准Selenium Grid非常相似，但是具有自己的功能。</font><font style="vertical-align: inherit;">这些功能将进一步讨论。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">协调员</font></font></h3><br>
<img src="https://habrastorage.org/webt/s0/gu/ib/s0guibehaq2q0zpa5vi40jc9un4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实际上，它是一个资源代理（资源被理解为浏览器）。它具有外部API，测试可通过该API发送对资源的请求。这些查询将作为要运行的任务保存到数据库中。协调员了解有关集群配置的所有信息-存在哪些节点管理器，这些节点管理器可以提供哪些资源，资源总数，当前任务中涉及多少资源。同时，他监视资源-活动，稳定性，并在这种情况下通知责任人。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
协调器的一个功能是将所有Node Manager集成到所谓的服务器场中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是农场的样子。使用了一半以上的资源，并且所有节点均处于联机状态：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ti/ar/ib/tiariberzr9rt2lpau2vfohpcoa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您还可以脱机显示节点或将其旋转一定百分比，如果有必要减少特定节点上的负载，则需要这样做。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个服务器场都可以在逻辑单元（我们称为服务）中与其他服务器场组合。同时，一个农场可以包含在几种不同的服务中。首先，它可以设置限制并确定每个特定服务使用的资源的优先级。其次，它使您可以轻松地管理配置-我们能够即时添加服务中节点管理器的数量，反之亦然，可以从服务器场中删除它们以与这些节点管理器进行交互，例如配置或更新等。 。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wv/rj/fc/wvrjfcs7gh4e3fsf6kjloe1uh_k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
协调器的API非常简单：可以针对当前使用的资源量请求服务，获取其限制并启动或停止某些资源。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">节点管理器</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是一项可以很好地完成两件事的服务-从协调员那里接收任务，并根据需要启动一些资源。</font><font style="vertical-align: inherit;">默认情况下，它的设计使资源的每次启动都是隔离的，也就是说，以前的启动都不会影响后续测试的启动。</font><font style="vertical-align: inherit;">作为响应，协调器使用了一堆主机和一组升高的端口。</font><font style="vertical-align: inherit;">例如，启动Selenium服务器的主机及其端口。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p8/xa/43/p8xa43yokgfpxyumwpmagx4ilpa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在主机上，它看起来像这样：节点管理器服务正在运行，并且它管理整个资源生命周期。</font><font style="vertical-align: inherit;">他选择了浏览器，完成了浏览器，确保不会忘记关闭它们。</font><font style="vertical-align: inherit;">为了确保彼此隔离，所有这些都代表服务用户进行。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">相互作用</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该测试与上述基础结构进行如下交互：它向协调器发出对必需资源的请求，协调器将此任务保存为需要执行。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
依次，节点管理器求助于任务协调器。收到任务后，他启动了资源。之后，他将启动结果发送给协调器，失败的启动也将报告给协调器。测试会收到资源请求的结果，如果成功，则直接开始使用资源。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fe/np/sf/fenpsf31k75tnpnxgwtw5mjymro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这种方法的优点是通过获得直接使用资源的能力来减少协调器上的负载。缺点-需要在测试框架内实现与协调器交互的逻辑，但是对我们来说这是可以接受的。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今天，我们可以在三个数据中心并行运行800多个浏览器。</font><font style="vertical-align: inherit;">对于协调员，这不是限制。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过启动缠绕在不同数据中心的DNS防火墙后面的多个协调器实例，可以确保容错能力。</font><font style="vertical-align: inherit;">如果数据中心或服务器出现问题，这可以保证对工作实例的访问。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
结果，我们得到了一个满足所有初始设置要求的解决方案。</font><font style="vertical-align: inherit;">自2015年以来一直稳定运行，并证明了其有效性。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安卓系统</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Android上进行测试时，通常有两种主要方法。首先是使用WebDriver-这是Selendroid和Appium的工作方式。第二个-使用本地工具，从而实现了Robotium，UI Automator或Espresso。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些方法之间的基本相似之处是获得设备并获得浏览器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还有更多区别，主要是需要安装经过测试的APK，我们将通过日志，屏幕截图等形式获取工件。而且，测试是在设备本身而不是在CI上进行的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在2015年，Odnoklassniki开始使用自动测试覆盖其Android应用程序。我们选择了一台Linux机器，通过USB连接一台真实设备，然后开始在Robotium上编写测试。这个简单的解决方案使您可以快速获得结果。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
时间过去了，测试数量和设备数量都在增加。为了解决管理任务，创建了设备管理器-覆盖</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（Android调试桥）命令</font><font style="vertical-align: inherit;">的包装程序</font><font style="vertical-align: inherit;">，该命令允许http api接口执行它们。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是设备管理器的第一个API的外观-借助它的帮助，您可以获得设备列表，安装/卸载APK，运行测试并获得结果。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ra/j5/pc/raj5pcnmij6_km7w1zla73xzix4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，我们注意到，在连接了多个设备的ADB服务器上启动时，测试结果会降低。在使用Docker隔离每台ADB服务器的过程中发现了有助于提高稳定性的解决方案。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
场已准备就绪-您可以连接电话。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rb/lh/gr/rblhgrqkdhtp6xgue6ysjzkjcx0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
许多人都熟悉这张照片。听说如果您从事Android农场，那么您每天都会陷入困境。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yb/lo/sh/ybloshbgsavgewkhufosue3gqzi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们提供了一个Android模拟器。它的使用归因于两个因素：首先，当时它已经达到了必要的稳定性水平；其次，我们在测试中没有任何特别依赖铁的功能。此外，当时该模拟器已很好地投影到现有基础架构上。下一步是教节点管理器启动新型资源。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行Android模拟器需要什么？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先，您需要一个带有一组实用程序的Android SDK。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后，您需要创建AVD-Android虚拟设备-这是您的Android仿真器的组织方式-它具有什么架构，将使用多少个内核，是否可以使用Google服务，等等。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gt/az/6e/gtaz6ejxanl2ppil-8niyzhkvjc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，您需要选择创建的AVD的名称，设置参数，例如，转移将启动ADB的端口，然后启动。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，这种方案有一个特殊性-系统仅允许您在一个特定的AVD上运行一个实例仿真器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
解决此问题的方法是创建一个存储在内存中的基本AVD，从而可以将其复制到其他位置。</font><font style="vertical-align: inherit;">在启动Android模拟器期间，基本AVD被复制到映射到内存的临时目录中，然后启动。</font><font style="vertical-align: inherit;">这样的方案工作很快，但是很麻烦。</font><font style="vertical-align: inherit;">迄今为止，该问题已通过只读选项解决，该选项使您可以从一个AVD无限数量地运行Android仿真器</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">性能</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
根据与AVD合作的结果，我们提出了一些内部建议：</font></font><br>
<br>
<ol>
<li>  86  ,  ARM  .     dev/kvm  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Linux  HAXM-  Mac  Windows</a></li>
<li>GPU-  .     ,    .  ,          ,   ,    Android-  </li>
<li> .       </li>
<li>   ,         localhost,        </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
至于要在Android上进行测试的Docker映像，我想强调一下Agoda和Selenoid，他们最大程度地利用了Android仿真器的功能。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它们之间的区别在于默认的Selenoid中有</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appium</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，Agoda和使用过的“干净”模拟器。此外，Selenoid具有更多的社区支持。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在2018年底，创建了CloudNode-Manager，它与协调器联系，接收任务并使用云中的命令启动。该服务代替铁机使用了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个云</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的资源</font><font style="vertical-align: inherit;">-Odnoklassniki自己的私有云。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们设法通过教DeviceManager如何与协调器一起工作来实现扩展。为此，我必须更改设备管理器API以添加请求设备类型（虚拟/真实）的功能。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您尝试在一台计算机上的250个仿真器上运行ADB安装，则会发生这种情况。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lk/ab/td/lkabtdmlsx7-1x6ne200l5jgi10.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
服务员立即对此做出了反应并引发了事件-机器向千兆位网络接口加载了传出流量。通过增加服务器的吞吐量解决了这种复杂性。我不能说这个问题给我们带来了很多麻烦，但您不要忘记它。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
看来成功是Devicemanager，协调器，扩展。我们可以在整个服务器场上运行测试。原则上，我们可以在每个请求请求上运行它们，开发人员将很快收到反馈。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uk/zl/l_/ukzll_cniqi00nxoiy67osju6do.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，并非所有事情都如此乐观。您可能已经注意到，到目前为止，关于测试质量还没有任何评论。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sr/he/4k/srhe4kzvbock0mcztvh88d2s_98.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是我们的发布会的样子。最有趣的是，在两次发射之间可能会落入完全不同的测试。这些是不稳定的瀑布。我，开发人员和测试人员都不相信这些结果。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们如何处理这个问题？他们只是复制了从Robotium到Espresso的所有内容，一切都变得不错了……实际上，没有。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了解决这个问题，我们不仅重写了Espresso上的所有内容，而且开始使用API​​进行各种操作，例如上载照片，创建帖子，添加到朋友等，进行快速登录，使用</font><font style="vertical-align: inherit;">了可直接进入所需屏幕的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIP链接。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，当然，我们分析了所有测试用例。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，测试运行如下所示：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m2/zg/lo/m2zglocfnlq8e31pgwew1czj-ic.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可能会注意到红色测试仍然存在，但是请务必记住，这些测试是在生产环境中运行的端到端测试。我们限制了应用程序主分支中可以包含的测试数量。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们有了稳定的测试和扩展。但是，测试基础结构仍然与测试紧密相关。同时，由于期望进行端到端测试，CI繁忙，其他程序集可以排队等待空闲代理。此外，还没有明确的并行启动方案。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上面提到的原因成为了QueueRunner开发的推动力-这项服务使您可以在不阻止CI的情况下异步运行测试。</font><font style="vertical-align: inherit;">要工作，他需要测试并测试APK，以及一组测试。</font><font style="vertical-align: inherit;">接收到必要的数据后，他将能够组织队列中的运行，分配和释放所需的资源。</font><font style="vertical-align: inherit;">QueueRunner将运行结果下载到Jira和Stash，并通过邮件和Messenger发送。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner有一个测试流程-它监视测试的生命周期。</font><font style="vertical-align: inherit;">现在，我们使用的默认流程包括五个步骤：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接收装置。</font><font style="vertical-align: inherit;">此时，设备管理器通过协调器请求一个真实或虚拟设备。</font></font></li>
<li> .        APK  ,    –  ,           .</li>
<li>,      </li>
<li> </li>
<li>    </li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，五个简单的步骤就是我们服务中整个测试生命周期。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ke/pd/yg/kepdyglhyclwq8ogfg4thqparxy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner给我们带来了什么好处？首先，它最大程度地利用了所有可能的资源-可以扩展到整个服务器场并快速获得结果。其次，有了奖金，我们就有机会控制测试的顺序。例如，我们可以在一开始就运行最长或最有问题的测试，从而减少等待它们运行的​​时间。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner还允许您进行智能重新托盘。我们将所有数据存储在数据库中，因此我们可以随时查看测试的历史记录。例如，可以查看测试通过与否的比率，并确定原则上是否值得重新启动测试。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
QueueRunner和Devicemanager使我们能够适应资源量。现在我们可以扩展到整个服务器场，这要归功于使用仿真器，也就是说，几乎无限数量的虚拟设备使我们有机会运行更多的测试，但是如果由于某种原因资源不可用，服务将等待它们返回并且不会丢失启动消息。我们仅使用对我们可用的资源，因此，一段时间后仍会获得结果，并且不会阻止CI。最重要的是，现在测试基础架构和测试是分开的。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，为了在Android上运行测试，您只需要给我们提供一个测试APK和一个测试列表。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从虚拟机上的Selenium场到在云中启动Android测试，我们已经走了很长一段路。</font><font style="vertical-align: inherit;">但是，此路径尚未完成。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开发过程</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们看看测试基础架构与开发流程之间的关系，以及测试人员和开发人员如何看待它。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们的Android团队使用标准的GitFlow：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/rf/p9/ot/rfp9ot5imowggxpkdgyekbym2ao.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个功能都有其自己的分支。主要开发发生在开发分支。决定创建新超级功能的开发人员将在自己的分支机构中开始开发，而其他开发人员可以在其他分支机构中并行工作。当开发人员认为已经准备好世界上理想的，最佳的代码并且需要尽快将其发布给用户时，他会在开发中提出拉动请求，自动组装单元，运行单元测试和组件测试。同时，将APK组装起来，发送到QueueRunner，然后运行端到端测试。之后，运行测试的结果将交给开发人员。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，很可能在开发中创建了特征分支之后，会有很多提交。</font><font style="vertical-align: inherit;">这意味着开发可能不再像以前那样。</font><font style="vertical-align: inherit;">因此，预合并首先发生-我们将开发合并到当前的功能分支中，正是在这种过早的状态下进行组装，单元测试，组件测试，端到端，并根据这些结果进行报告。</font><font style="vertical-align: inherit;">因此，我们了解了该功能在当前版本的developer中的功能，如果一切正常，则将其发送给用户。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/og/qs/2m/ogqs2mqcef0dwn-lyaxugjzhrca.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">报告中</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是Stash报告的样子：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/61/7b/qi/617bqiddnqointrhxigp3g2o904.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们的机器人首先写道测试已经开始，并且在测试通过时会更新消息，并添加已通过的数量，已下降的数量，已知的错误的数量以及易碎测试的数量。他在Jira中写了同样的东西，并添加了一个链接来比较发射。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是两个启动的比较的外观：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/li/kf/62/likf62ljuom4erhqvkxvoq4o-li.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在这里，将功能分支中的当前运行与开发中的最后一次运行进行比较。它包含有关正在运行的测试数量，匹配问题，下降的测试以及处于一种状态并切换到另一种状态的不稳定Flaky测试的信息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果至少一个单元测试或超过端到端测试的某个阈值下降，则合并将被阻止。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了了解测试是否稳定下降，我们比较了跌落痕迹的哈希值，然后才对它们进行了初步清除，只保留了行号。</font><font style="vertical-align: inherit;">如果哈希匹配，则这是相同的跌落，如果它们不同，则跌落很可能会不同。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">摘要</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们实施了稳定，容错的解决方案，可以很好地扩展到我们的基础架构。</font><font style="vertical-align: inherit;">然后，将生成的基础结构进行了Android测试。</font><font style="vertical-align: inherit;">设备管理器在这方面为我们提供了帮助，它可以帮助我们与真实设备和虚拟设备一起工作，以及QueueRunner，它可以帮助我们分离基础架构和测试，并且在测试期间不会阻塞CI。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
看来，2016年的测试运行时间为一周-从五十分钟或更长时间。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j9/0-/bk/j90-bkvotdp0g3zmlpphaskbmnu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在就是这样：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gi/0h/zy/gi0hzyeoygzkwphzp74vpph21q8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该图表显示了每个工作日平均2个小时内的运行情况。</font><font style="vertical-align: inherit;">运行时间最多减少了15分钟，运行次数明显增加。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN497700/index.html">从4月17日开始，每周在线备份，开发人员，安全和机器人</a></li>
<li><a href="../zh-CN497702/index.html">2020年您应注意的五个数据存储趋势</a></li>
<li><a href="../zh-CN497708/index.html">我们邀请您参加4月和5月的一系列Fujitsu网络研讨会</a></li>
<li><a href="../zh-CN497714/index.html">如何在macOS上保护进程和内核扩展</a></li>
<li><a href="../zh-CN497724/index.html">准备服务器以用Python发布Web应用程序</a></li>
<li><a href="../zh-CN497728/index.html">“燃烧”碎屑的危险</a></li>
<li><a href="../zh-CN497730/index.html">方便的BDD：SpecFlow + TFS</a></li>
<li><a href="../zh-CN497736/index.html">审查10台新内燃机</a></li>
<li><a href="../zh-CN497738/index.html">在Swift中测试自己：拼图迷的拼图</a></li>
<li><a href="../zh-CN497740/index.html">汽车制造商承认，完全无人驾驶汽车要花很长时间</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>