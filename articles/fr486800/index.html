<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔭 ⏩ 🔉 Cassandra. Comment ne pas mourir si vous ne connaissez qu'Oracle 🍦 💅🏿 🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr. 
 
 Mon nom est Misha Butrimov, je voudrais parler un peu de Cassandra. Mon histoire sera utile à ceux qui n'ont jamais rencontré de ba...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cassandra. Comment ne pas mourir si vous ne connaissez qu'Oracle</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qiwi/blog/486800/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mon nom est Misha Butrimov, je voudrais parler un peu de Cassandra. Mon histoire sera utile à ceux qui n'ont jamais rencontré de bases de données NoSQL - elle a beaucoup de fonctionnalités d'implémentation et d'embûches que vous devez connaître. Et si, à part Oracle ou toute autre base relationnelle, vous n'avez rien vu, ces choses vous sauveront la vie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qu'est-ce qui est bon avec Cassandra? Il s'agit d'une base de données NoSQL conçue sans point de défaillance unique, qui évolue bien. Si vous devez ajouter quelques téraoctets pour n'importe quelle base, il vous suffit d'ajouter des nœuds à l'anneau. L'étendre à un autre centre de données? Ajoutez des nœuds au cluster. Augmenter le RPS traité? Ajoutez des nœuds au cluster. L'autre manière fonctionne également.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/4s/4m/jn/4s4mjnltsraqofl5-ey4g2fi9t0.png" width="700"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À quoi d'autre est-elle bonne? </font><font style="vertical-align: inherit;">C'est pour traiter beaucoup de demandes. </font><font style="vertical-align: inherit;">Mais combien coûte combien? </font><font style="vertical-align: inherit;">10, 20, 30, 40 000 requêtes par seconde - ce n'est pas beaucoup. </font><font style="vertical-align: inherit;">100 000 demandes d'enregistrement par seconde également. </font><font style="vertical-align: inherit;">Certaines entreprises ont déclaré détenir 2 millions de demandes par seconde. </font><font style="vertical-align: inherit;">Ici, ils doivent probablement croire. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et en principe, Cassandra a une grande différence avec les données relationnelles - elle ne leur ressemble pas du tout. </font><font style="vertical-align: inherit;">Et c'est très important à retenir.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout ce qui se ressemble ne fonctionne pas de la même façon</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois qu'un collègue est venu me voir et m'a demandé: «Voici le langage de requête CQL Cassandra, et il a une instruction select, il a où, il a et. J'écris des lettres et ça ne marche pas. Pourquoi?". Si vous traitez Cassandra comme une base de données relationnelle, c'est un moyen idéal de mettre fin à votre vie par un suicide brutal. Et je ne le préconise pas, c'est interdit en Russie. Vous concevez simplement quelque chose de mal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, un client vient à nous et dit: «Créons une base de données pour les émissions de télévision, ou une base de données pour un répertoire de recettes. Nous y aurons des plats ou une liste de séries et d'acteurs. » Nous disons joyeusement: "Allez!". Ce sont deux octets à envoyer, quelques plaques et tout est prêt, tout fonctionnera très rapidement, de manière fiable. Et tout va bien jusqu'à ce que les clients viennent et disent que les femmes au foyer résolvent également le problème inverse: elles ont une liste de produits et elles veulent savoir quel plat elles veulent cuisiner. Tu es mort. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En effet, Cassandra est une base de données hybride: elle est à la fois une valeur clé et stocke les données dans de larges colonnes. Parlant en Java ou Kotlin, il pourrait être décrit comme ceci:</font></font><br>
<br>
<code>Map&lt;RowKey, SortedMap&lt;ColumnKey, ColumnValue&gt;&gt;</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Autrement dit, une carte, à l'intérieur de laquelle se trouve également une carte triée. La première clé de cette carte est la clé Row ou la clé de partition - la clé de partition. La deuxième clé, qui est la clé de la carte déjà triée, est la clé de clustering. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour illustrer la distribution de la base de données, nous dessinons trois nœuds. Vous devez maintenant comprendre comment décomposer les données en nœuds. Parce que si nous mettons tout en un (en passant, il peut y en avoir mille, deux mille, cinq - autant que vous le souhaitez), ce n'est pas vraiment une question de distribution. Par conséquent, nous avons besoin d'une fonction mathématique qui renverra un nombre. Juste un nombre, un long int qui tombera dans une certaine plage. Et nous avons un nœud sera responsable d'une plage, le second - pour le deuxième, n-ème - pour le n-ème.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vl/xn/mn/vlxnmnvvigtwc_ho-wkjqy5r60e.png" width="900"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce nombre est pris à l'aide d'une fonction de hachage qui s'applique uniquement à ce que nous appelons la clé de partition. </font><font style="vertical-align: inherit;">Il s'agit de la colonne spécifiée dans la directive Clé primaire, et c'est la colonne qui sera la première et la clé de mappage la plus élémentaire. </font><font style="vertical-align: inherit;">Il détermine quel nœud obtient quelles données. </font><font style="vertical-align: inherit;">Une table est créée dans Cassandra avec presque la même syntaxe qu'en SQL:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">users</span> (<font></font>
	user_id uu <span class="hljs-keyword">id</span>,
	<span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>,
	<span class="hljs-keyword">year</span> <span class="hljs-built_in">int</span>,<font></font>
	salary <span class="hljs-built_in">float</span>,<font></font>
	PRIMARY <span class="hljs-keyword">KEY</span>(user_id)<font></font>
<font></font>
)<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, la clé primaire se compose d'une colonne et il s'agit également d'une clé de partition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment les utilisateurs vont-ils tomber avec nous? </font><font style="vertical-align: inherit;">Une partie tombera sur une note, une partie sur une autre et une partie sur une troisième. </font><font style="vertical-align: inherit;">Il se révèle une table de hachage ordinaire, c'est aussi une carte, c'est aussi un dictionnaire en Python, c'est aussi une simple structure de valeurs Key à partir de laquelle on peut lire toutes les valeurs, lire et écrire par clé.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vp/3_/xa/vp3_xa1bupu1wawi77ytwk0pike.png" width="900"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sélectionnez: quand autoriser le filtrage se transforme en analyse complète, ou comment ne pas le faire</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Écrivons une déclaration Le select: </font></font><code>select * from users where, userid = </code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Il s'avère que cela ressemble à Oracle: nous écrivons select, nous spécifions les conditions et tout fonctionne, les utilisateurs l'obtiennent. Mais si vous sélectionnez, par exemple, un utilisateur avec une certaine année de naissance, Cassandra jure qu'elle ne peut pas répondre à la demande. Parce qu'elle ne sait rien sur la façon dont nous distribuons les données sur l'année de naissance - elle n'a qu'une seule colonne spécifiée comme clé. Puis elle dit: «D'accord, je peux toujours répondre à cette demande. Ajoutez autoriser le filtrage. " Nous ajoutons une directive, tout fonctionne. Et à ce moment, une chose terrible se produit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous conduisons sur des données de test, tout va bien. Et lorsque vous répondez à la demande en production, où, par exemple, nous avons 4 millions d'enregistrements, alors tout ne va pas très bien chez nous. Parce que permettre le filtrage est une directive qui permet à Cassandra de collecter toutes les données de cette table de tous les nœuds, de tous les centres de données (s'il y en a beaucoup dans ce cluster), puis de les filtrer uniquement. Il s'agit d'un analogue de Full Scan, et presque personne n'en est ravi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous n'avions besoin d'utilisateurs que par identifiants, cela nous conviendrait. Mais parfois, nous devons écrire d'autres requêtes et imposer d'autres restrictions à la sélection. Par conséquent, nous nous souvenons: nous avons tous une carte, qui a une clé de partition, mais à l'intérieur, il y a une carte triée.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et elle a aussi une clé, que nous appelons la Clustering Key. Cette clé, qui, à son tour, se compose des colonnes que nous sélectionnons, avec lesquelles Cassandra comprend comment ses données sont triées physiquement et reposera sur chaque nœud. Autrement dit, pour une clé de partition, la clé de clustering vous dira exactement comment pousser les données dans cet arbre, quelle place elles y prendront. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'agit d'un véritable arbre, un comparateur est simplement appelé là, dans lequel nous passons un certain ensemble de colonnes sous la forme d'un objet, et il est également défini sous la forme d'une énumération de colonnes.</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users_by_year_salary_id (<font></font>
	user_id <span class="hljs-keyword">uuid</span>,
	<span class="hljs-keyword">name</span> <span class="hljs-built_in">text</span>,
	<span class="hljs-keyword">year</span> <span class="hljs-built_in">int</span>,<font></font>
	salary <span class="hljs-built_in">float</span>,<font></font>
	PRIMARY <span class="hljs-keyword">KEY</span>((<span class="hljs-keyword">year</span>), salary, user_id)
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faites attention à la directive Clé primaire, elle a le premier argument (dans notre cas l'année) est toujours la clé de partition. </font><font style="vertical-align: inherit;">Il peut consister en une ou plusieurs colonnes, peu importe. </font><font style="vertical-align: inherit;">S'il y a plusieurs colonnes, vous devez les supprimer à nouveau entre parenthèses afin que le préprocesseur de langue comprenne qu'il s'agit de la clé primaire et derrière toutes les autres colonnes - la clé de clustering. </font><font style="vertical-align: inherit;">Dans ce cas, ils seront transmis dans le comparateur dans l'ordre dans lequel ils vont. </font><font style="vertical-align: inherit;">Autrement dit, la première colonne est plus importante, la seconde est moins importante, etc. </font><font style="vertical-align: inherit;">Lorsque nous écrivons pour des classes de données, par exemple, est égal à champs: nous listons les champs, et pour eux, nous écrivons ceux qui sont plus grands et ceux qui sont plus petits. </font><font style="vertical-align: inherit;">Dans Cassandra, il s'agit, relativement parlant, du champ de classe de données auquel les égaux écrits pour lui seront appliqués.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous fixons le tri, imposons des restrictions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne faut pas oublier que l'ordre de tri (décroissant, croissant, peu importe) est défini en même temps que la clé est créée, et vous ne pourrez plus le modifier ultérieurement. Il détermine physiquement comment les données seront triées et comment elles se trouveront. Si vous devez modifier la clé de clustering ou l'ordre de tri, vous devrez créer une nouvelle table et y verser des données. Avec l'existant, cela ne fonctionnera pas. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kg/qh/qt/kgqhqtjece2c4irbhyll0mxsl10.png" width="900"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons rempli notre table d'utilisateurs et avons vu qu'ils sont entrés dans un ring, d'abord par année de naissance, puis à l'intérieur de chaque nœud par salaire et par ID utilisateur. Maintenant, nous pouvons sélectionner, imposer des restrictions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre travail réapparaît</font></font><code>where, and</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et les utilisateurs nous contactent, et tout va bien à nouveau. </font><font style="vertical-align: inherit;">Mais si nous essayons d'utiliser uniquement la partie clé Clustering, la moins importante, Cassandra jurera tout de suite que nous ne pouvons pas trouver dans notre carte où cet objet a ces champs pour le comparateur null, mais celui qui vient d'être défini - où il se trouve. </font><font style="vertical-align: inherit;">Je vais devoir à nouveau récupérer toutes les données de ce nœud et les filtrer. </font><font style="vertical-align: inherit;">Et ceci est un analogue de Full Scan au sein du nœud, c'est mauvais.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans toute situation incompréhensible, créez une nouvelle table</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous voulons pouvoir obtenir des utilisateurs par ID, par âge ou par salaire, que devons-nous faire? Rien. Utilisez simplement deux tableaux. Si vous devez obtenir des utilisateurs de trois manières différentes, il y aura trois tableaux. Il est révolu le temps où nous avons économisé de l'espace sur la vis. C'est la ressource la moins chère. Il coûte beaucoup moins cher que le temps de réponse, ce qui peut être fatal à l'utilisateur. L'utilisateur est beaucoup plus agréable d'obtenir quelque chose en une seconde qu'en 10 minutes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous échangeons un espace excessif, des données dénormalisées pour la capacité de bien évoluer, de travailler de manière fiable. En effet, en fait, un cluster composé de trois centres de données, chacun ayant cinq nœuds, avec un niveau de stockage de données acceptable (quand rien n'est perdu à coup sûr), est capable de survivre à la mort d'un centre de données complètement. Et deux autres nœuds dans chacun des deux restants. Et ce n'est qu'après que les problèmes commencent. C'est une assez bonne redondance, cela coûte quelques disques SSD et processeurs inutiles. Par conséquent, pour utiliser Cassandra, qui n'est jamais SQL, dans lequel il n'y a pas de relations, pas de clés étrangères, vous devez connaître des règles simples.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous concevons tout à partir d'une demande. L'essentiel n'est pas les données, mais la façon dont l'application va fonctionner avec elles. S'il a besoin de recevoir différentes données de différentes manières ou les mêmes données de différentes manières, nous devons les mettre de la manière qui conviendra à l'application. Sinon, nous échouerons en Full Scan et Cassandra ne nous donnera aucun avantage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La dénormalisation des données est la norme. Oubliez les formulaires normaux, nous n'avons plus de bases de données relationnelles. On met quelque chose 100 fois, ça va mentir 100 fois. C’est moins cher que de l’arrêter de toute façon.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous sélectionnons les clés pour le partitionnement afin qu'elles soient normalement distribuées. </font><font style="vertical-align: inherit;">Nous n'avons pas besoin du hachage de nos clés pour tomber dans une plage étroite. </font><font style="vertical-align: inherit;">Autrement dit, l'année de naissance dans l'exemple ci-dessus est un mauvais exemple. </font><font style="vertical-align: inherit;">Au contraire, il est bon que nos utilisateurs soient normalement répartis par année de naissance, et mauvais si nous parlons d'élèves de 5e année - il ne sera pas très bon d'y partitionner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le tri est sélectionné une fois lors de la création de la Clustering Key. </font><font style="vertical-align: inherit;">Si vous devez le changer, vous devrez remplir notre table avec une clé différente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le plus important: si nous devons collecter les mêmes données de 100 manières différentes, nous aurons alors 100 tableaux différents.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486788/index.html">Webinaire «Surveillance à distance et diagnostic des équipements. Études de cas sur la solution CNC de Winnum »</a></li>
<li><a href="../fr486790/index.html">Et encore une fois Qbot - une nouvelle souche de cheval de Troie bancaire</a></li>
<li><a href="../fr486792/index.html">Le chemin du robot vers le satellite glacé d'une autre planète commence dans les profondeurs de l'Antarctique</a></li>
<li><a href="../fr486794/index.html">Les processus des neurones humains ont montré une capacité inattendue à calculer</a></li>
<li><a href="../fr486798/index.html">Y a-t-il un GameDev à Sakhaline? Fin</a></li>
<li><a href="../fr486802/index.html">Les gens rencontrent des systèmes de recommandation. Factorisation</a></li>
<li><a href="../fr486804/index.html">Informatique de santé mondiale: technologies cloud</a></li>
<li><a href="../fr486808/index.html">Test de grossesse électronique en pharmacie: comment ça marche</a></li>
<li><a href="../fr486810/index.html">Nouvelle interface Odnoklassniki: lancement de React en Java. Partie II</a></li>
<li><a href="../fr486814/index.html">Zabbix: la topologie du réseau est claire et automatique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>