<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏓 👨🏿‍🚀 🥧 Créer une API TODO pour Golang avec Kubernetes 😳 😷 🤱</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour à tous! Avant le lancement du cours sur la plate-forme d'infrastructure basée sur Kubernetes, nous avons préparé une traduction d'un autre mat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Créer une API TODO pour Golang avec Kubernetes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/498130/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour à tous! </font><font style="vertical-align: inherit;">Avant le lancement du cours sur la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plate-forme d'infrastructure basée sur Kubernetes, nous avons</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> préparé une traduction d'un autre matériel intéressant.</font></font></b></i><br>
<br>
<hr><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cet article est destiné aux nouveaux arrivants à Kubernetes, qui seront intéressés à comprendre un exemple pratique de la façon d'écrire une API Golang pour gérer une liste TODO, puis comment la déployer sur Kubernetes. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Chaque développeur aime une bonne liste TODO, non? </font><font style="vertical-align: inherit;">Sinon, comment pourrions-nous nous organiser autrement? </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gd/jy/vw/gdjyvw5u8cexjnsseoybworcx7a.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chaque développeur aime une bonne application TODO, non? </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons commencer par passer en revue la liste des composants nécessaires, puis continuer à configurer Kubernetes, fournir la base de données Postgresql, puis installer un cadre d'application qui nous aidera à déployer facilement l'API Go dans Kubernetes, sans se concentrer sur les détails.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons créer deux points de terminaison dans l'API - l'un pour créer un nouvel enregistrement TODO, l'autre pour sélectionner tous les enregistrements TODO. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout le code de ce tutoriel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est disponible sur GitHub.</font></font></a></b><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La liste des composants nécessaires:</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker installé localement</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kubernetes exécute du code dans les images de conteneur, vous devez donc installer Docker sur votre ordinateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez Docker: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.docker.com</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Enregistrez un compte Docker Hub pour stocker vos images Docker: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://hub.docker.com/</font></font></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cluster Kubernetes</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez choisir un cluster local ou distant, mais lequel est le meilleur? </font><font style="vertical-align: inherit;">Les options simplifiées, telles que k3d, fonctionnent sur n'importe quel ordinateur sur lequel Docker peut s'exécuter, de sorte que l'exécution d'un cluster local ne nécessite plus beaucoup de RAM. </font><font style="vertical-align: inherit;">Un cluster distant peut également être une solution très efficace, mais gardez à l'esprit que toutes vos images Docker devront être téléchargées et téléchargées pour chaque changement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez k3d: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/rancher/k3d</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
k3d n'installera pas kubectl (il s'agit de l'interface CLI pour Kubernetes), alors installez-le séparément d'ici: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://kubernetes.io/docs/tasks/tools / install-kubectl</font></font></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golang</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez également installer Golang avec l'IDE sur votre ordinateur. </font><font style="vertical-align: inherit;">Go est gratuit et vous pouvez le télécharger pour MacOS, Windows ou Linux à partir du lien suivant: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://golang.org/dl</font></font></a><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IDE</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je recommanderais d'utiliser Visual Studio Code, il est gratuit et dispose d'un ensemble de plugins pour Go que vous pouvez ajouter. </font><font style="vertical-align: inherit;">Certains collègues préfèrent Goland de Jetbrains. </font><font style="vertical-align: inherit;">Si vous êtes un programmeur Java, vous préféreriez probablement payer pour Goland, car cela vous rappellera leurs autres produits. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VSCode</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Golang</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créer un cluster</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous devez installer tous les logiciels spécifiés dans la section précédente.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créez un nouveau cluster à l'aide de k3d:</font></font></h4><br>
<code>k3d create</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configurez kubectl pour qu'il pointe vers un nouveau cluster. </font><font style="vertical-align: inherit;">N'oubliez pas que plusieurs clusters peuvent être utilisés à partir d'un même ordinateur, il est donc extrêmement important de pointer vers le bon:</font></font><br>
<br>
<pre><code class="go hljs">export KUBECONFIG=<span class="hljs-string">"$(k3d get-kubeconfig --name='k3s-default')"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assurez-vous que le cluster possède au moins un nœud. </font><font style="vertical-align: inherit;">Ici, vous pouvez voir que j'ai installé Kubernetes 1.17 - une version relativement nouvelle:</font></font><br>
<br>
<pre><code class="go hljs">kubectl get node<font></font>
NAME                     STATUS   ROLES    AGE   VERSION<font></font>
k3d-k3s-<span class="hljs-keyword">default</span>-server   Ready    master   <span class="hljs-number">48</span>s   v1<span class="hljs-number">.17</span><span class="hljs-number">.0</span>+k3s<span class="hljs-number">.1</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous allons stocker nos enregistrements TODO dans la table de base de données, nous devons donc maintenant l'installer. </font><font style="vertical-align: inherit;">Postgresql est une base de données relationnelle populaire que nous pouvons installer dans un cluster à l'aide du graphique Helm.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installer Arkade</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">arkade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un CLI Go, similaire à "brew" ou "apt-get", mais pour les applications Kubernetes. </font><font style="vertical-align: inherit;">Il utilise un projet Helm, kubectl ou CLI pour installer un projet ou un produit dans votre cluster.</font></font><br>
<br>
<pre><code class="go hljs">curl -sLS https:<span class="hljs-comment">//dl.get-arkade.dev | sudo sh</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez maintenant Postgresql</font></font><br>
<br>
<pre><code class="go hljs">arkade install postgresql<font></font>
===================================================================== = PostgreSQL has been installed.                                    =<font></font>
=====================================================================</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous verrez également des informations sur la chaîne de connexion et comment démarrer la CLI Postgresql via l'image Docker à l'intérieur du cluster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez obtenir ces informations à tout moment en utilisant </font></font><code>arkade info postgresql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous concevrons la disposition de la table</font></font><br>
<br>
<pre><code class="go hljs">CREATE TABLE todo (<font></font>
 id              INT GENERATED ALWAYS AS IDENTITY,<font></font>
 description     text NOT NULL,<font></font>
 created_date    timestamp NOT NULL,<font></font>
 completed_date  timestamp NOT NULL<font></font>
);</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exécutez </font></font><code>arkade info postgresql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour obtenir à nouveau les informations de connexion. </font><font style="vertical-align: inherit;">Ça devrait ressembler a quelque chose comme ca:</font></font><br>
<br>
<pre><code class="go hljs">export POSTGRES_PASSWORD=$(kubectl get secret --namespace <span class="hljs-keyword">default</span> postgresql -o jsonpath=<span class="hljs-string">"{.data.postgresql-password}"</span> | base64 --decode)<font></font>
kubectl run postgresql-client --rm --tty -i --restart=<span class="hljs-string">'Never'</span> --namespace <span class="hljs-keyword">default</span> --image docker.io/bitnami/postgresql:<span class="hljs-number">11.6</span><span class="hljs-number">.0</span>-debian<span class="hljs-number">-9</span>-r0 --env=<span class="hljs-string">"PGPASSWORD=$POSTGRES_PASSWORD"</span> --command -- psql --host postgresql -U postgres -d postgres -p <span class="hljs-number">5432</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, vous avez à l'invite de commande:, </font></font><code>postgres = #</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous pouvez créer la table en la copiant à l'intérieur, puis exécutez </font></font><code>\dt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pour afficher la table:</font></font><br>
<br>
<pre><code class="go hljs">postgres=# \dt<font></font>
List of relations<font></font>
Schema | Name | Type  |  Owner<font></font>
--------+------+-------+----------<font></font>
public | todo | table | postgres<font></font>
(<span class="hljs-number">1</span> row)</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installer le cadre d'application</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout comme les développeurs PHP ont accéléré leur flux de travail en utilisant les développeurs LAMP (Linux Apache + Mysql + PHP) et Rails en utilisant une pile pré-préparée, les développeurs Kubernetes peuvent utiliser des cadres d'application. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La pile PLONK signifie Prometheus, Linux, OpenFaaS, NATS et Kubernetes.</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus fournit des mesures, une mise à l'échelle automatique et une observabilité pour tester la santé de votre système, lui permet de répondre aux poussées de la demande et de réduire les coûts en fournissant des mesures pour prendre des décisions sur la mise à l'échelle à zéro.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux, bien que n'étant pas la seule option pour exécuter des charges de travail dans Kubernetes, est standard et plus facile à utiliser.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Au départ, OpenFaaS fournissait des fonctions portables aux développeurs, mais cela fonctionne très bien lors du déploiement d'API et de microservices. </font><font style="vertical-align: inherit;">Sa polyvalence signifie que tous les conteneurs Docker avec un serveur HTTP peuvent être déployés et gérés.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NATS est un projet CNCF populaire utilisé pour la messagerie et le pub / sub. </font><font style="vertical-align: inherit;">Dans la pile PLONK, il offre la possibilité d'exécuter des demandes de manière asynchrone et pour la mise en file d'attente.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kubernetes est la raison pour laquelle nous sommes ici. </font><font style="vertical-align: inherit;">Il fournit une infrastructure évolutive, auto-réparatrice et déclarative. </font><font style="vertical-align: inherit;">Et si vous n'avez plus besoin d'une partie de toute cette grandeur, son API est simplifiée avec OpenFaaS.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Installez la pile PLONK via Arkade:</font></font><br>
<br>
<pre><code class="go hljs">arkade install openfaas</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lisez le message d'information et exécutez chaque commande:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Installez faas-cli.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obtenez votre mot de passe.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rediriger l'interface utilisateur de la passerelle OpenFaaS (via le port 8080)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et connectez-vous au système via la CLI.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme précédemment, vous pouvez recevoir un message d'information à l'aide de </font></font><code> info openfaas</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déployez votre API First Go</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe plusieurs façons de créer une API Go à l'aide de PLONK. </font><font style="vertical-align: inherit;">La première option consiste à utiliser le Dockerfile et à déterminer manuellement le port TCP, la vérification de l'état, le serveur HTTP, etc. </font><font style="vertical-align: inherit;">Cela peut être fait en utilisant </font></font><code>faas-cli new --lang dockerfile API_NAME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mais il existe un moyen plus simple et plus automatisé. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxième façon consiste à utiliser les modèles intégrés proposés par le magasin de fonctions:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli template store list | grep <span class="hljs-keyword">go</span>
<span class="hljs-keyword">go</span>                       openfaas           Classic Golang template<font></font>
golang-http              openfaas-incubator Golang HTTP template<font></font>
golang-middleware        openfaas-incubator Golang Middleware template</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puisque nous voulons créer une API de style HTTP traditionnelle, le modèle de middleware golang serait le plus approprié. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au début du didacticiel, vous vous êtes inscrit avec votre compte Docker Hub pour stocker vos images Docker. </font><font style="vertical-align: inherit;">Chaque charge de travail Kubernetes doit être intégrée dans une image Docker avant de pouvoir être déployée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tirez le motif spécial:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli template store pull golang-middleware</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilisez Scaffold pour votre API avec golang-middleware et votre nom d'utilisateur dans le Docker Hub:</font></font><br>
<br>
<pre><code class="go hljs">export PREFIX=alexellis2<font></font>
export LANG=golang-middleware<font></font>
export API_NAME=todo<font></font>
faas-cli <span class="hljs-built_in">new</span> --lang $LANG --prefix $PREFIX $API_NAME</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous verrez deux fichiers générés:</font></font><br>
<br>
<ul>
<li><code>./todo.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fournit un moyen de configurer, déployer et installer le modèle et le nom</font></font></li>
<li><code>./todo/handler.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - ici vous écrivez le code et ajoutez tous les autres fichiers ou packages dont vous avez besoin</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Faisons quelques modifications, puis développons le code.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">package</span> function
<span class="hljs-keyword">import</span> (
   <span class="hljs-string">"net/http"</span>
   <span class="hljs-string">"encoding/json"</span><font></font>
)<font></font>
<span class="hljs-keyword">type</span> Todo <span class="hljs-keyword">struct</span> {<font></font>
   Description <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"description"`</span><font></font>
}<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Handle</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {<font></font>
   todos := []Todo{}<font></font>
   todos = <span class="hljs-built_in">append</span>(todos, Todo{Description: <span class="hljs-string">"Run faas-cli up"</span>})<font></font>
   res, _ := json.Marshal(todos)<font></font>
   w.WriteHeader(http.StatusOK)<font></font>
   w.Header().Set(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)<font></font>
   w.Write([]<span class="hljs-keyword">byte</span>(res))<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous n'utilisez pas VScode et ses plugins pour éditer et formater le code, exécutez-le après chaque modification pour vous assurer que le fichier est correctement formaté.</font></font><br>
<br>
<pre><code class="go hljs">gofmt -w -s ./todo/handler.<span class="hljs-keyword">go</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Déployez maintenant le code - créez d'abord une nouvelle image, lancez-la dans le Docker Hub et déployez-la sur le cluster à l'aide de l'API OpenFaaS:</font></font><br>
<br>
<pre><code class="go hljs">Invoke your endpoint when ready:<font></font>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo</span><font></font>
{<font></font>
<span class="hljs-string">"description"</span>: <span class="hljs-string">"Run faas-cli up"</span>
}</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autoriser les utilisateurs à créer de nouveaux enregistrements TODO</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permettons maintenant aux utilisateurs de créer de nouvelles entrées dans leur liste TODO. </font><font style="vertical-align: inherit;">Vous devez d'abord ajouter le lien ou la «dépendance» pour Aller à la bibliothèque Postgresql. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons l'obtenir en utilisant les modules de vente ou Go qui ont été introduits dans Go 1.11 et installés par défaut dans Go 1.13. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez </font></font><code>handler.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et ajoutez le module dont nous avons besoin pour accéder à Postgresql:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">import</span> (
   <span class="hljs-string">"database/sql"</span>
   _ <span class="hljs-string">"github.com/lib/pq"</span>
...</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que les modules Go détectent les dépendances, nous devons déclarer quelque chose dans le fichier, que nous utiliserons plus tard. </font><font style="vertical-align: inherit;">Si ce n'est pas le cas, VSCode supprimera ces lignes lors de l'enregistrement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez ceci sous les importations dans le fichier</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">var</span> db *sql.DB</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exécutez toujours ces commandes dans le </font></font><code>todo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dossier où il se trouve </font></font><code>handler.go</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, et non au niveau racine c </font></font><code>todo.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initialisez le nouveau module Go:</font></font><br>
<br>
<pre><code class="go hljs">cd todo/<font></font>
ls<font></font>
handler.<span class="hljs-keyword">go</span><font></font>
export GO111MODULE=on<font></font>
<span class="hljs-keyword">go</span> mod init</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, mettez à jour le fichier en utilisant la bibliothèque pq:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">go</span> get
<span class="hljs-keyword">go</span> mod tidy<font></font>
cat <span class="hljs-keyword">go</span>.mod<font></font>
module github.com/alexellis/todo1/todo<font></font>
<span class="hljs-keyword">go</span> <span class="hljs-number">1.13</span>
require github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout ce qui se trouve à l'intérieur </font></font><code>go.mod</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, copiez son contenu dans</font></font><code>GO_REPLACE.txt</code><br>
<br>
<pre><code class="go hljs">cat <span class="hljs-keyword">go</span>.mod &gt; GO_REPLACE.txt</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, assurons-nous que l'assembly fonctionne toujours avant d'ajouter le code d'insertion.</font></font><br>
<br>
<pre><code class="go hljs">faas-cli build -f todo.yml --build-arg GO111MODULE=on</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous remarquerez peut-être que nous transmettons maintenant </font></font><code>--build-arg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un modèle d'utilisation des modules Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de l'assemblage, vous verrez que les modules sont téléchargés au besoin sur Internet.</font></font><br>
<br>
<pre><code class="go hljs">Step <span class="hljs-number">16</span>/<span class="hljs-number">29</span> : RUN <span class="hljs-keyword">go</span> test ./... -cover<font></font>
---&gt; Running in <span class="hljs-number">9</span>a4017438500
<span class="hljs-keyword">go</span>: downloading github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span>
<span class="hljs-keyword">go</span>: extracting github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span>
<span class="hljs-keyword">go</span>: finding github.com/lib/pq v1<span class="hljs-number">.3</span><span class="hljs-number">.0</span><font></font>
?       github.com/alexellis/todo1/todo [no test files]<font></font>
Removing intermediate container <span class="hljs-number">9</span>a4017438500</code></pre><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuration des secrets pour l'accès Postgresql</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous pouvons créer un pool de connexions dans </font></font><code>init ()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, une méthode qui ne s'exécutera qu'une seule fois au démarrage du programme.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// init       .   ,     ,   /   /</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {
       <span class="hljs-keyword">if</span> _, err := os.Stat(<span class="hljs-string">"/var/openfaas/secrets/password"</span>); err == <span class="hljs-literal">nil</span> {<font></font>
               password, _ := sdk.ReadSecret(<span class="hljs-string">"password"</span>)<font></font>
               user, _ := sdk.ReadSecret(<span class="hljs-string">"username"</span>)<font></font>
               host, _ := sdk.ReadSecret(<span class="hljs-string">"host"</span>)<font></font>
               dbName := os.Getenv(<span class="hljs-string">"postgres_db"</span>)<font></font>
               port := os.Getenv(<span class="hljs-string">"postgres_port"</span>)<font></font>
               sslmode := os.Getenv(<span class="hljs-string">"postgres_sslmode"</span>)<font></font>
               connStr := <span class="hljs-string">"postgres://"</span> + user + <span class="hljs-string">":"</span> + password + <span class="hljs-string">"@"</span> + host + <span class="hljs-string">":"</span> + port + <span class="hljs-string">"/"</span> + dbName + <span class="hljs-string">"?sslmode="</span> + sslmode
<span class="hljs-keyword">var</span> err error<font></font>
               db, err = sql.Open(<span class="hljs-string">"postgres"</span>, connStr)
               <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                       <span class="hljs-built_in">panic</span>(err.Error())<font></font>
               }<font></font>
               err = db.Ping()<font></font>
               <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                       <span class="hljs-built_in">panic</span>(err.Error())<font></font>
               }<font></font>
       }<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous l'avez remarqué, certaines informations sont extraites de ce qui est </font></font><code> os.Getenv</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lu dans l'environnement. </font><font style="vertical-align: inherit;">Je considérerais ces valeurs comme non confidentielles, elles sont définies dans le fichier </font></font><code>todo.y</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le reste, comme le mot de passe et l'hôte, qui sont confidentiels, sont conservés dans les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">secrets de Kubernetes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez les créer à travers </font></font><code>faas-cli secret create</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou à travers </font></font><code>kubectl create secret generic -n openfaas-fn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La chaîne </font></font><code>sdk.ReadSecret</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vient de OpenFaaS CloudEND_LINK, avec l'importation suivante: </font></font><code>github.com/openfaas/openfaas-cloud/sdk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il lit un fichier secret sur le disque et renvoie une valeur ou une erreur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obtenez les valeurs secrètes de </font></font><code>arkade info postgresql</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, pour chaque mot de passe, procédez comme suit:</font></font><br>
<br>
<pre><code class="go hljs">export POSTGRES_PASSWORD=$(kubectl get secret --namespace <span class="hljs-keyword">default</span> postgresql -o jsonpath=<span class="hljs-string">"{.data.postgresql-password}"</span> | base64 --decode)<font></font>
export USERNAME=<span class="hljs-string">"postgres"</span><font></font>
export PASSWORD=$POSTGRES_PASSWORD<font></font>
export HOST=<span class="hljs-string">"postgresql.default"</span><font></font>
faas-cli secret create username --from-literal $USERNAME<font></font>
faas-cli secret create password --from-literal $PASSWORD<font></font>
faas-cli secret create host --from-literal $HOST</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vérifiez les secrets de disponibilité et de conformité:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli secret ls<font></font>
NAME<font></font>
username<font></font>
password<font></font>
host<font></font>
# And via kubectl:<font></font>
kubectl get secret -n openfaas-fn<font></font>
NAME                  TYPE                                  DATA   AGE<font></font>
username              Opaque                                <span class="hljs-number">1</span>      <span class="hljs-number">13</span>s<font></font>
password              Opaque                                <span class="hljs-number">1</span>      <span class="hljs-number">13</span>s<font></font>
host                  Opaque                                <span class="hljs-number">1</span>      <span class="hljs-number">12</span>s</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiez notre fichier YAML et ajoutez ce qui suit:</font></font><br>
<br>
<pre><code class="go hljs">secrets:<font></font>
   - host<font></font>
   - password<font></font>
   - username<font></font>
   environment:<font></font>
     postgres_db: postgres<font></font>
     postgres_sslmode: <span class="hljs-string">"disable"</span>
     postgres_port: <span class="hljs-number">5432</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, mettez à jour les modules Go et réexécutez la génération:</font></font><br>
<br>
<pre><code class="go hljs">cd todo
<span class="hljs-keyword">go</span> get
<span class="hljs-keyword">go</span> mod tidy<font></font>
cd ..<font></font>
faas-cli build -f todo.yml --build-arg GO111MODULE=on<font></font>
Successfully built d2c609f8f559<font></font>
Successfully tagged alexellis2/todo:latest<font></font>
Image: alexellis2/todo:latest built.<font></font>
[<span class="hljs-number">0</span>] &lt; Building todo done in <span class="hljs-number">22.50</span>s.<font></font>
[<span class="hljs-number">0</span>] Worker done.<font></font>
Total build time: <span class="hljs-number">22.50</span>s</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'assembly a fonctionné comme prévu, exécutons-le donc </font></font><code>faas-cli</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec les mêmes arguments pour démarrer et déployer l'image. </font><font style="vertical-align: inherit;">Si les informations d'identification et la configuration SQL sont correctes, nous ne verrons pas d'erreurs dans les journaux, cependant, si elles sont incorrectes, nous obtiendrons le code de panique dans init (). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vérifiez les journaux:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli logs todo
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z Forking - ./handler []
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Started logging stderr from function.
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Started logging stdout from function.
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> OperationalMode: http
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Timeouts: read: <span class="hljs-number">10</span>s, write: <span class="hljs-number">10</span>s hard: <span class="hljs-number">10</span>s.
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Listening on port: <span class="hljs-number">8080</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Metrics listening on port: <span class="hljs-number">8081</span>
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">10</span>:<span class="hljs-number">03</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">10</span>:<span class="hljs-number">03</span> Writing lock-file to: /tmp/.lock</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alors que tout semble bien, essayons maintenant d'appeler le point de terminaison:</font></font><br>
<br>
<pre><code class="go hljs">echo | faas-cli invoke todo -f todo.yml
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">11</span>:<span class="hljs-number">02</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">02</span> POST / - <span class="hljs-number">200</span> OK - ContentLength: <span class="hljs-number">35</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, nous avons maintenant établi une connexion réussie à la base de données et nous pouvons effectuer l'insertion. </font><font style="vertical-align: inherit;">Comment savons-nous cela? </font><font style="vertical-align: inherit;">Parce qu'il </font></font><code>db.Ping ()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renvoie une erreur, sinon il aurait jeté une panique:</font></font><br>
<br>
<pre><code class="go hljs">err = db.Ping()
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
   <span class="hljs-built_in">panic</span>(err.Error())<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suivez le lien pour plus de détails sur le package </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base de données / sql</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Écrire le code d'insertion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce code insère une nouvelle ligne dans la table </font></font><code>todo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et utilise une syntaxe spéciale dans laquelle la valeur n'est pas placée entre guillemets, mais est remplacée à la place par le code db.Query. </font><font style="vertical-align: inherit;">Dans "l'ancien temps" de la programmation LAMP, une erreur courante qui a rendu de nombreux systèmes dangereux: le manque de nettoyage des données d'entrée et la concaténation des entrées utilisateur directement dans l'instruction SQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imaginez quelqu'un entrer une description; </font></font><code>drop table todo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ce ne serait pas très amusant. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, nous exécutons </font></font><code>db.Query</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, puis passons l'instruction SQL à l'aide de </font></font><code>$1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>$2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etc. pour chaque valeur, puis nous pouvons obtenir le résultat et / ou l'erreur. </font><font style="vertical-align: inherit;">Nous devons également clôturer ce résultat, alors utilisez le report pour cela.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">insert</span><span class="hljs-params">(description <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">error</span></span> {<font></font>
       res, err := db.Query(<span class="hljs-string">`insert into todo (id, description, created_date) values (DEFAULT, $1, now());`</span>,<font></font>
               description)<font></font>
       <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
               <span class="hljs-keyword">return</span> err<font></font>
       }<font></font>
       <span class="hljs-keyword">defer</span> res.Close()
       <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, connectons cela au code.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Handle</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
       <span class="hljs-keyword">if</span> r.Method == http.MethodPost &amp;&amp; r.URL.Path == <span class="hljs-string">"/create"</span> {
               <span class="hljs-keyword">defer</span> r.Body.Close()<font></font>
               body, _ := ioutil.ReadAll(r.Body)<font></font>
               <span class="hljs-keyword">if</span> err := insert(<span class="hljs-keyword">string</span>(body)); err != <span class="hljs-literal">nil</span> {<font></font>
                       http.Error(w, fmt.Sprintf(<span class="hljs-string">"unable to insert todo: %s"</span>, err.Error()), http.StatusInternalServerError)<font></font>
               }<font></font>
       }<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Déployons-le et exécutons-le.</font></font><br>
<br>
<pre><code class="go hljs">echo | faas-cli invoke todo -f todo.yml<font></font>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo/create --data "faas-cli build"</span>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo/create --data "faas-cli push"</span>
curl http:<span class="hljs-comment">//127.0.0.1:8080/function/todo/create --data "faas-cli deploy"</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vérifiez les journaux de l'API:</font></font><br>
<br>
<pre><code class="go hljs">faas-cli logs todo
<span class="hljs-number">2020</span><span class="hljs-number">-03</span><span class="hljs-number">-26</span>T14:<span class="hljs-number">35</span>:<span class="hljs-number">29</span>Z <span class="hljs-number">2020</span>/<span class="hljs-number">03</span>/<span class="hljs-number">26</span> <span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">29</span> POST /create - <span class="hljs-number">200</span> OK - ContentLength: <span class="hljs-number">0</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vérifiez le contenu du tableau à l'aide de pgsql:</font></font><br>
<br>
<pre><code class="sql hljs">export POSTGRES_PASSWORD=$(kubectl get secret <span class="hljs-comment">--namespace default postgresql -o jsonpath="{.data.postgresql-password}" | base64 --decode)</span>
kubectl run postgresql-client <span class="hljs-comment">--rm --tty -i --restart='Never' --namespace default --image docker.io/bitnami/postgresql:11.6.0-debian-9-r0 --env="PGPASSWORD=$POSTGRES_PASSWORD" --command -- psql --host postgresql -U postgres -d postgres -p 5432</span>
postgres=<span class="hljs-comment"># select * from todo;</span><font></font>
id |   description   |        created_date        | completed_date<font></font>
<span class="hljs-comment">----+-----------------+----------------------------+----------------</span><font></font>
1 | faas-cli build  | 2020-03-26 14:36:03.367789 |<font></font>
2 | faas-cli push   | 2020-03-26 14:36:03.389656 |<font></font>
3 | faas-cli deploy | 2020-03-26 14:36:03.797881 |</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Félicitations, vous disposez désormais d'une API TODO qui peut accepter les demandes entrantes via </font></font><code>curl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou tout autre client HTTP et les écrire dans la table de base de données.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Demande d'enregistrement</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Créons une nouvelle fonction pour interroger les enregistrements TODO à partir d'une table:</font></font><br>
<br>
<pre><code class="sql hljs">func selectTodos() ([]Todo, error) {<font></font>
   var error err<font></font>
   var todos []Todo<font></font>
   return todos, err<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous ne pouvons pas nommer cette méthode de sélection car il s'agit d'un mot clé réservé pour travailler avec des goroutines. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connectez maintenant la méthode au gestionnaire principal:</font></font><br>
<br>
<pre><code class="sql hljs">} else if r.Method == http.MethodGet &amp;&amp; r.URL.Path == "/list" {<font></font>
   todos, err := selectTodos()<font></font>
   if err != nil {<font></font>
       http.Error(w, fmt.Sprintf("unable to get todos: %s", err.Error()), http.StatusInternalServerError)<font></font>
   }<font></font>
   out, _ := json.Marshal(todos)<font></font>
   w.Header().Set("Content-Type", "application/json")<font></font>
   w.Write(out)<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant qu'il y a des champs supplémentaires pour les dates dans notre schéma de données, mettez à jour la structure Todo:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Todo <span class="hljs-keyword">struct</span> {<font></font>
   ID <span class="hljs-keyword">int</span> <span class="hljs-string">`json:"id"`</span>
   Description   <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"description"`</span>
   CreatedDate   *time.Time <span class="hljs-string">`json:"created_date"`</span>
   CompletedDate *time.Time <span class="hljs-string">`json:"completed_date"`</span>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutons maintenant le </font></font><code>selectTodos()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code de requête </font><font style="vertical-align: inherit;">à notre méthode </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs">func selectTodos() ([]Todo, error) {<font></font>
       rows, getErr := db.Query(`<span class="hljs-keyword">select</span> <span class="hljs-keyword">id</span>, description, created_date, completed_date <span class="hljs-keyword">from</span> todo;`)<font></font>
   if getErr != nil {<font></font>
       return []Todo{}, errors.Wrap(getErr, "unable to get from todo table")<font></font>
   }<font></font>
   todos := []Todo{}<font></font>
   defer rows.Close()<font></font>
   for rows.Next() {<font></font>
       result := Todo{}<font></font>
       scanErr := rows.Scan(&amp;result.ID, &amp;result.Description, &amp;result.CreatedDate, &amp;result.CompletedDate)<font></font>
       if scanErr != nil {<font></font>
           log.Println("scan err:", scanErr)<font></font>
       }<font></font>
       todos = append(todos, result)<font></font>
   }<font></font>
   return todos, nil<font></font>
}</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme précédemment, nous devons retarder la fermeture des lignes de la demande. </font><font style="vertical-align: inherit;">Chaque valeur est insérée dans la nouvelle structure à l'aide de la méthode row.Scan. </font><font style="vertical-align: inherit;">À la fin de la méthode, nous avons un morceau de contenu Todo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essayons:</font></font><br>
<br>
<pre><code class="sql hljs">faas-cli up -f todo.yml <span class="hljs-comment">--build-arg GO111MODULE=on</span>
curl http://127.0.0.1:8080/function/todo/list</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici le résultat:</font></font><br>
<br>
<pre><code class="sql hljs">[<font></font>
 {<font></font>
   "id": 2,<font></font>
   "description": "faas-cli build",<font></font>
   "created_date": "2020-03-26T14:36:03.367789Z",<font></font>
   "completed_date": null<font></font>
 },<font></font>
 {<font></font>
   "id": 3,<font></font>
   "description": "faas-cli push",<font></font>
   "created_date": "2020-03-26T14:36:03.389656Z",<font></font>
   "completed_date": null<font></font>
 },<font></font>
 {<font></font>
   "id": 4,<font></font>
   "description": "faas-cli deploy",<font></font>
   "created_date": "2020-03-26T14:36:03.797881Z",<font></font>
   "completed_date": null<font></font>
 }<font></font>
]</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour supprimer les valeurs, nous pouvons mettre à jour les annotations de structure en ajoutant </font></font><code>omitempty</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="go hljs">CompletedDate *time.Time <span class="hljs-string">`json:"completed_date,omitempty"`</span></code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pour résumer le travail accompli</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous n'avons pas encore fini, mais c'est le bon moment pour nous arrêter et revoir ce que nous avons accompli jusqu'à présent. </font><font style="vertical-align: inherit;">Nous:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go, Docker, kubectl et VSCode (IDE) installés</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Déployer Kubernetes sur notre ordinateur local</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresql installé à l'aide d'Arkade et de Helm3</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenFaaS installé et la pile PLONK pour les développeurs d'applications Kubernetes</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Création de l'API REST statique initiale à l'aide de Go et </font></font><code>golang-middleware</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">du modèle OpenFaaS</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout de la fonctionnalité «insérer» à notre API TODO </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout d'une fonctionnalité de sélection à notre API TODO </font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exemple de code complet que nous avons créé jusqu'à présent est disponible sur mon compte GitHub: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alexellis / kubernetes-todo-go-app</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ensuite, nous pouvons faire beaucoup plus, par exemple:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout d'authentification à l'aide d'un jeton de support statique</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Créez une page Web à l'aide d'un modèle HTML statique ou React pour afficher une liste TODO et créer de nouveaux éléments.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajout de la prise en charge multi-utilisateurs à l'API</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et beaucoup plus. </font><font style="vertical-align: inherit;">Nous pourrions également nous plonger dans la pile PLONK et déployer le tableau de bord Grafana pour commencer à surveiller notre API et comprendre combien de ressources sont utilisées avec le tableau de bord Kubernetes ou le serveur métrique (installé à l'aide </font></font><code>arkade install</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En savoir plus sur arkade: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://get-arkade.dev</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Assistez à l'atelier OpenFaaS pour en savoir plus sur ce qui précède: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/openfaas/workshop/</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Vous pouvez vous abonner à ma newsletter premium Insiders Updates sur </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https: / /www.alexellis.io/</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
et sur mon twitter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alex Ellis</font></font></a><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En savoir plus sur le cours</font></font></a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr498120/index.html">Optimisation du temps de construction - Partie 1</a></li>
<li><a href="../fr498122/index.html">Comment tester sur un site distant pour ne pas ruiner le produit et votre vie</a></li>
<li><a href="../fr498124/index.html">Télégramme pour le support technique: outils et pièges</a></li>
<li><a href="../fr498126/index.html">Comment Amazon essaie d'amener les gens à acheter ... moins</a></li>
<li><a href="../fr498128/index.html">Numéro 36: Formation informatique - problèmes et défis actuels des grandes entreprises</a></li>
<li><a href="../fr498132/index.html">Recettes PostgreSQL: basculement automatique et réintégration automatique dans l'essaim de dockers</a></li>
<li><a href="../fr498134/index.html">Comment réutiliser du code avec des bundles symfony 5? Partie 1. Forfait minimum</a></li>
<li><a href="../fr498136/index.html">Conversation avec Polina Gurtova sur l'avenir et le présent de Frontend. Les organisateurs de DUMP 2020 posent des questions importantes.</a></li>
<li><a href="../fr498138/index.html">La vie après les études de premier cycle: comment j'ai décidé quoi faire ensuite lorsque l'enseignement supérieur et le travail existent déjà</a></li>
<li><a href="../fr498140/index.html">Répliquez cela. Webinaires Apache Ignite et GridGain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>