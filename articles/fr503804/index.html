<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè© üîÑ üßñüèΩ R√©cit de la fa√ßon de cr√©er une machine √† remonter le temps pour une base de donn√©es et d'√©crire accidentellement un exploit üë¶üèΩ ‚öúÔ∏è üïó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr. 
 
 Vous √™tes-vous d√©j√† demand√© comment changer l'heure dans la base de donn√©es? Facile? Eh bien, dans certains cas, oui, c'est facile ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>R√©cit de la fa√ßon de cr√©er une machine √† remonter le temps pour une base de donn√©es et d'√©crire accidentellement un exploit</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503804/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous √™tes-vous d√©j√† demand√© comment changer l'heure dans la base de donn√©es? </font><font style="vertical-align: inherit;">Facile? </font><font style="vertical-align: inherit;">Eh bien, dans certains cas, oui, c'est facile - la commande linux date et le truc sont dans le chapeau. </font><font style="vertical-align: inherit;">Et si vous devez modifier l'heure uniquement √† l'int√©rieur d'une instance de la base de donn√©es s'il y en a plusieurs sur le serveur? </font><font style="vertical-align: inherit;">Et pour un seul processus de base de donn√©es? </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ET? </font><font style="vertical-align: inherit;">Euh, c'est √ßa, mon ami, c'est tout le probl√®me.</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quelqu'un dira qu'il s'agit d'un autre sur, sans rapport avec la r√©alit√©, qui est p√©riodiquement pr√©sent√© sur Habr√©. </font><font style="vertical-align: inherit;">Mais non, la t√¢che est bien r√©elle et est dict√©e par la n√©cessit√© de la production - les tests de code. </font><font style="vertical-align: inherit;">Bien que je sois d'accord, le cas de test peut √™tre assez exotique - v√©rifiez comment le code se comporte pour une certaine date √† l'avenir. </font><font style="vertical-align: inherit;">Dans cet article, je vais examiner en d√©tail comment cette t√¢che a √©t√© r√©solue, et en m√™me temps capturer un peu le processus d'organisation des tests et dev repr√©sente la base Oracle. </font><font style="vertical-align: inherit;">Avant une longue lecture, installez-vous confortablement et demandez un chat.</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commen√ßons par une courte introduction pour montrer pourquoi cela est n√©cessaire. Comme d√©j√† annonc√©, nous √©crivons des tests lors de l'impl√©mentation des modifications dans la base de donn√©es. Le syst√®me sous lequel ces tests sont effectu√©s a √©t√© d√©velopp√© au d√©but (ou peut-√™tre un peu avant le d√©but) des z√©ro, donc toute la logique m√©tier est √† l'int√©rieur de la base de donn√©es et √©crite sous la forme de proc√©dures stock√©es dans le langage pl / sql. Et oui, cela nous fait souffrir et souffrir. Mais c'est un h√©ritage, et vous devez vivre avec. Dans le code et le mod√®le tabulaire, il est possible de sp√©cifier comment les param√®tres √† l'int√©rieur du syst√®me √©voluent dans le temps, en d'autres termes, de d√©finir l'activit√© √† partir de quelle date et √† quelle date ils peuvent √™tre appliqu√©s. Que faire? La r√©cente modification du taux de TVA en est un exemple frappant. Et pour que ces changements dans le syst√®me puissent √™tre v√©rifi√©s √† l'avance,une base de donn√©es avec de tels changements doit √™tre transf√©r√©e √† une certaine date dans le futur, les param√®tres de code dans les tableaux deviendront actifs au "moment actuel". Et en raison des sp√©cificit√©s du syst√®me pris en charge, vous ne pouvez pas utiliser de faux tests qui modifieraient simplement la valeur de retour de la date actuelle du syst√®me dans la langue au d√©marrage de la session de test.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons donc d√©termin√© pourquoi, puis nous devons d√©terminer </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comment l'</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> objectif </font><i><font style="vertical-align: inherit;">est</font></i><font style="vertical-align: inherit;"> atteint. </font><font style="vertical-align: inherit;">Pour ce faire, je ferai une petite r√©trospective des options de construction de bancs de test pour les d√©veloppeurs et comment a commenc√© chaque session de test.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Çge de pierre</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il √©tait une fois, lorsque les arbres √©taient petits et les gros ordinateurs centraux, il n'y avait qu'un seul serveur √† d√©velopper et il effectuait √©galement des tests. </font><font style="vertical-align: inherit;">Et en principe, tout cela √©tait suffisant pour tout le monde ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">640K est suffisant pour tout le monde!</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inconv√©nients: pour la t√¢che de changer l'heure, il fallait impliquer de nombreux d√©partements li√©s - administrateurs syst√®me (faisant le changement d'heure sur le serveur subd √† partir de la racine), administrateurs de SGBD (faisant le red√©marrage de la base de donn√©es), programmeurs ( il √©tait n√©cessaire de notifier qu'un changement d'heure se produirait, car une partie du code ne fonctionnait plus, par exemple, les jetons Web pr√©c√©demment √©mis pour appeler les m√©thodes api avaient cess√© d'√™tre valides et cela pouvait surprendre), les testeurs (se testant eux-m√™mes) ... lorsque vous revenez l'heure au pr√©sent tout a √©t√© r√©p√©t√© dans l'ordre inverse.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moyen √Çge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au fil du temps, le nombre de d√©veloppeurs dans le d√©partement a augment√© et √† un moment donn√©, le serveur a cess√© d'√™tre suffisant. Principalement d√ª au fait que diff√©rents d√©veloppeurs souhaitent modifier le m√™me package pl / sql et effectuer des tests pour celui-ci (m√™me sans changer l'heure). De plus en plus d'indignation se fait entendre: ¬´Combien de temps! Assez tol√©rant cela! Des usines aux ouvriers, des terres aux paysans! Chaque programmeur a une base de donn√©es! ‚Äù Cependant, si vous avez quelques t√©raoctets de base de donn√©es de produits et 50 √† 100 d√©veloppeurs, alors honn√™tement sous cette forme, l'exigence n'est pas tr√®s r√©elle. Et pourtant, tout le monde veut que la base de test et de d√©veloppement ne soit pas tr√®s en retard sur les ventes, √† la fois dans la structure et dans les donn√©es √† l'int√©rieur des tableaux. Il y avait donc un serveur s√©par√© pour les tests, appelons-le pr√©-production. Il a √©t√© construit √† partir de 2 serveurs identiques,o√π la vente a √©t√© faite pour restaurer la base de donn√©es √† partir de dollars RMAN et cela a pris environ 2 √† 2,5 jours. Apr√®s la r√©cup√©ration, la base de donn√©es a rendu l'anonymat des donn√©es personnelles et d'autres donn√©es importantes et la charge des applications de test a √©t√© appliqu√©e √† ce serveur (ainsi que les programmeurs eux-m√™mes ont toujours travaill√© avec le serveur r√©cemment restaur√©). Le travail avec le serveur requis a √©t√© assur√© √† l'aide de la ressource ip de cluster prise en charge via corosync (pacemaker). Pendant que tout le monde travaille avec le serveur actif, sur le 2√®me noeud, la r√©cup√©ration de la base de donn√©es recommence et apr√®s 2-3 jours, ils changent √† nouveau de place.Le travail avec le serveur requis a √©t√© assur√© √† l'aide de la ressource ip de cluster prise en charge via corosync (pacemaker). Pendant que tout le monde travaille avec le serveur actif, sur le 2√®me noeud, la r√©cup√©ration de la base de donn√©es recommence et apr√®s 2-3 jours, ils changent √† nouveau de place.Le travail avec le serveur requis a √©t√© assur√© √† l'aide de la ressource ip de cluster prise en charge via corosync (pacemaker). Pendant que tout le monde travaille avec le serveur actif, sur le 2√®me noeud, la r√©cup√©ration de la base de donn√©es recommence et apr√®s 2-3 jours, ils changent √† nouveau de place.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Des inconv√©nients √©vidents: vous avez besoin de 2 serveurs et 2 fois plus de ressources (principalement disque) que prod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avantages: op√©ration de changement d'heure et tests - elle peut √™tre effectu√©e sur le 2√®me serveur, sur le serveur principal √† ce moment-l√†, les d√©veloppeurs vivent et vaquent √† leurs occupations. </font><font style="vertical-align: inherit;">Le changement de serveur ne se produit que lorsque la base de donn√©es est pr√™te et que les temps d'arr√™t de l'environnement de test sont minimes.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√®re du progr√®s scientifique et technologique</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque nous sommes pass√©s √† la base de donn√©es 11g Release 2, nous avons d√©couvert une technologie int√©ressante qu'Oracle fournit sous le nom de CloneDB. L'essentiel est que les sauvegardes de la base de donn√©es de produits (il existe une copie directement en bits des fichiers de donn√©es de produit) sont stock√©es sur un serveur sp√©cial, qui publie ensuite cet ensemble de fichiers de donn√©es via DNFS (NFS direct) sur pratiquement n'importe quel nombre de serveurs, et vous n'avez pas besoin d'en avoir un sur le serveur le m√™me volume de disques, car l'approche Copy-On-Write est impl√©ment√©e: la base de donn√©es utilise un partage r√©seau avec les fichiers de donn√©es du serveur de sauvegarde pour lire les donn√©es dans les tableaux, et les modifications sont √©crites dans des fichiers de donn√©es locaux sur le serveur de d√©veloppement lui-m√™me. P√©riodiquement, la ¬´remise √† z√©ro des d√©lais¬ª est effectu√©e pour le serveur afin que les fichiers de donn√©es locaux ne se d√©veloppent pas beaucoup et que le lieu ne se termine pas. Lors de la mise √† jour du serveur, les donn√©es sont √©galement d√©personnalis√©es dans les tableaux,dans ce cas, toutes les mises √† jour des tables tombent dans des fichiers de donn√©es locaux et ces tables sont lues √† partir du serveur local, toutes les autres tables sont lues sur le r√©seau.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inconv√©nients: il y a encore 2 serveurs (pour assurer des mises √† jour fluides avec un temps d'arr√™t minimal pour les consommateurs), mais maintenant le volume des disques est consid√©rablement r√©duit. Pour stocker des dollars sur une balle nfs, vous avez besoin d'un serveur suppl√©mentaire de taille + - en tant que prod, mais le temps d'ex√©cution de la mise √† jour lui-m√™me est r√©duit (en particulier lors de l'utilisation de dollars incr√©mentiels). La mise en r√©seau avec une boule nfs ralentit sensiblement les op√©rations de lecture IO. Pour utiliser la technologie CloneDB, la base doit √™tre une Enterprise Edition; dans notre cas, nous avons d√ª effectuer √† chaque fois la proc√©dure de mise √† niveau sur les bases de test. Heureusement, les bases de donn√©es de test sont exempt√©es des politiques de licence Oracle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avantages: l'op√©ration de restauration d'une base √† partir d'un bakup prend moins d'un jour (je ne me souviens pas de l'heure exacte).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Changement d'heure: pas de changements majeurs. </font><font style="vertical-align: inherit;">Bien que, √† ce moment-l√†, des scripts aient d√©j√† √©t√© cr√©√©s pour modifier l'heure sur le serveur et red√©marrer la base de donn√©es afin de le faire sans attirer l' </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">attention des aides-soignants des</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> administrateurs.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√®re de la nouvelle histoire</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin d'√©conomiser encore plus d'espace disque et de rendre la lecture des donn√©es hors ligne, nous avons d√©cid√© d'impl√©menter notre version CloneDB (avec flashback et snapshots) en utilisant un syst√®me de fichiers avec compression. </font><font style="vertical-align: inherit;">Lors des tests pr√©liminaires, le choix s'est port√© sur ZFS, bien qu'il n'y ait pas de support officiel pour celui-ci dans le noyau Linux (citation de l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √Ä titre de comparaison, nous avons √©galement examin√© BTRFS (b-tree fs), dont Oracle fait la promotion, mais le taux de compression √©tait inf√©rieur avec la m√™me consommation de CPU et de RAM dans les tests. Pour activer la prise en charge ZFS sur RHEL5, son propre noyau bas√© sur UEK (noyau d'entreprise incassable) a √©t√© construit, et sur les axes et noyaux plus r√©cents, vous pouvez simplement utiliser le noyau UEK pr√™t √† l'emploi. La mise en ≈ìuvre d'une telle base de test est √©galement bas√©e sur le m√©canisme COW, mais au niveau des instantan√©s du syst√®me de fichiers. 2 p√©riph√©riques de disque sont fournis au serveur, sur un, le pool zfs est cr√©√©, o√π via RMAN une base de donn√©es de secours suppl√©mentaire est cr√©√©e √† partir de la vente, et puisque nous utilisons la compression, la partition prend moins de temps que la production.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le syst√®me est install√© sur le deuxi√®me p√©riph√©rique de disque et le reste est n√©cessaire au serveur et √† la base de donn√©es elle-m√™me pour fonctionner, par exemple, les partitions d'annulation et de temp. √Ä tout moment, vous pouvez cr√©er un instantan√© √† partir du pool zfs, qui s'ouvre ensuite en tant que base de donn√©es distincte. La cr√©ation d'un instantan√© prend quelques secondes. C'est magique! Et ces bases de donn√©es peuvent en principe √™tre inclin√©es beaucoup, si seulement le serveur avait suffisamment de RAM pour toutes les instances et la taille du pool zfs lui-m√™me (pour stocker les modifications dans les fichiers de donn√©es pendant la d√©personnalisation et pendant le cycle de vie du clone de base de donn√©es). Le principal moment de mise √† jour de la base de test est le fonctionnement de la d√©personnalisation des donn√©es, mais il tient √©galement en 15-20 minutes. Il y a une acc√©l√©ration importante.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inconv√©nients: sur le serveur, vous ne pouvez pas changer l'heure simplement en traduisant l'heure du syst√®me, car alors toutes les instances de base de donn√©es ex√©cut√©es sur ce serveur tomberont dans cette heure √† la fois. Une solution √† ce probl√®me a √©t√© trouv√©e et sera d√©crite dans la section appropri√©e. Pour l'avenir, je dirai que cela vous permet de modifier l'heure √† l'int√©rieur d'une seule instance de la base de donn√©es ( </font><i><font style="vertical-align: inherit;">par</font></i><font style="vertical-align: inherit;"> approche de changement d'heure </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par instance</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) sans affecter le reste sur le m√™me serveur. </font><font style="vertical-align: inherit;">Et l'heure sur le serveur lui-m√™me ne change pas non plus. </font><font style="vertical-align: inherit;">Cela √©limine le besoin d'un script racine pour changer l'heure sur le serveur. </font><font style="vertical-align: inherit;">Toujours √† ce stade, l'automatisation du changement d'heure pour les instances via Jenkins CI est impl√©ment√©e et les utilisateurs (√©quipes de d√©veloppement relativement parlant) qui poss√®dent leur stand ont le droit de travailler gr√¢ce auxquels ils peuvent eux-m√™mes changer l'heure, mettre √† jour le stand √† l'√©tat actuel avec les ventes, faire des instantan√©s et restauration (restauration) de la base √† l'instantan√© pr√©c√©demment cr√©√©.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'√®re de l'histoire r√©cente</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec l'av√®nement d'Oracle 12c, une nouvelle technologie est apparue - les bases de donn√©es enfichables et, par cons√©quent, les bases de donn√©es de conteneurs (cdb). Avec cette technologie, au sein d'une instance physique, plusieurs bases de donn√©es ¬´virtuelles¬ª peuvent √™tre cr√©√©es qui partagent une zone de m√©moire commune de l'instance. Avantages: vous pouvez √©conomiser de la m√©moire pour le serveur (et augmenter les performances globales de notre base de donn√©es, car toute la m√©moire qui √©tait occup√©e auparavant, par exemple, 5 instances diff√©rentes, peut √™tre partag√©e pour tous les conteneurs pdb d√©ploy√©s dans cdb, et ils ne l'utiliseront que quand ils en ont vraiment besoin, et non pas comme c'√©tait le cas lors de la phase pr√©c√©dente, lorsque chaque instance "bloquait" la m√©moire qui lui √©tait allou√©e et avec une faible activit√© de certains des clones, la m√©moire n'√©tait pas utilis√©e efficacement, en d'autres termes, elle √©tait inactive).Les fichiers de donn√©es de diff√©rents pdb se trouvent toujours dans le pool zfs, et lors du d√©ploiement de clones, ils utilisent le m√™me m√©canisme de capture instantan√©e zfs. √Ä ce stade, nous nous sommes rapproch√©s de la possibilit√© de donner √† presque tous les d√©veloppeurs leur propre base de donn√©es. La modification de l'heure √† ce stade ne n√©cessite pas de red√©marrage de la base de donn√©es et ne fonctionne de mani√®re tr√®s pr√©cise que pour les processus qui n√©cessitent une modification de l'heure; tous les autres utilisateurs travaillant avec cette base de donn√©es ne sont en aucune fa√ßon affect√©s.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moins: vous ne pouvez pas utiliser l'approche </font><font style="vertical-align: inherit;">de </font><font style="vertical-align: inherit;">changement de temps </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par instance</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la phase pr√©c√©dente, car nous avons maintenant une instance. Cependant, une solution √† ce cas a √©t√© trouv√©e. Et c'est pr√©cis√©ment cela qui a donn√© l'impulsion √† la r√©daction de cet article. Pour l'avenir, je dirai qu'il s'agit d'un changement de temps </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">par</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> approche de </font><i><font style="vertical-align: inherit;">processus</font></i><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">c'est-√†-dire dans chaque processus de base de donn√©es, vous pouvez d√©finir votre propre heure unique en g√©n√©ral.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, une session de test typique imm√©diatement apr√®s la connexion √† la base de donn√©es d√©finit le bon moment au d√©but de son travail, effectue des tests et renvoie le temps √† la fin. Le retour de l'heure est n√©cessaire pour une raison simple: certains processus de base de donn√©es Oracle ne se terminent pas lorsque le client de base de donn√©es se d√©connecte du serveur, ce sont des processus serveur appel√©s serveurs partag√©s, qui, contrairement aux processus d√©di√©s, s'ex√©cutent lorsque le serveur de base de donn√©es d√©marre et vivent presque ind√©finiment (dans l'id√©al image du monde). Si vous laissez l'heure modifi√©e dans un tel processus de serveur, alors une autre connexion qui sera servie dans ce processus recevra l'heure incorrecte.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans notre syst√®me, les serveurs partag√©s sont beaucoup utilis√©s, car jusqu'√† 11 g, il n'y avait pratiquement pas de solution ad√©quate pour que notre syst√®me r√©siste √† une charge √©lev√©e (en 11 g, DRCP est apparu - regroupement de connexions r√©sidentes de la base de donn√©es). Et voici pourquoi - dans sub, il y a une limite sur le nombre total de processus serveur qu'il peut cr√©er en mode d√©di√© et partag√©. Les processus d√©di√©s sont g√©n√©r√©s plus lentement que la base de donn√©es ne peut √©mettre un processus partag√© d√©j√† pr√™t √† partir du pool de processus partag√©s, ce qui signifie que lorsque de nouvelles connexions arrivent constamment (en particulier si le processus effectue d'autres op√©rations lentes), le nombre total de processus augmente. Lorsque la limite de sessions / processus est atteinte, la base de donn√©es cesse de desservir de nouvelles connexions et un effondrement se produit.La transition vers l'utilisation d'un pool de processus partag√©s nous a permis de r√©duire le nombre de nouveaux processus sur le serveur lors de la connexion.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C‚Äôest l√† que l‚Äôexamen des technologies de cr√©ation de bases de donn√©es de test est termin√©, et nous pouvons enfin commencer √† impl√©menter les algorithmes de changement de temps pour la base de donn√©es elle-m√™me.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fausse approche par instance</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment changer l'heure dans la base de donn√©es? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re chose qui m'est venue √† l'esprit √©tait de cr√©er dans un sch√©ma qui contient tout le code logique m√©tier, sa propre fonction, qui chevauche les fonctions de langage qui fonctionnent avec le temps (sysdate, current_date, etc.) et, sous certaines conditions, commence √† donner d'autres valeurs, par exemple, vous pourriez d√©finissez les valeurs via le contexte de la session au d√©but de l'ex√©cution du test. Cela n'a pas fonctionn√©, les fonctions de langage int√©gr√©es ne se chevauchaient pas avec celles de l'utilisateur. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ensuite, des syst√®mes de virtualisation l√©gers (Vserver, OpenVZ) et la conteneurisation via docker ont √©t√© test√©s. Cela ne fonctionne pas non plus, ils utilisent le m√™me noyau que le syst√®me h√¥te, ce qui signifie qu'ils utilisent les m√™mes valeurs de temporisation syst√®me. Tomber √† nouveau.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ici, je n'ai pas peur de venir √† la rescousse de ce mot, une brillante invention du monde Linux - red√©finition / interception de fonctions au stade du chargement dynamique d'objets partag√©s. Il est connu de beaucoup comme des astuces avec LD_PRELOAD. Dans la variable d'environnement LD_PRELOAD, vous pouvez sp√©cifier la biblioth√®que qui sera charg√©e avant toutes les autres dont le processus a besoin, et si cette biblioth√®que contient des caract√®res avec le m√™me nom que par exemple dans la libc standard, qui sera charg√©e plus tard, alors la table d'importation de symboles pour l'application ressemblera √† une fonction fournit notre module de remplacement. Et c'est exactement ce que fait la biblioth√®que de projet </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libfaketime</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que nous avons commenc√© √† utiliser afin de d√©marrer la base de donn√©es √† un moment diff√©rent de celui du syst√®me. La biblioth√®que manque des appels qui concernent l'utilisation du minuteur du syst√®me et l'obtention de l'heure et de la date du syst√®me. Pour contr√¥ler combien de temps se d√©place par rapport √† la date actuelle du serveur ou √† partir de quel moment le temps doit passer √† l'int√©rieur du processus - tout est contr√¥l√© par des variables d'environnement qui doivent √™tre d√©finies avec LD_PRELOAD. Pour impl√©menter le changement d'heure, nous avons impl√©ment√© un travail sur le serveur Jenkins, qui entre dans le serveur de base de donn√©es et red√©marre le SGBD avec ou sans variables d'environnement d√©finies pour libfaketime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un exemple d'algorithme pour d√©marrer une base de donn√©es avec un temps de substitution:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">export</span> LD_PRELOAD=/usr/<span class="hljs-built_in">local</span>/lib/faketime/libfaketime.so
<span class="hljs-built_in">export</span> FAKETIME=<span class="hljs-string">"+1d"</span>
<span class="hljs-built_in">export</span> FAKETIME_NO_CACHE=1<font></font>
<font></font>
<span class="hljs-variable">$ORACLE_HOME</span>/bin/sqlplus @/home/oracle/scripts/restart_db.sql
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et si vous pensez que tout a fonctionn√© tout de suite, vous vous trompez profond√©ment. </font><font style="vertical-align: inherit;">Car, comme il s'est av√©r√©, valide les biblioth√®ques qui sont charg√©es dans le processus au d√©marrage du SGBD. </font><font style="vertical-align: inherit;">Et dans le journal des alertes, il commence √† ressentir la contrefa√ßon constat√©e, tandis que la base ne d√©marre pas. </font><font style="vertical-align: inherit;">Maintenant, je ne me souviens pas exactement comment m'en d√©barrasser, il y a un param√®tre qui peut d√©sactiver l'ex√©cution des v√©rifications d'int√©grit√© au d√©marrage.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La fausse approche par processus</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'id√©e g√©n√©rale de changer l'heure uniquement en 1 processus est rest√©e la m√™me - utilisez libfaketime. </font><font style="vertical-align: inherit;">Nous d√©marrons la base de donn√©es avec une biblioth√®que pr√©charg√©e, mais d√©finissons un d√©calage de temps nul au d√©marrage, qui est ensuite propag√© √† tous les processus SGBD. </font><font style="vertical-align: inherit;">Et puis, √† l'int√©rieur de la session de test, d√©finissez la variable d'environnement pour ce processus uniquement. </font><font style="vertical-align: inherit;">Pff, quelque chose d'affaires.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, pour ceux qui sont familiers avec le langage pl / sql, tout le destin de cette id√©e est imm√©diatement clair. Parce que la langue est tr√®s limit√©e et convient essentiellement aux t√¢ches de haut niveau. Aucune programmation syst√®me ne peut y √™tre impl√©ment√©e. Bien que certaines op√©rations de bas niveau (par exemple, travailler avec un r√©seau, travailler avec des fichiers) soient pr√©sentes sous la forme de packages dbms / utl syst√®me pr√©install√©s. Pendant tout le temps que j'ai travaill√© avec Oracle, j'ai fait plusieurs fois l'ing√©nierie inverse des packages pr√©install√©s, le code de certains d'entre eux est cach√© aux yeux des √©trangers (ils sont appel√©s wrapp√©s). S'il vous est interdit de regarder quelque chose, la tentation de d√©couvrir comment il est dispos√© √† l'int√©rieur ne fait qu'augmenter. Mais souvent, m√™me apr√®s anvrapper, il n'y a pas toujours quelque chose √† voir, car les fonctions de ces packages sont impl√©ment√©es en tant qu'interface </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avec des so-biblioth√®ques sur disque.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au total, nous avons approch√© un candidat pour la mise en ≈ìuvre - la technologie </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">avec des proc√©dures externes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La biblioth√®que con√ßue de mani√®re sp√©ciale peut exporter des m√©thodes que la base de donn√©es Oracle peut appeler via pl / sql. Semble prometteur. Ce n'est qu'une fois que j'ai rencontr√© cela dans des cours de plsql avanc√©, donc je me suis souvenu tr√®s √† distance comment le cuisiner. Et cela signifie qu'il est n√©cessaire de lire la documentation. Je l'ai lu - et je suis imm√©diatement d√©prim√©. Parce que le chargement d'une telle biblioth√®que personnalis√©e se fait dans un processus d'agent distinct via un √©couteur de base de donn√©es, et la communication avec cet agent passe par dlink. Notre id√©e a donc pleur√© de d√©finir une variable d'environnement dans le processus de base de donn√©es lui-m√™me. Et tout cela est fait pour des raisons de s√©curit√©. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une image de la documentation qui montre comment cela fonctionne:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pu/1h/07/pu1h07d6fvy1wwetq4deujbpnga.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le type de la biblioth√®que so / dll n'est pas si important, mais pour une raison quelconque, l'image est uniquement pour Windows. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Peut-√™tre que quelqu'un a remarqu√© ici une autre opportunit√© potentielle. Oui, oui, c'est Java. Oracle vous permet d'√©crire du code de proc√©dure stock√©e non seulement en plsql, mais aussi en java, qui sont n√©anmoins export√©s de la m√™me mani√®re que les m√©thodes plsql. P√©riodiquement, je l'ai fait, donc cela ne devrait pas poser de probl√®me. Mais un autre √©cueil s'est cach√©. Java fonctionne avec une copie de l'environnement et vous permet d'obtenir uniquement les variables d'environnement que le processus JVM avait au d√©marrage. La JVM int√©gr√©e h√©rite des variables d'environnement du processus de base de donn√©es, mais c'est tout. J'ai vu des conseils sur Internet pour changer la carte en lecture seule par r√©flexion, mais √† quoi √ßa sert, car ce n'est encore qu'une copie. Autrement dit, la femme s'est retrouv√©e avec rien.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, Java n'est pas seulement une fourrure pr√©cieuse. En l'utilisant, vous pouvez g√©n√©rer des processus √† partir d'un processus de base de donn√©es. Bien que toutes les op√©rations dangereuses doivent √™tre r√©solues s√©par√©ment via le m√©canisme de subventions java, qui sont effectu√©es √† l'aide du package dbms_java. Depuis l'int√©rieur du code plsql, vous pouvez obtenir le pid de processus du processus serveur actuel dans lequel le code s'ex√©cute, en utilisant les vues syst√®me v $ session et v $ process. De plus, nous pouvons g√©n√©rer un processus enfant de notre session pour faire quelque chose avec ce pid. Pour commencer, j'ai simplement d√©duit toutes les variables d'environnement qui sont √† l'int√©rieur du processus de base de donn√©es (pour tester l'hypoth√®se)</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
pid=<span class="hljs-variable">$1</span><font></font>
<font></font>
awk <span class="hljs-string">'BEGIN {RS="\0"; ORS="\n"} $0'</span> <span class="hljs-string">"/proc/<span class="hljs-variable">$pid</span>/environ"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien d√©duit, et puis quoi. Il est toujours impossible de modifier les variables dans le fichier environ, ce sont les donn√©es qui ont √©t√© transf√©r√©es au processus lors de son d√©marrage et elles sont en lecture seule. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai cherch√© sur Internet sur stackoverflow "Comment changer une variable d'environnement dans un autre processus." La plupart des r√©ponses √©taient que c'√©tait impossible, mais il y avait une r√©ponse qui d√©crivait cette opportunit√© comme un hack de mauvaise qualit√© et sale. Et cette r√©ponse √©tait </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Albert Einstein</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gdb. Le d√©bogueur peut s'accrocher √† n'importe quel processus connaissant son pid et ex√©cuter n'importe quelle fonction / proc√©dure qui y existe en tant que symbole export√© publiquement, par exemple, √† partir d'une biblioth√®que. Dans libc, il existe des fonctions pour travailler avec des variables d'environnement, et libc est charg√© dans n'importe quel processus de la base de donn√©es Oracle (et pratiquement dans n'importe quel programme sous linux).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voici comment la variable d'environnement est d√©finie dans un processus √©tranger (vous devez l'appeler √† partir de la racine en raison du ptrace utilis√©):</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
pid=<span class="hljs-variable">$1</span>
env_name=<span class="hljs-variable">$2</span>
env_val=<span class="hljs-string">"<span class="hljs-variable">$3</span>"</span><font></font>
<font></font>
out=`gdb -q -batch -ex <span class="hljs-string">"attach <span class="hljs-variable">$pid</span>"</span> -ex <span class="hljs-string">'call (int) setenv("'</span><span class="hljs-variable">$env_name</span><span class="hljs-string">'", "'</span><span class="hljs-string">"<span class="hljs-variable">$env_val</span>"</span><span class="hljs-string">'", 1)'</span> -ex <span class="hljs-string">"detach"</span> 2&gt;&amp;1`
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De plus, pour voir les variables d'environnement √† l'int√©rieur du processus gdb est √©galement appropri√©. </font><font style="vertical-align: inherit;">Comme mentionn√© pr√©c√©demment, le fichier environ de / proc / pid / affiche uniquement les variables qui existaient au d√©but du processus. </font><font style="vertical-align: inherit;">Et si le processus a cr√©√© quelque chose au cours de son travail, cela ne peut √™tre vu qu'√† travers le d√©bogueur:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-meta">#!/bin/sh
</span>
pid=<span class="hljs-variable">$1</span>
var_name=<span class="hljs-variable">$2</span><font></font>
<font></font>
var_value=`gdb -q -batch -ex <span class="hljs-string">"attach <span class="hljs-variable">$pid</span>"</span> -ex <span class="hljs-string">'call (char*) getenv("'</span><span class="hljs-variable">$var_name</span><span class="hljs-string">'")'</span> -ex <span class="hljs-string">'detach'</span> | egrep <span class="hljs-string">'^\$1 ='</span>`<font></font>
<font></font>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span> == <span class="hljs-string">'$1 = 0x0'</span> ]
<span class="hljs-keyword">then</span>
  <span class="hljs-comment"># variable empty or does not exist</span>
  <span class="hljs-built_in">echo</span> -n
<span class="hljs-keyword">else</span>
  <span class="hljs-comment"># gdb returns $1 = hex_value "string value"</span>
  var_hex=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span> | awk <span class="hljs-string">'{print $3}'</span>`<font></font>
  var_value=`<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span> | sed -r -e <span class="hljs-string">'s/^\$1 = '</span><span class="hljs-variable">$var_hex</span><span class="hljs-string">' //;s/^"//;s/"$//'</span>`<font></font>
  <font></font>
  <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"<span class="hljs-variable">$var_value</span>"</span>
<span class="hljs-keyword">fi</span>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Donc, la solution est d√©j√† dans notre poche - via java, nous g√©n√©rons le processus de d√©bogage, qui va au processus qui l'a g√©n√©r√© et d√©finit la variable d'environnement souhait√©e pour lui, puis se termine (le Maure a fait son travail - le Maure peut partir). </font><font style="vertical-align: inherit;">Mais on avait l'impression que c'√©tait une sorte de b√©quille. </font><font style="vertical-align: inherit;">Je voulais quelque chose de plus √©l√©gant. </font><font style="vertical-align: inherit;">Ce serait en quelque sorte la m√™me chose pour forcer le processus de la base de donn√©es √† d√©finir des variables d'environnement sans assaut externe.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un ≈ìuf dans un canard, un canard dans un li√®vre ...</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis quelqu'un vient √† la rescousse, oui, vous l'avez devin√©, encore Java, √† savoir JNI (interface native java). </font><font style="vertical-align: inherit;">JNI vous permet d'appeler des m√©thodes C natives √† l'int√©rieur de la JVM. </font><font style="vertical-align: inherit;">Le code est √©mis d'une mani√®re sp√©ciale sous la forme d'un objet partag√© de la biblioth√®que, que la JVM charge ensuite, tandis que les m√©thodes qui √©taient dans la biblioth√®que sont mapp√©es aux m√©thodes java √† l'int√©rieur de la classe d√©clar√©es avec le modificateur natif. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eh bien, ok, nous √©crivons une classe (en fait, ce n'est qu'une pi√®ce):</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Posix</span> </span>{<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">int</span> <span class="hljs-title">setenv</span><span class="hljs-params">(String key, String value, <span class="hljs-keyword">boolean</span> overwrite)</span></span>;<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String <span class="hljs-title">getenv</span><span class="hljs-params">(String key)</span></span>;<font></font>
    <font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stub</span><span class="hljs-params">()</span> 
    </span>{<font></font>
        <font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s cela, compilez-le et r√©cup√©rez le fichier h g√©n√©r√© de la future biblioth√®que:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#  </span><font></font>
javac Posix.java<font></font>
<font></font>
<span class="hljs-comment">#   Posix.h        JNI</span><font></font>
javah Posix<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir re√ßu le fichier d'en-t√™te, nous √©crivons le corps de chaque m√©thode:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"Posix.h"</span></span><font></font>
<font></font>
<span class="hljs-function">JNIEXPORT jint JNICALL <span class="hljs-title">Java_Posix_setenv</span><span class="hljs-params">(JNIEnv *env, jclass cls, jstring key, jstring value, jboolean overwrite)</span>
</span>{
    <span class="hljs-keyword">char</span>* k = (<span class="hljs-keyword">char</span> *) (*env)-&gt;GetStringUTFChars(env, key, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">char</span>* v = (<span class="hljs-keyword">char</span> *) (*env)-&gt;GetStringUTFChars(env, value, <span class="hljs-literal">NULL</span>);<font></font>
<font></font>
    <span class="hljs-keyword">int</span> err = setenv(k, v, overwrite);<font></font>
<font></font>
    (*env)-&gt;ReleaseStringUTFChars(env, key, k);<font></font>
    (*env)-&gt;ReleaseStringUTFChars(env, value, v);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> err;<font></font>
}<font></font>
<font></font>
<span class="hljs-function">JNIEXPORT jstring JNICALL <span class="hljs-title">Java_Posix_getenv</span><span class="hljs-params">(JNIEnv *env, jclass cls, jstring key)</span>
</span>{
    <span class="hljs-keyword">char</span>* k = (<span class="hljs-keyword">char</span> *) (*env)-&gt;GetStringUTFChars(env, key, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">char</span>* v = getenv(k);<font></font>
<font></font>
    <span class="hljs-keyword">return</span> (*env)-&gt;NewStringUTF(env, v);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et compiler la biblioth√®que</font></font><br>
<br>
<pre><code class="bash hljs">gcc -I<span class="hljs-string">"<span class="hljs-variable">$JAVA_HOME</span>/include"</span> -I<span class="hljs-string">"<span class="hljs-variable">$JAVA_HOME</span>/include/linux"</span> -fPIC Posix.c -shared -o libPosix.so -Wl,-soname -Wl,--no-whole-archive<font></font>
<font></font>
strip libPosix.so<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que Java charge la biblioth√®que native, elle doit √™tre trouv√©e par le syst√®me ld selon toutes les r√®gles Linux. </font><font style="vertical-align: inherit;">De plus, Java poss√®de un ensemble de propri√©t√©s qui contiennent les chemins d'acc√®s aux recherches de biblioth√®que. </font><font style="vertical-align: inherit;">La fa√ßon la plus simple de travailler dans Oracle est de mettre notre biblioth√®que dans $ ORACLE_HOME / lib. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et apr√®s avoir cr√©√© la biblioth√®que, nous devons compiler la classe √† l'int√©rieur de la base de donn√©es et la publier en tant que package plsql. </font><font style="vertical-align: inherit;">Il existe 2 options pour cr√©er des classes Java dans la base de donn√©es:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> charger le fichier de classe binaire via l'utilitaire loadjava</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compiler le code de classe √† partir de la source √† l'aide de sqlplus</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous utiliserons la deuxi√®me m√©thode, bien qu'elles soient fondamentalement √©gales. </font><font style="vertical-align: inherit;">Pour le premier cas, il √©tait n√©cessaire d'√©crire imm√©diatement tout le code de classe √† l'√©tape 1, lorsque nous avons re√ßu une classe de stub pour le fichier h. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour cr√©er une classe dans subd, une syntaxe sp√©ciale est utilis√©e:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> <span class="hljs-keyword">AND</span> RESOLVE <span class="hljs-keyword">JAVA</span> <span class="hljs-keyword">SOURCE</span> NAMED <span class="hljs-string">"Posix"</span> <span class="hljs-keyword">AS</span><font></font>
...<font></font>
...<font></font>
/<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque la classe est cr√©√©e, elle doit √™tre publi√©e en tant que m√©thodes plsql, et l√† encore la syntaxe sp√©ciale:</font></font><br>
<br>
<pre><code class="sql hljs">procedure set_env(var_name varchar2, var_value varchar2)<font></font>
is<font></font>
language java name 'Posix.set_env(java.lang.String, java.lang.String)';<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous essayez d'appeler des m√©thodes potentiellement dangereuses dans Java, une ex√©cution est d√©clench√©e qui indique qu'aucune autorisation Java n'a √©t√© √©mise pour l'utilisateur. </font><font style="vertical-align: inherit;">Le chargement de m√©thodes natives est une autre op√©ration dangereuse, car nous injectons du code superflu directement dans le processus de base de donn√©es (le m√™me exploit qui a √©t√© annonc√© dans l'en-t√™te). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais puisque la base de donn√©es est test, nous accordons une subvention sans aucun souci de connexion √† partir de sys:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">begin</span>
dbms_java.grant_permission( <span class="hljs-string">'SYSTEM'</span>, <span class="hljs-string">'SYS:java.lang.RuntimePermission'</span>, <span class="hljs-string">'loadLibrary.Posix'</span>, <span class="hljs-string">''</span>);
<span class="hljs-keyword">commit</span>;
<span class="hljs-keyword">end</span>;<font></font>
/<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le nom d'utilisateur du syst√®me est celui o√π j'ai compil√© le code java et le paquet wrapper plsql. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est important de noter que lors du chargement d'une biblioth√®que via un appel √† System.loadLibrary, nous omettons le pr√©fixe lib et l'extension so (comme d√©crit dans la documentation) et ne passons aucun chemin o√π chercher. Il existe une m√©thode System.load similaire qui ne peut charger une biblioth√®que qu'en utilisant un chemin absolu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis 2 d√©sagr√©ables surprises nous attendent - j'ai atterri dans le prochain trou de lapin d'Oracle. Lors de l'√©mission d'une autorisation, une erreur se produit avec un message plut√¥t brumeux:</font></font><br>
<br>
<pre><code class="plaintext hljs">ORA-29532: Java call terminated by uncaught Java exception: java.lang.SecurityException: policy table update
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le probl√®me est googl√© sur Internet et conduit √† My Oracle Support (aka Metalink). </font><font style="vertical-align: inherit;">Parce que </font><font style="vertical-align: inherit;">Selon les r√®gles d'Oracle, la publication d'articles √† partir d'un Metalink n'est pas autoris√©e dans les sources ouvertes, je ne mentionnerai que le num√©ro de document - 259471.1 (ceux qui y ont acc√®s pourront lire par eux-m√™mes). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'essence du probl√®me est qu'Oracle ne nous laissera pas simplement autoriser le chargement de code tiers suspect dans notre processus. </font><font style="vertical-align: inherit;">C'est logique. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais comme la base est test√©e et que nous avons confiance en notre code, nous autorisons le t√©l√©chargement sans craintes particuli√®res. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fuh, les m√©saventures sont partout.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est vivant, vivant</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec un souffle retenu, j'ai d√©cid√© d'essayer de donner vie √† mon Frankenstein. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous commen√ßons la base de donn√©es avec le libfaketime pr√©charg√© et le d√©calage 0. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connectez-vous √† la base de donn√©es et appelez le code qui affiche simplement l'heure avant et apr√®s avoir chang√© la variable d'environnement:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">begin</span>
dbms_output.enable(<span class="hljs-number">100000</span>);<font></font>
dbms_java.set_output(100000);<font></font>
dbms_output.put_line('old time: '||to_char(sysdate, 'dd.mm.yyyy hh24:mi:ss'));<font></font>
system.posix.set_env('FAKETIME','+1d');<font></font>
dbms_output.put_line('new time: '||to_char(sysdate, 'dd.mm.yyyy hh24:mi:ss'));<font></font>
<span class="hljs-keyword">end</span>;<font></font>
/<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√áa marche, bon sang! </font><font style="vertical-align: inherit;">Honn√™tement, je m'attendais √† d'autres surprises, telles que des erreurs ORA-600. </font><font style="vertical-align: inherit;">Cependant, l'alerte avait le num√©ro complet et le code a continu√© √† fonctionner. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est important de noter que si la connexion √† la base de donn√©es est effectu√©e comme d√©di√©e, puis une fois la connexion termin√©e, le processus sera d√©truit et il n'y aura aucune trace. </font><font style="vertical-align: inherit;">Mais si nous utilisons des connexions partag√©es, dans ce cas, un processus pr√™t √† l'emploi est allou√© √† partir du pool de serveurs, nous modifions l'heure dans celui-ci via des variables d'environnement et lorsqu'il est d√©connect√©, il restera modifi√© √† l'int√©rieur du processus. </font><font style="vertical-align: inherit;">Et lorsqu'une autre session de base de donn√©es tombe dans le m√™me processus serveur, elle recevra le mauvais moment √† sa grande surprise. </font><font style="vertical-align: inherit;">Par cons√©quent, √† la fin de la session de test, il est pr√©f√©rable de toujours remettre l'heure √† z√©ro.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'esp√®re que l'histoire √©tait int√©ressante (et peut-√™tre m√™me utile √† quelqu'un). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les codes sources sont tous disponibles sur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La documentation de libfaketime </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aussi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comment faites-vous les tests? </font><font style="vertical-align: inherit;">Et comment cr√©er des bases de donn√©es de d√©veloppement et de test dans une entreprise?</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus pour ceux qui lisent jusqu'au bout</font></font></b>
                        <div class="spoiler_text"><img src="https://habrastorage.org/webt/wd/m1/s9/wdm1s9kk6_kckj-xf5amc_o6wjq.jpeg"><br>
</div>
                    </div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr503782/index.html">Comment r√©aliser une table interactive avec une surface de travail en forme de cercle?</a></li>
<li><a href="../fr503786/index.html">Repr√©sentation num√©rique de l'audio analogique. Bref programme √©ducatif</a></li>
<li><a href="../fr503788/index.html">Courriel dynamique :: s√©curit√©</a></li>
<li><a href="../fr503790/index.html">Permutations. 9e ann√©e. T√¢che de parit√©</a></li>
<li><a href="../fr503796/index.html">Rendre le support moins cher, en essayant de ne pas perdre en qualit√©</a></li>
<li><a href="../fr503812/index.html">Pirate agile et quelques lois de la dialectique</a></li>
<li><a href="../fr503826/index.html">Protection DDoS sym√©trique et asym√©trique - quelle est la diff√©rence?</a></li>
<li><a href="../fr503830/index.html">Amazon a ouvert un grand refuge pour les sans-abri</a></li>
<li><a href="../fr503832/index.html">Recettes PostgreSQL: moteur de mod√®le de moustache</a></li>
<li><a href="../fr503836/index.html">Avantages et inconv√©nients des technologies de mod√©ration des commentaires (+ sondage)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>