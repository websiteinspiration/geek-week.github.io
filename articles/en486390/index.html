<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñãÔ∏è üòë üß• Wright In The Shadows üò± ‚õîÔ∏è üë¥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a story about one of the tasks that we prepared for the CTFZone qualifying stage , which was held at the end of November. You can read about t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wright In The Shadows</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/bizone/blog/486390/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a story about one of the tasks that we prepared for the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTFZone</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qualifying stage </font><font style="vertical-align: inherit;">, which was held at the end of November. You can read about the qualification preparation process </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You start with two files: decrypt_flag.py and ntfs_volume.raw. Let's take a look at the script. He opens a file named key.bin, and then, using a loop, he tries to take a 34-byte binary string from each offset inside the file, which is then used as input for the PBKDF2 function. Each returned key is used as an XOR key to decrypt the encrypted string sewn into the code. If its decrypted MD5 hash matches the predetermined value in a decrypted form, the script uses the received data to generate and print the flag.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So you need to find the key.bin file. </font><font style="vertical-align: inherit;">It‚Äôs impossible to simply sort through all offsets inside the image file (ntfs_volume.raw), since the process of finding the key will be too slow. </font><font style="vertical-align: inherit;">This is not forbidden by the rules, but you certainly won‚Äôt have time before the end of CTF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The image file contains a single-partition MBR partition table. </font><font style="vertical-align: inherit;">Its offset is 2048 512-byte sectors, and it contains the NTFS file system, but the key.bin file is not there:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ fls -o 2048 -r -p ntfs_volume.raw | grep -F key.bin | wc ‚Äìl<font></font>
0</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NTFS stores UTF-16LE encoded file names. </font><font style="vertical-align: inherit;">Let's try searching in it!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/c4/9n/5g/c49n5g_kmk7j-ga2zo5nzthtad0.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Search results for file records</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Having studied the search results, we focus on file records that begin with the FILE signature [1]. </font><font style="vertical-align: inherit;">Here is the only such entry:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/wv/-x/id/wv-xid-sp4valyl_kmqxj9e2o5s.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Found Record</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The goal is already close! We have a file record, but we need data. In NTFS, they are stored in the $ DATA attribute, which can be resident or non-resident [2]. For the record we found, this attribute starts at offset 0 √ó 3AADD00 and indicates non-resident data (this means that the information is stored outside the file record). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So where exactly is the data of the desired file? To answer this question, it is necessary to decode the so-called mapping pairs, or data runs (pairs ‚Äúblock length - block offset‚Äù) [3]. The data runs of the desired file are as follows (note the offset 0 √ó 3AADD40): 22 53 01 A0 4E 21 05 31 C1 11 38 30 00. Or, if we rearrange them:</font></font><br>
<br>
<pre><code class="plaintext hljs">1.	22 53 01 A0 4E<font></font>
2.	21 05 31 C1<font></font>
3.	11 38 30 00</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The file consists of three fragments, the size of the first of which is 339 clusters, and it starts with cluster # 20128. For our code using PBKDF2, this snippet is large. As indicated in the file system header, the size of one cluster is 4096 bytes:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ fsstat -o 2048 ntfs_volume.raw | grep 'Cluster Size'<font></font>
Cluster Size: 4096</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take a look at the data for this offset (in bytes): </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2048 * 512 + 20128 * 4096 = 83492864. We will extract any significant amount of information (for example, 128 bytes) from here, insert it into a new file, which we will call key.bin, run the script ... Nothing succeeded. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps the file was not stored in the current, but in the previous version of the file system (previous formatting) - do not forget that we did not see the record about the deleted file with the same name. What was the cluster size before? Let's look for the file system header with the NTFS signature [4]. Maybe we are lucky and we really find the header from the previous formatting.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s3/mp/na/s3mpnalay_jhx-yvaytbqgp4qta.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Search results for the file system header</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The first and last positions in the </font><i><font style="vertical-align: inherit;">search</font></i><font style="vertical-align: inherit;"> results refer to the current file system, but the file system headers located between them seem to belong to the previous formatting. And they have a different cluster size!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/co/hb/locohbcqzrc6_etzqfxfnb1tusk.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The file system header from the previous version.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Such a sector size is written at an offset of 0 √ó 4554800B: 00 02, or 512. But such a cluster size is recorded at an offset of 0 √ó 0x4554800D: F7, or 247. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we have the cluster size (in bytes) 512 * 247 = 126464. Some kind of nonsense! If you believe the NTFS parser [5], such a value must have a sign and be processed in a special way, so the real cluster size (in sectors) is 1 &lt;&lt; - (- 9) = 512. Or, if in bytes, 512 * 512 = 262144 Now sounds more believable. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The data starts here at this offset (in bytes): </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2048 * 512 + 20128 * 262144 = 5277483008. Let's try again to do the same trick with the information stored there ... Again, a failure! What is wrong? We have CTF here, it means ‚Äúnot so‚Äù anything can be.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task we are fighting over is called In the Shadows. </font><font style="vertical-align: inherit;">It is possible that it has something to do with shadow copies of the volume. </font><font style="vertical-align: inherit;">So, we have a file from the file system that previously existed in this volume. </font><font style="vertical-align: inherit;">Unfortunately, we simply cannot take and mount its shadow copy, but we know the exact offset at which the data begins! </font><font style="vertical-align: inherit;">This is 5277483008, or, inside the section, 5277483008 - 2048 * 512 = 5276434432. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
According to the specifications of the VSS format [6], redirected data blocks are described in the Block descriptor structure containing a 64-bit field in which the original offset (inside the volume) is stored, and also a 64-bit field describing the target block offset (inside the volume). </font><font style="vertical-align: inherit;">Let's look for 5276434432 as a 64-bit little endian number.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are only two results in the results, and only one of them is located at an even offset.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y6/bo/dm/y6bodmvczyemr2uu-2m7giaukqw.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Found block descriptor</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Target </font><i><font style="vertical-align: inherit;">block</font></i><font style="vertical-align: inherit;"> offset: 00 00 9B 03 00 00 00 00, or just 60489728. Final offset: 60489728 + 2048 * 512 = 61538304. From here, export a certain amount of data to a new file named key.bin, and ...</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ./decrypt_flag.py<font></font>
ctfzone{my_c0ngr4t5_t0_u,w311_d0n3_31337}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Done!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References</font></font></h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/concepts/file_record.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/attributes/data.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/concepts/data_runs.html</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://flatcap.org/linux-ntfs/ntfs/files/boot.html</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/msuhanov/dfir_ntfs/blob/94bb46d6600153071b0c3c507ef37c42ad62110d/dfir_ntfs/BootSector.py#L58</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/libyal/libvshadow/blob/master/documentation/Volume%20Shadow%20Snapshot%20(VSS)%20format.asciidoc#431-block-descriptor</font></font></a></li>
</ol></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en486390/">https://habr.com/ru/post/en486390/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486376/index.html">How level designers use architecture theory to create game levels</a></li>
<li><a href="../en486378/index.html">The solar-powered home server worked for 15 months: uptime 95.26%</a></li>
<li><a href="../en486380/index.html">What a Product Manager Should Actually Do</a></li>
<li><a href="../en486382/index.html">Seals and Scrum</a></li>
<li><a href="../en486388/index.html">MyVPN Open Source Nonprofit Project Overview</a></li>
<li><a href="../en486392/index.html">A brief comparison of the SDS architecture or finding a suitable storage platform (GlusterVsCephVsVirtuozzoStorage)</a></li>
<li><a href="../en486394/index.html">Bookmarks - is there a limit?</a></li>
<li><a href="../en486396/index.html">React Native: New Milestone in Shopify Mobile Development</a></li>
<li><a href="../en486400/index.html">To get your personal data, you need to give out even more personal data</a></li>
<li><a href="../en486402/index.html">Backup Death: New Threats and New Protection for Global Cyber ‚Äã‚ÄãSummit 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>