<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úçüèº ‚ù£Ô∏è üï¶ Am√©lioration des performances √† l'aide du cache uop sur Sandy Bridge + ü•¢ üë≤ ‚úçüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans les processeurs Intel x86 modernes, le pipeline peut √™tre divis√© en 2 parties: Front End et Back End. 
 
 Front End est charg√© de charger le code...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Am√©lioration des performances √† l'aide du cache uop sur Sandy Bridge +</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/497290/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans les processeurs Intel x86 modernes, le pipeline peut √™tre divis√© en 2 parties: Front End et Back End. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Front End est charg√© de charger le code de la m√©moire et de le d√©coder en micro-op√©rations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le back-end est responsable de l'ex√©cution des micro-op√©rations √† partir du front-end. </font><font style="vertical-align: inherit;">√âtant donn√© que ces micro-op√©rations peuvent √™tre effectu√©es par le noyau dans le d√©sordre, le back-end garantit √©galement que le </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r√©sultat</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de ces micro-op√©rations correspond strictement √† l'ordre dans lequel elles vont dans le code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans la plupart des cas, une utilisation inefficace de Front End'a n'a pas d'effet notable sur les performances. </font><font style="vertical-align: inherit;">La bande passante maximale sur la plupart des processeurs Intel est de 4 micro-op√©rations par cycle, par cons√©quent, par exemple, pour un code li√© √† la m√©moire / L3, le processeur ne pourra pas l'utiliser compl√®tement.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pro relativement nouveau Ice Lake</font></font></b><div class="spoiler_text">   ,      Ice Lake    4  5   .  ,        ,         . <br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, dans certains cas, la diff√©rence de performances peut √™tre assez importante. </font><font style="vertical-align: inherit;">Sous la coupe se trouve une analyse de l'impact du cache de micro-op√©ration sur les performances.</font></font><br>
<a name="habracut"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le contenu de l'article</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Environnement</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©sentation des processeurs Intel Front End'a</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache ¬µop de l'analyse de la bande passante maximale -&gt; IDQ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Environnement</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour toutes les mesures de cet article seront utilis√©es </font></font><code>i7-8550U Kaby Lake</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, HT activ√© / </font></font><code>Ubuntu 18.04/Linux Kernel 5.3.0-45-generic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Dans ce cas, un tel environnement peut √™tre important, car </font><font style="vertical-align: inherit;">chaque mod√®le de CPU a son propre √©v√©nement de performance. </font><font style="vertical-align: inherit;">En particulier, pour les microarchitectures plus anciennes que Sandy Bridge, certains des √©v√©nements utilis√©s √† l'avenir n'ont tout simplement aucun sens.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©sentation des processeurs Intel Front End'a</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'organisation de la cha√Æne de montage de haut niveau est accessible au public et est publi√©e dans la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation officielle d'Intel sur l'optimisation des logiciels</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Une description plus d√©taill√©e de certaines des fonctionnalit√©s qui sont omises de la documentation officielle peut √™tre trouv√©e dans d'autres sources r√©put√©es, telles que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agner Fog</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Travis Downs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ainsi, par exemple, le sch√©ma de pipeline d'assemblage pour Skylake dans la documentation Intel ressemble √† ceci: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/qe/jr/xa/qejrxaieyvky3yjl5yps8toljme.png" alt="Pipeline Skylake"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinons de plus </font><font style="vertical-align: inherit;">pr√®s la </font><font style="vertical-align: inherit;">partie sup√©rieure de ce sch√©ma - Front End. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/dp/ya/yw/dpyaywk2lq0qub5zh4dvjlqwjn4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Legacy Decode Pipeline est responsable du d√©codage du code dans les micro-op√©rations. </font><font style="vertical-align: inherit;">Il se compose des √©l√©ments suivants:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unit√© de r√©cup√©ration d'instructions - IFU</font></font><br>
 <ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache d'instructions de premier niveau - L1i</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache d'adresse de traduction du journal d'instructions - ITLB</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©fecteur instructeur</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instructions de pr√©-d√©codeur</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File d'attente d'instructions pr√©-d√©cod√©es</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©codeurs d'instructions pr√©-d√©cod√©s √† micro-op√©ration</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consid√©rez chacune des parties du pipeline de d√©codage h√©rit√© individuellement. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instruction Fetch Unit. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est responsable du chargement du code, du pr√©codage (d√©termination de la longueur de l'instruction et des propri√©t√©s telles que ¬´si l'instruction est une branche¬ª) et de la livraison des instructions pr√©-d√©cod√©es √† la file d'attente. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache d'instructions de premier niveau - L1i</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour t√©l√©charger le code, l'IFU utilise L1i, le cache d'instructions de premier niveau, et L2 / LLC, le cache de deuxi√®me niveau et le cache offcore de niveau sup√©rieur, communs au code et aux donn√©es. Le t√©l√©chargement s'effectue en morceaux de 16 octets, √©galement align√©s sur 16 octets. Lorsque le code suivant de 16 octets est charg√© dans l'ordre, un appel est effectu√© vers L1i et, si la ligne correspondante n'est pas trouv√©e, une recherche est effectu√©e dans L2 et, en cas d'√©chec, dans LLC et dans la m√©moire. Avant Skylake LLC, le cache √©tait inclusif - chaque ligne en L1 (i / d) et L2 devrait √™tre contenue dans le LLC. Ainsi, LLC "connaissait" toutes les lignes de tous les c≈ìurs et, dans le cas des erreurs LLC, on savait si les caches des autres c≈ìurs contenaient la ligne requise √† l'√©tat modifi√©, ce qui signifie que cette ligne pouvait √™tre charg√©e √† partir d'un autre c≈ìur. Skylake LLC est devenu un cache de victimes L2 non inclus, mais la taille L2 a √©t√© augment√©e 4 fois. Je ne sais passi L2 est inclusif par rapport √† L1i. L2</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> inclus en ce qui concerne L1d. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traduction d'adresses logiques d'instructions - ITLB</font></font></b> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Avant de t√©l√©charger des donn√©es depuis le cache, vous devez rechercher la ligne correspondante. Pour </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><code>n</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les caches associatifs -way</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , chaque ligne peut se trouver √† </font></font><code>n</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diff√©rents endroits du cache lui-m√™me. Pour d√©terminer les positions possibles dans le cache, un index est utilis√© (g√©n√©ralement quelques bits inf√©rieurs de l'adresse). Pour d√©terminer si la ligne correspond √† l'adresse dont nous avons besoin, une balise est utilis√©e (le reste de l'adresse). Quelles adresses utiliser: physiques ou logiques - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d√©pendent de la mise en ≈ìuvre du cache</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. L'utilisation d'adresses physiques n√©cessite une traduction d'adresse. Pour la traduction d'adresse, un tampon TLB est utilis√©, qui met en cache les r√©sultats des pages parcourues, r√©duisant ainsi le d√©lai de r√©ception d'une adresse physique √† partir d'une adresse logique lors des appels suivants. Pour les instructions, il existe son propre tampon d'instructions TLB, situ√© s√©par√©ment du Data TLB. Le noyau du processeur dispose √©galement d'un TLB de deuxi√®me niveau commun au code et aux donn√©es - STLB. Je ne sais pas si STLB est inclusif (selon la rumeur, il ne s'agit pas d'un cache de victime inclusif par rapport √† D / I TLB). Utilisation des instructions de pr√©lecture du logiciel</font></font><code>prefetcht1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vous pouvez remonter la ligne avec le code en L2, cependant, l'enregistrement TLB correspondant ne sera tir√© qu'en DTLB. </font><font style="vertical-align: inherit;">Si STLB n'est pas inclusif, alors lorsque vous recherchez cette ligne avec le code dans les caches, vous obtiendrez ITLB miss -&gt; STLB miss -&gt; page walk (en fait, ce n'est pas si simple, car le noyau peut </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initier une page promenade sp√©culative</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avant qu'elle ne se produise) TLB miss). </font><font style="vertical-align: inherit;">La documentation d'Intel d√©courage √©galement l'utilisation des pr√©fixes SW pour le code, Intel Software Optimization Manual / 2.5.5.4:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La pr√©lecture contr√¥l√©e par logiciel est destin√©e √† la pr√©lecture des donn√©es, mais pas √† la pr√©lecture du code.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, Travis D. a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mentionn√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qu'une telle pr√©lecture peut √™tre tr√®s efficace (et probablement elle l'est), mais jusqu'√† pr√©sent, cela n'est pas √©vident pour moi et pour en √™tre convaincu, je devrai examiner s√©par√©ment cette question. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©fecteur instructeur</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le chargement des donn√©es dans le cache (L1d / i, L2, etc.) se produit lors de l'acc√®s √† un emplacement de m√©moire non mis en cache. </font><font style="vertical-align: inherit;">Cependant, si cela ne se produisait que dans de telles conditions, il en r√©sulterait une utilisation inefficace de la bande passante du cache. </font><font style="vertical-align: inherit;">Par exemple, sur Sandy Bridge pour L1d - 2 op√©rations de lecture, 1 √©criture de 16 octets par cycle; </font><font style="vertical-align: inherit;">pour L1i - 1 op√©ration de lecture de 16 octets, le d√©bit d'√©criture n'est pas sp√©cifi√© dans la documentation, Agner Fog est √©galement introuvable. </font><font style="vertical-align: inherit;">Pour r√©soudre ce probl√®me, il existe des pr√©r√©cup√©rateurs mat√©riels qui peuvent d√©terminer le mod√®le d'acc√®s √† la m√©moire et tirer les lignes n√©cessaires dans le cache avant que le code ne les adresse r√©ellement. </font><font style="vertical-align: inherit;">La documentation Intel d√©finit 4 prefetchers: 2 pour L1d, 2 pour L2:</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L1 DCU</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Pr√©fixe les lignes de cache s√©rie. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lecture seule en avant</font></font></b></li>
<li><b>L1 IP</b> ‚Äî              (. 0x5555555545a0, 0x5555555545b0, 0x5555555545c0, ...),    ,   ,  </li>
<li><b>L2 Spatial</b> ‚Äî       L2    -,        128-.       LLC</li>
<li><b>L2 Streamer</b> ‚Äî    .    L1 DCU      ¬´¬ª.       LLC</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La documentation Intel ne d√©crit pas le principe du pr√©fecteur L1i. </font><font style="vertical-align: inherit;">Tout ce que l'on sait, c'est que la Branch Prediction Unit (BPU) est impliqu√©e dans ce processus, Intel Software Optimization Manual / 2.6.2: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sd/js/y3/sdjsy3jrgseyeuukletr84i2gyu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agner Fog ne voit pas non plus de d√©tails. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La pr√©lecture de code dans L2 / LLC est explicitement d√©finie uniquement pour Streamer. </font><font style="vertical-align: inherit;">Manuel d'optimisation / 2.5.5.4 Pr√©fection des donn√©es:</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Streamer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : ce pr√©fetcher surveille les demandes de lecture du cache L1 pour les s√©quences d'adresses ascendantes et descendantes. </font><font style="vertical-align: inherit;">Les demandes de lecture surveill√©es comprennent les demandes Lache DCache lanc√©es par les op√©rations de chargement et de stockage et par les pr√©-r√©cup√©rateurs mat√©riels, et les demandes L1 ICache pour l'extraction de code.</font></font></blockquote> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour le pr√©fet spatial, ce n'est clairement pas pr√©cis√©:</font></font><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prefetcher spatial:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ce prefetcher s'efforce de terminer chaque ligne de cache r√©cup√©r√©e dans le cache L2 avec la ligne de paire qui le compl√®te en un bloc align√© de 128 octets.</font></font></blockquote> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais cela peut √™tre v√©rifi√©. </font><font style="vertical-align: inherit;">Chacun de ces prefetchers peut √™tre d√©sactiv√© √† l'aide de </font></font><code>MSR 0x1A4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, comme d√©crit dans le manuel </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Model-Specific Registers.</font></font></a><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√Ä propos de MSR 0x1A4</font></font></b><div class="spoiler_text">  MSR     L2 Spatial    L1i.     .              ,    LLC.     L2 Streamer       2.5 . <br>
<br>
 Linux  msr ,   msr     .  <code>$ sudo wrmsr -p 1 0x1a4 1</code>  L2 Streamer   1.<br>
</div></div><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instructions de pr√©-d√©codeur Une</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
fois le code de 16 octets suivant charg√©, ils tombent dans les instructions de pr√©-d√©codeur. </font><font style="vertical-align: inherit;">Sa t√¢che est de d√©terminer la longueur de l'instruction, de d√©coder les pr√©fixes et de marquer si l'instruction correspondante est une branche (tr√®s probablement, il existe encore de nombreuses propri√©t√©s diff√©rentes, mais la documentation les concernant est silencieuse). </font><font style="vertical-align: inherit;">Manuel d'optimisation des logiciels Intel / 2.6.2.2:</font></font><br>
<blockquote>The predecode unit accepts the sixteen bytes from the instruction cache or prefetch buffers and carries out the following tasks:<br>
<br>
<ul>
<li>Determine the length of the instructions</li>
<li>Decode all prefixes associated with instructions</li>
<li>Mark various properties of instructions for the decoders (for example, ‚Äúis branch.‚Äù)</li>
</ul></blockquote><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une ligne d'instructions pr√©-d√©cod√©es. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depuis l'IFU, les instructions sont ajout√©es √† la file d'attente d'instructions pr√©-encod√©e. </font><font style="vertical-align: inherit;">Cette file d'attente est apparue depuis Nehalem, conform√©ment √† la documentation Intel, sa taille est de 18 instructions. </font><font style="vertical-align: inherit;">Agner Fog mentionne √©galement que cette file d'attente ne contient pas plus de 64 octets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toujours dans Core2, cette file d'attente a √©t√© utilis√©e comme cache de boucle. </font><font style="vertical-align: inherit;">Si toutes les micro-op√©rations du cycle sont dans la file d'attente, dans certains cas, le co√ªt du chargement et du pr√©codage pourrait √™tre √©vit√©. </font><font style="vertical-align: inherit;">Le d√©tecteur de flux en boucle (LSD) peut fournir des instructions qui sont d√©j√† dans la file d'attente jusqu'√† ce que le BPU signale la fin du cycle. </font><font style="vertical-align: inherit;">Agner Fog a un certain nombre de notes int√©ressantes concernant le LSD sur Core2:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compos√© de 4 lignes de 16 octets</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©bit maximal jusqu'√† 32 octets de code par cycle</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä partir de Sandy Bridge, ce cache de boucle est pass√© de la file d'attente d'instructions pr√©-d√©cod√©e √† IDQ. </font></font><br>
 <br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©codeurs d'instructions pr√©-d√©cod√©es en micro-op√©ration A</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
partir de la file d'attente d'instructions pr√©-d√©cod√©es, le code est envoy√© au d√©codage en micro-op√©ration. Les d√©codeurs sont responsables du d√©codage - il y en a au total 4. Selon la documentation d'Intel, l'un des d√©codeurs peut d√©coder des instructions compos√©es de 4 micro-op√©rations ou moins. Le reste d√©code les instructions consistant en une micro-op√©ration (micro / macro fusionn√©e), Intel Software Optimization Manual / 2.5.2.1:</font></font><br>
<blockquote>There are four decoding units that decode instruction into micro-ops. The first can decode all IA-32 and Intel 64 instructions up to four micro-ops in size. The remaining three decoding units handle single-micro-op instructions. All four decoding units support the common cases of single micro-op flows including micro-fusion and macro-fusion.</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les instructions d√©cod√©es dans un grand nombre de micro-op√©rations (par exemple rep movsb, utilis√©es dans l'impl√©mentation de memcpy dans libc sur certaines tailles de m√©moire copi√©e) proviennent de Microcode Sequencer (MS ROM). La bande passante maximale du s√©quenceur est de 4 micro-op√©rations par cycle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme vous pouvez le voir sur le diagramme de la cha√Æne de montage, le pipeline de d√©codage h√©rit√© peut d√©coder jusqu'√† 5 micro-op√©rations par cycle sur Skylake. Sur Broadwell et les anciens, le d√©bit de pointe du Legacy Decode Pipeline √©tait de 4 micro-op√©rations par cycle. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache de micro-op√©ration</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une fois les instructions d√©cod√©es dans des micro-op√©rations, √† partir du pipeline de d√©codage h√©rit√©, elles tombent dans la file d'attente de micro-op√©ration sp√©ciale - Instruction Decode Queue (IDQ), ainsi que dans le soi-disant cache de micro-op√©ration (Decoded ICache, cache ¬µop). Le cache de micro-op√©ration a √©t√© initialement introduit dans Sandy Bridge et est utilis√© pour √©viter la r√©cup√©ration et le d√©codage des instructions dans les micro-op√©rations, augmentant ainsi le d√©bit de livraison des micro-op√©rations en IDQ - jusqu'√† 6 par cycle. Apr√®s √™tre entr√© dans IDQ, les micro-op√©rations vont au back-end pour ex√©cution avec un d√©bit de pointe de 4 micro-op√©rations par cycle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon la documentation d'Intel, le cache de micro-op√©ration se compose de 32 ensembles, chaque ensemble contient 8 lignes, chaque ligne peut mettre en cache jusqu'√† 6 micro op√©rations (micro / macro fusionn√©es), permettant un cache total jusqu'√† 32 * 8 * 6 = 1536 micro op√©rations . </font><font style="vertical-align: inherit;">La mise en cache de la micro-op√©ration se produit avec une granularit√© de 32 octets, c'est-√†-dire </font><font style="vertical-align: inherit;">les micro-op√©rations qui suivent les instructions de diff√©rentes r√©gions de 32 octets ne peuvent pas tomber sur une seule ligne. </font><font style="vertical-align: inherit;">Cependant, jusqu'√† 3 lignes de cache diff√©rentes peuvent correspondre √† une r√©gion de 32 octets. </font><font style="vertical-align: inherit;">Ainsi, jusqu'√† 18 micro-op√©rations dans le cache ¬µop peuvent correspondre √† chaque r√©gion de 32 octets.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manuel d'optimisation des logiciels Intel / 2.5.5.2</font></font></b><div class="spoiler_text"><blockquote>The Decoded ICache consists of 32 sets. Each set contains eight Ways. Each Way can hold up to six micro-ops. The Decoded ICache can ideally hold up to 1536 micro-ops. The following are some of the rules how the Decoded ICache is filled with micro-ops:<br>
<br>
<ul>
<li>ll micro-ops in a Way represent instructions which are statically contiguous in the code and have their EIPs within the same aligned 32-byte region.</li>
<li>Up to three Ways may be dedicated to the same 32-byte aligned chunk, allowing a total of 18 micro-ops to be cached per 32-byte region of the original IA program.</li>
<li>A multi micro-op instruction cannot be split across Ways.</li>
<li>Up to two branches are allowed per Way. </li>
<li>An instruction which turns on the MSROM consumes an entire Way.</li>
<li>A non-conditional branch is the last micro-op in a Way. </li>
<li>Micro-fused micro-ops (load+op and stores) are kept as one micro-op.</li>
<li>A pair of macro-fused instructions is kept as one micro-op.</li>
<li>Instructions with 64-bit immediate require two slots to hold the immediate.</li>
</ul></blockquote><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agner Fog mentionne √©galement qu'une seule ligne de micro-op√©rations peut √™tre t√©l√©charg√©e par cycle (non explicitement indiqu√© dans la documentation Intel, bien qu'il puisse √™tre facilement v√©rifi√© manuellement).</font></font><br>
<br>
<h4>    ¬µop cache --&gt; IDQ</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans certains cas, il est tr√®s pratique d'utiliser </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">des longueurs d'un octet </font><font style="vertical-align: inherit;">pour √©tudier le comportement de Front End </font><font style="vertical-align: inherit;">. Dans le m√™me temps, nous pouvons √™tre s√ªrs que nous enqu√™tons sur le frontal, et non sur le blocage des ressources sur le back-end, pour une raison quelconque. Le fait est que </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ainsi que d'autres instructions, ils sont d√©cod√©s dans le pipeline de d√©codage h√©rit√©, m√©lang√©s dans le cache ¬µop et envoy√©s √† IDQ. En outre </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ainsi que d'autres instructions, reprend la fin. La diff√©rence significative est que des ressources sur le back-end, il </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utilise uniquement le </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tampon de r√©organisation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et ne n√©cessite pas de slot dans la station de r√©servation (alias Scheduler). Ainsi, imm√©diatement apr√®s avoir entr√© Reorder Buffer, il est </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pr√™t pour la retraite, qui sera effectu√©e conform√©ment √† l'ordre dans le code de programme.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour tester le d√©bit, d√©clarez une fonction </font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test_decoded_icache</span><span class="hljs-params">(<span class="hljs-keyword">size_t</span> iteration_count)</span></span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
avec mise en ≈ìuvre sur </font></font><code>nasm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">align 32<font></font>
test_decoded_icache:<font></font>
    ;nop',  0  23 <font></font>
    dec rdi<font></font>
    ja test_decoded_icache<font></font>
    ret</code></pre><br>
<code>ja</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il n'a pas √©t√© choisi par hasard. </font></font><code>ja</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>dec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utiliser diff√©rents drapeaux - </font></font><code>ja</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lit √† </font><font style="vertical-align: inherit;">partir </font></font><code>CF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>ZF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>dec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas d' </font><font style="vertical-align: inherit;">enregistrement dans les FC, si Macro Fusion ne s'applique pas. </font><font style="vertical-align: inherit;">Cela se fait uniquement pour la commodit√© du comptage des micro-op√©rations dans un cycle - chaque instruction correspond √† une micro-op√©ration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les mesures, nous avons besoin des √©v√©nements de perf suivants: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. </font></font><code>uops_issued.any</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Utilis√© pour compter les micro-op√©rations que Renamer prend d'IDQ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le Guide de programmation syst√®me Intel documente cet √©v√©nement comme le nombre de micro-op√©rations que Renamer place dans la station de r√©servation:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compte le nombre d'uops que la table d'allocation de ressources (RAT) envoie √† la station de r√©servation (RS).</font></font><br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cette description n'est pas compl√®tement en corr√©lation avec les valeurs qui peuvent √™tre obtenues √† partir d'exp√©riences. En particulier, ils </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tombent dans ce comptoir, m√™me si c'est un fait qu'ils ne sont pas du tout n√©cessaires √† la station de r√©servation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. </font></font><code>uops_retired.retire_slots</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le nombre total de micro-op√©rations retir√©es en tenant compte de la micro / macro-fusion </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. </font></font><code>uops_retired.stall_cycles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le nombre de ticks pour lesquels il n'y a pas eu une seule micro-op√©ration retir√©e </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4. </font></font><code>resource_stalls.any</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le nombre de ticks de convoyeur inactif en raison de l'inaccessibilit√© de l'une des ressources Back End </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Intel Software Optimization Manual / B .4.1 il existe un diagramme de contenu qui caract√©rise les √©v√©nements d√©crits ci-dessus: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wq/j9/y3/wqj9y3jj7aeisnmdjxxxjwsl_jk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5. </font></font><code>idq.all_dsb_cycles_4_uops</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le nombre de cycles d'horloge pour lesquels 4 (ou plus) instructions ont √©t√© fournies par le cache ¬µop.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le fait que cette m√©trique prenne en compte la livraison de plus de 4 micro-op√©rations par cycle n'est pas d√©crit dans la documentation d'Intel, mais elle est tr√®s bien en accord avec les exp√©riences. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6. </font></font><code>idq.all_dsb_cycles_any_uops</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- le nombre de mesures pour lesquelles au moins une micro-op√©ration a √©t√© r√©alis√©e. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7. </font></font><code>idq.dsb_cycles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Le nombre total de ticks auxquels la livraison a √©t√© effectu√©e √† partir du cache ¬µop </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8. </font></font><code>idq_uops_not_delivered.cycles_le_N_uop_deliv.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Le nombre </font><font style="vertical-align: inherit;">de ticks </font><font style="vertical-align: inherit;">pour lesquels Renamer a effectu√© une </font></font><code>N</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ou plusieurs micro-op√©rations et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">il n'y a eu aucun temps d'arr√™t du c√¥t√© arri√®re</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><code>N</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- 1, 2, 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous prenons pour la recherche </font></font><code>iteration_count = 1 &lt;&lt; 31</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Nous commen√ßons l'analyse de ce qui se passe dans le CPU en examinant le nombre de micro-op√©rations et, tout d'abord, en mesurant la bande passante de retrait moyenne, c'est-√†-dire </font></font><code>uops_retired.retire_slots/uops_retired.total_cycle</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xi/b2/0s/xib20shepbr334i1xmhka10rjeg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce qui attire imm√©diatement votre attention, c'est l'affaissement du d√©bit de retraite √† une taille de cycle de 7 micro-op√©rations. Afin de comprendre quel est le probl√®me, examinons comment la vitesse de livraison moyenne du cache ¬µop - change </font></font><code>idq.all_dsb_cycles_any_uops / idq.dsb_cycles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xm/5s/su/xm5ssuzamxr4th-xs7e0ixrisfm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
et comment le nombre total de mesures et de mesures pour lesquelles le cache ¬µop livr√© √† IDQ est li√©: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/it/w5/va/itw5vasl9ogpslneyoclxzasu4k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, nous pouvons voir qu'avec un cycle de 6 micro-op√©rations, nous obtenons une efficacit√© Utilisation de la bande passante du cache ¬µop - 6 micro-op√©rations par cycle. En raison du fait que Renamer ne peut pas prendre autant que le cache ¬µop fournit, une partie des cycles de cache ¬µop ne fournit rien, ce qui est clairement visible dans le graphique pr√©c√©dent.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avec un cycle de 7 micro-op√©rations, nous obtenons une forte baisse du d√©bit du cache ¬µop - 3,5 micro-op√©rations par cycle. Dans le m√™me temps, comme le montre le graphique pr√©c√©dent, le cache ¬µop est constamment en fonctionnement. Ainsi, avec un cycle de 7 micro-op√©rations, nous obtenons une utilisation inefficace du cache ¬µop de bande passante. Le fait est que, comme indiqu√© pr√©c√©demment, le cache ¬µop par cycle peut fournir des micro-op√©rations √† partir d'une seule ligne. En cas de micro-op√©rations 7 - les 6 premiers tombent sur une ligne, et le 7√®me restant - sur une autre. De cette fa√ßon, nous obtenons 7 micro-op√©rations par 2 cycles, ou 3,5 micro-op√©rations par cycle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant comment Renamer prend les micro-op√©rations d'IDQ. Pour cela, nous avons besoin </font></font><code>idq_uops_not_delivered.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">et </font></font><code>idq_uops_not_delivered.cycles_le_N_uop_deliv.core</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kv/mg/qv/kvmgqvwgra-j4qgpxia46mwlsh4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez remarquer qu'avec 7 micro-op√©rations, seules 3 micro-op√©rations √† la fois prennent la moiti√© des cycles de Renamer. De l√†, nous obtenons un d√©bit de retraite d'une moyenne de 3,5 micro-op√©rations par cycle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre point int√©ressant li√© √† cet exemple peut √™tre vu si l'on consid√®re le </font><font style="vertical-align: inherit;">d√©bit </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">effectif</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la retraite. Ceux. ne consid√©rant pas </font></font><code>uops_retired.stall_cycles</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/uo/hy/gt/uohygtod0xknhsvolqjnig7tfos.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On peut noter qu'avec 7 micro-op√©rations, toutes les 7 mesures, la retraite de 4 micro-op√©rations est effectu√©e, et chaque 8√®me mesure est inactive sans micro-op√©rations retir√©es (d√©crochage de la retraite). </font><font style="vertical-align: inherit;">Apr√®s avoir men√© une s√©rie d'exp√©riences, il a √©t√© possible de constater qu'un tel comportement √©tait toujours observ√© pendant 7 microop√©rations, quelle que soit leur disposition 1-6, 6-1, 2-5, 5-2, 3-4, 4-3. </font><font style="vertical-align: inherit;">Je ne sais pas pourquoi c'est exactement le cas, et pas, par exemple, la mise hors service de 3 micro-op√©rations est effectu√©e dans un cycle d'horloge, et 4 dans le suivant. </font><font style="vertical-align: inherit;">Agner Fog mentionne que les transitions entre succursales ne peuvent utiliser qu'une partie des cr√©neaux des postes de retraite. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peut</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><i><font style="vertical-align: inherit;">√™tre que</font></i><font style="vertical-align: inherit;"> cette restriction est la raison de ce comportement de retraite.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Afin de comprendre si tout cela a un effet dans la pratique, consid√©rons l'exemple l√©g√®rement plus pratique suivant qu'avec </font></font><code>nop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux tableaux sont donn√©s </font></font><code>unsigned</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Il est n√©cessaire d'accumuler la somme des moyennes arithm√©tiques pour chaque index et de l'√©crire dans le troisi√®me tableau. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un exemple d'impl√©mentation pourrait ressembler √† ceci:</font></font><br>
<br>
<pre><code class="cpp hljs">
<span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> arr1[] = { ... };<font></font>
<font></font>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> arr2[] = { ... };<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">arithmetic_mean</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> *arr1, <span class="hljs-keyword">unsigned</span> *arr2, <span class="hljs-keyword">unsigned</span> *out, <span class="hljs-keyword">size_t</span> sz)</span></span>{
    <span class="hljs-keyword">unsigned</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">size_t</span> idx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span>(idx &lt; sz){<font></font>
        sum += (arr1[idx] + arr2[idx]) &gt;&gt; <span class="hljs-number">1</span>;<font></font>
        out[idx] = sum;<font></font>
        idx++;<font></font>
    }<font></font>
    __asm__ __volatile__(<span class="hljs-string">""</span> ::: <span class="hljs-string">"memory"</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>{
    <span class="hljs-keyword">unsigned</span> out[<span class="hljs-keyword">sizeof</span> arr1 / <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">unsigned</span>)];
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4096</span> * <span class="hljs-number">4096</span>; i++){<font></font>
        arithmetic_mean(arr1, arr2, out, <span class="hljs-keyword">sizeof</span> arr1 / <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">unsigned</span>));<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compiler avec des drapeaux gcc </font></font><br>
<br>
<pre><code class="plaintext hljs">-Werror<font></font>
-Wextra<font></font>
-Wall<font></font>
-pedantic<font></font>
-Wno-stack-protector<font></font>
-g3<font></font>
-O3<font></font>
-Wno-unused-result<font></font>
-Wno-unused-parameter</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est bien √©vident que la fonction </font></font><code>arithmetic_mean</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ne sera pas pr√©sente dans le code et sera ins√©r√©e directement dans </font></font><code>main</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">(gdb) disas main<font></font>
Dump of assembler code for function main:<font></font>
   #...<font></font>
   0x00000000000005dc &lt;+60&gt;:    nop    DWORD PTR [rax+0x0]<font></font>
   0x00000000000005e0 &lt;+64&gt;:    mov    edx,DWORD PTR [rdi+rax*4]<font></font>
   0x00000000000005e3 &lt;+67&gt;:    add    edx,DWORD PTR [r8+rax*4]<font></font>
   0x00000000000005e7 &lt;+71&gt;:    shr    edx,1<font></font>
   0x00000000000005e9 &lt;+73&gt;:    add    ecx,edx<font></font>
   0x00000000000005eb &lt;+75&gt;:    mov    DWORD PTR [rsi+rax*4],ecx<font></font>
   0x00000000000005ee &lt;+78&gt;:    add    rax,0x1<font></font>
   0x00000000000005f2 &lt;+82&gt;:    cmp    rax,0x80<font></font>
   0x00000000000005f8 &lt;+88&gt;:    jne    0x5e0 &lt;main+64&gt;<font></font>
   0x00000000000005fa &lt;+90&gt;:    sub    r9,0x1<font></font>
   0x00000000000005fe &lt;+94&gt;:    jne    0x5d8 &lt;main+56&gt;<font></font>
   #...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que le compilateur a align√© le code de la boucle sur 32 octets ( </font></font><code>nop DWORD PTR [rax+0x0]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), ce qui est exactement ce dont nous avons besoin. </font><font style="vertical-align: inherit;">Apr√®s s'√™tre assur√© qu'il n'y a pas de </font></font><code>resource_stalls.any</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Back End (toutes les mesures sont effectu√©es en tenant compte du cache L1d chauff√©), nous pouvons commencer √† consid√©rer les compteurs associ√©s √† la livraison √† IDQ:</font></font><br>
<br>
<pre><code class="plaintext hljs"> Performance counter stats for './test_decoded_icache':<font></font>
<font></font>
     2‚ÄØ273‚ÄØ343‚ÄØ251      idq.all_dsb_cycles_4_uops                                     (15,94%)<font></font>
     4‚ÄØ458‚ÄØ322‚ÄØ025      idq.all_dsb_cycles_any_uops                                     (16,26%)<font></font>
    15‚ÄØ473‚ÄØ065‚ÄØ238      idq.dsb_uops                                                  (16,59%)<font></font>
     4‚ÄØ358‚ÄØ690‚ÄØ532      idq.dsb_cycles                                                (16,91%)<font></font>
     2‚ÄØ528‚ÄØ373‚ÄØ243      idq_uops_not_delivered.core                                     (16,93%)<font></font>
        73‚ÄØ728‚ÄØ040      idq_uops_not_delivered.cycles_0_uops_deliv.core                                     (16,93%)<font></font>
       107‚ÄØ262‚ÄØ304      idq_uops_not_delivered.cycles_le_1_uop_deliv.core                                     (16,93%)<font></font>
       108‚ÄØ454‚ÄØ043      idq_uops_not_delivered.cycles_le_2_uop_deliv.core                                     (16,65%)<font></font>
     2‚ÄØ248‚ÄØ557‚ÄØ762      idq_uops_not_delivered.cycles_le_3_uop_deliv.core                                     (16,32%)<font></font>
     2‚ÄØ385‚ÄØ493‚ÄØ805      idq_uops_not_delivered.cycles_fe_was_ok                                     (16,00%)<font></font>
    15‚ÄØ147‚ÄØ004‚ÄØ678     uops_retired.retire_slots<font></font>
    4‚ÄØ724‚ÄØ790‚ÄØ623      uops_retired.total_cycles<font></font>
       <font></font>
     1,228684264 seconds time elapsed<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que la mauvaise largeur de retrait dans ce cas = 15147004678/4724790623 = 3.20585733562, et aussi que seulement 3 micro-op√©rations prennent la moiti√© des horloges de Renamer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajoutez maintenant la promotion de boucle manuelle √† l'impl√©mentation:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">arithmetic_mean</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> *arr1, <span class="hljs-keyword">unsigned</span> *arr2, <span class="hljs-keyword">unsigned</span> *out, <span class="hljs-keyword">size_t</span> sz)</span></span>{
    <span class="hljs-keyword">unsigned</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">size_t</span> idx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(sz &amp; <span class="hljs-number">2</span>){<font></font>
        sum += (arr1[idx] + arr2[idx]) &gt;&gt; <span class="hljs-number">1</span>;<font></font>
        out[idx] = sum;<font></font>
        idx++;<font></font>
    }<font></font>
    <span class="hljs-keyword">while</span>(idx &lt; sz){<font></font>
        sum += (arr1[idx] + arr2[idx]) &gt;&gt; <span class="hljs-number">1</span>;<font></font>
        out[idx] = sum;<font></font>
        idx++;<font></font>
        sum += (arr1[idx] + arr2[idx]) &gt;&gt; <span class="hljs-number">1</span>;<font></font>
        out[idx] = sum;<font></font>
        idx++;  <span class="hljs-comment">//   idx++     idx+=2</span><font></font>
    }<font></font>
    __asm__ __volatile__(<span class="hljs-string">""</span> ::: <span class="hljs-string">"memory"</span>);<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les compteurs de perf r√©sultants ressemblent √†:</font></font><br>
<br>
<pre><code class="plaintext hljs">Performance counter stats for './test_decoded_icache':<font></font>
<font></font>
     2‚ÄØ152‚ÄØ818‚ÄØ549      idq.all_dsb_cycles_4_uops                                     (14,79%)<font></font>
     3‚ÄØ207‚ÄØ203‚ÄØ856      idq.all_dsb_cycles_any_uops                                     (15,25%)<font></font>
    12‚ÄØ855‚ÄØ932‚ÄØ240      idq.dsb_uops                                                  (15,70%)<font></font>
     3‚ÄØ184‚ÄØ814‚ÄØ613      idq.dsb_cycles                                                (16,15%)<font></font>
        24‚ÄØ946‚ÄØ367      idq_uops_not_delivered.core                                     (16,24%)<font></font>
         3‚ÄØ011‚ÄØ119      idq_uops_not_delivered.cycles_0_uops_deliv.core                                     (16,24%)<font></font>
         5‚ÄØ239‚ÄØ222      idq_uops_not_delivered.cycles_le_1_uop_deliv.core                                     (16,24%)<font></font>
         7‚ÄØ373‚ÄØ563      idq_uops_not_delivered.cycles_le_2_uop_deliv.core                                     (16,24%)<font></font>
         7‚ÄØ837‚ÄØ764      idq_uops_not_delivered.cycles_le_3_uop_deliv.core                                     (16,24%)<font></font>
     3‚ÄØ418‚ÄØ529‚ÄØ799      idq_uops_not_delivered.cycles_fe_was_ok                                     (16,24%)<font></font>
     3‚ÄØ444‚ÄØ833‚ÄØ440      uops_retired.total_cycles                                     (18,18%)<font></font>
    13‚ÄØ037‚ÄØ919‚ÄØ196      uops_retired.retire_slots                                     (18,17%)<font></font>
<font></font>
    0,871040207 seconds time elapsed</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, nous avons une bande passante de retrait = 13037919196/3444833440 = 3,78477491672, ainsi qu'une utilisation efficace de la bande passante Renamer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, non seulement nous nous sommes d√©barrass√©s d'une op√©ration de branchement et d'un incr√©ment dans un cycle, mais nous avons √©galement augment√© la bande passante de retrait en utilisant efficacement le d√©bit du cache de micro-op√©ration, ce qui a donn√© une augmentation totale de 28% des performances. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notez que seule une r√©duction dans une op√©ration de branchement et d'incr√©mentation donne une augmentation moyenne des performances de 9%.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Petite remarque</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur le CPU qui a √©t√© utilis√© pour effectuer ces exp√©riences, le LSD est d√©sactiv√©. </font><font style="vertical-align: inherit;">Il semble que le LSD pourrait g√©rer une telle situation. </font><font style="vertical-align: inherit;">Pour les processeurs avec LSD activ√©, ces cas devront √™tre examin√©s s√©par√©ment.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr497278/index.html">Battement. Asynchronie et parall√©lisme</a></li>
<li><a href="../fr497280/index.html">Comment j'ai cess√© d'avoir peur et suis tomb√© amoureux du cholest√©rol</a></li>
<li><a href="../fr497282/index.html">Nettoyez le code dans Angular. Cuisson ESLint, codelyzer, stylelint, husky, lint-staged and Prettier</a></li>
<li><a href="../fr497286/index.html">Ludum Dare: check-list une semaine avant le d√©part</a></li>
<li><a href="../fr497288/index.html">Plafonnier d√©coratif Feron AL5000</a></li>
<li><a href="../fr497292/index.html">Jeux de technologie Shiro</a></li>
<li><a href="../fr497296/index.html">Erreurs populaires en anglais parmi les professionnels de l'informatique. Partie 2: Prononciation</a></li>
<li><a href="../fr497302/index.html">Navigation autonome d'un robot mobile</a></li>
<li><a href="../fr497304/index.html">Intercepter-NG 2.5 publi√© pour Android</a></li>
<li><a href="../fr497306/index.html">Usurpation de DLL (d√©tournement de DLL)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>