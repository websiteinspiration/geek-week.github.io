<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåÜ ‚öóÔ∏è ‚ö™Ô∏è Optimizaci√≥n de carga en un proyecto Highload con ElasticSearch ü§öüèº üíê üç°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Mi nombre es Maxim Vasiliev, trabajo como analista y gerente de proyectos en FINCH. Hoy me gustar√≠a contarles c√≥mo, con la ayuda de Elastic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Optimizaci√≥n de carga en un proyecto Highload con ElasticSearch</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503214/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola Habr! </font><font style="vertical-align: inherit;">Mi nombre es Maxim Vasiliev, trabajo como analista y gerente de proyectos en FINCH. </font><font style="vertical-align: inherit;">Hoy me gustar√≠a contarles c√≥mo, con la ayuda de ElasticSearch, pudimos procesar 15 millones de consultas en 6 minutos y optimizar la carga diaria en el sitio de uno de nuestros clientes. </font><font style="vertical-align: inherit;">Desafortunadamente, tendremos que prescindir de los nombres, ya que tenemos el NDA, esperamos que el contenido del art√≠culo no se vea afectado. </font><font style="vertical-align: inherit;">Vamos</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo se organiza el proyecto</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En nuestro backend, creamos servicios que garantizan el rendimiento de los sitios y las aplicaciones m√≥viles de nuestro cliente. </font><font style="vertical-align: inherit;">La estructura general se puede ver en el diagrama: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/sv/yw/mx/svywmxdiqxb59mwxobsses8vrc8.png" alt="imagen"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
en el proceso, procesamos una gran cantidad de transacciones: compras, pagos, operaciones con saldos de usuarios, para los cuales almacenamos muchos registros, y tambi√©n importamos y exportamos estos datos a sistemas externos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tambi√©n hay procesos inversos cuando recibimos datos de un cliente y los transmitimos al usuario. </font><font style="vertical-align: inherit;">Adem√°s, todav√≠a hay procesos para trabajar con pagos y programas de bonificaci√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fondo corto</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, utilizamos PostgreSQL como el √∫nico almac√©n de datos. Sus ventajas est√°ndar para DBMS: disponibilidad de transacciones, lenguaje desarrollado de muestreo de datos, herramientas amplias para la integraci√≥n; Junto con un buen rendimiento, las personas satisfechas han satisfecho nuestras necesidades durante mucho tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Almacenamos absolutamente todos los datos en Postgres: desde transacciones hasta noticias. Pero el n√∫mero de usuarios creci√≥, y con √©l el n√∫mero de solicitudes. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para comprender, el n√∫mero anual de sesiones en 2017 solo en el sitio de escritorio es de 131 millones. En 2018, 125 millones en 2019 son nuevamente 130 millones. Agregue otros 100-200 millones de la versi√≥n m√≥vil del sitio y la aplicaci√≥n m√≥vil, y recibir√° una gran cantidad de solicitudes.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con el crecimiento del proyecto, Postgres dej√≥ de hacer frente a la carga, no tuvimos tiempo, apareci√≥ una gran cantidad de consultas diferentes, bajo las cuales no pudimos crear una cantidad suficiente de √≠ndices. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nos dimos cuenta de que hab√≠a una necesidad de otros almacenes de datos que pudieran satisfacer nuestras necesidades y eliminar la carga de PostgreSQL. </font><font style="vertical-align: inherit;">Elasticsearch y MongoDB se consideraron como posibles opciones. </font><font style="vertical-align: inherit;">Este √∫ltimo perdi√≥ en los siguientes puntos:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Velocidad de indexaci√≥n lenta con aumento del volumen de datos en los √≠ndices. </font><font style="vertical-align: inherit;">La velocidad de Elastic es independiente de la cantidad de datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin b√∫squeda de texto completo</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ que elegimos Elastic para nosotros y nos preparamos para la transici√≥n. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cambiar a el√°stico</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Comenzamos la transici√≥n con un servicio de b√∫squeda en el punto de venta. </font><font style="vertical-align: inherit;">Nuestro cliente tiene un total de aproximadamente 70,000 puntos de venta, y requiere varios tipos de b√∫squedas en el sitio y en la aplicaci√≥n:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B√∫squeda de texto por nombre de ciudad</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geo-b√∫squeda en un radio dado desde alg√∫n punto. </font><font style="vertical-align: inherit;">Por ejemplo, si un usuario quiere ver qu√© puntos de venta est√°n m√°s cerca de su hogar.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Buscar por un cuadrado determinado: el usuario dibuja un cuadrado en el mapa y se le muestran todos los puntos en este radio. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Busca filtros adicionales. </font><font style="vertical-align: inherit;">Los puntos de venta difieren entre s√≠ en el surtido</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hablando de organizaci√≥n, en Postgres tenemos una fuente de datos tanto en el mapa como en las noticias, y en Elastic Snapshots se hacen a partir de los datos originales. El hecho es que inicialmente Postgres no pudo hacer frente a la b√∫squeda por todos los criterios. No solo hab√≠a muchos √≠ndices, sino que tambi√©n pod√≠an cruzarse, por lo que el programador de Postgres se perdi√≥ y no entendi√≥ qu√© √≠ndice usar para √©l. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. El siguiente en la fila fue la secci√≥n de noticias. Todos los d√≠as, las publicaciones aparecen en el sitio para que el usuario no se pierda en el flujo de informaci√≥n, los datos deben ordenarse antes de emitirse. Para esto, necesita una b√∫squeda: en el sitio puede buscar por coincidencia de texto y, al mismo tiempo, conectar filtros adicionales, ya que tambi√©n se realizan a trav√©s de Elastic.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Luego trasladamos el procesamiento de la transacci√≥n. </font><font style="vertical-align: inherit;">Los usuarios pueden comprar un producto espec√≠fico en el sitio y participar en el sorteo. </font><font style="vertical-align: inherit;">Despu√©s de tales compras, procesamos una gran cantidad de datos, especialmente los fines de semana y feriados. </font><font style="vertical-align: inherit;">A modo de comparaci√≥n, si en d√≠as normales el n√∫mero de compras oscila entre 1,5 y 2 millones, en vacaciones la cifra puede alcanzar los 53 millones. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al mismo tiempo, los datos deben procesarse en un tiempo m√≠nimo; a los usuarios no les gusta esperar un resultado durante varios d√≠as. </font><font style="vertical-align: inherit;">No lograr√° dichos plazos a trav√©s de Postgres: a menudo recibimos bloqueos y, aunque procesamos todas las solicitudes, los usuarios no pudieron verificar si recibieron premios o no. </font><font style="vertical-align: inherit;">Esto no es muy agradable para el negocio, por lo que trasladamos el procesamiento a Elasticsearch.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Periodicidad</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora las actualizaciones se configuran en funci√≥n de los eventos, en las siguientes condiciones:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Punto de venta. </font><font style="vertical-align: inherit;">Tan pronto como nos llegan datos de una fuente externa, comenzamos inmediatamente la actualizaci√≥n.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noticias. </font><font style="vertical-align: inherit;">Tan pronto como se edita cualquier noticia en el sitio, se env√≠a autom√°ticamente a Elastic.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ nuevamente, vale la pena mencionar las ventajas de Elastic. </font><font style="vertical-align: inherit;">En Postgres, al enviar una solicitud, debe esperar hasta que honestamente procese todos los registros. </font><font style="vertical-align: inherit;">Puede enviar 10 mil registros a Elastic e inmediatamente comenzar a trabajar, sin esperar hasta que los registros se distribuyan en todos los fragmentos. </font><font style="vertical-align: inherit;">Por supuesto, algunos fragmentos o r√©plicas pueden no ver los datos de inmediato, pero muy pronto todo estar√° disponible.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Metodos de Integracion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay 2 formas de integrarse con Elastic:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A trav√©s del cliente nativo sobre TCP. </font><font style="vertical-align: inherit;">El controlador nativo est√° desapareciendo gradualmente: ya no es compatible, tiene una sintaxis muy inconveniente. </font><font style="vertical-align: inherit;">Por lo tanto, pr√°cticamente no lo usamos e intentamos abandonarlo por completo.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A trav√©s de una interfaz HTTP en la que puede utilizar tanto las solicitudes JSON como la sintaxis de Lucene. </font><font style="vertical-align: inherit;">Este √∫ltimo es un motor de texto que usa Elastic. </font><font style="vertical-align: inherit;">En esta opci√≥n, tenemos la capacidad de Batch a trav√©s de solicitudes JSON a trav√©s de HTTP. </font><font style="vertical-align: inherit;">Esta es la opci√≥n que estamos tratando de usar.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias a la interfaz HTTP, podemos usar bibliotecas que proporcionan una implementaci√≥n asincr√≥nica del cliente HTTP. </font><font style="vertical-align: inherit;">Podemos aprovechar Batch y la API asincr√≥nica, que al final ofrece un alto rendimiento, lo que ayud√≥ mucho en los d√≠as de una gran acci√≥n (m√°s sobre eso a continuaci√≥n). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algunos n√∫meros para comparar:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahorro de usuarios que recibieron premios en Postgres en 20 transmisiones sin agrupaciones: 460,713 entradas en 42 segundos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente el√°stico + reactivo para 10 subprocesos + lote para 1000 elementos: 596749 registros en 11 segundos</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cliente el√°stico + reactivo para 10 subprocesos + lote para 1000 elementos: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">23801684 registros en 4 minutos</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora hemos escrito un administrador de solicitudes HTTP que crea JSON como Batch / not Batch y lo env√≠a a trav√©s de cualquier cliente HTTP, independientemente de la biblioteca. </font><font style="vertical-align: inherit;">Tambi√©n puede optar por enviar solicitudes de forma sincr√≥nica o asincr√≥nica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En algunas integraciones, todav√≠a utilizamos el cliente de transporte oficial, pero esto es solo una cuesti√≥n de refactorizaci√≥n. </font><font style="vertical-align: inherit;">Al mismo tiempo, se utiliza un cliente personalizado creado sobre la base de Spring WebClient para el procesamiento.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x2/sx/qg/x2sxqgijaic0-ldqbrjlwse_tp0.jpeg" alt="imagen"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gran promoci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Una vez al a√±o, se lleva a cabo una gran campa√±a para los usuarios en el proyecto: este es el mismo Highload, ya que en este momento trabajamos con decenas de millones de usuarios al mismo tiempo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo general, las cargas m√°ximas ocurren durante las vacaciones, pero esta promoci√≥n es un nivel completamente diferente. El a√±o anterior, el d√≠a de la promoci√≥n, vendimos 27,580,890 unidades de bienes. Los datos se procesaron durante m√°s de media hora, lo que caus√≥ molestias a los usuarios. Los usuarios recibieron premios por participar, pero qued√≥ claro que el proceso deb√≠a acelerarse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A principios de 2019, decidimos que necesit√°bamos ElasticSearch. Durante todo un a√±o, organizamos el procesamiento de los datos recibidos en Elastic y su salida en la API de la aplicaci√≥n m√≥vil y el sitio. Como resultado, al a√±o siguiente durante la campa√±a procesamos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15 131 783 registros en 6 minutos.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dado que tenemos muchas personas que desean comprar productos y participar en el sorteo de premios en promociones, esta es una medida temporal. </font><font style="vertical-align: inherit;">Ahora estamos enviando informaci√≥n relevante a Elastic, pero en el futuro planeamos transferir informaci√≥n de archivo de los √∫ltimos meses a Postgres como un dep√≥sito permanente. </font><font style="vertical-align: inherit;">Para no obstruir el √≠ndice Elastic, que tambi√©n tiene sus limitaciones.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n / Conclusiones</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por el momento, hemos transferido a Elastic todos los servicios que quer√≠amos y hemos detenido por ahora. </font><font style="vertical-align: inherit;">Ahora estamos creando un √≠ndice en Elastic sobre el almacenamiento principal persistente en Postgres, que asume la carga del usuario. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el futuro, planeamos transferir servicios si entendemos que la solicitud de datos se vuelve demasiado diversa y es buscada por un n√∫mero ilimitado de columnas. </font><font style="vertical-align: inherit;">Esto ya no es una tarea para Postgres. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si necesitamos una b√∫squeda de texto completo en el funcional, o si tenemos muchos criterios de b√∫squeda diferentes, entonces ya sabemos que esto debe traducirse a Elastic.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚åò‚åò‚åò</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias por leer. </font><font style="vertical-align: inherit;">Si su empresa tambi√©n utiliza ElasticSearch y tiene sus propios casos de implementaci√≥n, inf√≥rmenos. </font><font style="vertical-align: inherit;">Ser√° interesante saber c√≥mo otros lo han hecho :-)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es503200/index.html">YOLOv4: la red neuronal en tiempo real m√°s precisa en el conjunto de datos COCO de Microsoft</a></li>
<li><a href="../es503204/index.html">C√≥mo flashear Xiaomi Redmi 4 Prime / Pro / Premium en Android 10</a></li>
<li><a href="../es503208/index.html">¬øCu√°ndo es el mejor momento para invertir?</a></li>
<li><a href="../es503210/index.html">¬øSe pueden erradicar los sitios de phishing?</a></li>
<li><a href="../es503212/index.html">30 trucos para completar el curso en l√≠nea</a></li>
<li><a href="../es503218/index.html">GlobalSign presenta Atlas - Plataforma PKI de pr√≥xima generaci√≥n</a></li>
<li><a href="../es503226/index.html">¬øQu√© est√° impidiendo que el negocio pase a un "n√∫mero" y qu√© tiene que ver con la reputaci√≥n?</a></li>
<li><a href="../es503228/index.html">Control de la frecuencia card√≠aca mientras corres a trav√©s de la retroalimentaci√≥n musical, o "los probadores a quienes les gusta correr est√°n buscando"</a></li>
<li><a href="../es503230/index.html">Sistemas de clase de plataforma de respuesta a incidentes: aplicaci√≥n y funciones principales</a></li>
<li><a href="../es503232/index.html">C√≥mo convertirse en ingeniero de DevOps en seis meses o incluso m√°s r√°pido. Parte 6. Iniciando la aplicaci√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>