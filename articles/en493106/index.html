<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôÅ üë©üèæ‚Äçüè≠ üë©üèº‚Äçü§ù‚Äçüë©üèª How much is new in the Devil's Dozen? üçè üìî üëºüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are talking only about PostgreSQL 13. On April 8, a ‚Äúfreeze‚Äù took place - PostgreSQL feature freeze , now only those features that are accepted bef...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>How much is new in the Devil's Dozen?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/493106/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We are talking only about PostgreSQL 13. On April 8, a ‚Äúfreeze‚Äù took place - PostgreSQL </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">feature freeze</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , now only those features that are accepted before this date will be included in this version. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs hard to name a revolutionary version of this. </font><font style="vertical-align: inherit;">There are no cardinal, conceptual changes in it. </font><font style="vertical-align: inherit;">In addition, such important patches as Table and Functions for the JSON / SQL standard, which I wanted to see in PG12 next to the JSONPath patch, did not have time to enter it; </font><font style="vertical-align: inherit;">ready-made embedded storage did not appear - only the interface is being finalized. </font><font style="vertical-align: inherit;">But the list of improvements is still impressive. </font><font style="vertical-align: inherit;">We have prepared a fairly complete summary of the patches included in the Devil's Dozen.</font></font></i><br>
<br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Changes to SQL Commands</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CREATE DATABASE ... LOCALE</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Utilities</font></font><code>initdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font><code>createdb</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the team</font></font><code>CREATE COLLATION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">have a setting</font></font><code>LOCALE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that allows you to specify values for the right</font></font><code>LC_CTYPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>LC_COLLATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Now the same opportunity appeared in the team</font></font><code>CREATE DATABASE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> db_koi8r <span class="hljs-keyword">TEMPLATE</span> template0 
    <span class="hljs-keyword">ENCODING</span> <span class="hljs-string">'KOI8R'</span> LOCALE <span class="hljs-string">'ru_RU.KOI8R'</span>;</code></pre><a name="habracut"></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER VIEW ... RENAME COLUMN</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The column name in the view can now be changed with the command</font></font><code>ALTER VIEW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Previously, this required re-creating the view. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose you forgot to give the column a name:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> uptime <span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">current_timestamp</span>, <span class="hljs-built_in">current_timestamp</span> - pg_postmaster_start_time();
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> uptime;</code></pre><br>
<pre><code class="plaintext hljs">       current_timestamp       |    ?column?     <font></font>
-------------------------------+-----------------<font></font>
 2020-03-23 15:37:00.088824+03 | 04:18:24.897856</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It can be fixed:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">VIEW</span> uptime <span class="hljs-keyword">RENAME</span> <span class="hljs-keyword">COLUMN</span> "?column?" <span class="hljs-keyword">TO</span> uptime;
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> uptime;</code></pre><br>
<pre><code class="plaintext hljs">       current_timestamp       |     uptime      <font></font>
-------------------------------+-----------------<font></font>
 2020-03-23 15:37:40.726516+03 | 04:19:05.535548</code></pre><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER TABLE ... ALTER COLUMN ... DROP EXPRESSION</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The generated column of the table can now be made normal, that is, delete the expression to evaluate it:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> payments (<font></font>
    id <span class="hljs-type">integer</span> <span class="hljs-keyword">PRIMARY KEY</span>,<font></font>
    amount <span class="hljs-type">numeric</span>(<span class="hljs-number">18</span>,<span class="hljs-number">2</span>),<font></font>
    income_tax <span class="hljs-type">numeric</span>(<span class="hljs-number">18</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">GENERATED</span> <span class="hljs-keyword">ALWAYS</span> <span class="hljs-keyword">AS</span> (amount*<span class="hljs-number">0.13</span>) STORED<font></font>
);<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> payments(id, amount) <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-number">42</span>);<font></font>
\d payments</code></pre><br>
<pre><code class="plaintext hljs">                                     Table "public.payments"<font></font>
   Column   |     Type      | Collation | Nullable |                   Default            <font></font>
        <font></font>
------------+---------------+-----------+----------+--------------------------------------<font></font>
 id         | integer       |           | not null |<font></font>
 amount     | numeric(18,2) |           |          |<font></font>
 income_tax | numeric(18,2) |           |          | generated always as ((amount * 0.13))<font></font>
 stored<font></font>
Indexes:<font></font>
    "payments_pkey" PRIMARY KEY, btree (id)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Subsequently, they decided that income_tax should be explicitly set. </font><font style="vertical-align: inherit;">Delete the expression:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> payments <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> income_tax <span class="hljs-keyword">DROP</span> EXPRESSION;<font></font>
\d payments</code></pre><br>
<pre><code class="plaintext hljs">                   Table "public.payments"<font></font>
   Column   |     Type      | Collation | Nullable | Default<font></font>
------------+---------------+-----------+----------+---------<font></font>
 id         | integer       |           | not null |<font></font>
 amount     | numeric(18,2) |           |          |<font></font>
 income_tax | numeric(18,2) |           |          |<font></font>
Indexes:<font></font>
    "payments_pkey" PRIMARY KEY, btree (id)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, the existing data from the column has not gone away:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> payments;</code></pre><br>
<pre><code class="plaintext hljs"> id | amount | income_tax<font></font>
----+--------+------------<font></font>
  1 |  42.00 |       5.46</code></pre><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DROP DATABASE ... FORCE</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If you want to delete a database without waiting for all users to disconnect, you can use the new</font></font><code>FORCE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command</font><font style="vertical-align: inherit;">option</font></font><code>DROP DATABASE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> db;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Connect to the new database:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> <span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> dblink;
<span class="hljs-keyword">SELECT</span> dblink_connect(<span class="hljs-string">'dbname=db'</span>);</code></pre><br>
<pre><code class="plaintext hljs"> dblink_connect<font></font>
----------------<font></font>
 OK</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And now we will delete, forcibly interrupting, as well </font></font><code>pg_terminate_backend</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, open connections:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">DATABASE</span> db <span class="hljs-keyword">WITH</span> (FORCE);</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER TYPE ... SET STORAGE</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The command</font></font><code>ALTER TYPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows for basic data types to change various properties, in particular, the storage strategy. </font><font style="vertical-align: inherit;">Previously, you could only set it in a team</font></font><code>CREATE TYPE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For demonstration, we will not create a new base type, but use the existing -</font></font><code>tsquery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But first, create a separate database and connect to it:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> db;<font></font>
\c db</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A storage strategy is used for the tsquery data type </font></font><code>plain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so columns of tables of this type get the same strategy:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> typname,typstorage <span class="hljs-keyword">FROM</span> pg_type <span class="hljs-keyword">WHERE</span> typname = <span class="hljs-string">'tsquery'</span>;</code></pre><br>
<pre><code class="plaintext hljs"> typname | typstorage<font></font>
---------+------------<font></font>
 tsquery | p</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> queries (query <span class="hljs-type">tsquery</span>);
<span class="hljs-keyword">SELECT</span> attname, attstorage <span class="hljs-keyword">FROM</span> pg_attribute <span class="hljs-keyword">WHERE</span> attrelid = <span class="hljs-string">'queries'</span>::<span class="hljs-type">regclass</span> <span class="hljs-keyword">AND</span> attname = <span class="hljs-string">'query'</span>;</code></pre><br>
<pre><code class="plaintext hljs"> attname | attstorage<font></font>
---------+------------<font></font>
 query   | p</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you need to use a different strategy for new tables, you can change the base type:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TYPE</span> <span class="hljs-type">tsquery</span> <span class="hljs-keyword">SET</span> (storage=<span class="hljs-keyword">external</span>);
<span class="hljs-keyword">SELECT</span> typname,typstorage <span class="hljs-keyword">FROM</span> pg_type <span class="hljs-keyword">WHERE</span> typname = <span class="hljs-string">'tsquery'</span>;</code></pre><br>
<pre><code class="plaintext hljs"> typname | typstorage<font></font>
---------+------------<font></font>
 tsquery | e</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The type of storage in the new tables will also change:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> new_queries (query <span class="hljs-type">tsquery</span>);
<span class="hljs-keyword">SELECT</span> attname, attstorage <span class="hljs-keyword">FROM</span> pg_attribute <span class="hljs-keyword">WHERE</span> attrelid = <span class="hljs-string">'new_queries'</span>::<span class="hljs-type">regclass</span> <span class="hljs-keyword">AND</span> attname = <span class="hljs-string">'query'</span>;</code></pre><br>
<pre><code class="plaintext hljs"> attname | attstorage<font></font>
---------+------------<font></font>
 query   | e</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It should be borne in mind that changing a strategy involving the use of TOAST </font></font><code>plain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cannot be </font><font style="vertical-align: inherit;">changed back to </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TYPE</span> <span class="hljs-type">tsquery</span> <span class="hljs-keyword">SET</span> (storage=plain);</code></pre><br>
<pre><code class="plaintext hljs">ERROR:  cannot change type's storage to PLAIN</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, the experiments were carried out in a separate database, which is not a pity to delete. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ALTER STATISTICS ... SET STATISTICS The</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
command </font></font><code>CREATE STATISTICS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to collect lists of the most common values ‚Äã‚Äãfor selected combinations of table columns. </font><font style="vertical-align: inherit;">The number of most common values ‚Äã‚Äãcollected is determined by the parameter </font></font><code>default_statistics_target</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The value for specific statistics can now be changed with the command:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">STATISTICS</span>  <span class="hljs-keyword">SET</span> <span class="hljs-keyword">STATISTICS</span> _;</code></pre><br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FETCH FIRST with WITH TIES option</font></font></a></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
As you know,</font></font><code>SELECT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instead of specifying a</font><font style="vertical-align: inherit;">command</font><font style="vertical-align: inherit;">,</font></font><code>LIMIT</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can use the syntax defined in the SQL standard:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-string">'1.1'</span>), (<span class="hljs-number">2</span>,<span class="hljs-string">'2.1'</span>), (<span class="hljs-number">2</span>,<span class="hljs-string">'2.2'</span>), (<span class="hljs-number">3</span>,<span class="hljs-string">'3.1'</span>)) t(a,b)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> a
<span class="hljs-keyword">FETCH FIRST</span> <span class="hljs-number">2</span> <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">ONLY</span>;</code></pre><br>
<pre><code class="plaintext hljs"> a |  b  <font></font>
---+-----<font></font>
 1 | 1.1<font></font>
 2 | 2.1<font></font>
(2 rows)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now it </font></font><code>FETCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">supports the phrase </font></font><code>WITH TIES</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which adds to the output all ‚Äúrelated‚Äù lines (lines equal to the ones already selected, if only the sorting condition is taken into account):</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> *
<span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-string">'1.1'</span>), (<span class="hljs-number">2</span>,<span class="hljs-string">'2.1'</span>), (<span class="hljs-number">2</span>,<span class="hljs-string">'2.2'</span>), (<span class="hljs-number">3</span>,<span class="hljs-string">'3.1'</span>)) t(a,b)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> a
<span class="hljs-keyword">FETCH FIRST</span> <span class="hljs-number">2</span> <span class="hljs-keyword">ROWS</span> <span class="hljs-keyword">WITH</span> TIES;</code></pre><br>
<pre><code class="plaintext hljs"> a |  b  <font></font>
---+-----<font></font>
 1 | 1.1<font></font>
 2 | 2.1<font></font>
 2 | 2.2<font></font>
(3 rows)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Built-in Functions and Data Types</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_random_uuid The</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
new function</font></font><code>get_random_uuid</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns the version 4 UUID value (random value):</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> gen_random_uuid();</code></pre><br>
<pre><code class="plaintext hljs">           gen_random_uuid            <font></font>
--------------------------------------<font></font>
 25e02793-80c0-438c-be07-c94b966c43ab</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The function is useful for generating unique UUID values ‚Äã‚Äãin distributed systems. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Previously, you had to use the uuid-ossp or pgcrypto libraries. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">min_scale and trim_scale for values ‚Äã‚Äãof type numeric</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The function </font></font><code>min_scale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">determines the number of significant digits in the fractional part of the number, and the function </font></font><code>trim_scale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discards </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;">non-</font></b></a><font style="vertical-align: inherit;"> significant </font><font style="vertical-align: inherit;">zeros:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> n, min_scale(n), trim_scale(n) <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">VALUES</span>(<span class="hljs-number">42.42000</span>)) <span class="hljs-keyword">as</span> t(n);</code></pre><br>
<pre><code class="plaintext hljs">    n     | min_scale | trim_scale<font></font>
----------+-----------+------------<font></font>
 42.42000 |         2 |      42.42</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gcd and lcm</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Replenishment in the section of mathematical functions. </font><font style="vertical-align: inherit;">Now you can quickly find the largest common divisor (</font></font><code>gcm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and the smallest common multiple (</font></font><code>lcm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">):</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> gcd(<span class="hljs-number">54</span>,<span class="hljs-number">24</span>), lcm(<span class="hljs-number">54</span>,<span class="hljs-number">24</span>);</code></pre><br>
<pre><code class="plaintext hljs"> gcd | lcm<font></font>
-----+-----<font></font>
   6 | 216</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aggregate functions min and max for type pg_lsn</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aggregate functions have been added for the</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
data type</font><font style="vertical-align: inherit;">and</font><font style="vertical-align: inherit;">that allows you to perform queries of the form:</font></font><code>pg_lsn</code><font style="vertical-align: inherit;"></font><code>min</code><font style="vertical-align: inherit;"></font><code>max</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> min(restart_lsn) <span class="hljs-keyword">FROM</span> pg_replication_slots;
<span class="hljs-keyword">SELECT</span> min(sent_lsn) <span class="hljs-keyword">FROM</span> pg_stat_replication;</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Checking the type modifier of the return value of a function</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In previous versions, the type modifier was not checked for the return value of the function. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose there is a type for storing monetary units and a function that returns the amount of income tax:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TYPE</span> currency <span class="hljs-keyword">AS</span> (<font></font>
    amount <span class="hljs-type">numeric</span>(<span class="hljs-number">18</span>,<span class="hljs-number">2</span>),<font></font>
    code   <span class="hljs-type">text</span><font></font>
);<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> income_tax(quantity currency) <span class="hljs-keyword">RETURNS</span> currency
    <span class="hljs-keyword">AS</span> <span class="hljs-string">'SELECT quantity.amount * 0.13, quantity.code'</span> <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">SQL</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Calling the function, we expect to get two decimal places, however, we get four. </font><font style="vertical-align: inherit;">Even explicit casting after a function call does not help (third column):</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> amount, code, amount::<span class="hljs-type">numeric</span>(<span class="hljs-number">18</span>,<span class="hljs-number">2</span>)
<span class="hljs-keyword">FROM</span> income_tax(<span class="hljs-keyword">ROW</span>(<span class="hljs-number">42.42</span>, <span class="hljs-string">''</span>))\gx</code></pre><br>
<pre><code class="plaintext hljs">-[ RECORD 1 ]--<font></font>
amount | 5.5146<font></font>
code   | <font></font>
amount | 5.5146</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In version 13, the result is correct:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> amount, code, amount::<span class="hljs-type">numeric</span>(<span class="hljs-number">18</span>,<span class="hljs-number">2</span>)
<span class="hljs-keyword">FROM</span> income_tax(<span class="hljs-keyword">ROW</span>(<span class="hljs-number">42.42</span>, <span class="hljs-string">''</span>))\gx</code></pre><br>
<pre><code class="plaintext hljs">-[ RECORD 1 ]<font></font>
amount | 5.51<font></font>
code   | <font></font>
amount | 5.51</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The localized names in to_date () and to_timestamp ()</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Functions</font></font><code>to_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">also</font></font><code>to_timestamp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">learned to understand the localized names of the months and days of the week. </font><font style="vertical-align: inherit;">Previously, only English names could be used:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> to_date(<span class="hljs-string">', 24  2020'</span>, <span class="hljs-string">'TMDay, DD TMMonth YYYY'</span>);</code></pre><br>
<pre><code class="plaintext hljs">  to_date   <font></font>
------------<font></font>
 2020-03-24</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">normalize and IS NORMALIZED</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
To comply with the SQL standard, the normalize () function has been added to normalize a Unicode string, and the IS NORMALIZED predicate to check if a string is normalized.</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> str, normalize(str, NFC) <span class="hljs-keyword">AS</span> nfc,<font></font>
       str <span class="hljs-keyword">IS</span> NFC NORMALIZED <span class="hljs-keyword">AS</span> is_nfc_normalized,<font></font>
       normalize(str, NFKC) <span class="hljs-keyword">AS</span> nfkc,<font></font>
       str <span class="hljs-keyword">IS</span> NFKC NORMALIZED <span class="hljs-keyword">AS</span> is_nfkc_normalized
<span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">VALUES</span>(<span class="hljs-string">U&amp;'\0032\2075'</span>)) <span class="hljs-keyword">AS</span> vals(str)\gx</code></pre><br>
<pre><code class="plaintext hljs">-[ RECORD 1 ]------+---<font></font>
str                | 2‚Åµ<font></font>
nfc                | 2‚Åµ<font></font>
is_nfc_normalized  | t<font></font>
nfkc               | 25<font></font>
is_nfkc_normalized | f</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read more</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about UNICODE normalization forms. </font></font><br>
<br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xid8 type and xid8_current () function for 64-bit transaction numbers</font></font></a></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Added a new xid8 data type for 64-bit transaction number. But no, this does not mean that PostgreSQL switched to 64-bit transactions: everything works exactly as before. But some functions return a new type, for example, is now recommended for use instead of the old functions pg_current_xact_id txid_current, which returned int8, and so on. N. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">New polymorphic data types anycompatible family</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
added types </font></font><code>anycompatible</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>anycompatiblearray</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>anycompatiblenonarray</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>anycompatiblerange</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Unlike family types </font></font><code>anyelement</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, new types allow you to use not exactly the same, but actually compatible types. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the following example, the function</font></font><code>maximum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as arguments defined as </font></font><code>anycompatible</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are passed </font></font><code>integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>numeric</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The return value is converted to a common value for these two types:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> maximum(a anycompatible, b anycompatible) <span class="hljs-keyword">RETURNS</span> anycompatible
	<span class="hljs-keyword">AS</span> <span class="hljs-string">'SELECT CASE WHEN a &gt; b THEN a ELSE b END'</span> <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">SQL</span>;<font></font>
<font></font>
<span class="hljs-keyword">SELECT</span> f, pg_typeof(f) <span class="hljs-keyword">FROM</span> maximum(<span class="hljs-number">42</span>, <span class="hljs-number">42.42</span>) f;</code></pre><br>
<pre><code class="plaintext hljs">   f   | pg_typeof<font></font>
-------+-----------<font></font>
 42.42 | numeric</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Moreover, the types anycompatible- and any- are two independent sets of types:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> first_elems(a <span class="hljs-type">anyarray</span>, b anycompatiblearray)
    <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span>(a <span class="hljs-type">anyelement</span>, b anycompatible) <span class="hljs-keyword">AS</span> $$<span class="pgsql">
        <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ROW</span>(a[array_lower(a,<span class="hljs-number">1</span>)], b[array_lower(b,<span class="hljs-number">1</span>)]);
    $$</span> <span class="hljs-keyword">LANGUAGE</span> <span class="hljs-keyword">sql</span>;
<span class="hljs-keyword">SELECT</span> first_elems(<span class="hljs-keyword">ARRAY</span>[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>], <span class="hljs-keyword">ARRAY</span>[<span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>]) <span class="hljs-keyword">AS</span> str, <font></font>
       first_elems(<span class="hljs-keyword">ARRAY</span>[<span class="hljs-number">1.1</span>,<span class="hljs-number">2.2</span>,<span class="hljs-number">3.3</span>],<span class="hljs-keyword">ARRAY</span>[<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>]) <span class="hljs-type">bool</span>;</code></pre><br>
<pre><code class="plaintext hljs">  str  |  bool   <font></font>
-------+---------<font></font>
 (1,a) | (1.1,t)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procedural Languages</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transform for type bool in PL / Perl</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Most recently, TRANSFORM of Ivan Panchenko (Postgres Professional) -</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bool_plperl was committed</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Postgres passes boolean values ‚Äã‚Äãto</font></font><code>t</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or</font><font style="vertical-align: inherit;">in PL / Perl like</font></font><code>f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but for Perl it</font></font><code>f</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äôs not a boolean</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , but just the letter f, i.e. </font><font style="vertical-align: inherit;">in a logical context,</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> truth</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This problem can be solved in different ways (see</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> correspondence</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), but creating TRANSFORM for bool, according to Tom Lane, is the most practical. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fast execution of simple expressions in PL / pgSQL</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simple expressions (at least not containing table calls and not requiring locks) will be faster. </font><font style="vertical-align: inherit;">Previously, in these cases, time was unproductively spent on contacting the scheduler on each cycle.</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> slow_pi() <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">double</span> <span class="hljs-type">precision</span> <span class="hljs-keyword">AS</span> $$<span class="pgsql">
    <span class="hljs-keyword">DECLARE</span>
        a <span class="hljs-type">double</span> <span class="hljs-type">precision</span> := <span class="hljs-number">1</span>;
        s <span class="hljs-type">double</span> <span class="hljs-type">precision</span> := <span class="hljs-number">1</span>;
        r <span class="hljs-type">double</span> <span class="hljs-type">precision</span> := <span class="hljs-number">0</span>;
    <span class="hljs-keyword">BEGIN</span>
        <span class="hljs-keyword">FOR</span> i <span class="hljs-keyword">IN</span> <span class="hljs-number">1</span> .. <span class="hljs-number">10000000</span> <span class="hljs-keyword">LOOP</span>
            r := r + s/a; a := a + <span class="hljs-number">2</span>; s := -s;
        <span class="hljs-keyword">END</span> <span class="hljs-keyword">LOOP</span>;
        <span class="hljs-keyword">RETURN</span> <span class="hljs-number">4</span>*r;
    <span class="hljs-keyword">END</span>;
    $$</span> <span class="hljs-keyword">LANGUAGE</span> plpgsql;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Call slow_pi () in PG12:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> slow_pi();</code></pre><br>
<pre><code class="plaintext hljs">          slow_pi      <font></font>
    --------------------<font></font>
     3.1415925535898497<font></font>
    (1 row)<font></font>
    Time: 13060,650 ms (00:13,061)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now in PG13:</font></font><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> slow_pi();</code></pre><br>
<pre><code class="plaintext hljs">          slow_pi      <font></font>
    --------------------<font></font>
     3.1415925535897915<font></font>
    (1 row)<font></font>
    Time: 2108,464 ms (00:02,108)</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trusted extensions instead of pg_pltemplate</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The system directory has decreased by one table. </font><font style="vertical-align: inherit;">Deleted</font></font><code>pg_pltemplate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It stored the properties of procedural languages ‚Äã‚Äãthat are needed during execution</font></font><code>CREATE LANGUAGE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Now we decided to register the properties from in the scripts of extensions of the corresponding languages</font></font><code>pg_pltemplate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and get rid of the table itself. </font><font style="vertical-align: inherit;">But in order to realize what is planned, it is necessary to provide for the possibility for the database owner (without superuser rights) to create a trusted language from the extension script. </font><font style="vertical-align: inherit;">Indeed, now to create, for example, plpgsql, the database owner does not have to be superuser. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Received as follows. </font><font style="vertical-align: inherit;">A new logical parameter has appeared in the control file for extensions</font></font><code>trusted</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If both parameters</font></font><code>trusted</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>superuser</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">included, then the extension can be created not only by the superuser, but also by the user with the right </font></font><code>CREATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the current database (and therefore its owner). </font><font style="vertical-align: inherit;">When executing a script of such an extension, the superuser rights that initialized the cluster will be used. </font><font style="vertical-align: inherit;">The objects created by the extension will belong to it, although the owner of the extension itself will be the creating user. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Important consequences of these changes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trusted extensions open the way for third-party developers to create other trusted languages. </font><font style="vertical-align: inherit;">Now we are limited only to plpgsql, plperl and pltcl.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It </font></font><code>pg_pltemplate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">was hard written that plpython refers to the second version of the language. </font><font style="vertical-align: inherit;">Failure to </font></font><code>pg_pltemplate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do so is a step (necessary, though not sufficient) to the transition to python 3.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indices</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compression of B-tree</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
An important and long-awaited (the work began already in 2015) patch written by Anastasia Lubennikova (Postgres Professional) and Peter Geigan (Peter Geoghegan) is finally communicated by Peter. Nastya managed to</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> talk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about this</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"> at PGconf India</font></a><font style="vertical-align: inherit;"> . Postgres has learned to significantly reduce the size of B-tree indexes through deduplication, that is, savings on duplicate index keys. These indexes have been seriously redesigned so that compression is possible without loss in compatibility with previous versions of indexes. The idea of ‚Äã‚Äãdeduplication is taken from a more flexible architecture of indexes like</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GIN</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (reverse indexes - Generalized Inverted Index).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In these indices more often than in</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> B-tree</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, there is a situation when a key corresponds to a large number of records. In the case of word processing, for example, the same token is usually found in several documents. And it is stored in the index only once. Until recently, B-tree indexes did not know how to do this. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
B-tree indexes differ from GIN indexes primarily in leaf pages. Depending on the number of records related to the same key value, options are possible: the page contains only a posting list - a list of TIDs (identifiers of indexed records), if the list is small, and if there are a lot of TIDs, then instead of a list of values ‚Äã‚Äãare stored new ‚Äútree branches‚Äù - links to other pages like the posting list or other tree branches (they are called posting tree).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such a tree structure is similar to a B-tree, but differs in essential details: for example, lists for moving through pages of the same tree level in the GIN are unidirectional, not bidirectional. Therefore (including) good compatibility of new, deduplicated indexes with old versions is not easy to achieve. And the improvements really took more than 3 years. It was also necessary to work out the cleaning mechanism (microvacuum) and other nuances. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In performance tests, all indexes to which deduplication is applicable have shrunk by about 3 times. Compressing duplicates also helps unique indexes, eliminating the problem of index swelling at a high rate of table changes. New behavior can be connected and disconnected at the index settings level. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full scan by GIN index is not done where it is not necessary</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This patch allows in some cases to avoid a full pass through the entire GIN index. </font><font style="vertical-align: inherit;">Some operations, although supported by the GIN index, are performed by a full scan of the index. </font><font style="vertical-align: inherit;">Take, for example, the index for full-text column search </font></font><code>tsvector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If the search query has the form ‚Äúanything but a given word‚Äù, then the entire index will have to be read in its entirety. </font><font style="vertical-align: inherit;">If, however, another condition is present in the request that does not require a full scan of the index, then the index will still be scanned completely. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the new optimization, a more accurate condition will be used first, allowing you to get a gain from the index, and then the results will be double-checked to take into account another limitation. </font><font style="vertical-align: inherit;">Compare the number of pages that were read in version 12 (Buffers):</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>, <span class="hljs-keyword">BUFFERS</span>, <span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>, <span class="hljs-keyword">TIMING</span> <span class="hljs-keyword">OFF</span>)
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> mail_messages <span class="hljs-keyword">WHERE</span> tsv @@ to_tsquery(<span class="hljs-string">'!vacuum'</span>) <span class="hljs-keyword">AND</span> tsv @@ to_tsquery(<span class="hljs-string">'analyze'</span>);</code></pre><br>
<pre><code class="plaintext hljs">                                             QUERY PLAN                                             <font></font>
------------------------------------------------------------------<font></font>
Bitmap Heap Scan on mail_messages (actual rows=5864 loops=1)<font></font>
   Recheck Cond: ((tsv @@ to_tsquery('!vacuum'::text)) AND (tsv @@ to_tsquery('analyze'::text)))<font></font>
   Heap Blocks: exact=5167<font></font>
   Buffers: shared hit=24 read=27405<font></font>
   -&gt;  Bitmap Index Scan on mail_messages_tsv_idx (actual rows=5864 loops=1)<font></font>
         Index Cond: ((tsv @@ to_tsquery('!vacuum'::text)) AND (tsv @@ to_tsquery('analyze'::text)))<font></font>
         Buffers: shared hit=24 read=22238<font></font>
 Planning Time: 0.283 ms<font></font>
 Execution Time: 3258.234 ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
with the number of buffers in the new version:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>, <span class="hljs-keyword">BUFFERS</span>, <span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>, <span class="hljs-keyword">TIMING</span> <span class="hljs-keyword">OFF</span>)
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> mail_messages <span class="hljs-keyword">WHERE</span> tsv @@ to_tsquery(<span class="hljs-string">'!vacuum'</span>) <span class="hljs-keyword">AND</span> tsv @@ to_tsquery(<span class="hljs-string">'analyze'</span>);</code></pre><br>
<pre><code class="plaintext hljs">                                             QUERY PLAN                                             <font></font>
---------------------------------------------------------------------------<font></font>
Bitmap Heap Scan on mail_messages (actual rows=5864 loops=1)<font></font>
   Recheck Cond: ((tsv @@ to_tsquery('!vacuum'::text)) AND (tsv @@ to_tsquery('analyze'::text)))<font></font>
   Heap Blocks: exact=5156<font></font>
   Buffers: shared hit=5179<font></font>
   -&gt;  Bitmap Index Scan on mail_messages_tsv_idx (actual rows=5864 loops=1)<font></font>
         Index Cond: ((tsv @@ to_tsquery('!vacuum'::text)) AND (tsv @@ to_tsquery('analyze'::text)))<font></font>
         Buffers: shared hit=23<font></font>
 Planning Time: 0.250 ms<font></font>
 Execution Time: 8.779 ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A similar situation can be encountered when using trigrams, and when checking for the occurrence of arrays. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parameters of operator classes</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In PostgreSQL, many index access methods are a ‚Äúframework‚Äù that takes on a high-level implementation of the search algorithm, working with pages and locks, and the WAL log. And binding to specific data types and operators is performed using operator classes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Until now, operator classes could not have parameters. For example, for a full-text search, you can use the GiST index with the operator class </font></font><code>tsvector_ops</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(about the GiST operator classes </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) This class of operators uses a signature tree, and the signature length was fixed (124 bytes). Now you can specify the length explicitly, which allows you to control the balance between the size of the index and efficiency (the number of hash collisions):</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">INDEX</span> <span class="hljs-keyword">ON</span> mail_messages <span class="hljs-keyword">USING</span> gist(tsv tsvector_ops(siglen=<span class="hljs-number">1024</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Similar changes for starters were made for other classes of GiST operators that use a signature tree, which applies to the hstore, intarray, ltree and pg_trgm extensions. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But the main idea for which this change was conceived is the ability to pass the JSONPath expression to the GIN index so that not the entire JSON document is indexed, but only the necessary part of it. In many cases, this will radically reduce the size of indexes. But this work remains to be done. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea of ‚Äã‚ÄãOleg Bartunov, the implementation of Nikita Glukhov and Alexander Korotkov (all three Postgres Professional). </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The operator &lt;-&gt; (box, point) was</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
added. The missing operation was added for use in kNN for </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GiST</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SP-GiST</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In PG12 when working with geometric types </font></font><code>point</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>box</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can use the distance operator </font></font><code>&lt;-&gt;(point, box)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and it will speed up the search with the GiST and SP-GiST indexes. </font><font style="vertical-align: inherit;">But the operator symmetric to him </font></font><code>&lt;-&gt;(box, point)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">was not implemented, although he </font></font><code>box</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">already understood the distances to more complex types - polygons and circles.</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> points(<span class="hljs-type">point</span> <span class="hljs-type">point</span>);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> boxes(<span class="hljs-type">box</span> <span class="hljs-type">box</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> points <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">'1,2'</span>,<span class="hljs-string">'3,4'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> boxes <span class="hljs-keyword">VALUES</span>(box(<span class="hljs-type">point</span>(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>),<span class="hljs-type">point</span>(<span class="hljs-number">5</span>,<span class="hljs-number">6</span>)), box(<span class="hljs-type">point</span>(<span class="hljs-number">13</span>,<span class="hljs-number">14</span>),<span class="hljs-type">point</span>(<span class="hljs-number">15</span>,<span class="hljs-number">16</span>)));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In PG12:</font></font><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> p.point, b.box, b.box  &lt;-&gt; p.point distance <span class="hljs-keyword">FROM</span> points <span class="hljs-keyword">AS</span> p, boxes <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> distance;</code></pre><br>
<pre><code class="plaintext hljs">:    : box &lt;-&gt; point</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If vice versa, then everything is ok:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> p.point, b.box, p.point  &lt;-&gt; b.box distance <span class="hljs-keyword">FROM</span> points <span class="hljs-keyword">AS</span> p, boxes <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> distance;</code></pre><br>
<pre><code class="plaintext hljs"> point |       box       |      distance<font></font>
-------+-----------------+--------------------<font></font>
 (1,2) | (5,6),(3,4)     | 2.8284271247461903<font></font>
 (2,1) | (5,6),(3,4)     | 3.1622776601683795<font></font>
 (1,2) | (15,16),(13,14) | 16.970562748477143<font></font>
 (2,1) | (15,16),(13,14) | 17.029386365926403</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in PG13:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> p.point, b.box, b.box  &lt;-&gt; p.point distance <span class="hljs-keyword">FROM</span> points <span class="hljs-keyword">AS</span> p, boxes <span class="hljs-keyword">AS</span> b <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> distance;</code></pre><br>
<pre><code class="plaintext hljs"> point |       box       |      distance<font></font>
-------+-----------------+--------------------<font></font>
 (1,2) | (5,6),(3,4)     | 2.8284271247461903<font></font>
 (2,1) | (5,6),(3,4)     | 3.1622776601683795<font></font>
 (1,2) | (15,16),(13,14) | 16.970562748477143<font></font>
 (2,1) | (15,16),(13,14) | 17.029386365926403</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GiST and SP-GiST indices will be accelerated in this operation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note that in PG13, if you ask:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> count(*) <span class="hljs-keyword">FROM</span> pg_operator <span class="hljs-keyword">WHERE</span> oprname = <span class="hljs-string">'&lt;-&gt;'</span>;</code></pre><pre><code class="plaintext hljs"> count <font></font>
-------<font></font>
    28</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and if we do the same in PG12, we get 20 entries: in the 13th version, the list was replenished with as many as 8 operators.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Json</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support for the .datetime () method for jsonpath</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This is one of the unsuccessful patches of a large series of</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> JSONPath patches that PG12</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> did not have time to complete. Part of the JSON / SQL standard. The problem was that all the functions in the JSONPath patch series are immutable, but the date comparison takes into account the current time zone, which may change during the session.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In such cases, we allow existing immutable functions to throw an error about non-immutable comparisons. At the same time, this patch has functions with the suffix _tz that work stably in operations with timezone.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> New function - jsonb_set_lax function</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, lax is a non-strict (unlike strict) mode of operation of functions with jsonb. In this case, this function will be operational in a situation where one of the arguments that it takes is NULL. Unlike the strict version - jsonb_set () - it has an additional argument that indicates actions in the case of NULL. Options: use_json_null / raise_exception / return_target / delete_key. Options suggested by interested users. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimized some jsonb functions.</font></font></b></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Optimized </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a lot.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mainly through the efforts of Nikita Glukhov (Postgres Professional). </font><font style="vertical-align: inherit;">But to analyze each point in this case is pointless: firstly, their abundance will inflate an already short article; </font><font style="vertical-align: inherit;">and secondly, the changes relate to the internal device, and not every user is interested. </font><font style="vertical-align: inherit;">Therefore, we will only list most of them:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimized function JsonbExtractScalar ();</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimized operator # &gt;&gt;, functions jsonb_each_text (), jsonb_array_elements_text ();</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recognition of type JsonbContainer in get_jsonb_path_all () is optimized;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fetching the first token from the JsonbIterator iterator is replaced by the lightweight macro JsonbContainerIsXxx ();</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More convenient key extraction - findJsonbKeyInObject ();</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimized storage of result findJsonbValueFromContainer () and getIthJsonbValueFromContainer ();</font></font></li>
<li>  get_jsonb_path_all(),     ;<br>
  JsonbValueAsText.</li>
</ol><br>
<i> ,        SQL/JSON: JSON_TABLE  SQL/JSON: functions.       . ,   .      .     PG14.   JSONPath   .</i><br>
<br>
<h3>  </h3><br>
<h4>pgbench</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The utility for running performance tests received a series of improvements. </font><font style="vertical-align: inherit;">There were </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">statistics on the execution of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tasks at the initialization phase, a more </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">visual conclusion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the ability to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">see the code of built-in scripts</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , testing </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on a partitioned table of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> accounts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, we added a command </font></font><code>\aset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">similar to </font></font><code>\gset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but allowing to set variables for several requests sent at a time. </font><font style="vertical-align: inherit;">The following line, sent to the server for execution, sets both variables </font></font><code>one</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>two</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> one \; <span class="hljs-keyword">SELECT</span> <span class="hljs-number">2</span> <span class="hljs-keyword">AS</span> two \aset</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pg_dump learned to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unload data from third-party tables</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Through the parameter, </font></font><code>--include-foreign-data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you can specify a list of third-party servers, the data from the tables of which will be unloaded. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use this unloading carefully. </font><font style="vertical-align: inherit;">Far from the fact that the data must be uploaded to a third-party server. </font><font style="vertical-align: inherit;">In addition, it is quite possible that a third-party server will not be available during recovery. </font><font style="vertical-align: inherit;">Or a third-party server can only allow reading, but not writing data.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">psql</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A series of small patches makes psql more comfortable:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Improved tab completion for several teams.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to </font></font><code>\echo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sending a string to STDOUT, a new command </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>\warn</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sends a string to standard error output (STDERR).</font></font></li>
<li> <code>\d</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> toast-</a>       .        <code>\d+</code>        .</li>
<li>  <code>\dt+</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  ¬´Persistence¬ª</a>      (unlogged)   (permanent).</li>
<li>  <code>\e</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  </a>,       <code>;</code> (  <code>\g*</code>). ,       psql      .</li>
<li>         .     <code>PROMPT1</code>  <code>PROMPT2</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a> <code>%x</code>.</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">New commands</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for more information about access methods: </font></font><code>\dAc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>\dAf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>\dAo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,</font></font><code>\dAp</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">can</font></a></font><code>\g</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> now </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">specify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in brackets any options that are supported </font></font><code>\pset</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">They will act only on the current team.</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libpq</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Minor changes in connection with PostgreSQL:</font></font><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The inaccuracy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the description of the host and hostadr parameters and the resulting inconsistency in the output of the </font></font><code>\conninfo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">psql utility command have been fixed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the client certificate key is stored in encrypted form, you can enter the password only in interactive mode. </font><font style="vertical-align: inherit;">The new </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sslpassword</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">allows you</font></a><font style="vertical-align: inherit;"> to decrypt the key non-interactively.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Two new parameters, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sslminprotocolversion and sslmaxprotocolversion,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> allow you to specify a restriction on the version of the SSL / TCL protocol with which connection is allowed.</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reindexdb</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The new </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--jobs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parameter of the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">reindexdb</font></a><font style="vertical-align: inherit;"> utility sets the number of database connections in which indexes will be rebuilt at the same time.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_rewind</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The limitations of the utility are gradually being removed, and the possibilities are increasing. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Firstly, pg_rewind </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can now</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> record information for recovery (as pg_basebackup can do this), as well as start recovery and subsequent shutdown of an instance if it was not stopped through a breakpoint (this had to be done manually before). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And secondly, pg_rewind learned to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">work with the WAL archive</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the utility finds the WAL divergence point between the two servers, it should build a list of all pages that need to be copied to the target cluster in order to eliminate the differences. </font><font style="vertical-align: inherit;">For this, the utility requires all WAL files, starting from the found point. </font><font style="vertical-align: inherit;">If the necessary WAL files are not available on the target cluster, the utility could not perform its work before. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this patch by Alexey Kondratov (Postgres Professional) pg_rewind will be able to read the missing WAL segments from the archive of the log files using the restore_command parameter if a new -c or --restore-target-wal switch is specified.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_waldump</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pg_waldump will </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decrypt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> the prepared transaction </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">record</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">amcheck</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The amcheck extension has learned to </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">better recognize damage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in B-tree indexes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, now messages in the server log about damaged pages will </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">differ for indexes and tables</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pageinspect</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><code>heap_tuple_infomask_flags</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pageinspect extension function </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decrypts the values ‚Äã‚Äãof the fields</font></font></a> <code>infomask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><code>infomask2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returned by the function </font></font><code>heap_page_items</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Useful in investigating data corruption situations.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postgres_fdw</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The superuser at the username mapping level can </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allow regular users to</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> use a connection without a password:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-keyword">MAPPING</span> <span class="hljs-keyword">FOR</span>  <span class="hljs-keyword">SERVER</span> 
    <span class="hljs-keyword">OPTIONS</span> (<span class="hljs-keyword">ADD</span> password_required <span class="hljs-string">'false'</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is done, among other things, so that </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sslkey and sslcert</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can be used as connection parameters </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adminpack</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The adminpack extension has a new feature - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>pg_file_sync</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Using it, you can do fsync for files written by the server to disk, for example, via </font></font><code>pg_file_write</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>COPY TO</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitoring</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_slru</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the server‚Äôs shared memory, there is not only a large buffer cache, but also a number of other, simpler caches (for example, for transaction status). </font><font style="vertical-align: inherit;">They use a simple algorithm for crowding out the least frequently used pages (simple least-recently-used, or SLRU). </font><font style="vertical-align: inherit;">Until now, such caches ‚Äújust worked‚Äù, but there was a need to monitor them, primarily for developers of the PostgreSQL kernel to figure out if something needs to be changed in them. </font><font style="vertical-align: inherit;">For this and purpose, a new view of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_slru has appeared</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_activity</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the view, the </font></font><code>pg_stat_activity</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new column</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font></font><code>leader_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">For processes participating in parallel requests, it is populated with the number of the leading process. </font><font style="vertical-align: inherit;">And leading process </font></font><code>leader_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is a process number </font></font><code>pid</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following query shows which queries and which processes are currently running in parallel:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> query, leader_pid, <font></font>
    array_agg(pid) <span class="hljs-keyword">filter</span>(<span class="hljs-keyword">WHERE</span> leader_pid != pid) <span class="hljs-keyword">AS</span> members
  <span class="hljs-keyword">FROM</span> pg_stat_activity
 <span class="hljs-keyword">WHERE</span> leader_pid <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
 <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> query, leader_pid;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are changes to the list of waiting events. </font><font style="vertical-align: inherit;">Added </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">two new events</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>BackupWaitWalArchive</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>RecoveryPause</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">And the other two were given more accurate names: </font></font><code>RecoveryWalStream -&gt; RecoveryRetrieveRetryInterval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>RecoveryWalAll -&gt; RecoveryWalStream</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">two more new wait events occurring on the replica</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><code>RecoveryConflictSnapshot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(conflict with VACUUM, which deleted the necessary version of the rows) and </font></font><code>RecoveryConflictTablespace</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(conflict related to the removal of the table space).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_statements</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Until now, the extension has </font></font><code>pg_stat_statements</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">treated requests with </font></font><code>FOR UPDATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and without a phrase as the same request. Now requests with </font></font><code>FOR UPDATE</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are recorded separately</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The amount of information collected has increased. From now on, not only information on resources for executing commands is recorded, but also </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">statistics on generated journal entries</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . New presentation columns: </font></font><code>wal_bytes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- volume of generated records, </font></font><code>wal_records</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- number of generated records, </font></font><code>wal_num_fpw</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- number of full page images (full page writes). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This was made possible thanks to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prepared infrastructure</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for tracking the use of WAL. Therefore, now </font></font><code>EXPLAIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a new option it </font></font><code>WAL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will show the volume of generated records:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t (id <span class="hljs-type">int</span>);
<span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>, WAL, <span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>, <span class="hljs-keyword">TIMING</span> <span class="hljs-keyword">OFF</span>, <span class="hljs-keyword">SUMMARY</span> <span class="hljs-keyword">OFF</span>)
    <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>);</code></pre><br>
<pre><code class="plaintext hljs">              QUERY PLAN              <font></font>
--------------------------------------<font></font>
 Insert on t (actual rows=0 loops=1)<font></font>
   WAL:  records=1  bytes=59<font></font>
   -&gt;  Result (actual rows=1 loops=1)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Extension </font></font><code>auto_explain</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>VACUUM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s </font></font><code>VERBOSE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and </font></font><code>autovacuum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">also use the created infrastructure and will output volumes of WAL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Coming back to </font></font><code>pg_stat_statements</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If the new parameter </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_stat_statements.track_planning is enabled</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , then additional statistics related to the scheduler will be recorded for each operator: number of plan builds; </font><font style="vertical-align: inherit;">total planning time; </font><font style="vertical-align: inherit;">minimum and maximum time of one planning, as well as mean and standard deviation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Accounting for resources allocated to the scheduler is reflected in another patch that is not related to </font></font><code>pg_stat_statements</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>EXPLAIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the option </font></font><code>BUFFERS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will report the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">number of buffers used at the planning stage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">ANALYZE</span>, <span class="hljs-keyword">BUFFERS</span>, <span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>, <span class="hljs-keyword">TIMING</span> <span class="hljs-keyword">OFF</span>) 
    <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_class;</code></pre><br>
<pre><code class="plaintext hljs">                   QUERY PLAN                   <font></font>
------------------------------------------------<font></font>
 Seq Scan on pg_class (actual rows=386 loops=1)<font></font>
   Buffers: shared hit=9 read=4<font></font>
 Planning Time: 0.782 ms<font></font>
   Buffers: shared hit=103 read=11<font></font>
 Execution Time: 0.219 ms</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Magazine</font></font></h4><br>
<ul>
<li> <code>log_statement_sample_rate</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">   SQL,   </a>,      <code>log_min_duration_sample</code>( ).<br>
,    <code>log_min_duration_statement</code>    , ..  <code>log_min_duration_statement</code> ,  <code>log_min_duration_sample</code>,       ,      <code>log_statement_sample_rate</code>.<br>
 ,   <code>log_transaction_sample_rate</code>    ,       ,      .</li>
<li>  ,   (   log_min_error_statement),         .          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>log_parameter_max_length_on_error</code></a>.     0,   .<br>
 <code>log_parameter_max_length_on_error</code>          SQL,    ,      .<br>
    (     <code>log_statements</code>  <code>log_duration</code>)   ,  : <code>log_parameter_max_length</code>,     ,   .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can now </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write the process type</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><code>pg_stat_activity.backend_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) to the </font><font style="vertical-align: inherit;">server log </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">For this </font></font><code>log_line_prefix</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a special symbol is provided </font><font style="vertical-align: inherit;">in the parameter </font></font><code>%b</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">And if the log is written in csv ( </font></font><code>log_destination=csvlog</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">format </font><font style="vertical-align: inherit;">, then the column is </font></font><code>backend_type</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">already included there.</font></font></li>
</ul><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Progress</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
New ideas </font></font><code>pg_stat_progress_analyze</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>pg_stat_progress_basebackup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allow you to track the progress of the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">collection of statistics</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font></font><code>ANALYZE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the backup</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font></font><code>pg_basebackup</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, respectively.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimization</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculation of immutable functions in the FROM clause at the planning stage</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The patch of Aleksandr Kuzmenkov and Aleksandr Parfyonov (both from Postgres Professional) helps in cases where the</font></font><code>FROM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">call contains a function call that is actually a constant. </font><font style="vertical-align: inherit;">In this case, instead of making the connection, the constant value is substituted in the necessary places of the request. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here's how this happens with an example of a query related to full-text search:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>)
<span class="hljs-keyword">SELECT</span> subject, ts_rank_cd(tsv, q) <span class="hljs-keyword">AS</span> rank
<span class="hljs-keyword">FROM</span> mail_messages, to_tsquery(<span class="hljs-string">'english'</span>, <span class="hljs-string">'tuple'</span>) q
<span class="hljs-keyword">WHERE</span> tsv @@ q
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rank <span class="hljs-keyword">DESC</span>;</code></pre><br>
<pre><code class="plaintext hljs">                              QUERY PLAN                              <font></font>
------------------------------------------------------------------<font></font>
 Sort<font></font>
   Sort Key: (ts_rank_cd(mail_messages.tsv, '''tuple'''::tsquery)) DESC<font></font>
   -&gt;  Bitmap Heap Scan on mail_messages<font></font>
         Recheck Cond: (tsv @@ '''tuple'''::tsquery)<font></font>
         -&gt;  Bitmap Index Scan on mail_messages_tsv_idx<font></font>
               Index Cond: (tsv @@ '''tuple'''::tsquery)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is no connection, and the value 'tuple' :: tsquery is substituted in the query already at the planning stage. </font><font style="vertical-align: inherit;">Version 12 had a completely different picture:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">COSTS</span> <span class="hljs-keyword">OFF</span>)
<span class="hljs-keyword">SELECT</span> subject, ts_rank_cd(tsv, q) <span class="hljs-keyword">AS</span> rank                            
<span class="hljs-keyword">FROM</span> mail_messages, to_tsquery(<span class="hljs-string">'english'</span>, <span class="hljs-string">'tuple'</span>) q
<span class="hljs-keyword">WHERE</span> tsv @@ q                            
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> rank <span class="hljs-keyword">DESC</span>;</code></pre><br>
<pre><code class="plaintext hljs">                          QUERY PLAN                         <font></font>
-----------------------------------------------------<font></font>
 Sort<font></font>
   Sort Key: (ts_rank_cd(mail_messages.tsv, q.q)) DESC<font></font>
   -&gt;  Nested Loop<font></font>
         -&gt;  Function Scan on q<font></font>
         -&gt;  Bitmap Heap Scan on mail_messages<font></font>
               Recheck Cond: (tsv @@ q.q)<font></font>
               -&gt;  Bitmap Index Scan on mail_messages_tsv_idx<font></font>
                     Index Cond: (tsv @@ q.q)</code></pre><br>
<br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incremental sorting</font></font></a></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When sorting by many keys is needed (k1, k2, k3 ...), the scheduler can now take advantage of the knowledge that the data is already sorted by several of the first keys (for example, k1 and k2). In this case, you can not re-sort all the data again, but divide them into consecutive groups with the same values ‚Äã‚Äãk1 and k2, and ‚Äúsort‚Äù by the key k3.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, the entire sorting splits into several consecutive sorts of smaller size. This reduces the amount of memory needed, and also allows you to give out the first data before all sorting is complete.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, in the demobase on the tickets table there is an index on the ticket_id column. </font><font style="vertical-align: inherit;">Data received from the index will be sorted by ticket_id, so the following query will use incremental sorting:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">analyze</span>, <span class="hljs-keyword">costs</span> <span class="hljs-keyword">off</span>, <span class="hljs-keyword">timing</span> <span class="hljs-keyword">off</span>)
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tickets <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ticket_no, passenger_id;</code></pre><br>
<pre><code class="plaintext hljs">                                  QUERY PLAN                                  <font></font>
------------------------------------------------------------------------------<font></font>
 Incremental Sort (actual rows=2949857 loops=1)<font></font>
   Sort Key: ticket_no, passenger_id<font></font>
   Presorted Key: ticket_no<font></font>
   Full-sort Groups: 92184 Sort Method: quicksort Memory: avg=31kB peak=31kB<font></font>
   -&gt;  Index Scan using tickets_pkey on tickets (actual rows=2949857 loops=1)<font></font>
 Planning Time: 2.137 ms<font></font>
 Execution Time: 2230.019 ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incremental sorting functionality can be disabled with the enable_incrementalsort parameter. </font><font style="vertical-align: inherit;">In this case, the sorting will take noticeably longer:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SET</span> enable_incrementalsort = <span class="hljs-keyword">off</span>;
<span class="hljs-keyword">EXPLAIN</span> (<span class="hljs-keyword">analyze</span>, <span class="hljs-keyword">costs</span> <span class="hljs-keyword">off</span>, <span class="hljs-keyword">timing</span> <span class="hljs-keyword">off</span>)
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> tickets <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ticket_no, passenger_id;</code></pre><br>
<pre><code class="plaintext hljs">                              QUERY PLAN                               <font></font>
-----------------------------------------------------------------------<font></font>
 Gather Merge (actual rows=2949857 loops=1)<font></font>
   Workers Planned: 2<font></font>
   Workers Launched: 2<font></font>
   -&gt;  Sort (actual rows=983286 loops=3)<font></font>
         Sort Key: ticket_no, passenger_id<font></font>
         Sort Method: external merge  Disk: 107024kB<font></font>
         Worker 0:  Sort Method: external merge  Disk: 116744kB<font></font>
         Worker 1:  Sort Method: external merge  Disk: 107200kB<font></font>
         -&gt;  Parallel Seq Scan on tickets (actual rows=983286 loops=3)<font></font>
 Planning Time: 3.994 ms<font></font>
 Execution Time: 12291.844 ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea of ‚Äã‚Äãincremental sorting was proposed back in 2013 by Alexander Korotkov (Postgres Professional), and now, seven years later, the patch was brought by James Coleman to a state accepted by the community. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TRUNCATE acceleration</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When </font></font><code>TRUNCATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scanning occurs </font></font><code>shared_buffers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to remove table buffers from shared memory. Previously, scanning was performed three times, for each table layer: MAIN (main data layer), FSM (free space map), VM (visibility map). Now the logic has changed, instead of triple operation, buffers are scanned only once. With large values, </font></font><code>shared_buffers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this gives a tangible gain. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partial decompression TOAST</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When there is no need to read completely TOAST, limiting it to a slice at the beginning or close to the beginning, then it does not make sense to unclench it completely. </font><font style="vertical-align: inherit;">Compressed TOAST is read in iterations: read a piece, if there is no necessary data, then expand it and read on. </font><font style="vertical-align: inherit;">Suggested by a Google Summer of Code student, Binguo Bao, who gives an example:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> slicingtest (<font></font>
     id <span class="hljs-type">serial</span> <span class="hljs-keyword">PRIMARY KEY</span>,<font></font>
     a <span class="hljs-type">text</span><font></font>
);<font></font>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> slicingtest (a) <span class="hljs-keyword">SELECT</span>
    repeat(<span class="hljs-string">'1234567890-=abcdefghijklmnopqrstuvwxyz'</span>, <span class="hljs-number">1000000</span>) <span class="hljs-keyword">AS</span> a <span class="hljs-keyword">FROM</span>
    generate_series(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>);<font></font>
\<span class="hljs-keyword">timing</span>
<span class="hljs-keyword">SELECT</span> sum(length(substr(a, <span class="hljs-number">0</span>, <span class="hljs-number">20</span>))) <span class="hljs-keyword">FROM</span> slicingtest;</code></pre><br>
<pre><code class="plaintext hljs">Time: 28.123 ms</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the patch, an order of magnitude faster:</font></font><br>
<br>
<pre><code class="plaintext hljs">Time: 2.306 ms</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parallel VACUUM</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In his</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> article on this subject,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Yegor Rogov explains in detail this important step in parallelization. In short: ‚ÄúPatch Masahiko Sawada, which allows you to perform cleaning in parallel. The table itself is still cleared by one (leading) process, but to clean indexes, it can now start background workflows, one for each index. In manual mode, this allows you to speed up the cleaning of large tables with multiple indexes; automatic cleaning does not use this feature yet. ‚Äù</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Auto clean when pasted into a table</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For this patch (also known as the Berserk auto-vacuum), we need to thank Dorofei Proleskovsky, who proposed a solution to the following problem: auto-cleaning does not come to the append-only table, because they do not have ‚Äúdead‚Äù versions of the rows. Because of this, the visibility map is not updated, making only index-only scans ineffective, and when cleaning does come to prevent transaction counter overflows, it needs to do a lot of work at once. Now this situation has been fixed: auto-cleaning will also work on adding lines. Two new server parameters ( </font></font><code>autovacuum_vacuum_insert_threshold</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>autovacuum_vacuum_insert_scale_factor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) appeared, similar to those for modifications ( </font></font><code>autovacuum_vacuum_threshold</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>autovacuum_vacuum_scale_factor</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hash Aggregate Memory Management</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hash aggregation may require more RAM than the scheduler thought and than indicated in </font></font><code>work_mem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Previously, such a scheduler error led to the fact that the size was </font></font><code>work_mem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ignored and memory was allocated as much as needed for the operation or arrival of OOM Killer. Now the algorithm may not go beyond </font></font><code>work_mem</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and if necessary, use temporary files on disk. To control the behavior of the scheduler, the following parameters appeared: </font></font><code>enable_groupingsets_hash_disk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>enable_hashagg_disk</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Optimizing UPDATE for tables with generated columns</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In version 12, the generated columns were recalculated during any row update, even if this change did not affect them in any way. Now they will be recalculated only when it is really needed (if their base columns have changed). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This optimization, for example, can significantly speed up the updating of tables with a generated type column </font></font><code>tsvector</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, since the function is </font></font><code>to_tsvector()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quite expensive. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Access from the trigger to the list of changed columns</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
A small patch that adds a </font></font><code>TriggerData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bitmap of changed columns </font><font style="vertical-align: inherit;">to the structure </font><font style="vertical-align: inherit;">. This information can be used by general trigger functions, such as </font></font><code>tsvector_update_trigger()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>lo_manage()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in order not to do unnecessary work. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use of several advanced statistics when evaluating</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In PG12, the scheduler was not able to use several advanced statistics for the same table at the same time. For example, imagine a situation where two advanced statistics are constructed for different sets of columns, and columns from one set and from another participate in the query. Now the planner has access to all available information. </font></font><br>
<br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infrastructure for parallelization and COPY</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (see also </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this patch.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQL concurrency still works for read-only queries. </font><font style="vertical-align: inherit;">There are difficulties with writers, and one of them is blocking processes that simultaneously perform one task (included in a common parallel group). </font><font style="vertical-align: inherit;">It is believed that the locks of such processes do not conflict - for example, several processes can hold an exclusive lock on the same table. </font><font style="vertical-align: inherit;">This requires special care from the kernel developers, but otherwise they would constantly have deadlocks. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there are two exceptions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">relation extension lock, which is captured when new pages are added to the end of the data file, and</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">page lock, which is used when moving GIN index items from the wait list to the main tree.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(You can read more </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in this article.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such locks should conflict even between processes of the same parallel group - which implements this patch. </font><font style="vertical-align: inherit;">But these locks can never lead to deadlocks, so they are excluded from the scan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the user, in general, nothing changes, but this patch is important because, firstly, it paves the way for parallel INSERT and COPY, and secondly, it eliminates one of the PostgreSQL bottlenecks under high load conditions (which can be heard </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the report HL ++</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Safety</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SKH PRH</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
primes</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"> replaced Replaced</font></b></a><font style="vertical-align: inherit;"> EDH primes (Diffie-Hellman Ephemeral Keys) using the now defunct SKIP protocol.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> initdb: the default settings for authentication</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
have changed The default access settings for local and network connections have changed when initdb starts. Now in</font></font><code>pg_hba.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for local connections instead of the authentication method</font></font><code>trust</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be</font></font><code>peer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(or md5 if peer is not supported), and</font></font><code>md5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for network connections. Initially, more liberal measures were discussed: warning in the documentation. Then tougher:</font></font><code>scram-sha-256</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. As a result, we decided to limit ourselves to</font></font><code>peer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>md5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Using explicit_bzero</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Important patch. The bzero () and explicit_bzero () OS functions write bytes containing into the indicated memory areas </font></font><code>'\0'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(see, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for example</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , Linux). These patches are just the beginning: there are many sections of memory in which passwords and other sensitive information can remain. We decided to start from places like libpq, in which the whole file with passwords can remain in memory after reading .pgpass, and from cleaning after closing the connection. In be-secure-common.c now there is an overwriting of the entered secret phrase in SSL, which appears in the line (path) of the error. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Added "password_protocol" parameter to libpq</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This patch allows libpq to control which password transfer protocol is used during the connection. After receiving this parameter, libpq will refuse authentication if the protocol is weaker than the specified one. By default, this parameter </font></font><code>plaintext</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, that is, all protocols are suitable. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mandatory access for TRUNCATE</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This patch enables extensions to embed Mandatory Access Control (MAC) for a TRUNCATE operation. Rights to it will now be checked by the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sepgsql</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> extension </font><font style="vertical-align: inherit;">. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SELinux Reference Policy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and Redhat-based Linux distributions do not support SELinux checking on db_table {truncate}. In this case, sepgsql will be used with 'deny_unknown' equal to 1, and TRUNCATE will fail. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Availability of GUC ssl_passphrase_command</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A simple but useful patch. </font><font style="vertical-align: inherit;">Now the value of the ssl_passphrase_command parameter will be seen only by superuser. </font><font style="vertical-align: inherit;">The parameter specifies an external command that is called when a password is required to decrypt an SSL file, for example, a private key.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Localization</font></font></h3><br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versioning libc collation rules</font></font></a></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
For ICU collation rules, version numbers are stored in the database. Each time the rule is used (sorting, character comparison), the saved version number is checked with the current version in the ICU library in the OS, and in case of discrepancies, a warning is issued. This allows you to find that certain indexes built according to the modified sorting rules may be incorrect and should be rebuilt. By rebuilding the indexes with the command</font></font><code>ALTER COLLATION ... REFRESH VERSION</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the version of the sorting rule in the database is updated and warnings are no longer issued.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But that was only for the ICU. Now the version number is also stored for libc sorting rules:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">SELECT</span> collname, collversion <span class="hljs-keyword">FROM</span> pg_collation <span class="hljs-keyword">WHERE</span> collname = <span class="hljs-string">'ru_RU'</span>;</code></pre><br>
<pre><code class="plaintext hljs"> collname | collversion<font></font>
----------+-------------<font></font>
 ru_RU    | 2.27</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Which makes it possible to issue warnings when a library changes in the OS. </font><font style="vertical-align: inherit;">Very relevant in light of the transition to glibc 2.28, where many sorting rules have changed, and the corresponding indexes should be rebuilt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But until they switched to 2.28, everything is calm:</font></font><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLLATION</span> "ru_RU" <span class="hljs-keyword">REFRESH</span> <span class="hljs-keyword">VERSION</span>;</code></pre><br>
<pre><code class="plaintext hljs">NOTICE:  version has not changed<font></font>
ALTER COLLATION</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full Text Search</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fulltext search for Greek language</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
No comments. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dict_int learned to handle absolute values.</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The dict_int template dictionary (aka extension) added the ability to remove the sign from a number.</font></font><br>
<br>
<pre><code class="pgsql hljs">
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> dict_int;
<span class="hljs-keyword">SELECT</span> ts_lexize(<span class="hljs-string">'intdict'</span>, <span class="hljs-string">'-123'</span>);</code></pre><br>
<pre><code class="plaintext hljs">ts_lexize<font></font>
-----------<font></font>
 {-123}<font></font>
(1 row)</code></pre><br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TEXT SEARCH</span> <span class="hljs-keyword">DICTIONARY</span> intdict (ABSVAL = <span class="hljs-keyword">true</span>);
<span class="hljs-keyword">SELECT</span> ts_lexize(<span class="hljs-string">'intdict'</span>, <span class="hljs-string">'-123'</span>);</code></pre><br>
<pre><code class="plaintext hljs">ts_lexize<font></font>
-----------<font></font>
 {123}<font></font>
(1 row)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, this time the absolute value was recognized.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partitioning</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BEFORE</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
row triggers</font></font><code>BEFORE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on a partitioned table</font><font style="vertical-align: inherit;">In version 12, you cannot create row triggers</font><font style="vertical-align: inherit;">on a partitioned table. On separate sections - please, but not on the entire table at once. Now, a</font></font><code>BEFORE FOR EACH ROW</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trigger created on a partitioned table will be automatically inherited and work for all sections. But with the condition that if it is a trigger on</font></font><code>UPDATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then the partition key in it can only be changed within the current section.</font></font><br>
<br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Support for partitioned tables in logical replication</font></font></a></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Previously, including a partitioned table in a publication caused an error:</font></font><br>
<br>
<pre><code class="pgsql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PUBLICATION</span> pub <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">TABLE</span> p;</code></pre><br>
<pre><code class="plaintext hljs">ERROR:  "p" is a partitioned table<font></font>
DETAIL:  Adding partitioned tables to publications is not supported.<font></font>
HINT:  You can add the table partitions individually.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now it works. </font></font><br>
<br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Improved sectional JOIN algorithm</font></font></a></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Starting from the 11th version, the scheduler can join partitioned tables section by section, but only if the boundaries of the sections exactly match. </font><font style="vertical-align: inherit;">Now the algorithm has been improved: it will work if the section of one table is completely included in the section of another, even if their sizes do not match (for example, if one table is partitioned by day and the other by month). </font><font style="vertical-align: inherit;">The new algorithm works for partitioning by ranges and by lists. </font></font><br>
<br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sectional FULL OUTER JOIN Sectionalization join</font></font></a></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
now works for full outer joins recorded with a phrase </font></font><code>USING</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tableam</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this attractive and promising, but difficult area, there are no radical advances regarding PostgreSQL 12. There are no ready-made plug-in storages such as </font></font><code>zheap</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other than heap), but work continues on the API. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A higher level of abstraction in determining the size of the table</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Robert Haas rewrote the code, changing its architecture in favor of abstract layers, so as not to duplicate the code in the future. This piece refers to </font></font><code>estimate_rel_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the size of the layers (forks) of the table. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can use table access methods with relcache.</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This patch brings the memory management capabilities of table access methods to the capabilities of index methods. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tableam and TOAST</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
TOAST are largely designed for storage</font></font><code>heap</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Therefore, when creating new </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">table access methods,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you can go in two ways: help developers of new methods integrate insert, update and delete TOAST records into them or delegate work with TOAST to code using the traditional PostgreSQL storage - heap. </font><font style="vertical-align: inherit;">A series of 5 patches uses tuple slots to implement insert / update / delete operations and can help those that go both ways.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fsync</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handling fsync errors in pg_receivewal and pg_recvlogical</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The fight against</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fsync ()</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> continues. PostgreSQL believes that a successful fsync () call means that all data in the file has been flushed to disk, but this does not always happen (OS dependent) and may result in data loss. PG13 decided that it was necessary to deal with the utilities</font></font><code>pg_receivewal</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>pg_recvlogical</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Currently, the default behavior is this: these utilities will write fsync errors to the logs, restore the connection and continue as if nothing had happened. As a result, the WAL contains information about files that were successfully copied, which, in fact, were not correctly flushed to disk. So it‚Äôs better to interrupt the utility. The fate of pg_dump, pg_basebackup, pg_rewind and pg_checksums was also discussed, but so far have limited themselves to these two.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protection against setting incorrect flags for fsync ()</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This patch checks if the flags are set correctly when receiving the file descriptor for fsync () - directories are open only for reading, and files for writing or both.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Backup and replication</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pause during recovery before reaching the recovery point</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
If during the recovery the WALs have ended, but</font></font><code>recovery_target_time</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">they have not reached the</font><font style="vertical-align: inherit;">specified</font><font style="vertical-align: inherit;">one, the server completes the recovery and switches to normal operation mode. Now it will not be so. The recovery process will pause, as reported in the log, and the administrator will have the opportunity to insert the missing WAL segments and continue the recovery.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The ignore_invalid_pages parameter</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When the recovery process on a replica finds a link to an invalid page in the WAL record,</font></font><code>panic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-a</font><font style="vertical-align: inherit;">happens</font><font style="vertical-align: inherit;">. The inclusion of the parameter will help to overcome it.</font></font><code>ignore_invalid_pages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Recovery will continue with possible loss of integrity, data and other most serious consequences. The parameter is intended for server developers and should be used in those cases when you still need to try to complete the recovery and start the replica. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Changing primary_conninfo without restarting</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sergey Kornilov's patch, which allows you to change the settings </font></font><code>primary_conninfo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>primary_slot_name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>wal_receiver_create_temp_slot</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">without restarting the server. Actually, for the sake of this, they abandoned the file </font></font><code>recovery.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the 12th release. </font><font style="vertical-align: inherit;">
Pg_basebackup </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">backup</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manifests now creates a ‚Äúmanifest‚Äù - a JSON file containing information about the backup made (file names and sizes, necessary WAL files, as well as checksums for everything and everything).</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The new pg_validatebackup utility checks the backups for compliance with the manifest, and also checks for the availability and correctness of the WAL files necessary for recovery using the pg_waldump utility (this applies only to WAL files inside the backup itself, and not in the archive). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This will allow you to detect situations where the backup files were damaged or disappeared, or when recovery became impossible due to the lack of the necessary log files. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Limiting unread data replication slot The replication</font></font></b></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
slot is a convenient but dangerous mechanism: if the client does not read the data from the slot on time, unread WAL records can take up all the space on the server. Now using the parameter</font></font><code>max_slot_wal_keep_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can set a limit on the maximum amount of disk space that can be occupied by unread data. </font><font style="vertical-align: inherit;">If at the next checkpoint it turns out that the size is exceeded, the slot is disabled, and the place is freed.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support for Unix sockets on Windows Unix-</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
domain sockets are supported on Windows 10, although they are disabled by default.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documentation</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two new applications in the documentation. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After a long </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discussion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appendix M. Glossary appeared</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">There are currently 101 terms in the glossary. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The ability to highlight the color of diagnostic messages of console utilities using a variable </font></font><code>PG_COLOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">was earlier. </font><font style="vertical-align: inherit;">This is now </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documented</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Appendix N. Color Support</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Peter Eisentrout's original intent in this patch was to make the colorized output turned on by default. </font><font style="vertical-align: inherit;">And for those who did not want this, it was proposed to explicitly set the variable</font></font><code>NO_COLOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But there were more opponents of color differentiation of messages among those discussing the patch. </font><font style="vertical-align: inherit;">Therefore, they decided only to document the available opportunities. </font><font style="vertical-align: inherit;">And we got a new section of the first level in the documentation.</font></font><br>
<br>
<hr><br>
<i>        PG13,  ,  PG14     . ,   . .</i></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en493094/index.html">Amazon warehouse workers sound alarm over coronavirus spread</a></li>
<li><a href="../en493096/index.html">Add a dark theme in iOS</a></li>
<li><a href="../en493098/index.html">Deploy ASA VPN Load-Balancing Cluster</a></li>
<li><a href="../en493100/index.html">How finding easy ways helps startups achieve aggressive growth</a></li>
<li><a href="../en493102/index.html">Global Automation Trends: RPA Development</a></li>
<li><a href="../en493108/index.html">Cloudflare selects AMD processors for tenth-generation edge servers</a></li>
<li><a href="../en493110/index.html">How to delegate in remote work - a guide for team lead and more</a></li>
<li><a href="../en493112/index.html">How to start a new business in 6 months instead of 3 years</a></li>
<li><a href="../en493114/index.html">How Data Engineer Watched Data</a></li>
<li><a href="../en493116/index.html">‚ÄúMore interactivity!‚Äù or How was TeamLead Conf 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>