<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙍🏻 🛅 🌳 Verwendung von Prometheus zum Erkennen von Anomalien in GitLab 👩🏿‍⚕️ 👨‍👧 🕵🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eine der Grundfunktionen der Prometheus-Abfragesprache ist die Echtzeitaggregation von Zeitreihen . Sie können auch die Prometheus-Abfragesprache verw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Verwendung von Prometheus zum Erkennen von Anomalien in GitLab</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/499032/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a38/51d/6f9/a3851d6f99b3624787dfa4cfeb2112e5.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eine der Grundfunktionen der Prometheus-Abfragesprache ist die </font><font style="vertical-align: inherit;">Echtzeitaggregation </font><font style="vertical-align: inherit;">von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zeitreihen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Sie können auch die Prometheus-Abfragesprache verwenden, um Anomalien in Zeitreihendaten zu erkennen.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud - </font><font style="vertical-align: inherit;">Lösungen </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Team hat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> übersetzt </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">einen Artikel von dem Ingenieure des Gitlab Infrastruktur - </font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Teams</font></a><font style="vertical-align: inherit;"> , in </font><font style="vertical-align: inherit;">dem Sie Codebeispiele finden , </font><font style="vertical-align: inherit;">dass Sie auf Ihrem System ausprobieren können.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wofür ist Anomalieerkennung?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt vier Hauptgründe, die die Bedeutung der Erkennung von Anomalien für GitLab bestimmen:</font></font><br>
<br>
<ol>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Incident Diagnostics</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Wir können erkennen, welche Dienste über ihren normalen Umfang hinausgegangen sind, indem wir die Incident Detection Time (MTTD) reduzieren und dementsprechend eine schnellere Lösung für das Problem anbieten.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erkennung von Leistungseinbußen</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Wenn beispielsweise eine Regression in einen Dienst eingeführt wird, die dazu führt, dass dieser zu oft auf einen anderen Dienst zugreift, können wir dieses Problem schnell erkennen und beheben.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erkennung und Beseitigung von Missbrauch</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : GitLab bietet Bereitstellungs- und Integrationsmechanismen ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab CI / CD</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) und Hosting (GitLab Pages) sowie eine begrenzte Anzahl von Benutzern, die diese Mechanismen verwenden können.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sicherheit</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Die Erkennung von Anomalien ist wichtig, um ungewöhnliche Trends in der GitLab-Zeitreihe zu erkennen.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus diesen und anderen Gründen hat der Autor des Artikels beschlossen, herauszufinden, wie die Definition von Anomalien in der GitLab-Zeitreihe mithilfe von Prometheus-Abfragen und -Regeln konfiguriert werden kann.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ist die richtige Aggregationsebene?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstens müssen Zeitreihen korrekt aggregiert werden. </font><font style="vertical-align: inherit;">Im folgenden Beispiel haben wir den Standardzähler http_requests_total zum Abrufen von Daten verwendet, obwohl dies auch bei vielen anderen Metriken der Fall wäre.</font></font><br>
<br>
<pre><code class="plaintext hljs">http_requests_total{<font></font>
 job="apiserver",<font></font>
 method="GET",<font></font>
 controller="ProjectsController",<font></font>
 status_code="200",<font></font>
 environment="prod"<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diese Testmetrik enthält mehrere Parameter: Methode, Controller, Statuscode (status_code), Umgebung sowie von Prometheus selbst hinzugefügte Parameter, z. B. Job und Instanz. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt müssen Sie die richtige Ebene der Datenaggregation auswählen. </font><font style="vertical-align: inherit;">Zu viel, zu wenig - all dies ist wichtig, um Anomalien zu erkennen. </font><font style="vertical-align: inherit;">Wenn die Daten zu aggregiert sind, gibt es zwei mögliche Probleme:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie können die Anomalie überspringen, da durch die Aggregation Probleme ausgeblendet werden, die in Teilmengen Ihrer Daten auftreten.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie eine Anomalie finden, ist es schwierig, sie ohne zusätzlichen Aufwand mit einem separaten Teil Ihres Systems in Verbindung zu bringen.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn die Daten nicht ausreichend aggregiert sind, kann dies zu einer Erhöhung der Anzahl falsch positiver Ergebnisse sowie zu einer falschen Interpretation gültiger Daten als fehlerhaft führen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Basierend auf unserer Erfahrung ist die korrekteste Aggregationsebene die Serviceebene, dh wir fügen das Label für Arbeit (Job) und Umgebung (Umgebung) hinzu und verwerfen alle anderen Labels. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Aggregation, die wir im gesamten Artikel diskutieren werden, umfasst: job - http_request, Aggregation - fünf Minuten, die auf der Grundlage von Arbeit und Umgebung in fünf Minuten berechnet wird.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m<font></font>
expr: sum without(instance, method, controller, status_code)<font></font>
(rate(http_requests_total[5m]))<font></font>
# --&gt; job:http_requests:rate5m{job="apiserver", environment="prod"}&nbsp; 21321<font></font>
# --&gt; job:http_requests:rate5m{job="gitserver", environment="prod"}&nbsp; 2212<font></font>
# --&gt; job:http_requests:rate5m{job="webserver", environment="prod"}&nbsp; 53091</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus dem obigen Beispiel geht hervor, dass aus der Reihe http_requests_total-Teilmengen im Kontext von Arbeit und Umgebung ausgewählt werden und ihre Anzahl dann fünf Minuten lang berücksichtigt wird.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verwenden des Z-Scores zum Erkennen von Anomalien</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Grundprinzipien der Statistik können angewendet werden, um Anomalien zu erkennen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie den Mittelwert und die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Standardabweichung</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> der Prometheus-Reihe kennen, können Sie eine beliebige Stichprobe in der Reihe verwenden, um den Z-Score zu berechnen.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Z-Score ist ein Maß für die relative Streuung des beobachteten oder gemessenen Werts, das zeigt, wie viele </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Standardabweichungen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seine Streuung relativ zum </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durchschnittswert beträgt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das heißt, der Z-Score = 0 bedeutet, dass der Z-Score mit dem Durchschnittswert im Datensatz mit der Standardverteilung identisch ist, und der Z-Score = 1 bedeutet, dass die Standardabweichung = 1,0 vom Durchschnitt ist.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir gehen davon aus, dass die Basisdaten eine Normalverteilung haben, was bedeutet, dass 99,7% der Stichproben einen Z-Score von 0 bis 3 haben. Je weiter der Z-Score von Null entfernt ist, desto unwahrscheinlicher ist seine Existenz.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir wenden diese Eigenschaft an, um Anomalien in der Prometheus-Datenreihe zu erkennen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir berechnen den Mittelwert und die Standardabweichung für die Metrik anhand von Daten mit einer großen Stichprobengröße. </font><font style="vertical-align: inherit;">In diesem Beispiel verwenden wir wöchentliche Daten. </font><font style="vertical-align: inherit;">Wenn wir davon ausgehen, dass die Aufzeichnungen einmal pro Minute ausgewertet werden, werden wir in einer Woche etwas mehr als 10.000 Proben haben.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Long-term average value for the series<font></font>
- record: job:http_requests:rate5m:avg_over_time_1w<font></font>
expr: avg_over_time(job:http_requests:rate5m[1w])<font></font>
<font></font>
# Long-term standard deviation for the series<font></font>
- record: job:http_requests:rate5m:stddev_over_time_1w<font></font>
expr: stddev_over_time(job:http_requests:rate5m[1w])</code></pre><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir können den Z-Score für die Prometheus-Abfrage berechnen, sobald wir den Mittelwert und die Standardabweichung für die Aggregation erhalten.</font></font><br>
<br>
<pre><code class="plaintext hljs"># Z-Score for aggregation<font></font>
(<font></font>
job:http_requests:rate5m -<font></font>
job:http_requests:rate5m:avg_over_time_1w<font></font>
) /&nbsp; job:http_requests:rate5m:stddev_over_time_1w</code></pre><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Angenommen, basierend auf den statistischen Prinzipien von Normalverteilungen ist jeder Wert außerhalb des Bereichs von +3 bis -3 eine Anomalie. </font><font style="vertical-align: inherit;">Dementsprechend können wir eine Warnung vor solchen Anomalien erstellen. </font><font style="vertical-align: inherit;">Beispielsweise erhalten wir eine Benachrichtigung, wenn unsere Aggregation länger als fünf Minuten über diesen Bereich hinausgeht.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82e/e84/e96/82ee84e96be5ca6895b5aa5d6f0441ad.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagramm der Anzahl der Anfragen pro Sekunde an den GitLab Pages-Dienst für 48 Stunden. </font><font style="vertical-align: inherit;">Der Z-Score im Bereich von +3 bis -3 wird grün hervorgehoben. Der</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Z-Score kann in den Diagrammen schwierig zu interpretieren sein, da dieser Wert keine Maßeinheit hat. </font><font style="vertical-align: inherit;">Die Anomalien in diesem Diagramm sind jedoch sehr einfach zu bestimmen. </font><font style="vertical-align: inherit;">Alles, was über die grüne Zone hinausgeht, die einen Wertekorridor mit einem Z-Score von -3 bis +3 anzeigt, ist ein anomaler Wert.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was tun, wenn die Datenverteilung nicht normal ist?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir gehen davon aus, dass die Datenverteilung normal ist. </font><font style="vertical-align: inherit;">Andernfalls ist unser Z-Score falsch. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt viele statistische Tricks, um die Normalität der Datenverteilung zu bestimmen. Am besten überprüfen Sie jedoch, ob Ihr Daten-Z-Score im Bereich von -4,0 bis +4,0 liegt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zwei Prometheus-Abfragen mit minimalen und maximalen Z-Scores:</font></font><br>
<br>
<pre><code class="plaintext hljs">(<font></font>
max_over_time(job:http_requests:rate5m[1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; 4.01<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; 3.96<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; 2.96<font></font>
<font></font>
(<font></font>
 min_over_time(job:http_requests:rate5m[&lt;1w]) - avg_over_time(job:http_requests:rate5m[1w])<font></font>
) / stddev_over_time(job:http_requests:rate5m[1w])<font></font>
# --&gt; {job="apiserver", environment="prod"}&nbsp; -3.8<font></font>
# --&gt; {job="gitserver", environment="prod"}&nbsp; -4.1<font></font>
# --&gt; {job="webserver", environment="prod"}&nbsp; -3.2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Ihre Ergebnisse im Bereich von -20 bis +20 liegen, bedeutet dies, dass zu viele Daten verwendet wurden und die Ergebnisse verzerrt sind. </font><font style="vertical-align: inherit;">Denken Sie auch daran, dass Sie mit aggregierten Zeilen arbeiten müssen. </font><font style="vertical-align: inherit;">Metriken ohne Normalverteilung enthalten Parameter wie Fehlerrate, Verzögerung, Warteschlangenlängen usw. </font><font style="vertical-align: inherit;">Viele dieser Metriken funktionieren jedoch besser mit festen Alarmschwellenwerten.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Statistische Erkennung von Saisonalitätsanomalien</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obwohl die Berechnung von Z-Scores mit der Normalverteilung von Zeitreihendaten gut funktioniert, gibt es eine zweite Methode, mit der sich noch genauere Anomalieerkennungsergebnisse erzielen lassen. </font><font style="vertical-align: inherit;">Dies ist die Verwendung der statistischen Saisonalität.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saisonalität ist ein Merkmal einer Zeitreihenmetrik, wenn diese Metrik regelmäßigen und vorhersehbaren Änderungen unterliegt, die in jedem Zyklus wiederholt werden.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/096/646/cfc/096646cfc711897a4de6ce82d41d88d4.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diagramm der Anfragen pro Sekunde (RPS) von Montag bis Sonntag für vier aufeinanderfolgende Wochen Das</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Diagramm oben zeigt das RPS (Anzahl der Anfragen pro Sekunde) für sieben Tage - von Montag bis Sonntag für vier aufeinanderfolgende Wochen. </font><font style="vertical-align: inherit;">Dieser Bereich von sieben Tagen wird als "Versatz" bezeichnet, dh das Muster, das für die Messung verwendet wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jede Woche auf dem Diagramm hat eine andere Farbe. </font><font style="vertical-align: inherit;">Die Saisonalität der Daten wird durch die Reihenfolge in den in der Grafik angegebenen Trends angezeigt. Jeden Montagmorgen beobachten wir einen ähnlichen Anstieg des RPS, und abends am Freitag beobachten wir immer einen Rückgang des RPS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mithilfe der Saisonalität in unseren Zeitreihendaten können wir das Auftreten von Anomalien und deren Erkennung genauer vorhersagen.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man Saisonalität benutzt</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Prometheus verwendet verschiedene statistische Mechanismen, um die Saisonalität zu berechnen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zunächst führen wir eine Berechnung durch und fügen den Ergebnissen der Vorwoche einen Wachstumstrend für die Woche hinzu. Der Wachstumstrend wird wie folgt berechnet: Subtrahieren Sie den gleitenden Durchschnitt der letzten Woche vom gleitenden Durchschnitt der letzten Woche.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; job:http_requests:rate5m offset 1w&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w # One-week growth trend<font></font>
&nbsp; &nbsp; — job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die erste Iteration stellt sich als etwas „eng“ heraus - wir verwenden das Fünf-Minuten-Fenster dieser Woche und der Vorwoche, um unsere Prognosen zu erhalten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei der zweiten Iteration erweitern wir unsere Abdeckung, indem wir den Durchschnitt des Vier-Stunden-Zeitraums der Vorwoche mit der aktuellen Woche vergleichen.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn wir also versuchen, den Metrikwert am Montag um acht Uhr morgens vorherzusagen, anstatt des gleichen Fünf-Minuten-Fensters in der Woche zuvor, nehmen wir den Durchschnittswert der Metrik von sechs auf zehn am Morgen des vorherigen Montags.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
&nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h) # Rounded value from last period<font></font>
&nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w&nbsp; &nbsp; # Add 1w growth trend<font></font>
&nbsp; &nbsp; - job:http_requests:rate5m:avg_over_time_1w offset 1w</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der Anfrage wurden 166 Stunden angegeben, was zwei Stunden weniger als eine volle Woche ist (7 * 24 = 168), da wir einen Zeitraum von vier Stunden basierend auf der aktuellen Zeit verwenden möchten, sodass der Offset zwei Stunden weniger als eine volle Woche betragen muss.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dbe/1a3/417/dbe1a3417069f11203878b0efb3a613c.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Realer RPS (gelb) und vorhergesagter (blau) in zwei Wochen</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Ein Vergleich des tatsächlichen RPS mit unserer Prognose zeigt, dass unsere Berechnungen ziemlich genau waren. Diese Methode hat jedoch einen Nachteil. </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Beispiel wurde GitLab am 1. Mai mittwochs weniger als gewöhnlich verwendet, da dieser Tag ein freier Tag war. Da der geschätzte Wachstumstrend davon abhängt, wie das System in der Vorwoche verwendet wurde, ergaben unsere Prognosen für die nächste Woche, dh am Mittwoch, dem 8. Mai, einen niedrigeren RPS als tatsächlich. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieser Fehler kann korrigiert werden, indem drei Prognosen für drei aufeinanderfolgende Wochen vor Mittwoch, dem 1. Mai, dh den drei vorhergehenden Mittwochs, erstellt werden. Die Anforderung bleibt gleich, aber der Offset wird angepasst.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e4a/f28/40d/e4af2840d94eb531b2fc7ddf26f8abce.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es gibt drei Prognosen für drei Wochen vor dem 8. Mai auf dem Chart, verglichen mit dem tatsächlichen RPS für Mittwoch, den 8. Mai. Sie können sehen, dass die beiden Prognosen sehr genau sind, aber die Prognose für die Woche vom 1. Mai bleibt ungenau.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Außerdem benötigen wir keine drei Prognosen, sondern eine Prognose. Der Durchschnittswert ist keine Option, da er durch unsere verzerrten RPS-Daten ab dem 1. Mai unscharf wird. Stattdessen müssen Sie den Median berechnen. Prometheus hat keine Medianabfrage, aber wir können anstelle des Medians die Quantilaggregation verwenden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das einzige Problem ist, dass wir versuchen, drei Serien in die Aggregation aufzunehmen, und diese drei Serien sind in drei Wochen tatsächlich die gleichen Serien. Mit anderen Worten, sie haben die gleichen Bezeichnungen, daher ist es schwierig, sie zusammenzusetzen.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um Verwirrung zu vermeiden, erstellen wir ein Etikett mit dem Namen Offset und verwenden die Funktion zum Ersetzen von Etiketten, um jeder der drei Wochen einen Versatz hinzuzufügen. </font><font style="vertical-align: inherit;">Dann verwerfen wir bei der Quantilaggregation diese Markierungen, und dies ergibt einen Durchschnitt von drei.</font></font><br>
<br>
<pre><code class="plaintext hljs">- record: job:http_requests:rate5m_prediction<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; quantile(0.5,<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 166h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 1w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "1w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 334h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 2w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "2w", "", "")<font></font>
 &nbsp; &nbsp; or<font></font>
 &nbsp; &nbsp; label_replace(<font></font>
 &nbsp; &nbsp; &nbsp; avg_over_time(job:http_requests:rate5m[4h] offset 502h)<font></font>
 &nbsp; &nbsp; &nbsp; + job:http_requests:rate5m:avg_over_time_1w — job:http_requests:rate5m:avg_over_time_1w offset 3w<font></font>
 &nbsp; &nbsp; &nbsp; , "offset", "3w", "", "")<font></font>
 &nbsp; )<font></font>
 &nbsp; without (offset)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt ist unsere Prognose mit einem Median von drei Aggregationen genauer geworden.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/77e/a87/32c/77ea8732cbf6466a4766bc213166a3b3.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Medianprognose im Vergleich zum tatsächlichen RPS</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So finden Sie heraus, dass unsere Prognose wirklich genau ist</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die Genauigkeit der Prognose zu überprüfen, können wir zum Z-Score zurückkehren. </font><font style="vertical-align: inherit;">Es wird verwendet, um die Diskrepanz der Stichprobe mit ihrer Prognose in Standardabweichungen zu messen. </font><font style="vertical-align: inherit;">Je größer die Standardabweichung von der Prognose ist, desto höher ist die Wahrscheinlichkeit, dass ein bestimmter Wert ein Ausreißer ist.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/076/559/918/0765599182b7b441e31c32847c1de4fa.png"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der projizierte Abweichungsbereich liegt zwischen +1,5 und -1,5.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Sie können unser Grafana-Diagramm so ändern, dass anstelle eines wöchentlichen gleitenden Durchschnitts eine saisonale Prognose verwendet wird. </font><font style="vertical-align: inherit;">Der Bereich der Normalwerte für eine bestimmte Tageszeit ist grün schattiert. </font><font style="vertical-align: inherit;">Alles, was über die grüne Zone hinausgeht, gilt als Ausreißer. </font><font style="vertical-align: inherit;">In diesem Fall trat der Ausreißer am Sonntagnachmittag auf, als unser Cloud-Anbieter einige Netzwerkprobleme hatte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wird empfohlen, für saisonale Vorhersagen einen ± 2-Z-Score zu verwenden.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So richten Sie Benachrichtigungen mit Prometheus ein</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie eine Warnung für abnormale Ereignisse einrichten möchten, können Sie die relativ einfache Prometheus-Regel anwenden, mit der überprüft wird, ob der Z-Score eines Indikators im Bereich zwischen +2 und -2 liegt.</font></font><br>
<br>
<pre><code class="plaintext hljs">- alert: RequestRateOutsideNormalRange<font></font>
&nbsp; expr: &gt;<font></font>
 &nbsp; abs(<font></font>
 &nbsp; &nbsp; (<font></font>
 &nbsp; &nbsp; &nbsp; job:http_requests:rate5m - job:http_requests:rate5m_prediction<font></font>
 &nbsp; &nbsp; ) / job:http_requests:rate5m:stddev_over_time_1w<font></font>
 &nbsp; ) &gt; 2<font></font>
&nbsp; for: 10m<font></font>
&nbsp; labels:<font></font>
&nbsp; &nbsp; severity: warning<font></font>
&nbsp; annotations:<font></font>
&nbsp; &nbsp; summary: Requests for job {{ $labels.job }} are outside of expected operating parameters</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In GitLab verwenden wir eine benutzerdefinierte Routing-Regel, die eine Warnung über Slack sendet, wenn Anomalien festgestellt werden, unser Support-Team jedoch nicht kontaktiert.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So erkennen Sie Anomalien in GitLab mit Prometheus</font></font></h2><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prometheus kann verwendet werden, um einige Anomalien zu erkennen.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die richtige Aggregation ist der Schlüssel zum Auffinden von Anomalien.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Z-Scoring ist effektiv, wenn Ihre Daten normal verteilt sind.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die statistische Saisonalität ist ein leistungsfähiger Mechanismus zur Erkennung von Anomalien.</font></font></li>
</ol><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Übersetzt mit Unterstützung von </font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mail.ru Cloud Solutions</font></font></i></a><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font></i><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Immer noch nützlich</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einfache Caching-Methoden in GitLab CI: Ein Bildhandbuch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vorgefertigte und angepasste GitLab CE-Tools auf dem MCS-Marktplatz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unser Telegrammkanal zur digitalen Transformation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de499014/index.html">23 schwierige Fragen für JavaScript-Interviews</a></li>
<li><a href="../de499016/index.html">Integration mit ESIA für .Net: einfacher als es sich anhört</a></li>
<li><a href="../de499018/index.html">6 Heimsport-Apps</a></li>
<li><a href="../de499020/index.html">Eine Studie über ein vages Verhalten</a></li>
<li><a href="../de499030/index.html">Überwachung der MySQL-Leistung für Grafana auf isic in 20 Minuten</a></li>
<li><a href="../de499034/index.html">Wie kann man gefährliches Refactoring einführen, um mit einer Million Benutzern zu arbeiten?</a></li>
<li><a href="../de499036/index.html">Arbeit des Anbieters: eine Auswahl von Materialien zu Protokollen, IT und Netzwerkinfrastruktur</a></li>
<li><a href="../de499038/index.html">Meine Erfahrung mit einem vertikalen Monitor</a></li>
<li><a href="../de499040/index.html">Lesen Sie am Wochenende: Eine Auswahl von Materialien zur Geschichte von DNS, IT-Regulierung und Hardware 1cloud.ru</a></li>
<li><a href="../de499044/index.html">Nachrichten aus der Welt von OpenStreetMap Nr. 508 (04/07/2020/13/04/2020)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>