<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶Ö üèä üí∂ Xiaomi Gateway (eu version - Lumi.gateway.mieu01) Hacked üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ü§òüèæ üßôüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Xiaomi Zigbee Gateway Hack
 
 In this article I want to share with you my best practices and successes in parsing Xiaomi gateway (Version with euro pl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Xiaomi Gateway (eu version - Lumi.gateway.mieu01) Hacked</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/494296/"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xiaomi Zigbee Gateway Hack</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
In this article I want to share with you my best practices and successes in parsing Xiaomi gateway (Version with euro plug with I take.ru). </font><font style="vertical-align: inherit;">I‚Äôll tell you how to install alternative software on it, how to restore a gateway with a wiped software and even revive a gateway with a wiped u-boot. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--------- LOTS OF PICTURES -------------</font></font></b><br>
<br>
<img src="https://habrastorage.org/webt/aa/to/qs/aatoqssn86dgak8fgyoirmaiyae.png"><br>
<a name="habracut"></a><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First of all, I will tell you how to connect to the gateway board and get the root. </font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, some details about the gateway. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This article discusses the version of the gateway built on the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imx6ull</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> processor </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some technical specifications of the board:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wifi RTL8723BS - the driver from it for some reason is loaded separately.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU IMX6ULL</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM 256 mb</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROM 256 mb</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZIgbee module based on JN5169.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the board, service dimes, P2 and P4 are displayed. Ideally, they are made under the pogopins, but they are easier to solder to. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
P2 is Wart 0 of the processor where all the service information is displayed, the uboot bootlog and system management, you can use any usb-uart adapter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
P4 - USB OTG, which is used to upload firmware to nand. (As a full-fledged OTG, until the end I could not start it, when connected, the device is detected, but apparently something else is missing). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ia/zf/wn/iazfwn64giouka5exv5urahv-1w.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Chinese usb adapter board is ideally suited to the nicknames P4. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/na/ty/7a/naty7aswx3muah3ityxjrswxq_s.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After everything is soldered and connected, you first need to get root. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I did according to this instruction </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(link to the manual),</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> but with a little clarification after point 5, you need to type the </font><b><font style="vertical-align: inherit;">boot</font></b><font style="vertical-align: inherit;"> command</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otherwise, the system sits and waits for a command, the instructions were probably written with the hope that everyone understands Linux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For some reason, the SSH server did not turn on according to instructions and was turned on only by manually starting the command to start </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/init.d/dropbear start.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The next step, after receiving the root, I copied the contents of the system using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WinScp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (we select SCP mode when creating the connection). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further on good, you need to backup the full system, in case the experiments lead to sad consequences (as I did, but I didn‚Äôt backup). The </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
flash memory of the gateway is divided into 4 sections. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/lx/kb/qs/lxkbqs0mfj1ggqsaz5hftqbyzpw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As it turned out, there is not a lot of free space either, while in memory there are a lot of different duplicate files.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ci/sl/5m/cisl5mcfvpafxdna0tzjs2w7iko.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After playing for a couple of hours, I changed something in the software and the gateway stopped loading :) </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now, let's figure out how to revive this piece of iron and fill anything with it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perform actions only if you have a brick!</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The Imx6ULL processor contains all information in an open form, all data boards and reference manuals are available on the manufacturer‚Äôs website after registration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
U-boot was still loading at me ... But while I was trying to recover, I accidentally copied an extra command and completely wiped the nand. And u-boot, as it turned out, was in Nanda. And he got a brick. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The processor supports various boot modes. In the reference manual, they are all described.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nu/dq/qb/nudqqbeastlqyzr8ttgb4cpahti.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The development boards usually have switches, but there is nothing like that. The datasheet describes what kind of processor dimes it is. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xb/ca/nx/xbcanxw13rmesy3gosochuueqio.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And then the Chinese made a very nice gift too. They brought them to a very convenient place and almost signed them) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the board next to the processor, two resistors are soldered, where boot-mode pins just fit. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vj/mq/ak/vjmqakv9dquslukw8leus3myyra.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These two resistors are just switches of boot modes, by default it is set to nand, but by moving each of them to the side we get the serial boot mode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I transferred my gateway to the serial boot mode, in some way this mode is more convenient to test various firmware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To upload the firmware, a proprietary utility from NXP mfgtools is used. The only thing in it is to prepare a profile for the processor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Download </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mfgtools</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The archive is already prepared version with all the necessary settings. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We connect the gateway via USB. In serial boot mode, the gateway will try to download the firmware via the USB interface and a new HID device will appear on the computer. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mfgtools, in turn, will inform you that it sees a new device. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xb/dc/hg/xbdchgif-86a8uy3htahr8_xey4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sometimes the computer does not see it, with what it is connected I can not say. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the utility saw it, click Start, and the process of downloading the firmware will begin. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The utility will format the nand, flood the new ubut, kernel, dtb and rootfs. The rootfs in the archive was compiled by a friend Aleksandr Faronov, he put together a clean Linux build on Yocto. The U-boot, Kernel, DTB sections were pulled out of the gateway's native firmware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this Linux assembly, only a clean system will boot, there will be nothing more (</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zigby also does not work yet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the utility works in my case, the gateway will not do anything and load, too, because as we recall the processor in the serial boot mode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, he needs to be given a bootable U-boot image. </font><font style="vertical-align: inherit;">In the archive with mfgtools there is an additional uuu utility that loads U-boot into the board's Ram, let's go to the folder containing it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We close mfgtools and reconnect the gateway with a new one, the HID device should be detected again, then we execute the command.</font></font><br>
<br>
<pre><code class="plaintext hljs">uuu u-boot-small.imx</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The board will start loading, but since it doesn‚Äôt have env, it will get up after loading U-boot. </font><font style="vertical-align: inherit;">In the gateway console, we execute two commands, we register ENV for loading.</font></font><br>
<br>
<pre><code class="plaintext hljs">setenv bootargs 'console=ttymxc0,115200 ubi.mtd=3 root=ubi0:rootfs rootfstype=ubifs cma=96M mtdparts=gpmi-nand:3m(boot),7m(kernel),1m(dtb),-(rootfs)'</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
and start the boot </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">boot</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the gateway starts loading from nanda and from the firmware that we uploaded. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9v/oi/n5/9voin5jgztxajypsqjkol1ki-p0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By and large, that‚Äôs all. </font><font style="vertical-align: inherit;">In mfgtools in the \ Profiles \ Linux \ OS Firmware \ files folder all the firmware files are located, replacing which you can load any compatible system. </font><font style="vertical-align: inherit;">I tried downloading openwrt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wf/qy/ye/wfqyyekyy177yvbh0uczs_aryoq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The system is loading, but I still have not figured out how to slip the right core, and where to get it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I hope by joint efforts we will still bring this gateway to its logical conclusion) </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Backup of the gateway directories</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram for discussion</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en494284/index.html">Homemade antiseptic from what is in the pharmacy. We make alcohol from vodka without a moonshine in the old-fashioned way</a></li>
<li><a href="../en494286/index.html">Embox RTOS on Raspberry Pi</a></li>
<li><a href="../en494290/index.html">#YAMYWork. A decision that may be right</a></li>
<li><a href="../en494292/index.html">Wrike: 5 years with OKR</a></li>
<li><a href="../en494294/index.html">3D printing certified for the oil and gas and marine industries</a></li>
<li><a href="../en494298/index.html">Envoy for the little ones</a></li>
<li><a href="../en494300/index.html">Delegating RDP Session Management</a></li>
<li><a href="../en494302/index.html">Goals of the day as a team management tool</a></li>
<li><a href="../en494304/index.html">30 UX Tips in Augmented Reality</a></li>
<li><a href="../en494306/index.html">No money. Who?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>