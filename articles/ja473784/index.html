<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤘🏽 ⛅️ 🤥 オントロジーネットワークでWebAssemblyのスマートコントラクトを作成する方法 パート2：C ++ ✌🏽 💧 🏐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、Ontologyブロックチェーンネットワークに基づくWASMを使用して、C ++でスマートコントラクトを記述する方法の2つの例を見ていきます。今日、Ontologyはテストモードで数か月の安定した運用を行った後、メインネットワーク上にWASMを立ち上げました。これにより、複雑なビジネス...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>オントロジーネットワークでWebAssemblyのスマートコントラクトを作成する方法 パート2：C ++</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473784/"><img src="https://habrastorage.org/getpro/habr/post_images/3e1/ec5/4dd/3e1ec54ddc0f1d35cad05f7f2b6e600e.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では</font><font style="vertical-align: inherit;">、Ontologyブロックチェーンネットワークに基づく</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WASM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用して、C ++でスマートコントラクトを記述する方法の2つの例を見て</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">いき</font></a><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">今日、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ontology</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はテストモードで数か月の安定した運用を行った後</font><font style="vertical-align: inherit;">、メインネットワーク上に</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">WASM</font></a><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">立ち上げまし</font></a><font style="vertical-align: inherit;">た。これにより、複雑なビジネスロジックを含むdApp契約を簡単かつ低コストでブロックチェーンに転送できるため、dAppエコシステムを大幅に強化できます。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ontology Wasmは、Rust言語でのスマートコントラクトの作成もサポートしてい</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これについては、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">こちらをご覧ください</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、スマートコントラクトの2つの例です。最初に、「Hello world！」と書きます。</font><font style="vertical-align: inherit;">そして、友人に贈り物として送ることができる仮想のお金の封筒を作成します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++を使用したWASMコントラクトの開発</font></font></h2><br>
 <a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例1. Hello World</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hello Worldから始めましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;ontiolib/ontio.hpp&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> ontio;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hello</span>:</span><span class="hljs-keyword">public</span> contract {
   <span class="hljs-keyword">public</span>:
   <span class="hljs-keyword">using</span> contract::contract:
   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sayHello</span><span class="hljs-params">()</span></span>{
       <span class="hljs-built_in">printf</span>(<span class="hljs-string">"hello world!"</span>);<font></font>
   }<font></font>
};<font></font>
ONTIO_DISPATCH(hello, (sayHello)); </code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">契約作成 </font></font></h3><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ontology Wasm CDT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
コンパイラ</font><font style="vertical-align: inherit;">にはエントリポイントと解析パラメータが含まれているため、開発者はインプットメソッドを再定義する必要はありません。</font><font style="vertical-align: inherit;">さらに、サービスのロジックを記述するために、スマートコントラクトのAPIメソッドを呼び出すことができます。</font></font><br>
<br>
<pre><code class="cpp hljs">ONTIO_DISPATCH(hello, (sayHello));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の例では、これまでのところsayHelloのみをサポートしています。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">printf</span>(<span class="hljs-string">"hello world!"</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
"こんにちは世界！" </font><font style="vertical-align: inherit;">デバッグノードログに表示されます。</font><font style="vertical-align: inherit;">スマートコントラクト自体には、より機能的なコマンドが含まれているため、スマートコントラクトを直接記述する場合、printfはデバッグにのみ使用できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スマートコントラクトAPI</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ontology Wasmは、サーバーブロックチェーンとやり取りするために次のAPIを提供します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/d29/dad/66d/d29dad66d40c938e872179cc3487172e.png" alt="画像"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例2：お金の封筒 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、WasmスマートコントラクトAPIを使用したより複雑な例を見てみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、仮想のお金の封筒を作成します。赤い封筒（hongbao）のアナログは、中国のメッセンジャーWechatの人気のある機能であり、チャットで友達にお金を送ることができます。</font><font style="vertical-align: inherit;">ユーザーは赤い封筒の形でメッセージを受け取り、それを開くと、お金が自動的に口座残高に入金されます。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スマートコントラクトの一部として、ユーザーはこのコントラクトを使用して、仮想マネーエンベロープを使用してONT、ONG、またはOEP-4トークンを友達に送信し、友達はトークンをブロックチェーンウォレットに転送できます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">契約作成の準備</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ソースコントラクトファイルを作成し、redEnvelope.cppという名前を付けます。</font><font style="vertical-align: inherit;">次に、このコントラクトには3つのAPIが必要です。</font></font><br>
<br>
<ul>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">createRedEnvelope</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：お金の封筒を作成します</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queryEnvelope</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：エンベロープ情報を要求する</font></font></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClaimEnvelope</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：封筒を開いてお金を受け取る</font></font></li>
</ul><br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;ontiolib/ontio.hpp&gt;</span></span><font></font>
<font></font>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> ontio;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">redEnvlope</span>:</span> <span class="hljs-keyword">public</span> contract{<font></font>
<font></font>
}<font></font>
ONTIO_DISPATCH(redEnvlope, (createRedEnvlope)(queryEnvlope)(claimEnvelope));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、Key-Valueを保存する必要があります。</font><font style="vertical-align: inherit;">スマートコントラクトでは、データはKey-Valueとしてコントラクトのコンテキストに格納され、後続のリクエストのためにKEYデータにプレフィックスを追加する必要があります。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下では、使用する3つのプレフィックスを定義します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> rePrefix = <span class="hljs-string">"RE_PREFIX_"</span>;
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> sentPrefix = <span class="hljs-string">"SENT_COUNT_"</span>;
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> claimPrefix = <span class="hljs-string">"CLAIM_PREFIX_"</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
契約はオントロジートークン-ONTとONGの両方をサポートしているため、事前に契約アドレスを決定できます。</font><font style="vertical-align: inherit;">標準のスマートコントラクトとは異なり、オントロジー自身のコントラクトのアドレスは固定されており、コントラクトコードのハッシュからは派生しません。</font></font><br>
<br>
<pre><code class="cpp hljs">address ONTAddress = {<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>};<font></font>
address ONGAddress = {<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、契約で使用されているトークンに関する情報を保存する必要があります。契約トークンのアドレス、エンベロープの合計金額、およびエンベロープの数です。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">receiveRecord</span>{</span>
       address account;   <span class="hljs-comment">//User address</span>
       asset amount;      <span class="hljs-comment">//Received amount </span><font></font>
       ONTLIB_SERIALIZE(receiveRecord,(account)(amount))<font></font>
   };<font></font>
<font></font>
   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">envlopeStruct</span>{</span>
       address tokenAddress;   <span class="hljs-comment">//Token asset address</span>
       asset totalAmount;      <span class="hljs-comment">//Total amount</span>
       asset totalPackageCount; <span class="hljs-comment">//Total number of red envelope</span>
       asset remainAmount;      <span class="hljs-comment">//Remaining amount</span>
       asset remainPackageCount; <span class="hljs-comment">//Remaining number of red envelope</span>
       <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;struct receiveRecord&gt; records;  <span class="hljs-comment">//Received records</span><font></font>
       ONTLIB_SERIALIZE( envlopeStruct,  (tokenAddress)(totalAmount)(totalPackageCount)(remainAmount)(remainPackageCount)(records) )<font></font>
   };</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、Ontology Wasm CDTによって定義されたマクロ操作であり、データ構造化前のシリアル化に使用されます。</font></font><br>
<br>
<pre><code class="cpp hljs">ONTLIB_SERIALIZE(receiveRecord,(account)(amount))</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">封筒作成</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要な準備が完了したので、APIロジックの開発を開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.お金の封筒を作成するときは、所有者の住所、封筒の数と数量、およびトークンの住所を指定する必要があります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">createRedEnvlope</span><span class="hljs-params">(address owner,asset packcount, asset amount,address tokenAddr )</span></span>{<font></font>
<font></font>
       <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
   }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.所有者の署名を確認します。そうでない場合は、ロールバック（トランザクションをロールバック）して終了します。</font></font><br>
<br>
<pre><code class="cpp hljs">ontio_assert(check_witness(owner),<span class="hljs-string">"checkwitness failed"</span>);</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：ontio_assert（expr、errormsg）：false exprはエラーを返し、契約を終了します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. ONTトークンがエンベロープで使用される場合、ONTは分割されない（少なくとも1つのONT）ことを覚えておくことは重要です。</font><font style="vertical-align: inherit;">次に、各エンベロープに少なくとも1つのONTが存在することを保証するために、マネーエンベロープの合計量はトークンの数以上でなければなりません。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> (isONTToken(tokenAddr)){<font></font>
           ontio_assert(amount &gt;= packcount,<span class="hljs-string">"ont amount should greater than         packcount"</span>);<font></font>
       }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4.次に、エンベロープホルダーに対して、彼が送信するマネーエンベロープの総数を決定します。</font></font><br>
<br>
<pre><code class="cpp hljs">key sentkey = make_key(sentPrefix,owner.tohexstring());<font></font>
asset sentcount = <span class="hljs-number">0</span>;<font></font>
storage_get(sentkey,sentcount);<font></font>
sentcount += <span class="hljs-number">1</span>;<font></font>
storage_put(sentkey,sentcount);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5.エンベロープのハッシュを生成します-このエンベロープをマークする識別子：</font></font><br>
<br>
<pre><code class="cpp hljs">H256 hash ;<font></font>
<font></font>
hash256(make_key(owner,sentcount),hash) ;<font></font>
<font></font>
key rekey = make_key(rePrefix,hash256ToHexstring(hash));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
6.トークンを契約に変換します。</font><font style="vertical-align: inherit;">self_address（）コマンドを使用して現在実行されているコントラクトのアドレスを確認し、トークンのタイプに基づいて、割り当てられた量のトークンをコントラクトに転送します。</font></font><br>
<br>
<pre><code class="cpp hljs">address selfaddr = self_address();
<span class="hljs-keyword">if</span> (isONTToken(tokenAddr)){<font></font>
<font></font>
<span class="hljs-keyword">bool</span> result = ont::transfer(owner,selfaddr ,amount);<font></font>
ontio_assert(result,<span class="hljs-string">"transfer native token failed!"</span>);<font></font>
<font></font>
}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isONGToken(tokenAddr)){<font></font>
<font></font>
<span class="hljs-keyword">bool</span> result = ong::transfer(owner,selfaddr ,amount);<font></font>
ontio_assert(result,<span class="hljs-string">"transfer native token failed!"</span>);<font></font>
}<span class="hljs-keyword">else</span>{
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">char</span>&gt; params = pack(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-string">"transfer"</span>),owner,selfaddr,amount);
<span class="hljs-keyword">bool</span> res;<font></font>
call_contract(tokenAddr,params, res );<font></font>
<font></font>
ontio_assert(res,<span class="hljs-string">"transfer oep4 token failed!"</span>);<font></font>
}<font></font>
</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注1：</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ONTおよびONGの場合、Ontology Wasm CDTはトークン転送用のont :: transfer APIを提供します。 OEP-4トークンは、従来のクロスコントラクト呼び出し方法を使用して送信する必要があります。</font></font><br>
<br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注2：</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常のウォレットアドレスと同様に、契約アドレスはあらゆるタイプのトークンを受け入れることができます。ただし、コントラクトのアドレスはコンパイルされたバイナリハッシュによって生成されるため、対応する秘密キーがなく、コントラクトトークンを使用できません。秘密鍵を設定していない場合、これらのトークンを管理することはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7.契約に関する情報をデータウェアハウスに保存します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">envlopeStruct</span> <span class="hljs-title">es</span> ;</span><font></font>
es.tokenAddress = tokenAddr;<font></font>
es.totalAmount = amount;<font></font>
es.totalPackageCount = packcount;<font></font>
es.remainAmount = amount;<font></font>
es.remainPackageCount = packcount;<font></font>
es.records = {};<font></font>
storage_put(rekey, es);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
8.エンベロープの作成に関する通知を送信します。</font><font style="vertical-align: inherit;">これはスマートコントラクトを呼び出すための非同期プロセスであり、コントラクトは実行結果の通知も送信します。</font><font style="vertical-align: inherit;">実行形式は、契約の作成者が決定できます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">char</span> buffer [<span class="hljs-number">100</span>];
<span class="hljs-built_in">sprintf</span>(buffer, <span class="hljs-string">"{\"states\":[\"%s\", \"%s\", \"%s\"]}"</span>,<span class="hljs-string">"createEnvlope"</span>,owner.tohexstring().c_str(),hash256ToHexstring(hash).c_str());<font></font>
notify(buffer);<font></font>
<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
やった、お金の封筒はほぼ準備ができています。</font><font style="vertical-align: inherit;">エンベロープ情報をリクエストする方法を見てみましょう。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリエンベロープ（クエリ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストのロジックは非常にシンプルで、データストアから情報とフォーマットを取得して出力するだけです。 </font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title">queryEnvlope</span><span class="hljs-params">(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> hash)</span></span>{<font></font>
key rekey = make_key(rePrefix,hash);<font></font>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">envlopeStruct</span> <span class="hljs-title">es</span>;</span><font></font>
storage_get(rekey,es);<font></font>
<span class="hljs-keyword">return</span> formatEnvlope(es);<font></font>
}</code></pre><br>
<u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注：</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読み取り専用のスマートコントラクト操作（クエリなど）の場合は、事前実行を通じて結果を確認できます。</font><font style="vertical-align: inherit;">通常の契約コールとは異なり、プレエグゼクティブはウォレットの署名を必要としないため、ONGでの手数料は必要ありません。</font><font style="vertical-align: inherit;">これにより、エンベロープハッシュ（エンベロープID）を持っている他のユーザーは、エンベロープのふりをすることができます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">封筒を受け取る</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階で、トークンはスマートコントラクトに既に正常に転送されているため、友達がエンベロープで共有を正常に要求できるようにするには、エンベロープ識別子（ハッシュ）を送信する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.封筒を受け取るには、アカウントのアドレスと封筒のハッシュを入力する必要があります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">claimEnvlope</span><span class="hljs-params">(address account, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> hash)</span></span>{
<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.次に、契約でアカウントの署名が検証され、所有者であることを確認します。</font><font style="vertical-align: inherit;">各アカウントはエンベロープを1回だけ申請できます。</font></font><br>
<br>
<pre><code class="cpp hljs">ontio_assert(check_witness(account),<span class="hljs-string">"checkwitness failed"</span>);<font></font>
key claimkey = make_key(claimPrefix,hash,account);<font></font>
asset claimed = <span class="hljs-number">0</span> ;<font></font>
storage_get(claimkey,claimed);<font></font>
ontio_assert(claimed == <span class="hljs-number">0</span>,<span class="hljs-string">"you have claimed this envlope!"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.ストアから受信したハッシュ情報に従ってエンベロープが受信されたかどうかを確認します。</font></font><br>
<br>
<pre><code class="cpp hljs">key rekey = make_key(rePrefix,hash);
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">envlopeStruct</span> <span class="hljs-title">es</span>;</span><font></font>
storage_get(rekey,es);<font></font>
ontio_assert(es.remainAmount &gt; <span class="hljs-number">0</span>, <span class="hljs-string">"the envlope has been claimed over!"</span>);<font></font>
ontio_assert(es.remainPackageCount &gt; <span class="hljs-number">0</span>, <span class="hljs-string">"the envlope has been claimed over!"</span>);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4.請求レコードを作成します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">receiveRecord</span> <span class="hljs-title">record</span> ;</span><font></font>
record.account = account;<font></font>
asset claimAmount = <span class="hljs-number">0</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5.各封筒申請者の金額の計算。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の参加者については、残高の金額が決定され、それ以外の場合は、宣言された金額は、現在のブロックのハッシュとエンベロープに関する現在の情報によって計算された乱数によって決定されます。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> (es.remainPackageCount == <span class="hljs-number">1</span>){<font></font>
claimAmount = es.remainAmount;<font></font>
record.amount = claimAmount;<font></font>
}<span class="hljs-keyword">else</span>{<font></font>
H256 random = current_blockhash() ;<font></font>
<span class="hljs-keyword">char</span> part[<span class="hljs-number">8</span>];
<span class="hljs-built_in">memcpy</span>(part,&amp;random,<span class="hljs-number">8</span>);
<span class="hljs-keyword">uint64_t</span> random_num = *(<span class="hljs-keyword">uint64_t</span>*)part;
<span class="hljs-keyword">uint32_t</span> percent = random_num % <span class="hljs-number">100</span> + <span class="hljs-number">1</span>;<font></font>
claimAmount = es.remainAmount * percent / <span class="hljs-number">100</span>;
<span class="hljs-comment">//ont case</span>
<span class="hljs-keyword">if</span> (claimAmount == <span class="hljs-number">0</span>){<font></font>
claimAmount = <span class="hljs-number">1</span>;<font></font>
}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(isONTToken(es.tokenAddress)){
<span class="hljs-keyword">if</span> ( (es.remainAmount - claimAmount) &lt; (es.remainPackageCount - <span class="hljs-number">1</span>)){<font></font>
claimAmount = es.remainAmount - es.remainPackageCount + <span class="hljs-number">1</span>;<font></font>
}<font></font>
}<font></font>
record.amount = claimAmount;<font></font>
}<font></font>
es.remainAmount -= claimAmount;<font></font>
es.remainPackageCount -= <span class="hljs-number">1</span>;<font></font>
es.records.push_back(record);</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.資金のクレジット</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トークンの対応する量は、計算結果に従ってエンベロープ申請者のアカウントに転送されます。</font></font><br>
<br>
<pre><code class="cpp hljs">address selfaddr = self_address();
<span class="hljs-keyword">if</span> (isONTToken(es.tokenAddress)){
<span class="hljs-keyword">bool</span> result = ont::transfer(selfaddr,account ,claimAmount);<font></font>
ontio_assert(result,<span class="hljs-string">"transfer ont token failed!"</span>);<font></font>
} <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span> (isONGToken(es.tokenAddress)){
<span class="hljs-keyword">bool</span> result = ong::transfer(selfaddr,account ,claimAmount);<font></font>
ontio_assert(result,<span class="hljs-string">"transfer ong token failed!"</span>);<font></font>
} <span class="hljs-keyword">else</span>{
<span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">char</span>&gt; params = pack(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-string">"transfer"</span>),selfaddr,account,claimAmount);
<span class="hljs-keyword">bool</span> res = <span class="hljs-literal">false</span>;<font></font>
call_contract(es.tokenAddress,params, res );<font></font>
ontio_assert(res,<span class="hljs-string">"transfer oep4 token failed!"</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
7.資金の受領に関する情報と保管庫の封筒に関する更新情報を書き留め、契約の履行に関する通知を送信します。</font></font><br>
<br>
<pre><code class="cpp hljs">storage_put(claimkey,claimAmount);<font></font>
       storage_put(rekey,es);<font></font>
       <span class="hljs-keyword">char</span> buffer [<span class="hljs-number">100</span>];       
       <span class="hljs-built_in">std</span>::<span class="hljs-built_in">sprintf</span>(buffer, <span class="hljs-string">"{\"states\":[\"%s\",\"%s\",\"%s\",\"%lld\"]}"</span>,<span class="hljs-string">"claimEnvlope"</span>,hash.c_str(),account.tohexstring().c_str(),claimAmount);<font></font>
<font></font>
       notify(buffer);<font></font>
       <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のように、このコントラクトは、claimEnvelope APIを介してコントラクトからトークンを送信できます。</font><font style="vertical-align: inherit;">必要な要件を満たさずに資産を引き出すことはできないため、これにより、トークンがエンベロープ内にあるときにトークンのセキュリティが確保されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
できた！</font><font style="vertical-align: inherit;">最初のスマートコントラクトを作成しました。</font><font style="vertical-align: inherit;">完全な契約コードは、GitHubの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">契約テスト </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
契約を確認するには2つの方法があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">CLIを</font></a><font style="vertical-align: inherit;">使用する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a></li>
<li><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Golang SDKを</font></a><font style="vertical-align: inherit;">使用する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、ブロックチェーンAPIを使用してOntolgy Wasmのスマートコントラクトを作成する方法について説明しました。</font><font style="vertical-align: inherit;">プライバシーの問題を解決してスマートコントラクトを本格的な製品に変えることは、まだ残っています。</font><font style="vertical-align: inherit;">コードのこの段階では、誰でも契約の記録を追跡することで赤い封筒のハッシュを取得できます。つまり、誰でも封筒の共有を要求できます。</font><font style="vertical-align: inherit;">この問題は簡単に解決できます。エンベロープの作成時に適用できるアカウントのリストを定義します。</font><font style="vertical-align: inherit;">必要に応じて、この機能もテストできます。</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">20,000ドルからdApp開発のオントロジー</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">助成金</font></a><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">取得する</font></a><font style="vertical-align: inherit;">学生</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">向けの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オントロジータレントプログラムに</font><font style="vertical-align: inherit;">申し込む</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたは開発者ですか？</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Discordの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">技術コミュニティに参加してください</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">さらに、</font><font style="vertical-align: inherit;">弊社のWebサイトの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デベロッパーセンター</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をご覧ください。デベロッパーツールやドキュメントなどを見つけることができます。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オントロジー</font></font></h4><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オントロジーのウェブサイト</font></font></a> </li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不和</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">電報</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">英語</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロシア語</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Twitter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> / </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reddit</font></font></a></li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja473770/index.html">大量のPythonコードの静的分析：Instagramの経験。パート2</a></li>
<li><a href="../ja473774/index.html">DFクラウド上のセキュアクラウド </a></li>
<li><a href="../ja473776/index.html">Aspコア+ VueJSの例による検証ルールの統合</a></li>
<li><a href="../ja473778/index.html">画像の最適化：GoogleのビジョンAIを使用して画像のランキング原則を理解する方法</a></li>
<li><a href="../ja473780/index.html">4Kビデオでの高速輪郭検出：色と複雑な形状</a></li>
<li><a href="../ja473786/index.html">リガでのハッカソンの登録は終了しています。賞-PhysTechでの短期トレーニング</a></li>
<li><a href="../ja473788/index.html">マイクロタンパク質が現代生物学の未知の側面を発見</a></li>
<li><a href="../ja473790/index.html">3Dグラフィックのスプライン、最も自動化されたオプション</a></li>
<li><a href="../ja473794/index.html">モバイルフィッシング-無限の脅威</a></li>
<li><a href="../ja473796/index.html">光HDMIエクステンダー。300メートル</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>