<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏼‍🏭 ⚓️ 🙅🏿 思慮深いクエリ：PWAキャッシュ戦略 👨🏾‍🤝‍👨🏻 🧀 ⛹🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="むかしむかし、キャッシングでは、ブラウザーに大きく依存していました。当時の開発者はこれにほとんど影響を与えませんでした。しかし、その後、プログレッシブウェブアプリケーション（プログレッシブウェブアプリ、PWA）、サービスワーカー、キャッシュAPIが登場しました。突然、プログラマーには幅広い権限があり...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>思慮深いクエリ：PWAキャッシュ戦略</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/478326/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">むかしむかし、キャッシングでは、ブラウザーに大きく依存していました。当時の開発者はこれにほとんど影響を与えませんでした。しかし、その後、プログレッシブウェブアプリケーション（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プログレッシブウェブアプリ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、PWA）、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスワーカー</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャッシュAPIが登場しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。突然、プログラマーには幅広い権限があり、何がキャッシュに入るのか、そしてどのようにキャッシュに入るのかを制御できることがわかりました。これで、必要なすべてをキャッシュできるようになりました...これが潜在的な問題の原因です。</font><font style="vertical-align: inherit;">
メディアファイル、特に画像は、最近</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://"><font style="vertical-align: inherit;">の</font></a><font style="vertical-align: inherit;">典型的なWebページの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://"><font style="vertical-align: inherit;">サイズの</font></a><font style="vertical-align: inherit;">主要コンポーネントです</font><font style="vertical-align: inherit;">。時間とともに、状況は</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://"><font style="vertical-align: inherit;">悪化する</font></a><font style="vertical-align: inherit;">だけです</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/44/th/2i/44th2idptstxbm0yjtptkzk31pe.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=https://"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ページのパフォーマンスを向上させるために、できるだけ多くのデータをキャッシュするようにしています。しかし、それは価値がありますか？ほとんどの場合-それだけの価値はありません。これらすべての新しいテクノロジーを自由に使えるようになったことを考慮しても、Webページの高いパフォーマンスを実現するには、1つの単純なルールに従う必要があります。それは、すべての要求への応答で可能な限り</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少ない</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ</font><font style="vertical-align: inherit;">が確実に送られるようにする一方で、必要なものだけを必要とするものをサーバーに要求するという事実にあり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、私たちのプロジェクトが訪問者にポジティブな感情だけを引き起こすように努めています。</font><font style="vertical-align: inherit;">同時に、ネットワーク接続やユーザーのハードドライブに過負荷をかけたくありません。</font><font style="vertical-align: inherit;">これは、いくつかの古典的な実用的なトリックを提供し、メディアキャッシング戦略を試し、Service Workerの袖に隠されているCache APIのトリックを学ぶ時が来たことを意味します。</font></font><br>
<a name="habracut"></a><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">善意</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
低速モデム接続用にWebページを最適化するという非常に前に学んだことすべてが、Webへのモバイルアクセスの開発により、今日非常に重要になっています。これらすべてが、世界中の聴衆を対象に設計された現代のプロジェクトでの作業の価値を失わない。信頼性の低いネットワーク、または大きな遅延のあるネットワークは、地球の多くの部分で、依然として標準です。これは、高度な技術が導入されている場所の監視に基づいて作成されたネットワークの品質レベルに関する仮定に自信を持って頼ることができないことを忘れないようにするのに役立ちます。これは、生産性を最適化するための推奨アプローチにも当てはまります。今日、生産性の向上に役立つアプローチでは、将来的に価値が失われないことが歴史で確認されています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Service Workerが登場する前に、ブラウザーが</font><font style="vertical-align: inherit;">特定のリソースをキャッシュに保存する期間について</font><font style="vertical-align: inherit;">いくつかの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ガイダンス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">与えることができました</font><font style="vertical-align: inherit;">が、これがおそらくキャッシュへの唯一の影響でした。</font><font style="vertical-align: inherit;">ユーザーのコンピューターにダウンロードされたドキュメントとリソースは、ハードドライブ上のディレクトリに配置されました。</font><font style="vertical-align: inherit;">ブラウザがドキュメントまたはリソースのリクエストを準備するとき、ブラウザはまずキャッシュを調べて、すでに必要なものがあるかどうかを確認しました。</font><font style="vertical-align: inherit;">また、ブラウザに必要なものがすでにキャッシュにある場合、ブラウザはネットワークを再びロードしない可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今日では、ネットワークリクエストを制御し、キャッシュを大幅に改善できます。</font><font style="vertical-align: inherit;">しかし、これによって、どのリソースがWebページの一部であるかについての責任が軽減されるわけではありません。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サーバーから必要なものだけを要求する</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私が言ったように、現代のウェブはメディアでいっぱいです。画像や動画ファイルは、主要なコミュニケーション手段となっています。商業サイトについて話している場合、彼らは売上を増やすことができますが、資料のダウンロード速度と出力ページの速度について話す場合、それらの数が多いほど悪いです。このことを念頭に置いて、ページ上の場所を証明する前に、すべての画像（およびすべてのビデオなど）がこの場所の必要性を証明できるように努力する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数年前、私の料理のレシピは料理に関する新聞記事に含まれていました。私はその新聞の印刷版を購読していなかったので、記事が出たとき、私はその記事を見てサイトに行きました。サイトの作成者は最近それを再設計しました。次に、すべての記事をモーダルウィンドウに読み込むことにしました。モーダルウィンドウは、ほぼ画面全体に表示され、メインページの上に配置されていました。つまり、記事をダウンロードするには、記事のページを表示するために必要なすべてと、リソースのホームページを形成するために必要なすべてをダウンロードする必要がありました。そしてホームページにはビデオ広告がありました。そして、1つではありません。そしてもちろん、それは自動的に始まりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのサイトにアクセスしたところ、デベロッパーのツールを開いたところ、ページサイズが15 MBを超えていることがわかりました。次に、プロジェクトの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイトの費用はいくらですか？</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。さまざまな国のモバイルネットワークでサイトを使用するのにかかる費用を調べることができます。このプロジェクトで新聞のウェブサイトをチェックすることにしました。米国の平均的なユーザーがこのサイトを閲覧する実際のコストは、紙の新聞の1号のコストを上回っています。一言で言えば-混乱。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、サイトの作成者が読者に不快感を与えているという事実を批判することはできますが、現実はこれです。リソースを操作するユーザーエクスペリエンスを悪化させるために作業する人は誰もいません。同様のことが、どのWebサイト開発者にも起こり得ます。ページのパフォーマンスを最適化するために長い日を費やすことができ、経営陣はこのきちんと作成されたページがビデオ広告でいっぱいの別のページの上に表示されることを決定します。非常に不十分に最適化された2つのページが互いに積み重ねられた場合、どれほど事態が悪化するか想像してみてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画像や動画は、さまざまな素材が互いに競合している状況（新聞のホームページなど）で特定の素材に訪問者を引き付けるのに役立ちます。ただし、訪問者に1つのこと（たとえば、選択した記事を読む）を落ち着いて熱心に行わせたい場合、メディア資料の価値は、「非常に重要」から「害を及ぼさない」のレベルまで下がります。はい、研究は画像が注目を集めるのに非常に優れていることを示していますが、訪問者が特定のページに到達した後、それらはすでに</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それほど重要ではないことが判明しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。画像はページの読み込み時間を長くし、サイトへのアクセスを増やすだけです。また、ページに追加されるメディアが増えると、状況は悪化します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトのページサイズを縮小するために、私たちはあらゆる力を尽くす必要があります。</font><font style="vertical-align: inherit;">つまり、ページに価値をもたらさないものすべてのダウンロードを拒否する必要があります。</font><font style="vertical-align: inherit;">たとえば、データ漏えいに関する記事を書いている場合は</font><font style="vertical-align: inherit;">、フード付きのジャケットに身を包んだ誰かが非常に暗い部屋のコンピュータに座って</font><font style="vertical-align: inherit;">いる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">興味深い写真</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をその</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">写真</font></a><font style="vertical-align: inherit;">に含める誘惑に抵抗し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あなたに合った最小のファイルをサーバーからリクエストする</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事で絶対に必要な画像をピックアップするとします。</font><font style="vertical-align: inherit;">ここで、1つの非常に重要な質問をする必要があります。「この画像をユーザーに配信する最も速い方法は何ですか？」</font><font style="vertical-align: inherit;">この質問に対する答えは、非常に単純な場合も非常に複雑な場合もあります。</font><font style="vertical-align: inherit;">簡単な答えは、最も適切な</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">グラフィック形式</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を選択すること</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">です</font></a><font style="vertical-align: inherit;">（そして、最終的にユーザーに送信するものを慎重に最適化します）。</font><font style="vertical-align: inherit;">難しい答えは、新しい形式で画像を完全に再作成することです（たとえば、ラスター形式をベクターに変更することが最も効果的なソリューションである場合）。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">browserブラウザに代替ファイル形式を提供する</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画像形式に関しては、さまざまなブラウザーでのページパフォーマンスと画像の可用性の間の妥協点を見つける必要がなくなりました。イメージをさまざまなバージョンで準備し、それらをブラウザーに通知して、使用するものを決定させることができます。このような決定は、ブラウザーの機能に基づいて行われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タグ</font></font><code>picture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または</font></font><code>video</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">複数のアイテム</font><font style="vertical-align: inherit;">を使用してこれを行うことができ</font><font style="vertical-align: inherit;">ます</font></font><code>source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このような作業は、さまざまなメディアリソースオプションの作成から始まります。たとえば、同じ画像がWebPおよびJPG形式で保存されます。 WebP画像がJPG画像よりも小さくなる可能性は非常に高いです（これはおそらく言えませんが、そのようなことを自分で確認する必要があります）。代替リソースオプションを準備したら、それらへのパスを要素に配置できます</font></font><code>picture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="javascript hljs">&lt;picture&gt;
&nbsp;&nbsp;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"my.webp"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span>&gt;</span>
&nbsp;&nbsp;<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">align</span>=<span class="hljs-string">"center"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"my.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"Descriptive text about the picture."</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アイテムを認識するブラウザは、</font><font style="vertical-align: inherit;">リクエストするイメージを決定する前に</font><font style="vertical-align: inherit;">アイテム</font></font><code>picture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をチェックします</font></font><code>source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ブラウザがMIMEタイプをサポートしている場合、</font></font><code>"image/webp"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebP画像を受信するためのリクエストが実行されます。そうでない場合（またはブラウザが要素について知らない場合</font></font><code>picture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、通常のJPG画像が要求されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチは、JavaScriptを使用せずに、比較的小さなサイズの最適化された画像をユーザーに提供できるという点で優れています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ビデオファイルでも同じことができます：</font></font><br>
<br>
<pre><code class="javascript hljs">&lt;video controls&gt;
&nbsp;&nbsp;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"my.webm"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/webm"</span>&gt;</span>
&nbsp;&nbsp;<span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"my.mp4"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video/mp4"</span>&gt;</span>
&nbsp;&nbsp;<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Your browser doesn’t support native video playback,
&nbsp;&nbsp;&nbsp;&nbsp;but you can <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"my.mp4"</span> <span class="hljs-attr">download</span>&gt;</span>download<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;this video instead.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WebM形式をサポートするブラウザは、最初の要素にあるものをダウンロードします</font></font><code>source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 WebMがサポートしていないがMP4形式を理解しているブラウザーは、そのような2番目の要素からビデオを要求します。また、タグ</font></font><code>video</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">サポートしていないブラウザは</font><font style="vertical-align: inherit;">、対応するファイルをダウンロードできることをユーザーに伝えるテキスト行を表示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要素の順序は</font></font><code>source</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要です。ブラウザは、</font><font style="vertical-align: inherit;">使用できる</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の要素を</font><font style="vertical-align: inherit;">選択します</font><font style="vertical-align: inherit;">。したがって、互換性の高いオプションの後に画像リンクの最適化された代替バージョンを配置すると、ブラウザがこの最適化されたバージョンをロードしなくなる可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトの機能によっては、このレイアウトベースのアプローチは適さない場合があり、サーバーでのこのような処理の方が適していると判断する場合があります。</font><font style="vertical-align: inherit;">たとえば、JPGファイルが要求されたが、ブラウザがWebP形式をサポートしている場合（ヘッダーに示されているとおり</font></font><code>Accept</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、画像のWebPバージョンでこの要求に応答することを妨げるものはありません。</font><font style="vertical-align: inherit;">実際、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cloudinary</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">などの一部のCDNサービスは、そのままの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">状態</font></a><font style="vertical-align: inherit;">でそのような機能をサポートしています。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">differentブラウザにさまざまなサイズの画像を提供する</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画像を保存するためにさまざまなグラフィック形式を使用することに加えて、開発者はブラウザウィンドウのサイズに基づいて最適化されたさまざまなサイズの画像の使用を提供できます。</font><font style="vertical-align: inherit;">結局、高さまたは幅がこの画像を表示するユーザーに表示されるブラウザウィンドウより3〜4倍大きい画像をアップロードしても意味がありません。</font><font style="vertical-align: inherit;">これは帯域幅の浪費です。</font><font style="vertical-align: inherit;">そしてここでは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レスポンシブな画像</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が役に立ち</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例を考えてみましょう：</font></font><br>
<br>
<pre><code class="javascript hljs">&lt;img align=<span class="hljs-string">"center"</span> src=<span class="hljs-string">"medium.jpg"</span>
&nbsp;&nbsp;srcset=<span class="hljs-string">"small.jpg 256w,
&nbsp;&nbsp;&nbsp;&nbsp;medium.jpg 512w,
&nbsp;&nbsp;&nbsp;&nbsp;large.jpg 1024w"</span>
&nbsp;&nbsp;sizes=<span class="hljs-string">"(min-width: 30em) 30em, 100vw"</span>
&nbsp;&nbsp;alt=<span class="hljs-string">"Descriptive text about the picture."</span>&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この「チャージされた」要素</font></font><code>img</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">では、多くの興味深いことが起こっています。</font><font style="vertical-align: inherit;">それについていくつかの詳細を見てみましょう：</font></font><br>
<br>
<ul>
<li>  <code>img</code>      JPG-: 256    (<code>small.jpg</code>), 512    (<code>medium.jpg</code>)  1024    (<code>large.jpg</code>).        <code>srcset</code>.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>.</li>
<li> <code>src</code>   ,   .        ,   <code>srcset</code>.  ,   , ,        ,      .     ,   ,    ,            ,  , ,     .</li>
<li> <code>sizes</code> —  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="> </a>,     ,         (  — <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">  </a>)   CSS.    ,         (<code>100vw</code>)   ,     <code>30 em</code>   (<code>min-width: 30em</code>),       <code>30 em</code>.  <code>sizes</code>    ,       —     .     —       ,  <code>100vw</code>.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチを、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さまざまな</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像形式の</font><font style="vertical-align: inherit;">選択</font><font style="vertical-align: inherit;">や、1つの要素でトリミングするためのさまざまなオプションと</font><font style="vertical-align: inherit;">組み合わせることができ</font><font style="vertical-align: inherit;">ます</font></font><code>picture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このストーリーの主なポイントは、ユーザーが必要とするメディアファイルを正確にユーザーにすばやく配信できるようにするためのツールがたくさんあることです。</font><font style="vertical-align: inherit;">これらのツールを使用することをお勧めします。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クエリの実行を延期する（可能な場合）</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
むかしむかし、Internet Explorerは、開発者が</font></font><code>img</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ページ出力を高速化するために</font><font style="vertical-align: inherit;">特定の要素の優先順位を下げることを可能にする新しい属性のサポートを導入しました</font><font style="vertical-align: inherit;">。これが属性です</font></font><code>lazyload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。この属性は一般に受け入れられた標準にはなりませんでしたが、JavaScriptを使用せずに、ページの表示領域（またはそのような領域の近く）に画像が読み込まれるまでの遅延を整理するための価値のある試みでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それ以来、無数の画像読み込みシステムのJavaScript実装が無数に登場しましたが、Googleは最近、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loading</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性を導入することにより、より宣言的なアプローチを使用してこれを実装しようとしました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
属性には、</font></font><code>loading</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（3つの値をサポートし</font></font><code>auto</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>lazy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そして</font></font><code>eager</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、対応するリソースの処理方法を定義します。私たちにとって</font></font><code>lazy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、この</font><font style="vertical-align: inherit;">値は</font><font style="vertical-align: inherit;">リソースの読み込みを</font><font style="vertical-align: inherit;">表示領域から</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定の距離</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に到達するまで延期できるため、</font><font style="vertical-align: inherit;">最も興味深いよう</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">見え</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この属性を既存のものに追加します。</font></font><br>
<br>
<pre><code class="javascript hljs">&lt;img align=<span class="hljs-string">"center"</span> src=<span class="hljs-string">"medium.jpg"</span>
&nbsp;&nbsp;srcset=<span class="hljs-string">"small.jpg 256w,
&nbsp;&nbsp;&nbsp;&nbsp;medium.jpg 512w,
&nbsp;&nbsp;&nbsp;&nbsp;large.jpg 1024w"</span>
&nbsp;&nbsp;sizes=<span class="hljs-string">"(min-width: 30em) 30em, 100vw"</span>
&nbsp;&nbsp;loading=<span class="hljs-string">"lazy"</span>
&nbsp;&nbsp;alt=<span class="hljs-string">"Descriptive text about the picture."</span>&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この属性を使用すると、Chromiumベースのブラウザでのページパフォーマンスがある程度向上します。</font><font style="vertical-align: inherit;">うまくいけば、それはウェブ標準にまで落ち込み、他のブラウザにも現れるでしょう。</font><font style="vertical-align: inherit;">ただし、これが発生するまでは、特定の属性を理解しないブラウザは単にそれを無視するため、その使用による害はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチはメディアダウンロードの優先順位付けの戦略を完全に補完しますが、これについて説明する前に、サービスワーカーを詳しく検討することをお勧めします。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスワーカーの管理を要求します。</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Service </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は特別なタイプの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Web Worker</font></a><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">彼らは、使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">APIを取得</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、インターセプトする能力を持っているし、すべてのネットワーク要求を変更するだけでなく、要求に応答します。</font><font style="vertical-align: inherit;">また</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、Cache API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および他の非同期クライアントデータストア（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IndexedDB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">など）に</font><font style="vertical-align: inherit;">もアクセスできます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">IndexedDBは、たとえばリソースストアとして使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Service Workerがインストールされると、このイベントをインターセプトして、後で必要になる可能性があるリソースを事前にキャッシュに追加できます。</font><font style="vertical-align: inherit;">多くの人がこの機会を利用して、スタイル、スクリプト、ロゴなどのグローバルリソースのコピーを用意します。</font><font style="vertical-align: inherit;">ただし、ネットワーク要求が失敗した場合に使用するために、キャッシュにイメージをプリロードすることができます。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍念のため、バックアップ画像をキャッシュに保存してください</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特殊なケースで使用されるイメージの特定のバックアップバージョンがさまざまなネットワークシナリオで使用されるという想定に基づいて、対応するリソースを返す名前付き関数を作成できます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">respondWithFallbackImage</span>(<span class="hljs-params"></span>) </span>{
&nbsp;&nbsp;<span class="hljs-keyword">return</span> caches.match( <span class="hljs-string">"/i/fallbacks/offline.svg"</span> );<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フェッチイベントハンドラーで</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、この関数を使用して、通常のイメージのリクエストが機能しない場合にスペアイメージを発行できます。</font></font><br>
<br>
<pre><code class="javascript hljs">self.addEventListener( <span class="hljs-string">"fetch"</span>, event =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> request = event.request;
&nbsp;&nbsp;<span class="hljs-keyword">if</span> ( request.headers.get(<span class="hljs-string">"Accept"</span>).includes(<span class="hljs-string">"image"</span>) ) {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;event.respondWith(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> fetch( request, { <span class="hljs-attr">mode</span>: <span class="hljs-string">'no-cors'</span> } )<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.then( <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> response;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.catch(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;respondWithFallbackImage<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;);<font></font>
&nbsp;&nbsp;}<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークが利用可能な場合、すべてが期待どおりに機能します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f76/945/a06/f76945a06071194fa4201bccd345c658.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークが利用可能な</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
場合、</font><i><font color="#999999"><font style="vertical-align: inherit;">期待どおりにアバターが表示されますが</font></font></i><font style="vertical-align: inherit;">、ネットワーク接続が切断されると、画像は自動的に予備の画像に置き換えられます。</font><font style="vertical-align: inherit;">ただし、ページはまだ多かれ少なかれ許容できるように見えます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f8e/ce6/1df/f8ece61df76bfd70ed0345357649fad9.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークが利用できない場合にアバターの代わりに表示されるユニバーサルフォールバック画像</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
一見すると、パフォーマンスの面では、このアプローチはそれほど一般的ではないかもしれません。通常の画像に加えて、ブラウザーもフォールバックをロードする必要があるためです。</font><font style="vertical-align: inherit;">しかし、すべてがそのように配置されている場合、いくつかの非常に興味深い可能性が開発者の前に開かれます。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">userトラフィックの節約に対するユーザーの要望を尊重する</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一部のユーザーは、トラフィックの消費を抑えようとする場合、「軽量」ブラウザモードを使用するか、「データ保存」または「トラフィック保存」と呼ばれる設定を有効にします。</font><font style="vertical-align: inherit;">これが発生すると、ブラウザーはリクエストで</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Save-Data</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘッダーを送信することがよくあり</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Service Workerでは、このヘッダーの存在をリクエストで確認し、それに応じてリクエストへの応答を調整できます。</font><font style="vertical-align: inherit;">したがって、最初にヘッダーを確認します。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">let</span> save_data = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">if</span> ( <span class="hljs-string">'connection'</span> <span class="hljs-keyword">in</span> navigator ) {<font></font>
&nbsp;&nbsp;save_data = navigator.connection.saveData;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><code>fetch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像の</font><font style="vertical-align: inherit;">処理を</font><font style="vertical-align: inherit;">担当</font><font style="vertical-align: inherit;">するプロセッサで</font><font style="vertical-align: inherit;">、対応する要求をネットワークに送信する必要がないと判断できます。</font><font style="vertical-align: inherit;">代わりに、バックアップイメージをキャッシュからブラウザに渡すことで、それに応答できます。</font></font><br>
<br>
<pre><code class="javascript hljs">self.addEventListener( <span class="hljs-string">"fetch"</span>, event =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">const</span> request = event.request;
&nbsp;&nbsp;<span class="hljs-keyword">if</span> ( request.headers.get(<span class="hljs-string">"Accept"</span>).includes(<span class="hljs-string">"image"</span>) ) {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;event.respondWith(<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> ( save_data ) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> respondWithFallbackImage();<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">// ,    </span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;);<font></font>
&nbsp;&nbsp;}<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは</font></font><code>respondWithFallbackImage()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、元のリクエストの内容に応じて異なる画像を生成するよう</font><font style="vertical-align: inherit;">に関数を設定することで、さらに先に進むことができます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これを行うには、Service Workerのグローバルレベルでいくつかのバックアップイメージを定義できます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> fallback_avatar = <span class="hljs-string">"/i/fallbacks/avatar.svg"</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fallback_image = <span class="hljs-string">"/i/fallbacks/image.svg"</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、Service Workerのインストールイベントを処理するときに、これらのファイルの両方をキャッシュする必要があります。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">return</span> cache.addAll( [<font></font>
&nbsp;&nbsp;fallback_avatar,<font></font>
&nbsp;&nbsp;fallback_image<font></font>
]);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、</font></font><code>respondWithFallbackImage()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースのロードに使用されるURLを分析することにより、適切な画像を表示できます。</font><font style="vertical-align: inherit;">たとえば、私のサイトでは、アバターは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">webmention.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からダウンロードされ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その結果、関数で次のチェックが実行されます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">respondWithFallbackImage</span>(<span class="hljs-params"> url </span>) </span>{
&nbsp;&nbsp;<span class="hljs-keyword">const</span> image = avatars.test( <span class="hljs-regexp">/webmention\.io/</span> ) ? fallback_avatar<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: fallback_image;<font></font>
&nbsp;&nbsp;<span class="hljs-keyword">return</span> caches.match( image );<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この変更をコードに加えたら、ハンドラーを更新して</font></font><code>fetch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、関数を呼び出すときに</font></font><code>respondWithFallbackImage()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引数が渡されるように</font><font style="vertical-align: inherit;">する必要があり</font><font style="vertical-align: inherit;">ます</font></font><code>request.url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これが完了したら、イメージのダウンロード要求を中断すると、次の図のようなものが表示されます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13e/0dc/def/13e0dcdefc89eb05be75c7a3d716fd3d.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webmentionリソースから通常の条件でダウンロードされたアバターと画像は、リクエストにSave-Dataヘッダーが含まれている場合、2つの異なる画像に置き換えられます。</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
次に、メディアリソースの操作に関する一般的なルールを作成する必要があります。</font><font style="vertical-align: inherit;">もちろん、これらのルールの適用は状況によって異なります。</font></font><br>
<br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">▍キャッシュ戦略：特定のメディアリソースの優先順位付け</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
経験から、Web上のメディアリソース、特に画像は3つのカテゴリのいずれかに分類される傾向があることがわかります。これらのカテゴリは、それらに含まれる画像がプロジェクトの正しい操作を保証する上で異なる値を持っているという事実によって区別されます。スペクトルの一端には、プロジェクトに付加価値を与えない要素があります。反対側には、確かに価値のある重要なリソースがあります。たとえば、これらはグラフであり、それがなければ特定のテキストを理解することは不可能です。真ん中のどこかに、いわば「傷つかない」リソースがあります。これらはプロジェクトに付加価値をもたらしますが、その内容を理解するために不可欠とは言えません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この分類を考慮に入れてグラフィックリソースを検討すると、さまざまな状況でこれらの各タイプのリソースを操作するための、ある種の一般的なガイドを作成できます。</font><font style="vertical-align: inherit;">つまり、キャッシュ戦略の例を次に示します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトの内容を理解するための重要性を反映した、クラスに分割されたメディアリソースのロード戦略</font></font></h4><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースカテゴリ：「クリティカル」。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速接続、Save-Dataヘッダーの存在、低速接続：リソースのロード。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続の欠如：プレースホルダーの交換。</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースのカテゴリ：「痛くない」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クイック接続：リソースの読み込み。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Save-Dataヘッダーの存在、接続が遅い、接続がない：プレースホルダーで置き換え。</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">３</font></font></h4><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースカテゴリ：「重要ではない」</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高速接続、Save-Dataヘッダーの存在、低速接続、接続なし：ページのコンテンツから完全に除外されます。</font></font></li>
</ul><br>
<h3><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resourcesリソースのカテゴリ分けについて</font></font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「重要な」リソースと「害を及ぼさない」カテゴリのリソースを明確に分離することになると、それらのストレージを異なるフォルダに整理する（またはそのようなことを行う）と便利です。</font><font style="vertical-align: inherit;">このアプローチでは、Service Workerにロジックを追加して、何が何であるかを理解できるようにすることができます。</font><font style="vertical-align: inherit;">たとえば、個人のWebサイトでは、重要な画像を手元に保管するか、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自分の本の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サイトから取得します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">これを知っているので、これらの画像を選択するために、リクエストの送信先のドメインを分析する正規表現を使用できます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> high_priority = [
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-regexp">/aaron\-gustafson\.com/</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-regexp">/adaptivewebdesign\.info/</span>
&nbsp;&nbsp;];</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変数</font></font><code>high_priority</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して、たとえば、画像をダウンロードする特定のリクエストの優先度が高いかどうかを確認できる関数を作成できます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isHighPriority</span>(<span class="hljs-params"> url </span>) </span>{
&nbsp;&nbsp;<span class="hljs-comment">//        ?</span>
&nbsp;&nbsp;<span class="hljs-keyword">let</span> i = high_priority.length;
&nbsp;&nbsp;<span class="hljs-comment">//     </span>
&nbsp;&nbsp;<span class="hljs-keyword">while</span> ( i-- ) {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//    URL   ?</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> ( high_priority[i].test( url ) ) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">// ,   </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;<span class="hljs-comment">//  ,   </span>
&nbsp;&nbsp;<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メディアファイルのダウンロード要求の優先順位付けをサポートするプロジェクトを装備するには、新しい条件チェックをイベントハンドラーに追加するだけ</font></font><code>fetch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">これは、ヘッダーの操作に使用されたのと同じスキームに従って実装され</font></font><code>Save-Data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これが実際にどのように実装されるかは、私が得たものとはかなり異なる可能性が高いですが</font><font style="vertical-align: inherit;">、この問題の解決策の</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私のバージョン</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をあなたと共有したいと思います</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//   </span>
&nbsp;&nbsp;<span class="hljs-comment">//       -  </span>
&nbsp;&nbsp;<span class="hljs-comment">//      - </span><font></font>
<font></font>
<span class="hljs-comment">//    ?</span>
<span class="hljs-keyword">if</span> ( isHighPriority( url ) ) {<font></font>
<font></font>
&nbsp;&nbsp;<span class="hljs-comment">//  </span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//     -     </span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//   - &nbsp; "" </span><font></font>
<font></font>
<span class="hljs-comment">//    </span>
} <span class="hljs-keyword">else</span> {<font></font>
<font></font>
&nbsp;&nbsp;<span class="hljs-comment">//    ?</span>
&nbsp;&nbsp;<span class="hljs-keyword">if</span> ( save_data ) {<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//   " "</span><font></font>
<font></font>
&nbsp;&nbsp;<span class="hljs-comment">//    </span>
&nbsp;&nbsp;} <span class="hljs-keyword">else</span> {<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//  </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//     -     </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//   - &nbsp; "" </span><font></font>
&nbsp;&nbsp;}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチは、画像だけでなく、他のタイプのリソースにも適用できます。</font><font style="vertical-align: inherit;">キャッシュされたバージョンの利点を備えたブラウザーに発行されるページ、およびサーバーに保存されているバージョンの利点を備えたページを制御するために使用することもできます。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャッシュをクリーンに保ちます。</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発者がユーザーのシステムに何をキャッシュして保存するかを制御できるという事実は、開発者に大きな機会を与えます。しかし、開発者には深刻な責任があります。ユーザーに害を与えることなく、これらの機会を正しく実装する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのキャッシュ戦略は互いに異なる可能性があります。少なくとも詳細では。たとえば、サイトで本を公開する場合、そのすべての資料をキャッシュすることは理にかなっています。これにより、ユーザーはネットワークに接続せずに本を読むことができます。本には一定の固定サイズがあり、ギガバイトの画像や動画が含まれていないという前提に基づいて、ユーザーは各章を個別にダウンロードする必要がないというだけの利点があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、すべての記事とすべての写真をニュースサイトにキャッシュすると、すぐにそのようなサイトのユーザーのハードドライブがオーバーフローします。サイトのページ数やその他のリソースが事前に不明な場合、キャッシュ戦略を立てることが非常に重要です。これにより、キャッシュされるリソースの数に厳しい制限を設定できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような制限を導入する1つの方法は、さまざまなコンテンツのキャッシュに関連するいくつかの異なるブロックを作成することです。 1つまたは別のリソースが古くなるのが速いほど、そのようなリソースのキャッシュに格納される要素の数に対する制限が厳しくなります。もちろん、キャッシュはコンピューターのハードウェア機能によって制限されることもありますが、ここでは重要な質問が1つあります。「サイトのキャッシュが2 GBのユーザーディスクを占有するように本当に努力していますか？」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これも私のサイトからの例です：</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> sw_caches = {
&nbsp;&nbsp;<span class="hljs-attr">static</span>: {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${version}</span>static`</span><font></font>
&nbsp;&nbsp;},<font></font>
&nbsp;&nbsp;<span class="hljs-attr">images</span>: {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${version}</span>images`</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">limit</span>: <span class="hljs-number">75</span><font></font>
&nbsp;&nbsp;},<font></font>
&nbsp;&nbsp;<span class="hljs-attr">pages</span>: {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${version}</span>pages`</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">limit</span>: <span class="hljs-number">5</span><font></font>
&nbsp;&nbsp;},<font></font>
&nbsp;&nbsp;<span class="hljs-attr">other</span>: {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${version}</span>other`</span>,
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-attr">limit</span>: <span class="hljs-number">50</span><font></font>
&nbsp;&nbsp;}<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、いくつかのキャッシュを定義しました。それぞれに名前</font></font><code>name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があり、Cache APIでアクセスするために使用される</font><font style="vertical-align: inherit;">プロパティがあり</font><font style="vertical-align: inherit;">ます。キャッシュ名には、変数で設定されたバージョンプレフィックスがあります</font></font><code>version</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。この変数の値は、Service Workerコードで設定されます。バージョンの存在により、必要に応じて、すべてのキャッシュをクリアできます。</font><font style="vertical-align: inherit;">静的リソースのキャッシュに使用されるcacheを</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除いて</font></font><code>static</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、すべてのキャッシュには</font></font><code>limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、キャッシュに格納されるリソースの量を制限するために使用される</font><font style="vertical-align: inherit;">プロパティがあります</font><font style="vertical-align: inherit;">。たとえば、ユーザーがアクセスした最新の5ページだけがキャッシュされます。キャッシュされるイメージの数は75などに制限されています。これはまさに</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ジェレミー・キース</font></a><font style="vertical-align: inherit;">による</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">素晴らしい本で</font><font style="vertical-align: inherit;">説明されているアプローチです</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webプロジェクトのオフラインモードについて（まだ読んでいない場合-読むことをお勧めします。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここが</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最初の章です）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のキャッシュ定義がある場合、定期的にキャッシュをクリアして最も古い要素を削除できます。</font><font style="vertical-align: inherit;">Jeremyがキャッシュを順番に保持するために使用することをお勧めするコードは次のとおりです。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trimCache</span>(<span class="hljs-params">cacheName, maxItems</span>) </span>{
&nbsp;&nbsp;<span class="hljs-comment">//  </span><font></font>
&nbsp;&nbsp;caches.open(cacheName)<font></font>
&nbsp;&nbsp;.then( <span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//     </span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;cache.keys()<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;.then(<span class="hljs-function"><span class="hljs-params">keys</span> =&gt;</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//      ,   ?</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (keys.length &gt; maxItems) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//          </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cache.delete(keys[<span class="hljs-number">0</span>])<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.then( <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trimCache(cacheName, maxItems)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;});<font></font>
&nbsp;&nbsp;});<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいページをロードするたびに、このコードを呼び出すことができます。</font><font style="vertical-align: inherit;">Service Workerで実行すると、別のスレッドで動作し、サイトの応答性に影響を与えません。</font><font style="vertical-align: inherit;">このコードは</font></font><code>postMessage()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、メインのJavaScript実行スレッドからService Workerに</font><font style="vertical-align: inherit;">（を使用して</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">メッセージを送信するメカニズムを使用して</font><font style="vertical-align: inherit;">呼び出されます。</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">//     -</span>
<span class="hljs-keyword">if</span> ( navigator.serviceWorker.controller ) {
&nbsp;&nbsp;<span class="hljs-comment">//    </span>
&nbsp;&nbsp;<span class="hljs-built_in">window</span>.addEventListener( <span class="hljs-string">"load"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//  -  ,      </span>
&nbsp;&nbsp;&nbsp;&nbsp;navigator.serviceWorker.controller.postMessage( <span class="hljs-string">"clean up"</span> );<font></font>
&nbsp;&nbsp;});<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作業の最後のステップは、Service Workerにメッセージを受信する機能を装備することです。</font></font><br>
<br>
<pre><code class="javascript hljs">addEventListener(<span class="hljs-string">"message"</span>, messageEvent =&gt; {
&nbsp;&nbsp;<span class="hljs-keyword">if</span> (messageEvent.data == <span class="hljs-string">"clean up"</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//   </span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">for</span> ( <span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> sw_caches ) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//    </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> ( sw_caches[key].limit !== <span class="hljs-literal">undefined</span> ) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment">//      </span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trimCache( sw_caches[key].name, sw_caches[key].limit );<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;}<font></font>
});</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、Service Workerは着信メッセージを予期し</font><font style="vertical-align: inherit;">、プロパティが設定されている各キャッシュの</font></font><code>clean up</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font></font><code>trimCache()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">開始することによって</font><font style="vertical-align: inherit;">メッセージに応答します</font></font><code>limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このアプローチは非常にエレガントとは言えませんが、彼は仕事をしています。</font><font style="vertical-align: inherit;">その要素が使用される頻度、またはディスク上で使用するスペースの量に基づいて、キャッシュをクリアすることを決定した方がよい場合。</font><font style="vertical-align: inherit;">（キャッシュされたときのみに基づいてキャッシュ要素を削除することは、最も成功した戦略とはほど遠いものです。）しかし、残念ながら、キャッシュを調査している間は、その要素に関する詳細な情報を取得できません。</font><font style="vertical-align: inherit;">そして、私は実際に現在、キャッシュAPIでこれらの問題を解決するために取り組んでいます。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論：ユーザーは常に最も重要です</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プログレッシブWebアプリケーションの背後にあるテクノロジーは成長を続けています。ただし、サイトをPWAに変換することに関心がない場合でも、適切なテクノロジを使用すると、プロジェクトでの作業のユーザーエクスペリエンスを向上させる大きな機会が得られます。これらのテクノロジーは、プロジェクトがメディアリソースを処理する方法を大幅に改善できます。また、他の統合設計の場合と同様に、Webプロジェクトの改善作業は、リソースを操作するという悪い印象を経験するリスクが最も高いユーザーにスポットライトが当てられることから始まります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メディアファイルを重要なもの、「傷つけない」もの、およびそれなしで実行できるものに分けます。不要なものをすべて削除し、残っているものを適切に最適化します。画像の異なるバージョンを準備し、異なるフォーマットとサイズを使用します。レイテンシの長い低速ネットワークを使用するユーザーの生活を楽にするために、画像の最小バージョンを優先します。ユーザーがトラフィックを節約したいという要望を表明した場合は、この要望を尊重し、事前にこのモードで作業する準備をしてください。キャッシュに注意してください。特に、キャッシュをクリアしてユーザーのコンピューターのディスク領域を節約するように注意してください。そして最後に、キャッシュ戦略を定期的に分析します-特に大きなメディアファイルに関連する部分では。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのガイドラインに従ってください。そうすれば、各ユーザーに感謝の意が示されます。</font><font style="vertical-align: inherit;">インドの田舎のモバイルネットワークを介してインターネットに接続し、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JioPhone</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">ページを</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">閲覧</font></a><font style="vertical-align: inherit;">する人から、シリコンバレーに住み、10ギガビットファイバーに接続された強力なゲーム用ラップトップでWebサーフィンをする人まで。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">読者の皆様！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Webプロジェクトでメディアリソースの最新のキャッシング機能を使用していますか？</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/webt/-o/2e/tu/-o2etuqogwhmdnmysb9_vivc9v4.png"></div></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja478308/index.html">プラットフォーム戦争とボ​​ブおじさんのロシア到着：DotNextで何が起こったのか、何が起こるのか</a></li>
<li><a href="../ja478314/index.html">Kali Linuxは、Windowsおよびバージョン2019.4の他の機能で視覚的模倣モードを受け取りました</a></li>
<li><a href="../ja478320/index.html">プログラマーの作業をスピードアップするのに役立つVS Codeの10の機能</a></li>
<li><a href="../ja478322/index.html">実際のプロジェクトでのアプリケーションに関するReact NativeとFlutterの比較</a></li>
<li><a href="../ja478324/index.html">最小の違い</a></li>
<li><a href="../ja478328/index.html">データサイエンティストが車を購入した方法</a></li>
<li><a href="../ja478330/index.html">DapはWeb用のもう1つのジェットエンジンです。全然違う</a></li>
<li><a href="../ja478336/index.html">非同期、Swoole、ParallelによるTarantool PHPコネクタの高速化</a></li>
<li><a href="../ja478340/index.html">Tinkoffインターンシッププログラムはどのように機能しますか？</a></li>
<li><a href="../ja478342/index.html">ボットは私たちを助けます</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>