<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßùüèº üôÄ ‚òùüèæ ¬øPor qu√© puede necesitar replicaci√≥n semis√≠ncrona? üêì üë©üèΩ‚Äçü§ù‚Äçüë®üèº üî©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos. En contacto Vladislav Rodin. Actualmente estoy impartiendo cursos sobre arquitectura de software y arquitectura de software de alta carg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>¬øPor qu√© puede necesitar replicaci√≥n semis√≠ncrona?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/491106/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hola a todos. </font><font style="vertical-align: inherit;">En contacto Vladislav Rodin. </font><font style="vertical-align: inherit;">Actualmente estoy impartiendo cursos sobre arquitectura de software y arquitectura de software de alta carga en el portal OTUS. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En previsi√≥n del inicio de una nueva secuencia del curso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Arquitecto de altas cargas",</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> decid√≠ escribir un peque√±o material de autor, que quiero compartir con ustedes.</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/pi/ad/dp/piaddproyjjd7sel38p94k6p_qe.png"><br>
<hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introducci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debido al hecho de que solo se pueden realizar alrededor de 400-700 operaciones por segundo en el HDD (que es incomparable con los rps t√≠picos que caen en un sistema muy cargado), la base de datos de disco cl√°sica es un cuello estrecho de arquitectura. </font><font style="vertical-align: inherit;">Por lo tanto, se debe prestar especial atenci√≥n a los patrones de escala de este repositorio. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este momento hay 2 patrones de escalado de base: replicaci√≥n y fragmentaci√≥n. </font><font style="vertical-align: inherit;">Sharding le permite escalar la operaci√≥n de escritura y, como resultado, reducir las rps para la grabaci√≥n por cada servidor en su cl√∫ster. </font><font style="vertical-align: inherit;">La replicaci√≥n le permite hacer lo mismo, pero con operaciones de lectura. </font><font style="vertical-align: inherit;">Este art√≠culo est√° dedicado a este mismo patr√≥n.</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replicaci√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si observa la replicaci√≥n a un nivel muy alto, esto es algo simple: ten√≠a un servidor, los datos estaban en √©l y luego este servidor dej√≥ de hacer frente a la carga de leer estos datos. </font><font style="vertical-align: inherit;">Agrega un par de servidores m√°s, sincroniza los datos en todos los servidores y el usuario puede leer desde cualquier servidor de su cl√∫ster. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pesar de la aparente simplicidad, hay varias opciones para clasificar diversas implementaciones de este esquema:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por roles en el cl√∫ster (maestro-maestro o maestro-esclavo)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por objetos reenviados (basados ‚Äã‚Äãen filas, enunciados o mixtos)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seg√∫n el mecanismo de sincronizaci√≥n de nodos</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hoy nos ocuparemos del tercer punto. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øC√≥mo se compromete la transacci√≥n?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este tema no se relaciona directamente con la replicaci√≥n, sin embargo, se puede escribir un art√≠culo por separado, ya que sin una mayor comprensi√≥n del mecanismo de confirmaci√≥n de transacci√≥n, la lectura adicional es in√∫til, perm√≠tame recordarle las cosas m√°s b√°sicas. </font><font style="vertical-align: inherit;">Una transacci√≥n se confirma en 3 etapas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escribir una transacci√≥n en el registro de la base de datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicaci√≥n de una transacci√≥n en un motor de base de datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devolver confirmaci√≥n al cliente sobre la aplicaci√≥n exitosa de la transacci√≥n.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En varias bases de datos, pueden surgir matices en este algoritmo: por ejemplo, en el motor InnoDB de la base de datos MySQL hay 2 registros: uno para la replicaci√≥n (registro binario) y el otro para mantener ACID (registro de deshacer / rehacer), mientras que en PostgreSQL hay un registro ejecut√°ndose ambas funciones (escritura anticipada log = WAL). </font><font style="vertical-align: inherit;">Pero arriba est√° precisamente el concepto general que permite ignorar tales matices.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replicaci√≥n sincr√≥nica (sincronizaci√≥n)</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agreguemos la l√≥gica para replicar los cambios recibidos al algoritmo de confirmaci√≥n de transacci√≥n:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escribir una transacci√≥n en el registro de la base de datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicaci√≥n de una transacci√≥n en un motor de base de datos.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Env√≠o de datos a todas las r√©plicas.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reciba la confirmaci√≥n de todas las r√©plicas sobre la transacci√≥n en ellos.</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devolver confirmaci√≥n al cliente sobre la aplicaci√≥n exitosa de la transacci√≥n.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con este enfoque, obtenemos una serie de desventajas: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El cliente est√° esperando que se apliquen los cambios a todas las r√©plicas.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A medida que aumenta el n√∫mero de nodos en el cl√∫ster, reducimos la probabilidad de que la operaci√≥n de escritura tenga √©xito.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si todo est√° m√°s o menos claro con el primer p√°rrafo, entonces se deben aclarar los motivos del segundo p√°rrafo. </font><font style="vertical-align: inherit;">Si durante la replicaci√≥n sincr√≥nica no obtenemos una respuesta de al menos un nodo, revertimos la transacci√≥n. </font><font style="vertical-align: inherit;">Por lo tanto, al aumentar el n√∫mero de nodos en el cl√∫ster, aumenta la probabilidad de que la operaci√≥n de escritura falle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¬øPodemos esperar la confirmaci√≥n solo de una cierta fracci√≥n de nodos, por ejemplo, del 51% (qu√≥rum)? </font><font style="vertical-align: inherit;">S√≠, podemos, pero en la versi√≥n cl√°sica, se requiere la confirmaci√≥n de todos los nodos, porque as√≠ es como podemos garantizar la consistencia completa de los datos en el cl√∫ster, lo cual es una ventaja indudable de este tipo de replicaci√≥n.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replicaci√≥n as√≠ncrona</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modifiquemos el algoritmo anterior. </font><font style="vertical-align: inherit;">Enviaremos datos a las r√©plicas "en alg√∫n momento posterior", y "en alg√∫n momento posterior" los cambios se aplicar√°n en las r√©plicas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escribir una transacci√≥n en el registro de la base de datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicaci√≥n de una transacci√≥n en un motor de base de datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devolver confirmaci√≥n al cliente sobre la aplicaci√≥n exitosa de la transacci√≥n.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviar datos a r√©plicas y aplicarles cambios.</font></font></b></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Este enfoque lleva al hecho de que el cl√∫ster funciona r√°pidamente, porque no mantenemos al cliente esperando que los datos lleguen a las r√©plicas e incluso se comuniquen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero la condici√≥n de soltar datos en las r√©plicas "en alg√∫n momento posterior" puede conducir a la p√©rdida de la transacci√≥n y a la p√©rdida de la transacci√≥n confirmada al usuario, porque si los datos no tuvieron tiempo de replicarse, se envi√≥ una confirmaci√≥n al cliente sobre el √©xito de la operaci√≥n, y el nodo al que llegaron los cambios vol√≥ HDD, estamos perdiendo la transacci√≥n, lo que puede tener consecuencias muy desagradables.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replicaci√≥n semisincr√≥nica</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finalmente, llegamos a la replicaci√≥n semis√≠ncrona. </font><font style="vertical-align: inherit;">Este tipo de replicaci√≥n no es muy conocida ni muy com√∫n, pero es de gran inter√©s, ya que puede combinar las ventajas de la replicaci√≥n sincr√≥nica y asincr√≥nica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Intentemos combinar los 2 enfoques anteriores. </font><font style="vertical-align: inherit;">No mantendremos al cliente por mucho tiempo, pero requerimos que los datos se repliquen:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escribir una transacci√≥n en el registro de la base de datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicaci√≥n de una transacci√≥n en un motor de base de datos.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Env√≠o de datos a r√©plicas.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recibiendo confirmaci√≥n de la r√©plica sobre la recepci√≥n de cambios (se aplicar√°n "en alg√∫n momento posterior").</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devolver confirmaci√≥n al cliente sobre la aplicaci√≥n exitosa de la transacci√≥n.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tenga en cuenta que con este algoritmo, la p√©rdida de transacci√≥n ocurre solo en el caso de una ca√≠da del nodo que acepta los cambios y los nodos de r√©plica. </font><font style="vertical-align: inherit;">La probabilidad de tal mal funcionamiento se considera peque√±a, y se aceptan estos riesgos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero con este enfoque, el riesgo de lecturas fantasmas es posible. </font><font style="vertical-align: inherit;">Imagine el siguiente escenario: en el paso 4, no recibimos confirmaci√≥n de ninguna r√©plica. </font><font style="vertical-align: inherit;">Debemos revertir esta transacci√≥n y no devolver la confirmaci√≥n al cliente. </font><font style="vertical-align: inherit;">Dado que los datos se aplicaron en el paso 2, existe un intervalo de tiempo entre el final del paso 2 y la reversi√≥n de la transacci√≥n, durante el cual las transacciones paralelas pueden ver los cambios que no deber√≠an estar en la base de datos.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Replicaci√≥n de semisincronizaci√≥n sin p√©rdida</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si piensa un poco, solo puede cambiar los pasos del algoritmo en lugares para solucionar el problema de las lecturas fantasmas en este escenario:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escribir una transacci√≥n en el registro de la base de datos.</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Env√≠o de datos de r√©plica.</font></font></b></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recibiendo confirmaci√≥n de la r√©plica sobre la recepci√≥n de cambios (se aplicar√°n "en alg√∫n momento posterior").</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicaci√≥n de una transacci√≥n en un motor de base de datos.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devolver confirmaci√≥n al cliente sobre la aplicaci√≥n exitosa de la transacci√≥n.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora confirmamos los cambios solo si se replican. </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como siempre, no hay soluciones perfectas, hay un conjunto de soluciones, cada una de las cuales tiene sus propias ventajas y desventajas y es adecuada para resolver varios tipos de problemas. </font><font style="vertical-align: inherit;">Esto tambi√©n es cierto para elegir un mecanismo para sincronizar los datos de una base de datos replicada. </font><font style="vertical-align: inherit;">El conjunto de beneficios que tiene la replicaci√≥n semis√≠ncrona es lo suficientemente s√≥lido e interesante como para ser considerado merecedor de atenci√≥n, a pesar de su baja prevalencia. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eso es todo. </font><font style="vertical-align: inherit;">¬°Nos vemos en el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">curso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font></b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es491092/index.html">C√≥mo Crash Bandicoot hacke√≥ Playstation</a></li>
<li><a href="../es491094/index.html">Instalaci√≥n de Firebird 3 en versiones modernas de Linux: CentOS8 y Ubuntu 19</a></li>
<li><a href="../es491100/index.html">En Wanhao 5S, imprimieron una mu√±eca con la altura de una persona</a></li>
<li><a href="../es491102/index.html">C√≥mo desarrollar un servicio cuando hay competidores fuertes alrededor</a></li>
<li><a href="../es491104/index.html">C√≥mo encontr√© una falla de hardware en mi tableta Lenovo MiiX 2 10</a></li>
<li><a href="../es491108/index.html">Organizar implementaciones en muchos entornos k8s utilizando helmfile</a></li>
<li><a href="../es491110/index.html">Convertir rtf a xml en C #</a></li>
<li><a href="../es491112/index.html">El camino hacia la inocencia de la red - Cisco DNA</a></li>
<li><a href="../es491114/index.html">Reubicaci√≥n inteligente o c√≥mo elegir una empresa para trabajar y no arrepentirse</a></li>
<li><a href="../es491116/index.html">Est√°ndares de identificaci√≥n modernos: OAuth 2.0, OpenID Connect, WebAuthn</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>