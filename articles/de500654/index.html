<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÖüèª üò∫ üßëüèø‚Äçü§ù‚ÄçüßëüèΩ WebRTC unter Android: Aktivieren der Hardware-Codierung auf mehreren Ger√§ten üöñ üêè ‚ôåÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="F√ºr Videoanrufe in Badoo verwenden wir den WebRTC-Standard und den H.264-Codec. Wenn Sie der Dokumentation glauben, sollte dieser Codec auf jedem Andr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>WebRTC unter Android: Aktivieren der Hardware-Codierung auf mehreren Ger√§ten</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/500654/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºr Videoanrufe in Badoo verwenden wir den WebRTC-Standard und den H.264-Codec. </font><font style="vertical-align: inherit;">Wenn Sie der Dokumentation glauben, sollte dieser Codec auf jedem Android-Ger√§t seit Android 5.0 problemlos funktionieren. </font><font style="vertical-align: inherit;">In der Praxis stellte sich jedoch heraus, dass nicht alles so war. </font><font style="vertical-align: inherit;">In diesem Artikel werde ich √ºber die Funktionen zum Implementieren der Hardware-Codierung f√ºr den H.264-Codec in WebRTC und dar√ºber sprechen, wie er auf mehr Ger√§ten funktioniert.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tu/lt/w1/tultw1tnly1q-hovglpxdkzaax8.jpeg"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum H.264?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei einer Verbindung √ºber WebRTC √ºbertragen alle an der Sitzung teilnehmenden Ger√§te verschiedene Kommunikationsparameter, einschlie√ülich Video- und Audio-Codecs. Wenn Ger√§te mehrere Codecs unterst√ºtzen (z. B. VP8 und H.264), werden zuerst Priorit√§tscodecs f√ºr die Plattform aufgelistet. Diese Daten werden in der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abstimmungsphase</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in WebRTC </font><font style="vertical-align: inherit;">verwendet. Danach </font><font style="vertical-align: inherit;">verbleiben nur noch Codecs, die von allen Ger√§ten unterst√ºtzt werden. Ein Beispiel f√ºr solche Daten mit Entschl√ºsselung finden Sie in diesem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokument</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn bei Videoanrufen eines der Ger√§te den H.264-Codec nicht unterst√ºtzt, k√∂nnen beide Ger√§te beispielsweise auf den VP8-Codec umschalten, der nicht von der Hardware-Implementierung auf dem Ger√§t abh√§ngt. </font><font style="vertical-align: inherit;">Unsere Anwendung ist jedoch auf einer Vielzahl von Ger√§ten verf√ºgbar, einschlie√ülich Smartphones fr√ºherer Generationen. </font><font style="vertical-align: inherit;">Daher wollten wir f√ºr die Videokommunikation nach M√∂glichkeit die Hardware-Codierung verwenden: Sie entlastet den Prozessor und verbraucht den Akku nicht so stark, was f√ºr veraltete Ger√§te von entscheidender Bedeutung ist. </font><font style="vertical-align: inherit;">Die Unterst√ºtzung der H.264-Hardwarecodierung ist im Gegensatz zum gleichen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VP8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf einer gro√üen Anzahl von Ger√§ten implementiert </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H.264-Unterst√ºtzung f√ºr Android</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie der Meinung sind, dass die Beschreibung der Unterst√ºtzung </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√ºr Multimedia-Formate die</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dekodierung des H.264-Basisprofils auf allen Android-Ger√§ten und die Codierung - beginnend mit Android 3.0 - funktionieren sollte. In Badoo unterst√ºtzen wir Ger√§te ab Android 5.0, daher sollten wir keine Probleme haben. Aber es war nicht so einfach: Selbst in Gadgets mit der f√ºnften Version fanden wir eine gro√üe Anzahl von Funktionen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Womit kann es verbunden werden? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie wissen, muss jeder Hersteller bei der Entwicklung eines neuen Ger√§ts unter Android die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compatibility Test Suite bestehen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Es wird auf einem mit dem Ger√§t verbundenen PC ausgef√ºhrt. Die Ergebnisse m√ºssen an Google gesendet werden, um zu best√§tigen, dass das Ger√§t die Anforderungen des Android-Betriebssystems der angegebenen Version erf√ºllt. Erst danach kann das Gadget auf den Markt gebracht werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sind an Multimedia-Tests in dieser Testsuite interessiert, insbesondere an Videokodierungs- und -decodierungstests. Ich habe beschlossen, die Tests </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EncodeDecodeTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DecoderTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EncoderTest zu beenden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , da sie seit 4.3 auf allen Android-Versionen vorhanden sind. Das Diagramm der Anzahl der Codezeilen in diesen Tests sieht folgenderma√üen aus:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/td/g_/4p/tdg_4prrdcocytay8z7df_igw0o.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vor Version 4.3 existierten die meisten dieser Tests einfach nicht und ihr signifikanter Anstieg fiel auf die Versionen 5 und 7. Daher k√∂nnen wir sagen, dass Google vor der Version Android 4.3 nicht die Konformit√§t der Ger√§te mit den Spezifikationen f√ºr das Codieren und Decodieren von Videos √ºberpr√ºft hat, sondern in der Version 5.0 hat diese Pr√ºfung erheblich verbessert. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es scheint, dass dies darauf hinweist, dass ab Version 5.0 mit Codierung alles in Ordnung sein sollte. Aufgrund meiner fr√ºheren Erfahrungen mit dem Dekodieren von Streaming-Videos auf Android war ich mir jedoch sicher, dass dies nicht der Fall war. Es gen√ºgte, die Anzahl der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Themen zum Thema</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Codierung in der Google-Gruppe " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diskussion-Webrtc" zu betrachten</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WebRTC-Quelldateien, die gemeinfrei sind, haben uns bei der Suche nach Fallstricken geholfen. Betrachten wir sie genauer.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">H.264-Unterst√ºtzung in WebRTC</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir mit der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HardwareVideoEncoderFactory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt eine Methode mit dem sprechenden Namen isHardwareSupportedInCurrentSdkH264:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isHardwareSupportedInCurrentSdkH264</span><span class="hljs-params">(MediaCodecInfo info)</span> </span>{
  <span class="hljs-comment">// First, H264 hardware might perform poorly on this model.</span>
  <span class="hljs-keyword">if</span> (H264_HW_EXCEPTION_MODELS.contains(Build.MODEL)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<font></font>
  }<font></font>
  String name = info.getName();<font></font>
  <span class="hljs-comment">// QCOM H264 encoder is supported in KITKAT or later.</span>
  <span class="hljs-keyword">return</span> (name.startsWith(QCOM_PREFIX) &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT)
      <span class="hljs-comment">// Exynos H264 encoder is supported in LOLLIPOP or later.</span><font></font>
      || (name.startsWith(EXYNOS_PREFIX)<font></font>
             &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wir sehen k√∂nnen, wird die Unterst√ºtzung f√ºr die Hardware-Codierung unter Android nur f√ºr Qualcomm- und Exynos-Chips√§tze implementiert. Warum werden andere Chips√§tze in der Standard-WebRTC-Implementierung nicht unterst√ºtzt? Dies ist h√∂chstwahrscheinlich auf die Besonderheiten der Implementierung von Hardware-Codec-Herstellern zur√ºckzuf√ºhren. Und es ist oft m√∂glich, diese Merkmale nur in der Produktion zu identifizieren, da es nicht immer m√∂glich ist, bestimmte Ger√§te zu finden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Codec-Beschreibungen auf dem Ger√§t werden in der Datei media_codecs.xml gespeichert. Hier ist zum Beispiel diese Datei f√ºr das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pixel XL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und f√ºr das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HUAWEI P8 lite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Wenn Sie eine Liste von Codecs mit der Methode getCodecInfos () des MediaCodecList-Objekts erhalten, wird diese Datei analysiert - und die darin gespeicherten Codecs werden zur√ºckgegeben. Dieser Vorgang und das korrekte Ausf√ºllen dieser Datei durch den Hersteller werden im CTS-Test behandelt.</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecListTest</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die auch aus 160 Zeilen Code in Android 4,3 bis 740 Linien in Android 10 erh√∂ht </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Badoo, √§nderten wir den isHardwareSupportedInCurrentSdkH264 Methodencode, die ‚Äûwei√üe‚Äú Codec - </font><font style="vertical-align: inherit;">Liste zur√ºckgewiesen und es mit einer ‚Äûschwarzen‚Äú Liste des Programms ersetzen Codec Pr√§fixen, sind </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aufgelistet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in WebRTC:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] SOFTWARE_IMPLEMENTATION_PREFIXES = {<span class="hljs-string">"OMX.google."</span>, <span class="hljs-string">"OMX.SEC."</span>};</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie k√∂nnen jedoch nicht einfach alle Codecs unterst√ºtzen und implementieren, ohne auf die Funktionen der Hersteller zu achten. </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Anhand</font></a><font style="vertical-align: inherit;"> der Namen der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Themen,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> die der Hardware-Codierung unter Android in der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diskussion-webrtc-Gruppe gewidmet sind</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , k√∂nnen wir verstehen, dass in diesem Fall definitiv Fehler auftreten werden. </font><font style="vertical-align: inherit;">Grunds√§tzlich werden sie in der Codec-Konfigurationsphase angezeigt.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Codec-Konfigurationsoptionen</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Initialisierung des Codecs f√ºr die Codierung lautet wie folgt:</font></font><br>
<br>
<pre><code class="java hljs">MediaCodec mediaCodec = createByCodecName(codecName);<font></font>
MediaFormat format = MediaFormat.createVideoFormat(mime, width, height);<font></font>
format.setInteger(MediaFormat.KEY_BIT_RATE, targetBitrateBps);<font></font>
format.setInteger(MediaFormat.KEY_BITRATE_MODE, VIDEO_ControlRateConstant);<font></font>
format.setInteger(MediaFormat.KEY_COLOR_FORMAT, colorFormat);<font></font>
format.setInteger(MediaFormat.KEY_FRAME_RATE, targetFps);<font></font>
format.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, keyFrameIntervalSec);<font></font>
mediaCodec.configure(format, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei einigen dieser Parameter kann es leicht zu Fehlern kommen, die beim Konfigurieren des Codecs eine Ausnahme ausl√∂sen und die Anwendung st√∂ren. </font><font style="vertical-align: inherit;">Wenn Sie mit einem Codec arbeiten, m√ºssen Sie m√∂glicherweise die Bitrate in Abh√§ngigkeit von verschiedenen Faktoren anpassen, da der Codec selbst dies falsch macht. </font><font style="vertical-align: inherit;">Daf√ºr ist in WebRTC die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BaseBitrateAdjuster-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Klasse </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">verantwortlich</font></a><font style="vertical-align: inherit;"> , die zwei Nachkommen hat:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DynamicBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Passt</font></a><font style="vertical-align: inherit;"> die Bitrate abh√§ngig von der Datenmenge an</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FramerateBitrateAdjuster</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Passt die Bitrate abh√§ngig von der Bildrate an.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dementsprechend m√ºssen Sie f√ºr jeden Codec Ihren eigenen Bitratenanpassungsmechanismus ausw√§hlen. </font><font style="vertical-align: inherit;">Lassen Sie uns die Funktionen zum Festlegen der Initialisierungsparameter f√ºr Hardware-Codecs genauer betrachten.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stream-Aufl√∂sung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem Sie das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MediaCodecInfo-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Objekt f√ºr den Codec erhalten haben, k√∂nnen </font><font style="vertical-align: inherit;">Sie den Codec genauer untersuchen, indem Sie seine Funktionen in der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CodecCapabilities-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Klasse </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">abrufen</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Anhand dieser Informationen k√∂nnen Sie herausfinden, ob der Codec die ausgew√§hlte Aufl√∂sung und Bildrate unterst√ºtzt. </font><font style="vertical-align: inherit;">Wenn diese Parameter unterst√ºtzt werden, k√∂nnen sie sicher eingestellt werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Manchmal funktioniert diese Regel jedoch nicht. </font><font style="vertical-align: inherit;">Wir sind mit der Tatsache konfrontiert, dass Codecs mit dem Pr√§fix "OMX.MARVELL". </font><font style="vertical-align: inherit;">falsch codiert, zeigt gr√ºne Streifen an den R√§ndern des Bildschirms, wenn die Aufl√∂sung des Streams von 4: 3 abweicht. </font><font style="vertical-align: inherit;">Gleichzeitig behauptete der Codec selbst, dass die ausgew√§hlte Aufl√∂sung und Bildrate unterst√ºtzt werden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bitratenmodus</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Standardmodus f√ºr alle Video-Codecs ist eine konstante Bitrate. </font><font style="vertical-align: inherit;">Einmal mussten wir jedoch eine variable Bitrate verwenden:</font></font><br>
<br>
<pre><code class="java hljs">format.setInteger(MediaFormat.KEY_BITRATE_MODE, VIDEO_ControlRateVariable);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies geschah auf einem Lenovo A1000-Ger√§t mit dem Spreadtrum-Chipsatz (jetzt Unisoc), beginnend mit dem Pr√§fix ‚ÄûOMX.sprd.‚Äú. </font><font style="vertical-align: inherit;">Eine Suche im Internet f√ºhrte uns zu einem </font><font style="vertical-align: inherit;">sechs Jahre alten </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beitrag</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √ºber Firefox OS, in dem dieses Problem und seine L√∂sung beschrieben werden.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Farbformat</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn Sie den Codec im Byte-Puffer-Modus verwenden, m√ºssen Sie das richtige Format ausw√§hlen. </font><font style="vertical-align: inherit;">Dies erfolgt normalerweise mit einer Funktion der folgenden Form:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-meta">@Nullable</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> Integer <span class="hljs-title">selectColorFormat</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] supportedColorFormats, CodecCapabilities capabilities)</span> </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> supportedColorFormat : supportedColorFormats) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> codecColorFormat : capabilities.colorFormats) {
      <span class="hljs-keyword">if</span> (codecColorFormat == supportedColorFormat) {
        <span class="hljs-keyword">return</span> codecColorFormat;<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grob gesagt wird immer das erste der unterst√ºtzten Farbformate ausgew√§hlt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bei HUAWEI-Codecs, die mit den Pr√§fixen "OMX.IMG.TOPAZ.", "OMX.hisi" beginnen. </font><font style="vertical-align: inherit;">und "OMX.k3." funktionierte nicht und nach langer Suche fanden wir eine L√∂sung: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unabh√§ngig davon,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> welches Format diese Codecs zur√ºckgeben, m√ºssen Sie das Format </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">COLOR_FormatYUV420SemiPlanar</font></a><font style="vertical-align: inherit;"> verwenden </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://translate.google.com/translate%3Fhl%3D%26sl%3Dzh-CN%26tl%3Den%26u%3D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thread</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hat uns geholfen, </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://translate.google.com/translate%3Fhl%3D%26sl%3Dzh-CN%26tl%3Den%26u%3D"><font style="vertical-align: inherit;">dies</font></a><font style="vertical-align: inherit;"> in einem chinesischen Forum </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://translate.google.com/translate%3Fhl%3D%26sl%3Dzh-CN%26tl%3Den%26u%3D"><font style="vertical-align: inherit;">herauszufinden</font></a><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bitrate-Einstellung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Standard-WebRTC-Code enth√§lt </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Folgendes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">private</span> BitrateAdjuster <span class="hljs-title">createBitrateAdjuster</span><span class="hljs-params">(VideoCodecMimeType type, String codecName)</span> </span>{
  <span class="hljs-keyword">if</span> (codecName.startsWith(EXYNOS_PREFIX)) {
    <span class="hljs-keyword">if</span> (type == VideoCodecMimeType.VP8) {
        <span class="hljs-comment">// Exynos VP8 encoders need dynamic bitrate adjustment.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DynamicBitrateAdjuster();<font></font>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Exynos VP9 and H264 encoders need framerate-based bitrate adjustment.</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FramerateBitrateAdjuster();<font></font>
    }<font></font>
  }<font></font>
  <span class="hljs-comment">// Other codecs don't need bitrate adjustment.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BaseBitrateAdjuster();<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie diesem Code entnehmen k√∂nnen, ist die Bitratenanpassung f√ºr alle Chips√§tze au√üer Exynos deaktiviert. Dies gilt jedoch nur f√ºr Qualcomm, da im Standardcode nur Exynos und Qualcomm unterst√ºtzt werden. Beim Experimentieren mit verschiedenen Werten dieser Einstellung sowie beim Durchsuchen des Internets haben wir festgestellt, dass Codecs mit den Pr√§fixen ‚ÄûOMX.MTK‚Äú verwendet werden. es muss auch eingeschaltet sein. Dies ist auch f√ºr HUAWEI-Codecs erforderlich, die mit dem Pr√§fix "OMX.IMG.TOPAZ.", "OMX.hisi" beginnen. oder "OMX.k3.". Dies liegt an der Tatsache, dass diese Codecs keine Zeitstempel von Frames verwenden, um die Bitrate anzupassen, vorausgesetzt, dass alle Frames bei der Konfiguration des Codecs dieselbe Frequenz haben.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abschlie√üend werde ich eine Liste der Codecs geben, die wir f√ºr Ger√§te unter Android 5.0 und 5.1 erhalten haben. </font><font style="vertical-align: inherit;">Sie waren f√ºr uns vor allem deshalb von Interesse, weil sich die Situation bei neueren Android-Versionen verbessert und nicht standardm√§√üige Codecs kleiner werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies ist in der folgenden Grafik zu sehen. </font><font style="vertical-align: inherit;">Die logarithmische Skala zur besseren Darstellung seltener F√§lle. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/ng/ws/lengwsark1w8mgc0jmg95pptv_k.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wir sehen k√∂nnen, hatten die meisten Ger√§te Spreadtrum-, MediaTek-, HUAWEI- und MARVELL-Chips√§tze. Daher haben unsere √Ñnderungen dazu beigetragen, die Hardware-Codierung f√ºr diese Ger√§te zu erm√∂glichen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ergebnis</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obwohl wir davon ausgegangen sind, dass einige Ger√§te Probleme mit H.264 haben w√ºrden, konnte uns Android erneut √ºberraschen. Wie aus den Badoo-Benutzerstatistiken hervorgeht, befinden sich 2014-2016 noch einige Ger√§te in den H√§nden der Benutzer, die sie nicht aktualisieren m√∂chten oder k√∂nnen. Und obwohl die Situation mit der Ver√∂ffentlichung von Android-Updates f√ºr neue Ger√§te bereits viel besser ist als vor einigen Jahren, nimmt der Anteil der Gadgets der vorherigen Generation nur langsam ab und muss noch einige Zeit beibehalten werden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt wird WebRTC aufgrund seiner Verwendung im Stadia-Projekt von Google aktiv entwickelt (hier das </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit Details zu diesem Thema), so dass es immer besser wird und h√∂chstwahrscheinlich zum Standard f√ºr die Implementierung von Videokommunikation wird. </font><font style="vertical-align: inherit;">Ich hoffe, dass dieser Artikel Ihnen hilft, die Funktionen der Arbeit mit H.264 in WebRTC zu verstehen und in Ihren Projekten zu verwenden.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de500640/index.html">Wie man ein erfolgreiches Outsourcing-Unternehmen macht</a></li>
<li><a href="../de500642/index.html">Igrostroy: Schwelle f√ºr den Eintritt in die Industrie, Spezialit√§ten und m√∂gliche Einnahmen</a></li>
<li><a href="../de500644/index.html">Random Coffee Habr Edition - Networking f√ºr die IT-Community</a></li>
<li><a href="../de500646/index.html">Kochbytecode in der JVM-K√ºche</a></li>
<li><a href="../de500648/index.html">Was ist ein Architekturmodell der Unternehmensreife?</a></li>
<li><a href="../de500656/index.html">Hierarchische Protokollierung der Anwendung in der Datenbank</a></li>
<li><a href="../de500660/index.html">Eine vereinfachte und sehr kurze Geschichte der Entwicklung von "Wolken"</a></li>
<li><a href="../de500666/index.html">Microsoft Online-Zertifizierung - Sie, Ihr Speicherplatz und Ihr Computer</a></li>
<li><a href="../de500668/index.html">Drahtlose Motorsteuerung von Lego mit Steam Controller</a></li>
<li><a href="../de500670/index.html">Wie wir unser Produkt herstellen. Erster Teil, Forschung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>