<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚻 👨 🏑 Aviasales API与Amazon Kinesis的集成以及无服务器的简单性 🎳 🥘 🙎🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="哈Ha！
 
 你喜欢坐飞机吗？我喜欢它，但出于自我隔离，我也喜欢分析一种著名资源Aviasales的机票数据。
 
 今天，我们将分析Amazon Kinesis的工作，构建具有实时分析的流系统，将Amazon DynamoDB NoSQL数据库作为主要数据仓库，并为有趣的门票设置SMS警报。
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Aviasales API与Amazon Kinesis的集成以及无服务器的简单性</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500382/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">哈Ha！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
你喜欢坐飞机吗？</font><font style="vertical-align: inherit;">我喜欢它，但出于自我隔离，我也喜欢分析一种著名资源Aviasales的机票数据。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今天，我们将分析Amazon Kinesis的工作，构建具有实时分析的流系统，将Amazon DynamoDB NoSQL数据库作为主要数据仓库，并为有趣的门票设置SMS警报。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所有细节都砍下！</font><font style="vertical-align: inherit;">走！</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/-n/qn/yn/-nqnynmwzv61pmiq2ocatoxseme.jpeg"></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，我们需要访问</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviasales API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">免费提供对它的访问，没有任何限制，您只需要在“开发人员”部分进行注册即可获取用于访问数据的API令牌。</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本文的主要目的是提供对AWS中流信息的使用的一般理解，我们摆脱了所用API返回的数据并非严格相关，而是从缓存中传输的问题，缓存是根据Aviasales.ru和Jetradar.com网站用户的搜索生成的持续48小时。 </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过生产者计算机上安装的API接收到的Kinesis-agent机票数据将被自动解析，并通过Kinesis Data Analytics传输到所需的流中。</font><font style="vertical-align: inherit;">该流的未处理版本将直接写入存储库。</font><font style="vertical-align: inherit;">部署在DynamoDB中的原始数据存储将允许通过BI工具（例如AWS Quick Sight）对票证进行更深入的分析。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们将考虑两种方法来部署整个基础结构：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手册-通过AWS管理控制台;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform代码的基础结构-适用于懒惰的自动化工程师；</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正在开发的系统架构</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vt/ss/mx/vtssmx0accvfcphkjvmzwdf4udg.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用的组件：</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviasales API-</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此API返回的数据将用于所有后续工作；</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EC2生产者实例</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -云中的常规虚拟机，将在其上生成输入数据流：</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kinesis Agent</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是本地安装的Java应用程序，它提供了一种简单的方法来收集数据并将其发送到Kinesis（Kinesis数据流或Kinesis Firehose）。</font><font style="vertical-align: inherit;">代理会不断监视指定目录中的一组文件，并将新数据发送到Kinesis。</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用者API脚本</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -一个Python脚本，它发出API请求并将响应放入Kinesis Agent监视的文件夹中；</font></font></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><b>Kinesis Data Streams</b></a> —            ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><b>Kinesis Analytics</b></a> —  ,        . Amazon Kinesis Data Analytics              ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><b>AWS Lambda</b></a> — ,        .        ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><b>Amazon DynamoDB</b></a> —    «‑»  ,     10      .   DynamoDB    - ,       . DynamoDB   ,        .       ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><b>Amazon SNS</b></a> —        « — » (Pub/Sub),      ,     . SNS           push-, SMS-   .</li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初步训练</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了模拟数据流，我决定使用Aviasales API返回的机票信息。</font><font style="vertical-align: inherit;">该</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档提供了</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">相当广泛的各种方法列表，其中之一是“本月的价格日历”，它返回每月的每一天的价格，并按转账次数分组。</font><font style="vertical-align: inherit;">如果您未在请求中传送搜索月份，则将返回当前月份之后的月份的信息。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，注册并获取令牌。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下示例请求：</font></font><br>
<br>
<pre><code class="bash hljs">http://api.travelpayouts.com/v2/prices/month-matrix?currency=rub&amp;origin=LED&amp;destination=HKT&amp;show_to_affiliates=<span class="hljs-literal">true</span>&amp;token=TOKEN_API</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上面的通过请求中的令牌从API接收数据的方法可以使用，但是我更喜欢通过标头传递访问令牌，因此我们将在api_caller.py脚本中使用此方法。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
答案示例：</font></font><br>
<br>
<pre><code class="json hljs">{{
   <span class="hljs-attr">"success"</span>:<span class="hljs-literal">true</span>,
   <span class="hljs-attr">"data"</span>:[{
      <span class="hljs-attr">"show_to_affiliates"</span>:<span class="hljs-literal">true</span>,
      <span class="hljs-attr">"trip_class"</span>:<span class="hljs-number">0</span>,
      <span class="hljs-attr">"origin"</span>:<span class="hljs-string">"LED"</span>,
      <span class="hljs-attr">"destination"</span>:<span class="hljs-string">"HKT"</span>,
      <span class="hljs-attr">"depart_date"</span>:<span class="hljs-string">"2015-10-01"</span>,
      <span class="hljs-attr">"return_date"</span>:<span class="hljs-string">""</span>,
      <span class="hljs-attr">"number_of_changes"</span>:<span class="hljs-number">1</span>,
      <span class="hljs-attr">"value"</span>:<span class="hljs-number">29127</span>,
      <span class="hljs-attr">"found_at"</span>:<span class="hljs-string">"2015-09-24T00:06:12+04:00"</span>,
      <span class="hljs-attr">"distance"</span>:<span class="hljs-number">8015</span>,
      <span class="hljs-attr">"actual"</span>:<span class="hljs-literal">true</span><font></font>
   }]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上面的API响应示例显示了从圣彼得堡到Phuk的机票...哦，梦to以求... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于我来自喀山，而普吉岛现在“只是在做梦”，我们将查找从圣彼得堡到喀山的机票。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">假设您已经拥有一个AWS账户。</font><font style="vertical-align: inherit;">我要立即特别注意，Kinesis和通过SMS发送通知不包含在年度</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">免费套餐（免费使用）中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">但是尽管如此，只要记住几美元，就可以构建建议的系统并使用它。</font><font style="vertical-align: inherit;">并且，当然，不要在不必要的所有资源后删除它们。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">幸运的是，如果您保持每月免费使用限制，DynamoDb和lambda函数将成为我们的共享软件。</font><font style="vertical-align: inherit;">例如，对于DynamoDB：25 GB的存储，25 WCU / RCU和1亿个请求。</font><font style="vertical-align: inherit;">每月有100万个调用lambda函数。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手动部署系统</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置Kinesis数据流</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
转到Kinesis Data Streams服务并创建两个新的流，每个流一个分片。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">什么是碎片？</font></font></b>
                        <div class="spoiler_text"> —       Amazon Kinesis.         1 /       2 /.     1000  PUT  .         . ,       .          2 /       4 /    2000  PUT  .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
流中的碎片越多，其吞吐量就越大。</font><font style="vertical-align: inherit;">原则上，通过添加分片以这种方式缩放流。</font><font style="vertical-align: inherit;">但是碎片越多，价格就越高。</font><font style="vertical-align: inherit;">每个分片每小时的费用为1.5美分，每百万个PUT有效负载单位为1.4美分。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
创建一个名称为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">airline_tickets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的新线程</font><font style="vertical-align: inherit;">，一个碎片就足够了：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f8/5p/jg/f85pjg59pxlsbjio2_yzpz1wng4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在创建另一个名为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">special_stream的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">流</font><font style="vertical-align: inherit;">：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4l/_t/eo/4l_teoxvvwv5pablkpfnv-tlnac.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生产者设定</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
作为用于解析任务的数据生产者，使用常规的EC2实例就足够了。</font><font style="vertical-align: inherit;">它不必是功能强大且昂贵的虚拟机；现货t2.micro非常适合。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要说明：例如，您应该使用映像-Amazon Linux AMI 2018.03.0，使用该映像可以快速启动Kinesis Agent的设置较少。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
转到EC2服务，创建一个新的虚拟机，然后选择t2.micro类型的所需AMI，该类型包含在Free Tier中：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3q/rg/gt/3qrggtrxqistnkvgzn0bwkfdvbk.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了使新创建的虚拟机能够与Kinesis服务交互，您必须授予它这样做的权利。</font><font style="vertical-align: inherit;">最好的方法是分配一个IAM角色。</font><font style="vertical-align: inherit;">因此，在“步骤3：配置实例详细信息”屏幕上，选择“ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建新的IAM角色”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为EC2创建IAM角色</font></font></b>
                        <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/_p/rm/xv/_prmxvgp0iv148grjwdpunwaela.jpeg"></div><br>
  , ,      EC2     Permissions:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/as/nn/zvasnnl8ootjsr6rojjfhmjtfiw.jpeg"></div><br>
             ,     : AmazonKinesisFullAccess  CloudWatchFullAccess.<br>
<br>
 -     , : EC2-KinesisStreams-FullAccess.  ,     ,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jh/rj/38/jhrj38s8czngu9ri77mu26lh_o0.jpeg"></div><br>
    ,         :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yn/he/23/ynhe23lg4gfpfbjvlphntvfypyw.jpeg"></div><br>
           . <br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
默认情况下，您也可以保留硬盘的参数，也可以保留标签（尽管使用标签是一种很好的做法，但至少要提供实例名称并指定环境）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们在“第6步：配置安全组”选项卡上，您需要在其中创建一个新的安全组或指定现有的安全组，该组允许您通过ssh（端口22）连接到实例。</font><font style="vertical-align: inherit;">选择“源”-&gt;“我的IP”，然后可以运行实例。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y7/cd/z9/y7cdz9fllra7haynrf6gyu0jkdq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
进入运行状态后，您可以尝试通过ssh连接到它。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了成功使用Kinesis Agent，在成功连接到计算机之后，必须在终端中输入以下命令：</font></font><br>
<br>
<pre><code class="bash hljs">sudo yum -y update<font></font>
sudo yum install -y python36 python36-pip<font></font>
sudo /usr/bin/pip-3.6 install --upgrade pip<font></font>
sudo yum install -y aws-kinesis-agent<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
创建用于保存API响应的文件夹：</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir /var/<span class="hljs-built_in">log</span>/airline_tickets</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在启动代理之前，您需要配置其配置：</font></font><br>
<br>
<pre><code class="bash hljs">sudo vim /etc/aws-kinesis/agent.json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
agent.json文件的内容应如下所示：</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"cloudwatch.emitMetrics"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">"kinesis.endpoint"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-attr">"firehose.endpoint"</span>: <span class="hljs-string">""</span>,<font></font>
<font></font>
  <span class="hljs-attr">"flows"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"filePattern"</span>: <span class="hljs-string">"/var/log/airline_tickets/*log"</span>,
      <span class="hljs-attr">"kinesisStream"</span>: <span class="hljs-string">"airline_tickets"</span>,
      <span class="hljs-attr">"partitionKeyOption"</span>: <span class="hljs-string">"RANDOM"</span>,
      <span class="hljs-attr">"dataProcessingOptions"</span>: [<font></font>
         {<font></font>
            <span class="hljs-attr">"optionName"</span>: <span class="hljs-string">"CSVTOJSON"</span>,
            <span class="hljs-attr">"customFieldNames"</span>: [<span class="hljs-string">"cost"</span>,<span class="hljs-string">"trip_class"</span>,<span class="hljs-string">"show_to_affiliates"</span>,
                <span class="hljs-string">"return_date"</span>,<span class="hljs-string">"origin"</span>,<span class="hljs-string">"number_of_changes"</span>,<span class="hljs-string">"gate"</span>,<span class="hljs-string">"found_at"</span>,
                <span class="hljs-string">"duration"</span>,<span class="hljs-string">"distance"</span>,<span class="hljs-string">"destination"</span>,<span class="hljs-string">"depart_date"</span>,<span class="hljs-string">"actual"</span>,<span class="hljs-string">"record_id"</span>]<font></font>
         }<font></font>
      ]<font></font>
    }<font></font>
  ]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从配置文件中可以看到，代理将监视/ var / log / airline_tickets /目录中具有.log扩展名的文件，解析它们并将其传输到airline_tickets流。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们重新启动该服务，并确保它可以启动并运行：</font></font><br>
<br>
<pre><code class="bash hljs">sudo service aws-kinesis-agent restart</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在下载Python脚本，该脚本将从API请求数据：</font></font><br>
<br>
<pre><code class="bash hljs">REPO_PATH=https://raw.githubusercontent.com/igorgorbenko/aviasales_kinesis/master/producer<font></font>
<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/api_caller.py -P /home/ec2-user/<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/requirements.txt -P /home/ec2-user/<font></font>
sudo chmod a+x /home/ec2-user/api_caller.py<font></font>
sudo /usr/<span class="hljs-built_in">local</span>/bin/pip3 install -r /home/ec2-user/requirements.txt
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
api_caller.py脚本从Aviasales请求数据，并将收到的响应保存在Kinesis代理扫描的目录中。</font><font style="vertical-align: inherit;">这个脚本的实现是相当标准的，有一个TicketsApi类，它允许您异步提取API。</font><font style="vertical-align: inherit;">在此类中，我们传递带有令牌和请求参数的标头：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsApi</span>:</span>
    <span class="hljs-string">"""Api caller class."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, headers</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.base_url = BASE_URL<font></font>
        self.headers = headers<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">self, data</span>):</span>
        <span class="hljs-string">"""Get the data from API query."""</span><font></font>
        response_json = {}<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(headers=self.headers) <span class="hljs-keyword">as</span> session:
            <span class="hljs-keyword">try</span>:<font></font>
                response = <span class="hljs-keyword">await</span> session.get(self.base_url, data=data)<font></font>
                response.raise_for_status()<font></font>
                LOGGER.info(<span class="hljs-string">'Response status %s: %s'</span>,<font></font>
                            self.base_url, response.status)<font></font>
                response_json = <span class="hljs-keyword">await</span> response.json()
            <span class="hljs-keyword">except</span> HTTPError <span class="hljs-keyword">as</span> http_err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! HTTP error occurred: %s'</span>, str(http_err))
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! An error ocurred: %s'</span>, str(err))
            <span class="hljs-keyword">return</span> response_json<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepare_request</span>(<span class="hljs-params">api_token</span>):</span>
    <span class="hljs-string">"""Return the headers and query fot the API request."""</span>
    headers = {<span class="hljs-string">'X-Access-Token'</span>: api_token,
               <span class="hljs-string">'Accept-Encoding'</span>: <span class="hljs-string">'gzip'</span>}<font></font>
<font></font>
    data = FormData()<font></font>
    data.add_field(<span class="hljs-string">'currency'</span>, CURRENCY)<font></font>
    data.add_field(<span class="hljs-string">'origin'</span>, ORIGIN)<font></font>
    data.add_field(<span class="hljs-string">'destination'</span>, DESTINATION)<font></font>
    data.add_field(<span class="hljs-string">'show_to_affiliates'</span>, SHOW_TO_AFFILIATES)<font></font>
    data.add_field(<span class="hljs-string">'trip_duration'</span>, TRIP_DURATION)
    <span class="hljs-keyword">return</span> headers, data<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-string">"""Get run the code."""</span>
    <span class="hljs-keyword">if</span> len(sys.argv) != <span class="hljs-number">2</span>:<font></font>
        print(<span class="hljs-string">'Usage: api_caller.py &lt;your_api_token&gt;'</span>)<font></font>
        sys.exit(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span>
    api_token = sys.argv[<span class="hljs-number">1</span>]<font></font>
    headers, data = prepare_request(api_token)<font></font>
<font></font>
    api = TicketsApi(headers)<font></font>
    response = <span class="hljs-keyword">await</span> api.get_data(data)
    <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'success'</span>, <span class="hljs-literal">None</span>):<font></font>
        LOGGER.info(<span class="hljs-string">'API has returned %s items'</span>, len(response[<span class="hljs-string">'data'</span>]))
        <span class="hljs-keyword">try</span>:<font></font>
            count_rows = log_maker(response)<font></font>
            LOGGER.info(<span class="hljs-string">'%s rows have been saved into %s'</span>,<font></font>
                        count_rows,<font></font>
                        TARGET_FILE)<font></font>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
            LOGGER.error(<span class="hljs-string">'Oops! Request result was not saved to file. %s'</span>,<font></font>
                         str(e))<font></font>
    <span class="hljs-keyword">else</span>:<font></font>
        LOGGER.error(<span class="hljs-string">'Oops! API request was unsuccessful %s!'</span>, response)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了测试代理的正确设置和可操作性，我们将对api_caller.py脚本进行测试运行：</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/u8/17/rr/u817rrbmcgutepqlpx-aa7k2mo4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们会在座席的日志中以及airline_tickets数据流中的“监视”选项卡上查看工作结果：</font></font><br>
<br>
<pre><code class="bash hljs">tail -f /var/<span class="hljs-built_in">log</span>/aws-kinesis-agent/aws-kinesis-agent.log</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/5r/oy/ep5royv-vndczuzfhaufx2duuau.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/g3/pi/ya/g3piyaltiksnogpxwm0temjdpz4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如您所见，一切正常，Kinesis Agent成功将数据发送到流。</font><font style="vertical-align: inherit;">现在配置使用者。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置Kinesis Data Analytics</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们继续整个系统的中心组件-在Kinesis Data Analytics中创建一个名为kinesis_analytics_airlines_app的新应用程序：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dp/0s/4a/dp0s4aesniewnc3j7envuvi2lqa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kinesis Data Analytics支持使用SQL对Kinesis Streams中的数据进行实时分析。</font><font style="vertical-align: inherit;">这是一个完全可自动缩放的服务（与Kinesis Streams不同），该服务：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">允许您基于对源数据的查询来创建新流（输出流）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提供具有在应用程序操作期间发生的错误的流（错误流）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它可以自动确定输入数据方案（必要时可以手动重新定义）。</font></font></li>
</ol><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是一项昂贵的服务-每小时0.11 USD，因此您应谨慎使用它，并在完成工作后将其删除。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
将应用程序连接到数据源：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/sc/g6/2xscg6tquygvrr4dxhjofyxjx-m.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
选择您要连接的流（airline_tickets）：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/c7/ma/y1c7ma8a_9n3wwwokqleszry-qa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接下来，您需要附加新的IAM角色，以便应用程序可以从流中读取并写入流中。</font><font style="vertical-align: inherit;">为此，只要不更改访问权限块中的任何内容即可：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dg/96/wq/dg96wq1hgmmd0ouhxpxs8r0tjss.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，我们请求在流中发现数据方案，为此，我们单击“发现模式”按钮。</font><font style="vertical-align: inherit;">结果，将更新IAM角色（将创建一个新角色），并将启动从流中已经到达的数据中发现方案的过程：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5e/co/6r/5eco6ro21kgrevovywr-2ulfysw.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您需要转到SQL编辑器。</font><font style="vertical-align: inherit;">当您单击此按钮时，将出现一个有关启动应用程序的问题的窗口-选择我们要运行的内容：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kt/oc/ta/ktoctaokxjgsxbosk5eu8-yw_e0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在“ SQL编辑器”窗口中，插入一个简单的查询，然后单击“保存并运行SQL”：</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> STREAM <span class="hljs-string">"DESTINATION_SQL_STREAM"</span> (<span class="hljs-string">"cost"</span> <span class="hljs-keyword">DOUBLE</span>, <span class="hljs-string">"gate"</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">16</span>));<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> PUMP <span class="hljs-string">"STREAM_PUMP"</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"DESTINATION_SQL_STREAM"</span>
<span class="hljs-keyword">SELECT</span> STREAM <span class="hljs-string">"cost"</span>, <span class="hljs-string">"gate"</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"SOURCE_SQL_STREAM_001"</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-string">"cost"</span> &lt; <span class="hljs-number">5000</span>
    <span class="hljs-keyword">and</span> <span class="hljs-string">"gate"</span> = <span class="hljs-string">'Aeroflot'</span>;
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在关系数据库中，可以使用INSERT语句来添加记录并使用SELECT语句来查询数据的表。</font><font style="vertical-align: inherit;">在Amazon Kinesis Data Analytics中，您使用流（STREAM）和“泵”（PUMP）-连续插入请求，这些请求将数据从应用程序中的一个流插入到另一个流中。</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在上面的SQL查询中，以低于五千卢布的价格搜索Aeroflot机票。</font><font style="vertical-align: inherit;">属于这些条件的所有记录都将放置在DESTINATION_SQL_STREAM流中。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l7/zk/8l/l7zk8ltrlivhjnmj3u1xcvazwai.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在目标块中，选择special_stream流，然后在应用程序内流名称DESTINATION_SQL_STREAM下拉列表中：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5r/5s/7r/5r5s7rpwfezpiyjokrby1jkmcly.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
经过所有操作，结果应类似于下图：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/o3/_b/4co3_blpb57-arskyc7jwsc2d_i.jpeg"></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建和订阅SNS主题</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
转到简单通知服务，然后创建一个名为“航空公司”的新主题：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/su/ur/zr/suurzrkeqmmm7jk3-j5iuqaiar8.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们订阅了该主题，在其中指明了SMS通知将到达的手机号码：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/gc/sz/epgcszgapjrsl4-jhx7vktgi7fi.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在DynamoDB中创建表</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要存储其airline_tickets流的原始数据，请在DynamoDB中创建一个具有相同名称的表。</font><font style="vertical-align: inherit;">作为主键，我们将使用record_id：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/t7/td/4e/t7td4eq2asrdur1arxzbmsuthdk.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建Lambda收集器函数</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们创建一个称为收集器的lambda函数，该函数的任务是轮询airline_tickets流，如果那里有新记录，则将这些记录插入DynamoDB表中。</font><font style="vertical-align: inherit;">显然，除了默认权限外，此lambda还必须有权读取Kinesis数据流并写入DynamoDB。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为Lambda收集器功能创建IAM角色</font></font></b>
                        <div class="spoiler_text">    IAM      Lambda-TicketsProcessingRole:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s9/sv/_f/s9sv_fh7p4flqdklnzh5rohd9ws.jpeg"></div><br>
       AmazonKinesisReadOnlyAccess  AmazonDynamoDBFullAccess,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/v0/zy/f_v0zyuhd3h9y5e9tiuurfbpqnq.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/78/db/ge/78dbgeqrxjuuh6rzlqd-k1qdgee.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当新条目击中airline_stream流时，该lambda应该由Kinesis触发器触发，因此您需要添加一个新触发器：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qt/h0/gg/qth0ggplzpl1afpad4shlgl_tbu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/we/2c/ip/we2cipjv713dvyo10ry4wmyrdi0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仍然需要插入代码并保存lambda。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-string">"""Parsing the stream and inserting into the DynamoDB table."""</span>
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> decimal <span class="hljs-keyword">import</span> Decimal<font></font>
<font></font>
DYNAMO_DB = boto3.resource(<span class="hljs-string">'dynamodb'</span>)<font></font>
TABLE_NAME = <span class="hljs-string">'airline_tickets'</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsParser</span>:</span>
    <span class="hljs-string">"""Parsing info from the Stream."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, table_name, records</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.table = DYNAMO_DB.Table(table_name)<font></font>
        self.json_data = TicketsParser.get_json_data(records)<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_json_data</span>(<span class="hljs-params">records</span>):</span>
        <span class="hljs-string">"""Return deserialized data from the stream."""</span>
        decoded_record_data = ([base64.b64decode(record[<span class="hljs-string">'kinesis'</span>][<span class="hljs-string">'data'</span>])
                                <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> records])<font></font>
        json_data = ([json.loads(decoded_record)<font></font>
                      <span class="hljs-keyword">for</span> decoded_record <span class="hljs-keyword">in</span> decoded_record_data])
        <span class="hljs-keyword">return</span> json_data<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_item_from_json</span>(<span class="hljs-params">json_item</span>):</span>
        <span class="hljs-string">"""Pre-process the json data."""</span><font></font>
        new_item = {<font></font>
            <span class="hljs-string">'record_id'</span>: json_item.get(<span class="hljs-string">'record_id'</span>),
            <span class="hljs-string">'cost'</span>: Decimal(json_item.get(<span class="hljs-string">'cost'</span>)),
            <span class="hljs-string">'trip_class'</span>: json_item.get(<span class="hljs-string">'trip_class'</span>),
            <span class="hljs-string">'show_to_affiliates'</span>: json_item.get(<span class="hljs-string">'show_to_affiliates'</span>),
            <span class="hljs-string">'origin'</span>: json_item.get(<span class="hljs-string">'origin'</span>),
            <span class="hljs-string">'number_of_changes'</span>: int(json_item.get(<span class="hljs-string">'number_of_changes'</span>)),
            <span class="hljs-string">'gate'</span>: json_item.get(<span class="hljs-string">'gate'</span>),
            <span class="hljs-string">'found_at'</span>: json_item.get(<span class="hljs-string">'found_at'</span>),
            <span class="hljs-string">'duration'</span>: int(json_item.get(<span class="hljs-string">'duration'</span>)),
            <span class="hljs-string">'distance'</span>: int(json_item.get(<span class="hljs-string">'distance'</span>)),
            <span class="hljs-string">'destination'</span>: json_item.get(<span class="hljs-string">'destination'</span>),
            <span class="hljs-string">'depart_date'</span>: json_item.get(<span class="hljs-string">'depart_date'</span>),
            <span class="hljs-string">'actual'</span>: json_item.get(<span class="hljs-string">'actual'</span>)<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> new_item<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">"""Batch insert into the table."""</span>
        <span class="hljs-keyword">with</span> self.table.batch_writer() <span class="hljs-keyword">as</span> batch_writer:
            <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.json_data:<font></font>
                dynamodb_item = TicketsParser.get_item_from_json(item)<font></font>
                batch_writer.put_item(dynamodb_item)<font></font>
<font></font>
        print(<span class="hljs-string">'Has been added '</span>, len(self.json_data), <span class="hljs-string">'items'</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-string">"""Parse the stream and insert into the DynamoDB table."""</span>
    print(<span class="hljs-string">'Got event:'</span>, event)<font></font>
    parser = TicketsParser(TABLE_NAME, event[<span class="hljs-string">'Records'</span>])<font></font>
    parser.run()<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建Lambda函数通知程序</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以相同的方式创建第二个lambda函数，该函数将监视第二个流（special_stream）并向SNS发送通知。</font><font style="vertical-align: inherit;">因此，此lambda必须具有来自Kinesis的读取访问权限，并将消息发送到指定的SNS主题，然后由SNS服务将其发送给该主题的所有订户（电子邮件，SMS等）。</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建IAM角色</font></font></b>
                        <div class="spoiler_text">  IAM  Lambda-KinesisAlarm   ,         alarm_notifier:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zm/fn/ru/zmfnru75p-tp0y1fqzxaoea2xos.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yp/vp/u0/ypvpu0jl74aak54hl-d4wf7r1kc.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该lambda应该根据触发新条目进入special_stream的触发器来工作，因此您需要以与收集器lambda相同的方式配置触发器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了方便配置此lambda，我们引入了一个新的环境变量TOPIC_ARN，在其中放置了Airlines的ANR（亚马逊资源名称）主题：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/43/nn/qf/43nnqfmsnahbfu30k5mqadhbuhi.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并插入lambda代码，这非常简单：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> os<font></font>
<font></font>
SNS_CLIENT = boto3.client(<span class="hljs-string">'sns'</span>)<font></font>
TOPIC_ARN = os.environ[<span class="hljs-string">'TOPIC_ARN'</span>]<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-keyword">try</span>:<font></font>
        SNS_CLIENT.publish(TopicArn=TOPIC_ARN,<font></font>
                           Message=<span class="hljs-string">'Hi! I have found an interesting stuff!'</span>,<font></font>
                           Subject=<span class="hljs-string">'Airline tickets alarm'</span>)<font></font>
        print(<span class="hljs-string">'Alarm message has been successfully delivered'</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
        print(<span class="hljs-string">'Delivery failure'</span>, str(err))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
看来这完成了手动系统配置。</font><font style="vertical-align: inherit;">仅用于测试并确保我们正确配置了所有内容。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从Terraform代码进行部署</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要的准备</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个非常方便的开源工具，用于通过代码部署基础架构。</font><font style="vertical-align: inherit;">它具有自己的语法，易于学习，并提供了许多有关如何部署以及部署什么的示例。</font><font style="vertical-align: inherit;">Atom或Visual Studio代码编辑器中有许多方便的插件，这些插件使使用Terraform更加容易。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下载分发工具包</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">对Terraform的所有功能的详细分析不在本文的讨论范围之内，因此我们将限制自己的重点。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如何开始</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完整的项目代码</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在我的存储库中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我们为自己克隆一个存储库。</font><font style="vertical-align: inherit;">在开始之前，您需要确保已安装并配置了AWS CLI，如下所示 </font><font style="vertical-align: inherit;">Terraform将在〜/ .aws /凭证文件中查找凭证。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在启动plan命令之前先部署整个基础架构是一个好习惯，以查看Terraform现在正在云中为我们创建的内容：</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe plan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
系统将提示您输入电话号码以向其发送通知。</font><font style="vertical-align: inherit;">在此阶段，它是可选的。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/e3/-i/ps/e3-ipsgvy03inzbw_26haktayk4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在分析了程序的工作计划之后，我们可以开始创建资源：</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe apply</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
发送此命令后，将再次要求您输入电话号码，并在显示有关实际执行操作的问题时键入“是”。</font><font style="vertical-align: inherit;">这将使您能够提升整个基础架构，执行EC2的所有必要设置，部署lambda函数等。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过Terraform代码成功创建所有资源后，您需要进入Kinesis Analytics应用程序的详细信息（不幸的是，我没有直接从代码中找到如何执行此操作）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
启动应用程序：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/ns/qc/qxnsqcjpbkiaradzqomahtxzhnu.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
之后，您必须通过从下拉列表中进行选择来显式设置应用程序内流名称：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ki/m5/pl/kim5plwariaz8bp-qo-qonli4yu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hg/69/kf/hg69kfwwtwhwkzxlpnb7g3k2ctm.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在一切准备就绪。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应用测试</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
无论您是如何手动部署系统还是通过Terraform代码部署系统，其工作方式都一样。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们通过SSH进入安装了Kinesis Agent的EC2虚拟机，并运行api_caller.py脚本</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
等待短信到您的电话号码仍然是： </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/98/ui/mc/98uimcirxv_n6pglm2qz5jtkvf4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
短信-短信将在1分钟内到达电话： </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kg/u7/dj/kgu7djc9xgex84h349dlpfukivg.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
记录是否保存在DynamoDB数据库中以进行后续更详细的分析还有待观察。</font><font style="vertical-align: inherit;">airline_tickets表包含以下内容：</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/dj/vc/gqdjvcmx0q45o_sgqc_l5po_l-c.jpeg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在完成工作的过程中，构建了基于Amazon Kinesis的在线数据处理系统。</font><font style="vertical-align: inherit;">我们检查了将Kinesis Agent与Kinesis Data Streams结合使用以及使用SQL命令对Kinesis Analytics进行实时分析的选项，以及Amazon Kinesis与其他AWS服务的交互。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们以两种方式部署上述系统：足够长的手动时间和从Terraform代码快速获取的时间。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该项目的整个源代码都可以</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在我在GitHub上的存储库中找到</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，建议您熟悉一下它。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我准备愉快地讨论这篇文章，我在等待您的评论。</font><font style="vertical-align: inherit;">我希望进行建设性的批评。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
祝你成功！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN500364/index.html">在Moodle和BigBlueButton上扩展学校学习门户</a></li>
<li><a href="../zh-CN500368/index.html">生成可预测的随机序列：一种不同的置换方法</a></li>
<li><a href="../zh-CN500370/index.html">面向2020年值得订阅的10个有用的英语播客</a></li>
<li><a href="../zh-CN500378/index.html">工作中有效的信息搜索</a></li>
<li><a href="../zh-CN500380/index.html">远程处理个人数据：风险和可能的后果</a></li>
<li><a href="../zh-CN500384/index.html">皮克斯工作室先锋获得图灵奖和一百万美元</a></li>
<li><a href="../zh-CN500386/index.html">使您现有的业务解决方案适应SwiftUI。第2部分</a></li>
<li><a href="../zh-CN500390/index.html">IT和数字通信领域中语言本地化的实际模型。第1部分</a></li>
<li><a href="../zh-CN500396/index.html">自主访问控制系统的问题-他们没有想到的地方</a></li>
<li><a href="../zh-CN500398/index.html">远程马拉松周3：无效的过程</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>