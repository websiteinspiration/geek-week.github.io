<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙋🏾 👂🏽 ✔️ PostgreSQLのWAL：2.事前記録ログ ➗ 🥗 🔜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前回、共有メモリの重要なオブジェクトの1つであるバッファキャッシュのデバイスに出会いました。RAMから情報が失われる可能性は、障害からの回復が必要な主な理由です。今日はこれらのツールについてお話します。
 
 マガジン
 悲しいかな、奇跡は起こりません。RAM内の情報の損失を生き残るために、必要なす...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQLのWAL：2.事前記録ログ</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/459250/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前回</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、共有メモリの重要なオブジェクトの1つであるバッファキャッシュのデバイスに出会いました。</font><font style="vertical-align: inherit;">RAMから情報が失われる可能性は、障害からの回復が必要な主な理由です。</font><font style="vertical-align: inherit;">今日はこれらのツールについてお話します。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マガジン</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
悲しいかな、奇跡は起こりません。RAM内の情報の損失を生き残るために、必要なすべてのものをディスク（または他の不揮発性デバイス）にタイムリーに書き込む必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、これが行われたことです。データの変更に加えて、</font><font style="vertical-align: inherit;">これらの変更の</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ジャーナル</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">も保持され</font><font style="vertical-align: inherit;">ます。バッファキャッシュのページで何かを変更すると、この変更に関するログエントリが作成されます。レコードには、必要に応じて変更を繰り返すことができるように十分な最小限の情報が含まれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが機能するには</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変更されたページがそこ</font><font style="vertical-align: inherit;">に到達</font><em><font style="vertical-align: inherit;">する前</font></em><font style="vertical-align: inherit;">に、ジャーナルエントリがディスク</font><em><font style="vertical-align: inherit;">に</font></em><font style="vertical-align: inherit;">移動する必要</font><font style="vertical-align: inherit;">があります。したがって、その名前は</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PreRecordマガジン</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（先読みログ）です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
障害が発生した場合、ディスク上のデータは不整合な状態にあります。一部のページは以前に書き込まれ、一部は後で書き込まれました。ただし、障害が発生する前にすでに完了しているが、その結果がディスクに到達しなかった操作によって読み取りおよび再実行できるジャーナルが残っています。</font></font><br>
<a name="habracut"></a><br>
<blockquote>         ,      ? ,  .<br>
-,  —      . &nbsp;   HDD-  .      — ,          .<br>
-,      ,  .<br>
-,       ,            (    ).<br>
  -,    ,  (   )      ,       .<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
障害が発生した場合にディスクで不整合のリスクがあるすべての操作をログに記録する必要があります。</font><font style="vertical-align: inherit;">特に、次のアクションがログに記録されます。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッファキャッシュ内のページの変更（原則として、これらはテーブルとインデックスのページです）-変更されたページはすぐにはディスクに移動しないため。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トランザクションのコミットとキャンセル-ステータスの変更はXACTバッファーで発生し、すぐにはディスクに到達しません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル操作（ファイルとディレクトリの作成と削除、たとえば、テーブル作成時のファイルの作成）-これらの操作はデータ変更と同時に発生する必要があるため。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログに記録されません：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ジャーナル化されていない（ログに記録されていない）テーブルの操作-それらの名前はそれ自体を表しています。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一時テーブルを使用した操作-そのようなテーブルの存続期間は、それらを作成したセッションの存続期間を超えないため、意味がありません。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PostgreSQL 10より前のバージョンでは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハッシュインデックスは</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ログに記録さ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">れ</font></a><font style="vertical-align: inherit;">ませんでした</font><font style="vertical-align: inherit;">（ハッシュ関数を異なるデータタイプにマップするためだけに機能しました）が、これは修正されました。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">論理デバイス</font></font></h1><br>
<img src="https://habrastorage.org/webt/vx/vj/67/vxvj673dzyqmhumlxby7i8wt5q0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
論理的には、ジャーナルはさまざまな長さの一連のレコードと考えることができます。</font><font style="vertical-align: inherit;">各レコードには</font><font style="vertical-align: inherit;">、特定の操作に関する</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が含まれており</font><font style="vertical-align: inherit;">、その前に標準</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ヘッダー</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が付いています</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">タイトルは、とりわけ、次のことを示しています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レコードが属するトランザクション番号。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リソースマネージャー-記録を担当するシステムのコンポーネント。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェックサム（CRC）-データの破損を判別できます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レコード長と前のレコードへのリンク。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データ自体の形式と意味は異なります。</font><font style="vertical-align: inherit;">たとえば、特定のオフセットを使用してコンテンツに上書きする必要があるページのフラグメントを表すことができます。</font><font style="vertical-align: inherit;">指定されたリソースマネージャは、レコード内のデータを解釈する方法を「理解」します。</font><font style="vertical-align: inherit;">テーブル、インデックスのタイプ、トランザクションのステータスなどの個別のマネージャーがあります。コマンドで必要に応じて、それらの完全なリストを取得できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">pg_waldump -r list
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">物理デバイス</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ディスクでは、ログは$ PGDATA / pg_walディレクトリにファイルとして保存されます。各ファイルのデフォルトは16 MBです。 1つのディレクトリに多数のファイルが存在しないように、サイズを増やすことができます。 PostgreSQL 11より前のバージョンでは、これはソースコードのコンパイル時にのみ実行できましたが、クラスター（key </font></font><code>--wal-segsize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">初期化時にサイズを指定できるようになりました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログエントリは現在使用中のファイルに分類されます。それが終了すると、次のものが使用され始めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーの共有メモリ内のログに特別なバッファが割り当てられます。ジャーナルキャッシュのサイズは</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wal_buffers</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パラメータによって設定されます</font><font style="vertical-align: inherit;">（デフォルト値は自動構成を意味します：バッファキャッシュの1/32が割り当てられます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ジャーナルキャッシュはバッファキャッシュのように配置されますが、主にリングバッファモードで機能します。レコードは「ヘッド」に追加され、「テール」からディスクに書き込まれます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記録（「テール」）および挿入（「ヘッド」）の位置は、それぞれ関数pg_current_wal_lsnおよびpg_current_wal_insert_lsnを示しています。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> pg_current_wal_lsn(), pg_current_wal_insert_lsn();
</code></pre><pre><code class="plaintext hljs"> pg_current_wal_lsn | pg_current_wal_insert_lsn <font></font>
--------------------+---------------------------<font></font>
 0/331E4E64         | 0/331E4EA0<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
特定のレコードを参照するために、データ型pg_lsn（LSN =ログシーケンス番号）が使用されます。これは、ログの先頭からのレコードの前のバイトオフセットを表す64ビットの数値です。</font><font style="vertical-align: inherit;">LSNは2つの32ビット数値として16進表記で出力されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どのファイルで目的の位置を見つけるか、ファイルの先頭からのオフセットを調べることができます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> file_name, upper(to_hex(file_offset)) file_offset
<span class="hljs-keyword">FROM</span> pg_walfile_name_offset(<span class="hljs-string">'0/331E4E64'</span>);
</code></pre><pre><code class="plaintext hljs">        file_name         | file_offset <font></font>
--------------------------+-------------<font></font>
 000000010000000000000033 | 1E4E64<font></font>
 \      /\                       /<font></font>
           0/331E4E64<font></font>
 <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイル名は2つの部分で構成されます。</font><font style="vertical-align: inherit;">上位8桁の16進数はタイムブランチの番号を示し（バックアップからの復元時に使用されます）、残りは上位LSN桁に対応します（残りの下位LSN桁はオフセットを示します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ログファイルは$ PGDATA / pg_wal /ディレクトリのファイルシステムで表示できますが、PostgreSQL 10以降、特別な関数を使用して表示することもできます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> pg_ls_waldir() <span class="hljs-keyword">WHERE</span> <span class="hljs-type">name</span> = <span class="hljs-string">'000000010000000000000033'</span>;
</code></pre><pre><code class="plaintext hljs">           name           |   size   |      modification      <font></font>
--------------------------+----------+------------------------<font></font>
 000000010000000000000033 | 16777216 | 2019-07-08 20:24:13+03<font></font>
(1 row)<font></font>
</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フォワード書き込み</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ジャーナリングがどのように発生し、プロアクティブな記録がどのように提供されるかを見てみましょう。</font><font style="vertical-align: inherit;">テーブルを作成します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> wal(id <span class="hljs-type">integer</span>);<font></font>
=&gt; <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> wal <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルページのヘッダーを確認します。</font><font style="vertical-align: inherit;">これを行うには、すでにおなじみの拡張機能が必要です。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">EXTENSION</span> pageinspect;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクションを開始して、ログの挿入位置を覚えておきましょう。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">BEGIN</span>;<font></font>
=&gt; <span class="hljs-keyword">SELECT</span> pg_current_wal_insert_lsn();
</code></pre><pre><code class="plaintext hljs"> pg_current_wal_insert_lsn <font></font>
---------------------------<font></font>
 0/331F377C<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、いくつかの操作を実行してみましょう。たとえば、次の行を更新します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">UPDATE</span> wal <span class="hljs-keyword">set</span> id = id + <span class="hljs-number">1</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この変更はログに記録され、挿入位置が変更されました：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> pg_current_wal_insert_lsn();
</code></pre><pre><code class="plaintext hljs"> pg_current_wal_insert_lsn <font></font>
---------------------------<font></font>
 0/331F37C4<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変更されたデータページがジャーナルエントリの前にディスクにプッシュされないようにするために、このページに関連する最後のジャーナルエントリのLSNがページヘッダーに格納されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> lsn <span class="hljs-keyword">FROM</span> page_header(get_raw_page(<span class="hljs-string">'wal'</span>,<span class="hljs-number">0</span>));
</code></pre><pre><code class="plaintext hljs">    lsn     <font></font>
------------<font></font>
 0/331F37C4<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ジャーナルはクラスタ全体に共通であり、新しいエントリは常にそこに含まれることに注意してください。</font><font style="vertical-align: inherit;">したがって、ページのLSNは、pg_current_wal_insert_lsn関数が返したばかりの値よりも小さい場合があります。</font><font style="vertical-align: inherit;">しかし、私たちのシステムでは何も起こらないので、数字は同じです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクションを完了します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">COMMIT</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コミットレコードもログに記録され、位置が再び変更されます。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> pg_current_wal_insert_lsn();
</code></pre><pre><code class="plaintext hljs"> pg_current_wal_insert_lsn <font></font>
---------------------------<font></font>
 0/331F37E8<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コミットは、XACTと呼ばれる構造でトランザクションのステータスを変更します（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すでに説明しました</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。ステータスはファイルに保存されますが、共有メモリの128ページを占有する独自のキャッシュも使用します。したがって、XACTページの場合、最後のジャーナルエントリのLSNを追跡する必要があります。ただし、この情報はページ自体ではなくRAMに保存されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ある時点で、作成されたジャーナルエントリがディスクに書き込まれます。どちらの場合-別の機会に話しますが、この場合、これはすでに発生しています。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> pg_current_wal_lsn(), pg_current_wal_insert_lsn();
</code></pre><pre><code class="plaintext hljs"> pg_current_wal_lsn | pg_current_wal_insert_lsn <font></font>
--------------------+---------------------------<font></font>
 0/331F37E8         | 0/331F37E8<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この後、データおよびXACTページをキャッシュからプッシュできます。しかし、それを早期に強制する必要がある場合は、それが検出され、ジャーナルエントリが最初に強制的に記録されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つのLSN位置がわかっているので、それらの間のジャーナルエントリのサイズ（バイト単位）を、一方の位置から他方の位置を引くだけで取得できます。位置をpg_lsnタイプにキャストする必要があります：</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> <span class="hljs-string">'0/331F37E8'</span>::pg_lsn - <span class="hljs-string">'0/331F377C'</span>::pg_lsn;
</code></pre><pre><code class="plaintext hljs"> ?column? <font></font>
----------<font></font>
      108<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、行の更新とコミットには、ログに108バイトが必要でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、特定の負荷で時間単位ごとにサーバーによって生成されるジャーナルエントリの量を見積もることができます。これは、セットアップ中に必要となる重要な情報です（次回説明します）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、pg_waldumpユーティリティを使用して、作成されたジャーナルエントリを確認します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ユーティリティはLSN範囲（この例のように）を操作して、指定されたトランザクションのレコードを選択できます。ディスク上のログファイルにアクセスする必要があるため、postgres OSユーザーの代わりに実行する必要があります。</font></font><br>
<br>
<pre><code class="plaintext hljs">postgres$ /usr/lib/postgresql/11/bin/pg_waldump -p /var/lib/postgresql/11/main/pg_wal -s 0/331F377C -e 0/331F37E8 000000010000000000000033
</code></pre><pre><code class="plaintext hljs">rmgr: Heap        len (rec/tot):     69/    69, tx:     101085, lsn: 0/331F377C, prev 0/331F3014, desc: HOT_UPDATE off 1 xmax 101085 ; new off 2 xmax 0, blkref #0: rel 1663/16386/33081 blk 0
</code></pre><pre><code class="plaintext hljs">rmgr: Transaction len (rec/tot):     34/    34, tx:     101085, lsn: 0/331F37C4, prev 0/331F377C, desc: COMMIT 2019-07-08 20:24:13.945435 MSK
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここに、2つのエントリのヘッダーが表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つ目は、</font><font style="vertical-align: inherit;">ヒープリソースマネージャーに関連する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HOT_UPDATE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">ファイル名とページ番号はblkrefフィールドに示され、更新されたテーブルページと一致します。</font></font><br>
<br>
<pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword">SELECT</span> pg_relation_filepath(<span class="hljs-string">'wal'</span>);
</code></pre><pre><code class="plaintext hljs"> pg_relation_filepath <font></font>
----------------------<font></font>
 base/16386/33081<font></font>
(1 row)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のエントリは、トランザクションリソースマネージャに関連するCOMMITです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も読みやすい形式ではありませんが、必要に応じてそれを理解できます。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">回復</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーを起動すると、postmasterプロセスが最初に起動し、次にpostmasterプロセスが起動プロセスを起動します。起動タスクは、障害が発生した場合の回復を確実にするためのものです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リカバリが必要かどうかを判断するために、スタートアップは特別な制御ファイル$ PGDATA / global / pg_controlを調べ、クラスターのステータスを調べます。</font><font style="vertical-align: inherit;">pg_controldataユーティリティを使用して、自分でステータスを確認できます。</font></font><br>
<br>
<pre><code class="plaintext hljs">postgres$ /usr/lib/postgresql/11/bin/pg_controldata -D /var/lib/postgresql/11/main | grep state
</code></pre><pre><code class="plaintext hljs">Database cluster state:               in production
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
きちんと停止したサーバーのステータスは「シャットダウン」になります。サーバーが機能せず、ステータスが「稼働中」のままである場合は、DBMSが落ちてから、復元が自動的に実行されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
復元するために、起動プロセスはログを順次読み取り、必要に応じてページにエントリを適用します。ディスク上のページのLSNとジャーナルエントリのLSNを比較することで、必要性を確認できます。ページのLSNが大きい場合、レコードを適用する必要はありません。しかし、実際には、レコードは厳密に一貫したアプリケーション用に設計されているため、それさえ不可能です。</font></font><br>
<br>
<blockquote> .        (FPI, full page image),  ,           —     ,   .           XACT —        LSN.<br>
</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リカバリ中のページの変更は、通常の作業と同様に、バッファキャッシュで行われます。このポストマスターの場合、必要なバックグラウンドプロセスが開始されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様に、ジャーナルエントリはファイルに適用されます。たとえば、ファイルには存在する必要があると記録されているが存在しない場合、ファイルが作成されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、回復プロセスの最後に、すべての非ジャーナルテーブルは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期層の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ダミー」で上書きされます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはアルゴリズムの非常に単純化された表現です。特に、ジャーナルエントリの読み取りを開始する場所については何も述べていません（この会話は、チェックポイントが考慮されるまで延期する必要があります）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後の説明。</font><font style="vertical-align: inherit;">「クラシック」リカバリプロセスは2つのフェーズで構成されます。</font><font style="vertical-align: inherit;">最初のフェーズ（ロールフォワード）では、ジャーナルエントリがロールされ、サーバーは障害中に失われたすべての作業を繰り返します。</font><font style="vertical-align: inherit;">2番目（ロールバック）では、障害発生時にコミットされなかったトランザクションがロールバックされます。</font><font style="vertical-align: inherit;">ただし、PostgreSQLには第2フェーズは必要ありません。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以前</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">検討したように</font></a><font style="vertical-align: inherit;">、マルチバージョントランザクションの実装の機能により、物理的にロールバックする必要はありません。</font><font style="vertical-align: inherit;">XACTで修正ビットが設定されないことで十分です。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">続くこと</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja459240/index.html">統合失調症と診断されたITの10年、生存のヒント</a></li>
<li><a href="../ja459242/index.html">T + Conf 2019カンファレンスに続いて</a></li>
<li><a href="../ja459244/index.html">ノート製品マネージャー：アプリストアのゲームページでのユーザーの行動。ゲームのダウンロードにはどのくらい時間がかかりますか</a></li>
<li><a href="../ja459246/index.html">サイトコンバージョンが減少しているのはなぜですか？60のデザインとユーザビリティエラーの例</a></li>
<li><a href="../ja459248/index.html">7月9日から7月14日までのモスクワでのデジタルイベント</a></li>
<li><a href="../ja459252/index.html">セキュリティウィーク28：スマートホームのハッキング</a></li>
<li><a href="../ja459254/index.html">さらに良いジップボム</a></li>
<li><a href="../ja459256/index.html">テーマ病院をさまざまなプラットフォームに最適化した方法</a></li>
<li><a href="../ja459258/index.html">フックしない14,000マイル</a></li>
<li><a href="../ja459262/index.html">22歳で引退</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>