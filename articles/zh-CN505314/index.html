<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☪️ 🖥️ 🤾🏼 Linux时间同步：NTP，Chrony和systemd-timesyncd 🧙🏿 🔧 👨🏽‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大多数人会跟踪时间。我们准时起床执行早晨的仪式，然后上班，休息一下午餐，按时完成项目，庆祝生日和假期，登机等等。
 
 而且：我们当中有些人痴迷于时间。我的手表由太阳能供电，并通过WWVB Longwave Radio从科罗拉多州柯林斯堡的国家标准与技术研究院（NIST）获得准确的时间。时间信号与也...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Linux时间同步：NTP，Chrony和systemd-timesyncd</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/505314/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/m-/ts/k3/m-tsk33gxcmkrlh4yuqdaxl4ytk.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大多数人会跟踪时间。</font><font style="vertical-align: inherit;">我们准时起床执行早晨的仪式，然后上班，休息一下午餐，按时完成项目，庆祝生日和假期，登机等等。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
而且：我们当中有些人痴迷于时间。</font><font style="vertical-align: inherit;">我的手表由太阳能供电，并</font><font style="vertical-align: inherit;">通过</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">WWVB Longwave Radio</font></a><font style="vertical-align: inherit;">从科罗拉多州柯林斯堡</font><font style="vertical-align: inherit;">的国家标准与技术研究院（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NIST</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">获得准确的时间</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">时间信号与也位于科林斯堡的原子钟同步。</font><font style="vertical-align: inherit;">我的Fitbit与我的手机同步，而我的手机与</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">NTP</font></a><font style="vertical-align: inherit;">服务器同步，而</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">NTP</font></a><font style="vertical-align: inherit;">服务器</font><font style="vertical-align: inherit;">最终与原子时钟同步。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设备还可以跟踪时间</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们的设备和计算机需要准确的时间有很多原因。例如，在银行业，股票市场和其他金融企业中，交易必须以正确的顺序进行，并且准确的时间安排至关重要。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们的电话，平板电脑，汽车，GPS系统和计算机需要精确的时间和日期设置。我希望计算机桌面上的时钟显示正确的时间。我希望我的本地日历在适当的时候有提醒。正确的时间还可以确保cron和systemd作业在正确的时间启动。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
日期和时间对于日志记录也很重要，因此根据日期和时间查找某些日志会更容易一些。</font><font style="vertical-align: inherit;">例如，我曾经在DevOps工作（当时他们当时并没有这么称呼），并在北卡罗来纳州建立了电子邮件系统。</font><font style="vertical-align: inherit;">我们过去每天处理超过2000万封电子邮件。</font><font style="vertical-align: inherit;">如果计算机及时同步，则通过一系列服务器跟踪电子邮件或使用日志文件在地理位置分散的主机上确定事件的确切顺序会容易得多。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一次-几个小时</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Linux主机必须意识到存在系统时间和RTC时间。 RTC（实时时钟）对于硬件时钟来说有点奇怪，而且不是很准确。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
即使使用系统主板上的电池关闭了计算机，硬件时钟也会连续运行。 RTC的主要功能是存储与时间服务器的连接不可用时的时间。在那些无法通过Internet连接到时间服务器的时代，每台计算机都必须具有准确的内部时钟。操作系统必须在引导时访问RTC，并且用户必须使用硬件BIOS配置界面手动设置系统时间，以确保它是正确的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
硬件手表不了解时区的概念；</font><font style="vertical-align: inherit;">RTC仅存储时间，不存储时区或与UTC（协调世界时，也称为GMT或格林威治标准时间）的时差。</font><font style="vertical-align: inherit;">您可以使用该工具安装RTC，我将在本文后面讨论。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
系统时间是操作系统在桌面GUI时钟上，在date命令的输出中，在日志的时间戳中显示的时间。</font><font style="vertical-align: inherit;">这也适用于创建，修改和打开文件的时间。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">rtc手册</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
页</font><font style="vertical-align: inherit;">具有RTC和系统时钟的完整说明。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NTP有什么？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
世界各地的计算机都使用NTP（网络时间协议）来使用NTP服务器层次结构通过Internet将其时间与标准参考时钟同步。主要时间服务器位于第1层，它们通过卫星，无线电甚至调制解调器通过电话线直接连接到第0层的各种国家时间服务。级别0的时间服务可以是原子钟，调谐到原子钟发送的信号的无线电接收器，或使用GPS卫星发送的高精度时钟信号的GPS接收器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在绝大多数参考服务器上，数千个公共NTP第2层服务器都是开放的，每个人都可以使用。</font><font style="vertical-align: inherit;">许多拥有大量需要NTP服务器的主机的组织和用户（包括我在内）都喜欢安装自己的时间服务器，因此只有一个本地主机调用第2层或第3层。然后，他们将网络上的其余节点配置为使用本地时间服务器。</font><font style="vertical-align: inherit;">就我的家庭网络而言，这是3级服务器。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">各种NTP实现 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NTP的初始实现是ntpd。然后两个新成员加入了chronyd和systemd-timesyncd。所有这三个都将本地主机时间与NTP时间服务器同步。 systemd-timesyncd服务不如chronyd可靠，但这对于大多数目的来说已经足够。如果未同步RTC，则可以在本地系统时间稍有偏移时逐步调整系统时间以与NTP服务器同步。 systemd-timesync服务不能用作时间服务器。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chrony</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个NTP实现，包含两个程序：chronyd守护程序和一个名为chronyc的命令行界面。 Chrony具有一些在很多情况下是无法替代的功能：</font></font><br>
<br>
<ul>
<li>Chrony       ,    ntpd.       ,    .</li>
<li>     , ,           ,      -   ,       .</li>
<li>    ,        .</li>
<li>    .</li>
<li>    Chrony    .             .</li>
<li>Chrony       .          .</li>
<li>Chrony     NTP-.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
再说一遍：NTP是可以使用Chrony或systemd-timesyncd在Linux主机上实现的协议。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
RPM软件包NTP，Chrony和systemd-timesyncd在标准Fedora仓库中可用。</font><font style="vertical-align: inherit;">RPM systemd-udev是内核事件管理器，默认情况下已安装在Fedora中，但不是必需的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以安装所有三个组件并在它们之间切换，但这会造成额外的麻烦。</font><font style="vertical-align: inherit;">所以最好不要。</font><font style="vertical-align: inherit;">当前版本的Fedora，CentOS和RHEL已作为标准实现迁移到了Chrony，并且它们还具有systemd-timesyncd。</font><font style="vertical-align: inherit;">我相信Chrony运作良好，提供了比NTP服务更好的界面，提供了更多信息并增强了控制，系统管理员一定会喜欢。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">禁用NTP服务 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您的主机可能已经在运行NTP服务。</font><font style="vertical-align: inherit;">如果是这样，则需要在切换到其他选项之前将其禁用。</font><font style="vertical-align: inherit;">我已经运行chronyd，所以我使用了以下命令来停止和禁用它。</font><font style="vertical-align: inherit;">对您在主机上使用的任何NTP守护程序运行适当的命令：</font></font><br>
<br>
<pre><code class="bash hljs">[root@testvm1 ~]<span class="hljs-comment"># systemctl disable chronyd ; systemctl stop chronyd</span><font></font>
Removed /etc/systemd/system/multi-user.target.wants/chronyd.service.<font></font>
[root@testvm1 ~]<span class="hljs-comment">#</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
验证服务已停止并禁用：</font></font><br>
<br>
<pre><code class="bash hljs">[root@testvm1 ~]<span class="hljs-comment"># systemctl status chronyd</span><font></font>
● chronyd.service - NTP client/server<font></font>
     Loaded: loaded (/usr/lib/systemd/system/chronyd.service; disabled; vendor preset: enabled)<font></font>
     Active: inactive (dead)<font></font>
       Docs: man:chronyd(8)<font></font>
             man:chrony.conf(5)<font></font>
[root@testvm1 ~]<span class="hljs-comment">#</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">启动前检查状态</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
系统时钟同步状态使您可以确定NTP服务是否正在运行。</font><font style="vertical-align: inherit;">由于您尚未启动NTP，因此timesync-status命令将提示以下内容：</font></font><br>
<br>
<pre><code class="bash hljs">[root@testvm1 ~]<span class="hljs-comment"># timedatectl timesync-status</span>
Failed to query server: Could not activate remote peer.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
直接状态请求提供重要信息。</font><font style="vertical-align: inherit;">例如，不带任何参数的timedatectl命令将执行默认状态子命令：</font></font><br>
<br>
<pre><code class="bash hljs">[root@testvm1 ~]<span class="hljs-comment"># timedatectl status</span><font></font>
           Local time: Fri 2020-05-15 08:43:10 EDT  <font></font>
           Universal time: Fri 2020-05-15 12:43:10 UTC  <font></font>
                 RTC time: Fri 2020-05-15 08:43:08      <font></font>
                Time zone: America/New_York (EDT, -0400)<font></font>
System clock synchronized: no                          <font></font>
              NTP service: inactive                    <font></font>
          RTC <span class="hljs-keyword">in</span> <span class="hljs-built_in">local</span> TZ: yes                    <font></font>
<font></font>
Warning: The system is configured to <span class="hljs-built_in">read</span> the RTC time <span class="hljs-keyword">in</span> the <span class="hljs-built_in">local</span> time zone.<font></font>
         This mode cannot be fully supported. It will create various problems<font></font>
         with time zone changes and daylight saving time adjustments. The RTC<font></font>
         time is never updated, it relies on external facilities to maintain it.<font></font>
         If at all possible, use RTC <span class="hljs-keyword">in</span> UTC by calling
         <span class="hljs-string">'timedatectl set-local-rtc 0'</span>.<font></font>
[root@testvm1 ~]<span class="hljs-comment">#</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这样您就可以获得主机的本地时间，UTC时间和RTC时间。在这种情况下，系统时间设置为America / New_York（TZ）时区，RTC设置为本地时区的时间，并且NTP服务未激活。 RTC时间开始与系统时间略有不同。对于时钟未同步的系统，这是正常的。主机上的偏移量取决于自上次系统同步以来经过的时间。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们还收到了有关将本地时间用于RTC的警告-这适用于时区和夏时制设置的更改。</font><font style="vertical-align: inherit;">如果必须进行更改时关闭计算机，则RTC时间不会更改。</font><font style="vertical-align: inherit;">但是对于全天候工作的服务器或其他主机，这根本不是问题。</font><font style="vertical-align: inherit;">此外，任何提供NTP时间同步的服务都将在初始启动阶段调整主机时间，因此一旦启动完成，时间将再次变为正确。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时区设定</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，您在安装过程中指定时区，以后没有任何更改的任务。但是，有时您需要更改时区。有几种工具可以提供帮助。 Linux使用时区文件来确定主机的本地时区。这些文件位于</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ usr / share / zoneinfo目录中</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。默认情况下，对于我的时区，系统将写入以下内容：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ etc / localtime-&gt; ../usr/share/zoneinfo/America/New_York</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。但是您无需知道此类细微之处即可更改时区。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最主要的是要知道您所在位置和相应团队的时区的正式名称。假设您要将时区更改为洛杉矶：</font></font><br>
<br>
<pre><code class="bash hljs">
[root@testvm2 ~]<span class="hljs-comment"># timedatectl list-timezones | column</span><font></font>
&lt;SNIP&gt;<font></font>
America/La_Paz                  Europe/Budapest<font></font>
America/Lima                    Europe/Chisinau<font></font>
America/Los_Angeles             Europe/Copenhagen<font></font>
America/Maceio                  Europe/Dublin<font></font>
America/Managua                 Europe/Gibraltar<font></font>
America/Manaus                  Europe/Helsinki<font></font>
&lt;SNIP&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在您可以设置时区。</font><font style="vertical-align: inherit;">我使用date命令检查更改，但您也可以使用timedatectl：</font></font><br>
<br>
<pre><code class="bash hljs">[root@testvm2 ~]<span class="hljs-comment"># date</span><font></font>
Tue 19 May 2020 04:47:49 PM EDT<font></font>
[root@testvm2 ~]<span class="hljs-comment"># timedatectl set-timezone America/Los_Angeles</span>
[root@testvm2 ~]<span class="hljs-comment"># date</span><font></font>
Tue 19 May 2020 01:48:23 PM PDT<font></font>
[root@testvm2 ~]<span class="hljs-comment">#</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，您可以再次将主机的时区更改为本地时间。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统时间同步</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
systemd timesync守护程序提供了一个在systemd上下文中易于管理的NTP实现。</font><font style="vertical-align: inherit;">默认情况下，它已安装在Fedora和Ubuntu中。</font><font style="vertical-align: inherit;">但是，默认情况下仅在Ubuntu中启动。</font><font style="vertical-align: inherit;">我不确定其他发行版。</font><font style="vertical-align: inherit;">您可以自己检查：</font></font><br>
<br>
<pre><code class="bash hljs">[root@testvm1 ~]<span class="hljs-comment"># systemctl status systemd-timesyncd</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置systemd-timesyncd</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
systemd-timesyncd的配置文件是</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/systemd/timesyncd.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这是一个简单的文件，与旧的NTP和chronyd服务相比，其中包含的选项更少。</font><font style="vertical-align: inherit;">这是我的Fedora虚拟机上此文件的内容（无进一步更改）：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#  This file is part of systemd.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment">#  systemd is free software; you can redistribute it and/or modify it</span>
<span class="hljs-comment">#  under the terms of the GNU Lesser General Public License as published by</span>
<span class="hljs-comment">#  the Free Software Foundation; either version 2.1 of the License, or</span>
<span class="hljs-comment">#  (at your option) any later version.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Entries in this file show the compile time defaults.</span>
<span class="hljs-comment"># You can change settings by editing this file.</span>
<span class="hljs-comment"># Defaults can be restored by simply deleting this file.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># See timesyncd.conf(5) for details.</span><font></font>
<font></font>
[Time]<font></font>
<span class="hljs-comment">#NTP=</span>
<span class="hljs-comment">#FallbackNTP=0.fedora.pool.ntp.org 1.fedora.pool.ntp.org 2.fedora.pool.ntp.org 3.fedora.pool.ntp.org</span>
<span class="hljs-comment">#RootDistanceMaxSec=5</span>
<span class="hljs-comment">#PollIntervalMinSec=32</span>
<span class="hljs-comment">#PollIntervalMaxSec=2048</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
除注释外，它包含的唯一部分是[时间]。</font><font style="vertical-align: inherit;">所有其他行均被注释掉。</font><font style="vertical-align: inherit;">这些是默认值，不需要更改（除非您有此理由）。</font><font style="vertical-align: inherit;">如果您在NTP =行中没有定义NTP时间服务器，则Fedora默认使用Fedora备份时间服务器。</font><font style="vertical-align: inherit;">我通常添加我的时间服务器：</font></font><br>
<br>
<pre><code class="bash hljs">NTP=myntpserver</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">启动时间同步</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以像这样启动并激活systemd-timesyncd：</font></font><br>
<br>
<pre><code class="bash hljs">[root@testvm2 ~]<span class="hljs-comment"># systemctl enable systemd-timesyncd.service</span><font></font>
Created symlink /etc/systemd/system/dbus-org.freedesktop.timesync1.service → /usr/lib/systemd/system/systemd-timesyncd.service.<font></font>
Created symlink /etc/systemd/system/sysinit.target.wants/systemd-timesyncd.service → /usr/lib/systemd/system/systemd-timesyncd.service.<font></font>
[root@testvm2 ~]<span class="hljs-comment"># systemctl start systemd-timesyncd.service</span>
[root@testvm2 ~]<span class="hljs-comment">#</span></code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">硬件时钟安装</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
运行timesyncd后，情况如下所示：</font></font><br>
<br>
<pre><code class="bash hljs">[root@testvm2 systemd]<span class="hljs-comment"># timedatectl</span><font></font>
               Local time: Sat 2020-05-16 14:34:54 EDT  <font></font>
           Universal time: Sat 2020-05-16 18:34:54 UTC  <font></font>
                 RTC time: Sat 2020-05-16 14:34:53      <font></font>
                Time zone: America/New_York (EDT, -0400)<font></font>
System clock synchronized: yes                          <font></font>
              NTP service: active                      <font></font>
          RTC <span class="hljs-keyword">in</span> <span class="hljs-built_in">local</span> TZ: no    </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初，RTC与本地时间（EDT）之间的时差不超过一秒，并且在接下来的几天中差异会增加几秒钟。由于RTC中没有时区的概念，因此timedatectl命令必须执行比较以确定所需的时区。如果RTC与当地时间不完全匹配，则它与当地时区不匹配。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
寻找更多信息，我检查了systemd-timesync的状态，发现了这一点：</font></font><br>
<br>
<pre><code class="bash hljs">[root@testvm2 systemd]<span class="hljs-comment"># systemctl status systemd-timesyncd.service</span><font></font>
● systemd-timesyncd.service - Network Time Synchronization<font></font>
     Loaded: loaded (/usr/lib/systemd/system/systemd-timesyncd.service; enabled; vendor preset: disabled)<font></font>
     Active: active (running) since Sat 2020-05-16 13:56:53 EDT; 18h ago<font></font>
       Docs: man:systemd-timesyncd.service(8)<font></font>
   Main PID: 822 (systemd-timesyn)<font></font>
     Status: <span class="hljs-string">"Initial synchronization to time server 163.237.218.19:123 (2.fedora.pool.ntp.org)."</span>
      Tasks: 2 (<span class="hljs-built_in">limit</span>: 10365)<font></font>
     Memory: 2.8M<font></font>
        CPU: 476ms<font></font>
     CGroup: /system.slice/systemd-timesyncd.service<font></font>
             └─822 /usr/lib/systemd/systemd-timesyncd<font></font>
<font></font>
May 16 09:57:24 testvm2.both.org systemd[1]: Starting Network Time Synchronization...<font></font>
May 16 09:57:24 testvm2.both.org systemd-timesyncd[822]: System clock time <span class="hljs-built_in">unset</span> or jumped backwards, restoring from recorded timestamp: Sat 2020-05-16 13:56:53 EDT<font></font>
May 16 13:56:53 testvm2.both.org systemd[1]: Started Network Time Synchronization.<font></font>
May 16 13:57:56 testvm2.both.org systemd-timesyncd[822]: Initial synchronization to time server 163.237.218.19:123 (2.fedora.pool.ntp.org).<font></font>
[root@testvm2 systemd]<span class="hljs-comment">#</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请注意日志消息，该消息指出系统时间未设置或重置。</font><font style="vertical-align: inherit;">Timesync服务根据时间戳设置系统时间。</font><font style="vertical-align: inherit;">时间戳记由timesync守护程序维护，并在每次成功同步后创建。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
timedatectl命令无法从系统时钟中获取硬件时钟的值。</font><font style="vertical-align: inherit;">她只能从命令行中输入的值设置时间和日期。</font><font style="vertical-align: inherit;">您可以使用hwclock命令将RTC设置为与系统时间相同的值：</font></font><br>
<br>
<pre><code class="bash hljs">[root@testvm2 ~]<span class="hljs-comment"># /sbin/hwclock --systohc --localtime</span>
[root@testvm2 ~]<span class="hljs-comment"># timedatectl</span><font></font>
               Local time: Mon 2020-05-18 13:56:46 EDT  <font></font>
           Universal time: Mon 2020-05-18 17:56:46 UTC  <font></font>
                 RTC time: Mon 2020-05-18 13:56:46      <font></font>
                Time zone: America/New_York (EDT, -0400)<font></font>
System clock synchronized: yes                          <font></font>
              NTP service: active                      <font></font>
          RTC <span class="hljs-keyword">in</span> <span class="hljs-built_in">local</span> TZ: yes</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--localtime选项表示硬件时钟显示的是本地时间，而不是UTC。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为什么根本需要RTC？</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
任何NTP实现都将在启动时设置系统时钟。</font><font style="vertical-align: inherit;">然后为什么要使用RTC？</font><font style="vertical-align: inherit;">这并非完全正确：只有当您与时间服务器建立网络连接时，才会发生这种情况。</font><font style="vertical-align: inherit;">但是，许多系统无法持续访问网络连接，因此硬件时钟对于Linux基于它们设置系统时间很有用。</font><font style="vertical-align: inherit;">这比手动设置时间要好，即使它可能会偏离实时时间。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
本文讨论了一些用于管理日期，时间和时区的工具。 systemd-timesyncd工具提供了一个NTP客户端，该客户端可以将本地主机上的时间与NTP服务器同步。但是，systemd-timesyncd不提供服务器服务，因此，如果您的网络上需要NTP服务器，则必须使用其他工具（例如Chrony）作为服务器。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我更喜欢对网络上的所有服务使用单一实现，因此我使用Chrony。如果不需要本地NTP服务器，或者不介意将Chrony用作服务器，将systemd-timesyncd用作SNTP客户端。毕竟，如果您对systemd-timesyncd的功能感到满意，则无需使用Chrony的其他功能作为客户端。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
还有一点需要注意：不需要使用systemd工具来实现NTP。</font><font style="vertical-align: inherit;">您可以使用旧版本的ntpd，Chrony或其他NTP实现。</font><font style="vertical-align: inherit;">毕竟，systemd包含大量服务；</font><font style="vertical-align: inherit;">其中许多是可选的，因此您可以将其关闭并改用其他功能。</font><font style="vertical-align: inherit;">这不是一个巨大的整体怪物。</font><font style="vertical-align: inherit;">您可能不喜欢系统化或部分系统化，但是您必须做出明智的决定。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我喜欢systemd中的NTP实现，但我更喜欢Chrony，因为它更适合我的需求。</font><font style="vertical-align: inherit;">这是Linux，宝贝-）</font></font><br>
<br>
<hr><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为广告</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VDSina </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为任何任务</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提供</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">服务器</font></a><font style="vertical-align: inherit;">，提供大量用于自动安装的操作系统，可以从自己的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ISO</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装任何操作系统，也可以通过</font><font style="vertical-align: inherit;">自己设计和日常付款</font><font style="vertical-align: inherit;">的便捷</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">控制面板</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进行安装</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">回想一下，我们拥有永不过时的永恒服务器；）</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/9fa/cf4/a34/9facf4a348ef01048b4eb5e16ae66daa.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN505298/index.html">照片和视频中的乘员龙飞行</a></li>
<li><a href="../zh-CN505300/index.html">面向工程师，程序员，数学家和广大工人的石油工业，第1部分</a></li>
<li><a href="../zh-CN505302/index.html">10电路设计技巧</a></li>
<li><a href="../zh-CN505306/index.html">从游戏到电子商务项目。更改Technopark的两年计划</a></li>
<li><a href="../zh-CN505310/index.html">技术先进的公司与众不同之处以及技术支持如何帮助您的团队成长</a></li>
<li><a href="../zh-CN505322/index.html">未来的调度员：他在服务公司中的角色将如何改变？</a></li>
<li><a href="../zh-CN505330/index.html">如何在3年内不从头开始创建加密货币</a></li>
<li><a href="../zh-CN505336/index.html">如何：马奈或莫奈？神经网络响应</a></li>
<li><a href="../zh-CN505340/index.html">沃尔玛员工试图证明防盗AI不起作用</a></li>
<li><a href="../zh-CN505342/index.html">依赖注入和依赖倒置原理是不相同的</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>