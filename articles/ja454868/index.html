<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♍️ 👨🏿‍⚕️ 🎬 EmscriptenなしでWebAssemblyでCをコンパイルする 🅰️ 👨🏿‍✈️ 🔢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="コンパイラはEmscriptenの一部です。しかし、すべての笛を取り除いて、それだけを残すとどうなりますか？
 
 Emscriptenは、C / C ++をWebAssemblyにコンパイルするために必要です。しかし、それは単なるコンパイラ以上のものです。 Emscriptenの目標は、C / C...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>EmscriptenなしでWebAssemblyでCをコンパイルする</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454868/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイラは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emscriptenの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一部です</font><font style="vertical-align: inherit;">。しかし、すべての笛を取り除いて、それだけを残すとどうなりますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Emscriptenは、C / C ++を</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebAssembly</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にコンパイルするために必要です</font><font style="vertical-align: inherit;">。しかし、それは単なるコンパイラ以上のものです。 Emscriptenの目標は、C / C ++コンパイラを完全に置き換え、元々</font><font style="vertical-align: inherit;">Web用に</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設計さ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れて</font><b><font style="vertical-align: inherit;">いない</font></b><font style="vertical-align: inherit;">コードをWeb上で実行することです</font><font style="vertical-align: inherit;">。このため、EmscriptenはPOSIXオペレーティングシステム全体をエミュレートします。プログラムが</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fopen（）を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用する場合、</font><font style="vertical-align: inherit;">Emscriptenはファイルシステムエミュレーションを提供します。 OpenGLを使用する場合、Emscriptenは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebGL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">でサポートされるC互換のGLコンテキストを提供します</font><font style="vertical-align: inherit;">。これは多くの作業であり、最終的なパッケージに実装する必要がある多くのコードです。しかし、あなたはただそれを取り除くことができますか？</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emscriptenツールキット</font><font style="vertical-align: inherit;">
の実際の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイラ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はLLVMです。 CコードをWebAssemblyバイトコードに変換するのは彼です。これは、プログラムの分析、変換、最適化のための最新のモジュール式フレームワークです。 LLVMは、マシンコードに直接コンパイルされることがないという意味でモジュール化されています。代わりに、組み込みの</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フロントエンドコンパイラ</font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が中間表現</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（IR）を</font><font style="vertical-align: inherit;">生成</font><i><font style="vertical-align: inherit;">し</font></i><font style="vertical-align: inherit;">ます。実際、この中間表現はLLVMと呼ばれます。これは低レベル仮想マシンの略語であり、プロジェクトの名前です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックエンドコンパイラ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IRをホストマシンコードに変換します。</font><font style="vertical-align: inherit;">この厳密な分離の利点は、新しいアーキテクチャーが、新しいコンパイラーの「単純な」追加によってサポートされることです。</font><font style="vertical-align: inherit;">この意味で、WebAssemblyはLLVMがサポートする多くのコンパイル目標の1つにすぎず、しばらくの間、特別なフラグでアクティブ化されてきました。</font><font style="vertical-align: inherit;">LLVM 8以降、WebAssemblyコンパイルターゲットはデフォルトで使用可能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MacOSでは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">homebrew</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してLLVMをインストールできます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">$ brew install llvm<font></font>
$ brew link --force llvm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WebAssemblyサポートを確認します。</font></font><br>
<br>
<pre><code class="bash hljs">$ llc --version<font></font>
LLVM (http://llvm.org/):<font></font>
  LLVM version 8.0.0<font></font>
  Optimized build.<font></font>
  Default target: x86_64-apple-darwin18.5.0<font></font>
  Host CPU: skylake<font></font>
<font></font>
  Registered Targets:<font></font>
    <span class="hljs-comment"># …,  …</span><font></font>
    systemz    - SystemZ<font></font>
    thumb      - Thumb<font></font>
    thumbeb    - Thumb (big endian)<font></font>
    wasm32     - WebAssembly 32-bit <span class="hljs-comment"># ! ! !</span><font></font>
    wasm64     - WebAssembly 64-bit<font></font>
    x86        - 32-bit X86: Pentium-Pro and above<font></font>
    x86-64     - 64-bit X86: EM64T and AMD64<font></font>
    xcore      - XCore</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
準備ができているようです！</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cを難しい方法でコンパイルする</font></font></h1><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注：以下</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、低レベルのRAW WebAssemblyフォーマットです。</font><font style="vertical-align: inherit;">理解するのが難しい場合、これは正常です。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebAssemblyを適切に使用するには、この記事のテキスト全体を理解する必要はありません。</font><font style="vertical-align: inherit;">コピーと貼り付けのコードを探している場合は、「最適化」セクションのコンパイラの呼び出しを参照してください</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">しかし、興味があれば、読み続けてください！</font><font style="vertical-align: inherit;">私は以前、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">純粋なWebアセンブリ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とWATの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">概要</font></a><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">書きました</font><font style="vertical-align: inherit;">。これらは、この投稿を理解するために必要な基本です。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告：標準から少し逸脱し、すべてのステップで（可能な限り）人間が読める形式を使用するようにします。</font><font style="vertical-align: inherit;">ここでの私たちのプログラムは、国境の状況を回避し、気を散らさないようにするために非常にシンプルになります：</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Filename: add.c</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span> </span>{
  <span class="hljs-keyword">return</span> a*a + b;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なんて素晴らしいエンジニアリングの偉業でしょう！</font><font style="vertical-align: inherit;">特に、プログラムが呼び出されるので</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、追加</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、実際にはそれはしない</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追加</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">何も</font><font style="vertical-align: inherit;">（追加されません）。</font><font style="vertical-align: inherit;">さらに重要なことは、プログラムは標準ライブラリを使用せず、ここでのタイプは「int」のみを使用することです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cを内部LLVMビューに変える</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のステップは、CプログラムをLLVM IRに変換することです。</font><font style="vertical-align: inherit;">これは、</font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LLVMとともにインストールされ</font><font style="vertical-align: inherit;">たフロントエンドコンパイラのタスクです</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">clang \<font></font>
  --target=wasm32 \ <span class="hljs-comment"># Target WebAssembly</span>
  -emit-llvm \ <span class="hljs-comment"># Emit LLVM IR (instead of host machine code)</span>
  -c \ <span class="hljs-comment"># Only compile, no linking just yet</span>
  -S \ <span class="hljs-comment"># Emit human-readable assembly rather than binary</span>
  add.c</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、</font></font><code>add.ll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LLVM IRの内部表現が</font><font style="vertical-align: inherit;">得られ</font><font style="vertical-align: inherit;">ます。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全を期すためにのみ示してい</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">WebAssemblyまたはclangを使用する場合、C開発者</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LLVM IRに接触する</font><i><font style="vertical-align: inherit;">ことはありません</font></i><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs">; ModuleID = <span class="hljs-string">'add.c'</span>
source_filename = <span class="hljs-string">"add.c"</span>
target datalayout = <span class="hljs-string">"e-m:e-p:32:32-i64:64-n32:64-S128"</span>
target triple = <span class="hljs-string">"wasm32"</span><font></font>
<font></font>
; Function Attrs: norecurse nounwind readnone<font></font>
define hidden i32 @add(i32, i32) local_unnamed_addr #<span class="hljs-number">0</span> {<font></font>
  %<span class="hljs-number">3</span> = mul nsw i32 %<span class="hljs-number">0</span>, %<span class="hljs-number">0</span>
  %<span class="hljs-number">4</span> = add nsw i32 %<span class="hljs-number">3</span>, %<span class="hljs-number">1</span>
  ret i32 %<span class="hljs-number">4</span><font></font>
}<font></font>
<font></font>
attributes #<span class="hljs-number">0</span> = { norecurse nounwind readnone <span class="hljs-string">"correctly-rounded-divide-sqrt-fp-math"</span>=<span class="hljs-string">"false"</span> <span class="hljs-string">"disable-tail-calls"</span>=<span class="hljs-string">"false"</span> <span class="hljs-string">"less-precise-fpmad"</span>=<span class="hljs-string">"false"</span> <span class="hljs-string">"min-legal-vector-width"</span>=<span class="hljs-string">"0"</span> <span class="hljs-string">"no-frame-pointer-elim"</span>=<span class="hljs-string">"false"</span> <span class="hljs-string">"no-infs-fp-math"</span>=<span class="hljs-string">"false"</span> <span class="hljs-string">"no-jump-tables"</span>=<span class="hljs-string">"false"</span> <span class="hljs-string">"no-nans-fp-math"</span>=<span class="hljs-string">"false"</span> <span class="hljs-string">"no-signed-zeros-fp-math"</span>=<span class="hljs-string">"false"</span> <span class="hljs-string">"no-trapping-math"</span>=<span class="hljs-string">"false"</span> <span class="hljs-string">"stack-protector-buffer-size"</span>=<span class="hljs-string">"8"</span> <span class="hljs-string">"target-cpu"</span>=<span class="hljs-string">"generic"</span> <span class="hljs-string">"unsafe-fp-math"</span>=<span class="hljs-string">"false"</span> <span class="hljs-string">"use-soft-float"</span>=<span class="hljs-string">"false"</span> }<font></font>
<font></font>
!llvm.<span class="hljs-keyword">module</span>.flags = !{!<span class="hljs-number">0</span>}<font></font>
!llvm.ident = !{!<span class="hljs-number">1</span>}<font></font>
<font></font>
!<span class="hljs-number">0</span> = !{i32 <span class="hljs-number">1</span>, !<span class="hljs-string">"wchar_size"</span>, i32 <span class="hljs-number">4</span>}<font></font>
!<span class="hljs-number">1</span> = !{!<span class="hljs-string">"clang version 8.0.0 (tags/RELEASE_800/final)"</span>}</code></pre><br>
<i>LLVM IR     ,           .</i><br>
<br>
<h3> LLVM IR   </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のステップは、バックエンドコンパイラを呼び出して</font></font><code>llc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、内部表現からオブジェクトファイルを作成することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力ファイル</font></font><code>add.o</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はすでに有効なWebAssemblyモジュールであり、Cファイルのすべてのコンパイル済みコードが含まれていますが、通常、オブジェクトファイルには重要な部分がないため、オブジェクトファイルを実行できません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コマンドを省略した場合は、</font></font><code>-filetype=obj</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WATに似た、人間が読める形式のWebAssembly用のLLVMアセンブラーを取得します。ただし、その</font></font><code>llvm-mc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ようなファイルを操作</font><font style="vertical-align: inherit;">するツール</font><font style="vertical-align: inherit;">はまだ形式を完全にはサポートしておらず、ファイルを処理できないことがよくあります。そのため、事後オブジェクトファイルを逆アセンブルします。これらのオブジェクトファイルを確認するには、特定のツールが必要です。 WebAssemblyの場合、これ</font></font><code>wasm-objdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は一部です</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebAssembly Binary Toolkit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">または略してwabt。</font></font><br>
<br>
<pre><code class="bash hljs">$ brew install wabt <span class="hljs-comment"># in case you haven’t</span><font></font>
$ wasm-objdump -x add.o<font></font>
<font></font>
add.o:  file format wasm 0x1<font></font>
<font></font>
Section Details:<font></font>
<font></font>
Type[1]:<font></font>
 - <span class="hljs-built_in">type</span>[0] (i32, i32) -&gt; i32<font></font>
Import[3]:<font></font>
 - memory[0] pages: initial=0 &lt;- env.__linear_memory<font></font>
 - table[0] elem_type=funcref init=0 max=0 &lt;- env.__indirect_function_table<font></font>
 - global[0] i32 mutable=1 &lt;- env.__stack_pointer<font></font>
Function[1]:<font></font>
 - func[0] sig=0 &lt;add&gt;<font></font>
Code[1]:<font></font>
 - func[0] size=75 &lt;add&gt;<font></font>
Custom:<font></font>
 - name: <span class="hljs-string">"linking"</span><font></font>
  - symbol table [count=2]<font></font>
   - 0: F &lt;add&gt; func=0 binding=global vis=hidden<font></font>
   - 1: G &lt;env.__stack_pointer&gt; global=0 undefined binding=global vis=default<font></font>
Custom:<font></font>
 - name: <span class="hljs-string">"reloc.CODE"</span>
  - relocations <span class="hljs-keyword">for</span> section: 3 (Code) [1]<font></font>
R_WASM_GLOBAL_INDEX_LEB offset=0x000006(file=0x000080) symbol=1 &lt;env.__stack_pointer&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
出力は、add（）関数がこのモジュールにあることを示して</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">い</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ますが</font><font style="vertical-align: inherit;">、メタデータを</font><font style="vertical-align: inherit;">含む</font><i><font style="vertical-align: inherit;">カスタム</font></i><font style="vertical-align: inherit;">セクション</font><font style="vertical-align: inherit;">と、驚くべきことに、いくつかのインポート</font><font style="vertical-align: inherit;">も含まれて</font><i><font style="vertical-align: inherit;">い</font></i><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リンク</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の次の段階で</font><i><font style="vertical-align: inherit;">、</font></i><font style="vertical-align: inherit;">カスタムセクションが分析および削除され、リンカー（リンカー）がインポートを処理します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">レイアウト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
従来、リンカのタスクは、いくつかのオブジェクトファイルを実行可能ファイルにアセンブルすることです。</font><font style="vertical-align: inherit;">LLVMリンカーはと呼ばれ</font></font><code>lld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ターゲットのシンボリックリンクで呼び出されます。</font><font style="vertical-align: inherit;">WebAssemblyの場合、これは</font></font><code>wasm-ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br>
<pre><code class="bash hljs">wasm-ld \<font></font>
  --no-entry \ <span class="hljs-comment"># We don’t have an entry function</span>
  --<span class="hljs-built_in">export</span>-all \ <span class="hljs-comment"># Export everything (for now)</span><font></font>
  -o add.wasm \<font></font>
  add.o</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果は、サイズが262バイトのWebAssemblyモジュールです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">発売</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、最も重要なことは、すべてが</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実際に</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">機能</font><font style="vertical-align: inherit;">することを確認すること</font><font style="vertical-align: inherit;">です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前回の記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">同様に、</font><font style="vertical-align: inherit;">数行の埋め込みJavaScriptを使用して、このWebAssemblyモジュールをロードして実行できます。</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> { instance } = <span class="hljs-keyword">await</span> WebAssembly.instantiateStreaming(
      fetch(<span class="hljs-string">"./add.wasm"</span>)
    );
    <span class="hljs-built_in">console</span>.log(instance.exports.add(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>));
  }
  init();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが問題なければ、DevToolコンソールに数値17が表示されます</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emscriptenに触れずに、CをWebAssemblyに正常にコンパイルしました。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">また、WebAssemblyモジュールをセットアップおよびロードするためのミドルウェアがないことにも注意してください。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cのコンパイルは少し簡単です</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CをWebAssemblyでコンパイルするために、多くの手順を実行しました。</font><font style="vertical-align: inherit;">私が言ったように、私たちは教育の目的で、すべての段階を詳細に調べました。</font><font style="vertical-align: inherit;">人間が読める中間形式をスキップして、開発されたCコンパイラをすぐにスイスのアーミーナイフとして適用しましょう。</font></font><br>
<br>
<pre><code class="bash hljs">clang \<font></font>
  --target=wasm32 \<font></font>
  -nostdlib \ <span class="hljs-comment"># Don’t try and link against a standard library</span>
  -Wl,--no-entry \ <span class="hljs-comment"># Flags passed to the linker</span>
  -Wl,--<span class="hljs-built_in">export</span>-all \<font></font>
  -o add.wasm \<font></font>
  add.c</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは同じファイルを取得しています</font></font><code>.wasm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、コマンドは1つです。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最適化</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のコマンドを実行して、WebAssemblyモジュールのWATを見てみましょう</font></font><code>wasm2wat</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">(module<font></font>
  (type (;0;) (func))<font></font>
  (type (;1;) (func (param i32 i32) (result i32)))<font></font>
  (func $__wasm_call_ctors (type 0))<font></font>
  (func $add (type 1) (param i32 i32) (result i32)<font></font>
    (local i32 i32 i32 i32 i32 i32 i32 i32)<font></font>
    global.get 0<font></font>
    local.set 2<font></font>
    i32.const 16<font></font>
    local.set 3<font></font>
    local.get 2<font></font>
    local.get 3<font></font>
    i32.sub<font></font>
    local.set 4<font></font>
    local.get 4<font></font>
    local.get 0<font></font>
    i32.store offset=12<font></font>
    local.get 4<font></font>
    local.get 1<font></font>
    i32.store offset=8<font></font>
    local.get 4<font></font>
    i32.load offset=12<font></font>
    local.set 5<font></font>
    local.get 4<font></font>
    i32.load offset=12<font></font>
    local.set 6<font></font>
    local.get 5<font></font>
    local.get 6<font></font>
    i32.mul<font></font>
    local.set 7<font></font>
    local.get 4<font></font>
    i32.load offset=8<font></font>
    local.set 8<font></font>
    local.get 7<font></font>
    local.get 8<font></font>
    i32.add<font></font>
    local.set 9<font></font>
    local.get 9<font></font>
    return)<font></font>
  (table (;0;) 1 1 anyfunc)<font></font>
  (memory (;0;) 2)<font></font>
  (global (;0;) (mut i32) (i32.const 66560))<font></font>
  (global (;1;) i32 (i32.const 66560))<font></font>
  (global (;2;) i32 (i32.const 1024))<font></font>
  (global (;3;) i32 (i32.const 1024))<font></font>
  (export "memory" (memory 0))<font></font>
  (export "__wasm_call_ctors" (func $__wasm_call_ctors))<font></font>
  (export "__heap_base" (global 1))<font></font>
  (export "__data_end" (global 2))<font></font>
  (export "__dso_handle" (global 3))<font></font>
  (export "add" (func $add)))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
わあ、なんて素晴らしいコードでしょう。</font><font style="vertical-align: inherit;">驚いたことに、このモジュールはメモリ（操作</font></font><code>i32.load</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font><font style="vertical-align: inherit;">からわかるように</font></font><code>i32.store</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、8つのローカル変数、およびいくつかのグローバル変数を使用しています。</font><font style="vertical-align: inherit;">おそらく、より簡潔なバージョンを手動で作成できます。</font><font style="vertical-align: inherit;">このプログラムは、最適化を適用しなかったため、非常に大きくなっています。</font><font style="vertical-align: inherit;">やってみましょう：</font></font><br>
<br>
<pre><code class="bash hljs">clang \<font></font>
   --target=wasm32 \<font></font>
+  -O3 \ <span class="hljs-comment"># Agressive optimizations</span>
+  -flto \ <span class="hljs-comment"># Add metadata for link-time optimizations</span><font></font>
   -nostdlib \<font></font>
   -Wl,--no-entry \<font></font>
   -Wl,--<span class="hljs-built_in">export</span>-all \<font></font>
+  -Wl,--lto-O3 \ <span class="hljs-comment"># Aggressive link-time optimizations</span><font></font>
   -o add.wasm \<font></font>
   add.c</code></pre><br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">技術的には、レイアウトの最適化（LTO）は1つのファイルしか作成しないため、利点はありません。</font><font style="vertical-align: inherit;">大規模なプロジェクトでは、LTOはファイルサイズの大幅な削減に役立ちます。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらのコマンドを実行した後、ファイルは</font></font><code>.wasm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">262バイトから197バイト</font><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">削減され、WATも大幅に簡素化されました。</font></font><br>
<br>
<pre><code class="plaintext hljs">(module<font></font>
  (type (;0;) (func))<font></font>
  (type (;1;) (func (param i32 i32) (result i32)))<font></font>
  (func $__wasm_call_ctors (type 0))<font></font>
  (func $add (type 1) (param i32 i32) (result i32)<font></font>
    local.get 0<font></font>
    local.get 0<font></font>
    i32.mul<font></font>
    local.get 1<font></font>
    i32.add)<font></font>
  (table (;0;) 1 1 anyfunc)<font></font>
  (memory (;0;) 2)<font></font>
  (global (;0;) (mut i32) (i32.const 66560))<font></font>
  (global (;1;) i32 (i32.const 66560))<font></font>
  (global (;2;) i32 (i32.const 1024))<font></font>
  (global (;3;) i32 (i32.const 1024))<font></font>
  (export "memory" (memory 0))<font></font>
  (export "__wasm_call_ctors" (func $__wasm_call_ctors))<font></font>
  (export "__heap_base" (global 1))<font></font>
  (export "__data_end" (global 2))<font></font>
  (export "__dso_handle" (global 3))<font></font>
  (export "add" (func $add)))</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">標準ライブラリを呼び出す</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
標準のlibcライブラリなしでCを使用することは、かなり失礼なようです。</font><font style="vertical-align: inherit;">追加するのは当然ですが、私は正直に言って、</font><font style="vertical-align: inherit;">簡単</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">はあり</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ませ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ん。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実際、記事ではlibcライブラリを直接呼び出していません</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">いくつかの適切なものがあり、特に</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">glibc</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">musl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dietlibcがあり</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">ただし、これらのライブラリのほとんどは、特定のシステムコールのセットを実装するPOSIXオペレーティングシステムで実行されることになっています。</font><font style="vertical-align: inherit;">JavaScriptにはカーネルインターフェイスがないため、おそらくJavaScriptを使用して、これらのPOSIXシステム呼び出しを自分で実装する必要があります。</font><font style="vertical-align: inherit;">これは困難な作業であり、ここでは行いません。</font><font style="vertical-align: inherit;">良いニュースは、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これがEmscriptenがあなたのために行うことです</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、すべてのlibc関数がシステムコールに依存しているわけではありません。</font><font style="vertical-align: inherit;">などの機能</font></font><code>strlen()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><code>sin()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">またはでも</font></font><code>memset()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、あなたがこれらの機能を使用するかだけでも、コピー/言及したいくつかのライブラリーからその実施を貼り付けることができ、簡単なC.この手段で実装されています。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">動的メモリ</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
libcのがなければ、のようなCの基本的なインターフェース</font></font><code>malloc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とは、</font><font style="vertical-align: inherit;">私たちには使用できません</font></font><code>free()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最適化されていないWATでは、必要に応じてコンパイラがメモリを使用することがわかりました。</font><font style="vertical-align: inherit;">つまり、メモリを損傷する危険を冒すことなく、メモリを好きなだけ使用することはできません。</font><font style="vertical-align: inherit;">それがどのように使用されるかを理解する必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LLVMメモリモデル</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WebAssemblyのメモリのセグメント化方法は、経験豊富なプログラマーを少し驚かせます。まず、WebAssemblyでは、nullアドレスは技術的に許容されますが、それでもエラーとして扱われることがよくあります。次に、スタックが最初に来て（アドレスが低くなるまで）大きくなり、ヒープが後で現れて大きくなります。これは、WebAssemblyのメモリが実行時に増加する可能性があるためです。これは、スタックまたはヒープに対応する固定端がないことを意味します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
レイアウトは</font></font><code>wasm-ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次のとおりです</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kz/xv/z6/kzxvz60tlxzqdv_9tvxlm4m3gca.png"><br>
<br>
<i><font color="gray"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。スタックは大きくなり、ヒープは大きくなります。スタックはで始まり</font></font><code>__data_end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ヒープ</font><font style="vertical-align: inherit;">は</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">始まります</font></font><code>__heap_base</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。スタックが最初に配置されるため、コンパイル中に設定された最大サイズ、つまり</font></font><code>__heap_base</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マイナス</font><font style="vertical-align: inherit;">によって制限され</font></font><code>__data_end</code></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ます。戻ってWATのグローバルセクションを見ると、次の値が見つかります。</font></font><code>__heap_base</code><font style="vertical-align: inherit;"></font><code>__data_end</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;これは</font><font style="vertical-align: inherit;">66560と</font><font style="vertical-align: inherit;">1024に</font><font style="vertical-align: inherit;">設定します</font><font style="vertical-align: inherit;">。これは、スタックが最大64 KiBまで大きくなる可能性があることを意味しますが、それほど多くはありません。</font><font style="vertical-align: inherit;">さいわい、</font></font><code>wasm-ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この値を変更できます。</font></font><br>
<br>
<pre><code class="bash hljs">clang \<font></font>
   --target=wasm32 \<font></font>
   -O3 \<font></font>
   -flto \<font></font>
   -nostdlib \<font></font>
   -Wl,--no-entry \<font></font>
   -Wl,--<span class="hljs-built_in">export</span>-all \<font></font>
   -Wl,--lto-O3 \<font></font>
+  -Wl,-z,stack-size=$[8 * 1024 * 1024] \ <span class="hljs-comment"># Set maximum stack size to 8MiB</span><font></font>
   -o add.wasm \<font></font>
   add.c</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アロケーターアセンブリ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ヒープ領域はで始まることがわかってい</font></font><code>__heap_base</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。機能が</font></font><code>malloc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ない</font><font style="vertical-align: inherit;">ため</font><font style="vertical-align: inherit;">、次のメモリ領域を安全に使用できることがわかります。好きなようにデータを配置でき、スタックが他の方向に大きくなるため、メモリ破損を恐れる必要はありません。ただし、誰もが自由に使用できるヒープはすぐに詰まる可能性があるため、通常、何らかの動的メモリ管理が必要になります。 1つのオプションは</font><font style="vertical-align: inherit;">、Emscriptenで使用されている</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Doug Leeのmalloc実装</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">など、malloc（）の本格的な実装を</font><font style="vertical-align: inherit;">採用することです。さまざまなトレードオフを持ついくつかの小さな実装があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、なぜあなた自身を書きませんか</font></font><code>malloc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？私たちはあまりにも深く行き詰まっているので、何の違いもありません。最も単純なものの1つはバンプアロケーターです。これは超高速で、非常に小さく、実装が簡単です。ただし、欠点があります。メモリを解放することはできません。一見するとそのようなアロケーターは信じられないほど役に立たないように見えますが、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Squooshを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発しているときに</font><font style="vertical-align: inherit;">、それが優れた選択である前例に出くわしました。バンプアロケーターの概念は、未使用のメモリの開始アドレスをグローバルとして格納することです。プログラムが1 </font></font><code>n</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バイトのメモリを</font><font style="vertical-align: inherit;">要求した場合は</font><font style="vertical-align: inherit;">、マーカーをに移動し</font></font><code>n</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">て前の値を返します。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> __heap_base;<font></font>
<font></font>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> bump_pointer = &amp;__heap_base;
<span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">malloc</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>{
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> r = bump_pointer;<font></font>
  bump_pointer += n;<font></font>
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">void</span> *)r;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-keyword">void</span>* p)</span> </span>{
  <span class="hljs-comment">// lol</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
WATのグローバル変数は実際に定義されている</font></font><code>wasm-ld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ため、宣言すると、Cコードから通常の変数としてアクセスできます</font></font><code>extern</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">したがって、</font><b><font style="vertical-align: inherit;">Cの5行に...を</font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">独自に記述します</font></font><code>malloc()</code><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バンプアロケーターは</font></font><code>malloc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C </font><font style="vertical-align: inherit;">と完全に互換性がありません</font><font style="vertical-align: inherit;">。たとえば、アライメントの保証はありません。</font><font style="vertical-align: inherit;">しかし、それは十分に機能するので...</font></font></blockquote> <h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">動的メモリ使用量</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
確認するために、任意のサイズの数の配列を取り、合計を計算する関数Cを作成しましょう。</font><font style="vertical-align: inherit;">あまり興味深いことではありませんが、アセンブリ中に配列のサイズがわからないため、動的メモリを使用する必要があります。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sum</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a[], <span class="hljs-keyword">int</span> len)</span> </span>{
  <span class="hljs-keyword">int</span> sum = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {<font></font>
    sum += a[i];<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> sum;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sum（）関数はかなり簡単です。</font><font style="vertical-align: inherit;">さらに興味深い質問は、JavaScriptからWebAssemblyに配列を渡す方法です。結局のところ、WebAssemblyは数値しか認識しません。</font><font style="vertical-align: inherit;">一般的な考え方は、使用することです</font></font><code>malloc()</code> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、JavaScriptから</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、メモリの一部を割り当てることが値をコピーして、アドレス（！数）を渡す</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">場合は</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、配列は次のとおりです。</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> { instance } = <span class="hljs-keyword">await</span> WebAssembly.instantiateStreaming(
      fetch(<span class="hljs-string">"./add.wasm"</span>)
    );

    <span class="hljs-keyword">const</span> jsArray = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
    <span class="hljs-comment">// Allocate memory for 5 32-bit integers</span>
    <span class="hljs-comment">// and return get starting address.</span>
    <span class="hljs-keyword">const</span> cArrayPointer = instance.exports.malloc(jsArray.length * <span class="hljs-number">4</span>);
    <span class="hljs-comment">// Turn that sequence of 32-bit integers</span>
    <span class="hljs-comment">// into a Uint32Array, starting at that address.</span>
    <span class="hljs-keyword">const</span> cArray = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>(
      instance.exports.memory.buffer,
      cArrayPointer,
      jsArray.length
    );
    <span class="hljs-comment">// Copy the values from JS to C.</span>
    cArray.set(jsArray);
    <span class="hljs-comment">// Run the function, passing the starting address and length.</span>
    <span class="hljs-built_in">console</span>.log(instance.exports.sum(cArrayPointer, cArray.length));
  }
  init();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開始すると、DevToolsコンソールに回答15が表示されます。これは、実際には1から5までのすべての数値の合計です。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
だから、最後まで読んでください。おめでとう！繰り返しますが、少し過負荷になったと感じた場合は、すべて順調です。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての詳細を読む必要はありません。それらを理解することは、優れたWeb開発者にとって完全にオプションであり、WebAssemblyの優れた使用にさえ必要ありません</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。しかし、私はこの情報を共有したいと思いました</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。Emscriptenの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ようなプロジェクトが行うすべての作業を本当に感謝することができるからです</font><font style="vertical-align: inherit;">。同時に、これにより、WebAssemblyの純粋な計算モジュールがどれほど小さくできるかがわかります。配列を合計するためのWasmモジュールは</font><i><font style="vertical-align: inherit;">、動的メモリアロケータを含め、</font></i><font style="vertical-align: inherit;">サイズが230バイトのみです。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">Emscriptenで同じコードをコンパイルすると、100バイトのWebAssemblyコードと11K JavaScriptリンクコードが生成されます。</font><font style="vertical-align: inherit;">あなたはそのような結果のために試す必要がありますが、それが価値がある状況があります。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja454840/index.html">彼の妻と住宅ローンとオランダへの慎重な移転。パート2：ドキュメントの準備と移動</a></li>
<li><a href="../ja454844/index.html">Odigest：今週のデザイナーにとって興味深い</a></li>
<li><a href="../ja454850/index.html">単一のアルゴリズムの進化</a></li>
<li><a href="../ja454856/index.html">ブラウザー以外のソフトウェアにおけるSSL / TLS証明書検証の脆弱性を分析します</a></li>
<li><a href="../ja454864/index.html">さまざまな企業の開発プロセスはどうですか</a></li>
<li><a href="../ja454872/index.html">Space Invaders：512バイト（Assembler x86）にもなりました</a></li>
<li><a href="../ja454874/index.html">マイクロコントローラーのマルチタスクについて少し</a></li>
<li><a href="../ja454876/index.html">ゲームにおけるキャラクター能力の柔軟なシステムの設計について</a></li>
<li><a href="../ja454878/index.html">MITER ATT＆CKを勉強しています。モバイルマトリックス：デバイスアクセス。パート3</a></li>
<li><a href="../ja454880/index.html">フリーランサーの人生における「オフシーズン」：生き残り、生き残る方法は？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>