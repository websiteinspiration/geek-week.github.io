<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😈 👨🏽‍🎤 ✊🏿 SSO sur l'architecture de microservice. Nous utilisons Keycloak. Numéro de pièce 1 🙏🏾 🧓🏼 🧑🏾‍🤝‍🧑🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans toute grande entreprise, le X5 Retail Group ne fait pas exception, car le nombre de projets nécessitant une authentification des utilisateurs aug...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>SSO sur l'architecture de microservice. Nous utilisons Keycloak. Numéro de pièce 1</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/X5RetailGroup/blog/486778/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans toute grande entreprise, le X5 Retail Group ne fait pas exception, car le nombre de projets nécessitant une authentification des utilisateurs augmente à mesure que le nombre de projets augmente. Au fil du temps, une transition transparente des utilisateurs d'une application à une autre est nécessaire, puis il est nécessaire d'utiliser un seul serveur Single-Sing-On (SSO). Mais qu'en est-il lorsque des fournisseurs d'identité tels que AD ou d'autres qui n'ont pas d'attributs supplémentaires sont déjà utilisés dans divers projets. Une classe de systèmes appelés «courtiers d'identité» viendra à la rescousse. Les plus fonctionnels sont ses représentants, tels que Keycloak, Gravitee Access management, etc. Le plus souvent, les scénarios d'utilisation peuvent être différents: interaction machine, participation des utilisateurs, etc. La solution doit supporter des fonctionnalités flexibles et évolutives,capable de combiner toutes les exigences en une seule, et une telle solution dans notre entreprise est maintenant un courtier indicateur - Keycloak.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hm/bi/eh/hmbiehmxsfcq_cfltz8xj0mhrgc.jpeg"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keycloak est un produit open source pour l'authentification et le contrôle d'accès pris en charge par RedHat. </font><font style="vertical-align: inherit;">C'est la base des produits de l'entreprise utilisant SSO - RH-SSO.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Concepts de base </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer à traiter des décisions et des approches, vous devez déterminer les termes et la séquence des processus: L' </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mm/j1/c2/mmj1c2uynwb23y5j4me13zzcrb4.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">identification</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est le processus de reconnaissance d'un sujet par son identifiant (en d'autres termes, il détermine un nom, un identifiant ou un numéro). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'authentification</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une procédure d'authentification (un utilisateur est vérifié avec un mot de passe, une lettre est vérifiée par signature électronique, etc.) L' </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autorisation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est la fourniture d'accès à une ressource (par exemple, un courrier électronique).</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Courtier d'identité Keycloak</font></font></h4><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keycloak</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est une solution open source de gestion des identités et des accès conçue pour être utilisée dans les circuits intégrés où des modèles d'architecture de microservices peuvent être utilisés. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keycloak offre des fonctionnalités telles que l'authentification unique (SSO), l'identification du courtier et la connexion sociale, la fédération des utilisateurs, les adaptateurs client, une console d'administrateur et une console de gestion de compte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fonctionnalité de base prise en charge dans Keycloak:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Authentification unique et déconnexion unique pour les applications basées sur un navigateur.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prise en charge d'OpenID / OAuth 2.0 / SAML.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Courtage d'identité - Authentification à l'aide de fournisseurs d'identité OpenID Connect externes ou SAML.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connexion sociale - prise en charge de Google, GitHub, Facebook, Twitter pour l'identification des utilisateurs.</font></font></li>
<li>User Federation –    LDAP  Active Directory     .</li>
<li>Kerberos bridge –  Kerberos     .</li>
<li>Admin Console —         Web.</li>
<li>Account Management Console –     .</li>
<li>      .</li>
<li>2FA Authentication –  TOTP/HOTP   Google Authenticator  FreeOTP.</li>
<li>Login Flows –   ,      .</li>
<li>Session Management –        .</li>
<li>Token Mappers –   ,       .</li>
<li>    realm, application  .</li>
<li>CORS Support –      CORS.</li>
<li>Service Provider Interfaces (SPI) –   SPI,      :  ,  ,     .</li>
<li>   JavaScript applications, WildFly, JBoss EAP, Fuse, Tomcat, Jetty, Spring.</li>
<li>    ,  OpenID Connect Relying Party library  SAML 2.0 Service Provider Library.</li>
<li>    plugins.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour les processus CI / CD, ainsi que l'automatisation des processus de gestion dans Keycloak, l'API REST / API JAVA peut être utilisée. </font><font style="vertical-align: inherit;">La documentation est disponible sous forme électronique: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
API REST </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.keycloak.org/docs-api/8.0/rest-api/index.html</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
API JAVA </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.keycloak.org/docs-api/8.0/javadocs /index.html</font></font></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fournisseurs d'identité d'entreprise (sur site)</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La possibilité d'authentifier les utilisateurs via les services de fédération d'utilisateurs. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8j/s9/cl/8js9cl3cx9whnsshxcel0xynpqs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'authentification directe peut également être utilisée - si les utilisateurs s'authentifient sur les postes de travail avec Kerberos (LDAP ou AD), ils peuvent être automatiquement authentifiés avec Keycloak sans avoir à ressaisir leur nom d'utilisateur et leur mot de passe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour l'authentification et l'autorisation supplémentaire des utilisateurs, il est possible d'utiliser un SGBD relationnel, qui est le plus applicable aux environnements de développement, car il n'implique pas de paramètres et d'intégrations à long terme dans les premières étapes des projets. Par défaut, Keycloak utilise un SGBD intégré pour stocker les paramètres et les données utilisateur.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La liste des SGBD pris en charge est longue et comprend: MS SQL, Oracle, PostgreSQL, MariaDB, Oracle et autres. </font><font style="vertical-align: inherit;">Les plus testés actuellement sont Oracle 12C Release1 RAC et le cluster Galera 3.12 pour MariaDB 10.1.19.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fournisseurs d'identité - connexion sociale </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est possible d'utiliser une connexion depuis les réseaux sociaux. </font><font style="vertical-align: inherit;">Pour activer la possibilité d'authentifier les utilisateurs, la console d'administration Keycloack est utilisée. </font><font style="vertical-align: inherit;">Il n'est pas nécessaire de modifier le code de l'application et cette fonctionnalité est disponible «prête à l'emploi» et peut être activée à n'importe quelle étape du projet. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bs/rj/vp/bsrjvpxnw7eojom-_bv816iwoxk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour authentifier les utilisateurs, il est possible d'utiliser des fournisseurs d'identités OpenID / SAML.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Scénarios d'autorisation typiques utilisant OAuth2 dans Keycloak</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flux de code d'autorisation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - utilisé avec les applications côté serveur. L'un des types d'autorisation les plus courants, car il convient bien aux applications serveur dans lesquelles le code source de l'application et les données client ne sont pas accessibles aux étrangers. Dans ce cas, le processus est basé sur la redirection. L'application doit pouvoir interagir avec l'agent utilisateur (user-agent), tel qu'un navigateur Web, pour recevoir des codes d'autorisation API redirigés via l'agent utilisateur. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flux implicite</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - utilisé par les applications mobiles ou Web (applications s'exécutant sur l'appareil de l'utilisateur).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un type implicite d'autorisation d'autorisation est utilisé par les applications mobiles et Web où la confidentialité des clients ne peut pas être garantie. </font><font style="vertical-align: inherit;">Le type d'autorisation implicite utilise également la redirection de l'agent utilisateur et le jeton d'accès est transmis à l'agent utilisateur pour une utilisation ultérieure dans l'application. </font><font style="vertical-align: inherit;">Cela rend le jeton disponible pour l'utilisateur et d'autres applications sur l'appareil de l'utilisateur. </font><font style="vertical-align: inherit;">Avec ce type d'autorisation, l'application n'est pas authentifiée et le processus lui-même repose sur une URL de redirection (précédemment enregistrée dans le service).</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le flux implicite ne prend pas en charge les jetons d'actualisation.
</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flux d'octroi des informations d'identification client</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - utilisé lorsque l'application accède à l'API. </font><font style="vertical-align: inherit;">Ce type d'autorisation est généralement utilisé pour les interactions de serveur à serveur qui doivent s'exécuter en arrière-plan sans interaction immédiate avec l'utilisateur. </font><font style="vertical-align: inherit;">Le flux d'informations d'identification du client permet au service Web (le client confidentiel) d'utiliser ses propres informations d'identification au lieu d'usurper l'identité de l'utilisateur pour l'authentification lors de l'appel d'un autre service Web. </font><font style="vertical-align: inherit;">Pour un niveau de sécurité plus élevé, il est possible que le service appelant utilise un certificat (au lieu d'un secret partagé) comme informations d'identification. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La spécification OAuth2 est décrite dans la </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC-6749 </font></font></a> <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC-8252 </font></font></a> <br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC-6819</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeton JWT et ses avantages</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
JWT (JSON Web Token) est un standard ouvert ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://tools.ietf.org/html/rfc7519</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) qui définit une méthode compacte et autonome pour transférer en toute sécurité des informations entre les parties en tant qu'objet JSON. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon la norme, le jeton se compose de trois parties au format base 64, séparées par des points. </font><font style="vertical-align: inherit;">La première partie est appelée en-tête, qui contient le type de jeton et le nom de l'algorithme de hachage pour obtenir une signature numérique. </font><font style="vertical-align: inherit;">La deuxième partie stocke les informations de base (utilisateur, attributs, etc.). </font><font style="vertical-align: inherit;">La troisième partie est une signature numérique.</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;en-tête codé&gt;. &lt;charge utile codée&gt;. &lt;signature&gt;</font></font></oembed><br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N'enregistrez jamais de jeton dans votre base de données. </font><font style="vertical-align: inherit;">Étant donné qu'un jeton valide est équivalent à un mot de passe, le stockage d'un jeton revient à stocker un mot de passe en texte clair.</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un jeton d'accès</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un jeton qui donne à son propriétaire un accès aux ressources protégées du serveur. </font><font style="vertical-align: inherit;">Habituellement, il a une courte durée de vie et peut contenir des informations supplémentaires, telles que l'adresse IP de la partie demandant ce jeton. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un jeton d'actualisation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un jeton qui permet aux clients de demander de nouveaux jetons d'accès après l'expiration de leur durée de vie. </font><font style="vertical-align: inherit;">Ces jetons sont généralement émis pour une longue période. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Principaux avantages de l'application en architecture de microservices:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La possibilité d'accéder à diverses applications et services via une authentification unique.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En l'absence d'un certain nombre d'attributs requis dans le profil utilisateur, il est possible d'enrichir avec des données qui peuvent être ajoutées à la charge utile, y compris automatisées et à la volée.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il n'est pas nécessaire de stocker des informations sur les sessions actives, l'application serveur doit uniquement vérifier la signature.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contrôle d'accès plus flexible avec des attributs supplémentaires dans la charge utile.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilisation d'une signature de jeton pour l'en-tête et la charge utile augmente la sécurité de la solution dans son ensemble.</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeton JWT - Composition</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">tête</font></b><font style="vertical-align: inherit;"> - par défaut, l'en-tête contient uniquement le type de jeton et l'algorithme utilisé pour le chiffrement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le type de jeton est stocké dans la clé "typ". </font><font style="vertical-align: inherit;">La clé "typ" est ignorée dans le JWT. </font><font style="vertical-align: inherit;">Si la clé typ est présente, sa valeur doit être JWT pour indiquer que cet objet est un jeton Web JSON. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La deuxième clé alg définit l'algorithme utilisé pour chiffrer le jeton. </font><font style="vertical-align: inherit;">Par défaut, il doit être défini sur HS256. </font><font style="vertical-align: inherit;">L'en-tête est codé en base64.</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{"alg": "HS256", "typ": "JWT"}</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Charge utile (contenu)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - la charge utile stocke toutes les informations qui doivent être vérifiées. </font><font style="vertical-align: inherit;">Chaque clé de la charge utile est appelée «instruction». </font><font style="vertical-align: inherit;">Par exemple, la candidature ne peut être saisie que sur invitation (promo fermée). </font><font style="vertical-align: inherit;">Lorsque nous voulons inviter quelqu'un à participer, nous lui envoyons une lettre d'invitation. </font><font style="vertical-align: inherit;">Il est important de vérifier que l'adresse e-mail appartient à la personne qui accepte l'invitation, nous inclurons donc cette adresse dans la charge utile, pour cela nous l'enregistrerons dans la clé «e-mail»</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{"email": "example@x5.ru"}
</font></font></oembed><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les clés de la charge utile peuvent être arbitraires. </font><font style="vertical-align: inherit;">Cependant, il y en a quelques-uns réservés:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iss (Issuer) - définit l'application à partir de laquelle le jeton est envoyé.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub (Subject) - définit le sujet du jeton.</font></font></li>
<li>aud (Audience) –       URI,     .     JWT   ,        —   .</li>
<li>exp (Expiration Time) — ,     .  JWT ,           . Exp       unix .</li>
<li>nbf (Not Before) —    unix ,  ,    .</li>
<li>iat (Issued At) —     ,            JWT. iat       unix .</li>
<li>Jti (JWT ID) — ,      c  .</li>
</ul><br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est important de comprendre que la charge utile n'est pas transmise sous forme cryptée (bien que les jetons puissent être intégrés et qu'il soit alors possible de transmettre des données cryptées). </font><font style="vertical-align: inherit;">Par conséquent, il est impossible d'y stocker des informations secrètes. </font><font style="vertical-align: inherit;">Comme l'en-tête, la charge utile est codée en base64.</font></font></oembed><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Signature</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - lorsque nous avons un en-tête et une charge utile, nous pouvons calculer la signature. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encodé en Base64: l'en-tête et la charge utile sont pris, ils sont combinés en une ligne par un point. </font><font style="vertical-align: inherit;">Ensuite, cette ligne et la clé secrète sont envoyées à l'entrée de l'algorithme de chiffrement spécifié dans l'en-tête (clé "alg"). </font><font style="vertical-align: inherit;">La clé peut être n'importe quelle chaîne. </font><font style="vertical-align: inherit;">Des cordes plus longues seront préférables, car cela prendra plus de temps pour correspondre.</font></font><br>
<br>
<oembed><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{"alg": "RSA1_5", "charge utile": "A128CBC-HS256"}</font></font></oembed><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architecture du cluster de basculement Keycloak</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lorsque vous utilisez un seul cluster pour tous les projets, il existe des exigences accrues pour une solution d'authentification unique. Lorsque le nombre de projets est faible, ces exigences ne sont pas si perceptibles pour tous les projets, mais avec une augmentation du nombre d'utilisateurs et d'intégrations, les exigences d'accessibilité et de productivité augmentent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'augmentation du risque de défaillance d'un SSO unique augmente les exigences pour l'architecture de la solution et les méthodes utilisées pour la redondance des composants et conduit à un SLA très serré. À cet égard, plus souvent lors du développement ou dans les premiers stades de la mise en œuvre de solutions, les projets ont leur propre infrastructure non tolérante aux pannes. Au fur et à mesure de votre développement, vous devez prévoir la possibilité de développement et de mise à l'échelle. Le plus flexible est de créer un cluster de basculement à l'aide de la virtualisation de conteneurs ou d'une approche hybride.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour travailler dans des clusters actifs / actifs et actifs / passifs, il est nécessaire d'assurer la cohérence des données dans une base de données relationnelle - les deux nœuds de base de données doivent être répliqués de manière synchrone entre différents centres de données géo-distribués. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'exemple le plus simple d'une installation à sécurité intégrée. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xo/tw/7w/xotw7wkifwb3h6nnclvnjbbe72c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quels sont les avantages d'utiliser un seul cluster:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Haute disponibilité et performances.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prise en charge des modes de fonctionnement: actif / actif, actif / passif.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La possibilité d'évoluer dynamiquement - lors de l'utilisation de la virtualisation de conteneurs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Possibilité de gestion et de surveillance centralisées.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Approche unifiée pour l'identification / l'authentification / l'autorisation des utilisateurs dans les projets.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interaction plus transparente entre différents projets sans participation des utilisateurs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La possibilité de réutiliser le jeton JWT dans divers projets.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Point de confiance unique.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lancement plus rapide de projets utilisant la virtualisation de microservices / conteneurs (pas besoin de monter et configurer des composants supplémentaires).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peut-être l'acquisition d'un support commercial auprès du vendeur. </font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Éléments à prendre en compte lors de la planification d'un cluster</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SGBD</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keycloak utilise un système de gestion de SGBD pour sauvegarder: domaines, clients, utilisateurs, etc. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une large gamme de SGBD est prise en charge: MS SQL, Oracle, MySQL, PostgreSQL. </font><font style="vertical-align: inherit;">Keycloak est livré avec sa propre base de données relationnelle intégrée. </font><font style="vertical-align: inherit;">L'utilisation pour les environnements non chargés tels que les environnements de développement est recommandée. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour fonctionner dans des clusters actifs / actifs et actifs / passifs, il est nécessaire de garantir la cohérence des données dans une base de données relationnelle, et les deux nœuds du cluster de base de données sont répliqués de manière synchrone entre les centres de données.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cache distribué (Infinspan)</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour que le cluster fonctionne correctement, une synchronisation supplémentaire des types de cache suivants à l'aide de JBoss Data Grid est requise: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sessions d'authentification - utilisées pour enregistrer les données lors de l'authentification d'un utilisateur spécifique. </font><font style="vertical-align: inherit;">Les demandes de ce cache incluent généralement uniquement le navigateur et le serveur Keycloak, pas l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetons d'action - utilisés pour les scénarios où l'utilisateur doit confirmer l'action de manière asynchrone (par e-mail). </font><font style="vertical-align: inherit;">Par exemple, pendant le flux de mot de passe oublié, le cache actionTokens Infinispan est utilisé pour suivre les métadonnées sur les marqueurs d'action associés qui ont déjà été utilisés, il ne peut donc pas être réutilisé.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mise en cache et invalidation des données persistantes - utilisé pour mettre en cache les données persistantes pour éviter les requêtes de base de données inutiles. </font><font style="vertical-align: inherit;">Lorsqu'un serveur Keycloak met à jour des données, tous les autres serveurs Keycloak de tous les centres de données doivent en être conscients. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Travail - utilisé uniquement pour envoyer des messages d'invalidation entre les nœuds de cluster et les centres de données. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sessions utilisateur - utilisées pour enregistrer des données sur les sessions utilisateur valides pour la session de navigation d'un utilisateur. </font><font style="vertical-align: inherit;">Le cache doit gérer les requêtes HTTP de l'utilisateur final et de l'application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Protection contre la force brute - utilisée pour suivre les données de connexion ayant échoué.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'équilibrage de charge</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'équilibreur de charge est un point d'entrée unique dans keycloak et devrait prendre en charge les sessions persistantes. </font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serveur d'application</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils sont utilisés pour contrôler l'interaction des composants entre eux et peuvent être virtualisés ou conteneurisés à l'aide des outils d'automatisation existants et à l'échelle dynamique des outils d'automatisation d'infrastructure. </font><font style="vertical-align: inherit;">Les scénarios de déploiement les plus courants dans OpenShift, Kubernetes, Rancher. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur ce point, la première partie - théorique - est terminée. </font><font style="vertical-align: inherit;">Dans la série d'articles suivante, des exemples d'intégration avec divers fournisseurs d'identification et des exemples de configuration seront discutés.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr486778/">https://habr.com/ru/post/fr486778/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr486764/index.html">Bricolage Schema.org: personnalisation de la micro-mise en page sans programmeur</a></li>
<li><a href="../fr486766/index.html">Comment transférer toutes les transactions en ligne sur le marché de l'affacturage archaïque? Expérience de l'affacturage Sberbank</a></li>
<li><a href="../fr486768/index.html">Révision du panneau d'administration Webasyst</a></li>
<li><a href="../fr486772/index.html">Brûlez, mais ne brûlez pas - brûlez pour briller</a></li>
<li><a href="../fr486776/index.html">Complétion de code et vérification de type pour boto3</a></li>
<li><a href="../fr486780/index.html">Développement frontend dans l'entreprise: qu'est-ce que c'est et comment le rendre efficace</a></li>
<li><a href="../fr486782/index.html">UI / UX - conception. Tendances et prévisions pour 2020</a></li>
<li><a href="../fr486784/index.html">Les frères Lumiere n'ont jamais rêvé</a></li>
<li><a href="../fr486788/index.html">Webinaire «Surveillance à distance et diagnostic des équipements. Études de cas sur la solution CNC de Winnum »</a></li>
<li><a href="../fr486790/index.html">Et encore une fois Qbot - une nouvelle souche de cheval de Troie bancaire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>