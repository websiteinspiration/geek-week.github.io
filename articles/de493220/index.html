<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🏫 📹 🕍 Wir arbeiten lokal mit dem CO₂ Xiaomi ClearGrass-Luftdetektorsensor ohne chinesische Server 👩🏿‍🤝‍👩🏽 👇🏼 🧖🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lange Zeit hatte ich vor, einen Kohlendioxidsensor CO₂ in der Hausautomation einzuführen. In Bezug auf Preis / Qualität / Funktion / Aussehen erwies s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Wir arbeiten lokal mit dem CO₂ Xiaomi ClearGrass-Luftdetektorsensor ohne chinesische Server</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493220/"><img src="https://habrastorage.org/webt/hn/ly/y5/hnlyy5b88_sljyfalw7vhvutvpk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lange Zeit hatte ich vor, einen Kohlendioxidsensor CO₂ in der Hausautomation einzuführen. </font><font style="vertical-align: inherit;">In Bezug auf Preis / Qualität / Funktion / Aussehen erwies sich der Xiaomi ClearGrass-Luftdetektor als der beste für mich. </font><font style="vertical-align: inherit;">Der Luftqualitätsanalysator enthält Sensoren:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CO₂</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tVOC (flüchtige organische Verbindungen)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PM2.5</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temperatur</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Feuchtigkeit</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ClearGrass verfügt über einen hochwertigen Bildschirm mit großen Betrachtungswinkeln und einen Akku für 6 Stunden Akkulaufzeit. </font><font style="vertical-align: inherit;">Der Preis in der Größenordnung von 130 US-Dollar für ein solches Gerät übersetzt es in das Must-Have-Segment! </font><font style="vertical-align: inherit;">Eine großartige Rezension kann auf </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mysku.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gelesen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">werden</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Analysator kann der nativen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qingping + -</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oder </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MiHome-Anwendung hinzugefügt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> werden. In beiden Fällen werden die Daten über chinesische Server übertragen, was kategorisch nicht zu mir passte. </font><font style="vertical-align: inherit;">Ich habe mich entschlossen, herauszufinden, wie Daten lokal vom Sensor abgerufen werden können, ohne Remote-Server von Drittanbietern zu verwenden.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Verkehr studieren</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der erste Schritt bestand darin zu sehen, wie ClearGrass Daten an die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qingping +</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -Anwendung </font><b><font style="vertical-align: inherit;">überträgt</font></b><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">ClearGrass stellt über WLAN eine Verbindung zum Internet her. </font><font style="vertical-align: inherit;">Um den Datenverkehr zu hören, habe ich einen Zugriffspunkt auf dem Raspberry Pi Wi-Fi eingerichtet und tcpdump gestartet, um Informationen zu sammeln:</font></font><br>
<br>
<pre><code class="bash hljs">sudo tcpdump -i wlan0 -vv -s0 -X -n port 1883 -s 65535 -w cleargrass.pcap</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Analyse des Datenverkehrs ergab, dass ClearGrass auf etwa 5 verschiedene IP-Adressen zugreift und am 154.8.191.174 </font><font style="vertical-align: inherit;">Luftqualitätsdaten </font><font style="vertical-align: inherit;">unverschlüsselt mit dem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTT-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Protokoll überträgt </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x5/6f/2t/x56f2t0busaoxisazagrv-sgsxe.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Wir verpacken den Datenverkehr von ClearGrass auf dem Raspberry Pi</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem ich ein bisschen mit </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iptables</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> experimentiert hatte </font><b><font style="vertical-align: inherit;">,</font></b><font style="vertical-align: inherit;"> kam ich zu dieser Regel:</font></font><br>
<br>
<pre><code class="bash hljs">sudo iptables -i wlan0 -t nat -A PREROUTING -s 192.168.115.19 -j REDIRECT</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es lautet wie folgt: "Der gesamte neue Datenverkehr auf der wlan0-Schnittstelle von 192.168.115.19 (IP ClearGrass) sollte lokal umgeleitet werden." </font><font style="vertical-align: inherit;">Ich bin kein großer Kenner von iptables, daher freue ich mich über Vorschläge und Verbesserungen. </font><font style="vertical-align: inherit;">In dieser Regel gibt es ein Minus. Wenn der Analysator bereits mit dem Raspberry Pi verbunden ist, wird der Datenverkehr nicht umgeleitet. </font><font style="vertical-align: inherit;">Zuerst müssen Sie die Regel ausführen und erst dann ClearGrass über WLAN mit dem Raspberry Pi verbinden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als ich den MQTT- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mückenbroker</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> auf dem Raspberry Pi </font><b><font style="vertical-align: inherit;">abholte</font></b><font style="vertical-align: inherit;"> , sah ich, dass der Analysator einmal pro Minute Luftqualitätsdaten überträgt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. MQTT Nano-Broker auf JS für die Hausautomation Z-Way</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Heimautomationsserver verwende ich Z-Way, das viele Z-Wave-Geräte unterstützt und Skripte in JS schreiben kann. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/51/e5/bs/51e5bsz8q3zogjrys3rpah6tcx8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider gibt es für Z-Way keinen MQTT-Broker in JS (im Gegensatz zu Systemen, die auf node.js basieren). Daher habe ich beschlossen, einen minimalen Broker zu schreiben, der nur Daten von diesem Analysegerät akzeptiert und nichts anderes tun kann. </font><font style="vertical-align: inherit;">Ohne die Dokumentation besonders zu lesen, habe ich mir die Kommunikation zwischen dem Analysegerät und der Mücke angesehen und die folgende Sequenz zusammengestellt:</font></font><br>
<br>
<pre><code class="bash hljs">MQTT PROTOCOL<font></font>
<font></font>
Connect Command (sensor -&gt; broker)<font></font>
	0x10 - Connect Command<font></font>
<font></font>
Connect Ack (broker -&gt; sensor)<font></font>
	0x20 - Connect Ack<font></font>
	0x02 - Len 2<font></font>
	0x00<font></font>
	0x00 - Connection Accepted<font></font>
<font></font>
Subscribe Request (sensor -&gt; broker)<font></font>
	0x82 - 0b1000 0010; 0b1000 - Subscribe Request<font></font>
<font></font>
Subscribe Ack (broker -&gt; sensor)<font></font>
	0x90 - 0b1001 0000; 0b1001 - Subscribe Ack<font></font>
	0x03 - Len 3<font></font>
	0x00<font></font>
	0x08 - Message identifier 8<font></font>
	0x00 - Fire and Forget<font></font>
<font></font>
Ping Request (sensor -&gt; broker)<font></font>
	0xC0 - Ping Request<font></font>
	0x00 - Len 0<font></font>
<font></font>
Ping Response (broker -&gt; sensor)<font></font>
	0xD0 - Ping Response<font></font>
	0x00 - Len 0<font></font>
<font></font>
Publish Message (sensor -&gt; broker)<font></font>
	0x30 - Publish Message<font></font>
	0x96<font></font>
	0x04 - Len 534</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis wurde ein einfaches JS-Skript geboren:</font></font><br>
<br>
<pre><code class="javascript hljs">mqttSocket.reusable();<font></font>
mqttSocket.bind(<span class="hljs-number">1883</span>);<font></font>
mqttSocket.onrecv = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, host, port</span>) </span>{
	<span class="hljs-keyword">var</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(data);<font></font>
<font></font>
	<span class="hljs-keyword">switch</span>(arr[<span class="hljs-number">0</span>]) {
		<span class="hljs-comment">// PING</span>
		<span class="hljs-keyword">case</span> <span class="hljs-number">0xC0</span>:
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"---------- MQTT PING RESPONSE"</span>);
			<span class="hljs-keyword">this</span>.send([<span class="hljs-number">0xD0</span>, <span class="hljs-number">0x00</span>]);
			<span class="hljs-keyword">break</span>;
		<span class="hljs-comment">// CONNECT</span>
		<span class="hljs-keyword">case</span> <span class="hljs-number">0x10</span>:
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"---------- MQTT CONNECT ACK"</span>);
			<span class="hljs-keyword">this</span>.send([<span class="hljs-number">0x20</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>]);
			<span class="hljs-keyword">break</span>;
		<span class="hljs-comment">// SUBSCRIBE</span>
		<span class="hljs-keyword">case</span> <span class="hljs-number">0x82</span>:
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">"---------- MQTT SUBSCRIBE ACK"</span>);
			<span class="hljs-keyword">this</span>.send([<span class="hljs-number">0x90</span>, <span class="hljs-number">0x03</span>, arr[<span class="hljs-number">2</span>], arr[<span class="hljs-number">3</span>], <span class="hljs-number">0x00</span>]);
			<span class="hljs-keyword">break</span>;
		<span class="hljs-comment">// PUBLISH</span>
		<span class="hljs-keyword">case</span> <span class="hljs-number">0x30</span>:
			<span class="hljs-keyword">var</span> sensorPayload = self.getPayload(arr);
			<span class="hljs-keyword">var</span> sensorMessage = sensorPayload.substr(sensorPayload.indexOf(<span class="hljs-string">'{'</span>), sensorPayload.lastIndexOf(<span class="hljs-string">'}'</span>));
			<span class="hljs-keyword">var</span> sensorObj = <span class="hljs-built_in">JSON</span>.parse(sensorMessage);
			<span class="hljs-built_in">console</span>.logJS(<span class="hljs-string">"---------- MQTT MESSAGE:"</span>, sensorObj);
			<span class="hljs-built_in">console</span>.logJS(<span class="hljs-string">"---------- CO2: "</span>, sensorObj.data.co2);<font></font>
			self.vDevCO2.set(<span class="hljs-string">"metrics:level"</span>, sensorObj.data.co2);
			<span class="hljs-keyword">break</span>;<font></font>
	}<font></font>
};<font></font>
mqttSocket.listen();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Natürlich, obwohl zum Beispiel in einer Prämisse nicht viel berücksichtigt wird, können sowohl PING als auch MESSAGE kommen, aber ich werde einiges davon vermissen. </font><font style="vertical-align: inherit;">Vielleicht werde ich in Zukunft die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aedes-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Codebasis verwenden </font><font style="vertical-align: inherit;">, um einen MQTT-Broker für Z-Way zu erstellen. </font><font style="vertical-align: inherit;">Im Moment war das Ziel eine grundlegende Gelegenheit, lokale Luftqualitätsdaten vom Xiaomi ClearGrass Air Detector-Analysegerät abzurufen, und dieses Ziel wurde erreicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Zukunft möchte ich die Z-Wave-Version der TION S3-Entlüftung installieren und anhand der Daten von ClearGrass steuern.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de493202/index.html">RBK.money hat die weltweit erste Open-Source-Zahlungsverarbeitung veröffentlicht - gemeinsam die Zukunft gestalten</a></li>
<li><a href="../de493204/index.html">Alexey Komissarov über den digitalen Durchbruch 2020</a></li>
<li><a href="../de493206/index.html">Einige Beispiele zum Senden einer Anfrage an den Server</a></li>
<li><a href="../de493208/index.html">3D-Druck mit Fotopolymer in Sekunden</a></li>
<li><a href="../de493210/index.html">3D-Druck des Pandemieschutzes</a></li>
<li><a href="../de493222/index.html">Coronavirus und die IT-Branche - was jetzt passiert und was in naher Zukunft zu erwarten ist</a></li>
<li><a href="../de493224/index.html">Wie ich das Seminar gestreamt habe und die Studenten sogar mit mir gesprochen haben</a></li>
<li><a href="../de493226/index.html">Lesen und Korrigieren von 100.000 Codezeilen pro Woche</a></li>
<li><a href="../de493230/index.html">Neue Google PageSpeed ​​Insights mit Lighthouse 6 (Beta): Überprüfen Sie die Leistung Ihrer Website</a></li>
<li><a href="../de493232/index.html">Die Geschichte meiner Arbeit bei Open Product LLC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>