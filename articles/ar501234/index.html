<!doctype html>
<html class="no-js" lang="ar">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ฌ ๐ญ ๐ต๐ฝ ุงูุชูุฌูู ุงูุณุฑูุน ู NAT ุนูู Linux ๐๐ฟ ๐ โ๐ป</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุน ุงุณุชููุงุฏ ุนูุงููู IPv4 ุ ููุงุฌู ุงูุนุฏูุฏ ูู ูุดุบูู ุงูุงุชุตุงูุงุช ุงูุญุงุฌุฉ ุฅูู ุชูุธูู ูุตูู ุนููุงุฆูู ุฅูู ุงูุดุจูุฉ ุจุงุณุชุฎุฏุงู ุชุฑุฌูุฉ ุงูุนููุงู. ูู ูุฐู ุงูููุงูุฉ ุณุฃุฎุจุฑู ุจููููุฉ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ุงูุชูุฌูู ุงูุณุฑูุน ู NAT ุนูู Linux</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501234/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุน ุงุณุชููุงุฏ ุนูุงููู IPv4 ุ ููุงุฌู ุงูุนุฏูุฏ ูู ูุดุบูู ุงูุงุชุตุงูุงุช ุงูุญุงุฌุฉ ุฅูู ุชูุธูู ูุตูู ุนููุงุฆูู ุฅูู ุงูุดุจูุฉ ุจุงุณุชุฎุฏุงู ุชุฑุฌูุฉ ุงูุนููุงู. </font><font style="vertical-align: inherit;">ูู ูุฐู ุงูููุงูุฉ ุณุฃุฎุจุฑู ุจููููุฉ ุงูุญุตูู ุนูู ุฃุฏุงุก ูุณุชูู NAT Carrier Grade ุนูู ุฎูุงุฏู ุงูุณูุน.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููููู ูู ุงูุชุงุฑูุฎ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ูุนุฏ ููุถูุน ููุงุฏ ูุณุงุญุฉ ุนููุงู IPv4 ุฌุฏูุฏูุง. ูู ููุช ูุง ุ ุธูุฑุช ููุงุฆู ุงูุงูุชุธุงุฑ ูู RIPE ุ ุซู ูุงูุช ููุงู ุชุจุงุฏูุงุช ุชู ูููุง ุชุฏุงูู ูุฌููุนุงุช ูู ุงูุนูุงููู ูุฅุจุฑุงู ูุนุงููุงุช ูุฅูุฌุงุฑูุง. ุจุฏุฃ ูุดุบูู ุงูุงุชุตุงูุงุช ุชุฏุฑูุฌูุงู ูู ุชูุฏูู ุฎุฏูุงุช ุงููุตูู ุฅูู ุงูุฅูุชุฑูุช ูู ุฎูุงู ุชุฑุฌูุฉ ุงูุนูุงููู ูุงูููุงูุฐ. ูู ููุฌุญ ุดุฎุต ูุง ูู ุงูุญุตูู ุนูู ุนูุงููู ูุงููุฉ ูุฅุนุทุงุก ุนููุงู "ุฃุจูุถ" ููู ูุดุชุฑู ุ ุจูููุง ุจุฏุฃ ุดุฎุต ูุง ูู ุชูููุฑ ุงููุงู ูู ุฎูุงู ุฑูุถ ุดุฑุงุก ุงูุนูุงููู ูู ุงูุณูู ุงูุซุงูููุฉ. ุฏุนูุช ุงูุดุฑูุงุช ุงููุตูุนุฉ ููุนุฏุงุช ุงูุดุจูุฉ ูุฐู ุงูููุฑุฉ ููุง ุชุชุทูุจ ูุฐู ุงููุธููุฉ ุนุงุฏุฉู ูุญุฏุงุช ุฃู ุชุฑุงุฎูุต ุชูุณูุน ุฅุถุงููุฉ. ุนูู ุณุจูู ุงููุซุงู ุ ูุน ูุฌูุฏ Juniper ูู ุชุดูููุฉ ููุฌู MX (ุจุงุณุชุซูุงุก ุฃุญุฏุซ MX104 ู MX204) ุ ูููู ุชูููุฐ NAPT ุนูู ุจุทุงูุฉ ุฎุฏูุฉ MS-MIC ูููุตูุฉ ุ ูุชุทูุจ Cisco ASR1k ุชุฑุฎูุต GN ุุนูู Cisco ASR9k ุ ูุญุฏุฉ A9K-ISM-100 ูููุตูุฉ ูุฑุฎุตุฉ A9K-CGN-LIC ููุง. ุจุดูู ุนุงู ุ ุงููุชุนุฉ ุชููู ุงููุซูุฑ ูู ุงููุงู.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุจุชูุณ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุง ุชุชุทูุจ ูููุฉ ุชูููุฐ NAT ููุงุฑุฏ ุญูุณุจุฉ ูุชุฎุตุตุฉ ุ ูููู ูููุนุงูุฌุงุช ุฐุงุช ุงูุฃุบุฑุงุถ ุงูุนุงูุฉ ุงูุชู ูุชู ุชุซุจูุชูุง ุ ุนูู ุณุจูู ุงููุซุงู ุ ูู ุฃู ุฌูุงุฒ ุชูุฌูู ููุฒูู ุ ุญููุง. </font><font style="vertical-align: inherit;">ุนูู ูููุงุณ ุดุฑูุฉ ุงูููู ุ ูููู ุญู ูุฐู ุงููุดููุฉ ุจุงุณุชุฎุฏุงู ุฎูุงุฏู ุงูุณูุน ุงูุชู ุชุนูู ุจูุธุงู FreeBSD (ipfw / pf) ุฃู GNU / Linux (iptables). </font><font style="vertical-align: inherit;">ูู ูููุฑ ูุฑู ุ ูุฃูู </font><font style="vertical-align: inherit;">ููุฏ ุฑูุถุช ุงุณุชุฎุฏุงู ูุธุงู ุงูุชุดุบูู ูุฐุง ููุชุฑุฉ ุทูููุฉ ุ ูุฐุง ุฏุนูุง ูุฑูุฒ ุนูู ุฌูู / ููููุณ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ููุณ ูู ุงูุตุนุจ ุนูู ุงูุฅุทูุงู ุชุดุบูู ุชุฑุฌูุฉ ุงูุนููุงู. </font><font style="vertical-align: inherit;">ุชุญุชุงุฌ ุฃููุงู ุฅูู ูุชุงุจุฉ ุงููุงุนุฏุฉ ูู iptables ูู ุฌุฏูู nat:</font></font><br>
<br>
<pre><code class="bash hljs">iptables -t nat -A POSTROUTING -s 100.64.0.0/10 -j SNAT --to &lt;pool_start_addr&gt;-&lt;pool_end_addr&gt; --persistent
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุณูููู ูุธุงู ุงูุชุดุบูู ุจุชุญููู ูุญุฏุฉ nf_conntrack ุ ูุงูุชู ุณุชุฑุงูุจ ุฌููุน ุงูุงุชุตุงูุงุช ุงููุดุทุฉ ูุฅุฌุฑุงุก ุงูุชุญูููุงุช ุงููุงุฒูุฉ. </font><font style="vertical-align: inherit;">ููุงู ุงูุนุฏูุฏ ูู ุงูุชูุงุตูู ุงูุฏูููุฉ. </font><font style="vertical-align: inherit;">ุฃููุงู ุ ุจูุง ุฃููุง ูุชุญุฏุซ ุนู NAT ุนูู ูุทุงู ุดุฑูุฉ ุงูููู ุ ููู ุงูุถุฑูุฑู ุชุดุฏูุฏ ุงููููุงุช ุ ูุฃูู ูุน ุงูููู ุงูุงูุชุฑุงุถูุฉ ุ ุณูููู ุญุฌู ุฌุฏูู ุงูุชุฑุฌูุฉ ุจุณุฑุนุฉ ุฅูู ููู ูุงุฑุซูุฉ. </font><font style="vertical-align: inherit;">ูููุง ููู ูุซุงู ููุฅุนุฏุงุฏุงุช ุงูุชู ุงุณุชุฎุฏูุชูุง ุนูู ุฎุงุฏูู:</font></font><br>
<br>
<pre><code class="bash hljs">net.ipv4.ip_forward = 1<font></font>
net.ipv4.ip_local_port_range = 8192 65535<font></font>
<font></font>
net.netfilter.nf_conntrack_generic_timeout = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_established = 600<font></font>
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 60<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 45<font></font>
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30<font></font>
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120<font></font>
net.netfilter.nf_conntrack_tcp_timeout_close = 10<font></font>
net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300<font></font>
net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300<font></font>
net.netfilter.nf_conntrack_udp_timeout = 30<font></font>
net.netfilter.nf_conntrack_udp_timeout_stream = 60<font></font>
net.netfilter.nf_conntrack_icmpv6_timeout = 30<font></font>
net.netfilter.nf_conntrack_icmp_timeout = 30<font></font>
net.netfilter.nf_conntrack_events_retry_timeout = 15<font></font>
net.netfilter.nf_conntrack_checksum=0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุซุงูููุง ุ ูุธุฑูุง ูุฃู ุงูุญุฌู ุงูุงูุชุฑุงุถู ูุฌุฏูู ุงูุชุฑุฌูุฉ ุบูุฑ ูุตูู ููุนูู ูู ุธุฑูู ูุดุบู ุงูุงุชุตุงูุงุช ุ ูุฌุจ ุฒูุงุฏุชู:</font></font><br>
<br>
<pre><code class="plaintext hljs">net.netfilter.nf_conntrack_max = 3145728
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 ูู ุงูุถุฑูุฑู ุฃูุถูุง ุฒูุงุฏุฉ ุนุฏุฏ ุงููุฌููุนุงุช ูุฌุฏูู ุงูุชุฌุฒุฆุฉ ุงูุฐู ูุฎุฒู ุฌููุน ุงูุชุฑุฌูุงุช (ูุฐุง ูู ุฎูุงุฑ ูุญุฏุฉ nf_conntrack): </font></font><br>
<br>
<pre><code class="plaintext hljs">options nf_conntrack hashsize=1572864
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุจุนุฏ ูุฐู ุงูุชูุงุนุจุงุช ุงูุจุณูุทุฉ ุ ูุชู ุงูุญุตูู ุนูู ุจูุงุก ูุนูู ุจุดูู ูุงูู ุ ูุงูุฐู ูููู ุฃู ูุชุฑุฌู ุนุฏุฏูุง ูุจูุฑูุง ูู ุนูุงููู ุงูุนููุงุก ุฅูู ุชุฌูุน ุฎุงุฑุฌู. ููุน ุฐูู ุ ูุฅู ุฃุฏุงุก ูุฐุง ุงูุญู ุถุนูู. ูู ูุญุงููุงุชู ุงูุฃููู ูุงุณุชุฎุฏุงู GNU / Linux ูู NAT (ุญูุงูู 2013) ุ ุชูููุช ูู ุงูุญุตูู ุนูู ุฃุฏุงุก 7 ุฌูุฌุงุจุช / ุซุงููุฉ ุจุณุฑุนุฉ 0.8 ููุฌุงุจุช ูู ุงูุซุงููุฉ ููู ุฎุงุฏู (Xeon E5-1650v2). ููุฐ ุฐูู ุงูููุช ุ ุชู ุฅุฌุฑุงุก ุงูุนุฏูุฏ ูู ุงูุชุญุณููุงุช ุงููุฎุชููุฉ ูู ููุฏุณ ุดุจูุฉ GNU / Linux kernel ุ ูุฒุงุฏ ุฃุฏุงุก ุฎุงุฏู ูุงุญุฏ ุนูู ููุณ ุงูุฌูุงุฒ ุชูุฑูุจูุง ุฅูู 18-19 ุฌูุฌุงุจุช / ุซุงููุฉ ุนูุฏ 1.8-1.9 ููุฌุง ุจุช ูู ุงูุซุงููุฉ (ูุงูุช ูุฐู ูู ุงูููู ุงูุญุฏูุฉ) ุ ูููู ุงูุญุงุฌุฉ ุฅูู ุญุฌู ุญุฑูุฉ ุงููุฑูุฑ ุ ูุนุงูุฌุชูุง ุจูุงุณุทุฉ ุฎุงุฏู ูุงุญุฏ ุ ููุช ุจุดูู ุฃุณุฑุน. ููุชูุฌุฉ ูุฐูู ุ ุชู ุชุทููุฑ ูุฎุทุทุงุช ููุงุฒูุฉ ุงูุชุญููู ูุฎูุงุฏู ูุฎุชููุฉ ุ ูููู ูู ูุฐุง ุฒุงุฏ ูู ุชุนููุฏ ุงูุฅุนุฏุงุฏ ุุฎุฏูุฉ ูุงูุญูุงุธ ุนูู ุฌูุฏุฉ ุงูุฎุฏูุงุช ุงูููุฏูุฉ.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ููุชุงุจูุฒ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูู ุงูููุช ุงูุญุงุถุฑ ุ ูุนุฏ ุงุณุชุฎุฏุงู DPDK ู XDP ุงุชุฌุงููุง ุนุตุฑููุง ูู ุจุฑูุงูุฌ "ููู ุงูุญุฒู". </font><font style="vertical-align: inherit;">ุชูุช ูุชุงุจุฉ ุงูุนุฏูุฏ ูู ุงูููุงูุงุช ุญูู ูุฐุง ุงูููุถูุน ุ ูุชู ุนูู ุงูุนุฏูุฏ ูู ุงูุนุฑูุถ ุงูุชูุฏูููุฉ ุงููุฎุชููุฉ ุ ูุชุธูุฑ ุงูููุชุฌุงุช ุงูุชุฌุงุฑูุฉ (ุนูู ุณุจูู ุงููุซุงู ุ SKAT ูู VasExperts). </font><font style="vertical-align: inherit;">ูููู ูู ุธุฑูู ุงูููุงุฑุฏ ุงููุญุฏูุฏุฉ ูููุจุฑูุฌูู ูู ูุดุบูู ุงูุงุชุตุงูุงุช ุ ูู ุงูุตุนุจ ุฌุฏูุง ูุทุน "ุญุตุฉ" ูู ููุน ูุง ุนูู ุฃุณุงุณ ูุฐู ุงูุฃุทุฑ. </font><font style="vertical-align: inherit;">ูุชุดุบูู ูุซู ูุฐุง ุงูุญู ูู ุงููุณุชูุจู ุณูููู ุฃูุซุฑ ุตุนูุจุฉ ุ ุนูู ูุฌู ุงูุฎุตูุต ุ ุณูููู ูู ุงูุถุฑูุฑู ุชุทููุฑ ุฃุฏูุงุช ุงูุชุดุฎูุต. </font><font style="vertical-align: inherit;">ุนูู ุณุจูู ุงููุซุงู ุ ูุง ูุนูู tcpdump ุงูุนุงุฏู ูุน DPDK ุ ููู "ูุฑู" ุงูุญุฒู ุงููุฑุณูุฉ ุฅูู ุงูุฃุณูุงู ุจุงุณุชุฎุฏุงู XDP. </font><font style="vertical-align: inherit;">ููู ุฎุถู ูู ูุฐุง ุงูุญุฏูุซ ุนู ุชูููุงุช ุฌุฏูุฏุฉ ูุฅุฎุฑุงุฌ ุชูุฌูู ุงูุญุฒูุฉ ุฅูู ุงููุณุชุฎุฏู ุงููุถุงุกุ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุชูุงุฑูุฑ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ู </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">ููุงูุงุช</font></a><font style="vertical-align: inherit;"> ุฐูุจุช ุฏูู ุฃู ููุงุญุธูุง ุฃุญุฏ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุจุงุจูู ููุฑุง ุฃููุณู ุ ูุดุฑู iptables ุ ุนูู ุชุทููุฑ ุชูุฑูุบ ุงูุชุฏูู ูู nftables. ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ูุฐู ุงูุขููุฉ ุจูุฒูุฏ ูู ุงูุชูุตูู.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุงูููุฑุฉ ุงูุฑุฆูุณูุฉ ูู ุฃูู ุฅุฐุง ูุฑุฑ ุฌูุงุฒ ุงูุชูุฌูู ุญุฒู ุฌูุณุฉ ูุงุญุฏุฉ ุนูู ุฌุงูุจู ุงูุฏูู (ุชุญููุช ุฌูุณุฉ TCP ุฅูู ุงูุญุงูุฉ ESTABLISHED) ุ ููู ุชููู ููุงู ุญุงุฌุฉ ูุชูุฑูุฑ ุงูุญุฒู ุงููุงุญูุฉ ููุฐู ุงูุฌูุณุฉ ูู ุฎูุงู ุฌููุน ููุงุนุฏ ุฌุฏุงุฑ ุงูุญูุงูุฉ ุ ูุฃู ูู ูุฐู ุงููุญูุตุงุช ุณุชูุชูู ุฌููุนูุง ุนู ุทุฑูู ููู ุงูุญุฒูุฉ ุฅูู ุงูุชูุฌูู. ูุนู ุ ูุงููุงูุน ุฃู ุงุฎุชูุงุฑ ุงููุณุงุฑ ูุง ูุญุชุงุฌ ุฅูู ุฅุฌุฑุงุก - ููุญู ูุนุฑู ุจุงููุนู ุงููุงุฌูุฉ ููุงุฌูุฉ ุงููุถูู ุงูุชู ูุฌุจ ุฅุนุงุฏุฉ ุชูุฌูู ุงูุญุฒู ุฎูุงู ูุฐู ุงูุฌูุณุฉ. ูุจูู ููุท ูุญูุธ ูุฐู ุงููุนูููุงุช ูุงุณุชุฎุฏุงููุง ููุชูุฌูู ูู ูุฑุญูุฉ ูุจูุฑุฉ ูู ูุนุงูุฌุฉ ุงูุญุฒู. ุนูุฏ ุฅุฌุฑุงุก NAT ุ ูู ุงูุถุฑูุฑู ุฃูุถูุง ุญูุธ ุงููุนูููุงุช ุญูู ุงูุชุบููุฑุงุช ูู ุงูุนูุงููู ูุงูููุงูุฐ ุงููุญููุฉ ุจูุงุณุทุฉ ูุญุฏุฉ nf_conntrack. ูุนู ุ ุจุงูุทุจุน ุ ูู ูุฐู ุงูุญุงูุฉ ุ ุชููู ุงูุนุฏูุฏ ูู ุงููุญุงุถุฑูู ูููุงุนุฏ ุฅุญุตุงุฆูุฉ ุงููุนูููุงุช ุงูุฃุฎุฑู ูู iptables ุนู ุงูุนูู ุูููู ูุฌุฒุก ูู ูููุฉ NAT ุงูุฏุงุฆูุฉ ุงููููุตูุฉ ุฃู ุ ุนูู ุณุจูู ุงููุซุงู ุ ุงูุญุฏูุฏ ุ ููุฐุง ููุณ ููููุง ุฌุฏูุง ุ ูุฃู ุงูุฎุฏูุงุช ููุฒุนุฉ ุนุจุฑ ุงูุฃุฌูุฒุฉ.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุชุฑุชูุจ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุงุณุชุฎุฏุงู ูุฐู ุงููุธููุฉ ูุญุชุงุฌ ุฅูู:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงุณุชุฎุฏู ููุงุฉ ุฌุฏูุฏุฉ. </font><font style="vertical-align: inherit;">ุนูู ุงูุฑุบู ูู ุญูููุฉ ุฃู ุงููุธููุฉ ููุณูุง ุธูุฑุช ูู ููุงุฉ 4.16 ุ ุฅูุง ุฃููุง ูุงูุช "ุฎุงููุง" ููุชุฑุฉ ุทูููุฉ ููุงูุช ุชุณูู ุจุดูู ุฏูุฑู ุฐุนุฑ ุงูููุงุฉ. </font><font style="vertical-align: inherit;">ุงุณุชูุฑ ูู ุดูุก ูู ุฏูุณูุจุฑ 2019 ุชูุฑูุจูุง ุ ุนูุฏูุง ุชู ุฅุตุฏุงุฑ ููุงุฉ LTS 4.19.90 ู 5.4.5.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุฅุนุงุฏุฉ ูุชุงุจุฉ ููุงุนุฏ iptables ุจุชูุณูู nftables ุจุงุณุชุฎุฏุงู ุฅุตุฏุงุฑ ุญุฏูุซ ุฅูู ุญุฏ ูุง ูู nftables. </font><font style="vertical-align: inherit;">ูุนูู ุจุดูู ุฌูุฏ ูู ุงูุฅุตุฏุงุฑ 0.9.0</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุฅุฐุง ูุงู ูู ุดูุก ูุงุถุญูุง ูู ุญูุซ ุงููุจุฏุฃ ูุน ุงูููุฑุฉ ุงูุฃููู ุ ูุฅู ุงูุดูุก ุงูุฑุฆูุณู ูู ุนุฏู ูุณูุงู ุชุถููู ุงููุญุฏุฉ ุงูููุทูุฉ ูู ุงูุชูููู ุฃุซูุงุก ุงูุชุฌููุน (CONFIG_NFT_FLOW_OFFLOAD = m) ุ ูุฅู ุงูููุฑุฉ ุงูุซุงููุฉ ุชุชุทูุจ ุดุฑุญูุง. </font><font style="vertical-align: inherit;">ูุชู ูุตู ููุงุนุฏ nftables ุจุดูู ูุฎุชูู ุชูุงููุง ุนู ููุงุนุฏ iptables. </font><font style="vertical-align: inherit;">ุชูุดู </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุซุงุฆู</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ุนู ุฌููุน ุงูููุงุท ุชูุฑูุจูุง ุ ูููุงู ุฃูุถูุง </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ูุญููุงุช</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ููุงุนุฏ </font><font style="vertical-align: inherit;">ุฎุงุตุฉ </font><font style="vertical-align: inherit;">ูู iptables ุฅูู nftables. </font><font style="vertical-align: inherit;">ูุฐูู ุ ุณุฃุนุทู ููุท ูุซุงููุง ุนูู ุฅุนุฏุงุฏ NAT ูุฅูุบุงุก ุชุญููู ุงูุชุฏูู. </font><font style="vertical-align: inherit;">ูุณููุฉ ุฅูุถุงุญ ุตุบูุฑุฉ ููุซุงู: &lt;i_if&gt; ุ &lt;o_if&gt; ูู ูุงุฌูุงุช ุงูุดุจูุฉ ุงูุชู ุชูุฑ ูู ุฎูุงููุง ุญุฑูุฉ ุงููุฑูุฑ ุ ูู ุงููุงูุน ูููู ุฃู ูููู ููุงู ุฃูุซุฑ ูู ุงุซููู. </font><font style="vertical-align: inherit;">&lt;pool_addr_start&gt; ุ &lt;pool_addr_end&gt; - ุนููุงู ุงูุจุฏุงูุฉ ูุงูููุงูุฉ ููุทุงู ุงูุนูุงููู "ุงูุจูุถุงุก". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุชูููู NAT ุจุณูุท ููุบุงูุฉ:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table nat {<font></font>
        chain postrouting {<font></font>
                <span class="hljs-built_in">type</span> nat hook postrouting priority 100;<font></font>
                oif &lt;o_if&gt; snat to &lt;pool_addr_start&gt;-&lt;pool_addr_end&gt; persistent<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุนุฏ ุชูุฑูุบ ุงูุชุฏูู ุฃูุซุฑ ุชุนููุฏูุง ุจุนุถ ุงูุดูุก ุ ููููู ููููู:</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment">#! /usr/sbin/nft -f</span><font></font>
<font></font>
table inet filter {<font></font>
        flowtable fastnat {<font></font>
                hook ingress priority 0<font></font>
                devices = { &lt;i_if&gt;, &lt;o_if&gt; }<font></font>
        }<font></font>
<font></font>
        chain forward {<font></font>
                <span class="hljs-built_in">type</span> filter hook forward priority 0; policy accept;<font></font>
                ip protocol { tcp , udp } flow offload @fastnat;<font></font>
        }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุฐุง ุ ูู ุงููุงูุน ุ ูู ุงูุฅุนุฏุงุฏ ุจุฃูููู. </font><font style="vertical-align: inherit;">ุงูุขู ุณุชุฐูุจ ูู ุญุฑูุฉ ูุฑูุฑ TCP / UDP ุฅูู ุฌุฏูู fastnat ูุณุชุชู ูุนุงูุฌุชูุง ุจุดูู ุฃุณุฑุน.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ุงููุชุงุฆุฌ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุชูุถูุญ ูุฏู ุณุฑุนุฉ "ูุฐุง ุจูุซูุฑ" ุ ุณุฃุฑูู ููุทุฉ ุดุงุดุฉ ููุญูู ุนูู ุฎุงุฏููู ุญูููููู ุจููุณ ุงูุฌูุงุฒ (Xeon E5-1650v2) ุ ุชูุช ุชููุฆุชููุง ุจููุณ ุงููุฏุฑ ุ ุจุงุณุชุฎุฏุงู ููุณ ููุงุฉ Linux ุ ูููู ุชุดุบูู NAT ูู iptables (NAT4) ููู nftables (NAT5). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/y7/ov/c7/y7ovc7nkxxoply2apwjtur9tj-m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ูุง ููุฌุฏ ุฑุณู ุจูุงูู ููุญุฒู ูู ุงูุซุงููุฉ ูู ููุทุฉ ุงูุดุงุดุฉ ุ ูููู ูู ููู ุชุนุฑูู ุงูุชุญููู ููุฐู ุงูุฎูุงุฏู ุ ูุจูุบ ูุชูุณุท โโุญุฌู ุงูุญุฒูุฉ ุญูุงูู 800 ุจุงูุช ุ ูุฐูู ุชุฑุชูุน ุงูููู ุฅูู 1.5 ููุฌุง ุจุช ูู ุงูุซุงููุฉ. </font><font style="vertical-align: inherit;">ููุง ุชุฑู ุ ูุฅู ูุงูุด ุฃุฏุงุก ุงูุฎุงุฏู ูุน nftables ุถุฎู. </font><font style="vertical-align: inherit;">ูู ุงูููุช ุงูุญุงูู ุ ูุนุงูุฌ ูุฐุง ุงูุฎุงุฏู ูุง ูุตู ุฅูู 30 ุฌูุฌุงุจุช / ุซุงููุฉ ุจุณุฑุนุฉ 3 ููุฌุงุจุช ูู ุงูุซุงููุฉ ุ ููู ุงููุงุถุญ ุฃูู ูุงุฏุฑ ุนูู ุชุดุบูู ุงููููุฏ ุงููุงุฏูุฉ ูุดุจูุฉ 40 ุฌูุฌุงุจุช ูู ุงูุซุงููุฉ ุ ูุน ูุฌูุฏ ููุงุฑุฏ ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุงููุฌุงููุฉ. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ุขูู ุฃู ุชููู ูุฐู ุงููุงุฏุฉ ูููุฏุฉ ููููุฏุณู ุงูุดุจูุงุช ุงูุฐูู ูุญุงูููู ุชุญุณูู ุฃุฏุงุก ุฎูุงุฏููู.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar501220/index.html">ุงูุชุญููู: ูู ูููู ููุดุฑูุฉ ุงูุชูุงู ุงููุซูุฑ ูู ุงููุงูุ</a></li>
<li><a href="../ar501222/index.html">ุชุทุจูู COBIT ุนูุฏ ุชุทููุฑ ุงุณุชุฑุงุชูุฌูุฉ ุชูููููุฌูุง ุงููุนูููุงุช</a></li>
<li><a href="../ar501224/index.html">ูุง ูููู ููุดุจูุงุช ุงูุนุตุจูุฉ "ุบูุงุก" ูุฃุฏุงุก ูุนุฏู ุงูููุช</a></li>
<li><a href="../ar501226/index.html">ุจุญุซ ุณุฑูุน ุนู ุงููููุงุช</a></li>
<li><a href="../ar501232/index.html">ููู ูููู ูุฎุจูุฑ ุชูููููุฌูุง ุงููุนูููุงุช ูุณุจ ุงููุฒูุฏ ูู ุงููุนุฑูุฉ</a></li>
<li><a href="../ar501236/index.html">ุฅุฐู ูุง ูู ูู ูุฐุง ุ "ุทู ุงูุจุฑูุชูู"ุ</a></li>
<li><a href="../ar501240/index.html">ุชุฏููู ุฃูู ุงููููุน</a></li>
<li><a href="../ar501244/index.html">ูุง ูุญุชุงุฌ ุงููุจุฑูุฌ ุฅูู ุญู ูุดุงูู ุงูุนูู</a></li>
<li><a href="../ar501246/index.html">ุชุตุญูุญ ุบุฑุงููู 19-ุงูุฑุณููุงุช</a></li>
<li><a href="../ar501248/index.html">JavaScript Workplace Hall of Fame ุ ุงูุฌุฒุก 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>