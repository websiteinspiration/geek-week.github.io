<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏕️ 👩🏿‍🤝‍👩🏻 🔖 本「Terraform：コードレベルのインフラストラクチャ」 🕥 🖊️ ✌🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、habrozhiteli！この本は、すでに書かれたコードを担当するすべての人を対象としています。これは、システム管理者、運用スペシャリスト、リリース、SR、DevOpsエンジニア、インフラストラクチャ開発者、フルサイクル開発者、エンジニアリングチームリーダー、テクニカルディレクターに適用...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>本「Terraform：コードレベルのインフラストラクチャ」</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/503858/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><img src="https://habrastorage.org/webt/el/eg/lp/eleglpt_bkgjd7cftgp1yrmg_gk.jpeg" align="left" alt="画像"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、habrozhiteli！この本は、すでに書かれたコードを担当するすべての人を対象としています。これは、システム管理者、運用スペシャリスト、リリース、SR、DevOpsエンジニア、インフラストラクチャ開発者、フルサイクル開発者、エンジニアリングチームリーダー、テクニカルディレクターに適用されます。インフラストラクチャに関与し、コードを展開し、サーバーを構成し、クラスターをスケーリングし、データをバックアップし、アプリケーションを監視し、午前3時に電話に応答する場合、この本はあなたのためです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まとめると、これらの責任は一般に運用活動（またはシステム管理）と呼ばれます。</font><font style="vertical-align: inherit;">以前は、コードの記述方法は知っていてもシステム管理を理解していない開発者によく会いました。</font><font style="vertical-align: inherit;">システム管理者は、コードを書くことができないまま出くわすことがよくありました。</font><font style="vertical-align: inherit;">この分離が受け入れられるようになったが、クラウドコンピューティングとDevOps運動なしには想像もできない現代の世界では、ほとんどすべての開発者が管理スキルを必要とし、システム管理者はプログラミングを行うことができなければなりません。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraformを使用してインフラストラクチャをコードの形で管理する方法を学ぶだけでなく、DevOpsの全体的な概念にインフラストラクチャがどのように適合するかについても学びます。</font><font style="vertical-align: inherit;">この本を読んで、あなたが答えることができるいくつかの質問があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜIaCを使用するのですか？</font></font></li>
<li>    , ,     ?</li>
<li>   Terraform, Chef, Ansible, Puppet, Salt, CloudFormation, Docker, Packer  Kubernetes?</li>
<li>   Terraform       ?</li>
<li>   Terraform,    ?</li>
<li>    Terraform,       ?</li>
<li>     Terraform?</li>
<li>  Terraform     ?</li>
<li>    Terraform   ?</li>
</ul><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    </b>
                        <div class="spoiler_text">    2017 .   2019-         ,      !                 .  ,        .<br>
<br>
        ,  ,     ,    Terraform,    .<br>
<br>
<ul>
<li>   Terraform.    ,   Terraform  0.8.     Terraform   0.12.       ,     .  ,   !</li>
<li>   .           Terraform.    , ,    ,  ,    ,  ,  ,    .</li>
<li>  .      Terraform   .  , ,               — ,      .</li>
<li>   .  8      ,      Terraform    . ,  ,      ,          : ,      .</li>
<li>HCL2.  Terraform 0.12   HCL   HCL2.        (       ${…}!),   ,     ,   null, for_each  for,    .          HCL2,         5  6.</li>
<li>   .  Terraform 0.9    .        Terraform    .  Terraform 0.9     ,       ;     0.10      .       3.</li>
<li>    Terraform.  Terraform 0.10         (    AWS, GCP, Azure  . .).         ,         .          terraform init  ,       .       2  7.</li>
<li>   .  2016   Terraform        (AWS, GCP  Azure).      100,  ,  ,   1.               (,     Alicloud, Oracle Cloud Infrastructure, VMware vSphere  .),       ,     (GitHub, GitLab  BitBucket),   (MySQL, PostreSQL  InfluxDB),     ( DataDog, New Relic  Grafana),   Kubernetes, Helm, Heroku, Rundeck  Rightscale   .  ,       : ,   AWS     ,        ,   CloudFormation!</li>
<li>  Terraform.  2017   HashiCorp    Terraform (registry.terraform.io) —  ,         Terraform,  .  2018          .  Terraform 0.11        .       « »  . 153.</li>
<li>  .  Terraform 0.9    :         ,    ,   errored.tfstate.  Terraform 0.12    .    ,            ,     .</li>
<li>   .      ,     (.  «  »  . 144),  « »         (,  «  Terraform»  . 242),  plan    apply (.  «  »  . 64),     create_before_destroy,    count,           (.  «»  . 160),    ,   provider   .</li>
</ul></div>
                    </div><br>
<h3>.    Terraform</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（後で本の自動テストの問題により多くの注意が払われます）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DevOpsの世界はさまざまな恐怖に満ちています。変更を行うときは、常に、それがどのような結果をもたらすかを自問します。すべての環境で同じように動作しますか？別の障害が発生しますか？そして、それが起こった場合、それを修正するために今回どれだけ仕事を続けなければなりませんか？会社が成長するにつれて、さらに多くの問題が発生し、展開プロセスがさらに悪化し、エラーのリスクが高まります。多くの企業では、展開の頻度を少なくしてこのリスクを最小限に抑えようとしていますが、その結果、個々の展開が大きくなり、エラーが発生しやすくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インフラストラクチャをコードの形式で管理する場合、リスクを最小限に抑えるためのより良い方法、つまりテストがあります。</font><font style="vertical-align: inherit;">彼らの目標は、変更を加えるのに十分な自信を与えることです。</font><font style="vertical-align: inherit;">ここでのキーワードは信頼です。どのテストもエラーがないことを保証できないため、確率に対処する可能性が高くなります。</font><font style="vertical-align: inherit;">すべてのインフラストラクチャと展開プロセスをコードとしてキャプチャできる場合は、このコードをテスト環境でテストできます。</font><font style="vertical-align: inherit;">成功すれば、同じコードが産業環境で機能する大きな可能性があります。</font><font style="vertical-align: inherit;">恐怖と不確実性の世界では、高い確率と自信は高くつきます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この章では、インフラストラクチャコードを手動と自動の両方でテストするプロセスについて、後者を中心に説明します。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手動テスト：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手動テストの基本;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト後のリソースのクリーンアップ。</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動テスト：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユニットテスト;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">統合テスト;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エンドツーエンドのテスト。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他のテスト方法。</font></font></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手動テスト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terraformコードをテストする方法を考えるとき、Rubyなどの汎用プログラミング言語で書かれたテストコードといくつかの類似点を描くと便利です。</font><font style="vertical-align: inherit;">単純なRuby Webサーバーをweb-server.rbファイルに記述しているとします。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebServer</span> &lt; <span class="hljs-title">WEBrick</span>::<span class="hljs-title">HTTPServlet</span>::<span class="hljs-title">AbstractServlet</span>
  <span class="hljs-title">def</span> <span class="hljs-title">do_GET</span>(<span class="hljs-title">request</span>, <span class="hljs-title">response</span>)
     <span class="hljs-title">case</span> <span class="hljs-title">request</span>.<span class="hljs-title">path</span>
     <span class="hljs-title">when</span> "/"
         <span class="hljs-title">response</span>.<span class="hljs-title">status</span> </span>= <span class="hljs-number">200</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Hello, World'</span>
     <span class="hljs-keyword">else</span>
         response.status = <span class="hljs-number">404</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Not Found'</span><font></font>
     end<font></font>
  end<font></font>
end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードは、URL /の本文Hello、Worldを含む200 OK応答を返します。</font><font style="vertical-align: inherit;">他のアドレスの場合、答えは404になります。このコードを手動でどのようにテストしますか？</font><font style="vertical-align: inherit;">通常、Webサーバーをローカルで実行するためのコードがいくつか追加されます。</font></font><br>
<br>
<pre><code class="java hljs">#   ,      <font></font>
#  ,       <font></font>
<span class="hljs-keyword">if</span> __FILE__ == $<span class="hljs-number">0</span>
  #      <span class="hljs-number">8000</span>
  server = WEBrick::HTTPServer.new :Port =&gt; <span class="hljs-number">8000</span>
  server.mount <span class="hljs-string">'/'</span>, WebServer<font></font>
<font></font>
  #    Ctrl+C<font></font>
  trap <span class="hljs-string">'INT'</span> <span class="hljs-keyword">do</span> server.shutdown end<font></font>
<font></font>
  #  <font></font>
  server.start<font></font>
end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このファイルをターミナルで実行すると、ポート8000​​でWebサーバーが読み込まれます。</font></font><br>
<br>
<pre><code class="java hljs">$ ruby web-server.rb<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick <span class="hljs-number">1.3</span><span class="hljs-number">.1</span>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO ruby <span class="hljs-number">2.3</span><span class="hljs-number">.7</span> (<span class="hljs-number">2018</span>-<span class="hljs-number">03</span>-<span class="hljs-number">28</span>) [universal.x86_64-darwin17]<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick::HTTPServer#start: pid=<span class="hljs-number">19767</span> port=<span class="hljs-number">8000</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このサーバーの動作を確認するには、ブラウザーまたはcurlを使用できます。</font></font><br>
<br>
<pre><code class="java hljs">$ curl localhost:<span class="hljs-number">8000</span>/<font></font>
Hello, World<font></font>
<font></font>
$ curl localhost:<span class="hljs-number">8000</span>/invalid-path<font></font>
Not Found</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、201 CreatedとボディをJSON形式で返す/ apiエントリポイントをコードに追加して、このコードを変更したとします。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebServer</span> &lt; <span class="hljs-title">WEBrick</span>::<span class="hljs-title">HTTPServlet</span>::<span class="hljs-title">AbstractServlet</span>
  <span class="hljs-title">def</span> <span class="hljs-title">do_GET</span>(<span class="hljs-title">request</span>, <span class="hljs-title">response</span>)
     <span class="hljs-title">case</span> <span class="hljs-title">request</span>.<span class="hljs-title">path</span>
     <span class="hljs-title">when</span> "/"
         <span class="hljs-title">response</span>.<span class="hljs-title">status</span> </span>= <span class="hljs-number">200</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Hello, World'</span>
     when <span class="hljs-string">"/api"</span>
         response.status = <span class="hljs-number">201</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'application/json'</span>
         response.body = <span class="hljs-string">'{"foo":"bar"}'</span>
     <span class="hljs-keyword">else</span>
         response.status = <span class="hljs-number">404</span>
         response[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'text/plain'</span>
         response.body = <span class="hljs-string">'Not Found'</span><font></font>
     end<font></font>
  end<font></font>
end</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この更新されたコードを手動でテストするには、Ctrl + Cを押し、スクリプトを再度実行してWebサーバーを再起動します。</font></font><br>
<br>
<pre><code class="java hljs">$ ruby web-server.rb<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick <span class="hljs-number">1.3</span><span class="hljs-number">.1</span>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO ruby <span class="hljs-number">2.3</span><span class="hljs-number">.7</span> (<span class="hljs-number">2018</span>-<span class="hljs-number">03</span>-<span class="hljs-number">28</span>) [universal.x86_64-darwin17]<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick::HTTPServer#start: pid=<span class="hljs-number">19767</span> port=<span class="hljs-number">8000</span><font></font>
^C<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">15</span>:<span class="hljs-number">54</span>] INFO going to shutdown ...<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">15</span>:<span class="hljs-number">54</span>] INFO WEBrick::HTTPServer#start done.<font></font>
<font></font>
$ ruby web-server.rb<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick <span class="hljs-number">1.3</span><span class="hljs-number">.1</span>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO ruby <span class="hljs-number">2.3</span><span class="hljs-number">.7</span> (<span class="hljs-number">2018</span>-<span class="hljs-number">03</span>-<span class="hljs-number">28</span>) [universal.x86_64-darwin17]<font></font>
[<span class="hljs-number">2019</span>-<span class="hljs-number">05</span>-<span class="hljs-number">25</span> <span class="hljs-number">14</span>:<span class="hljs-number">11</span>:<span class="hljs-number">52</span>] INFO WEBrick::HTTPServer#start: pid=<span class="hljs-number">19767</span> port=<span class="hljs-number">8000</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいバージョンを確認するには、curlコマンドを再度使用します。</font></font><br>
<br>
<pre><code class="java hljs">$ curl localhost:<span class="hljs-number">8000</span>/api<font></font>
{<span class="hljs-string">"foo"</span>:<span class="hljs-string">"bar"</span>}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">手動テストの基本</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この種の手動テストはTerraformではどのように見えますか？</font><font style="vertical-align: inherit;">たとえば、前の章から、ALBを展開するためのコードがまだあります。</font><font style="vertical-align: inherit;">モジュール/ネットワーク/alb/main.tfファイルのスニペットを次に示します。</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_lb"</span> <span class="hljs-string">"example"</span> {<font></font>
   name                     = <span class="hljs-keyword">var</span>.alb_name<font></font>
   load_balancer_type = <span class="hljs-string">"application"</span>
   subnets                  = <span class="hljs-keyword">var</span>.subnet_ids<font></font>
   security_groups      = [aws_security_group.alb.id]<font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_lb_listener"</span> <span class="hljs-string">"http"</span> {<font></font>
   load_balancer_arn = aws_lb.example.arn<font></font>
   port                      = local.http_port<font></font>
   protocol                = <span class="hljs-string">"HTTP"</span><font></font>
<font></font>
   #      <span class="hljs-number">404</span><font></font>
   default_action {<font></font>
      type = <span class="hljs-string">"fixed-response"</span><font></font>
<font></font>
      fixed_response {<font></font>
        content_type = <span class="hljs-string">"text/plain"</span>
        message_body = <span class="hljs-string">"404: page not found"</span>
        status_code = <span class="hljs-number">404</span><font></font>
      }<font></font>
    }<font></font>
}<font></font>
<font></font>
resource <span class="hljs-string">"aws_security_group"</span> <span class="hljs-string">"alb"</span> {<font></font>
   name = <span class="hljs-keyword">var</span>.alb_name<font></font>
}<font></font>
<font></font>
# (...)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このリストをRubyコードと比較すると、AWS ALB、ターゲットグループ、リスナー、セキュリティグループ、およびその他のリソースを自分のコンピューターにデプロイできないという明らかな違いが1つあることがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストNo. 1に関する重要な結論は次のとおりです。Terraformコードのテストはローカルでは実行できません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、Terraformだけでなく、ほとんどのIaCツールにも当てはまります。 Terraformで手動テストを実行する唯一の実用的な方法は、コードを実際の環境（AWSなど）にデプロイすることです。言い換えると、本を読んでいる間に作業したterraform applyコマンドとterraform destroyコマンドを個別に起動することは、Terraformでの手動テストです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これが、各モジュールのサンプルフォルダーに展開しやすいサンプルを配置することが非常に重要である理由の1つです（第6章を参照）。</font><font style="vertical-align: inherit;">albモジュールをテストする最も簡単な方法は、examples / albで作成したデモコードを使用することです。</font></font><br>
<br>
<pre><code class="java hljs">provider <span class="hljs-string">"aws"</span> {<font></font>
   region = <span class="hljs-string">"us-east-2"</span><font></font>
<font></font>
   #     AWS  <span class="hljs-number">2</span>.x<font></font>
   version = <span class="hljs-string">"~&gt; 2.0"</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">module</span> <span class="hljs-string">"alb"</span> {<font></font>
    source = <span class="hljs-string">"../../modules/networking/alb"</span><font></font>
<font></font>
    alb_name = <span class="hljs-string">"terraform-up-and-running"</span>
    subnet_ids = data.aws_subnet_ids.<span class="hljs-keyword">default</span>.ids<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例をデプロイするには、繰り返し行ったように、terraform applyコマンドを実行する必要があります。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">$ terraform <span class="hljs-title">apply</span>

<span class="hljs-params">(...)</span>

Apply complete! Resources: 5 added, 0 changed, 0 destroyed.

Outputs:

alb_dns_name </span>= hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
デプロイの最後に、curlなどのツールを使用して、たとえば、ALBがデフォルトで404を返すようにすることができます。</font></font><br>
<br>
<pre><code class="java hljs">$ curl \<font></font>
   -s \<font></font>
   -o /dev/<span class="hljs-keyword">null</span> \<font></font>
   -w <span class="hljs-string">"%{http_code}"</span> \<font></font>
hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com<font></font>
<font></font>
<span class="hljs-number">404</span></code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インフラチェック</font></font><br>
<br>
      ,   HTTP, ,     ,   curl  HTTP-.        . ,        MySQL,       MySQL.      VPN-,      VPN.      ,      ,       SSH    - .    .   ,    ,      .       ,    .</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
お知らせします。ALBは構成に他のリスナールールがないため404を返し、albモジュールのデフォルトアクションには404の応答があります。</font></font><br>
<br>
<pre><code class="java hljs">resource <span class="hljs-string">"aws_lb_listener"</span> <span class="hljs-string">"http"</span> {<font></font>
   load_balancer_arn = aws_lb.example.arn<font></font>
   port                      = local.http_port<font></font>
   protocol                = <span class="hljs-string">"HTTP"</span><font></font>
<font></font>
   #      <span class="hljs-number">404</span><font></font>
   default_action {<font></font>
      type = <span class="hljs-string">"fixed-response"</span><font></font>
<font></font>
      fixed_response {<font></font>
       content_type = <span class="hljs-string">"text/plain"</span>
       message_body = <span class="hljs-string">"404: page not found"</span>
       status_code = <span class="hljs-number">404</span><font></font>
      }<font></font>
   }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、コードを実行してテストする方法はすでに知っています。</font><font style="vertical-align: inherit;">これで、変更を開始できます。</font><font style="vertical-align: inherit;">何かを変更するたびに（たとえば、デフォルトのアクションが401を返すようにするため）、terraform applyコマンドを使用して新しいコードをデプロイする必要があります。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">$ terraform <span class="hljs-title">apply</span>

<span class="hljs-params">(...)</span>

Apply complete! Resources: 0 added, 1 changed, 0 destroyed.

Outputs:

alb_dns_name </span>= hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいバージョンを確認するには、curlを再起動します。</font></font><br>
<br>
<pre><code class="java hljs">$ curl \<font></font>
   -s \<font></font>
   -o /dev/<span class="hljs-keyword">null</span> \<font></font>
   -w <span class="hljs-string">"%{http_code}"</span> \<font></font>
   hello-world-stage-<span class="hljs-number">477699288</span>.us-east-<span class="hljs-number">2</span>.elb.amazonaws.com
<span class="hljs-number">401</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
完了したら、terraform destroyコマンドを実行してリソースを削除します。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">$ terraform <span class="hljs-title">destroy</span>

<span class="hljs-params">(...)</span>

Apply complete! Resources: 0 added, 0 changed, 5 destroyed.</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、Terraformを使用する場合、すべての開発者は、テスト用の優れたコードサンプルと、ローカルコンピューターと同等の役割を果たし、テストの実行に使用される実際の開発環境（AWSアカウントなど）を必要とします。手動テストプロセスでは、多くの場合、多数のインフラストラクチャコンポーネントを作成および削除する必要があり、これにより多くのエラーが発生する可能性があります。この点で、環境は、最終テスト、特に産業用アプリケーションを対象とした、より安定した環境から完全に分離されている必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記を踏まえ、私は、各開発チームが、影響なしにインフラストラクチャを作成および削除できる分離された環境を準備することを強くお勧めします。</font><font style="vertical-align: inherit;">異なる開発者間の競合の可能性を最小限に抑えるには（2人の開発者が同じ名前のロードバランサーを作成しようとしていると想像してください）、理想的なソリューションは、各チームメンバーに個別の完全に分離された環境を提供することです。</font><font style="vertical-align: inherit;">たとえば、TerraformをAWSと組み合わせて使用​​する場合は、理想的には、各開発者が独自のアカウントを持ち、必要なすべてをテストできます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト後のリソースのクリーンアップ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの分離された環境の存在は、開発者の高い生産性のために必要ですが、注意しないと、すべての環境を混乱させ、総計のコストがかかる大量の追加リソースを蓄積する可能性があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コストを抑えるには、孤立したメディアを定期的にクリーニングします。これは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テスト番号2に関する重要な結論</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テスト後に、開発者がterraform destroyコマンドを使用して展開したすべてを削除する場合は、少なくともチームにカルチャーを作成する必要があります。定期的に（たとえば、cronを使用して）実行できる過剰または古いリソースをクリーンアップするためのツールを見つけることが可能な場合があります。以下は、さまざまなデプロイメント環境の例です。</font></font><br>
<br>
<ul>
<li>cloud-nuke (http://bit.ly/2OIgM9r).      ,         .        AWS ( Amazon EC2 Instances, ASG, ELB  . .).      (Google Cloud, Azure)   .    —    ,    . , cloud-nuke      cron,           .   ,   ,      ,      :<br>
<br>
<pre><code class="java hljs">$ cloud-nuke aws --older-than <span class="hljs-number">48</span>h</code></pre></li>
<li>Janitor Monkey (http://bit.ly/2M4GoLB).      ,   AWS  ,    (  —   ).    ,  ,    ,            .    Netflix Simian Army,      Chaos Monkey    .   ,    Simian Army    ,       : ,   Janitor Monkey   Swabbie (http://bit.ly/2OLrOLb).</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aws-nuke（http://bit.ly/2ZB8lOe）。</font><font style="vertical-align: inherit;">これは、AWSアカウントのすべてのコンテンツを削除するためのオープンソースツールです。</font><font style="vertical-align: inherit;">削除するアカウントとリソースは、構成ファイルでYAML形式で指定されています。</font></font><br>
<br>
<pre><code class="java hljs">#   <font></font>
regions:<font></font>
- us-east-<span class="hljs-number">2</span><font></font>
<font></font>
#    <font></font>
accounts:<font></font>
   <span class="hljs-string">"111111111111"</span>: {}<font></font>
<font></font>
#    <font></font>
resource-types:<font></font>
   targets:<font></font>
   - S3Object<font></font>
   - S3Bucket<font></font>
   - IAMRole</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aws-nukeは次のように開始します。</font></font><br>
<br>
<pre><code class="java hljs">$ aws-nuke -<span class="hljs-number">5</span>c config.yml</code></pre></li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自動テスト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動テストの概念は、実際のコードの動作をテストするためにテストを作成することです。</font><font style="vertical-align: inherit;">第8章では、CIサーバーを使用して、これらのテストを各コミット後に実行できることを学びます。</font><font style="vertical-align: inherit;">それらが完了していない場合、固定はすぐに元に戻すか修正できます。</font><font style="vertical-align: inherit;">したがって、コードは常に機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
自動テストには3つのタイプがあります。</font></font><br>
<br>
<ul>
<li> .       — .    ,             .   (,  , -    )   mock-.       (, mock-     ,  )    ,        .</li>
<li> .      .          ,          .      mock-: ,     ,     ,      ,   , ,  ,  mock-.</li>
<li> .      (, ,  ,  )       .          : , Selenium        .         - mock-,          (        ,  ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
各タイプのテストには独自の目的があり、それらの助けを借りてあらゆる種類のエラーを識別できるため、それらを一緒に使用する必要があります。単体テストは高速であり、行われた変更のアイデアを即座に取得し、さまざまな組み合わせを確認できます。これにより、コードの基本コンポーネント（個々のモジュール）が期待どおりに動作するという確信が得られます。ただし、モジュールが個別に正しく機能するという事実は、それらが一緒に機能できることをまったく意味しません。したがって、基本コンポーネントに互換性があることを確認するには、統合テストが必要です。一方、システムのさまざまな部分の正しい動作は、このシステムが産業環境での展開後に正常に機能することを保証するものではないため、実際の条件に近い状態でコードをテストするには、エンドツーエンドのテストが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
»書籍の詳細については、上で見つけることができます</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出版社のウェブサイト</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
» </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンテンツ</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
» </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">抜粋</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
についてはKhabrozhiteley 25％クーポン割引- </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テラフォーム</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ブックの紙のバージョンの支払いの際に、電子書籍を電子メールで送信されます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja503842/index.html">脳プロテーゼ：人工および生物学的ニューラルネットワークの同期</a></li>
<li><a href="../ja503844/index.html">数ステップでMatTableレンダリングを高速化</a></li>
<li><a href="../ja503846/index.html">フラッシュ、「彼が再び死ぬかどうかは不明ですが、花は消えます...」</a></li>
<li><a href="../ja503848/index.html">Sinterit 26.05でのSLS印刷と28.05に輝く3Dスキャナーに関する無料のウェビナーをご利用ください</a></li>
<li><a href="../ja503854/index.html">SILを最大限に活用する</a></li>
<li><a href="../ja503860/index.html">ニューラルネットワーク環境の設定R-CNNマスク</a></li>
<li><a href="../ja503862/index.html">画期的な製品を生み出す成功への対価としての心理的問題</a></li>
<li><a href="../ja503864/index.html">Flutterのフレーバー組織</a></li>
<li><a href="../ja503866/index.html">2020年のロードマップ開発Zextras Suiteを公開</a></li>
<li><a href="../ja503868/index.html">ドメインモデルの輝きと貧困</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>