<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üàÅ üö∞ üî∑ Python backend service development guide ‚ùé ‚úàÔ∏è üõµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, my name is Alexander Vasin, I‚Äôm a backend developer in Edadil. The idea of ‚Äã‚Äãthis material began with the fact that I wanted to parse the introduc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Python backend service development guide</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/499534/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hi, my name is Alexander Vasin, I‚Äôm a backend developer in Edadil. The idea of ‚Äã‚Äãthis material began with the fact that I wanted to parse the introductory assignment ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya.Disk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) into the Yandex </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">Backend Development</font></a><font style="vertical-align: inherit;"> School. I began to describe all the subtleties of the choice of certain technologies, the testing methodology ... It turned out to be no analysis at all, but a very detailed guide on how to write backends in Python. From the initial idea there were only requirements for the service, on the example of which it is convenient to disassemble tools and technologies. As a result, I woke up on a hundred thousand characters. Exactly so much was required to consider everything in great detail. So, the program for the next 100 kilobytes: how to build a service backend, from the choice of tools to the deployment. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pm/sz/r2/pmszr288srjaplio0w_utpnb4ym.png"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TL; DR:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a GitHub rep with application</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and who loves (real) longreads - please, under cat.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will develop and test the REST API service in Python, pack it in a lightweight Docker container and deploy it using Ansible.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can implement the REST API service in different ways using different tools. </font><font style="vertical-align: inherit;">The described solution is not the only right one, I chose the implementation and tools based on my personal experience and preferences.</font></font></blockquote><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What do we do?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What tools to choose?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Development</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why do you need to start with setup.py?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to specify dependency versions?</font></font></a></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Database</font></font></a><br>
 <ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We design the scheme</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Describe the schema in SQLAlchemy</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Customize Alembic</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We generate migrations</font></font></a></li>
</ul></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data serialization</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handlers</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / imports</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citizens / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens / birthdays</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handlers</font></font></a><ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / imports</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citizens / $ citizen_id</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens / birthdays</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrations</font></font></a></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembly</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stress Testing</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What else can be done?</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally</font></font></a></li>
</ul><br>
<a name="task"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What do we do?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Imagine that an online gift store plans to launch an action in different regions. </font><font style="vertical-align: inherit;">For a sales strategy to be effective, market analysis is needed. </font><font style="vertical-align: inherit;">The store has a supplier who regularly sends (for example, by mail) data unloading with information about residents. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's develop a Python REST API service that will analyze the data provided and identify the demand for gifts from residents of different age groups in different cities by month. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We implement the following handlers in the service:</font></font><br>
<br>
<ul>
<li> <code>POST /imports</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adds a new upload with data;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Returns the residents of the specified discharge;</font></font><br>
 </li>
<li> <code>PATCH /imports/$import_id/citizens/$citizen_id</code><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Changes information about the resident (and his relatives) in the specified unloading;</font></font><br>
 </li>
<li> <code>GET /imports/$import_id/citizens/birthdays</code><br>
  ,        ( ),   ;<br>
 </li>
<li> <code>GET /imports/$import_id/towns/stat/percentile/age</code><br>
 50-, 75-  99-   ( )      .<br>
 </li>
</ul><br>
<a name="tools"></a><h1>  ?</h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, we are writing a service in Python using familiar frameworks, libraries and DBMS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 lectures of the</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> video course, various DBMSs and their features are described. For my implementation, I chose the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PostgreSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DBMS </font><font style="vertical-align: inherit;">, which has established itself as a reliable solution with excellent </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation in Russian</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a strong Russian community (you can always find the answer to a question in Russian), and even </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">free courses</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The relational model is quite versatile and well understood by many developers. Although the same thing could be done on any NoSQL DBMS, in this article we will consider PostgreSQL.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main objective of the service - data transmission over the network between the database and clients - does not imply a large load on the processor, but requires the ability to process multiple requests at one time. In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10 lectures</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> considered asynchronous approach. It allows you to efficiently serve multiple clients within the same OS process (unlike, for example, the pre-fork model used in Flask / Django, which creates several processes for processing requests from users, each of them consumes memory, but is idle most of the time ) Therefore, as a library for writing the service, I chose asynchronous </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aiohttp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">
The </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">5th lecture of the</font></a><font style="vertical-align: inherit;"> video course tells that </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">SQLAlchemy</font></a></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/webt/or/rj/pn/orrjpnx6upvsipcqbsql7f36vzc.png"></a><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to decompose complex queries into parts, reuse them, generate queries with a dynamic set of fields (for example, the PATCH processor allows partial updating of a resident with arbitrary fields) and focus directly on business logic. The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpg</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> driver </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">can</font></a><font style="vertical-align: inherit;"> handle these requests and transfer the data the fastest </font><font style="vertical-align: inherit;">, and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asyncpgsa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> will help them make friends </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My favorite tool for managing the state of the database and working with migrations is </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . By the way, I recently talked about it in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moscow Python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The logic of validation was succinctly described by </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Marshmallow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> schemes </font><font style="vertical-align: inherit;">(including checks for family ties). Using the </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://github.com/maximdanilchenko/aio"><font style="vertical-align: inherit;">aiohttp-spec</font></a><font style="vertical-align: inherit;"> module</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://github.com/maximdanilchenko/aio"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I linked aiohttp-handlers and schemes for data validation, and the bonus was to generate documentation in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swagger</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> format </font><font style="vertical-align: inherit;">and display it in a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">graphical interface</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For writing tests, I chose </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, more about it in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 lectures</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To debug and profile this project, I used the PyCharm debugger ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lecture 9</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 lecture</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> describes how to any computer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (or even on different OS) can run packaged without having to adjust the application environment for starting and easy to install / update / delete the application on the server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the deployment, I chose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ansible</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It allows you to declaratively describe the desired state of the server and its services, works via ssh and does not require special software.</font></font><br>
<br>
<a name="development"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Development</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decided to give the Python package a name </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and use the following structure: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ox/ly/wt/oxlywtje20xt5ceou8pbtfp8an8.png" width="550"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the file </font></font><code>analyzer/__init__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I posted general information about the package: description ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docstring</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), version, license, developer contacts.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It can be viewed with the help built-in</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python<font></font>
&gt;&gt;&gt; import analyzer<font></font>
&gt;&gt;&gt; <span class="hljs-built_in">help</span>(analyzer)<font></font>
<font></font>
Help on package analyzer:<font></font>
<font></font>
NAME<font></font>
    analyzer<font></font>
<font></font>
DESCRIPTION<font></font>
      REST API,    .<font></font>
<font></font>
PACKAGE CONTENTS<font></font>
    api (package)<font></font>
    db (package)<font></font>
    utils (package)<font></font>
<font></font>
DATA<font></font>
    __all__ = (<span class="hljs-string">'__author__'</span>, <span class="hljs-string">'__email__'</span>, <span class="hljs-string">'__license__'</span>, <span class="hljs-string">'__maintainer__'</span>,...<font></font>
    __email__ = <span class="hljs-string">'alvassin@yandex.ru'</span>
    __license__ = <span class="hljs-string">'MIT'</span>
    __maintainer__ = <span class="hljs-string">'Alexander Vasin'</span><font></font>
<font></font>
VERSION<font></font>
    0.0.1<font></font>
<font></font>
AUTHOR<font></font>
    Alexander Vasin<font></font>
<font></font>
FILE<font></font>
    /Users/alvassin/Work/backendschool2019/analyzer/__init__.py</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The package has two input points - the REST API service ( </font></font><code>analyzer/api/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and the database state management utility ( </font></font><code>analyzer/db/__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Files are called </font></font><code>__main__.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for a reason - firstly, such a name attracts attention, it makes it clear that the file is an entry point. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secondly, thanks to this approach to entry points </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>     python -m</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># REST API</span>
$ python -m analyzer.api --<span class="hljs-built_in">help</span><font></font>
<font></font>
<span class="hljs-comment">#    </span>
$ python -m analyzer.db --<span class="hljs-built_in">help</span></code></pre><br>
<a name="setuppy"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why do you need to start with setup.py?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Looking ahead, we‚Äôll think about how to distribute the application: it can be packaged in a zip (as well as wheel / egg-) archive, an rpm package, a pkg file for macOS and installed on a remote computer, a virtual machine, MacBook or Docker- container. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main purpose of the file </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>setup.py</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is to describe the package with the application for </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">
The file must contain general information about the package (name, version, author, etc.), but also in it you can specify the modules required for work, ‚Äúextra‚Äù dependencies (for example, for testing), entry points (for example, executable commands ) and requirements for the interpreter. </font><font style="vertical-align: inherit;">
Setuptools plugins allow you to collect artifact from the described package. There are built-in plugins: zip, egg, rpm, macOS pkg. The remaining plugins are distributed via PyPI: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">wheel</font></a><font style="vertical-align: inherit;"> ,</font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">distutils</a>/<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">setuptools</a></code><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the bottom line, describing one file, we get great opportunities. </font><font style="vertical-align: inherit;">That is why the development of a new project must begin with </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the function, </font></font><code>setup()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dependent modules are indicated by a list:</font></font><br>
<br>
<pre><code class="python hljs">setup(..., install_requires=[<span class="hljs-string">"aiohttp"</span>, <span class="hljs-string">"SQLAlchemy"</span>])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But I described the dependencies in separate files </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whose contents are used in </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It seems more flexible to me, plus there is a secret: later it will allow you to build a Docker image faster. </font><font style="vertical-align: inherit;">Dependencies will be set as a separate step before installing the application itself, and when rebuilding the Docker container, it will be cached. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To be </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">able to read the dependencies from the files </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the function is written:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is worth noting that </font></font><code>setuptools</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">when the default assembly source distribution includes only the assembly files </font></font><code>.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>.cpp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>.h</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">To a dependency file </font></font><code>requirements.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>requirements.dev.txt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hit the bag, they should be clearly specified in the file </font></font><code>MANIFEST.in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setup.py entirely</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> importlib.machinery <span class="hljs-keyword">import</span> SourceFileLoader<font></font>
<font></font>
<span class="hljs-keyword">from</span> pkg_resources <span class="hljs-keyword">import</span> parse_requirements
<span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> find_packages, setup<font></font>
<font></font>
module_name = <span class="hljs-string">'analyzer'</span><font></font>
<font></font>
<span class="hljs-comment"># ,     (   ), </span>
<span class="hljs-comment">#   __init__.py   machinery.</span><font></font>
module = SourceFileLoader(<font></font>
    module_name, os.path.join(module_name, <span class="hljs-string">'__init__.py'</span>)<font></font>
).load_module()<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_requirements</span>(<span class="hljs-params">fname: str</span>) -&gt; list:</span><font></font>
    requirements = []<font></font>
    <span class="hljs-keyword">with</span> open(fname, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> fp:
        <span class="hljs-keyword">for</span> req <span class="hljs-keyword">in</span> parse_requirements(fp.read()):<font></font>
            extras = <span class="hljs-string">'[{}]'</span>.format(<span class="hljs-string">','</span>.join(req.extras)) <span class="hljs-keyword">if</span> req.extras <span class="hljs-keyword">else</span> <span class="hljs-string">''</span><font></font>
            requirements.append(<font></font>
                <span class="hljs-string">'{}{}{}'</span>.format(req.name, extras, req.specifier)<font></font>
            )<font></font>
    <span class="hljs-keyword">return</span> requirements<font></font>
<font></font>
setup(<font></font>
    name=module_name,<font></font>
    version=module.__version__,<font></font>
    author=module.__author__,<font></font>
    author_email=module.__email__,<font></font>
    license=module.__license__,<font></font>
    description=module.__doc__,<font></font>
    long_description=open(<span class="hljs-string">'README.rst'</span>).read(),<font></font>
    url=<span class="hljs-string">'https://github.com/alvassin/backendschool2019'</span>,<font></font>
    platforms=<span class="hljs-string">'all'</span>,<font></font>
    classifiers=[<font></font>
        <span class="hljs-string">'Intended Audience :: Developers'</span>,
        <span class="hljs-string">'Natural Language :: Russian'</span>,
        <span class="hljs-string">'Operating System :: MacOS'</span>,
        <span class="hljs-string">'Operating System :: POSIX'</span>,
        <span class="hljs-string">'Programming Language :: Python'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3'</span>,
        <span class="hljs-string">'Programming Language :: Python :: 3.8'</span>,
        <span class="hljs-string">'Programming Language :: Python :: Implementation :: CPython'</span><font></font>
    ],<font></font>
    python_requires=<span class="hljs-string">'&gt;=3.8'</span>,<font></font>
    packages=find_packages(exclude=[<span class="hljs-string">'tests'</span>]),<font></font>
    install_requires=load_requirements(<span class="hljs-string">'requirements.txt'</span>),<font></font>
    extras_require={<span class="hljs-string">'dev'</span>: load_requirements(<span class="hljs-string">'requirements.dev.txt'</span>)},<font></font>
    entry_points={<font></font>
        <span class="hljs-string">'console_scripts'</span>: [
            <span class="hljs-comment"># f-strings  setup.py   - </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-comment">#   ,     Python 3.8, </span>
            <span class="hljs-comment"># source distribution       </span>
            <span class="hljs-comment">#   Python.     </span>
            <span class="hljs-comment"># .</span>
            <span class="hljs-string">'{0}-api = {0}.api.__main__:main'</span>.format(module_name),
            <span class="hljs-string">'{0}-db = {0}.db.__main__:main'</span>.format(module_name)<font></font>
        ]<font></font>
    },<font></font>
    include_package_data=<span class="hljs-literal">True</span>
)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can install the project in development mode using the following command (in editable mode, Python will not install the entire package in a folder </font></font><code>site-packages</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but only create links, so any changes made to the package files will be visible immediately):</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment">#      extra- "dev"</span>
pip install -e <span class="hljs-string">'.[dev]'</span><font></font>
<font></font>
<span class="hljs-comment">#      </span>
pip install -e .</code></pre><br>
<a name="requirements"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to specify dependency versions?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs great when developers are actively working on their packages - bugs are being actively fixed in them, new functionality appears and feedback can be obtained faster. But sometimes changes in dependent libraries are not backward compatible and can lead to errors in your application if you do not think about it beforehand. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For each dependent package, you can specify a specific version, for example </font></font><code>aiohttp==3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Then the application will be guaranteed to be built specifically with those versions of the dependent libraries with which it was tested. But this approach has a drawback - if developers fix a critical bug in a dependent package that does not affect backward compatibility, this fix will not get into the application. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is an approach to versioning </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semantic Versioning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which suggests submitting the version in the format </font></font><code>MAJOR.MINOR.PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - increases when backward incompatible changes are added;</font></font></li>
<li><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Increases when adding new functionality with support for backward compatibility;</font></font></li>
<li><code>PATCH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - increases when adding bug fixes with backward compatibility support.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If a dependent package follows this approach (of which the authors are usually reported in the README and CHANGELOG files), it is sufficient to fix the value of </font></font><code>MAJOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>MINOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and to limit the minimum value for PATCH-version: </font></font><code>&gt;= MAJOR.MINOR.PATCH, == MAJOR.MINOR.*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such a requirement can be implemented using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ =</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><font style="vertical-align: inherit;">. For example, it </font></font><code>aiohttp~=3.6.2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will allow PIP to install for </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">version 3.6.3, but not 3.7. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you specify the interval of dependency versions, this will give one more advantage - there will be no version conflicts between dependent libraries.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you are developing a library that requires a different dependency package, then allow for it not one specific version, but an interval. </font><font style="vertical-align: inherit;">Then it will be much easier for the users of your library to use it (all of a sudden their application requires the same dependency package, but of a different version). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semantic Versioning is just an agreement between authors and consumers of packages. </font><font style="vertical-align: inherit;">It does not guarantee that authors write code without bugs and cannot make a mistake in the new version of their package.</font></font><br>
<br>
<a name="db"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Database</font></font></h2><br>
<a name="dbstructure"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We design the scheme</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The description of the POST / imports handler provides an example of unloading with information about residents:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Upload Example</font></font></b>
                        <div class="spoiler_text"><pre><code class="json hljs">{
  <span class="hljs-attr">"citizens"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"26.12.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">2</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"1675"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">7</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"01.04.1997"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"male"</span>,
      <span class="hljs-attr">"relatives"</span>: [<span class="hljs-number">1</span>]<font></font>
    },<font></font>
    {<font></font>
      <span class="hljs-attr">"citizen_id"</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">"town"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"street"</span>: <span class="hljs-string">" "</span>,
      <span class="hljs-attr">"building"</span>: <span class="hljs-string">"2"</span>,
      <span class="hljs-attr">"apartment"</span>: <span class="hljs-number">11</span>,
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"  "</span>,
      <span class="hljs-attr">"birth_date"</span>: <span class="hljs-string">"23.11.1986"</span>,
      <span class="hljs-attr">"gender"</span>: <span class="hljs-string">"female"</span>,
      <span class="hljs-attr">"relatives"</span>: []<font></font>
    },<font></font>
    ...<font></font>
  ]<font></font>
}</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thought was to store all the information about the resident in one table </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, where the relationship would be represented by a field </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">form of a list of integers</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But this method has several disadvantages</font></font></b>
                        <div class="spoiler_text"><ol>
<li>   <code>GET /imports/$import_id/citizens/birthdays</code>   ,      ,     <code>citizens</code>   .          <code>relatives</code>    <code>UNNEST</code>.<br>
<br>
     ,  <b>    10- </b>:<br>
<pre><code class="sql hljs"><span class="hljs-keyword">SELECT</span> <font></font>
    relations.citizen_id, <font></font>
    relations.relative_id, <font></font>
    date_part(<span class="hljs-string">'month'</span>, relatives.birth_date) <span class="hljs-keyword">as</span> relative_birth_month
<span class="hljs-keyword">FROM</span> (
	<span class="hljs-keyword">SELECT</span><font></font>
        citizens.import_id, <font></font>
        citizens.citizen_id,<font></font>
        <span class="hljs-keyword">UNNEST</span>(citizens.relatives) <span class="hljs-keyword">as</span> relative_id
	<span class="hljs-keyword">FROM</span> citizens
    <span class="hljs-keyword">WHERE</span> import_id = <span class="hljs-number">1</span>
) <span class="hljs-keyword">as</span> relations
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> citizens <span class="hljs-keyword">as</span> relatives <span class="hljs-keyword">ON</span>
    relations.import_id = relatives.import_id <span class="hljs-keyword">AND</span><font></font>
    relations.relative_id = relatives.citizen_id<font></font>
</code></pre><br>
 </li>
<li>    <b>    <code>relatives</code>   PostgreSQL</b>,   :    <code>relatives</code>     ,      .       (     )         .</li>
</ol></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, I decided to bring all the data required for work to a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">third normal form</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and the following structure was obtained:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/di/pf/px/dipfpxxw142kafiect0yhrtt4uo.png"><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">imports</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table </font><font style="vertical-align: inherit;">consists of an automatically incrementing column </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is needed to create a foreign key check in the table </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citizens</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> table </font><font style="vertical-align: inherit;">stores </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">scalar data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about the resident (all fields except information about family relationships). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pair ( </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">is used as the primary key </font><font style="vertical-align: inherit;">, guaranteeing the uniqueness of residents </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">within the framework </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A foreign key </font></font><code>citizens.import_id -&gt; imports.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ensures that the field </font></font><code>citizens.import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contains only existing unloads.</font></font><br>
 </li>
<li>  <b>relations</b>    <b> </b>. <br>
<br>
<b>     </b> (     ):           <code>citizens</code>  <code>relations</code>     .<br>
     (<code>import_id</code>, <code>citizen_id</code>, <code>relative_id</code>)  ,      <code>import_id</code>   <code>citizen_id</code>   c  <code>relative_id</code>. <br>
<br>
       : <code>(relations.import_id, relations.citizen_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>  <code>(relations.import_id, relations.relative_id) -&gt; (citizens.import_id, citizens.citizen_id)</code>, ,        <code>citizen_id</code>   <code>relative_id</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This structure ensures the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">integrity of the data using PostgreSQL tools</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , it allows you to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">efficiently get residents with relatives</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the database, but is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subject to a race condition</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> when updating information about residents with competitive queries (we will take a closer look at the PATCH handler implementation).</font></font><br>
<br>
<a name="do_sqlalchemy"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Describe the schema in SQLAlchemy</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapter 5,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I talked about how to create queries using SQLAlchemy, you need to describe the database schema using special objects: tables are described using </font></font><code>sqlalchemy.Table</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and are bound to a registry </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that stores all the meta-information about the database. By the way, the registry </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is capable of not only storing the meta-information described in Python, but also representing the real state of the database in the form of SQLAlchemy objects. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This feature also allows Alembic to compare conditions and generate a migration code automatically.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By the way, each database has its own default constraints naming scheme. </font><font style="vertical-align: inherit;">So that you don‚Äôt waste time naming new constraints or searching / recalling what constraint you are about to remove, SQLAlchemy suggests using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">naming conventions naming</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> patterns </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">They can be defined in the registry </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a MetaData registry and pass naming patterns to it</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> MetaData<font></font>
<font></font>
convention = {<font></font>
    <span class="hljs-string">'all_column_names'</span>: <span class="hljs-keyword">lambda</span> constraint, table: <span class="hljs-string">'_'</span>.join([<font></font>
        column.name <span class="hljs-keyword">for</span> column <span class="hljs-keyword">in</span> constraint.columns.values()<font></font>
    ]),<font></font>
<font></font>
    <span class="hljs-comment">#  </span>
    <span class="hljs-string">'ix'</span>: <span class="hljs-string">'ix__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'uq'</span>: <span class="hljs-string">'uq__%(table_name)s__%(all_column_names)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#  CHECK-constraint-</span>
    <span class="hljs-string">'ck'</span>: <span class="hljs-string">'ck__%(table_name)s__%(constraint_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'fk'</span>: <span class="hljs-string">'fk__%(table_name)s__%(all_column_names)s__%(referred_table_name)s'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#   </span>
    <span class="hljs-string">'pk'</span>: <span class="hljs-string">'pk__%(table_name)s'</span><font></font>
}<font></font>
metadata = MetaData(naming_convention=convention)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you specify naming patterns, Alembic will use them during the automatic generation of migrations and will name all constraints according to them. </font><font style="vertical-align: inherit;">In the future, the created registry </font></font><code>MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be required to describe the tables:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We describe the database schema with SQLAlchemy objects</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/schema.py</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum, unique<font></font>
<font></font>
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> (<font></font>
    Column, Date, Enum <span class="hljs-keyword">as</span> PgEnum, ForeignKey, ForeignKeyConstraint, Integer,<font></font>
    String, Table<font></font>
)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@unique</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gender</span>(<span class="hljs-params">Enum</span>):</span>
    female = <span class="hljs-string">'female'</span>
    male = <span class="hljs-string">'male'</span><font></font>
<font></font>
<font></font>
imports_table = Table(<font></font>
    <span class="hljs-string">'imports'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>)<font></font>
)<font></font>
<font></font>
citizens_table = Table(<font></font>
    <span class="hljs-string">'citizens'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, ForeignKey(<span class="hljs-string">'imports.import_id'</span>),<font></font>
           primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'town'</span>, String, nullable=<span class="hljs-literal">False</span>, index=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'street'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'building'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'apartment'</span>, Integer, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'name'</span>, String, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'birth_date'</span>, Date, nullable=<span class="hljs-literal">False</span>),<font></font>
    Column(<span class="hljs-string">'gender'</span>, PgEnum(Gender, name=<span class="hljs-string">'gender'</span>), nullable=<span class="hljs-literal">False</span>),<font></font>
)<font></font>
<font></font>
relations_table = Table(<font></font>
    <span class="hljs-string">'relations'</span>,<font></font>
    metadata,<font></font>
    Column(<span class="hljs-string">'import_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'citizen_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    Column(<span class="hljs-string">'relative_id'</span>, Integer, primary_key=<span class="hljs-literal">True</span>),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'citizen_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
    ForeignKeyConstraint(<font></font>
        (<span class="hljs-string">'import_id'</span>, <span class="hljs-string">'relative_id'</span>),<font></font>
        (<span class="hljs-string">'citizens.import_id'</span>, <span class="hljs-string">'citizens.citizen_id'</span>)<font></font>
    ),<font></font>
)<font></font>
</code></pre></div>
                    </div><br>
<a name="db_alembic"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Customize Alembic</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the database schema is described, it is necessary to generate migrations, but for this you first need to configure Alembic, which is also discussed in </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapter 5</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To use the command </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you must perform the following steps:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install Package: </font></font><code>pip install alembic</code></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialize Alembic: </font></font><code>cd analyzer &amp;&amp; alembic init db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This command will create a configuration file </font></font><code>analyzer/alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and a folder </font></font><code>analyzer/db/alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the following contents:</font></font><br>
 <ul>
<li> <code>env.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Called every time you start Alembic. </font><font style="vertical-align: inherit;">Connects to Alembic registry </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a description of the desired state of the database and contains instructions for starting migrations.</font></font><br>
 </li>
<li><code>script.py.mako</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the template on the basis of which migrations are generated.</font></font></li>
<li><code>versions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the folder in which Alembic will search (and generate) migrations.</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Specify the database address in the alembic.ini file:</font></font><br>
<br>
<pre><code class="plaintext hljs">; analyzer/alembic.ini<font></font>
[alembic] <font></font>
sqlalchemy.url = postgresql://user:hackme@localhost/analyzer</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Specify a description of the desired state of the database (registry </font></font><code>sqlalchemy.MetaData</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) so that Alembic can generate migrations automatically:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># analyzer/db/alembic/env.py</span>
<span class="hljs-keyword">from</span> analyzer.db <span class="hljs-keyword">import</span> schema<font></font>
target_metadata = schema.metadata</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic is configured and can already be used, but in our case this configuration has several disadvantages:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The utility </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">searches </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the current working directory. </font><font style="vertical-align: inherit;">You </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can specify the </font><font style="vertical-align: inherit;">path to the </font><font style="vertical-align: inherit;">command line argument, but this is inconvenient: I want to be able to call the command from any folder without additional parameters.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To configure Alembic to work with a specific database, you need to change the file </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It would be much more convenient to specify the database settings for the environment variable and / or a command line argument, for example </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The name of the utility </font></font><code>alembic</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does not correlate very well with the name of our service (and the user may actually not have Python at all and know nothing about Alembic). </font><font style="vertical-align: inherit;">It would be much more convenient for the end user if all executable commands of the service had a common prefix, for example </font></font><code>analyzer-*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These problems are solved with a small wrapper. </font></font><code>analyzer/db/__main__.py:</code><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alembic uses a standard module to process command line arguments </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">argparse</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It allows you to add an optional argument </font></font><code>--pg-url</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a default value from an environment variable </font></font><code>ANALYZER_PG_URL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    alembic.parser.add_argument(<font></font>
        <span class="hljs-string">'--pg-url'</span>, default=os.getenv(<span class="hljs-string">'ANALYZER_PG_URL'</span>, DEFAULT_PG_URL),<font></font>
        help=<span class="hljs-string">'Database URL [env var: ANALYZER_PG_URL]'</span><font></font>
    )<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#   sqlalchemy.url   Alembic</span>
    config.set_main_option(<span class="hljs-string">'sqlalchemy.url'</span>, options.pg_url)<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The path to the file </font></font><code>alembic.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be calculated relative to the location of the executable file, and not the current working directory of the user.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> alembic.config <span class="hljs-keyword">import</span> CommandLine, Config
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<font></font>
<font></font>
<font></font>
PROJECT_PATH = Path(__file__).parent.parent.resolve()<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><font></font>
    alembic = CommandLine()<font></font>
    options = alembic.parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#     (alembic.ini),   </span>
    <span class="hljs-comment">#    </span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(options.config):<font></font>
        options.config = os.path.join(PROJECT_PATH, options.config)<font></font>
<font></font>
    <span class="hljs-comment">#    Alembic</span><font></font>
    config = Config(file_=options.config, ini_section=options.name,<font></font>
                    cmd_opts=options)<font></font>
<font></font>
    <span class="hljs-comment">#      alembic   (,  alembic</span>
    <span class="hljs-comment">#   env.py,       )</span>
    alembic_location = config.get_main_option(<span class="hljs-string">'script_location'</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isabs(alembic_location):<font></font>
        config.set_main_option(<span class="hljs-string">'script_location'</span>,<font></font>
                               os.path.join(PROJECT_PATH, alembic_location))<font></font>
<font></font>
    <span class="hljs-comment">#   alembic</span><font></font>
    exit(alembic.run_cmd(config, options))<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utility for managing the state of the database</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is ready, it can be registered </font></font><code>setup.py</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as an executable command with a name understandable to the end user, for example </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Register an executable command in setup.py</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> setuptools <span class="hljs-keyword">import</span> setup<font></font>
<font></font>
setup(..., entry_points={<font></font>
    <span class="hljs-string">'console_scripts'</span>: [
        <span class="hljs-string">'analyzer-db = analyzer.db.__main__:main'</span><font></font>
    ]<font></font>
})<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After reinstalling the module, a file will be generated </font></font><code>env/bin/analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the command </font></font><code>analyzer-db</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will become available:</font></font><br>
<br>
<pre><code class="bash hljs">$ pip install -e <span class="hljs-string">'.[dev]'</span></code></pre><br>
<a name="db_alembic_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We generate migrations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To generate migrations, two states are required: desired (which we described with SQLAlchemy objects) and real (the database, in our case, is empty). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decided that the easiest way to raise Postgres with Docker was to add a command </font></font><code>make postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that runs a container with PostgreSQL on port 5432 in the background:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raise PostgreSQL and generate migration</font></font></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ make postgres<font></font>
...<font></font>
$ analyzer-db revision --message=<span class="hljs-string">"Initial"</span> --autogenerate<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'imports'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'citizens'</span>
INFO  [alembic.autogenerate.compare] Detected added index <span class="hljs-string">'ix__citizens__town'</span> on <span class="hljs-string">'['</span>town<span class="hljs-string">']'</span>
INFO  [alembic.autogenerate.compare] Detected added table <span class="hljs-string">'relations'</span>
  Generating /Users/alvassin/Work/backendschool2019/analyzer/db/alembic/versions/d5f704ed4610_initial.py ...  <span class="hljs-keyword">done</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alembic generally does a good job of the routine work of generating migrations, but I would like to draw attention to the following:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The user data types specified in the created tables are created automatically (in our case - </font></font><code>gender</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), but the code to delete them is </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not generated. </font><font style="vertical-align: inherit;">If you apply, roll back, and then apply the migration again, this will cause an error because the specified data type already exists.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delete the gender data type in the downgrade method</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic <span class="hljs-keyword">import</span> op
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> Column, Enum<font></font>
<font></font>
GenderType = Enum(<span class="hljs-string">'female'</span>, <span class="hljs-string">'male'</span>, name=<span class="hljs-string">'gender'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">upgrade</span>():</span><font></font>
    ...<font></font>
    <span class="hljs-comment">#      GenderType   </span>
    op.create_table(<span class="hljs-string">'citizens'</span>, ...,<font></font>
                    Column(<span class="hljs-string">'gender'</span>, GenderType, nullable=<span class="hljs-literal">False</span>))<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
    op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
<font></font>
    <span class="hljs-comment">#       </span>
    GenderType.drop(op.get_bind())</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the method, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">some actions can sometimes be removed (if we delete the whole table, you can not delete its indexes separately):</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for instance</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">downgrade</span>():</span>
op.drop_table(<span class="hljs-string">'relations'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      citizens,    </span>
<span class="hljs-comment">#    </span>
op.drop_index(op.f(<span class="hljs-string">'ix__citizens__town'</span>), table_name=<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'citizens'</span>)<font></font>
op.drop_table(<span class="hljs-string">'imports'</span>)</code></pre></div>
                    </div></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the migration is fixed and ready, we apply it:</font></font><br>
<br>
<pre><code class="bash hljs">$ analyzer-db upgrade head<font></font>
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.<font></font>
INFO  [alembic.runtime.migration] Will assume transactional DDL.<font></font>
INFO  [alembic.runtime.migration] Running upgrade  -&gt; d5f704ed4610, Initial</code></pre><br>
<a name="application"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Before you begin creating handlers, you must configure the aiohttp application.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you look at aiohttp quickstart, you can write something like this</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    logging.basicConfig(level=logging.DEBUG)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = web.Application()<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app.router.add_route(...)<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    web.run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This code raises a number of questions and has a number of disadvantages:</font></font><br>
<br>
<ul>
<li> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to configure the application? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At a minimum, you must specify the host and port for connecting clients, as well as information for connecting to the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I really like to solve this problem with the help of the module </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>ConfigArgParse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: it extends the standard one </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>argparse</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and allows using command line arguments, environment variables (indispensable for configuring Docker containers) and even configuration files (as well as combining these methods) for configuration. </font><font style="vertical-align: inherit;">Using </font></font><code>ConfigArgParse</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it, you can also validate the values ‚Äã‚Äãof application configuration parameters.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example of processing parameters using ConfigArgParse</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> web
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser, ArgumentDefaultsHelpFormatter<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.argparse <span class="hljs-keyword">import</span> positive_int<font></font>
<font></font>
parser = ArgumentParser(<font></font>
    <span class="hljs-comment">#        ANALYZER_,</span>
    <span class="hljs-comment">#  ANALYZER_API_ADDRESS  ANALYZER_API_PORT</span>
    auto_env_var_prefix=<span class="hljs-string">'ANALYZER_'</span>,<font></font>
<font></font>
    <span class="hljs-comment">#     </span><font></font>
    formatter_class=ArgumentDefaultsHelpFormatter<font></font>
)<font></font>
<font></font>
parser.add_argument(<span class="hljs-string">'--api-address'</span>, default=<span class="hljs-string">'0.0.0.0'</span>,<font></font>
                    help=<span class="hljs-string">'IPv4/IPv6 address API server would listen on'</span>)<font></font>
<font></font>
<span class="hljs-comment">#      </span>
parser.add_argument(<span class="hljs-string">'--api-port'</span>, type=positive_int, default=<span class="hljs-number">8081</span>,<font></font>
                    help=<span class="hljs-string">'TCP port API server would listen on'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#   ,     </span>
    <span class="hljs-comment">#  ,    </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#       </span><font></font>
    app = web.Application()<font></font>
    web.run_app(app, host=args.api_address, port=args.api_port)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div><br>
, <code>ConfigArgParse</code>,   <code>argparse</code>,           (     <code>-h</code>  <code>--help</code>).       :<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="bash hljs">$ python __main__.py --<span class="hljs-built_in">help</span><font></font>
usage: __main__.py [-h] [--api-address API_ADDRESS] [--api-port API_PORT]<font></font>
<font></font>
If an arg is specified <span class="hljs-keyword">in</span> more than one place, <span class="hljs-keyword">then</span> commandline values override environment variables <span class="hljs-built_in">which</span> override defaults.<font></font>
<font></font>
optional arguments:<font></font>
  -h, --<span class="hljs-built_in">help</span>            show this <span class="hljs-built_in">help</span> message and <span class="hljs-built_in">exit</span><font></font>
  --api-address API_ADDRESS<font></font>
                        IPv4/IPv6 address API server would listen on [env var: ANALYZER_API_ADDRESS] (default: 0.0.0.0)<font></font>
  --api-port API_PORT   TCP port API server would listen on [env var: ANALYZER_API_PORT] (default: 8081)</code></pre></div>
                    </div></li>
<li>             ‚Äî ,    ¬´¬ª     .          ,  <strong>     </strong>. <br>
<br>
    <code>os.environ.clear()</code>,  Python            (,      <code>asyncio</code>?),        ,   <code>ConfigArgParser</code>.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Callable
<span class="hljs-keyword">from</span> configargparse <span class="hljs-keyword">import</span> ArgumentParser
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
ENV_VAR_PREFIX = <span class="hljs-string">'ANALYZER_'</span><font></font>
<font></font>
parser = ArgumentParser(auto_env_var_prefix=ENV_VAR_PREFIX)<font></font>
parser.add_argument(<span class="hljs-string">'--pg-url'</span>, type=URL, default=URL(DEFAULT_PG_URL),<font></font>
                   help=<span class="hljs-string">'URL to use to connect to the database'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clear_environ</span>(<span class="hljs-params">rule: Callable</span>):</span>
    <span class="hljs-string">"""
      ,     
     rule
    """</span>
    <span class="hljs-comment">#   os.environ    tuple,    </span>
    <span class="hljs-comment"># os.environ   </span>
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> filter(rule, tuple(os.environ)):<font></font>
        os.environ.pop(name)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span><font></font>
    args = parser.parse_args()<font></font>
<font></font>
    <span class="hljs-comment">#      ANALYZER_</span>
    clear_environ(<span class="hljs-keyword">lambda</span> i: i.startswith(ENV_VAR_PREFIX))<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    app = create_app(args)<font></font>
    ...<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li> <strong>   stderr/      .</strong><br>
<br>
 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> 9</a> ,    <code>logging.basicConfig()</code>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>   stderr</code></a>.<br>
<br>
       ,       .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>   aiomisc.<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    aiomisc</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> logging<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiomisc.log <span class="hljs-keyword">import</span> basic_config<font></font>
<font></font>
basic_config(logging.DEBUG, buffered=<span class="hljs-literal">True</span>)    
</code></pre></div>
                    </div></li>
<li> <strong>  ,     </strong>    ?    ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>fork</code></a>     ,           (,  Windows   ).<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv<font></font>
<font></font>
<span class="hljs-keyword">import</span> forklib
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket
<span class="hljs-keyword">from</span> setproctitle <span class="hljs-keyword">import</span> setproctitle<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8081</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
    setproctitle(<span class="hljs-string">f'[Master] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">worker</span>():</span>
        setproctitle(<span class="hljs-string">f'[Worker] <span class="hljs-subst">{os.path.basename(argv[<span class="hljs-number">0</span>])}</span>'</span>)<font></font>
        app = Application()<font></font>
        run_app(app, sock=sock)<font></font>
<font></font>
    forklib.fork(os.cpu_count(), worker, auto_restart=<span class="hljs-literal">True</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()<font></font>
</code></pre></div>
                    </div></li>
<li>    <strong>   -    </strong>?  ,      (   ‚Äî    )    ,      <code>nobody</code>.      ‚Äî     .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> pwd<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app
<span class="hljs-keyword">from</span> aiomisc <span class="hljs-keyword">import</span> bind_socket<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-comment">#  </span>
    sock = bind_socket(address=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8085</span>, proto_name=<span class="hljs-string">'http'</span>)<font></font>
<font></font>
    user = pwd.getpwnam(<span class="hljs-string">'nobody'</span>)<font></font>
    os.setgid(user.pw_gid)<font></font>
    os.setuid(user.pw_uid)<font></font>
<font></font>
    app = create_app(...)<font></font>
    run_app(app, sock=sock)<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<font></font>
    main()</code></pre></div>
                    </div></li>
<li>            <code>create_app</code>,         .</li>
</ul><br>
<a name="serialization"></a><h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All successful handler responses will be returned in JSON format. </font><font style="vertical-align: inherit;">It would also be convenient for clients to receive information about errors in a serialized form (for example, to see which fields did not pass validation). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The documentation </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">offers a method </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://docs.aio"><code>json_response</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that takes an object, serializes it in JSON, and returns a new object </font></font><code>aiohttp.web.Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a header </font></font><code>Content-Type: application/json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and serialized data inside.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to serialize data using json_response</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> Application, View, run_app
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> json_response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> json_response({<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But there is another way: aiohttp allows you to register an arbitrary serializer for a specific type of response data in the registry </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">For example, you can specify a serializer </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for objects of type </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mapping</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, it will be enough for the handler to return an object </font></font><code>Response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the response data in the parameter </font></font><code>body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">aiohttp will find a serializer that matches the data type and serialize the response. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the fact that serialization of objects is described in one place, this approach is also more flexible - it allows you to implement very interesting solutions (we will consider one of the use cases in the handler </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to serialize data using aiohttp.PAYLOAD_REGISTRY</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> MappingProxyType
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Mapping<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> PAYLOAD_REGISTRY, JsonPayload
<span class="hljs-keyword">from</span> aiohttp.web <span class="hljs-keyword">import</span> run_app, Application, Response, View<font></font>
<font></font>
PAYLOAD_REGISTRY.register(JsonPayload, (Mapping, MappingProxyType))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SomeView</span>(<span class="hljs-params">View</span>):</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> Response(body={<span class="hljs-string">'hello'</span>: <span class="hljs-string">'world'</span>})<font></font>
<font></font>
<font></font>
app = Application()<font></font>
app.router.add_route(<span class="hljs-string">'*'</span>, <span class="hljs-string">'/hello'</span>, SomeView)<font></font>
run_app(app)<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is important to understand that </font></font><code>json_response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, like </font></font><code>aiohttp.JsonPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, they use a standard </font><font style="vertical-align: inherit;">method </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>json.dumps</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that cannot serialize complex data types, for example, </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>asyncpg.Record</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>asyncpg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns records from the database as instances of this class). </font><font style="vertical-align: inherit;">Moreover, some complex objects may contain others: in one record from the database there may be a type field </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Python developers have addressed this problem: the method </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to use the argument </font></font><code>default</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to specify a function that is called when it is necessary to serialize an unfamiliar object. </font><font style="vertical-align: inherit;">The function is expected to cast an unfamiliar object to a type that can serialize the json module.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to extend JsonPayload to serialize arbitrary objects</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> date
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial, singledispatch
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Any<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp.payload <span class="hljs-keyword">import</span> JsonPayload <span class="hljs-keyword">as</span> BaseJsonPayload
<span class="hljs-keyword">from</span> aiohttp.typedefs <span class="hljs-keyword">import</span> JSONEncoder<font></font>
<font></font>
<span class="hljs-meta">@singledispatch</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert</span>(<span class="hljs-params">value</span>):</span>
    <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">f'Unserializable value: <span class="hljs-subst">{value!r}</span>'</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(Record)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_asyncpg_record</span>(<span class="hljs-params">value: Record</span>):</span>
    <span class="hljs-string">"""
        , 
    asyncpg
    """</span>
    <span class="hljs-keyword">return</span> dict(value)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@convert.register(date)</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">convert_date</span>(<span class="hljs-params">value: date</span>):</span>
    <span class="hljs-string">"""
       date      ‚Äî  
      .     
      ..
    """</span>
    <span class="hljs-keyword">return</span> value.strftime(<span class="hljs-string">'%d.%m.%Y'</span>)<font></font>
    <font></font>
 <font></font>
dumps = partial(json.dumps, default=convert)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JsonPayload</span>(<span class="hljs-params">BaseJsonPayload</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,
                 value: Any,
                 encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 dumps: JSONEncoder = dumps,
                 *args: Any,
                 **kwargs: Any</span>) -&gt; <span class="hljs-keyword">None</span>:</span>
        super().__init__(value, encoding, content_type, dumps, *args, **kwargs)</code></pre></div>
                    </div><br>
<a name="handlers"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handlers</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
aiohttp allows you to implement handlers with asynchronous functions and classes. </font><font style="vertical-align: inherit;">Classes are more extensible: firstly, the code belonging to one handler can be placed in one place, and secondly, classes allow you to use inheritance to get rid of code duplication (for example, each handler requires a database connection).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler Base Class</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_urldispatcher <span class="hljs-keyword">import</span> View
<span class="hljs-keyword">from</span> asyncpgsa <span class="hljs-keyword">import</span> PG<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseView</span>(<span class="hljs-params">View</span>):</span><font></font>
    URL_PATH: str<font></font>
<font></font>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">pg</span>(<span class="hljs-params">self</span>) -&gt; PG:</span>
        <span class="hljs-keyword">return</span> self.request.app[<span class="hljs-string">'pg'</span>]
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since it is difficult to read one large file, I decided to split the handlers into files. </font><font style="vertical-align: inherit;">Small files encourage weak connectivity, and if, for example, there are ring imports inside handlers, it means that something may be wrong with the composition of entities.</font></font><br>
<br>
<a name="imports_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / imports</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The input handler receives json with data about residents. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The maximum allowable request size</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in aiohttp is controlled by the option </font></font><code>client_max_size</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=http://docs.aiohttp.org/en/stable/web_reference.html&amp;usg=ALkJrhjRFxuHDYKYWzNjAq4ntQBJTRNUig#aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is 2 MB by default</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If the limit is exceeded, aiohttp will return an HTTP response with a status of 413: Request Entity Too Large Error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, the correct json with the longest lines and numbers will weigh ~ 63 megabytes, so the restrictions on the size of the request need to be expanded. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to check and deserialize the data</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . If they are incorrect, you need to return an HTTP response </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I needed two schemes </font></font><code>Marhsmallow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The first one </font></font><code>CitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, checks the data of each individual resident, and also deserializes the happy birthday string into the object </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data type, format and availability of all required fields;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lack of unfamiliar fields;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Date of birth must be indicated in the format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and cannot be of any significance from the future</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The list of relatives of each resident must contain unique identifiers of residents existing in this upload.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second scheme </font></font><code>ImportSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">,, checks the unloading as a whole:</font></font><br>
<br>
<ul>
<li><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> each resident within the unloading should be unique;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Family ties should be two-way (if resident # 1 has a resident # 2 in the list of relatives, then resident # 2 must also have a relative # 1).</font></font></li>
</ul><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the data is correct, they must be added to the database</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with a new unique one </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To add data, you will need to perform several queries in different tables. </font><font style="vertical-align: inherit;">In order to avoid partially partially added data in the database in case of an error or exception (for example, when disconnecting a client that did not receive a full response, aiohttp </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=http://docs.aio"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will throw a CancelledError exception</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you must use a transaction</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is necessary to add data to tables in parts</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , since in one query to PostgreSQL there can be no more than 32,767 arguments. </font><font style="vertical-align: inherit;">There are </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 fields </font><font style="vertical-align: inherit;">in the table </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Accordingly, for 1 request, only 32,767 / 9 = 3,640 rows can be inserted into this table, and in one upload there can be up to 10,000 inhabitants.</font></font><br>
<br>
<a name="citizens_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The handler returns all residents for unloading with the specified </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If the specified </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">upload does not exist</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you must return the 404: Not Found HTTP response. </font><font style="vertical-align: inherit;">This behavior seems to be common for handlers that need an existing unload, so I pulled the verification code into a separate class.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Base class for handlers with unloads</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> aiohttp.web_exceptions <span class="hljs-keyword">import</span> HTTPNotFound
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> select, exists<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> imports_table<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseImportView</span>(<span class="hljs-params">BaseView</span>):</span>
<span class="hljs-meta">    @property</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">import_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> int(self.request.match_info.get(<span class="hljs-string">'import_id'</span>))<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_import_exists</span>(<span class="hljs-params">self</span>):</span><font></font>
        query = select([<font></font>
            exists().where(imports_table.c.import_id == self.import_id)<font></font>
        ])<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">await</span> self.pg.fetchval(query):
            <span class="hljs-keyword">raise</span> HTTPNotFound()
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To get a list of relatives for each resident, you will need to perform </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from table </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to table </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, aggregating the field </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">grouped by </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the resident has no relatives, then he </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will return the </font></font><code>relations.relative_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">value </font><font style="vertical-align: inherit;">for him in the field </font></font><code>NULL</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and, as a result of aggregation, the list of relatives will look like </font></font><code>[NULL]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To fix this incorrect value, I used the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_remove</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The database stores the date in a format </font></font><code>YYYY-MM-DD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but we need a format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Technically, you can format the date either with an SQL query or on the Python side at the time of serializing the response with </font></font><code>json.dumps</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(asyncpg returns the value of the field </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as an instance of the class</font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I chose serialization on the Python side, given that it </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is the only object </font></font><code>datetime.date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the project with a single format (see the section </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúSerializing Data‚Äù</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the fact that two requests are executed in the handler (checking for the existence of an unloading and a request for a list of residents), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it is not necessary to use a transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . By default, PostgreSQL uses the isolation level, </font></font><code>READ COMMITTED</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and even within one transaction all changes to other, successfully completed transactions will be visible (adding new rows, changing existing ones).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The largest upload in a text view can take ~ 63 megabytes - this is quite a lot, especially considering that several requests for receiving data may arrive at the same time. </font><font style="vertical-align: inherit;">There is a rather interesting way </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to get data from the database using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cursor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and send it to the client in parts</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we need to implement two objects:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">type </font><font style="vertical-align: inherit;">object </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that returns records from the database. </font><font style="vertical-align: inherit;">At the first call, it connects to the database, opens a transaction and creates a cursor; during further iteration, it returns records from the database. </font><font style="vertical-align: inherit;">It is returned by the handler.</font></font><br>
 <br>
 <div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SelectQuery Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> AsyncIterable
<span class="hljs-keyword">from</span> asyncpgsa.transactionmanager <span class="hljs-keyword">import</span> ConnectionTransactionContextManager
<span class="hljs-keyword">from</span> sqlalchemy.sql <span class="hljs-keyword">import</span> Select<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelectQuery</span>(<span class="hljs-params">AsyncIterable</span>):</span>
    <span class="hljs-string">"""
    ,     PostgreSQL   
    ,  ,    
    """</span>
    PREFETCH = <span class="hljs-number">500</span><font></font>
<font></font>
    __slots__ = (<font></font>
        <span class="hljs-string">'query'</span>, <span class="hljs-string">'transaction_ctx'</span>, <span class="hljs-string">'prefetch'</span>, <span class="hljs-string">'timeout'</span><font></font>
    )<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, query: Select,
                 transaction_ctx: ConnectionTransactionContextManager,
                 prefetch: int = None,
                 timeout: float = None</span>):</span><font></font>
        self.query = query<font></font>
        self.transaction_ctx = transaction_ctx<font></font>
        self.prefetch = prefetch <span class="hljs-keyword">or</span> self.PREFETCH<font></font>
        self.timeout = timeout<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__aiter__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.transaction_ctx <span class="hljs-keyword">as</span> conn:<font></font>
            cursor = conn.cursor(self.query, prefetch=self.prefetch,<font></font>
                                 timeout=self.timeout)<font></font>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> cursor:
                <span class="hljs-keyword">yield</span> row
</code></pre></div>
                    </div></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A serializer </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that can iterate over asynchronous generators, serialize data from an asynchronous generator to JSON and send data to clients in parts. </font><font style="vertical-align: inherit;">It is registered </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as a serializer of objects </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
 <br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AsyncGenJSONListPayload Code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial<font></font>
<font></font>
<span class="hljs-keyword">from</span> aiohttp <span class="hljs-keyword">import</span> Payload<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># ,    JSON  asyncpg.Record  datetime.date</span>
dumps = partial(json.dumps, default=convert, ensure_ascii=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsyncGenJSONListPayload</span>(<span class="hljs-params">Payload</span>):</span>
    <span class="hljs-string">"""
       AsyncIterable,     
     JSON   
    """</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, value, encoding: str = <span class="hljs-string">'utf-8'</span>,
                 content_type: str = <span class="hljs-string">'application/json'</span>,
                 root_object: str = <span class="hljs-string">'data'</span>,
                 *args, **kwargs</span>):</span><font></font>
        self.root_object = root_object<font></font>
        super().__init__(value, content_type=content_type, encoding=encoding,<font></font>
                         *args, **kwargs)<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">write</span>(<span class="hljs-params">self, writer</span>):</span>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<font></font>
            (<span class="hljs-string">'{"%s":['</span> % self.root_object).encode(self._encoding)<font></font>
        )<font></font>
<font></font>
        first = <span class="hljs-literal">True</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> self._value:
            <span class="hljs-comment">#      </span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> first:
                <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b','</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                first = <span class="hljs-literal">False</span><font></font>
<font></font>
            <span class="hljs-keyword">await</span> writer.write(dumps(row).encode(self._encoding))<font></font>
<font></font>
        <span class="hljs-comment">#  </span>
        <span class="hljs-keyword">await</span> writer.write(<span class="hljs-string">b']}'</span>)</code></pre></div>
                    </div></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, in the handler it will be possible to create an object </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pass an SQL query and a function to it to open the transaction, and return it to </font></font><code>Response body</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler code</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># analyzer/api/handlers/citizens.py</span>
<span class="hljs-keyword">from</span> aiohttp.web_response <span class="hljs-keyword">import</span> Response
<span class="hljs-keyword">from</span> aiohttp_apispec <span class="hljs-keyword">import</span> docs, response_schema<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.schema <span class="hljs-keyword">import</span> CitizensResponseSchema
<span class="hljs-keyword">from</span> analyzer.db.schema <span class="hljs-keyword">import</span> citizens_table <span class="hljs-keyword">as</span> citizens_t
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> SelectQuery<font></font>
<font></font>
<span class="hljs-keyword">from</span> .query <span class="hljs-keyword">import</span> CITIZENS_QUERY
<span class="hljs-keyword">from</span> .base <span class="hljs-keyword">import</span> BaseImportView<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CitizensView</span>(<span class="hljs-params">BaseImportView</span>):</span>
    URL_PATH = <span class="hljs-string">r'/imports/{import_id:\d+}/citizens'</span><font></font>
<font></font>
<span class="hljs-meta">    @docs(summary='    ')</span>
<span class="hljs-meta">    @response_schema(CitizensResponseSchema())</span>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">await</span> self.check_import_exists()<font></font>
<font></font>
        query = CITIZENS_QUERY.where(<font></font>
            citizens_t.c.import_id == self.import_id<font></font>
        )<font></font>
        body = SelectQuery(query, self.pg.transaction())<font></font>
        <span class="hljs-keyword">return</span> Response(body=body)
</code></pre></div>
                    </div><br>
<code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it detects a registered </font></font><code>aiohttp.PAYLOAD_REGISTRY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">serializer </font></font><code>AsyncGenJSONListPayload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for objects of type </font><font style="vertical-align: inherit;">in the registry </font></font><code>AsyncIterable</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Then the serializer will iterate over the object </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and send data to the client. At the first call, the object </font></font><code>SelectQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">receives a connection to the database, opens a transaction and creates a cursor; during further iteration, it will receive data from the database with the cursor and return them line by line. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This approach allows not to allocate memory for the entire amount of data with each request, but it has a peculiarity: the application will not be able to return the corresponding HTTP status to the client if an error occurs (after all, the HTTP status, headers have already been sent to the client, and data is being written).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If an exception occurs, there is nothing left but to disconnect. </font><font style="vertical-align: inherit;">An exception, of course, can be secured, but the client will not be able to understand exactly what error occurred. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On the other hand, a similar situation may arise even if the processor receives all the data from the database, but the network blinks while transmitting data to the client - no one is safe from this.</font></font><br>
<br>
<a name="update_citizen_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citizens / $ citizen_id</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The handler receives the identifier of the unload </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the resident </font></font><code>citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, as well as json with the new data about the resident. </font><font style="vertical-align: inherit;">In the case of a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non-existent unloading or a resident</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , an HTTP response must be returned </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The data transmitted by the client must be </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verified and deserialized</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If they are incorrect, you must return an HTTP response </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">I implemented a Marshmallow scheme </font></font><code>PatchCitizenSchema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that checks:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The type and format of the data for the specified fields.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Date of birth. </font><font style="vertical-align: inherit;">It must be specified in a format </font></font><code>DD.MM.YYYY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and cannot be of significance from the future.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A list of relatives of each resident. </font><font style="vertical-align: inherit;">It must have unique identifiers for residents.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The existence of the relatives indicated in the field </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can not be checked separately: when a </font></font><code>relations</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non-existent resident is </font><font style="vertical-align: inherit;">added to the table, </font><font style="vertical-align: inherit;">PostgreSQL will return an error </font></font><code>ForeignKeyViolationError</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that can be processed and the HTTP status can be returned </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What status should be returned if the client sent </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incorrect data for a non-existent resident or unloading</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? It is semantically more correct to check first the existence of the unloading and the resident (if there is none, return </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and only then whether the client has sent the correct data (if not, return </font></font><code>400: Bad Request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). In practice, it is often cheaper to check the data first, and only if they are correct, access the database.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Both options are acceptable, but I decided to choose a cheaper second option, since in any case the result of the operation is an error that does not affect anything (the client will correct the data and then also find out that the resident does not exist). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the data is correct, it is necessary to </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">update the information about the resident in the database</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In the handler, you will need to make several queries to different tables. If an error or exception occurs, the changes to the database must be undone, so </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">queries must be performed in a transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The method </font></font><code>PATCH</code> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows you to transfer only some fields</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for a resident.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The handler must be written in such a way that it does not crash when accessing data that the client did not specify, and also does not execute queries on tables in which the data has not changed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the client specified the field </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it is necessary to obtain a list of existing relatives. If it has changed, determine which records from the table </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">must be deleted and which ones to add in order to bring the database into line with the client‚Äôs request. By default, PostgreSQL uses transaction isolation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code> READ COMMITTED</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This means that as part of the current transaction, changes will be visible to existing (as well as new ones) records of other completed transactions. This can lead to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a race condition between competitive requests</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose there is an unloading with residents</font></font><code>#1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>#2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>#3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">without kinship. The service receives two simultaneous requests to change resident # 1: </font></font><code><nobr>{"relatives": [2]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code><nobr>{"relatives": [3]}</nobr></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. aiohttp will create two handlers that simultaneously receive the current state of the resident from PostgreSQL. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each handler will not detect a single related relationship and will decide to add a new relationship with the specified relative. As a result, resident # 1 has the same field as relatives </font></font><code>[2,3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/go/bk/mz/gobkmzuhzr47rfzgvtygkxb1stm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This behavior cannot be called obvious. There are two options expected to decide the outcome of the race: to complete only the first request, and for the second to return an HTTP response </font></font><br>
<code>409: Conflict</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(so that the client repeats the request), or to execute requests in turn (the second request will be processed only after the first is completed). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first option can be implemented by turning on isolation mode</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>SERIALIZABLE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If during the processing of the request someone already managed to change and commit the data, an exception will be thrown, which can be processed and the corresponding HTTP status returned. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The disadvantage of this solution - a large number of locks in PostgreSQL, </font></font><code>SERIALIZABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will throw an exception, even if competitive queries change the records of residents from different unloadings. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can also use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recommendation lock</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mechanism </font><font style="vertical-align: inherit;">. If you obtain such a lock on </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, competitive requests for different unloadings will be able to run in parallel. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To process competitive requests in one upload, you can implement the behavior of any of the options: the function </font></font><code>pg_try_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tries to obtain a lock and</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
it returns the boolean result immediately (if it was not possible to get the lock - an exception can be thrown), but it </font></font><code>pg_advisory_xact_lock</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">waits until the </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
resource becomes available for blocking (in this case, the requests will be executed sequentially, I settled on this option). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, the handler must </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return the current information about the updated resident</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It was possible to limit ourselves to returning data from his request to the client (since we are returning a response to the client, it means that there were no exceptions and all requests were successfully completed). Or - use the RETURNING keyword in queries that modify the database and generate a response from the results. But both of these approaches would not allow us to see and test the case with the race of states.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There were no high load requirements for the service, so I decided to request all the data about the resident again and return to the client an honest result from the database. </font></font><br>
<br>
<a name="citizen_birthdays_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens / birthdays</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The handler calculates the number of gifts that each resident of the unloading will get to his relatives (first order). </font><font style="vertical-align: inherit;">The number is grouped by month for upload with the specified </font></font><code>import_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In the case of a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non-existent upload</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , an HTTP response must be returned </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two implementation options:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get data for residents with relatives from the database, and on the Python side, aggregate data by month and generate lists for those months for which there is no data in the database.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compile a json request in the database and add stubs for the missing months.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I settled on the first option - visually it looks more understandable and supported. The number of birthdays in a given month can be obtained by making </font></font><code>JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the table with family ties ( </font></font><code>relations.citizen_id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the resident for whom we consider the birthdays of relatives) into the table </font></font><code>citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(containing the date of birth from which you want to get the month). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Month values ‚Äã‚Äãmust not contain leading zeros. The month obtained from the field </font></font><code>birth_date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">using the function </font></font><code>date_part</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">may contain a leading zero. To remove it, I performed </font></font><code>cast</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>integer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the SQL query. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the fact that the handler needs to fulfill two requests (check the existence of unloading and get information about birthdays and gifts), a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transaction is not required</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By default, PostgreSQL uses READ COMMITTED mode, in which all new (added by other transactions) and existing (modified by other transactions) records are visible in the current transaction after they are successfully completed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, if a new upload is added at the time of receiving the data, it will not affect the existing ones. </font><font style="vertical-align: inherit;">If at the time of receiving the data a request to change the resident is fulfilled, either the data will not be visible yet (if the transaction changing the data has not been completed), or the transaction will complete completely and all changes will be immediately visible. </font><font style="vertical-align: inherit;">The integrity obtained from the database will not be violated.</font></font><br>
<br>
<a name="town_age_stat_handler"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The handler calculates the 50th, 75th and 99th percentiles of the ages (full years) of residents by city in the sample with the specified import_id. </font><font style="vertical-align: inherit;">In the case of a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non-existent upload</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , an HTTP response must be returned </font></font><code>404: Not Found</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the fact that the processor executes two requests (checking for the existence of unloading and obtaining a list of residents), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it is not necessary to use a transaction</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two implementation options:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get the age of residents from the database, grouped by city, and then on the Python side calculate the percentiles using numpy (which is specified as a reference in the task) and round up to two decimal places.</font></font></li>
<li>     PostgreSQL:  percentile_cont     ,             SQL-,  numpy   .</li>
</ol> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second option requires transferring less data between the application and PostgreSQL, but it does not have a very obvious pitfall: in PostgreSQL, rounding is mathematical, ( </font></font><code>SELECT ROUND(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns 3), and in Python - accounting, to the nearest integer ( </font></font><code>round(2.5)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns 2). </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To test the handler, the implementation must be the same in both PostgreSQL and Python (implementing a function with mathematical rounding in Python looks easier). </font><font style="vertical-align: inherit;">It is worth noting that when calculating percentiles, numpy and PostgreSQL may return slightly different numbers, but taking into account rounding, this difference will not be noticeable.</font></font><br>
<br>
<a name="testing"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Testing</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What needs to be checked in this application? Firstly, that the handlers meet the requirements and perform the required work in an environment as close as possible to the combat environment. Secondly, migrations that change the state of the database work without errors. Thirdly, there are a number of auxiliary functions that could also be correctly covered by tests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decided to use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pytest framework because</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> of its flexibility and ease of use. It offers a powerful mechanism for preparing the environment for tests - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fixtures</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , that is, functions with a decorator</font></font><code>pytest.mark.fixture</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">whose names can be specified by the parameter in the test. </font><font style="vertical-align: inherit;">If pytest detects a parameter with a fixture name in the test annotation, it will execute this fixture and pass the result in the value of this parameter. </font><font style="vertical-align: inherit;">And if the fixture is a generator, then the test parameter will take the value returned </font></font><code>yield</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and after the test finishes, the second part of the </font><font style="vertical-align: inherit;">fixture will </font><font style="vertical-align: inherit;">be executed, which can clear resources or close connections. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For most tests, we need a PostgreSQL database. </font><font style="vertical-align: inherit;">To isolate tests from each other, you can create a separate database before each test, and delete it after execution.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a fixture database for each test</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">from</span> sqlalchemy_utils <span class="hljs-keyword">import</span> create_database, drop_database
<span class="hljs-keyword">from</span> yarl <span class="hljs-keyword">import</span> URL<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> DEFAULT_PG_URL<font></font>
<font></font>
PG_URL = os.getenv(<span class="hljs-string">'CI_ANALYZER_PG_URL'</span>, DEFAULT_PG_URL)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">postgres</span>():</span>
    tmp_name = <span class="hljs-string">'.'</span>.join([uuid.uuid4().hex, <span class="hljs-string">'pytest'</span>])<font></font>
    tmp_url = str(URL(PG_URL).with_path(tmp_name))<font></font>
    create_database(tmp_url)<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment">#      postgres  -</span>
        <span class="hljs-keyword">yield</span> tmp_url
    <span class="hljs-keyword">finally</span>:<font></font>
        drop_database(tmp_url)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_db</span>(<span class="hljs-params">postgres</span>):</span>
    <span class="hljs-string">"""
     ,  PostgreSQL
    """</span><font></font>
    engine = create_engine(postgres)<font></font>
    <span class="hljs-keyword">assert</span> engine.execute(<span class="hljs-string">'SELECT 1'</span>).scalar() == <span class="hljs-number">1</span>
    engine.dispose()</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sqlalchemy_utils</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> module did a great job of this task </font><font style="vertical-align: inherit;">, taking into account the features of different databases and drivers. For example, PostgreSQL does not allow execution </font></font><code>CREATE DATABASE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in a transaction block. When creating a database, it </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">translates </font></font><code>psycopg2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(which usually executes all requests in a transaction) into autocommit mode. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another important feature: if at least one client is connected to PostgreSQL, the database cannot be deleted, but </font></font><code>sqlalchemy_utils</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disconnects all clients before deleting the database. The database will be successfully deleted even if some test with active connections to it hangs.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We need PostgreSQL in different states: for testing migrations, we need a clean database, while handlers require that all migrations be applied. </font><font style="vertical-align: inherit;">You can programmatically change the state of a database using Alembic commands; they require the Alembic configuration object to call them.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Create a fixture Alembic configuration object</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> types <span class="hljs-keyword">import</span> SimpleNamespace<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.pg <span class="hljs-keyword">import</span> make_alembic_config<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture()</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">alembic_config</span>(<span class="hljs-params">postgres</span>):</span>
    cmd_options = SimpleNamespace(config=<span class="hljs-string">'alembic.ini'</span>, name=<span class="hljs-string">'alembic'</span>,<font></font>
                                  pg_url=postgres, raiseerr=<span class="hljs-literal">False</span>, x=<span class="hljs-literal">None</span>)
    <span class="hljs-keyword">return</span> make_alembic_config(cmd_options)</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Please note that fixtures </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">have a parameter </font></font><code>postgres</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allows not only to indicate the dependence of the test on fixtures, but also the dependencies between fixtures. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This mechanism allows you to flexibly separate logic and write very concise and reusable code.</font></font><br>
<br>
<a name="testing_handlers"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handlers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Testing handlers requires a database with created tables and data types. To apply migrations, you must programmatically call the upgrade Alembic command. To call it, you need an object with the Alembic configuration, which we have already defined with fixtures </font></font><code>alembic_config</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The database with migrations looks like a completely independent entity, and it can be represented as a fixture:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> alembic.command <span class="hljs-keyword">import</span> upgrade<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">migrated_postgres</span>(<span class="hljs-params">alembic_config, postgres</span>):</span>
    upgrade(alembic_config, <span class="hljs-string">'head'</span>)
    <span class="hljs-comment">#  DSN  ,    </span>
    <span class="hljs-keyword">return</span> postgres</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When there are many migrations in the project, their application for each test may take too much time. To speed up the process, you can </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create a database with migrations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> once </font><font style="vertical-align: inherit;">and then </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use it as a template</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to the database for testing handlers, you will need a running application, as well as a client configured to work with this application. To make the application easy to test, I put its creation into a function </font></font><code>create_app</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that takes parameters to run: a database, a port for the REST API, and others. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Arguments for launching the application can also be represented as a separate fixture. To create them, you will need to determine the free port for running the test application and the address to the migrated temporary database.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To determine the free port, I used the fixture </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the aiomisc package. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A standard fixture </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">would also be fine, but it returns a function to determine free ports, while it </font></font><code>aiomisc_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">immediately returns the port number. </font><font style="vertical-align: inherit;">For our application, we need to determine only one free port, so I decided not to write an extra line of code with a call </font></font><code>aiohttp_unused_port</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">arguments</span>(<span class="hljs-params">aiomisc_unused_port, migrated_postgres</span>):</span>
    <span class="hljs-keyword">return</span> parser.parse_args(<font></font>
        [<font></font>
            <span class="hljs-string">'--log-level=debug'</span>,
            <span class="hljs-string">'--api-address=127.0.0.1'</span>,
            <span class="hljs-string">f'--api-port=<span class="hljs-subst">{aiomisc_unused_port}</span>'</span>,
            <span class="hljs-string">f'--pg-url=<span class="hljs-subst">{migrated_postgres}</span>'</span><font></font>
        ]<font></font>
    )</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All tests with handlers imply requests to the REST API; work directly with the application is </font></font><code>aiohttp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not required. </font><font style="vertical-align: inherit;">Therefore, I made one fixture that launches the application and using the factory </font></font><code>aiohttp_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">creates and returns a standard test client connected to the application </font></font><code>aiohttp.test_utils.TestClient</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> analyzer.api.app <span class="hljs-keyword">import</span> create_app<font></font>
<font></font>
<span class="hljs-meta">@pytest.fixture</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">api_client</span>(<span class="hljs-params">aiohttp_client, arguments</span>):</span><font></font>
    app = create_app(arguments)<font></font>
    client = <span class="hljs-keyword">await</span> aiohttp_client(app, server_kwargs={
        <span class="hljs-string">'port'</span>: arguments.api_port<font></font>
    })<font></font>
<font></font>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> client
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> client.close()
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, if you specify fixture in the test parameters </font></font><code>api_client</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the following will happen:</font></font><br>
<br>
<ol>
<li> <code>postgres</code>    (  <code>migrated_postgres</code>).</li>
<li> <code>alembic_config</code>    Alembic,      (  <code>migrated_postgres</code>).</li>
<li> <code>migrated_postgres</code>   (  <code>arguments</code>).</li>
<li> <code>aiomisc_unused_port</code>    (  <code>arguments</code>).</li>
<li> <code>arguments</code>     (  <code>api_client</code>).</li>
<li> <code>api_client</code>          .</li>
<li> .</li>
<li> <code>api_client</code>     .</li>
<li> <code>postgres</code>   .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fixtures can avoid code duplication, but in addition to preparing the environment in the tests, there is another potential place where there will be a lot of the same code - application requests. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, making a request, we expect to get a certain HTTP status. Secondly, if the status is as expected, then before working with the data, you need to make sure that they have the correct format. It is easy to make a mistake here and write a handler that does the correct calculations and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns the correct result, but does not pass automatic validation due to the incorrect response format</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (for example, forget to wrap the answer in a dictionary with a key </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). All of these checks could be done in one place. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the module</font></font><code>analyzer.testing</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I have prepared for each handler a helper function that checks the status of HTTP, as well as the response format using Marshmallow. </font></font><br>
<br>
<a name="test_citizens_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decided to start with a handler that returns residents, because it is very useful for checking the results of other handlers that change the state of the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I intentionally did not use code that adds data to the database from the handler </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, although it is not difficult to make it into a separate function. </font><font style="vertical-align: inherit;">The handler code has the property to change, and if there is any error in the code that adds to the database, there is a chance that the test will stop working as intended and implicitly for developers will stop showing errors. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For this test, I defined the following test data sets:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unloading with several relatives. </font><font style="vertical-align: inherit;">Checks that for each resident a list with identifiers of relatives will be correctly formed.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unloading with one resident without relatives. </font><font style="vertical-align: inherit;">Checks that the field </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is an empty list (due </font></font><code>LEFT JOIN</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the SQL query, the list of relatives may be equal </font></font><code>[None]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unloading with a resident who is a relative of himself.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empty unloading. </font><font style="vertical-align: inherit;">Checks that the handler allows adding empty unloading and does not crash with an error.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To run the same test separately at each upload, I used another very powerful pytest mechanism - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parameterization</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This mechanism allows you to wrap the test function in the decorator </font></font><code>pytest.mark.parametrize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and describe in it what parameters the test function should take for each individual test case.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to parameterize a test</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytest<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
datasets = [<font></font>
    <span class="hljs-comment">#    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>, <span class="hljs-number">3</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">3</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   </span><font></font>
    [<font></font>
        generate_citizen(relatives=[])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#   ,    </span><font></font>
    [<font></font>
        generate_citizen(citizen_id=<span class="hljs-number">1</span>, name=<span class="hljs-string">''</span>, gender=<span class="hljs-string">'male'</span>,<font></font>
                         birth_date=<span class="hljs-string">'17.02.2020'</span>, relatives=[<span class="hljs-number">1</span>])<font></font>
    ],<font></font>
<font></font>
    <span class="hljs-comment">#  </span><font></font>
    [],<font></font>
]<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@pytest.mark.parametrize('dataset', datasets)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_citizens</span>(<span class="hljs-params">api_client, dataset</span>):</span>
    <span class="hljs-string">"""
        4 ,    
    """</span></code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the test will add the upload to the database, then, using a request to the handler, it will receive information about the residents and compare the reference upload with the received one. But how do you compare residents? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each resident consists of scalar fields and a field </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- a list of identifiers of relatives. A list in Python is an ordered type, and when comparing the order of the elements of each list does matter, but when comparing lists with siblings, the order should not matter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you bring </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the set before the comparison, then when comparing it does not work out to find a situation where one of the inhabitants in the field </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has duplicates. If you sort the list with the identifiers of relatives, this will circumvent the problem of different order of identifiers of relatives, but at the same time detect duplicates.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When comparing two lists with residents, one may encounter a similar problem: technically, the order of residents in the unloading is not important, but it is important to detect if there are two residents with the same identifiers in one unloading and not in the other. </font><font style="vertical-align: inherit;">So in addition to organizing the list with relatives, relatives for each resident need to arrange the residents in each unloading. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since the task of comparing residents will arise more than once, I implemented two functions: one for comparing two residents, and the second for comparing two lists with residents:</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compare residents</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Iterable, Mapping<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize_citizen</span>(<span class="hljs-params">citizen</span>):</span>
    <span class="hljs-string">"""
         
    """</span>
    <span class="hljs-keyword">return</span> {**citizen, <span class="hljs-string">'relatives'</span>: sorted(citizen[<span class="hljs-string">'relatives'</span>])}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizens</span>(<span class="hljs-params">left: Mapping, right: Mapping</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
      
    """</span>
    <span class="hljs-keyword">return</span> normalize_citizen(left) == normalize_citizen(right)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">compare_citizen_groups</span>(<span class="hljs-params">left: Iterable, right: Iterable</span>) -&gt; bool:</span>
    <span class="hljs-string">"""
          ,   
      
    """</span>
    left = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> left]<font></font>
    left.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])<font></font>
<font></font>
    right = [normalize_citizen(citizen) <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> right]<font></font>
    right.sort(key=<span class="hljs-keyword">lambda</span> citizen: citizen[<span class="hljs-string">'citizen_id'</span>])
    <span class="hljs-keyword">return</span> left == right
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make sure that this handler does not return residents of other unloadings, I decided to add an additional unloading with one inhabitant before each test.</font></font><br>
<br>
<a name="test_imports_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POST / imports</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I defined the following datasets for testing the handler:</font></font><br>
<br>
<ul>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Correct data, expected to be successfully added to the database.</font></font></b><br>
 <br>
<ul>
<li>    ( ).<br>
<br>
      .    ,     ,    insert    ,    .</li>
<li>   ( , ).<br>
<br>
,            .<br>
 </li>
<li>    .<br>
<br>
     ,       . :)<br>
 </li>
<li>    <br>
<br>
,  aiohttp             PostgreSQL    32 767  (    ).<br>
 </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empty unloading </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The handler should take into account such a case and not fall, trying to perform empty insert into the table with the inhabitants.</font></font><br>
 </li>
</ul><br>
 </li>
<li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data with errors, expect an HTTP response of 400: Bad Request.</font></font></b><br>
 <br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Date of birth is incorrect (future tense).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">citizen_id is not unique within the upload.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A kinship is indicated incorrectly (there is only from one resident to another, but there is no feedback).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The resident has a non-existent relative in the unloading.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Family ties are not unique.</font></font></li>
</ul></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the processor worked successfully and the data was added, you need to get the residents added to the database and compare them with the standard upload. </font><font style="vertical-align: inherit;">To get residents, I used the already tested handler </font></font><code>GET /imports/$import_id/citizens</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and for comparison, a function </font></font><code>compare_citizen_groups</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a name="test_update_citizen_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PATCH / imports / $ import_id / citizens / $ citizen_id</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Validation of data is in many ways similar to that described in the handler </font></font><code>POST /imports</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a few exceptions: there is only one resident and the client can pass </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">only those fields that he wants</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I decided to use the following sets with incorrect data to verify that the handler will return an HTTP response </font></font><code>400: Bad request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The field is specified, but has an incorrect data type and / or format</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The date of birth is incorrect (future time).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The field </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contains a relative that does not exist in the unloading.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is also necessary to verify that the handler correctly updates information about the resident and his relatives. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, create an upload with three inhabitants, two of whom are relatives, and send a request with new values ‚Äã‚Äãfor all scalar fields and a new relative identifier in the field </font></font><code>relatives</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make sure that the handler distinguishes between residents of different unloadings before the test (and, for example, does not change residents with the same identifiers from another unloading), I created an additional unloading with three residents who have the same identifiers.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The handler must save the new values ‚Äã‚Äãof the scalar fields, add a new specified relative and remove the relationship with an old, not specified relative. </font><font style="vertical-align: inherit;">All changes in kinship should be bilateral. </font><font style="vertical-align: inherit;">There should not be changes in other unloadings. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since such a handler may be subject to race conditions (this was discussed in the Development section), I added </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">two additional tests</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">One reproduces the problem with the race state (extends the handler class and removes the lock), the second proves that the problem with the race state is not reproduced.</font></font><br>
<br>
<a name="test_citizen_birthdays_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / citizens / birthdays</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To test this handler, I selected the following datasets:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An unloading in which a resident has one relative in one month and two relatives in another.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unloading with one resident without relatives. </font><font style="vertical-align: inherit;">Checks that the handler does not take it into account in the calculations.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empty unloading. </font><font style="vertical-align: inherit;">Checks that the handler will not fail and will return the correct dictionary with 12 months in the response.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unloading with a resident who is a relative of himself. </font><font style="vertical-align: inherit;">Checks that a resident will buy a gift for the month of his birth.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The handler must return all months in the response, even if there are no birthdays in these months. </font><font style="vertical-align: inherit;">To avoid duplication, I made a function to which you can pass the dictionary so that it complements it with values ‚Äã‚Äãfor missing months. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make sure that the handler distinguishes between residents of different unloadings, I added an additional unloading with two relatives. </font><font style="vertical-align: inherit;">If the handler mistakenly uses them in the calculations, the results will be incorrect and the handler will fall with an error.</font></font><br>
<br>
<a name="test_town_age_stat_handler"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GET / imports / $ import_id / towns / stat / percentile / age</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The peculiarity of this test is that the results of its work depend on the current time: the age of the inhabitants is calculated based on the current date. </font><font style="vertical-align: inherit;">To ensure that the test results do not change over time, the current date, dates of birth of residents and expected results must be recorded. </font><font style="vertical-align: inherit;">This will make it easy to reproduce any, even edge cases. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is the best fix date? </font><font style="vertical-align: inherit;">The handler uses the PostgreSQL function to calculate the age of residents </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>AGE</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which takes the first parameter as the date for which it is necessary to calculate the age and the second as the base date (defined by a constant </font></font><code>TownAgeStatView.CURRENT_DATE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We replace the base date in the handler with the test time</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> patch<font></font>
<font></font>
<span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<font></font>
<span class="hljs-meta">@patch('analyzer.api.handlers.TownAgeStatView.CURRENT_DATE', new=CURRENT_DATE)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_get_ages</span>(<span class="hljs-params">...</span>):</span>
    ...</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For testing the handler, I selected the following data sets (for all residents I indicated one city, because the handler aggregates the results by city):</font></font><br>
<br>
<ul>
<li>   ,      ( ‚Äî    364 ). ,         .</li>
<li>  ,      ( ‚Äî   ).    ‚Äî  ,     ,       1 .</li>
<li> .      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><code>numpy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">benchmark </font><font style="vertical-align: inherit;">for calculating percentiles - </font><font style="vertical-align: inherit;">with linear interpolation, and the benchmark results for testing I calculated for them. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You also need to round the fractional percentile values ‚Äã‚Äãto two decimal places. If you used PostgreSQL for rounding in the handler, and Python for calculating the reference data, you might notice that </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rounding in Python 3 and PostgreSQL can give different results</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for instance</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs"># Python 3<font></font>
round(2.5)<font></font>
&gt; 2<font></font>
<font></font>
-- PostgreSQL<font></font>
SELECT ROUND(2.5)<font></font>
&gt; 3<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact is that Python uses bank rounding </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the nearest even</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and PostgreSQL </font><font style="vertical-align: inherit;">uses </font><font style="vertical-align: inherit;">mathematical (half-up). </font><font style="vertical-align: inherit;">In case calculations and rounding are performed in PostgreSQL, it would be correct to use mathematical rounding in tests as well. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first I described data sets with dates of birth in a text format, but it was inconvenient to read a test in this format: each time I had to calculate the age of each inhabitant in my mind in order to remember what a particular data set was checking. </font><font style="vertical-align: inherit;">Of course, you could get by with the comments in the code, but I decided to go a little further and wrote a function </font></font><code>age2date</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that allows you to describe the date of birth in the form of age: the number of years and days.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, like this</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> pytz<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen<font></font>
<font></font>
<font></font>
CURRENT_DATE = datetime(<span class="hljs-number">2020</span>, <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, tzinfo=pytz.utc)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">age2date</span>(<span class="hljs-params">years: int, days: int = <span class="hljs-number">0</span>, base_date=CURRENT_DATE</span>) -&gt; str:</span><font></font>
    birth_date = copy(base_date).replace(year=base_date.year - years)<font></font>
    birth_date -= timedelta(days=days)<font></font>
    <span class="hljs-keyword">return</span> birth_date.strftime(BIRTH_DATE_FORMAT)<font></font>
<font></font>
<span class="hljs-comment">#    ?  ,     ?</span>
generate_citizen(birth_date=<span class="hljs-string">'17.02.2009'</span>)<font></font>
<font></font>
<span class="hljs-comment">#   11       </span>
generate_citizen(birth_date=age2date(years=<span class="hljs-number">11</span>))
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To make sure that the handler distinguishes between residents of different unloadings, I added an additional unload with one resident from another city: if the handler mistakenly uses it, an extra city will appear in the results and the test will break.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An interesting fact: when I wrote this test on February 29, 2020, I suddenly stopped generating unloads with residents </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">due to a bug in Faker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2020 is a leap year, and other years that Faker chose were not always leap years in them too was not February 29th). </font><font style="vertical-align: inherit;">Remember to record dates and test edge cases!</font></font></blockquote><br>
<a name="test_migrations"></a><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Migrations</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The migration code at first glance seems obvious and least error prone, why test it? This is a very dangerous error: the most insidious mistakes of migrations can manifest themselves at the most inopportune moment. Even if they do not spoil the data, they can cause unnecessary downtime. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initial</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> migration </font><font style="vertical-align: inherit;">existing in the project </font><font style="vertical-align: inherit;">changes the structure of the database, but does not change the data. What common mistakes can be protected from such migrations?</font></font><br>
<br>
<ul>
<li>  <code>downgrade</code>           (     ,      ,     ).<br>
<br>
   ,        (--):         ,        ‚Äî    .<br>
 </li>
<li>C   .</li>
<li>    ( ).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most of these errors will be detected by the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stairway test</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . His idea - to use a single migration, consistently performing the methods </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for each migration. Such a test is enough to be added to the project once, it does not require support and will serve faithfully. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But if the migration, in addition to the structure, would change the data, then it would be necessary to write at least one separate test, checking that the data correctly changes in the method </font></font><code>upgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and returns to the initial state in </font></font><code>downgrade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Just in case: a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">project with examples of testing different migrations</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which I prepared for a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">report about Alembic</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Moscow Python.</font></font><br>
<br>
<a name="build"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assembly</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The final artifact that we are going to deploy and which we want to get as a result of the assembly is a Docker image. To build, you must </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select the base image</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with Python. The official image </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>python:latest</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weighs ~ 1 GB and, if used as a base image, the image with the application will be huge. There are </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">images based on the Alpine OS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the size of which is much smaller. But with a growing number of installed packages, the size of the final image will grow, and as a result, even the image collected on the basis of Alpine will not be so small. I chose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">snakepacker / python</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as the base image </font><font style="vertical-align: inherit;">- it weighs a bit more than Alpine images, but is based on Ubuntu, which offers a huge selection of packages and libraries. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another way</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduce the size of the image with the application</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - do not include in the final image the compiler, libraries and files with headers for the assembly, which are not required for the application to work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, you can use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multi-stage assembly of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Docker:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using a ‚Äúheavy‚Äù image </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 1 GB, ~ 500 MB compressed), create a virtual environment, install all the dependencies and the application package in it. </font><font style="vertical-align: inherit;">This image is needed exclusively for assembly, it can contain a compiler, all the necessary libraries and files with headers.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#   </span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/*</code></pre></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We copy the finished virtual environment into a ‚Äúlight‚Äù image </font></font><code>snakepacker/python:3.8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(~ 100 MB, compressed ~ 50 MB), which contains only the interpreter of the required version of Python. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Important: in a virtual environment, absolute paths are used, so it must be copied to the same address at which it was assembled in the collector container.</font></font><br>
<br>
<pre><code class="python hljs">FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#       builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reduce the time it takes to build the image</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the application dependent modules can be installed before it is installed in the virtual environment. </font><font style="vertical-align: inherit;">Then Docker will cache them and will not reinstall if they have not changed.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dockerfile entirely</font></font></b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment">###############      ################</span>
<span class="hljs-comment">#  ‚Äî ¬´¬ª (~1 ,    ~500 )    </span>
<span class="hljs-comment">#    </span>
FROM snakepacker/python:all <span class="hljs-keyword">as</span> builder<font></font>
<font></font>
<span class="hljs-comment">#      pip</span>
RUN python3<span class="hljs-number">.8</span> -m venv /usr/share/python3/app<font></font>
RUN /usr/share/python3/app/bin/pip install -U pip<font></font>
<font></font>
<span class="hljs-comment">#   ,  .   </span>
<span class="hljs-comment"># Docker   ,  requirements.txt  </span><font></font>
COPY requirements.txt /mnt/<font></font>
RUN /usr/share/python3/app/bin/pip install -Ur /mnt/requirements.txt<font></font>
<font></font>
<span class="hljs-comment">#  source distribution     </span><font></font>
COPY dist/ /mnt/dist/<font></font>
RUN /usr/share/python3/app/bin/pip install /mnt/dist/* \<font></font>
    &amp;&amp; /usr/share/python3/app/bin/pip check<font></font>
<font></font>
<span class="hljs-comment">###########################   ############################</span>
<span class="hljs-comment">#    ¬´¬ª (~100 ,    ~50 )   Python</span>
FROM snakepacker/python:<span class="hljs-number">3.8</span> <span class="hljs-keyword">as</span> api<font></font>
<font></font>
<span class="hljs-comment">#         builder</span>
COPY --<span class="hljs-keyword">from</span>=builder /usr/share/python3/app /usr/share/python3/app<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment"># </span><font></font>
RUN ln -snf /usr/share/python3/app/bin/analyzer-* /usr/local/bin/<font></font>
<font></font>
<span class="hljs-comment">#        </span>
CMD [<span class="hljs-string">"analyzer-api"</span>]</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For ease of assembly, I added a command </font></font><code>make upload</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that collects the Docker image and uploads it to hub.docker.com.</font></font><br>
<br>
<a name="ci"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ci</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now that the code is covered with tests and we can build a Docker image, it's time to automate these processes. The first thing that comes to mind: run tests for creating pool requests, and when adding changes to the master branch, collect a new Docker image and upload it to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker Hub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (or </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub Packages</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , if you are not going to distribute the image publicly). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I solved this problem with </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub Actions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . To do this, it was necessary to create a YAML file in a folder </font></font><code>.github/workflows</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and describe in it a workflow (with two tasks: </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), which I named </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is executed every time workflow is started </font></font><code>CI</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, using </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">services</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">picks up a container with PostgreSQL, waits for it to become available, and launches </font></font><code>pytest</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the container </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task </font></font><code>publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is performed only if the changes have been added to the branch </font></font><code>master</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and if the task </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">was successful. </font><font style="vertical-align: inherit;">It collects the source distribution by the container </font></font><code>snakepacker/python:all</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then collects and loads the Docker image with </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>docker/build-push-action@v1</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full description of workflow</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">name: CI<font></font>
<font></font>
# Workflow      <font></font>
#   -  master<font></font>
on:<font></font>
  push:<font></font>
    branches: [ master ]<font></font>
  pull_request:<font></font>
    branches: [ master ]<font></font>
<font></font>
jobs:<font></font>
  #       workflow<font></font>
  test:<font></font>
    runs-on: ubuntu-latest<font></font>
<font></font>
    services:<font></font>
      postgres:<font></font>
        image: docker://postgres<font></font>
        ports:<font></font>
          - 5432:5432<font></font>
        env:<font></font>
          POSTGRES_USER: user<font></font>
          POSTGRES_PASSWORD: hackme<font></font>
          POSTGRES_DB: analyzer<font></font>
<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: test<font></font>
        uses: docker://snakepacker/python:all<font></font>
        env:<font></font>
          CI_ANALYZER_PG_URL: postgresql://user:hackme@postgres/analyzer<font></font>
        with:<font></font>
          args: /bin/bash -c "pip install -U '.[dev]' &amp;&amp; pylama &amp;&amp; wait-for-port postgres:5432 &amp;&amp; pytest -vv --cov=analyzer --cov-report=term-missing tests"<font></font>
<font></font>
  #    Docker-  <font></font>
  publish:<font></font>
    #        master<font></font>
    if: github.event_name == 'push' &amp;&amp; github.ref == 'refs/heads/master'<font></font>
    # ,   test   <font></font>
    needs: test<font></font>
    runs-on: ubuntu-latest<font></font>
    steps:<font></font>
      - uses: actions/checkout@v2<font></font>
      - name: sdist<font></font>
        uses: docker://snakepacker/python:all<font></font>
        with:<font></font>
          args: make sdist<font></font>
<font></font>
      - name: build-push<font></font>
        uses: docker/build-push-action@v1<font></font>
        with:<font></font>
          username: ${{ secrets.REGISTRY_LOGIN }}<font></font>
          password: ${{ secrets.REGISTRY_TOKEN }}<font></font>
          repository: alvassin/backendschool2019<font></font>
          target: api<font></font>
          tags: 0.0.1, latest<font></font>
</code></pre></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now, when adding changes to the master in the Actions tab on GitHub, you can see the launch of tests, the assembly and loading of the Docker image: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/r5/qx/pm/r5qxpmy7mlttqniibfvxadvzitw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And when creating a pool request in the master branch, the results of the task will also be displayed in it </font></font><code>test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pz/d9/nk/pzd9nkmxq7a75fnlcw2tx37i308.png"><br>
<br>
<a name="deployment"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To deploy the application on the provided server, you need to install Docker, Docker Compose, start the containers with the application and PostgreSQL and apply the migrations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These steps can be automated using Ansible's configuration management system. It is written in Python, does not require special agents (connects directly via ssh), uses jinja templates and allows declaratively describe the desired state in YAML files. The declarative approach allows you not to think about the current state of the system and the actions necessary to bring the system to the desired state. All this work rests on the shoulders of Ansible modules. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ansible allows you to group logically related tasks into </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">roles</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and then reuse them. We will need two roles:</font></font><code>docker</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(installs and configures Docker) and </font></font><code>analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(installs and configures the application). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The role</font></font><code>docker</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adds a repository with Docker to the system, installs and configures packages </font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Optionally, you can set the REST API to automatically resume after a server reboot. Ubuntu allows you to solve this problem with the help of an initialization system </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>systemd</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It controls units representing various resources (daemons, sockets, mount points, and others). To add a new unit to systemd, you must describe its configuration in a separate .service file and place this file in one of the special folders, for example, in </font></font><code>/etc/systemd/system</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Then the unit can be launched, as well as enable autoload for it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Package</font></font><code>docker-ce</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">during installation, it will automatically create a file with the unit configuration - you only need to make sure that it is running and turns on when the system starts. </font><font style="vertical-align: inherit;">For Docker Compose </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><code>  docker-compose@.service</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be created by Ansible. </font><font style="vertical-align: inherit;">The symbol </font></font><code>@</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the name indicates to systemd that the unit is a template. </font><font style="vertical-align: inherit;">This allows you to start the service </font></font><code>docker-compose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a parameter - for example, with the name of our service, which will be substituted instead of </font></font><code>%i</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the unit configuration file:</font></font><br>
<br>
<pre><code class="plaintext hljs">[Unit]<font></font>
Description=%i service with docker compose<font></font>
Requires=docker.service<font></font>
After=docker.service<font></font>
<font></font>
[Service]<font></font>
Type=oneshot<font></font>
RemainAfterExit=true<font></font>
WorkingDirectory=/etc/docker/compose/%i<font></font>
ExecStart=/usr/local/bin/docker-compose up -d --remove-orphans<font></font>
ExecStop=/usr/local/bin/docker-compose down<font></font>
<font></font>
[Install]<font></font>
WantedBy=multi-user.target</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The role will</font></font><code>analyzer</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> generate a file from the template </font></font><code>docker-compose.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">at the address </font></font><code>/etc/docker/compose/analyzer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, register the application as an automatically launched service in </font></font><code>systemd</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and apply the migration. </font><font style="vertical-align: inherit;">When the roles are ready, you need to describe the playbook.</font></font><br>
<br>
<pre><code class="plaintext hljs">---<font></font>
<font></font>
- name: Gathering facts<font></font>
  hosts: all<font></font>
  become: yes<font></font>
  gather_facts: yes<font></font>
<font></font>
- name: Install docker<font></font>
  hosts: docker<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - docker<font></font>
<font></font>
- name: Install analyzer<font></font>
  hosts: api<font></font>
  become: yes<font></font>
  gather_facts: no<font></font>
  roles:<font></font>
    - analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The list of hosts, as well as the variables used in the roles, can be specified in the inventory file </font></font><code>hosts.ini</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="plaintext hljs">[api]<font></font>
130.193.51.154<font></font>
<font></font>
[docker:children]<font></font>
api<font></font>
<font></font>
[api:vars]<font></font>
analyzer_image = alvassin/backendschool2019<font></font>
analyzer_pg_user = user<font></font>
analyzer_pg_password = hackme<font></font>
analyzer_pg_dbname = analyzer</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After all the Ansible files are ready, run it:</font></font><br>
<br>
<pre><code class="plaintext hljs">$ ansible-playbook -i hosts.ini deploy.yml</code></pre><br>
<a name="load_testing"></a><div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About stress testing</font></font></b>
                        <div class="spoiler_text">,   ,     .      ,      -   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>.     :      ,    ‚Äî   ,         10 . ,         (, ,   CI-):           .<br>
<br>
,     ,      ,        10 .   ?  ,          ,   .  ,     ,       .<br>
<br>
          RPS,      :      . ,    ,     <code>import_id</code>,    <code>POST /imports</code>      .      . <br>
<br>
,       Python 3,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Locust</a>. <br>
<br>
   ,      <code>locustfile.py</code>     <code>locust</code>.         -     .<br>
<br>
 Locust   .    ,        .       <br>
 <code>self.round</code>           .<br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">    locustfile.py</b>
                        <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># locustfile.py</span>
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> http <span class="hljs-keyword">import</span> HTTPStatus<font></font>
<font></font>
<span class="hljs-keyword">from</span> locust <span class="hljs-keyword">import</span> HttpLocust, constant, task, TaskSet
<span class="hljs-keyword">from</span> locust.exception <span class="hljs-keyword">import</span> RescheduleTask<font></font>
<font></font>
<span class="hljs-keyword">from</span> analyzer.api.handlers <span class="hljs-keyword">import</span> (<font></font>
    CitizenBirthdaysView, CitizensView, CitizenView, TownAgeStatView<font></font>
)<font></font>
<span class="hljs-keyword">from</span> analyzer.utils.testing <span class="hljs-keyword">import</span> generate_citizen, generate_citizens, url_for<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnalyzerTaskSet</span>(<span class="hljs-params">TaskSet</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        super().__init__(*args, **kwargs)<font></font>
        self.round = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">make_dataset</span>(<span class="hljs-params">self</span>):</span><font></font>
        citizens = [<font></font>
            <span class="hljs-comment">#     .   </span>
            <span class="hljs-comment"># PATCH-  relatives    </span>
            <span class="hljs-comment"># ,     - </span>
            <span class="hljs-comment"># (     ,    </span>
            <span class="hljs-comment"># ).</span>
            generate_citizen(citizen_id=<span class="hljs-number">1</span>, relatives=[<span class="hljs-number">2</span>]),<font></font>
            generate_citizen(citizen_id=<span class="hljs-number">2</span>, relatives=[<span class="hljs-number">1</span>]),<font></font>
            *generate_citizens(citizens_num=<span class="hljs-number">9998</span>, relations_num=<span class="hljs-number">1000</span>,<font></font>
                               start_citizen_id=<span class="hljs-number">3</span>)<font></font>
        ]<font></font>
        <span class="hljs-keyword">return</span> {citizen[<span class="hljs-string">'citizen_id'</span>]: citizen <span class="hljs-keyword">for</span> citizen <span class="hljs-keyword">in</span> citizens}<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">request</span>(<span class="hljs-params">self, method, path, expected_status, **kwargs</span>):</span>
        <span class="hljs-keyword">with</span> self.client.request(<font></font>
                method, path, catch_response=<span class="hljs-literal">True</span>, **kwargs<font></font>
        ) <span class="hljs-keyword">as</span> resp:
            <span class="hljs-keyword">if</span> resp.status_code != expected_status:<font></font>
                resp.failure(<span class="hljs-string">f'expected status <span class="hljs-subst">{expected_status}</span>, '</span>
                             <span class="hljs-string">f'got <span class="hljs-subst">{resp.status_code}</span>'</span>)<font></font>
            logging.info(<font></font>
                <span class="hljs-string">'round %r: %s %s, http status %d (expected %d), took %rs'</span>,<font></font>
                self.round, method, path, resp.status_code, expected_status,<font></font>
                resp.elapsed.total_seconds()<font></font>
            )<font></font>
            <span class="hljs-keyword">return</span> resp<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_import</span>(<span class="hljs-params">self, dataset</span>):</span>
        resp = self.request(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'/imports'</span>, HTTPStatus.CREATED,<font></font>
                            json={<span class="hljs-string">'citizens'</span>: list(dataset.values())})
        <span class="hljs-keyword">if</span> resp.status_code != HTTPStatus.CREATED:
            <span class="hljs-keyword">raise</span> RescheduleTask
        <span class="hljs-keyword">return</span> resp.json()[<span class="hljs-string">'data'</span>][<span class="hljs-string">'import_id'</span>]<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_citizens</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizensView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_citizen</span>(<span class="hljs-params">self, import_id</span>):</span>
        url = url_for(CitizenView.URL_PATH, import_id=import_id, citizen_id=<span class="hljs-number">1</span>)<font></font>
        self.request(<span class="hljs-string">'PATCH'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/{citizen_id}'</span>,<font></font>
                     json={<span class="hljs-string">'relatives'</span>: [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>)]})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_birthdays</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(CitizenBirthdaysView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/citizens/birthdays'</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_town_stats</span>(<span class="hljs-params">self, import_id</span>):</span><font></font>
        url = url_for(TownAgeStatView.URL_PATH, import_id=import_id)<font></font>
        self.request(<span class="hljs-string">'GET'</span>, url, HTTPStatus.OK,<font></font>
                     name=<span class="hljs-string">'/imports/{import_id}/towns/stat/percentile/age'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @task</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">workflow</span>(<span class="hljs-params">self</span>):</span>
        self.round += <span class="hljs-number">1</span><font></font>
        dataset = self.make_dataset()<font></font>
<font></font>
        import_id = self.create_import(dataset)<font></font>
        self.get_citizens(import_id)<font></font>
        self.update_citizen(import_id)<font></font>
        self.get_birthdays(import_id)<font></font>
        self.get_town_stats(import_id)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsiteUser</span>(<span class="hljs-params">HttpLocust</span>):</span><font></font>
    task_set = AnalyzerTaskSet<font></font>
    wait_time = constant(<span class="hljs-number">1</span>)</code></pre></div>
                    </div><br>
 100  c  ,  ,        :<br>
<br>
<img src="https://habrastorage.org/webt/qx/ri/b3/qxrib3jily9gzmexxhupu35tipa.png"><br>
<br>
       ,           ( ‚Äî 95 ,  ‚Äî ).        .<br>
<br>
<img src="https://habrastorage.org/webt/dn/px/fn/dnpxfn5ly7vttziqnnfpvvdsl9g.png"><br>
<br>
      ‚Äî     Ansible       ~20.15  ~20.30    Locust.<br>
<br>
<img src="https://habrastorage.org/webt/om/1e/ok/om1eoknqvzqmyez-plpgykhz8io.png"></div>
                    </div><br>
<a name="whatelse"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What else can be done?</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Profiling the application showed that about a quarter of the total query execution time is spent on JSON serialization and deserialization: there are a lot of data sent and received from the service. </font><font style="vertical-align: inherit;">These processes can be significantly accelerated using the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orjson</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">, but the service will have to be prepared a bit - </font></font><code>orjson</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it is not a drop-in replacement for the standard module. </font></font><code>json</code> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usually, production requires several copies of the service to ensure fault tolerance and cope with the load. </font><font style="vertical-align: inherit;">To manage a group of services, you need a tool that shows whether a copy of the service is "alive". </font><font style="vertical-align: inherit;">This problem can be solved by a handler </font></font><code>/health</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that polls all the resources required for work, in our case, a database. </font><font style="vertical-align: inherit;">If</font></font><code>SELECT 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">executed in less than a second, then the service is alive. If not, you need to pay attention to it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When an application works very intensively with a network, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uvloop</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> can coolly increase performance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An important factor is the readability of the code. One of my colleagues, Yuri Shikanov, wrote a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gray</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> module combining several tools </font><font style="vertical-align: inherit;">for automatic verification and execution of code, which is easy to add to a </font></font><code>pre-commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Git hook, set up with a single configuration file or environment variables. Gray allows you to sort imports ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isort</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), optimizes python expressions according to new versions of the language ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pyupgrade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), adds commas at the end of function calls, imports, lists, etc. (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add-trailing-comma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), and also quotes to a single form ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unify</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br>
<br>
<a name="final"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* * *</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That's all for me: we developed, covered with tests, assembled and deployed the service, and also carried out load testing.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acknowledgments</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I would like to express my deep gratitude to the guys who took the time to take part in writing this article, to review the code, to introduce my ideas and comments: to Maria Zelenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zelma</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Vladimir Solomatin </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">leenr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Anastasia Semenova </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">morkov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Yuri Shikanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dizballanze</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Mikhail Shushpanov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mishush</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, Pavel Mosein </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pavkazzz</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and especially to Dmitry Orlov </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">orlovdl</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en499518/index.html">Video conferencing is now a market and new technologies. Longrid, part one</a></li>
<li><a href="../en499522/index.html">–í—Å–µ –Ω–æ–≤–æ–≤–≤–µ–¥–µ–Ω–∏—è Windows 10 2004 (20H1)</a></li>
<li><a href="../en499524/index.html">Quarkus: application upgrades using the helloworld example from JBoss EAP Quickstart</a></li>
<li><a href="../en499528/index.html">A ‚Äústunning‚Äù mathematical bridge that extends beyond Fermat‚Äôs Great Theorem</a></li>
<li><a href="../en499532/index.html">Words in numbers: free blog analytics habravebinary with Yandex.Metrica</a></li>
<li><a href="../en499536/index.html">Growbox as a method of knowing oneself</a></li>
<li><a href="../en499540/index.html">How 3D game rendering works: texturing and texture filtering</a></li>
<li><a href="../en499542/index.html">Top Fakapov Cyan</a></li>
<li><a href="../en499544/index.html">Learn neural networks in Google Sheets</a></li>
<li><a href="../en499546/index.html">Firmware development for an analog video camera EVR-Y2022F</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>