<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üàöÔ∏è ‚òùüèæ ‚§¥Ô∏è UID and Stalker Authorization on the MAG250 üòß üÜò üìµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have long been interested in the topic of authorization of media consoles in the Stalker portal, but it was not before that. One day I accidentally ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>UID and Stalker Authorization on the MAG250</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/486896/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I have long been interested in the topic of authorization of media consoles in the Stalker portal, but it was not before that. </font><font style="vertical-align: inherit;">One day I accidentally got the Infomir MAG250 prefix and I decided to tackle this issue.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Training</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, I disassembled the prefix, soldered the cable to the connector and connected it to the computer. </font><font style="vertical-align: inherit;">Having launched the terminal program, I was pleased with the familiar U-Boot. </font><font style="vertical-align: inherit;">The boot process could also be interrupted by pressing any key (usually the manufacturer disables such chips and you have to spend a lot of time to bring U-Boot to the desired state). </font><font style="vertical-align: inherit;">Access with root privileges was also available via ssh. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o-/4t/p6/o-4tp67pijj-mwgwzsxy7tcq0fu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The console is equipped with 256MB DRAM and two flash drives, NOR 1 MB and NAND 256 MB. </font><font style="vertical-align: inherit;">With NOR, U-Boot is loaded in the process, which loads the kernel and file system from NAND.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getuid () function</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The prefix authorizes itself in the Stalker portal, sending a bunch of any information, such as, for example, type, firmware version, hardware version, serial number, etc. But I was specifically interested in the device_id parameter, which the gSTB.GetUID () function issued. At first glance, it was a hash like SHA256 or MD5. Referring to the official documentation </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">soft.infomir.com/stbapi/JS/v343/gSTB.html#.GetUID</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the function can take up to two parameters, but the first thing I was interested in was the option without parameters. By loading stbapp in the IDA, we can easily find this function. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ev/5q/ln/ev5qlnsrhnbb2d61izfqbwqktp4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Going a little further, we see an interesting moment</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k7/gr/ow/k7growkphe0iah5oqaidlljtgpe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, the program allocates 0x41 bytes of memory, nullifies it, and calls the driver function / dev / stapi / stevt_ioctl, passing it this piece of memory and the parameter 0xC004C919. </font><font style="vertical-align: inherit;">Therefore, a certain stevt_ioctl driver is responsible for generating the UID. </font><font style="vertical-align: inherit;">To check this, I quickly sketched this code: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mo/fa/no/mofanof9n_oicnlia9xzepfbbpo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Running it on the console, I saw a familiar UID.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stevt_ioctl</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to disassemble the stapi_ioctl_stripped.ko driver, which is located in / root / modules. </font><font style="vertical-align: inherit;">We load the driver into the IDA and find the handler 0xC004C919 ioctl (I called this function calcHash). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yh/0x/ph/yh0xphq5q-bouv83w_vdpsl10js.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are three interesting points. </font><font style="vertical-align: inherit;">First, 0x41 bytes of memory are copied from user space to kernel space (this is exactly what is transmitted by the user and in our case consists of zeros), the </font><b><font style="vertical-align: inherit;">get_mem_type</font></b><font style="vertical-align: inherit;"> function is </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">called</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(along the way in the kernel itself) and the result (again 0x41 bytes) is then copied to the user's address area. </font><font style="vertical-align: inherit;">To find the address of the get_mem_type function, I saw two possibilities: just look at the / proc / kallsysms file, hoping that access was not restricted, well, or, otherwise, write an assembly in assembler for the driver itself that will return the value of register r0 in the right place. </font><font style="vertical-align: inherit;">Having looked in / proc / kallsysms, I was pleasantly surprised and found the address of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_mem_type</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 0x8080E380 </font><font style="vertical-align: inherit;">function </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Core</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For further analysis, you will need to analyze the kernel. The kernel itself can be found in the manufacturer‚Äôs firmware, or you can remove the dump using U-Boot </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jy/pw/rk/jypwrkvsciffckeuityrrpxw0gk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
or mount the desired partition. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Based on the U-Boot information, the kernel is loaded at 0x80800000, and the entry point is at 0x80801000. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We load the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> kernel in the IDA and find the </font><b><font style="vertical-align: inherit;">get_mem_type</font></b><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After analyzing the code, I discovered this section, which supposedly returned the UID. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d3/fq/tf/d3fqtfjotcjbowla35u8ww7rzzg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So the UID is stored at 0x80D635EC. Next, we are looking for in the IDA, where this value is formed. This was in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">init_board_extra</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><font style="vertical-align: inherit;">(I won‚Äôt translate the full listing)</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cl/ws/l2/clwsl2szmjouku6qbpyucp2g2hc.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So this is the same unknown value at the address of the r4 register from which the hash of interest is calculated (fill_hash by the way was resolved by SHA256). </font><font style="vertical-align: inherit;">I really was eager to find out what it was and I quickly wrote an insert in assembler, which, through the printk function, returned the contents of memory at the address of register r2. </font><font style="vertical-align: inherit;">Having modified the kernel in this way, I made a new uImage and uploaded it to a USB drive. </font><font style="vertical-align: inherit;">And in the terminal U-Boot set:</font></font><br>
<br>
<pre><code class="plaintext hljs">usb start<font></font>
fatload usb 0:1 80000000 uImage<font></font>
bootm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But after the last team, such a sadness was waiting for me. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xy/pw/js/xypwjsvafjdefnqk9q4u18npeji.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
U-Boot politely refused to ship my new kernel.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Editing U-Boot</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To convince U-Boot to boot my kernel, I decided to patch it in memory with the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mw</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command itself </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">To start, I made a full dump of NOR flash, which is located at 0xA0000000. </font><font style="vertical-align: inherit;">Having driven the dump into the IDA, I discovered the memory address where the U-Boot copied itself. </font><font style="vertical-align: inherit;">It was 0x8FD00000. </font><font style="vertical-align: inherit;">Again, dumping this memory area and starting the IDA, I easily found a function that checked the signature. </font><font style="vertical-align: inherit;">If everything was correct, she returned 0. Moreover, she was called in two different places. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/on/tq/eb/ontqebdlazmflevjnrx2kx9nnkw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What exactly did this function do was not interesting to me. </font><font style="vertical-align: inherit;">She just needed to return 0 like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">mov #0x0, r0<font></font>
rts<font></font>
nop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The corresponding code for U-Boot was now like this:</font></font><br>
<br>
<pre><code class="plaintext hljs">usb start<font></font>
mw.l 8fd0ec08 000b200a;<font></font>
mw.l 8fd0ec0c 00900009<font></font>
fatload usb 0:1 80000000 uImage<font></font>
bootm</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then U-Boot happily loaded my kernel, which issued</font></font><br>
<br>
<pre><code class="plaintext hljs">EF0F3A38FF7FD567012016J04501200:1a:79:23:7e:2MAG250pq8UK0DAOQD1JzpmBx1Vwdb58f9jP7SN</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Full analysis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, what did the UID consist of? It was some unknown number of 8 bytes, the serial number of the console, the MAC address, the type of console and a piece of garbage. It remains to find out what kind of unknown number it was and where the garbage came from. I returned to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">init_board_extra</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> function </font><b><font style="vertical-align: inherit;">again</font></b><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An unknown number was taken from this code section:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8g/hu/u2/8ghuu2d4buowz6plm_feo1hi9pk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here, using the __ioremap function, the kernel accessed physical memory at 0x00000000 (which was the NOR address of the flash), wrote 0x0F to 0x00000000, then 0x98 to 0x000000AA and read 8 bytes starting from 0x000000C2. And what is it? These are the CFI protocol commands with which the kernel communicated with NOR. 0x0F brought the NOR to its original state, and with the 0x98 switch command mods CFI. In this module, at the address 0x000000C2 is the Security Code Area or 64-bit unique device number. Those. unknown number is a unique NOR flash number. The following is a dump of CFI identification. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/5y/y_/ez/5yy_eziyuvoq3pirbxmfecrjfqu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can make your dump directly in U-Boot by setting</font></font><br>
<pre><code class="plaintext hljs">mw.w a0000000 f0<font></font>
mw.w a00000aa 98<font></font>
md.b a1000000 100<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A piece of garbage was just an ordinary 32-byte character set that was sewn into the kernel itself. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n3/dz/tb/n3dztbcvv-kjjud2dhvkg25lrni.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And this garbage was processed before using the encryption function </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">swap_pairs</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which simply changed the position of the bytes</font></font><br>
<br>
<pre><code class="plaintext hljs">[0x00000003]&lt;-&gt;[0x0000000F]<font></font>
[0x00000005]&lt;-&gt;[0x0000001F]<font></font>
[0x00000009]&lt;-&gt;[0x00000002]<font></font>
[0x0000000A]&lt;-&gt;[0x0000001D]<font></font>
[0x00000010]&lt;-&gt;[0x00000015]<font></font>
[0x00000004]&lt;-&gt;[0x00000013]<font></font>
[0x0000000D]&lt;-&gt;[0x00000018]</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Based on the information received, I dare to assume that the manufacturer‚Äôs database contains information on each ID NOR flash and the corresponding serial number and MAC address. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Of course, it's impossible to select all this, but you can write your own software, which will fully emulate the console.</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en486880/index.html">Mistakes of translators that led to disastrous consequences</a></li>
<li><a href="../en486884/index.html">Japanese pharmaceutical company begins testing drugs synthesized using a neural network</a></li>
<li><a href="../en486888/index.html">The book ‚ÄúObject-Oriented Approach. 5th int. ed. "</a></li>
<li><a href="../en486890/index.html">Self-development: how I did not sit on two chairs and found a third</a></li>
<li><a href="../en486892/index.html">Contact Picker API, or how to share your contacts with a browser</a></li>
<li><a href="../en486902/index.html">Protocol Oriented Programming in Swift 5.1</a></li>
<li><a href="../en486904/index.html">Showing developers the status of quality control of source code in SonarQube</a></li>
<li><a href="../en486908/index.html">Wulfric Ransomware is a cryptor that doesn't exist</a></li>
<li><a href="../en486912/index.html">Lowkiq. Why did we do it?</a></li>
<li><a href="../en486914/index.html">8. Fortinet Getting Started v6.0. Work with users</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>