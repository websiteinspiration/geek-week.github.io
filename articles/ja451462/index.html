<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📮 🙆🏼 👶 Laravelでバインディングを使用して重複コードを減らします 🈷️ 🙆🏻 💇🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ご列席の皆様、こんにちは。
 
 少し前に、Laravelで単一のプロジェクトをレビューするときに、重複したコードが重複する現象に遭遇しました。
 
 つまり、システムにはAJAXリクエスト用の内部APIの構造があり、基本的にデータベースから何かのコレクション（注文、ユーザー、割り当てなど）を返しま...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Laravelでバインディングを使用して重複コードを減らします</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451462/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d55/56b/807/d5556b807e74c5f1ba534192a5352d7a.png" alt="画像" width="400"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ご列席の皆様、こんにちは。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
少し前に、Laravelで単一のプロジェクトをレビューするときに、重複したコードが重複する現象に遭遇しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、システムにはAJAXリクエスト用の内部APIの構造があり、基本的にデータベースから何かのコレクション（注文、ユーザー、割り当てなど）を返します。この構造の要点は、結果とともにJSONを返すことです。コードレビューでは、同じコードを使用して5つまたは6つのクラスをカウントしました。唯一の違いは、ResourceCollection、JsonResource、およびモデル自体の依存関係の注入でした。このアプローチは私には根本的に間違っているように思われ、Laravelフレームワークが提供する強力なDIを使用して、このコードに正しい変更を加えることを自分で行うことにしました。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで、私は後で話し合うことになったのです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Magento 2の開発経験は約1年半ありますが、このCMSに初めて出会ったとき、そのDIにショックを受けました。知らない人のために：Magento 2では、システムの小さな部分が、いわゆる「仮想型」に基づいて構築されています。つまり、特定のクラスを参照する場合、必ずしも「実際の」クラスを参照するわけではありません。ここでは、特定の「実際の」クラスに基づいて「アセンブル」された仮想タイプ（たとえば、DIを介してアセンブルされた管理グリッドのコレクション）を参照しています。つまり、DIで同様のものを記述するだけで、依存関係で使用するクラスを実際にコンパイルできます。</font></font><br>
<br>
<pre><code class="xml hljs"><span class="hljs-tag">&lt;<span class="hljs-name">virtualType</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Vendor\Module\Model\ResourceModel\MyData\Grid\Collection"</span>
                 <span class="hljs-attr">type</span>=<span class="hljs-string">"Magento\Framework\View\Element\UiComponent\DataProvider\SearchResult"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">arguments</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"mainTable"</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"string"</span>&gt;</span>vendor_table<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"resourceModel"</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"string"</span>&gt;</span>Vendor\Module\Model\ResourceModel\MyData
            <span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">arguments</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">virtualType</span>&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vendor \ Module \ Model \ ResourceModel \ MyData \ Grid \ Collectionクラスを要求すると、Magento \ Framework \ View \ Element \ UiComponent \ DataProvider \ SearchResultのインスタンスが取得されますが、mainTableの依存関係は「vendor_table」とresourceModel-に設定されていますベンダー\モジュール\モデル\ ResourceModel \ MyData。 " </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、そのようなアプローチは私には理解しにくいようで、完全に「適切」ではなく、あまり一般的ではありませんでした。しかし、</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このボールの</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1年の開発後</font><font style="vertical-align: inherit;">、私は逆に、このアプローチのフォロワーになり、さらに、自分のプロジェクトにそれを適用することに気付きました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Laravelに戻る。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DI Laravelは、「サービスコンテナー」上に構築されています。これは、システムのバインダーと依存関係を管理するエンティティです。</font><font style="vertical-align: inherit;">したがって、たとえば、DummyDataProviderInterfaceインターフェースにこのDummyDataProviderインターフェースの実装を通知できます。</font></font><br>
<br>
<pre><code class="php hljs">app()-&gt;bind(DummyDataProviderInterface::class, DummyDataProvider::class);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、サービスコンテナーでDummyDataProviderInterfaceを要求すると（たとえば、クラスコンストラクターを介して）、DummyDataProviderクラスのインスタンスを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
多くの</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（何らかの理由で）</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Laravelサービスコンテナーでこの知識を終了し、独自のはるかに興味深いことを行います</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、無駄</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Laravelは、特定のインターフェースなどの実際のエンティティを「バインド」するだけでなく、いわゆる「仮想タイプ」（別名）も作成できます。そして、この場合でも、Laravelはあなたのタイプを実装するクラスを渡す必要はありません。 bind（）メソッドは、$ appパラメーターが渡された2番目の引数として無名関数（アプリケーションクラスのインスタンス）を取ることができます。一般に、ここでコンテキストバインディングに進みます。「仮想型」を実装するクラスに渡すものは、現在の状況によって異なります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションアーキテクチャを構築するこのアプローチに誰もが同意するわけではないので、警告します。同じクラスが何百もある場合は、この資料をスキップしてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、まず、「実際の」クラスとして機能するものを決定します。コードレビューに導いたプロジェクトの例を使用して、リソースリクエスト（実際にはCRUDですが、少し削減）について同じ状況を考えてみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的なCrudコントローラーの実装を見てみましょう。</font></font><br>
<br>
<pre><code class="php hljs">
<span class="hljs-meta">&lt;?php</span><font></font>
<font></font>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Wolf</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>\<span class="hljs-title">Backend</span>\<span class="hljs-title">Crud</span>;<font></font>
<font></font>
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Wolf</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>\<span class="hljs-title">Controller</span>;<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> Model
     */</span>
    <span class="hljs-keyword">protected</span> $model;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> \Illuminate\Http\Resources\Json\ResourceCollection|null
     */</span>
    <span class="hljs-keyword">protected</span> $resourceCollection;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@var</span> \Illuminate\Http\Resources\Json\JsonResource|null
     */</span>
    <span class="hljs-keyword">protected</span> $jsonResource;<font></font>
<font></font>
    <span class="hljs-comment">/**
     * BaseController constructor.
     * <span class="hljs-doctag">@param</span> Model $model
     * <span class="hljs-doctag">@param</span> \Illuminate\Http\Resources\Json\ResourceCollection|null $resourceCollection
     * <span class="hljs-doctag">@param</span> \Illuminate\Http\Resources\Json\JsonResource|null $jsonResource
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        $model,
        $resourceCollection = <span class="hljs-literal">null</span>,
        $jsonResource = <span class="hljs-literal">null</span>
    </span>) </span>{
        <span class="hljs-keyword">$this</span>-&gt;model = $model;
        <span class="hljs-keyword">$this</span>-&gt;resourceCollection = $resourceCollection;
        <span class="hljs-keyword">$this</span>-&gt;jsonResource = $jsonResource;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Display a listing of the resource.
     *
     * <span class="hljs-doctag">@param</span> Request $request
     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Resources\Json\ResourceCollection
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params">Request $request</span>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;resourceCollection::make(<span class="hljs-keyword">$this</span>-&gt;model-&gt;get());<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/**
     * Display the specified resource.
     *
     * <span class="hljs-doctag">@param</span>  int $id
     * <span class="hljs-doctag">@return</span> \Illuminate\Http\Resources\Json\JsonResource
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span>(<span class="hljs-params">$id</span>)
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;jsonResource::make(<span class="hljs-keyword">$this</span>-&gt;model-&gt;find($id));<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際にはプロジェクトが計画段階にあるので、私は実装にそれほど気になりませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何かを返す必要がある2つのメソッドがあります。データベースからエンティティのコレクションを返すインデックスと、特定のエンティティのjsonリソースを返すshowです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際のクラスを使用する場合、毎回、モデル、リソース、およびコレクションのクラスを定義する1〜2個のセッターを含むクラスを作成します。本当に複雑な実装が1〜2しかない、数十のファイルを想像してみてください。 DI Laravelを使用すると、このような「クローン」を回避できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、このシステムのアーキテクチャはシンプルですが、スイスの時計として信頼できます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コレクション、モデル、リソースなどとして使用されるクラスを直接参照する「仮想タイプ」の配列を含むjsonファイルがあります... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、次のようになります。</font></font><br>
<br>
<pre><code class="javascript hljs">{
    <span class="hljs-string">"Wolf\\Http\\Controllers\\Backend\\Crud\\OrdersResourceController"</span>: {
        <span class="hljs-string">"model"</span>: <span class="hljs-string">"Wolf\\Model\\Backend\\Order"</span>,
        <span class="hljs-string">"resourceCollection"</span>: <span class="hljs-string">"Wolf\\Http\\Resources\\OrdersCollection"</span>,
        <span class="hljs-string">"jsonResource"</span>: <span class="hljs-string">"Wolf\\Http\\Resources\\OrderResource"</span><font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、Laravelバインディングを使用して、Wolf \ Http \ Controllers \ Backend \ Crud \ BaseController for virtual type Wolf \ Http \ Controllers \ Backend \ Crud \ OrdersResourceController for the implementation class（note the class Wolf \ Http \ Controllers \ Backend \ Crud \ OrdersResourceControllerを要求すると、抽象クラスではなくWolf \ Http \ Controllers \ Backend \ Crud \ BaseControllerのインスタンスを取得する必要があるため、抽象的であってはなりません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CrudServiceProviderのboot（）メソッドに、次のコードを挿入します。</font></font><br>
<br>
<pre><code class="php hljs">
$path = app_path(<span class="hljs-string">'etc/crud.json'</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;filesystem-&gt;isFile($path)) {<font></font>
    $virtualTypes = json_decode(<span class="hljs-keyword">$this</span>-&gt;filesystem-&gt;get($path), <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">foreach</span> ($virtualTypes <span class="hljs-keyword">as</span> $virtualType =&gt; $data) {
        <span class="hljs-keyword">$this</span>-&gt;app-&gt;bind($virtualType, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">$app</span>) <span class="hljs-title">use</span> (<span class="hljs-params">$data</span>) </span>{
            <span class="hljs-comment">/** <span class="hljs-doctag">@var</span> Application $app */</span><font></font>
            $bindingData = [<font></font>
                <span class="hljs-string">'model'</span> =&gt; $app-&gt;make($data[<span class="hljs-string">'model'</span>]),
                <span class="hljs-string">'resourceCollection'</span> =&gt; $data[<span class="hljs-string">'resourceCollection'</span>],
                <span class="hljs-string">'jsonResource'</span> =&gt; $data[<span class="hljs-string">'jsonResource'</span>]<font></font>
            ];<font></font>
            <span class="hljs-keyword">return</span> $app-&gt;makeWith(<span class="hljs-built_in">self</span>::BASE_CRUD_CONTROLLER, $bindingData);<font></font>
        });<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
定数BASE_CRUD_CONTROLLERには、CRUDコントローラーのロジックを実装するクラスの名前が含まれています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理想からは程遠いが、うまくいく:)</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、仮想タイプの配列を調べ、バインダーを設定します。サービスコンテナーからモデルインスタンスのみを取得し、ResourceCollectionとJsonResourceはクラス名にすぎないことに注意してください。何故ですか？モデルは属性を取り込んで埋める必要はなく、属性がなくても十分に機能します。ただし、コレクションは、データやエンティティを取得するための何らかのリソースを取り込む必要があります。したがって、BaseControllerでは、静的メソッドコレクション（）とmake（）をそれぞれ使用します（原則として、リソースに何かを入れてインスタンスを返す動的ゲッターを追加できますが、これはあなたに任せます）。これらのインスタンスを返します同じコレクションですが、データが転送されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、原則として、Laravelバインディング全体をそのような状態にすることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
全体として、Wolf \ Http \ Controllers \ Backend \ Crud \ OrdersResourceControllerを要求すると、コントローラーWolf \ Http \ Controllers \ Backend \ Crud \ BaseControllerのインスタンスが取得されますが、モデル、リソース、およびコレクションの組み込みの依存関係があります。</font><font style="vertical-align: inherit;">ResourceCollectionとJsonResourceを作成するだけで、返されるデータを制御できます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja451452/index.html">Build2019、見たものを理解する</a></li>
<li><a href="../ja451454/index.html">通知アプリiOSの内容を変更します</a></li>
<li><a href="../ja451456/index.html">ロシアのAERODISKストレージ：負荷テスト。IOPSの絞り込み</a></li>
<li><a href="../ja451458/index.html">ゲーム開発者を醸造しました。パート1</a></li>
<li><a href="../ja451460/index.html">迷路のジュリア</a></li>
<li><a href="../ja451466/index.html">graphql-落とし穴</a></li>
<li><a href="../ja451468/index.html">先週のフロントエンドの世界からの新鮮な食材のダイジェストNo.364（2019年5月6日〜12日）</a></li>
<li><a href="../ja451476/index.html">Goに関するLLVM</a></li>
<li><a href="../ja451478/index.html">パンダプロファイリングライブラリを使用したデータ探索の高速化</a></li>
<li><a href="../ja451480/index.html">なぜ産業貿易省は外国の機器のデータの保存を禁止するのですか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>