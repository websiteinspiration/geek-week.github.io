<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛷️ 🧑🏿‍🤝‍🧑🏾 🎅🏼 在Zabbix中通过SNMPv3监视网络设备 😷 🕙 🛒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="本文讨论了使用SNMPv3协议监视网络设备的功能。我们将讨论SNMPv3，我将分享在Zabbix中创建完整模板的经验，并展示在大型网络上组织分布式警报时可以实现的目标。SNMP是监视网络设备的主要协议，而Zabbix在监视大量对象和汇总大量传入指标方面非常出色。
 
 关于SNMPv3的几句话
 让...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>在Zabbix中通过SNMPv3监视网络设备</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/zabbix/blog/495704/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本文讨论了使用SNMPv3协议监视网络设备的功能。</font><font style="vertical-align: inherit;">我们将讨论SNMPv3，我将分享在Zabbix中创建完整模板的经验，并展示在大型网络上组织分布式警报时可以实现的目标。</font><font style="vertical-align: inherit;">SNMP是监视网络设备的主要协议，而Zabbix在监视大量对象和汇总大量传入指标方面非常出色。</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于SNMPv3的几句话</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们从SNMPv3的使用及其使用功能开始。</font><font style="vertical-align: inherit;">SNMP任务通过向网络设备发送简单命令（例如，打开和关闭网络接口或重新启动设备）来监视网络设备和基本管理。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNMPv3与以前的版本之间的主要区别是经典的安全功能[1-3]，即：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">身份验证，确定从可信来源接收到请求；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">加密，以防止被第三方拦截时泄露所传输的数据；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完整性，即保证数据包在传输期间不会被篡改。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNMPv3意味着使用一种安全模型，在该模型中为给定用户及其所属的组设置了身份验证策略（在SNMP的早期版本中，在从服务器到监视对象的请求中，仅比较了“社区”，以明文形式传输了带有“密码”的文本字符串） （纯文本））。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNMPv3引入了安全级别的概念-可接受的安全级别，这些级别确定设备的配置以及监视对象的SNMP代理的行为。安全模型和安全级别的组合决定了在处理SNMP数据包时使用哪种安全机制[4]。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下表描述了模型和SNMPv3安全级别的组合（我决定将前三列保留为原始格式）：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qu/5x/ac/qu5xacorpr-q2zreebuvsul87vw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们将在使用加密的身份验证模式下使用SNMPv3。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置SNMPv3 </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
监视网络设备在监视服务器和被监视对象上都涉及SNMPv3协议的相同配置。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们从配置Cisco网络设备开始，其最低必需配置如下（对于配置，我们使用CLI，我简化了名称和密码以避免混淆）：</font></font><br>
<br>
<pre><code class="plaintext hljs">snmp-server group snmpv3group v3 priv read snmpv3name <font></font>
snmp-server user snmpv3user snmpv3group v3 auth md5 md5v3v3v3 priv des des56v3v3v3<font></font>
snmp-server view snmpv3name iso included</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
snmp-server组的第一行-定义SNMPv3用户组（snmpv3group），读取模式（read）以及snmpv3group组的访问权限，以查看监视对象的MIB树的某些分支（以下配置中的snmpv3name确定该组MIB树的哪些分支） snmpv3group将可以访问）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第二行是snmp-server用户-定义用户snmpv3user，其在snmpv3group组中的成员身份以及身份验证md5（md5的密码为md5v3v3v3）和加密des（des的密码为des56v3v3v3）的使用。当然，最好使用aes而不是des，在此我仅作为示例。另外，在定义用户时，您可以添加访问列表（ACL），该列表用于管理有权监视此设备的监视服务器的IP地址-这也是最佳做法，但我不会使示例复杂化。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
snmp-server视图的第三行定义了代码名称，该代码名称设置了snmpv3name MIB树的分支，以便snmpv3group用户组可以请求它们。</font><font style="vertical-align: inherit;">使用ISO，而不是严格定义单个分支，它允许snmpv3group用户组访问监视对象的MIB树的所有对象。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
华为设备（也在CLI中）的类似配置如下：</font></font><br>
<br>
<pre><code class="plaintext hljs">snmp-agent mib-view included snmpv3name iso<font></font>
snmp-agent group v3 snmpv3group privacy read-view snmpv3name<font></font>
snmp-agent usm-user v3 snmpv3user group snmpv3group<font></font>
snmp-agent usm-user v3 snmpv3user authentication-mode md5 <font></font>
            md5v3v3v3<font></font>
snmp-agent usm-user v3 snmpv3user privacy-mode des56<font></font>
            des56v3v3v3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
设置网络设备后，您需要检查通过SNMPv3协议从监视服务器的访问，我将使用snmpwalk：</font></font><br>
<br>
<pre><code class="plaintext hljs">snmpwalk -v 3 -u snmpv3user -l authPriv -A md5v3v3v3 -a md5 -x des -X des56v3v3v3 10.10.10.252</code></pre><br>
<img src="https://habrastorage.org/webt/dj/zh/jt/djzhjtntle82d3erggwh-beglsq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
snmpget是一个使用MIB文件请求特定OID对象的更直观的工具：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/iz/6n/2v/iz6n2vstdjeaxgsw2fhjqlcra3u.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，让我们继续为Zabbix模板设置SNMPv3的典型数据元素。为了简化和独立于MIB，我使用数字OID：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/aw/ig/-h/awig-hyentp_3pgvn3urihj7fye.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在键字段中使用自定义宏，因为它们对于模板中的所有数据元素都是相同的。如果网络上的所有网络设备都具有相同的SNMPv3参数，则可以在模板中设置它们；如果主机中的不同监视对象的SNMPv3参数不同，则可以在主机中设置它们：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/f7/ci/bp/f7cibpnkgslkyj7kq8spsekdi2k.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
请注意，监视系统仅具有用于身份验证和加密的用户名和密码。 。在监视对象上设置用户组和允许访问的MIB对象的区域。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在让我们继续填写模板。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zabbix调查模板</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
创建任何调查模板时，一个简单的规则是使它们尽可能详细：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/fh/nc/am/fhncamsfgnhkd-h4dy8px17isq4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我非常注意清单，以便使用大型网络更加方便。</font><font style="vertical-align: inherit;">稍后，但现在-触发：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/g1/4g/mt/g14gmt7flcx9jhv8q8vgjnee4qe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了简化触发器的可视化，它们的名称包含系统宏{HOST.CONN}，因此在警报部分的仪表板上不仅显示设备名称，而且还显示IP地址，尽管这是不必要的便利。为了确定设备的不可用性，除了通常的回显请求之外，当对象可以通过ICMP访问但不响应SNMP请求时，我还使用SNMP主机不可用性检查-这种情况是可能的，例如，在不同设备上复制IP地址时，由于防火墙配置不正确，或监视对象上的SNMP设置不正确。如果仅通过ICMP使用主机访问控制，则在调查网络事件时，监视数据可能不会出现，因此必须控制其接收。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们继续探索网络接口-对于网络设备，这是最重要的监视功能。</font><font style="vertical-align: inherit;">由于网络设备上可能有数百个接口，因此有必要过滤掉不必要的接口，以免影响可视化效果和数据库。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我将SNMP的标准检测功能与大量可检测的参数一起使用，以实现更灵活的过滤：</font></font><br>
<br>
<pre><code class="plaintext hljs">discovery[{#IFDESCR},1.3.6.1.2.1.2.2.1.2,{#IFALIAS},1.3.6.1.2.1.31.1.1.1.18,{#IFADMINSTATUS},1.3.6.1.2.1.2.2.1.7]</code></pre><br>
<img src="https://habrastorage.org/webt/1m/vp/fu/1mvpfu0kalas5i-w-9uyb5-pk3s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过此检测，您可以按网络接口的类型，用户描述“描述”和端口的管理状态来过滤它们。</font><font style="vertical-align: inherit;">在我的情况下，用于过滤的过滤器和正则表达式如下所示：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c1/z_/ym/c1z_ymi8yjcpt-cncmzdfdmynlq.png"><br>
 <br>
<img src="https://habrastorage.org/webt/et/wv/aj/etwvajeuy5h9jwx7bdwyocmhn1c.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
检测到后，将排除以下接口：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">借助IFADMINSTATUS，手动禁用（adminstatus &lt;&gt; 1）；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">感谢IFALIAS，没有文字说明；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">感谢IFALIAS，文字说明中带有*；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">感谢IFDESCR（在我的情况下，在正则表达式中IFALIAS和IFDESCR由一个别名正则表达式检查）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SNMPv3数据收集模板已准备就绪。</font><font style="vertical-align: inherit;">我们将不讨论网络接口数据元素的原型，而是继续研究结果。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">监测结果</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
首先-小型网络清单：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bm/s0/h1/bms0h1txizz1lm_p9bdw3iwyvaa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果为每个系列的网络设备准备了模板-则可以实现一个方便的布局来分析最新软件的摘要数据，序列号以及清洁女工到达服务器的通知（由于正常运行时间较小）。</font><font style="vertical-align: inherit;">我的模板清单摘录如下：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i8/ok/ju/i8okju-_mwfomxxj1quhf1eaifk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在-主仪表板，按严重性级别分布触发器：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rs/cr/-t/rscr-tzx6tnsbpjqqnxwyfhu-qg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于采用了针对网络中每种设备模型的模板的集成方法，因此可以实现在一个监视系统的框架内将组织一个工具来预测故障和事故（如果有合适的传感器和度量标准）。</font><font style="vertical-align: inherit;">Zabbix非常适合监视网络，服务器，服务基础架构，并且为网络设备提供服务的任务清楚地展示了其功能。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用的来源清单：</font></font></b><div class="spoiler_text">1. Hucaby D. CCNP Routing and Switching SWITCH 300-115 Official Cert Guide. Cisco Press, 2014. pp. 325-329.<br>
2. RFC 3410. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">tools.ietf.org/html/rfc3410</a><br>
3. RFC 3415. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">tools.ietf.org/html/rfc3415</a><br>
4. SNMP Configuration Guide, Cisco IOS XE Release 3SE. Chapter: SNMP Version 3. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">www.cisco.com/c/en/us/td/docs/ios-xml/ios/snmp/configuration/xe-3se/3850/snmp-xe-3se-3850-book/nm-snmp-snmpv3.html</a><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN495694/index.html">移动应用参考服务</a></li>
<li><a href="../zh-CN495696/index.html">波斯王子创作者如何克服Apple II的内存限制</a></li>
<li><a href="../zh-CN495698/index.html">图片中的客户端-服务器架构</a></li>
<li><a href="../zh-CN495700/index.html">厄运男孩ESP32</a></li>
<li><a href="../zh-CN495702/index.html">我们研究了Mediastreamer2 VoIP引擎。第1部分</a></li>
<li><a href="../zh-CN495706/index.html">来自世界开放地图505号的新闻（03.17.2020-23.03.2020）</a></li>
<li><a href="../zh-CN495708/index.html">在Centos 8上具有两重授权的Openconnect紧急VPN服务器</a></li>
<li><a href="../zh-CN495712/index.html">我们设定发展目标（不仅限于血腥企业）</a></li>
<li><a href="../zh-CN495716/index.html">关于学习外语的神话</a></li>
<li><a href="../zh-CN495718/index.html">JetBrains和ITMO硕士：我们将继续深入学习并宣布开放日</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>