<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍🔬 🗒️ 🙍🏽 现实世界中的Brotli效率 🤚🏾 🌅 📓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="开发快速网站的最基本规则之一是优化其资源。如果我们正在谈论文本资源-涉及用HTML，CSS和JavaScript编写的代码，则意味着我们正在谈论数据压缩。 用于压缩Web上文本资源的事实上的标准是Gzip方法。即，使用Gzip压缩站点下载期间获得的大约80％的压缩资源。为了压缩其余20％的资源，使用...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>现实世界中的Brotli效率</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/499278/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开发快速网站的最基本规则之一是优化其资源。如果我们正在谈论文本资源-涉及用HTML，CSS和JavaScript编写的代码，则意味着我们正在谈论数据压缩。</font><font style="vertical-align: inherit;">
用于压缩Web上文本资源的事实上的标准是Gzip方法。即，使用Gzip压缩站点下载期间获得的大约80％的压缩资源。为了压缩其余20％的资源，使用了一种更新得多的算法-Brotli。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/f1/0c/go/f10cgoennqxp98xrt8hxus_wkii.jpeg"></a><br>
<br><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当然，当浏览器收到对网站请求的答复时，进入浏览器的这100％压缩资源并不绝对包含所有资源。仍然有许多资源可以压缩，也可以压缩。但是这些资源仍未压缩。有关压缩的更详细指标，可以在</font><font style="vertical-align: inherit;">Web年鉴资源</font><font style="vertical-align: inherit;">的“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://almanac."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">压缩”</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">部分中找到</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gzip压缩方法非常有效。莎士比亚的所有纯文本著作都需要5.3 MB。在进行Gzip压缩（压缩级别6）之后，它们仅占用1.9 MB。这意味着存储该数据的文件大小减少了2.8倍。同时，在压缩过程中数据不会丢失。大！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更好的是，文件中重复行的存在会影响Gzip压缩的程度。文本中重复次数越多，压缩效率越高。这对于Web来说非常好，因为用HTML，CSS和JS编写的代码具有统一的语法并包含许多重复。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，尽管Gzip是一种非常有效的压缩方法，但它也相当古老。它于1992年出现（这当然有助于解释其普遍性）。 21年后的2013年，Google发布了Brotli，这是一种新算法，与Gzip方法相比，它的压缩水平更高。使用Brotli将莎士比亚5.2 MB的相同作品压缩为1.7 MB（压缩级别为6）。这已经意味着文件大小减小了3.1倍。这甚至比使用Gzip更好。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">工具</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">评估使用Gzip和Brotli的数据压缩级别，您可能会发现，压缩某些数据时，Brotli比Gzip效率更高。</font><font style="vertical-align: inherit;">例如，与使用最大压缩级别（9）的Gzip相比，使用最大压缩级别（11）的Brotli进行压缩时，ReactDOM数据要小27％。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是处理ReactDOM时Brotli压缩与Gzip压缩的比较。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">压缩等级</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大小（以字节为单位）</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">压缩效率（与未压缩数据相比）</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">比Gzip改善的百分比</font></font></strong></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1个</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">43456</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.73</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3％</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">39898</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.97</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">十一％</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">39416</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.08</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">十五％</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">38488</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.08</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">十五％</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">36323</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.27</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">十九％</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">36048</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.29</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">二十％</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">35804</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.31</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">二十％</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">35709</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.32</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21％</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">35659</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.33</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21％</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">33590</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.53</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">25％</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">十一</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">33036</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.59</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">27％</font></font></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如您所见，在所有压缩级别，Brotli都会绕过Gzip。在Brotli提供的最大压缩级别下，它的效率比Gzip高出27％。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
而且，根据个人观察，我注意到我的一位客户从Gzip转移到Brotli导致文件大小平均减少了31％。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，在过去的几年中，我与其他性能专家一起一直在鼓励客户从Gzip转到Brotli。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我会说几句关于浏览器对Gzip和Brotli的支持。 Gzip如此广泛，以至于CanIUse甚至不显示带有支持信息的表。它说：“几乎所有浏览器都支持此HTTP标头（从IE6 +，Firefox 2 +，Chrome 1+等开始）。” Brotli在撰写本文时，获得了非常令人愉快的</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">支持。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为93.17％。这是非常非常的！因此，如果您的站点至少具有一定的规模，则可能不希望将未压缩的资源返还给超过6％的用户。但是使用Brotli，您将不会损失任何东西。客户使用支持新算法的渐进模型，因此无法接受Brotli资源的用户将仅使用Gzip形式的后备选项。我们将在下面讨论更多。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常，特别是如果使用CDN，打开Brotli只需几秒钟。</font><font style="vertical-align: inherit;">至少Cloudflare就是这种情况，Cloudflare是我用于CSS Wizardry网站的服务。</font><font style="vertical-align: inherit;">但是，如果我们谈论最近几年，我的许多客户都不是那么成功。</font><font style="vertical-align: inherit;">其中有些支持自己的基础结构，实践表明，安装和部署Brotli并非如此简单。</font><font style="vertical-align: inherit;">有些使用CDN服务，在支持新算法的容易访问的功能上没有区别。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在那些我们无法切换到Brotli的情况下，我们总是有一个未解决的问题：“如果...怎么办”。</font><font style="vertical-align: inherit;">结果，我最终决定用数字武装自己，并回答如何使站点过渡到Brotli的问题。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">少不一定意味着更快。</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，通常“更少”意味着“更快”。</font><font style="vertical-align: inherit;">通常，如果减小文件大小，它将从服务器更快地传输到客户端。</font><font style="vertical-align: inherit;">但是，如果您将文件缩小20％，这并不意味着它将更快地到达20％。</font><font style="vertical-align: inherit;">这里的要点是文件大小只是Web性能的一方面。</font><font style="vertical-align: inherit;">而且，无论文件大小如何，传递给浏览器的资源都与许多其他因素和许多系统限制（网络延迟，数据包丢失等）相关联。</font><font style="vertical-align: inherit;">换句话说，节省文件大小有助于传输与以前相同的数据，发送较少的数据包，但是服务器和客户端之间的数据传输受到网络延迟的限制，结果，到达客户端的数据包较小的速度不会改变。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP，数据包，往返延迟</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果考虑将文件从服务器传输到客户端非常简单，我们将不得不考虑一下TCP协议。当我们从服务器收到文件时，它不会一go而就。 TCP协议可将文件分成称为数据包的段，TCP协议可基于HTTP协议工作。这些数据包按顺序发送到客户端。客户端在开始下一个系列的传输之前，确认该系列中每个数据包的接收。直到客户端收集了所有必要的程序包，直到服务器上没有未发送的程序包，并且直到客户端可以将程序包收集到可以识别为文件的文件中为止。为了使数据包序列传输会话成功完成，服务器必须将它们发送给客户端，并且客户端必须确认其接收。时间，接收数据和接收确认消息所需的数据量称为往返时间（RTT）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个新的TCP连接都无法知道可用带宽是多少，以及连接的可靠性如何（即，丢包的级别是多少）。如果服务器尝试通过支持每秒一兆位数据传输速率的连接发送兆字节的数据，则这种传输将使连接不堪重负，并导致通信通道过载。反之亦然-如果服务器尝试通过非常快速的连接传输少量数据，则该连接将被低效率地使用，它将处于空闲状态。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了解决这个难题，TCP使用了一种称为慢启动的机制。</font><font style="vertical-align: inherit;">这是过载窗口管理策略的一部分。</font><font style="vertical-align: inherit;">每个新的TCP连接都受到以下限制：在第一个数据包序列中只能发送10个数据包（10个数据包-初始拥塞窗口的大小）。</font><font style="vertical-align: inherit;">十个TCP段大约为14 KB数据。</font><font style="vertical-align: inherit;">如果客户端成功接收了这些软件包，则第二个系列将已经包含20个软件包，然后将有40、80、160等。</font><font style="vertical-align: inherit;">数据包在序列中的增长将持续到发生以下事件之一为止：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">系统将面临数据包丢失。</font><font style="vertical-align: inherit;">此时，服务器将按照以下顺序减少数据包数量，将先前的数据包数量除以2，然后尝试再次传输数据。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们已达到可用带宽的极限，可以满负荷使用。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这种简单而优雅的策略可让您在谨慎和乐观的边缘保持平衡。</font><font style="vertical-align: inherit;">它适用于Web应用程序建立的每个新的TCP连接。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
简而言之，新TCP连接的拥塞窗口的初始大小仅为14 Kb。</font><font style="vertical-align: inherit;">约占未压缩ReactDOM数据的11.8％。</font><font style="vertical-align: inherit;">使用Gzip压缩的数据的36.94％，或使用Brotli压缩的数据的42.38％（处于最大压缩级别）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
然后我们放慢速度。</font><font style="vertical-align: inherit;">从11.8％到36.94％的过渡已经是非常明显的进步！</font><font style="vertical-align: inherit;">但是从36.94％到42.38％的过渡-距离如此令人印象深刻。</font><font style="vertical-align: inherit;">发生了什么？</font></font><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据会话号</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个会话中传输的数据量，Kb</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">累计传输数据量，Kb</font></font></strong></td>
<td><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReactDOM数据的传输顺序</font></font></strong></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1个</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">14</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">14</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">28</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">42</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gzip（37.904 Kb），Brotli（33.036 Kb）</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">56</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">98</font></font></td>
<td></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">112</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">210</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未压缩的选件（118.656 Kb）</font></font></td>
</tr>
<tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">224</font></font></td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">434</font></font></td>
<td></td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
事实证明，使用Gzip压缩的数据和使用Brotli压缩的数据都在同一系列的数据包中传输。</font><font style="vertical-align: inherit;">传输文件需要两个序列。</font><font style="vertical-align: inherit;">如果在传输所有序列时RTT相当均匀，则意味着传输使用Gzip和Brotli压缩的数据需要花费相同的时间。</font><font style="vertical-align: inherit;">另一方面，传输未压缩版本的数据需要四个系列的数据包，而不是两个。</font><font style="vertical-align: inherit;">而且，尤其是在具有高网络延迟的连接上，这可能导致数据传输需要相当明显的时间。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我倾向于这样一个事实，即数据传输速度不仅取决于文件大小。它受TCP协议功能的影响。我们不仅需要使文件更小。我们需要使它们更小，使其具有一定的大小，以允许它们以更少的数据包序列进行传输。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从理论上讲，这意味着为了使Brotli算法比Gzip效率更高，它必须能够更加主动地压缩数据。这是必要的，因此与使用Gzip相比，数据可以更少的数据包序列进行传输。而且我不知道该算法将如何发展...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
值得注意的是，上述模型已相当简化。还有许多其他因素需要考虑。例如-是新的还是已经打开的TCP连接？连接是否还用于其他用途？服务器流量优先级划分机制是否停止并开始数据传输？ H / 2流是否具有带宽独占访问权？本节是更认真的研究。应该将其视为您自己研究的一个良好起点。但是，请考虑使用Wireshark之​​类的工具彻底分析数据，并阅读</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">材料，</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">该</font></a><font style="vertical-align: inherit;">材料提供了对“神奇的”前14 Kb的更深入的描述。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以上内容仅适用于全新的TCP连接。</font><font style="vertical-align: inherit;">通过现有连接传输的文件将不会通过慢启动过程。</font><font style="vertical-align: inherit;">这导致我们得出两个重要结论：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我认为不值得重复，但我会重复：静态资源需要托管。</font><font style="vertical-align: inherit;">这是避免启动延迟的好方法，因为使用您自己的，已经“预热”的服务器意味着离开该服务器的数据包可以访问更宽的带宽。</font><font style="vertical-align: inherit;">这个结论使我得出第二个结论。</font></font></li>
<li> ,              ,    .       ,            .    .</li>
</ol><br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><strong>   </strong></td>
<td><strong> ,    , </strong></td>
<td><strong>   , </strong></td>
</tr>
<tr>
<td>1</td>
<td>14</td>
<td>14</td>
</tr>
<tr>
<td>2</td>
<td>28</td>
<td>42</td>
</tr>
<tr>
<td>3</td>
<td>56</td>
<td>98</td>
</tr>
<tr>
<td>4</td>
<td>112</td>
<td>210</td>
</tr>
<tr>
<td>5</td>
<td>224</td>
<td>434</td>
</tr>
<tr>
<td>6</td>
<td>448</td>
<td>882</td>
</tr>
<tr>
<td>7</td>
<td>896</td>
<td>1778</td>
</tr>
<tr>
<td>8</td>
<td>1792</td>
<td>3570</td>
</tr>
<tr>
<td>9</td>
<td>3584</td>
<td>7154</td>
</tr>
<tr>
<td>10</td>
<td>7168</td>
<td>14322</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>20</td>
<td>7340032</td>
<td>14680050</td>
</tr>
</tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在第10次数据传输会话结束时，在一个会话中传输的数据量为7168 Kb，而总共已传输14322 Kb数据。</font><font style="vertical-align: inherit;">对于Internet上的常规工作（即，不用于查看《权力的游戏》），这已经绰绰有余了。</font><font style="vertical-align: inherit;">实际上，通常会发生这样的情况：我们加载整个网页及其所有资源而没有达到带宽限制。</font><font style="vertical-align: inherit;">换句话说，使用1 Gbit / s的光纤通信通道（即0.125 GB / s）将不会使正常浏览比使用较慢的连接快得多，因为该通道的大部分甚至都不会将会被使用。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
到第20次数据传输会话时，理论上我们将以一个数据包序列传输7.34 GB的数据。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">那现实世界呢？</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
到目前为止，我们一直在进行理论上的考虑。</font><font style="vertical-align: inherit;">由于我想了解Brotli对真实网站的影响，所以我开始研究此材料。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
到目前为止，这里给出的数字表明缺乏压缩和使用Gzip之间的巨大差异，以及与Gzip相比，使用Brotli带来的收益是相当小的。</font><font style="vertical-align: inherit;">这告诉我们，从缺乏压缩到使用Gzip的过渡将带来明显的改善，但是从Gzip到Brotli的过渡可能看起来不那么令人印象深刻。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我选择了几个站点作为示例，并遵循以下注意事项：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该站点应该是相对知名的（最好使用可以与某些东西进行比较的站点）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该地点应适合进行测试。</font><font style="vertical-align: inherit;">也就是说-它的大小应该合适（因此，分析其压缩材料会更有趣），同时，其主要不应包含未使用Gzip / Brotli压缩的材料-例如YouTube。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并非馆藏中的所有网站都应该属于大型公司（值得分析一些，例如“常规”网站）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
鉴于这些要求，我</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选择了</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下面列出</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">的</font></a><font style="vertical-align: inherit;">站点并开始测试。</font><font style="vertical-align: inherit;">这是我选择的网站：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m.facebook.com</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.linkedin.com</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.insider.com</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yandex.com</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.esedirect.co.uk</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.story.one</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.cdm-bedrijfskleding.nl</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">www.everlane.com</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我不想使测试复杂化，因此决定采用以下指标：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传输的数据量。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">首次合格油漆（FCP）时间。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在以下情况下对它们进行了分析：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">缺乏压缩。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用gzip。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用brotli。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
FCP指标看起来非常接近现实世界，并且足以应用于任何站点，因为它使您可以评估人们对网站的需求-即这些站点的内容。</font><font style="vertical-align: inherit;">此外，我之所以选择此指标，是因为有</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">才华的Paul Calvano</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这样说：“经验告诉我，使用Brotli可以改善FCP，尤其是在关键CSS / JS资源很大的情况下” 。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试中</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我告诉你一个肮脏的秘密。 Web性能的许多研究（不是全部，而是很多）并不是基于对性能改进的研究，而是基于相反的结论-性能下降。例如，英国广播公司更容易断言：“由于</font><font style="vertical-align: inherit;">每秒钟需要</font><font style="vertical-align: inherit;">花费一</font><font style="vertical-align: inherit;">秒钟的时间，他们</font><font style="vertical-align: inherit;">就会失去</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10％的用户</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”，而不是知道发生了什么。放慢网站速度而不是提高网站速度要容易得多，您会因此而感到很多人干得这么好。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
鉴于此，我没有尝试先下载使用Gzip的网站，然后离线使用Brotli以某种方式压缩其内容。</font><font style="vertical-align: inherit;">相反，我发现了使用Brotli的网站，然后关闭了压缩功能。</font><font style="vertical-align: inherit;">我从Brotli转到Gzip，然后从Gzip转到非压缩，以评估其在网站上的工作方式。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
虽然我不能说能够连接到Linkedin服务器并断开Brotli的连接，但是我可以从不支持Brotli的浏览器简单地访问此站点。</font><font style="vertical-align: inherit;">尽管我无法在Chrome中禁用Brotli支持，但是我可以从服务器中隐藏我的浏览器支持Brotli的事实。</font><font style="vertical-align: inherit;">浏览器使用请求标头告知服务器它们支持哪种压缩算法</font></font><code>content-encoding</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">使用Webpagetest，我可以自己定制标题。</font><font style="vertical-align: inherit;">所以，一切都非常简单！</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3bb/295/390/3bb2953909f7cea0ac8970049f763638.png"></div><br>
<i><font color="#999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebPageTest的高级功能允许我们设置自定义请求标头。</font></font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
这是我设置“自定义标头”字段的方法：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全关闭压缩：</font></font><code>accept-encoding: randomstring</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">禁用Brotli，但Gzip已支持：</font></font><code>accept-encoding: gzip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果站点支持该压缩方法（并在浏览器支持的情况下），则要使用Brotli：该字段保持为空。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以通过检查</font></font><code>content-encoding</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务器响应</font><font style="vertical-align: inherit;">中标头的存在（或不存在）来确定这是否按预期工作</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不出所料，从缺乏压缩到Gzip的过渡意味着重大改进，但是从Gzip到Brotli的过渡看起来并不那么令人印象深刻。</font><font style="vertical-align: inherit;">我的实验原始数据可以在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这里</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">找到</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">以下是我最感兴趣的发现：</font></font><br>
<br>
<ul>
<li>     Gzip     : 73%.</li>
<li>  FCP   Gzip     : 23.305%.</li>
<li>     Brotli    Gzip: 5.767%.</li>
<li>  FCP   Brotli    Gzip: 3.462%.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这些都是中值。</font><font style="vertical-align: inherit;">说到“材料尺寸”，我的意思是仅HTML，CSS和JavaScript。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于使用了Gzip，与未压缩版本相比，文件大小减少了73％。</font><font style="vertical-align: inherit;">使用Brotli只能将文件大小再减少5.7％。</font><font style="vertical-align: inherit;">如果我们谈论FCP，则由于缺少Gzip，该指标比没有压缩的指标提高了23％，而Brotli仅对此增加了3.5％。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尽管这些结果似乎加强了理论，但仍有几种方法可以改善这些结果。</font><font style="vertical-align: inherit;">首先是测试更多的站点，我想更详细地讨论两个站点。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自己的资源数据和来自外部来源的数据</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在测试中，我在所有地方都关闭了Brotli，而不仅仅是关闭了存储站点数据的服务器。</font><font style="vertical-align: inherit;">这意味着我不仅衡量了站点从使用Brotli所获得的收益，而且还就潜在性而言，衡量了Brotli从这些站点所使用的外部资源中获得的收益。</font><font style="vertical-align: inherit;">仅当在调查站点的关键方式中使用第三方资源时，这才属于我们关注的范围，但这值得记住。</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">压缩等级</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
说到压缩，我们经常讨论使用最佳压缩应用方案获得的结果。即-使用Gzip时，我们要记住第9级压缩，而使用Brotli时，请注意第11级压缩。但是，不可能以最佳方式配置被调查服务器。例如，Apache使用6级gzip压缩，而NGINX仅使用第一种。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
禁用Brotli意味着我们将切换到fallback选项，切换到Gzip，并且鉴于我测试站点的方式，我无法更改此类fallback配置或以某种方式对其进行操作。我之所以这样说是因为在打开Brotli时，测试中两个站点的材料实际上在增加大小。这向我表明，Gzip压缩级别比Brotli压缩级别提供了更强的压缩。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
选择压缩级别是一个折衷方案。</font><font style="vertical-align: inherit;">每个人都想问一下最高的压缩程度，并在此基础上考虑解决的问题。</font><font style="vertical-align: inherit;">但是这种方法是不切实际的。</font><font style="vertical-align: inherit;">事实是，服务器动态执行此压缩所需的额外时间很可能会抵消更高压缩级别的好处。</font><font style="vertical-align: inherit;">为了解决此问题，您可以采取以下措施：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以使用务实的压缩级别，以在动态数据压缩期间提供速度和效率之间的适当平衡。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以将预压缩的静态资源上载到服务器，其压缩级别高于动态压缩所使用的级别。</font><font style="vertical-align: inherit;">在这种情况下，要选择动态压缩级别，可以使用第一段中概述的想法。</font></font></li>
</ol><br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">摘要</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一个人的印象是，明智地推理，可以认识到Brotli相对于Gzip的优势微不足道。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果在CDN的控制面板中通过几次鼠标移动即可启用Brotli支持，则应立即拿起Brotli并将其打开。对这种压缩算法的支持足够广泛，不支持Brotli的浏览器很容易切换到备用机制，即使有一点改进也总比没有好。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果可能，将以最大压缩级别预压缩的静态资源上载到服务器。对于动态压缩，请不要使用最高压缩级别，而请使用最低压缩级别。如果您使用NGINX，请确保您没有使用NGINX的标准第一级压缩。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，如果要使用Brotli，您可能需要数周的开发，测试和部署，而不必惊慌-只需确保对所有可压缩的内容都使用Gzip压缩（除文本资源外，还包括文件.ico和.ttf-当然，如果您的项目中使用了它们。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我想这篇文章的简短版本可能是这样的：如果您不应该或者不能启用Brotli，那么您并不会损失太多。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">亲爱的读者们！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您打算使用Brotli吗？</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/iq/fi/b4/iqfib45pgphfrxv--zfemt0qnmw.jpeg"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN499254/index.html">PyConRu 2020计划委员会成员回答有关Python的问题：最新外观和一些parseltang</a></li>
<li><a href="../zh-CN499262/index.html">个体经营的SMZhack的最终在线黑客马拉松：将吸引人们的项目</a></li>
<li><a href="../zh-CN499268/index.html">空间意识：Hololens眼镜可以做什么？</a></li>
<li><a href="../zh-CN499272/index.html">焊接组件0201。紧张，请移开屏幕</a></li>
<li><a href="../zh-CN499274/index.html">我们拆解了新的胶囊。我们知道有多少个麦克风及其工作原理</a></li>
<li><a href="../zh-CN499280/index.html">JavaScript框架的价格</a></li>
<li><a href="../zh-CN499286/index.html">研究：黑市中企业网络访问权交易正在增长</a></li>
<li><a href="../zh-CN499288/index.html">支持与冠状病毒有关的业务的所有措施。第1部分</a></li>
<li><a href="../zh-CN499290/index.html">如何为大公司编写信息安全技术标准</a></li>
<li><a href="../zh-CN499296/index.html">演示用英语（结构，短语，问答，语法，技巧）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>