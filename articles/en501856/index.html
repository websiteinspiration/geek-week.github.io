<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÅ üé© üîÜ Tarantool: Analyst Look üëêüèª üë©‚Äç‚öïÔ∏è üë•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone! My name is Andrey Kapustin. I work as a systems analyst at Mail.ru Group. Our products form a single ecosystem for the user, in which ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Tarantool: Analyst Look</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/501856/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone! </font><font style="vertical-align: inherit;">My name is Andrey Kapustin. </font><font style="vertical-align: inherit;">I work as a systems analyst at Mail.ru Group. </font><font style="vertical-align: inherit;">Our products form a single ecosystem for the user, in which data generates many independent infrastructures: taxi and food ordering services, mail services, social networks. </font><font style="vertical-align: inherit;">Today, the faster and more accurately we can predict the customer's need, the faster and more accurately we can offer him our products. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Many system analysts and engineers are now asking questions:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to design a trigger platform architecture for real-time marketing?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to organize a data structure that meets the requirements of a marketing strategy for interacting with customers?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to ensure stable operation of such a system under very high loads? </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These systems are based on high-load processing and analysis of big data. </font><font style="vertical-align: inherit;">We have gained considerable experience in these areas. </font><font style="vertical-align: inherit;">And as an example of one real story, I‚Äôll tell you about our approach to analytics and development of solutions in the field of Real-time Marketing using Tarantool.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once a large telecom operator came to us for help. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The task was this:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have more than 100 million subscribers. </font><font style="vertical-align: inherit;">We know a lot about them: current balance, traffic volume, connected services, trips, favorite places. </font><font style="vertical-align: inherit;">We use the information as we can: we collect data during the day, put huge amounts of information in the repository (DataLake). </font><font style="vertical-align: inherit;">We start handlers at night, in the morning we create advertising campaigns and send out offers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And we want to do the same thing in real time!</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why? </font><font style="vertical-align: inherit;">Because the faster the telecom operator processes the information, the more money they can earn. </font><font style="vertical-align: inherit;">For example, on impulse purchases: a user walks past a cafe at lunchtime, and then a discount comes to his phone so that he chooses this particular cafe. </font><font style="vertical-align: inherit;">That is, you need to "just" offer the right product at the right time and help immediately respond to the offer in a convenient way. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ov/lj/jk/ovljjkmaaevszjc-pcd55q_wjw8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What you need to solve a business problem:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can determine the need through the customer profile. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Determine the moment - according to human life events. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stimulate feedback - choosing the optimal communication channel.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is called Real-Time Marketing. </font><font style="vertical-align: inherit;">With regard to the telecom sector, sending relevant personalized messages to subscribers at the right time with the ability to IMMEDIATELY respond to an offer. </font><font style="vertical-align: inherit;">Proposals can be formed both for the target group and for a specific user, while the request should be processed real-time in any case. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
From a technical point of view, we must solve the following problems:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keeping up-to-date data of more than 100 million subscribers; </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Real-time event flow processing at a load of 30,000 RPS;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formation and routing of targeted offers to subscribers with the fulfillment of non-functional requirements (response time, availability, etc.);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seamless connection of new sources of heterogeneous data by subscribers. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
‚ÄúReal time‚Äù in this case means processing information in 30 seconds. </font><font style="vertical-align: inherit;">It‚Äôs pointless longer, the moment is missed, the client is gone. </font><font style="vertical-align: inherit;">And the saddest thing is that in such a situation it will not be clear why (?) - did we propose the wrong thing or didn‚Äôt manage in time? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Getting the answer to this question is very important for product development:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Marketing promotion of your products: test hypotheses, increase revenue.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We attract potential customers: we invest in advertising, we capture the market.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We connect additional services or services: we expand the product line.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It‚Äôs easy to make mistakes at every stage. </font><font style="vertical-align: inherit;">And the price of error is great. </font><font style="vertical-align: inherit;">We must beat quickly and accurately! </font><font style="vertical-align: inherit;">And for this, customer information must be complete and current. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this case, the information is really worth the money! </font></font></strong><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After all, the more we know about our customers, the more we will earn. </font><font style="vertical-align: inherit;">This means that adding each new parameter to the client profile increases the accuracy of targeting. </font><font style="vertical-align: inherit;">But this is an ongoing process because:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The customer base is constantly growing.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The range of services is expanding.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In such conditions, it is very effective to segment the customer base. In this case, it was decided to use the stratification mechanism - multivariate classification of subscribers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simply put, we distinguish specific groups of subscribers (strata) by ranges of values ‚Äã‚Äãof an unlimited number of attributes. In this case, the subscriber should automatically change the stratum immediately upon transition of the attribute value to the corresponding range. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The figure below is an example of a three-dimensional model of stratification from childhood. A ball is a subscriber. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/n-/kz/dj/n-kzdji4x9ybrmslvmopitqn4ww.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For each client, we can calculate how much they spent on attracting him, how much they earned and how. That is, we know </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how much information costs</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and how much we lose if we do not update it.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They counted and decided - it is necessary to update! And immediately problems arise: there is always something missing. In each project, new requirements come from the customer that contradict TK, architecture, each other and ... common sense. Maintaining data integrity and relevance is becoming more difficult every day. New sources of information appear with new attributes that are unclear where to store and how to process. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It should be borne in mind that the more </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">normalized</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data, the more restrictions, directories, checks in them. Anyone who tried to add a couple of fields to the table ‚Äúon the go‚Äù knows what kind of ‚Äúpainter‚Äù this is: it does not fit into the current data model! And how can the customer explain that if you add a new field, you will have to rewrite half of the project code ?! We ‚Äúcollapse‚Äù or ‚Äúdiscard‚Äù the ‚Äúextra‚Äù analytics at the entrance, and as a result we cannot form relevant offers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Western colleagues call this effect ‚ÄúShit in - Shit out.‚Äù </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, data takes up more space and is more difficult to process. With the increase in the amount of information, this becomes critical, because transaction processing speed decreases. And our goal is to process each request for no more than a minute with a load of 30,000 requests per second. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Conclusion: for real-time marketing, normalization</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not suitable</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for 100+ million subscribers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We arrived at a solution in the form of a universal customer profile. </font><font style="vertical-align: inherit;">It lies in the key-value storage, so we can not fix the data structure. </font><font style="vertical-align: inherit;">Each column is a key and value, which can be anything. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We got a combination of:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Static attributes that are rarely updated (name, passport, address). </font><font style="vertical-align: inherit;">Mandatory block with ID.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And a dynamic tail of arbitrary length ‚Äî often updated data that depends on the source. </font><font style="vertical-align: inherit;">Several independent blocks for each source.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This approach is called denormalization. </font><font style="vertical-align: inherit;">How convenient is it?</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ‚Äútail‚Äù may </font><strong><font style="vertical-align: inherit;">not</font></strong><font style="vertical-align: inherit;"> be </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validated.</font></font></strong></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We save the "raw" data as is without processing.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We save all incoming information, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we lose nothing.</font></font></strong></li>
<li>      ID ,    .</li>
<li>   (  2-3 ),      .</li>
<li>   :         .</li>
</ol><br>
<h2> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now you need to select a tool for implementation. This is usually done by the architect according to the requirements that the analyst assembled. It is very important to find out the NFT - the expected amount of data and the level of load. It depends on what methods of data storage and processing we will use. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The heading of this chapter hints that our service will process a lot of data. And a lot - how much? Let's figure it out. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Data can be considered large if the relationship is not visible to them with the naked eye. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We process more than 100 million different customer profiles that contain unstructured information, are often updated and used - this is real big data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You need to cache current customer profiles. Without storing hot data in RAM, real-time processing cannot be achieved.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">High load</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now we will deal with the load intensity, that is, with the number of requests. </font><font style="vertical-align: inherit;">The term "high load" is used to describe situations when the equipment ceases to withstand the load. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We process different types of events that occur continuously with an intensity of 10 to 30 thousand requests per second. </font><font style="vertical-align: inherit;">In this case, complex business logic is used, and the reaction speed is critical. </font><font style="vertical-align: inherit;">Obviously, we are designing a highly loaded service, which should dynamically scale depending on the instant load.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarantool as an accelerator</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We at Mail.ru Group use Tarantool to solve such problems. </font><font style="vertical-align: inherit;">On Habr√© a lot has been said about how it is built ‚Äúunder the hood‚Äù, I won‚Äôt repeat it, I‚Äôll recall only the main points: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tarantool is an In-memory DBMS and application server in one bottle. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When working with a large amount of data, it is advisable to use it in two ways:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a data showcase for caching information in RAM for the sake of speeding up access. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As an application server for processing data according to specified rules. </font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, the business logic is stored next to the data, which is vital for highly loaded services. </font><font style="vertical-align: inherit;">In our project, we used Tarantool as a ‚Äúsmart‚Äù data storefront with built-in business logic, according to which on-the-fly processing of the incoming stream of events and information takes place. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why Tarantool is effective for RTM:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hot data caching. </font><font style="vertical-align: inherit;">The client profile is cached in memory, so it is always up to date.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Complex real-time computing. </font><font style="vertical-align: inherit;">Personal offers to clients are formed in real time for each event.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fault tolerant and scalable solution:</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two obvious risks in our project: </font></font><br>
<br>
<ol>
<li>        ,              .     <strong></strong> ‚Äî     Tarantool c   ,       . </li>
<li>    ,   .               ,          .  ,          .    ,          .      <strong></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, i.e. </font><font style="vertical-align: inherit;">distribute 100 million records of the client profile table between several shards in order to parallelize query processing and thus reduce the load on the record. </font><font style="vertical-align: inherit;">The simplest example is to divide the customer profile table by the range of ID values. </font><font style="vertical-align: inherit;">To solve this problem, Tarantool provides horizontal scaling tools, more about which can be found in, for example, the article ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarantool Cartridge: sharding Lua backend in three lines</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù.</font></font></li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tarantool does not replace Oracle or other analytic repositories. </font><font style="vertical-align: inherit;">At the same time, it is effective for processing a large amount of data in real time. </font><font style="vertical-align: inherit;">We have successfully solved the customer‚Äôs task within the agreed terms and project budget, so I recommend experimenting with this tool when creating highly loaded services.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501844/index.html">How I stopped being afraid and wrote a game bot</a></li>
<li><a href="../en501846/index.html">How to choose a video surveillance system</a></li>
<li><a href="../en501848/index.html">I explain the reservation in the data center on beer</a></li>
<li><a href="../en501850/index.html">We disassemble EM-algorithm into small bricks</a></li>
<li><a href="../en501854/index.html">How to quit programming and start performing</a></li>
<li><a href="../en501858/index.html">Putting all the dots on the "psi"</a></li>
<li><a href="../en501860/index.html">May 15 RU-Center may add you a paid service without your participation</a></li>
<li><a href="../en501862/index.html">Flutter under the hood</a></li>
<li><a href="../en501864/index.html">Assistant or inspector: for whom is the robot calling?</a></li>
<li><a href="../en501866/index.html">How many jobs robots will destroy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>