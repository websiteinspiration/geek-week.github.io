<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê† üõ∞Ô∏è üïó Opening ports 4321 and 9898 on Xiaomi Gateway 2 üçΩÔ∏è üì∂ ‚óªÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction
 Resting on New Year's holidays, I got excited about the idea of ‚Äã‚Äãcreating a ‚ÄúSmart Home‚Äù. Among the "popular" ecosystems, the most popu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Opening ports 4321 and 9898 on Xiaomi Gateway 2</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487768/"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resting on New Year's holidays, I got excited about the idea of ‚Äã‚Äãcreating a ‚ÄúSmart Home‚Äù. Among the "popular" ecosystems, the most popular due to the cheapness and abundance of all kinds of connected devices seemed to me a solution from Xiaomi. Immediately abandoning the management of my house through Chinese servers (possible delays, security and binding to devices of the same manufacturer), I began to study all kinds of smart home control systems and select compatible equipment for them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After hours of searching, I decided that the Home Assistant is right for me. I decided to build everything at the initial stage using the Raspberry Pi 4 Model B (2GB) and sensors from Xiaomi. Having bought a gateway (you need a version with the article </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">number DGNWG02LM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and turning on the LAN communication protocol, I was faced with the fact that ports 4321 and 9898, which are necessary for integration into the Home Assistant, still remained closed.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You could </font><b><font style="vertical-align: inherit;">verify</font></b><font style="vertical-align: inherit;"> this through </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nmap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> using the command </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nmap -sU -Pn &lt;Gateway IP&gt; -p 9898,4321,54321</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ta/rh/hl/tarhhleh9pcv7fmpaebftwvciuq.png" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this article I will describe how to open these ports and what it will take.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Training</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I'm not sure that you can post links to specific stores, so I‚Äôll only indicate the prices at which I bought everything I needed in Moscow. </font><font style="vertical-align: inherit;">We will need:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">U6 screwdriver head (aka SP6) - 36 rubles</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USB-to-TTL converter based on CH340 - 84 rubles</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connecting cable mom-dad - you need at least 3 pieces, but I took a set of 40 pieces for 110 rubles</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Soldering iron - I had :)</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getting to the fun part</font></font></h4><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You carry out all further actions at your own risk. Opening the gateway will void your warranty.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The first step is to remove the three rubber pads that cover the screws. The pads are not glued, just pry them with something thin: I used a knife. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/zf/bi/qs/zfbiqsiq4yzt6xqk4rjwgerodcm.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Under one of the pads there will be a warranty seal. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is the point of no return</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unscrewing the screws, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gently</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> open the gateway. In its upper part there is a speaker connected by wires to the board on the lower part. We disconnect the wires so that nothing interferes. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/od/zu/6d/odzu6db1a8_ky6wic1lrtnfxunw.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You need to solder three cables to the gateway board. With two points everything is clear, the third is on the side of the button. Places are indicated in the picture: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/h5/-x/1v/h5-x1vvavmnokro2iojyysyn76q.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We get something like this:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_a/g0/he/_ag0hesnmhhb2e7zk9hs1g4d-tg.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The next step is to configure the connection for the converter. </font><font style="vertical-align: inherit;">We remove the jumpers from the converter (when I bought it, it stood on VCC and 3V3), we connect it to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USB 2.0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> port </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On Windows 10, the drivers loaded themselves, a connection on the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COM3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> port appeared in the device manager </font><font style="vertical-align: inherit;">(remember it, it will come in handy later). </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ar/iw/ew/ariwewaznpdg4oothlkls-mogl8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the properties of our device, go to the "Port Settings" tab and change the values:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Bit per second" at </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">115200</font></font></b></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Flow Control" to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Just in case, you can check the screenshot: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/df/g0/dr/dfg0drfos-u5pbh2t2nj_rpihx4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the configuration of the converter we are done, we pull it out of the USB port. We proceed to the connection of the gateway: we connect its </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> converter, and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We </font></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do not connect the </font></font></b><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">RX</font></b><font style="vertical-align: inherit;"> gateway yet </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Plug the gateway into a power outlet. If everything is done correctly, it will start flashing blue. We wait for the full download (blinking will stop) and connect the converter </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to the same USB port</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as at the setup stage. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Run PuTTY as administrator. In the "Session" section, change the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Connection type"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Serial</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In the fields </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Serial line"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúSpeed‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> indicate the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">port</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that we remembered earlier (in my case - COM3), and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">115200</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d_/sc/lb/d_sclb65priuudogh09janyh8dg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the ‚ÄúSerial‚Äù section, check that our COM port is specified, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúSpeed ‚Äã‚Äã(baud)‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">115200</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúFlow control‚Äù</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">none</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/vh/c3/hh/vhc3hh2c3gdi4lzmmereg-hdtqo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We return to the "Session" section and connect to the gateway. If everything was done correctly, readable text will appear in the console. It looked like this for me: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/tw/aa/nj/twaanjonw54dshlwypcamd71lro.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need to connect the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gateway to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TX</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> converter. There should be no errors in the console. Readable text continued to appear, this time in JSON format. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enter the </font><b><font style="vertical-align: inherit;">psm-set network.open_pf 3</font></b><font style="vertical-align: inherit;"> command</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and press Enter. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In some videos and articles that I followed, it is written that some answer should appear in the console. </font><font style="vertical-align: inherit;">After entering the command, I waited about a minute, but there was no answer. </font><font style="vertical-align: inherit;">In the console, only occasionally flashed new entries. </font><font style="vertical-align: inherit;">Therefore, just in case, I tried three other options for the command:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">psm-get network open_pf 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (space instead of </font><b><font style="vertical-align: inherit;">period</font></b><font style="vertical-align: inherit;"> )</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># psm-get network.open_pf 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (after any entry in the console, press Enter, so that # appears, and write the command)</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># psm-get network open_pf 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (analogous to the previous one, but with a space)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After four attempts to answer, I did not wait and decided to check if the ports were open. </font><font style="vertical-align: inherit;">To do this, turn off the converter and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reboot the</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gateway by pulling it out of the socket. </font><font style="vertical-align: inherit;">Without connecting the converter to the computer, turn on the gateway and wait for the download. </font><font style="vertical-align: inherit;">After that, use the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nmap</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><b><font style="vertical-align: inherit;">-sU -Pn &lt;Gateway IP&gt; -p 9898,4321,54321 to</font></b><font style="vertical-align: inherit;"> check the ports. </font><font style="vertical-align: inherit;">In my case, they were open!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9y/lx/pf/9ylxpfv2a9zr_pbupu5s-hodjvs.png" alt="image"></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487750/index.html">Some subtleties of injection collections in Spring</a></li>
<li><a href="../en487752/index.html">Optimize storage: a case of unification and lower cost of ownership</a></li>
<li><a href="../en487754/index.html">Organization of the intranet (automation of IT production). Part 1 - Users and Mail</a></li>
<li><a href="../en487756/index.html">RIT, Maxim Lapshin (Erlyvideo): how a programmer to grow a company</a></li>
<li><a href="../en487764/index.html">I am 14 and I combine school with work in IT</a></li>
<li><a href="../en487772/index.html">Meet the Chuvash language in Yandex.Translate: how we solve the main problem of machine translation</a></li>
<li><a href="../en487774/index.html">SQL Server Date and Time Errors</a></li>
<li><a href="../en487776/index.html">Microsoft Azure Training Day: Server Infrastructure Migration (registration completed)</a></li>
<li><a href="../en487780/index.html">Vulnerability Management - more: management or vulnerabilities?</a></li>
<li><a href="../en487782/index.html">How I got rid of a thousand tabs ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>