<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüíª üñêüèº üíâ Think carefully before using Docker-in-Docker for CI or test environment. üõ∏ üëΩ ‚ô®Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Docker-in-Docker is a virtualized Docker daemon running in the container itself to build container images. The main goal of creating Docker-in-Docker ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Think carefully before using Docker-in-Docker for CI or test environment.</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/488536/"><img src="https://habrastorage.org/webt/8j/ln/oq/8jlnoqfosyog1s4rp7hh43ppq1g.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Docker-in-Docker is a virtualized Docker daemon running in the container itself to build container images. </font><font style="vertical-align: inherit;">The main goal of creating Docker-in-Docker was to help develop Docker itself. </font><font style="vertical-align: inherit;">Many people use it to run Jenkins CI. </font><font style="vertical-align: inherit;">At first this seems normal, but then there are problems that can be avoided by installing Docker in the Jenkins CI container. </font><font style="vertical-align: inherit;">This article describes how to do this. </font><font style="vertical-align: inherit;">If you are interested in the final solution without details, just read the last section of the article "Solving the problem."</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tv/dz/cs/tvdzcsek7ynpcid8mzaiivsi-f8.jpeg"><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker-in-Docker: Good</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
More than two years ago, I inserted the </font><font style="vertical-align: inherit;">‚Äìprivileged </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flag</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Docker </font><font style="vertical-align: inherit;">and wrote the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first version of dind</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The goal was to help the core team develop Docker faster. </font><font style="vertical-align: inherit;">Before Docker-in-Docker, a typical development cycle was like this:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hackity hack;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assembly</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stopping a running docker daemon;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">launch a new docker daemon;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">testing;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop repeat.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you wanted to make a beautiful, reproducible assembly (that is, in a container), then it became more intricate:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hackity hack;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">make sure that a working version of Docker is running;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">build a new docker with an old docker;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stop the docker daemon;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">launch a new docker daemon;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to test;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stop the new Docker daemon;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repeat.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With the advent of Docker-in-Docker, the process has been simplified:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hackity hack;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assembly + launch in one step;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop repeat.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isn't that much better?</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dk/ur/cc/dkurccpm4cvwazgfz69gvmfaep4.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker-in-Docker: Bad</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, contrary to popular belief, Docker-in-Docker is not 100% composed of stars, ponies, and unicorns. </font><font style="vertical-align: inherit;">I mean, there are several issues that a developer needs to know about.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of them concerns LSM (Linux security modules), such as AppArmor and SELinux: when the container starts, the ‚Äúinternal Docker‚Äù may try to apply security profiles that will conflict or confuse the ‚Äúexternal Docker‚Äù. </font><font style="vertical-align: inherit;">This is the most difficult problem that needed to be solved when trying to combine the original implementation of the ‚Äìprivileged flag. </font><font style="vertical-align: inherit;">My changes worked, and all tests would pass on my Debian machine and Ubuntu test virtual machines too, but they would crash and burn on Michael Crosby's machine (as far as I remember, he had Fedora). </font><font style="vertical-align: inherit;">I can‚Äôt remember the exact cause of the problem, but it may have come about because Mike is a wise person who works with SELINUX = enforce (I used AppArmor) and my changes did not take SELinux profiles into account.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker-in-Docker: Angry</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The second problem is related to Docker storage drivers. When you launch Docker-in-Docker, the external Docker runs on top of the regular file system (EXT4, BTRFS or whatever you have), and the internal Docker runs on top of the write-to-copy system (AUFS, BTRFS, Device Mapper, etc.). , depending on what is configured to use an external Docker). In this case, there are many combinations that will not work. For example, you cannot run AUFS on top of AUFS.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you run BTRFS on top of BTRFS, this should work first, but as soon as the subkeys appear, the parent subvolume cannot be deleted. The Device Mapper module does not have a namespace, so if several Docker instances use it on the same machine, they can all see (and influence) the images on each other and on the container backup devices. This is bad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are workarounds to solve many of these problems. For example, if you want to use AUFS in the internal Docker, just turn the / var / lib / docker folder into one and everything will be fine. Docker added some basic namespaces to the target names of the Device Mapper, so that if multiple Docker calls are made on the same machine, they will not ‚Äústep‚Äù against each other.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, this setup is far from simple, as you can see from these </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">articles</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the dind repository on GitHub.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Docker-in-Docker: getting worse</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What about the build cache? This can also be quite difficult. People often ask me ‚Äúif I am running Docker-in-Docker, how can I use the images located on my host, instead of pulling everything back in my internal Docker‚Äù? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Some enterprising people tried to bind / var / lib / docker from the host to the Docker-in-Docker container. Sometimes they share / var / lib / docker with multiple containers. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jj/sw/jf/jjswjfxpobox6znhjyje0-kkrwi.jpeg"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Want to corrupt data? Because this is exactly what will damage your data!</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The docker daemon was clearly designed to have exclusive access to / var / lib / docker. Nothing else should ‚Äútouch, poke or touch‚Äù any Docker files in this folder.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why is this so? Because it is the result of one of the most difficult lessons learned from developing dotCloud. The dotCloud container engine worked with several processes accessing / var / lib / dotcloud at the same time. Tricky tricks, such as atomic file replacement (instead of editing in place), "perching" the code with advisory and mandatory locks, and other experiments with secure systems such as SQLite and BDB, did not always work. When we redesigned our container engine, which eventually turned into Docker, one of the main design decisions was to collect all container operations under a single daemon to do away with all this nonsense of simultaneous access.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not get me wrong: it is quite possible to do something good, reliable and fast, which will include several processes and modern parallel control. But we think it's simpler and easier to write and maintain code using Docker as the only player. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means that if you share the / var / lib / docker directory between multiple Docker instances, you will have problems. Of course, this may work, especially in the early stages of testing. ‚ÄúListen, Ma, I can run ubuntu as a docker!‚Äù But try to do something more complex, for example, pull out the same image from two different instances, and you will see how the world burns.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means that if your CI system performs assemblies and reassemblies, then every time you restart the Docker-in-Docker container, you run the risk of dropping a nuclear bomb into its cache. </font><font style="vertical-align: inherit;">This is not cool at all!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solution to the problem</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's take a step back. Do you really need a Docker-in-Docker or just want to be able to run Docker, namely build and run containers and images from your CI system, while this CI system itself is in the container? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I bet most people need the latter option, that is, they want a CI system like Jenkins to run containers. And the easiest way to do this is to simply insert the Docker socket into your CI container, associating it with the -v flag. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simply put, when you launch your CI container (Jenkins or another), instead of hacking something with Docker-in-Docker, start it from the line:</font></font><br>
<br>
<pre><code class="plaintext hljs">docker run -v /var/run/docker.sock:/var/run/docker.sock ...</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now this container will have access to the Docker socket and, therefore, will be able to launch containers. Except that instead of launching ‚Äúchild‚Äù containers, it will run ‚Äúrelated‚Äù containers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Try this using the official docker image (which contains the Docker binary):</font></font><br>
<br>
<pre><code class="plaintext hljs">docker run -v /var/run/docker.sock:/var/run/docker.sock \<font></font>
           -ti docker</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It looks and works like a Docker-in-Docker, but it‚Äôs not a Docker-in-Docker: when this container creates additional containers, they will be created in top-level Docker. </font><font style="vertical-align: inherit;">You will not experience the side effects of nesting, and the build cache will be shared across multiple calls. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note: previous versions of this article advised binding the Docker binary from the host to the container. </font><font style="vertical-align: inherit;">This has now become unreliable, as the Docker mechanism no longer extends to static or almost static libraries. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thus, if you want to use the Docker from Jenkins CI, you have 2 options: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
installing the Docker CLI using the basic image packaging system (that is, if your image is based on Debian, use the .deb packages), using the Docker API.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A bit of advertising :)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for staying with us. Do you like our articles? Want to see more interesting materials? Support us by placing an order or recommending to your friends, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cloud VPS for developers from $ 4.99</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unique analog of entry-level servers that was invented by us for you: </font></font></b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The whole truth about VPS (KVM) E5-2697 v3 (6 Cores) 10GB DDR4 480GB SSD 1Gbps from $ 19 or how to divide the server?</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (options are available with RAID1 and RAID10, up to 24 cores and up to 40GB DDR4). </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R730xd 2 times cheaper at the Equinix Tier IV data center in Amsterdam?</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Only we have </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV from $ 199</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the Netherlands!</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - from $ 99! </font></font></b></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read about</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> How to Build Infrastructure Bldg. </font><font style="vertical-align: inherit;">class c using Dell R730xd E5-2650 v4 servers costing 9,000 euros for a penny?</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488520/index.html">Bloopers and squiggles. 2</a></li>
<li><a href="../en488522/index.html">JOOQ and his rabbit hole. How to survive without hibernate</a></li>
<li><a href="../en488528/index.html">Using PKCS # 11 cryptographic token mechanisms on the Android platform</a></li>
<li><a href="../en488530/index.html">What is reactivity?</a></li>
<li><a href="../en488534/index.html">DIY UV lamp 400-405 nm for polymerization of 3D photopolymer models</a></li>
<li><a href="../en488540/index.html">Gauss gun</a></li>
<li><a href="../en488544/index.html">Remove code coverage from an already running Node.JS application</a></li>
<li><a href="../en488546/index.html">Hack The Box. JSON walkthrough. Vulnerability in Json.Net and LPE via SeImpersonatePrivilege</a></li>
<li><a href="../en488548/index.html">Experiment: how to learn to create popular texts in English (and why the English-speaking Habrists read so little)</a></li>
<li><a href="../en488550/index.html">Who wants to make cooperatives out of IT giants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>