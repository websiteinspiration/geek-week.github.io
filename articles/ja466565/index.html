<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ“™ ğŸµ ğŸ² Python + OpenCV + Kerasï¼š30åˆ†ã§ãƒ†ã‚­ã‚¹ãƒˆèªè­˜ ğŸ¤›ğŸ» ğŸ‘˜ ğŸšŸ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ã“ã‚“ã«ã¡ã¯Habrã€‚
 
 ã‚ˆãçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹60,000ã®æ‰‹æ›¸ãæ•°å­—MNISTã‚’å®Ÿé¨“ã—ãŸå¾Œã€é¡ä¼¼ã—ãŸä½•ã‹ãŒã‚ã‚‹ã‹ã©ã†ã‹ã€ã—ã‹ã—æ•°å­—ã ã‘ã§ãªãæ–‡å­—ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã¨ã„ã†è«–ç†çš„ãªç–‘å•ãŒç”Ÿã˜ã¾ã—ãŸã€‚çµå±€ã®ã¨ã“ã‚ã€ã”å­˜çŸ¥ã®ã‚ˆã†ã«ã€Extended MNISTï¼ˆEMNISTï¼‰ãŒå­˜åœ¨ã—ã€ãã®ã‚ˆã†ãªãƒ™ãƒ¼...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Python + OpenCV + Kerasï¼š30åˆ†ã§ãƒ†ã‚­ã‚¹ãƒˆèªè­˜</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466565/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã‚“ã«ã¡ã¯Habrã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã‚ˆãçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹60,000ã®æ‰‹æ›¸ãæ•°å­—MNISTã‚’å®Ÿé¨“ã—ãŸå¾Œã€é¡ä¼¼ã—ãŸä½•ã‹ãŒã‚ã‚‹ã‹ã©ã†ã‹ã€ã—ã‹ã—æ•°å­—ã ã‘ã§ãªãæ–‡å­—ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã¨ã„ã†è«–ç†çš„ãªç–‘å•ãŒç”Ÿã˜ã¾ã—ãŸã€‚çµå±€ã®ã¨ã“ã‚ã€ã”å­˜çŸ¥ã®ã‚ˆã†ã«ã€Extended MNISTï¼ˆEMNISTï¼‰ãŒå­˜åœ¨ã—ã€ãã®ã‚ˆã†ãªãƒ™ãƒ¼ã‚¹ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
èª°ã‹ãŒã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½¿ã„æ–¹ã«èˆˆå‘³ãŒã‚ã‚Œã°ã€ç°¡å˜ãªãƒ†ã‚­ã‚¹ãƒˆèªè­˜ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚çŒ«ã¸ã‚ˆã†ã“ãã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kq/bl/4r/kqbl4rtgmtvz1xl50tzbulmdmlw.png"><br>
<a name="habracut"></a><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ³¨</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šã“ã®ä¾‹ã¯å®Ÿé¨“çš„ã§æ•™è‚²çš„ãªã‚‚ã®ã§ã‚ã‚Šã€ç§ã¯ãã‚ŒãŒä½•ã‚’ã‚‚ãŸã‚‰ã™ã‹ã‚’çŸ¥ã‚ŠãŸã„ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">ç§ã¯2ç•ªç›®ã®FineReaderã‚’è¨ˆç”»ã—ã¦ã„ãªã‹ã£ãŸã—ã€è¨ˆç”»ã‚‚ã—ã¦ã„ãªã‹ã£ãŸã®ã§ã€ã“ã“ã§ã¯å¤šãã®ã“ã¨ã¯ã‚‚ã¡ã‚ã‚“å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">ãã®ãŸã‚ã€ã€Œãªãœã€ã€Œã™ã§ã«è‰¯ã„ã€ãªã©ã®ä¸»å¼µã¯èªã‚ã‚‰ã‚Œã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">ãŠãã‚‰ãã™ã§ã«Pythonç”¨ã®æ—¢è£½ã®OCRãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚‹ã¯ãšã§ã™ãŒã€è‡ªåˆ†ã§ä½œæˆã™ã‚‹ã®ã¯èˆˆå‘³æ·±ã„ã“ã¨ã§ã—ãŸã€‚</font><font style="vertical-align: inherit;">ã¡ãªã¿ã«ã€å®Ÿéš›ã®FineReaderãŒã©ã®ã‚ˆã†ã«ä½œæˆã•ã‚ŒãŸã‹ã‚’ç¢ºèªã—ãŸã„äººã®ãŸã‚ã«ã€2014å¹´ã®Habrã«é–¢ã™ã‚‹ãƒ–ãƒ­ã‚°ã«ã¯ã€</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¨</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2ã®2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¤ã®è¨˜äº‹ãŒã‚ã‚Šã¾ã™</font><font style="vertical-align: inherit;">ï¼ˆã‚‚ã¡ã‚ã‚“ã€ä¼æ¥­ã®ãƒ–ãƒ­ã‚°ã®ã‚ˆã†ã«ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨è©³ç´°ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚</font><font style="vertical-align: inherit;">ã•ã¦ã€å§‹ã‚ã¾ã—ã‚‡ã†ã€‚ã“ã“ã§ã¯ã™ã¹ã¦ãŒã‚ªãƒ¼ãƒ—ãƒ³ã§ã€ã™ã¹ã¦ãŒã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä¾‹ã¨ã—ã¦ã€ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–ã‚Šä¸Šã’ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã“ã«1ã¤ã‚ã‚Šã¾ã™ï¼š</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã“ã‚“ã«ã¡ã¯ä¸–ç•Œ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãã‚Œã§ä½•ãŒã§ãã‚‹ã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–‡å­—ã«åˆ†å‰²ã™ã‚‹</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ¥ã€…ã®æ–‡å­—ã«åˆ†å‰²ã™ã‚‹ã“ã¨ã§ã™ã€‚ OpenCVã¯ã“ã®ãŸã‚ã«å½¹ç«‹ã¡ã¾ã™ã€‚ã‚ˆã‚Šæ­£ç¢ºã«ã¯ã€findContoursé–¢æ•°ã§ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç”»åƒï¼ˆcv2.imreadï¼‰ã‚’é–‹ãã€b / wï¼ˆcv2.cvtColor + cv2.thresholdï¼‰ã«å¤‰æ›ã—ã€å°‘ã—å¢—ã‚„ã—ï¼ˆcv2.erodeï¼‰ã€è¼ªéƒ­ã‚’è¦‹ã¤ã‘ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">image_file = <span class="hljs-string">"text.png"</span><font></font>
img = cv2.imread(image_file)<font></font>
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)<font></font>
ret, thresh = cv2.threshold(gray, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>, cv2.THRESH_BINARY)<font></font>
img_erode = cv2.erode(thresh, np.ones((<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), np.uint8), iterations=<span class="hljs-number">1</span>)<font></font>
<font></font>
<span class="hljs-comment"># Get contours</span><font></font>
contours, hierarchy = cv2.findContours(img_erode, cv2.RETR_TREE, cv2.CHAIN_APPROX_NONE)<font></font>
<font></font>
output = img.copy()<font></font>
<font></font>
<span class="hljs-keyword">for</span> idx, contour <span class="hljs-keyword">in</span> enumerate(contours):<font></font>
    (x, y, w, h) = cv2.boundingRect(contour)<font></font>
    <span class="hljs-comment"># print("R", idx, x, y, w, h, cv2.contourArea(contour), hierarchy[0][idx])</span>
    <span class="hljs-comment"># hierarchy[i][0]: the index of the next contour of the same level</span>
    <span class="hljs-comment"># hierarchy[i][1]: the index of the previous contour of the same level</span>
    <span class="hljs-comment"># hierarchy[i][2]: the index of the first child</span>
    <span class="hljs-comment"># hierarchy[i][3]: the index of the parent</span>
    <span class="hljs-keyword">if</span> hierarchy[<span class="hljs-number">0</span>][idx][<span class="hljs-number">3</span>] == <span class="hljs-number">0</span>:<font></font>
        cv2.rectangle(output, (x, y), (x + w, y + h), (<span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-number">1</span>)<font></font>
<font></font>
<font></font>
cv2.imshow(<span class="hljs-string">"Input"</span>, img)<font></font>
cv2.imshow(<span class="hljs-string">"Enlarged"</span>, img_erode)<font></font>
cv2.imshow(<span class="hljs-string">"Output"</span>, output)<font></font>
cv2.waitKey(<span class="hljs-number">0</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ç­‰é«˜ç·šã®éšå±¤ãƒ„ãƒªãƒ¼ã‚’å–å¾—ã—ã¾ã™ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼cv2.RETR_TREEï¼‰ã€‚æœ€åˆã«ç”»åƒã®ä¸€èˆ¬çš„ãªè¼ªéƒ­ã€æ¬¡ã«æ–‡å­—ã®è¼ªéƒ­ã€æ¬¡ã«å†…å´ã®è¼ªéƒ­ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚æ–‡å­—ã®è¼ªéƒ­ã ã‘ãŒå¿…è¦ãªã®ã§ã€ã€Œè¼ªéƒ­ã€ãŒå…¨ä½“ã®è¼ªéƒ­ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚ã“ã‚Œã¯ç°¡ç•¥åŒ–ã•ã‚ŒãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã‚ã‚Šã€å®Ÿéš›ã®ã‚¹ã‚­ãƒ£ãƒ³ã§ã¯æ©Ÿèƒ½ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’èªè­˜ã™ã‚‹ã“ã¨ã¯é‡è¦ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çµæœï¼š</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7j/zi/pg/7jzipgqvc9ebvxgu2j7c_ubr-rw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€ä»¥å‰ã«28x28ã®æ­£æ–¹å½¢ã«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã—ãŸå„æ–‡å­—ã‚’ä¿å­˜ã™ã‚‹ã“ã¨ã§ã™ï¼ˆMNISTãƒ™ãƒ¼ã‚¹ã¯ã“ã®å½¢å¼ã§ä¿å­˜ã•ã‚Œã¾ã™ï¼‰ã€‚ OpenCVã¯numpyã«åŸºã¥ã„ã¦æ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚¯ãƒ­ãƒƒãƒ—ã¨ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®ãŸã‚ã«é…åˆ—ã‚’æ“ä½œã™ã‚‹é–¢æ•°ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">letters_extract</span>(<span class="hljs-params">image_file: str, out_size=<span class="hljs-number">28</span></span>) -&gt; List[Any]:</span><font></font>
    img = cv2.imread(image_file)<font></font>
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)<font></font>
    ret, thresh = cv2.threshold(gray, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>, cv2.THRESH_BINARY)<font></font>
    img_erode = cv2.erode(thresh, np.ones((<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), np.uint8), iterations=<span class="hljs-number">1</span>)<font></font>
<font></font>
    <span class="hljs-comment"># Get contours</span><font></font>
    contours, hierarchy = cv2.findContours(img_erode, cv2.RETR_TREE, cv2.CHAIN_APPROX_NONE)<font></font>
<font></font>
    output = img.copy()<font></font>
<font></font>
    letters = []<font></font>
    <span class="hljs-keyword">for</span> idx, contour <span class="hljs-keyword">in</span> enumerate(contours):<font></font>
        (x, y, w, h) = cv2.boundingRect(contour)<font></font>
        <span class="hljs-comment"># print("R", idx, x, y, w, h, cv2.contourArea(contour), hierarchy[0][idx])</span>
        <span class="hljs-comment"># hierarchy[i][0]: the index of the next contour of the same level</span>
        <span class="hljs-comment"># hierarchy[i][1]: the index of the previous contour of the same level</span>
        <span class="hljs-comment"># hierarchy[i][2]: the index of the first child</span>
        <span class="hljs-comment"># hierarchy[i][3]: the index of the parent</span>
        <span class="hljs-keyword">if</span> hierarchy[<span class="hljs-number">0</span>][idx][<span class="hljs-number">3</span>] == <span class="hljs-number">0</span>:<font></font>
            cv2.rectangle(output, (x, y), (x + w, y + h), (<span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-number">1</span>)<font></font>
            letter_crop = gray[y:y + h, x:x + w]<font></font>
            <span class="hljs-comment"># print(letter_crop.shape)</span><font></font>
<font></font>
            <span class="hljs-comment"># Resize letter canvas to square</span><font></font>
            size_max = max(w, h)<font></font>
            letter_square = <span class="hljs-number">255</span> * np.ones(shape=[size_max, size_max], dtype=np.uint8)
            <span class="hljs-keyword">if</span> w &gt; h:
                <span class="hljs-comment"># Enlarge image top-bottom</span>
                <span class="hljs-comment"># ------</span>
                <span class="hljs-comment"># ======</span>
                <span class="hljs-comment"># ------</span>
                y_pos = size_max//<span class="hljs-number">2</span> - h//<span class="hljs-number">2</span>
                letter_square[y_pos:y_pos + h, <span class="hljs-number">0</span>:w] = letter_crop
            <span class="hljs-keyword">elif</span> w &lt; h:
                <span class="hljs-comment"># Enlarge image left-right</span>
                <span class="hljs-comment"># --||--</span>
                x_pos = size_max//<span class="hljs-number">2</span> - w//<span class="hljs-number">2</span>
                letter_square[<span class="hljs-number">0</span>:h, x_pos:x_pos + w] = letter_crop
            <span class="hljs-keyword">else</span>:<font></font>
                letter_square = letter_crop<font></font>
<font></font>
            <span class="hljs-comment"># Resize letter to 28x28 and add letter and its X-coordinate</span><font></font>
            letters.append((x, w, cv2.resize(letter_square, (out_size, out_size), interpolation=cv2.INTER_AREA)))<font></font>
<font></font>
    <span class="hljs-comment"># Sort array in place by X-coordinate</span>
    letters.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>], reverse=<span class="hljs-literal">False</span>)<font></font>
<font></font>
    <span class="hljs-keyword">return</span> letters
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€å¾Œã«ã€Xåº§æ¨™ã§æ–‡å­—ã‚’ä¸¦ã¹æ›¿ãˆã¾ã™ã€‚ã”è¦§ã®ã¨ãŠã‚Šã€çµæœã‚’ã‚¿ãƒ—ãƒ«ï¼ˆxã€wã€æ–‡å­—ï¼‰ã®å½¢å¼ã§ä¿å­˜ã—ã€æ–‡å­—é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‹ã‚‰ã‚¹ãƒšãƒ¼ã‚¹ã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã™ã¹ã¦ãŒæ©Ÿèƒ½ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">cv2.imshow(<span class="hljs-string">"0"</span>, letters[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>])<font></font>
cv2.imshow(<span class="hljs-string">"1"</span>, letters[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>])<font></font>
cv2.imshow(<span class="hljs-string">"2"</span>, letters[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>])<font></font>
cv2.imshow(<span class="hljs-string">"3"</span>, letters[<span class="hljs-number">3</span>][<span class="hljs-number">2</span>])<font></font>
cv2.imshow(<span class="hljs-string">"4"</span>, letters[<span class="hljs-number">4</span>][<span class="hljs-number">2</span>])<font></font>
cv2.waitKey(<span class="hljs-number">0</span>)</code></pre><br>
<img src="https://habrastorage.org/webt/j-/uw/yh/j-uwyhhh8l0yrapth5u6fy9na0u.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æ–‡å­—ã¯èªè­˜ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚ç•³ã¿è¾¼ã¿ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦æ–‡å­—ã‚’èªè­˜ã—ã¾ã™ã€‚ã“ã®ã‚¿ã‚¤ãƒ—ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯ã€ã“ã®ã‚ˆã†ãªã‚¿ã‚¹ã‚¯ã«é©ã—ã¦ã„ã¾ã™ã€‚ </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">èªè­˜ã®ãŸã‚ã®ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆCNNï¼‰</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…ƒã®EMNISTãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«ã¯62ç¨®é¡ã®æ–‡å­—ï¼ˆA..Zã€0..9ãªã©ï¼‰ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">emnist_labels = [<span class="hljs-number">48</span>, <span class="hljs-number">49</span>, <span class="hljs-number">50</span>, <span class="hljs-number">51</span>, <span class="hljs-number">52</span>, <span class="hljs-number">53</span>, <span class="hljs-number">54</span>, <span class="hljs-number">55</span>, <span class="hljs-number">56</span>, <span class="hljs-number">57</span>, <span class="hljs-number">65</span>, <span class="hljs-number">66</span>, <span class="hljs-number">67</span>, <span class="hljs-number">68</span>, <span class="hljs-number">69</span>, <span class="hljs-number">70</span>, <span class="hljs-number">71</span>, <span class="hljs-number">72</span>, <span class="hljs-number">73</span>, <span class="hljs-number">74</span>, <span class="hljs-number">75</span>, <span class="hljs-number">76</span>, <span class="hljs-number">77</span>, <span class="hljs-number">78</span>, <span class="hljs-number">79</span>, <span class="hljs-number">80</span>, <span class="hljs-number">81</span>, <span class="hljs-number">82</span>, <span class="hljs-number">83</span>, <span class="hljs-number">84</span>, <span class="hljs-number">85</span>, <span class="hljs-number">86</span>, <span class="hljs-number">87</span>, <span class="hljs-number">88</span>, <span class="hljs-number">89</span>, <span class="hljs-number">90</span>, <span class="hljs-number">97</span>, <span class="hljs-number">98</span>, <span class="hljs-number">99</span>, <span class="hljs-number">100</span>, <span class="hljs-number">101</span>, <span class="hljs-number">102</span>, <span class="hljs-number">103</span>, <span class="hljs-number">104</span>, <span class="hljs-number">105</span>, <span class="hljs-number">106</span>, <span class="hljs-number">107</span>, <span class="hljs-number">108</span>, <span class="hljs-number">109</span>, <span class="hljs-number">110</span>, <span class="hljs-number">111</span>, <span class="hljs-number">112</span>, <span class="hljs-number">113</span>, <span class="hljs-number">114</span>, <span class="hljs-number">115</span>, <span class="hljs-number">116</span>, <span class="hljs-number">117</span>, <span class="hljs-number">118</span>, <span class="hljs-number">119</span>, <span class="hljs-number">120</span>, <span class="hljs-number">121</span>, <span class="hljs-number">122</span>]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã—ãŸãŒã£ã¦ã€ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯62ã®å‡ºåŠ›ã‚’æŒã¡ã€èªè­˜ã€Œ1ã€ãŒãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å¯¾å¿œã™ã‚‹å‡ºåŠ›ã«ãªã‚‹ã¨ã€å…¥åŠ›ã§28x28ã®ç”»åƒã‚’å—ã‘å–ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> tensorflow <span class="hljs-keyword">import</span> keras
<span class="hljs-keyword">from</span> keras.models <span class="hljs-keyword">import</span> Sequential
<span class="hljs-keyword">from</span> keras <span class="hljs-keyword">import</span> optimizers
<span class="hljs-keyword">from</span> keras.layers <span class="hljs-keyword">import</span> Convolution2D, MaxPooling2D, Dropout, Flatten, Dense, Reshape, LSTM, BatchNormalization
<span class="hljs-keyword">from</span> keras.optimizers <span class="hljs-keyword">import</span> SGD, RMSprop, Adam
<span class="hljs-keyword">from</span> keras <span class="hljs-keyword">import</span> backend <span class="hljs-keyword">as</span> K
<span class="hljs-keyword">from</span> keras.constraints <span class="hljs-keyword">import</span> maxnorm
<span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">emnist_model</span>():</span><font></font>
    model = Sequential()<font></font>
    model.add(Convolution2D(filters=<span class="hljs-number">32</span>, kernel_size=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">'valid'</span>, input_shape=(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>), activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(Convolution2D(filters=<span class="hljs-number">64</span>, kernel_size=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(MaxPooling2D(pool_size=(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)))<font></font>
    model.add(Dropout(<span class="hljs-number">0.25</span>))<font></font>
    model.add(Flatten())<font></font>
    model.add(Dense(<span class="hljs-number">512</span>, activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(Dropout(<span class="hljs-number">0.5</span>))<font></font>
    model.add(Dense(len(emnist_labels), activation=<span class="hljs-string">'softmax'</span>))<font></font>
    model.compile(loss=<span class="hljs-string">'categorical_crossentropy'</span>, optimizer=<span class="hljs-string">'adadelta'</span>, metrics=[<span class="hljs-string">'accuracy'</span>])
    <span class="hljs-keyword">return</span> model</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã”è¦§ã®ã¨ãŠã‚Šã€ã“ã‚Œã¯ç”»åƒã®ç‰¹å®šã®æ©Ÿèƒ½ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼32ã¨64ã®æ•°ï¼‰ã‚’å¼·èª¿ã™ã‚‹å¤å…¸çš„ãªç•³ã¿è¾¼ã¿ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚Šã€ãã®ã€Œå‡ºåŠ›ã€ã«ã€Œç·šå½¢ã€MLPãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒæ¥ç¶šã•ã‚Œã¦ãŠã‚Šã€æœ€çµ‚çš„ãªçµæœã‚’å½¢æˆã—ã¦ã„ã¾ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
æœ€é•·ã®æ®µéšã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«é€²ã¿ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ã“ã‚Œã‚’è¡Œã†ã«</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã¯ã€ãƒªãƒ³ã‚¯ã‹ã‚‰</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹EMNISTãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</font><font style="vertical-align: inherit;">ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚µã‚¤ã‚º536Mbï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èª­ã¿å–ã‚‹ã«ã¯ã€idx2numpyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨æ¤œè¨¼ã®ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> idx2numpy<font></font>
<font></font>
emnist_path = <span class="hljs-string">'/home/Documents/TestApps/keras/emnist/'</span>
X_train = idx2numpy.convert_from_file(emnist_path + <span class="hljs-string">'emnist-byclass-train-images-idx3-ubyte'</span>)<font></font>
y_train = idx2numpy.convert_from_file(emnist_path + <span class="hljs-string">'emnist-byclass-train-labels-idx1-ubyte'</span>)<font></font>
<font></font>
X_test = idx2numpy.convert_from_file(emnist_path + <span class="hljs-string">'emnist-byclass-test-images-idx3-ubyte'</span>)<font></font>
y_test = idx2numpy.convert_from_file(emnist_path + <span class="hljs-string">'emnist-byclass-test-labels-idx1-ubyte'</span>)<font></font>
<font></font>
X_train = np.reshape(X_train, (X_train.shape[<span class="hljs-number">0</span>], <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>))<font></font>
X_test = np.reshape(X_test, (X_test.shape[<span class="hljs-number">0</span>], <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>))<font></font>
<font></font>
print(X_train.shape, y_train.shape, X_test.shape, y_test.shape, len(emnist_labels))<font></font>
<font></font>
k = <span class="hljs-number">10</span>
X_train = X_train[:X_train.shape[<span class="hljs-number">0</span>] // k]<font></font>
y_train = y_train[:y_train.shape[<span class="hljs-number">0</span>] // k]<font></font>
X_test = X_test[:X_test.shape[<span class="hljs-number">0</span>] // k]<font></font>
y_test = y_test[:y_test.shape[<span class="hljs-number">0</span>] // k]<font></font>
<font></font>
<span class="hljs-comment"># Normalize</span><font></font>
X_train = X_train.astype(np.float32)<font></font>
X_train /= <span class="hljs-number">255.0</span><font></font>
X_test = X_test.astype(np.float32)<font></font>
X_test /= <span class="hljs-number">255.0</span><font></font>
<font></font>
x_train_cat = keras.utils.to_categorical(y_train, len(emnist_labels))<font></font>
y_test_cat = keras.utils.to_categorical(y_test, len(emnist_labels))<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¨æ¤œè¨¼ç”¨ã«2ã‚»ãƒƒãƒˆç”¨æ„ã—ã¾ã—ãŸã€‚</font><font style="vertical-align: inherit;">æ–‡å­—è‡ªä½“ã¯è¡¨ç¤ºãŒç°¡å˜ãªé€šå¸¸ã®é…åˆ—</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lb/uj/yt/lbujytoizk2gxviahqxz5emvgay.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã§ã™ã€‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¯ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®1/10ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼kï¼‰ã®ã¿ã‚’ä½¿ç”¨</font><font style="vertical-align: inherit;">ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãã‚Œä»¥å¤–ã®å ´åˆã€ãƒ—ãƒ­ã‚»ã‚¹ã«ã¯å°‘ãªãã¨ã‚‚10æ™‚é–“ã‹ã‹ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã—ã€ãƒ—ãƒ­ã‚»ã‚¹ã®æœ€å¾Œã«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ‡ã‚£ã‚¹ã‚¯ã«ä¿å­˜ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-comment"># Set a learning rate reduction</span>
learning_rate_reduction = keras.callbacks.ReduceLROnPlateau(monitor=<span class="hljs-string">'val_acc'</span>, patience=<span class="hljs-number">3</span>, verbose=<span class="hljs-number">1</span>, factor=<span class="hljs-number">0.5</span>, min_lr=<span class="hljs-number">0.00001</span>)<font></font>
<font></font>
<span class="hljs-comment"># Required for learning_rate_reduction:</span><font></font>
keras.backend.get_session().run(tf.global_variables_initializer())<font></font>
<font></font>
model.fit(X_train, x_train_cat, validation_data=(X_test, y_test_cat), callbacks=[learning_rate_reduction], batch_size=<span class="hljs-number">64</span>, epochs=<span class="hljs-number">30</span>)<font></font>
<font></font>
model.save(<span class="hljs-string">'emnist_letters.h5'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å­¦ç¿’ãƒ—ãƒ­ã‚»ã‚¹è‡ªä½“ã¯ç´„30åˆ†ã‹ã‹ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vu/xv/_s/vuxv_s6hsxg1q0gxcqapd0o3bv8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã‚Œã¯ä¸€åº¦ã ã‘è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®å¾Œã€ã™ã§ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãŒå®Œäº†ã™ã‚‹ã¨ã€ã™ã¹ã¦ã®æº–å‚™ãŒæ•´ã„ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’èªè­˜ã§ãã¾ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">èªè­˜</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
èªè­˜ã®ãŸã‚ã«ã€ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€predict_classesé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs">model = keras.models.load_model(<span class="hljs-string">'emnist_letters.h5'</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">emnist_predict_img</span>(<span class="hljs-params">model, img</span>):</span>
    img_arr = np.expand_dims(img, axis=<span class="hljs-number">0</span>)<font></font>
    img_arr = <span class="hljs-number">1</span> - img_arr/<span class="hljs-number">255.0</span>
    img_arr[<span class="hljs-number">0</span>] = np.rot90(img_arr[<span class="hljs-number">0</span>], <span class="hljs-number">3</span>)<font></font>
    img_arr[<span class="hljs-number">0</span>] = np.fliplr(img_arr[<span class="hljs-number">0</span>])<font></font>
    img_arr = img_arr.reshape((<span class="hljs-number">1</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>))<font></font>
<font></font>
    result = model.predict_classes([img_arr])<font></font>
    <span class="hljs-keyword">return</span> chr(emnist_labels[result[<span class="hljs-number">0</span>]])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çµå±€ã®ã¨ã“ã‚ã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå†…ã®ç”»åƒã¯æœ€åˆã«å›è»¢ã•ã‚Œã¦ã„ãŸãŸã‚ã€èªè­˜å‰ã«ç”»åƒã‚’å›è»¢ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
å…¥åŠ›ã§ç”»åƒã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ã‘å–ã‚Šã€å‡ºåŠ›ã§1è¡Œã‚’ä¸ãˆã‚‹æœ€å¾Œã®é–¢æ•°ã¯ã€ã‚ãšã‹10è¡Œã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">img_to_str</span>(<span class="hljs-params">model: Any, image_file: str</span>):</span><font></font>
    letters = letters_extract(image_file)<font></font>
    s_out = <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(letters)):<font></font>
        dn = letters[i+<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] - letters[i][<span class="hljs-number">0</span>] - letters[i][<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> i &lt; len(letters) - <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        s_out += emnist_predict_img(model, letters[i][<span class="hljs-number">2</span>])
        <span class="hljs-keyword">if</span> (dn &gt; letters[i][<span class="hljs-number">1</span>]/<span class="hljs-number">4</span>):<font></font>
            s_out += <span class="hljs-string">' '</span>
    <span class="hljs-keyword">return</span> s_out</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã“ã“ã§ã¯ã€ä»¥å‰ã«ä¿å­˜ã—ãŸæ–‡å­—å¹…ã‚’ä½¿ç”¨ã—ã¦ã€æ–‡å­—é–“ã®é–“éš”ãŒæ–‡å­—ã®1/4ã‚ˆã‚Šå¤§ãã„å ´åˆã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ä½¿ç”¨ä¾‹ï¼š</font></font><br>
<pre><code class="python hljs">model = keras.models.load_model(<span class="hljs-string">'emnist_letters.h5'</span>)<font></font>
s_out = img_to_str(model, <span class="hljs-string">"hello_world.png"</span>)<font></font>
print(s_out)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
çµæœï¼š</font></font><br>
<img src="https://habrastorage.org/webt/ck/r5/iq/ckr5iqlfoiokza60cleu3w1x-hg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
é¢ç™½ã„æ©Ÿèƒ½-ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¯æ–‡å­—ã€ŒOã€ã¨æ•°å­—ã€Œ0ã€ã‚’ã€Œæ··åŒã€ã—ã¾ã—ãŸãŒã€ã“ã‚Œã¯é©šãã“ã¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</font><font style="vertical-align: inherit;">EMNISTã®ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚»ãƒƒãƒˆã«ã¯ã€</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‰‹æ›¸ãã®</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ–‡å­—ã¨æ•°å­—ãŒ</font><font style="vertical-align: inherit;">å«ã¾ã‚Œ</font><font style="vertical-align: inherit;">ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã‚‰ã¯å°åˆ·ã•ã‚ŒãŸã‚‚ã®ã¨</font><font style="vertical-align: inherit;">ã¯å®Œå…¨ã«ã¯ç•°ãªã‚Š</font><font style="vertical-align: inherit;">ã¾ã™ã€‚</font><font style="vertical-align: inherit;">ç†æƒ³çš„ã«ã¯ã€ç”»é¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’èªè­˜ã™ã‚‹ã«ã¯ã€ç”»é¢ã®ãƒ•ã‚©ãƒ³ãƒˆã«åŸºã¥ã„ã¦åˆ¥ã®ã‚»ãƒƒãƒˆã‚’æº–å‚™ã—ã€ãã®ä¸Šã§ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">çµè«–</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã”è¦§ã®ã¨ãŠã‚Šã€ãƒãƒƒãƒˆã‚’ç‡ƒã‚„ã™ã®ã¯ç¥ã§ã¯ãªãã€ã‹ã¤ã¦ã®å›³æ›¸é¤¨ã®åŠ©ã‘ã‚’å€Ÿã‚Šã¦ã€Œé­”æ³•ã€ã®ã‚ˆã†ã«æ€ã‚ã‚Œã¦ã„ãŸã‚‚ã®ã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pythonã¯ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãªã®ã§ã€ã‚³ãƒ¼ãƒ‰ã¯Windowsã€Linuxã€OSXã®ã©ã“ã§ã‚‚æ©Ÿèƒ½ã—ã¾ã™ã€‚</font><font style="vertical-align: inherit;">Kerasã¯iOS / Androidã«ç§»æ¤ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ç†è«–çš„ã«ã¯ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã¯</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã§ä½¿ç”¨ã§ã</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ã¾ã™</font></a><font style="vertical-align: inherit;">ã€‚</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
è‡ªåˆ†ã§å®Ÿé¨“ã—ãŸã„äººã®ãŸã‚ã«ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ãƒã‚¿ãƒãƒ¬ã®ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keras_emnist.py</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-comment"># Code source: dmitryelj@gmail.com</span><font></font>
<font></font>
<span class="hljs-keyword">import</span> os
<span class="hljs-comment"># Force CPU</span>
<span class="hljs-comment"># os.environ["CUDA_VISIBLE_DEVICES"] = "-1"</span>
<span class="hljs-comment"># Debug messages</span>
<span class="hljs-comment"># 0 = all messages are logged (default behavior)</span>
<span class="hljs-comment"># 1 = INFO messages are not printed</span>
<span class="hljs-comment"># 2 = INFO and WARNING messages are not printed</span>
<span class="hljs-comment"># 3 = INFO, WARNING, and ERROR messages are not printed</span>
os.environ[<span class="hljs-string">'TF_CPP_MIN_LOG_LEVEL'</span>] = <span class="hljs-string">'3'</span><font></font>
<font></font>
<font></font>
<span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> imghdr
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pathlib
<span class="hljs-keyword">from</span> tensorflow <span class="hljs-keyword">import</span> keras
<span class="hljs-keyword">from</span> keras.models <span class="hljs-keyword">import</span> Sequential
<span class="hljs-keyword">from</span> keras <span class="hljs-keyword">import</span> optimizers
<span class="hljs-keyword">from</span> keras.layers <span class="hljs-keyword">import</span> Convolution2D, MaxPooling2D, Dropout, Flatten, Dense, Reshape, LSTM, BatchNormalization
<span class="hljs-keyword">from</span> keras.optimizers <span class="hljs-keyword">import</span> SGD, RMSprop, Adam
<span class="hljs-keyword">from</span> keras <span class="hljs-keyword">import</span> backend <span class="hljs-keyword">as</span> K
<span class="hljs-keyword">from</span> keras.constraints <span class="hljs-keyword">import</span> maxnorm
<span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">from</span> scipy <span class="hljs-keyword">import</span> io <span class="hljs-keyword">as</span> spio
<span class="hljs-keyword">import</span> idx2numpy  <span class="hljs-comment"># sudo pip3 install idx2numpy</span>
<span class="hljs-keyword">from</span> matplotlib <span class="hljs-keyword">import</span> pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time<font></font>
<font></font>
<font></font>
<span class="hljs-comment"># Dataset:</span>
<span class="hljs-comment"># https://www.nist.gov/node/1298471/emnist-dataset</span>
<span class="hljs-comment"># https://www.itl.nist.gov/iaui/vip/cs_links/EMNIST/gzip.zip</span><font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cnn_print_digit</span>(<span class="hljs-params">d</span>):</span><font></font>
    print(d.shape)<font></font>
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(<span class="hljs-number">28</span>):<font></font>
        s = <span class="hljs-string">""</span>
        <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> range(<span class="hljs-number">28</span>):<font></font>
            s += <span class="hljs-string">"{0:.1f} "</span>.format(d[<span class="hljs-number">28</span>*y + x])<font></font>
        print(s)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cnn_print_digit_2d</span>(<span class="hljs-params">d</span>):</span><font></font>
    print(d.shape)<font></font>
    <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> range(d.shape[<span class="hljs-number">0</span>]):<font></font>
        s = <span class="hljs-string">""</span>
        <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(d.shape[<span class="hljs-number">1</span>]):<font></font>
            s += <span class="hljs-string">"{0:.1f} "</span>.format(d[x][y])<font></font>
        print(s)<font></font>
<font></font>
<font></font>
emnist_labels = [<span class="hljs-number">48</span>, <span class="hljs-number">49</span>, <span class="hljs-number">50</span>, <span class="hljs-number">51</span>, <span class="hljs-number">52</span>, <span class="hljs-number">53</span>, <span class="hljs-number">54</span>, <span class="hljs-number">55</span>, <span class="hljs-number">56</span>, <span class="hljs-number">57</span>, <span class="hljs-number">65</span>, <span class="hljs-number">66</span>, <span class="hljs-number">67</span>, <span class="hljs-number">68</span>, <span class="hljs-number">69</span>, <span class="hljs-number">70</span>, <span class="hljs-number">71</span>, <span class="hljs-number">72</span>, <span class="hljs-number">73</span>, <span class="hljs-number">74</span>, <span class="hljs-number">75</span>, <span class="hljs-number">76</span>, <span class="hljs-number">77</span>, <span class="hljs-number">78</span>, <span class="hljs-number">79</span>, <span class="hljs-number">80</span>, <span class="hljs-number">81</span>, <span class="hljs-number">82</span>, <span class="hljs-number">83</span>, <span class="hljs-number">84</span>, <span class="hljs-number">85</span>, <span class="hljs-number">86</span>, <span class="hljs-number">87</span>, <span class="hljs-number">88</span>, <span class="hljs-number">89</span>, <span class="hljs-number">90</span>, <span class="hljs-number">97</span>, <span class="hljs-number">98</span>, <span class="hljs-number">99</span>, <span class="hljs-number">100</span>, <span class="hljs-number">101</span>, <span class="hljs-number">102</span>, <span class="hljs-number">103</span>, <span class="hljs-number">104</span>, <span class="hljs-number">105</span>, <span class="hljs-number">106</span>, <span class="hljs-number">107</span>, <span class="hljs-number">108</span>, <span class="hljs-number">109</span>, <span class="hljs-number">110</span>, <span class="hljs-number">111</span>, <span class="hljs-number">112</span>, <span class="hljs-number">113</span>, <span class="hljs-number">114</span>, <span class="hljs-number">115</span>, <span class="hljs-number">116</span>, <span class="hljs-number">117</span>, <span class="hljs-number">118</span>, <span class="hljs-number">119</span>, <span class="hljs-number">120</span>, <span class="hljs-number">121</span>, <span class="hljs-number">122</span>]<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">emnist_model</span>():</span><font></font>
    model = Sequential()<font></font>
    model.add(Convolution2D(filters=<span class="hljs-number">32</span>, kernel_size=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">'valid'</span>, input_shape=(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>), activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(Convolution2D(filters=<span class="hljs-number">64</span>, kernel_size=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(MaxPooling2D(pool_size=(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)))<font></font>
    model.add(Dropout(<span class="hljs-number">0.25</span>))<font></font>
    model.add(Flatten())<font></font>
    model.add(Dense(<span class="hljs-number">512</span>, activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(Dropout(<span class="hljs-number">0.5</span>))<font></font>
    model.add(Dense(len(emnist_labels), activation=<span class="hljs-string">'softmax'</span>))<font></font>
    model.compile(loss=<span class="hljs-string">'categorical_crossentropy'</span>, optimizer=<span class="hljs-string">'adadelta'</span>, metrics=[<span class="hljs-string">'accuracy'</span>])
    <span class="hljs-keyword">return</span> model<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">emnist_model2</span>():</span><font></font>
    model = Sequential()<font></font>
    <span class="hljs-comment"># In Keras there are two options for padding: same or valid. Same means we pad with the number on the edge and valid means no padding.</span>
    model.add(Convolution2D(filters=<span class="hljs-number">32</span>, kernel_size=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>, padding=<span class="hljs-string">'same'</span>, input_shape=(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>)))<font></font>
    model.add(MaxPooling2D((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)))<font></font>
    model.add(Convolution2D(<span class="hljs-number">64</span>, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>, padding=<span class="hljs-string">'same'</span>))<font></font>
    model.add(MaxPooling2D((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)))<font></font>
    model.add(Convolution2D(<span class="hljs-number">128</span>, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>, padding=<span class="hljs-string">'same'</span>))<font></font>
    model.add(MaxPooling2D((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)))
    <span class="hljs-comment"># model.add(Conv2D(128, (3, 3), activation='relu', padding='same'))</span>
    <span class="hljs-comment"># model.add(MaxPooling2D((2, 2)))</span>
    <span class="hljs-comment">## model.add(Dropout(0.25))</span><font></font>
    model.add(Flatten())<font></font>
    model.add(Dense(<span class="hljs-number">512</span>, activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(Dropout(<span class="hljs-number">0.5</span>))<font></font>
    model.add(Dense(len(emnist_labels), activation=<span class="hljs-string">'softmax'</span>))<font></font>
    model.compile(loss=<span class="hljs-string">'categorical_crossentropy'</span>, optimizer=<span class="hljs-string">'adadelta'</span>, metrics=[<span class="hljs-string">'accuracy'</span>])
    <span class="hljs-keyword">return</span> model<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">emnist_model3</span>():</span><font></font>
    model = Sequential()<font></font>
    model.add(Convolution2D(filters=<span class="hljs-number">32</span>, kernel_size=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">'same'</span>, input_shape=(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>), activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(Convolution2D(filters=<span class="hljs-number">32</span>, kernel_size=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">'same'</span>, activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(MaxPooling2D(pool_size=(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)))<font></font>
    model.add(Dropout(<span class="hljs-number">0.25</span>))<font></font>
<font></font>
    model.add(Convolution2D(filters=<span class="hljs-number">64</span>, kernel_size=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">'same'</span>, activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(Convolution2D(filters=<span class="hljs-number">64</span>, kernel_size=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=<span class="hljs-string">'same'</span>, activation=<span class="hljs-string">'relu'</span>))<font></font>
    model.add(MaxPooling2D(pool_size=(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), strides=(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)))<font></font>
    model.add(Dropout(<span class="hljs-number">0.25</span>))<font></font>
<font></font>
    model.add(Flatten())<font></font>
    model.add(Dense(<span class="hljs-number">512</span>, activation=<span class="hljs-string">"relu"</span>))<font></font>
    model.add(Dropout(<span class="hljs-number">0.5</span>))<font></font>
    model.add(Dense(len(emnist_labels), activation=<span class="hljs-string">"softmax"</span>))<font></font>
    model.compile(loss=<span class="hljs-string">'categorical_crossentropy'</span>, optimizer=RMSprop(lr=<span class="hljs-number">0.001</span>, rho=<span class="hljs-number">0.9</span>, epsilon=<span class="hljs-number">1e-08</span>, decay=<span class="hljs-number">0.0</span>), metrics=[<span class="hljs-string">'accuracy'</span>])
    <span class="hljs-keyword">return</span> model<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">emnist_train</span>(<span class="hljs-params">model</span>):</span><font></font>
    t_start = time.time()<font></font>
<font></font>
    emnist_path = <span class="hljs-string">'D:\\Temp\\1\\'</span>
    X_train = idx2numpy.convert_from_file(emnist_path + <span class="hljs-string">'emnist-byclass-train-images-idx3-ubyte'</span>)<font></font>
    y_train = idx2numpy.convert_from_file(emnist_path + <span class="hljs-string">'emnist-byclass-train-labels-idx1-ubyte'</span>)<font></font>
<font></font>
    X_test = idx2numpy.convert_from_file(emnist_path + <span class="hljs-string">'emnist-byclass-test-images-idx3-ubyte'</span>)<font></font>
    y_test = idx2numpy.convert_from_file(emnist_path + <span class="hljs-string">'emnist-byclass-test-labels-idx1-ubyte'</span>)<font></font>
<font></font>
    X_train = np.reshape(X_train, (X_train.shape[<span class="hljs-number">0</span>], <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>))<font></font>
    X_test = np.reshape(X_test, (X_test.shape[<span class="hljs-number">0</span>], <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>))<font></font>
<font></font>
    print(X_train.shape, y_train.shape, X_test.shape, y_test.shape, len(emnist_labels))<font></font>
<font></font>
    <span class="hljs-comment"># Test:</span>
    k = <span class="hljs-number">10</span>
    X_train = X_train[:X_train.shape[<span class="hljs-number">0</span>] // k]<font></font>
    y_train = y_train[:y_train.shape[<span class="hljs-number">0</span>] // k]<font></font>
    X_test = X_test[:X_test.shape[<span class="hljs-number">0</span>] // k]<font></font>
    y_test = y_test[:y_test.shape[<span class="hljs-number">0</span>] // k]<font></font>
<font></font>
    <span class="hljs-comment"># Normalize</span><font></font>
    X_train = X_train.astype(np.float32)<font></font>
    X_train /= <span class="hljs-number">255.0</span><font></font>
    X_test = X_test.astype(np.float32)<font></font>
    X_test /= <span class="hljs-number">255.0</span><font></font>
<font></font>
    x_train_cat = keras.utils.to_categorical(y_train, len(emnist_labels))<font></font>
    y_test_cat = keras.utils.to_categorical(y_test, len(emnist_labels))<font></font>
<font></font>
    <span class="hljs-comment"># Set a learning rate reduction</span>
    learning_rate_reduction = keras.callbacks.ReduceLROnPlateau(monitor=<span class="hljs-string">'val_acc'</span>, patience=<span class="hljs-number">3</span>, verbose=<span class="hljs-number">1</span>, factor=<span class="hljs-number">0.5</span>, min_lr=<span class="hljs-number">0.00001</span>)<font></font>
<font></font>
    <span class="hljs-comment"># Required for learning_rate_reduction:</span><font></font>
    keras.backend.get_session().run(tf.global_variables_initializer())<font></font>
<font></font>
    model.fit(X_train, x_train_cat, validation_data=(X_test, y_test_cat), callbacks=[learning_rate_reduction], batch_size=<span class="hljs-number">64</span>, epochs=<span class="hljs-number">30</span>)<font></font>
    print(<span class="hljs-string">"Training done, dT:"</span>, time.time() - t_start)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">emnist_predict</span>(<span class="hljs-params">model, image_file</span>):</span>
    img = keras.preprocessing.image.load_img(image_file, target_size=(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>), color_mode=<span class="hljs-string">'grayscale'</span>)<font></font>
    emnist_predict_img(model, img)<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">emnist_predict_img</span>(<span class="hljs-params">model, img</span>):</span>
    img_arr = np.expand_dims(img, axis=<span class="hljs-number">0</span>)<font></font>
    img_arr = <span class="hljs-number">1</span> - img_arr/<span class="hljs-number">255.0</span>
    img_arr[<span class="hljs-number">0</span>] = np.rot90(img_arr[<span class="hljs-number">0</span>], <span class="hljs-number">3</span>)<font></font>
    img_arr[<span class="hljs-number">0</span>] = np.fliplr(img_arr[<span class="hljs-number">0</span>])<font></font>
    img_arr = img_arr.reshape((<span class="hljs-number">1</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>))<font></font>
<font></font>
    result = model.predict_classes([img_arr])<font></font>
    <span class="hljs-keyword">return</span> chr(emnist_labels[result[<span class="hljs-number">0</span>]])<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">letters_extract</span>(<span class="hljs-params">image_file: str, out_size=<span class="hljs-number">28</span></span>):</span><font></font>
    img = cv2.imread(image_file)<font></font>
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)<font></font>
    ret, thresh = cv2.threshold(gray, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>, cv2.THRESH_BINARY)<font></font>
    img_erode = cv2.erode(thresh, np.ones((<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), np.uint8), iterations=<span class="hljs-number">1</span>)<font></font>
<font></font>
    <span class="hljs-comment"># Get contours</span><font></font>
    contours, hierarchy = cv2.findContours(img_erode, cv2.RETR_TREE, cv2.CHAIN_APPROX_NONE)<font></font>
<font></font>
    output = img.copy()<font></font>
<font></font>
    letters = []<font></font>
    <span class="hljs-keyword">for</span> idx, contour <span class="hljs-keyword">in</span> enumerate(contours):<font></font>
        (x, y, w, h) = cv2.boundingRect(contour)<font></font>
        <span class="hljs-comment"># print("R", idx, x, y, w, h, cv2.contourArea(contour), hierarchy[0][idx])</span>
        <span class="hljs-comment"># hierarchy[i][0]: the index of the next contour of the same level</span>
        <span class="hljs-comment"># hierarchy[i][1]: the index of the previous contour of the same level</span>
        <span class="hljs-comment"># hierarchy[i][2]: the index of the first child</span>
        <span class="hljs-comment"># hierarchy[i][3]: the index of the parent</span>
        <span class="hljs-keyword">if</span> hierarchy[<span class="hljs-number">0</span>][idx][<span class="hljs-number">3</span>] == <span class="hljs-number">0</span>:<font></font>
            cv2.rectangle(output, (x, y), (x + w, y + h), (<span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-number">1</span>)<font></font>
            letter_crop = gray[y:y + h, x:x + w]<font></font>
            <span class="hljs-comment"># print(letter_crop.shape)</span><font></font>
<font></font>
            <span class="hljs-comment"># Resize letter canvas to square</span><font></font>
            size_max = max(w, h)<font></font>
            letter_square = <span class="hljs-number">255</span> * np.ones(shape=[size_max, size_max], dtype=np.uint8)
            <span class="hljs-keyword">if</span> w &gt; h:
                <span class="hljs-comment"># Enlarge image top-bottom</span>
                <span class="hljs-comment"># ------</span>
                <span class="hljs-comment"># ======</span>
                <span class="hljs-comment"># ------</span>
                y_pos = size_max//<span class="hljs-number">2</span> - h//<span class="hljs-number">2</span>
                letter_square[y_pos:y_pos + h, <span class="hljs-number">0</span>:w] = letter_crop
            <span class="hljs-keyword">elif</span> w &lt; h:
                <span class="hljs-comment"># Enlarge image left-right</span>
                <span class="hljs-comment"># --||--</span>
                x_pos = size_max//<span class="hljs-number">2</span> - w//<span class="hljs-number">2</span>
                letter_square[<span class="hljs-number">0</span>:h, x_pos:x_pos + w] = letter_crop
            <span class="hljs-keyword">else</span>:<font></font>
                letter_square = letter_crop<font></font>
<font></font>
            <span class="hljs-comment"># Resize letter to 28x28 and add letter and its X-coordinate</span><font></font>
            letters.append((x, w, cv2.resize(letter_square, (out_size, out_size), interpolation=cv2.INTER_AREA)))<font></font>
<font></font>
    <span class="hljs-comment"># Sort array in place by X-coordinate</span>
    letters.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>], reverse=<span class="hljs-literal">False</span>)<font></font>
<font></font>
    <span class="hljs-comment"># cv2.imshow("Input", img)</span>
    <span class="hljs-comment"># # cv2.imshow("Gray", thresh)</span>
    <span class="hljs-comment"># cv2.imshow("Enlarged", img_erode)</span>
    <span class="hljs-comment"># cv2.imshow("Output", output)</span>
    <span class="hljs-comment"># cv2.imshow("0", letters[0][2])</span>
    <span class="hljs-comment"># cv2.imshow("1", letters[1][2])</span>
    <span class="hljs-comment"># cv2.imshow("2", letters[2][2])</span>
    <span class="hljs-comment"># cv2.imshow("3", letters[3][2])</span>
    <span class="hljs-comment"># cv2.imshow("4", letters[4][2])</span>
    <span class="hljs-comment"># cv2.waitKey(0)</span>
    <span class="hljs-keyword">return</span> letters<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">img_to_str</span>(<span class="hljs-params">model: Any, image_file: str</span>):</span><font></font>
    letters = letters_extract(image_file)<font></font>
    s_out = <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(letters)):<font></font>
        dn = letters[i+<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] - letters[i][<span class="hljs-number">0</span>] - letters[i][<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> i &lt; len(letters) - <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        s_out += emnist_predict_img(model, letters[i][<span class="hljs-number">2</span>])
        <span class="hljs-keyword">if</span> (dn &gt; letters[i][<span class="hljs-number">1</span>]/<span class="hljs-number">4</span>):<font></font>
            s_out += <span class="hljs-string">' '</span>
    <span class="hljs-keyword">return</span> s_out<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:<font></font>
<font></font>
    <span class="hljs-comment"># model = emnist_model()</span>
    <span class="hljs-comment"># emnist_train(model)</span>
    <span class="hljs-comment"># model.save('emnist_letters.h5')</span><font></font>
<font></font>
    model = keras.models.load_model(<span class="hljs-string">'emnist_letters.h5'</span>)<font></font>
    s_out = img_to_str(model, <span class="hljs-string">"hello_world.png"</span>)<font></font>
    print(s_out)<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ã„ã¤ã‚‚ã®ã‚ˆã†ã«ã€ã™ã¹ã¦ã®æˆåŠŸã—ãŸå®Ÿé¨“ã€‚</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja466555/index.html">gitlab.comã§å¤§è¦æ¨¡ãªå•é¡Œã®è§£æ±ºç­–ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã‹ã‚‰å­¦ã‚“ã 6ã¤ã®æ•™è¨“ã€‚ãƒ‘ãƒ¼ãƒˆ1</a></li>
<li><a href="../ja466557/index.html">ã‚µã‚¤ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½œæˆã—ã€æ¥µç«¯ã«ã¨ã©ã¾ã‚‰ãªã„æ–¹æ³•</a></li>
<li><a href="../ja466559/index.html">Letã¯æ–°ã—ã„Varã§ã™</a></li>
<li><a href="../ja466561/index.html">å®Œå…¨ã«é€æ˜ãªé¸æŠè‚¢ãŒå¿…è¦ã§ã™ã‹ï¼Ÿ- ç§ã¯ãã‚Œã‚‰ã‚’æŒã¤</a></li>
<li><a href="../ja466563/index.html">KOSTï¼šã‚¯ãƒ©ã‚¦ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã®æ–°ã—ã„ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯ã«å«ã¾ã‚Œã‚‹ã‚‚ã®</a></li>
<li><a href="../ja466567/index.html">ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ç”¨ãƒ„ãƒ¼ãƒ«ã‚­ãƒƒãƒˆï¼šãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¨ãã®æ§‹æˆã‚’æ“ä½œã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã«é–¢ã™ã‚‹ãƒ†ãƒ¼ãƒåˆ¥ã‚¦ã‚§ãƒ“ãƒŠãƒ¼</a></li>
<li><a href="../ja466569/index.html">ãƒ¢ã‚¹ã‚¯ãƒ¯å–å¼•æ‰€ã§ã®IPOï¼šãªãœãã‚ŒãŒå¿…è¦ãªã®ã‹ã€èª°ãŒãã‚Œã‚’è¡Œã„ã€ã©ã®ã‚ˆã†ã«æ ªã‚’è²·ã†ã®ã‹</a></li>
<li><a href="../ja466571/index.html">Tesseract OCRã®ãƒ’ãƒ³ãƒˆ-OCRãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ç‹¬è‡ªã®èªå½™ã‚’ä½œæˆã—ã¾ã™</a></li>
<li><a href="../ja466573/index.html">å°†æ¥ã®é›‡ç”¨ä¸»ã¸ã®è³ªå•</a></li>
<li><a href="../ja466575/index.html">Pythonã‹ã‚‰DLLã«2æ¬¡å…ƒãƒªã‚¹ãƒˆã‚’æ¸¡ã™</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>