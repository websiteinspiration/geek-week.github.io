<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äç‚ù§Ô∏è‚Äçüë® üôéüèº üíÖüèæ Typescript: unsound behavior or indulgences of reliability üëò ‚ôâÔ∏è üéÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The goal is to show where TS gives the illusion of security, allowing you to get errors while the program is running. 
 
 We will not talk about bugs,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Typescript: unsound behavior or indulgences of reliability</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492106/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The goal is to show where TS gives the illusion of security, allowing you to get errors while the program is running. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will not talk about bugs, in TS there are enough </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1,500 open bugs and 6,000 closed ('is: issue is: open label: Bug'). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All examples will be considered with:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strict mode is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on (wrote an article while understanding)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Without explicit "any": "as any", "Objects", "Function", {[key: string]: unknown}</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Without implicit "any": (noImplicitAny): untyped imports (pure JS files), incorrect type inference</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Without false guesses about types: response from the server, typing of third-party libraries</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 Content: </font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nominal types, custom types - when things seem the same, but so different</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type variance, exact types - about the relationship between types</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refinement invalidation - talk about trust</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exceptions - is it worth it to admit when messed up?</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsafe operations - confidence is not always good</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus Cases - Type Checking at the PR Review Stage</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></li>
</ul><a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Is it difficult to write a function to add two numbers in JS? </font><font style="vertical-align: inherit;">Take a naive implementation</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sum</span>(<span class="hljs-params">a, b</span>) </span>{
	<span class="hljs-keyword">return</span> a + b;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's check our implementation of `sum (2, 2) === 4`, does everything seem to work? </font><font style="vertical-align: inherit;">Not really, when we describe a function, we should think about all kinds of input values, as well as what the function can return</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-number">1.1</span> + <span class="hljs-number">2.7</span>   <span class="hljs-comment">// 3.8000000000000003</span>
<span class="hljs-literal">NaN</span> + <span class="hljs-number">2</span>     <span class="hljs-comment">// NaN</span>
<span class="hljs-number">99999999999999992</span> + <span class="hljs-number">99999999999999992</span> <span class="hljs-comment">// 200000000000000000</span>
<span class="hljs-number">2n</span> + <span class="hljs-number">2</span>      <span class="hljs-comment">// Uncaught TypeError: </span>
            <span class="hljs-comment">// Cannot mix BigInt and other types, use explicit conversions.</span>
{} + <span class="hljs-literal">true</span>   <span class="hljs-comment">// 1</span>
<span class="hljs-number">2</span> + <span class="hljs-string">'2'</span>     <span class="hljs-comment">// '22'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Soundness is the analyzer's ability to prove that there are no errors while the program is running. If the program was accepted by the analyzer, then it is guaranteed to be safe. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Safe program is a program that can work forever without errors. Those. the program will not crash or throw errors. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Correct program - a program that does what it should and does not do what it should not. Correctness depends on the execution of business logic. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Types can prove that the program as a whole is safe, and tests that the program is safe and correct only within the test data (100% coverage, the absence of ‚Äúmutants‚Äù from stryker, passing a property based test and so on can not prove anything, and licenses reduces risks). There are legends that theorem provers can prove the correctness of the program.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It is important to understand the TS philosophy, to understand what the instrument is trying to solve and what is important, what it is not trying to solve. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A note on Soundness</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
TS skips some operations that are not sure at the compilation stage. </font><font style="vertical-align: inherit;">Places with unsound behavior were carefully thought out. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Design goals</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Not the goal for TS - To make a type system with a guarantee of security, instead focus on the balance between safety and productivity </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example structure: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The problem is not safe behavior, the list may not be complete, this is what I found in articles, reports, TS git issues. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The proposal is a TS issue open 3-4 years ago, with a bunch of comments and interesting explanations by the authors. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tip - IMHO of the author, what the author considers good practices</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structural vs Nominal typing</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structural vs Nominal typing 1. Problem</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structural typing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - when comparing types does not take into account their names or where they were declared, and types are compared according to the "structure". </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We want to send the letter `sendEmail` to the correct address` ValidatedEmail`, there is a function for checking the address `validateEmail` which returns the correct address` ValidatedEmail`. </font><font style="vertical-align: inherit;">Unfortunately TS allows you to send any string to `sendEmail`, because </font><font style="vertical-align: inherit;">`ValidatedEmail` for TS is no different from` string`</font></font><br>
<br>
<pre><code class="javascript hljs">type ValidatedEmail = string;<font></font>
declare <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateEmail</span>(<span class="hljs-params">email: string</span>): <span class="hljs-title">ValidatedEmail</span>;

<span class="hljs-title">declare</span> <span class="hljs-title">function</span> <span class="hljs-title">sendEmail</span>(<span class="hljs-params">mail: ValidatedEmail</span>): <span class="hljs-title">void</span>;
<span class="hljs-title">sendEmail</span>(<span class="hljs-params">validateEmail(<span class="hljs-string">"asdf@gmail.com"</span></span>));

// <span class="hljs-title">Should</span> <span class="hljs-title">be</span> <span class="hljs-title">error</span>!
<span class="hljs-title">sendEmail</span>(<span class="hljs-params"><span class="hljs-string">"asdf@gmail.com"</span></span>);</span></code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structural vs Nominal typing 1. Offer</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/microsoft/TypeScript/issues/202</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Enter the keyword `nominal` so that types are checked Nominally. </font><font style="vertical-align: inherit;">Now we can prohibit passing just `string` where` ValidatedEmail` is expected</font></font><br>
<br>
<pre><code class="javascript hljs">nominal type ValidatedEmail = string;<font></font>
declare <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateEmail</span>(<span class="hljs-params">email: string</span>): <span class="hljs-title">ValidatedEmail</span>;

<span class="hljs-title">declare</span> <span class="hljs-title">function</span> <span class="hljs-title">sendEmail</span>(<span class="hljs-params">mail: ValidatedEmail</span>): <span class="hljs-title">void</span>;
<span class="hljs-title">sendEmail</span>(<span class="hljs-params">validateEmail(<span class="hljs-string">'asdf@gmail.com'</span></span>));

// <span class="hljs-title">Error</span>!
<span class="hljs-title">sendEmail</span>(<span class="hljs-params"><span class="hljs-string">'asdf@gmail.com'</span></span>);</span></code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structural vs Nominal typing 1. Tip</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can create an `Opaque` type, which will take some` T` and give it uniqueness by combining it with a type created from the passed `K`. </font><font style="vertical-align: inherit;">`K` can be either a unique symbol (` unique symbol`) or a string (then it will be necessary to ensure that these strings are unique).</font></font><br>
<br>
<pre><code class="javascript hljs">type Opaque&lt;K extends symbol | string, T&gt; <font></font>
	= T &amp; { [X <span class="hljs-keyword">in</span> K]: never };<font></font>
<font></font>
declare <span class="hljs-keyword">const</span> validatedEmailK: unique symbol;<font></font>
type ValidatedEmail = Opaque&lt;<span class="hljs-keyword">typeof</span> validatedEmailK, string&gt;;
<span class="hljs-comment">// type ValidatedEmail = Opaque&lt;'ValidatedEmail', string&gt;;</span><font></font>
<font></font>
declare <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateEmail</span>(<span class="hljs-params">email: string</span>): <span class="hljs-title">ValidatedEmail</span>;

<span class="hljs-title">declare</span> <span class="hljs-title">function</span> <span class="hljs-title">sendEmail</span>(<span class="hljs-params">mail: ValidatedEmail</span>): <span class="hljs-title">void</span>;
<span class="hljs-title">sendEmail</span>(<span class="hljs-params">validateEmail(<span class="hljs-string">'asdf@gmail.com'</span></span>));

// <span class="hljs-title">Argument</span> <span class="hljs-title">of</span> <span class="hljs-title">type</span> '"<span class="hljs-title">asdf</span>@<span class="hljs-title">gmail</span>.<span class="hljs-title">com</span>"' <span class="hljs-title">is</span> <span class="hljs-title">not</span> <span class="hljs-title">assignable</span>
//  <span class="hljs-title">to</span> <span class="hljs-title">parameter</span> <span class="hljs-title">of</span> <span class="hljs-title">type</span> '<span class="hljs-title">Opaque</span>&lt;<span class="hljs-title">unique</span> <span class="hljs-title">symbol</span>, <span class="hljs-title">string</span>&gt;'.
<span class="hljs-title">sendEmail</span>(<span class="hljs-params"><span class="hljs-string">'asdf@gmail.com'</span></span>);</span></code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structural vs Nominal typing 2. Problem</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have a Dollar and Euro class, each of the classes has an add method for adding the Dollar to the Dollar and the Euro to the Euro. </font><font style="vertical-align: inherit;">For TS, these classes are structurally equal and we can add the Dollar to the Euro.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dollar</span> </span>{
  <span class="hljs-attr">value</span>: number;<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(value: number) {
    <span class="hljs-keyword">this</span>.value = value;<font></font>
  }<font></font>
<font></font>
  add(dollar: Dollar): Dollar {<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Dollar(dollar.value + <span class="hljs-keyword">this</span>.value);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Euro</span> </span>{
  <span class="hljs-attr">value</span>: number;<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(value: number) {
    <span class="hljs-keyword">this</span>.value = value;<font></font>
  }<font></font>
<font></font>
  add(euro: Euro): Euro {<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Euro(euro.value + <span class="hljs-keyword">this</span>.value);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> dollars100 = <span class="hljs-keyword">new</span> Dollar(<span class="hljs-number">100</span>);
<span class="hljs-keyword">const</span> euro100 = <span class="hljs-keyword">new</span> Euro(<span class="hljs-number">100</span>);<font></font>
<font></font>
<span class="hljs-comment">// Correct</span><font></font>
dollars100.add(dollars100);<font></font>
euro100.add(euro100);<font></font>
<font></font>
<span class="hljs-comment">// Should be error!</span>
dollars100.add(euro100);</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structural vs Nominal typing 2. Offer</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/microsoft/TypeScript/issues/202</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
The sentence is all the same, with `nominal`, but since </font><font style="vertical-align: inherit;">Since classes can magically become Nominal (more on that later), the possibilities of making such a transformation in a more explicit way are considered.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Structural vs Nominal typing 1. Tip</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the class has a private field (native with `#` or from TS c `private`), then the class magically becomes Nominal, the name and value can be anything. </font><font style="vertical-align: inherit;">The `!` (Definite assignment assertion) is used to prevent TS from swearing on an uninitialized field (strictNullChecks, strictPropertyInitialization flags are enabled).</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dollar</span> </span>{
  <span class="hljs-comment">// #desc!: never;</span><font></font>
  private desc!: never;<font></font>
  value: number;<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(value: number) {
    <span class="hljs-keyword">this</span>.value = value;<font></font>
  }<font></font>
<font></font>
  add(dollar: Dollar) {<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Dollar(dollar.value + <span class="hljs-keyword">this</span>.value);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Euro</span> </span>{
  <span class="hljs-comment">// #desc!: never;</span><font></font>
  private desc!: never;<font></font>
  value: number;<font></font>
<font></font>
  <span class="hljs-keyword">constructor</span>(value: number) {
    <span class="hljs-keyword">this</span>.value = value;<font></font>
  }<font></font>
<font></font>
  add(euro: Euro) {<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Euro(euro.value + <span class="hljs-keyword">this</span>.value);<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> dollars100 = <span class="hljs-keyword">new</span> Dollar(<span class="hljs-number">100</span>);
<span class="hljs-keyword">const</span> euro100 = <span class="hljs-keyword">new</span> Euro(<span class="hljs-number">100</span>);<font></font>
<font></font>
<span class="hljs-comment">// Correct</span><font></font>
dollars100.add(dollars100);<font></font>
euro100.add(euro100);<font></font>
<font></font>
<span class="hljs-comment">// Error: Argument of type 'Euro' is not assignable to parameter of type 'Dollar</span><font></font>
dollars100.add(euro100);<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type variance 1. Problem</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A programming option, in short, is the ability to pass Supertype / Subtype there, where Type is expected. </font><font style="vertical-align: inherit;">For example, there is a hierarchy Shape -&gt; Circle -&gt; Rectangle, is it possible to transfer or return a Shape / Rectangle if Circle is expected? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Variant in programming </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SO</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can pass the type with the field in which the number lies to a function that expects the field as a string or a number, and mutates the transmitted object in the body, changing the field to a string. </font><font style="vertical-align: inherit;">Those. </font><font style="vertical-align: inherit;">`{status: number} as {status: number | </font><font style="vertical-align: inherit;">string} as {status: string} `here is such a trick as turning a number into a string, causing a </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">surprise</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> error.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">changeStatus</span>(<span class="hljs-params">arg: { status: number | string }</span>) </span>{<font></font>
  arg.status = <span class="hljs-string">"NotFound"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> error: { <span class="hljs-attr">status</span>: number } = { <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> };<font></font>
changeStatus(error);<font></font>
<font></font>
<span class="hljs-comment">// Error: toFixed is not a function</span>
<span class="hljs-built_in">console</span>.log(error.status.toFixed());</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type variance 1. Offer</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/Microsoft/TypeScript/issues/10717</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It is proposed to introduce `in / out` to explicitly limit covariance / contravariance for generics.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">changeStatus</span>&lt;
  <span class="hljs-title">out</span> <span class="hljs-title">T</span> <span class="hljs-title">extends</span> </span>{
    <span class="hljs-attr">status</span>: number | string;<font></font>
  }<font></font>
&gt;(arg: T) {<font></font>
  arg.status = <span class="hljs-string">"NotFound"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> error: { <span class="hljs-attr">status</span>: number } = { <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> };
<span class="hljs-comment">// Error!</span><font></font>
changeStatus(error);<font></font>
<font></font>
<span class="hljs-built_in">console</span>.log(error.status.toFixed());</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type variance 1. Tip</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we work with immutable structures, then there will be no such error (we have already enabled the strictFunctionTypes flag).</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">changeStatus</span>(<span class="hljs-params">arg: Readonly&lt;{ status: number | string }&gt;</span>) </span>{
  <span class="hljs-comment">// Error: Cannot assign, status is not writable</span>
  arg.status = <span class="hljs-string">"NotFound"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> error: Readonly&lt;{ <span class="hljs-attr">status</span>: number }&gt; = { <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> };<font></font>
changeStatus(error);<font></font>
<font></font>
<span class="hljs-built_in">console</span>.log(error.status.toFixed());</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type variance 1. Bonus</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Readonly is assignable to mutable </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/Microsoft/TypeScript/issues/13347 </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/microsoft/TypeScript/pull/6532#issuecomment-174356151</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
But, even if we created Readonly type, TS will not forbid to pass to the function where not expected Readonly `Readonly &lt;{readonly status: number}&gt; as {status: number | </font><font style="vertical-align: inherit;">string} as {status: string} `</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">changeStatus</span>(<span class="hljs-params">arg: { status: number | string }</span>) </span>{<font></font>
  arg.status = <span class="hljs-string">"NotFound"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> error: Readonly&lt;{ readonly status: number }&gt; <font></font>
  = { <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> };<font></font>
changeStatus(error);<font></font>
<font></font>
<span class="hljs-comment">// Error: toFixed is not a function</span>
<span class="hljs-built_in">console</span>.log(error.status.toFixed());</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type variance 2. Problem</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Objects may contain additional fields that the types corresponding to them do not have: `{message: string; </font><font style="vertical-align: inherit;">status: string} as {message: string} `. </font><font style="vertical-align: inherit;">Due to which some operations may not be safe</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> error: { <span class="hljs-attr">message</span>: string; status: string } = {
  <span class="hljs-attr">message</span>: <span class="hljs-string">"No data"</span>,
  <span class="hljs-attr">status</span>: <span class="hljs-string">"NotFound"</span><font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateError</span>(<span class="hljs-params">arg: { message: string }</span>) </span>{
  <span class="hljs-keyword">const</span> defaultError = { <span class="hljs-attr">message</span>: <span class="hljs-string">"Not found"</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> };
  <span class="hljs-keyword">const</span> newError: { <span class="hljs-attr">message</span>: string; status: number }<font></font>
    = { ...defaultError, ...arg };<font></font>
  <font></font>
  <span class="hljs-comment">// Error: toFixed is not a function</span>
  <span class="hljs-built_in">console</span>.log(newError.status.toFixed());<font></font>
}<font></font>
<font></font>
updateError(error);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TS thought that as a result of the merge, `{... {message: string, status: number}, ... {message: string}}` status will be a number. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In reality, `{... {message:" Not found ", status: 404}, ... {message:" No data ", status:" NotFound "},}` status - string.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type variance 2. Offer</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/microsoft/TypeScript/issues/12936</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Introducing an `Exact` type or similar syntax to say that a type cannot contain additional fields.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> error: Exact&lt;{ <span class="hljs-attr">message</span>: string; }&gt; = {
  <span class="hljs-attr">message</span>: <span class="hljs-string">"No data"</span>,<font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateError</span>(<span class="hljs-params">arg: Exact&lt;{ message: string }&gt;</span>) </span>{
  <span class="hljs-keyword">const</span> defaultError = {  <span class="hljs-attr">message</span>: <span class="hljs-string">"Not found"</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">404</span>, };
  <span class="hljs-comment">// Can spread only Exact type!</span>
  <span class="hljs-keyword">const</span> newError = { ...defaultError, ...arg };
  <span class="hljs-built_in">console</span>.log(newError.status.toFixed());<font></font>
}<font></font>
<font></font>
updateError(error);</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type variance 2. Tip</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Merge objects by explicitly listing fields or filtering out unknown fields.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> error: { <span class="hljs-attr">message</span>: string; status: string } = {
  <span class="hljs-attr">message</span>: <span class="hljs-string">"No data"</span>,
  <span class="hljs-attr">status</span>: <span class="hljs-string">"NotFound"</span><font></font>
};<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateError</span>(<span class="hljs-params">arg: { message: string }</span>) </span>{
  <span class="hljs-keyword">const</span> defaultError = { <span class="hljs-attr">message</span>: <span class="hljs-string">"Not found"</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> };
  <span class="hljs-comment">// Merge explicitly or filter unknown fields</span>
  <span class="hljs-keyword">const</span> newError = { ...defaultError, <span class="hljs-attr">message</span>: arg.message };
  <span class="hljs-built_in">console</span>.log(newError.status.toFixed());<font></font>
}<font></font>
<font></font>
updateError(error);</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refinement invalidation. </font><font style="vertical-align: inherit;">Problem</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After we have proved something about the external state, calling functions is not safe, because </font><font style="vertical-align: inherit;">There are no guarantees that functions do not change this external state:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logAge</span>(<span class="hljs-params">name: string, age: number</span>) </span>{
  <span class="hljs-comment">// 2nd call -  Error: toFixed is not a function</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${name}</span> will lose <span class="hljs-subst">${age.toFixed()}</span>`</span>);<font></font>
  person.age = <span class="hljs-string">"PLACEHOLDER"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> person: { <span class="hljs-attr">name</span>: string; age: number | string } = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Person"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">42</span><font></font>
};<font></font>
<font></font>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> person.age === <span class="hljs-string">"number"</span>) {<font></font>
  logAge(person.name, person.age);<font></font>
  <span class="hljs-comment">// refinement should be invalidated</span><font></font>
  logAge(person.name, person.age);<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refinement invalidation. </font><font style="vertical-align: inherit;">Sentence</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/microsoft/TypeScript/issues/7770#issuecomment-334919251</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Add the `pure` modifier for functions, this will at least allow you to trust such functions</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refinement invalidation. </font><font style="vertical-align: inherit;">Tip</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use immutable data structures, then the function call will be a priori safe for previous checks.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The flow type is so strong that it does not have all the problems listed above, but is so running that I would not recommend using it.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exceptions. </font><font style="vertical-align: inherit;">Problem</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TS does not help to work with Exceptions in any way; nothing is clear on the function signature.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { JokeError } <span class="hljs-keyword">from</span> <span class="hljs-string">"../helpers"</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJoke</span>(<span class="hljs-params">isFunny: boolean</span>): <span class="hljs-title">string</span> </span>{
  <span class="hljs-keyword">if</span> (isFunny) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JokeError(<span class="hljs-string">"No funny joke"</span>);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Duh"</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> joke: string = getJoke(<span class="hljs-literal">true</span>);
<span class="hljs-built_in">console</span>.log(joke);
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exceptions. </font><font style="vertical-align: inherit;">Sentence</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/microsoft/TypeScript/issues/13219</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It is proposed to introduce a syntax that allows explicitly describing Exceptions in a function signature</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { JokeError } <span class="hljs-keyword">from</span> <span class="hljs-string">'../helpers'</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJoke</span>(<span class="hljs-params">isFunny: boolean</span>): <span class="hljs-title">string</span> | <span class="hljs-title">throws</span> <span class="hljs-title">JokeError</span> </span>{
  <span class="hljs-comment">/*...*/</span>}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJokeSafe</span>(<span class="hljs-params">isFunny: boolean</span>): <span class="hljs-title">string</span> </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> getJoke(isFunny);<font></font>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> JokeError) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;<font></font>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Should infer error correctly, should cast to never</span>
      <span class="hljs-keyword">return</span> error <span class="hljs-keyword">as</span> never;<font></font>
    }<font></font>
  }<font></font>
}<font></font>
<font></font>
<span class="hljs-built_in">console</span>.log(getJokeSafe(<span class="hljs-literal">true</span>));</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exceptions. </font><font style="vertical-align: inherit;">Bonus</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/microsoft/TypeScript/issues/6283</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
For some reason, in TS, the type definition for Promise ignores the type of error</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> promise1: <span class="hljs-built_in">Promise</span>&lt;number&gt; = <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-number">42</span>);<font></font>
<font></font>
<span class="hljs-keyword">const</span> promise: <span class="hljs-built_in">Promise</span>&lt;never&gt; = <span class="hljs-built_in">Promise</span>.reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>());<font></font>
<font></font>
<span class="hljs-comment">// typescript/lib</span><font></font>
interface PromiseConstructor {<font></font>
  <span class="hljs-keyword">new</span> &lt;T&gt;(<font></font>
    executor: (<font></font>
      resolve: <span class="hljs-function">(<span class="hljs-params">value?: T | PromiseLike&lt;T&gt;</span>) =&gt;</span> <span class="hljs-keyword">void</span>,
      <span class="hljs-attr">reject</span>: <span class="hljs-function">(<span class="hljs-params">reason?: any</span>) =&gt;</span> <span class="hljs-keyword">void</span>
    ) =&gt; <span class="hljs-keyword">void</span>
  ): <span class="hljs-built_in">Promise</span>&lt;T&gt;;<font></font>
}</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exceptions. </font><font style="vertical-align: inherit;">Tip</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Take an Either container like Promise, with only the best typing. </font><font style="vertical-align: inherit;">( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Either implementation example</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { Either, exhaustiveCheck, JokeError } <span class="hljs-keyword">from</span> <span class="hljs-string">"../helpers"</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJoke</span>(<span class="hljs-params">isFunny: boolean</span>): <span class="hljs-title">Either</span>&lt;<span class="hljs-title">JokeError</span>, <span class="hljs-title">string</span>&gt; </span>{
  <span class="hljs-keyword">if</span> (isFunny) {
    <span class="hljs-keyword">return</span> Either.left(<span class="hljs-keyword">new</span> JokeError(<span class="hljs-string">"No funny joke"</span>));<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> Either.right(<span class="hljs-string">"Duh"</span>);<font></font>
}<font></font>
<font></font>
getJoke(<span class="hljs-literal">true</span>)
  <span class="hljs-comment">// (parameter) error: JokeError</span>
  .mapLeft(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> JokeError) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"JokeError"</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      exhaustiveCheck(error);<font></font>
    }<font></font>
  })<font></font>
  <span class="hljs-comment">// (parameter) joke: string</span>
  .mapRight(<span class="hljs-function"><span class="hljs-params">joke</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(joke));
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsafe operations. </font><font style="vertical-align: inherit;">Problem</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we have a tuple of a fixed size, then TS can guarantee that there is something on the requested index. </font><font style="vertical-align: inherit;">This will not work for the array and TS will trust us</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">// ReadOnly fixed size tuple</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> constNumbers: readonly [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] <font></font>
  = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;<font></font>
<font></font>
<span class="hljs-comment">// Error: Object is possibly 'undefined'.</span>
<span class="hljs-built_in">console</span>.log(constNumbers[<span class="hljs-number">100</span>].toFixed());<font></font>
<font></font>
<span class="hljs-keyword">const</span> dynamicNumbers: number[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-built_in">console</span>.log(dynamicNumbers[<span class="hljs-number">100</span>].toFixed());
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsafe operations. </font><font style="vertical-align: inherit;">Sentence</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github.com/microsoft/TypeScript/issues/13778</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
It is proposed to add `undefined` to the return type` T` for index access to the array. </font><font style="vertical-align: inherit;">But in this case, when accessing at any index, you will have to use `?` Or do explicit checks.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">// interface Array&lt;T&gt; {</span>
<span class="hljs-comment">//   [n: number]: T | undefined;</span>
<span class="hljs-comment">// }</span><font></font>
<font></font>
<span class="hljs-keyword">const</span> dynamicNumbers: number[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-comment">// Error: Object is possibly 'undefined'.</span>
<span class="hljs-built_in">console</span>.log(dynamicNumbers[<span class="hljs-number">100</span>].toFixed());<font></font>
<font></font>
<span class="hljs-comment">// Optional chaining `?`</span>
<span class="hljs-built_in">console</span>.log(dynamicNumbers[<span class="hljs-number">100</span>]?.toFixed());<font></font>
<font></font>
<span class="hljs-comment">// type refinement</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> dynamicNumbers[<span class="hljs-number">100</span>] === <span class="hljs-string">'number'</span>) {
  <span class="hljs-built_in">console</span>.log(dynamicNumbers[<span class="hljs-number">100</span>].toFixed());<font></font>
}</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsafe operations. </font><font style="vertical-align: inherit;">Tip</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order not to produce entities beyond need, we take the previously known container `Either` and write a safe function for working with the index, which will return` Either &lt;null, T&gt; `.</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">import</span> { Either } <span class="hljs-keyword">from</span> <span class="hljs-string">"../helpers"</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">safeIndex</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">
  array: T[],
  index: number,
</span>): <span class="hljs-title">Either</span>&lt;<span class="hljs-title">null</span>, <span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-keyword">if</span> (index <span class="hljs-keyword">in</span> array) {
    <span class="hljs-keyword">return</span> Either.right(array[index]);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> Either.left(<span class="hljs-literal">null</span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> dynamicNumbers: number[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<font></font>
<font></font>
safeIndex(dynamicNumbers, <span class="hljs-number">100</span>)<font></font>
  .mapLeft(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Nothing"</span>))<font></font>
  .mapRight(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> el + <span class="hljs-number">2</span>)<font></font>
  .mapRight(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(el.toFixed()));
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus </font><font style="vertical-align: inherit;">Reloading functions</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If we want to say that a function takes a couple of lines and returns a string or takes a couple of numbers and returns a number, then in the implementation these signatures will be contiguous, and the programmer should guarantee their correctness, but on TS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS look at the alternative through generic and conditional types:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a: string, b: string</span>): <span class="hljs-title">string</span>;
<span class="hljs-title">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a: number, b: number</span>): <span class="hljs-title">number</span>;
<span class="hljs-title">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a: string | number,
             b: string | number,
</span>): <span class="hljs-title">string</span> | <span class="hljs-title">number</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${a}</span> + <span class="hljs-subst">${b}</span>`</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">const</span> sum: number = add(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);
<span class="hljs-comment">// Error: toFixed is not a function</span>
sum.toFixed();</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonus </font><font style="vertical-align: inherit;">Type guard</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
TS trusts the programmer that `isSuperUser` correctly determines who` SuperUser` is and if `Vasya` is added, there will be no prompts. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS is worth thinking about how we will distinguish types already at the stage of their union - tagged union</font></font><br>
<br>
<pre><code class="javascript hljs">type SimpleUser = { <span class="hljs-attr">name</span>: string };<font></font>
type SuperUser = { <font></font>
  <span class="hljs-attr">name</span>: string; <font></font>
  isAdmin: <span class="hljs-literal">true</span>; <font></font>
  permissions: string[] <font></font>
};<font></font>
type Vasya = { <span class="hljs-attr">name</span>: string; isAdmin: <span class="hljs-literal">true</span>; isGod: <span class="hljs-literal">true</span> };<font></font>
type User = SimpleUser | SuperUser | Vasya;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isSuperUser</span>(<span class="hljs-params">user: User</span>): <span class="hljs-title">user</span> <span class="hljs-title">is</span> <span class="hljs-title">SuperUser</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">"isAdmin"</span> <span class="hljs-keyword">in</span> user &amp;&amp; user.isAdmin;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">doSomethings</span>(<span class="hljs-params">user: User</span>) </span>{
  <span class="hljs-comment">// Error: Cannot read property 'join' of undefined</span>
  <span class="hljs-keyword">if</span> (isSuperUser(user)) {
    <span class="hljs-built_in">console</span>.log(user.permissions.join(<span class="hljs-string">","</span>));<font></font>
  }<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusions on the tips</font></font></h3><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Nominal types</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Opaque type, private fields </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Type variance</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Exact types, DeepReadonly type </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Exceptions</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Either monad </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Refinement invalidation</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Pure functions </font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Unsafe operations (index access)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Either / Maybe monads </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Immutable data, pure functions, monads ... Congratulations , we proved that FP is cool!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></h3><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TS wants to strike a balance between correctness and productivity</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tests can prove safety and correctness only for test data.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Types can prove the overall security of a program.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mutation - bad, okay?</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As DZ would recommend to play with Flow having corrected a simple error:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-comment">// https://flow.org/try/</span>
declare <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span>(<span class="hljs-params">arg: { name: string, surname?: string }</span>): <span class="hljs-title">void</span>;
<span class="hljs-title">const</span> <span class="hljs-title">person</span>: </span>{ name: string } =  { <span class="hljs-attr">name</span>: <span class="hljs-string">'Negasi'</span> };
<span class="hljs-comment">// Error</span>
log(person);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example code, solution and analysis of the problem, useful links in the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492088/index.html">Testing the Amazon Lumberyard game engine. Approaches and Tools</a></li>
<li><a href="../en492090/index.html">Scrum - the nuances of using a distributed team</a></li>
<li><a href="../en492094/index.html">Update RouterOS on your MikroTik</a></li>
<li><a href="../en492100/index.html">Testing video cards to work with KOMPAS-3D</a></li>
<li><a href="../en492102/index.html">Creation of VK chatbot based on VkBotCore C #</a></li>
<li><a href="../en492108/index.html">How to get to Silicon Valley: 7 ways for it-startup</a></li>
<li><a href="../en492110/index.html">Using a cloud token with support for Russian cryptography on the Android platform</a></li>
<li><a href="../en492112/index.html">Alexander Plyushchev about the politicization of the Internet, the digitalization of power and robots that will replace journalists (but this is not accurate)</a></li>
<li><a href="../en492116/index.html">Trying to deal with striking differences in coronavirus mortality in Italy and South Korea</a></li>
<li><a href="../en492118/index.html">5 myths about UPS, their refutation and the real situation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>