<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⭕️ 👩🏾‍🚀 👨🏼‍⚖️ Mikrotik RouterOSでのマルチバンとルーティング 🔊 ◽️ 🛩️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="2020年2月11日の修正と追加
 前書き 
 虚栄心に加えて、ロシア語を話す電報コミュニティの関連グループでのこのトピックに関する質問の憂鬱な頻度は私に記事を取り上げるように促しました。この記事は、Mikrotik RouterOS（以降、ROS）の初心者管理者を対象としています。ルーティングに重...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Mikrotik RouterOSでのマルチバンとルーティング</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/463813/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2020年2月11日の修正と追加</font></font><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
虚栄心に加えて、ロシア語を話す電報コミュニティの関連グループでのこのトピックに関する質問の憂鬱な頻度は私に記事を取り上げるように促しました。</font><font style="vertical-align: inherit;">この記事は、Mikrotik RouterOS（以降、ROS）の初心者管理者を対象としています。</font><font style="vertical-align: inherit;">ルーティングに重点を置いて、マルチバンのみを考慮します。</font><font style="vertical-align: inherit;">おまけとして、安全で便利な操作を保証するための最小限の設定があります。</font><font style="vertical-align: inherit;">これらのキューの開示、ロードバランシング、vlanov、ブリッジ、チャネルの状態の多段階の詳細な分析などを探している人は、時間と労力の読みを無駄にすることはできません。</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期データ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テスト対象として、ROSバージョン6.45+の5ポートMikrotikルーターが選択されました。</font><font style="vertical-align: inherit;">2つのローカルエリアネットワーク（LAN1とLAN2）と3つのプロバイダー（ISP1、ISP2、ISP3）の間でトラフィックをルーティングします。</font><font style="vertical-align: inherit;">ISP1へのチャネルには静的な「グレー」アドレスがあり、ISP2はDHCP経由で受信した「ホワイト」、ISP3はPPPoE認証を使用した「ホワイト」です。</font><font style="vertical-align: inherit;">接続スキームを図に示します</font></font><br>
<br>
<img src="https://habrastorage.org/webt/pd/di/mv/pddimv_vbwqmityow2oe2oxngam.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。タスクは、スキームに基づいてMTKルーターを構成し、次のようにします。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バックアッププロバイダーへの自動切り替えを提供します。</font><font style="vertical-align: inherit;">メインプロバイダーはISP2、最初の予約はISP1、2番目の予約はISP3です。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ISP1を介してのみインターネットへのLAN1アクセスを整理するため。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アドレスリストに基づいて、選択したプロバイダーを介してローカルネットワークからインターネットにトラフィックをルーティングする機能を提供します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ローカルエリアネットワークからインターネットにサービスを公開する可能性を提供する（DSTNAT）</font></font></li>
<li>          .</li>
<li>               .</li>
<li>     ,     ( LAN).</li>
</ol><br>
<i><b>.</b>    “  ”,             “ ”.      Winbox,     .        Winbox.          Ether5.</i><br>
<br>
<h4>   ,   ,          </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
興味深く注意深い管理者は、自分でそのようなスキームを設定すると、突然、それがすでに正常に機能していることに突然気づきます。はい、はい。カスタムルーティングテーブルや他のルートルールがなければ、このトピックに関するほとんどの記事でいっぱいです。見てみな？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターフェイスとデフォルトゲートウェイのアドレス指定を構成できますか？はい：</font><b><font style="vertical-align: inherit;">距離= 2</font></b><font style="vertical-align: inherit;">および</font><b><font style="vertical-align: inherit;">チェックゲートウェイ= ping</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
のアドレスとゲートウェイがISP1に登録されました</font><b><font style="vertical-align: inherit;">。</font></b><font style="vertical-align: inherit;"> 
ISP2では、クライアントのデフォルトのdhcp設定はそれぞれ、1に等しい距離です。</font><font style="vertical-align: inherit;">
ISP3では、クライアントのpppoe設定で</font><b><font style="vertical-align: inherit;">add-default-route = yesを</font></b><font style="vertical-align: inherit;">設定し、</font><b><font style="vertical-align: inherit;">default-route-distance = 3を</font></b><font style="vertical-align: inherit;">設定し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
出力にNATを登録することを忘れないでください：</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ ip firewall nat add action = masquerade chain = srcnat out-interface-list = WAN</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
結果として、LANのユーザーはメインのISP2プロバイダーを通じて楽しい負荷をかけ、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェックゲートウェイ</font></font></b> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メカニズムを使用してチャネルの予約があります</font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。注1を参照してください。</font></font></sup><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
タスクのポイント1が実装されています。タグ付きのマルチバンはどこにありますか？いいえ...詳細</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。 ISP1を介してLANから特定のクライアントを解放する必要があります。/ </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ip firewall mangle add action = route chain = prerouting dst-address-list =！BOGONS \ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
passthrough = yes route-dst = 100.66.66.1 src-address-list = Via_ISP1 </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
/ ip firewall mangle add action = route chain = prerouting dst-address-list =！BOGONS \ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
passthrough = no route-dst = 100.66.66.1 src-address = 192.168.88.0 / 24</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
タスクの項目2および3が実装されます。タグ、スタンプ、ルートルール、どこにいるの？！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターネットからクライアントに172.17.17.17のアドレスを持つお気に入りのOpenVPNサーバーへのアクセスを許可する必要がありますか？してください：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ IPクラウドセットDDNSが有効= yesの私たちは、</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
クライアントへの出力結果を与える：「</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：PUT [IPクラウドGET DNS名]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」我々は、</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターネットからのポート転送を記述します</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ IPファイアウォール、NATの追加アクション= dstnatチェーン= dstnat dst-port = 1194 \ </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
in-interface-list = WAN protocol = udp to-addresses = 172.17.17.17</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Point 4 is ready。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ポイント5にファイアウォールとその他のセキュリティを設定すると同時に、すべてがユーザーに機能し、お気に入りの飲み物が入ったコンテナに手を伸ばしていることをうれしく思います... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ああ！トンネルはまだ忘れられています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
グーグルの記事に従って設定されたl2tpクライアントは、愛されているオランダのVDSに昇格しましたか？はい。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IPsecを使用したl2tp-serverが上昇し、IPクラウドからDNS名でクライアントを取得します（上記を参照）。はい。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
後ろに寄り、飲み物を一口飲んで、問題の項目6と7を怠惰に調べます。必要だと思いますか？すべてがそのように機能します...必要がない場合は、それですべてです。マルチバンが実装されました。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルチバンとは何ですか？これは、1つのルーターへの複数のインターネットチャネルの接続です。</font></font></b> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
疑わしい適用性の誇示以外に何があるので、この記事をこれ以上読むことはできませんか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残っている人、タスクのポイント6と7に興味があり、完璧主義のかゆみを感じている人たちと一緒に、さらに深く潜ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マルチバンを実装する最も重要なタスクは、トラフィックの正しいルーティングです。つまり：どちらの場合でも（どちらでも）</font></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注3を参照</font></font></sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロバイダーのチャネルはルーターのデフォルトルートを調べ、パケットの送信元のチャネルに正確に応答を返す必要があります。タスクは明確です。問題はどこだ？確かに、単純なローカルネットワークでもタスクは同じですが、追加の設定で煩わされることはなく、問題もありません。違いは、単純なLANのように、厳密に特定されたものを介してではなく、インターネット上のすべてのルーティングされたノードに各チャネルを介してアクセスできることです。しかし、「トラブル」は、ISP3のIPアドレスの要求を受け取った場合、デフォルトゲートウェイがそこに向けられているため、この場合、回答はISP2チャネルを経由することです。これはそのままになり、プロバイダーによって正しくないものとして破棄されます。問題を決めた。それを解決するには？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソリューションは3つの段階に分かれています。</font></font><br>
<br>
<ol>
<li><b> . </b>        :  , , address lists, hairpin NAT  . </li>
<li><b>.</b>            .</li>
<li><b>  ISP.</b>      ,    ,       .</li>
</ol><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ISPへの接続の3つの異なるタイプは、動的アドレスを使用してマルチバンを設定することで解決できないことはないことを示し、ソリューションオプションの1つを示すために選択されました。</font></font></i><br>
<u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要！</font></font></b></u><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">距離</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルートのコストを使用して指定されたアルゴリズムに従ってチャネルを切り替えるに</font><font style="vertical-align: inherit;">は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェックゲートウェイ</font></font></b> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メカニズムを使用し</font><b><font style="vertical-align: inherit;">ます。</font></b></font><sup><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注1を参照してください。</font></font></sup> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
記事に記載されているスクリプトは、チャネル予約とは関係ありません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.プリセット</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.1。</font><font style="vertical-align: inherit;">次のコマンドでルーターの設定をクリアします。</font></font><br>
<br>
<pre><code class="plaintext hljs">/system reset-configuration skip-backup=yes no-defaults=yes</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">危険！</font><font style="vertical-align: inherit;">とにかくリセットしますか？</font><font style="vertical-align: inherit;">[y / N]：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「そして、再起動後、MAC経由でWinboxに接続します。</font><font style="vertical-align: inherit;">この段階で、構成とユーザーベースはクリアされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.2。</font><font style="vertical-align: inherit;">新しいユーザーを作成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/user add group=full name=knight password=ultrasecret comment="Not horse"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その下にログインして、デフォルトを削除します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/user remove admin</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作成者がより安全であると考え、使用を推奨するのは、デフォルトユーザーの切断ではなく削除です。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.3。</font><font style="vertical-align: inherit;">ファイアウォール、検出設定、その他のMACサーバーでの操作に便利な基本的なインターフェースリストを作成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/interface list add name=WAN comment="For Internet"<font></font>
/interface list add name=LAN comment="For Local Area"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コメント付きのインターフェースに署名します </font></font><br>
<br>
<pre><code class="plaintext hljs">/interface ethernet set ether1 comment="to ISP1"<font></font>
/interface ethernet set ether2 comment="to ISP2"<font></font>
/interface ethernet set ether3 comment="to ISP3"<font></font>
/interface ethernet set ether4 comment="to LAN1"<font></font>
/interface ethernet set ether5 comment="to LAN2"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターフェースリストに入力します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/interface list member add interface=ether1 list=WAN comment=ISP1<font></font>
/interface list member add interface=ether2 list=WAN comment=ISP2 <font></font>
/interface list member add interface=ether3 list=WAN comment="to ISP3"<font></font>
/interface list member add interface=ether4 list=LAN comment=LAN1<font></font>
/interface list member add interface=ether5 list=LAN comment=LAN2<font></font>
</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明確なコメントを書くことは、これに費やす時間の価値があるだけでなく、構成のトラブルシューティングと理解を大幅に促進します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
著者は、セキュリティ上の理由から、ipプロトコルは通過しないという事実にもかかわらず、ether3インターフェースをインターフェースリスト「WAN」に追加する必要があると考えています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PPPインターフェースがether3で上げられた後、「WAN」</font></font></i> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
1.4</font><i><font style="vertical-align: inherit;">インターフェースリストに追加する必要があることを忘れないでください</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">MAC経由でプロバイダーのネットワークからルーターを近接検出および制御から隠します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip neighbor discovery-settings set discover-interface-list=!WAN<font></font>
/tool mac-server set allowed-interface-list=LAN<font></font>
/tool mac-server mac-winbox set allowed-interface-list=LAN</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.5。</font><font style="vertical-align: inherit;">ルーターを保護するために最低限必要なファイアウォールフィルタールールのセットを作成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter add action=accept chain=input \<font></font>
comment="Related Established Untracked Allow" \<font></font>
connection-state=established,related,untracked</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（このルールは、接続されたネットワークとルーター自体の両方から開始される確立された接続と関連する接続に許可を提供します）</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter add action=accept chain=input \<font></font>
comment="ICMP from ALL" protocol=icmp</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（pingだけでなく、pingも実行できます。すべてのicmpを入力できます。MTUの問題を見つけるのに非常に役立ちます）</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter add action=drop chain=input comment="All other WAN Drop" \<font></font>
in-interface-list=WAN</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（入力チェーンを閉じるルールは、インターネットから到着する他のすべてを禁止します）</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter add action=accept chain=forward \<font></font>
comment="Established, Related, Untracked allow" \<font></font>
connection-state=established,related,untracked</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（このルールは、ルーターを通過する確立済みの関連接続を許可します）</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter add action=drop chain=forward comment="Invalid drop" \<font></font>
connection-state=invalid</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（このルールは、connection-state = invalidで、ルーターを通過する接続をドロップします。Mikrotikで強く推奨されていますが、まれな状況で、有用なトラフィックをブロックする可能性があります）</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall filter add action=drop chain=forward \<font></font>
comment="Drop all from WAN not DSTNATed" connection-nat-state=!dstnat \<font></font>
connection-state=new in-interface-list=WAN</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（このルールは、インターネットから送信され、ルーターを介してdstnat手順を実行しなかったパケットを禁止します。これにより、外部ネットワークと同じブロードキャストドメインにあり、外部IPをゲートウェイとして登録する侵入者からローカルネットワークを保護します。ローカルエリアネットワークを「探索」します。）</font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LAN1とLAN2は信頼されたネットワークであり、それらの間のトラフィックとそれらからのトラフィックはフィルタリングされないと仮定します。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.6。</font><font style="vertical-align: inherit;">ルーティング不可能なネットワークのリストを含むリストを作成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall address-list<font></font>
add address=0.0.0.0/8 comment="\"This\" Network" list=BOGONS<font></font>
add address=10.0.0.0/8 comment="Private-Use Networks" list=BOGONS<font></font>
add address=100.64.0.0/10 comment="Shared Address Space. RFC 6598" list=BOGONS<font></font>
add address=127.0.0.0/8 comment=Loopback list=BOGONS<font></font>
add address=169.254.0.0/16 comment="Link Local" list=BOGONS<font></font>
add address=172.16.0.0/12 comment="Private-Use Networks" list=BOGONS<font></font>
add address=192.0.0.0/24 comment="IETF Protocol Assignments" list=BOGONS<font></font>
add address=192.0.2.0/24 comment=TEST-NET-1 list=BOGONS<font></font>
add address=192.168.0.0/16 comment="Private-Use Networks" list=BOGONS<font></font>
add address=198.18.0.0/15 comment="Network Interconnect Device Benchmark Testing"\<font></font>
 list=BOGONS<font></font>
add address=198.51.100.0/24 comment=TEST-NET-2 list=BOGONS<font></font>
add address=203.0.113.0/24 comment=TEST-NET-3 list=BOGONS<font></font>
add address=224.0.0.0/4 comment=Multicast list=BOGONS<font></font>
add address=192.88.99.0/24 comment="6to4 Relay Anycast" list=BOGONS<font></font>
add address=240.0.0.0/4 comment="Reserved for Future Use" list=BOGONS<font></font>
add address=255.255.255.255 comment="Limited Broadcast" list=BOGONS</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
（これは、インターネットにルーティングされないアドレスとネットワークのリストであり、したがって、これにも従います。）</font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リストは変更される可能性があるため、関連性を定期的に確認することをお勧めします。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.7。</font><font style="vertical-align: inherit;">ルーター自体のDNSを構成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip dns set servers=1.1.1.1,8.8.8.8</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ROSの現在のバージョンでは、動的サーバーが静的に定義されたサーバーよりも優先されます。</font><font style="vertical-align: inherit;">名前解決要求は、リストの順序で最初のサーバーに送信されます。</font><font style="vertical-align: inherit;">次のサーバーへの移行は、現在のサーバーが利用できないときに実行されます。</font><font style="vertical-align: inherit;">大きなタイムアウト-5秒以上。</font><font style="vertical-align: inherit;">「倒れたサーバー」が再開されたときに戻ることは、自動的には起こりません。</font><font style="vertical-align: inherit;">このアルゴリズムとマルチバンの存在を考えると、著者はプロバイダーによって発行されたサーバーを使用しないことをお勧めします。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.8。</font><font style="vertical-align: inherit;">ローカルネットワークを構成します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.8.1。</font><font style="vertical-align: inherit;">ローカルネットワークインターフェイスで静的IPアドレスを構成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip address add interface=ether4 address=192.168.88.254/24 comment="LAN1 IP"<font></font>
/ip address add interface=ether5 address=172.16.1.0/23 comment="LAN2 IP"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 1.8.2。</font><font style="vertical-align: inherit;">メインルーティングテーブルを通じてローカルネットワークへのルートのルールを設定します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip route rule add dst-address=192.168.88.0/24 table=main comment="to LAN1"<font></font>
/ip route rule add dst-address=172.16.0.0/23 table=main comment="to LAN2"</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、デフォルトルートが経由しないルーターインターフェイスの外部IPアドレスを使用してローカルネットワークアドレスにアクセスする最も簡単で迅速な方法の1つです。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.8.3。</font><font style="vertical-align: inherit;">必要に応じて、LAN1およびLAN2のヘアピンNATを有効にします。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall nat add action=src-nat chain=srcnat comment="Hairpin to LAN1" \<font></font>
out-interface=ether4 src-address=192.168.88.0/24 to-addresses=192.168.88.254<font></font>
/ip firewall nat add action=src-nat chain=srcnat comment="Hairpin to LAN2" \<font></font>
out-interface=ether5 src-address=172.16.0.0/23 to-addresses=172.16.1.0</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これにより、LAN1およびLAN2のユーザーは、外部IP（dstnat）を介して、同じネットワークセグメント上のユーザーと一緒に配置されているサーバーにアクセスできます。</font></font></i><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.実際には、正しいマルチバンの実装</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「彼らが尋ねたところから答える」という問題を解決するために、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続マーク</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルーティングマークの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2つのROSツールを使用</font><font style="vertical-align: inherit;">し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続マークを</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用すると、目的の接続にマークを付け、後でこのラベルを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルーティングマーク</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を適用するための条件として使用できます</font><font style="vertical-align: inherit;">。そして、すでにして</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マークをルーティングする</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ことがで作業することが可能である</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、IPルーティング</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルーティングルール</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。ツールを見つけたので、次に、どの接続にラベルを付けるか（1つは、どこにラベルを付けるか）を決定する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つ目は、すべてが簡単です。適切なチャネルを介してインターネットからルーターに到達するすべての接続をマークする必要があります。私たちの場合、これらは3つのラベル（チャネルの数に応じて）になります：「conn_isp1」、「conn_isp2」、「conn_isp3」。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のニュアンスは、着信接続が2つのタイプ（中継とルーター自体を対象とする接続）になることです。接続マークメカニズムは</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マングル</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブルで機能します</font><font style="vertical-align: inherit;">。親切mikrotik-trainings.comリソース（広告ではない）の専門家によって組み立て略図でパケットの動きを考える：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/gg/yc/u4/ggycu4_z4ps93z-crahvri9pshw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
矢印に続いて、我々は「に到着するパケットがわかり</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">入力インタフェースは</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」「を通過</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PREROUTING</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font><font style="vertical-align: inherit;">鎖</font><font style="vertical-align: inherit;">とだけにしてトランジットに分割されています「</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ルーティング決定</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font><font style="vertical-align: inherit;">ブロックでローカル</font><font style="vertical-align: inherit;">。したがって、2羽の鳥を殺すには、</font><font style="vertical-align: inherit;">テーブル</font><b><font style="vertical-align: inherit;">マングルプレルーティング</font></b><font style="vertical-align: inherit;">チェーン</font><b><font style="vertical-align: inherit;">プレルーティングの</font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接続マーク</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用し</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font><i><b><font style="vertical-align: inherit;">コメント</font></b></i></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<i><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。 ROSでは、「ルーティングマーク」マークは、IP /ルート/ルールセクションでは「テーブル」として示され、残りのセクションでは「ルーティングマーク」として示されます。これは理解を混乱させる可能性がありますが、実際にはまったく同じであり、Linuxのiproute2のrt_tablesに類似しています。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
2.1。各プロバイダーからの着信接続をマークします。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall mangle add action=mark-connection chain=prerouting \<font></font>
comment="Connmark in from ISP1" connection-mark=no-mark in-interface=ether1 \<font></font>
new-connection-mark=conn_isp1 passthrough=no<font></font>
<font></font>
/ip firewall mangle add action=mark-connection chain=prerouting \<font></font>
comment="Connmark in from ISP2" connection-mark=no-mark in-interface=ether2 \<font></font>
new-connection-mark=conn_isp2 passthrough=no<font></font>
<font></font>
/ip firewall mangle add action=mark-connection chain=prerouting \<font></font>
comment="Connmark in from ISP3" connection-mark=no-mark in-interface=pppoe-isp3 \<font></font>
new-connection-mark=conn_isp3 passthrough=no</code></pre><br>
<i><b>.</b> <br>
 ,            ,       : «input does not match any value of interface».         «pppoe-isp3»,     . 3.3.2.      «pppoe-isp3»  «ether3».   . 3.3.2       .<br>
<br>
 ,          connection-mark=no-mark  connection-state=new. <br>
<br>
passthrough=no — ,                  .</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでもルーティングに干渉しないことに注意してください。今は準備段階だけです。実装の次の段階は、ローカルネットワークの宛先から安定した接続を介して返されるトランジットトラフィックの処理です。それら。 （図を参照）が、これらのパケットは、パスに沿ったルータを介して行ってきました：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「入力インタフェース」=&gt;「PREROUTING」=&gt;「ルーティング決定」=&gt;「進む」=&gt;「ポストルーティング」=&gt;「ポストルーティング」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">とになった彼らのローカルネットワーク上の宛先。</font></font><br>
<br>
<u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要！</font></font></b></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ROSでは、外部インターフェースと内部インターフェースへの論理的な分割はありません。下の図で応答パケットのパスをトレースすると、リクエストと同じ論理パスをたどります。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“入力インターフェイス” =&gt;”事前ルーティング” =&gt;”ルーティング決定” =&gt;”転送” =&gt;”ポストルーティング” = &gt;”出力インターフェース”</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要求のためだけに「</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">入力インターフェース</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」はISPインターフェースであり、答えのために-LAN </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.2。</font><font style="vertical-align: inherit;">リターントランジットトラフィックを対応するルーティングテーブルに転送します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall mangle add action=mark-routing chain=prerouting \<font></font>
comment="Routemark transit out via ISP1" connection-mark=conn_isp1 \<font></font>
dst-address-type=!local in-interface-list=!WAN new-routing-mark=to_isp1 passthrough=no<font></font>
<font></font>
/ip firewall mangle add action=mark-routing chain=prerouting \<font></font>
comment="Routemark transit out via ISP2" connection-mark=conn_isp2 \<font></font>
dst-address-type=!local in-interface-list=!WAN new-routing-mark=to_isp2 passthrough=no<font></font>
<font></font>
/ip firewall mangle add action=mark-routing chain=prerouting \<font></font>
comment="Routemark transit out via ISP3" connection-mark=conn_isp3 \<font></font>
dst-address-type=!local in-interface-list=!WAN new-routing-mark=to_isp3 passthrough=no</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font><font style="vertical-align: inherit;">in-interface-list =！WAN-ローカルネットワークからのトラフィックのみを処理し、dst-address-type =！localは、ルーター自体のインターフェースのアドレスの宛先アドレスなしで動作します。</font></font><br>
</b></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
途中でルーターに到着したローカルパケットについても同様です：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「入力インターフェイス」=&gt;「事前ルーティング」=&gt;「ルーティング決定」=&gt;「入力」=&gt;「ローカルプロセス」</font></font></b><br>
 <br>
<u><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重要！</font></font></b></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">答えは次のパスに沿って進みます：</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ローカルプロセス」=&gt;「ルーティング決定」=&gt;「出力」=&gt;「ポストルーティング」=&gt;「出力インターフェイス」</font></font><br>
</b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
2.3。</font><font style="vertical-align: inherit;">応答ローカルトラフィックを対応するルーティングテーブルに転送します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall mangle add action=mark-routing chain=output \<font></font>
comment="Routemark local out via ISP1" connection-mark=conn_isp1 \<font></font>
dst-address-type=!local new-routing-mark=to_isp1 passthrough=no<font></font>
<font></font>
/ip firewall mangle add action=mark-routing chain=output \<font></font>
comment="Routemark local out via ISP2" connection-mark=conn_isp2 \<font></font>
dst-address-type=!local new-routing-mark=to_isp2 passthrough=no<font></font>
<font></font>
/ip firewall mangle add action=mark-routing chain=output \<font></font>
comment="Routemark local out via ISP3" connection-mark=conn_isp3 \<font></font>
dst-address-type=!local new-routing-mark=to_isp3 passthrough=no</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この段階で、要求の送信元であるインターネットチャネルに応答を送信する準備のタスクは解決されたと見なすことができます。</font><font style="vertical-align: inherit;">すべてがマークされ、マークが付けられ、ルーティングの準備ができています。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この設定の優れた「副作用」は、両方の（ISP2、ISP3）プロバイダーから同時にDSNATポートを転送できることです。</font><font style="vertical-align: inherit;">ISP1にはルーティング可能なアドレスがないため、まったくありません。</font><font style="vertical-align: inherit;">この効果は、たとえば、異なるインターネットチャネルを参照する2つのMXを備えたメールサーバーにとって重要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外部IPルーターを使用したローカルネットワークのニュアンスを排除するために、段落のソリューションを使用します。</font><font style="vertical-align: inherit;">1.8.2および3.1.2.6。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、マーキング付きのツールを使用して、問題の段落3を解決できます。</font><font style="vertical-align: inherit;">次のように実装します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.4。</font><font style="vertical-align: inherit;">ローカルクライアントからのトラフィックをルーティングリストから対応するテーブルに転送します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall mangle add action=mark-routing chain=prerouting \<font></font>
comment="Address List via ISP1" dst-address-list=!BOGONS new-routing-mark=to_isp1 \<font></font>
passthrough=no src-address-list=Via_ISP1<font></font>
<font></font>
/ip firewall mangle add action=mark-routing chain=prerouting \<font></font>
comment="Address List via ISP2" dst-address-list=!BOGONS new-routing-mark=to_isp2 \<font></font>
passthrough=no src-address-list=Via_ISP2<font></font>
<font></font>
/ip firewall mangle add action=mark-routing chain=prerouting \<font></font>
comment="Address List via ISP3" dst-address-list=!BOGONS new-routing-mark=to_isp3 \<font></font>
passthrough=no src-address-list=Via_ISP3</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その結果、次のようになります（画像はクリック可能です）。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/jw/bt/of/jwbtofiohmdeunznqgpnamyuhrm.jpeg"></a><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. ISP接続を構成し、ブランドベースのルーティングを有効にする</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.1。</font><font style="vertical-align: inherit;">ISP1への接続を設定します：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.1.1。</font><font style="vertical-align: inherit;">静的IPアドレスを構成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip address add interface=ether1 address=100.66.66.2/30 comment="ISP1 IP"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 3.1.2。</font><font style="vertical-align: inherit;">静的ルーティングを設定します：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.1.2.1。</font><font style="vertical-align: inherit;">デフォルトの緊急ルートを追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip route add comment="Emergency route" distance=254 type=blackhole</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このルートにより、ローカルプロセスからのトラフィックは、プロバイダーのチャネルの状態に関係なく、ルート決定ステージを通過できます。発信ローカルトラフィックのニュアンスは、パケットが少なくともどこかに移動するために、デフォルトゲートウェイへのアクティブなルートがメインルーティングテーブルに存在する必要があることです。そうでない場合、パッケージは単に破棄されます。</font></font></i> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チャネル状態をより深く分析</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
する</font><font style="vertical-align: inherit;">ため</font><font style="vertical-align: inherit;">の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チェックゲートウェイ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツールの拡張として、</font><font style="vertical-align: inherit;">再帰的ルート方式の使用を提案します。この方法の本質は、直接ではなく中間ゲートウェイを介して、ゲートウェイへのパスを検索するようにルーターに指示することです。そのような「テスト」ゲートウェイとして、4.2.2.1、4.2.2.2、4.2.2.3がそれぞれISP1、ISP2、ISP3に選択されます。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.1.2.2。</font><font style="vertical-align: inherit;">「確認」アドレスにルーティングします。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip route add check-gateway=ping comment="For recursion via ISP1" \<font></font>
distance=1 dst-address=4.2.2.1 gateway=100.66.66.1 scope=10</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さらに4.2.2.1を再帰的ゲートウェイとして使用するために、スコープ値はROSターゲットスコープでデフォルトに削減されます。</font><font style="vertical-align: inherit;">「検証」アドレスへのルートのスコープは、検証を参照するルートのターゲットスコープ以下にする必要があります。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.1.2.3。</font><font style="vertical-align: inherit;">ルーティングマークのないトラフィックのデフォルトの再帰ルート：</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip route add check-gateway=ping comment="Unmarked via ISP1" \<font></font>
distance=2 gateway=4.2.2.1</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ISP1はタスクの条件下で最初のスタンバイとして宣言されているため、距離= 2の値が使用されます。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.1.2.4。</font><font style="vertical-align: inherit;">ルーティングマーク「to_isp1」が付いたトラフィックのデフォルトの再帰ルート：</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip route add comment="Marked via ISP1 Main" distance=1 gateway=4.2.2.1 \<font></font>
routing-mark=to_isp1</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実際、ここでようやくステップ2で実行した準備作業を利用し始めます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このルートでは、ルート「to_isp1」とマークされているすべてのトラフィックは、現在の状況に関係なく、最初のプロバイダーのゲートウェイに送信されます。メインテーブルのデフォルトゲートウェイがアクティブです。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.1.2.5。</font><font style="vertical-align: inherit;">ラベル付きISP2およびISP3トラフィックの最初のデフォルトのフォールバック再帰ルート：</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip route add comment="Marked via ISP2 Backup1" distance=2 gateway=4.2.2.1 \<font></font>
routing-mark=to_isp2<font></font>
/ip route add comment="Marked via ISP3 Backup1" distance=2 gateway=4.2.2.1 \<font></font>
routing-mark=to_isp3</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらのルートは、アドレスリスト「to_isp *」のメンバーであるローカルネットワークからのトラフィックを予約するためにも必要です</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
。</font><font style="vertical-align: inherit;">ISP1を介したインターネットへのローカルルータートラフィックのルートを規定します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip route rule add comment="From ISP1 IP to Inet" src-address=100.66.66.2 table=to_isp1</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1.8.2項のルールと組み合わせて、特定のソースを持つ目的のチャネルへの出口が提供されます。これは、ローカル側のIPアドレス（EoIP、IP-IP、GRE）が指定されているトンネルを構築するために重要です。 ip routeルールのルールは上から下に実行されるため、条件が初めて一致するまで、このルールは1.8.2のルールの後にある必要があります。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
3.1.3。発信トラフィックのNATルールを登録します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall nat add action=src-nat chain=srcnat comment="NAT via ISP1" \<font></font>
ipsec-policy=out,none out-interface=ether1 to-addresses=100.66.66.2</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NATは、IPsecポリシーに該当することを除いて、すべてのことです。</font><font style="vertical-align: inherit;">どうしても必要な場合を除いて、action = masqueradeは使用しないようにしています。</font><font style="vertical-align: inherit;">新しい接続ごとにNATのアドレスを計算するため、src-natよりも低速でリソースを集中的に使用します。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.1.4。</font><font style="vertical-align: inherit;">他のプロバイダーを介してアクセスを拒否されたクライアントを、ISP1プロバイダーゲートウェイに直接送信します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip firewall mangle add action=route chain=prerouting \<font></font>
comment="Address List via ISP1 only" dst-address-list=!BOGONS passthrough=no \<font></font>
route-dst=100.66.66.1 src-address-list=Via_only_ISP1 place-before=0</code></pre><br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">action = routeは優先度が高く、他のルーティングルールよりも早く適用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
place-before = 0-リストの最初にルールを置きます。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.2。</font><font style="vertical-align: inherit;">ISP2への接続を設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ISP2プロバイダーはDHCPを介して設定を提供するため、DHCPクライアントがトリガーされたときに開始するスクリプトを使用して必要な変更を加えるのが妥当です。</font></font><br>
<br>
<pre><code class="plaintext hljs">/ip dhcp-client<font></font>
add add-default-route=no disabled=no interface=ether2 script=":if (\$bound=1) do={\r\<font></font>
    \n   /ip route remove [ find gateway=\"4.2.2.2\" ]; /ip route remove \<font></font>
          [ find where dst-address ~\"4.2.2.2\" ]\r\<font></font>
    \n   /ip route add check-gateway=ping comment=\"For recursion via ISP2\" \<font></font>
          distance=1 dst-address=4.2.2.2/32 gateway=\$\"gateway-address\" scope=10\r\<font></font>
    \n   /ip route add check-gateway=ping comment=\"Unmarked via ISP2\" \<font></font>
          distance=1 gateway=4.2.2.2\r\<font></font>
    \n   /ip route add comment=\"Marked via ISP2 Main\" distance=1 gateway=4.2.2.2 \<font></font>
          routing-mark=to_isp2\r\<font></font>
    \n   /ip route add comment=\"Marked via ISP1 Backup1\" distance=2 \<font></font>
          gateway=4.2.2.2 routing-mark=to_isp1\r\<font></font>
    \n   /ip route add comment=\"Marked via ISP3 Backup2\" distance=3 \<font></font>
          gateway=4.2.2.2 routing-mark=to_isp3\r\<font></font>
    \n   /ip firewall nat add action=src-nat chain=srcnat ipsec-policy=out,none \<font></font>
          out-interface=\$\"interface\" to-addresses=\$\"lease-address\" \<font></font>
          comment=\"NAT via ISP2\"\r\<font></font>
    \n   /ip route rule add comment=\"From ISP2 IP to Inet\" \<font></font>
          src-address=\$\"lease-address\" table=to_isp2 \r\<font></font>
    \n} else={\r\<font></font>
    \n   /ip route remove [ find gateway=\"4.2.2.2\" ]; /ip route remove \<font></font>
          [ find where dst-address ~\"4.2.2.2\" ]\r\<font></font>
    \n   /ip firewall nat remove  [find comment=\"NAT via ISP2\"]\r\<font></font>
    \n   /ip route rule remove [find comment=\"From ISP2 IP to Inet\"]\r\<font></font>
    \n}\r\<font></font>
    \n" use-peer-dns=no use-peer-ntp=no</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Winboxウィンドウのスクリプト自体（クリック可能）：</font><i><b><font style="vertical-align: inherit;">注。</font></b></i><i><font style="vertical-align: inherit;">スクリプトの最初の部分はリースが正常に受信されたときにトリガーされ、2番目の部分はリースが解放された後にトリガーされます。</font></i><sup><font style="vertical-align: inherit;">注2</font></sup><font style="vertical-align: inherit;"> 
3.3を</font><sup><font style="vertical-align: inherit;">参照してください</font></sup><font style="vertical-align: inherit;">。 ISP3プロバイダーへの接続を構成します。</font><font style="vertical-align: inherit;">
構成プロバイダーは動的を提供するので、pppインターフェースの上昇後と下降後に開始するスクリプトを使用して必要な変更を加えるのが妥当です。</font><i><b><font style="vertical-align: inherit;">コメント。</font></b></i><i><font style="vertical-align: inherit;"> pppインターフェースは、IPアドレスの代わりにゲートウェイとして指定できます。ただし、この場合、再帰ルートをアクティブにすることはできません。したがって、プロバイダー側​​のIPアドレスを変数に入れ、他のプロバイダーと同じようにさらに使用します</font></i><font style="vertical-align: inherit;"> 
3.3.1。まず、プロファイルを構成します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/dz/_f/hh/dz_fhhyltpdet5oush5wqwpud2e.jpeg"></a><br>
<i><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font></i><sup><font style="vertical-align: inherit;"></font></sup><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<i><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font></i><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="plaintext hljs">/ppp profile<font></font>
add comment="for PPPoE to ISP3" interface-list=WAN name=isp3_client \<font></font>
on-down="/ip route remove [ find gateway=\"4.2.2.3\" ]\r\<font></font>
    \n/ip route remove [ find where dst-address ~\"4.2.2.3\" ]\r\<font></font>
    \n/ip firewall nat remove  [find comment=\"NAT via ISP3\"]\r\<font></font>
    \n/ip route rule remove [find comment=\"From ISP3 IP to Inet\"]" \<font></font>
on-up="/ip route remove [ find gateway=\"4.2.2.3\" ]; /ip route remove \<font></font>
    [ find where dst-address ~\"4.2.2.3\" ]\r\<font></font>
    \n/ip route add check-gateway=ping comment=\"For recursion via ISP3\" distance=1 \<font></font>
    dst-address=4.2.2.3/32 gateway=\$\"remote-address\" scope=10\r\<font></font>
    \n/ip route add check-gateway=ping comment=\"Unmarked via ISP3\" distance=3 \<font></font>
    gateway=4.2.2.3\r\<font></font>
    \n/ip route add comment=\"Marked via ISP3 Main\" distance=1 gateway=4.2.2.3 \<font></font>
    routing-mark=to_isp3\r\<font></font>
    \n/ip route add comment=\"Marked via ISP1 Backup2\" distance=3 gateway=4.2.2.3 \<font></font>
    routing-mark=to_isp1\r\<font></font>
    \n/ip route add comment=\"Marked via ISP2 Backup2\" distance=3 gateway=4.2.2.3 \<font></font>
    routing-mark=to_isp2\r\<font></font>
    \n/ip firewall mangle set [find comment=\"Connmark in from ISP3\"] \<font></font>
    in-interface=\$\"interface\"\r\<font></font>
    \n/ip firewall nat add action=src-nat chain=srcnat ipsec-policy=out,none \<font></font>
    out-interface=\$\"interface\" to-addresses=\$\"local-address\" \<font></font>
    comment=\"NAT via ISP3\"\r\<font></font>
    \n/ip route rule add comment=\"From ISP3 IP to Inet\" \<font></font>
    src-address=\$\"local-address\" table=to_isp3 "<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Winboxウィンドウのスクリプト自体（クリック可能）：</font><i><b><font style="vertical-align: inherit;">注。</font></b></i><i><font style="vertical-align: inherit;">文字列</font></i><i><b><font style="vertical-align: inherit;">/ IPファイアウォールマングルセット[コメントを見つける= "ISP3からの接続"] in-interface = $ "interface"; </font></b></i><i><font style="vertical-align: inherit;">
インターフェースは表示名ではなくコードで機能するため、インターフェースの名前変更を正しく処理できます。</font></i><font style="vertical-align: inherit;">
3.3.2。</font><font style="vertical-align: inherit;">次に、プロファイルを使用して、ppp接続を作成します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/oz/tz/it/oztzitzzxgl5jz0g9jxskvtf3us.jpeg"></a><br>
<i><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<b><font style="vertical-align: inherit;"></font></b><br><font style="vertical-align: inherit;"></font></i><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="plaintext hljs">/interface pppoe-client add allow=mschap2 comment="to ISP3" disabled=no \<font></font>
interface=ether3 name=pppoe-isp3 password=isp3_pass profile=isp3_client \<font></font>
user=isp3_client</code></pre><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コメント。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一部のプロバイダーは、「remote-address」パラメーターを指定することを「忘れ」ます。</font><font style="vertical-align: inherit;">この場合、接続時に構成スクリプトが正しく機能せず、ログに次のエラーが表示されます：</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pppoe、ppp、info pppoe-isp3：リモートアドレスを判別できませんでした。xxx.xxx.xxx.xxxを使用して</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この問題を解決するには、手動で設定する必要がありますpppプロファイルアドレス（任意のダミー）：</font></font><br>
<pre><code class="plaintext hljs">/ppp profile set isp3_client remote-address=169.254.69.96</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
文字列</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ IPファイアウォールマングルセット[コメントを見つける= "ISP3からの接続"] in-interface = $ "interface"; </font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インターフェースは表示名ではなくコードで機能するため、インターフェースの名前変更を正しく処理できます。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、時計を設定します。</font></font><br>
<br>
<pre><code class="plaintext hljs">/system ntp client set enabled=yes \<font></font>
server-dns-names=0.pool.ntp.org,1.pool.ntp.org,2.pool.ntp.org</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後まで読んだ方へ</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マルチバンを実装するために提案された方法は、著者の個人的な好みであり、唯一の可能な方法ではありません。</font><font style="vertical-align: inherit;">ROSツールキットは広範囲で柔軟性があり、一方では初心者にとって難題となり、他方では人気の理由となります。</font><font style="vertical-align: inherit;">新しいツールとソリューションを探索、試して、発見してください。</font><font style="vertical-align: inherit;">たとえば、得られた知識の応用として、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マルチバンの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この実装では、</font><b><font style="vertical-align: inherit;">チェックゲートウェイ</font></b><font style="vertical-align: inherit;">ツール</font><font style="vertical-align: inherit;">を再帰ルートで</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netwatch</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に置き換えることが可能</font><b><font style="vertical-align: inherit;">です</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ノート</font></font></h4><br>
<ol>
<li><i><b>Check-gateway</b> — ,             .     10 ,   . ,       20-30 .       —     <b>Netwatch</b>,      . <br>
 <b>Check-gateway</b>        . <br>
<br>
<u><b> !</b></u>          ,    .     <b>check-gateway=ping</b>  .</i></li>
<li><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DHP操作メカニズムで障害が発生し、クライアントが更新状態でハングしているように見えます。</font><font style="vertical-align: inherit;">この場合、スクリプトの2番目の部分は機能しませんが、状態が対応する再帰ルートを監視しているため、トラフィックが正しく移動するのに支障はありません。</font></font></i></li>
<li><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ECMP（等コストマルチパス）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -ROSには、複数のゲートウェイと同じ距離のルートを指定する機能があります。</font><font style="vertical-align: inherit;">この場合、接続は、指定されたゲートウェイの数に比例して、ラウンドロビンアルゴリズムを使用してチャネルに分散されます。</font></font></i></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事を書くきっかけは、その構造の形成と強調に役立ちます</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">-Eugene @jscar</font></a><font style="vertical-align: inherit;">への個人的な感謝</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja463799/index.html">Windows 10で気に入らない点</a></li>
<li><a href="../ja463801/index.html">製品マネージャーを成功させるための3つの重要な要素：Anton Stozhko</a></li>
<li><a href="../ja463803/index.html">Haikuでの5日目：いくつかのプログラムを移植しましょう</a></li>
<li><a href="../ja463805/index.html">ゲームデザイナーになりたい人のための7冊</a></li>
<li><a href="../ja463811/index.html">Android Q用のアプリケーションの準備。パート1</a></li>
<li><a href="../ja463815/index.html">なぜ外資系銀行が資金源に関心を持っているのですか？</a></li>
<li><a href="../ja463817/index.html">20人の製品マネージャーと、すべての中で最も多次元のマトリックス構造。スカイエンとの会話</a></li>
<li><a href="../ja463819/index.html">PostgreSQLロック：2.文字列ロック</a></li>
<li><a href="../ja463821/index.html">AMO、Bitrix、1Cなど：どこから始めればよいか？</a></li>
<li><a href="../ja463823/index.html">Rust 1.37.0リリース：プロファイルに基づく最適化、名前のない定数およびカーゴベンダー</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>