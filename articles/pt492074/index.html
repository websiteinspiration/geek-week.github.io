<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👈 🎍 🌑 Tenho que ir rápido. Sincronização rápida de email IMAP 👩🏽‍🤝‍👩🏼 ⛳️ 🍵</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Olá! Eu sou Ilya. Dois anos atrás, entrei para o cliente móvel IMAP. As versões anteriores do aplicativo baixavam a lista de cartas por um longo tempo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Tenho que ir rápido. Sincronização rápida de email IMAP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492074/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Olá! Eu sou Ilya. Dois anos atrás, entrei para o cliente móvel IMAP. As versões anteriores do aplicativo baixavam a lista de cartas por um longo tempo e gastavam muito tráfego para atualizar a caixa de correio. Surgiu a questão de otimizar o trabalho com o protocolo e sobre as capacidades desse protocolo em geral. Eu não sabia nada sobre o protocolo e mergulhei na leitura da documentação. Acontece que, durante todo esse tempo, o cliente usou o protocolo sem interrupções e não levou em conta os recursos de implementação. Esses recursos ajudaram a acelerar o download de e-mails em 2 a 3 vezes. Sobre o que é IMAP e quais são os chips para otimizá-lo mais adiante no meu artigo.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não vou mergulhar profundamente no protocolo. </font><font style="vertical-align: inherit;">Um artigo da categoria "Gostaria de ler este artigo há dois anos". </font><font style="vertical-align: inherit;">É improvável que os gurus do IMAP encontrem novas informações por si mesmos. </font><font style="vertical-align: inherit;">Este artigo se baseia na descrição do protocolo da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 3501</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conexão com o servidor</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMAP é um protocolo stateful. </font><font style="vertical-align: inherit;">Essa foi uma descoberta para mim, antes que eu não tinha visto ou trabalhado com esses protocolos. </font><font style="vertical-align: inherit;">Considere o esquema de trabalhar com o servidor.&nbsp;</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/311/882/30f/31188230f96d5252e2a974ebe843786d.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos em ordem, e mais importante, com exemplos. </font><font style="vertical-align: inherit;">Primeiro, você precisa criar uma conexão com o servidor. </font><font style="vertical-align: inherit;">Para fazer isso, use a biblioteca openSSL.</font></font><br>
<br>
<pre><code class="bash hljs">openssl s_client -connect imap.server.com:993 -crlf&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ótimo, a conexão foi estabelecida e você pode observar a resposta OK com uma linha que começa com a resposta CAPABILITY</font></font><br>
<br>
<pre><code class="bash hljs">OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE&nbsp; SPECIAL-USE AUTH=PLAIN AUTH=LOGIN]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Há uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cábula</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prática </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">para</font></a><font style="vertical-align: inherit;"> cada CAPABILITY </font><font style="vertical-align: inherit;">, onde todos os valores possíveis de CAPABILITY são gravados com links para o RFC. </font><font style="vertical-align: inherit;">Por exemplo, IMAP4rev1 informa ao cliente que o servidor está funcionando de acordo com o padrão IMAP4 e IDLE sinaliza que você pode assinar as alterações que ocorrem na caixa de correio.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autorização do servidor</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de se conectar ao servidor, você precisa ir para a sua caixa de correio. </font><font style="vertical-align: inherit;">Isso é feito usando o comando LOGIN.</font></font><br>
<br>
<pre><code class="bash hljs">a1 LOGIN email pass</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Então, pare, faça o login, eu entendo, e a1 o que é isso? </font><font style="vertical-align: inherit;">-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Talvez você pergunte. </font><font style="vertical-align: inherit;">E esta é a etiqueta da equipe. </font><font style="vertical-align: inherit;">No interesse do cliente, as tags devem ser diferentes, pois a resposta chega com a mesma tag da solicitação, o que significa que ela pode ser correspondida para análise entre equipes. </font><font style="vertical-align: inherit;">O servidor também pode retornar uma resposta com um asterisco no início, como * OK, isso é chamado de resposta sem marcação. </font><font style="vertical-align: inherit;">Basicamente, essa resposta é retornada para equipes que esperam várias entidades na resposta, por exemplo, LIST.&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicitação de lista de pastas</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para solicitar uma lista de letras em uma pasta, você deve primeiro descobrir essas pastas. </font><font style="vertical-align: inherit;">Isso é feito pelo comando LIST. </font><font style="vertical-align: inherit;">Este comando retorna uma lista de pastas no servidor.</font></font><br>
<br>
<pre><code class="bash hljs">A2 LIST «» *<font></font>
* LIST (\HasNoChildren \Trash) «/» Trash<font></font>
* LIST (\HasNoChildren \Sent) «/» Sent<font></font>
* LIST (\HasNoChildren \Drafts) «/» Drafts<font></font>
* LIST (\HasNoChildren \Junk) «/» Junk<font></font>
* LIST (\HasNoChildren) «/» INBOX<font></font>
A2 OK List completed (0.001 + 0.000 + 0.001 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro parâmetro no comando é namespace. Se o servidor suportar espaço para nome, seus valores poderão ser solicitados usando a consulta NAMESPACE. O espaço para nome padrão se parece com uma sequência vazia. Em seguida, o parâmetro curinga entra em jogo. Com isso, podemos dizer ao servidor quais pastas precisamos retornar. Por exemplo, podemos obter: um ramo de árvore de pastas, apenas raízes ou tudo, como no exemplo acima. É melhor não fazer isso, porque quem sabe quantas pastas o usuário tem na caixa. Os autores do protocolo recomendam o uso de "%" - nesse caso, você obterá todas as pastas de nível superior da caixa de correio.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir da resposta, entendemos que essa é uma resposta sem marcação em que cada linha é sua pasta na caixa. </font><font style="vertical-align: inherit;">Primeiro, há sinalizadores pelos quais lemos as meta-informações da pasta, por exemplo, no exemplo, todas as pastas não têm descendentes e algumas pastas para fins especiais (como Lixo, Lixo, etc.). </font><font style="vertical-align: inherit;">Em seguida, vem o caractere separador de pastas. </font><font style="vertical-align: inherit;">Este símbolo é usado para subpastas. </font><font style="vertical-align: inherit;">Por exemplo, para um descendente da pasta Lixeira, o nome seria semelhante a "Lixeira / Nova Pasta". </font><font style="vertical-align: inherit;">Depois de todas as pastas, o servidor retornará OK para nós com a tag que atribuímos ao comando e o tempo de execução desse comando.&nbsp;&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seleção de pasta</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Além disso, de acordo com o esquema, devemos selecionar uma pasta na qual iremos apertar nossas mensagens. </font><font style="vertical-align: inherit;">Isso é feito usando o comando SELECT.</font></font><br>
<br>
<pre><code class="bash hljs">4 SELECT INBOX<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 16337 EXISTS<font></font>
* 2 RECENT<font></font>
* OK [UNSEEN 6037] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 17412] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 21503] Highest<font></font>
4 OK [READ-WRITE] Select completed (0.015 + 0.000 + 0.014 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando você seleciona uma pasta, todas as informações sobre ela são retornadas. </font><font style="vertical-align: inherit;">Vamos em ordem.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda com sinalizadores permitidos dentro da pasta para obter letras.&nbsp;&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda com sinalizadores que o cliente pode mudar para sempre</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda com o número de letras na pasta</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A resposta é com o número de cartas recentes, ou seja, aquelas que recebemos entre as seleções de pasta</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responder com o número de mensagens não lidas</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, por enquanto, vamos nos debruçar sobre isso. </font><font style="vertical-align: inherit;">O restante das informações não precisamos.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicitar cartas</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, o mais interessante é o pedido de cartas. </font><font style="vertical-align: inherit;">Você precisa ser extremamente cuidadoso aqui, especialmente em clientes móveis. </font><font style="vertical-align: inherit;">Concordo, é improvável que, ao entrar no aplicativo, você receba milhares de mensagens do servidor para o seu banco de dados. </font><font style="vertical-align: inherit;">Além disso, não faz sentido fazer o download da carta inteira, pois pode não ser prático exibir, por exemplo, uma lista de todas as letras. </font><font style="vertical-align: inherit;">Por exemplo, para mostrar rapidamente as cartas do usuário, solicitaremos apenas um "envelope". </font><font style="vertical-align: inherit;">Neste envelope, queremos ver: remetente, destinatário, assunto da carta e data do envio. </font><font style="vertical-align: inherit;">Carregaremos as 10 primeiras postagens.</font></font><br>
<br>
<pre><code class="bash hljs">5 FETCH 16337:16327 (ENVELOPE)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dois pontos enumeram o segmento dos números de letras que queremos receber e entre parênteses o que queremos ler dessas cartas, nesse caso, o envelope da carta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou dar a resposta de forma abreviada:</font></font><br>
<br>
<pre><code class="bash hljs">* 16334 FETCH (ENVELOPE (<span class="hljs-string">"Sat, 07 Sep 2019 23:07:48 +0000"</span> <span class="hljs-string">"Hello from Fabric.io"</span> ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((NIL NIL <span class="hljs-string">"me"</span> <span class="hljs-string">"me@mail"</span>)) NIL NIL NIL <span class="hljs-string">"&lt;5d7438441b07c_2d872ad30967b9646405c6@answers-notifier2012.mail&gt;"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
É claro que nada está claro. </font><font style="vertical-align: inherit;">E o fato é que o formato do envelope é ditado pela </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 2822.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Não vou considerá-lo neste artigo. </font><font style="vertical-align: inherit;">Este envelope possui todas as informações necessárias: data de recebimento da carta, assunto da carta, remetente, destinatário e até mesmo messageId. </font><font style="vertical-align: inherit;">Seus clientes costumam exibir uma conversa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, conseguimos mostrar ao usuário informações básicas sobre a carta, mas e o corpo? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos fazer o download imediato de todo o corpo da carta, independentemente de seu tamanho, é claro que não é por muito tempo, mas ainda assim caro pela rede e memória. </font><font style="vertical-align: inherit;">A propósito, isso é feito com o mesmo comando FETCH.&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">6 FETCH 16337:16327 (BODY[])&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tente esse comando na sua caixa de entrada e você entenderá o que eu quis dizer com “caro”, mesmo com 10 mensagens, obtemos uma resposta bastante volumosa com absolutamente todas as informações sobre a carta. Falando dela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com que frequência você baixou a fonte da carta em qualquer cliente que você conhece para ver sua aparência na sua forma original? Caso contrário, vamos obter uma carta de teste. Nele, adicionei uma figura diretamente à carta e uma figura como anexo. Salve-o no formato eml e abra-o com qualquer editor de texto. Dependendo do cliente, você receberá diferentes fontes da carta, mas em geral elas serão semelhantes.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos começar com o cabeçalho do email:</font></font><br>
<br>
<pre><code class="bash hljs">Return-Path: &lt;myemail&gt;<font></font>
Delivered-To:myemail<font></font>
Received: from localhost (localhost [127.0.0.1])<font></font>
	byimap.server.com (imap.server.com) with ESMTP id 6C2BE2A0363<font></font>
	<span class="hljs-keyword">for</span> &lt;myemail&gt;; Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
X-Virus-Scanned: amavisd-new at imap.server.com<font></font>
Received: from imap.server.com ([127.0.0.1])<font></font>
	by localhost ( imap.server.com [127.0.0.1]) (amavisd-new, port 10026)<font></font>
	with ESMTP id abx8HQQT_k5A <span class="hljs-keyword">for</span> &lt;myemail&gt;;<font></font>
	Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
Mime-Version: 1.0<font></font>
Date: Sun, 08 Sep 2019 20:41:28 +0000<font></font>
Content-Type: multipart/mixed;<font></font>
&nbsp;boundary=»--=_Part_722_554093397.1567975288»<font></font>
Message-ID: &lt;9e4e3872e603eac2c20f26bb1d65548d&gt;<font></font>
From: <span class="hljs-string">"Me"</span> &lt;myemail&gt;<font></font>
Subject: Hey, Habr!<font></font>
To: myemail<font></font>
X-Priority: 3 (Normal)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas as meta-informações são descritas no cabeçalho da carta, de quem, para quem, quando, tipo de conteúdo da mensagem, assunto e prioridade da carta. </font><font style="vertical-align: inherit;">O campo limite indica o limite da letra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entenda melhor o que isso significa.</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: multipart/related;<font></font>
&nbsp;boundary=»--=_Part_583_946112260.1567975288»<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: multipart/alternative;<font></font>
&nbsp;boundary=»--=_Part_881_599167713.1567975288»<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/plain; charset=«utf-8»<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/html; charset=«utf-8»<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=3D<span class="hljs-string">"Content-Type"</span> content=3D<span class="hljs-string">"t=
ext/html; charset=3Dutf-8"</span> /&gt;&lt;/head&gt;&lt;body&gt;&lt;div data-crea=3D<span class="hljs-string">"font-wrapper"</span>=<font></font>
&nbsp;style=3D«font-family: XO Tahion; font-size: 16px; direction: ltr»&gt; &lt;img =<font></font>
src=3D<span class="hljs-string">"cid:jua-uid-q1nz1guinitrcfd3-1567975257318"</span>&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;/div&gt; &lt;b=<font></font>
r&gt; &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<font></font>
----=_Part_881_599167713.1567975288--<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: image/jpeg; name=«2018-09-04 22.46.36.jpg»<font></font>
Content-Disposition: inline; filename=«2018-09-04 22.46.36.jpg»<font></font>
Content-ID: &lt;jua-uid-q1nz1guinitrcfd3-1567975257318&gt;<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada limite é a borda usual de um pedaço de escrita. </font><font style="vertical-align: inherit;">Eles começam com dois hífens "-". </font><font style="vertical-align: inherit;">A borda de fechamento possui esses dois hífens no final. </font><font style="vertical-align: inherit;">É descrito em mais detalhes no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC1341.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Isso pode ser chamado de parte principal da carta, partes da carta e seus tipos MIME são descritos aqui.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre tipos MIME</font></font></b><div class="spoiler_text">MIME-   ,     MIME (<i>Multipurpose Internet Mail Extensions) </i>     email .&nbsp;<br>
<br>
<ul>
<li>multipart/mixed         ,             .&nbsp;</li>
</ul><br>
<ul>
<li>multipart/related  ,     ,     ,&nbsp;</li>
</ul><br>
<ul>
<li>multipart/alternative   ,       , ,   text/plain  text/html,       .&nbsp;</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Não temos texto simples aqui, por isso é mais lógico usar uma representação html. Nesta apresentação em html, há apenas uma figura com o parâmetro Content-Disposition: inline, ou seja, ele está localizado diretamente no corpo da carta e não nos documentos anexos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O link para esta imagem não é muito simples. É descrito pelo parâmetro Content-ID, que é igual a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jua-uid-q1nz1guinitrcfd3-1567975257318</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este é um link para a próxima parte da carta - uma figura codificada na base 64. Para salvar meus nervos, não incluí todo o código da base 64. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A última parte da carta tem a forma&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: image/png; name=«2018-07-02 11.08.23 pm.png»<font></font>
Content-Disposition: attachment; filename=«2018-07-02 11.08.23 pm.png»<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
que já possui Disposição de conteúdo não embutida, como na imagem acima, mas anexo. </font><font style="vertical-align: inherit;">Essa imagem deve apenas ir para o painel de anexo de arquivo, pela maneira como também é codificada na base-64 e tem um tamanho grande. </font><font style="vertical-align: inherit;">Aqui fica claro que você não deve carregar novamente todo o corpo da carta se quisermos mostrar apenas informações básicas.&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voltar ao protocolo</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de trabalhar nas letras, você precisa fechar a pasta selecionada e dizer adeus ao servidor. </font><font style="vertical-align: inherit;">Para fechar a pasta, precisamos inserir o comando CLOSE. </font><font style="vertical-align: inherit;">Sim, é tão simples</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
7 CLOSE<font></font>
7 OK Close completed (0.001 + 0.000 secs).<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A propósito, se você trabalhou com o console em paralelo comigo e leu o artigo, um evento não tão agradável poderia ter acontecido, o servidor poderia fechar sua conexão com o tempo limite. </font><font style="vertical-align: inherit;">Isso é completamente normal e cada servidor tem seu próprio tempo limite, por exemplo, temos 30 minutos.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, é recomendável executar o comando NOOP em segundo plano</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
1 OK NOOP completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele literalmente não faz nada, mas permite que você mantenha a conexão sem tempo limite, tanto quanto precisamos. </font><font style="vertical-align: inherit;">Se você atualmente selecionar uma pasta, o NOOP poderá funcionar como uma solicitação periódica de alterações nessa pasta&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
* 16472 EXPUNGE<font></font>
* 16471 EXPUNGE<font></font>
* 16472 EXISTS<font></font>
* 1 RECENT<font></font>
1 OK NOOP completed (0.004 + 0.000 + 0.003 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, na resposta, somos notificados de duas mensagens excluídas, uma nova e que o número de mensagens nesta pasta é 16 472. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe também que você pode trabalhar com apenas uma pasta selecionada, não há trabalho paralelo aqui. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, no final, feche a sessão com o servidor e nos despediremos.</font></font><br>
<br>
<pre><code class="bash hljs">8 LOGOUT<font></font>
* BYE Logging out<font></font>
8 OK Logout completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos a triste resposta sem sinal BYE, o que significa que é hora de terminar o trabalho.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sincronização rápida com CONDSOTORE e QRESYNC</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Você pode usar a operação NOOP para rastrear alterações em uma caixa em uma pasta selecionada. Mas e se quisermos descobrir o que mudou na pasta enquanto estávamos trabalhando com outra? A opção mais óbvia é classificar todas as letras no armazenamento local, seja um cache ou um banco de dados, e comparar com o que o servidor retornará. Por um lado, essa é realmente uma solução e, em alguns servidores, será literalmente a única verdadeira. Por outro lado, queremos mostrar letras o mais rápido que o protocolo geralmente permitir. Felizmente, nosso servidor suporta extensões de protocolo como CONDSTORE e QRESYNC, que foram adicionadas ao </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC7162</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O primeiro adiciona um número especial de 63 bits à mensagem e pasta, chamada de sequência mod, que aumenta a cada operação nesta carta. A sequência de mod mais alta entre todas as mensagens é adicionada à pasta. Como resultado, cada vez que você se conecta a uma pasta em um servidor que suporta o CONDSTORE, podemos facilmente descobrir se algo mudou ou não, simplesmente comparando os valores da sequência de mod para as pastas local e do servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Além disso, esta extensão adiciona parâmetros adicionais para os comandos STORE e FETCH - CHANGEDSINCE mod-sequence e UNCHANGEDSINCE mod-sequence, que permitem executar uma operação se a sequência mod das mensagens transmitidas for maior e menor que isso, respectivamente. Vejamos um exemplo.</font></font><br>
<br>
<pre><code class="bash hljs">FETCH 17221:17241 (UID) (CHANGEDSINCE 0)<font></font>
* OK [HIGHESTMODSEQ 22746] Highest<font></font>
* 17222 FETCH (UID 18319 MODSEQ (22580))<font></font>
* 17223 FETCH (UID 18320 MODSEQ (22601))<font></font>
* 17224 FETCH (UID 18324 MODSEQ (22607))<font></font>
* 17225 FETCH (UID 18325 MODSEQ (22604))<font></font>
* 17226 FETCH (UID 18326 MODSEQ (22608))<font></font>
* 17227 FETCH (UID 18327 MODSEQ (22614))<font></font>
* 17228 FETCH (UID 18328 MODSEQ (22613))<font></font>
* 17229 FETCH (UID 18336 MODSEQ (22628))<font></font>
* 17230 FETCH (UID 18338 MODSEQ (22628))<font></font>
* 17231 FETCH (UID 18340 MODSEQ (22628)<font></font>
* 17232 FETCH (UID 18341 MODSEQ (22628))<font></font>
* 17221 FETCH (UID 18318 MODSEQ (22583))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simulei uma situação em que entramos na caixa de correio e não sabíamos nada sobre isso antes, ou seja, nossa sequência de modificação local é 0. Como você pode ver, o servidor nos retorna geralmente todas as mensagens que estão na caixa de correio, pois antes disso não recebíamos nada e não sabe nada sobre a caixa. Em resposta a uma solicitação de cartas UID de CHANGEDSINCE, uma resposta não marcada OK também vem com um HIGHESTMODESEQ que agora salvaremos e para cada mensagem nosso MODSEQ.Executaremos </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
algumas operações com a caixa de correio: adicione novas cartas, altere os sinalizadores. Vamos fazer uma nova solicitação, mas com a sequência de modificação anterior</font></font><br>
<br>
<pre><code class="bash hljs">1 fetch 17221:* (UID FLAGS) (CHANGEDSINCE 22746)<font></font>
* 17267 FETCH (UID 18378 FLAGS () MODSEQ (22753))<font></font>
* 17270 FETCH (UID 18381 FLAGS (\Seen) MODSEQ (22754))<font></font>
* 17271 FETCH (UID 18382 FLAGS () MODSEQ (22751))<font></font>
* 17273 FETCH (UID 18384 FLAGS () MODSEQ (22750))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e já vemos a diferença, em vez de gerar 20 comunidades novas e antigas que acabamos de chegar (asterisco em 17221: * significa levar letras do número 17221 ao máximo possível), recebemos cartas cujo MODSEQ é maior que o anterior. Isso ajuda muito bem a sincronizar uma pasta na qual não estamos há algum tempo e obter uma espécie de conversão das letras alteradas, em vez de tentar todas as possíveis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece, muito melhor? Mas o QRESYNC torna a operação de sincronização ainda mais rápida, permitindo especificar os parâmetros MODSEQ e as UIDs de mensagens conhecidas por nós durante a seleção da pasta. Vamos explicar com um exemplo. Primeiro, o QRESYNC deve ser ativado com o comando ENABLE.&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 ENABLE QRESYNC<font></font>
* ENABLED QRESYNC<font></font>
1 OK Enabled (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (0 0))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18385] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22754] Highest<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
como não sabíamos nada sobre a pasta antes disso, o servidor retorna apenas informações sobre a pasta para nós, sem um nugget de suas alterações. Suponha que tenhamos perguntado as primeiras vinte mensagens e lembrado o UID e também o HIGHESTMODESEQ. Saímos da pasta, nos enviamos uma mensagem, excluímos a mensagem, alteramos os sinalizadores e retornamos com as informações anteriores sobre a pasta</font></font><br>
<br>
<pre><code class="bash hljs">1 CLOSE<font></font>
1 OK Close completed (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (1532079879 22754 18300:18385))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18386] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22757] Highest<font></font>
* VANISHED (EARLIER) 18380<font></font>
* 17269 FETCH (UID 18383 FLAGS () MODSEQ (22757))<font></font>
* 17271 FETCH (UID 18385 FLAGS () MODSEQ (22755))<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora, ao escolher uma pasta alterada, obtemos imediatamente um nugget de alterações, na forma de uma resposta VANISHED (EARLIER) para mensagens que foram excluídas e FETCH para mensagens que foram adicionadas ou alteradas. Agora é ainda mais fácil sincronizar a pasta se o usuário não a visitar há um longo tempo. Essa é uma maneira muito interessante se você tiver várias mensagens armazenadas localmente no cache e não quiser compará-las com as mensagens no servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro parâmetro dessa solicitação é UIDVALIDITY, que é essencialmente usado para verificar se o uid que você recebeu anteriormente não foi alterado na pasta. Isso pode acontecer se o servidor alterar o uid da sessão de sessão para sessão para todas as mensagens ou se a pasta foi excluída e uma pasta com o mesmo nome foi criada em seu lugar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo parâmetro é o HIGHESTMODSEQ conhecido por nós e o último é o intervalo de UIDs conhecidos. Eles podem ser gravados como dois pontos, se o intervalo for contínuo ou separado por vírgula.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusão</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No meu exemplo, deparei-me com uma situação em que a ignorância da área de assunto leva à operação incorreta e subótima do aplicativo. </font><font style="vertical-align: inherit;">Não cobri todas as opções possíveis para usar o protocolo neste artigo. </font><font style="vertical-align: inherit;">Mas espero que para o próximo desenvolvedor do cliente IMAP as informações acima sejam úteis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O IMAP tem uma tonelada de coisas interessantes. </font><font style="vertical-align: inherit;">Os comandos para sincronização rápida são apenas o começo; na verdade, você pode otimizar ainda mais os comandos IMAP, dependendo dos recursos do servidor, e tornar o trabalho com o correio mais rápido, mais econômico na rede e na memória e geralmente mais agradável. </font><font style="vertical-align: inherit;">Mas vou falar sobre isso mais tarde.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt492058/index.html">Instalando o ROS2 no Ubuntu 18.04</a></li>
<li><a href="../pt492060/index.html">Como resolver? "ECONNREFUSED - Conexão recusada pelo servidor"</a></li>
<li><a href="../pt492062/index.html">Modelo de servidor back-end Golang - parte 1 (servidor HTTP)</a></li>
<li><a href="../pt492066/index.html">Por que o Event Sourcing é o antipadrão para a interação de microsserviços</a></li>
<li><a href="../pt492068/index.html">Grupo S7 abre um departamento “Tecnologias de Informação na Aviação” no MIPT</a></li>
<li><a href="../pt492076/index.html">Um exemplo de arquitetura hexagonal em Java</a></li>
<li><a href="../pt492078/index.html">Os materiais mais importantes e úteis do coronavírus COVID-19</a></li>
<li><a href="../pt492082/index.html">Como simplificar o gerenciamento de dispositivos domésticos e protegê-los (compartilhe ideias sobre o Kauri Safe Smart Home)</a></li>
<li><a href="../pt492086/index.html">Coronavírus vs negócios de TI russos: as empresas estão prontas para transferir funcionários para um local remoto?</a></li>
<li><a href="../pt492088/index.html">Testando o mecanismo de jogo do Amazon Lumberyard. Abordagens e Ferramentas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>