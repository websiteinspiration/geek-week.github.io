<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëà üéç üåë Tenho que ir r√°pido. Sincroniza√ß√£o r√°pida de email IMAP üë©üèΩ‚Äçü§ù‚Äçüë©üèº ‚õ≥Ô∏è üçµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°! Eu sou Ilya. Dois anos atr√°s, entrei para o cliente m√≥vel IMAP. As vers√µes anteriores do aplicativo baixavam a lista de cartas por um longo tempo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Tenho que ir r√°pido. Sincroniza√ß√£o r√°pida de email IMAP</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/492074/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√°! Eu sou Ilya. Dois anos atr√°s, entrei para o cliente m√≥vel IMAP. As vers√µes anteriores do aplicativo baixavam a lista de cartas por um longo tempo e gastavam muito tr√°fego para atualizar a caixa de correio. Surgiu a quest√£o de otimizar o trabalho com o protocolo e sobre as capacidades desse protocolo em geral. Eu n√£o sabia nada sobre o protocolo e mergulhei na leitura da documenta√ß√£o. Acontece que, durante todo esse tempo, o cliente usou o protocolo sem interrup√ß√µes e n√£o levou em conta os recursos de implementa√ß√£o. Esses recursos ajudaram a acelerar o download de e-mails em 2 a 3 vezes. Sobre o que √© IMAP e quais s√£o os chips para otimiz√°-lo mais adiante no meu artigo.</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o vou mergulhar profundamente no protocolo. </font><font style="vertical-align: inherit;">Um artigo da categoria "Gostaria de ler este artigo h√° dois anos". </font><font style="vertical-align: inherit;">√â improv√°vel que os gurus do IMAP encontrem novas informa√ß√µes por si mesmos. </font><font style="vertical-align: inherit;">Este artigo se baseia na descri√ß√£o do protocolo da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 3501</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conex√£o com o servidor</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IMAP √© um protocolo stateful. </font><font style="vertical-align: inherit;">Essa foi uma descoberta para mim, antes que eu n√£o tinha visto ou trabalhado com esses protocolos. </font><font style="vertical-align: inherit;">Considere o esquema de trabalhar com o servidor.&nbsp;</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/311/882/30f/31188230f96d5252e2a974ebe843786d.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos em ordem, e mais importante, com exemplos. </font><font style="vertical-align: inherit;">Primeiro, voc√™ precisa criar uma conex√£o com o servidor. </font><font style="vertical-align: inherit;">Para fazer isso, use a biblioteca openSSL.</font></font><br>
<br>
<pre><code class="bash hljs">openssl s_client -connect imap.server.com:993 -crlf&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√ìtimo, a conex√£o foi estabelecida e voc√™ pode observar a resposta OK com uma linha que come√ßa com a resposta CAPABILITY</font></font><br>
<br>
<pre><code class="bash hljs">OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE&nbsp; SPECIAL-USE AUTH=PLAIN AUTH=LOGIN]</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
H√° uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√°bula</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pr√°tica </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">para</font></a><font style="vertical-align: inherit;"> cada CAPABILITY </font><font style="vertical-align: inherit;">, onde todos os valores poss√≠veis de CAPABILITY s√£o gravados com links para o RFC. </font><font style="vertical-align: inherit;">Por exemplo, IMAP4rev1 informa ao cliente que o servidor est√° funcionando de acordo com o padr√£o IMAP4 e IDLE sinaliza que voc√™ pode assinar as altera√ß√µes que ocorrem na caixa de correio.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autoriza√ß√£o do servidor</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de se conectar ao servidor, voc√™ precisa ir para a sua caixa de correio. </font><font style="vertical-align: inherit;">Isso √© feito usando o comando LOGIN.</font></font><br>
<br>
<pre><code class="bash hljs">a1 LOGIN email pass</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ent√£o, pare, fa√ßa o login, eu entendo, e a1 o que √© isso? </font><font style="vertical-align: inherit;">-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Talvez voc√™ pergunte. </font><font style="vertical-align: inherit;">E esta √© a etiqueta da equipe. </font><font style="vertical-align: inherit;">No interesse do cliente, as tags devem ser diferentes, pois a resposta chega com a mesma tag da solicita√ß√£o, o que significa que ela pode ser correspondida para an√°lise entre equipes. </font><font style="vertical-align: inherit;">O servidor tamb√©m pode retornar uma resposta com um asterisco no in√≠cio, como * OK, isso √© chamado de resposta sem marca√ß√£o. </font><font style="vertical-align: inherit;">Basicamente, essa resposta √© retornada para equipes que esperam v√°rias entidades na resposta, por exemplo, LIST.&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicita√ß√£o de lista de pastas</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para solicitar uma lista de letras em uma pasta, voc√™ deve primeiro descobrir essas pastas. </font><font style="vertical-align: inherit;">Isso √© feito pelo comando LIST. </font><font style="vertical-align: inherit;">Este comando retorna uma lista de pastas no servidor.</font></font><br>
<br>
<pre><code class="bash hljs">A2 LIST ¬´¬ª *<font></font>
* LIST (\HasNoChildren \Trash) ¬´/¬ª Trash<font></font>
* LIST (\HasNoChildren \Sent) ¬´/¬ª Sent<font></font>
* LIST (\HasNoChildren \Drafts) ¬´/¬ª Drafts<font></font>
* LIST (\HasNoChildren \Junk) ¬´/¬ª Junk<font></font>
* LIST (\HasNoChildren) ¬´/¬ª INBOX<font></font>
A2 OK List completed (0.001 + 0.000 + 0.001 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro par√¢metro no comando √© namespace. Se o servidor suportar espa√ßo para nome, seus valores poder√£o ser solicitados usando a consulta NAMESPACE. O espa√ßo para nome padr√£o se parece com uma sequ√™ncia vazia. Em seguida, o par√¢metro curinga entra em jogo. Com isso, podemos dizer ao servidor quais pastas precisamos retornar. Por exemplo, podemos obter: um ramo de √°rvore de pastas, apenas ra√≠zes ou tudo, como no exemplo acima. √â melhor n√£o fazer isso, porque quem sabe quantas pastas o usu√°rio tem na caixa. Os autores do protocolo recomendam o uso de "%" - nesse caso, voc√™ obter√° todas as pastas de n√≠vel superior da caixa de correio.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir da resposta, entendemos que essa √© uma resposta sem marca√ß√£o em que cada linha √© sua pasta na caixa. </font><font style="vertical-align: inherit;">Primeiro, h√° sinalizadores pelos quais lemos as meta-informa√ß√µes da pasta, por exemplo, no exemplo, todas as pastas n√£o t√™m descendentes e algumas pastas para fins especiais (como Lixo, Lixo, etc.). </font><font style="vertical-align: inherit;">Em seguida, vem o caractere separador de pastas. </font><font style="vertical-align: inherit;">Este s√≠mbolo √© usado para subpastas. </font><font style="vertical-align: inherit;">Por exemplo, para um descendente da pasta Lixeira, o nome seria semelhante a "Lixeira / Nova Pasta". </font><font style="vertical-align: inherit;">Depois de todas as pastas, o servidor retornar√° OK para n√≥s com a tag que atribu√≠mos ao comando e o tempo de execu√ß√£o desse comando.&nbsp;&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sele√ß√£o de pasta</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, de acordo com o esquema, devemos selecionar uma pasta na qual iremos apertar nossas mensagens. </font><font style="vertical-align: inherit;">Isso √© feito usando o comando SELECT.</font></font><br>
<br>
<pre><code class="bash hljs">4 SELECT INBOX<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 16337 EXISTS<font></font>
* 2 RECENT<font></font>
* OK [UNSEEN 6037] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 17412] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 21503] Highest<font></font>
4 OK [READ-WRITE] Select completed (0.015 + 0.000 + 0.014 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quando voc√™ seleciona uma pasta, todas as informa√ß√µes sobre ela s√£o retornadas. </font><font style="vertical-align: inherit;">Vamos em ordem.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda com sinalizadores permitidos dentro da pasta para obter letras.&nbsp;&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda com sinalizadores que o cliente pode mudar para sempre</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responda com o n√∫mero de letras na pasta</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A resposta √© com o n√∫mero de cartas recentes, ou seja, aquelas que recebemos entre as sele√ß√µes de pasta</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Responder com o n√∫mero de mensagens n√£o lidas</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, por enquanto, vamos nos debru√ßar sobre isso. </font><font style="vertical-align: inherit;">O restante das informa√ß√µes n√£o precisamos.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicitar cartas</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, o mais interessante √© o pedido de cartas. </font><font style="vertical-align: inherit;">Voc√™ precisa ser extremamente cuidadoso aqui, especialmente em clientes m√≥veis. </font><font style="vertical-align: inherit;">Concordo, √© improv√°vel que, ao entrar no aplicativo, voc√™ receba milhares de mensagens do servidor para o seu banco de dados. </font><font style="vertical-align: inherit;">Al√©m disso, n√£o faz sentido fazer o download da carta inteira, pois pode n√£o ser pr√°tico exibir, por exemplo, uma lista de todas as letras. </font><font style="vertical-align: inherit;">Por exemplo, para mostrar rapidamente as cartas do usu√°rio, solicitaremos apenas um "envelope". </font><font style="vertical-align: inherit;">Neste envelope, queremos ver: remetente, destinat√°rio, assunto da carta e data do envio. </font><font style="vertical-align: inherit;">Carregaremos as 10 primeiras postagens.</font></font><br>
<br>
<pre><code class="bash hljs">5 FETCH 16337:16327 (ENVELOPE)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os dois pontos enumeram o segmento dos n√∫meros de letras que queremos receber e entre par√™nteses o que queremos ler dessas cartas, nesse caso, o envelope da carta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou dar a resposta de forma abreviada:</font></font><br>
<br>
<pre><code class="bash hljs">* 16334 FETCH (ENVELOPE (<span class="hljs-string">"Sat, 07 Sep 2019 23:07:48 +0000"</span> <span class="hljs-string">"Hello from Fabric.io"</span> ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((<span class="hljs-string">"Fabric"</span> NIL <span class="hljs-string">"notifier"</span> <span class="hljs-string">"fabric.io"</span>)) ((NIL NIL <span class="hljs-string">"me"</span> <span class="hljs-string">"me@mail"</span>)) NIL NIL NIL <span class="hljs-string">"&lt;5d7438441b07c_2d872ad30967b9646405c6@answers-notifier2012.mail&gt;"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â claro que nada est√° claro. </font><font style="vertical-align: inherit;">E o fato √© que o formato do envelope √© ditado pela </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC 2822.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√£o vou consider√°-lo neste artigo. </font><font style="vertical-align: inherit;">Este envelope possui todas as informa√ß√µes necess√°rias: data de recebimento da carta, assunto da carta, remetente, destinat√°rio e at√© mesmo messageId. </font><font style="vertical-align: inherit;">Seus clientes costumam exibir uma conversa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, conseguimos mostrar ao usu√°rio informa√ß√µes b√°sicas sobre a carta, mas e o corpo? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Podemos fazer o download imediato de todo o corpo da carta, independentemente de seu tamanho, √© claro que n√£o √© por muito tempo, mas ainda assim caro pela rede e mem√≥ria. </font><font style="vertical-align: inherit;">A prop√≥sito, isso √© feito com o mesmo comando FETCH.&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">6 FETCH 16337:16327 (BODY[])&nbsp;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tente esse comando na sua caixa de entrada e voc√™ entender√° o que eu quis dizer com ‚Äúcaro‚Äù, mesmo com 10 mensagens, obtemos uma resposta bastante volumosa com absolutamente todas as informa√ß√µes sobre a carta. Falando dela. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com que frequ√™ncia voc√™ baixou a fonte da carta em qualquer cliente que voc√™ conhece para ver sua apar√™ncia na sua forma original? Caso contr√°rio, vamos obter uma carta de teste. Nele, adicionei uma figura diretamente √† carta e uma figura como anexo. Salve-o no formato eml e abra-o com qualquer editor de texto. Dependendo do cliente, voc√™ receber√° diferentes fontes da carta, mas em geral elas ser√£o semelhantes.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos come√ßar com o cabe√ßalho do email:</font></font><br>
<br>
<pre><code class="bash hljs">Return-Path: &lt;myemail&gt;<font></font>
Delivered-To:myemail<font></font>
Received: from localhost (localhost [127.0.0.1])<font></font>
	byimap.server.com (imap.server.com) with ESMTP id 6C2BE2A0363<font></font>
	<span class="hljs-keyword">for</span> &lt;myemail&gt;; Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
X-Virus-Scanned: amavisd-new at imap.server.com<font></font>
Received: from imap.server.com ([127.0.0.1])<font></font>
	by localhost ( imap.server.com [127.0.0.1]) (amavisd-new, port 10026)<font></font>
	with ESMTP id abx8HQQT_k5A <span class="hljs-keyword">for</span> &lt;myemail&gt;;<font></font>
	Sun,&nbsp; 8 Sep 2019 23:41:29 +0300 (MSK)<font></font>
Mime-Version: 1.0<font></font>
Date: Sun, 08 Sep 2019 20:41:28 +0000<font></font>
Content-Type: multipart/mixed;<font></font>
&nbsp;boundary=¬ª--=_Part_722_554093397.1567975288¬ª<font></font>
Message-ID: &lt;9e4e3872e603eac2c20f26bb1d65548d&gt;<font></font>
From: <span class="hljs-string">"Me"</span> &lt;myemail&gt;<font></font>
Subject: Hey, Habr!<font></font>
To: myemail<font></font>
X-Priority: 3 (Normal)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todas as meta-informa√ß√µes s√£o descritas no cabe√ßalho da carta, de quem, para quem, quando, tipo de conte√∫do da mensagem, assunto e prioridade da carta. </font><font style="vertical-align: inherit;">O campo limite indica o limite da letra. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entenda melhor o que isso significa.</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: multipart/related;<font></font>
&nbsp;boundary=¬ª--=_Part_583_946112260.1567975288¬ª<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: multipart/alternative;<font></font>
&nbsp;boundary=¬ª--=_Part_881_599167713.1567975288¬ª<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/plain; charset=¬´utf-8¬ª<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
----=_Part_881_599167713.1567975288<font></font>
Content-Type: text/html; charset=¬´utf-8¬ª<font></font>
Content-Transfer-Encoding: quoted-printable<font></font>
&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=3D<span class="hljs-string">"Content-Type"</span> content=3D<span class="hljs-string">"t=
ext/html; charset=3Dutf-8"</span> /&gt;&lt;/head&gt;&lt;body&gt;&lt;div data-crea=3D<span class="hljs-string">"font-wrapper"</span>=<font></font>
&nbsp;style=3D¬´font-family: XO Tahion; font-size: 16px; direction: ltr¬ª&gt; &lt;img =<font></font>
src=3D<span class="hljs-string">"cid:jua-uid-q1nz1guinitrcfd3-1567975257318"</span>&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;/div&gt; &lt;b=<font></font>
r&gt; &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;<font></font>
----=_Part_881_599167713.1567975288--<font></font>
----=_Part_583_946112260.1567975288<font></font>
Content-Type: image/jpeg; name=¬´2018-09-04 22.46.36.jpg¬ª<font></font>
Content-Disposition: inline; filename=¬´2018-09-04 22.46.36.jpg¬ª<font></font>
Content-ID: &lt;jua-uid-q1nz1guinitrcfd3-1567975257318&gt;<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada limite √© a borda usual de um peda√ßo de escrita. </font><font style="vertical-align: inherit;">Eles come√ßam com dois h√≠fens "-". </font><font style="vertical-align: inherit;">A borda de fechamento possui esses dois h√≠fens no final. </font><font style="vertical-align: inherit;">√â descrito em mais detalhes no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC1341.</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Isso pode ser chamado de parte principal da carta, partes da carta e seus tipos MIME s√£o descritos aqui.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre tipos MIME</font></font></b><div class="spoiler_text">MIME-   ,     MIME (<i>Multipurpose Internet Mail Extensions) </i>     email .&nbsp;<br>
<br>
<ul>
<li>multipart/mixed         ,             .&nbsp;</li>
</ul><br>
<ul>
<li>multipart/related  ,     ,     ,&nbsp;</li>
</ul><br>
<ul>
<li>multipart/alternative   ,       , ,   text/plain  text/html,       .&nbsp;</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o temos texto simples aqui, por isso √© mais l√≥gico usar uma representa√ß√£o html. Nesta apresenta√ß√£o em html, h√° apenas uma figura com o par√¢metro Content-Disposition: inline, ou seja, ele est√° localizado diretamente no corpo da carta e n√£o nos documentos anexos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O link para esta imagem n√£o √© muito simples. √â descrito pelo par√¢metro Content-ID, que √© igual a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jua-uid-q1nz1guinitrcfd3-1567975257318</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este √© um link para a pr√≥xima parte da carta - uma figura codificada na base 64. Para salvar meus nervos, n√£o inclu√≠ todo o c√≥digo da base 64. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A √∫ltima parte da carta tem a forma&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">----=_Part_722_554093397.1567975288<font></font>
Content-Type: image/png; name=¬´2018-07-02 11.08.23 pm.png¬ª<font></font>
Content-Disposition: attachment; filename=¬´2018-07-02 11.08.23 pm.png¬ª<font></font>
Content-Transfer-Encoding: base64</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
que j√° possui Disposi√ß√£o de conte√∫do n√£o embutida, como na imagem acima, mas anexo. </font><font style="vertical-align: inherit;">Essa imagem deve apenas ir para o painel de anexo de arquivo, pela maneira como tamb√©m √© codificada na base-64 e tem um tamanho grande. </font><font style="vertical-align: inherit;">Aqui fica claro que voc√™ n√£o deve carregar novamente todo o corpo da carta se quisermos mostrar apenas informa√ß√µes b√°sicas.&nbsp;</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voltar ao protocolo</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois de trabalhar nas letras, voc√™ precisa fechar a pasta selecionada e dizer adeus ao servidor. </font><font style="vertical-align: inherit;">Para fechar a pasta, precisamos inserir o comando CLOSE. </font><font style="vertical-align: inherit;">Sim, √© t√£o simples</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
7 CLOSE<font></font>
7 OK Close completed (0.001 + 0.000 secs).<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A prop√≥sito, se voc√™ trabalhou com o console em paralelo comigo e leu o artigo, um evento n√£o t√£o agrad√°vel poderia ter acontecido, o servidor poderia fechar sua conex√£o com o tempo limite. </font><font style="vertical-align: inherit;">Isso √© completamente normal e cada servidor tem seu pr√≥prio tempo limite, por exemplo, temos 30 minutos.&nbsp;</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, √© recomend√°vel executar o comando NOOP em segundo plano</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
1 OK NOOP completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ele literalmente n√£o faz nada, mas permite que voc√™ mantenha a conex√£o sem tempo limite, tanto quanto precisamos. </font><font style="vertical-align: inherit;">Se voc√™ atualmente selecionar uma pasta, o NOOP poder√° funcionar como uma solicita√ß√£o peri√≥dica de altera√ß√µes nessa pasta&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 NOOP<font></font>
* 16472 EXPUNGE<font></font>
* 16471 EXPUNGE<font></font>
* 16472 EXISTS<font></font>
* 1 RECENT<font></font>
1 OK NOOP completed (0.004 + 0.000 + 0.003 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, na resposta, somos notificados de duas mensagens exclu√≠das, uma nova e que o n√∫mero de mensagens nesta pasta √© 16 472. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Observe tamb√©m que voc√™ pode trabalhar com apenas uma pasta selecionada, n√£o h√° trabalho paralelo aqui. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bem, no final, feche a sess√£o com o servidor e nos despediremos.</font></font><br>
<br>
<pre><code class="bash hljs">8 LOGOUT<font></font>
* BYE Logging out<font></font>
8 OK Logout completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vemos a triste resposta sem sinal BYE, o que significa que √© hora de terminar o trabalho.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sincroniza√ß√£o r√°pida com CONDSOTORE e QRESYNC</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ pode usar a opera√ß√£o NOOP para rastrear altera√ß√µes em uma caixa em uma pasta selecionada. Mas e se quisermos descobrir o que mudou na pasta enquanto est√°vamos trabalhando com outra? A op√ß√£o mais √≥bvia √© classificar todas as letras no armazenamento local, seja um cache ou um banco de dados, e comparar com o que o servidor retornar√°. Por um lado, essa √© realmente uma solu√ß√£o e, em alguns servidores, ser√° literalmente a √∫nica verdadeira. Por outro lado, queremos mostrar letras o mais r√°pido que o protocolo geralmente permitir. Felizmente, nosso servidor suporta extens√µes de protocolo como CONDSTORE e QRESYNC, que foram adicionadas ao </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RFC7162</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O primeiro adiciona um n√∫mero especial de 63 bits √† mensagem e pasta, chamada de sequ√™ncia mod, que aumenta a cada opera√ß√£o nesta carta. A sequ√™ncia de mod mais alta entre todas as mensagens √© adicionada √† pasta. Como resultado, cada vez que voc√™ se conecta a uma pasta em um servidor que suporta o CONDSTORE, podemos facilmente descobrir se algo mudou ou n√£o, simplesmente comparando os valores da sequ√™ncia de mod para as pastas local e do servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, esta extens√£o adiciona par√¢metros adicionais para os comandos STORE e FETCH - CHANGEDSINCE mod-sequence e UNCHANGEDSINCE mod-sequence, que permitem executar uma opera√ß√£o se a sequ√™ncia mod das mensagens transmitidas for maior e menor que isso, respectivamente. Vejamos um exemplo.</font></font><br>
<br>
<pre><code class="bash hljs">FETCH 17221:17241 (UID) (CHANGEDSINCE 0)<font></font>
* OK [HIGHESTMODSEQ 22746] Highest<font></font>
* 17222 FETCH (UID 18319 MODSEQ (22580))<font></font>
* 17223 FETCH (UID 18320 MODSEQ (22601))<font></font>
* 17224 FETCH (UID 18324 MODSEQ (22607))<font></font>
* 17225 FETCH (UID 18325 MODSEQ (22604))<font></font>
* 17226 FETCH (UID 18326 MODSEQ (22608))<font></font>
* 17227 FETCH (UID 18327 MODSEQ (22614))<font></font>
* 17228 FETCH (UID 18328 MODSEQ (22613))<font></font>
* 17229 FETCH (UID 18336 MODSEQ (22628))<font></font>
* 17230 FETCH (UID 18338 MODSEQ (22628))<font></font>
* 17231 FETCH (UID 18340 MODSEQ (22628)<font></font>
* 17232 FETCH (UID 18341 MODSEQ (22628))<font></font>
* 17221 FETCH (UID 18318 MODSEQ (22583))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simulei uma situa√ß√£o em que entramos na caixa de correio e n√£o sab√≠amos nada sobre isso antes, ou seja, nossa sequ√™ncia de modifica√ß√£o local √© 0. Como voc√™ pode ver, o servidor nos retorna geralmente todas as mensagens que est√£o na caixa de correio, pois antes disso n√£o receb√≠amos nada e n√£o sabe nada sobre a caixa. Em resposta a uma solicita√ß√£o de cartas UID de CHANGEDSINCE, uma resposta n√£o marcada OK tamb√©m vem com um HIGHESTMODESEQ que agora salvaremos e para cada mensagem nosso MODSEQ.Executaremos </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
algumas opera√ß√µes com a caixa de correio: adicione novas cartas, altere os sinalizadores. Vamos fazer uma nova solicita√ß√£o, mas com a sequ√™ncia de modifica√ß√£o anterior</font></font><br>
<br>
<pre><code class="bash hljs">1 fetch 17221:* (UID FLAGS) (CHANGEDSINCE 22746)<font></font>
* 17267 FETCH (UID 18378 FLAGS () MODSEQ (22753))<font></font>
* 17270 FETCH (UID 18381 FLAGS (\Seen) MODSEQ (22754))<font></font>
* 17271 FETCH (UID 18382 FLAGS () MODSEQ (22751))<font></font>
* 17273 FETCH (UID 18384 FLAGS () MODSEQ (22750))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e j√° vemos a diferen√ßa, em vez de gerar 20 comunidades novas e antigas que acabamos de chegar (asterisco em 17221: * significa levar letras do n√∫mero 17221 ao m√°ximo poss√≠vel), recebemos cartas cujo MODSEQ √© maior que o anterior. Isso ajuda muito bem a sincronizar uma pasta na qual n√£o estamos h√° algum tempo e obter uma esp√©cie de convers√£o das letras alteradas, em vez de tentar todas as poss√≠veis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece, muito melhor? Mas o QRESYNC torna a opera√ß√£o de sincroniza√ß√£o ainda mais r√°pida, permitindo especificar os par√¢metros MODSEQ e as UIDs de mensagens conhecidas por n√≥s durante a sele√ß√£o da pasta. Vamos explicar com um exemplo. Primeiro, o QRESYNC deve ser ativado com o comando ENABLE.&nbsp;</font></font><br>
<br>
<pre><code class="bash hljs">1 ENABLE QRESYNC<font></font>
* ENABLED QRESYNC<font></font>
1 OK Enabled (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (0 0))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18385] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22754] Highest<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
como n√£o sab√≠amos nada sobre a pasta antes disso, o servidor retorna apenas informa√ß√µes sobre a pasta para n√≥s, sem um nugget de suas altera√ß√µes. Suponha que tenhamos perguntado as primeiras vinte mensagens e lembrado o UID e tamb√©m o HIGHESTMODESEQ. Sa√≠mos da pasta, nos enviamos uma mensagem, exclu√≠mos a mensagem, alteramos os sinalizadores e retornamos com as informa√ß√µes anteriores sobre a pasta</font></font><br>
<br>
<pre><code class="bash hljs">1 CLOSE<font></font>
1 OK Close completed (0.001 + 0.000 secs).<font></font>
1 SELECT INBOX (QRESYNC (1532079879 22754 18300:18385))<font></font>
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span>)<font></font>
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft <span class="hljs-variable">$Forwarded</span> <span class="hljs-variable">$MDNSent</span> \*)] Flags permitted.<font></font>
* 17271 EXISTS<font></font>
* 0 RECENT<font></font>
* OK [UNSEEN 17241] First unseen.<font></font>
* OK [UIDVALIDITY 1532079879] UIDs valid<font></font>
* OK [UIDNEXT 18386] Predicted next UID<font></font>
* OK [HIGHESTMODSEQ 22757] Highest<font></font>
* VANISHED (EARLIER) 18380<font></font>
* 17269 FETCH (UID 18383 FLAGS () MODSEQ (22757))<font></font>
* 17271 FETCH (UID 18385 FLAGS () MODSEQ (22755))<font></font>
1 OK [READ-WRITE] Select completed (0.001 + 0.000 secs).</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E agora, ao escolher uma pasta alterada, obtemos imediatamente um nugget de altera√ß√µes, na forma de uma resposta VANISHED (EARLIER) para mensagens que foram exclu√≠das e FETCH para mensagens que foram adicionadas ou alteradas. Agora √© ainda mais f√°cil sincronizar a pasta se o usu√°rio n√£o a visitar h√° um longo tempo. Essa √© uma maneira muito interessante se voc√™ tiver v√°rias mensagens armazenadas localmente no cache e n√£o quiser compar√°-las com as mensagens no servidor. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O primeiro par√¢metro dessa solicita√ß√£o √© UIDVALIDITY, que √© essencialmente usado para verificar se o uid que voc√™ recebeu anteriormente n√£o foi alterado na pasta. Isso pode acontecer se o servidor alterar o uid da sess√£o de sess√£o para sess√£o para todas as mensagens ou se a pasta foi exclu√≠da e uma pasta com o mesmo nome foi criada em seu lugar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O segundo par√¢metro √© o HIGHESTMODSEQ conhecido por n√≥s e o √∫ltimo √© o intervalo de UIDs conhecidos. Eles podem ser gravados como dois pontos, se o intervalo for cont√≠nuo ou separado por v√≠rgula.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclus√£o</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No meu exemplo, deparei-me com uma situa√ß√£o em que a ignor√¢ncia da √°rea de assunto leva √† opera√ß√£o incorreta e sub√≥tima do aplicativo. </font><font style="vertical-align: inherit;">N√£o cobri todas as op√ß√µes poss√≠veis para usar o protocolo neste artigo. </font><font style="vertical-align: inherit;">Mas espero que para o pr√≥ximo desenvolvedor do cliente IMAP as informa√ß√µes acima sejam √∫teis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O IMAP tem uma tonelada de coisas interessantes. </font><font style="vertical-align: inherit;">Os comandos para sincroniza√ß√£o r√°pida s√£o apenas o come√ßo; na verdade, voc√™ pode otimizar ainda mais os comandos IMAP, dependendo dos recursos do servidor, e tornar o trabalho com o correio mais r√°pido, mais econ√¥mico na rede e na mem√≥ria e geralmente mais agrad√°vel. </font><font style="vertical-align: inherit;">Mas vou falar sobre isso mais tarde.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt492058/index.html">Instalando o ROS2 no Ubuntu 18.04</a></li>
<li><a href="../pt492060/index.html">Como resolver? "ECONNREFUSED - Conex√£o recusada pelo servidor"</a></li>
<li><a href="../pt492062/index.html">Modelo de servidor back-end Golang - parte 1 (servidor HTTP)</a></li>
<li><a href="../pt492066/index.html">Por que o Event Sourcing √© o antipadr√£o para a intera√ß√£o de microsservi√ßos</a></li>
<li><a href="../pt492068/index.html">Grupo S7 abre um departamento ‚ÄúTecnologias de Informa√ß√£o na Avia√ß√£o‚Äù no MIPT</a></li>
<li><a href="../pt492076/index.html">Um exemplo de arquitetura hexagonal em Java</a></li>
<li><a href="../pt492078/index.html">Os materiais mais importantes e √∫teis do coronav√≠rus COVID-19</a></li>
<li><a href="../pt492082/index.html">Como simplificar o gerenciamento de dispositivos dom√©sticos e proteg√™-los (compartilhe ideias sobre o Kauri Safe Smart Home)</a></li>
<li><a href="../pt492086/index.html">Coronav√≠rus vs neg√≥cios de TI russos: as empresas est√£o prontas para transferir funcion√°rios para um local remoto?</a></li>
<li><a href="../pt492088/index.html">Testando o mecanismo de jogo do Amazon Lumberyard. Abordagens e Ferramentas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>