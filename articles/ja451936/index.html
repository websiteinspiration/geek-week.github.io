<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📣 🐲 👩‍🔧 UCブラウザーの脆弱性を探す 🤹 🤚🏼 👨🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="前書き
 3月の終わりに、検証されていないコードをUCブラウザーでダウンロードして実行する隠れた機能を発見したと報告しました。今日は、このダウンロードがどのように行われ、ハッカーが自分の目的でそれを使用することができるかを詳しく分析します。
 
 しばらく前にUCブラウザが宣伝され、非常に積極的に配...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>UCブラウザーの脆弱性を探す</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/drweb/blog/451936/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/-f/na/kn/-fnaknrx70xmfiflvfa6ijw1pys.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前書き</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3月の終わりに、</font><font style="vertical-align: inherit;">検証されていないコードをUCブラウザーでダウンロードして実行する隠れた機能を発見した</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と報告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">しました。今日は、このダウンロードがどのように行われ、ハッカーが自分の目的でそれを使用することができるかを詳しく分析します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しばらく前にUCブラウザが宣伝され、非常に積極的に配布されました：マルウェアを使用してユーザーのデバイスにインストールされ、ビデオファイルを装ってさまざまなサイトから配布されました（つまり、ユーザーはポルノクリップなどをダウンロードしたと思ったが、代わりにこれを使用してAPKを受け取ったブラウザ）、ブラウザが古く、脆弱であり、そのようなものであるというメッセージを伴う恐ろしいバナーを使用しました。 VKの公式UCブラウザグループには</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーマがあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーザーが不当な広告について不満を言うことができる場合、多くの例があります。 2016年には</font><font style="vertical-align: inherit;">、ロシア語</font><font style="vertical-align: inherit;">での</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">動画広告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">さえありました</font><font style="vertical-align: inherit;">（そうです、広告をブロックするブラウザーからの広告）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを書いている時点では、UC BrowserのGoogle Playへのインストール数は5億を超えています。これは印象的です-Google Chromeだけがもっと持っています。レビューの中には、Google Playの広告や一部のアプリケーションへのリダイレクトに関する苦情がたくさんあります。これが調査の理由でした。UCブラウザーが何か悪いことをしているかどうかを確認することにしました。そして、それは彼がそれをしていたことが判明しました！</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アプリケーションコードにより、実行可能コードをダウンロードして実行する機能が明らかになりました。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは、</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Google Playでの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">アプリケーションの公開に関する規則に反します</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">UCブラウザーが実行可能コードをダウンロードするという事実に加えて、それは安全ではなくなり、MitM攻撃の実行に使用される可能性があります。</font><font style="vertical-align: inherit;">このような攻撃を何とか実行できたかどうかを確認してみましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下に記載されている内容はすべて、調査時にGoogle Playに存在していたUCブラウザのバージョンに関連しています。</font></font><br>
<br>
<pre><code class="plaintext hljs">package: com.UCMobile.intl<font></font>
versionName: 12.10.8.1172<font></font>
versionCode: 10598<font></font>
sha1 APK-: f5edb2243413c777172f6362876041eb0c3a928c</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">攻撃ベクトル</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UCブラウザーマニフェストで、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com.uc.deployment.UpgradeDeployService</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">というサービスを見つけることができます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="plaintext hljs">    &lt;service android:exported="false" android:name="com.uc.deployment.UpgradeDeployService" android:process=":deploy" /&gt;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このサービスが開始すると、ブラウザーは</font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtmlに</font></a></i><font style="vertical-align: inherit;"> POSTリクエストを送信し</font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、開始後しばらくして交通量に気づくことができます。それに応じて、彼はアップデートまたは新しいモジュールをダウンロードするコマンドを受け取るかもしれません。分析中、サーバーはそのようなコマンドを提供しませんでしたが、ブラウザーでPDFを開こうとすると、上記のアドレスで2番目の要求を行い、その後ネイティブライブラリをダウンロードします。攻撃を実行するために、UCブラウザーのこの機能を使用することを決定しました。APKにはなく、必要に応じてインターネットからダウンロードされるネイティブライブラリを使用してPDFを開く機能です。理論的には、UCブラウザーは、ブラウザーの起動後に実行される要求に対して正しく形成された応答を提供した場合、ユーザーの操作なしで何かを強制的にダウンロードできることに注意してください。ただし、このためには、サーバーとのやり取りのプロトコルをさらに詳しく調べる必要があります。したがって、インターセプトされた回答を編集して、PDFで作業するためのライブラリを置き換える方が簡単であると判断しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ユーザーがブラウザで直接PDFを開きたい場合は、トラフィックで次のリクエストが表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/j0/i1/c1/j0i1c1n_nwf_gnauzbudnqor5oi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、</font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtml</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">へのPOSTリクエストが</font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">あり</font></a></i><font style="vertical-align: inherit;">、その後に</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PDFおよび</font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Office</font></a></i><font style="vertical-align: inherit;">形式を表示するためのライブラリを含むアーカイブがダウンロードされます。</font><font style="vertical-align: inherit;">最初のリクエストでは、システムに関する情報が送信され（少なくとも必要なライブラリを提供するためのアーキテクチャ）、それに応答して、ブラウザはダウンロードする必要があるライブラリに関するいくつかの情報を受信すると想定することは論理的です：アドレス、そしておそらく他の何か。</font><font style="vertical-align: inherit;">問題は、このリクエストが暗号化されていることです。</font></font><br>
<br>
<div class="scrollable-table"><table>
<tbody><tr>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> リクエストスニペット</font></font><br>
<br>
</td>
<td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 応答スニペット</font></font><br>
<br>
</td>
</tr>
<tr>
<td><img src="https://habrastorage.org/webt/go/tj/tz/gotjtzkpg2owfmk8jrnznox_vdg.jpeg"><br>
<br>
</td>
<td><img src="https://habrastorage.org/webt/g5/7k/iv/g57kivkwrysmcqvptmhclqzzipq.png"><br>
<br>
</td>
</tr>
</tbody></table></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ライブラリ自体はZIPでパッケージ化されており、暗号化されていません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6r/lt/ns/6rltnsrtyd-_5ekwis68qn-vydc.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">検索トラフィック復号化コード</font></font></h3><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーの応答を復号化してみましょう。</font><font style="vertical-align: inherit;">私たちは、クラスのコードを見て</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com.uc.deployment.UpgradeDeployService</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：から</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">onStartCommand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font><i><font style="vertical-align: inherit;">我々は</font></i><font style="vertical-align: inherit;">に行く</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com.uc.deployment.bx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、およびそれからの</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com.uc.browser.core.dcfe</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">e</span><span class="hljs-params">(l arg9)</span> </span>{
        <span class="hljs-keyword">int</span> v4_5;<font></font>
        String v3_1;<font></font>
        <span class="hljs-keyword">byte</span>[] v3;
        <span class="hljs-keyword">byte</span>[] v1 = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">if</span>(arg9 == <span class="hljs-keyword">null</span>) {<font></font>
            v3 = v1;<font></font>
        }<font></font>
        <span class="hljs-keyword">else</span> {<font></font>
            v3_1 = arg9.iGX.ipR;<font></font>
            StringBuilder v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]product:"</span>);<font></font>
            v4.append(arg9.iGX.ipR);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]version:"</span>);<font></font>
            v4.append(arg9.iGX.iEn);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]upgrade_type:"</span>);<font></font>
            v4.append(arg9.iGX.mMode);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]force_flag:"</span>);<font></font>
            v4.append(arg9.iGX.iEo);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]silent_mode:"</span>);<font></font>
            v4.append(arg9.iGX.iDQ);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]silent_type:"</span>);<font></font>
            v4.append(arg9.iGX.iEr);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]silent_state:"</span>);<font></font>
            v4.append(arg9.iGX.iEp);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]silent_file:"</span>);<font></font>
            v4.append(arg9.iGX.iEq);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]apk_md5:"</span>);<font></font>
            v4.append(arg9.iGX.iEl);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]download_type:"</span>);<font></font>
            v4.append(arg9.mDownloadType);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]download_group:"</span>);<font></font>
            v4.append(arg9.mDownloadGroup);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]download_path:"</span>);<font></font>
            v4.append(arg9.iGH);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]apollo_child_version:"</span>);<font></font>
            v4.append(arg9.iGX.iEx);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]apollo_series:"</span>);<font></font>
            v4.append(arg9.iGX.iEw);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]apollo_cpu_arch:"</span>);<font></font>
            v4.append(arg9.iGX.iEt);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]apollo_cpu_vfp3:"</span>);<font></font>
            v4.append(arg9.iGX.iEv);<font></font>
            v4 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v4.append(v3_1);<font></font>
            v4.append(<span class="hljs-string">"]apollo_cpu_vfp:"</span>);<font></font>
            v4.append(arg9.iGX.iEu);<font></font>
            ArrayList v3_2 = arg9.iGX.iEz;<font></font>
            <span class="hljs-keyword">if</span>(v3_2 != <span class="hljs-keyword">null</span> &amp;&amp; v3_2.size() != <span class="hljs-number">0</span>) {<font></font>
                Iterator v3_3 = v3_2.iterator();<font></font>
                <span class="hljs-keyword">while</span>(v3_3.hasNext()) {<font></font>
                    Object v4_1 = v3_3.next();<font></font>
                    StringBuilder v5 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
                    v5.append(((au)v4_1).getName());<font></font>
                    v5.append(<span class="hljs-string">"]component_name:"</span>);<font></font>
                    v5.append(((au)v4_1).getName());<font></font>
                    v5 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
                    v5.append(((au)v4_1).getName());<font></font>
                    v5.append(<span class="hljs-string">"]component_ver_name:"</span>);<font></font>
                    v5.append(((au)v4_1).aDA());<font></font>
                    v5 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
                    v5.append(((au)v4_1).getName());<font></font>
                    v5.append(<span class="hljs-string">"]component_ver_code:"</span>);<font></font>
                    v5.append(((au)v4_1).gBl);<font></font>
                    v5 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
                    v5.append(((au)v4_1).getName());<font></font>
                    v5.append(<span class="hljs-string">"]component_req_type:"</span>);<font></font>
                    v5.append(((au)v4_1).gBq);<font></font>
                }<font></font>
            }<font></font>
 <font></font>
            j v3_4 = <span class="hljs-keyword">new</span> j();<font></font>
            m.b(v3_4);<font></font>
            h v4_2 = <span class="hljs-keyword">new</span> h();<font></font>
            m.b(v4_2);<font></font>
            ay v5_1 = <span class="hljs-keyword">new</span> ay();<font></font>
            v3_4.hS(<span class="hljs-string">""</span>);<font></font>
            v3_4.setImsi(<span class="hljs-string">""</span>);<font></font>
            v3_4.hV(<span class="hljs-string">""</span>);<font></font>
            v5_1.bPQ = v3_4;<font></font>
            v5_1.bPP = v4_2;<font></font>
            v5_1.yr(arg9.iGX.ipR);<font></font>
            v5_1.gBF = arg9.iGX.mMode;<font></font>
            v5_1.gBI = arg9.iGX.iEz;<font></font>
            v3_2 = v5_1.gAr;<font></font>
            c.aBh();<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"os_ver"</span>, c.getRomInfo()));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"processor_arch"</span>, com.uc.b.a.a.c.getCpuArch()));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"cpu_arch"</span>, com.uc.b.a.a.c.Pb()));<font></font>
            String v4_3 = com.uc.b.a.a.c.Pd();<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"cpu_vfp"</span>, v4_3));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"net_type"</span>, String.valueOf(com.uc.base.system.a.Jo())));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"fromhost"</span>, arg9.iGX.iEm));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"plugin_ver"</span>, arg9.iGX.iEn));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"target_lang"</span>, arg9.iGX.iEs));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"vitamio_cpu_arch"</span>, arg9.iGX.iEt));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"vitamio_vfp"</span>, arg9.iGX.iEu));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"vitamio_vfp3"</span>, arg9.iGX.iEv));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"plugin_child_ver"</span>, arg9.iGX.iEx));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"ver_series"</span>, arg9.iGX.iEw));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"child_ver"</span>, r.aVw()));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"cur_ver_md5"</span>, arg9.iGX.iEl));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"cur_ver_signature"</span>, SystemHelper.getUCMSignature()));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"upgrade_log"</span>, i.bjt()));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"silent_install"</span>, String.valueOf(arg9.iGX.iDQ)));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"silent_state"</span>, String.valueOf(arg9.iGX.iEp)));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"silent_file"</span>, arg9.iGX.iEq));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"silent_type"</span>, String.valueOf(arg9.iGX.iEr)));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"cpu_archit"</span>, com.uc.b.a.a.c.Pc()));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"cpu_set"</span>, SystemHelper.getCpuInstruction()));
            <span class="hljs-keyword">boolean</span> v4_4 = v4_3 == <span class="hljs-keyword">null</span> || !v4_3.contains(<span class="hljs-string">"neon"</span>) ? <span class="hljs-keyword">false</span> : <span class="hljs-keyword">true</span>;<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"neon"</span>, String.valueOf(v4_4)));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"cpu_cores"</span>, String.valueOf(com.uc.b.a.a.c.Jl())));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"ram_1"</span>, String.valueOf(com.uc.b.a.a.h.Po())));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"totalram"</span>, String.valueOf(com.uc.b.a.a.h.OL())));<font></font>
            c.aBh();<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"rom_1"</span>, c.getRomInfo()));<font></font>
            v4_5 = e.getScreenWidth();<font></font>
            <span class="hljs-keyword">int</span> v6 = e.getScreenHeight();<font></font>
            StringBuilder v7 = <span class="hljs-keyword">new</span> StringBuilder();<font></font>
            v7.append(v4_5);<font></font>
            v7.append(<span class="hljs-string">"*"</span>);<font></font>
            v7.append(v6);<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"ss"</span>, v7.toString()));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"api_level"</span>, String.valueOf(Build$VERSION.SDK_INT)));<font></font>
            v3_2.add(g.fs(<span class="hljs-string">"uc_apk_list"</span>, SystemHelper.getUCMobileApks()));<font></font>
            Iterator v4_6 = arg9.iGX.iEA.entrySet().iterator();<font></font>
            <span class="hljs-keyword">while</span>(v4_6.hasNext()) {<font></font>
                Object v6_1 = v4_6.next();<font></font>
                v3_2.add(g.fs(((Map$Entry)v6_1).getKey(), ((Map$Entry)v6_1).getValue()));<font></font>
            }<font></font>
 <font></font>
            v3 = v5_1.toByteArray();<font></font>
        }<font></font>
 <font></font>
        <span class="hljs-keyword">if</span>(v3 == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">this</span>.iGY.iGI.a(arg9, <span class="hljs-string">"up_encode"</span>, <span class="hljs-string">"yes"</span>, <span class="hljs-string">"fail"</span>);
            <span class="hljs-keyword">return</span>;<font></font>
        }<font></font>
 <font></font>
        v4_5 = <span class="hljs-keyword">this</span>.iGY.iGw ? <span class="hljs-number">0x1F</span> : <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span>(v3 == <span class="hljs-keyword">null</span>) {<font></font>
        }<font></font>
        <span class="hljs-keyword">else</span> {<font></font>
            v3 = g.i(v4_5, v3);<font></font>
            <span class="hljs-keyword">if</span>(v3 == <span class="hljs-keyword">null</span>) {<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span> {<font></font>
                v1 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[v3.length + <span class="hljs-number">16</span>];
                <span class="hljs-keyword">byte</span>[] v6_2 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">16</span>];<font></font>
                Arrays.fill(v6_2, <span class="hljs-number">0</span>);<font></font>
                v6_2[<span class="hljs-number">0</span>] = <span class="hljs-number">0x5F</span>;<font></font>
                v6_2[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<font></font>
                v6_2[<span class="hljs-number">2</span>] = ((<span class="hljs-keyword">byte</span>)v4_5);<font></font>
                v6_2[<span class="hljs-number">3</span>] = -<span class="hljs-number">50</span>;<font></font>
                System.arraycopy(v6_2, <span class="hljs-number">0</span>, v1, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>);<font></font>
                System.arraycopy(v3, <span class="hljs-number">0</span>, v1, <span class="hljs-number">16</span>, v3.length);<font></font>
            }<font></font>
        }<font></font>
 <font></font>
        <span class="hljs-keyword">if</span>(v1 == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">this</span>.iGY.iGI.a(arg9, <span class="hljs-string">"up_encrypt"</span>, <span class="hljs-string">"yes"</span>, <span class="hljs-string">"fail"</span>);
            <span class="hljs-keyword">return</span>;<font></font>
        }<font></font>
 <font></font>
        <span class="hljs-keyword">if</span>(TextUtils.isEmpty(<span class="hljs-keyword">this</span>.iGY.mUpgradeUrl)) {
            <span class="hljs-keyword">this</span>.iGY.iGI.a(arg9, <span class="hljs-string">"up_url"</span>, <span class="hljs-string">"yes"</span>, <span class="hljs-string">"fail"</span>);
            <span class="hljs-keyword">return</span>;<font></font>
        }<font></font>
 <font></font>
        StringBuilder v0 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
        v0.append(arg9.iGX.ipR);<font></font>
        v0.append(<span class="hljs-string">"]url:"</span>);<font></font>
        v0.append(<span class="hljs-keyword">this</span>.iGY.mUpgradeUrl);<font></font>
        com.uc.browser.core.d.c.i v0_1 = <span class="hljs-keyword">this</span>.iGY.iGI;<font></font>
        v3_1 = <span class="hljs-keyword">this</span>.iGY.mUpgradeUrl;<font></font>
        com.uc.base.net.e v0_2 = <span class="hljs-keyword">new</span> com.uc.base.net.e(<span class="hljs-keyword">new</span> com.uc.browser.core.d.c.i$a(v0_1, arg9));<font></font>
        v3_1 = v3_1.contains(<span class="hljs-string">"?"</span>) ? v3_1 + <span class="hljs-string">"&amp;dataver=pb"</span> : v3_1 + <span class="hljs-string">"?dataver=pb"</span>;<font></font>
        n v3_5 = v0_2.uc(v3_1);<font></font>
        m.b(v3_5, <span class="hljs-keyword">false</span>);<font></font>
        v3_5.setMethod(<span class="hljs-string">"POST"</span>);<font></font>
        v3_5.setBodyProvider(v1);<font></font>
        v0_2.b(v3_5);<font></font>
        <span class="hljs-keyword">this</span>.iGY.iGI.a(arg9, <span class="hljs-string">"up_null"</span>, <span class="hljs-string">"yes"</span>, <span class="hljs-string">"success"</span>);
        <span class="hljs-keyword">this</span>.iGY.iGI.b(arg9);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、POSTリクエストの形成を確認します。</font><font style="vertical-align: inherit;">16バイトの配列の作成とその塗りつぶしに注目します：0x5F、0、0x1F、-50（= 0xCE）。</font><font style="vertical-align: inherit;">上記のリクエストで見たものと一致します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じクラスで、別の興味深いメソッドがあるネストされたクラスに気付くことができます：</font></font><br>
<br>
<pre><code class="java hljs">        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">a</span><span class="hljs-params">(l arg10, <span class="hljs-keyword">byte</span>[] arg11)</span> </span>{<font></font>
            f v0 = <span class="hljs-keyword">this</span>.iGQ;<font></font>
            StringBuilder v1 = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"["</span>);<font></font>
            v1.append(arg10.iGX.ipR);<font></font>
            v1.append(<span class="hljs-string">"]:UpgradeSuccess"</span>);
            <span class="hljs-keyword">byte</span>[] v1_1 = <span class="hljs-keyword">null</span>;
            <span class="hljs-keyword">if</span>(arg11 == <span class="hljs-keyword">null</span>) {<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(arg11.length &lt; <span class="hljs-number">16</span>) {<font></font>
            }<font></font>
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span>(arg11[<span class="hljs-number">0</span>] != <span class="hljs-number">0x60</span> &amp;&amp; arg11[<span class="hljs-number">3</span>] != <span class="hljs-number">0xFFFFFFD0</span>) {<font></font>
                    goto label_57;<font></font>
                }<font></font>
                <span class="hljs-keyword">int</span> v3 = <span class="hljs-number">1</span>;
                <span class="hljs-keyword">int</span> v5 = arg11[<span class="hljs-number">1</span>] == <span class="hljs-number">1</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
                <span class="hljs-keyword">if</span>(arg11[<span class="hljs-number">2</span>] != <span class="hljs-number">1</span> &amp;&amp; arg11[<span class="hljs-number">2</span>] != <span class="hljs-number">11</span>) {
                    <span class="hljs-keyword">if</span>(arg11[<span class="hljs-number">2</span>] == <span class="hljs-number">0x1F</span>) {<font></font>
                    }<font></font>
                    <span class="hljs-keyword">else</span> {<font></font>
                        v3 = <span class="hljs-number">0</span>;<font></font>
                    }<font></font>
                }<font></font>
                <span class="hljs-keyword">byte</span>[] v7 = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[arg11.length - <span class="hljs-number">16</span>];<font></font>
                System.arraycopy(arg11, <span class="hljs-number">16</span>, v7, <span class="hljs-number">0</span>, v7.length);
                <span class="hljs-keyword">if</span>(v3 != <span class="hljs-number">0</span>) {<font></font>
                    v7 = g.j(arg11[<span class="hljs-number">2</span>], v7);<font></font>
                }<font></font>
                <span class="hljs-keyword">if</span>(v7 == <span class="hljs-keyword">null</span>) {<font></font>
                    goto label_57;<font></font>
                }<font></font>
                <span class="hljs-keyword">if</span>(v5 != <span class="hljs-number">0</span>) {<font></font>
                    v1_1 = g.P(v7);<font></font>
                    goto label_57;<font></font>
                }<font></font>
                v1_1 = v7;<font></font>
            }<font></font>
        label_57:<font></font>
            <span class="hljs-keyword">if</span>(v1_1 == <span class="hljs-keyword">null</span>) {<font></font>
                v0.iGY.iGI.a(arg10, <span class="hljs-string">"up_decrypt"</span>, <span class="hljs-string">"yes"</span>, <span class="hljs-string">"fail"</span>);
                <span class="hljs-keyword">return</span>;<font></font>
            }<font></font>
            q v11 = g.b(arg10, v1_1);<font></font>
            <span class="hljs-keyword">if</span>(v11 == <span class="hljs-keyword">null</span>) {<font></font>
                v0.iGY.iGI.a(arg10, <span class="hljs-string">"up_decode"</span>, <span class="hljs-string">"yes"</span>, <span class="hljs-string">"fail"</span>);
                <span class="hljs-keyword">return</span>;<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span>(v0.iGY.iGt) {<font></font>
                v0.d(arg10);<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span>(v0.iGY.iGo != <span class="hljs-keyword">null</span>) {<font></font>
                v0.iGY.iGo.a(<span class="hljs-number">0</span>, ((o)v11));<font></font>
            }<font></font>
            <span class="hljs-keyword">if</span>(v0.iGY.iGs) {<font></font>
                v0.iGY.a(((o)v11));<font></font>
                v0.iGY.iGI.a(v11, <span class="hljs-string">"up_silent"</span>, <span class="hljs-string">"yes"</span>, <span class="hljs-string">"success"</span>);<font></font>
                v0.iGY.iGI.a(v11);<font></font>
                <span class="hljs-keyword">return</span>;<font></font>
            }<font></font>
            v0.iGY.iGI.a(v11, <span class="hljs-string">"up_silent"</span>, <span class="hljs-string">"no"</span>, <span class="hljs-string">"success"</span>);<font></font>
        }<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメソッドは、バイト配列を入力として受け取り、ゼロバイトが0x60または3番目のバイトが0xD0であり、2番目のバイトが1、11または0x1Fであることを確認します。サーバーからの回答を確認します。0バイト-0x60、2番目-0x1F、3番目-0x60。必要なもののように見えます。行（「up_decrypt」など）から判断すると、サーバーの応答を復号化するメソッドをここで呼び出す必要があります。</font><i><font style="vertical-align: inherit;">gj</font></i></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
メソッドに渡し</font><font style="vertical-align: inherit;">ます。オフセット2のバイト（この例では0x1F）が最初の引数としてそこに転送され、</font><font style="vertical-align: inherit;">
最初の16バイト</font><font style="vertical-align: inherit;">なしのサーバー応答が2番目の引数として転送されることに注意してください</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="java hljs">     <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] j(<span class="hljs-keyword">int</span> arg1, <span class="hljs-keyword">byte</span>[] arg2) {
        <span class="hljs-keyword">if</span>(arg1 == <span class="hljs-number">1</span>) {<font></font>
            arg2 = c.c(arg2, c.adu);<font></font>
        }<font></font>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(arg1 == <span class="hljs-number">11</span>) {<font></font>
            arg2 = m.aF(arg2);<font></font>
        }<font></font>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(arg1 != <span class="hljs-number">0x1F</span>) {<font></font>
        }<font></font>
        <span class="hljs-keyword">else</span> {<font></font>
            arg2 = EncryptHelper.decrypt(arg2);<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> arg2;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
明らかに、解読アルゴリズムの選択があり、同じバイト（この</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
場合は0x1F）は、3つの可能なオプションの1つを示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードの分析を続けます。</font><font style="vertical-align: inherit;">数回ジャンプした後、トーキング名である</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">decodeBytesByKey</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を持つメソッドに</font><i><font style="vertical-align: inherit;">入り</font></i><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、さらに2バイトが回答から分離され、それらから文字列が取得されます。</font><font style="vertical-align: inherit;">このようにして、メッセージを復号化するためにキーが選択されることは明らかです。</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] decryptBytesByKey(<span class="hljs-keyword">byte</span>[] bytes) {
        <span class="hljs-keyword">byte</span>[] v0 = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">if</span>(bytes != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span>(bytes.length &lt; EncryptHelper.PREFIX_BYTES_SIZE) {<font></font>
                }<font></font>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(bytes.length == EncryptHelper.PREFIX_BYTES_SIZE) {
                    <span class="hljs-keyword">return</span> v0;<font></font>
                }<font></font>
                <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">byte</span>[] prefix = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[EncryptHelper.PREFIX_BYTES_SIZE];  <span class="hljs-comment">// 2 </span>
                    System.arraycopy(bytes, <span class="hljs-number">0</span>, prefix, <span class="hljs-number">0</span>, prefix.length);<font></font>
                    String keyId = c.ayR().d(ByteBuffer.wrap(prefix).getShort()); <span class="hljs-comment">//  </span>
                    <span class="hljs-keyword">if</span>(keyId == <span class="hljs-keyword">null</span>) {
                        <span class="hljs-keyword">return</span> v0;<font></font>
                    }<font></font>
                    <span class="hljs-keyword">else</span> {<font></font>
                        a v2 = EncryptHelper.ayL();<font></font>
                        <span class="hljs-keyword">if</span>(v2 == <span class="hljs-keyword">null</span>) {
                            <span class="hljs-keyword">return</span> v0;<font></font>
                        }<font></font>
                        <span class="hljs-keyword">else</span> {
                            <span class="hljs-keyword">byte</span>[] enrypted = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[bytes.length - EncryptHelper.PREFIX_BYTES_SIZE];<font></font>
                            System.arraycopy(bytes, EncryptHelper.PREFIX_BYTES_SIZE, enrypted, <span class="hljs-number">0</span>, enrypted.length);
                            <span class="hljs-keyword">return</span> v2.l(keyId, enrypted);<font></font>
                        }<font></font>
                    }<font></font>
                }<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span>(SecException v7_1) {<font></font>
                EncryptHelper.handleDecryptException(((Throwable)v7_1), v7_1.getErrorCode());<font></font>
                <span class="hljs-keyword">return</span> v0;<font></font>
            }<font></font>
            <span class="hljs-keyword">catch</span>(Throwable v7) {<font></font>
                EncryptHelper.handleDecryptException(v7, <span class="hljs-number">2</span>);
                <span class="hljs-keyword">return</span> v0;<font></font>
            }<font></font>
        }<font></font>
 <font></font>
        <span class="hljs-keyword">return</span> v0;<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
先を見れば、この段階ではキーはまだ取得されておらず、「識別子」のみが取得されていることに注意してください。</font><font style="vertical-align: inherit;">キーの取得はもう少し複雑です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の方法では、既存のパラメーターにさらに2つが追加され、そのうち4つがあります。マジックナンバー16、キー識別子、暗号化されたデータ、および理解できない文字列（この場合は空）です。</font></font><br>
<br>
<pre><code class="java hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] l(String keyId, <span class="hljs-keyword">byte</span>[] encrypted) <span class="hljs-keyword">throws</span> SecException {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.ayJ().staticBinarySafeDecryptNoB64(<span class="hljs-number">16</span>, keyId, encrypted, <span class="hljs-string">""</span>);<font></font>
    }</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一連の移行の後、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com.alibaba.wireless.security.open.staticdataencrypt.IStaticDataEncryptComponent</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インターフェイスの</font><i><font style="vertical-align: inherit;">staticBinarySafeDecryptNoB64</font></i><font style="vertical-align: inherit;">メソッドに</font><i><font style="vertical-align: inherit;">到達し</font></i><font style="vertical-align: inherit;">ます</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションのメインコードには、このインターフェイスを実装するクラスはありません。そのようなクラスは、ファイル</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lib / armeabi-v7a / libsgmain.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にあります。これは、実際には.soではなく.jarです。私たちにとって興味深い方法は、次のように実装されています。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">package</span> com.alibaba.wireless.security.a.i;<font></font>
 <font></font>
<span class="hljs-comment">// ...</span><font></font>
 <font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">a</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IStaticDataEncryptComponent</span> </span>{
    <span class="hljs-keyword">private</span> ISecurityGuardPlugin a;
<span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] a(<span class="hljs-keyword">int</span> mode, <span class="hljs-keyword">int</span> magicInt, <span class="hljs-keyword">int</span> xzInt, String keyId, <span class="hljs-keyword">byte</span>[] encrypted, String magicString) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.a.getRouter().doCommand(<span class="hljs-number">10601</span>, <span class="hljs-keyword">new</span> Object[]{Integer.valueOf(mode), Integer.valueOf(magicInt), Integer.valueOf(xzInt), keyId, encrypted, magicString});<font></font>
    }<font></font>
<span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] b(<span class="hljs-keyword">int</span> magicInt, String keyId, <span class="hljs-keyword">byte</span>[] encrypted, String magicString) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.a(<span class="hljs-number">2</span>, magicInt, <span class="hljs-number">0</span>, keyId, encrypted, magicString);<font></font>
    }<font></font>
<span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] staticBinarySafeDecryptNoB64(<span class="hljs-keyword">int</span> magicInt, String keyId, <span class="hljs-keyword">byte</span>[] encrypted, String magicString) <span class="hljs-keyword">throws</span> SecException {
        <span class="hljs-keyword">if</span>(keyId != <span class="hljs-keyword">null</span> &amp;&amp; keyId.length() &gt; <span class="hljs-number">0</span> &amp;&amp; magicInt &gt;= <span class="hljs-number">0</span> &amp;&amp; magicInt &lt; <span class="hljs-number">19</span> &amp;&amp; encrypted != <span class="hljs-keyword">null</span> &amp;&amp; encrypted.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.b(magicInt, keyId, encrypted, magicString);<font></font>
        }<font></font>
 <font></font>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SecException(<span class="hljs-string">""</span>, <span class="hljs-number">301</span>);<font></font>
    }<font></font>
<span class="hljs-comment">//...</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パラメータのリストには、さらに2つの整数2と0が追加</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
されてい</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">メソッド</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doFinal</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムクラス</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">javax.crypto.Cipherの</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ように、約2のデコード手段</font><font style="vertical-align: inherit;">によって</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そして、これらすべてが番号10601の特定のルーターに転送されます-これは明らかに、コマンド番号です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の遷移チェーンの後で、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IRouterComponent</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インターフェイス</font><font style="vertical-align: inherit;">と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doCommand</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッド</font><font style="vertical-align: inherit;">を実装するクラスを見つけます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">package</span> com.alibaba.wireless.security.mainplugin;<font></font>
<font></font>
<span class="hljs-keyword">import</span> com.alibaba.wireless.security.framework.IRouterComponent;
<span class="hljs-keyword">import</span> com.taobao.wireless.security.adapter.JNICLibrary;<font></font>
 <font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">a</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IRouterComponent</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">a</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">super</span>();<font></font>
    }<font></font>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">doCommand</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg2, Object[] arg3)</span> </span>{
        <span class="hljs-keyword">return</span> JNICLibrary.doCommandNative(arg2, arg3);<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また</font><font style="vertical-align: inherit;">、</font><i><font style="vertical-align: inherit;">doCommandNative</font></i><font style="vertical-align: inherit;">ネイティブメソッドが</font><i><font style="vertical-align: inherit;">宣言さ</font></i><font style="vertical-align: inherit;">れて</font><font style="vertical-align: inherit;">いる</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JNICLibrary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">クラス</font><font style="vertical-align: inherit;">：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">package</span> com.taobao.wireless.security.adapter;<font></font>
 <font></font>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JNICLibrary</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Object <span class="hljs-title">doCommandNative</span><span class="hljs-params">(<span class="hljs-keyword">int</span> arg0, Object[] arg1)</span></span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ネイティブコードで</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doCommandNative</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">メソッドを見つける必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">そして、楽しみが始まります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">マシンコードの難読化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイル</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libsgmain.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（これは実際には.jarであり、暗号化に関連するいくつかのインターフェースの実装のすぐ上にあります）は、ネイティブライブラリ</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libsgmainso-6.4.36.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。 IDAでそれを開き、エラーのあるダイアログボックスの束を取得します。問題は、セクションヘッダーテーブルが無効であることです。これは、特に分析を複雑にするために行われます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_k/bz/5c/_kbz5cbedw6g1jnsj047rtqudli.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、それも必要ではありません。ELFファイルを正しくロードして分析するには、テーブルセグメントのプログラムで十分です。したがって、セクションテーブルを削除し、ヘッダーの対応するフィールドを無効にします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2y/xh/vk/2yxhvksp30f016gfyhrlfh0pklc.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
IDAでファイルを再度開きます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Java仮想マシンにネイティブライブラリのどこにネイティブとしてJavaコードで宣言されたメソッドの実装があるかを正確に伝えるには、2つの方法があります。 1つは、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Java_package_name_ClassName_Method_name</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">という形式の名前を付けること</font><i><font style="vertical-align: inherit;">です</font></i><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2つ目は</font><font style="vertical-align: inherit;">
、</font><i><font style="vertical-align: inherit;">RegisterNatives</font></i><font style="vertical-align: inherit;">関数を呼び出して</font><font style="vertical-align: inherit;">、ライブラリをロードするときに（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JNI_OnLoad</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数で</font><font style="vertical-align: inherit;">）</font><i><font style="vertical-align: inherit;">登録</font></i></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すること</font><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">
この例では、最初の方法を使用する場合、名前は次のようになります：</font><i><font style="vertical-align: inherit;">Java_com_taobao_wireless_security_adapter_JNICLibrary_doCommandNative</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
エクスポートされた関数にはそのようなものはないため、</font><i><font style="vertical-align: inherit;">RegisterNativesの</font></i><font style="vertical-align: inherit;">呼び出しを探す必要があります</font><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">JNI_OnLoad</font></i><font style="vertical-align: inherit;"> 
関数に移動して</font><font style="vertical-align: inherit;">、次の図を確認します。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/m6/dp/iw/m6dpiwaonfuyri-jg8thppcfgqe.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
何が起きてる？一見すると、関数の最初と最後はARMアーキテクチャの典型です。スタックの最初の命令は、関数がその作業で使用するレジスターの内容（この場合はR0、R1、およびR2）と、関数からの戻りアドレスを含むレジスターLRの内容を格納します。最後の命令で、保存されたレジスタが復元され、戻りアドレスがすぐにPCレジスタに配置されます-したがって、関数から戻ります。しかしよく見ると、最後から2番目の命令がスタックに格納されている戻りアドレスを変更していることに気付くでしょう。それが何になるかを計算します</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コード実行。特定のアドレス0xB130がR1にロードされ、そこから5が減算されてから、R0に転送され、それに0x10が追加されます。それは0xB13Bであることがわかります。したがって、IDAは最後の命令で関数からの通常の戻りがあると考えますが、実際には計算されたアドレス0xB13Bへの遷移があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ARMプロセッサには、ARMとThumbの2つのモードと2つの命令セットがあることを思い出してください。アドレスの最下位ビットは、どの命令セットが使用されているかをプロセッサに伝えます。つまり、アドレスは実際には0xB13Aであり、下位ビットの単位はThumbモードを示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このライブラリの各関数の先頭には、同様の「アダプター」と</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ジャンクコードが</font><font style="vertical-align: inherit;">追加され</font><font style="vertical-align: inherit;">てい</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。さらに、それらについて詳しく説明</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
することはしません。ほぼすべての機能の本当の始まりはもう少し先であること</font><font style="vertical-align: inherit;">を覚え</font><font style="vertical-align: inherit;">ている</font><font style="vertical-align: inherit;">だけ</font><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードには0xB13Aへの明示的な遷移がないため、IDA自体はコードがこの場所にあることを認識しませんでした。同じ理由で、ライブラリ内のほとんどのコードがコードとして認識されないため、分析が多少難しくなります。コードがここにあることをIDAに伝えます。これは、次のようになります</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eq/wp/p3/eqwpp3exmqnybi7r_tdvvan4jls.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。テーブルは明らかに0xB144から始まります。そして、sub_494Cはどうですか？</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bo/9b/rn/bo9brnkfvauy3ntm2dnucnsxqhs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この関数がLRレジスタで呼び出されると、上記のテーブルのアドレス（0xB144）を取得します。 R0では、このテーブルのインデックス。つまり、値はテーブルから取得され、LRに追加され、移動</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
先のアドレスが</font><font style="vertical-align: inherit;">取得され</font><font style="vertical-align: inherit;">ます。それを計算してみましょう：0xB144 + [0xB144 + 8 * 4] = 0xB144 + 0x120 = 0xB264。受け取ったアドレスに移動すると、いくつかの有用な指示と0xB140 </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nz/95/4x/nz954xqtjmky6tnpaqeejhvecus.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
への遷移が表示されます。これで、テーブルからのインデックス0x20のオフセットによる遷移が発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テーブルのサイズから判断すると、コードにはそのような遷移が多数あります。手動で住所を計算しなくても、これをより自動的に処理できるかどうかという疑問が生じます。そして、スクリプトとIDAのコードにパッチを適用する機能が役立ちます。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">put_unconditional_branch</span>(<span class="hljs-params">source, destination</span>):</span>
    offset = (destination - source - <span class="hljs-number">4</span>) &gt;&gt; <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> offset &gt; <span class="hljs-number">2097151</span> <span class="hljs-keyword">or</span> offset &lt; <span class="hljs-number">-2097152</span>:
        <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"Invalid offset"</span>)
    <span class="hljs-keyword">if</span> offset &gt; <span class="hljs-number">1023</span> <span class="hljs-keyword">or</span> offset &lt; <span class="hljs-number">-1024</span>:<font></font>
        instruction1 = <span class="hljs-number">0xf000</span> | ((offset &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">0x7ff</span>)<font></font>
        instruction2 = <span class="hljs-number">0xb800</span> | (offset &amp; <span class="hljs-number">0x7ff</span>)<font></font>
        patch_word(source, instruction1)<font></font>
        patch_word(source + <span class="hljs-number">2</span>, instruction2)
    <span class="hljs-keyword">else</span>:<font></font>
        instruction = <span class="hljs-number">0xe000</span> | (offset &amp; <span class="hljs-number">0x7ff</span>)<font></font>
        patch_word(source, instruction)<font></font>
 <font></font>
 <font></font>
ea = here()<font></font>
<span class="hljs-keyword">if</span> get_wide_word(ea) == <span class="hljs-number">0xb503</span>: <span class="hljs-comment">#PUSH {R0,R1,LR}</span>
    ea1 = ea + <span class="hljs-number">2</span>
    <span class="hljs-keyword">if</span> get_wide_word(ea1) == <span class="hljs-number">0xbf00</span>: <span class="hljs-comment">#NOP</span>
        ea1 += <span class="hljs-number">2</span>
    <span class="hljs-keyword">if</span> get_operand_type(ea1, <span class="hljs-number">0</span>) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> get_operand_value(ea1, <span class="hljs-number">0</span>) == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> get_operand_type(ea1, <span class="hljs-number">1</span>) == <span class="hljs-number">2</span>:<font></font>
        index = get_wide_dword(get_operand_value(ea1, <span class="hljs-number">1</span>))
        <span class="hljs-keyword">print</span> <span class="hljs-string">"index ="</span>, hex(index)<font></font>
        ea1 += <span class="hljs-number">2</span>
        <span class="hljs-keyword">if</span> get_operand_type(ea1, <span class="hljs-number">0</span>) == <span class="hljs-number">7</span>:<font></font>
            table = get_operand_value(ea1, <span class="hljs-number">0</span>) + <span class="hljs-number">4</span>
        <span class="hljs-keyword">elif</span> get_operand_type(ea1, <span class="hljs-number">1</span>) == <span class="hljs-number">2</span>:<font></font>
            table = get_operand_value(ea1, <span class="hljs-number">1</span>) + <span class="hljs-number">4</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">print</span> <span class="hljs-string">"Wrong operand type on"</span>, hex(ea1), <span class="hljs-string">"-"</span>, get_operand_type(ea1, <span class="hljs-number">0</span>), get_operand_type(ea1, <span class="hljs-number">1</span>)<font></font>
            table = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> table <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">print</span> <span class="hljs-string">"Unable to find table"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">print</span> <span class="hljs-string">"table ="</span>, hex(table)<font></font>
            offset = get_wide_dword(table + (index &lt;&lt; <span class="hljs-number">2</span>))<font></font>
            put_unconditional_branch(ea, table + offset)<font></font>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">print</span> <span class="hljs-string">"Unknown code"</span>, get_operand_type(ea1, <span class="hljs-number">0</span>), get_operand_value(ea1, <span class="hljs-number">0</span>), get_operand_type(ea1, <span class="hljs-number">1</span>) == <span class="hljs-number">2</span>
<span class="hljs-keyword">else</span>:
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Unable to detect first instruction"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カーソルを行0xB26Aに置き、スクリプトを実行して0xB4B0への遷移を確認します。IDA </font></font><br>
<br>
<img src="https://habrastorage.org/webt/52/rf/fx/52rffxhzmtrfdhfrznsr8dovfim.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
はこのセクションをコードとして認識しませんでした。私たちは彼女を助けて、そこで別の構造を見ます：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ct/d9/kv/ctd9kvewm9l1blmw3pqipi8mnqm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BLXの後の指示はあまり意味がありません、それはある種のバイアスのように見えます。 sub_4964を調べます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o7/wi/4-/o7wi4-imrothkr6qpkbrklj40aw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際には、ここでLRにあるアドレスでdwordが取得され、このアドレスに追加されます。その後、受信したアドレスの値が取得され、スタックにプッシュされます。また、LRに4が追加されるため、関数から戻った後、この同じオフセットにジャンプします。次に、POP {R1}コマンドは受信した値をスタックから取得します。アドレス0xB4BA + 0xEA = 0xB5A4を見ると、アドレステーブルに似たものが表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ev/hb/a8/evhba8ty8dtnv8niuxyfue0nkfk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このデザインにパッチを適用するには、コードから2つのパラメーターを取得する必要があります。オフセットと、結果を入れたいレジスター番号です。</font><font style="vertical-align: inherit;">可能なレジスタごとに、事前にコードを準備する必要があります。</font></font><br>
<br>
<pre><code class="python hljs">patches = {}<font></font>
patches[<span class="hljs-number">0</span>] = (<span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x48</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0xe0</span>)<font></font>
patches[<span class="hljs-number">1</span>] = (<span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0xe0</span>)<font></font>
patches[<span class="hljs-number">2</span>] = (<span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x4a</span>, <span class="hljs-number">0x12</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0xe0</span>)<font></font>
patches[<span class="hljs-number">3</span>] = (<span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x4b</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0xe0</span>)<font></font>
patches[<span class="hljs-number">4</span>] = (<span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x4c</span>, <span class="hljs-number">0x24</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0xe0</span>)<font></font>
patches[<span class="hljs-number">5</span>] = (<span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x4d</span>, <span class="hljs-number">0x2d</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0xe0</span>)<font></font>
patches[<span class="hljs-number">8</span>] = (<span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0xdf</span>, <span class="hljs-number">0xf8</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0xd8</span>, <span class="hljs-number">0xf8</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xe0</span>)<font></font>
patches[<span class="hljs-number">9</span>] = (<span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0xdf</span>, <span class="hljs-number">0xf8</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0xd9</span>, <span class="hljs-number">0xf8</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xe0</span>)<font></font>
patches[<span class="hljs-number">10</span>] = (<span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0xdf</span>, <span class="hljs-number">0xf8</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0xa0</span>, <span class="hljs-number">0xda</span>, <span class="hljs-number">0xf8</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xa0</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xe0</span>)<font></font>
patches[<span class="hljs-number">11</span>] = (<span class="hljs-number">0x00</span>, <span class="hljs-number">0xbf</span>, <span class="hljs-number">0xdf</span>, <span class="hljs-number">0xf8</span>, <span class="hljs-number">0x06</span>, <span class="hljs-number">0xb0</span>, <span class="hljs-number">0xdb</span>, <span class="hljs-number">0xf8</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xb0</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0xe0</span>)<font></font>
 <font></font>
ea = here()<font></font>
<span class="hljs-keyword">if</span> (get_wide_word(ea) == <span class="hljs-number">0xb082</span> <span class="hljs-comment">#SUB SP, SP, #8</span>
        <span class="hljs-keyword">and</span> get_wide_word(ea + <span class="hljs-number">2</span>) == <span class="hljs-number">0xb503</span>): <span class="hljs-comment">#PUSH {R0,R1,LR}</span>
    <span class="hljs-keyword">if</span> get_operand_type(ea + <span class="hljs-number">4</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">7</span>:<font></font>
        pop = get_bytes(ea + <span class="hljs-number">12</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>)
        <span class="hljs-keyword">if</span> pop[<span class="hljs-number">1</span>] == <span class="hljs-string">'\xbc'</span>:<font></font>
            register = <span class="hljs-number">-1</span>
            r = get_wide_byte(ea + <span class="hljs-number">12</span>)
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">8</span>):
                <span class="hljs-keyword">if</span> r == (<span class="hljs-number">1</span> &lt;&lt; i):<font></font>
                    register = i<font></font>
                    <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">if</span> register == <span class="hljs-number">-1</span>:
                <span class="hljs-keyword">print</span> <span class="hljs-string">"Unable to detect register"</span>
            <span class="hljs-keyword">else</span>:<font></font>
                address = get_wide_dword(ea + <span class="hljs-number">8</span>) + ea + <span class="hljs-number">8</span>
                <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> patches[register]:<font></font>
                    patch_byte(ea, b)<font></font>
                    ea += <span class="hljs-number">1</span>
                <span class="hljs-keyword">if</span> ea % <span class="hljs-number">4</span> != <span class="hljs-number">0</span>:<font></font>
                    ea += <span class="hljs-number">2</span><font></font>
                patch_dword(ea, address)<font></font>
        <span class="hljs-keyword">elif</span> pop[:<span class="hljs-number">3</span>] == <span class="hljs-string">'\x5d\xf8\x04'</span>:<font></font>
            register = ord(pop[<span class="hljs-number">3</span>]) &gt;&gt; <span class="hljs-number">4</span>
            <span class="hljs-keyword">if</span> register <span class="hljs-keyword">in</span> patches:<font></font>
                address = get_wide_dword(ea + <span class="hljs-number">8</span>) + ea + <span class="hljs-number">8</span>
                <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> patches[register]:<font></font>
                    patch_byte(ea, b)<font></font>
                    ea += <span class="hljs-number">1</span><font></font>
                patch_dword(ea, address)<font></font>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">print</span> <span class="hljs-string">"POP instruction not found"</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">print</span> <span class="hljs-string">"Wrong operand type on +4:"</span>, get_operand_type(ea + <span class="hljs-number">4</span>, <span class="hljs-number">0</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Unable to detect first instructions"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
置換したい構成要素-0xB4B2-の先頭にカーソルを置き、スクリプトを実行します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/lv/mp/oo/lvmpoow5agndjnbbl-t3imyaisq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
前述の構成に加えて</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dk/nn/rw/dknnrwaye18zzz0xipny0_gdqfq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、次</font><font style="vertical-align: inherit;">のコードもコードに</font><font style="vertical-align: inherit;">表示さ</font><font style="vertical-align: inherit;">れます。</font><font style="vertical-align: inherit;">前のケースと同様に、BLX命令の後に</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fn/bw/uz/fnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
オフセットがあります。LRからアドレスへのオフセットを</font><font style="vertical-align: inherit;">取得</font><font style="vertical-align: inherit;">し、LRに追加します。そしてそこに行きます。</font><font style="vertical-align: inherit;">0x72044 + 0xC = 0x72050。</font><font style="vertical-align: inherit;">このデザインのスクリプトは非常に簡単です。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">put_unconditional_branch</span>(<span class="hljs-params">source, destination</span>):</span>
    offset = (destination - source - <span class="hljs-number">4</span>) &gt;&gt; <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> offset &gt; <span class="hljs-number">2097151</span> <span class="hljs-keyword">or</span> offset &lt; <span class="hljs-number">-2097152</span>:
        <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"Invalid offset"</span>)
    <span class="hljs-keyword">if</span> offset &gt; <span class="hljs-number">1023</span> <span class="hljs-keyword">or</span> offset &lt; <span class="hljs-number">-1024</span>:<font></font>
        instruction1 = <span class="hljs-number">0xf000</span> | ((offset &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">0x7ff</span>)<font></font>
        instruction2 = <span class="hljs-number">0xb800</span> | (offset &amp; <span class="hljs-number">0x7ff</span>)<font></font>
        patch_word(source, instruction1)<font></font>
        patch_word(source + <span class="hljs-number">2</span>, instruction2)
    <span class="hljs-keyword">else</span>:<font></font>
        instruction = <span class="hljs-number">0xe000</span> | (offset &amp; <span class="hljs-number">0x7ff</span>)<font></font>
        patch_word(source, instruction)<font></font>
 <font></font>
 <font></font>
ea = here()<font></font>
<span class="hljs-keyword">if</span> get_wide_word(ea) == <span class="hljs-number">0xb503</span>: <span class="hljs-comment">#PUSH {R0,R1,LR}</span>
    ea1 = ea + <span class="hljs-number">6</span>
    <span class="hljs-keyword">if</span> get_wide_word(ea + <span class="hljs-number">2</span>) == <span class="hljs-number">0xbf00</span>: <span class="hljs-comment">#NOP</span>
        ea1 += <span class="hljs-number">2</span><font></font>
    offset = get_wide_dword(ea1)<font></font>
    put_unconditional_branch(ea, (ea1 + offset) &amp; <span class="hljs-number">0xffffffff</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Unable to detect first instruction"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプトの結果：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tm/fq/yo/tmfqyogtdhbje0atjckosbrgide.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数のすべてにパッチが適用された後、IDAを実際の始まりに向けることができます。</font><font style="vertical-align: inherit;">すべての関数コードをバラバラに収集し、HexRaysを使用して逆コンパイルできます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文字列のデコード</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UCブラウザーから</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libsgmainso-6.4.36.so</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ライブラリーのマシンコードで難読化を処理する方法を学び</font><font style="vertical-align: inherit;">、関数コード</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JNI_OnLoadを取得しました</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> __fastcall <span class="hljs-title">real_JNI_OnLoad</span><span class="hljs-params">(JavaVM *vm)</span>
</span>{
  <span class="hljs-keyword">int</span> result; <span class="hljs-comment">// r0</span>
  jclass clazz; <span class="hljs-comment">// r0 MAPDST</span>
  <span class="hljs-keyword">int</span> v4; <span class="hljs-comment">// r0</span>
  JNIEnv *env; <span class="hljs-comment">// r4</span>
  <span class="hljs-keyword">int</span> v6; <span class="hljs-comment">// [sp-40h] [bp-5Ch]</span>
  <span class="hljs-keyword">int</span> v7; <span class="hljs-comment">// [sp+Ch] [bp-10h]</span><font></font>
  v7 = *(_DWORD *)off_8AC00;<font></font>
  <span class="hljs-keyword">if</span> ( !vm )
    <span class="hljs-keyword">goto</span> LABEL_39;<font></font>
  sub_7C4F4();<font></font>
  env = (JNIEnv *)sub_7C5B0(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">if</span> ( !env )
    <span class="hljs-keyword">goto</span> LABEL_39;<font></font>
  v4 = sub_72CCC();<font></font>
  sub_73634(v4);<font></font>
  sub_73E24(&amp;unk_83EA6, &amp;v6, <span class="hljs-number">49</span>);<font></font>
  clazz = (jclass)((<span class="hljs-keyword">int</span> (__fastcall *)(JNIEnv *, <span class="hljs-keyword">int</span> *))(*env)-&gt;FindClass)(env, &amp;v6);
  <span class="hljs-keyword">if</span> ( clazz<font></font>
    &amp;&amp; (sub_9EE4(),<font></font>
        sub_71D68(env),<font></font>
        sub_E7DC(env) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_69D68(env) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_197B4(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_E240(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_B8B0(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_5F0F4(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_70640(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_11F3C(env) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_21C3C(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_2148C(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_210E0(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_41B58(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_27920(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_293E8(env, clazz) &gt;= <span class="hljs-number">0</span>
     &amp;&amp; sub_208F4(env, clazz) &gt;= <span class="hljs-number">0</span>) )<font></font>
  {<font></font>
    result = (sub_B7B0(env, clazz) &gt;&gt; <span class="hljs-number">31</span>) | <span class="hljs-number">0x10004</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
LABEL_39:<font></font>
    result = <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> result;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の行を注意深く検討してください。</font></font><br>
<br>
<pre><code class="cpp hljs">  sub_73E24(&amp;unk_83EA6, &amp;v6, <span class="hljs-number">49</span>);<font></font>
  clazz = (jclass)((<span class="hljs-keyword">int</span> (__fastcall *)(JNIEnv *, <span class="hljs-keyword">int</span> *))(*env)-&gt;FindClass)(env, &amp;v6);</code></pre><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub_73E24</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
関数</font><font style="vertical-align: inherit;">は、クラス名を明示的に復号化します。</font><font style="vertical-align: inherit;">この関数のパラメーターとして、暗号化に似たデータへのポインター、バッファー、数値が渡されます。</font><font style="vertical-align: inherit;">明らかに、関数が呼び出された後、バッファに</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">復号化された行が</font><i><font style="vertical-align: inherit;">含ま</font></i><font style="vertical-align: inherit;">れ</font><font style="vertical-align: inherit;">ます。これは、</font><i><font style="vertical-align: inherit;">FindClass</font></i><font style="vertical-align: inherit;">関数に渡される</font><i><font style="vertical-align: inherit;">ため</font></i><font style="vertical-align: inherit;">です。このクラスは、クラス名を2番目のパラメータとして受け取ります。</font><font style="vertical-align: inherit;">したがって、数値はバッファのサイズまたは文字列の長さです。</font><font style="vertical-align: inherit;">クラスの名前を解読してみましょう。正しい方向に進んでいるかどうかがわかります。</font><i><font style="vertical-align: inherit;">sub_73E24</font></i><font style="vertical-align: inherit;">で何が起こるかを</font><i><font style="vertical-align: inherit;">詳しく見てみ</font></i><font style="vertical-align: inherit;">ましょう</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> __fastcall <span class="hljs-title">sub_73E56</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> __int8 *in, <span class="hljs-keyword">unsigned</span> __int8 *out, <span class="hljs-keyword">size_t</span> size)</span>
</span>{
  <span class="hljs-keyword">int</span> v4; <span class="hljs-comment">// r6</span>
  <span class="hljs-keyword">int</span> v7; <span class="hljs-comment">// r11</span>
  <span class="hljs-keyword">int</span> v8; <span class="hljs-comment">// r9</span>
  <span class="hljs-keyword">int</span> v9; <span class="hljs-comment">// r4</span>
  <span class="hljs-keyword">size_t</span> v10; <span class="hljs-comment">// r5</span>
  <span class="hljs-keyword">int</span> v11; <span class="hljs-comment">// r0</span>
  struc_1 v13; <span class="hljs-comment">// [sp+0h] [bp-30h]</span>
  <span class="hljs-keyword">int</span> v14; <span class="hljs-comment">// [sp+1Ch] [bp-14h]</span>
  <span class="hljs-keyword">int</span> v15; <span class="hljs-comment">// [sp+20h] [bp-10h]</span>
  v4 = <span class="hljs-number">0</span>;<font></font>
  v15 = *(_DWORD *)off_8AC00;<font></font>
  v14 = <span class="hljs-number">0</span>;<font></font>
  v7 = sub_7AF78(<span class="hljs-number">17</span>);<font></font>
  v8 = sub_7AF78(size);<font></font>
  <span class="hljs-keyword">if</span> ( !v7 )<font></font>
  {<font></font>
    v9 = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">goto</span> LABEL_12;<font></font>
  }<font></font>
  (*(<span class="hljs-keyword">void</span> (__fastcall **)(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *, <span class="hljs-keyword">int</span>))(v7 + <span class="hljs-number">12</span>))(v7, <span class="hljs-string">"DcO/lcK+h?m3c*q@"</span>, <span class="hljs-number">16</span>);
  <span class="hljs-keyword">if</span> ( !v8 )<font></font>
  {<font></font>
LABEL_9:<font></font>
    v4 = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">goto</span> LABEL_10;<font></font>
  }<font></font>
  v4 = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> ( !in )<font></font>
  {<font></font>
LABEL_10:<font></font>
    v9 = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">goto</span> LABEL_11;<font></font>
  }<font></font>
  v9 = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> ( out )<font></font>
  {<font></font>
    <span class="hljs-built_in">memset</span>(out, <span class="hljs-number">0</span>, size);<font></font>
    v10 = size - <span class="hljs-number">1</span>;<font></font>
    (*(<span class="hljs-keyword">void</span> (__fastcall **)(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">unsigned</span> __int8 *, <span class="hljs-keyword">size_t</span>))(v8 + <span class="hljs-number">12</span>))(v8, in, v10);
    <span class="hljs-built_in">memset</span>(&amp;v13, <span class="hljs-number">0</span>, <span class="hljs-number">0x14</span>u);<font></font>
    v13.field_4 = <span class="hljs-number">3</span>;<font></font>
    v13.field_10 = v7;<font></font>
    v13.field_14 = v8;<font></font>
    v11 = sub_6115C(&amp;v13, &amp;v14);<font></font>
    v9 = v11;<font></font>
    <span class="hljs-keyword">if</span> ( v11 )<font></font>
    {<font></font>
      <span class="hljs-keyword">if</span> ( *(_DWORD *)(v11 + <span class="hljs-number">4</span>) == v10 )<font></font>
      {<font></font>
        qmemcpy(out, *(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> **)v11, v10);<font></font>
        v4 = *(_DWORD *)(v9 + <span class="hljs-number">4</span>);<font></font>
      }<font></font>
      <span class="hljs-keyword">else</span><font></font>
      {<font></font>
        v4 = <span class="hljs-number">0</span>;<font></font>
      }<font></font>
      <span class="hljs-keyword">goto</span> LABEL_11;<font></font>
    }<font></font>
    <span class="hljs-keyword">goto</span> LABEL_9;<font></font>
  }<font></font>
LABEL_11:<font></font>
  sub_7B148(v7);<font></font>
LABEL_12:<font></font>
  <span class="hljs-keyword">if</span> ( v8 )<font></font>
    sub_7B148(v8);<font></font>
  <span class="hljs-keyword">if</span> ( v9 )<font></font>
    sub_7B148(v9);<font></font>
  <span class="hljs-keyword">return</span> v4;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub_7AF78</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
関数</font><font style="vertical-align: inherit;">は、指定されたサイズのバイト配列のコンテナーのインスタンスを作成します（これらのコンテナーについては詳しく説明しません）。このような2つのコンテナーがここで作成されます</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。1つには「DcO / lcK + h？M3c * q @」という行</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が配置され</font><font style="vertical-align: inherit;">（これがキーであると容易に推測できます）、もう1つは暗号化されたデータです。さらに、両方のオブジェクトが特定の構造に配置され、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub_6115C</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数に渡されます</font><font style="vertical-align: inherit;">。また、この構造体の値が3のフィールドにも注目しています。この構造体で次に何が起こるか見てみましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> __fastcall <span class="hljs-title">sub_611B4</span><span class="hljs-params">(struc_1 *a1, _DWORD *a2)</span>
</span>{
  <span class="hljs-keyword">int</span> v3; <span class="hljs-comment">// lr</span>
  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v4; <span class="hljs-comment">// r1</span>
  <span class="hljs-keyword">int</span> v5; <span class="hljs-comment">// r0</span>
  <span class="hljs-keyword">int</span> v6; <span class="hljs-comment">// r1</span>
  <span class="hljs-keyword">int</span> result; <span class="hljs-comment">// r0</span>
  <span class="hljs-keyword">int</span> v8; <span class="hljs-comment">// r0</span>
  *a2 = <span class="hljs-number">820000</span>;
  <span class="hljs-keyword">if</span> ( a1 )<font></font>
  {<font></font>
    v3 = a1-&gt;field_14;<font></font>
    <span class="hljs-keyword">if</span> ( v3 )<font></font>
    {<font></font>
      v4 = a1-&gt;field_4;<font></font>
      <span class="hljs-keyword">if</span> ( v4 &lt; <span class="hljs-number">0x19</span> )<font></font>
      {<font></font>
        <span class="hljs-keyword">switch</span> ( v4 )<font></font>
        {<font></font>
          <span class="hljs-keyword">case</span> <span class="hljs-number">0u</span>:<font></font>
            v8 = sub_6419C(a1-&gt;field_0, a1-&gt;field_10, v3);<font></font>
            <span class="hljs-keyword">goto</span> LABEL_17;
          <span class="hljs-keyword">case</span> <span class="hljs-number">3u</span>:<font></font>
            v8 = sub_6364C(a1-&gt;field_0, a1-&gt;field_10, v3);<font></font>
            <span class="hljs-keyword">goto</span> LABEL_17;
          <span class="hljs-keyword">case</span> <span class="hljs-number">0x10</span>u:
          <span class="hljs-keyword">case</span> <span class="hljs-number">0x11</span>u:
          <span class="hljs-keyword">case</span> <span class="hljs-number">0x12</span>u:<font></font>
            v8 = sub_612F4(<font></font>
                   a1-&gt;field_0,<font></font>
                   v4,<font></font>
                   *(_QWORD *)&amp;a1-&gt;field_8,<font></font>
                   *(_QWORD *)&amp;a1-&gt;field_8 &gt;&gt; <span class="hljs-number">32</span>,<font></font>
                   a1-&gt;field_10,<font></font>
                   v3,<font></font>
                   a2);<font></font>
            <span class="hljs-keyword">goto</span> LABEL_17;
          <span class="hljs-keyword">case</span> <span class="hljs-number">0x14</span>u:<font></font>
            v8 = sub_63A28(a1-&gt;field_0, v3);<font></font>
            <span class="hljs-keyword">goto</span> LABEL_17;
          <span class="hljs-keyword">case</span> <span class="hljs-number">0x15</span>u:<font></font>
            sub_61A60(a1-&gt;field_0, v3, a2);<font></font>
            <span class="hljs-keyword">return</span> result;
          <span class="hljs-keyword">case</span> <span class="hljs-number">0x16</span>u:<font></font>
            v8 = sub_62440(a1-&gt;field_14);<font></font>
            <span class="hljs-keyword">goto</span> LABEL_17;
          <span class="hljs-keyword">case</span> <span class="hljs-number">0x17</span>u:<font></font>
            v8 = sub_6226C(a1-&gt;field_10, v3);<font></font>
            <span class="hljs-keyword">goto</span> LABEL_17;
          <span class="hljs-keyword">case</span> <span class="hljs-number">0x18</span>u:<font></font>
            v8 = sub_63530(a1-&gt;field_14);<font></font>
LABEL_17:<font></font>
            v6 = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">if</span> ( v8 )<font></font>
            {<font></font>
              *a2 = <span class="hljs-number">0</span>;<font></font>
              v6 = v8;<font></font>
            }<font></font>
            <span class="hljs-keyword">return</span> v6;
          <span class="hljs-keyword">default</span>:<font></font>
            LOWORD(v5) = <span class="hljs-number">28032</span>;
            <span class="hljs-keyword">goto</span> LABEL_5;<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
  LOWORD(v5) = <span class="hljs-number">-27504</span>;<font></font>
LABEL_5:<font></font>
  HIWORD(v5) = <span class="hljs-number">13</span>;<font></font>
  v6 = <span class="hljs-number">0</span>;<font></font>
  *a2 = v5;<font></font>
  <span class="hljs-keyword">return</span> v6;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スイッチパラメータとして、以前に値3が割り当てられた構造体フィールドが渡されます。ケース3を見てみましょう。</font><font style="vertical-align: inherit;">前の関数でそこに追加された構造体のパラメータ、つまり、キーと暗号化されたデータが</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub_6364C</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数に</font><font style="vertical-align: inherit;">転送さ</font><font style="vertical-align: inherit;">れます</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub_6364C</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">をよく見ると</font><font style="vertical-align: inherit;">、RC4アルゴリズムが含まれていることがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アルゴリズムとキーがあります。</font><font style="vertical-align: inherit;">クラス名を解読してみましょう。</font><font style="vertical-align: inherit;">これが起こったことです：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com / taobao / wireless / security / adapter / JNICLibrary</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">いいね！</font><font style="vertical-align: inherit;">私たちは正しい軌道に乗っています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">チームツリー</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に</font><font style="vertical-align: inherit;">、</font><i><font style="vertical-align: inherit;">doCommandNative</font></i><font style="vertical-align: inherit;">関数をポイントする</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RegisterNatives</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼び出しを見つける必要があり</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">JNI_OnLoad</font></i><font style="vertical-align: inherit;">から呼び出された関数を</font><i><font style="vertical-align: inherit;">調べ、</font></i><font style="vertical-align: inherit;">それを</font><i><font style="vertical-align: inherit;">sub_B7B0で</font></i><font style="vertical-align: inherit;">見つけます</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> __fastcall <span class="hljs-title">sub_B7F6</span><span class="hljs-params">(JNIEnv *env, jclass clazz)</span>
</span>{
  <span class="hljs-keyword">char</span> signature[<span class="hljs-number">41</span>]; <span class="hljs-comment">// [sp+7h] [bp-55h]</span>
  <span class="hljs-keyword">char</span> name[<span class="hljs-number">16</span>]; <span class="hljs-comment">// [sp+30h] [bp-2Ch]</span>
  JNINativeMethod method; <span class="hljs-comment">// [sp+40h] [bp-1Ch]</span>
  <span class="hljs-keyword">int</span> v8; <span class="hljs-comment">// [sp+4Ch] [bp-10h]</span><font></font>
 <font></font>
  v8 = *(_DWORD *)off_8AC00;<font></font>
  decryptString((<span class="hljs-keyword">unsigned</span> __int8 *)&amp;unk_83ED9, (<span class="hljs-keyword">unsigned</span> __int8 *)name, <span class="hljs-number">0x10</span>u);<span class="hljs-comment">// doCommandNative</span>
  decryptString((<span class="hljs-keyword">unsigned</span> __int8 *)&amp;unk_83EEA, (<span class="hljs-keyword">unsigned</span> __int8 *)signature, <span class="hljs-number">0x29</span>u);<span class="hljs-comment">// (I[Ljava/lang/Object;)Ljava/lang/Object;</span><font></font>
  method.name = name;<font></font>
  method.signature = signature;<font></font>
  method.fnPtr = sub_B69C;<font></font>
  <span class="hljs-keyword">return</span> ((<span class="hljs-keyword">int</span> (__fastcall *)(JNIEnv *, jclass, JNINativeMethod *, <span class="hljs-keyword">int</span>))(*env)-&gt;RegisterNatives)(env, clazz, &amp;method, <span class="hljs-number">1</span>) &gt;&gt; <span class="hljs-number">31</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doCommandNative</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">というネイティブメソッド</font><i><font style="vertical-align: inherit;">が</font></i><font style="vertical-align: inherit;">ここに登録されています</font><font style="vertical-align: inherit;">。今私たちは彼の住所を知っています。彼が何をしているのか見てみましょう。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> __fastcall <span class="hljs-title">doCommandNative</span><span class="hljs-params">(JNIEnv *env, jobject obj, <span class="hljs-keyword">int</span> command, jarray args)</span>
</span>{
  <span class="hljs-keyword">int</span> v5; <span class="hljs-comment">// r5</span>
  struc_2 *a5; <span class="hljs-comment">// r6</span>
  <span class="hljs-keyword">int</span> v9; <span class="hljs-comment">// r1</span>
  <span class="hljs-keyword">int</span> v11; <span class="hljs-comment">// [sp+Ch] [bp-14h]</span>
  <span class="hljs-keyword">int</span> v12; <span class="hljs-comment">// [sp+10h] [bp-10h]</span>
  v5 = <span class="hljs-number">0</span>;<font></font>
  v12 = *(_DWORD *)off_8AC00;<font></font>
  v11 = <span class="hljs-number">0</span>;<font></font>
  a5 = (struc_2 *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x14</span>u);
  <span class="hljs-keyword">if</span> ( a5 )<font></font>
  {<font></font>
    a5-&gt;field_0 = <span class="hljs-number">0</span>;<font></font>
    a5-&gt;field_4 = <span class="hljs-number">0</span>;<font></font>
    a5-&gt;field_8 = <span class="hljs-number">0</span>;<font></font>
    a5-&gt;field_C = <span class="hljs-number">0</span>;<font></font>
    v9 = command % <span class="hljs-number">10000</span> / <span class="hljs-number">100</span>;<font></font>
    a5-&gt;field_0 = command / <span class="hljs-number">10000</span>;<font></font>
    a5-&gt;field_4 = v9;<font></font>
    a5-&gt;field_8 = command % <span class="hljs-number">100</span>;<font></font>
    a5-&gt;field_C = env;<font></font>
    a5-&gt;field_10 = args;<font></font>
    v5 = sub_9D60(command / <span class="hljs-number">10000</span>, v9, command % <span class="hljs-number">100</span>, <span class="hljs-number">1</span>, (<span class="hljs-keyword">int</span>)a5, &amp;v11);<font></font>
  }<font></font>
  <span class="hljs-built_in">free</span>(a5);
  <span class="hljs-keyword">if</span> ( !v5 &amp;&amp; v11 )<font></font>
    sub_7CF34(env, v11, &amp;byte_83ED7);<font></font>
  <span class="hljs-keyword">return</span> v5;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
名前から、開発者がネイティブライブラリに転送することを決定したすべての関数のエントリポイントがあると推測できます。番号10601の関数に注目し</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。コードによれば、コマンド番号から3つの番号が取得されていることがわかります：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command / 10000</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command％</font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">10000/ </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font><i><font style="vertical-align: inherit;">command％10</font></i><font style="vertical-align: inherit;">、つまりこの場合は</font><i><font style="vertical-align: inherit;">1、6、1</font></i><font style="vertical-align: inherit;">。 3つの数値、</font><font style="vertical-align: inherit;">および</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JNIEnv</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">へのポインターと</font><font style="vertical-align: inherit;">関数に渡された引数が構造体に追加されて渡されます。得られた3つの数値（N1、N2、N3と表記）を使用して、チームツリーが構築されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次のようなもの：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xg/jk/l1/xgjkl1uhzmibo-nhmha3kpivf5a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ツリーは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JNI_OnLoadで</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">動的に入力され</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ツリー内のパスをエンコードする3つの数値。</font><font style="vertical-align: inherit;">ツリーの各リーフには、対応する関数のつぶされたアドレスが含まれています。</font><font style="vertical-align: inherit;">キーは親ノードにあります。</font><font style="vertical-align: inherit;">必要な関数がツリーに追加されているコード内の場所を見つけることは、使用されているすべての構造を見れば難しくありません（すでにかなり大きな記事を膨らませないように、それらの説明は行いません）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">より難読化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トラフィックを復号化する関数のアドレスを取得しました：0x5F1AC。しかし、喜ぶには早すぎます。UCBrowserの開発者たちは、私たちに別の驚きを用意しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Javaコードで生成された配列からパラメーターを受け取った後</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、アドレス0x4D070の関数に入ります。そして、ここでは別のタイプのコード難読化を待っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
R7とR4に2つのインデックスを配置します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/7i/fx/86/7ifx86mr4yph41jsxukpjqvxmfa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のインデックスをR11に転送し</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fa/62/6j/fa626jaylcaaewtslff_-byaseo.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。テーブルからアドレスを取得するには、インデックスを使用します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/co/rk/s1/corks1o2dp75elfvdsxjimrohuo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のアドレスに移動した後、R4にある2番目のインデックスを使用します。テーブルには230の項目があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
どうする？これがスイッチであることをIDAに伝えることができます。編集-&gt;その他-&gt;スイッチイディオムを指定します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/36/uu/xn/36uuxnabf3xesptr8qisxzzfutk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果のコードは怖いです。しかし、そのジャングルを通り抜けると、すでに知っている関数の呼び出しに気付くでしょう。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub_6115C</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-d/pt/3a/-dpt3akb_yckinmdheczkktzlem.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ケース3でRC4アルゴリズムを使用した復号化が行われるスイッチがありました。この場合、関数に渡される構造は、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">doCommandNativeに</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">渡されるパラメーターから入力されます</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">そこ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に値16の</font><i><font style="vertical-align: inherit;">magicIntがあった</font></i><font style="vertical-align: inherit;">ことを思い出し</font><font style="vertical-align: inherit;">ます。対応するケースを確認します-そしていくつかの遷移の後に、アルゴリズムを特定できるコードを見つけます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/rn/_1/i4/rn_1i4avl8oki83hslk5u19ygoe.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはAESです！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アルゴリズムがあり、パラメータ、モード、キー、および場合によっては初期化ベクトルを取得します（その存在はAESアルゴリズムの動作モードに依存します）。それらの構造は、</font><i><font style="vertical-align: inherit;">sub_6115C</font></i><font style="vertical-align: inherit;">関数</font><i><font style="vertical-align: inherit;">呼び出しの</font></i><font style="vertical-align: inherit;">前のどこかに形成する必要があり</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ただしコードのこの部分は特によく難読化されているため、暗号化関数のすべてのパラメーターがファイルにダンプされるようにコードにパッチを適用することが考えられます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パッチ</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アセンブリ言語ですべてのパッチコードを手動で記述しないようにするには、Android Studioを実行し、そこで復号化関数と同じパラメーターを受け取る関数を記述してファイルに書き込み、コンパイラーが生成するコードをコピーして貼り付けます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UCブラウザチームの友人も、コードを追加することの便利さに「気を配りました」。各関数の最初に、他のコードと簡単に置き換えることができるジャンクコードがあることを思い出します。非常に便利:)確かに、目的関数の先頭には、すべてのパラメーターをファイルに保存するコードのための十分なスペースがありません。それをパーツに分けて、隣の関数のガベージブロックを使わなければなりませんでした。合計4つのパーツ。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の部分：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hy/lk/qr/hylkqrhqgyei6qjdj6ayvgivpqu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ARMアーキテクチャでは、関数の最初の4つのパラメータはレジスタR0〜R3を介して渡され、残りは（もしあれば）スタックを介して渡されます。レジスタLRでは、戻りアドレスが送信されます。パラメータをダンプした後に関数が機能するように、これらすべてを保存する必要があります。また、プロセスで使用するすべてのレジスタを保存する必要があるため、PUSH.W {R0-R10、LR}を実行します。 R7では、スタックを介して関数に渡されるパラメーターのリストのアドレスを取得します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fopen</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用して</font><font style="vertical-align: inherit;">、ファイル</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/データ/ローカル/ tmp / aes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を「ab」モードで</font><font style="vertical-align: inherit;">開き</font><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
つまり、追加します。 R0でファイル名のアドレスをロードし、R1でモードを示す行のアドレスをロードします。そして、ここでガベージコードが終了するので、次の関数に進みます。それが機能し続けるために、最初にガベージをバイパスする実際の関数コードへの移行を置き、ガベージの代わりにパッチの継続を追加します。</font><i><font style="vertical-align: inherit;">fopen</font></i></font><br>
<br>
<img src="https://habrastorage.org/webt/68/ss/kf/68sskfcymjorl_flpf8mg9wwej4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
と</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼びます</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">aes</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
関数の最初の3つのパラメーターは</font><i><font style="vertical-align: inherit;">int</font></i><font style="vertical-align: inherit;">型</font><font style="vertical-align: inherit;">です。最初にレジスタをスタックに保存したので、スタックの</font><font style="vertical-align: inherit;">アドレスを</font><i><font style="vertical-align: inherit;">関数fwriteに</font></i><font style="vertical-align: inherit;">渡すだけで済みます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">
次に、データのサイズと、キーのデータへのポインタ、初期化ベクトル、および暗号化されたデータを含む3つの構造があります。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/d1/yt/iz/d1ytiz_jx7byflntqxxec2nece0.jpeg"><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/webt/me/vy/kz/mevykztpkcwdr6xkpnenauxqccs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、ファイルを閉じ、レジスタを復元し、制御を実際の</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数に</font><i><font style="vertical-align: inherit;">渡し</font></i><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
パッチが適用されたライブラリを含むAPKを収集し、署名し、デバイス/エミュレーターにドロップし、起動します。ダンプが作成され、そこに多くのデータが書き込まれていることがわかります。ブラウザはトラフィックだけでなく暗号化も使用し、すべての暗号化は問題の関数を通過します。そして、何らかの理由で必要なデータがなく、必要なリクエストがトラフィックに表示されません。 UCブラウザーが必要な要求を行うまで待機しないようにするには、先に受信したサーバーからの暗号化された応答を受け取り、アプリケーションに再度パッチを適用します。メインのアクティビティonCreateに復号化を追加します。</font></font><br>
<br>
<pre><code class="plaintext hljs">    const/16 v1, 0x62<font></font>
    new-array v1, v1, [B<font></font>
    fill-array-data v1, :encrypted_data<font></font>
    const/16 v0, 0x1f<font></font>
    invoke-static {v0, v1}, Lcom/uc/browser/core/d/c/g;-&gt;j(I[B)[B<font></font>
    move-result-object v1<font></font>
    array-length v2, v1<font></font>
    invoke-static {v2}, Ljava/lang/String;-&gt;valueOf(I)Ljava/lang/String;<font></font>
    move-result-object v2<font></font>
    const-string v0, "ololo"<font></font>
    invoke-static {v0, v2}, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
収集、署名、インストール、起動。</font><font style="vertical-align: inherit;">メソッドがnullを返したため、NullPointerExceptionが発生します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードをさらに分析する過程で、「META-INF /」および「.RSA」という興味深い行がデコードされる関数が発見されました。</font><font style="vertical-align: inherit;">アプリケーションが証明書を確認しているようです。</font><font style="vertical-align: inherit;">または、そこからキーを生成することもできます。</font><font style="vertical-align: inherit;">証明書で何が起こっているのか本当に理解したくないので、正しい証明書を記入してください。</font><font style="vertical-align: inherit;">「META-INF /」の代わりに「BLABLINF /」となるように暗号化された行にパッチを当てて、APKにその名前のフォルダーを作成し、そこにプロテインブラウザーの証明書をドロップします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
収集、署名、インストール、起動。</font><font style="vertical-align: inherit;">ビンゴ！</font><font style="vertical-align: inherit;">キーは私たちのものです！</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mitm</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
キーとキーに等しい初期化ベクトルを取得しました。 CBCモードでサーバーの応答を復号化してみましょう。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/9k/m7/un/9km7unymy_ybx1lwnflfbqd36ke.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MD5に似たアーカイブURL「extract_unzipsize」と番号が表示されます。チェック：MD5アーカイブが同じで、解凍されたライブラリのサイズが同じです。このライブラリにパッチを当ててブラウザに提供しようとしています。パッチを当てたライブラリが読み込まれたことを示すために、Intentを実行して、テキスト「PWNED！」を含むSMSを作成します。サーバーからの2つの応答を置き換えます：</font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtml</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と、アーカイブのダウンロード用です。最初に、MD5を置き換えます（解凍後、サイズは変更されません）。2番目に、パッチを適用したライブラリを含むアーカイブを提供します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ブラウザはアーカイブを数回ダウンロードしようとし、その後エラーを出します。どうやら何か</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼は好きじゃない。</font><font style="vertical-align: inherit;">この泥だらけのフォーマットを分析した結果、サーバーはアーカイブのサイズを引き続き転送する</font></font><br>
<br>
<img src="https://habrastorage.org/webt/e2/-v/ua/e2-vuahng86h0bt0vm84f3xhqrg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ことがわかりました。これはLEB128でエンコードされています。</font><font style="vertical-align: inherit;">パッチの適用後、ライブラリを含むアーカイブのサイズが少し変更されたため、ブラウザはアーカイブのダウンロードが不正であると判断し、数回試行した後、エラーが発生しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
アーカイブのサイズを修正します...そして-勝利！</font><font style="vertical-align: inherit;">:)ビデオの結果。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.youtube.com/watch?v=Nfns7uH03J8</font></font></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発者の結果と対応</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まったく同じ方法で、ハッカーは安全でないUCブラウザ機能を使用して悪意のあるライブラリを配布および実行する可能性があります。これらのライブラリはブラウザのコンテキストで機能するため、すべてのシステム権限を受け取ります。その結果、フィッシングウィンドウを表示したり、データベースに保存されているログイン、パスワード、Cookieを含むオレンジ色の中国のリス作業ファイルにアクセスしたりできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはUCブラウザーの開発者に連絡し、見つかった問題を通知し、脆弱性とその危険性を指摘しようとしましたが、彼らは私たちと何も話し合いませんでした。その間、ブラウザは危険な機能を明白に見せ続けました。しかし、脆弱性の詳細を明らかにするとすぐに、以前のようにこれを無視することができなくなりました。 3月27日は</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
UCブラウザ12.10.9.1193の新しいバージョンがリリースされ、HTTPSを介してサーバーにアクセスしました：</font></font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtml</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、「修正」の後、作成するまで、ブラウザーでPDFを開こうとすると、「エラーが発生しました。問題が発生しました！」というエラーメッセージが表示されました。</font><font style="vertical-align: inherit;">PDFを開こうとしたときのサーバーへの要求は実行されませんでしたが、ブラウザーの起動時に要求が実行されました。これは、Google Playのルールに違反して実行可能コードをダウンロードする継続的な機能を示唆しています。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja451926/index.html">130ストリーム後のライブコードについて</a></li>
<li><a href="../ja451928/index.html">AMPページでウェブ解析を設定する方法</a></li>
<li><a href="../ja451930/index.html">階段の照明の自動化</a></li>
<li><a href="../ja451932/index.html">PHDays 9：安全開発セクションへようこそ</a></li>
<li><a href="../ja451934/index.html">アレクサンダーラムデン：「鉄のどの部分にも特徴がある」</a></li>
<li><a href="../ja451938/index.html">Go Bitmap Indexes：Wild Search</a></li>
<li><a href="../ja451942/index.html">アフリカの無毛症が何千人もの命を救う方法</a></li>
<li><a href="../ja451944/index.html">2019：DEXの年（分散型取引所）</a></li>
<li><a href="../ja451948/index.html">3つのカートリッジのストーリー</a></li>
<li><a href="../ja451950/index.html">仮想発電所。「グリーン」エネルギー源を管理することは可能ですか？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>