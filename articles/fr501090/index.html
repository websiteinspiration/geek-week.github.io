<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😨 📰 🤔 K8S Multicluster Journey 🚯 👩‍💼 🥤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 
 
 Nous représentons l'équipe de la plateforme Exness. Plus tôt, nos collègues ont déjà écrit un article sur les images prêtes pour la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>K8S Multicluster Journey</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/exness/blog/501090/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous représentons l'équipe de la plateforme Exness. </font><font style="vertical-align: inherit;">Plus tôt, nos collègues ont déjà écrit un article sur les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">images prêtes pour la production pour les k8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Aujourd'hui, nous voulons partager l'expérience de la migration de services dans Kubernetes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_w/_v/4y/_w_v4y4cimb9xplp-da3e-cnwx4.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, nous vous proposons quelques chiffres pour une meilleure compréhension de ce qui sera discuté:</font></font><br>
<br>
<ul>
<li>    100+ ,    10      QA, DevOps  Scrum.   — Python, PHP, C++, Java  Golang.&nbsp;<br>
</li>
<li>    —  2000   .     Rancher v1.6      VMware.&nbsp;<br>
</li>
</ul><br>
<h4></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme on dit, rien ne dure éternellement, et Rancher a annoncé assez longtemps la fin du support de la version 1.6. </font><font style="vertical-align: inherit;">Oui, depuis plus de trois ans, nous avons appris à cuisiner et à résoudre les problèmes qui se posent, mais nous sommes de plus en plus souvent confrontés à des problèmes qui ne seront jamais résolus. </font><font style="vertical-align: inherit;">Rancher 1.6 dispose également d'un système ossifié de délivrance de droits, dans lequel vous pouvez faire presque tout ou rien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Propre virtualisation, même si elle a permis un meilleur contrôle du stockage et de la sécurité des données, mais a imposé des coûts opérationnels, difficiles à supporter avec la croissance constante de l'entreprise, le nombre de projets et les exigences pour eux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voulions suivre les normes IaC et, si nécessaire, obtenir le courant rapidement, dans n'importe quel emplacement géographique et sans verrou de fournisseur, et pouvoir également les abandonner rapidement.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premiers pas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous voulions nous appuyer sur des technologies et des solutions modernes qui permettraient aux équipes d'avoir un cycle de développement plus rapide et de minimiser les coûts d'exploitation pour l'interaction avec une plateforme qui fournit de l'énergie.&nbsp; </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, la première chose qui nous est venue à l'esprit était Kubernetes, mais nous ne nous sommes pas excités et avons fait quelques recherches sur le sujet du bon choix. Nous n'avons évalué que des solutions open source et Kubernetes a été battu sans condition dans une bataille déloyale.&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vient ensuite la question du choix d'un outil de création de clusters. Nous avons comparé les solutions les plus populaires: kops, kubespray, kubeadm. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, le kubeadm nous semblait plutôt trop compliqué, plutôt une sorte d'inventeur du "vélo", et le kops manquait de souplesse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le gagnant est sorti:</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/35e/1e6/e85/35e1e6e85e12e982649fd020862463cd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons commencé à expérimenter sur notre propre virtualisation et AWS, essayant de recréer une ressemblance approximative de notre modèle de gestion des ressources précédent, où tout le monde utilise le même «cluster». </font><font style="vertical-align: inherit;">Et maintenant, nous avons le premier cluster de 10 petites machines virtuelles, dont deux sont dans AWS. </font><font style="vertical-align: inherit;">Nous avons commencé à essayer de faire migrer les équipes là-bas, tout semblait être «bien», et l'histoire pourrait être terminée, mais ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premiers problèmes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ansible est ce sur quoi kubespray est construit, ce n'est pas l'outil qui permet de suivre l'IaC: quelque chose s'est mal passé lors de l'entrée / sortie des nœuds, et une intervention a été nécessaire, et lors de l'utilisation de différents OS, le playbook s'est comporté en différentes manières. Avec le nombre croissant de commandes et de nœuds dans le cluster, nous avons commencé à remarquer que le playbook prenait de plus en plus de temps, au final, notre record était de 3,5 heures, et le vôtre? :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et il semble que kubespray soit simplement Ansible, et tout est clair à première vue, mais: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/11e/593/7d7/11e5937d7576851ad38e8469502e6d7f.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au début du voyage, il y avait une tâche pour exécuter les capacités uniquement dans AWS et la virtualisation, mais comme cela arrive souvent, les exigences ont changé.</font></font><br>
&nbsp;<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e4f/b1b/f10/e4fb1bf10754dc4ea192c0a05d2e524c.png"><img src="https://habrastorage.org/getpro/habr/post_images/e1d/eeb/7d5/e1deeb7d5c4b2392962fbe5b6a528388.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la lumière de cela, il est devenu clair que notre ancien modèle de combinaison des ressources dans un système d'orchestration n'était pas approprié - dans le cas où les clusters sont très éloignés et sont gérés par différents fournisseurs.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En outre. Lorsque toutes les équipes travaillent au sein du même cluster, divers services avec NodeSelector installé de manière incorrecte peuvent voler vers l'hôte «étranger» d'une autre équipe et y utiliser des ressources, et dans le cas de la mise en attente, il y avait des appels constants que tel ou tel service ne fonctionnait pas, non distribué correctement en raison du facteur humain. Un autre problème était le calcul du coût, compte tenu notamment des problèmes de répartition des services par nœuds.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre histoire a été la question des droits des employés: chaque équipe voulait être «à la tête» du cluster et le gérer pleinement, ce qui pourrait provoquer un effondrement complet, car les équipes sont fondamentalement indépendantes les unes des autres.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment être</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compte tenu de ce qui précède et du souhait des équipes d'être plus indépendantes, nous avons tiré une conclusion simple: une équipe - un cluster.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous en avons donc un deuxième: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/5ca/125/895/5ca125895d8571f18c41034f226c65d5.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis un troisième cluster:&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/81b/7a9/f75/81b7a9f755d7be0798ec641ef8d444ae.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puis nous avons commencé à penser: disons, dans un an nos équipes auront plus d'un cluster? Dans différentes zones géographiques, par exemple, ou sous le contrôle de différents prestataires? Et certains d'entre eux voudront pouvoir déployer rapidement un cluster temporaire pour tous les tests.&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/265/52e/0a5/26552e0a5bb71a6f82b3dd4f3226b768.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Serait plein Kubernetes! Il s'agit d'une sorte de MultiKubernetes, il s'avère.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le même temps, nous devrons tous prendre en charge tous ces clusters, pouvoir en contrôler facilement l'accès, en créer de nouveaux et retirer les anciens sans intervention manuelle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depuis le début de notre voyage dans le monde de Kubernetes, un certain temps s'est écoulé et nous avons décidé de réexaminer les solutions disponibles. Il s'est avéré qu'il existe déjà sur le marché - Rancher 2.2. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/9a2/c00/e81/9a2c00e81c4d2a0daf2b6f0a7afe8c0a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la première étape de nos recherches, Rancher Labs a déjà fait la première version de la version 2, mais bien qu'elle puisse être augmentée très rapidement en exécutant le conteneur sans dépendances externes avec quelques paramètres ou en utilisant le graphique HELM officiel, cela nous a semblé grossier et nous ne savions pas si compter sur cette décision, qu'elle soit développée ou rapidement abandonnée. Le paradigme cluster = clics lui-même dans l'interface utilisateur ne nous convenait pas non plus, et nous ne voulions pas nous attacher à RKE, car il s'agit d'un outil assez étroit d'esprit.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La version Rancher 2.2 avait déjà un aspect plus efficace et, avec les précédentes, avait un tas de fonctionnalités intéressantes, telles que l'intégration avec de nombreux fournisseurs externes, un point de distribution unique des droits et des fichiers kubeconfig, le lancement d'une image kubectl avec vos droits dans l'interface utilisateur, des espaces de noms imbriqués, alias projets.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une communauté s'est déjà formée autour de Rancher 2, et le fournisseur HashiCorp Terraform a été créé pour le gérer, ce qui nous a aidés à tout assembler.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-il arrivé</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En conséquence, nous avons obtenu un petit cluster dans lequel Rancher est lancé, accessible à tous les autres clusters, ainsi qu'à de nombreux clusters qui lui sont associés, l'accès à chacun d'entre eux pouvant être émis aussi simplement que l'ajout d'un utilisateur au répertoire ldap, quel que soit l'endroit où il se trouve est localisé et les ressources dont le fournisseur utilise.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant gitlab-ci et Terraform, un système a été créé qui vous permet de créer un cluster de n'importe quelle configuration dans les fournisseurs de cloud ou notre propre infrastructure et de les connecter à Rancher. Tout cela se fait dans le style IaC, où chaque cluster est décrit par un référentiel et son état est versionné. Dans ce cas, la plupart des modules sont connectés à partir de référentiels externes de sorte qu'il ne reste plus qu'à transférer des variables ou à décrire leur configuration personnalisée pour les instances, ce qui contribue à réduire le pourcentage de répétabilité du code. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/eae/814/877/eae814877be3c3a957b6f75a2c657f58.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien sûr, notre voyage est loin d'être terminé et il reste encore de nombreuses tâches intéressantes à accomplir, comme un point de travail unique avec les journaux et les métriques de tous les clusters, le maillage de service, les gitops pour gérer les charges dans un multicluster, et bien plus encore. Nous espérons que vous serez intéressé par notre expérience!&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'article a été écrit par A. Antipov, A. Ganush, Platform Engineers.&nbsp;</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr500312/index.html">Écrire une application de prise de notes JavaScript</a></li>
<li><a href="../fr500314/index.html">PHP Digest n ° 179 (21 avril - 4 mai 2020)</a></li>
<li><a href="../fr500316/index.html">Nouvelle version d'Apple et de Google Contact Tracing Protocol</a></li>
<li><a href="../fr500318/index.html">HP Elite Dragonfly - quel type d'ordinateur portable Athena êtes-vous?</a></li>
<li><a href="../fr500320/index.html">Propres moteurs de jeu: un peu de recherche</a></li>
<li><a href="../fr501092/index.html">À propos de la recherche de juin prometteur et "udalenka". Expérience du responsable du support technique de Redmadrobot</a></li>
<li><a href="../fr501098/index.html">Solutions de batteries intelligentes SmartLi pour onduleurs modulaires</a></li>
<li><a href="../fr501106/index.html">Le simulateur de mots anglais le plus simple utilisant Python et Balabolka</a></li>
<li><a href="../fr501108/index.html">Historique du multiprocesseur Nvidia Streaming</a></li>
<li><a href="../fr501110/index.html">Mobius et WWDC: plus de plaisir ensemble</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>