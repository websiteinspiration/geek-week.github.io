<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üò® üì∞ ü§î K8S Multicluster Journey üöØ üë©‚Äçüíº ü•§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 
 
 Nous repr√©sentons l'√©quipe de la plateforme Exness. Plus t√¥t, nos coll√®gues ont d√©j√† √©crit un article sur les images pr√™tes pour la...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>K8S Multicluster Journey</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/exness/blog/501090/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous repr√©sentons l'√©quipe de la plateforme Exness. </font><font style="vertical-align: inherit;">Plus t√¥t, nos coll√®gues ont d√©j√† √©crit un article sur les </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">images pr√™tes pour la production pour les k8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Aujourd'hui, nous voulons partager l'exp√©rience de la migration de services dans Kubernetes.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_w/_v/4y/_w_v4y4cimb9xplp-da3e-cnwx4.png"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, nous vous proposons quelques chiffres pour une meilleure compr√©hension de ce qui sera discut√©:</font></font><br>
<br>
<ul>
<li>    100+ ,    10      QA, DevOps  Scrum.   ‚Äî Python, PHP, C++, Java  Golang.&nbsp;<br>
</li>
<li>    ‚Äî  2000   .     Rancher v1.6      VMware.&nbsp;<br>
</li>
</ul><br>
<h4></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comme on dit, rien ne dure √©ternellement, et Rancher a annonc√© assez longtemps la fin du support de la version 1.6. </font><font style="vertical-align: inherit;">Oui, depuis plus de trois ans, nous avons appris √† cuisiner et √† r√©soudre les probl√®mes qui se posent, mais nous sommes de plus en plus souvent confront√©s √† des probl√®mes qui ne seront jamais r√©solus. </font><font style="vertical-align: inherit;">Rancher 1.6 dispose √©galement d'un syst√®me ossifi√© de d√©livrance de droits, dans lequel vous pouvez faire presque tout ou rien. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Propre virtualisation, m√™me si elle a permis un meilleur contr√¥le du stockage et de la s√©curit√© des donn√©es, mais a impos√© des co√ªts op√©rationnels, difficiles √† supporter avec la croissance constante de l'entreprise, le nombre de projets et les exigences pour eux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous voulions suivre les normes IaC et, si n√©cessaire, obtenir le courant rapidement, dans n'importe quel emplacement g√©ographique et sans verrou de fournisseur, et pouvoir √©galement les abandonner rapidement.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premiers pas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tout d'abord, nous voulions nous appuyer sur des technologies et des solutions modernes qui permettraient aux √©quipes d'avoir un cycle de d√©veloppement plus rapide et de minimiser les co√ªts d'exploitation pour l'interaction avec une plateforme qui fournit de l'√©nergie.&nbsp; </font></font><br>
&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien s√ªr, la premi√®re chose qui nous est venue √† l'esprit √©tait Kubernetes, mais nous ne nous sommes pas excit√©s et avons fait quelques recherches sur le sujet du bon choix. Nous n'avons √©valu√© que des solutions open source et Kubernetes a √©t√© battu sans condition dans une bataille d√©loyale.&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vient ensuite la question du choix d'un outil de cr√©ation de clusters. Nous avons compar√© les solutions les plus populaires: kops, kubespray, kubeadm. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour commencer, le kubeadm nous semblait plut√¥t trop compliqu√©, plut√¥t une sorte d'inventeur du "v√©lo", et le kops manquait de souplesse. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et le gagnant est sorti:</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/35e/1e6/e85/35e1e6e85e12e982649fd020862463cd.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons commenc√© √† exp√©rimenter sur notre propre virtualisation et AWS, essayant de recr√©er une ressemblance approximative de notre mod√®le de gestion des ressources pr√©c√©dent, o√π tout le monde utilise le m√™me ¬´cluster¬ª. </font><font style="vertical-align: inherit;">Et maintenant, nous avons le premier cluster de 10 petites machines virtuelles, dont deux sont dans AWS. </font><font style="vertical-align: inherit;">Nous avons commenc√© √† essayer de faire migrer les √©quipes l√†-bas, tout semblait √™tre ¬´bien¬ª, et l'histoire pourrait √™tre termin√©e, mais ...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Premiers probl√®mes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ansible est ce sur quoi kubespray est construit, ce n'est pas l'outil qui permet de suivre l'IaC: quelque chose s'est mal pass√© lors de l'entr√©e / sortie des n≈ìuds, et une intervention a √©t√© n√©cessaire, et lors de l'utilisation de diff√©rents OS, le playbook s'est comport√© en diff√©rentes mani√®res. Avec le nombre croissant de commandes et de n≈ìuds dans le cluster, nous avons commenc√© √† remarquer que le playbook prenait de plus en plus de temps, au final, notre record √©tait de 3,5 heures, et le v√¥tre? :) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et il semble que kubespray soit simplement Ansible, et tout est clair √† premi√®re vue, mais: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/11e/593/7d7/11e5937d7576851ad38e8469502e6d7f.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Au d√©but du voyage, il y avait une t√¢che pour ex√©cuter les capacit√©s uniquement dans AWS et la virtualisation, mais comme cela arrive souvent, les exigences ont chang√©.</font></font><br>
&nbsp;<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e4f/b1b/f10/e4fb1bf10754dc4ea192c0a05d2e524c.png"><img src="https://habrastorage.org/getpro/habr/post_images/e1d/eeb/7d5/e1deeb7d5c4b2392962fbe5b6a528388.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la lumi√®re de cela, il est devenu clair que notre ancien mod√®le de combinaison des ressources dans un syst√®me d'orchestration n'√©tait pas appropri√© - dans le cas o√π les clusters sont tr√®s √©loign√©s et sont g√©r√©s par diff√©rents fournisseurs.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En outre. Lorsque toutes les √©quipes travaillent au sein du m√™me cluster, divers services avec NodeSelector install√© de mani√®re incorrecte peuvent voler vers l'h√¥te ¬´√©tranger¬ª d'une autre √©quipe et y utiliser des ressources, et dans le cas de la mise en attente, il y avait des appels constants que tel ou tel service ne fonctionnait pas, non distribu√© correctement en raison du facteur humain. Un autre probl√®me √©tait le calcul du co√ªt, compte tenu notamment des probl√®mes de r√©partition des services par n≈ìuds.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une autre histoire a √©t√© la question des droits des employ√©s: chaque √©quipe voulait √™tre ¬´√† la t√™te¬ª du cluster et le g√©rer pleinement, ce qui pourrait provoquer un effondrement complet, car les √©quipes sont fondamentalement ind√©pendantes les unes des autres.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment √™tre</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compte tenu de ce qui pr√©c√®de et du souhait des √©quipes d'√™tre plus ind√©pendantes, nous avons tir√© une conclusion simple: une √©quipe - un cluster.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous en avons donc un deuxi√®me: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/5ca/125/895/5ca125895d8571f18c41034f226c65d5.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis un troisi√®me cluster:&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/81b/7a9/f75/81b7a9f755d7be0798ec641ef8d444ae.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puis nous avons commenc√© √† penser: disons, dans un an nos √©quipes auront plus d'un cluster? Dans diff√©rentes zones g√©ographiques, par exemple, ou sous le contr√¥le de diff√©rents prestataires? Et certains d'entre eux voudront pouvoir d√©ployer rapidement un cluster temporaire pour tous les tests.&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/265/52e/0a5/26552e0a5bb71a6f82b3dd4f3226b768.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Serait plein Kubernetes! Il s'agit d'une sorte de MultiKubernetes, il s'av√®re.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le m√™me temps, nous devrons tous prendre en charge tous ces clusters, pouvoir en contr√¥ler facilement l'acc√®s, en cr√©er de nouveaux et retirer les anciens sans intervention manuelle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depuis le d√©but de notre voyage dans le monde de Kubernetes, un certain temps s'est √©coul√© et nous avons d√©cid√© de r√©examiner les solutions disponibles. Il s'est av√©r√© qu'il existe d√©j√† sur le march√© - Rancher 2.2. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/9a2/c00/e81/9a2c00e81c4d2a0daf2b6f0a7afe8c0a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä la premi√®re √©tape de nos recherches, Rancher Labs a d√©j√† fait la premi√®re version de la version 2, mais bien qu'elle puisse √™tre augment√©e tr√®s rapidement en ex√©cutant le conteneur sans d√©pendances externes avec quelques param√®tres ou en utilisant le graphique HELM officiel, cela nous a sembl√© grossier et nous ne savions pas si compter sur cette d√©cision, qu'elle soit d√©velopp√©e ou rapidement abandonn√©e. Le paradigme cluster = clics lui-m√™me dans l'interface utilisateur ne nous convenait pas non plus, et nous ne voulions pas nous attacher √† RKE, car il s'agit d'un outil assez √©troit d'esprit.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La version Rancher 2.2 avait d√©j√† un aspect plus efficace et, avec les pr√©c√©dentes, avait un tas de fonctionnalit√©s int√©ressantes, telles que l'int√©gration avec de nombreux fournisseurs externes, un point de distribution unique des droits et des fichiers kubeconfig, le lancement d'une image kubectl avec vos droits dans l'interface utilisateur, des espaces de noms imbriqu√©s, alias projets.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Une communaut√© s'est d√©j√† form√©e autour de Rancher 2, et le fournisseur HashiCorp Terraform a √©t√© cr√©√© pour le g√©rer, ce qui nous a aid√©s √† tout assembler.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu'est-il arriv√©</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En cons√©quence, nous avons obtenu un petit cluster dans lequel Rancher est lanc√©, accessible √† tous les autres clusters, ainsi qu'√† de nombreux clusters qui lui sont associ√©s, l'acc√®s √† chacun d'entre eux pouvant √™tre √©mis aussi simplement que l'ajout d'un utilisateur au r√©pertoire ldap, quel que soit l'endroit o√π il se trouve est localis√© et les ressources dont le fournisseur utilise.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En utilisant gitlab-ci et Terraform, un syst√®me a √©t√© cr√©√© qui vous permet de cr√©er un cluster de n'importe quelle configuration dans les fournisseurs de cloud ou notre propre infrastructure et de les connecter √† Rancher. Tout cela se fait dans le style IaC, o√π chaque cluster est d√©crit par un r√©f√©rentiel et son √©tat est versionn√©. Dans ce cas, la plupart des modules sont connect√©s √† partir de r√©f√©rentiels externes de sorte qu'il ne reste plus qu'√† transf√©rer des variables ou √† d√©crire leur configuration personnalis√©e pour les instances, ce qui contribue √† r√©duire le pourcentage de r√©p√©tabilit√© du code. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/eae/814/877/eae814877be3c3a957b6f75a2c657f58.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien s√ªr, notre voyage est loin d'√™tre termin√© et il reste encore de nombreuses t√¢ches int√©ressantes √† accomplir, comme un point de travail unique avec les journaux et les m√©triques de tous les clusters, le maillage de service, les gitops pour g√©rer les charges dans un multicluster, et bien plus encore. Nous esp√©rons que vous serez int√©ress√© par notre exp√©rience!&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'article a √©t√© √©crit par A. Antipov, A. Ganush, Platform Engineers.&nbsp;</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr500312/index.html">√âcrire une application de prise de notes JavaScript</a></li>
<li><a href="../fr500314/index.html">PHP Digest n ¬∞ 179 (21 avril - 4 mai 2020)</a></li>
<li><a href="../fr500316/index.html">Nouvelle version d'Apple et de Google Contact Tracing Protocol</a></li>
<li><a href="../fr500318/index.html">HP Elite Dragonfly - quel type d'ordinateur portable Athena √™tes-vous?</a></li>
<li><a href="../fr500320/index.html">Propres moteurs de jeu: un peu de recherche</a></li>
<li><a href="../fr501092/index.html">√Ä propos de la recherche de juin prometteur et "udalenka". Exp√©rience du responsable du support technique de Redmadrobot</a></li>
<li><a href="../fr501098/index.html">Solutions de batteries intelligentes SmartLi pour onduleurs modulaires</a></li>
<li><a href="../fr501106/index.html">Le simulateur de mots anglais le plus simple utilisant Python et Balabolka</a></li>
<li><a href="../fr501108/index.html">Historique du multiprocesseur Nvidia Streaming</a></li>
<li><a href="../fr501110/index.html">Mobius et WWDC: plus de plaisir ensemble</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>