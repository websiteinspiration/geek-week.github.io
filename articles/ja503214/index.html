<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏻‍🚀 👨🏼 🎚️ ElasticSearchを使用したHighloadプロジェクトでの負荷の最適化 🗞️ 🌅 👨🏽‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、ハブル！私の名前はマキシムヴァシリエフです。FINCHでアナリストおよびプロジェクトマネージャーとして働いています。今日、ElasticSearchを使用して、1500万のクエリを6分間で処理し、クライアントの1つのサイトの1日の負荷を最適化する方法を説明します。残念ながら、私たちはND...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ElasticSearchを使用したHighloadプロジェクトでの負荷の最適化</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/503214/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、ハブル！</font><font style="vertical-align: inherit;">私の名前はマキシムヴァシリエフです。FINCHでアナリストおよびプロジェクトマネージャーとして働いています。</font><font style="vertical-align: inherit;">今日、ElasticSearchを使用して、1500万のクエリを6分間で処理し、クライアントの1つのサイトの1日の負荷を最適化する方法を説明します。</font><font style="vertical-align: inherit;">残念ながら、私たちはNDAを持っているので、名前なしでやらなければなりません。記事の内容が影響を受けないことを願っています。</font><font style="vertical-align: inherit;">行こう。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロジェクトの配置方法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バックエンドでは、クライアントのサイトとモバイルアプリケーションのパフォーマンスを保証するサービスを作成します。</font><font style="vertical-align: inherit;">一般的な構造は図で確認できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sv/yw/mx/svywmxdiqxb59mwxobsses8vrc8.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このプロセスでは、購入、支払い、ユーザー残高のある操作などの多数のトランザクションを処理します。このログには大量のログが保存され、このデータを外部システムにインポートおよびエクスポートします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
クライアントからデータを受信して​​ユーザーに送信する場合も、逆のプロセスがあります。</font><font style="vertical-align: inherit;">さらに、支払いやボーナスプログラムを処理するプロセスはまだあります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">短い背景</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、PostgreSQLを唯一のデータウェアハウスとして使用しました。 DBMSの標準的な利点：トランザクションの可用性、データサンプリングの開発言語、統合のための幅広いツール。優れたパフォーマンスと相まって、満足した人々は長い間私たちのニーズを満たしてきました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
トランザクションからニュースまで、すべてのデータをPostgresに保存しました。しかし、ユーザーの数は増加し、それに伴ってリクエストの数も増加しました。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理解のために、デスクトップサイトだけでの2017年の年間セッション数は1億3100万です。2018年には、1億2500万は1億3千万です。モバイルバージョンのサイトとモバイルアプリケーションからさらに1億から2億を追加すると、膨大な数のリクエストが発生します。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトの成長に伴い、Postgresは負荷に対処できなくなり、時間がありませんでした。さまざまなクエリが多数表示され、十分な数のインデックスを作成できませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは、私たちのニーズを提供し、PostgreSQLの負荷を軽減する他のデータウェアハウスが必要であることを認識しました。</font><font style="vertical-align: inherit;">ElasticsearchとMongoDBが可能なオプションと見なされました。</font><font style="vertical-align: inherit;">後者は次の点で負けました：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスのデータ量が増えると、インデックス作成速度が遅くなります。</font><font style="vertical-align: inherit;">Elasticでは、速度はデータの量に依存しません。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">全文検索なし</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、Elasticを自分で選択し、移行の準備をしました。 </font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elasticへの切り替え</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. POS検索サービスから移行を開始しました。</font><font style="vertical-align: inherit;">私たちのクライアントは合計で約70,000のPOSを持ち、サイトとアプリケーションでいくつかのタイプの検索が必要です。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">都市名によるテキスト検索</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ある地点からの特定の半径での地理検索。</font><font style="vertical-align: inherit;">たとえば、ユーザーが自宅に最も近い販売拠点を確認したい場合などです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定の正方形で検索-ユーザーはマップ上に正方形を描画し、この半径内のすべてのポイントが表示されます。 </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">追加のフィルターを検索します。</font><font style="vertical-align: inherit;">POSの品揃えは互いに異なります</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
組織といえば、Postgresでは地図とニュースの両方にデータのソースがあり、Elastic Snapshotsでは元のデータから作成されます。実際、当初、Postgresはすべての基準による検索に対応できませんでした。多くのインデックスが存在するだけでなく、それらが交差する可能性もあったため、Postgresスケジューラは失われ、どのインデックスを使用するか理解できませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2.次の行はニュースセクションです。毎日、サイトに出版物が表示されるので、ユーザーは情報の流れに迷うことがありません。発行する前にデータを並べ替える必要があります。これを行うには、検索が必要です。サイトでは、テキストマッチで検索できると同時に、Elasticで作成されているため、追加のフィルターを接続できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3.次に、トランザクション処理を移動しました。</font><font style="vertical-align: inherit;">ユーザーはサイトで特定の製品を購入し、抽選に参加できます。</font><font style="vertical-align: inherit;">そのような購入の後、特に週末と休日に大量のデータを処理します。</font><font style="vertical-align: inherit;">比較のために、通常の日に購入数が150万から200万の間にある場合、祝日には5300万に達する可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、データは最小限の時間で処理される必要があります-ユーザーは数日間結果を待つのが嫌です。</font><font style="vertical-align: inherit;">Postgresを介してこのような期限を達成することはできません-私たちはしばしばロックを取得し、すべてのリクエストを処理している間、ユーザーは賞品を受け取ったかどうかを確認できませんでした。</font><font style="vertical-align: inherit;">これはビジネスにとってあまり快適ではないため、処理をElasticsearchに移動しました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">周期性</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、更新は次の条件下でイベントごとに構成されます。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">POS。</font><font style="vertical-align: inherit;">外部ソースからのデータが到着するとすぐに、アップデートを開始します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニュース。</font><font style="vertical-align: inherit;">ニュースがサイトで編集されるとすぐに、自動的にElasticに送信されます。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでも、Elasticの利点に言及する価値があります。</font><font style="vertical-align: inherit;">Postgresでは、リクエストを送信するとき、すべてのレコードを正直に処理するまで待つ必要があります。</font><font style="vertical-align: inherit;">1万件のレコードをElasticに送信し、レコードがすべてのシャードに分散されるまで待たずに、すぐに作業を開始できます。</font><font style="vertical-align: inherit;">もちろん、一部のシャードまたはレプリカはデータをすぐには表示しない場合がありますが、すぐにすべてが利用可能になります。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">統合方法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Elasticと統合するには2つの方法があります。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TCP上のネイティブクライアントを介して。</font><font style="vertical-align: inherit;">ネイティブドライバーは次第に廃止されます。サポートされなくなり、構文が非常に不便になります。</font><font style="vertical-align: inherit;">したがって、実際にはそれを使用せず、完全に放棄しようとします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSONリクエストとLucene構文の両方を使用できるHTTPインターフェース経由。</font><font style="vertical-align: inherit;">後者はElasticを使用するテキストエンジンです。</font><font style="vertical-align: inherit;">このオプションでは、HTTPを介してJSONリクエストを介してバッチ処理することができます。</font><font style="vertical-align: inherit;">これは、使用しようとしているオプションです。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
HTTPインターフェースのおかげで、HTTPクライアントの非同期実装を提供するライブラリを使用できます。</font><font style="vertical-align: inherit;">Batchと非同期APIを利用することができます。これにより、最終的には高いパフォーマンスが得られ、大規模なアクションの日中に非常に役立ちました（以下で詳しく説明します）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。比較するいくつかの数値：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresで賞を受け取ったユーザーをグループ化せずに20ストリームで保存：42秒で460,713エントリ</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラスティック+ 10スレッドのリアクティブクライアント+ 1000要素のバッチ：11秒で596749レコード</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">エラスティック+ 10スレッドのリアクティブクライアント+ 1000要素のバッチ：</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4分で23801684レコード</font></font></b></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、JSONをBatchではなくBatchとしてビルドし、ライブラリに関係なく任意のHTTPクライアントを介して送信するHTTPリクエストマネージャーを作成しました。</font><font style="vertical-align: inherit;">リクエストを同期または非同期で送信することもできます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一部の統合では、まだ公式のトランスポートクライアントを使用していますが、これは今後のリファクタリングの問題にすぎません。</font><font style="vertical-align: inherit;">同時に、Spring WebClientに基づいて構築されたカスタムクライアントが処理に使用されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/x2/sx/qg/x2sxqgijaic0-ldqbrjlwse_tp0.jpeg" alt="画像"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">大きなプロモーション</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1年に1回、プロジェクトでユーザーを対象とした大規模なキャンペーンが行われます。現時点では数千万のユーザーを同時に対象にしているため、これは同じHighloadです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、ピーク負荷は休暇中に発生しますが、このプロモーションはまったく異なるレベルです。昨年はプロモーション当日、27,580,890個の商品を販売しました。データが30分以上処理されたため、ユーザーに不便が生じました。ユーザーは参加して賞を受賞しましたが、プロセスを加速する必要があることが明らかになりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2019年の初めに、ElasticSearchが必要だと判断しました。 1年間、モバイルアプリケーションとサイトのAPIで、Elasticでの受信データの処理とその出力を整理しました。その結果、翌年のキャンペーン期間中、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">15分の131 783レコードを6分間で処理しました。</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
商品を購入してプロモーションの抽選に参加したい人がたくさんいるので、これは一時的な措置です。</font><font style="vertical-align: inherit;">現在、Elasticに関連情報を送信していますが、将来的には、過去数か月のアーカイブ情報を永続的なリポジトリとしてPostgresに転送する予定です。</font><font style="vertical-align: inherit;">制限があるエラスティックインデックスを詰まらせないため。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論/結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現時点では、必要なすべてのサービスをElasticに移行し、現在は一時停止しています。</font><font style="vertical-align: inherit;">今度は、Postgresのメインの永続ストレージの上にElasticでインデックスを構築します。これにより、ユーザーの負荷がかかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今後は、データ要求が多様化し、無制限の列で検索されることが判明した場合にサービスを移管する予定です。</font><font style="vertical-align: inherit;">これはPostgresのタスクではなくなりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
機能で全文検索が必要な場合、または多くの異なる検索基準がある場合、これをElasticに変換する必要があることはすでにわかっています。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">⌘⌘⌘</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
読んでくれてありがとう。</font><font style="vertical-align: inherit;">あなたの会社がElasticSearchも使用していて、独自の実装ケースがある場合は、お知らせください。</font><font style="vertical-align: inherit;">他の人がどのように持っているかを知るのは興味深いでしょう:-)</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja503202/index.html">CCTVシステム：ロシアの8つの主なトレンドとその機能</a></li>
<li><a href="../ja503204/index.html">Xiaomi Redmi 4 Pro（プライム、プレミアム）をAndroid 10でフラッシュする方法</a></li>
<li><a href="../ja503208/index.html">投資するのに最適な時期はいつですか？</a></li>
<li><a href="../ja503210/index.html">フィッシングサイトを根絶することはできますか？</a></li>
<li><a href="../ja503212/index.html">オンラインコースを完了するための30のライフハック</a></li>
<li><a href="../ja503218/index.html">GlobalSignがAtlasを発表-次世代PKIプラットフォーム</a></li>
<li><a href="../ja503226/index.html">ビジネスが「数」に移行するのを妨げているもの、および評判と何が関係しているのか</a></li>
<li><a href="../ja503228/index.html">音楽フィードバックをジョギングしている間の心拍数制御-または「走りたいテスターが探している」</a></li>
<li><a href="../ja503230/index.html">インシデントレスポンスプラットフォームクラスシステム：アプリケーションと主な機能</a></li>
<li><a href="../ja503232/index.html">6か月以上でDevOpsエンジニアになる方法 パート6.アプリケーションの起動</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>