<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ぐ   Localizaci贸n temporal en Symfony 4 + Twig 锔  </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La necesidad de una localizaci贸n temporal del producto surge cuando el producto crece a una escala tal que requiere trabajo en diferentes zonas horari...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Localizaci贸n temporal en Symfony 4 + Twig</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495604/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La necesidad de una localizaci贸n temporal del producto surge cuando el producto crece a una escala tal que requiere trabajo en diferentes zonas horarias (evidencia). </font><font style="vertical-align: inherit;">Me gustar铆a describir una variante de una idea simple para resolver este caso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El trasfondo es este: desarrollamos un sistema de CRM / ERP de nicho, y luego nos dijeron que ma帽ana trabajar铆an con este sistema en una franquicia de Vladivostok a Kaliningrado. </font><font style="vertical-align: inherit;">Desafortunadamente, tal escenario no se pens贸 originalmente, y comenzamos a aprender c贸mo hacerlo con un costo m铆nimo y la m谩xima comodidad.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En total, se ampliaron tres tareas: c贸mo sacamos los datos y c贸mo ingresamos, y entre ellas la tarea c贸mo almacenamos todo. Como el tiempo, como saben, es relativamente literal y figurado, se decidi贸 almacenar el tiempo como antes en Mosc煤 UTC + 3, pero procesarlo en la entrada y salida (y tener en cuenta que el punto de referencia es UTC + 3). Por supuesto, entendimos que hay otras soluciones en esta y otras direcciones. Puede convertir todas las entradas existentes a UTC + -0, as铆 como utilizar tipos especializados en el DBMS que almacenan la zona horaria, puede escribir este tipo personalizado usted mismo, si de repente la base de datos no es totalmente compatible con tales caracter铆sticas. Pero guiados por el principio de simplicidad, seguimos el camino propuesto, m谩s a煤n, a primera vista, no perdi贸 mucho con el resto,y la l贸gica para determinar la zona horaria deseada era bastante simple.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu茅s de que Mosc煤 se convirti贸 en un punto de referencia, agregamos un par谩metro de zona horaria personalizada a cada usuario, as铆 como una serie de entidades relacionadas (organizaci贸n, ciudad, pedidos, ofertas, etc.). </font><font style="vertical-align: inherit;">Entonces fue posible establecer inequ铆vocamente en qu茅 zona horaria el usuario o entidad con la que trabaja. </font><font style="vertical-align: inherit;">La l贸gica all铆 es est谩ndar y precisamente a menudo espec铆fica de los proyectos. </font><font style="vertical-align: inherit;">Incluimos esta l贸gica en el servicio y obtuvimos una zona horaria en la que necesita</font></font><br>
<br>
<pre><code class="php hljs">$localizationService-&gt;getTimezone();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La decisi贸n de localizar las fechas en las plantillas fue la siguiente: al inicializar las extensiones de Twig, la zona horaria se cambi贸 a la deseada:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">Environment $twig, LocalizationService $localizationService</span>) </span>{<font></font>
    $twig-&gt;getExtension(<span class="hljs-string">'Twig_Extension_Core'</span>)-&gt;setTimezone($localizationService-&gt;getTimezone());<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestra situaci贸n se complic贸 a煤n m谩s por el hecho de que despu茅s de que se muestra cualquier fecha y hora, es necesario hacer un sub铆ndice "01.01.2020 12:30 (Mosc煤)", de modo que, por ejemplo, en un pedido / tarea / transacci贸n condicional que est茅 vinculada a la zona horaria, informaci贸n sobre la hora cintur贸n. </font><font style="vertical-align: inherit;">Por razones pr谩cticas, esto es necesario para que un 煤nico centro de llamadas pueda trabajar c贸modamente con diferentes zonas horarias dentro del marco de una tarea / aplicaci贸n / transacci贸n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toda la l贸gica para determinar la prioridad de las zonas horarias se ha conectado a la mencionada zona getTimezone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem谩s, nos enfrentamos con el hecho de que si realiza su filtro o funci贸n de ramita, deber谩 cambiar un mont贸n de plantillas, pero le gustar铆a evitar esto. </font><font style="vertical-align: inherit;">Por lo tanto, despu茅s de preguntar un poco, decidimos redefinir la fecha est谩ndar del filtro de ramita</font></font><br>
<br>
<pre><code class="php hljs">...
<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'date'</span>, [<span class="hljs-keyword">$this</span>, <span class="hljs-string">'date'</span>], [<span class="hljs-string">'needs_environment'</span> =&gt; <span class="hljs-literal">true</span>]),<font></font>
...<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">date</span>(<span class="hljs-params">Twig_Environment $env, $date, $format = <span class="hljs-literal">null</span>, $timezone = <span class="hljs-literal">null</span></span>)
</span>{<font></font>
    $appendix = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (format &amp;&amp; strpos($format, <span class="hljs-string">'H:i'</span>) !== <span class="hljs-literal">false</span>)<font></font>
        $appendix = <span class="hljs-string">' ('</span>.DateTimeFunctions::getRussianAbbrev(<span class="hljs-keyword">$this</span>-&gt;localizationService-&gt;getTimezone()).<span class="hljs-string">')'</span>;   <font></font>
...<font></font>
    <span class="hljs-comment">//    date   $result</span><font></font>
...<font></font>
   <span class="hljs-keyword">return</span> $result.$appendix;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adem谩s, desde que tomamos el filtro est谩ndar, la versi贸n anterior se redefini贸:</font></font><br>
<br>
<pre><code class="php hljs">...
<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'native_date'</span>, [<span class="hljs-keyword">$this</span>, <span class="hljs-string">'nativeDate'</span>], [ <span class="hljs-string">'needs_environment'</span> =&gt; <span class="hljs-literal">true</span>]),<font></font>
...<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nativeDate</span>(<span class="hljs-params">Twig_Environment $env, $date, $format = <span class="hljs-literal">null</span>, $timezone = <span class="hljs-literal">null</span></span>)
</span>{
    <span class="hljs-comment">//    date </span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c贸digo de filtro de fecha est谩ndar se puede encontrar en / twig / twig / lib / Twig / Extension / Core :: twig_date_format_filter. </font><font style="vertical-align: inherit;">Aunque, de hecho, en la mayor铆a de los casos, una opci贸n simple y no muy diferente servir谩:</font></font><br>
<br>
<pre><code class="php hljs">$date-&gt;setTimeZone($timezone)<font></font>
$result = $date-&gt;format($format);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, tambi茅n puede bifurcar o redefinir la parte m谩s sustancial de Twig, pero si la funcionalidad del filtro est谩ndar le conviene, simplemente puede sacarlo por separado y no perder nada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queda por resolver el problema de ingresar la fecha y hora. </font><font style="vertical-align: inherit;">Una soluci贸n:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOffsetHours</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isInit)
        <span class="hljs-keyword">$this</span>-&gt;init();<font></font>
<font></font>
    $local = <span class="hljs-keyword">new</span> \DateTime(<span class="hljs-string">'now'</span>, <span class="hljs-keyword">new</span> \DateTimeZone(<span class="hljs-keyword">$this</span>-&gt;getTimezone()));<font></font>
    $user = <span class="hljs-keyword">new</span> \DateTime(<span class="hljs-string">'now'</span>);<font></font>
<font></font>
    $localOffset = $local-&gt;getOffset() / <span class="hljs-number">3600</span>;<font></font>
    $globalOffset = $user-&gt;getOffset() / <span class="hljs-number">3600</span>;<font></font>
<font></font>
    $diff = $globalOffset - $localOffset;<font></font>
    <span class="hljs-keyword">return</span> $diff;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toGlobalTime</span>(<span class="hljs-params">\DateTimeInterface $dateTime</span>): \<span class="hljs-title">DateTimeInterface</span> 
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isInit)
        <span class="hljs-keyword">$this</span>-&gt;init();<font></font>
<font></font>
    $offsetHours = <span class="hljs-keyword">$this</span>-&gt;getOffsetHours();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ($offsetHours &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> $dateTime-&gt;modify(<span class="hljs-string">'+ '</span>.$offsetHours.<span class="hljs-string">' hours'</span>);<font></font>
    } <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span>($offsetHours &lt; <span class="hljs-number">0</span>){
        <span class="hljs-keyword">return</span> $dateTime-&gt;modify($offsetHours.<span class="hljs-string">' hours'</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $dateTime;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego llame antes de guardar la fecha y hora, por ejemplo, en oyentes. Esta opci贸n se nos ocurri贸, ya que b谩sicamente la hora y la fecha en el proyecto son fijas para ciertos eventos y no se ingresan manualmente. Para otro caso extremo, donde el tiempo se introduce constantemente a trav茅s de formularios, la soluci贸n puede no ser 贸ptima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como un bono. El proyecto utiliza Omines datatables-bundle para generar tablas. All铆 la soluci贸n fue a煤n m谩s f谩cil. En lugar de DateTimeColumn para la localizaci贸n, se utiliz贸 lo siguiente:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomDateTimeColumn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DateTimeColumn</span>
</span>{<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> $localizationService;
    <span class="hljs-keyword">private</span> $timeZone;<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">LocalizationService $localizationService</span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;localizationService = $localizationService;
        <span class="hljs-keyword">$this</span>-&gt;timeZone = $localizationService-&gt;getTimezoneObject();<font></font>
    }<font></font>
    <font></font>
   <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalize</span>(<span class="hljs-params">$value</span>)
    </span>{<font></font>
        $value-&gt;setTimeZone(<span class="hljs-keyword">$this</span>-&gt;timeZone);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">parent</span>::normalize($value);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias por tu tiempo. </font><font style="vertical-align: inherit;">Si alguien ayuda a mejorar las cosas b谩sicas de la soluci贸n, estar茅 muy agradecido. </font><font style="vertical-align: inherit;">Estamos hablando de los b谩sicos, ya que est谩 claro que el c贸digo es vac铆o y en realidad tiene una DI mucho m谩s grande y todo tipo de golosinas para uso interno en el proyecto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En resumen. </font><font style="vertical-align: inherit;">Se presenta la idea de una soluci贸n simple para la r谩pida localizaci贸n temporal del proyecto. </font><font style="vertical-align: inherit;">No depende de las versiones, o si lo hace, es d茅bil. </font><font style="vertical-align: inherit;">Esta soluci贸n migr贸 con 茅xito de Symfony 4.2 a 5.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es495588/index.html">Creando roguelike en Unity desde cero: generador de mazmorras</a></li>
<li><a href="../es495592/index.html">C贸mo usar diccionarios (y no solo)</a></li>
<li><a href="../es495594/index.html">Comience a ganar dinero con el software: creando mini-digital-business</a></li>
<li><a href="../es495596/index.html">Trabajo a distancia en la oficina. RDP, Port Knocking, Mikrotik: simple y seguro</a></li>
<li><a href="../es495602/index.html">隆Comenzando con Core Data! Dif铆cil en palabras simples [Parte 2]</a></li>
<li><a href="../es495606/index.html">"Monitoreo social". Puntuaci贸n 1: 0 a nuestro favor</a></li>
<li><a href="../es495608/index.html">[Infograf铆a] Visualizaci贸n de pandemias en la historia de la humanidad</a></li>
<li><a href="../es495610/index.html">驴Por qu茅 el futuro no es para Python?</a></li>
<li><a href="../es495612/index.html">驴Airbnb sobrevivir谩 al coronavirus? [spoiler: s铆]</a></li>
<li><a href="../es495614/index.html">FFmpeg libav manual</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>