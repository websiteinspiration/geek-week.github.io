<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤰🏿 👧 🧚🏿 Localización temporal en Symfony 4 + Twig ⏯️ 🎤 🧕🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La necesidad de una localización temporal del producto surge cuando el producto crece a una escala tal que requiere trabajo en diferentes zonas horari...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Localización temporal en Symfony 4 + Twig</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495604/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La necesidad de una localización temporal del producto surge cuando el producto crece a una escala tal que requiere trabajo en diferentes zonas horarias (evidencia). </font><font style="vertical-align: inherit;">Me gustaría describir una variante de una idea simple para resolver este caso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El trasfondo es este: desarrollamos un sistema de CRM / ERP de nicho, y luego nos dijeron que mañana trabajarían con este sistema en una franquicia de Vladivostok a Kaliningrado. </font><font style="vertical-align: inherit;">Desafortunadamente, tal escenario no se pensó originalmente, y comenzamos a aprender cómo hacerlo con un costo mínimo y la máxima comodidad.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En total, se ampliaron tres tareas: cómo sacamos los datos y cómo ingresamos, y entre ellas la tarea cómo almacenamos todo. Como el tiempo, como saben, es relativamente literal y figurado, se decidió almacenar el tiempo como antes en Moscú UTC + 3, pero procesarlo en la entrada y salida (y tener en cuenta que el punto de referencia es UTC + 3). Por supuesto, entendimos que hay otras soluciones en esta y otras direcciones. Puede convertir todas las entradas existentes a UTC + -0, así como utilizar tipos especializados en el DBMS que almacenan la zona horaria, puede escribir este tipo personalizado usted mismo, si de repente la base de datos no es totalmente compatible con tales características. Pero guiados por el principio de simplicidad, seguimos el camino propuesto, más aún, a primera vista, no perdió mucho con el resto,y la lógica para determinar la zona horaria deseada era bastante simple.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Después de que Moscú se convirtió en un punto de referencia, agregamos un parámetro de zona horaria personalizada a cada usuario, así como una serie de entidades relacionadas (organización, ciudad, pedidos, ofertas, etc.). </font><font style="vertical-align: inherit;">Entonces fue posible establecer inequívocamente en qué zona horaria el usuario o entidad con la que trabaja. </font><font style="vertical-align: inherit;">La lógica allí es estándar y precisamente a menudo específica de los proyectos. </font><font style="vertical-align: inherit;">Incluimos esta lógica en el servicio y obtuvimos una zona horaria en la que necesita</font></font><br>
<br>
<pre><code class="php hljs">$localizationService-&gt;getTimezone();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La decisión de localizar las fechas en las plantillas fue la siguiente: al inicializar las extensiones de Twig, la zona horaria se cambió a la deseada:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">Environment $twig, LocalizationService $localizationService</span>) </span>{<font></font>
    $twig-&gt;getExtension(<span class="hljs-string">'Twig_Extension_Core'</span>)-&gt;setTimezone($localizationService-&gt;getTimezone());<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestra situación se complicó aún más por el hecho de que después de que se muestra cualquier fecha y hora, es necesario hacer un subíndice "01.01.2020 12:30 (Moscú)", de modo que, por ejemplo, en un pedido / tarea / transacción condicional que esté vinculada a la zona horaria, información sobre la hora cinturón. </font><font style="vertical-align: inherit;">Por razones prácticas, esto es necesario para que un único centro de llamadas pueda trabajar cómodamente con diferentes zonas horarias dentro del marco de una tarea / aplicación / transacción. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Toda la lógica para determinar la prioridad de las zonas horarias se ha conectado a la mencionada zona getTimezone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, nos enfrentamos con el hecho de que si realiza su filtro o función de ramita, deberá cambiar un montón de plantillas, pero le gustaría evitar esto. </font><font style="vertical-align: inherit;">Por lo tanto, después de preguntar un poco, decidimos redefinir la fecha estándar del filtro de ramita</font></font><br>
<br>
<pre><code class="php hljs">...
<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'date'</span>, [<span class="hljs-keyword">$this</span>, <span class="hljs-string">'date'</span>], [<span class="hljs-string">'needs_environment'</span> =&gt; <span class="hljs-literal">true</span>]),<font></font>
...<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">date</span>(<span class="hljs-params">Twig_Environment $env, $date, $format = <span class="hljs-literal">null</span>, $timezone = <span class="hljs-literal">null</span></span>)
</span>{<font></font>
    $appendix = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (format &amp;&amp; strpos($format, <span class="hljs-string">'H:i'</span>) !== <span class="hljs-literal">false</span>)<font></font>
        $appendix = <span class="hljs-string">' ('</span>.DateTimeFunctions::getRussianAbbrev(<span class="hljs-keyword">$this</span>-&gt;localizationService-&gt;getTimezone()).<span class="hljs-string">')'</span>;   <font></font>
...<font></font>
    <span class="hljs-comment">//    date   $result</span><font></font>
...<font></font>
   <span class="hljs-keyword">return</span> $result.$appendix;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además, desde que tomamos el filtro estándar, la versión anterior se redefinió:</font></font><br>
<br>
<pre><code class="php hljs">...
<span class="hljs-keyword">new</span> TwigFilter(<span class="hljs-string">'native_date'</span>, [<span class="hljs-keyword">$this</span>, <span class="hljs-string">'nativeDate'</span>], [ <span class="hljs-string">'needs_environment'</span> =&gt; <span class="hljs-literal">true</span>]),<font></font>
...<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nativeDate</span>(<span class="hljs-params">Twig_Environment $env, $date, $format = <span class="hljs-literal">null</span>, $timezone = <span class="hljs-literal">null</span></span>)
</span>{
    <span class="hljs-comment">//    date </span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El código de filtro de fecha estándar se puede encontrar en / twig / twig / lib / Twig / Extension / Core :: twig_date_format_filter. </font><font style="vertical-align: inherit;">Aunque, de hecho, en la mayoría de los casos, una opción simple y no muy diferente servirá:</font></font><br>
<br>
<pre><code class="php hljs">$date-&gt;setTimeZone($timezone)<font></font>
$result = $date-&gt;format($format);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por supuesto, también puede bifurcar o redefinir la parte más sustancial de Twig, pero si la funcionalidad del filtro estándar le conviene, simplemente puede sacarlo por separado y no perder nada. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queda por resolver el problema de ingresar la fecha y hora. </font><font style="vertical-align: inherit;">Una solución:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getOffsetHours</span>(<span class="hljs-params"></span>)
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isInit)
        <span class="hljs-keyword">$this</span>-&gt;init();<font></font>
<font></font>
    $local = <span class="hljs-keyword">new</span> \DateTime(<span class="hljs-string">'now'</span>, <span class="hljs-keyword">new</span> \DateTimeZone(<span class="hljs-keyword">$this</span>-&gt;getTimezone()));<font></font>
    $user = <span class="hljs-keyword">new</span> \DateTime(<span class="hljs-string">'now'</span>);<font></font>
<font></font>
    $localOffset = $local-&gt;getOffset() / <span class="hljs-number">3600</span>;<font></font>
    $globalOffset = $user-&gt;getOffset() / <span class="hljs-number">3600</span>;<font></font>
<font></font>
    $diff = $globalOffset - $localOffset;<font></font>
    <span class="hljs-keyword">return</span> $diff;<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toGlobalTime</span>(<span class="hljs-params">\DateTimeInterface $dateTime</span>): \<span class="hljs-title">DateTimeInterface</span> 
</span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;isInit)
        <span class="hljs-keyword">$this</span>-&gt;init();<font></font>
<font></font>
    $offsetHours = <span class="hljs-keyword">$this</span>-&gt;getOffsetHours();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ($offsetHours &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> $dateTime-&gt;modify(<span class="hljs-string">'+ '</span>.$offsetHours.<span class="hljs-string">' hours'</span>);<font></font>
    } <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span>($offsetHours &lt; <span class="hljs-number">0</span>){
        <span class="hljs-keyword">return</span> $dateTime-&gt;modify($offsetHours.<span class="hljs-string">' hours'</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> $dateTime;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego llame antes de guardar la fecha y hora, por ejemplo, en oyentes. Esta opción se nos ocurrió, ya que básicamente la hora y la fecha en el proyecto son fijas para ciertos eventos y no se ingresan manualmente. Para otro caso extremo, donde el tiempo se introduce constantemente a través de formularios, la solución puede no ser óptima. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como un bono. El proyecto utiliza Omines datatables-bundle para generar tablas. Allí la solución fue aún más fácil. En lugar de DateTimeColumn para la localización, se utilizó lo siguiente:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomDateTimeColumn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DateTimeColumn</span>
</span>{<font></font>
    <font></font>
    <span class="hljs-keyword">private</span> $localizationService;
    <span class="hljs-keyword">private</span> $timeZone;<font></font>
    <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">LocalizationService $localizationService</span>)
    </span>{
        <span class="hljs-keyword">$this</span>-&gt;localizationService = $localizationService;
        <span class="hljs-keyword">$this</span>-&gt;timeZone = $localizationService-&gt;getTimezoneObject();<font></font>
    }<font></font>
    <font></font>
   <font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalize</span>(<span class="hljs-params">$value</span>)
    </span>{<font></font>
        $value-&gt;setTimeZone(<span class="hljs-keyword">$this</span>-&gt;timeZone);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">parent</span>::normalize($value);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias por tu tiempo. </font><font style="vertical-align: inherit;">Si alguien ayuda a mejorar las cosas básicas de la solución, estaré muy agradecido. </font><font style="vertical-align: inherit;">Estamos hablando de los básicos, ya que está claro que el código es vacío y en realidad tiene una DI mucho más grande y todo tipo de golosinas para uso interno en el proyecto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En resumen. </font><font style="vertical-align: inherit;">Se presenta la idea de una solución simple para la rápida localización temporal del proyecto. </font><font style="vertical-align: inherit;">No depende de las versiones, o si lo hace, es débil. </font><font style="vertical-align: inherit;">Esta solución migró con éxito de Symfony 4.2 a 5.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es495588/index.html">Creando roguelike en Unity desde cero: generador de mazmorras</a></li>
<li><a href="../es495592/index.html">Cómo usar diccionarios (y no solo)</a></li>
<li><a href="../es495594/index.html">Comience a ganar dinero con el software: creando mini-digital-business</a></li>
<li><a href="../es495596/index.html">Trabajo a distancia en la oficina. RDP, Port Knocking, Mikrotik: simple y seguro</a></li>
<li><a href="../es495602/index.html">¡Comenzando con Core Data! Difícil en palabras simples [Parte 2]</a></li>
<li><a href="../es495606/index.html">"Monitoreo social". Puntuación 1: 0 a nuestro favor</a></li>
<li><a href="../es495608/index.html">[Infografía] Visualización de pandemias en la historia de la humanidad</a></li>
<li><a href="../es495610/index.html">¿Por qué el futuro no es para Python?</a></li>
<li><a href="../es495612/index.html">¿Airbnb sobrevivirá al coronavirus? [spoiler: sí]</a></li>
<li><a href="../es495614/index.html">FFmpeg libav manual</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>