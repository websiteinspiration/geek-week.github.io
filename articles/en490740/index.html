<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶ï üõÄüèø üßóüèΩ Defecting *** s is not just randomization ‚õ∑Ô∏è üõµ üö∂</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a problem in the bank: developers and testers need to be given access to the database. There is a lot of client data that cannot be used for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Defecting *** s is not just randomization</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/technoserv/blog/490740/"><img src="https://habrastorage.org/webt/i_/5b/oz/i_5bozus9ql-pf8uiehztugtlqu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is a problem in the bank: developers and testers need to be given access to the database. There is a lot of client data that cannot be used for disclosure to the development and testing departments in accordance with PCI DSS requirements of the Central Bank and personal data laws. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would seem that just changing everything to some asymmetric hashes is enough and everything will be fine. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, it will not. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact is that the database of the bank is a set of interconnected tables. Somewhere they are connected by name and customer account number. Somewhere by its unique identifier. Somewhere (here the pain begins) through a stored procedure that calculates a pass-through identifier based on this and the neighboring table. Etc.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The usual situation is that the developer of the first version of the system has already died or left ten years ago, and the kernel systems running in the old hypervisor inside the new hypervisor (to ensure compatibility) are still in the prod. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, before anonymizing all this, you first need to understand the database.</font></font><a name="habracut"></a><br>
<br>
<img src="https://habrastorage.org/webt/8i/hu/ix/8ihuixtler91uuhxmyar6khyg9a.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Who does depersonalization and why?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They engage in depersonalization or masking because there are laws and standards. </font><font style="vertical-align: inherit;">Yes, it‚Äôs much better to test for a ‚Äúsell snapshot,‚Äù but regulators may revoke a license for such a flight. </font><font style="vertical-align: inherit;">That is, to cover up the business as such. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Any depersonalization is a rather expensive and clumsy layer between productive systems and development testing.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The goal of anonymization (masking) projects is almost always to prepare test data that is as similar as possible to real ones stored in productive databases. That is, if the data contains errors - instead of an email, the phone is clogged, instead of the Cyrillic alphabet in the surname Latin, etc., then the disguised data should be of the same quality, but changed beyond recognition. The second goal is to reduce the volume of databases that are used in testing and development. The full amount is left only for load testing, and for the rest of the tasks, a certain data slice is usually done according to predefined rules - database truncation. The third goal is to get related data in different disguised and truncated databases. This means that data in different systems, at different times, must be anonymized uniformly.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In terms of computational complexity, depersonalization is about the same as a few database archives with extreme compression. </font><font style="vertical-align: inherit;">The algorithm is roughly similar. </font><font style="vertical-align: inherit;">The difference is that archiving algorithms have been honed over the years and have reached almost maximum efficiency. </font><font style="vertical-align: inherit;">And depersonalization algorithms are written so that they at least work on the current base and are quite universal. </font><font style="vertical-align: inherit;">And software after depersonalization generally worked. </font><font style="vertical-align: inherit;">That is an excellent result - to grind 40 TB per night. </font><font style="vertical-align: inherit;">It so happens that it‚Äôs cheaper for the customer to drive the database into depersonalization once every six months for a week on a weak server - also an approach.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/fb/oz/xn/fbozxnaozpdrvta1pwhbpy0wjq0.png"><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How are data replaced?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Each data type changes according to the rules that can be used in the code. For example, if we replace the name with a random hash with special characters and numbers, then the very first data validation will immediately produce an error in real testing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, first the depersonalization system must determine what type of data is stored in the field. Depending on the vendor, different approaches are used, from manual markup to attempts to discover the database and auto-detect what is stored there. We have the practice of introducing all the major solutions in the market. We‚Äôll analyze one of the options when there is a wizard that tries to find data and ‚Äúguess‚Äù what kind of data is stored there.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ik/ay/pp/ikaypp08szz93wdulbekztz0l5a.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Naturally, to work with this software you need access to real data (usually this is a copy of a recent backup of the database). According to banking experience, we first sign a ton of papers for two months, and then we come to the bank, we are undressed, searched and dressed, then we go to a separate room, caged with a Faraday cage, in which there are two security guards and breathe warmly in the back of our heads. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, suppose, after all this, we see a table in which there is a field "Name". The wizard has already marked it for us as a name, and we can only confirm and choose the type of depersonalization. Wizard offers a random replacement for Slavic names (there are bases for different regions). We agree and get replacements like Ivan Ivanov Petrenko - Joseph Albertovich Chingachguk. If this is important, the gender is preserved, if not, replacements go throughout the database of names. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examples of replacements:</font></font><br>
<blockquote> .  -&gt;  <br>
  -&gt;  <br>
  -&gt;  <br>
  -&gt;  <br>
  -&gt;  -</blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next field is the date in Unixtime. Wizard determined this too, but we need to choose the depersonalization function. Usually, dates are used to control the sequence of events, and the situation when a client first made a transfer in a bank and then opened an account, nobody really needs to test. Therefore, we set a small delta - by default, within 30 days. There will still be errors, but if this is critical, you can configure more complex rules by adding your script to anonymization processing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The address must be validated, so the database of Russian addresses is used. The card number must correspond to the real numbers and be validated by them. Sometimes the task is to ‚Äúmake all Visas random Mastercards‚Äù - this is also feasible in a couple of clicks.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Under the hood of the wizard is the profiling. </font><font style="vertical-align: inherit;">Profiling is a search for data in a database according to predefined rules (attributes, domains). </font><font style="vertical-align: inherit;">In fact, we read each cell of the customer‚Äôs database, apply a set of regular expressions to each cell, compare the values ‚Äã‚Äãin this cell with dictionaries, etc. As a result, we have a set of triggered rules on the columns of the database tables. </font><font style="vertical-align: inherit;">We can configure profiling, we can not read all the tables in the database, we can take only a certain number of rows from the table or a certain percentage of rows.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/re/jf/pr/rejfprirtem5yix7i1fgryx00my.png"><br>
 <br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is going on inside?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For each entry in the database, the depersonalization rules that we have chosen apply. In this case, temporary tables are created for the duration of the process, where replacements are written. Each subsequent record in the database is run according to these replacement correspondence tables, and if there is a correspondence there, it is replaced in the same way as before. Everything is actually a little more complicated depending on your scripts and pattern matching rules (there may be an inaccurate replacement, for example, for childbirth or for replacing dates stored in a different format), but the general idea is that.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If there are marked-up correspondences ‚Äúthe name is Cyrillic - the name is Latin‚Äù, then they should be clearly indicated at the development stage, and then in the substitution table they will correspond to each other. That is, the name will be anonymized in Cyrillic, and then this anonymized entry will be converted to the Latin alphabet, for example. At this point, we are moving away from the ‚Äúdo not improve the quality of data in the system‚Äù approach, but this is one of the compromises that you have to make for the sake of some kind of system performance. Practice shows that if stressful, functional testing does not notice a compromise in its work, then there was nothing. And here comes the important point that depersonalization as a whole is not encryption. If you have a couple of yards of entries in the table, and in ten of them the TIN has not changed, then what? Nothing, these ten records can not be found.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the end of the process, the conversion tables remain in the protected database of the depersonalization server. </font><font style="vertical-align: inherit;">The base is cut (truncated) and passed to testing without conversion tables, thus, for the tester, depersonalization becomes irreversible. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The full anonymous database is passed to testers for stress testing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This means that while working with the database, the conversion table ‚Äúswells‚Äù (the exact amount depends on the choice of replacements and their type), but the working base remains the original size.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What does the process look like in the operator interface?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
General view of the IDE using one of the vendors as an example: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/mg/cv/hl/mgcvhlu-ji5kpthji20d69ymciq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debugger: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e9/cg/-g/e9cg-gh2ommj4thktnasi5226ms.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Starting a transformation from the IDE: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/jn/bu/nf/jnbunfxvs4uu1_yihw29nctjqom.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configuring an expression to search for sensitive data in the profiler: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/bg/v_/m1/bgv_m1xhie3afbc2sygwjxxqagc.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Page with a set of rules for the profiler: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ij/gc/hy/ijgchygguusqsm2pvu8dvvgmu_0.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result of the profiler, web page with data search:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tq/sl/rc/tqslrcat9rxq4x3dxeamxlckfqo.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is all data in the database masked?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No. Typically, the list of data for depersonalization is regulated by laws and standards of the sphere, plus the customer has suggestions for specific fields that no one should know about. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The logic is that if we mask the name of the patient in the hospital, you can mask or not mask the diagnosis - still no one will know who he is from. We had a case when notes on a transaction in a bank were simply masked in random letters. There were notes of the level: "The loan was refused, because the client came drunk, he vomited to the bar." From a debugging point of view, it's just a string of characters. Well, let her stay. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Example strategies:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1k/ke/ap/1kkeapcafujhhyz33tpxkoss3gy.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A dynamic seed table is a transcoding table into which we add the recoding that has already happened. </font><font style="vertical-align: inherit;">The hash can be very different and in the case of the same TIN, more often a new random TIN is generated with the first characters stored, with check digits.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is it possible to change data using the DBMS itself?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yes. When depersonalizing data, there are two main approaches - changing the data in the database using the database itself or organizing an ETL process and changing data using third-party software. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The key plus of the first approach is that you do not need to take data out of the database anywhere, there are no network costs, and fast and optimized database tools are used. The key minus is a separate development for each system, the lack of common conversion tables for different systems. Conversion tables are needed for reproducibility of depersonalization, further data integration between systems.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The key advantage of the second approach is that it doesn‚Äôt matter which database, system, file it is or some kind of web interface - once you implement a rule, you can use it everywhere. </font><font style="vertical-align: inherit;">The key minus is that you need to read data from the database, process it with a separate application, write it back to the database. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Practice shows that if the customer has a set of several systems that require further integration, then only the second approach can be implemented for the final cost in money, as well as for acceptable development times. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/99/0o/n8/990on8xrvxfl8hqeur9i_8donv8.png"><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That is, we can do anything we want, but the ETL approach has proven itself very well in the banking sector.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And why the data simply does not spoil manually?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This can be done once. </font><font style="vertical-align: inherit;">Someone will sit for three days, depersonalize a bunch of data and prepare a database of 500-1000 records. </font><font style="vertical-align: inherit;">The difficulty is that the process must be repeated regularly (with each change in the database structure and the appearance of new fields and tables) and in large volumes (for different types of testing). </font><font style="vertical-align: inherit;">A common request is to depersonalize the first 10-50 GB of the database so that this amount falls on each table evenly.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What to do if document scans are stored in the database?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If a document can be reduced to XML and converted back (for example, office documents), you can also depersonalize them. </font><font style="vertical-align: inherit;">But sometimes there are binaries like passport scans in PDF / JPG / TIFF / BMP. </font><font style="vertical-align: inherit;">In this case, the generally accepted practice is to supply similar documents with a third-party script and replace real ones with samples from the base of randomly generated ones. </font><font style="vertical-align: inherit;">The most difficult thing is with photographs, but there are services like </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that solve the issue in approximately the same way.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Who is responsible for what?</font></font></h3><br>
 <img src="https://habrastorage.org/webt/fu/vl/eq/fuvleqe09bpz3fp4g02v7g0vd7m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When updating after changing software or ‚Äúcatching up‚Äù, the processes are simpler.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But what if something goes wrong in the tests?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This usually happens. </font><font style="vertical-align: inherit;">First, testers, after the first depersonalization run, more precisely formulate the requirements for the database. </font><font style="vertical-align: inherit;">We can change the rules of depersonalization or reject records like ‚Äúhere the actions should go in chronological order, and not in a chaotic‚Äù. </font><font style="vertical-align: inherit;">Secondly, depending on the implementation, we either support depersonalization as the database changes, or leave all the documentation, descriptions of the database structure and processing types, transfer the entire processing code (rules in xml / sql) and train specialists from the customer.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to watch a demo?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The easiest way is to email me at PSemenov@technoserv.com.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490730/index.html">Intel x86 Root of Trust: loss of trust</a></li>
<li><a href="../en490732/index.html">Speech Recognition: A Very Short Introductory Course</a></li>
<li><a href="../en490734/index.html">Easter eggs on topographic maps of Switzerland</a></li>
<li><a href="../en490736/index.html">9 clear tools for learning and pumping English vocabulary</a></li>
<li><a href="../en490738/index.html">Lisk substitution principle</a></li>
<li><a href="../en490742/index.html">A new era in robotics has begun</a></li>
<li><a href="../en490746/index.html">Rating in Yandex.Taxi: a short post on a serious topic</a></li>
<li><a href="../en490748/index.html">The task for the developer, or how we scanned hand scanners without a vendor</a></li>
<li><a href="../en490750/index.html">Mikhail Salosin. Golang Meetup. Using Go in the backend of the Watch + application</a></li>
<li><a href="../en490754/index.html">Visual Studio Code Code Editor. The most detailed guide for setting up and installing plugins for beginners</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>