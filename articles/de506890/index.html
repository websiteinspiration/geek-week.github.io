<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßóüèø ‚õ©Ô∏è üç© Osterei in ionCube - ein Versuch von Entwicklern, M√ºll unter den Teppich zu kehren? ü§≥üèø üë©‚Äçüëß‚Äçüëß üîî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ein Webentwickler wei√ü, dass f√ºr kommerzielle Zwecke erstellte Skripte mit √ºberschriebenen Urheberrechten im Netzwerk spazieren gehen k√∂nnen. Es ist m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Osterei in ionCube - ein Versuch von Entwicklern, M√ºll unter den Teppich zu kehren?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/506890/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><div style="text-align:center;"><img src="https://habrastorage.org/webt/kc/lp/mo/kclpmoxrvrfvypeaomwmvyezwhu.jpeg"></div></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein Webentwickler wei√ü, dass f√ºr kommerzielle Zwecke erstellte Skripte mit √ºberschriebenen Urheberrechten im Netzwerk spazieren gehen k√∂nnen. </font><font style="vertical-align: inherit;">Es ist m√∂glich, dass das Skript im Auftrag einer anderen Person weiterverkauft wird. </font><font style="vertical-align: inherit;">Um den Quellcode des Skripts auszublenden und dessen √Ñnderung zu verhindern, werden Verschleierer, Minifizierer usw. verwendet. </font><font style="vertical-align: inherit;">Eines der √§ltesten und bekanntesten Tools zum Verschl√ºsseln von Skripten in PHP ist ionCube. </font><font style="vertical-align: inherit;">Es wurde 2002 eingef√ºhrt und √ºberwacht weiterhin die Entwicklung von PHP und erkl√§rt die Unterst√ºtzung f√ºr die neuesten Versionen der Plattform. </font><font style="vertical-align: inherit;">Wie ich in diesem Artikel zeigen werde, ist ionCube mit PHP 7-Unterst√ºtzung alles andere als in Ordnung ...</font></font><a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Modell f√ºr die Verwendung von PHP-Verschl√ºsselern ist so, dass der Programmierer ein verschl√ºsseltes Skript verkauft und der K√§ufer des Skripts auf seinem Server ein Erweiterungsmodul installieren muss, mit dem verschl√ºsselte Skripte ausgef√ºhrt werden k√∂nnen. </font><font style="vertical-align: inherit;">Das von ionCube verschl√ºsselte Skript sieht ungef√§hr so ‚Äã‚Äãaus:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span> <span class="hljs-comment">//0059b</span>
<span class="hljs-comment">// 10.2 72</span>
<span class="hljs-comment">// </span>
<span class="hljs-comment">// IONCUBE ONLINE ENCODER EVALUATION</span>
<span class="hljs-comment">// THIS FILE IS LICENSED TO BE USED FOR ENCODER TESTING</span>
<span class="hljs-comment">// PURPOSES ONLY AND SHOULD NOT BE DISTRIBUTED</span>
<span class="hljs-comment">// </span>
<span class="hljs-keyword">if</span>(!extension_loaded(<span class="hljs-string">'ionCube Loader'</span>)){$__oc=strtolower(substr(php_uname(),<span class="hljs-comment">//skipped</span><font></font>
<font></font>
<span class="hljs-meta">?&gt;</span><font></font>
HR+cPn5yR+EksbFLjyZwm7EQh7Q0Y6YO6pLddgsuLRlBWUC5JWhAm3KcPBcRdP9D0zkMmdPNk5VG<font></font>
rMP1GxIwsA5NinHkQjWqG2pHL5nIZUvatUW+XMas3Knjf4wz9+DJoq47N1qZLDXwVzpOOupqa+Y4<font></font>
k8PPXt8WNYXL4gbJnVu6NrqBqqwOrtlHUE9Sc30fMfAAEDTAVfa7ADHT2egTb5xxy9RGlDCjGlma<font></font>
RxoL1LvxvYcfe48f44x/H+GVTM7dPaYyy9DozcJjt3l8EDxcD73d67cWOtDgQGixQEmBlYJO7Cvh<font></font>
IAfeCBywIrDMgWfCC80uEIX+WtSmt/PuI7OXMgsNG3yVZu2HXJvXFRmXvc6748uxr+Zh0uZnAqeL<font></font>
pkJB5K9H5qbMr4YM/Aig+<span class="hljs-number">7</span>MhwVG3KJ0kQCEhKxJe7+<span class="hljs-number">7</span>Un/jSGcwQ8HKa/<span class="hljs-number">90</span>ePzH2EXazm3T87pf2<font></font>
hXL/exl4L7hutt/MfDGjculaEOCaoDLlUJjJqeXJL3kFDUsiPFfEL/BwAYUqe2pJAMjWXn7YIUt7<font></font>
Y1DdTUD4ob/<span class="hljs-number">5</span>fwE9wQwfG6PfDLPFkrGVKFpkBa95sRuA7qgtXATacXAVzsfYMxZgbwF3RcI5IxQo<font></font>
HTgnCg57vWmM/u6swJrgkz+<span class="hljs-number">747</span>DWZRS1TfJZnKbdbmWIHAW11HG2FloKdWWSIronfqnuXTI/j2/R
<span class="hljs-number">9</span>hX1Uim6mQowBwjS5zHZY8WFU9xE1KgETkCTsaDZODg9NYTICKs5aAdujzAtzxLWSicHZCfmpgzd<font></font>
FRhqYTYE1B9wktZsItkssDaq+xlyTZ+<span class="hljs-number">0</span>LGnXAC6eaH7npS7w3NRBRj9ySVTRYPXBraVuJViMIX+U
<span class="hljs-number">4</span>IzHJDFSNiT818GtS7erlLKcbGn4OZ40Ee3XEiicFzVrOfOvH0rJT3LZgVqY+KMtjqaQike2P4Dd<font></font>
A0SOuqOlFgQitYoo</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Benutzer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">haben lange bemerkt,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dass beim Laden des ionCube Loader-Moduls zwei globale Funktionen mit sehr seltsamen Namen in PHP angezeigt werden: </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;und </font></font><code>_dyuweyrj4r</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Wenn Sie eine dieser Funktionen aufrufen, druckt PHP einen der beiden chinesischen Aphorismen und schlie√üt die Ausf√ºhrung ab: </font><font style="vertical-align: inherit;">
Es ist ersichtlich, dass die Ausgabezeile nicht von der aufgerufenen Funktion abh√§ngt und zuf√§llig ausgew√§hlt wird. </font><font style="vertical-align: inherit;">
Es stellt sich die Frage: Warum werden diese Funktionen ben√∂tigt und was tun sie?</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(); echo 'Hmm..';"</b><br>
A rat who gnaws at a cat's tail invites destruction.<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4(); echo 'Hmm..';"</b><br>
Do good, reap good; do evil, reap evil.<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4r(); echo 'Hmm..';"</b><br>
Do good, reap good; do evil, reap evil.</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einfache Experimente</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lassen Sie uns zun√§chst sehen, welche Parameter </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">erforderlich sind: </font><font style="vertical-align: inherit;">
Es sieht so aus, als w√§ren zwei Zahlen erforderlich, aber unabh√§ngig davon, welche Zahlen dieselben Aphorismen drucken.</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(1,2,3);"</b><br>
PHP Warning: _dyuweyrj4() expects at most 2 parameters, 3 given in Standard input code on line 1<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4('foo', 'bar');"</b><br>
PHP Warning: _dyuweyrj4() expects parameter 1 to be int, string given in Standard input code on line 1<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4(1, 'bar');"</b><br>
PHP Warning: _dyuweyrj4() expects parameter 2 to be int, string given in Standard input code on line 1<br>
<br>
C:\php&gt;<b>php -r "_dyuweyrj4(1, 2);"</b><br>
A rat who gnaws at a cat's tail invites destruction.</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutzungssuche</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In einem schlammigen indonesischen Forum finde ich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ein Beispiel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das 2013 √ºberf√ºllt war </font><font style="vertical-align: inherit;">&nbsp;- h√∂chstwahrscheinlich von einem PHP-Bytecode-Disassembler erhalten:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tconnect</span>(<span class="hljs-params"> </span>)
</span>{<font></font>
    $__tmp = _dyuweyrj4( <span class="hljs-number">21711392</span>, <span class="hljs-number">920173696</span> );
    <span class="hljs-keyword">return</span> $__tmp[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tvariable</span>(<span class="hljs-params"> </span>)
</span>{<font></font>
    $__tmp = _dyuweyrj4( <span class="hljs-number">21720496</span>, <span class="hljs-number">920165136</span> );
    <span class="hljs-keyword">return</span> $__tmp[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist bei Zahlenpaaren (21711392, 920173696) und (21720496, 920165136) interessant? </font><font style="vertical-align: inherit;">Ein aufmerksamer Forscher wird feststellen, dass das XOR der Zahlen in jedem Paar 932443808 ergibt. Versuchen wir, </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mit ein paar Zahlen </font><font style="vertical-align: inherit;">anzurufen </font><font style="vertical-align: inherit;">, die das Ergebnis von XOR 932443808 ergeben: </font><font style="vertical-align: inherit;">
Es wurde nichts gedruckt!</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(0, 932443808);"</b></code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(932443808, 0);"</b></code><br>
<br>
<img src="https://habrastorage.org/webt/ap/ed/c8/apedc8vzemybnk6fcmzhfj3tiwu.png"><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eintauchen in den Debugger</font></font></font></h2><br>
<img src="https://habrastorage.org/webt/kz/cy/_i/kzcy_i1kqfmexamdktae0lwhuuu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir sehen, dass versucht wird, an der Adresse zu lesen </font></font><code>[ecx+40h]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, au√üerdem ist sie </font></font><code>ecx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;gleich </font></font><code>0x3793f6a0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;der Nummer, die wir an die Funktion √ºbergeben haben. Dies bedeutet, dass die Funktion erwartet, den Adresswert im PHP-Prozessspeicher als Parameter zu erhalten, und dem dword an der Adresse </font></font><code>[ecx+40h]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;einen hinzuf√ºgt (der Befehl </font></font><code>inc dword ptr [eax]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;ist direkt unter dem Cache-Punkt sichtbar). Lassen Sie uns versuchen, eine solche Adresse zu √ºbergeben: Dazu achten wir darauf, dass sich die Adresse, unter der das Hauptmodul php.exe geladen wird, erst nach einem Neustart von Windows √§ndert. In meinem Fall ist es </font></font><code>0x00980000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Beim √ñffnen von php.exe in der IDA sehen wir uns an, welche Daten zum Umschreiben verf√ºgbar sind: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/04/v4/fo/04v4foanwlcng6m_k0xopymi4ja.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versuchen wir als Experiment, den ersten Zeiger in der Struktur neu zu schreiben </font></font><code>cli_sapi_module</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Es gibt einen Link dazu von </font></font><code>main+22</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; Wenn Sie php.exe unter der Adresse herunterladen, befindet sich </font></font><code>0x00980000</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;dieser Link unter</font></font><code>0x00982d63</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;Wir m√ºssen also einen Wert </font><font style="vertical-align: inherit;">an die Funktion √ºbergeben </font><font style="vertical-align: inherit;">, der kleiner ist </font></font><code>0x40</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, d.h. </font></font><code>0x00982d23</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">
Wieder abst√ºrzen; aber in einer anderen Funktion innerhalb von ioncube_loader_win_7.3.dll. Interessanterweise hat die Adresse, an der der Nullzeiger gelesen </font><font style="vertical-align: inherit;">&nbsp;wurde, nichts mit dem an die Funktion √ºbergebenen Wert zu tun. (Es ist ironisch, dass die √úberpr√ºfung auf einen Nullzeiger - - </font><font style="vertical-align: inherit;">&nbsp;unmittelbar </font><b><font style="vertical-align: inherit;">nach dem</font></b><font style="vertical-align: inherit;"> &nbsp;Zugriff auf diesen Zeiger durchgef√ºhrt wird.) Nachdem </font><font style="vertical-align: inherit;">wir </font><font style="vertical-align: inherit;">den Speicher unter der Adresse betrachtet haben </font><font style="vertical-align: inherit;">, finden wir dort die Struktur </font><font style="vertical-align: inherit;">, d.h. Funktionsdefinition. Es ist am bequemsten, durch das Direktfenster hinein zu schauen: </font><font style="vertical-align: inherit;">
Wie Sie sehen k√∂nnen, ist der Nullzeiger, der den Absturz verursacht hat, das Feld </font><font style="vertical-align: inherit;">&nbsp;in der Funktionsdefinition</font></font><br>
<br>
<code>C:\php&gt;<b>php -r "_dyuweyrj4(0x00982d23, 0x00982d23 ^ 0x3793f6a0);"</b></code><br>
<br>
<img src="https://habrastorage.org/webt/kq/vd/n7/kqvdn7plaxnkhddfyucx_ktd_jk.png"><br>
<br><font style="vertical-align: inherit;"></font><code>0x14c32820+0x78</code><font style="vertical-align: inherit;"></font><code>test ebx, ebx</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><code>0x14c32820</code><font style="vertical-align: inherit;"></font><code>_zend_op_array</code><font style="vertical-align: inherit;"></font><br>
<br>
<code><b>(_zend_op_array*)0x14c32820</b><br>
0x14c32820 {type=0x01 '\x1' arg_flags=0x14c32821 "" fn_flags=0x00000100 ...}<br>
&nbsp; &nbsp; type: 0x01 '\x1'<br>
&nbsp; &nbsp; arg_flags: 0x14c32821 ""<br>
&nbsp; &nbsp; fn_flags: 0x00000100<br>
&nbsp; &nbsp; function_name: 0x06f66850 {gc={refcount=0x00000001 u={type_info=0x000001c6 } } h=0xacaf1bdb len=0x0000000a ...}<br>
&nbsp; &nbsp; scope: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; prototype: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; num_args: 0x00000000<br>
&nbsp; &nbsp; required_num_args: 0x00000000<br>
&nbsp; &nbsp; arg_info: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; cache_size: 0x131183d0<br>
&nbsp; &nbsp; last_var: 0x06ee0e98<br>
&nbsp; &nbsp; T: 0x00000000<br>
&nbsp; &nbsp; last: 0x00000000<br>
&nbsp; &nbsp; opcodes: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; run_time_cache: 0x00000000 {???}<br>
&nbsp; &nbsp; static_variables: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; vars: 0x00000000 {???}<br>
&nbsp; &nbsp; refcount: 0x600df45e {???}<br>
&nbsp; &nbsp; last_live_range: 0x88008c00<br>
&nbsp; &nbsp; last_try_catch: 0x00000001<br>
&nbsp; &nbsp; live_range: 0x00000100 {var=??? start=??? end=??? }<br>
&nbsp; &nbsp; try_catch_array: 0x14c2d958 {try_op=0x00000001 catch_op=0x000001c6 finally_op=0xddab5409 ...}<br>
&nbsp; &nbsp; filename: 0x14c1a538 {gc={refcount=0x00000001 u={type_info=0x14c00668 } } h=0x00000000 len=0x00000001 ...}<br>
&nbsp; &nbsp; line_start: 0x00000000<br>
&nbsp; &nbsp; line_end: 0x00000002<br>
&nbsp; &nbsp; doc_comment: 0x00000002 {gc={refcount=??? u={type_info=??? } } h=??? len=??? ...}<br>
&nbsp; &nbsp; last_literal: 0x714beccc<br>
&nbsp; &nbsp; literals: 0x71180110 {php7.dll!zif_xmlwriter_write_pi(_zend_execute_data *, _zval_struct *)} {value={lval=0x3314ec83 ...} ...}<br>
&nbsp; &nbsp; reserved: 0x14c3288c {0x06ee0bc0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000}<br>
<br>
<b>((_zend_op_array*)0x14c32820)-&gt;function_name</b><br>
0x06f66850 {gc={refcount=0x00000001 u={type_info=0x000001c6 } } h=0xacaf1bdb len=0x0000000a ...}<br>
&nbsp; &nbsp; gc: {refcount=0x00000001 u={type_info=0x000001c6 } }<br>
&nbsp; &nbsp; h: 0xacaf1bdb<br>
&nbsp; &nbsp; len: 0x0000000a<br>
&nbsp; &nbsp; val: 0x06f66860 "_dyuweyrj4"<br>
<br>
<b>&amp;((_zend_op_array*)0)-&gt;reserved[3]</b><br>
0x00000078 {???}</code><br>
<br><font style="vertical-align: inherit;"></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Anscheinend wird dieses Feld von ionCube Loader f√ºr einige seiner internen Zwecke verwendet. </font><font style="vertical-align: inherit;">Lassen Sie uns zur √úberpr√ºfung die Datei in einer Zeile ausf√ºhren</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span> _dyuweyrj4(<span class="hljs-number">0x00982d23</span>, <span class="hljs-number">0x00982d23</span> ^ <span class="hljs-number">0x3793f6a0</span>);</code></pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- √ºber ihren </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Online-PHP-Encoder</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">(Das Ergebnis der Verschl√ºsselung wird ganz am Anfang des Beitrags angegeben.) Leider hilft dies nicht: Es </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;bleibt Null. </font><font style="vertical-align: inherit;">Wir stellen jedoch sicher, dass die ausf√ºhrende (namenlose) Funktion </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jetzt ausgef√ºllt ist:</font></font><br>
<br>
<code><b>executor_globals.current_execute_data-&gt;func-&gt;op_array</b><br>
{type=0x02 '\x2' arg_flags=0x14a72141 "" fn_flags=0x08000000 ...}<br>
&nbsp; &nbsp; type: 0x02 '\x2'<br>
&nbsp; &nbsp; arg_flags: 0x14a72141 ""<br>
&nbsp; &nbsp; fn_flags: 0x08000000<br>
&nbsp; &nbsp; function_name: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; scope: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; prototype: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; num_args: 0x00000000<br>
&nbsp; &nbsp; required_num_args: 0x00000000<br>
&nbsp; &nbsp; arg_info: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; cache_size: 0x00000004<br>
&nbsp; &nbsp; last_var: 0x00000000<br>
&nbsp; &nbsp; T: 0x00000001<br>
&nbsp; &nbsp; last: 0x00000005<br>
&nbsp; &nbsp; opcodes: 0x14a72280 {handler=0x999fc7ce op1={constant=0x00000000 var=0x00000000 num=0x00000000 ...} op2={constant=...} ...}<br>
&nbsp; &nbsp; run_time_cache: 0x14a74018 {0x14c27ba0}<br>
&nbsp; &nbsp; static_variables: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; vars: 0x00000000 {???}<br>
&nbsp; &nbsp; refcount: 0x14a74030 {0x00000002}<br>
&nbsp; &nbsp; last_live_range: 0x00000000<br>
&nbsp; &nbsp; last_try_catch: 0x00000000<br>
&nbsp; &nbsp; live_range: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; try_catch_array: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; filename: 0x14a66230 {gc={refcount=0x00000001 u={type_info=0x00000006 } } h=0x00000000 len=0x00000032 ...}<br>
&nbsp; &nbsp; line_start: 0x00200001<br>
&nbsp; &nbsp; line_end: 0x00000001<br>
&nbsp; &nbsp; doc_comment: 0x00000000 &lt;NULL&gt;<br>
&nbsp; &nbsp; last_literal: 0x00000005<br>
&nbsp; &nbsp; literals: 0x14a66280 {value={lval=0x0716a738 dval=5.875681226702e-316#DEN counted=0x0716a738 {gc={refcount=0x00000001 ...} } ...} ...}<br>
&nbsp; &nbsp; reserved: 0x14a721ac {0x00000000, 0x00000000, 0x00000000, 0x14a6b200, 0x00000000, 0x00000000}</code><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bug mit einem Bug rausgeschmissen</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie wir sehen k√∂nnen, ist </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;es nur mit verschl√ºsselten Funktionen gef√ºllt. (Dies ist nicht das einzige Unterscheidungsmerkmal: Auf dem obigen Ausdruck k√∂nnen Sie </font></font><code>line_start=0x00200001</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;anstelle einer plausiblen Zeilennummer </font><font style="vertical-align: inherit;">auch feststellen </font><font style="vertical-align: inherit;">, dass der Zeiger, auf </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">den in die abgest√ºrzte Funktion gelangt </font><font style="vertical-align: inherit;">, dem Zeiger </font><font style="vertical-align: inherit;">entnommen wird, der </font></font><code>execute_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">im </font></font><code>_dyuweyrj4</code>&nbsp;<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">impliziten ersten Parameter √ºbergeben wurde</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;- dies </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;entspricht </font><font style="vertical-align: inherit;">also </font><font style="vertical-align: inherit;">immer der aufgerufenen Funktion n√§mlich selbst </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Diese Funktion ist nicht verschl√ºsselt und daher </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;immer Null. Wir schlie√üen daraus: Ein Aufruf </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;mit den ‚Äûrichtigen‚Äú Parametern </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√ºhrt zwangsl√§ufig zu einem Absturz</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;(und mit den falschen, wie wir gesehen haben - an die Presse der chinesischen Aphorismen). Das Tolle daran ist, dass der resultierende Absturz nicht beabsichtigt ist, sondern vor der √úberpr√ºfung mit einem Nullzeiger aufgerufen wird. Ein solcher Fehler im Code w√ºrde jedes statische Analysewerkzeug auffangen. aber anscheinend verwenden sie so etwas in ionCube nicht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was passiert, wenn ich einen Fehler in ioncube_loader_win_7.3.dll behebe, indem ich vor der Verwendung eine Zeigerpr√ºfung setze? Aus diesem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Grund</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist es am bequemsten, </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">x64dbg</font></a><font style="vertical-align: inherit;"> zu verwenden </font><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/j1/mh/zd/j1mhzdzqh5k-lgme_k8awtppxw0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir beginnen </font></font><code>php -r "_dyuweyrj4(0x00982d23, 0x00982d23 ^ 0x3793f6a0);"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;mit dem gepatchten ionCube Loader und ... wir bekommen den Absturz an einer neuen Stelle - wieder bei Verwendung des Nullzeigers von </font></font><code>_zend_op_array.reserved[3]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ji/al/nx/jialnxbvufmj0dvqgc2s19thaxs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das bedeutet, dass die (falsche) Pr√ºfung auf einen Nullzeiger keinen Sinn hatte: In der n√§chsten aufgerufenen Funktion wird derselbe Zeiger ohne Pr√ºfung verwendet. </font><font style="vertical-align: inherit;">Wir schlie√üen daraus, dass eine potenzielle Sicherheitsanf√§lligkeit, die es uns erm√∂glichen w√ºrde, den Speicher des PHP-Prozesses an einer beliebigen Adresse zu √§ndern und dadurch aus der Sandbox zu entkommen - beispielsweise Aufruffunktionen, die vom Serveradministrator nicht zugelassen werden - in ionCube Loader durch eine Folge von Fehlern geschlossen wird, die zum unbeabsichtigten Cache php.exe f√ºhren .</font></font><br>
<br>
<h2><font color="#3AC1EF"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was meinte der Autor?</font></font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich glaube, dass es anfangs </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;erschien, um ein formal korrektes Array von </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vertuschungen </font><font style="vertical-align: inherit;">an verschl√ºsselte Funktionen zu binden </font><font style="vertical-align: inherit;">- weil ionCube Loader bei weitem nicht das einzige Erweiterungsmodul ist, das in diese Arrays kriecht. (Einer der h√§ufigsten F√§lle, in denen Erweiterungen in die </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funktion s gelangen, besteht darin, diese </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zwischen den L√§ufen desselben Skripts zwischenzuspeichern. Der andere </font><font style="vertical-align: inherit;">Fall </font><font style="vertical-align: inherit;">sind PHP-Disassembler, wie die Ausgabe aus dem indonesischen Forum.) Ich habe </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;einen Zeiger auf das </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;verschl√ºsselte </font><font style="vertical-align: inherit;">Argument erhalten </font><font style="vertical-align: inherit;">Funktionen und √ºbergab die Steuerung an den Entschl√ºsseler, durch den ionCube Loader die Standardfunktion ersetzt </font></font><code>zend_execute_ex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Das einzige Szenario, in dem es </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;aufgerufen werden k√∂nnte, ist, wenn das externe Erweiterungsmodul zwischengespeichert wird. "</font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vertuschungen "getrennt von der verschl√ºsselten Funktion und versuchen dann, </font></font><code>zend_op</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diese auszuf√ºhren. In diesem Fall f√ºhrt ein Aufruf </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;mit einem Zeiger auf die </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;verschl√ºsselte Funktion zu einer Entschl√ºsselung und einem Start dieser Funktion selbst. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beim Wechsel zu PHP 7 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√§nderte sich der</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> &nbsp;ABI der Erweiterungsfunktionen: Anstelle von vier impliziten Parametern </font></font><code>ht, return_value_ptr, this_ptr, return_value_used</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;, Die Struktur wird verwendet </font></font><code>_zend_execute_data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Hier sind ionCube-Programmierer verwirrt, weil sie </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;jetzt zwei Zeiger erhalten auf </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: einen durch das Feld </font></font><code>_zend_execute_data.func</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, den zweiten durch den explizit √ºbergebenen Parameter. Der erste entspricht der </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zweiten, der verschl√ºsselten Funktion, die aufgerufen werden muss. Und hier sehen wir einen weiteren Fehler: das Inkrementieren des Feldes </font></font><code>refcount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;verschl√ºsselte Funktion, </font></font><code>_dyuweyrj4</code>&nbsp;<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vergisst es komplett</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und arbeitet weiter nur mit seinen eigenen </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Der Versuch, eine Erweiterungsfunktion wie eine verschl√ºsselte PHP-Funktion aufzurufen, f√ºhrt nat√ºrlich zu einem Absturz - und es ist gut, dass sie keine unendliche Rekursion verursacht, da sie </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;versucht, sich selbst aufzurufen! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es stellt sich die Frage: Wie hat die Qualit√§tssicherung in ionCube die Funktion verfehlt, die nie wie beabsichtigt funktionieren konnte? </font><font style="vertical-align: inherit;">Die Tatsache, dass es nicht in den Testplan fiel, ist auch offensichtlich, weil in der 64-Bit-Version von ionCube Loader die Parameter </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;32-Bit bleiben - dies bedeutet, dass der Zeiger auf die </font></font><code>_zend_op_array</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;verschl√ºsselte Funktion bereits vor dem Inkrement auf 32 Bit abgeschnitten </font></font><code>refcount</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wird und dieser Absturz Das haben wir gleich beim ersten Mal mitbekommen, was bei jedem Anruf garantiert passiert </font></font><code>_dyuweyrj4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/gu/ab/cg/guabcgmwuqoopx1ar80sjpz6keq.png"></a><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/de/0y/l-/de0yl-6ppopvisr_a80b4yuhjj8.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de506872/index.html">Buchen Sie Spring Boot 2: Best Practices f√ºr Profis</a></li>
<li><a href="../de506874/index.html">Aus dem Leben eines Programmierers: Gesch√§ftsleute</a></li>
<li><a href="../de506880/index.html">Joel Spolsky: Wie die Stack Overflow-√Ñra begann</a></li>
<li><a href="../de506886/index.html">Life Hack f√ºr Bits</a></li>
<li><a href="../de506888/index.html">Spickzettel f√ºr Data Science sortieren</a></li>
<li><a href="../de506896/index.html">Die realistischste Interpretation der Quantenmechanik</a></li>
<li><a href="../de506902/index.html">Smart Home in einer Smart City</a></li>
<li><a href="../de506906/index.html">Paradoxe des Schwarzen Lochs offenbaren den grundlegenden Zusammenhang zwischen Energie und Ordnung</a></li>
<li><a href="../de506908/index.html">Spitzenwissenschaft. Mai Medien 10: Verzweiflung von Aquarienfischen, Stimmen von psychischen St√∂rungen und oft COVID</a></li>
<li><a href="../de506916/index.html">Was ist ein Service Mesh?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>