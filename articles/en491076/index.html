<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôç ‚òùÔ∏è üë®üèæ‚Äçüíª Clever work with RabbitMQ in NestJS ü§ö üõåüèø üë©‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing financial systems, standard mechanisms for processing completed tasks in most implementations of the AMQP protocol are not always suit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Clever work with RabbitMQ in NestJS</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/491076/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When developing financial systems, standard mechanisms for processing completed tasks in most implementations of the AMQP protocol are not always suitable. </font><font style="vertical-align: inherit;">At some point, we encountered such a problem, but first things first.</font></font><br>
<br>
<a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The standard implementation of RabbitMQ in NestJS makes it easy to receive messages in decorated functions:</font></font><br>
<br>
<pre><code class="javascript hljs">@MessagePattern(<span class="hljs-string">'notifications'</span>)<font></font>
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {<font></font>
  <span class="hljs-built_in">console</span>.log(context.getMessage());<font></font>
}<font></font>
</code></pre><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">More details on how this works are described here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also work with queues in Nest was well covered in this article on Habr√©</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It would seem that something else might be needed. </font><font style="vertical-align: inherit;">However, there are a number of disadvantages in the current implementation.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem 1</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In order to send the ack result to a channel, you need to manually pull the channel out of the RmqContext context and send a signal to it.</font></font><br>
<br>
<pre><code class="javascript hljs">@MessagePattern(<span class="hljs-string">'notifications'</span>)<font></font>
getNotifications(@Payload() data: number[], @Ctx() context: RmqContext) {<font></font>
  <span class="hljs-keyword">const</span> channel = context.getChannelRef();
  <span class="hljs-keyword">const</span> originalMsg = context.getMessage();<font></font>
  channel.ack(originalMsg);<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decision</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Use the same pattern that was used when working with http handlers by returning the result of execution directly from the function as a regular object, Promise or Observable.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem 2</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you need to send the result in a separate queue, then in each controller that uses Rabbit you need to know its name. </font><font style="vertical-align: inherit;">In other words, there is no way to configure this in 1 place during module initialization and use it implicitly.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decision</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the module configuration stage, specify the queues for successful results of operations and for errors. </font><font style="vertical-align: inherit;">We decided to send the results of successful operations in one queue, and the results of erroneous ones in another. </font><font style="vertical-align: inherit;">Using the solution to problem 1, if the return value, Promise or Observable is successful, the result is sent to the successful operation queue, if not, the message is rejected and falls into the error queue, RabbitMQ makes it easy to do this using the x-dead options -letter-exchange and x-dead-letter-routing-key when creating the queue.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem 3</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a library user, the developer needs to know the details of the AMQP protocol to get the id of the next message, understand what ack is and when to call it, etc.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decision</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add a decorator to get the id of the message. </font><font style="vertical-align: inherit;">Instead of ack, return the result of the execution from the handler function.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problem 4</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps the most important problem: delivering a message to the handler more than once. When it comes to financial transactions, this is a very important point, because a situation may arise when the money has already been sent, and the operation fell at the last step - when writing to the database or sending acknowledgment message to the message broker. One of the obvious solutions is to write the message ID generated by the producer in the database when the message is received by the consumer, before processing the message, if it is not already there, if there is one, then reject the message. But the AMQP protocol provides a redelivered flag identifying whether this message was ever delivered to other clients, which we can use to detect re-delivered messages and send them to the queue with errors.In the current implementation in Nest, there is no way to not deliver such messages.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decision</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not deliver this message to the handler, but log the error at the stage of receiving the message from the driver. </font><font style="vertical-align: inherit;">Of course, this behavior can be made configurable at the stage of decorating the method to explicitly indicate that we still want to receive messages for this type of action. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To solve all of the above problems, its own implementation of the protocol was written. </font><font style="vertical-align: inherit;">What initialization looks like:</font></font><br>
<br>
<pre><code class="javascript hljs"><span class="hljs-keyword">const</span> amqp = <span class="hljs-keyword">await</span> NestFactory.create(<font></font>
 RabbitModule.forRoot({<font></font>
   <span class="hljs-attr">host</span>: process.env.AMQP_QUEUE_HOST,
   <span class="hljs-attr">port</span>: <span class="hljs-built_in">parseInt</span>(process.env.AMQP_QUEUE_PORT, <span class="hljs-number">10</span>),
   <span class="hljs-attr">login</span>: process.env.AMQP_QUEUE_LOGIN,
   <span class="hljs-attr">password</span>: process.env.AMQP_QUEUE_PASSWORD,
   <span class="hljs-attr">tasksQueueNormal</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST,
   <span class="hljs-attr">tasksQueueRedelivery</span>: process.env.AMQP_QUEUE_REQUEST_ONCE_DELIVERY,
   <span class="hljs-attr">deadLetterRoutingKey</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST_DEAD_LETTER,
   <span class="hljs-attr">deadLetterRoutingKeyRedelivery</span>: process.env.AMQP_QUEUE_COMMAND_REQUEST_ONCE_DELEVERY_DEAD_LETTER,
   <span class="hljs-attr">exchange</span>: process.env.AMQP_EXCHANGE_COMMAND,
   <span class="hljs-attr">prefetch</span>: <span class="hljs-built_in">parseInt</span>(process.env.AMQP_QUEUE_PREFETCH, <span class="hljs-number">10</span>),<font></font>
 }),<font></font>
);<font></font>
<span class="hljs-keyword">const</span> transport = amqp.get&lt;RabbitTransport&gt;(RabbitTransport);<font></font>
app.connectMicroservice({<font></font>
 <span class="hljs-attr">strategy</span>: transport,
 <span class="hljs-attr">options</span>: {},<font></font>
});<font></font>
<font></font>
app.startAllMicroservices();<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we indicate the names of the queues for delivering messages, results and errors, as well as individual queues that are not sensitive to redelivery. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the controller level, the work is as similar as working with http</font></font><br>
<br>
<pre><code class="javascript hljs">@AMQP(‚Äòsay_hey‚Äô)<font></font>
sayHay(@AMQPRequest requestId: string, @AMQPParam q: HeyMessage): Observable&lt;Result&gt; {<font></font>
 <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.heyService.greet(requestId, q);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result of the task will fall into the result queue as soon as this Observable is executed. </font><font style="vertical-align: inherit;">The parameter decorated with @AMQPRequest corresponds to the correlationId field of the protocol. </font><font style="vertical-align: inherit;">This is a unique identifier for the delivered message. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The @AMQPParam parameter matches the message body itself. </font><font style="vertical-align: inherit;">If it is JSON, then the message will arrive in the function already converted to the object. </font><font style="vertical-align: inherit;">If it is a simple type, then the message is sent as is. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following message will be in the dead letter:</font></font><br>
<br>
<pre><code class="javascript hljs">@AMQP(‚Äòsay_hey‚Äô)<font></font>
sayHayErr(@AMQPRequest requestId: string, @AMQPParam q: HeyMessage): Observable&lt;Result&gt; {<font></font>
 <span class="hljs-keyword">return</span> throwError(‚ÄòBuy‚Äô);<font></font>
}<font></font>
</code></pre><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What's up</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Add Type Reflection to AMQPParam so that the message body is converted to the class being passed. </font><font style="vertical-align: inherit;">Now it‚Äôs just a caste to type. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All code and installation instructions </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are available on GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Any edits and comments are welcome.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en491052/index.html">How and why curators at the St. Petersburg HSE help freshmen programmers</a></li>
<li><a href="../en491054/index.html">How to sign email correspondence with a GPG key using PKCS # 11 tokens</a></li>
<li><a href="../en491056/index.html">Ampere Altra - the world's first 80-core ARM processor</a></li>
<li><a href="../en491058/index.html">Mortality, mortality, coronavirus and matan</a></li>
<li><a href="../en491062/index.html">Angular: creating a custom form element and passing form state to it</a></li>
<li><a href="../en491084/index.html">saneex.c: try / catch / finally based on setjmp / longjmp (C99) faster than standard C ++ exceptions ¬π</a></li>
<li><a href="../en491086/index.html">Webix JavaScript library through the eyes of a beginner. Part 6. Server interaction</a></li>
<li><a href="../en491088/index.html">GitHub: New Open Source Library for OSINT</a></li>
<li><a href="../en491090/index.html">Convert text documents to xml in C #</a></li>
<li><a href="../en491092/index.html">How Crash Bandicoot Hacked Playstation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>