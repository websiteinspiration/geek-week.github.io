<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚤 👷🏻 ♊️ EF Core + Oracle: cómo hacer que las migraciones sean idempotentes 🏥 👰🏻 😡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Por lo general, el marco EF Core se usa junto con MS SQL, otro producto de Microsoft. Sin embargo, esto no es un dogma. Por ejemplo, en CUSTIS escribi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>EF Core + Oracle: cómo hacer que las migraciones sean idempotentes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/494278/"><img src="https://habrastorage.org/webt/3a/lj/or/3aljorcjihhefstlxuybizl-3tg.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo general, el marco EF Core se usa junto con MS SQL, otro producto de Microsoft. </font><font style="vertical-align: inherit;">Sin embargo, esto no es un dogma. </font><font style="vertical-align: inherit;">Por ejemplo, en CUSTIS escribimos lógica de negocios en C #, y usamos Oracle para administrar las bases de datos. </font><font style="vertical-align: inherit;">EF Core tiene un maravilloso mecanismo de migración, pero en nuestro caso no son idempotentes. </font><font style="vertical-align: inherit;">El hecho es que Oracle y otras bases de datos, como MySQL, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no admiten DDL transaccional</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Esto significa que si la migración cae en algún punto intermedio, no se puede revertir ni revertir. </font><font style="vertical-align: inherit;">¿Cómo implementar migraciones idempotentes a EF Core sin MS SQL?</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antecedentes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nuestra compañía tiene una herramienta bastante poderosa para instalar parches en una base de datos Oracle, que usamos en varios proyectos. </font><font style="vertical-align: inherit;">Fue escrito cuando no hubo Liquibase, migraciones EF y otras herramientas abiertas. </font><font style="vertical-align: inherit;">Patcher le permite trabajar con cientos de bases de datos, rastrear el historial de instalación, ver registros, almacenar secretos y mucho más. </font><font style="vertical-align: inherit;">Las secuencias de comandos para cambiar la base de datos se escriben en forma de macros SQL o m4. </font><font style="vertical-align: inherit;">Con su ayuda, puede, entre otras cosas, modificar la estructura: crear tablas, columnas y otros objetos. </font><font style="vertical-align: inherit;">Además, las macros m4 son idempotentes. </font><font style="vertical-align: inherit;">Esto significa que si intenta crear, por ejemplo, la tabla, el script no se cae, pero ve que ya existe y omite la creación. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supongamos que un script para instalar un parche consta de dos operaciones:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear tabla A.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creando la Tabla B.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si la secuencia de comandos falla después de la primera operación, la tabla A permanecerá en Oracle. Volver a aplicar el parche funcionará correctamente: la secuencia de comandos verificará que A ya existe, por lo que pasará inmediatamente a la segunda operación. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Además de las ventajas, el parcheador todavía tiene un inconveniente: la herramienta está cerrada y solo se usa en CUSTIS. Los desarrolladores tienen que aprender a trabajar con él y, fuera de la empresa, esa experiencia no es muy valiosa. Además, el parcheador no admite el modo de operación Code First, por lo que todos los scripts para cambiar la estructura de la base de datos deben escribirse manualmente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Queríamos probar un mecanismo listo para instalar parches y elegimos la migración. A finales de 2019, se acaba de lanzar otro proyecto para el cliente, en el que decidimos probar un nuevo enfoque. El principal problema de este mecanismo era la no idepotencia de las migraciones.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problema</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En MS SQL, una cadena de instrucciones DDL o migración se realiza como una transacción compuesta única. </font><font style="vertical-align: inherit;">En caso de interrupción, la operación se cancela por completo. </font><font style="vertical-align: inherit;">Oracle DDL no es transaccional, por lo que una caída en la migración conducirá a un estado inconsistente de la base de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Volvamos al parche, que consiste en dos operaciones: crear las tablas A y B. Si el migrador cae después de la primera, Oracle permanecerá en la tabla A. El reinicio no funcionará; al operador </font></font><code>CREATE TABLE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no le gustará que A ya exista. </font><font style="vertical-align: inherit;">También fallará en revertir la migración: EF Core escribe en la tabla del sistema que la migración se completó, solo al final del proceso. </font><font style="vertical-align: inherit;">Desde el punto de vista de EF Core, si la migración aún no se ha completado, entonces no hay nada que retroceder.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisión</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La búsqueda de una solución preparada para Oracle en Internet no arrojó resultados. Todo lo que he encontrado son artículos sobre cómo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">escribir</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e&nbsp; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instalar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> parches cuando trabajo con EF. Un poco más tarde en StackOverflow se me ocurrió la idea de hacer mi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMigrationsSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Esta interfaz es responsable de generar código SQL que procesa las operaciones de EF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El paquete </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oracle.EntityFrameworkCore</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> incluyó OracleMigrationsSqlGenerator, implementa IMigrationsSqlGenerator. Por ejemplo, si desea agregar una columna, se generará el siguiente código:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> MY_TABLE <span class="hljs-keyword">ADD</span> (MY_COLUMN <span class="hljs-built_in">DATE</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, el código se pasa a otras clases para ejecutarse en la base de datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para comenzar, intenté anular un par de operaciones OracleMigrationsSqlGenerator. </font><font style="vertical-align: inherit;">La tarea resultó ser bastante factible, y comencé a escribir un migrante idempotente. </font><font style="vertical-align: inherit;">Así es como surgió </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CUSTIS.OracleIdempotentSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de la operación EF, nuestro migrador verifica si se ha realizado antes. </font><font style="vertical-align: inherit;">Por ejemplo, se agrega una columna como esta:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">DECLARE</span>
    i <span class="hljs-built_in">NUMBER</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">COUNT</span>(*) <span class="hljs-keyword">INTO</span> i
    <span class="hljs-keyword">FROM</span> user_tab_columns
    <span class="hljs-keyword">WHERE</span> table_name = <span class="hljs-keyword">UPPER</span>(<span class="hljs-string">'MY_TABLE'</span>) <span class="hljs-keyword">AND</span> column_name = <span class="hljs-keyword">UPPER</span>(<span class="hljs-string">'MY_COLUMN'</span>);<font></font>
    IF I != 1 THEN<font></font>
        <span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">IMMEDIATE</span> <span class="hljs-string">'ALTER TABLE MY_TABLE ADD (MY_COLUMN DATE)'</span>;  
    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;       
<span class="hljs-keyword">END</span>;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilizando</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usar el paquete es muy simple: solo necesita reemplazarlo </font></font><code>IMigrationsSqlGenerator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en el contexto correcto:</font></font><br>
<br>
<pre><code class="cs hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyDbContext</span> : <span class="hljs-title">DbContext</span><font></font>
{<font></font>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnConfiguring</span>(<span class="hljs-params">DbContextOptionsBuilder optionsBuilder</span>)</span><font></font>
    {<font></font>
        optionsBuilder.ReplaceService&lt;IMigrationsSqlGenerator, IdempotentSqlGenerator&gt;();<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las migraciones se forman y establecen mediante las </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">herramientas estándar para EF Core</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cs hljs">dotnet ef migrations <span class="hljs-keyword">add</span> v1<span class="hljs-number">.0</span><span class="hljs-number">.1</span>
dotnet ef database update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El enfoque general establecido en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CUSTIS.OracleIdempotentSqlGenerator</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se puede implementar en generadores escritos para MySQL, MariaDB, Teradata, AmazonAurora y otras bases de datos en las que DDL no es transaccional.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referencias</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El paquete está disponible en NuGet </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources en GitHub</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es494264/index.html">Clúster de dos nodos: el diablo en detalle</a></li>
<li><a href="../es494266/index.html">Acerca de udalenka, RDP sin protección y el aumento en el número de servidores disponibles en Internet</a></li>
<li><a href="../es494270/index.html">Antigüedades: trabajo remoto en dispositivos de 1998</a></li>
<li><a href="../es494272/index.html">Creación de un plan de negocio de inicio de TI: estructura detallada paso a paso</a></li>
<li><a href="../es494274/index.html">Sistema de autotest de comercio electrónico</a></li>
<li><a href="../es494284/index.html">Antiséptico casero de lo que hay en la farmacia. Hacemos alcohol con vodka sin alcohol a la antigua usanza</a></li>
<li><a href="../es494286/index.html">Embox RTOS en Raspberry Pi</a></li>
<li><a href="../es494290/index.html">#YAMYWork. Una decisión que puede ser correcta</a></li>
<li><a href="../es494292/index.html">Wrike: 5 años con OKR</a></li>
<li><a href="../es494294/index.html">Impresión 3D certificada para las industrias de petróleo y gas y marina.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>