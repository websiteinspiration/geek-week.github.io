<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌷 🕧 👷 Kami memompa treadmill 💍 🍺 🤰🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Baru-baru ini, saya memutuskan pembelian yang sangat aneh untuk diri saya sendiri. Ya, saya membeli treadmill. 
 
 
 
 Dan segera kesadaran itu datang...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Kami memompa treadmill</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502368/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baru-baru ini, saya memutuskan pembelian yang sangat aneh untuk diri saya sendiri. </font><font style="vertical-align: inherit;">Ya, saya membeli treadmill. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iw/er/bm/iwerbme5xz1jbn_rah5ihonnyv4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan segera kesadaran itu datang kepada saya bahwa tidak ada statistik yang cukup rinci seperti ketika mengendarai sepeda. </font><font style="vertical-align: inherit;">Dalam kasus sepeda, aplikasi di telepon menulis kecepatan, detak jantung, irama, dan angkat saya. </font><font style="vertical-align: inherit;">Sangat penasaran untuk mengontrol semua parameter ini selama pelatihan, untuk dapat melihat grafik dan membandingkan hasil Anda dari waktu ke waktu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi saya memutuskan untuk melakukan sesuatu yang mirip dengan treadmill: hubungkan ke smartphone atau tablet untuk mengumpulkan dan menampilkan statistik.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti biasa, cerita saya dalam bentuk artikel teks tradisional, dan melalui video. </font><font style="vertical-align: inherit;">Anda lebih suka.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video</font></font></h2><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ChTILq0P7Ok" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artikel</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rancangan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bahkan pada saat saya mengumpulkan treadmill, saya perhatikan bahwa remote control dan sabuk pengaman itu sendiri hanya menghubungkan empat kabel. Rupanya, beberapa dari mereka digunakan untuk menyalakan konsol, karena kanvas itu sendiri terhubung ke jaringan 220 volt, dan kabel yang tersisa diperlukan untuk mengirimkan sinyal kontrol dalam arah yang berlawanan - dari konsol ke kanvas, mereka mengontrol kecepatan dan sudut trek. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya menghubungkan paralel osiloskop ke kabel-kabel ini, mencoba berbagai kombinasi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akibatnya, saya menemukan bahwa semuanya hampir sama dengan yang saya harapkan. Salah satu kabel ground, dan yang lainnya adalah daya 12 volt. Sisanya mengirimkan data digital.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di salah satu dari mereka, sinyal berubah ketika mengganti kecepatan dan sudut. </font><font style="vertical-align: inherit;">Inilah yang saya butuhkan! </font><font style="vertical-align: inherit;">Amplitudo sinyal sekitar empat volt. </font><font style="vertical-align: inherit;">Tetapi protokolnya tidak terlihat seperti sesuatu yang standar, dan sinyalnya sangat berisik, ketika trek menyala, Anda perlu memfilternya. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gm/nu/wq/gmnuwqpcnnxeo0ut0uxqs3wpnk0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kabel terakhir hanya pulsa dengan frekuensi konstan. </font><font style="vertical-align: inherit;">Rupanya, bagi konsol untuk melihat koneksi ke sabuk berjalan. </font><font style="vertical-align: inherit;">Jika Anda melepas kabel ini, remote control segera memberikan kesalahan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Indikasi dari sensor pulsa pada kabel-kabel ini jelas tidak ditransmisikan, tetapi tidak perlu. </font><font style="vertical-align: inherit;">Lebih baik menghubungkan sensor dada yang terpisah, yang sudah lama saya gunakan saat mengendarai sepeda. </font><font style="vertical-align: inherit;">Selain itu, ternyata sensor detak jantung pada treadmill itu sendiri tergeletak banyak, meremehkan bacaan.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perakitan perangkat</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, tugas selanjutnya adalah merakit papan yang menghubungkan paralel dengan kabel-kabel ini, membaca kecepatan dan sudut saat ini, dan entah bagaimana mentransfernya secara nirkabel ke tablet atau smartphone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekali lagi, saya memutuskan untuk menggunakan komputer papan tunggal Onion Omega2. Dia harus melakukan pekerjaan dengan sangat baik. Hanya perlu menurunkan tegangan suplai ke 3,3 volt dan memfilter data dari gangguan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengurangi tegangan, sekarang saya menggunakan papan yang sudah jadi ini dengan konverter DC-DC. Harganya beberapa sen, dapat bertahan hingga beberapa ampere, dan tegangan output disesuaikan dengan twist. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/lj/xo/acljxovuyfsah8j57fccxnxpboi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada saat yang sama, papan ini memiliki kesimpulan untuk menyolder langsung ke papan lain, sangat nyaman. Hal utama adalah tidak memuntir twist tegangan setelah pemasangan di sirkuit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk menyaring kebisingan pada jalur data, saya membuat filter RC biasa: resistor 2,2 kilo-ohm dan kapasitor 22 picofarad. </font><font style="vertical-align: inherit;">Ini harus menyaring suara frekuensi tinggi, meninggalkan sinyal frekuensi rendah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ternyata syal yang cukup kecil. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0k/bt/2e/0kbt2easvesiu_xpo5hwwr-wyzq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya menghubungkannya ke kabel treadmill untuk melihat seberapa baik sinyal disaring ketika dihidupkan dan, tampaknya, bentuk gelombangnya menjadi hampir sempurna.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i-/dt/jo/i-dtjo2zc2onozxqv1i2ai7alse.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modul kernel</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Namun, tidak mudah untuk memeriksa kinerja setrika. Seperti yang kita lihat </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
sebelumnya pada osiloskop, sinyalnya berjalan sangat cepat, dan kami tidak menggunakan mikrokontroler, melainkan komputer papan tunggal Omega2 dengan Linux. Di Linux, kami tidak akan dapat memproses sinyal dari ruang pengguna dengan begitu cepat. Tapi dari intinya kita bisa! Karena itu, inilah saatnya untuk menulis modul kernel Linux! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk melakukan ini, Anda perlu mengunduh sumber kernel Linux, dalam kasus kami ini adalah rakitan OpenWRT untuk Omega2, dan buat direktori dengan kode sumber modul kami di dalamnya.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menulis kode modul sangat mirip pemrograman mikrokontroler. Kami juga menulis dalam C, juga semuanya level rendah, kami juga bekerja dengan interupsi dan juga beralih ke kesimpulan GPIO. Hanya di sini, selain semua hal di atas, kami masih berinteraksi dengan ruang pengguna melalui file pseudo. Dengan demikian, modul kernel kami menjadi semacam adaptor antara perangkat keras dan aplikasi biasa. Sebenarnya, ini disebut driver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pada awalnya, saya tidak tahu bagaimana cara memecahkan kode sinyal, jadi saya hanya menyimpulkan durasinya. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v2/qg/ou/v2qgouholyhcstqxsph1nkjyfyy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Segera menjadi jelas bahwa sinyal dikodekan dengan durasi tingkat tinggi. Panjangnya 600 mikrodetik atau 1200 mikrodetik. Level rendah selalu sepanjang 600 mikrodetik kecuali untuk urutan awal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebanyak 17 tetes seperti itu naik dan turun. </font><font style="vertical-align: inherit;">Ternyata, ini adalah 16 bit data ditambah urutan awal. </font><font style="vertical-align: inherit;">Saya membuat decoding, mengambil sebagai dasar bahwa perbedaan panjang yang panjang adalah nol logis, dan yang pendek adalah unit logis dan saya mendapatkan apa yang terjadi. </font><font style="vertical-align: inherit;">Saya segera melihat data yang saya butuhkan! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d0/if/oh/d0ifohb7jktcyh6poivdersopr8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
16 bit, seperti yang Anda tahu, dua byte. </font><font style="vertical-align: inherit;">Byte pertama menunjukkan jenis data yang dikirim: sudut kemiringan atau kecepatan, dan byte kedua data itu sendiri. </font><font style="vertical-align: inherit;">Pengemudi sangat sederhana. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Satu-satunya parameter driver adalah nomor port.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Module parameters */</span>
<span class="hljs-keyword">static</span> u8 receive_pin = <span class="hljs-number">11</span>;<font></font>
module_param(receive_pin, byte, S_IRUGO);<font></font>
MODULE_PARM_DESC(receive_pin,<span class="hljs-string">"Treadmill receiver pin number (default 11)"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat menginisialisasi, konfigurasikan untuk input dan atur interupsi, yang akan dipicu setiap kali level di atasnya berubah.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Allocate and init the timer */</span>
data_recv_timer = kzalloc(<span class="hljs-keyword">sizeof</span>(struct hrtimer), GFP_KERNEL);
<span class="hljs-keyword">if</span> (!data_recv_timer) {<font></font>
    pr_err(<span class="hljs-string">"treadmill: can't allocate memory for timer\n"</span>);<font></font>
    treadmill_free();<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
}<font></font>
hrtimer_init(data_recv_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);<font></font>
data_recv_timer-&gt;function = recv_timer_callback;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam gangguan ini, pertama-tama kita melihat waktu saat ini. Selanjutnya, kami menggunakan nilai ini untuk menghitung berapa banyak waktu telah berlalu sejak interupsi terakhir terpicu dan memasukkannya ke dalam array. Tentu saja, kita ingat waktu sekarang untuk perhitungan di waktu berikutnya. Selain itu, Anda harus memulai kembali timer khusus.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* IRQ fired every rising/falling edge of receiver pin */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">irq_handler_t</span> <span class="hljs-title">treadmill_irq_handler</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> irq,
    <span class="hljs-keyword">void</span> *dev_id, struct pt_regs *regs)</span>
</span>{<font></font>
    u64 now = ktime_to_us(ktime_get_boottime());<font></font>
    u8 value = gpio_get_value(receive_pin);<font></font>
    u64 time_passed;<font></font>
    reset_recv_timer();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ((timings_pos &amp; <span class="hljs-number">1</span>) == value)<font></font>
    {<font></font>
        time_passed = now - last_time;<font></font>
        <span class="hljs-keyword">if</span> (timings_pos &lt; TIMINGS_BUFFER_SIZE)<font></font>
        {<font></font>
            timings[timings_pos] = time_passed;<font></font>
            timings_pos++;<font></font>
        }<font></font>
        last_time = now;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/* Announce that the IRQ has been handled correctly */</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">irq_handler_t</span>) IRQ_HANDLED;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kuncinya adalah bahwa jika timer masih bekerja, itu berarti bahwa tidak ada level drop pada pin untuk waktu yang lama, dan karenanya sudah waktunya untuk memproses informasi yang dikumpulkan. </font><font style="vertical-align: inherit;">Dalam fungsi yang disebut timer, diperiksa bahwa ada 34 tetes, setelah itu kita melihat berapa lama setiap interval. </font><font style="vertical-align: inherit;">Jika ada 600 mikrodetik, kemudian 1200 mikrodetik, maka kita bawa 900 ke luar negeri. Jika intervalnya kurang, maka kita tulis satu di hasilnya, digeser satu bit. </font><font style="vertical-align: inherit;">Setelah memproses setiap interval, kami mengirim hasilnya ke file pseudo, sehingga mentransfer data ke ruang pengguna.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Timer */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> hrtimer_restart <span class="hljs-title">recv_timer_callback</span><span class="hljs-params">(struct hrtimer *timer)</span>
</span>{
    <span class="hljs-keyword">int</span> i, p;<font></font>
    u16 data;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (timings_pos != <span class="hljs-number">34</span>) {<font></font>
        pr_debug(<span class="hljs-string">"treadmill: invalid edges count: %d"</span>, timings_pos);<font></font>
        timings_pos = <span class="hljs-number">0</span>; 
        <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
    }<font></font>
<font></font>
    data = <span class="hljs-number">0</span>;   
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">2</span>; i &lt; timings_pos; i += <span class="hljs-number">2</span>)<font></font>
    {<font></font>
        data &gt;&gt;= <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (timings[i] &lt; <span class="hljs-number">900</span>) <span class="hljs-comment">// 600us = 1, 1200 us = 0</span>
            data |= <span class="hljs-number">0x8000</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">for</span> (p = <span class="hljs-number">0</span>; p &lt; <span class="hljs-number">2</span>; p++) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; treadmill_number_opens; i++) {
            <span class="hljs-keyword">if</span> (!(opened_files[i]-&gt;f_mode &amp; FMODE_READ)) <span class="hljs-keyword">continue</span>;<font></font>
            ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_buffer[<font></font>
                ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_write_pos++<font></font>
                % RECEIVER_BUFFER_SIZE] = (data &gt;&gt; (<span class="hljs-number">8</span> * p)) &amp; <span class="hljs-number">0xFF</span>;<font></font>
        }<font></font>
    };<font></font>
    wake_up_interruptible(&amp;wq_data);<font></font>
<font></font>
    timings_pos = <span class="hljs-number">0</span>; <font></font>
   <font></font>
    <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Server python dan deteksi kecepatan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kemudian tetap menulis skrip Python yang akan membacanya dari pseudo-file dan mengirimkannya melalui jaringan sebagai string JSON. Tampaknya semuanya cukup mudah. Namun, jika semuanya sederhana dengan sudut kemiringan, dan nilai dalam byte kedua persis sesuai dengan sudut kemiringan sebagai persentase, maka dengan kecepatan semuanya ternyata jauh lebih membingungkan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nilai 9 setara dengan satu kilometer per jam, dan nilai 160 sesuai dengan 18 kilometer per jam. Artinya, ketergantungan data pada kecepatan nyata sama sekali tidak jelas. Saya menulis semua nilai secara manual, mengarahkannya ke Excel, diplot dan mendapat kurva yang sangat tidak rata.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/cp/gt/p0cpgtrosoipnmqnjmfluzntiiu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan ada kecepatan ketika pembacaan pada remote berbeda, tetapi data dan kecepatan trek itu sendiri tetap sama! Misalnya, 5,2 km / jam dan 5,3 km / jam sebenarnya kecepatannya sama. Di mana-mana curang. Saya bertanya-tanya, berapa kecepatan sebenarnya? Mengukurnya entah bagaimana, tetapi tinggalkan untuk nanti. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Terlepas dari transfer burung beo ini ke kilometer per jam, skripnya ternyata sangat sederhana. Kami membaca data dari pseudo-file Linux, mendekodekannya, menerima koneksi jaringan dan mentransfer data ke klien yang terhubung melalui jaringan sebagai string JSON.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreadmillServer</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, device = <span class="hljs-string">"/dev/treadmill"</span>, port = <span class="hljs-number">11010</span>, interface = <span class="hljs-string">'0.0.0.0'</span></span>):</span><font></font>
        self._device = device<font></font>
        self._port = port<font></font>
        self._interface = interface<font></font>
        self._working = <span class="hljs-literal">False</span><font></font>
        self._clients = []<font></font>
        self._server_sock = <span class="hljs-literal">None</span>
        self.incline = <span class="hljs-number">0</span>
        self.speed = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">True</span><font></font>
        self._server_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<font></font>
        self._server_sock.bind((self._interface, self._port))<font></font>
        self._server_sock.listen(<span class="hljs-number">10</span>)<font></font>
        print(<span class="hljs-string">"Listening port"</span>, self._port)<font></font>
        Thread(target=self._port_listener, name=<span class="hljs-string">"Treadmill port listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
        Thread(target=self._device_listener, name=<span class="hljs-string">"Treadmill device listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> self._server_sock != <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">try</span>:<font></font>
                self._server_sock.close()<font></font>
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>
            self._server_sock = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><font></font>
        self.stop()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_port_listener</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">while</span> self._working <span class="hljs-keyword">and</span> self._server_sock:
            <span class="hljs-keyword">try</span>:<font></font>
                conn, addr = self._server_sock.accept()<font></font>
                print(<span class="hljs-string">'Connected: {0}'</span>.format(addr))<font></font>
                TreadmillClientConnection(self, conn, addr)<font></font>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
                print(<span class="hljs-string">"Error:"</span>, e)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya pikir tidak diperlukan otorisasi dan keamanan di sini. </font><font style="vertical-align: inherit;">Keadaan treadmill bukan jenis data yang ingin saya lindungi dari peretas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami memasukkan skrip ini ke startup dan menghapus papan di dalam treadmill. </font><font style="vertical-align: inherit;">Sayangnya, itu hanya muat di pipa logam yang menghubungkan konsol ke sabuk berjalan. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q9/s3/ab/q9s3abxgl3zhcxxepbj4n46onog.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seperti yang Anda tahu, logam melindungi sinyal radio, jadi saya membawa antena Wi-Fi keluar dari pipa, tetapi di bawah selubung plastik yang menyembunyikan kabel. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k8/j4/op/k8j4op4zjjbwby41ltcahq_hgxa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk hal ini treadmill "pintar" langsung sudah siap. </font><font style="vertical-align: inherit;">Dia sudah tahu bagaimana cara mendistribusikan statistik melalui jaringan. </font><font style="vertical-align: inherit;">Tetap menulis klien untuknya!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klien Android</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang menurut saya harus menjadi klien seperti itu. </font><font style="vertical-align: inherit;">Ini adalah aplikasi Android yang akan saya jalankan di tablet atau smartphone dan meletakkannya di atas tampilan treadmill itu sendiri, masing-masing, itu harus menampilkan semua informasi tentang latihan di layar, menggantikan tampilan treadmill itu sendiri. </font><font style="vertical-align: inherit;">Aplikasi harus bisa bekerja di latar belakang, sehingga saya bisa menonton video tanpa masalah saat jogging. </font><font style="vertical-align: inherit;">Selain itu, ia harus menjaga statistik terperinci tentang pengoperasian, menyinkronkan semuanya dengan cloud dan menggambar grafik ketergantungan pada kecepatan dan sudut kemiringan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inti dari aplikasi semacam itu adalah layanan yang berjalan di latar belakang, terhubung ke treadmill dalam loop tanpa akhir, menerima data, dan menerjemahkannya. </font><font style="vertical-align: inherit;">Tidak ada kesulitan khusus dalam hal ini.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sensor detak jantung</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hal yang paling sulit adalah bekerja dengan sensor detak jantung. </font><font style="vertical-align: inherit;">Banyak perangkap ditemukan. </font><font style="vertical-align: inherit;">Saya memiliki monitor detak jantung dada di sini: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c5/sy/w1/c5syw10i53ey_zkbcjjrdpmxpzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya sudah lama menggunakannya saat mengendarai sepeda. </font><font style="vertical-align: inherit;">Ini cukup standar, ini berfungsi pada BLE ala Bluetooth Low Enegy, dapat dipasangkan dengan telepon dan navigator Garmin tanpa masalah. </font><font style="vertical-align: inherit;">Saya bahkan tidak dapat berpikir bahwa bekerja dengannya dari aplikasi saya akan sangat tidak terlihat. </font><font style="vertical-align: inherit;">Sensor tersebut memiliki GUID standar untuk pembacaan yang berbeda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mulai menerima detak jantung, Anda harus terlebih dahulu mengonfigurasi monitor detak jantung Anda untuk mengirim bacaan secara berkala. </font><font style="vertical-align: inherit;">Saya bisa melakukan ini hanya dengan mempelajari contoh yang tidak berfungsi dan dengan mengetik.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sebagai hasilnya, saya menulis sebuah kelas untuk bekerja dengan sensor detak jantung, yang secara otomatis mencoba menghubungkannya dan secara berkala melaporkan detak jantung saat ini.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samsung Health SDK</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adapun statistik dan grafik. </font><font style="vertical-align: inherit;">Saya memutuskan untuk tidak menemukan kembali roda, tetapi untuk menggunakan apa yang sudah saya gunakan saat mengendarai sepeda, yaitu entah bagaimana berteman dengan aplikasi Samsung Health yang luar biasa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang mungkin akan terlihat seperti saya mengiklankan Samsung lagi. </font><font style="vertical-align: inherit;">Tetapi pada sepeda, aplikasi ini telah benar-benar membuktikan dirinya dengan sangat baik. </font><font style="vertical-align: inherit;">Yang mengejutkan saya, ini terhubung ke semua sensor tanpa masalah, menunjukkan irama dan kecepatan roda, dan menentukan statistik di headphone, itu menunjukkan statistik yang sama dengan grafik, dan memberikan pencapaian, dan menyimpan segala sesuatu di awan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pencarian menunjukkan bahwa Samsung Health memiliki SDK sendiri, yang, meskipun tidak sepenuhnya dapat dipahami, masih didokumentasikan: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img-developer.samsung.com/onlinedocs/health/android/data/index.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bekerja dengannya pada dasarnya bekerja dengan database yang menyimpan berbagai bacaan dari langkah-langkah yang diambil dan pengukuran detak jantung hingga gula darah dan fase tidur. </font><font style="vertical-align: inherit;">Tetapi sekarang kami tertarik pada catatan latihan, yang mencakup nilai skalar seperti jenis olahraga, waktu, jarak, durasi, kalori yang terbakar, dan susunan data langsung seperti riwayat denyut jantung, kecepatan, dan koordinat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semua data ini harus disimpan dan dipersiapkan dengan benar. </font><font style="vertical-align: inherit;">Beberapa perlu dihitung.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perhitungan tinggi badan</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalnya mengangkat tinggi. </font><font style="vertical-align: inherit;">Dari treadmill, kita tahu sudut pendakian di setiap titik waktu, yang diukur dalam persen. </font><font style="vertical-align: inherit;">Persentase sudut ketinggian adalah rasio jarak yang ditempuh dengan pendakian. </font><font style="vertical-align: inherit;">Ternyata kecepatan vertikal sama dengan kecepatan biasa kali kemiringan sebagai persentase dan dibagi seratus. </font><font style="vertical-align: inherit;">Mengetahui kecepatan vertikal, kita dapat menghitung ketinggian saat ini di setiap saat. </font><font style="vertical-align: inherit;">Akibatnya, itu harus dimasukkan ke dalam koordinat saat ini, meskipun pada kenyataannya selama latihan mereka tidak berubah dan tidak diperhitungkan. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Menanggapi data ini, aplikasi Samsung Health akan menunjukkan berapa banyak yang seharusnya saya naik, serta kecepatan vertikal pada setiap saat pelatihan.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penghitungan Kalori</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tapi bagaimana cara menghitung kalori? Selain itu, penghitungan kalori adalah keharusan bagi Samsung Health. Pada saat yang sama, kalori yang terbakar adalah indikator yang sangat tidak akurat, yang tergantung pada banyak faktor. Tidak yakin apakah masuk akal untuk menghitungnya. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya tidak datang dengan sesuatu dari saya sendiri dan hanya google kalkulator (https://42.195km.net/e/treadsim/) dan menyalin algoritma dari javascript saya (https://42.195km.net/e/treadsim/treadsim107 .js). Di pintu masuk, ia menempuh jarak yang ditempuh, sudut ketinggian dan ... berat.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saya dapat mengatur berat badan saya secara manual, tetapi karena kami bekerja dengan Samsung Health, saya dapat mengambil berat badan saya saat ini dari sana. </font><font style="vertical-align: inherit;">Lagi pula, saya menggunakan skala pintar dari Xiaomi, yang disinkronkan dengan Google Fit di ponsel saya, Google FIt melalui aplikasi terpisah disinkronkan dengan Samsung Health, Samsung Health melalui cloud disinkronkan dengan dirinya sendiri di tablet, di mana aplikasi saya sudah menerimanya.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penampilan aplikasi</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Secara visual, tugas aplikasi adalah tampilan skala besar dari indikasi utama: kecepatan, sudut, detak jantung, jarak, kalori. Lebih baik melakukannya dalam warna putih dengan latar belakang hitam sehingga konsumsi baterai saat menggunakan layar AMOLED minimal, karena kami jelas menunjukkan bahwa saat menampilkan aktivitas kami, layar harus dihidupkan terus-menerus. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ss/qz/6b/ssqz6bqch_3xljgjpbrzba3ykzy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tombol-tombol secara otomatis disembunyikan ketika treadmill aktif. Anda dapat memulai dan menghentikan pelatihan hanya dengan kecepatan nol.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan tentu saja, Anda perlu membuat dukungan untuk mode "gambar dalam gambar". Ini dilakukan hanya dalam beberapa baris. Anda hanya perlu menunjukkan dalam manifes bahwa aktivitas mendukung mode ini, dan dalam kode masuk ke dalamnya ketika meminimalkan aplikasi. Hasilnya, Anda dapat menonton, misalnya, YouTube dan melihat bacaan treadmill di sudut layar. Ternyata sangat nyaman. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yt/0c/ls/yt0clswyb0ua3o3x5oopusvy5ie.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi pada tahap ini saya akhirnya disalip oleh rasa sakit pengembang untuk Android, karena saya sudah mendapatkan empat ukuran layar yang berbeda: ponsel dan tablet dalam mode normal dan mereka juga dalam mode "gambar dalam gambar". Dan kebetulan bahwa jika saya memilih ukuran font normal untuk satu ukuran layar, maka dalam kasus lain semuanya terlalu kecil, maka terlalu besar.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saat mengembangkan untuk Android, ada beberapa kategori layar, dan Anda dapat membuat pengaturan yang berbeda berlaku secara otomatis untuk mereka, tetapi dalam kasus saya ini tidak cukup. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Akibatnya, saya harus menghitung dan mengatur ukuran font dalam kode, yang menurut saya sangat salah. </font><font style="vertical-align: inherit;">Namun, itu berfungsi dengan sempurna sebagai hasilnya.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasil</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dan inilah hasilnya. </font><font style="vertical-align: inherit;">Kami membuka aplikasi, menunggu koneksi dengan treadmill dan sensor detak jantung, memulai pelatihan dan menggunakan treadmill seperti biasa. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Di akhir latihan, kami menghentikan treadmill. </font><font style="vertical-align: inherit;">Setelah mencapai kecepatan nol, tombol "selesai pelatihan" akan muncul. </font><font style="vertical-align: inherit;">Klik itu, dan statistik dikirim ke Samsung Health. </font><font style="vertical-align: inherit;">Buka dan lihat semua data. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xz/-q/e5/xz-qe5ipelysxlqfmfzayv8m6uc.png"><br>
<br>
<img src="https://habrastorage.org/webt/jn/m9/md/jnm9mdprmuyul2_bcdqbd8clzrc.png"><br>
<br>
<img src="https://habrastorage.org/webt/tg/gh/lx/tgghlxokyu_l7sxghej5fzm1u0s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat melihat grafik denyut nadi, kecepatan dan kenaikan, membandingkan kemajuan Anda pada interval waktu yang berbeda, semua ini disimpan di cloud dan dapat diakses dari semua perangkat. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anda dapat menyinkronkannya dengan Google Fit. </font><font style="vertical-align: inherit;">Kecantikan. </font><font style="vertical-align: inherit;">Saya senang dengan hasilnya. </font><font style="vertical-align: inherit;">Sekarang hal utama adalah tidak membuang kelas. </font><font style="vertical-align: inherit;">Anda dapat menambah fungsionalitas aplikasi sehingga menyerupai pelatihan jika saya malas untuk waktu yang lama. </font><font style="vertical-align: inherit;">Tapi saya sudah terlalu malas untuk melakukan fungsi ini.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id502354/index.html">Penyedia IaaS berjuang untuk pasar Eropa - mendiskusikan situasi dan peristiwa industri</a></li>
<li><a href="../id502358/index.html">Implementasi MVP berdasarkan ApplicationController dan IoC dalam aplikasi WinForms</a></li>
<li><a href="../id502360/index.html">Pelepasan Grizzly atau Super Bor</a></li>
<li><a href="../id502362/index.html">Mempelajari Pelacakan Peristiwa untuk Windows: Teori dan Praktik</a></li>
<li><a href="../id502366/index.html">Bandingkan karya open source Python - libraries untuk pengakuan entitas bernama</a></li>
<li><a href="../id502370/index.html">Menempatkan game "Snake" di papan tempat memotong roti. Bagian 1: mesin negara</a></li>
<li><a href="../id502372/index.html">Masalah dan prinsip penyesuaian versi kotak Bitrix24</a></li>
<li><a href="../id502374/index.html">Protokol Komunikasi FT8 - Bagaimana Cara Kerjanya</a></li>
<li><a href="../id502380/index.html">Seledri + asyncio</a></li>
<li><a href="../id502382/index.html">Kakek Antarmuka Sepeda Beracun. "Kebohongan, ancaman, dan pemerasan." (s1 e6)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>