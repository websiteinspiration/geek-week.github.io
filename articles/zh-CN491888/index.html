<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😘 🖼️ ♍️ GitLab CI：我们一直在等待的最新版本中的6个功能 ☑️ ⚠️ 🐩</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在无所不在的CI / CD时代，我们面临着各种各样的相关工具，包括CI系统。但是，是GitLab对我们来说是最接近的，真正的“本地人”。他在整个行业中获得了显着的知名度*。该产品的开发人员并没有落后于对其使用的日益增长的兴趣，因此定期用新版本使开发人员和DevOps工程师社区感到高兴。
 
 
 G...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>GitLab CI：我们一直在等待的最新版本中的6个功能</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/491888/"><img src="https://habrastorage.org/webt/gw/s2/_l/gws2_lpk_xse3zwysoxi7yhgedi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在无所不在的CI / CD时代，我们面临着各种各样的相关工具，包括CI系统。但是，是GitLab对我们来说是最接近的，真正的“本地人”。他在整个行业中获得了显着的知名度*。该产品的开发人员并没有落后于对其使用的日益增长的兴趣，因此定期用新版本使开发人员和DevOps工程师社区感到高兴。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/le/lp/fl/lelpfl_26qkmpjz5qf5cjq4bbd0.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab存储库月份和标签聚合</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
主动开发带来许多新的有趣功能时就是GitLab的情况。如果对于潜在用户来说，这只是选择工具的因素之一，对于现有用户来说，情况是这样的：如果您在上个月未更新GitLab安装，那么很可能错过了一些有趣的东西。包括定期出现的安全更新。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
关于最重要的-即我们的DevOps工程师和客户的要求-最新版本的GitLab社区版本中的创新，并将在本文中进行讨论。</font></font><a name="habracut"></a><br>
<br>
<i>*   5  ,  «GitLab»,   : «,   GitHub?».     — ,  Google Trends <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>  5-    «gitlab»   .     «»  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>.     ,   ,     «»   .</i><br>
<br>
<h2>№1: needs</h2><br>
<ul>
<li>     job'.</li>
<li>    GitLab: 12.2.</li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a>.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
想</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>dependencies</code></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-这就是您需要的吗？也许，我们不是谁提出分配这个指令的错误唯一的......这是需要列出以前的工作时，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">器物</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，其中将需要。这是工件，而不是依赖于先前任务的性能。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假设在某个阶段发生了一些不需要执行的工作，但是由于某种原因，就没有可能或只是希望将它们带到另一个阶段（懒惰是进步的动力，但不会被带走）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
情况：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/_u/sa/k1/_usak1lrpdqpjtxln69r3ktc5ag.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如您所见，stage </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含用于展开生产和阶段以及作业</font><i><font style="vertical-align: inherit;">Selenium测试的</font></i><font style="vertical-align: inherit;">按钮</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于某种原因未执行。</font><font style="vertical-align: inherit;">很简单：他等到上一阶段的所有作业都成功完成为止。</font><font style="vertical-align: inherit;">但是，在同一个管道的框架中，我们不需要立即部署阶段来运行测试（它早些时候就被抽出了，不在标签内）。</font><font style="vertical-align: inherit;">该怎么办？</font><font style="vertical-align: inherit;">然后，前来救援</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的需求</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们只列出了运行测试所需的先前工作：</font></font><br>
<br>
<pre><code class="plaintext hljs">  needs:<font></font>
    - To production (Cluster 1)<font></font>
    - To production (Cluster 2)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...我们得到一个作业，该作业仅在执行列出的作业后自动调用：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jm/9y/8z/jm9y8zesapj3neflq_xmn7er70i.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
方便吗？</font><font style="vertical-align: inherit;">但是一旦我期望该指令可以像这样工作</font></font><code>dependencies</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2号：扩展</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 增强的YAML锚点和别名。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 自GitLab 11.3起引入。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#extends</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
厌倦了阅读卷</font></font><code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？缺少代码重用原理？然后，您已经尝试过并且可能成功地将您</font></font><code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的状态设置为如下所示：</font></font><br>
<br>
<pre><code class="plaintext hljs">.base_deploy: &amp;base_deploy<font></font>
  stage: deploy<font></font>
  script:<font></font>
    - my_deploy_command.sh<font></font>
  variables:<font></font>
    CLUSTER: "default-cluster"<font></font>
    MY_VAR: "10"<font></font>
<font></font>
Deploy Test:<font></font>
  &lt;&lt;: *base_deploy<font></font>
  environment:<font></font>
    url: test.example.com<font></font>
    name: test<font></font>
<font></font>
Deploy Production:<font></font>
  &lt;&lt;: *base_deploy<font></font>
  environment:<font></font>
    url: production.example.com<font></font>
    name: production<font></font>
  variables:<font></font>
    CLUSTER: "prod-cluster"<font></font>
    MY_VAR: "10"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
听起来不错吗？但是，如果您仔细观察，就会有什么吸引您的目光……为什么我们不仅要改变生产方式</font></font><code>variables.CLUSTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，而且还要重新</font><font style="vertical-align: inherit;">生产</font></font><code>variables.MY_VAR=10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？这个变量应该取自</font></font><code>base_deploy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">吗？事实证明，它不应该这样做：YAML起作用，以便重新定义从锚接收到</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">内容</font><font style="vertical-align: inherit;">，它</font><i><font style="vertical-align: inherit;">不会扩展</font></i><font style="vertical-align: inherit;">匹配字段</font><i><font style="vertical-align: inherit;">的</font></i><font style="vertical-align: inherit;">内容，而是会</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">替换它</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。因此，我们不得不在匹配的段落中列出我们已经知道的变量。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
是的，“扩展”是正确的词：这正是所涉及的功能。</font></font><code>Extends</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它们不仅使我们能够像锚一样重写字段，还可以对其进行智能合并：</font></font><br>
<br>
<pre><code class="plaintext hljs">.base_deploy: <font></font>
  stage: deploy<font></font>
  script:<font></font>
    - my_deploy_command.sh<font></font>
  variables:<font></font>
    CLUSTER: "default-cluster"<font></font>
    MY_VAR: "10"<font></font>
<font></font>
Deploy Production:<font></font>
  extends: .base_deploy<font></font>
  environment:<font></font>
    url: production.example.com<font></font>
    name: production<font></font>
  variables:<font></font>
    CLUSTER: "prod-cluster"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在最后的作业</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deploy Production中，这里</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将有一个</font></font><code>MY_VAR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">具有默认值</font><font style="vertical-align: inherit;">的变量</font><font style="vertical-align: inherit;">和一个被覆盖</font><font style="vertical-align: inherit;">的变量</font></font><code>CLUSTER</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
看来这真是一件小事，但请想象一下：您有一个</font></font><code>base_deploy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和20个电路部署相似。</font><font style="vertical-align: inherit;">它们需要传递给其他人</font></font><code>cluster</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>environment.name</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同时保留一组特定的变量或其他匹配的字段...这种小小的愉悦感使我们能够将开发电路集的部署描述减少2-3倍。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第三名：包括</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我们将庞大的YAML分为几部分，并在其他项目中重复使用。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 从11.4版开始在Core中引入。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#include</font></font></a></li>
</ul><br>
<code>.gitlab-ci.yaml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它看起来仍然</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">像是20种语言的真空吸尘器的折叠式说明（您只懂其中一种）</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，当您需要处理它的其中一个部分而又不面对途中遇到的未知工作时，是否很难？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
长期的编程朋友将为您提供帮助</font></font><code>include</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="plaintext hljs">stages:<font></font>
  - test<font></font>
  - build<font></font>
  - deploy<font></font>
<font></font>
variables:<font></font>
  VAR_FOR_ALL: 42<font></font>
<font></font>
include:<font></font>
  - local: .gitlab/ci/test.yml<font></font>
  - local: .gitlab/ci/build.yml<font></font>
  - local: .gitlab/ci/deploy-base.yml<font></font>
  - local: .gitlab/ci/deploy-production.yml</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
那些。</font><font style="vertical-align: inherit;">现在，我们正在大胆地编辑生产环境中的部署，而测试人员正在忙于修改他们的文件，而我们甚至可能没有看过。</font><font style="vertical-align: inherit;">另外，这有助于避免合并冲突：了解别人的代码并不总是很有趣。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
但是，如果我们知道前后20个项目的流程，该如何解释每个工作的逻辑呢？</font><font style="vertical-align: inherit;">这将如何帮助我们？</font><font style="vertical-align: inherit;">对于那些对代码重用有所启发的人以及所有拥有许多类似项目的人，您可以：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include：文件</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -包含来自同一GitLab实例的另一个存储库的GitLab CI文件，</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其中</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包括：template- </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现成的GitLab模板的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集合</font><font style="vertical-align: inherit;">，</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包括：远程</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -外部文件（通过HTTPS访问）。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
十二个具有不同代码但类型相同的项目，但部署方式相同-轻松且无需在所有存储库中保持最新的CI！</font><i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">本文</font></a></i><i><font style="vertical-align: inherit;">还提供了</font></i></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个实际使用的示例</font><font style="vertical-align: inherit;">。</font></font><code>include</code><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第4：只有/裁判除外</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 全面的条件，包括变量和文件更改。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于这是一个完整的功能家族，因此某些部分开始出现在GitLab 10.0中，而其他部分（例如</font></font><code>changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">开始出现在</font><font style="vertical-align: inherit;">11.4中。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#onlyexcept-advanced</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我看来，有时候这不是听我们的管道，而是我们。</font><font style="vertical-align: inherit;">一支优秀的管理工具中</font></font><code>only</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font><code>except</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-现在集成。</font><font style="vertical-align: inherit;">这是什么意思？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在最简单（也许最愉快）的情况下，跳过阶段：</font></font><br>
<br>
<pre><code class="plaintext hljs">Tests:<font></font>
  only:<font></font>
    - master<font></font>
  except:<font></font>
    refs:<font></font>
    - schedules<font></font>
    - triggers<font></font>
    variables:<font></font>
    - $CI_COMMIT_MESSAGE =~ /skip tests/</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在示例作业中，它仅在主节点的一个分支上运行，但不能由计划或触发器触发（GitLab共享API调用和触发器，尽管本质上是相同的API）。</font><font style="vertical-align: inherit;">如果提交消息中有</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">跳过测试</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">密码，则作业将不会执行</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如，</font></font><code>README.md</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目或文档中</font><font style="vertical-align: inherit;">的错字</font><font style="vertical-align: inherit;">已</font><font style="vertical-align: inherit;">得到修复</font><font style="vertical-align: inherit;">-为什么要等待测试结果？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
“嘿，2020年在外面！” </font><font style="vertical-align: inherit;">为什么每次更改文档时我都应该向铁盒解释没有必要运行测试？” </font><font style="vertical-align: inherit;">确实：</font></font><code>only:changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它允许您仅在某些目录中更改文件时运行测试。</font><font style="vertical-align: inherit;">例如：</font></font><br>
<br>
<pre><code class="plaintext hljs">  only:<font></font>
    refs:<font></font>
      - master<font></font>
      - merge_requests<font></font>
    changes:<font></font>
      - "front/**/*"<font></font>
      - "jest.config.js"<font></font>
      - "package.json"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
而对于反向动作-即 </font><font style="vertical-align: inherit;">不要跑-是的</font></font><code>except:changes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第5条：规则</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 个人工作规则。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 在GitLab 12.3中引入。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#rules</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该指令与之前的指令非常相似</font></font><code>only:*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但是有一个重要的区别：它允许您控制参数</font></font><code>when</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">例如，如果您不想完全消除开始工作的可能性。</font><font style="vertical-align: inherit;">您可以简单地保留该按钮，如果需要，可以独立调用该按钮，而无需启动新管道或进行提交。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃6：环境：auto_stop_in</font></font></h2><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 在没有活动的情况下停止环境。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 在GitLab 12.8中引入。</font></font></li>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.gitlab.com/ce/ci/yaml/#environmentauto_stop_in</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们在本文发表之前就已经了解了这种机会，并且还没有足够的时间在实践中进行尝试，但这绝对是“同一件事”，在几个项目中都是如此。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您可以在GitLab环境中指定参数</font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-当您要动态创建和删除环境（例如到每个分支）时，</font><font style="vertical-align: inherit;">该参数</font><font style="vertical-align: inherit;">非常有用。</font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，当MR的合并在主分支中或MR关闭时（甚至仅通过单击按钮），将执行</font><font style="vertical-align: inherit;">标记为k的作业</font><font style="vertical-align: inherit;">，由于该原因，不必要的环境会被自动删除。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果不是出于人为因素，一切都是方便，合乎逻辑的，并且可以正常工作。许多开发人员不是通过单击GitLab中的按钮来合并MR，而是通过本地合并</font></font><code>git merge</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。您可以理解它们：方便！但是在这种情况下，逻辑</font></font><code>on_stop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它行不通，我们已经积累了被遗忘的环境...这是期待已久的方便之处</font></font><code>auto_stop_in</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">奖励：机会不足时的临时小屋</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尽管有所有（以及许多其他）GitLab所需的新功能，但遗憾的是，有时无法在当前可用功能的框架内描述完成工作的条件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab并不完美，但是它提供了构建梦想管道的基本工具……如果您准备超越普通的DSL，而陷入脚本世界。</font><font style="vertical-align: inherit;">以下是根据我们的经验提供的一些解决方案，这些解决方案决不假装在意识形态上是正确的或推荐的，但在没有内置API功能的情况下，将提供更多解决方案以演示不同的可能性。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决方法1：一键启动两个作业</font></font></h3><br>
<pre><code class="plaintext hljs">script:<font></font>
  - &gt; <font></font>
    export CI_PROD_CL1_JOB_ID=`curl -s -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs" | \<font></font>
      jq '[.[] | select(.name == "Deploy (Cluster 1)")][0] | .id'`<font></font>
  - &gt; <font></font>
    export CI_PROD_CL2_JOB_ID=`curl -s -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/pipelines/${CI_PIPELINE_ID}/jobs" | \<font></font>
      jq '[.[] | select(.name == "Deploy (Cluster 2)")][0] | .id'`<font></font>
  - &gt; <font></font>
    curl -s --request POST -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/jobs/$CI_PROD_CL1_JOB_ID/play"<font></font>
  - &gt; <font></font>
    curl -s --request POST -H "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \ <font></font>
      "https://gitlab.domain/api/v4/projects/${CI_PROJECT_ID}/jobs/$CI_PROD_CL2_JOB_ID/play"<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
而且，如果您确实想这样做，为什么不呢？</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决方法2：更改了图像内部rubocop的MR rb文件中的传输</font></font></h3><br>
<pre><code class="plaintext hljs">Rubocop:<font></font>
  stage: test<font></font>
  allow_failure: false<font></font>
  script:<font></font>
    ...<font></font>
    - export VARFILE=$(mktemp)<font></font>
    - export MASTERCOMMIT=$(git merge-base origin/master HEAD)<font></font>
    - echo -ne 'CHANGED_FILES=' &gt; ${VARFILE}<font></font>
    - if [ $(git --no-pager diff --name-only ${MASTERCOMMIT} | grep '.rb$' | wc -w |awk '{print $1}') -gt 0 ]; then<font></font>
        git --no-pager diff --name-only ${MASTERCOMMIT} | grep '.rb$' |tr '\n' ' ' &gt;&gt; ${VARFILE} ;<font></font>
      fi<font></font>
    - if [ $(wc -w ${VARFILE} | awk '{print $1}') -gt 1 ]; then<font></font>
        werf --stages-storage :local run rails-dev --docker-options="--rm --user app --env-file=${VARFILE}" -- bash -c /scripts/rubocop.sh ;<font></font>
      fi<font></font>
    - rm ${VARFILE}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
里面没有图像</font></font><code>.git</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，所以我不得不出去检查已更改的文件。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：这不是非常标准的情况，并且是拼命尝试满足该问题的许多条件的情况，对此的描述不包括在本文的范围内。</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解决方法＃3：推出时触发从其他存储库启动作业</font></font></h3><br>
<pre><code class="plaintext hljs">  before_script:<font></font>
    - |<font></font>
      echo '### Trigger review: infra'<font></font>
      curl -s -X POST \<font></font>
        -F "token=$REVIEW_TOKEN_INFRA" \<font></font>
        -F "ref=master" \<font></font>
        -F "variables[REVIEW_NS]=$CI_ENVIRONMENT_SLUG" \<font></font>
        -F "variables[ACTION]=auto_review_start" \<font></font>
        https://gitlab.example.com/api/v4/projects/${INFRA_PROJECT_ID}/trigger/pipeline</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
看起来，这种简单而必要的事情（在微服务领域）正在将另一个微服务作为依赖项部署到新创建的电路中。</font><font style="vertical-align: inherit;">但这不是必需的，因此不需要API调用和已经熟悉的功能（如上所述）：</font></font><br>
<br>
<pre><code class="plaintext hljs">  only:<font></font>
    refs:<font></font>
    - triggers<font></font>
    variables:<font></font>
    - $ACTION == "auto_review_start"</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
笔记：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类似于示例1，触发器上的作业被设计为将变量传递给API。</font><font style="vertical-align: inherit;">通过传递的作业名称在API上实现此操作更合乎逻辑。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 是的，该功能是在商业（EE）版本的GitLab中提供的，但我们不考虑它。</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GitLab努力跟上趋势，逐步实现DevOps社区所需要的令人愉悦的功能。</font><font style="vertical-align: inherit;">它们非常易于使用，当基本功能不够用时，可以随时使用脚本进行扩展。</font><font style="vertical-align: inherit;">而且，如果我们发现它在支持方面并不那么优雅，便捷……则有必要等待新版本的GitLab或</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">帮助我们做出贡献的项目</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">聚苯乙烯</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另请参阅我们的博客：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用werf和GitLab CI组装和部署相同类型的微服务</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">具有Kubernetes的GitLab CI中的JUnit</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”；</font></font></li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">werf —    CI/CD  Kubernetes (   )</a>» <i>( ; 27  2019  DevOpsConf)</i>;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">       GitLab CI</a>»;</li>
<li> «<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitLab CI       production</a>».</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN491876/index.html">MosQA＃2-来自mitap的材料，并搜索任务中的所有标志</a></li>
<li><a href="../zh-CN491880/index.html">不可避免地要通过ISO / IEC 27001认证的5个阶段。愤怒</a></li>
<li><a href="../zh-CN491882/index.html">使用脚本自动输入到SecureCRT</a></li>
<li><a href="../zh-CN491884/index.html">IT公司的整体知识管理</a></li>
<li><a href="../zh-CN491886/index.html">KnowledgeConf 2020 Online：逐步实施知识管理</a></li>
<li><a href="../zh-CN491890/index.html">驱动器解剖：SSD</a></li>
<li><a href="../zh-CN491896/index.html">Cyan我们如何通过用户体验研究来改善产品</a></li>
<li><a href="../zh-CN491900/index.html">机器学习的灵活性和自动化</a></li>
<li><a href="../zh-CN491902/index.html">用ProseMirror编写一个简单的WYSIWYG编辑器</a></li>
<li><a href="../zh-CN491904/index.html">如何编写安全的Python代码。用餐Kushal Das</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>