<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìé ‚¨õÔ∏è üëµ Linux Kernel TLS and Nginx üë©üèø‚Äçü§ù‚Äçüë®üèª üóûÔ∏è üò£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will talk about the history of development and the current state of technology for accelerating the distribution of content in TLS c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Linux Kernel TLS and Nginx</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501010/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this article I will talk about the history of development and the current state of technology for accelerating the distribution of content in TLS connections by transferring encryption to the core of the operating system, as well as about my contribution to the development of this direction.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Back in 2015, Randall Stewart and Scott Long from Netflix made a presentation at the AsiaBSDCon2015 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conference</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on optimizing the distribution of encrypted content. The main message of the report is to transfer data encryption to the kernel of the operating system to reduce the number of data copies between kernel-space and user-space and use the optimized non-blocking sendfile () system call. The topic turned out to be very promising and already at the 2016 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Netdev 1.2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conference, </font><font style="vertical-align: inherit;">Dave Watson from Facebook made a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">presentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the need to create TLS sockets in the Linux kernel, and Boris Pismenny, Ilya Lesokhin and Liran Liss from Mellanox </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">made a presentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">about the ability to use TLS hardware acceleration in network cards. </font><font style="vertical-align: inherit;">The topic was also discussed at HighLoad ++ 2017 by a speaker from Tempesta Technologies.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux kernel support</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result of all these conversations was the appearance of Kernel TLS in the Linux 4.13 kernel (2017) with support for TLSv1.2 and the AES128-GCM cipher. </font><font style="vertical-align: inherit;">Initially, encryption of only outgoing traffic was supported, decryption support appeared later in the Linux kernel 4.17 (2018). </font><font style="vertical-align: inherit;">In version 5.1, they added support for TLSv1.3 and AES256-GCM, and in version 5.2 they also added the AES128-CCM cipher (2019).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support in user-space</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In all the reports mentioned above, it was said that only encryption of useful data can be placed in the kernel, and all TLS approvals and control messages must be handled the same in user-space. And for this, a modified version of OpenSSL was used. However, at the time of the publication of the reports in the public domain there was no information about which modifications to this well-known library needed to be done to support the functionality. Perhaps the only available example of using Linux Kernel TLS was the blog article Filippo Valsorda </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Playing with kernel TLS in Linux 4.13 and Go</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which appeared immediately after the release of the Linux 4.13 kernel. </font><font style="vertical-align: inherit;">And, although it showed a valid example of the use of technology, it did not bring an understanding of how to use the technology in real projects. </font><font style="vertical-align: inherit;">Indeed, very few people write a WEB server for their project on their own, usually everyone uses well-known and time-tested tools.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support in OpenSSL</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first discussions of the technology in OpenSSL appeared in the summer of 2017 shortly before the release of the Linux 4.13 kernel ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PR 3631</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), but the discussion process was very, very slow, the first real comments appeared in October (after the release of the 4.13 kernel), and the actual </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">working version</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">started discussing in February 2018. By the time all corrections were agreed, the window for adding new functionality in OpenSSL 1.1.1 was closed, and support for Kernel TLS was moved to the next release. </font><font style="vertical-align: inherit;">Since that time, Kernel TLS RX support has been added, and SSL_sendfile () is a call to the corresponding syscall with a little handling of possible situations in the TLS protocol. </font><font style="vertical-align: inherit;">But now in the year 2020, OpenSSL 3.0 has not yet come out, TLSv1.3 is supported by the vast majority of browsers, and the AES128-GCM cipher is actively replaced by the more resistant AES256-GCM. </font><font style="vertical-align: inherit;">So I took the liberty and sent a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pull Request</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to support new ciphers and TLSv1.3 in the hope that they would accept it before the new release of the library.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support in WEB-servers</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But supporting Kernel TLS in the TLS library is not enough. Reports about the technology said that maximum efficiency can be obtained using sending without copying data to user-space - using the sendfile () system call. And the server application should be able to distinguish between situations where you can use sendfile () on a socket with TLS, and when you need to do ‚Äúread the old way‚Äù read () / SSL_write (). Some progress towards adding functionality to Nginx appeared in April 2019, but no changes were accepted to the main code. The developers' position is that the API for these functions in OpenSSL has not yet been approved, and the actual code proposed in the patch does not seem to be sufficiently portable to different platforms. To be honest, the code not only does not look very nice, but it also contains errors that prevent Nginx from being built without additional corrections.I could not find Kernel TLS support in other web servers at all (maybe someone saw it - tell me in the comments).</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And what to do?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
While the community is awaiting the release of OpenSSL 3.0, in order to start developing support for Kernel TLS in Nginx with a stable API, I went the other way. </font><font style="vertical-align: inherit;">In my </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cozy corner of</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GitHub, I did 2 things:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I created an </font><font style="vertical-align: inherit;">OpenSSL </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fork</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and backported everything related to Kernel TLS to the stable version of OpenSSL 1.1.1 (OpenSSL_1_1_1-ktls branch). </font><font style="vertical-align: inherit;">Especially in order to be able to check the functionality in conditions of stable operation of the rest of the library. </font><font style="vertical-align: inherit;">As stable versions become available, I try to rebase so that the fork is up to date.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I created a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fork of</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nginx, in which I added (based on a patch from Mellanox) support for calling SSL_sendfile () in conditions when it is really possible and with the necessary SSL socket checks, and the ability to enable / disable the functionality through the configuration variable. </font><font style="vertical-align: inherit;">In addition to this feature, in my fork there are also several patches that optimize the work of Nginx a bit and fix some bugs (master-feature branch). </font><font style="vertical-align: inherit;">As far as possible, I try to rebase based on the master branch of the Nginx main repo, in order to keep the fork up to date.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I invite everyone to take part in testing. </font><font style="vertical-align: inherit;">Comments and corrections to the code can be thrown at Issues on GitHub. </font><font style="vertical-align: inherit;">To build this Nginx with this OpenSSL and the included Kernel TLS support, add parameters to the configure script:</font></font><br>
<br>
<pre><code class="bash hljs">./configure --with-openssl=&lt;OpenSSL-fork-dir&gt; --with-openssl-opt=<span class="hljs-string">"enable-ktls"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment, I don‚Äôt have the opportunity to test this Nginx + OpenSSL bundle under heavy load to confirm the performance from the comment on the Nginx patch, so if suddenly someone can measure the difference in CPU load at high file upload speeds, it would be great to get graphs and add them into an article for a visual understanding of the effect.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501000/index.html">Code generation in Go by the example of creating a client for the database</a></li>
<li><a href="../en501002/index.html">Umka: new statically typed scripting language</a></li>
<li><a href="../en501004/index.html">Do it. Work</a></li>
<li><a href="../en501006/index.html">We are friends STM32 with LCD display 1604 on I2C bus (HAL library)</a></li>
<li><a href="../en501008/index.html">Dominos paving</a></li>
<li><a href="../en501012/index.html">How I was looking for a kid engine for a blog</a></li>
<li><a href="../en501016/index.html">On the development trends of the processor architecture, or why I believe in the success of Huawei in the server market</a></li>
<li><a href="../en501018/index.html">How to get around some google translate restrictions</a></li>
<li><a href="../en501020/index.html">How to test code containing setTimeout / setInterval under the hood</a></li>
<li><a href="../en501022/index.html">‚ÄúI am in the desert‚Äù: why self-isolation turned out to be a serious stress for us and what it all resulted in</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>