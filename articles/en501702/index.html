<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ûüèª üßíüèº üåÇ Visualization of Promises and Async / Await ü§æ üèÄ üíÉüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, friends! 
 
 I present to you the translation of the article "JavaScript Visualized: Promises & Async / Await" by Lydia Hallie. 
 
 Have you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Visualization of Promises and Async / Await</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501702/"><img src="https://habrastorage.org/webt/bu/rt/-e/burt-epjeqoebt-fjzxyhekod2m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Good day, friends! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I present to you the translation of the article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"JavaScript Visualized: Promises &amp; Async / Await"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by Lydia Hallie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Have you come across JavaScript code that ... does not work as expected? </font><font style="vertical-align: inherit;">When functions are performed in an arbitrary, unpredictable order, or are performed with a delay. </font><font style="vertical-align: inherit;">One of the main tasks of promises is to streamline the execution of functions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
My insatiable curiosity and sleepless nights paid off in full - thanks to them I created several animations. </font><font style="vertical-align: inherit;">It's time to talk about promises: how they work, why they should be used, and how it's done.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When writing JS code, we often have to deal with tasks that depend on other tasks. Suppose we want to get an image, compress it, apply a filter to it and save it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First of all, we need to get an image. To do this, use the function </font></font><code>getImage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. After loading the image, we pass it to the function </font></font><code>resizeImage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. After compressing the image, we apply a filter to it using the function </font></font><code>applyFilter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. After compression and applying the filter, we save the image and inform the user about the success. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we obtain the following:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vy/sf/kq/vysfkqrpan_45kt7zkasehy14m4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hmm ... Have you noticed anything? </font><font style="vertical-align: inherit;">Despite the fact that everything works, it does not look the best way. </font><font style="vertical-align: inherit;">We get many nested callback functions that depend on previous callbacks. </font><font style="vertical-align: inherit;">This is called callback hell and it makes it very difficult to read and maintain code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, today we have promises.</font></font><br>
<br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Promise Syntax</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Promises were introduced in ES6. </font><font style="vertical-align: inherit;">In many manuals you can read the following:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A promise (promise) is a value that is fulfilled or rejected in the future.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yeah ... So-so explanation. </font><font style="vertical-align: inherit;">At one time, it made me consider promises to be something strange, vague, some kind of magic. </font><font style="vertical-align: inherit;">What are they really? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We can create a promise with a constructor </font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that takes a callback function as an argument. </font><font style="vertical-align: inherit;">Cool, let's try: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yx/or/hu/yxorhuwt-ogj2_grnqpexlducek.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wait, what's coming back here? </font></font><br>
<br>
<code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Is an object that contains status ( </font></font><code>[[PromiseStatus]]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and value ( </font></font><code>[[PromiseValue]]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">In the above example, the value </font></font><code>[[PromiseStatus]]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is </font></font><code>pending</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the value of the promise is </font></font><code>undefined</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do not worry, you do not have to interact with this object, you can not even access the </font></font><code>[[PromiseStatus]]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font><font style="vertical-align: inherit;">properties </font></font><code>[[PromiseValue]]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">However, these properties are very important when working with promises.</font></font><br>
<br>
<code>PromiseStatus</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or the status of a promise can take one of three values:</font></font><br>
<br>
<ul>
<li><code>fulfilled</code>:   <code>resolved</code> ().   ,  </li>
<li><code>rejected</code>:   <code>rejected</code> ().  - </li>
<li><code>pending</code>:       ,  <code>pending</code> (,    )</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sounds great, but when does a promise get the indicated statuses? And why does status matter? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the above example, we pass a </font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simple callback function to the </font><font style="vertical-align: inherit;">constructor </font></font><code>() =&gt; {}</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This function actually takes two arguments. The value of the first argument, usually called </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>res</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, is the method invoked when the promise is executed. The value of the second argument, usually called </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>rej</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, is the method called when the promise is rejected when something went wrong. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ph/ev/5o/phev5oy-unumotchrvnwquasnas.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what is output to the console when calling the methods </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0o/oc/jr/0oocjrmqi757q-x4decxez9rana.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cool! Now we know how to get rid of status </font></font><code>pending</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and meaning </font></font><code>undefined</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The status of the promise when calling the method </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is </font></font><code>fulfilled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, when </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-</font></font><code>rejected</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<code>[[PromiseValue]]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or the value of the promise is the value that we pass to the methods </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as an argument. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fun fact: Jake Archibald after reading this article pointed to a bug in Chrome, which instead </font></font><code>fulfilled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returned </font></font><code>resolved</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/wv/zd/6y/wvzd6y2g_mz5act3lvnpjkacebm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ok, now we know how to work with the object </font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. But what is it used for? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the introduction, I gave an example in which we get an image, compress it, apply a filter to it and save it. Then it all ended with callback hell. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fortunately, promises help to cope with this. We rewrite the code so that each function returns a promise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If the image has loaded, we perform a promise. Otherwise, if an error occurs, reject the promise:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ci/7w/s3/ci7ws3oh1myicklbwzotn0ge1ge.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what happens when this code is run in the terminal: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/kf/vx/01/kfvx01bguyyok5fdwcgnsr2qzfk.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cool! </font><font style="vertical-align: inherit;">Promis returns with parsed (‚Äúparsed‚Äù) data, as we expected. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But ... what's next? </font><font style="vertical-align: inherit;">We are not interested in the subject of promis, we are interested in its data. </font><font style="vertical-align: inherit;">There are 3 built-in methods for obtaining a Promise value:</font></font><br>
<br>
<ul>
<li><code>.then()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: called after performing a promise</font></font></li>
<li><code>.catch()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: called after the rejection of the promise</font></font></li>
<li><code>.finally()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: always called, both after execution and after rejection of a promise</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/jm/kx/bl/jmkxblijk89jgqpte14xgimhp4q.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The method </font></font><code>.then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">takes the value passed to the method </font></font><code>resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/o5/tb/xo/o5tbxoro5xa0cfx80ijumefdg_e.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The method </font></font><code>.catch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">takes the value passed to the method </font></font><code>reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/8i/6p/vm/8i6pvmsr8uyhrmrlqlfry3o2fzo.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, we got the desired value. We can do anything with this value. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we are confident in the fulfillment or rejection of a promise, you can write </font></font><code>Promise.resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">either </font></font><code>Promise.reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the appropriate value. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ni/oz/3h/nioz3hmwq-ercnvsi8xc4isphtk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the syntax that will be used in the following examples.</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The result </font></font><code>.then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is the value of the promise (i.e., this method also returns the promise). </font><font style="vertical-align: inherit;">This means that we can use as much </font></font><code>.then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as needed: the result of the previous </font></font><code>.then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is passed as an argument to the next </font></font><code>.then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/6_/z_/ga6_z_34tprviih5r2yf1afyaoe.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In </font></font><code>getImage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we can use several </font></font><code>.then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to transfer the processed image to the next function. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6t/va/8w/6tva8wgrrpmr3yk1h131dhaxcmq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This syntax looks much better than the ladder of nested callback functions.</font></font><br>
<br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microtasks and (macro) tasks</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, now we know how to create promises and how to extract values ‚Äã‚Äãfrom them. Add some code to our script and run it again: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/47/pd/id/47pdidukvud0u2p8eibdk3ytmiu.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, it is displayed in the console </font></font><code>Start!</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This is normal, since we have the first line of code </font></font><code>console.log('Start!')</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The second value displayed on the console is </font></font><code>End!</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, not the value of the completed promise. The value of the promise is displayed last. Why did it happen? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here we see the power of promises. Although JS is single-threaded, we can make the code asynchronous with </font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where else could we observe asynchronous behavior? Some methods built into the browser, such as </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, can simulate asynchrony.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Right </font><font style="vertical-align: inherit;">In the event loop (Event Loop), there are two types of queues: the queue of (macro) tasks or simply tasks ((macro) task queue, task queue) and the queue of microtasks or just microtasks (microtask queue, microtasks). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What applies to each of them? </font><font style="vertical-align: inherit;">In short, then:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Macro Tasks: setTimeout, setInterval, setImmediate</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microtasks: process.nextTick, Promise callback, queueMicrotask</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We see </font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the list of microtasks. </font><font style="vertical-align: inherit;">When the </font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">method is executed and called </font></font><code>then()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>catch()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>finally()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the callback function with the method is added to the microtask queue. </font><font style="vertical-align: inherit;">This means that the callback with the method is not executed immediately, which makes JS code asynchronous. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When is the method </font></font><code>then()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>catch()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>finally()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is it executed? </font><font style="vertical-align: inherit;">Tasks in the event loop have the following priority:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, the functions in the call stack are executed. </font><font style="vertical-align: inherit;">The values ‚Äã‚Äãreturned by these functions are removed from the stack.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the stack is freed up, microtasks are placed into it one after another (microtasks can return other microtasks, creating an endless cycle of microtasks).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the stack and the microtask queue are released, the event loop checks for macros. </font><font style="vertical-align: inherit;">Macro tasks are pushed onto the stack, executed, and deleted.</font></font></li>
</ol><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider an example:</font></font><br>
<br>
<ul>
<li><code>Task1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: A function that is added to the stack immediately, for example, by a call in code.</font></font></li>
<li><code>Task2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Task3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Task4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: Mikrozadachi example </font></font><code>then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProMIS or task added via </font></font><code>queueMicrotask</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><code>Task5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Task6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: macro tasks, for example, </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or</font></font><code>setImmediate</code></li>
</ul><br>
<img src="https://habrastorage.org/webt/xl/hp/gl/xlhpgltjfi-dxo70zyuqjimbzzu.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First </font></font><code>Task1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns a value and is removed from the stack. Then the engine checks for microtasks in the corresponding queue. After adding and subsequently removing microtasks from the stack, the engine checks for macro tasks, which are also added to the stack and removed from it after returning the values. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enough words. Let's write the code. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/_h/oj/ee/_hojeek-qp4i0v1fatji5qxyd4m.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this code, we have a macro </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task and a micro task </font></font><code>.then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Run the code and see what is displayed in the console. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Note: in the above example, I use methods such as </font></font><code>console.log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>Promise.resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. All of these methods are internal, so they do not appear in the stack trace - do not be surprised when you do not find them in the browser troubleshooting tools. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the first line we have</font></font><code>console.log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It is added to the stack and displayed in the console </font></font><code>Start!</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. After that, this method is removed from the stack and the engine continues to parse the code. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pc/ss/nu/pcssnuqx9bbmlywvd6zearuoaqu.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The engine reaches </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which is added to the stack. This method is a built-in browser method: its callback function ( </font></font><code>() =&gt; console.log('In timeout')</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) is added to the Web API and is there before the timer fires. Despite the fact that the timer counter is 0, the callback is still placed first in the WebAPI and then in the macro task queue: </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- this is a macro task. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9t/yq/yw/9tyqywfouzwyjiks-b41l5vtxq4.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, the engine reaches the method </font></font><code>Promise.resolve()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This method is added to the stack, and then executed with a value </font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. His callback </font></font><code>then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is placed in the microtask queue. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/mi/np/acminp3ylrdseonspqvm_m_nq44.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finally, the engine reaches the second method </font></font><code>console.log()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It is immediately pushed onto the stack, it is output to the console</font></font><code>End!</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the method is removed from the stack, and the engine continues. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/76/wt/z0/76wtz0lpgee1nuob0vz2coji-fw.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The engine ‚Äúsees‚Äù that the stack is empty. </font><font style="vertical-align: inherit;">Checking the task queue. </font><font style="vertical-align: inherit;">It is located there </font></font><code>then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is pushed onto the stack, the value of the promise is displayed on the console: in this case, a string </font></font><code>Promise!</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1n/5u/05/1n5u05wug2yzg2hqfftf2lilaci.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The engine sees that the stack is empty. </font><font style="vertical-align: inherit;">He "looks" in the queue of microtasks. </font><font style="vertical-align: inherit;">She is empty too. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's time to check the macro task queue: it's there </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is pushed onto the stack and returns a method </font></font><code>console.log()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A string is output to the console </font></font><code>'In timeout!'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>setTimeout</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is removed from the stack. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/6v/42/lo/6v42lobbr5hkg5y4tvrt5rapwio.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Done. </font><font style="vertical-align: inherit;">Now everything fell into place, right?</font></font><br>
<br>
<hr><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Async / await</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ES7 introduced a new way to work with asynchronous code in JS. Using the keywords </font></font><code>async</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we can create an asynchronous function that implicitly returns a promise. But ... how do we do this? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Earlier, we discussed how to explicitly create an object </font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: using </font></font><code>new Promise(() =&gt; {})</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Promise.resolve</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>Promise.reject</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instead, we can create an asynchronous function that implicitly returns the specified object. This means that we no longer need to manually create </font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/me/py/py/mepypyet9xa6eky4slldnhflprs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fact that an asynchronous function implicitly returns a promise is, of course, great, but the power of this function is fully manifested when using a keyword </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">makes the asynchronous function wait for the promise (its value) to complete. To get the value of the performed promise, we must assign the variable the expected (awaited) value of the promise. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turns out that we can delay the execution of an asynchronous function? Great, but ... what does that mean? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's see what happens when you run the following code:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vh/wt/o0/vhwto0gbbpku7nehrlg5fe1nsni.gif"><br>
<br>
<hr><br>
<img src="https://habrastorage.org/webt/tk/zo/nx/tkzonxqy0rpal2gsghjjok33elg.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first the engine sees </font></font><code>console.log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This method is pushed onto the stack and displayed on the console </font></font><code>Before function!</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/hr/7u/k4/hr7uk471lkclnrkq6j4reflsaem.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then the asynchronous function is called </font></font><code>myFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, its code is executed. In the first line of this code, we call the second </font></font><code>console.log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a line </font></font><code>'In function!'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This method is added to the stack, its value is displayed on the console, and it is removed from the stack. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/x8/0k/bq/x80kbq_ivdjxkn5otwj7iraowiu.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The function code is executed next. On the second line we have a keyword </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thing that happens here is the execution of the expected value: in this case, the function </font></font><code>one</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It is pushed onto the stack and returns a promise. After the promise has been completed, and the function </font></font><code>one</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returned the value, the engine sees </font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, the execution of the asynchronous function is delayed. The execution of the function body is suspended, the remaining code is executed as a microtask. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/nq/iz/w6/nqizw6g6lhqkheesua-yai1etwy.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the execution of the asynchronous function has been delayed, the engine returns to the execution of the code in a global context. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/e-/ad/ea/e-adeazwnxkl63oawcydpapig1a.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After all the code has been executed in a global context, the event loop checks for microtasks and detects </font></font><code>myFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><code>myFunc()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pushed onto the stack and executed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The variable </font></font><code>res</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gets the value of the executed promise returned by the function </font></font><code>one</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. We call </font></font><code>console.log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the value of the variable </font></font><code>res</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: a string </font></font><code>One!</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in this case. </font></font><code>One!</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is displayed in the console. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Done. Notice the difference between the asynchronous function and the </font></font><code>then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">promis </font><font style="vertical-align: inherit;">method </font><font style="vertical-align: inherit;">? Keyword</font></font><code>await</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">postpones the execution of an asynchronous function. </font><font style="vertical-align: inherit;">If we used </font></font><code>then</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then the Promise body would continue to run.</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turned out pretty verbose. </font><font style="vertical-align: inherit;">Do not worry if you feel insecure when working with promises. </font><font style="vertical-align: inherit;">It takes some time to get used to them. </font><font style="vertical-align: inherit;">This is common to all techniques for working with asynchronous code in JS. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also see </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Visualization of the work of service workers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;">" </font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Thank you for your time. </font><font style="vertical-align: inherit;">I hope it was well spent.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501684/index.html">Cloister -> easy OTP cluster management</a></li>
<li><a href="../en501688/index.html">Additional SSR performance with Nuxt fullstack server (Part 2)</a></li>
<li><a href="../en501690/index.html">Who is a DevOps engineer, what does he do, how much he earns and how to become one</a></li>
<li><a href="../en501696/index.html">Dashboard Postgresql Overview for postgres_exporter (Prometheus)</a></li>
<li><a href="../en501698/index.html">We have reduced the time for developing a new scenario for publishing an advertisement from 6 days to 42 seconds</a></li>
<li><a href="../en501704/index.html">Is the project going to a new level? Testing needed</a></li>
<li><a href="../en501706/index.html">How to make a good short report</a></li>
<li><a href="../en501708/index.html">Adapting open and closed glasses to a half mask, and a home-made shutter for open glasses</a></li>
<li><a href="../en501710/index.html">For which niches crisis 2020 is the best time for development</a></li>
<li><a href="../en501712/index.html">Talking about tests: some stories and a survey</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>