<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏻‍🎤 👷🏼 👨‍👧‍👧 NoVerify: a PHP linter that works fast 🚽 🧑🏽‍🤝‍🧑🏻 🏴󠁧󠁢󠁥󠁮󠁧󠁿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are good static analysis utilities for PHP: PHPStan, Psalm, Phan, Exakat. Linters do their job well, but very slowly, because almost all are wri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>NoVerify: a PHP linter that works fast</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/487260/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are good static analysis utilities for PHP: PHPStan, Psalm, Phan, Exakat. </font><font style="vertical-align: inherit;">Linters do their job well, but very slowly, because almost all are written in PHP (or Java). </font><font style="vertical-align: inherit;">For personal use or a small project, this is normal, but for a site with millions of users, this is a critical factor. </font><font style="vertical-align: inherit;">A slow linter slows down the CI pipeline and makes it impossible to use it as a solution that can be integrated into a text editor or IDE. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/of/zg/kr/ofzgkrouigpm_lqdgdxepukek4q.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A site with millions of users is VKontakte. </font><font style="vertical-align: inherit;">Development and addition of new functions, testing and fixing bugs, reviews - all this should go quickly, in the conditions of hard deadlines. </font><font style="vertical-align: inherit;">Therefore, a good and fast linter that can check the code base for 5 million lines in 5-10 seconds is an irreplaceable thing.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are no suitable linters on the market, so Yuri Nasretdinov (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">youROCK</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) from VKontakte wrote his help to development teams - NoVerify. </font><font style="vertical-align: inherit;">This is a linter for PHP, which is written in Go. </font><font style="vertical-align: inherit;">It works 10-30 times faster than analogs, can find something that PhpStorm does not warn about, easily extends and integrates well into projects in which they have not heard of static analysis before.&nbsp;</font><strong><font style="vertical-align: inherit;">Iskander Sharipov</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
will tell about this linter </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Under the cat: how to choose a linter and prefer to write your own, why NoVerify is so fast and how it is arranged inside, why it is written in Go, what it can find and how it expands, what compromises you had to make for it and what can be built on its basis.</font></font><br>
<a name="habracut"></a><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/dlcDvUTQ5Lk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Iskander Sharipov</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quasilyte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) works in the backend infrastructure of VKontakte and is well acquainted with NoVerify. </font><font style="vertical-align: inherit;">In the past, he was engaged in the Go-compiler in the Intel team. </font><font style="vertical-align: inherit;">He doesn’t write in PHP, but this is his favorite language for static analysis - it has a lot of things that can go wrong. </font></font><br>
<br>
<i><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note. </font></font></strong></i><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To understand the background, read the article by Yuri Nasretdinov, the author of NoVerify on </font></font></i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Habré,</font></font></i></a><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> with a background and comparison with some existing linters, which are usually written in PHP. </font><font style="vertical-align: inherit;">All statements in the direction of PHP (in the article by Yuri and here) are a joke. </font><font style="vertical-align: inherit;">Iskander loves PHP, everyone loves PHP.</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Product Development</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In VKontakte, this is a website development on KPHP. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Speed ​​is important for VKontakte:</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fixing bugs, adding and developing new functions from the first phase to the last. But </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">speed is accompanied by errors</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , especially when there are hard deadlines - we are in a hurry, nervous and make more mistakes than in a calm situation. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Errors affect users</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . We do not want them to suffer, therefore we control quality. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But quality control slows down development</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This we also do not want, so the effect must be minimized. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, we could conduct </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">more</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> code </font><strong><font style="vertical-align: inherit;">reviews</font></strong><font style="vertical-align: inherit;"> without fail, hire </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">more testers</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and write more tests. </font><font style="vertical-align: inherit;">But all this is poorly automated: the review must be done, and the tests must be written. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main tasks of my team are different. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collect metrics, analyze and quickly repair</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">If something went wrong, we want to quickly roll it back, understand what’s wrong, fix it and quickly add the working code back to production. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitor the rigor of the pipeline</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> so that non-working code doesn’t get into production at all - you don’t need to roll it back. </font><font style="vertical-align: inherit;">Here linters come to the rescue - static code analyzers. </font><font style="vertical-align: inherit;">We’ll talk about this.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Choose a linter</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's choose a linter that we add to the pipeline. We take a simple approach - we formulate the requirements. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linter should work fast</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . There are several steps in our pipeline: the operation of the linter should not take much time and time-consuming developer, while he is waiting for feedback. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support for "their" checks</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Most likely, the linter does not have everything we need - we will have to add our own checks. They should find problems typical of our code base, check the code from the point of view of our project. Not all of this can be (or conveniently) covered by tests. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Support for “own” checks</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">We can write many tests, but will they be well supported? </font><font style="vertical-align: inherit;">For example, if we write on regular expressions, they will become more complicated when you need to take into account the context, semantics and syntax of the language. </font><font style="vertical-align: inherit;">Therefore, tests are not an option. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Most of the linters we reviewed are written in PHP. </font><font style="vertical-align: inherit;">But they do not pass on demand. </font><font style="vertical-align: inherit;">Linters in PHP (there is no AOT compilation yet) work 10-20 times slower than in other languages ​​- our largest file can be analyzed for tens of seconds. </font><font style="vertical-align: inherit;">This slows down the workflow too much and too much — this is a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fatal flaw</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">What do developers do in this case? </font><font style="vertical-align: inherit;">They write their own. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, we wrote our NoVerify PHP linter on Go. </font><font style="vertical-align: inherit;">Why on it? </font><font style="vertical-align: inherit;">Spoiler: not only because Jura decided so.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Noverify</font></font></h3><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go is a good compromise between development speed and productivity.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first "proof" in the picture with "infographics": good execution speed, easy support. </font><font style="vertical-align: inherit;">We lose in speed of development, but the first two points are more important to us.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c67/bfb/e53/c67bfbe537c7b8996cc429cef661c377.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The figures are taken from the head, they are not backed up by anything. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For the second “evidence”, he argued more simply.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c10/6e7/2e9/c106e72e9b04791cd5abd3097664c875.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PHP is slower, Go is faster, and so on.&nbsp;</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
We chose Go for three reasons. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go as a language for utilities is easy to learn at a basic level</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In the PHP development team, for sure, someone heard about Go, looked at Docker, knows that it is written in Go, maybe even saw the source. With a basic understanding, after one or two weeks of intensive Go learning, they will be able to write code on it. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go is quite effective</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Even a beginner will not be able to make many mistakes, because Go has good tuning and a lot of linter. In Go, the average code is slightly better than in other languages, because there are much fewer ways to shoot your own leg. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go apps are easy to maintain.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go is a fairly mature programming language for which almost all the developer tools that you can wish for are available. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We will verify NoVerify with our requirements.</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NoVerify is </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">several times faster than alternatives</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For it, you can </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">write extensions</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , both Open Source, and your own. </font><font style="vertical-align: inherit;">It is important that we can separate these checks, and you can write your own.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Easy to test and develop. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Partly, because the standard Go distribution has a standard framework with profiling and testing. </font><font style="vertical-align: inherit;">It is mainly used for unit testing. </font><font style="vertical-align: inherit;">Particularly dexterous can be used for integration, as we do - we have integration testing written through Go tests.</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compromise of Integration</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's start with the problem. </font><font style="vertical-align: inherit;">When you start any linter for the </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">first time</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on an old project that did not use any analysis, you will most likely see this. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/rx/yu/qz/rxyuqz6edr8po3uc7xo87byzgpu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh my code! </font><font style="vertical-align: inherit;">No one will ever correct so many mistakes. </font><font style="vertical-align: inherit;">I want to close the project, remove the linter and never run it again. </font><font style="vertical-align: inherit;">What to do to avoid this?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Integrate</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run in diff mode</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . We do not want to run all checks on the whole project with a million errors at every CI step. Perhaps you know about baseline: in NoVerify, this is out of the box, you do not need to embed a separate utility. We immediately considered that such a regime was needed. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add legacy (vendors) to the exceptions</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It’s easier not to touch some things, to leave aside even with a defect, so as not to modify it yourself and not leave a mark in history. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We start with a subset of checks</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . You can not connect everything that includes style. To begin with, it finds real bugs: we’ll find, fix, and switch to something new. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We collect feedback from colleagues</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">How to understand when it's time to turn on something else? </font><font style="vertical-align: inherit;">Ask colleagues. </font><font style="vertical-align: inherit;">As soon as they are glad that the errors have disappeared and almost nothing is found, turn on something else - it's time to work.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Git setup</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diff mode means that you have a version control system - Git. If you have SVN, then the instruction will not help, go to Git. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We install pre-push hook with a linter</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and check before we start the code. We check on the local machine </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> an </font><strong><font style="vertical-align: inherit;">option </font></strong></font><code>--no-verify</code><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to bypass the linter</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It would probably be more convenient to use a pre-receive hook and disable the server-side linter, but for historical reasons, a lot of things happen in VK in a pre-push hook, so NoVerify was built in there too. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After the push, CI checks are launched. NoVerify has two modes of operation: with full analysis and without it. On CI, you most likely want (and can) run</font></font><code>--git-full-diff</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- machines in CI can be loaded harder and check even those files that have not changed. </font><font style="vertical-align: inherit;">On local machines, we can run a less strict, but faster analysis of only changed files (5-15 seconds faster).&nbsp;</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">False positives</font></font></h3><br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5c8/508/9c9/5c85089c909c79ed02c4c72f25bb9850.jpg"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the example below: in this function, something containing a field is accepted, but the type is not described in any way. </font><font style="vertical-align: inherit;">It is not a fact that there is a field at all when a function is called from different contexts. </font><font style="vertical-align: inherit;">In a strict version, the linter could complain: “It is not clear what type it is, how can I return a field without checks?” </font><font style="vertical-align: inherit;">But this is not necessarily a mistake.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_foo</span>(<span class="hljs-params">$obj</span>) </span>{
    <span class="hljs-keyword">return</span> $obj-&gt;foo;<font></font>
    ^^^<font></font>
}<font></font>
<font></font>
Warning:<font></font>
Property <span class="hljs-string">"foo"</span> does not exist</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">False positives interfere.&nbsp;</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is the main reason for abandoning linter. </font><font style="vertical-align: inherit;">People choose other options that find fewer errors, but produce fewer false positives. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They often push around when something worked, but this is not a mistake. </font><font style="vertical-align: inherit;">Many have a mechanism to bypass linter - to run with the flag without checking the linter. </font><font style="vertical-align: inherit;">In our country, this flag was called </font></font><code>no-verify</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a pre-push hook. </font><font style="vertical-align: inherit;">We often used it and the name was immortalized in the name of the linter.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pickiness</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another linter property. </font><font style="vertical-align: inherit;">For example, many do not understand aliases. </font><font style="vertical-align: inherit;">In PHP, </font></font><code>sizeof</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this is an analogue </font></font><code>count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: it does not calculate the size, but returns the number of elements. </font><font style="vertical-align: inherit;">The mental model of C developers has a </font></font><code>sizeof</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">different meaning. </font><font style="vertical-align: inherit;">If in the code base there is </font></font><code>sizeof</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, most likely, mean </font></font><code>count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But this is nitpicking.</font></font><br>
<br>
<pre><code class="php hljs">$len = sizeof($x);<font></font>
    ^^^^^^<font></font>
<font></font>
Warning:<font></font>
<span class="hljs-keyword">use</span> "<span class="hljs-title">count</span>" <span class="hljs-title">instead</span> <span class="hljs-title">of</span> "<span class="hljs-title">sizeof</span>"</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What to do with it?</font></font></h3><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Be strict and force to rule everything without exception</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . To impose rules, to demand, to observe and not to allow them to circumvent - never works. For such rigidity to work, the team must consist of the same people: character, level of culture, pedantry and perception of the quality of the code. If this is not so, there will be a riot. It’s easier to assemble a team from your clones than to force to follow all the rules.&nbsp; </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not block push / commit on comments like fixing </font></font><code>sizeof</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><code>count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Most likely, this is not an error, but a nit-picking and does not affect the code. But then 99% of the responses will be ignored (by the team) and there will always be extra ones in the code </font></font><code>sizeof</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Allow some level of configuration for different teams and developers.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can configure the configuration for each command so that those who do not want to change </font></font><code>sizeof</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can not do this. </font><font style="vertical-align: inherit;">Let everyone else follow the rules. </font><font style="vertical-align: inherit;">A good option, but the consistency will sag, and in some directories the code will be slightly worse. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Run such checks once a month, on subbotniks</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Checks can be run not every time on the CI or pre-push hook, but in the routine Cron once a month. </font><font style="vertical-align: inherit;">Run and edit everything you find after active development. </font><font style="vertical-align: inherit;">But this work requires resources for automation and verification. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do nothing. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Turning off stylistic checks is also an option.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compromise</font></font></h3><br>
<img src="https://habrastorage.org/webt/-l/jq/ao/-ljqaougomtrtjxnr_kl_b6rgyk.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There will always be a compromise between a happy developer and a happy linter. </font><font style="vertical-align: inherit;">It is easy to make a linter happy: the most strict mode and the lack of workarounds. </font><font style="vertical-align: inherit;">Perhaps after that no one will remain in the team, so if the linter interferes with the work, this is a problem.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Useful action above all.</font></font></blockquote><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NoVerify Technical Details</font></font></h2><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Private checks VKontakte.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Noverify is written something like this. In GitHub, the NoVerify repository is divided into two parts: the framework that is used to implement the linter, and separate checks, </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vklints</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . This is done so that the linter loads third-party checks: you can write a separate module on Go and they register themselves in the framework. After starting from the NoVerify binary, the framework loads all the registered sets of checks and they work as a whole.&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/webt/s8/jj/5z/s8jj5zbegovtmxkg8ydhezx2mfw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
NoVerify is both a library and a binary (linter). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Our checks are called </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vklints</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . They find that they do not see PhpStorm and Open Source NoVerify - important errors that are not suitable for general use. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What is vklints?</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Checking the specifics of using certain functions</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , classes, and even global variables that do not follow our conventions. This is something that cannot be used in special places for various reasons described in the style guide. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Additional style checks.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> They do not correspond to what is accepted in the PHP-community, are not described in the PHP Standard Recommendation or even contradict it, but for us it is the standard. There is no point in adding them to Open Source because you don’t want to follow them. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strict comparison requirements for some types</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . For example, we have a check that requires comparing strings with a comparison operator </font></font><code>===</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. In particular, it requires passing a flag for strict comparison of functions in order to compare strings. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suspicious array keys.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another interesting mistake: sometimes, when developers commit, they can press key combinations before saving the file. </font><font style="vertical-align: inherit;">These characters sometimes remain in a string or in a piece of code. </font><font style="vertical-align: inherit;">Once, in the key of the array was the Russian letter “Y”. </font><font style="vertical-align: inherit;">Most likely, the developer pressed CTRL-S in the Russian layout, saved the file and committed. </font><font style="vertical-align: inherit;">Sometimes we find such keys in arrays, but new errors will no longer pass. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dynamic rules are a simpler NoVerify extension mechanism described in PHP. </font><font style="vertical-align: inherit;">A separate article has been written about this: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">how to add checks to NoVerify without writing a single line of Go code</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How NoVerify Works</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To parse PHP you need a </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parser</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We cannot use the PHP parser in PHP: it is slow, from Go it can only be used through a wrapper in C. Therefore, we use the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parser</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in Go. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This parser has several problems. </font><font style="vertical-align: inherit;">Unfortunately, he can only work with UTF-8 and we need to distinguish between UTF-8 and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not UTF-8</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In addition to UTF-8, Windows-1251 is often found in Russian PHP projects. </font><font style="vertical-align: inherit;">We also have such files. </font><font style="vertical-align: inherit;">How do we recognize them?&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The file </font></font><code>encodings.xml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lists all the paths where the files with UTF-8 are. </font><font style="vertical-align: inherit;">If we encounter a file outside these paths, then </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the fly we</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> stream to UTF-8 by streaming stream (without converting in advance).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c47/ace/5aa/c47ace5aa12a572a201925c6be5e522a.jpg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parsing and analysis</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Completed in a few steps. </font><font style="vertical-align: inherit;">On the first - we </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">load metadata from phpstorm-stubs</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">This is data that looks like PHP code, but is never executed and describes the types of inputs / outputs from standard functions. </font><font style="vertical-align: inherit;">The phpStorm metadata has a useful </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">override</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directive for the linter </font><font style="vertical-align: inherit;">... It allows us to describe, for example, that we accept an array of type </font></font><code>T[]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and return the type </font></font><code></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(useful for functions </font></font><code>array_pop</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">).</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c62/a79/6a6/c62a796a6fc623a27e92633d80de56c2.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Phpstorm-stubs is loaded first. </font><font style="vertical-align: inherit;">We use metadata as the initial type information - the foundation. </font><font style="vertical-align: inherit;">This foundation is absorbed by the linter and we begin to analyze the sources. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We load the current master</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> before absorption. </font><font style="vertical-align: inherit;">We check the code in two modes:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">local changes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : regarding baseline we find new errors in the code;</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we indicate the range of revisions</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : the first and last revisions, and between them everything is inclusive - this is the new code, and everything that “before” is old.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next comes the analysis stage.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3e4/d05/03b/3e4d0503b0d2932b765ba30c6d8ef698.jpg"></div><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AST analysis</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">We now have metadata, type information. </font><font style="vertical-align: inherit;">We take all the PHP-source, parsim and analyze directly above the AST - we do not have an intermediate representation at the moment. </font><font style="vertical-align: inherit;">Analyzing a raw AST is not very convenient, especially if you depend on the libraries and data types that it represents.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/43c/864/84c/43c86484c14609526fb5db5228bb7f67.jpg"></div><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The analysis results are stored in the cache</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . It is used in reanalysis, which is much faster. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reports and filtering</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Then we generate </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reports or warnings</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> twice </font><font style="vertical-align: inherit;">: first we find warnings for the old version of the code (before baseline), then for the new one. Reports are filtered by comparison (diff) - we look for warnings that appeared in the new version of the code and pass them to the user. In some static analyzers, this is called “baseline mode”.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b0c/469/a6d/b0c469a6d2d66eb821b38a37fdd4b828.jpg"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Double code analysis (in diff mode) is very slow. </font><font style="vertical-align: inherit;">But we can afford it - NoVerify is still dozens of times faster than other PHP linkers. </font><font style="vertical-align: inherit;">At the same time, it has a reserve for additional acceleration, at least by 30 percent. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How do we analyze files? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In PHP, you can call a function before it is defined - you need to know the information about this function before analyzing it. </font><font style="vertical-align: inherit;">Therefore, first we go through the entire file in AST, index it, identify the types of all functions, register the classes, and only then analyze it.&nbsp;</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9a6/5f2/844/9a65f2844b9ba3cf78e8b4dee2616430.jpg"></div><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analysis is the second pass through the file</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Most interpreters and compilers also work with two passes and more. </font><font style="vertical-align: inherit;">In order not to “scan” the file a second time, you must have declarations before use, as in C, for example.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type inference</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most interesting part is that errors are most often encountered here. </font><font style="vertical-align: inherit;">It still does not correspond to the correctness of the PHP type system, which is difficult to define formally. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What does the model look like.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ae/8ec/ca9/8ae8ecca980c79343d149b8b1f15bb15.jpg"></div><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semantic model (demo). </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Types of types:</font></font><br>
<br>
<ul>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expected</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is what we describe in the comments. We expect some types in the program, but this does not mean that they are really used in it.</font></font></li>
<li><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actual</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - real ones that are in the program. </font><font style="vertical-align: inherit;">For example, if we assign a number to something, then it is obvious that </font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or </font></font><code>float</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(if this is a floating-point number) will be Actual types.&nbsp;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actual types seem to be "stronger" - they are real, true. </font><font style="vertical-align: inherit;">But sometimes we can get a type only by annotation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Annotations (in Expected types) can be divided into two categories: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trust</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">distrust</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">For example, phpstorm-stubs belong to the first category. </font><font style="vertical-align: inherit;">They are considered moderated (without errors) before we use them. </font><font style="vertical-align: inherit;">Unreliable ones are those that other developers write, because they may have errors. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actual types can also be divided into several parts: values, assertion, predicates and type hint, which extends the capabilities of PHP 7. But there is a problem that type hint does not solve.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expected vs Actual</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's say a class </font></font><code>Foo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">has an inheritor. From the descendant class, we can call methods that are not in Foo, because the descendant extends the parent. But if we get the heir </font></font><code>Foo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from </font></font><code>new static()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with this annotation of the return type (from </font></font><code>self</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), then a problem will arise. We can call this method, but the IDE will not prompt you - you need to specify </font></font><code>static()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This is a late </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static binding in PHP</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , when not the </font></font><code>Foo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class inheritor </font><font style="vertical-align: inherit;">can return </font><font style="vertical-align: inherit;">.&nbsp;</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> </span>{
    <span class="hljs-comment">/** <span class="hljs-doctag">@return</span> static */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newStatic</span>(<span class="hljs-params"></span>) : <span class="hljs-title">self</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">static</span>();<font></font>
    }<font></font>
}<font></font>
<span class="hljs-comment">// actual = Foo</span>
<span class="hljs-comment">// expected = static</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When we write </font></font><code>new static()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, not only the class can return </font></font><code>new Foo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">For example, if a </font></font><code>Foo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class is inherited </font><font style="vertical-align: inherit;">from </font></font><code>bar</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, then there may be </font></font><code>new bar</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Accordingly, we need at least two type information. </font><font style="vertical-align: inherit;">None of them are redundant - both are needed. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Therefore, the Actual type here will be </font></font><code>self</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- for the PHP interpreter. </font><font style="vertical-align: inherit;">But for the IDE and for the linters to work, we need </font></font><code>static</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If we call this code from the context of the heir class, we need to know the information that this is not the same base class and it has more methods.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> </span>{
    <span class="hljs-comment">/** <span class="hljs-doctag">@return</span> static */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">newStatic</span>(<span class="hljs-params"></span>) : <span class="hljs-title">self</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">static</span>();<font></font>
    }<font></font>
}<font></font>
<span class="hljs-comment">// actual -  PHP </span>
<span class="hljs-comment">// expected -   IDE/</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type hint</font></font></h3><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Static typing and type hint are not the same thing.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You may have heard that you can only check at the boundaries of functions. </font><font style="vertical-align: inherit;">At the borders, we check the inputs and outputs, where the input is the function arguments. </font><font style="vertical-align: inherit;">Inside the function, you can do any nonsense: assign a </font></font><code>foo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">value </font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, although you described what it is </font></font><code>T</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">You can complain that you are violating the types that you declared, but for PHP there is </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no error</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .&nbsp;</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params">T $foo</span>) </span>{<font></font>
        $foo = <span class="hljs-number">10</span>; <span class="hljs-comment">//  int</span>
        <span class="hljs-keyword">return</span> $foo;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
An example is more difficult - we return </font></font><code>foo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">At the beginning of the function, we determined that </font></font><code>foo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it was </font></font><code>T</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and there is no information about the return.&nbsp;</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params">T $foo</span>) </span>{<font></font>
    $foo = <span class="hljs-number">10</span>; <span class="hljs-comment">//  int</span>
    <span class="hljs-keyword">return</span> $foo;<font></font>
}<font></font>
<span class="hljs-comment">// ? 1. f -&gt; int</span>
<span class="hljs-comment">// ? 2. f -&gt; T|int</span>
<span class="hljs-comment">// ? 3. f -&gt; T</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Which type is correct? </font><font style="vertical-align: inherit;">The first two, we will analyze the difference between them. </font><font style="vertical-align: inherit;">PhpStorm and linter output the second option. </font><font style="vertical-align: inherit;">Despite the fact that it always returns </font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the type </font></font><code>T|int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is </font><font style="vertical-align: inherit;">deduced </font><font style="vertical-align: inherit;">- the "union" of types. </font><font style="vertical-align: inherit;">This is a type that can be assigned both of these values: first we had information about the type T, then we assigned it </font></font><code>10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, so the type of the variable </font></font><code>foo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">must be compatible with these two types.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Annotations</font></font></h3><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comments and annotations may lie.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the example below, we wrote that we are returning a number, but returning a string. </font><font style="vertical-align: inherit;">If the linter worked only at the level of annotations and type hint, then we would consider that it always returns </font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">But Actual types just help get away from this: here, the Expected type is this </font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the Actual type is a string. </font><font style="vertical-align: inherit;">Linter knows that the string is returned and may warn you that you promised to return </font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">This separation is important to us.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-comment">/** <span class="hljs-doctag">@return</span> int */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"I lied!"</span>; }</code></pre><br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inheritance of annotations. </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here, I mean that a class that implements some kind of interface has a method. </font><font style="vertical-align: inherit;">The method has good comments, documentation, types - it is needed to implement the interface. </font><font style="vertical-align: inherit;">But there are no comments in the implementation: there is only </font></font><code>@inheritdoc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">or nothing at all.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IFoo</span> </span>{
    <span class="hljs-comment">/** <span class="hljs-doctag">@return</span> int */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params"></span>)</span>;<font></font>
}<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Fooer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IFoo</span> </span>{
    <span class="hljs-comment">/** <span class="hljs-doctag">@inheritdoc</span> */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"10"</span>; }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What returns this method? It seems that what is described in the - interface is returned </font></font><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but in fact a string. This is not good: PHP is all the same, but convergence is important to us. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two options to fix this code. The obvious is to </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return</font></font></strong><code>int</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . But perhaps you need to return a different type. What to do? Write that we </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return the string</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In this case, explicit type information is necessary for both the IDE and the linter in order to correctly analyze the code.</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">IFoo</span> </span>{
    <span class="hljs-comment">/** <span class="hljs-doctag">@return</span> int */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params"></span>)</span>;<font></font>
}<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Fooer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IFoo</span> </span>{
    <span class="hljs-comment">/** <span class="hljs-doctag">@return</span> string */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"10"</span>; }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This information would not be needed at all if people wrote comments, not </font></font><code>@inheritdoc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is not necessary for PhpStorm to understand what types you have. </font><font style="vertical-align: inherit;">But if the types are not described correctly, there will be a problem. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PhpStorm and the linter have sets of disjoint bugs when we use the same files for metadata (types). </font><font style="vertical-align: inherit;">If we fix everything we need in phpstorm-stubs from the JetBrains repository, then the IDE will most likely break. </font><font style="vertical-align: inherit;">If you leave everything by default, not everything will work correctly </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
for us. Therefore, we have a small fork -&nbsp; </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VKCOM / phpstorm-stubs</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A couple of patches have been added to fix something that does not fit. </font><font style="vertical-align: inherit;">I can not recommend it for PhpStorm, but it is necessary for the linter to work.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open source</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Noverify is an open source project. It is posted on </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Brief instructions "if something went wrong." </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If something is broken or does not start.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The wrong reaction is to resent and remove NoVerify. The correct reaction: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://github.com/login%3Freturn_to%3D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to issue a ticket</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on GitHub and talk about your problem. Most likely, it will be resolved in 1-2 days. </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You are missing some feature.</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wrong reaction: remove NoVerify and write your own linter (although writing your own linter is always cool). The correct reaction: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://github.com/login%3Freturn_to%3D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to issue a ticket</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on GitHub and, perhaps, we will add a new function. It is more complicated with features than with errors - a discussion arises, and each person has a different vision of the implementation in the team. But in the end, they are still being implemented.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you are interested in the development of the project or you just want to talk about static analysis, go to our chat room - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">noverify_linter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<blockquote>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">  PHP-</a>,   ,  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">    </a>,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">PHP Russia</a>.<br>
 <br>
     ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> </a>.       ,    ,     .         telegram- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">@PHPRussiaConfChannel</a>.   ,  . <br>
</blockquote></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/en487260/">https://habr.com/ru/post/en487260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en487248/index.html">A little more about improper testing</a></li>
<li><a href="../en487250/index.html">Delayed Alpha blending</a></li>
<li><a href="../en487254/index.html">How to use CCTV cameras not only to monitor intruders</a></li>
<li><a href="../en487256/index.html">Burn and return from the ashes or Phoenix people</a></li>
<li><a href="../en487258/index.html">Asynchronous PHP</a></li>
<li><a href="../en487262/index.html">Open conference PHP Russia Online</a></li>
<li><a href="../en487266/index.html">GitLab 12.7 released with Parent-Child pipelines and beta version of common job handlers for Windows</a></li>
<li><a href="../en487270/index.html">Perovskites can extend the life of gadget screens</a></li>
<li><a href="../en487272/index.html">Bookmarks - counting is finished</a></li>
<li><a href="../en487274/index.html">How to do a code review?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>