<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§™ üë®üèø‚Äçüî¨ üßúüèº Gera√ß√£o de c√≥digo no Go pelo exemplo da cria√ß√£o de um cliente para o banco de dados üîß üèüÔ∏è üßëüèΩ‚Äçü§ù‚ÄçüßëüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, eu gostaria de considerar os problemas de gera√ß√£o de c√≥digo em Golang. Notei que, frequentemente, nos coment√°rios dos artigos sobre Go m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Gera√ß√£o de c√≥digo no Go pelo exemplo da cria√ß√£o de um cliente para o banco de dados</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/501000/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neste artigo, eu gostaria de considerar os problemas de gera√ß√£o de c√≥digo em Golang. </font><font style="vertical-align: inherit;">Notei que, frequentemente, nos coment√°rios dos artigos sobre Go mencionam a gera√ß√£o e a reflex√£o de c√≥digos, o que causa um debate acalorado. </font><font style="vertical-align: inherit;">Ao mesmo tempo, existem poucos artigos sobre gera√ß√£o de c√≥digo no hub, embora sejam usados ‚Äã‚Äãbastante em projetos no Go. </font><font style="vertical-align: inherit;">No artigo, tentarei dizer o que √© gera√ß√£o de c√≥digo, para descrever o escopo da aplica√ß√£o com exemplos de c√≥digo. </font><font style="vertical-align: inherit;">Al√©m disso, n√£o vou ignorar o reflexo.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando a gera√ß√£o de c√≥digo √© usada</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em Habr√© j√° existem bons artigos sobre o assunto </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , n√£o vou repetir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A gera√ß√£o de c√≥digo deve ser usada nos casos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aumentar a velocidade do c√≥digo, ou seja, para substituir a reflex√£o;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reduzir a rotina de um programador (e erros associados a ele);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementa√ß√£o de wrappers de acordo com as regras fornecidas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A partir dos exemplos, podemos considerar a biblioteca Stringer, que est√° inclu√≠da no fornecimento de idiomas padr√£o e permite gerar automaticamente m√©todos String () para conjuntos de constantes num√©ricas. </font><font style="vertical-align: inherit;">Usando-o, voc√™ pode implementar a sa√≠da de nomes de vari√°veis. </font><font style="vertical-align: inherit;">Exemplos da biblioteca foram descritos em detalhes nos artigos acima. </font><font style="vertical-align: inherit;">O exemplo mais interessante foi a deriva√ß√£o do nome da cor da paleta. </font><font style="vertical-align: inherit;">A aplica√ß√£o da gera√ß√£o de c√≥digo evita a altera√ß√£o do c√≥digo em v√°rios locais ao alterar a paleta.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De um exemplo mais pr√°tico, podemos mencionar a biblioteca easyjson do Mail.ru. </font><font style="vertical-align: inherit;">Essa biblioteca permite acelerar a execu√ß√£o do masrshall / unmarshall JSON da / para a estrutura. </font><font style="vertical-align: inherit;">Sua implementa√ß√£o em benchmarks contornou todas as alternativas. </font><font style="vertical-align: inherit;">Para usar a biblioteca, voc√™ precisa chamar easyjson, ele ir√° gerar c√≥digo para todas as estruturas que encontrar no arquivo transferido ou apenas para aquelas para as quais o coment√°rio // easyjson: json √© indicado. </font><font style="vertical-align: inherit;">Tome a estrutura do usu√°rio como um exemplo:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span>{<font></font>
    ID <span class="hljs-keyword">int</span>
    Login <span class="hljs-keyword">string</span>
    Email <span class="hljs-keyword">string</span>
    Level <span class="hljs-keyword">int</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para o arquivo em que est√° contido, execute a gera√ß√£o do c√≥digo:</font></font><br>
<br>
<pre><code class="bash hljs">easyjson -all main.go</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtemos m√©todos para o usu√°rio:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MarshalEasyJSON (w * jwriter.Writer) - para converter a estrutura em uma matriz de bytes JSON;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UnmarshalEasyJSON (l * jlexer.Lexer) - para converter de uma matriz de bytes em uma estrutura. </font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As fun√ß√µes de erro MarshalJSON () ([] byte, erro) e UnmarshalJSON (dados [] byte) s√£o necess√°rias para compatibilidade com a interface json padr√£o.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo Easyjson</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestEasyJSON</span><span class="hljs-params">()</span></span> {<font></font>
	testJSON := <span class="hljs-string">`{"ID":123, "Login":"TestUser", "Email":"user@gmail.com", "Level":12}`</span>
	JSONb := []<span class="hljs-keyword">byte</span>(testJSON)<font></font>
	fmt.Println(testJSON)<font></font>
	recvUser := &amp;User{}<font></font>
	recvUser.UnmarshalJSON(JSONb)<font></font>
	fmt.Println(recvUser)<font></font>
	recvUser.Level += <span class="hljs-number">1</span><font></font>
	outJSON, _ := recvUser.MarshalJSON()<font></font>
	fmt.Println(<span class="hljs-keyword">string</span>(outJSON))<font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nesta fun√ß√£o, primeiro convertemos o JSON em uma estrutura, adicionamos um n√≠vel e imprimimos o JSON resultante. </font><font style="vertical-align: inherit;">A gera√ß√£o de c√≥digo pelo easyjson significa livrar-se da reflex√£o em tempo de execu√ß√£o e aumentar o desempenho do c√≥digo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A gera√ß√£o de c√≥digo √© usada ativamente para criar microsservi√ßos que se comunicam via gRPC. Ele usa o formato protobuf para descrever os m√©todos de servi√ßos - usando a linguagem intermedi√°ria EDL. Ap√≥s a descri√ß√£o do servi√ßo, o compilador protoc √© iniciado, o que gera c√≥digo para a linguagem de programa√ß√£o desejada. No c√≥digo gerado, obtemos as interfaces que precisam ser implementadas no servidor e os m√©todos usados ‚Äã‚Äãno cliente para organizar a comunica√ß√£o. Acontece que, convenientemente, podemos descrever nossos servi√ßos em um √∫nico formato e gerar c√≥digo para a linguagem de programa√ß√£o na qual cada um dos elementos de intera√ß√£o ser√° descrito.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m disso, a gera√ß√£o de c√≥digo pode ser usada no desenvolvimento de estruturas. </font><font style="vertical-align: inherit;">Por exemplo, para implementar c√≥digo que n√£o precisa ser gravado pelo desenvolvedor do aplicativo, mas √© necess√°rio para a opera√ß√£o correta. </font><font style="vertical-align: inherit;">Por exemplo, para criar validadores de campo de formul√°rio, gere automaticamente o Middleware, gere dinamicamente clientes para DBMS.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementa√ß√£o do Go Code Generator</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos examinar na pr√°tica como o mecanismo de gera√ß√£o de c√≥digo no Go funciona. Antes de tudo, √© necess√°rio mencionar a AST - Abstract Syntax Tree ou Abstract Syntax Tree. Para detalhes, voc√™ pode ir √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Para nossos prop√≥sitos, √© necess√°rio entender que todo o programa √© constru√≠do na forma de um gr√°fico, onde os v√©rtices s√£o mapeados (marcados) com os operadores da linguagem de programa√ß√£o e as folhas com os operandos correspondentes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, para iniciantes, precisamos de pacotes: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">go / ast </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">go / parser / </font></font></a><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">go / token / A</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
an√°lise do arquivo com o c√≥digo e a compila√ß√£o da √°rvore s√£o executadas pelos seguintes comandos</font></font><br>
<br>
<pre><code class="go hljs"><font></font>
fset := token.NewFileSet()<font></font>
node, err := parser.ParseFile(fset, os.Args[<span class="hljs-number">1</span>], <span class="hljs-literal">nil</span>, parser.ParseComments)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Indicamos que o nome do arquivo deve ser retirado do primeiro argumento da linha de comando; tamb√©m solicitamos que coment√°rios sejam adicionados √† √°rvore. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em geral, para controlar a gera√ß√£o do c√≥digo, o usu√°rio (o desenvolvedor do c√≥digo com base no qual outro c√≥digo √© gerado) pode usar coment√°rios ou tags (enquanto escrevemos `json:" "` pr√≥ximo ao campo da estrutura). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por exemplo, escreveremos um gerador de c√≥digo para trabalhar com um banco de dados. </font><font style="vertical-align: inherit;">O gerador de c√≥digo examinar√° o arquivo transferido para ele, procurar√° estruturas que tenham um coment√°rio correspondente e criar√° um wrapper sobre a estrutura (m√©todos CRUD) para intera√ß√£o com o banco de dados. </font><font style="vertical-align: inherit;">Vamos usar os par√¢metros:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dbe comment: {"table": "users"}, no qual voc√™ pode definir a tabela na qual os registros da estrutura estar√£o;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tag dbe para os campos da estrutura, na qual √© poss√≠vel especificar o nome da coluna na qual colocar o valor e os atributos do campo para o banco de dados: primary_key e not_null. </font><font style="vertical-align: inherit;">Eles ser√£o usados ‚Äã‚Äãao criar a tabela. </font><font style="vertical-align: inherit;">E para o nome do campo, voc√™ pode usar "-" para n√£o criar uma coluna para ele.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Farei uma reserva antecipada de que o projeto ainda n√£o est√° em combate, n√£o conter√° parte das verifica√ß√µes e prote√ß√µes necess√°rias. </font><font style="vertical-align: inherit;">Se houver interesse, continuarei seu desenvolvimento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, decidimos sobre a tarefa e os par√¢metros para controlar a gera√ß√£o do c√≥digo, podemos come√ßar a escrever o c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os links para todo o c√≥digo estar√£o no final do artigo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Come√ßamos a ignorar a √°rvore resultante e analisaremos cada elemento do primeiro n√≠vel. </font><font style="vertical-align: inherit;">O Go possui tipos predefinidos para an√°lise: BadDecl, GenDecl e FuncDecl.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tipo Descri√ß√£o</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><span class="hljs-comment">// A BadDecl node is a placeholder for declarations containing</span>
<span class="hljs-comment">// syntax errors for which no correct declaration nodes can be</span>
<span class="hljs-comment">// created.</span>
<span class="hljs-comment">//</span>
BadDecl <span class="hljs-keyword">struct</span> {<font></font>
    From, To token.Pos <span class="hljs-comment">// position range of bad declaration</span><font></font>
}<font></font>
<span class="hljs-comment">// A GenDecl node (generic declaration node) represents an import,</span>
<span class="hljs-comment">// constant, type or variable declaration. A valid Lparen position</span>
<span class="hljs-comment">// (Lparen.IsValid()) indicates a parenthesized declaration.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Relationship between Tok value and Specs element type:</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// token.IMPORT *ImportSpec</span>
<span class="hljs-comment">// token.CONST *ValueSpec</span>
<span class="hljs-comment">// token.TYPE *TypeSpec</span>
<span class="hljs-comment">// token.VAR *ValueSpec</span>
<span class="hljs-comment">//</span>
GenDecl <span class="hljs-keyword">struct</span> {<font></font>
    Doc *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span>
    TokPos token.Pos <span class="hljs-comment">// position of Tok</span>
    Tok token.Token <span class="hljs-comment">// IMPORT, CONST, TYPE, VAR</span>
    Lparen token.Pos <span class="hljs-comment">// position of '(', if any</span><font></font>
    Specs []Spec<font></font>
    Rparen token.Pos <span class="hljs-comment">// position of ')', if any</span><font></font>
}<font></font>
<span class="hljs-comment">// A FuncDecl node represents a function declaration.</span>
FuncDecl <span class="hljs-keyword">struct</span> {<font></font>
    Doc *CommentGroup <span class="hljs-comment">// associated documentation; or nil</span>
    Recv *FieldList <span class="hljs-comment">// receiver (methods); or nil (functions)</span>
    Name *Ident <span class="hljs-comment">// function/method name</span>
    Type *FuncType <span class="hljs-comment">// function signature: parameters, results, and position of "func" keyword</span>
    Body *BlockStmt <span class="hljs-comment">// function body; or nil for external (non-Go) function</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como estamos interessados ‚Äã‚Äãem estruturas, usamos o GenDecl. </font><font style="vertical-align: inherit;">Nesse est√°gio, FuncDecl pode ser √∫til, no qual as defini√ß√µes de fun√ß√µes se encontram e voc√™ as agrupa, mas agora n√£o precisamos delas. </font><font style="vertical-align: inherit;">A seguir, examinamos a matriz Specs em cada n√≥ e procuramos trabalhar com um campo de defini√ß√£o de tipo (* ast.TypeSpec) e essa √© uma estrutura (* ast.StructType). </font><font style="vertical-align: inherit;">Depois de determinarmos que temos uma estrutura, verificamos que ela possui um coment√°rio // dbe. </font><font style="vertical-align: inherit;">O c√≥digo de passagem da √°rvore completa e a defini√ß√£o de qual estrutura trabalhar est√£o abaixo.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atravessar √°rvores e obter estruturas</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-keyword">for</span> _, f := <span class="hljs-keyword">range</span> node.Decls {<font></font>
	genD, ok := f.(*ast.GenDecl)<font></font>
	<span class="hljs-keyword">if</span> !ok {<font></font>
		fmt.Printf(<span class="hljs-string">"SKIP %T is not *ast.GenDecl\n"</span>, f)
		<span class="hljs-keyword">continue</span><font></font>
	}<font></font>
	targetStruct := &amp;StructInfo{}<font></font>
	<span class="hljs-keyword">var</span> thisIsStruct <span class="hljs-keyword">bool</span>
	<span class="hljs-keyword">for</span> _, spec := <span class="hljs-keyword">range</span> genD.Specs {<font></font>
		currType, ok := spec.(*ast.TypeSpec)<font></font>
		<span class="hljs-keyword">if</span> !ok {<font></font>
			fmt.Printf(<span class="hljs-string">"SKIP %T is not ast.TypeSpec\n"</span>, spec)
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
<font></font>
		currStruct, ok := currType.Type.(*ast.StructType)<font></font>
		<span class="hljs-keyword">if</span> !ok {<font></font>
			fmt.Printf(<span class="hljs-string">"SKIP %T is not ast.StructType\n"</span>, currStruct)
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
		targetStruct.Name = currType.Name.Name<font></font>
		thisIsStruct = <span class="hljs-literal">true</span><font></font>
	}<font></font>
	<span class="hljs-comment">//Getting comments</span>
	<span class="hljs-keyword">var</span> needCodegen <span class="hljs-keyword">bool</span>
	<span class="hljs-keyword">var</span> dbeParams <span class="hljs-keyword">string</span>
	<span class="hljs-keyword">if</span> thisIsStruct {
		<span class="hljs-keyword">for</span> _, comment := <span class="hljs-keyword">range</span> genD.Doc.List {<font></font>
			needCodegen = needCodegen || strings.HasPrefix(comment.Text, <span class="hljs-string">"// dbe"</span>)
			<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(comment.Text) &lt; <span class="hljs-number">7</span> {<font></font>
				dbeParams = <span class="hljs-string">""</span>
			} <span class="hljs-keyword">else</span> {<font></font>
				dbeParams = strings.Replace(comment.Text, <span class="hljs-string">"// dbe:"</span>, <span class="hljs-string">""</span>, <span class="hljs-number">1</span>)<font></font>
			}<font></font>
		}<font></font>
	}<font></font>
	<span class="hljs-keyword">if</span> needCodegen {<font></font>
		targetStruct.Target = genD<font></font>
		genParams := &amp;DbeParam{}<font></font>
		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(dbeParams) != <span class="hljs-number">0</span> {<font></font>
			err := json.Unmarshal([]<span class="hljs-keyword">byte</span>(dbeParams), genParams)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
				fmt.Printf(<span class="hljs-string">"Error encoding DBE params for structure %s\n"</span>, targetStruct.Name)
				<span class="hljs-keyword">continue</span><font></font>
			}<font></font>
		} <span class="hljs-keyword">else</span> {<font></font>
			genParams.TableName = targetStruct.Name<font></font>
		}<font></font>
<font></font>
		targetStruct.GenParam = genParams<font></font>
		generateMethods(targetStruct, out)<font></font>
	}<font></font>
}</code></pre><br>
     ,  :<br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> DbeParam <span class="hljs-keyword">struct</span> {<font></font>
	TableName <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"table"`</span><font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">type</span> StructInfo <span class="hljs-keyword">struct</span> {<font></font>
	Name     <span class="hljs-keyword">string</span><font></font>
	GenParam *DbeParam<font></font>
	Target   *ast.GenDecl<font></font>
}</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora prepararemos informa√ß√µes sobre os campos da estrutura, para que, com base nas informa√ß√µes recebidas, geremos fun√ß√µes de cria√ß√£o de tabela (createTable) e m√©todos CRUD.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo para obter campos de uma estrutura</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">generateMethods</span><span class="hljs-params">(reqStruct *StructInfo, out *os.File)</span></span> {
	<span class="hljs-keyword">for</span> _, spec := <span class="hljs-keyword">range</span> reqStruct.Target.Specs {<font></font>
		fmt.Fprintln(out, <span class="hljs-string">""</span>)<font></font>
		currType, ok := spec.(*ast.TypeSpec)<font></font>
		<span class="hljs-keyword">if</span> !ok {
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
		currStruct, ok := currType.Type.(*ast.StructType)<font></font>
		<span class="hljs-keyword">if</span> !ok {
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
<font></font>
		fmt.Printf(<span class="hljs-string">"\tgenerating createTable methods for %s\n"</span>, currType.Name.Name)<font></font>
<font></font>
		curTable := &amp;TableInfo{<font></font>
			TableName: reqStruct.GenParam.TableName,<font></font>
			Columns:   <span class="hljs-built_in">make</span>([]*ColInfo, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(currStruct.Fields.List)),<font></font>
		}<font></font>
<font></font>
		<span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> currStruct.Fields.List {
			<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(field.Names) == <span class="hljs-number">0</span> {
				<span class="hljs-keyword">continue</span><font></font>
			}<font></font>
			tableCol := &amp;ColInfo{FieldName: field.Names[<span class="hljs-number">0</span>].Name}
			<span class="hljs-keyword">var</span> fieldIsPrimKey <span class="hljs-keyword">bool</span>
			<span class="hljs-keyword">var</span> preventThisField <span class="hljs-keyword">bool</span>
			<span class="hljs-keyword">if</span> field.Tag != <span class="hljs-literal">nil</span> {<font></font>
				tag := reflect.StructTag(field.Tag.Value[<span class="hljs-number">1</span> : <span class="hljs-built_in">len</span>(field.Tag.Value)<span class="hljs-number">-1</span>])<font></font>
				tagVal := tag.Get(<span class="hljs-string">"dbe"</span>)<font></font>
				fmt.Println(<span class="hljs-string">"dbe:"</span>, tagVal)<font></font>
				tagParams := strings.Split(tagVal, <span class="hljs-string">","</span>)<font></font>
			PARAMSLOOP:<font></font>
				<span class="hljs-keyword">for</span> _, param := <span class="hljs-keyword">range</span> tagParams {
					<span class="hljs-keyword">switch</span> param {
					<span class="hljs-keyword">case</span> <span class="hljs-string">"primary_key"</span>:
						<span class="hljs-keyword">if</span> curTable.PrimaryKey == <span class="hljs-literal">nil</span> {<font></font>
							fieldIsPrimKey = <span class="hljs-literal">true</span>
							tableCol.NotNull = <span class="hljs-literal">true</span>
						} <span class="hljs-keyword">else</span> {<font></font>
							log.Panicf(<span class="hljs-string">"Table %s cannot have more then 1 primary key!"</span>, currType.Name.Name)<font></font>
						}<font></font>
					<span class="hljs-keyword">case</span> <span class="hljs-string">"not_null"</span>:<font></font>
						tableCol.NotNull = <span class="hljs-literal">true</span>
					<span class="hljs-keyword">case</span> <span class="hljs-string">"-"</span>:<font></font>
						preventThisField = <span class="hljs-literal">true</span>
						<span class="hljs-keyword">break</span> PARAMSLOOP
					<span class="hljs-keyword">default</span>:<font></font>
						tableCol.ColName = param<font></font>
					}<font></font>
<font></font>
				}<font></font>
				<span class="hljs-keyword">if</span> preventThisField {
					<span class="hljs-keyword">continue</span><font></font>
				}<font></font>
			}<font></font>
			<span class="hljs-keyword">if</span> tableCol.ColName == <span class="hljs-string">""</span> {<font></font>
				tableCol.ColName = tableCol.FieldName<font></font>
			}<font></font>
			<span class="hljs-keyword">if</span> fieldIsPrimKey {<font></font>
				curTable.PrimaryKey = tableCol<font></font>
			}<font></font>
			<span class="hljs-comment">//Determine field type</span>
			<span class="hljs-keyword">var</span> fieldType <span class="hljs-keyword">string</span>
			<span class="hljs-keyword">switch</span> field.Type.(<span class="hljs-keyword">type</span>) {
			<span class="hljs-keyword">case</span> *ast.Ident:<font></font>
				fieldType = field.Type.(*ast.Ident).Name<font></font>
			<span class="hljs-keyword">case</span> *ast.SelectorExpr:<font></font>
				fieldType = field.Type.(*ast.SelectorExpr).Sel.Name<font></font>
			}<font></font>
			<span class="hljs-comment">//fieldType := field.Type.(*ast.Ident).Name</span>
			fmt.Printf(<span class="hljs-string">"%s- %s\n"</span>, tableCol.FieldName, fieldType)
			<span class="hljs-comment">//Check for integers</span>
			<span class="hljs-keyword">if</span> strings.Contains(fieldType, <span class="hljs-string">"int"</span>) {<font></font>
				tableCol.ColType = <span class="hljs-string">"integer"</span>
			} <span class="hljs-keyword">else</span> {
				<span class="hljs-comment">//Check for other types</span>
				<span class="hljs-keyword">switch</span> fieldType {
				<span class="hljs-keyword">case</span> <span class="hljs-string">"string"</span>:<font></font>
					tableCol.ColType = <span class="hljs-string">"text"</span>
				<span class="hljs-keyword">case</span> <span class="hljs-string">"bool"</span>:<font></font>
					tableCol.ColType = <span class="hljs-string">"boolean"</span>
				<span class="hljs-keyword">case</span> <span class="hljs-string">"Time"</span>:<font></font>
					tableCol.ColType = <span class="hljs-string">"TIMESTAMP"</span>
				<span class="hljs-keyword">default</span>:<font></font>
					log.Panicf(<span class="hljs-string">"Field type %s not supported"</span>, fieldType)<font></font>
				}<font></font>
			}<font></font>
			tableCol.FieldType = fieldType<font></font>
			curTable.Columns = <span class="hljs-built_in">append</span>(curTable.Columns, tableCol)<font></font>
			curTable.StructName = currType.Name.Name<font></font>
<font></font>
		}<font></font>
		curTable.generateCreateTable(out)<font></font>
<font></font>
		fmt.Printf(<span class="hljs-string">"\tgenerating CRUD methods for %s\n"</span>, currType.Name.Name)<font></font>
		curTable.generateCreate(out)<font></font>
		curTable.generateQuery(out)<font></font>
		curTable.generateUpdate(out)<font></font>
		curTable.generateDelete(out)<font></font>
	}<font></font>
}</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analisamos todos os campos da estrutura desejada e come√ßamos a analisar as tags de cada campo. Usando a reflex√£o, obtemos a tag na qual estamos interessados ‚Äã‚Äã(afinal, pode haver outras tags no campo, por exemplo, para json). Analisamos o conte√∫do da tag e determinamos se o campo √© uma chave prim√°ria (se mais de uma chave prim√°ria for especificada, xingar e interromper a execu√ß√£o), existe um requisito para que o campo seja diferente de zero, precisamos trabalhar com o banco de dados para esse campo e definir nome da coluna se ele foi substitu√≠do na tag. Tamb√©m precisamos determinar o tipo da coluna da tabela com base no tipo do campo da estrutura. H√° um conjunto finito de tipos de campos, geraremos apenas para tipos b√°sicos, reduziremos todas as linhas ao tipo de campo TEXT, embora, em geral, voc√™ possa adicionar a defini√ß√£o do tipo de coluna √†s tags para poder configurar com mais precis√£o. Por outro lado,ningu√©m se preocupa em criar a tabela desejada no banco de dados antecipadamente ou em corrigir a criada automaticamente.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ap√≥s analisar a estrutura, iniciamos o m√©todo para criar o c√≥digo para a fun√ß√£o de cria√ß√£o de tabela e os m√©todos para criar as fun√ß√µes Criar, Consultar, Atualizar e Excluir. </font><font style="vertical-align: inherit;">Preparamos uma express√£o SQL para cada fun√ß√£o e uma liga√ß√£o a ser executada. </font><font style="vertical-align: inherit;">N√£o me incomodei com o tratamento de erros, apenas forneci o erro do driver do banco de dados. </font><font style="vertical-align: inherit;">Para gera√ß√£o de c√≥digo, √© conveniente usar modelos da biblioteca de texto / modelo. </font><font style="vertical-align: inherit;">Com a ajuda deles, voc√™ pode obter um c√≥digo muito mais suport√°vel e previs√≠vel (o c√≥digo √© vis√≠vel imediatamente, mas n√£o manchado pelo c√≥digo do gerador).</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cria√ß√£o de tabela</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tableD *TableInfo)</span> <span class="hljs-title">generateCreateTable</span><span class="hljs-params">(out *os.File)</span> <span class="hljs-title">error</span></span> {<font></font>
	fmt.Fprint(out, <span class="hljs-string">"func (in *"</span>+tableD.StructName+<span class="hljs-string">") createTable(db *sql.DB) (error) {\n"</span>)
	<span class="hljs-keyword">var</span> resSQLq = fmt.Sprintf(<span class="hljs-string">"\tsqlQ := `CREATE TABLE %s (\n"</span>, tableD.TableName)
	<span class="hljs-keyword">for</span> _, col := <span class="hljs-keyword">range</span> tableD.Columns {<font></font>
		colSQL := col.ColName + <span class="hljs-string">" "</span> + col.ColType
		<span class="hljs-keyword">if</span> col.NotNull {<font></font>
			colSQL += <span class="hljs-string">" NOT NULL"</span><font></font>
		}<font></font>
		<span class="hljs-keyword">if</span> col == tableD.PrimaryKey {<font></font>
			colSQL += <span class="hljs-string">" AUTO_INCREMENT"</span><font></font>
		}<font></font>
		colSQL += <span class="hljs-string">",\n"</span><font></font>
		resSQLq += colSQL<font></font>
	}<font></font>
	<span class="hljs-keyword">if</span> tableD.PrimaryKey != <span class="hljs-literal">nil</span> {<font></font>
		resSQLq += fmt.Sprintf(<span class="hljs-string">"PRIMARY KEY (%s)\n"</span>, tableD.PrimaryKey.ColName)<font></font>
	}<font></font>
	resSQLq += <span class="hljs-string">")`\n"</span><font></font>
	fmt.Fprint(out, resSQLq)<font></font>
	fmt.Fprint(out, <span class="hljs-string">"\t_, err := db.Exec(sqlQ)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n"</span>)<font></font>
	fmt.Fprint(out, <span class="hljs-string">"\t return nil\n}\n\n"</span>)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adicionar registro</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs"><font></font>
<font></font>
	fmt.Fprint(out, <span class="hljs-string">"func (in *"</span>+tableD.StructName+<span class="hljs-string">") Create(db *sql.DB) (error) {\n"</span>)
	<span class="hljs-keyword">var</span> columns, valuePlaces, valuesListParams <span class="hljs-keyword">string</span>
	<span class="hljs-keyword">for</span> _, col := <span class="hljs-keyword">range</span> tableD.Columns {
		<span class="hljs-keyword">if</span> col == tableD.PrimaryKey {
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
		columns += <span class="hljs-string">"`"</span> + col.ColName + <span class="hljs-string">"`,"</span>
		valuePlaces += <span class="hljs-string">"?,"</span>
		valuesListParams += <span class="hljs-string">"in."</span> + col.FieldName + <span class="hljs-string">","</span><font></font>
	}<font></font>
	columns = columns[:<span class="hljs-built_in">len</span>(columns)<span class="hljs-number">-1</span>]<font></font>
	valuePlaces = valuePlaces[:<span class="hljs-built_in">len</span>(valuePlaces)<span class="hljs-number">-1</span>]<font></font>
	valuesListParams = valuesListParams[:<span class="hljs-built_in">len</span>(valuesListParams)<span class="hljs-number">-1</span>]<font></font>
<font></font>
	resSQLq := fmt.Sprintf(<span class="hljs-string">"\tsqlQ := \"INSERT INTO %s (%s) VALUES (%s);\"\n"</span>,<font></font>
		tableD.TableName,<font></font>
		columns,<font></font>
		valuePlaces)<font></font>
	fmt.Fprintln(out, resSQLq)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"result, err := db.Exec(sqlQ, %s)\n"</span>, valuesListParams)<font></font>
	fmt.Fprintln(out, <span class="hljs-string">`if err != nil {
		return err
	}`</span>)
	<span class="hljs-comment">//Setting id if we have primary key</span>
	<span class="hljs-keyword">if</span> tableD.PrimaryKey != <span class="hljs-literal">nil</span> {<font></font>
		fmt.Fprintf(out, <span class="hljs-string">`lastId, err := result.LastInsertId()
		if err != nil {
			return nil
		}`</span>)<font></font>
		fmt.Fprintf(out, <span class="hljs-string">"\nin.%s = %s(lastId)\n"</span>, tableD.PrimaryKey.FieldName, tableD.PrimaryKey.FieldType)<font></font>
	}<font></font>
	fmt.Fprintln(out, <span class="hljs-string">"return nil\n}\n\n"</span>)
	<span class="hljs-comment">//in., _ := result.LastInsertId()`)</span>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recuperando Registros de uma Tabela</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tableD *TableInfo)</span> <span class="hljs-title">generateQuery</span><span class="hljs-params">(out *os.File)</span> <span class="hljs-title">error</span></span> {<font></font>
	fmt.Fprint(out, <span class="hljs-string">"func (in *"</span>+tableD.StructName+<span class="hljs-string">") Query(db *sql.DB) ([]*"</span>+tableD.StructName+<span class="hljs-string">", error) {\n"</span>)<font></font>
<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"\tsqlQ := \"SELECT * FROM %s;\"\n"</span>, tableD.TableName)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"rows, err := db.Query(sqlQ)\n"</span>)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"results := make([]*%s, 0)\n"</span>, tableD.StructName)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">`for rows.Next() {`</span>)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"\t tempR := &amp;%s{}\n"</span>, tableD.StructName)
	<span class="hljs-keyword">var</span> valuesListParams <span class="hljs-keyword">string</span>
	<span class="hljs-keyword">for</span> _, col := <span class="hljs-keyword">range</span> tableD.Columns {<font></font>
		valuesListParams += <span class="hljs-string">"&amp;tempR."</span> + col.FieldName + <span class="hljs-string">","</span><font></font>
	}<font></font>
	valuesListParams = valuesListParams[:<span class="hljs-built_in">len</span>(valuesListParams)<span class="hljs-number">-1</span>]<font></font>
<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"\terr = rows.Scan(%s)\n"</span>, valuesListParams)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">`if err != nil {
		return nil, err
		}`</span>)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"\n\tresults = append(results, tempR)"</span>)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">`}
		return results, nil
	}`</span>)<font></font>
	fmt.Fprintln(out, <span class="hljs-string">""</span>)<font></font>
	fmt.Fprintln(out, <span class="hljs-string">""</span>)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atualiza√ß√£o de registro (funciona por chave prim√°ria)</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tableD *TableInfo)</span> <span class="hljs-title">generateUpdate</span><span class="hljs-params">(out *os.File)</span> <span class="hljs-title">error</span></span> {<font></font>
	fmt.Fprint(out, <span class="hljs-string">"func (in *"</span>+tableD.StructName+<span class="hljs-string">") Update(db *sql.DB) (error) {\n"</span>)
	<span class="hljs-keyword">var</span> updVals, valuesListParams <span class="hljs-keyword">string</span>
	<span class="hljs-keyword">for</span> _, col := <span class="hljs-keyword">range</span> tableD.Columns {
		<span class="hljs-keyword">if</span> col == tableD.PrimaryKey {
			<span class="hljs-keyword">continue</span><font></font>
		}<font></font>
		updVals += <span class="hljs-string">"`"</span> + col.ColName + <span class="hljs-string">"`=?,"</span>
		valuesListParams += <span class="hljs-string">"in."</span> + col.FieldName + <span class="hljs-string">","</span><font></font>
	}<font></font>
	updVals = updVals[:<span class="hljs-built_in">len</span>(updVals)<span class="hljs-number">-1</span>]<font></font>
	valuesListParams += <span class="hljs-string">"in."</span> + tableD.PrimaryKey.FieldName<font></font>
<font></font>
	resSQLq := fmt.Sprintf(<span class="hljs-string">"\tsqlQ := \"UPDATE %s SET %s WHERE %s = ?;\"\n"</span>,<font></font>
		tableD.TableName,<font></font>
		updVals,<font></font>
		tableD.PrimaryKey.ColName)<font></font>
	fmt.Fprintln(out, resSQLq)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"_, err := db.Exec(sqlQ, %s)\n"</span>, valuesListParams)<font></font>
	fmt.Fprintln(out, <span class="hljs-string">`if err != nil {
		return err
	}`</span>)<font></font>
<font></font>
	fmt.Fprintln(out, <span class="hljs-string">"return nil\n}\n\n"</span>)
	<span class="hljs-comment">//in., _ := result.LastInsertId()`)</span>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Excluir um registro (funciona por chave prim√°ria)</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tableD *TableInfo)</span> <span class="hljs-title">generateDelete</span><span class="hljs-params">(out *os.File)</span> <span class="hljs-title">error</span></span> {<font></font>
	fmt.Fprint(out, <span class="hljs-string">"func (in *"</span>+tableD.StructName+<span class="hljs-string">") Delete(db *sql.DB) (error) {\n"</span>)<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"sqlQ := \"DELETE FROM %s WHERE id = ?\"\n"</span>, tableD.TableName)<font></font>
<font></font>
	fmt.Fprintf(out, <span class="hljs-string">"_, err := db.Exec(sqlQ, in.%s)\n"</span>, tableD.PrimaryKey.FieldName)<font></font>
<font></font>
	fmt.Fprintln(out, <span class="hljs-string">`if err != nil {
		return err
	}
	return nil
}`</span>)<font></font>
	fmt.Fprintln(out)<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O in√≠cio do gerador de c√≥digo resultante √© realizado pela execu√ß√£o usual, passamos o caminho para o arquivo para o qual voc√™ deseja gerar o c√≥digo na flag -name. </font><font style="vertical-align: inherit;">Como resultado, obtemos o arquivo com o sufixo _dbe, no qual est√° o c√≥digo gerado. </font><font style="vertical-align: inherit;">Para testes, crie m√©todos para a seguinte estrutura:</font></font><br>
<br>
<pre><code class="go hljs">
<span class="hljs-comment">// dbe:{"table": "users"}</span>
<span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> {<font></font>
	ID       <span class="hljs-keyword">int</span>    <span class="hljs-string">`dbe:"id,primary_key"`</span>
	Login    <span class="hljs-keyword">string</span> <span class="hljs-string">`dbe:"login,not_null"`</span>
	Email    <span class="hljs-keyword">string</span>
	Level    <span class="hljs-keyword">uint8</span>
	IsActive <span class="hljs-keyword">bool</span>
	UError   error <span class="hljs-string">`dbe:"-"`</span><font></font>
}<font></font>
</code></pre><br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo resultante</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-keyword">package</span> main<font></font>
<font></font>
<span class="hljs-keyword">import</span> <span class="hljs-string">"database/sql"</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *User)</span> <span class="hljs-title">createTable</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-title">error</span></span> {<font></font>
	sqlQ := <span class="hljs-string">`CREATE TABLE users (
	id integer NOT NULL AUTO_INCREMENT,
	login text NOT NULL,
	Email text,
	Level integer,
	IsActive boolean,
	PRIMARY KEY (id)
	)`</span><font></font>
	_, err := db.Exec(sqlQ)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *User)</span> <span class="hljs-title">Create</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-title">error</span></span> {<font></font>
	sqlQ := <span class="hljs-string">"INSERT INTO users (`login`,`Email`,`Level`,`IsActive`) VALUES (?,?,?,?);"</span><font></font>
<font></font>
	result, err := db.Exec(sqlQ, in.Login, in.Email, in.Level, in.IsActive)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err<font></font>
	}<font></font>
	lastId, err := result.LastInsertId()<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
	}<font></font>
	in.ID = <span class="hljs-keyword">int</span>(lastId)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *User)</span> <span class="hljs-title">Query</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-params">([]*User, error)</span></span> {<font></font>
	sqlQ := <span class="hljs-string">"SELECT * FROM users;"</span><font></font>
	rows, err := db.Query(sqlQ)<font></font>
	results := <span class="hljs-built_in">make</span>([]*User, <span class="hljs-number">0</span>)
	<span class="hljs-keyword">for</span> rows.Next() {<font></font>
		tempR := &amp;User{}<font></font>
		err = rows.Scan(&amp;tempR.ID, &amp;tempR.Login, &amp;tempR.Email, &amp;tempR.Level, &amp;tempR.IsActive)<font></font>
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<font></font>
		}<font></font>
		results = <span class="hljs-built_in">append</span>(results, tempR)<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> results, <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *User)</span> <span class="hljs-title">Update</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-title">error</span></span> {<font></font>
	sqlQ := <span class="hljs-string">"UPDATE users SET `login`=?,`Email`=?,`Level`=?,`IsActive`=? WHERE id = ?;"</span><font></font>
<font></font>
	_, err := db.Exec(sqlQ, in.Login, in.Email, in.Level, in.IsActive, in.ID)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(in *User)</span> <span class="hljs-title">Delete</span><span class="hljs-params">(db *sql.DB)</span> <span class="hljs-title">error</span></span> {<font></font>
	sqlQ := <span class="hljs-string">"DELETE FROM users WHERE id = ?"</span><font></font>
	_, err := db.Exec(sqlQ, in.ID)<font></font>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err<font></font>
	}<font></font>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para testar a opera√ß√£o do c√≥digo gerado, crie um objeto com dados arbitr√°rios, crie uma tabela para ele (se a tabela existir no banco de dados, um erro ser√° retornado). </font><font style="vertical-align: inherit;">Depois de colocar esse objeto na tabela, leia todos os campos da tabela, atualize os valores de n√≠vel e exclua o objeto.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chame os m√©todos resultantes</font></font></b>
                        <div class="spoiler_text"><pre><code class="go hljs">
<span class="hljs-keyword">var</span> err error<font></font>
db, err := sql.Open(<span class="hljs-string">"mysql"</span>, DSN)
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Unable to connect to DB"</span>, err)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
err = db.Ping()<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Unable to ping BD"</span>)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
newUser := &amp;User{<font></font>
	Login:    <span class="hljs-string">"newUser"</span>,<font></font>
	Email:    <span class="hljs-string">"new@test.com"</span>,<font></font>
	Level:    <span class="hljs-number">0</span>,<font></font>
	IsActive: <span class="hljs-literal">false</span>,<font></font>
	UError:   <span class="hljs-literal">nil</span>,<font></font>
}<font></font>
<font></font>
err = newUser.createTable(db)<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Error creating table."</span>, err)<font></font>
<font></font>
}<font></font>
err = newUser.Create(db)<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Error creating user."</span>, err)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
<font></font>
nU := &amp;User{}<font></font>
dbUsers, err := nU.Query(db)<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Error selecting users."</span>, err)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
fmt.Printf(<span class="hljs-string">"From table users selected %d fields"</span>, <span class="hljs-built_in">len</span>(dbUsers))
<span class="hljs-keyword">var</span> DBUser *User
<span class="hljs-keyword">for</span> _, user := <span class="hljs-keyword">range</span> dbUsers {<font></font>
	fmt.Println(user)<font></font>
	DBUser = user<font></font>
}<font></font>
DBUser.Level = <span class="hljs-number">2</span><font></font>
err = DBUser.Update(db)<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Error updating users."</span>, err)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
err = DBUser.Delete(db)<font></font>
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {<font></font>
	fmt.Println(<span class="hljs-string">"Error deleting users."</span>, err)
	<span class="hljs-keyword">return</span><font></font>
}<font></font>
</code></pre><br>
</div>
                    </div> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na implementa√ß√£o atual, a funcionalidade do cliente no banco de dados √© muito limitada:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">somente MySQL √© suportado;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nem todos os tipos de campo s√£o suportados.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o h√° filtragem e limites para SELECT.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, a corre√ß√£o de bugs j√° est√° al√©m do escopo de analisar o c√≥digo-fonte Go e gerar um novo c√≥digo com base nele. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usar um gerador de c√≥digo nesse cen√°rio permitir√° alterar os campos e tipos de estruturas usadas no aplicativo em um √∫nico local; n√£o √© necess√°rio lembrar de fazer altera√ß√µes no c√≥digo para interagir com o banco de dados; voc√™ s√≥ precisa executar o gerador de c√≥digo sempre. </font><font style="vertical-align: inherit;">Essa tarefa poderia ser resolvida com a ajuda da reflex√£o, mas isso teria afetado o desempenho. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O gerador de c√≥digo-fonte e um exemplo do c√≥digo gerado postado no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt500986/index.html">Monitoramento no data center: como alteramos o antigo BMS para um novo. Parte 3</a></li>
<li><a href="../pt500992/index.html">Como est√° o Gerenciamento de Desempenho nas melhores empresas de TI</a></li>
<li><a href="../pt500994/index.html">Execute formiga. Corre</a></li>
<li><a href="../pt500996/index.html">Como se tornar um engenheiro de DevOps em seis meses ou at√© mais r√°pido. Parte 1. Introdu√ß√£o</a></li>
<li><a href="../pt500998/index.html">Rede neural convolucional e sua integra√ß√£o no iOS (parte 1)</a></li>
<li><a href="../pt501002/index.html">Umka: nova linguagem de script estaticamente tipada</a></li>
<li><a href="../pt501004/index.html">Fa√ßa. Trabalhos</a></li>
<li><a href="../pt501006/index.html">Somos amigos STM32 com display LCD 1604 no barramento I2C (biblioteca HAL)</a></li>
<li><a href="../pt501008/index.html">Pavimenta√ß√£o de domin√≥s</a></li>
<li><a href="../pt501010/index.html">TLS e Nginx do kernel do Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>