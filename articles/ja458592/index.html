<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🔧 📗 🆒 高CephレイテンシからeBPF / BCCを使用したカーネルパッチまで 🏈 🍘 🎙️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Linuxには、多数のカーネルデバッグツールとアプリケーションがあります。それらのほとんどはアプリケーションのパフォーマンスに悪影響を及ぼし、本番環境では使用できません。
 
 数年前、eBPFという別のツールが開発されました。これにより、低いオーバーヘッドでカーネルとユーザーアプリケーションをトレ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>高CephレイテンシからeBPF / BCCを使用したカーネルパッチまで</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/selectel/blog/458592/"><img src="https://habrastorage.org/webt/-8/ok/na/-8okna9qfyroicvgoz-zenv7-si.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Linuxには、多数のカーネルデバッグツールとアプリケーションがあります。</font><font style="vertical-align: inherit;">それらのほとんどはアプリケーションのパフォーマンスに悪影響を及ぼし、本番環境では使用できません。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数年前、</font><font style="vertical-align: inherit;">eBPFという</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">別のツール</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">開発され</font></a><font style="vertical-align: inherit;">ました。</font><font style="vertical-align: inherit;">これにより、低いオーバーヘッドでカーネルとユーザーアプリケーションをトレースでき、プログラムを再構築したり、サードパーティのモジュールをカーネルにロードしたりする必要がありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eBPFを使用するアプリケーションユーティリティはすでに多数あります。この記事では、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PythonBCC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ライブラリに基づいて独自のプロファイリングユーティリティを作成する方法について説明します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">記事は実際のイベントに基づいています。</font><font style="vertical-align: inherit;">問題の発生から修正まで、特定の状況で既存のユーティリティをどのように使用できるかを示します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">セフが遅い</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいホストがCephクラスターに追加されました。</font><font style="vertical-align: inherit;">一部のデータを移行した後、書き込みリクエストの処理速度が他のサーバーよりもはるかに遅いことに気付きました。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/_r/yv/4c_ryvapivstw8l-nr7dipfvh8e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他のプラットフォームとは異なり、このホストではbcacheと新しいLinux 4.15カーネルが使用されました。</font><font style="vertical-align: inherit;">この構成のホストは、ここで初めて使用されました。</font><font style="vertical-align: inherit;">そして当時、理論的には何でも問題の根源になり得ることが明らかでした。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ホストの調査</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ceph-osdプロセス内で何が起こるかを見てみましょう。</font><font style="vertical-align: inherit;">これを行うには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">perf</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flamescope</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用します</font><font style="vertical-align: inherit;">（詳細については、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こちらを参照してください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/uw/gj/ox/uwgjoxekagdl-noj-wp_uy5g8q8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この図は、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fdatasync（）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">がリクエストを</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generic_make_request（）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数に送信するのに長い時間を費やしたことを示しています</font><font style="vertical-align: inherit;">。これは、おそらく問題の原因がosdデーモン自体の外にあることを意味します。カーネルでもディスクでもかまいません。 iostatの出力は、bcacheディスクを使用したリクエストの処理で長い待機時間を示しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホストを確認したところ、systemd-udevdデーモンが大量のCPU時間を消費していることがわかりました-複数のコアで約20％。これは奇妙な動作なので、原因を突き止める必要があります。 Systemd-udevdはueventsで動作するため、</font><strong><font style="vertical-align: inherit;">udevadmモニター</font></strong><font style="vertical-align: inherit;">を通してそれらを調べることにしました</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">システム内のブロックデバイスごとに多数の変更イベントが生成されたことがわかります。</font><font style="vertical-align: inherit;">これは非常に珍しいので、これらすべてのイベントを生成するものを確認する必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCCツールキットの使用</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すでにわかったように、カーネル（およびシステムコールのcephデーモン）は、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generic_make_request（）に</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの時間を費やしてい</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">この関数の速度を測定してみましょう。</font><font style="vertical-align: inherit;">ある</font><font style="vertical-align: inherit;">偉大なユーティリティすでに</font><font style="vertical-align: inherit;">における</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funclatencyが</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">情報出力の間隔が1秒のPIDでデーモンをトレースし、ミリ秒単位で結果を表示します。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/o7/zw/rl/o7zwrly0nejoo5r7zbezws3jxmo.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、この機能は高速です。</font><font style="vertical-align: inherit;">彼女が行うのは、デバイスドライバーのキューに要求を送信することだけです。</font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bcache</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、実際には3つのディスクで構成される複雑なデバイスです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バッキングデバイス（キャッシュディスク）。この場合、低速のHDDです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キャッシングデバイス（キャッシングディスク）。ここでは、NVMeデバイスの1つのセクションです。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションが動作するbcache仮想デバイス。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストの送信が遅いことはわかっていますが、これらのデバイスのどれですか？</font><font style="vertical-align: inherit;">これについては少し後で扱います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ueventsが問題を引き起こしている可能性があることがわかりました。</font><font style="vertical-align: inherit;">彼らの世代を正確に引き起こすものを見つけることはそれほど単純ではありません。</font><font style="vertical-align: inherit;">これが定期的に実行されるある種のソフトウェアであるとします。</font><font style="vertical-align: inherit;">同じ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">BCCユーティリティのセット</font></a><font style="vertical-align: inherit;">から</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">execsnoop</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スクリプトを使用して、システム</font><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">どの</font><strong><font style="vertical-align: inherit;">ような</font></strong><font style="vertical-align: inherit;">ソフトウェアが実行されるかを見てみましょう</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">それを実行し、出力をファイルに送信します。</font><font style="vertical-align: inherit;">
たとえば、次のようになります。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="bash hljs">/usr/share/bcc/tools/execsnoop  | tee ./execdump
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここではexecsnoopの完全な出力を提供することはしませんが、関心のある1行は次のようになります。</font></font><br>
<br>
<pre><code class="bash hljs">sh 1764905 5802 0 sudo arcconf getconfig 1 AD | grep Temperature | awk -F <span class="hljs-string">'[:/]'</span> <span class="hljs-string">'{print $2}'</span> | sed <span class="hljs-string">'s/^ \([0-9]*\) C.*/\1/'</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3番目の列は、プロセスのPPID（親PID）です。</font><font style="vertical-align: inherit;">PID 5802のプロセスは、監視システムのスレッドの1つであることが判明しました。</font><font style="vertical-align: inherit;">監視システムの構成を確認したところ、誤ったパラメーターが見つかりました。</font><font style="vertical-align: inherit;">HBAアダプターの温度は30秒ごとに取得されましたが、これは必要以上に頻繁です。</font><font style="vertical-align: inherit;">検証間隔をより長い間隔に変更した後、このホストでの要求の処理の遅延が他のホストよりも目立たなくなったことがわかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、bcacheデバイスが非常に遅い理由はまだ明らかではありません。</font><font style="vertical-align: inherit;">同一の構成のテストプラットフォームを準備し、bcacheでfioを実行し、udevadmトリガーを定期的に開始してueventを生成することにより、問題の再現を試みました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCCベースのツールの作成</font></font></h3><br><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generic_make_request（）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
への最も遅い呼び出しをトレースして表示するための簡単なユーティリティを書いてみましょう</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">この関数が呼び出されたドライブの名前にも興味があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
計画は簡単です：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><strong><font style="vertical-align: inherit;">generic_make_request（）で</font></strong></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kprobe</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">登録</font><font style="vertical-align: inherit;">し</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数名からアクセスできるディスク名を保存します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">タイムスタンプを保存します。</font></font></li>
</ul><br>
</li>
</ul><ul>
<li><font style="vertical-align: inherit;"><strong><font style="vertical-align: inherit;">generic_make_request（）</font></strong><font style="vertical-align: inherit;">から戻るように</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kretprobe</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">登録</font><font style="vertical-align: inherit;">し</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">現在のタイムスタンプを取得します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">保存したタイムスタンプを検索し、現在のタイムスタンプと比較します。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結果が指定したものより大きい場合は、保存されているディスク名を見つけてターミナルに表示します。</font></font></li>
</ul><br>
</li>
</ul><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kprobes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kretprobes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、ブレークポイントメカニズムを使用して関数コードをオンザフライで変更します。</font><font style="vertical-align: inherit;">このトピックに関する</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ドキュメント</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">優れた</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事を</font><font style="vertical-align: inherit;">読むことができます</font><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">のさまざまなユーティリティのコードを見ると、</font><font style="vertical-align: inherit;">それらの構造が同じであることが</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">わかり</font></a><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">したがって、この記事では、スクリプトの引数の解析を省略して、BPFプログラム自体に移ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pythonスクリプト内のeBPFテキストは次のようになります。</font></font><br>
<br>
<pre><code class="python hljs">bpf_text = “”” <span class="hljs-comment"># Here will be the bpf program code “””</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数間でデータを交換するために、eBPFプログラムは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハッシュテーブルを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">私たちもそうします。</font><font style="vertical-align: inherit;">キーとして、プロセスのPIDを使用し、値として構造を定義します。</font></font><br>
<br>
<pre><code class="python hljs">struct data_t {<font></font>
	u64 pid;<font></font>
	u64 ts;<font></font>
	char comm[TASK_COMM_LEN];<font></font>
	u64 lat;<font></font>
	char disk[DISK_NAME_LEN];<font></font>
};<font></font>
<font></font>
BPF_HASH(p, u64, struct data_t);<font></font>
BPF_PERF_OUTPUT(events);<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは</font><font style="vertical-align: inherit;">、タイプ</font><em><font style="vertical-align: inherit;">u64の</font></em><font style="vertical-align: inherit;">キー</font><font style="vertical-align: inherit;">とタイプ</font><em><font style="vertical-align: inherit;">struct data_tの</font></em><font style="vertical-align: inherit;">値を</font><em><font style="vertical-align: inherit;">使用</font></em><font style="vertical-align: inherit;">して、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">というハッシュテーブルを登録します</font><font style="vertical-align: inherit;">。このテーブルは、BPFプログラムのコンテキストで利用できます。 BPF_PERF_OUTPUTマクロ</font><font style="vertical-align: inherit;">は、</font><em><font style="vertical-align: inherit;">イベント</font></em><font style="vertical-align: inherit;">と呼ばれる別のテーブルを登録し</font><em><font style="vertical-align: inherit;">ます</font></em><font style="vertical-align: inherit;">。これは、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">データ</font></a><font style="vertical-align: inherit;">をユーザー空間</font><font style="vertical-align: inherit;">に</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">転送する</font></a><font style="vertical-align: inherit;">ために</font><font style="vertical-align: inherit;">使用さ</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">れます</font></a><font style="vertical-align: inherit;">。</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
関数呼び出しと関数からの戻りの間、または異なる関数への呼び出しの間の遅延を測定するときは、受信したデータが同じコンテキストに属している必要があることに注意してください。つまり、関数の並列起動の可能性について覚えておく必要があります。あるプロセスのコンテキストで関数を呼び出してから、別のプロセスのコンテキストでこの関数から戻るまでの遅延を測定する機会がありますが、これはおそらく役に立たないでしょう。ここでの良い例は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">biolatencyユーティリティです</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">単一のディスク</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リクエスト</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を反映する</font><em><font style="vertical-align: inherit;">structリクエスト</font></em><font style="vertical-align: inherit;">へのポインタがハッシュテーブルのキーとして設定されています</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、調査中の関数が呼び出されたときに実行されるコードを記述する必要があります。</font></font><br>
<br>
<pre><code class="python hljs">void start(struct pt_regs *ctx, struct bio *bio) {<font></font>
	u64 pid = bpf_get_current_pid_tgid();<font></font>
	struct data_t data = {};<font></font>
	u64 ts = bpf_ktime_get_ns();<font></font>
	data.pid = pid;<font></font>
	data.ts = ts;<font></font>
	bpf_probe_read_str(&amp;data.disk, sizeof(data.disk), (void*)bio-&gt;bi_disk-&gt;disk_name);<font></font>
	p.update(&amp;pid, &amp;data);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、呼び出された</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generic_make_request（）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数の2番目の引数が2番目の引数として置き換えられます</font><font style="vertical-align: inherit;">。その後、作業しているプロセスのPIDと現在のタイムスタンプ（ナノ秒単位）を取得します。これらすべてを、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しく割り当てられたstruct data_t dataに書き込みます</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><strong><font style="vertical-align: inherit;">generic_make_request（）を</font></strong><font style="vertical-align: inherit;">呼び出すときに渡される</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bio</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造からディスク名を取得</font><font style="vertical-align: inherit;">し、同じ</font><em><font style="vertical-align: inherit;">データ</font></em><font style="vertical-align: inherit;">構造に保存し</font><em><font style="vertical-align: inherit;">ます</font></em><font style="vertical-align: inherit;">。最後のステップは、前述のハッシュテーブルにエントリを追加することです。</font><font style="vertical-align: inherit;">
次の関数は、</font><strong><font style="vertical-align: inherit;">generic_make_request（）</font></strong><font style="vertical-align: inherit;">からの戻り時に呼び出されます</font><font style="vertical-align: inherit;">。</font></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><strong><font style="vertical-align: inherit;"></font></strong><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="python hljs">void stop(struct pt_regs *ctx) {<font></font>
    u64 pid = bpf_get_current_pid_tgid();<font></font>
    u64 ts = bpf_ktime_get_ns();<font></font>
    struct data_t* data = p.lookup(&amp;pid);<font></font>
    <span class="hljs-keyword">if</span> (data != <span class="hljs-number">0</span> &amp;&amp; data-&gt;ts &gt; <span class="hljs-number">0</span>) {<font></font>
        bpf_get_current_comm(&amp;data-&gt;comm, sizeof(data-&gt;comm));<font></font>
        data-&gt;lat = (ts - data-&gt;ts)/<span class="hljs-number">1000</span>;
        <span class="hljs-keyword">if</span> (data-&gt;lat &gt; MIN_US) {<font></font>
            FACTOR<font></font>
            data-&gt;pid &gt;&gt;= <span class="hljs-number">32</span>;<font></font>
            events.perf_submit(ctx, data, sizeof(struct data_t));<font></font>
        }<font></font>
        p.delete(&amp;pid);<font></font>
    }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この関数は前の関数と似ています。プロセスのPIDとタイムスタンプを認識しますが、新しいデータ構造にメモリを割り当てません。代わりに、ハッシュテーブルで、キー==現在のPIDを持つ既存の構造を探します。構造が見つかった場合は、実行中のプロセスの名前を見つけて追加します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで使用するバイナリシフトは、スレッドのGIDを取得するために必要です。それら。作業中のコンテキストでスレッドを開始したメインプロセスのPID。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">呼び出すbpf_get_current_pid_tgid（）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font><font style="vertical-align: inherit;">は、スレッドのGIDとそのPIDの両方を単一の64ビット値で返します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
端末に出力する場合、フローではなくメインプロセスに関心があります。受信した遅延を特定のしきい値と比較した後、</font><em><font style="vertical-align: inherit;">データ</font></em><font style="vertical-align: inherit;">構造を渡します</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イベント</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブルを介してユーザー空間に移動した</font><font style="vertical-align: inherit;">後、</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からレコードを削除し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このコードを読み込むPythonスクリプトでは、MIN_USとFACTORを遅延しきい値と時間単位に置き換える必要があります。これらは引数を介して渡します。</font></font><br>
<br>
<pre><code class="python hljs">bpf_text = bpf_text.replace(<span class="hljs-string">'MIN_US'</span>,str(min_usec))
<span class="hljs-keyword">if</span> args.milliseconds:<font></font>
	bpf_text = bpf_text.replace(<span class="hljs-string">'FACTOR'</span>,<span class="hljs-string">'data-&gt;lat /= 1000;'</span>)<font></font>
	label = <span class="hljs-string">"msec"</span>
<span class="hljs-keyword">else</span>:<font></font>
	bpf_text = bpf_text.replace(<span class="hljs-string">'FACTOR'</span>,<span class="hljs-string">''</span>)<font></font>
	label = <span class="hljs-string">"usec"</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPFマクロを使用し</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">てBPFプログラムを準備し</font><font style="vertical-align: inherit;">、サンプルを登録する</font><font style="vertical-align: inherit;">必要があり</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="python hljs">b = BPF(text=bpf_text)<font></font>
b.attach_kprobe(event=<span class="hljs-string">"generic_make_request"</span>,fn_name=<span class="hljs-string">"start"</span>)<font></font>
b.attach_kretprobe(event=<span class="hljs-string">"generic_make_request"</span>,fn_name=<span class="hljs-string">"stop"</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また</font><font style="vertical-align: inherit;">、スクリプトで</font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct data_t</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を定義する必要があります</font><font style="vertical-align: inherit;">。そうしないと、何も読み取ることができません。</font></font><br>
<br>
<pre><code class="python hljs">TASK_COMM_LEN = <span class="hljs-number">16</span>	<span class="hljs-comment"># linux/sched.h</span>
DISK_NAME_LEN = <span class="hljs-number">32</span>	<span class="hljs-comment"># linux/genhd.h</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Data</span>(<span class="hljs-params">ct.Structure</span>):</span>
	_fields_ = [(<span class="hljs-string">"pid"</span>, ct.c_ulonglong),<font></font>
            	(<span class="hljs-string">"ts"</span>, ct.c_ulonglong),<font></font>
            	(<span class="hljs-string">"comm"</span>, ct.c_char * TASK_COMM_LEN),<font></font>
            	(<span class="hljs-string">"lat"</span>, ct.c_ulonglong),<font></font>
            	(<span class="hljs-string">"disk"</span>,ct.c_char * DISK_NAME_LEN)]
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後のステップは、端末へのデータ出力です。</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">print_event</span>(<span class="hljs-params">cpu, data, size</span>):</span>
    <span class="hljs-keyword">global</span> start<font></font>
    event = ct.cast(data, ct.POINTER(Data)).contents<font></font>
    <span class="hljs-keyword">if</span> start == <span class="hljs-number">0</span>:<font></font>
        start = event.ts<font></font>
    time_s = (float(event.ts - start)) / <span class="hljs-number">1000000000</span>
    print(<span class="hljs-string">"%-18.9f %-16s %-6d   %-1s %s   %s"</span> % (time_s, event.comm, event.pid, event.lat, label, event.disk))<font></font>
<font></font>
b[<span class="hljs-string">"events"</span>].open_perf_buffer(print_event)
<span class="hljs-comment"># format output</span>
start = <span class="hljs-number">0</span>
<span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:
    <span class="hljs-keyword">try</span>:<font></font>
        b.perf_buffer_poll()<font></font>
    <span class="hljs-keyword">except</span> KeyboardInterrupt:<font></font>
        exit()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スクリプト自体は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GItHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で入手できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">fioがbcacheに記述されているテストプラットフォームで実行して、udevadm monitorを呼び出してみましょう。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/0q/wl/yo/0qwlyofk3ynh0ksh1rcqe_9kt6w.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
やっと！</font><font style="vertical-align: inherit;">これで、ブレーキをかけたbcacheデバイスのように見えたものが、実際</font><font style="vertical-align: inherit;">にはキャッシュされたドライブの</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generic_make_request（）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">へのブレーキをかけた呼び出しであることがわかります</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カーネルを掘り下げる</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リクエストの送信中に正確に遅くなるものは何ですか？リクエストのアカウンティングが開始される前でも遅延が発生していることがわかります。それに関する追加の統計（/ proc / diskstatsまたはiostat）に対する特定の要求の説明はまだ始まっていません。これは、問題の再生中にiostatを実行するか、</font><font style="vertical-align: inherit;">要求のアカウンティングの開始と終了に基づい</font><font style="vertical-align: inherit;">た</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BCC biolatencyスクリプトを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">実行することで簡単に確認でき</font><font style="vertical-align: inherit;">ます。これらのユーティリティはどれも、キャッシュされたドライブへのクエリの問題を示しません。</font><strong><font style="vertical-align: inherit;">generic_make_request（）</font></strong></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
関数</font><font style="vertical-align: inherit;">を見ると、リクエストが</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記録さ</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">れる前にさらに2つの関数が呼び出されていることがわかります。最初のもの、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generic_make_request_checks（）は</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ディスク設定のリクエストの正当性をチェックします。第二-</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blk_queue_enter（）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">には、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wait_event_interruptible（）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">への興味深い呼び出しがあります</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="python hljs">ret = wait_event_interruptible(q-&gt;mq_freeze_wq,<font></font>
	(atomic_read(&amp;q-&gt;mq_freeze_depth) == <span class="hljs-number">0</span> &amp;&amp;<font></font>
	(preempt || !blk_queue_preempt_only(q))) ||<font></font>
	blk_queue_dying(q));<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その中で、カーネルはキューの解凍を待ちます。</font><font style="vertical-align: inherit;">遅延を測定します</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blk_queue_enter（）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">~<span class="hljs-comment"># /usr/share/bcc/tools/funclatency  blk_queue_enter -i 1 -m               	 </span>
Tracing 1 <span class="hljs-built_in">functions</span> <span class="hljs-keyword">for</span> <span class="hljs-string">"blk_queue_enter"</span>... Hit Ctrl-C to end.<font></font>
<font></font>
 	msecs           	: count 	distribution<font></font>
     	0 -&gt; 1      	: 341  	|****************************************|<font></font>
<font></font>
 	msecs           	: count 	distribution<font></font>
     	0 -&gt; 1      	: 316  	|****************************************|<font></font>
<font></font>
 	msecs           	: count 	distribution<font></font>
     	0 -&gt; 1      	: 255  	|****************************************|<font></font>
     	2 -&gt; 3      	: 0    	|                                    	|<font></font>
     	4 -&gt; 7      	: 0    	|                                    	|<font></font>
     	8 -&gt; 15     	: 1    	|                                    	|<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは解決策に近いようです。</font><font style="vertical-align: inherit;">キューを「フリーズ/フリーズ解除」するために使用される関数は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blk_mq_freeze_queue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blk_mq_unfreeze_queue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font><font style="vertical-align: inherit;">これらは、クエリキューの設定を変更する必要がある場合に使用されます。これは、このキュー内のクエリにとって潜在的に危険です。</font><font style="vertical-align: inherit;">呼び出すとき</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blk_mq_freeze_queue（）</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">関数</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（blk_freeze_queue_start）の</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カウンタをインクリメントする</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q-&gt; mq_freeze_depth</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">その後、カーネルは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blk_mq_freeze_queue_wait（）で</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キューが空になるのを待ちます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カーネルはキューに入れられたすべての操作が完了するまで待機するため、このキューをクリアするまでの待機時間は、ディスクの待ち時間と同じです。キューが空になるとすぐに、設定の変更が適用されます。次に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blk_mq_unfreeze_queue（）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が呼び出され</font><font style="vertical-align: inherit;">、</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freeze_depth</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カウンターがデクリメントされます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これで、状況を修正するのに十分なことがわかりました。その結果、udevadm triggerコマンドは、ブロックデバイスの設定の適用につながります。これらの設定は、udevルールで説明されています。 sysfsを使用して設定を変更するか、カーネルのソースコードを確認することで、キューを「フリーズ」する設定を正確に見つけることができます。</font><font style="vertical-align: inherit;">端末での各呼び出しのカーネルスタックとユーザー空間のトレースを表示</font><font style="vertical-align: inherit;">するBCC </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレース</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーティリティを試すこともでき</font><font style="vertical-align: inherit;">ます。</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blk_freeze_queue</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、例えば：</font></font><br>
<br>
<pre><code class="bash hljs">~<span class="hljs-comment"># /usr/share/bcc/tools/trace blk_freeze_queue -K -U</span><font></font>
PID 	TID 	COMM        	FUNC        	 <font></font>
3809642 3809642 systemd-udevd   blk_freeze_queue<font></font>
    	blk_freeze_queue+0x1 [kernel]<font></font>
    	elevator_switch+0x29 [kernel]<font></font>
    	elv_iosched_store+0x197 [kernel]<font></font>
    	queue_attr_store+0x5c [kernel]<font></font>
    	sysfs_kf_write+0x3c [kernel]<font></font>
    	kernfs_fop_write+0x125 [kernel]<font></font>
    	__vfs_write+0x1b [kernel]<font></font>
    	vfs_write+0xb8 [kernel]<font></font>
    	sys_write+0x55 [kernel]<font></font>
    	do_syscall_64+0x73 [kernel]<font></font>
    	entry_SYSCALL_64_after_hwframe+0x3d [kernel]<font></font>
    	__write_nocancel+0x7 [libc-2.23.so]<font></font>
    	[unknown]<font></font>
<font></font>
3809631 3809631 systemd-udevd   blk_freeze_queue<font></font>
    	blk_freeze_queue+0x1 [kernel]<font></font>
    	queue_requests_store+0xb6 [kernel]<font></font>
    	queue_attr_store+0x5c [kernel]<font></font>
    	sysfs_kf_write+0x3c [kernel]<font></font>
    	kernfs_fop_write+0x125 [kernel]<font></font>
    	__vfs_write+0x1b [kernel]<font></font>
    	vfs_write+0xb8 [kernel]<font></font>
    	sys_write+0x55 [kernel]<font></font>
    	do_syscall_64+0x73 [kernel]<font></font>
    	entry_SYSCALL_64_after_hwframe+0x3d [kernel]<font></font>
    	__write_nocancel+0x7 [libc-2.23.so]<font></font>
    	[unknown]<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Udevルールはめったに変更されず、通常これは制御下で行われます。</font><font style="vertical-align: inherit;">したがって、すでに設定されている値を使用しても、アプリケーションからディスクへのリクエストの送信の遅延が急増することがわかります。</font><font style="vertical-align: inherit;">もちろん、ディスク構成に変更がない場合（たとえば、デバイスが接続/切断しない場合）にudevイベントを生成することはお勧めできません。</font><font style="vertical-align: inherit;">ただし、必要がない場合は、カーネルが無駄な作業を行わないようにしたり、リクエストキューを凍結しないようにすることができます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3つの</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">小さな</font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コミット</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で状況</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">が</font></a><font style="vertical-align: inherit;">修正されます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">結論</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eBPFは非常に柔軟で強力なツールです。</font><font style="vertical-align: inherit;">この記事では、1つの実際的なケースを検討し、実行できることのほんの一部を示しました。</font><font style="vertical-align: inherit;">BCCユーティリティの開発に関心がある場合は</font><font style="vertical-align: inherit;">、作業の基本がよく説明さ</font><font style="vertical-align: inherit;">れている</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式チュートリアルをご覧ください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eBPFに基づく他の興味深いデバッグおよびプロファイリングツールがあります。</font><font style="vertical-align: inherit;">それらの1つは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bpftraceです</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。これにより、awkのような言語で強力な単一行の小さなプログラムを作成できます。</font><font style="vertical-align: inherit;">もう1つ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-ebpf_exporter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用すると、低レベルの高解像度メトリックスを直接</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Prometheusサーバー</font></a><font style="vertical-align: inherit;">に収集でき、将来的には美しい視覚化とアラートさえも取得できます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja458574/index.html">開発者からチームリーダーに成長し、それとさらに共存する方法</a></li>
<li><a href="../ja458576/index.html">Webアプリケーションでのテキスト管理とローカリゼーション</a></li>
<li><a href="../ja458582/index.html">アマゾンのエンジニアが家の外に猫を寄せ付けないAIブロックデバイスを作成しました</a></li>
<li><a href="../ja458584/index.html">Webinar Group-IB 7月11日、「初心者のためのマルウェア分析：基本的なアプローチ」</a></li>
<li><a href="../ja458590/index.html">iOSアプリケーションのアーキテクチャアプローチ</a></li>
<li><a href="../ja458594/index.html">L7バランシングで繰り返し要求を使用してクライアントへの応答の可能性を高めることを忘れないでください</a></li>
<li><a href="../ja458596/index.html">ささいな喜び＃6：OpenAIジム-ゲームをプレイしてロボットを操作する</a></li>
<li><a href="../ja458598/index.html">環境マップ上の光源の認識</a></li>
<li><a href="../ja458600/index.html">電動自転車とは（2つのメーカーの5つのモデルの2つの部分でのグループレビュー）、パート1</a></li>
<li><a href="../ja458602/index.html">Great Chinese Firewallをどのように貫通したか（パート1）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>