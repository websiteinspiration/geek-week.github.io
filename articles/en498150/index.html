<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÜ ü§ê üì™ Plumber programmers, or the story of one leak and the difficulties of dealing with it üê∑ üö£üèΩ üë©üèæ‚Äçü§ù‚Äçüë©üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It was Tuesday, February 25th. The difficult release of the version on Saturday, February 22, was already in the past. It seemed that all the worst wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Plumber programmers, or the story of one leak and the difficulties of dealing with it</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/498150/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It was Tuesday, February 25th. The difficult release of the version on Saturday, February 22, was already in the past. It seemed that all the worst was behind, and nothing portended trouble. But everything changed at one time when a monitoring error came about a memory leak on the coordinator process of the access control service. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Where from? The last major changes in the coordinator's code base were in the previous version more than two months ago, and after that nothing remarkable happened to the memory. But, unfortunately, the monitoring schedules were adamant - the coordinator's memory obviously began to leak somewhere, there was a large puddle on the service floor, which meant that the plumbing team had a lot of work to do.</font></font><br>
<a name="habracut"></a><br>
<img src="https://habrastorage.org/webt/sz/a5/nc/sza5ncpnbgd9jxdzckmeu1bztsi.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First we make a small digression. </font><font style="vertical-align: inherit;">Among other things, VLSI allows you to keep track of working hours and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">monitor access</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> by face model, fingerprint or access cards. </font><font style="vertical-align: inherit;">At the same time, VLSI communicates with endpoint controllers (locks, turnstiles, access terminals, etc.). </font><font style="vertical-align: inherit;">A separate service communicates with devices. </font><font style="vertical-align: inherit;">It is passive, interacts with access control devices based on their own protocols implemented over HTTP (S). </font><font style="vertical-align: inherit;">It is written on the basis of the standard stack for services in our company: PostgreSQL database, Python 3 is used for business logic, extended with C / C ++ methods from our platform. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A typical web service node consists of the following processes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Monitor is the root process.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A coordinator is a child process of a monitor.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Work processes.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Monitor is the first web service process. </font><font style="vertical-align: inherit;">Its task is to call fork (), start the child coordinator process and monitor its work. </font><font style="vertical-align: inherit;">The coordinator is the main process of the web service, it is he who receives requests from external devices, sends responses and balances the load. </font><font style="vertical-align: inherit;">The coordinator sends the request to the work processes for execution, they execute it, transmit the response to the shared memory and inform the coordinator that the task is completed and you can pick up the result.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Who is to blame and what to do?</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the coordinator of the access control service differs from the coordinators of other services in our company by the presence of a web server. The coordinators of other services worked without leaks, so the problem had to be looked for in our configuration. Worse, on the test stands, the new version existed for a long time, and no one noticed memory problems on them. They began to look more closely and found that memory flows only on one of the stands, and even then with varying success - which means that the problem is still not so easily reproduced.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/c_/lg/_k/c_lg_kswgcknpdyc8k2h7bd22d8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What to do? How to find a reason? First of all, we took a memory dump and sent it to specialists from the platform for analysis. The result - there is nothing in the dump: no reason, no hint what way to look further. We checked the changes in the coordinator's code from the previous version - all of a sudden we made some terrible edits, but just didn‚Äôt understand this right away? But no - only a few comments were added to the coordinator code, but a couple of methods moved to new files - in general, nothing criminal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
They began to look towards our colleagues - developers of the core of our service. They confidently denied the very possibility of involvement in our misfortune, but offered to implant tracemalloc monitoring in the service. No sooner said than done, at the next hotfix we are finalizing the service, quickly testing, releasing to battle.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And what do we see? Now our memory flows away not just quickly, but very quickly - the growth has become exponential. We attribute the first peak to evil forces and the factors accompanying them, but the second peak, several hours after the first, makes it clear that it takes too long to wait for the next hotfix to be released with such an emergency behavior of the service. Therefore, we take the results of tracemalloc and patch the service, rolling back the edits with monitoring in order to return at least to linear growth.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zl/yh/w7/zlyhw7-3oq-9wxxwkvwvsl8gd08.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It seemed that we had the results of the work of tracemalloc on the memory allocated in Python, now we will look into them and find the culprit of the leak, but it wasn‚Äôt there - in the collected data there are no 5.5GB peaks that we saw on the monitoring graphs. The maximum used memory is only 250MB, and even traceMalloc eats 130MB of them. This is partly explainable - tracemalloc allows you to see the memory dynamics in Python, but it does not know about the memory allocation in C and C ++ packages that are implemented by our platform. In the obtained data, it was not possible to find something interesting, the memory is allocated in acceptable volumes to ordinary objects such as streams, strings and dictionaries - in general, nothing suspicious. Then we decided to remove everything superfluous from the data, leaving only the total memory consumption and time, and visualize.Although the visualization did not help answer the questions ‚Äúwhat is happening‚Äù and ‚Äúwhy‚Äù, with its help we saw a correlation with the data from monitoring - which means that we definitely have a problem somewhere, and we need to look for it.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/yr/es/gp/yresgpdyry0i_dr88dbtswqr8k8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At that time, our plumber team ran out of ideas on where to look for a leak. Fortunately, the bird sang to us that one major change from the platform did happen - the Python version changed from 3.4 to 3.7, and this is a huge search field. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We decided to look for problems related to memory leaks in Python 3.7 on the Internet, because for sure someone already encountered this behavior. Still, Python 3.7 was published a long time ago, we switched to it only with the current update. Fortunately, the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">answer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to our question was found quickly, and there was also </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">issue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pull-request</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to fix the problem, and she herself was in the changes made by the Python developers. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What happened?</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Starting with version 3.7, the behavior of the ThreadingMixIn class has changed, from which we inherit from our web server to process each request in a separate thread. In the ThreadingMixIn class, they added the entry of all created threads into an array. Due to such changes, class instances that handle device connections are not freed after completion, and the garbage collector in Python cannot clear memory from spent threads. This is what led to the linear growth of allocated memory in direct proportion to the number of requests to our server. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here it is, the insidious code of the Python module with a big hole (the code in Python 3.5 is shown on the left before changes, on the right - in 3.7, after):</font></font><br>
<br>
<img src="https://habrastorage.org/webt/0m/pp/87/0mpp87t9snuuoadbahwaoxw2jj8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Finding out the reason, we easily eliminated the leak: in our heir class, we changed the value of the flag that returned the old behavior, and that's all - a victory! </font><font style="vertical-align: inherit;">Streams are created as before, without writing to the class variable, but we observe a pleasant picture on the monitoring graphs - the leak has been fixed! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1o/ja/ss/1ojassz9esw-378romz5kexysde.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's nice to write about this after a victory. </font><font style="vertical-align: inherit;">We are probably not the first to encounter this problem after switching to Python 3.7, but most likely not the last. </font><font style="vertical-align: inherit;">For ourselves, we concluded that we need:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Take a more serious approach to assessing the possible consequences of major changes, especially if other applied decisions depend on us.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the event of global changes in the platform, such as, for example, changing the version of Python, check your code for possible problems.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Respond to any suspicious change in the monitoring schedules of not only combat services, but also test ones. </font><font style="vertical-align: inherit;">Despite the current garbage collector, there are memory leaks in Python too.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is a need to be careful with memory analysis tools like tracemalloc, as using them incorrectly can make things worse.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You need to be prepared for the fact that the detection of memory leaks will require patience, perseverance and a little detective work.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Well, I would like to express my gratitude to everyone who helped to cope with emergency plumbing work and once again return to its former working capacity to our service!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en498136/index.html">Conversation with Polina Gurtova about the future and present of Frontend. DUMP 2020 organizers ask some important questions.</a></li>
<li><a href="../en498138/index.html">Life after undergraduate studies: how I decided what to do next when higher education and work already exist</a></li>
<li><a href="../en498140/index.html">Replicate this. Webinars Apache Ignite and GridGain</a></li>
<li><a href="../en498144/index.html">Your First BERT: An Illustrated Guide</a></li>
<li><a href="../en498146/index.html">Six smart security trends to watch out for</a></li>
<li><a href="../en498154/index.html">Calendar of free IT events online from April 20 to 26</a></li>
<li><a href="../en498156/index.html">F #, morphology of binary images</a></li>
<li><a href="../en498158/index.html">Remote Marathon Week 1: Workplace</a></li>
<li><a href="../en498160/index.html">GlusterFS as external storage for Kubernetes</a></li>
<li><a href="../en498162/index.html">We invite you to an IT internship at Alfa Bank</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>