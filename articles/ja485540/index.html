<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🎓 ⛵️ 🐳 リバースアナログカメラの設計 🧔 🤦🏻 🔮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habrの前半で、アナログビデオ監視システムに関連する記事を公開しました。特に、DVRのHDDファイルシステムの研究に関する記事がありました。この記事では、ユーザーの視点からの巧妙なアナログビデオカメラモデルEvidence EVR-Y2022Fのレビューと、エンジニアリングの視点からのそのデバイス...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>リバースアナログカメラの設計</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485540/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/oq/uq/4j/oquq4jd-hxdwvx98q94lkttxb6i.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habrの前半で、アナログビデオ監視システムに関連する記事を公開しました。</font><font style="vertical-align: inherit;">特に、DVRのHDDファイルシステムの研究に関する記事がありました。</font><font style="vertical-align: inherit;">この記事では、ユーザーの視点からの巧妙なアナログビデオカメラモデルEvidence EVR-Y2022Fのレビューと、エンジニアリングの視点からのそのデバイスの詳細な調査について説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
現在、ネットワークIPカメラと対応するDVRに基づく最新のビデオ監視システムがより頻繁に使用されています。ただし、まず第一に、低価格のため、アナログビデオ監視システムは依然として関連性があります。多くのアナログビデオカメラがあります。画質の特性に加えて、他の多くの特性、特にPTZインターフェースの存在があります。このインターフェイスでは、DVRを使用するPELCO-Dプロトコルを使用して、RS-485ライン経由でカムコーダーを制御できます。これらは通常、ビデオの角度を変更することで回転できるドーム型カメラです。光学ズームとフォーカス（フォーカス）コントロールをサポートするPTZインターフェイスを備えたカメラはあまり一般的ではありません。この記事で説明するのは、このようなカメラについてです。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このビデオカメラの全体像を表紙と下の写真の両方に示します（図1）。便利なシンプルなボディと、注目を集める大きなレンズを搭載。ボタンとコネクタは後ろにあります（図2）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/o8/yu/rf/o8yurf7ijzqqoy_hww9cj_brnvs.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 1.ビデオカメラの正面図。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/jv/am/vr/jvamvrgeoy00qtcs3hpactw7p38.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 2.ビデオカメラの背面図。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図からわかるように、12V電源コネクタ、ビデオ出力、RS-485（A +、B-）、およびその他のZFCMがあります。さらに、制御電源LEDと5つのボタンがあります。ボタンの名前に基づくと、カメラには画面上の設定メニューとズームとフォーカスの手動制御があります。完全な操作マニュアルが存在せず、インターネットでも見つけられなかったことをすぐに指摘したいと思います。パッケージには、カメラの技術仕様が記載されたリーフが1枚だけ含まれていました。私はZFCMインターフェイスに非常に興味を持っていました。インターネットでも印象的な情報は見つかりませんでしたが、カメラのボタンを遠隔操作するために使用されていると直感的に推測しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
接続されているテレビ画面（またはモニター）でカメラに電圧をかけると、青色の背景に白い大きな文字「HELLO」が一時的に表示されます。同時に、モーターがカメラ内部のレンズを動かす音を聞くことができます。次に、画像が表示されます。カメラをさまざまな距離の物体に向けることで、カメラが自動的に焦点を合わせることができることが画面上の画像から明らかになります。 TELE / WIDEボタンを使用して、ズームを変更できます。つまり、ズームインまたはズームアウトできます。この場合、毎回オートフォーカスが発生します。 NEAR / FARボタンを押すと、オートフォーカスが無効になり、手動でフォーカスを調整できます。この機能は非常に興味深く、便利です。プロの写真やビデオカメラを除いて、彼女に会うことができます。事実、場合によっては、オートフォーカスアルゴリズムが必ずしも効率的に機能するとは限りません。たとえば、カメラの前にある非常に遠いオブジェクトの背景にある細い木の枝は、オートフォーカスによってキャプチャされません。マニュアルフォーカスを使用すると、レンズの前にあるオブジェクトに調整できます。さらに、カメラのズームはかなり良好です（22Xと宣言されています）。図3と4は、遠くの被写体の最大ズームと、固定ズームでのさまざまな手動フォーカス構成を示しています。この記事では、ビデオキャプチャデバイスを使用して作成したカメラのすべての画像（静止画像）を使用し、次に縮尺を半分にしました。また、CRTを備えた画面では、このカメラからのビデオはフラットLCDモニターよりも優れて表示されます。マニュアルフォーカスを使用すると、レンズの前にあるオブジェクトに調整できます。さらに、カメラのズームはかなり良好です（22Xと宣言されています）。図3と4は、遠くの被写体の最大ズームと、固定ズームでのさまざまな手動フォーカス構成を示しています。この記事では、ビデオキャプチャデバイスを使用して作成したカメラのすべての画像（静止画像）を使用し、次に縮尺を半分にしました。また、CRTを備えた画面では、このカメラからのビデオはフラットLCDモニターよりも優れて表示されます。マニュアルフォーカスを使用すると、レンズの前にあるオブジェクトに調整できます。さらに、カメラのズームはかなり良好です（22Xと宣言されています）。図3と4は、遠くの被写体の最大ズームと、固定ズームでのさまざまな手動フォーカス構成を示しています。この記事では、ビデオキャプチャデバイスを使用して作成したカメラのすべての画像（静止画像）を使用し、次に縮尺を半分にしました。また、CRTを備えた画面では、このカメラからのビデオはフラットLCDモニターよりも優れて表示されます。この記事では、ビデオキャプチャデバイスを使用して作成したカメラのすべての画像（静止画像）を使用し、次に縮尺を半分にしました。また、CRTを備えた画面では、このカメラからのビデオはフラットLCDモニターよりも優れて表示されます。この記事では、ビデオキャプチャデバイスを使用して作成したカメラのすべての画像（静止画像）を使用し、次に縮尺を半分にしました。また、CRTを備えた画面では、このカメラからのビデオはフラットLCDモニターよりも優れて表示されます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/eb/vk/qz/ebvkqzgk1bgti8d98l3kk48wvtg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 3.最小および最大ズーム。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/5k/1e/yb/5k1eybjqkiyncvlkw0dp-ftujoy.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 4.異なる焦点距離。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
「MENU」ボタンを押すと、OSDがビデオ画像の背景に白い文字で表示されます。メニューはセクションで構成されています。メインメニューページは以下の通りです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/38/t1/uk/38t1ukbk-h0xmg6lxzmlguzlp-i.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 5.メインメニューページ（ "MAIN"）。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pokeメソッドを使用すると、このメニューの管理方法を簡単に推測できます。メニュー項目は、ズームコントロールボタン（「上/下」）を使用して選択され、選択された項目のアクティブ化と構成は、フォーカスコントロールボタン（「左/右」）を使用して行われます。メニューの終了-「MENU」ボタンをもう一度、どこからでも押します。セクションからメインページに移動するには、最後のアイテム「戻る」をアクティブにする必要があります。 EXITメインページの最後の項目をアクティブにすると、メニューも終了します。選択したメニュー項目の記号は、点滅しているパラメーター（パラメーターの場合）または右側の矢印（メニューセクションの場合）です。上の図では、メインページの2番目のメニュー項目をすでに選択しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホームページの最初のメニュー項目は、PELCO-Dプロトコルのカメラアドレスです。最後の項目（EXITを含まない）は、出荷時の設定へのリセットです。残りの項目-6つのメニューセクションを検討します。セクションのページでは、メインメニューに移動するための最後の「戻る」項目はすでに矢印で強調表示されており、この項目のアクティブ化の兆候は点滅する矢印です。画面中央の項目の上に、メインメニューページに「MAIN」という単語が表示され、セクションページにメニューセクションの名前が表示されることにも注意してください。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zp/jw/2k/zpjw2kd0fdu38c-ra6d2yx3ls6c.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 6. "FOCUS"メニューのセクション。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「フォーカス」セクションの最初の段落（図6）を使用して、オートフォーカスを強制するか、マニュアルフォーカスを強制するか、またはを押してモードを選択できます。後者は、フォーカスボタンを押すとオートフォーカスが無効になり、ズームボタンを押す（ズーム比を変更する）とオンになることを意味します。 2番目の項目では、近距離の焦点距離を制限できます。 3番目のポイントは、カメラの電源を入れたときのように、ズームとフォーカスを強制的に初期化することです。 4番目と5番目はズーム制限です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/-o/vh/ck/-ovhckhlzqhvlj_bs6xiqc9h3fu.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 7.メニューセクション「WB MODE」。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目のセクション（図7）は、ホワイトバランスの設定に使用されます。このセクションの最初の段落では、プリセットモードの1つと、自動モードまたはユーザーモードを選択できます。後者は、セクションの2番目と3番目の段落を使用して構成され、青と赤の信号レベルを設定できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nk/oo/c-/nkooc-7ocvqpha8niwaxinvkwty.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 8.メニューセクションの「AE MODE」。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3番目のセクション（図8）は、露出を調整するためのものです。このセクションの最初の段落では、自動または手動の露出モードを選択できます。手動露出の場合、次の3つの項目を使用できます（2、3、4）。セクションの2番目の段落を使用して、AGC特性（自動ゲイン制御）の値を調整します。 3番目の助けを借りて-明るさの値（ただし、値「AUTO」もあります）。 4番目の、シャッター値。また、画像のゲインと明るさに影響します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ga/0n/0v/ga0n0va3bhfsa_0m2atlp2lgheg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 9.メニューセクション「GENERAL」とアクティブなパラメーター「MIRROR」。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
4番目のセクション（図9）は、他の個々の設定に当てられています。最初の項目は鏡像モード（左から右に表示）です。この場合、図からわかるようにアクティブで、背景の画像が鏡像化されています。私はこのモードを示すために故意にこれを行いました。 2番目のポイントは、リアライトの補正です。 3番目の項目は、デイ/ナイトモードです。デイモード、ナイトモード、または自動検出を選択できます。ナイトモードでは、カメラは白黒画像を生成します。 4番目の項目は、制御プロトコルのRS-485データレートの選択です。最後に、このセクションの5番目のポイントは、プロトコルの選択です。 PELCOD以外に、ここには他のオプションはありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bj/sk/an/bjskankw5j6qfisl69elqhlarhy.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 10.メニューセクション「OSD DIS」。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
5番目のセクション（図10）では、カメラ操作中に画面に情報を表示するためのパラメーターを構成します。最初の項目では、表示モードを選択できます。常に表示するか、表示しないか、またはデフォルトで選択されているように、フォーカス/ズームを変更するときに数秒表示します。 2番目の項目では、カメラ番号、またはRS-485のアドレスを表示できます。左上に表示されます。 3番目の項目は、フォーカスモードの表示を有効にします。 4番目の項目は、ズーム値の表示を有効にします。両方のオプションが右下隅に表示されます（通常モードでは、メニューがアクティブでない場合）。図の6つのカメラ画像の1つ。 4この情報の表示に気づくことができますが、まだ消える時間はありません。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/1s/i0/xu/1si0xudclpc24uabiy7ogkuwozg.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 11.メニューのセクション「IR LIGHT」。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の6番目のセクション（図11）は、赤外線照明制御の設定に専念しています。このカメラにはバックライトもそのインターフェースもないため、メニューのこのセクションは役に立ちません。しかし、どうやら、ファームウェアはユニバーサルなので、これは提供されています。私が理解しているように、ズーム位置の特定の間隔で3つのハイライトの1つを含めるように構成できます。最初のポイントは、このすべての機能を有効または無効にすることです。 2番目の項目は、バックライト番号（1、2、3）の選択です。次の3つのポイントは、各バックライトの個別の設定です。つまり、3番目のポイントは、現在選択されているバックライトに対してこの機能を有効または無効にすることです。 4番目の項目は、バックライト（間隔の左側の境界）をオンにするためのズーム値です。 5番目のポイントは、バックライト（間隔の右側の境界）をオフにするためのズーム値です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それでメニュー設定の検討を終えました。メニューのナビゲーションが不便で、若干の遅延があることは注目に値します。メニューを使用したカメラの設定が1回または非常にまれに発生するという事実にもかかわらず、それはまだ迷惑です。より正確には、メニューに経験豊富なユーザーのための「高速実行」オプションはありません。また、現在のアイテムを選択したことを示す記号またはパラメータの1ヘルツのちらつきは、まったく珍しいものです。イラスト用のメニューの画像をキャプチャするプロセスでさえ、アクティブな点滅パラメータが画面上にあるように、その瞬間をいつもうまく捉えることができませんでした。要するに、ボタンを押したときの反応は瞬時ではないため、非常に速いクリックは処理されません。私は2000年半ばのボタン式電話、特にボタン操作が即座に処理されたNokiaまたはSiemensを思い出します。最近の安価な押しボタン式電話には、この機能はありません。説明したカメラのメニューナビゲーションの場合にも、同様のことが観察されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、カメラの分解を開始します。この問題は、私の技術的な関心だけでなく、もっと卑劣な理由によっても引き起こされました。カメラを数ヶ月操作した後、彼女は「長い寿命を命じました」。失敗の理由はおそらく明らかでした：ファームウェアが死にました。それでも、修理の成功を期待して、カメラの内部を確認することにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
視覚的には、カメラは3つのプリント基板で構成されています。すぐに、コネクタ付きのボタンが配置されている最初のボードの詳細を調べ始めました。ボードをフレキシブルケーブルから外して反対側に向けると、主に5つのオプトカプラー、UARTからRS-485へのコンバーターのマイクロ回路とその5Vリニアレギュレーター（バンク）が見えました。私はこのボードの回路をスケッチし、すべてのトラックとテスターとの連絡先を呼び出すことにしました。結果はそのような計画です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/07/kw/wm/07kwwmqzmekf5droynktwfygm7k.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 12.最初のボードのスキーム。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チャートをスケッチする過程で、ZFCMインターフェースの使用方法がすぐに明らかになりましたが、まず最初に。 5つの利用可能なボタンは、直列接続された抵抗器のチェーンに接続されています。つまり、ピンが1つしかないADCが原因で、コントローラーはボタンのクリックを処理します。抵抗分圧器により、押された各ボタンは特定の電圧に対応し、複数のボタンを押しても処理されません。まあ、これで、すべてが明確です、これは古典的です。次に、フォトカプラについて説明します。そして、それらはZFCMに必要なだけです。各ボタンには、トランジスタのオプトカプラが出力部と並列に接続されており、オプトカプラの入力LED部（以下、アノードとカソード）はZFCM端子に巧みに接続されています。各フォトカプラの操作は、対応するボタンを押すことと同じです。 「MENU」ボタンに対応するオプトカプラーの陽極は「M」（メニュー）端子に行き、2つのズームボタンに対応するオプトカプラーのLED部分は逆平行に相互接続され、これらの2つの端は「C」および「Z」（ズーム）端子に接続されます。同じ話がフォーカスボタンのオプトカプラーにも当てはまります。端子は「C」と「F」（フォーカス）だけです。したがって、端子「C」は共通であることがわかります。フォトカプラ回路には、おそらく12Vの電圧からフォトカプラを点火するために、2.2KΩの制限抵抗が含まれています。つまり、「MENU」ボタンをリモートで押すには、従来のPSUから「C」（マイナス）端子と「M」（プラス）端子に12Vを供給する必要があります。ズームとフォーカスのボタンはより複雑です。たとえば、「WIDE」ボタン（「down」ボタンでもあります）をリモートで押す場合は、端子「Z」と「C」に同じ極性で12Vを印加する必要があります。また、「TELE」ボタン（「上」ボタンでもあります）をエミュレートするには、極性を変更する必要があります。残りの2つのボタンについても同様の操作が行われます。つまり、フォーカスの場合、「Z」端子の代わりに「F」端子のみが参加します。 ZFCMを実装するためのコントロールパネルは、たとえば次のように実行できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8y/b9/6s/8yb96sxoxrzpk15fcdedx0wfk4u.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 13. ZFCMのコントロールパネルの実装。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
回路にはバイポーラ電源が必要ですが、12Vバッテリーを2つ、さらには「クローナ」を置くこともできます。 620オームの抵抗器（私の手に落ちるなど）は、一対のズームボタンまたはフォーカスボタンを同時に押している間、短絡を防ぎ、一般に、作業に悪影響を与えません。一般的に、最初のボードの回路は単純で、追加のコメントは必要ありません。また、耐ノイズ性のために、ビデオ信号の「グラウンド」は一般的な「グラウンド」とは別になっていることにも注意してください。また、2つと3つのピンがGNDに接続されているため、MAX485トランシーバー（回路内-中国の対応物）は情報を受信するためにのみ機能します。これは、「DI」ピンがJ302に出力され、MKに接続されているにもかかわらずです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の部分を調べた後、残りのボード、つまりそれらの構成に含まれるすべての大きなマイクロ回路を表面的に調べました。ボードは両面で、両面にはコンポーネントが均等にしっかりと詰め込まれています。最大のボードは、「脳の中心」である-未知の起源のFBS101コントローラーと、多数のマイクロ回路、トランジスター、その他の小さなものです。 3番目のボードは小さく（最初のボードの後ろにあります）、SONYマイクロ回路の束があり、特に、CCD（つまり、ビデオののぞき穴）がカメラの光学部品にしっかりと接続されています。コンポーネントの番号付けから判断すると、3番目のボードは実際には3番目ではなく2番目であり、2番目は3番目です。しかし、最初から私は逆に数えることに同意しました。最初と3番目のボードは、2つのフレキシブルループによって2番目（メイン）に接続されています。また、ループバックケーブルが2番目のボードに接続されています。2つのモーター（ズームとフォーカス用）と2つの対応するリミットスイッチが取り付けられています。それらは表示されず、光学部品内に配置されます。先を見れば、リミットスイッチ（リミットスイッチ）は実際にはゼロ位置のセンサーとして機能し、両端ではなく中央にあることにすぐに気づきます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3番目のボード（ビデオプロセッサCXD3142R）の最大のマイクロ回路のデータシートを見つけました。その後-同じボードの残りのマイクロ回路のデータシート。特に、私が発見したように、マイクロ回路の1つは、いわゆるキャラクタージェネレーター（PD6464A）として機能します。ビデオプロセッサによって生成されたアナログビデオ信号は、それを介してビデオ出力に渡され、ビデオに文字をスーパーインポーズします。画面、特にメニューに碑文を形成するのは彼女です。チップは人気があり、そのデータシートは非常にシンプルです。このチップ（または同様のチップ）は、90年代のVCRおよびVHSカメラで使用されていました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのデータシートをざっと読んだ後、私は自分でカメラのファームウェアを開発することを考えました。また、標準のコントローラーが不明であることが判明したため、Atmegaを搭載した別のボードをカメラに挿入することにしました。 3番目のボードでは、ビデオプロセッサとキャラクタージェネレータの2つのチップが重要な役割を果たします。残りはビデオプロセッサの周辺です（特にCCD）。 SPIを介して（2番目のボード上の）メインコントローラーから情報を受け取るのは、これらの2つの主要なマイクロ回路です。したがって、最初に検討する必要があるのは2つのデータシートだけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一般的な開発とプレゼンテーションを容易にするために、残りの2つのボードの図を完全に書き直すことにしました。より正確には、タスクがファームウェアを書き込むことである場合、メイン（2番目）の回路基板を何らかの方法で調査する必要があります。しかし、2番目のボードの回路を再描画すると、3番目のボードで同様の手順を実行するように求められます。 3番目のボードのスキームの描画を容易にするために、ビデオプロセッサの周辺にあるすべてのマイクロ回路のデータシートを簡単に調査する必要がありました。ここでは、メインボードが大きいにもかかわらず、回路はメインボードの回路よりも集中化されていません。そのため、メインボードの回路よりテスターの呼び出し方で描くのが難しかったです。さらに、複雑さの主な基準は、ボードが両面であるだけでなく、多層でもあるという事実でした！コンピューターですべてをドラフトする前に、図をドラフトで描いた。上記の最初のボードの回路はすでに指定していますが、残りの回路は後で指定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下の図は、分解されたカメラとボードの種類を示しています。モーターとリミットスイッチ付きの列車も見ることができます。シャフトが短いモーターがフォーカスモーターです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ne/1d/zl/ne1dzle2nyk-yxrr5epeg9i5b84.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 14.分解されたビデオカメラ。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/tv/xa/bc/tvxabc0fbodmrfuxswi8sfjomyw.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 15.裏面のプリント基板の種類。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/ns/ky/g2/nskyg2-_ojgevvypcz4vhmqulr0.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 16.ビデオカメラは分解された状態です。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
すべてのボードの回路を再描画する長いプロセスの後に作成したカメラの構造図を検討してください。次の図に示します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xo/-x/4k/xo-x4kcqg8zzmemyqz22fq69mtc.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 17.ビデオカメラの構造図。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最大の「長方​​形」は、メインボード上のメインマイクロコントローラー（MK）U501です。ちなみに、すべてのコンポーネントのマーキングは、コンポーネントの横のボードに書かれているのでとても便利です。 MKの内部にはたくさんの空きスペースがあるため、信号出力の説明を記載した表をすぐに配置することにしました。 U201ビデオプロセッサは、SPIインターフェイス（ピン20（XCK）、26（CLK）、27（DATA_IN）、28（DATA_OUT））だけでなく、追加の信号を使用してMKに接続されています。まず、パラレル8ビットデジタルビデオバスです。また、ライン（38）、フレーム（39）、各画像要素（29）の同期パルス。これらのパルスの計算のおかげで、コントローラーは、デジタルビデオバス上の情報がどのフィールドまたはフレームのどのピクセルからのものかを認識します。 RST（19）の出力を介して、MKは起動時にビデオプロセッサをリセットします。MKは、AGC（80）の出力を通じて、ビデオプロセッサの周辺チップの1つからのAGC値の状態を認識しています。すでに書いたように、アナログビデオ信号はU402キャラクタージェネレーターを介して出力に渡されます。 SPIインターフェースは、ストローブ信号（チップ選択）-MKの出力（21）を除いて、MKからビデオプロセッサのSPIインターフェースに並列に接続されます。ビデオプロセッサは、アナログ形式とデジタル形式の両方でビデオ信号を配信できます。 MKに到達するデジタル信号は、オートフォーカス機能に明らかに必要です。ズームおよびフォーカスモーターを制御するのはMKです。モーターは、従来のバイポーラステッピングモーター（BH）です。 MKエンジンごとに、4つの出力が割り当てられます。ズームの場合-（44、46、54、55）、フォーカスの場合-（45、47、50、51）。後で説明するSDドライバーは、信号が解読された形式でドライバーに送られるように設計されています。一般に、モータードライブまたは位置決め付きの別のドライブの助けを借りて機械ユニットを制御するには、ゼロマークとなる1つのエンドスイッチで十分であり、モータードライブのステップをカウントして、アセンブリの最終位置をプログラムで監視できます。この場合、システムの電源を入れると、「初期化」、つまりゼロマークまで「ドライブ」して、何ステップが経過したかを覚えて戻る必要があります。私たちの場合、これは実装方法であり、この初期化アルゴリズムはカメラの電源がオンになるたびに発生します。ゼロマークフォーカススイッチからの信号はMKの出力（4）に送られ、ズームは出力（5）に送られます。オープンフォトカプラはリミットスイッチとして機能し、MKの結論（18）に従って、両方のリミットスイッチのLED部分がオンになります。ただし、カメラの寿命全体を通して、この信号は常にアクティブです。ボタンからのアナログ信号はMKの端子（1）に送られ、RS-485インターフェースからの情報は端子（42）（UART-RX）に送られます。したがって、MKはビデオプロセッサ、文字ジェネレータ（画面に文字と数字を印刷）を制御し、ボタンとPELCO-Dからのコマンドを処理し、光学ズームとフォーカスを制御します。しかし、最も重要で複雑なMKチップは、オートフォーカスを実装するためにデジタルバスを介して送られるビデオ信号の処理と分析です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインボードで他に何が面白いですか？ 2つの未知のはんだ付けされていないコネクタがあります（それらの場所）。それらの1つはJ503-12ピンです-図を描いたときにデコードしました。すでに最初は、このコネクタがフラッシュに使用されていると思いました。そして、それは起こりました。 2番目のJ505コネクタ（5ピン）の目的は、かなり後でわかりました。メニューの最後のセクションの説明で説明したように、赤外線照明（正確には3つ）がそれに固執します。 J503コネクタの隣には、U503 SPI EEPROMチップがあります。ラベル付けがインターネットで簡単にできるわけではなかったので、その目的はすぐにはわかりませんでした。最初はI2C EEPROMだと思いました。その下、ボードの反対側には、HA125というラベルの付いた別のU502チップがあります。これは、人気のある74HC244チップと同様の4チャネルリピーターです。各チャネルは論理信号で開閉できます。 1つのチャネルは、リピーターとしてMKリセット回路で動作します。そして、残りの3つのチャネルを特定の方法で経由して、SPIラインがMK、3番目のボード、およびEEPROMの間を通過します。この関係を下の図に示します（図18）。これは、プログラマーと連携するために必要です。プログラマーがJ503コネクターに接続されると、U502リピーターの3つのチャネルが非アクティブになり、MKがSPI EEPROMから切断されます。MKをSPI EEPROMから切断します。MKをSPI EEPROMから切断します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ay/kk/tg/aykktgugaut5pii5dxbbn7vane8.png"><br>
<i>. 18.    SPI  .</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この図は、J503コネクタの各ピンの目的を示しています。残りの結論は、私が言及しなかった食物と「土地」です。コネクタJ502-ビデオプロセッサを備えた3番目のボードへの出力コネクタ。プログラミングコネクタJ503を介して、EEPROM U503を操作するだけでなく（コネクタ7、9、11、5の出力上）、ビデオプロセッサとデータを交換することもできます（コネクタ5、10、8、12上の出力）。おそらくその3番目のボードでは、何かをフラッシュすることもできます。一般に、外部SPIデバイスを使用してビデオパス全体をデバッグできます。 U502の隣には小さなU504マイクロ回路があり、これは明らかに、EEPROMおよびビデオプロセッサからのSPIインターフェイスのMISO信号のアクティブな加算器として機能します。どうやら、EEPROMはカメラの電源が入っているときにファームウェアをロードする段階でのみ機能します。将来的には、SPIデータをMKに送信しません。カメラの動作中、SPIデータはビデオプロセッサからのみ送信されます（ある場合）。つまり、MCの側面に入るSPI信号の混合は発生しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
電源プランはそれほど単純ではありませんでした。そのコンポーネントはボード全体のほぼ半分を占めます：DC-DCコンバーター、リニアレギュレーター、ツェナーダイオードの束。より明確にするために、ブロック図を描きました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/kc/od/mf/kcodmft0ohv4cyiyyflcmhy8jts.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 19.電源の構成のブロック図。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のボードではすべてがシンプルです。 U201エレメントはU202 MAX485に電力を供給する働きをし、5Vを生成します。 2番目のボードでは、すべてがはるかに複雑です。エレメントU803およびU805は、MK、U801に電力を供給するために、それぞれ3.3Vおよび1.8Vの電圧を生成します-モータードライブ（5.5V）に電力を供給するため。エレメントU804は、主に3番目のボード用に5Vを生成します。現在のボードでは、1か所でのみ使用されており、重要ではありません。セルU802は、3.6Vの補助電圧を生成します。これは、U803およびU805の入力です。また、3.3Vを生成する3番目のボードのU207エレメントにも到達します。したがって、Q801およびQ802と合わせて、-8V（負）および18Vがどのように生成されるかは不明です。私はこの問題については特に掘り下げませんでした。彼らはすぐに3番目のボードに行きます。そこで、ツェナーダイオードD201の助けを借りて-8Vの負電圧が-5.1Vに変わり、18VはU205を使用して12Vに変換されます。負の電圧には、光から信号への変換の物理的特性に基づくCCDが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メインボードの回路基板を調べたところ、このカメラにはない別のモータードライバーの存在を検出しました。コネクタの対応する端子からSDとトレーラーでループをトレースすると、その上の対応するトラックがレンズに向かって折り返され、この時点でループが途切れます。ほとんどの場合、ループのこの部分とボード上の追加のドライバーは、このカメラモデルでは提供されていない絞りモーター用です。ループには余分なトラックがあり、対応するコネクタピンはまったく関与していません。おそらく、それらはダイヤフラムリミットスイッチ用に設計されています。または、未使用のループトラックの一部がメカニカルシャッターに関連しています（ビデオカメラの多くのモデルで同じ「ラッチ」）。おそらく、ボード上の未使用のドライバーは彼のためだけのものです。下の図は、カメラで使用される一般的なドライバ回路を示しています。最初の回路は、2つの同一のステッピングモーター制御回路の1つです。 2番目のスキームは、明らかにラッチ用の未使用のドライバーです。通常のDCモーターを制御するためのドライバーとしても機能しますが、SDを設定してダイアフラムを駆動する方がより論理的です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zf/fq/vl/zffqvlha8k5izacaimhwr6nenmg.png"><br>
<i>. 20.      .</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スキームは古典的であるため、詳細なコメントは必要ありませんが、それでも簡単に説明します。最初のスキームは次のように機能します。論理「1」が「制御1」に供給され、「0」が「制御3」に供給されると、直接極性の1つの（上）モーター巻線が機能します。場所で「0」と「1」を変更すると、巻線の極性が変わります。両方の「0」を適用すると、巻線の電圧が消えます。どちらも「1」は禁止されている組み合わせです（どうなるかは推測できます）。同様に、下側の巻線（「コントロール2」と「コントロール4」）についても同様です。したがって、これらの4つの制御入力に「1」を順番に送信すると、モーターステアが一方向または他の方向に回転します。 2番目のスキームは、最初のスキームの2つの半分のうちの1つと同様に機能します。モーターが通常のDCモーターの場合、次に、制御入力の論理的な組み合わせ「0-1」と「1-0」がそれぞれ正回転と逆回転を実現し、同じ名前「0-0」と「1-1」の組み合わせが停止を実現します。モーターの代わりに電磁ラッチ、つまりメカニカルシャッターがある場合、論理的な組み合わせ「0-1」と「1-0」で開閉が実現されます。上の図のダイオードは、負荷と反対方向に含まれており、逆起電力を抑制する働きをします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2番目と3番目のボードの完全な図を提示する時が来ました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ds/zj/5t/dszj5ttv7pcjfyi75tzzbdvg98i.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 21. 2番目のボード（メインボード）のスキーム。</font></font></i><br>
<br>
<img src="https://habrastorage.org/webt/fq/ub/lm/fqublmghd93l3pv1s8t-_qshu-g.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 22. 3番目のボード（CCDとビデオプロセッサを搭載したボード）のスキーム。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
マイクロコントローラの周りには、すべての端子の半分を占める多くの抵抗とコンデンサがはんだ付けされています。また、ボードには多くのダイオードアレイ（「A7」のマークが付いています）があり、保護目的で使用されます。SDドライバーでは、デュアルトランジスタアレイが使用されます。 Quartz MK Y501の周波数は12 MHzです。図に反映されていない「ゼロ」抵抗R645、R646、R647、R648は横に描かれています。それらは、すべてのスキームがすでに組み立てられていたかなり遅い時期に発見されました。ラインを最小限に抑え、回路に少なくともある程度の明快さを与えるために、バスの原理を適用し、電力線に入力矢印と出力矢印を散らしました。その中に電圧値の名前が書き込まれています（変数Vcc1 ... Vcc5、それらの値は回路の隅に表示されています）。 3番目のボードの回路はより複雑です。 Y201ビデオプロセッサのクオーツフェース値は18です。9375 MHzは、主張されているPALカラーシステムのビデオパラメーターに基づいて選択されます。周辺回路の1つ-U204 8チャネルDACは、必要な基準電圧を形成するのに役立ちます。その値は、ビデオプロセッサのSPIを介して変更できます。 DAC（AO7）の空きチャネルの1つからの電圧は、キャラクタージェネレーターの23出力に供給されます。データシートによると、このチップからの出力ビデオ信号のレベルを設定するために、そこに基準電圧が供給されています。これは、SPIを介した特定のコマンドに従って、ビデオプロセッサを介してこの基準電圧の値をプログラムで変更するために行われます。DAC（AO7）の空きチャネルの1つからの電圧は、キャラクタージェネレーターの23出力に供給されます。データシートによると、このチップからの出力ビデオ信号のレベルを設定するために、そこに基準電圧が供給されています。これは、SPIを介した特定のコマンドによってビデオプロセッサを介してこの基準電圧の値をプログラムで変更するために行われます。DAC（AO7）の空きチャネルの1つからの電圧は、キャラクタージェネレーターの23出力に供給されます。データシートによると、このチップからの出力ビデオ信号のレベルを設定するために、そこに基準電圧が供給されています。これは、SPIを介した特定のコマンドによってビデオプロセッサを介してこの基準電圧の値をプログラムで変更するために行われます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
図に加えて、両面のプリント基板のスケッチを2：1の縮尺で描きました。ここには、マーキングのあるすべてのコンポーネントが示されています（図23）。スキームとスケッチのコンポーネントのリストを比較して、不足しているコンポーネントのエラーに取り組みました。この段階で、4つのジャンパーがないことを発見し、脇に置いておきました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wn/wa/c0/wnwac0sbme7oxaaprwbh5rjvx8c.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 23.プリント回路基板のスケッチ。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
記事のこの部分の結論として、SDとリミットスイッチを使用したループの配線図を示します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qk/oh/_f/qkoh_f6eetlkfjvbn03tufbhd3i.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">図。 24. SDとトレーラーのあるループの配線図。</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
次に、以前にMK U501とEEPROM U503をはんだ付けしなかった各ノードの詳細な調査に進みました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リミットスイッチは、ズームレンズとフォーカスレンズが動く経路のほぼ中央にあります。ステッピングモーターの軸上のネジの回転により変位が発生します。解体して手動でノードを移動することができますが、自重があっても非常に簡単に移動できます。このようにして、リミットスイッチからの信号遷移の方向を「0」から「1」に固定しながら、リミットスイッチがトリガーされる場所を確立しました。私はこの方向を前向きに考えることに同意しました。わかりやすくモデリングしやすいように、整数座標系F（Z）を導入するというアイデアがありました。ゼロの場合、リミットスイッチが機能するポイントを考慮することに同意しました。モーターシャフトの位置、したがってレンズの位置が離散しているため、ステッピングモーターのステップを整数として座標値を取得しました。ズームとフォーカスによって制限（境界）を決定するだけです。デバッグボード上にテストファームウェアを作成し、8本のワイヤーをSDドライバーにはんだ付けすることで、それらを経験的に決定しました。 MKの対応する結論の後、ベース回路にある抵抗にはんだ付けするのが最も便利です。ギア（ノット）を手動で動かすと、この機械システムの興味深い特徴を発見しました。フォーカスノードが完全に左から最後まで移動し、ズームノードが中間位置から右にスムーズに移動した場合、右端のボーダーの前（全長の約10％に達していない）で、フォーカスノードのプルが開始されます。これは、閉じてアクセスできない光学系のメカニズムの機能です（私は分解しませんでした）。つまり、フォーカスノードを左に移動し、ズームノードを右に同時に移動することは不可能であることがわかります。この機能も考慮に入れました。経験的に、ズーム座標値を設定し、この機能が発生し始める場所。平面にスケッチを描き、ズームを横軸とし、フォーカスを縦軸とすると、次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k9/ld/me/k9ldmefn5zu7pkjrcctpwmmpavm.png"><br>
<i>. 25.      .</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
座標平面上の太い線は、許容座標を制限するほぼ長方形の領域を示しています。より正確には、ズームノードとフォーカスノードの可能な位置を示しています。なぜほとんど？なぜなら、上で書いたように、力学のトリックの特徴に基づいて、長方形領域の右下隅が除外されているからです。水平方向の長方形は、垂直方向の約2倍の大きさです。これは、先に書いたように、線形寸法では、ズームの動きの長さがフォーカスよりも長いためです。ネジ、ギア比、ステッピングモーターも同じです。図からわかるように、ズームは-600から600まで変化します。つまり、ゼロマークは正確に中央に位置しています。フォーカスの場合、この間隔は-340〜280で、ゼロマークはわずかにオフセットされます。一般的に、理論的には、ゼロマーク（トレーラー）はどこにでも配置できます。右下隅の相対的なスライス座標は-100 x -100です。つまり、フォーカスが極端に負の位置にあり、ズームがプラスに増加すると、500に達すると、機械的にフォーカスが引き込まれます。数値（座標値）はSDのステップであることを思い出させてください。作業者の五角形領域の外側にある点線は、メカニズムがまだミスを許している場合の「ストレッチ」領域の境界です。しかし、調査中、私は何度も間違えられました、そして、SDは端に当接したギアを通して強打で行きました。ワーキングチャンバーの実際のワーキングエリアが何であったかはわかりませんが、はるかに小さく、もちろん長方形だったようです。長方形はこの五角形の領域の内側にあり、切り取られた角は外側のままでした。言い換えると、元のファームウェアでのズームとフォーカスの本当の限界は、おそらくメカニックが許容するものより少なかったでしょう。中国人がそんなに迷惑をかけるとは思えない。はい、私たちは焦点の合った画像にのみ関心があるため、この領域のすべての点が実用的な意味を持つわけではないことは明らかです。はい、そしておそらく、領域内の光学の観点から多くの無意味な点がありますが、その理論に踏み込んで力学を理解することは課題ではありません。最も可能性が高いのは、オリジナルでは、フォーカスが下（-240）からやや上（240）に制限されており、領域が中央対称の長方形になり、同時に右下隅のカットが除外されているためです。それにもかかわらず、私は自分のファームウェアに五角形の領域全体を実装する計画があり、それが実際にどのように反映されるかを確認しました。そして右下のコーナーで私が思いついた処理する方法。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
研究を続けるために、私は作業状態でまったく同じカメラを見つけました。まず、ビデオプロセッサに送られる動作中のカメラのSPI MK出力を動作していないカメラに愚かに並列化しました。つまり、作業室MKは2つのビデオプロセッサを同時に並行して初期化しました。つまり、初期化が成功し、動作していないカメラが画像を生成し始めたと確信しました。オシロスコープでBHの信号を調べると、デューティサイクルが1：4、周波数が約400 kHzのPWMが存在することがわかりました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それから私はビデオプロセッサーでデータシートを勉強し始めました。キャラクタージェネレーターのデータシートとは異なり、不明確であることが判明しました。頭に負担がかからないように、ブレッドボードにSPIアナライザーと呼ばれる一時的な補助デバイスを作りました。ちなみに、先を見ると、ビデオプロセッサのSPIは最初は3.3Vレベルを使用していますが、すべてが5Vレベルで正常に動作しています。おそらく、チップは5Vの許容誤差を許容します。これがどれほど重要であるかについては、詳細には触れませんでした。それは数年前のことでしたが、今は自分自身がそのときどのような事実を考慮に入れたか覚えていません。最初に、アナライザーを動作中のカメラのキャラクタージェネレーターに接続しました。メニューを呼び出してメニューを実行すると、UARTターミナルを介してキャラクタージェネレーターに送信されるバイトをキャッチして書き留めました。それとは別に、カムコーダーの電源を入れたときのキャラクタージェネレーターの初期化に注意しました。すべてがデータシートに匹敵し、すべてが成功しました。しかし、ビデオプロセッサにバイトがあるため、より興味深いことがわかりました。ビデオプロセッサのデータシートには、カテゴリ（グループ）に分けられた多数のレジスタが示されています。各カテゴリには、独自のアドレス（番号）もあります。このすべてのヒープの中で、「Ctrl + F」を使用して、キーワード「MIRROR」を見つけました。このパラメーターは、3番目のカテゴリーの9番目のレジスターのビット7に対応します。どうやら、ユーザーがメニューでMIRROR機能を選択すると、MKはこのビットを覆します。これは鏡像モードです。メニューを見たときにこの機能について触れました。そして、私はこのパラメーターに特にアタッチすることにしました。初期化バイトに注意を払っていない間、私はメニューの適切なセクションに行き、このパラメーターをクリックし始めました。この場合、SPIアナライザーは受信したバイトを記録しました。ミラーモードがオンになっているとき、MKは48バイトをビデオプロセッサに送信しましたが、そのほとんどはゼロでした。私はゼロ以外のバイトのみを調べ始めました。それらは、MIRROR関数が存在するデータシートのそれらのアドレスとまったく一致しませんでした。 Excelでこれらのバイトのビットを逆にすることにしました。それからはじめて、何かが収束し始め、より明確になった。ビデオプロセッサのSPIパラメータでビット逆順（LSBファースト）が使用されているという結論に達しました。 48バイトのパケットを条件付きで16バイトの3つのグループに分割しました。各グループでは、最初の4バイトはゼロ以外で、残りの12バイトはゼロです。 4つの最初の非ゼロバイトには常に定数値（0x04）があります（これも後で確認します）。 2番目のバイトはカテゴリー番号です。 3番目はカテゴリー内のパラメーター番号で、最後は4番目はパラメーター値です。ただ、3番目のグループの4バイトは、「MIRROR」に対応するアドレスと値に完全に一致しました。オンとオフの両方で、対応するビットに変化が見られました。そして、最初の2つのバイトグループが繰り返されました。何らかの理由で最初のバイトグループは、デフォルト値であるカテゴリ2のレジスタNo. 1に0x00を登録しました（データシートによる）。2番目のバイトグループは、カテゴリNo. 2のレジスタNo. 4のビット4を「1」に設定します。データシートの要約では、このレジスタの意味がわかりませんでした。以下の画像は、「MIRROR」モードがオンになっている場合のSPIトラフィックを含むExcelのスクリーンショットを示しています。最初の2列は、ビットを反転せずに受信バイトです。また、「ST」列はビットが反転しています。オフにすると、対応するビットに変化が見られました。そして、最初の2つのバイトグループが繰り返されました。何らかの理由で最初のバイトグループは、デフォルト値であるカテゴリ2のレジスタNo. 1に0x00を登録しました（データシートによる）。2番目のバイトグループは、カテゴリNo. 2のレジスタNo. 4のビット4を「1」に設定します。データシートの要約では、このレジスタの意味がわかりませんでした。以下の画像は、「MIRROR」モードがオンになっている場合のSPIトラフィックを含むExcelのスクリーンショットを示しています。最初の2列は、ビットを反転せずに受信バイトです。また、「ST」列はビットが反転しています。オフにすると、対応するビットに変化が見られました。そして、最初の2つのバイトグループが繰り返されました。何らかの理由で最初のバイトグループは、デフォルト値であるカテゴリ2のレジスタNo. 1に0x00を登録しました（データシートによる）。2番目のバイトグループは、カテゴリNo. 2のレジスタNo. 4のビット4を「1」に設定します。データシートの要約では、このレジスタの意味がわかりませんでした。以下の画像は、「MIRROR」モードがオンになっている場合のSPIトラフィックを含むExcelのスクリーンショットを示しています。最初の2列は、ビットを反転せずに受信バイトです。また、「ST」列はビットが反転しています。２番目のバイトグループは、カテゴリー２のレジスター４のビット４を「１」に設定する。データシートの要約では、このレジスタの意味がわかりませんでした。以下の画像は、「MIRROR」モードがオンになっているときのSPIトラフィックを含むExcelのスクリーンショットを示しています。目的の「ユニット」が赤で強調表示されており、すべてが開始されています。最初の2列は、ビットを反転せずに受信バイトです。また、「ST」列はビットが反転しています。２番目のバイトグループは、カテゴリー２のレジスター４のビット４を「１」に設定する。データシートの要約では、このレジスタの意味がわかりませんでした。以下の画像は、「MIRROR」モードがオンになっているときのSPIトラフィックを含むExcelのスクリーンショットを示しています。目的の「ユニット」が赤で強調表示されており、すべてが開始されています。最初の2列は、ビットを反転せずに受信バイトです。また、「ST」列はビットが反転しています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jn/lf/rq/jnlfrqjnrquqanf2sbkr3elplds.png"><br>
<i>. 26.  SPI   Excel.</i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、48バイトではなく4バイトの簡略化されたコマンドをビデオプロセッサに送信するために、同じデバッグボード上に「SPIジェネレータ」を構築することにしました。最初のバイトは定数（4）です。 2番目のバイトはカテゴリアドレス（3）、3番目のバイトはパラメータアドレス（9）、4番目のバイトはパラメータ値です。 「MIRROR」の場合はビット7で、残りのビット（受信データから取得）を保持すると、「0xB0」でミラーモードがオンになり、「0x30」でオフになることがわかります。実験は成功しました！したがって、ビデオプロセッサへのSPIパッケージは次のようになります（0x04、CAT、PAR、VALUE）。つまり、定数4、カテゴリ番号、カテゴリ内のパラメータ番号、およびパラメータ値。他のアドレスで明確なパラメーターを使用していくつかの例を確認することで、これを確信しました。そしてなぜMKはビデオプロセッサにそれほど多くのnullバイトを送信するのですか？私はSPIアナライザーをビデオプロセッサの「SO」出力（MISOと同じ）に接続することにしました。結局のところ、ビデオプロセッサはさまざまなバイトをMKに送信し、MKはゼロを送信します。私はそれらを解読しませんでした、そしてデータシートには「シリアル出力」についてほとんど理解できる情報がありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私のSPIアナライザーでは、受信トラフィックを簡略化するために、ヌルバイトを無視するようにしました。そして、ゼロバイトが有用である場合（その非常に重要な4バイトから）、見過ごされることはありません。それは4バイト目（パラメーター値）のみであり、1回限りの場合です。残りのバイトをゼロにすることはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ビデオプロセッサの初期化バイトを調べました。この場合、4バイトの小包を47個記録しました。その中には多くの繰り返しがありました！なぜこれが行われるのかわかりません。繰り返しを除いて、これらすべての前提をSPIジェネレーターに入れました。その結果、21個のパッケージが作成され、独自のSPIジェネレーターによる初期化も成功しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初期化後、特定のメニュー項目を変更するときにMKがビデオプロセッサに送信する傍受バイトを調べ始めました。 Excelスプレッドシートに保存した「プロトコル」全体。また、初期化のように多くの「余分な」前提と繰り返しがありましたが、ビデオプロセッサのデータシートに依存して、キーポイントのみに注意を払いました。データシートのパラメーターと同じ名前のメニューパラメーターは、コメントしません。メニューのパラメータがあまり明確でないことに関係する最も興味深い点のみを書きます。これはまず、「GENERAL」セクションの3番目のパラメーターであり、「D / N」と呼ばれます。 「日」、「夜」、「自動」の3つの意味があることはすでに述べました。結局のところ、「day」パラメーターの値は「auto」パラメーターの値と完全に同じです。つまり、実際には、固有のパラメーターは2つしかありません。アナライザーは示したパラメーターの値を変更すると、「MIRROR」パラメーターの場合と同様に、3番目のカテゴリーの9番目のバイトが編集されます。ただし、MIRRORパラメーターを変更すると、このバイトの1ビット（bit7）のみが編集されました。また、「D / N」を切り替えると、bit5とbit4が編集されます。デイモードではこれらのビットは「1」に、ナイトモードでは「0」に引き上げられます。データシートでこのバイトの構造を見ると、最下位の5ビット（bit0 ... bit4）がビデオコンポーネントのバーストレベルに関与しており、bit5がその反転に関与していることがわかります。ナイトモードは反転のあるバーストレベルのゼロ値に対応し、デイモードは反転なしのバーストレベル0x10に対応することがわかります。ちなみに、レベル値は、データシートで指定されているデフォルト値（NTSCの場合は0x12、PALの場合は0x13）とは異なります。私のSPIデバッガーを使用して、このバイトを実験しました。さまざまな値でビデオプロセッサに送信します。 「バーストレベル」パラメータがゼロの場合、「反転バースト」ビットの値に関係なく、画像は白黒になります。バーストレベルが増加すると、画像の色が画面に追加され、バーストの反転によって場所によって赤と青の色が変化します（明らかに、ビデオ信号の色差コンポーネントが入れ替わります）0x10レベルの値は、視覚的に0x13データシートの値とほとんど同じです。したがって、カメラ設定の「夜」および「日」モードは、白黒またはカラー画像にすぎません。また、「自動」は「昼間」と同じです。 MKがメカニカルシャッターを使用して追加の操作を実行する可能性がありますが、このモデルにはありません。しかし、私は未使用のドライバーの入力で信号を制御しませんでした。また、露出設定に関する「AE MODE」メニューの3番目のセクションにもう1つ注意点があります。明るさを調整する3番目のパラメーターには、15階調（1 ... 15）と、上記のレビューメニューで説明した「AUTO」という値があります。アナライザーは何を示しましたか？このパラメーターを変更すると、ビデオプロセッサの基準電圧の値に対応して、6番目のカテゴリの5番目のバイトが編集されます。これは、すでに簡単に書いた周辺DAC U204の6番目のチャネルで開発されています。データシートの推奨されるデフォルト値は0x58（または88）です。この例では、40（輝度値1）から96（輝度値15）に変化します。つまり、4ずつ増加します（カウントする場合）。メニューからさまざまな15の輝度値に応じて、MKが送信する値のリストをすぐに提供します：40、44、48、52、56、60、64、68、72、76、80、84、88、92、96。ただし、「AUTO」値が選択されている場合、MKは66のバイト値を送信します。気づいたり数えたりすると、この値は平均輝度値（値7と値8の間）、つまり中央のタイプに対応します。これは中国人が彼らのファームウェアで実行したという考えです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メニューの最後のセクションを調べて、私は直感的に、未知のJ505コネクタの電圧を測定するというアイデアを思いつきました。</font><font style="vertical-align: inherit;">このセクションのパラメータをクリックすると、このコネクタの一部の端子で電圧レベルの変化が見られ、その後すぐにその目的を理解しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まあ、原則として、これはこの大きな記事を終えることができます。</font><font style="vertical-align: inherit;">次の記事では、これの続きとして、この壊れたカメラ用の独自のファームウェアの開発について説明します。</font><font style="vertical-align: inherit;">開発前に、必要なすべての手順が実行されました。</font><font style="vertical-align: inherit;">回路を描いて研究しただけでなく、周辺機器とMCを交換するためのプロトコルについても詳細に研究しました。</font><font style="vertical-align: inherit;">また、機械部品が調査され、必要な測定が行われます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja485530/index.html">ガイド付き学習</a></li>
<li><a href="../ja485532/index.html">それらを理解していないプログラマのためのインタビューガイド</a></li>
<li><a href="../ja485534/index.html">HighLoad ++、Mikhail Makurov（Intersvyaz）：バックアップおよびクラスター化されたZabbixサービスの作成経験</a></li>
<li><a href="../ja485536/index.html">飛行機をハックすることは可能ですか-2</a></li>
<li><a href="../ja485538/index.html">Zabbix：行のすべてを監視します（例としてRedisを使用）</a></li>
<li><a href="../ja485542/index.html">Notionにグラフィックを追加する</a></li>
<li><a href="../ja485544/index.html">動的システムとしてのチェス</a></li>
<li><a href="../ja485546/index.html">黙示録が来ています</a></li>
<li><a href="../ja485548/index.html">棚のSwiftUI</a></li>
<li><a href="../ja485550/index.html">モスクワ環状道路を越えて生命はありますか？開発者を探して準備する方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>