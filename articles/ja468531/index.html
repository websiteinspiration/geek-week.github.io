<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍍 🏞️ 🙌🏽 VKontakte向けの最初のPHPボット ⤴️ 🌇 Ⓜ️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="こんにちは、Khabrovites。この出版物では、VKontakte用の最初のチャットボットの作成方法について説明します。経験豊富なプログラマにとっては、これは面白くないと思いますが、私自身、あまり初心者の問題を理解していないので、旅を始めたばかりの人も興味があると思います。また、スクリーンショッ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>VKontakte向けの最初のPHPボット</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468531/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">こんにちは、Khabrovites。</font><font style="vertical-align: inherit;">この出版物では、VKontakte用の最初のチャットボットの作成方法について説明します。</font><font style="vertical-align: inherit;">経験豊富なプログラマにとっては、これは面白くないと思いますが、私自身、あまり初心者の問題を理解していないので、旅を始めたばかりの人も興味があると思います。</font><font style="vertical-align: inherit;">また、スクリーンショットのほとんどが英語で表示されることをすぐに警告します。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、コミュニティを作成する必要があります。誰でも扱えると思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、コミュニティ設定に移動し、「APIの使用」項目を選択して、「トークンの作成」ボタンをクリックします。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tq/eg/ou/tqegou3hhrqx4guyg2t4iypw3pc.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、実際には、このトークンを使用して使用できるものを選択する必要があります。コミュニティメッセージにアクセスする必要がありますが、将来のトークンの作成について覚えておく必要がないように、すべてのアクセス権を選択できます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dn/-w/ax/dn-waxj-jyi1r_yyxvqkee7ctfm.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、私たちは切望されたトークンを得ました。ところで、それは安全な場所に保管し、誰にも見せないようにする必要があります。これでコードに進むことができます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/2q/bd/mr/2qbdmr-ahvavqv_bz2wcic10u8a.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コードはPHPで作成するため、Visual StudioコードまたはPHPStormをダウンロードできます。原則として、コードはメモ帳で書くことができますが、それだけでは不便です。コードが終わったら、グループをさらに設定します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そのため、最初に、着信メッセージに関する情報を取得し、それをJSON形式からPHPで理解できる形式に変換する必要があります。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
$data = json_decode(file_get_contents(<span class="hljs-string">'php://input'</span>));
<span class="hljs-meta">?&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
data変数には、メッセージ、ユーザーID、チャットIDを含む配列があります。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「そして何ですか」json_decode（file_get_contents（ 'php：// input'））」、あなたは尋ねます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この瞬間から始めましょう：</font></font><br>
<br>
<pre><code class="php hljs">file_get_contents(<span class="hljs-string">'php://input'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡単に言えば、スクリプトに、何が入力されたのか、つまりVKが送信した要求を尋ねます。</font><font style="vertical-align: inherit;">以下はそのようなリクエストの例です。</font></font><br>
<br>
<pre><code class="json hljs">{<span class="hljs-attr">"type"</span>:<span class="hljs-string">"message_new"</span>,<span class="hljs-attr">"object"</span>:{<span class="hljs-attr">"date"</span>:<span class="hljs-number">1568464037</span>,<span class="hljs-attr">"from_id"</span>:<span class="hljs-number">450829055</span>,<span class="hljs-attr">"id"</span>:<span class="hljs-number">5400</span>,<span class="hljs-attr">"out"</span>:<span class="hljs-number">0</span>,<span class="hljs-attr">"peer_id"</span>:<span class="hljs-number">450829055</span>,<span class="hljs-attr">"text"</span>:<span class="hljs-string">" ."</span>,<span class="hljs-attr">"conversation_message_id"</span>:<span class="hljs-number">1478</span>,<span class="hljs-attr">"fwd_messages"</span>:[],<span class="hljs-attr">"important"</span>:<span class="hljs-literal">false</span>,<span class="hljs-attr">"random_id"</span>:<span class="hljs-number">0</span>,<span class="hljs-attr">"attachments"</span>:[],<span class="hljs-attr">"is_hidden"</span>:<span class="hljs-literal">false</span>},<span class="hljs-attr">"group_id"</span>:<span class="hljs-number">171524656</span>}
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
英語で最低限の知識があれば、リクエストの内容が理解しやすいと思います。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さて、「json_decode（）」は、上記のJSONをPHPが操作できる配列に変換する関数です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、発生したイベントを確認するコードを記述します。新しいメッセージが届いた場合は、そのメッセージと応答のあったメッセージを比較し、チャットIDを確認します。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
$data = json_decode(file_get_contents(<span class="hljs-string">'php://input'</span>));
<span class="hljs-keyword">switch</span> ($data-&gt;type) {  
	<span class="hljs-keyword">case</span> <span class="hljs-string">'confirmation'</span>: 
		<span class="hljs-keyword">echo</span> $confirmation_token; 
	<span class="hljs-keyword">break</span>;  <font></font>
		<font></font>
	<span class="hljs-keyword">case</span> <span class="hljs-string">'message_new'</span>: <font></font>
		$message_text = $data -&gt; <span class="hljs-keyword">object</span> -&gt; text;<font></font>
		$message_text = $data -&gt; <span class="hljs-keyword">object</span> -&gt; peer_id;
		<span class="hljs-keyword">if</span> ($message_text == <span class="hljs-string">""</span>){
			<span class="hljs-comment">// - </span><font></font>
		}<font></font>
		<span class="hljs-keyword">if</span> ($message_text == <span class="hljs-string">""</span>){
			<span class="hljs-comment">// - </span><font></font>
		}<font></font>
		<span class="hljs-keyword">echo</span> <span class="hljs-string">'ok'</span>;
	<span class="hljs-keyword">break</span>;<font></font>
}<font></font>
<span class="hljs-meta">?&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、これらのメッセージに何らかの形で応答する必要があります。</font><font style="vertical-align: inherit;">これを行うには、単純な関数を記述します。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">vk_msg_send</span>(<span class="hljs-params">$peer_id,$text</span>)</span>{<font></font>
	$request_params = <span class="hljs-keyword">array</span>(
		<span class="hljs-string">'message'</span> =&gt; $text, 
		<span class="hljs-string">'peer_id'</span> =&gt; $peer_id, 
		<span class="hljs-string">'access_token'</span> =&gt; <span class="hljs-string">"TOKEN"</span>,
		<span class="hljs-string">'v'</span> =&gt; <span class="hljs-string">'5.87'</span> <font></font>
	);<font></font>
	$get_params = http_build_query($request_params); <font></font>
	file_get_contents(<span class="hljs-string">'https://api.vk.com/method/messages.send?'</span>. $get_params);<font></font>
}<font></font>
<span class="hljs-meta">?&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで何が起こっているのですか？</font><font style="vertical-align: inherit;">ここでは、先ほど作成したメッセージテキスト、チャットID、トークンを使用してVK API（ドキュメントを読むことをお勧めします）へのリクエストを作成し、VKサーバーに送信します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、これらのコードを接続し、特定のメッセージに対するボットの反応を記述します。</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-meta">&lt;?php</span>
$confirmation_token = <span class="hljs-string">'CONF_TOKEN'</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">vk_msg_send</span>(<span class="hljs-params">$peer_id,$text</span>)</span>{<font></font>
	$request_params = <span class="hljs-keyword">array</span>(
		<span class="hljs-string">'message'</span> =&gt; $text, 
		<span class="hljs-string">'peer_id'</span> =&gt; $peer_id, 
		<span class="hljs-string">'access_token'</span> =&gt; <span class="hljs-string">"TOKEN"</span>,
		<span class="hljs-string">'v'</span> =&gt; <span class="hljs-string">'5.87'</span> <font></font>
	);<font></font>
	$get_params = http_build_query($request_params); <font></font>
	file_get_contents(<span class="hljs-string">'https://api.vk.com/method/messages.send?'</span>. $get_params);<font></font>
}<font></font>
$data = json_decode(file_get_contents(<span class="hljs-string">'php://input'</span>));
<span class="hljs-keyword">switch</span> ($data-&gt;type) {  
	<span class="hljs-keyword">case</span> <span class="hljs-string">'confirmation'</span>: 
		<span class="hljs-keyword">echo</span> $confirmation_token; 
	<span class="hljs-keyword">break</span>;  <font></font>
		<font></font>
	<span class="hljs-keyword">case</span> <span class="hljs-string">'message_new'</span>: <font></font>
		$message_text = $data -&gt; <span class="hljs-keyword">object</span> -&gt; text;<font></font>
		$chat_id = $data -&gt; <span class="hljs-keyword">object</span> -&gt; peer_id;
		<span class="hljs-keyword">if</span> ($message_text == <span class="hljs-string">""</span>){<font></font>
			vk_msg_send($chat_id, <span class="hljs-string">",  ,    ."</span>);<font></font>
		}<font></font>
		<span class="hljs-keyword">if</span> ($message_text == <span class="hljs-string">""</span>){<font></font>
			vk_msg_send($chat_id, <span class="hljs-string">".    - ,     ,    ."</span>);<font></font>
		}<font></font>
		<span class="hljs-keyword">echo</span> <span class="hljs-string">'ok'</span>;
	<span class="hljs-keyword">break</span>;<font></font>
}<font></font>
<span class="hljs-meta">?&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「それでは、なぜメッセージを送信した後で「ok」と書かなければならないのですか？」</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コールバックAPIと呼ばれるupdateメソッドを使用するため、つまり、VKは新しいメッセージについて話します。つまり、聞いたことを伝える必要があります。そうでない場合は、何回か繰り返されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、グループの設定に進みましょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定に入り、APIバージョン5.87を選択します（もちろん、新しいバージョンを使用することもできますが、APIバージョンを1つにまとめることをお勧めします）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/d1/ka/yo/d1kayoif8egeljzym8hl176iarw.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同じセクションから、サーバーが返す必要がある行を取得し、confirmation_token変数に代入します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、サーバーアドレスを入力します。これを行うには、ドメインとホスティングが必要です。指定するアドレスは、ボットを含む単なるファイルでなければなりません。読者が自分でこれを処理できることを願っています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、コミュニティのどのイベントがVKontakteによって報告されるかを選択します。</font><font style="vertical-align: inherit;">着信メッセージだけが必要です。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/dy/k8/y9/dyk8y9kva7a245bra7vnedtxeu8.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、サーバーアドレスを確認すると、最初のボットを使用する準備が整います。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/qn/pm/uw/qnpmuwwvsqpzpnorleydc_llgxe.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはHabréに関する私の最初の出版物なので、この記事に関するコメントをもらい、さらに改善するだけです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
読んでくれてありがとう。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja468521/index.html">情報セキュリティを一般化する方法</a></li>
<li><a href="../ja468523/index.html">ロケットからロボットへ、そしてPythonはそれと何をしなければならないか。GeekBrains Alumni Story</a></li>
<li><a href="../ja468525/index.html">木のおもちゃ、パート1-1982-1985</a></li>
<li><a href="../ja468527/index.html">逆動力学問題法によるコントローラーの合成</a></li>
<li><a href="../ja468529/index.html">Goryraを使いこなす、またはGhidraでeBPFを逆コンパイルする</a></li>
<li><a href="../ja468533/index.html">Express 42によるDevOpsでのヒッチハイク</a></li>
<li><a href="../ja468535/index.html">ログは必要ありませんか？</a></li>
<li><a href="../ja468537/index.html">DevOpsの基本。プロジェクトへの最初からの参入</a></li>
<li><a href="../ja468541/index.html">ドラッグ＆＆-視覚障害者向けのコンポーネントをドロップしますか？冗談ですか？</a></li>
<li><a href="../ja468543/index.html">平日プログラム委員会フロントエンド会議。セルゲイ・ポポフとのインタビュー</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>