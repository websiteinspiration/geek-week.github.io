<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêï üëàüèª üèöÔ∏è What can result from weakening the level of transaction isolation in databases üéâ ü§± üåú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone. In touch Vladislav Rodin. Currently, I am the head of the High Load Architect course at OTUS, and I also teach courses on software arc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>What can result from weakening the level of transaction isolation in databases</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/501294/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello everyone. </font><font style="vertical-align: inherit;">In touch Vladislav Rodin. </font><font style="vertical-align: inherit;">Currently, I am the head of the High Load Architect course at OTUS, and I also teach courses on software architecture. </font></font><br>
</i><br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to teaching, as you can see, I have been writing for a blog copyright material OTUS Habr√© and today's article I want to coincide with the start of the course </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬´the PostgreSQL¬ª</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which right now is open the set.</font></font></i></b><br>
<br>
<img src="https://habrastorage.org/webt/wc/kz/hr/wckzhr5i0yusvkgrw6ibzhuu5rm.png"><br>
<hr><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">last time</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> you and I talked about that transaction in databases used for two purposes: to ensure fault tolerance and data access in a competitive environment. </font><font style="vertical-align: inherit;">To complete these tasks, a transaction must have ACID properties. </font><font style="vertical-align: inherit;">Today we will talk in detail about the letter </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I (isolation)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in this abbreviation.</font></font><br>
<a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Insulation</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Isolation solves the problem of accessing data in a competitive environment, effectively providing protection against race conditions. Ideally, isolation means serialization, that is, a property that ensures that the result of the execution of transactions in parallel is the same as if they were executed sequentially. The main problem of this property is that it is technically very difficult to provide and, as a result, has a significant impact on system performance. That is why isolation is often weakened, accepting the risks of some anomalies, which will be discussed below. The possibility of the occurrence of certain anomalies just the same characterizes the level of transaction isolation.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most famous anomalies are: dirty read, non-repeatable read, phantom read, but in fact there are 5 more: dirty write, cursor lost update, lost update, read skew, write skew.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dirty write</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The essence of the anomaly is that transactions can overwrite non-committed data. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/007/48f/64e/00748f64e3706c7ecd676eaabe4a0351.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This anomaly is dangerous not only because the data may conflict after committing both transactions (as in the picture), but also because atomicity is violated: because we allow overwriting non-locked data, it is not clear how to roll back one transaction without hitting the other . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The anomaly is treated quite simply: we hang up the write lock before recording starts, forbidding other transactions to change the record until the lock is released.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dirty read</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dirty read means reading uncommitted data. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/334/54a/0a2/33454a0a2a3312fa8f010e33110ec5f3.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Problems arise when, based on a sample, it is necessary to carry out some actions or make decisions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To fix the anomaly, you can hang a read lock, but it will hit performance hard. </font><font style="vertical-align: inherit;">It is much simpler to say that for a rollback transaction, the initial state of the data (before recording) must be stored in the system. </font><font style="vertical-align: inherit;">Why not read from there? </font><font style="vertical-align: inherit;">This is fairly inexpensive, so most databases remove dirty read by default.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lost update</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lost update means lost updates, and the translation accurately reflects the essence of the problem: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/7a7/185/a1b/7a7185a1b409181482510eec788255ae.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, the result of transaction T2 was canceled. </font><font style="vertical-align: inherit;">This situation is fixed by explicit or implicit write locks. </font><font style="vertical-align: inherit;">That is, we either simply update the record, and then an implicit lock occurs, or we perform </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select for update</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , causing a read and write lock to occur. </font><font style="vertical-align: inherit;">Please note that such an operation is quite dangerous: with our ‚Äúinnocent‚Äù reading, we block other readings. </font><font style="vertical-align: inherit;">Some databases offer a more secure </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select for share</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that allows you to read data, but does not allow them to change.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cursor lost update</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For finer control, bases can offer other tools, for example, a cursor. </font><font style="vertical-align: inherit;">A cursor is a structure that contains a set of lines and allows you to iterate over them. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">declare cursor_name for select_statement</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">The contents of the cursor are described by select. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why do we need a cursor? </font><font style="vertical-align: inherit;">The fact is that some databases offer locking on all records selected by select (read stability), or only on the record on which the cursor is currently located (cursor stability). </font><font style="vertical-align: inherit;">With cursor stability, a short lock is implemented, which allows us to reduce the number of locks if we iterate over a large data sample. </font><font style="vertical-align: inherit;">Therefore, the lost update anomaly is highlighted separately for the cursor.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Non-repeatable read</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Non-repeatable read is that during the execution of our transaction 2 consecutive reads of the same record will lead to different results, because another transaction intervened between these two reads, changed our data and was committed. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/3b8/ac7/be3/3b8ac7be3f4b29b3b20f8d4d72e52e35.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Why is this a problem at all? </font><font style="vertical-align: inherit;">Imagine that the purpose of transaction T2 in the picture is to select all products whose price is less than 150 cu </font><font style="vertical-align: inherit;">Someone else updated the price to $ 200 </font><font style="vertical-align: inherit;">Thus, the installed filter did not work. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These anomalies cease to occur when two-phase locks are added or when using the MVCC mechanism, which I would like to talk about separately.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Phantom read</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Phantom is reading data that has been added by another transaction. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/946/4dc/24e/9464dc24e22f13034a28f3b798d0aadc.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As an example, you can observe the wrong selection of the cheapest product when this anomaly occurs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Getting rid of phantom readings is already quite difficult. </font><font style="vertical-align: inherit;">Normal blocking is not enough, because we would not be able to block what is not yet available. </font><font style="vertical-align: inherit;">2PL systems use predictive locking, whereas MVCC systems use a transaction scheduler to cancel transactions that could be broken by an insert. </font><font style="vertical-align: inherit;">Both the first and second mechanisms are quite heavy.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read skew</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Read skew arises when we work with several tables, the content of which should change in a consistent manner. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suppose there are tables representing posts and their meta-information: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b9c/982/e3e/b9c982e3e51222ea919510ce857a2ab6.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One transaction reads from tables, another changes them: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/04e/df8/5a1/04edf85a1ceb8791f55ab6afa1c40b8f.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result of transaction T1, the post has title = Good and updated_by = T2, which is some inconsistency. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In fact, this is a non-repeatable read, but as part of several tables. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For correction, T1 can hang up locks on all lines that it will read, which will prevent T2 from changing information. </font><font style="vertical-align: inherit;">In the case of MVCC, transaction T2 will be canceled. </font><font style="vertical-align: inherit;">Protection against this anomaly can become important if we use cursors.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write skew</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This anomaly is also easier to explain using an example: suppose that in our system at least one doctor must be on duty, but both doctors decide to cancel their duty: The </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/23a/f78/439/23af784391a4f9adaeb322e5e509f933.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/8ec/2cb/d15/8ec2cbd1598ce5fa1e4d22607284795a.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
anomaly has led to the fact that none of the doctors will go on duty. Why did this happen? Because the transaction checked a condition that might be violated by another transaction, and because of isolation, we did not see this change. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is the same non-repeatable read. Alternatively, selects can hang locks on these records. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Write skew and read skew are combinations of previous anomalies. You can consider write skew, which is essentially a phantom read. Consider a table in which there are names of employees, their salary and the project on which they work:</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/ab4/61a/f1e/ab461af1ee01323db8377074875a044b.jpg" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/acd/126/e73/acd126e73fbe5310bfcb5bf0291e36c2.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, we get the following picture: each manager thought that his change would not lead to a budget, so they made personnel changes, which in total led to an overrun. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The cause of the problem is exactly the same as in phantom reading.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findings</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Weakening the level of transaction isolation in the database is a compromise between security and performance, the choice of this level should be approached based on the potential risks to the business in the event of any anomalies.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learn more about the course.</font></font><br>
</a><br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501282/index.html">Coronavirus side effect: robots will occupy our jobs even faster</a></li>
<li><a href="../en501284/index.html">8 questions about unmanned vehicles from Silicon Valley</a></li>
<li><a href="../en501286/index.html">Easygui python basics. Part 1</a></li>
<li><a href="../en501288/index.html">Do not rush to switch to EDI and EDS today: pitfalls you might not know about</a></li>
<li><a href="../en501292/index.html">Estimation of the cost of commercial ships. Arithmetic and common sense</a></li>
<li><a href="../en501296/index.html">How to make a career as a programmer without solving a business problem</a></li>
<li><a href="../en501298/index.html">Creating your own QGIS plugin repository</a></li>
<li><a href="../en501300/index.html">React and Atlaskit in Atlassian server and data center plugins</a></li>
<li><a href="../en501302/index.html">Please do not make noise</a></li>
<li><a href="../en501306/index.html">Building a pipeline to deliver Graal Native Image to end users</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>