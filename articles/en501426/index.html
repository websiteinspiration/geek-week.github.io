<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ò¢Ô∏è üßìüèΩ üôÖ Unison: setting up and automating two-way synchronization of directories on two servers üòï üë©üèΩ‚Äçüíº ü§ì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Getty Images / iStockphoto The
 
 problem of synchronizing directories on two servers with Linux family of operating systems on board can be solved ea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Unison: setting up and automating two-way synchronization of directories on two servers</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/501426/"><img src="https://habrastorage.org/webt/px/ch/pt/pxchptdqlhxiictuiik4ldo02ka.jpeg"><br>
<sup><font color="9999999"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getty Images / iStockphoto The</font></font></font></sup><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
problem of synchronizing directories on two servers with Linux family of operating systems on board can be solved easier if you use specialized tools. Let's see how this can be done with</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unison</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perhaps you have several servers, and you are faced with the task of synchronizing certain directories on these servers. For example, you need to synchronize the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory </font><font style="vertical-align: inherit;">on each of these servers so that some application has access to relevant information. Or maybe you just need to periodically back up data from one server to another in a synchronized fashion. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unison is similar to the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rsync</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> synchronization utility </font><font style="vertical-align: inherit;">, but unlike it, it supports two-way synchronization. That is, it allows you to synchronize two copies of files, updating each copy depending on the changes made.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When using Unison on servers, it is desirable to have installed packages like openssh-server and ssh, because for security reasons, synchronization is best done using the SSH protocol. </font><font style="vertical-align: inherit;">However, if you are confident in the security of your network (for example, the server can use SSH authentication without a password), you can not bother.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What else is needed to use Unison</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will show the whole process using two Ubuntu servers as an example (both 18.04). </font><font style="vertical-align: inherit;">You can install and use Unison with other distributions, but then you will need to change the installation command, otherwise Unison can be installed from standard repositories (of course, your user must have sudo rights). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will use these servers:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1 - 192.168.1.6</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server2 - 192.168.1.19</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to install Unison</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thing to take care of is installing Unison. </font><font style="vertical-align: inherit;">This should be done on both servers. </font><font style="vertical-align: inherit;">Go to both servers and enter the command:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install unison unison-all -y</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wait for the Unison installation to complete and continue.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to generate and copy an SSH key</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First, we generate the SSH key only for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">To do this, use the command:</font></font><br>
<br>
<pre><code class="bash hljs">ssh-keygen -t rsa</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When you are asked to enter a password, just press the ENTER key. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the key is generated, copy it to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> using the command:</font></font><br>
<br>
<pre><code class="bash hljs">ssh-copy-id 192.168.1.19</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once the key is copied, you can proceed directly to business.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to use Unison</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's create one test directory for each server for test purposes. </font><font style="vertical-align: inherit;">Command for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir -p /data1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir -p /data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, on both servers, you must change the name of the owner of the created directory, otherwise Unison will not be able to write anything there. </font><font style="vertical-align: inherit;">As the owner, specify the user who will run the Unison command:</font></font><br>
<br>
<pre><code class="bash hljs">sudo chown -R <span class="hljs-variable">$USER</span>.<span class="hljs-variable">$USER</span> /data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Do the same for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">sudo chown -R <span class="hljs-variable">$USER</span>.<span class="hljs-variable">$USER</span> /data1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Put some test files in </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="bash hljs">touch /data1/{test1,test2,test3}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We synchronize our directories with the following command (by running it on </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br>
<br>
<pre><code class="bash hljs">unison /data1 ssh://192.168.1.19//data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since you are trying to synchronize these root directories for the first time, you will receive a warning that synchronization may take some time (but in our case this will not happen, since we added only three test files of the minimum volume to the directory). </font><font style="vertical-align: inherit;">If it were a backup on production, the first launch could really take some time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So drink tea next time. </font><font style="vertical-align: inherit;">In the meantime, press Enter to start the process. </font><font style="vertical-align: inherit;">After you do this, you will be asked to confirm the synchronization of each file. </font><font style="vertical-align: inherit;">When finished, enter 'y' to continue. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Since we only synchronize three test files, this will happen very quickly and will return you to the bash shell. </font><font style="vertical-align: inherit;">To make sure the files are synchronized, go to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and enter the command:</font></font><br>
<br>
<pre><code class="bash hljs">ls /data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Further, the system will report that </font><font style="vertical-align: inherit;">our test1, test2 and test3 files are </font><font style="vertical-align: inherit;">in the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> directory </font><font style="vertical-align: inherit;">: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/pu/xv/bi/puxvbivby-poqpuch07emsz7kui.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We succeeded: Unison synchronized both directories.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to start Unison without the need for user interaction</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think you do not want to constantly confirm the synchronization of each directory file every time you start Unison. </font><font style="vertical-align: inherit;">This is especially annoying when you synchronize directories with a large number of files. </font><font style="vertical-align: inherit;">Therefore, automation is needed. </font><font style="vertical-align: inherit;">Go to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and enter the command:</font></font><br>
<br>
<pre><code class="bash hljs">nano ~/.unison/default.prf</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When the configuration file opens for editing, add two lines to it:</font></font><br>
<br>
<pre><code class="bash hljs">auto=<span class="hljs-literal">true</span>
batch=<span class="hljs-literal">true</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then save and close the file. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now Unison will not bother you with trifles. </font><font style="vertical-align: inherit;">But that's not all.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to create a task for Cron Scheduler</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think you would hardly want to start synchronization manually, because you can make a mistake somewhere or, for example, not take into account the change in the directory structure on the servers. </font><font style="vertical-align: inherit;">To configure automation, you need to create a cron job for </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">server1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's create a script to start synchronization:</font></font><br>
<br>
<pre><code class="bash hljs">sudo nano /usr/<span class="hljs-built_in">local</span>/bin/unisonsync</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The following should be added to this file: </font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#!/bin/bash/</span>
unison /data1 ssh://192.168.1.19//data2</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Next, you need to give the script the right to execute:</font></font><br>
<br>
<pre><code class="bash hljs">sudo chmod ugo+x /usr/<span class="hljs-built_in">local</span>/bin/unisonsync</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Create a job for Cron with the command:</font></font><br>
<br>
<pre><code class="bash hljs">crontab -e</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that type:</font></font><br>
<br>
<pre><code class="bash hljs">*/5 * * * * /usr/<span class="hljs-built_in">local</span>/bin/unisonsync &amp;&gt; /dev/null</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now the synchronization will automatically start every 5 minutes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have shown that Unison makes it easy to synchronize directories on two Linux servers. </font><font style="vertical-align: inherit;">You can verify this yourself by adding files to the corresponding test directories </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ data2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on both servers. </font><font style="vertical-align: inherit;">After making sure that the synchronization works, you can use it in combat mode on production servers.</font></font><br>
<br>
<hr><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As an advertisement</font></font></h4><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VDSina is</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> always happy to offer reliable servers for any tasks. </font><font style="vertical-align: inherit;">You have access to a huge selection of operating systems for automatic installation, it is possible to install any OS from your own </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">image</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , as well as use a high-speed </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">local network</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> between servers within the same location.</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/9fa/cf4/a34/9facf4a348ef01048b4eb5e16ae66daa.png"></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en501414/index.html">Configuring Debian, Nginx, and Gunicorn for a Django Project</a></li>
<li><a href="../en501416/index.html">A bit about WebRTC: what to use and the case from practice</a></li>
<li><a href="../en501418/index.html">Week 4 Marathon: Motivation</a></li>
<li><a href="../en501420/index.html">Online Mitapas and YouTube Shows: JUG Ru Group Stream Week</a></li>
<li><a href="../en501424/index.html">From life with Kubernetes: How we removed DBMS (and not only) from review environments to static</a></li>
<li><a href="../en501430/index.html">Great Guide to Website Content Design and Planning</a></li>
<li><a href="../en501432/index.html">Two alternatives to JDBC</a></li>
<li><a href="../en501434/index.html">Security Week 20: hacking a computer through Thunderbolt</a></li>
<li><a href="../en501436/index.html">Number recognition algorithm on the image with a low probability of the second kind of error</a></li>
<li><a href="../en501438/index.html">How 3D game rendering works: lighting and shadows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>