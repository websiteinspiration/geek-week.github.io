<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôèüèæ ü§úüèø üóëÔ∏è Homemade Autopilot on a Single Board Computer (SBC) Tinker board and Arduino DUE üßÄ ‚òùüèº üôè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The idea of ‚Äã‚Äãbuilding an autopilot came about 2 years ago. I wanted to create a fully autonomous apparatus capable of getting from point A to point B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Homemade Autopilot on a Single Board Computer (SBC) Tinker board and Arduino DUE</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/490572/"><img src="https://habrastorage.org/getpro/habr/post_images/61d/7fa/23b/61d7fa23bfc1c4a76018dbf13eb0adb6.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea of ‚Äã‚Äãbuilding an autopilot came about 2 years ago. </font><font style="vertical-align: inherit;">I wanted to create a fully autonomous apparatus capable of getting from point A to point B with the possibility of avoiding collisions and flying around obstacles, able to overcome jamming zones or the absence of a satellite signal. </font><font style="vertical-align: inherit;">I also wanted to have a convenient and simple control with the mouse as it is implemented in games (strategies) controlling the movement of the aircraft with the help of points. </font><font style="vertical-align: inherit;">I had to start everything from scratch, like this article, so if there are errors, write about it in the comments. </font><font style="vertical-align: inherit;">I'll start in order.</font></font><br>
<br>
<a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hardware</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, I did not know which iron is better to use for this project, but in the end I came to the conclusion that the best option would be a bunch of microcontroller (MK) + single-board computer. Where MK solves the problem of stabilization of an aircraft (LA), its movement at a given course and altitude, and a single-board computer solves the problem of navigation and movement along a route. Since the plan was to avoid collisions, the computer had to be powerful enough to process information from obstacle detection sensors, compact and not too expensive at that time TinkerBoard was the most suitable for this description, then Raspbery was 3B + and was much inferior in characteristics. As MK, I wanted to have an arduino compatible controller because arduino had a huge base of ready-made sketches and therefore the choice fell on DUE 84 MHz, 32bit ARM Cortex-M3 becausehe was the most powerful and had to compensate for the directness of my hands)).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Initially, I planned to use the MPU 9250 with a Majevik filter as orientation sensors, and its results were excellent. The main advantage of this option was that all the calculations, including the calibration of the sensors (accelerometer, gyroscope and magnetometer), were on the MK. But there was a problem, the filter poorly compensated for the linear acceleration, which constantly occurs during shocks or a sharp change of course. This is expressed in the readings of pitch and roll, at the moment of acceleration they begin to float away, and passing through the proportionally differential (PD) regulator and especially the differential part, the floating created problems. Therefore, I had to use a sensor with an already implemented BNO 055 filter.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unlike the MPU 9250, the BNO has onboard the integrated Cortex M0 MK, which immediately calculates the orientation in Euler angles, the absolute orientation quaternine and calculates linear acceleration, although this sensor also has several disadvantages. The main problem of this sensor is auto-calibration, or rather, that it cannot be turned off, it is such a ‚Äúfit‚Äù of this sensor and this calibration has an unpleasant property to disappear, sometimes absolutely suddenly even just being in one place without movement. This is mainly reflected in the yaw that is attached to the magnetometer in this sensor and should show the direction to the magnetic north pole (course), but sometimes it shows 100 degrees in strona, and then after calibrating it can go back))). In other matters, the course problem can still be solved using synchronization with GPS. Otherwise, the sensor works fine,he always determines the pitch and roll correctly, and linear accelerations do not greatly affect his work, unless, of course, the acceleration does not exceed 2G, because this threshold is used to measure the gravity vector and compensate for the drift of gyroscopes.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The rest of the iron set is as follows: GPS Ublox Neo M8N with USB output, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BMP 280 barometer, HSCR 04 sonar for receiving data on ground availability and more accurate vertical speed, EEPROM 24c16 for storing calibration data and PID settings, Neoway M509E GSM module for sending messages about the coordinates of the aircraft in case of an accident. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The functional diagram is shown in Figure 1: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/7f7/9e3/9df/7f79e39df3579c4508abd884aba32236.png" alt="image"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 1 - Functional diagram of the Autopilot</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Software</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For software development, I use QT along with the QT Creator IDE. he is most familiar to me, and also thanks to cross-platform functionality, I can run my programs on both a single-board PC with Debian and a desktop with Windows, which is very convenient. For the development of microcontroller software, the Arduino IDE is used. For clarity, I will try to present all sections in Figure 2. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/6fa/dcb/48d/6fadcb48dd175a45e40ca07bf2870961.png" alt="image"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 2. - Architecture of the AP (BNO 080 added for the future).</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
1) Graphical control interface - is a satellite map with the help of which the aircraft is controlled. The satellite image display program itself is not mine, it was stolen by me </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (its author also tried to do something similar).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can control the aircraft using dots (markers) or WADS buttons. To control points, it is necessary to lay the flight route with green markers, they are put with the mouse (RMB), and click load route, or use the (red) instant move marker (LMB) and then the aircraft from the current position will fly to this point, for its operation it is necessary to set checkbox in the "Manual" checkbox from accidental clicks.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All marker parameters are entered in the appropriate fields on the form, you can remove the markers by double-clicking the middle mouse button, while they will still remain in the aircraft‚Äôs memory, to delete the memory, use the delete route button. Upon reaching the point, as in the strategies of the aircraft, it will revolve around it. Button control WADS directly controls the steering wheels using PD controllers. When each button is pressed, a value is input to the input of the controller, for example, when S is pressed, pitch 30 and when released is 0. When W -30 is pressed, etc. WADS is turned on using checkboxes: ‚Äúmanual‚Äù, ‚Äúbuttons‚Äù. This mode helps to check the functionality of all the rudders before starting. The graphical interface runs on the laptop, control commands from the graphical interface using the TCP socket are transferred to the kernel. The graphical control interface is shown in Figure 3:</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/687/2ad/ff3/6872adff36543236e64e5f75af0842cd.jpg" alt="image"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Figure 3 - Graphical management interface.</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) The core of autopilot is that part of the software that is calculated on a TinkerBoard single board computer. </font><font style="vertical-align: inherit;">The kernel is responsible for navigation and movement along the route. </font><font style="vertical-align: inherit;">To do this, a GPS sensor is connected to the computer. </font><font style="vertical-align: inherit;">Using it, you can get the current position of the aircraft (latitude and longitude) and compare this position with what is in the flight route. </font><font style="vertical-align: inherit;">As a result of this operation, the azimuth to the target is obtained, which is sent to the microcontroller along with the rest of the flight parameters. </font><font style="vertical-align: inherit;">In the future, the kernel can be equipped with its IMU sensor to implement the ANN. </font><font style="vertical-align: inherit;">For example, you can use BNO 080 to integrate, accelerate and get speed, and by integrating speed, get the distance. </font><font style="vertical-align: inherit;">The distance received from the ANN will need to be translated into the GPS coordinate system (latitude and longitude) for its use in calculating the azimuth.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Such ANN can be used in conjunction with a GPS sensor in case of temporary loss of communication with the satellite so that the aircraft does not miss a ‚Äúturn‚Äù to a point. At the time of operation from GPS, the ANN will be constantly adjusted by its readings and fill in the gaps between the periods of GPS sensor update. In the same way, the machine vision algorithm or SLAM should be adjusted by changing the height of the point and creating biases of the calculated azimuth. After the route calculation is completed, the kernel sends UART data: azimuth, altitude, angle of attack, type of point, and also whether rotation around this point is necessary.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) The microcontroller performs the core commands, the main task of the MK is to follow the given course at a given height. For this, the MKU is equipped with an IMU BNO 055 sensor, a bmp 280 barometer and a sonar. For movement along the course, the azimuth obtained from the core is used, it is compared with the current rate and the resulting mismatch is transmitted to the PD controllers for yaw and roll. Pitch control is carried out by 2 PD controllers: the 1st determines the mismatch of the current and predetermined heights, which is fed to the input of the 2nd controller, while the output of the height controller is limited by the current angle of attack to control its set. If in the graphical interface the type of point is selected for takeoff or landing, a sonar is used to determine the height. His testimony is combined with the data of the barometer,to most accurately determine the distance to the ground and the vertical speed. In addition to the main functions, the MK also collects telemetry about the operation of IMU sensors, the current direction and altitude, transfers them to the kernel, where these data are supplemented by data from GPS and enter the graphical interface.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conclusion </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the moment, the autopilot is still at the flight test stage and is not fully configured. </font><font style="vertical-align: inherit;">However, I spent only two starts and have not yet picked up the coefficients for the regulators. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, PD regulators seem unstable to me and I want to replace them with something more reliable, especially since they are already outdated. </font><font style="vertical-align: inherit;">It is also necessary to replace calculations with Euler angles with calculations in quaternions, because </font><font style="vertical-align: inherit;">the latter behave more stably when turning the aircraft at angles greater than 120 degrees and flying during the wind.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A more detailed shot of avionics</font></font></b>
                        <div class="spoiler_text"> <br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/d4d/ff2/ca1/d4dff2ca14a27c848142db0092ba0c9b.jpg" alt="image"><br>
<br>
</div>
                    </div><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Link to the source code of the poison (with libraries) </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github here only the source but newer</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en490558/index.html">Evangelists vs. Werewolves</a></li>
<li><a href="../en490560/index.html">Hackathon from scratch in two weeks</a></li>
<li><a href="../en490566/index.html">Software deployment environments</a></li>
<li><a href="../en490568/index.html">Plastic Shot: Atypical Ammo</a></li>
<li><a href="../en490570/index.html">Go: Should I use a pointer instead of a copy of my structure?</a></li>
<li><a href="../en490574/index.html">What do recursion, landing pages and content marketing have in common: says the founder of the agency Embacy</a></li>
<li><a href="../en490576/index.html">Ultrasonic bath. Part 1</a></li>
<li><a href="../en490578/index.html">The digest of interesting materials for the mobile developer # 335 (February 24 - March 1)</a></li>
<li><a href="../en490584/index.html">Infineon has implemented cross-signing certificates in its cryptographic chips</a></li>
<li><a href="../en490586/index.html">What is Spring Framework? From Dependency Injection to Web MVC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>