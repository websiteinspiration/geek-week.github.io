<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙄 👰🏿 🧓🏾 使用XCTestplan和Xcode 11的自动iOS屏幕截图 👩🏾‍🤝‍👨🏿 🧑🏼 📕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Raiffeisenbank中有几个移动应用程序可以在各种设备和操作系统上运行，因此我们尝试使测试中的常规过程自动化。这篇文章对我们来说似乎很有用，因此我们决定将其翻译。照片来源：unsplash.com 如果您的应用程序是多语言的，通用的并且针对不同的设备设计的，那么您可以花费大量时间为每种配置创...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>使用XCTestplan和Xcode 11的自动iOS屏幕截图</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/raiffeisenbank/blog/502626/"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raiffeisenbank中有几个移动应用程序可以在各种设备和操作系统上运行，因此我们尝试使测试中的常规过程自动化。这篇文章对我们来说似乎很有用，因此我们决定将其翻译。</font></font></i><font style="vertical-align: inherit;"><font color="grey"><font style="vertical-align: inherit;">照片来源：unsplash.com</font></font><font style="vertical-align: inherit;"> 
如果您的应用程序是多语言的，通用的并且针对不同的设备设计的，那么您可以花费大量时间为每种配置创建屏幕截图。假设您有四种语言，支持iPad和iPhone，并且每个屏幕需要保存4个屏幕-这是32个屏幕截图。该过程必须是自动化的，以免在每次更新接口时浪费时间。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/webt/zh/ny/9i/zhny9ihqeamema_yinthkbx9cgg.png"></a><br>
<font color="grey"><font style="vertical-align: inherit;"></font></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Xcode 11中出现的XCTestPlan工具允许我们为测试创建几种配置。</font><font style="vertical-align: inherit;">如今，配置最常用于确定测试的运行方式，包括为应用程序选择语言。</font><font style="vertical-align: inherit;">在本文中，您将学习如何使用XCTestPlan自动执行屏幕截图。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">启动XCTestplan</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们设置一个单独的UITests目标来自动创建屏幕截图，如果您不打算使用这些配置运行主要测试，则该功能特别有用。要创建一个新目标，请选择</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File-&gt; New-&gt; Target</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并创建一个新的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UI Testing Bundle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。之后，您需要</font><font style="vertical-align: inherit;">向该目标</font><font style="vertical-align: inherit;">添加一个新的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XCTestplan</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。为此，您可以使用菜单</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">产品-&gt;测试计划-&gt;新测试计划</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，或在</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方案编辑器中</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选择</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转换以使用测试计划</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。如果通过菜单执行此操作，则需要确保新目标位于“测试”标签上。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于我们只想配置语言设置，因此我们可以保持“共享设置”不变，而只需为我们支持的每种语言添加一个新配置。</font><font style="vertical-align: inherit;">支持英语，德语和法语的应用程序的设置如下所示：</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e73/6c7/f4b/e736c7f4b030915e123f137711f1a73f.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是XCTestplan的所有必需的设置和启动。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">屏幕截图自动化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
创建屏幕截图的UI测试与常规测试几乎没有什么不同，只是它们会创建附件。您还可以添加XCTAssert检查，以便在出现问题时测试失败。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另一个要点：如果</font><font style="vertical-align: inherit;">在截屏时您的UI尚未准备好</font><font style="vertical-align: inherit;">（</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">键盘显示</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> /隐藏，动画完成），则</font><font style="vertical-align: inherit;">可能需要</font><b><font style="vertical-align: inherit;">waitForExpectations</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下面是所有辅助方法的示例：</font></font><br>
<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testScreenshots</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">let</span> app = <span class="hljs-type">XCUIApplication</span>()
    <span class="hljs-keyword">let</span> searchButton = app.buttons[<span class="hljs-string">"search"</span>]<font></font>
    searchButton.tap()<font></font>
    <font></font>
    <span class="hljs-keyword">let</span> keyboard = app.keyboards.firstMatch<font></font>
    waitForExistence(of: keyboard)<font></font>
    app.typeText(<span class="hljs-string">"Cupertino"</span>)<font></font>
    add(takePromoShot(name: <span class="hljs-string">"Search"</span>))<font></font>
    <font></font>
    <span class="hljs-keyword">let</span> firstResult = app.cells.firstMatch<font></font>
    firstResult.tap()<font></font>
    waitForDisappearance(of: keyboard)<font></font>
    add(takePromoShot(name: <span class="hljs-string">"Result"</span>))<font></font>
}<font></font>
</code></pre><br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">waitForExistence</span><span class="hljs-params">(of element: XCUIElement)</span></span> {
    <span class="hljs-keyword">let</span> predicate = <span class="hljs-type">NSPredicate</span>(format: <span class="hljs-string">"exists == TRUE"</span>)<font></font>
    expectation(<span class="hljs-keyword">for</span>: predicate, evaluatedWith: element, handler: <span class="hljs-literal">nil</span>)<font></font>
    waitForExpectations(timeout: <span class="hljs-number">5.0</span>, handler: <span class="hljs-literal">nil</span>)<font></font>
}<font></font>
</code></pre><br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">waitForDisappearance</span><span class="hljs-params">(of element: XCUIElement)</span></span> {
    <span class="hljs-keyword">let</span> predicate = <span class="hljs-type">NSPredicate</span>(format: <span class="hljs-string">"exists == FALSE"</span>)<font></font>
    expectation(<span class="hljs-keyword">for</span>: predicate, evaluatedWith: element, handler: <span class="hljs-literal">nil</span>)<font></font>
    waitForExpectations(timeout: <span class="hljs-number">5.0</span>, handler: <span class="hljs-literal">nil</span>)<font></font>
}<font></font>
</code></pre><br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">takePromoShot</span><span class="hljs-params">(name: String)</span></span> -&gt; <span class="hljs-type">XCTAttachment</span> {
    <span class="hljs-keyword">let</span> lang = <span class="hljs-type">Locale</span>.preferredLanguages[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">let</span> screenshot = <span class="hljs-type">XCUIScreen</span>.main.screenshot()
    <span class="hljs-keyword">let</span> attachment = <span class="hljs-type">XCTAttachment</span>(screenshot: screenshot)<font></font>
    attachment.lifetime = .keepAlways<font></font>
    attachment.name = <span class="hljs-string">"\(lang)-\(name)"</span>
    <span class="hljs-keyword">return</span> attachment<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注意最新功能。</font><font style="vertical-align: inherit;">它获取快照的名称，添加语言标识符，获取屏幕快照，并返回带有</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.keepAlways</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数值的</font><b><font style="vertical-align: inherit;">XCTAttachment</font></b><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这很重要，因为默认情况下，如果测试成功，则会删除测试过程中截取的屏幕截图。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lifiteme是</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一个重要的参数，因为它可确保在测试完成后保存屏幕截图。</font><font style="vertical-align: inherit;">在UI测试期间，会不断拍摄屏幕截图。</font><font style="vertical-align: inherit;">当您需要确定测试失败的原因和时间时，它们非常有用。</font><font style="vertical-align: inherit;">但默认情况下，如果测试成功，屏幕截图将被删除。</font><font style="vertical-align: inherit;">因此，当</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">testScreenshots（）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功时，您将只有必要的屏幕截图。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">习惯状态栏</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大多数开发人员更喜欢在屏幕截图上看到带有正确时间的状态栏，完整的网络信号和其他详细信息。</font><font style="vertical-align: inherit;">在Xcode 11中，这变得更加容易。</font><font style="vertical-align: inherit;">有一个实用程序</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xcrun simctl status_bar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它允许您指定这些设置。</font><font style="vertical-align: inherit;">可以将其添加为</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构建阶段</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<br>
<pre><code class="bash hljs">xcrun simctl status_bar booted override --time 9:41 --operatorName <span class="hljs-string">' '</span> --cellularMode active --cellularBar 4 --wifiBars 3 --batteryState charged</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
执行此命令后，状态栏的外观将与Apple的营销材料相同。</font><font style="vertical-align: inherit;">不幸的是，团队不会在真实的设备上工作，只能在模拟器上工作。</font><font style="vertical-align: inherit;">还应注意，在开始测试以收集屏幕截图之前，您使用的模拟器必须正在运行。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">收集结果截图</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在我们可以运行UI测试了。</font><font style="vertical-align: inherit;">当它们通过时，我们将</font><font style="vertical-align: inherit;">在Xcode的</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Report Navigator</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中</font><font style="vertical-align: inherit;">看到结果</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">也将有包含按语言配置分组的过程的测试。</font><font style="vertical-align: inherit;">带有附件的过程都用回形针标记。</font><font style="vertical-align: inherit;">图像本身可以在</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">QuickLook中</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">打开</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/4c8/412/fce/4c8412fce1f89e4da3cc3ceddc79d858.png" alt="图片"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
单独收集所有生成的图片可能非常耗时，尤其是在您的应用程序支持多种语言的情况下。</font><font style="vertical-align: inherit;">不幸的是，这些附件在测试结果中没有显示为png或jpg（Xcode 11中的另一个更改）。</font><font style="vertical-align: inherit;">但是您可以解析测试结果，并找到指向实际附件的JSON并收集它们。</font><font style="vertical-align: inherit;">可以</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">使用xcparse实用程序</font></a><font style="vertical-align: inherit;">来完成</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它使用Homebrew安装并通过以下命令启动：</font></font><br>
<br>
<pre><code class="bash hljs">xcparse screenshots /path/to/Test.xcresult /path/to/outputDirectory</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
其他标志将按设备，操作系统或配置对文件进行分组。</font><font style="vertical-align: inherit;">我们文件的名称包含语言标识符，因此您只需按名称对它们进行排序。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
所描述的方法已经使我们节省了足够的时间，特别是在需要以新分辨率支持设备或接口被显着更新的情况下。</font><font style="vertical-align: inherit;">在WWDC20上，我希望看到设备的选择是XCTestplan配置的一部分，但是现在，您必须手动选择或使用脚本来收集AppStore中的必要屏幕截图。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN502604/index.html">Patrik Patrick的TLS简介（第1部分）</a></li>
<li><a href="../zh-CN502608/index.html">我们如何在SaaS服务中启动应用程序市场</a></li>
<li><a href="../zh-CN502614/index.html">Kubernetes最佳实践 设置查询和资源限制</a></li>
<li><a href="../zh-CN502620/index.html">金钱会计</a></li>
<li><a href="../zh-CN502624/index.html">他们如何在Facebook上工作？公司的价值观和雇用</a></li>
<li><a href="../zh-CN502628/index.html">语义网神话</a></li>
<li><a href="../zh-CN502630/index.html">您几年前删除的邮件仍可以存储在智能手机上</a></li>
<li><a href="../zh-CN502634/index.html">远程医疗。三个技术创业公司。产品是唯一的，但命运不同</a></li>
<li><a href="../zh-CN502636/index.html">商业和计算机朋克：混合，维持，使用</a></li>
<li><a href="../zh-CN502638/index.html">2020年如何在Instagram上开发博客：Sasha Mitroshina案分析</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>