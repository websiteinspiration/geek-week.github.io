<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòä üòú ‚¨ÜÔ∏è Options fonctionnelles sur les st√©ro√Ødes üòï üë©üèº‚Äçüç≥ üìÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Je vous pr√©sente la traduction de l'article Options fonctionnelles sur les st√©ro√Ødes par M√°rk S√°gi-Kaz√°r . 
 
 
 
 Les options fonction...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Options fonctionnelles sur les st√©ro√Ødes</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489296/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bonjour, Habr! </font><font style="vertical-align: inherit;">Je vous pr√©sente la traduction de l'article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Options fonctionnelles sur les st√©ro√Ødes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> par </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">M√°rk S√°gi-Kaz√°r</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ne/tg/q_/netgq_6sygojlguqfqahr_k_hh0.jpeg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les options fonctionnelles sont le paradigme de Go pour des API propres et extensibles. </font><font style="vertical-align: inherit;">Elle est popularis√©e par </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dave Cheney</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rob Pike</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ce message traite des pratiques qui ont √©t√© autour du mod√®le depuis sa premi√®re introduction. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les options fonctionnelles sont apparues comme un moyen de cr√©er de bonnes API propres avec une configuration qui inclut des param√®tres facultatifs. </font><font style="vertical-align: inherit;">Il existe de nombreuses fa√ßons √©videntes de le faire (constructeur, structure de configuration, param√®tres, etc.), mais lorsque vous devez passer des dizaines d'options, elles sont mal lues et ne donnent pas de bonnes API comme options fonctionnelles.</font></font><a name="habracut"></a><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introduction - quelles sont les options fonctionnelles?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Habituellement, lorsque vous cr√©ez un ¬´objet¬ª, vous appelez le constructeur avec les arguments n√©cessaires:</font></font><br>
<br>
<pre><code class="go hljs">obj := New(arg1, arg2)</code></pre><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Ignorons le fait qu'il n'y a pas de constructeurs traditionnels dans Go.)</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Les options fonctionnelles vous permettent d'√©tendre l'API avec des param√®tres suppl√©mentaires, transformant la ligne ci-dessus en ce qui suit:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// I can still do this...</span><font></font>
obj := New(arg1, arg2)<font></font>
<font></font>
<span class="hljs-comment">// ...but this works too</span>
obj := New(arg1, arg2, myOption1, myOption2)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les options fonctionnelles sont essentiellement des arguments d'une fonction variable qui prend comme param√®tres un type de configuration composite ou interm√©diaire. </font><font style="vertical-align: inherit;">En raison de sa nature variable, il est parfaitement acceptable d'appeler le constructeur sans aucune option, en le gardant propre, m√™me si vous souhaitez utiliser les valeurs par d√©faut. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pour mieux illustrer le mod√®le, regardons un exemple r√©aliste (sans options fonctionnelles):</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> {<font></font>
    addr <span class="hljs-keyword">string</span><font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// NewServer initializes a new Server listening on addr.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">(addr <span class="hljs-keyword">string</span>)</span> *<span class="hljs-title">Server</span></span> {
    <span class="hljs-keyword">return</span> &amp;Server {<font></font>
        addr: addr,<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir ajout√© l'option timeout, le code ressemble √† ceci:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> {<font></font>
    addr <span class="hljs-keyword">string</span><font></font>
<font></font>
    <span class="hljs-comment">// default: no timeout</span><font></font>
    timeout time.Duration<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// Timeout configures a maximum length of idle connection in Server.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Timeout</span><span class="hljs-params">(timeout time.Duration)</span> <span class="hljs-title">func</span><span class="hljs-params">(*Server)</span></span> {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Server)</span></span> {<font></font>
        s.timeout = timeout<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// NewServer initializes a new Server listening on addr with optional configuration.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">(addr <span class="hljs-keyword">string</span>, opts ...<span class="hljs-keyword">func</span>(*Server)</span>) *<span class="hljs-title">Server</span></span> {<font></font>
    server := &amp;Server {<font></font>
        addr: addr,<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">// apply the list of options to Server</span>
    <span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts {<font></font>
        opt(server)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> server<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'API r√©sultante est facile √† utiliser et facile √† lire:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// no optional paramters, use defaults</span>
server := NewServer(<span class="hljs-string">":8080"</span>)<font></font>
<font></font>
<span class="hljs-comment">// configure a timeout in addition to the address</span>
server := NewServer(<span class="hljs-string">":8080"</span>, Timeout(<span class="hljs-number">10</span> * time.Second))<font></font>
<font></font>
<span class="hljs-comment">// configure a timeout and TLS in addition to the address</span>
server := NewServer(<span class="hljs-string">":8080"</span>, Timeout(<span class="hljs-number">10</span> * time.Second), TLS(&amp;TLSConfig{}))</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√Ä titre de comparaison, voici √† quoi ressemble l'initialisation en utilisant le constructeur et en utilisant la structure de configuration de config:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// constructor variants</span>
server := NewServer(<span class="hljs-string">":8080"</span>)<font></font>
server := NewServerWithTimeout(<span class="hljs-string">":8080"</span>, <span class="hljs-number">10</span> * time.Second)<font></font>
server := NewServerWithTimeoutAndTLS(<span class="hljs-string">":8080"</span>, <span class="hljs-number">10</span> * time.Second, &amp;TLSConfig{})<font></font>
<font></font>
<font></font>
<span class="hljs-comment">// config struct</span>
server := NewServer(<span class="hljs-string">":8080"</span>, Config{})<font></font>
server := NewServer(<span class="hljs-string">":8080"</span>, Config{ Timeout: <span class="hljs-number">10</span> * time.Second })<font></font>
server := NewServer(<span class="hljs-string">":8080"</span>, Config{ Timeout: <span class="hljs-number">10</span> * time.Second, TLS: &amp;TLSConfig{} })</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'avantage d'utiliser des options fonctionnelles par rapport au constructeur est probablement √©vident: elles sont plus faciles √† maintenir et √† lire / √©crire. </font><font style="vertical-align: inherit;">Les param√®tres fonctionnels d√©passent √©galement la structure de configuration lorsque les param√®tres ne sont pas transmis au constructeur. </font><font style="vertical-align: inherit;">Dans les sections suivantes, je montrerai encore plus d'exemples o√π la structure de configuration peut ne pas r√©pondre aux attentes. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lisez l'historique complet des options fonctionnelles en cliquant sur les liens dans l'introduction. </font><font style="vertical-align: inherit;">(Note du traducteur - un blog avec un article original de Dave Cheney n'est pas toujours disponible en Russie et vous devrez peut-√™tre vous connecter via VPN pour le consulter. De plus, les informations de l'article sont disponibles dans la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vid√©o de son rapport sur dotGo 2014</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pratiques d'options fonctionnelles</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les options fonctionnelles elles-m√™mes ne sont rien de plus que des fonctions pass√©es au constructeur. </font><font style="vertical-align: inherit;">La facilit√© d'utilisation de fonctions simples donne de la flexibilit√© et a un grand potentiel. </font><font style="vertical-align: inherit;">Par cons√©quent, il n'est pas surprenant qu'au fil des ans, de nombreuses pratiques soient apparues autour du mod√®le. </font><font style="vertical-align: inherit;">Ci-dessous, je fournirai une liste de ce que je consid√®re comme les pratiques les plus populaires et les plus utiles. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Envoyez-moi un e-mail si vous pensez qu'il manque quelque chose.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type d'options</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La premi√®re chose que vous pouvez faire lors de l'application du mod√®le d'options fonctionnelles consiste √† d√©terminer le type de la fonction facultative:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// Option configures a Server.</span>
<span class="hljs-keyword">type</span> Option <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Server)</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que cela ne semble pas √™tre une grande am√©lioration, le code devient plus lisible en utilisant un nom de type au lieu de d√©finir une fonction:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Timeout</span><span class="hljs-params">(timeout time.Duration)</span> <span class="hljs-title">func</span><span class="hljs-params">(*Server)</span></span> { <span class="hljs-comment">/*...*/</span> }<font></font>
<font></font>
<span class="hljs-comment">// reads: a new server accepts an address</span>
<span class="hljs-comment">//      and a set of functions that accepts the server itself</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">(addr <span class="hljs-keyword">string</span>, opts ...<span class="hljs-keyword">func</span>(s *Server)</span>) *<span class="hljs-title">Server</span></span><font></font>
<font></font>
<span class="hljs-comment">// VS</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Timeout</span><span class="hljs-params">(timeout time.Duration)</span> <span class="hljs-title">Option</span></span> { <span class="hljs-comment">/*...*/</span> }<font></font>
<font></font>
<span class="hljs-comment">// reads: a new server accepts an address and a set of options</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">(addr <span class="hljs-keyword">string</span>, opts ...Option)</span> *<span class="hljs-title">Server</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre avantage d'avoir un type d'option est que Godoc place les fonctions d'option sous le type:</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ng/7j/cw/ng7jcwf-ayhf9tfblay4-dl7_ck.png" alt="image"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liste des types d'options</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En r√®gle g√©n√©rale, les param√®tres fonctionnels sont utilis√©s pour cr√©er une seule instance de quelque chose, mais ce n'est pas toujours le cas. </font><font style="vertical-align: inherit;">La r√©utilisation de la liste de param√®tres par d√©faut lors de la cr√©ation de plusieurs instances n'est pas rare non plus:</font></font><br>
<br>
<pre><code class="go hljs">defaultOptions := []Option{Timeout(<span class="hljs-number">5</span> * time.Second)}<font></font>
<font></font>
server1 := NewServer(<span class="hljs-string">":8080"</span>, <span class="hljs-built_in">append</span>(defaultOptions, MaxConnections(<span class="hljs-number">10</span>))...)<font></font>
<font></font>
server2 := NewServer(<span class="hljs-string">":8080"</span>, <span class="hljs-built_in">append</span>(defaultOptions, RateLimit(<span class="hljs-number">10</span>, time.Minute))...)<font></font>
<font></font>
server3 := NewServer(<span class="hljs-string">":8080"</span>, <span class="hljs-built_in">append</span>(defaultOptions, Timeout(<span class="hljs-number">10</span> * time.Second))...)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce code n'est pas tr√®s lisible, d'autant plus que l'int√©r√™t d'utiliser des options fonctionnelles est de cr√©er des API conviviales. </font><font style="vertical-align: inherit;">Heureusement, il existe un moyen de simplifier cela. </font><font style="vertical-align: inherit;">Nous avons juste besoin de couper l'option [] directement avec l'option:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// Options turns a list of Option instances into an Option.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Options</span><span class="hljs-params">(opts ...Option)</span> <span class="hljs-title">Option</span></span> {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Server)</span></span> {
        <span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts {<font></font>
            opt(s)<font></font>
        }<font></font>
    }<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir remplac√© la tranche par la fonction Options, le code ci-dessus devient:</font></font><br>
<br>
<pre><code class="go hljs">defaultOptions := Options(Timeout(<span class="hljs-number">5</span> * time.Second))<font></font>
<font></font>
server1 := NewServer(<span class="hljs-string">":8080"</span>, defaultOptions, MaxConnections(<span class="hljs-number">10</span>))<font></font>
<font></font>
server2 := NewServer(<span class="hljs-string">":8080"</span>, defaultOptions, RateLimit(<span class="hljs-number">10</span>, time.Minute))<font></font>
<font></font>
server3 := NewServer(<span class="hljs-string">":8080"</span>, defaultOptions, Timeout(<span class="hljs-number">10</span> * time.Second))</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pr√©fixes des options With / Set</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les options sont souvent de types complexes, contrairement √† un d√©lai d'expiration ou √† un nombre maximal de connexions. </font><font style="vertical-align: inherit;">Par exemple, dans le package serveur, vous pouvez d√©finir l'interface de l'enregistreur comme une option (et l'utiliser s'il n'y a pas d'enregistreur par d√©faut):</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Logger <span class="hljs-keyword">interface</span> {<font></font>
    Info(msg <span class="hljs-keyword">string</span>)<font></font>
    Error(msg <span class="hljs-keyword">string</span>)<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De toute √©vidence, le nom de l'enregistreur ne peut pas √™tre utilis√© comme nom d'option, car il est d√©j√† utilis√© par l'interface. </font><font style="vertical-align: inherit;">Vous pouvez appeler l'option LoggerOption, mais ce n'est pas un nom tr√®s convivial. </font><font style="vertical-align: inherit;">Si vous regardez le constructeur comme une phrase, dans notre cas, le mot avec: WithLogger vient √† l'esprit.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithLogger</span><span class="hljs-params">(logger Logger)</span> <span class="hljs-title">Option</span></span> {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Server)</span></span> {<font></font>
        s.logger = logger<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// reads: create a new server that listens on :8080 with a logger</span>
NewServer(<span class="hljs-string">":8080"</span>, WithLogger(logger))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre exemple courant d'une option de type complexe est une tranche de valeurs:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// ...</span><font></font>
<font></font>
    whitelistIPs []<span class="hljs-keyword">string</span><font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithWhitelistedIP</span><span class="hljs-params">(ip <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Option</span></span> {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Server)</span></span> {<font></font>
        s.whitelistIPs = <span class="hljs-built_in">append</span>(s.whitelistIPs, ip)<font></font>
    }<font></font>
}<font></font>
<font></font>
NewServer(<span class="hljs-string">":8080"</span>, WithWhitelistedIP(<span class="hljs-string">"10.0.0.0/8"</span>), WithWhitelistedIP(<span class="hljs-string">"172.16.0.0/12"</span>))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ce cas, l'option ajoute g√©n√©ralement les valeurs aux valeurs existantes, plut√¥t que de les √©craser. </font><font style="vertical-align: inherit;">Si vous devez remplacer un ensemble de valeurs existant, vous pouvez utiliser le mot set dans le nom de l'option:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetWhitelistedIP</span><span class="hljs-params">(ip <span class="hljs-keyword">string</span>)</span> <span class="hljs-title">Option</span></span> {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s *Server)</span></span> {<font></font>
        s.whitelistIPs = []<span class="hljs-keyword">string</span>{ip}<font></font>
    }<font></font>
}<font></font>
<font></font>
NewServer(<font></font>
    <span class="hljs-string">":8080"</span>,<font></font>
    WithWhitelistedIP(<span class="hljs-string">"10.0.0.0/8"</span>),<font></font>
    WithWhitelistedIP(<span class="hljs-string">"172.16.0.0/12"</span>),<font></font>
    SetWhitelistedIP(<span class="hljs-string">"192.168.0.0/16"</span>), <span class="hljs-comment">// overwrites any previous values</span>
)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mod√®le pr√©d√©fini</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les cas d'utilisation sp√©ciaux sont g√©n√©ralement assez universels pour les prendre en charge dans la biblioth√®que. </font><font style="vertical-align: inherit;">Dans le cas d'une configuration, cela peut signifier un ensemble de param√®tres regroup√©s et utilis√©s comme pr√©r√©glage √† utiliser. </font><font style="vertical-align: inherit;">Dans notre exemple, le serveur peut avoir des sc√©narios d'utilisation ouverts et internes qui d√©finissent les d√©lais d'expiration, les limites de vitesse, le nombre de connexions, etc. de diff√©rentes mani√®res.</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// PublicPreset configures a Server for public usage.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">PublicPreset</span><span class="hljs-params">()</span> <span class="hljs-title">Option</span></span> {
    <span class="hljs-keyword">return</span> Options(<font></font>
        WithTimeout(<span class="hljs-number">10</span> * time.Second),<font></font>
        MaxConnections(<span class="hljs-number">10</span>),<font></font>
    )<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// InternalPreset configures a Server for internal usage.</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InternalPreset</span><span class="hljs-params">()</span> <span class="hljs-title">Option</span></span> {
    <span class="hljs-keyword">return</span> Options(<font></font>
        WithTimeout(<span class="hljs-number">20</span> * time.Second),<font></font>
        WithWhitelistedIP(<span class="hljs-string">"10.0.0.0/8"</span>),<font></font>
    )<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bien que les pr√©r√©glages puissent √™tre utiles dans certains cas, ils sont probablement d'une grande valeur dans les biblioth√®ques internes et dans les biblioth√®ques publiques, leur valeur est moindre.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Valeurs de type par d√©faut vs valeurs de pr√©r√©glage par d√©faut</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Go a toujours des valeurs par d√©faut. Pour les nombres, c'est g√©n√©ralement z√©ro, pour les types bool√©ens, c'est faux, et ainsi de suite. Dans une configuration facultative, il est consid√©r√© comme une bonne pratique de s'appuyer sur les valeurs par d√©faut. Par exemple, une valeur nulle devrait signifier un d√©lai d'expiration illimit√© au lieu de son absence (ce qui n'a g√©n√©ralement aucun sens). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans certains cas, la valeur de type par d√©faut n'est pas une bonne valeur par d√©faut. Par exemple, la valeur par d√©faut de Logger est nil, ce qui peut conduire √† la panique (si vous ne prot√©gez pas les appels de l'enregistreur avec des v√©rifications conditionnelles). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans ces cas, la d√©finition de la valeur dans le constructeur (avant d'appliquer les param√®tres) est un bon moyen de d√©terminer le repli:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">(addr <span class="hljs-keyword">string</span>, opts ...<span class="hljs-keyword">func</span>(*Server)</span>) *<span class="hljs-title">Server</span></span> {<font></font>
    server := &amp;Server {<font></font>
        addr:   addr,<font></font>
        logger: noopLogger{},<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">// apply the list of options to Server</span>
    <span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts {<font></font>
        opt(server)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> server<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai vu des exemples avec des pr√©r√©glages par d√©faut (en utilisant le mod√®le d√©crit dans la section pr√©c√©dente). </font><font style="vertical-align: inherit;">Cependant, je ne consid√®re pas cela comme une bonne pratique. </font><font style="vertical-align: inherit;">C'est beaucoup moins expressif que de simplement d√©finir des valeurs par d√©faut dans le constructeur:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewServer</span><span class="hljs-params">(addr <span class="hljs-keyword">string</span>, opts ...<span class="hljs-keyword">func</span>(*Server)</span>) *<span class="hljs-title">Server</span></span> {<font></font>
    server := &amp;Server {<font></font>
        addr:   addr,<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">// what are the defaults?</span>
    opts = <span class="hljs-built_in">append</span>([]Option{DefaultPreset()}, opts...)<font></font>
<font></font>
    <span class="hljs-comment">// apply the list of options to Server</span>
    <span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts {<font></font>
        opt(server)<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> server<font></font>
}</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option de structure de configuration</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avoir une structure de configuration comme option fonctionnelle n'est probablement pas aussi courant, mais cela se trouve parfois. </font><font style="vertical-align: inherit;">L'id√©e est que les options fonctionnelles font r√©f√©rence √† la structure de configuration au lieu de faire r√©f√©rence √† l'objet r√©el en cours de cr√©ation:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
    Timeout time.Duration<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">type</span> Option <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *Config)</span></span><font></font>
<font></font>
<span class="hljs-keyword">type</span> Server <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// ...</span><font></font>
<font></font>
    config Config<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce mod√®le est utile lorsque vous disposez de nombreuses options, et la cr√©ation d'une structure de configuration semble plus propre que la liste de toutes les options dans un appel de fonction:</font></font><br>
<br>
<pre><code class="go hljs">config := Config{<font></font>
    Timeout: <span class="hljs-number">10</span> * time.Second
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// lots of other options</span><font></font>
}<font></font>
<font></font>
NewServer(<span class="hljs-string">":8080"</span>, WithConfig(config))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un autre cas d'utilisation de ce mod√®le consiste √† d√©finir des valeurs par d√©faut:</font></font><br>
<br>
<pre><code class="go hljs">config := Config{<font></font>
    Timeout: <span class="hljs-number">10</span> * time.Second
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// lots of other options</span><font></font>
}<font></font>
<font></font>
NewServer(<span class="hljs-string">":8080"</span>, WithConfig(config), WithTimeout(<span class="hljs-number">20</span> * time.Second))</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mod√®les avanc√©s</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apr√®s avoir √©crit des dizaines d'options fonctionnelles, vous vous demandez peut-√™tre s'il existe une meilleure fa√ßon de proc√©der. </font><font style="vertical-align: inherit;">Pas en termes d'utilisation, mais en termes de support √† long terme. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par exemple, si nous pouvions d√©finir des types et les utiliser comme param√®tres:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-keyword">type</span> Timeout time.Duration<font></font>
<font></font>
NewServer(<span class="hljs-string">":8080"</span>, Timeout(time.Minute))</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
(Notez que l'utilisation de l'API reste la m√™me) </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il s'av√®re qu'en changeant le type d'option, nous pouvons facilement faire ceci:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// Option configures a Server.</span>
<span class="hljs-keyword">type</span> Option <span class="hljs-keyword">interface</span> {
    <span class="hljs-comment">// apply is unexported,</span>
    <span class="hljs-comment">// so only the current package can implement this interface.</span><font></font>
    apply(s *Server)<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remplacer une fonction facultative en tant qu'interface ouvre la porte √† un certain nombre de nouvelles fa√ßons de mettre en ≈ìuvre des options fonctionnelles: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Diff√©rents types int√©gr√©s peuvent √™tre utilis√©s comme param√®tres sans fonction d'encapsuleur:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// Timeout configures a maximum length of idle connection in Server.</span>
<span class="hljs-keyword">type</span> Timeout time.Duration<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t Timeout)</span> <span class="hljs-title">apply</span><span class="hljs-params">(s *Server)</span></span> {<font></font>
    s.timeout = time.Duration(t)<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les listes d'options et de structures de configuration (voir les sections pr√©c√©dentes) peuvent √©galement √™tre red√©finies comme suit:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// Options turns a list of Option instances into an Option.</span>
<span class="hljs-keyword">type</span> Options []Option<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o Options)</span> <span class="hljs-title">apply</span><span class="hljs-params">(s *Server)</span></span> {
    <span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> o {<font></font>
        o.apply(s)<font></font>
    }<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> {<font></font>
    Timeout time.Duration<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c Config)</span> <span class="hljs-title">apply</span><span class="hljs-params">(s *Server)</span></span> {<font></font>
    s.config = c<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mon pr√©f√©r√© est la possibilit√© de r√©utiliser l'option dans plusieurs constructeurs:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-comment">// ServerOption configures a Server.</span>
<span class="hljs-keyword">type</span> ServerOption <span class="hljs-keyword">interface</span> {<font></font>
    applyServer(s *Server)<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// ClientOption configures a Client.</span>
<span class="hljs-keyword">type</span> ClientOption <span class="hljs-keyword">interface</span> {<font></font>
    applyClient(c *Client)<font></font>
}<font></font>
<font></font>
<span class="hljs-comment">// Option configures a Server or a Client.</span>
<span class="hljs-keyword">type</span> Option <span class="hljs-keyword">interface</span> {<font></font>
    ServerOption<font></font>
    ClientOption<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithLogger</span><span class="hljs-params">(logger Logger)</span> <span class="hljs-title">Option</span></span> {
    <span class="hljs-keyword">return</span> withLogger{logger}<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">type</span> withLogger <span class="hljs-keyword">struct</span> {<font></font>
    logger Logger<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o withLogger)</span> <span class="hljs-title">applyServer</span><span class="hljs-params">(s *Server)</span></span> {<font></font>
    s.logger = o.logger<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(o withLogger)</span> <span class="hljs-title">applyClient</span><span class="hljs-params">(c *Client)</span></span> {<font></font>
    c.logger = o.logger<font></font>
}<font></font>
<font></font>
NewServer(<span class="hljs-string">":8080"</span>, WithLogger(logger))<font></font>
NewClient(<span class="hljs-string">"http://localhost:8080"</span>, WithLogger(logger))</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sommaire</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les param√®tres fonctionnels sont un mod√®le puissant pour cr√©er des API propres et extensibles avec des dizaines de param√®tres. </font><font style="vertical-align: inherit;">Bien que cela fasse un peu plus de travail que la prise en charge d'une structure de configuration simple, cela offre beaucoup plus de flexibilit√© et fournit des API beaucoup plus propres que les alternatives.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr489282/index.html">DirectX 12 - De L√©onard de Vinci √† l'art contemporain</a></li>
<li><a href="../fr489284/index.html">Mes outils de d√©veloppement Chrome pr√©f√©r√©s</a></li>
<li><a href="../fr489286/index.html">Slips, chaussettes et blaireau: anti-cotation des cadeaux le 23 f√©vrier</a></li>
<li><a href="../fr489290/index.html">"Travailler dans l'informatique - 2020", ou Qui et pour ce que nous aimons</a></li>
<li><a href="../fr489294/index.html">Apprentissage des variables CSS avec un exemple pratique</a></li>
<li><a href="../fr489298/index.html">Entretien informel avec Maria Dolgusheva (RH de la Silicon Valley)</a></li>
<li><a href="../fr489302/index.html">Num√©ro 31: Formation informatique - probl√®mes et d√©fis actuels des grandes entreprises</a></li>
<li><a href="../fr489304/index.html">Analyse des donn√©es ChIP-seq: des histones aux t√¢ches informatiques</a></li>
<li><a href="../fr489306/index.html">[Habr]: Beignets</a></li>
<li><a href="../fr489310/index.html">Top 10: les meilleurs reportages de Heisenbug 2019 Moscou</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>