<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëáüèø üëéüèæ üéë We add a rootkit hunter hash check into the daily script üë° üíø üë©‚Äçüë¶‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Because of all this udalenka, it turned out that the training laptop, half empty before, has now become the main working machine and it is worth prote...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We add a rootkit hunter hash check into the daily script</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/496346/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Because of all this udalenka, it turned out that the training laptop, half empty before, has now become the main working machine and it is worth protecting it somehow more thoughtfully. What, in general, is clearly hinted at by the authorities. On the laptop now is Ubuntu 20.04 beta. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It all started with clear BIOS settings and full disk encryption, which I probably shouldn‚Äôt write about. But then I decided to understand what the </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rkhunter</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><font style="vertical-align: inherit;">(‚Äúrootkit, backdoor, sniffer and exploit scanner‚Äù) </font><font style="vertical-align: inherit;">can do at the file level </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I had no big expectations from the software that had not been updated for a couple of years. </font><font style="vertical-align: inherit;">I must say right away that I very much doubt the use of February 2018 signatures to search for rootkits, but one of the other modes of operation - checking file hashes, interested me. </font><font style="vertical-align: inherit;">Who is interested in such an experience and what has happened so far - welcome to cat.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The idea is simple - but let's add a check in the morning useful things script to see if the MD5 hashes of the files for which they should not change have not changed. </font><font style="vertical-align: inherit;">At least until package updates should. </font><font style="vertical-align: inherit;">Such a very light, but not useless, in my opinion, whitelisting. </font><font style="vertical-align: inherit;">The current version capable of calculating and checking the hashes of the utility is set simply by the package manager:</font></font><br>
<br>
<pre><code class="bash hljs">apt search rkhunter<font></font>
rkhunter/focal,focal,now 1.4.6-8 all [installed]<font></font>
  rootkit, backdoor, sniffer and exploit scanner</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The main hunter config is in /etc/rkhunter.conf and first, to solve my problem, these are the parameters I set there:</font></font><br>
<br>
<pre><code class="bash hljs">ENABLE_TESTS=hashes</code></pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Because, apart from hashes, nothing interests me yet. </font><font style="vertical-align: inherit;">The list of other possible tests can be obtained by the command.</font></font><br>
<br>
<pre><code class="bash hljs">sudo rkhunter --list <span class="hljs-built_in">test</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I still consider the MD5-ok collision to be related to mathematics, but not to practice. </font><font style="vertical-align: inherit;">I do not insist on this opinion, but almost every day I look at good malware and so far have not encountered such conflicts in the wild. </font><font style="vertical-align: inherit;">So for now in the config is enough for me.</font></font><br>
 <br>
<pre><code class="bash hljs">HASH_CMD=MD5</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then he indicated his package manager and, most importantly, the directories, file hashes that interest me. </font><font style="vertical-align: inherit;">The path will be, for example, / bin and / usr / bin. </font><font style="vertical-align: inherit;">About files that appeared in directories, but which were not there at the time of calculation, the hunter will also give warnings.</font></font><br>
 <br>
<pre><code class="bash hljs">PKGMGR=DPKG<font></font>
USER_FILEPROP_FILES_DIRS=/bin/*<font></font>
USER_FILEPROP_FILES_DIRS=/usr/bin/*</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here is an important point: with my settings, scanning is not based on packages, but on directories. Probably, this is more correct, because the packages contain a lot of non-executable files and they must first be filtered out, for example, through file. So far, I have chosen the path of increasing the list of directories and exceptions. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We have finished the scanner config so far, now it‚Äôs time to update the base of the correct hashes in /var/lib/rkhunter/db/rkhunter.dat with the new settings. To do this, you need a command (it also takes the names of packages to add to the database, if you go the other way).</font></font><br>
<br>
<pre><code class="bash hljs">sudo rkhunter --propupd</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After that, all files of interest to you and their hashes should appear in rkhunter.dat. In my case, these are 2847 files, and the indexer took 9m 2,117s. It‚Äôs a bit much, like, for three thousand MD5s, considering md5sum for / bin / ls for 0.003s, but there really is. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
That‚Äôs it, we are ready to run a check. Not yet combat, it is unlikely that some malware has already managed to change the hashes.</font></font><br>
<br>
<pre><code class="bash hljs">sudo rkhunter -c</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There is one very useful key here - rwo (report warnings only), which will skip all successful comparisons and give only warnings. </font><font style="vertical-align: inherit;">You need to look for the result of work in /var/log/rkhunter.log. </font><font style="vertical-align: inherit;">As for the speed of the check, for my almost three thousand binaries it was 10m 27,489s, comparable to the indexing time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We sorted out the verification, but the question remains of reindexing when updating packages. </font><font style="vertical-align: inherit;">Those. </font><font style="vertical-align: inherit;">we did apt update and now do not consider all updated files to be malware. </font><font style="vertical-align: inherit;">The scanner has another config / etc / default / rkhunter for automating tasks. </font><font style="vertical-align: inherit;">In it we will set the parameter.</font></font><br>
<br>
<pre><code class="bash hljs">APT_AUTOGEN=<span class="hljs-string">"yes"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And in /etc/apt/apt.conf.d/90rkhunter lies a script that is responsible for post-reindexing:</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
 // Makes sure that rkhunter file properties database is updated after each remove or install only APT_AUTOGEN is enabled<font></font>
 DPkg::Post-Invoke { <span class="hljs-string">"if [ -x /usr/bin/rkhunter ] &amp;&amp; grep -qiE '^APT_AUTOGEN=.?(true|yes)' /etc/default/rkhunter; then /usr/share/rkhunter/scripts/rkhupd.sh; fi"</span>; };</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Actually, everyone, any additions are happy to accept. </font><font style="vertical-align: inherit;">Hope it was helpful.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en496336/index.html">What are smart meters for?</a></li>
<li><a href="../en496338/index.html">Crisis and that's it</a></li>
<li><a href="../en496340/index.html">We train generative-competitive network for drawing pictures on Azure ML</a></li>
<li><a href="../en496342/index.html">CI / CD Process Update: teamcity</a></li>
<li><a href="../en496344/index.html">Is quarantine online hackathons the right time?</a></li>
<li><a href="../en496348/index.html">Web Storage API Case Studies</a></li>
<li><a href="../en496350/index.html">You shall not pass! - 3D printers answer to coronavirus</a></li>
<li><a href="../en496354/index.html">Ternary computer programming: play with the emulator</a></li>
<li><a href="../en496356/index.html">Creating a navigator using augmented reality technologies and machine learning methods</a></li>
<li><a href="../en496358/index.html">Getting ready to celebrate Cosmonautics Day online (the list is being updated)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>