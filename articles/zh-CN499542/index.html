<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧓 🕵🏼 👨🏽 顶级法卡波夫·青色 💟 😈 🙄</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="对所有人都好！ 
 
 我叫Nikita，我是Cyan工程师的团队负责人。我在公司的职责之一是将与产品上的基础结构相关的事件数量减少到零。
 稍后将讨论的内容给我们带来了很多痛苦，本文的目的是防止其他人重复我们的错误或至少将其影响最小化。 
 
 前言
 曾几何时，当Cyan由单块组成，并且还没有微...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>顶级法卡波夫·青色</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/cian/blog/499542/"><img src="https://habrastorage.org/webt/zy/iu/-q/zyiu-qkcptbeezgf_c5adiagete.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对所有人都好！&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我叫Nikita，我是Cyan工程师的团队负责人。</font><font style="vertical-align: inherit;">我在公司的职责之一是将与产品上的基础结构相关的事件数量减少到零。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
稍后将讨论的内容给我们带来了很多痛苦，本文的目的是防止其他人重复我们的错误或至少将其影响最小化。&nbsp;</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前言</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
曾几何时，当Cyan由单块组成，并且还没有微服务的提示时，我们通过检查3-5页来测量资源的可用性。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
答案-一切正常，不要长时间响应-警报。</font><font style="vertical-align: inherit;">人们在会议上决定，他们应该花多少时间才能将其视为事件。</font><font style="vertical-align: inherit;">工程师团队一直参与事件调查。</font><font style="vertical-align: inherit;">调查完成后，他们写了一份验尸报告-一种格式的报告给邮局：当时是什么，持续了多长时间，他们现在做什么，将来我们会做什么。&nbsp;</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">网站的首页，或者据我们所知，已经跌破了谷底</font></font></h3>&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了以某种方式理解错误的优先级，我们突出显示了该网站针对业务功能最关键的页面。</font><font style="vertical-align: inherit;">根据他们的意见，我们考虑成功/失败请求和超时的数量。</font><font style="vertical-align: inherit;">因此，我们测量正常运行时间。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
假设我们发现站点中有许多超重要部分负责主要服务-搜索和提交公告。</font><font style="vertical-align: inherit;">如果失败的请求数大于1％，则这是严重事件。</font><font style="vertical-align: inherit;">如果在黄金时间的15分钟内错误百分比超过0.1％，则这也被视为严重事件。</font><font style="vertical-align: inherit;">这些标准涵盖了大多数事件，其余事件超出了本文的范围。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ot/mw/k9/otmwk90qyl-jcomorjhkofebrgq.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最佳的青色事故</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我们精确地学会了确定事件发生的事实。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，对我们国家的每起事件都进行了详细描述，并反映在吉拉史诗中。</font><font style="vertical-align: inherit;">顺便说一句：为此，我们启动了一个单独的项目，称为FAIL-只能在其中创建史诗。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您收集过去几年中所有的失败，那么领导者是：&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">与mssql相关的事件；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由外部因素引起的事件；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">管理员错误。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
让我们更详细地介绍管理员的错误以及其他一些有趣的失败。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第五名-“将域名放入DNS”</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
星期二下雨天。我们决定清理DNS群集。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我想将内部dns服务器从绑定转移到powerdns，从而突出显示完全独立的服务器，除了dns外没有其他东西。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我们在DC的每个位置上都放置了一台dns服务器，此刻该将区域从绑定移动到powerdns，并将基础结构切换到新服务器。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在移动高峰时，在本地缓存中指示的所有服务器都绑定在所有服务器上，圣彼得堡的数据中心中只有一个。最初，这个DC对我们来说并不重要，但突然变成了单点故障。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就在这样的搬迁时期，莫斯科和圣彼得堡之间的通道下降了。</font><font style="vertical-align: inherit;">实际上，我们在没有DNS的情况下保持了五分钟，并在托管人解决问题后起床。&nbsp;</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论：</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
如果以前我们在准备工作时忽略了外部因素，那么现在这些因素也包括在我们正在准备的工作清单中。</font><font style="vertical-align: inherit;">现在，我们努力确保所有组件都保留为n-2，并且在工作期间我们可以将该级别降低为n-1。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在制定行动计划时，请先标记出服务可能下降的要点，并事先考虑一切都变得“比没有地方糟”的情况。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过不同的地理位置/数据中心/机架/交换机/输入来分配内部DNS服务器。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在每台服务器上，放置一个本地缓存dns服务器，该服务器将请求重定向到主dns服务器，如果该请求不可用，它将从缓存中响应。&nbsp;</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第四名-“清理Nginx”</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一天，我们的团队决定“足够忍受”，重构nginx配置的过程开始了。</font><font style="vertical-align: inherit;">主要目标是使配置具有直观的结构。</font><font style="vertical-align: inherit;">以前，一切都是“历史悠久的”，其本身没有逻辑。</font><font style="vertical-align: inherit;">现在，每个server_name都被取出到同名文件中，并将所有配置分发到文件夹中。</font><font style="vertical-align: inherit;">顺便说一下，配置包含253949行或7836520个字符，占用了将近7兆字节。</font><font style="vertical-align: inherit;">顶层结构：&nbsp;</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nginx结构</font></font></b>
                        <div class="spoiler_text"><pre><code class="plaintext hljs">├── access<font></font>
│ &nbsp; ├── allow.list<font></font>
...<font></font>
│ &nbsp; └── whitelist.conf<font></font>
├── geobase<font></font>
│ &nbsp; ├── exclude.conf<font></font>
...<font></font>
│ &nbsp; └── geo_ip_to_region_id.conf<font></font>
├── geodb<font></font>
│ &nbsp; ├── GeoIP.dat<font></font>
│ &nbsp; ├── GeoIP2-Country.mmdb<font></font>
│ &nbsp; └── GeoLiteCity.dat<font></font>
├── inc<font></font>
│ &nbsp; ├── error.inc<font></font>
...<font></font>
│ &nbsp; └── proxy.inc<font></font>
├── lists.d<font></font>
│ &nbsp; ├── bot.conf<font></font>
...<font></font>
│ &nbsp; ├── dynamic<font></font>
│ &nbsp; └── geo.conf<font></font>
├── lua<font></font>
│ &nbsp; ├── cookie.lua<font></font>
│ &nbsp; ├── log<font></font>
│ &nbsp; │ &nbsp; └── log.lua<font></font>
│ &nbsp; ├── logics<font></font>
│ &nbsp; │ &nbsp; ├── include.lua<font></font>
│ &nbsp; │ &nbsp; ├── ...<font></font>
│ &nbsp; │ &nbsp; └── utils.lua<font></font>
│ &nbsp; └── prom<font></font>
│ &nbsp; &nbsp; &nbsp; ├── stats.lua<font></font>
│ &nbsp; &nbsp; &nbsp; └── stats_prometheus.lua<font></font>
├── map.d<font></font>
│ &nbsp; ├── access.conf<font></font>
│ &nbsp; ├── ..&nbsp;<font></font>
│ &nbsp; └── zones.conf<font></font>
├── nginx.conf<font></font>
├── robots.txt<font></font>
├── server.d<font></font>
│ &nbsp; ├── cian.ru<font></font>
│ &nbsp; │ &nbsp; ├── cian.ru.conf<font></font>
│ &nbsp; │ &nbsp; ├── ...<font></font>
│ &nbsp; │ &nbsp; └── my.cian.ru.conf<font></font>
├── service.d<font></font>
│ &nbsp; ├── ...<font></font>
│ &nbsp; └── status.conf<font></font>
└── upstream.d<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;├── cian-mcs.conf<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;├── ...<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;└── wafserver.conf</code></pre><br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
它变得更好了，但是在重命名和分发配置的过程中，其中一些扩展名错误，并且没有包含在include * .conf指令中。</font><font style="vertical-align: inherit;">结果，部分主机变得不可用，并将301返回到主要主机。</font><font style="vertical-align: inherit;">由于响应代码不是5xx / 4xx，因此并未立即发现，而是仅在早上发现。</font><font style="vertical-align: inherit;">之后，我们开始编写测试来测试基础架构组件。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发现：</font></font></b>&nbsp;<br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">正确地构造配置（不仅是nginx），并在项目的早期阶段考虑一下结构。</font><font style="vertical-align: inherit;">因此，您将使团队更容易理解它们，从而减少TTM。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于某些基础架构组件，编写测试。</font><font style="vertical-align: inherit;">例如：检查所有关键的server_names返回正确的状态+响应主体。</font><font style="vertical-align: inherit;">只需要几个脚本来检查组件的基本功能就足够了，这样您就不必在凌晨3点疯狂地记住其他需要检查的内容。&nbsp;</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第三名-“卡桑德拉（Cassandra）突然结束”</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数据一直在稳定增长，直到Cassandra群集中的大型案例的修复工作开始下降之前，一切都很好，因为无法对其进行压缩。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在一个雨天，簇几乎变成了南瓜，即：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">名额仍占集群总数的20％；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您无法完全添加节点，因为添加分区后由于分区空间不足而无法进行清理；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于压缩不起作用，性能会略有下降；&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">群集处于紧急模式。</font></font></li>
</ul><br>
<img src="https://habrastorage.org/webt/lp/ah/ie/lpahie7bann64sajoibumpqbr5g.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
退出-添加了另外5个无需清理的节点，之后它们开始系统地从群集中删除，然后将它们重新输入为结束该节点的空节点。</font><font style="vertical-align: inherit;">时间花费比我们想要的多得多。</font><font style="vertical-align: inherit;">存在集群部分或完全无法访问的风险。&nbsp;</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发现：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有cassandra服务器应占用每个分区上不超过60％的空间。&nbsp;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它们应加载不超过50％的CPU。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不要阻塞容量规划，而要根据其具体情况为每个组件仔细考虑。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">集群中的节点越多越好。</font><font style="vertical-align: inherit;">包含少量数据的服务器迁移速度更快，并且这样的集群更易于恢复。&nbsp;</font></font></li>
</ul><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二名-“领事键值存储中的数据已消失”</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于服务发现，我们和许多人一样使用领事。但是这里，它的键值也用于蓝绿色整块计算。它存储有关活动上游和非活动上游的信息，这些信息在部署期间会更改位置。为此，编写了与KV交互的部署服务。在某些时候，来自KV的数据消失了。从内存中恢复，但有许多错误。结果，在计算过程中，上游的负载分布不均，并且由于CPU后端过载而导致很多502错误。结果，我们从领事KV转移到postgres，从那里移除它们并不容易。&nbsp;&nbsp; </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发现：</font></font><br>
</b><br>
<ul>
<li>  -           . ,       ES —        ,    ,   ,    action.destructive_requires_name: true.</li>
<li>      . ,    ( , &nbsp;python),      .</li>
</ul><br>
<h4>  — « »&nbsp;</h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在某些时候，如果后端有10台以上的服务器，我们会注意到nginx上游的负载分布不均。由于轮循机制将请求从1顺序发送到最后一个上游，并且每次nginx重新加载都是从头开始的，因此第一个上游总是比其余上游有更多请求，结果，它们的工作速度较慢，整个站点遭受了损失。随着流量的增加，这一点变得更加明显。仅仅更新nginx以启用随机功能是行不通的-您需要重做一堆在版本1.15上还没有启动的lua代码（当时）。我必须修补我们的nginx 1.14.2，在其中引入随机支持。这样就解决了问题。该错误赢得了“队长非显而易见性”提名。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论：</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
研究此bug非常有趣，令人兴奋。&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置监视，以帮助快速发现此类波动。</font><font style="vertical-align: inherit;">例如，您可以使用ELK监视每个上游的每个后端上的rp，并从nginx的角度监视它们的响应时间。</font><font style="vertical-align: inherit;">在这种情况下，它有助于我们识别问题。&nbsp;</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，可以采用更加谨慎的方法来避免大多数失败。</font><font style="vertical-align: inherit;">您必须始终牢记墨菲定律：&nbsp; </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">任何可能出错的地方都会出错，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并基于该</font><i><font style="vertical-align: inherit;">错误</font></i><font style="vertical-align: inherit;">构建组件。&nbsp;</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN499528/index.html">超越费马大定理的“惊人”数学桥梁</a></li>
<li><a href="../zh-CN499532/index.html">数字一词：使用Yandex.Metrica进行免费的博客分析habravebinary</a></li>
<li><a href="../zh-CN499534/index.html">Python后端服务开发指南</a></li>
<li><a href="../zh-CN499536/index.html">Growbox作为认识自己的方法</a></li>
<li><a href="../zh-CN499540/index.html">3D游戏渲染如何工作：纹理和纹理过滤</a></li>
<li><a href="../zh-CN499544/index.html">在Google表格中学习神经网络</a></li>
<li><a href="../zh-CN499546/index.html">模拟摄像机EVR-Y2022F的固件开发</a></li>
<li><a href="../zh-CN499548/index.html">面具-照顾别人还是对安全的幻想？</a></li>
<li><a href="../zh-CN499550/index.html">生态系统低码解决方案</a></li>
<li><a href="../zh-CN499556/index.html">MS Orleans上的游戏服务器-第3部分：摘要</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>