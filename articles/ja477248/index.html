<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👮 👸🏻 🐵 クラッシュ後にPostgresデータベースを回復した最初の経験（Relattonベース/ 16490のブロック4123007の無効なページ） 👩🏿‍🔬 🎉 🌮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Postgresデータベースの全機能を復元する最初の成功体験を皆さんと共有したいと思います。半年前にPostgres DBMSに出会いましたが、その前はデータベース管理の経験がまったくありませんでした。
 
 
 
 私は大規模なIT企業でセミDevOpsエンジニアとして働いています。当社は負荷の高...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>クラッシュ後にPostgresデータベースを回復した最初の経験（Relattonベース/ 16490のブロック4123007の無効なページ）</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477248/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postgresデータベースの全機能を復元する最初の成功体験を皆さんと共有したいと思います。半年前にPostgres DBMSに出会いましたが、その前はデータベース管理の経験がまったくありませんでした。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zf/35/tb/zf35tb0kz_lvnsdbyagxaueaffy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は大規模なIT企業でセミDevOpsエンジニアとして働いています。当社は負荷の高いサービス用のソフトウェアを開発していますが、私はパフォーマンス、メンテナンス、および展開を担当しています。彼らは私にとって標準的なタスクを設定しました：1つのサーバーでアプリケーションを更新します。アプリケーションはDjangoで作成され、アップグレード中に移行が実行され（データベース構造が変更されます）、このプロセスの前に、念のために標準のpg_dumpプログラムを通じて完全なデータベースダンプを削除します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダンプの削除中に予期しないエラーが発生しました（Postgresのバージョンは9.5）：</font></font><br>
<br>
<pre><code class="plaintext hljs">pg_dump: Oumping the contents of table “ws_log_smevlog” failed: PQgetResult() failed.<font></font>
pg_dump: Error message from server: ERROR: invalid page in block 4123007 of relatton base/16490/21396989<font></font>
pg_dump: The command was: COPY public.ws_log_smevlog [...]<font></font>
pg_dunp: [parallel archtver] a worker process dled unexpectedly</code></pre><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ブロック内の無効なページ」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
というエラー</font><font style="vertical-align: inherit;">は、ファイルシステムレベルでの問題を示しています。</font><font style="vertical-align: inherit;">さまざまなフォーラムで、彼らは</font><font style="vertical-align: inherit;">この問題を解決するために</font><i><font style="vertical-align: inherit;">zero_damaged_pa​​ges</font></i><font style="vertical-align: inherit;">オプションで</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FULL </font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">作成することを提案しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">さて、popprobeum ...</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リカバリー準備</font></font></h4><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意！</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データベースを復元する前に、必ずPostgresをバックアップしてください。</font><font style="vertical-align: inherit;">仮想マシンがある場合は、データベースを停止してスナップショットを作成します。</font><font style="vertical-align: inherit;">スナップショットを作成できない場合は、データベースを停止し、Postgresディレクトリの内容（wal-filesを含む）を安全な場所にコピーします。</font><font style="vertical-align: inherit;">私たちのビジネスの主なものは、物事を悪化させることではありません。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を読んでください</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースは全体として機能したので、通常のデータベースダンプに限定しましたが、データが破損しているテーブルは除外しました（</font><font style="vertical-align: inherit;">pg_dumpの</font><font style="vertical-align: inherit;">オプション</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-T、-exclude-table = TABLE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーは物理的で、スナップショットを取ることは不可能でした。</font><font style="vertical-align: inherit;">バックアップが削除されました。続行してください。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルシステムチェック</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データベースの復元を試みる前に、ファイルシステム自体がすべて正常であることを確認する必要があります。エラーが発生した場合は修正してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の場合、データベースを含むファイルシステムは</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「/ srv」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">にマウントされ</font><font style="vertical-align: inherit;">、タイプはext4でした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
：私たちは、データベースを停止</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">systemctl停止postgresql@9.5-main.serviceを</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、ファイルシステムは、ユーザーに使用されていないと、使用してアンマウントすることができていることを確認し</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lsofをコマンド</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ D / srvのlsofを</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
、それも使用されるように、私はRedisのデータベースを停止しなければなりませんでした</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」 / SRV」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。次に、アンマウント</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ srv</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（umount）します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-fキー</font><font style="vertical-align: inherit;">
を指定して</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e2fsck</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーティリティ</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">使用してファイルシステムをチェックしました</font><font style="vertical-align: inherit;">（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルシステムがクリーンとマークされていても強制的にチェックします</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8_/zj/d_/8_zjd_jjdoiq_kg_qgndbq3mjpm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dumpe2fs</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーティリティを使用して</font><font style="vertical-align: inherit;">（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sudo dumpe2fs / dev / mapper / gu2-sys-srv | grepチェック</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）、確認できますチェックが実際に行われたこと：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i7/on/oe/i7onoelytrz8ihbjndgqrmkn37i.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e2fsck</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はext4ファイルシステムレベルで問題が検出されなかったことを示します。つまり、データベースの復元を引き続き試行するか、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">バキュームフルに</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">戻す</font><font style="vertical-align: inherit;">ことができます（もちろん、ファイルシステムをマウントしてデータベースを起動する必要があります） ）</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーが物理的な場合は、ディスクのステータスを確認してください（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">smartctl -a / dev / XXXを使用）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）またはRAIDコントローラーを使用して、問題がハードウェアレベルではないことを確認します。</font><font style="vertical-align: inherit;">私の場合、RAIDは「鉄」であることが判明したので、ローカル管理者にRAIDのステータスを確認するよう依頼しました（サーバーは私から数百キロ離れていました）。</font><font style="vertical-align: inherit;">エラーはなかったので、間違いなく復旧を開始できると彼は言った。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">試行1：zero_damaged_pa​​ges</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スーパーユーザー権限を持つpsqlアカウントを介してデータベースに接続します。</font><font style="vertical-align: inherit;">まさにスーパーユーザーが必要です。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zero_damaged_pa​​ges</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプション</font><font style="vertical-align: inherit;">を変更できるのは彼だけです。</font><font style="vertical-align: inherit;">私の場合、これはpostgresです</font><i><font style="vertical-align: inherit;">。psql </font></i></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-h 127.0.0.1 -U postgres -s [database_name] </font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">zero_damaged_pa​​ges</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
オプション</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、（postgrespro Webサイトからの）読み取りエラーを無視するために必要です。</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">破損したページタイトルが見つかった場合、Postgres Proは通常エラーを報告し、現在のトランザクションを中止します。</font><font style="vertical-align: inherit;">zero_damaged_pa​​gesパラメータが有効になっている場合、システムは代わりに警告を表示し、メモリ内の破損したページをクリアして、処理を続行します。</font><font style="vertical-align: inherit;">この動作により、データ、つまり破損したページのすべての行が破壊されます。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> オプションをオンにして、完全なバキュームテーブルを作成してみます。</font></font><br>
<br>
<pre><code class="plaintext hljs">VACUUM FULL VERBOSE</code></pre><br>
<img src="https://habrastorage.org/webt/ft/ym/m1/ftymm1cwyqwpdunlfmecfa1seas.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、失敗。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同様のエラーが発生しました：</font></font><br>
<br>
<pre><code class="plaintext hljs">INFO: vacuuming "“public.ws_log_smevlog”<font></font>
WARNING: invalid page in block 4123007 of relation base/16400/21396989; zeroing out page<font></font>
ERROR: unexpected chunk number 573 (expected 565) for toast value 21648541 in pg_toast_106070</code></pre><br>
<i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_toast-</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同じページに収まらない場合にPostgresに「長いデータ」を保存するメカニズム（デフォルトでは8kb）。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">試行2：インデックスを再作成する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のグーグルのヒントは役に立ちませんでした。</font><font style="vertical-align: inherit;">数分検索した後、2つ目のヒントが見つかりました</font><font style="vertical-align: inherit;">。破損したテーブルの</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスを再作成</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">してください。</font><font style="vertical-align: inherit;">私は多くの場所でこのアドバイスに会いましたが、自信を刺激するものではありませんでした。</font><font style="vertical-align: inherit;">インデックスを再作成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">reindex table ws_log_smevlog</code></pre><br>
<img src="https://habrastorage.org/webt/km/kx/ny/kmkxnywf16bm7hywt5wu-zchofq.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インデックスの再作成は</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">問題なく完了しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、これは役に立たず、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM FULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は同様のエラーでクラッシュしました。</font><font style="vertical-align: inherit;">私は失敗に慣れていたので、インターネットでさらにアドバイスを探し始め、かなり興味深い</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を見つけました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">試行3：SELECT、LIMIT、OFFSET</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記の記事では、テーブルを1行ずつ見て、問題のあるデータを削除することを提案しました。</font><font style="vertical-align: inherit;">まず、すべての行を確認する必要がありました。</font></font><br>
<br>
<pre><code class="plaintext hljs">for ((i=0; i&lt;"Number_of_rows_in_nodes"; i++ )); do psql -U "Username" "Database Name" -c "SELECT * FROM nodes LIMIT 1 offset $i" &gt;/dev/null || echo $i; done</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私の場合、テーブルには</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1,628,991</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行が</font><font style="vertical-align: inherit;">含まれてい</font><i><font style="vertical-align: inherit;">ました</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">良い意味で</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、データ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">分割に</font></a><font style="vertical-align: inherit;">注意する必要がありました</font><font style="vertical-align: inherit;">が、これは別の議論のトピックです。</font><font style="vertical-align: inherit;">土曜日だったので、このコマンドをtmuxで実行してスリープしました。</font></font><br>
<br>
<pre><code class="plaintext hljs">for ((i=0; i&lt;1628991; i++ )); do psql -U my_user -d my_database -c "SELECT * FROM ws_log_smevlog LIMIT 1 offset $i" &gt;/dev/null || echo $i; done</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
朝までに調子を確認することにしました。</font><font style="vertical-align: inherit;">驚いたことに、20時間でスキャンされたデータはわずか2％でした。</font><font style="vertical-align: inherit;">50日も待てなかった。</font><font style="vertical-align: inherit;">別の完全な失敗。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、私はあきらめませんでした。</font><font style="vertical-align: inherit;">なぜこんなにスキャンに時間がかかったのだろう。</font><font style="vertical-align: inherit;">ドキュメントから（再びpostgresproについて）私は見つけました：</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OFFSETは、行の生成を開始する前に、指定された行数をスキップすることを示します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
OFFSETとLIMITの両方が指定されている場合、システムはまずOFFSET行をスキップしてから、LIMITを制限するために行のカウントを開始します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
LIMITを使用する場合、結果行が特定の順序で返されるようにORDER BY句を使用することも重要です。</font><font style="vertical-align: inherit;">そうしないと、予測できない文字列のサブセットが返されます。</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明らかに、上記のコマンドには誤りがありました。最初に、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">による順序</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">がなかった</font><i><font style="vertical-align: inherit;">ため</font></i><font style="vertical-align: inherit;">、結果が誤っている可能性があります。</font><font style="vertical-align: inherit;">次に、Postgresは最初にOFFSET行をスキャンしてスキップする必要があり、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OFFSET</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が増加すると</font><i><font style="vertical-align: inherit;">、</font></i><font style="vertical-align: inherit;">パフォーマンスはさらに低下します。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">試行4：テキスト形式でダンプを削除する</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、一見素晴らしいアイデアが浮かびました。テキスト形式のダンプを削除し、最後に記録された行を分析することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、最初に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ws_log_smevlog</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テーブルの構造を見てみ</font><i><font style="vertical-align: inherit;">ましょう</font></i><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/hv/_u/qk/hv_uqkxblnoxsivawvjrwepqyz8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、</font><font style="vertical-align: inherit;">行の一意の識別子（カウンター）を含む</font><font style="vertical-align: inherit;">列</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「id」</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">計画はこれでした：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキスト形式（SQLコマンドの形式）でダンプの削除を開始します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ある時点で、エラーのためにダンプが中断されますが、テキストファイルは引き続きディスクに保存されます。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テキストファイルの最後を見ると、正常に撮影された最後の行の識別子（id）が見つかります。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テキスト形式でダンプを削除し始めました：</font></font><br>
<br>
<pre><code class="plaintext hljs">pg_dump -U my_user -d my_database -F p -t ws_log_smevlog -f ./my_dump.dump</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ダンプダンプは、予想通り、同じエラーで中断されました。</font></font><br>
<br>
<pre><code class="plaintext hljs">pg_dump: Error message from server: ERROR: invalid page in block 4123007 of relatton base/16490/21396989</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テール</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を介して</font><font style="vertical-align: inherit;">、ダンプの最後（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テール-5 ./my_dump.dump</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">を調べたところ、</font><font style="vertical-align: inherit;">ID </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">186 525の</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行でダンプが中断されていることがわかりました</font><font style="vertical-align: inherit;">。 「つまり、問題はID 186 526の行にあり、壊れているため、削除する必要があります。」と思った。しかし、データベースに</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">select * from ws_log_smevlog where id = 186529</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">」</font><font style="vertical-align: inherit;">というリクエストを</font><i><font style="vertical-align: inherit;">出したところ</font></i><font style="vertical-align: inherit;">、この行ですべてが正常であることが判明しました。インデックス186 530から186 540の行も問題なく機能しました。別の「素晴らしいアイデア」は失敗した。後でこれがなぜ起こったのか理解しました：テーブルからデータを削除/変更すると、それらは物理的に削除されませんが、「</font><i><font style="vertical-align: inherit;">デッドタプル</font></i><font style="vertical-align: inherit;">」としてマークされます、そして</font><i><font style="vertical-align: inherit;">自動バキューム</font></i><font style="vertical-align: inherit;">が来ます</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これらの行を削除済みとしてマークし、これらの行を再び使用できるようにします。</font><font style="vertical-align: inherit;">理解すると、テーブル内のデータが変更され、autovacuumがオンになっている場合、それらは順番に格納されません。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">試行5：SELECT、FROM、WHERE id =</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
失敗は私たちをより強くします。</font><font style="vertical-align: inherit;">あなたは決してあきらめるべきではありません。最後まで行き、自分と自分の能力を信じる必要があります。</font><font style="vertical-align: inherit;">そこで、もう1つオプションを試すことにしました。データベースのすべてのエントリを一度に1つずつ表示するだけです。</font><font style="vertical-align: inherit;">テーブルの構造（上記を参照）がわかっているので、一意の（主キー）idフィールドがあります。</font><font style="vertical-align: inherit;">テーブルには、1,628,991行があり、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が順番に並んでいます。つまり、一度に1つずつ繰り返すことができます。</font></font><br>
<br>
<pre><code class="plaintext hljs">for ((i=1; i&lt;1628991; i=$((i+1)) )); do psql -U my_user -d my_database  -c "SELECT * FROM ws_log_smevlog where id=$i" &gt;/dev/null || echo $i; done</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
誰かが理解できない場合、コマンドは次のように機能します。テーブルを1行ずつスキャンしてstdoutを</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ dev / null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に</font><font style="vertical-align: inherit;">送信し</font><i><font style="vertical-align: inherit;">ます</font></i><font style="vertical-align: inherit;">が、SELECTコマンドが失敗すると、エラーテキストが表示され（stderrがコンソールに送信されます）、エラーを含む行が出力されます（||に感謝します。 selectに問題があったことを意味します（コマンドの戻りコードは0ではありません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私は幸運で、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">id</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールドにインデックスを作成しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/k2/yf/tp/k2yftpsxvdq0rtcq_vvrscn0xoq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、目的のIDを持つ行を見つけるのにそれほど時間がかからないことを意味します。</font><font style="vertical-align: inherit;">理論的には、うまくいくはずです。</font><font style="vertical-align: inherit;">さて、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tmux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">で</font><font style="vertical-align: inherit;">コマンドを実行して、</font><font style="vertical-align: inherit;">スリープ状態にします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
朝までに、約90,000件のレコードが表示されたことがわかりました。これは5％強です。</font><font style="vertical-align: inherit;">従来の方法（2％）と比較して優れた結果！</font><font style="vertical-align: inherit;">でも20日も待ちたくなかった...</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">試行6：SELECT、FROM、WHERE id&gt; =およびid &lt;</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
優れたサーバーがデータベースの下でお客様に割り当てられました。デュアルプロセッサー</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">インテルXeon E5-2697 v2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、私たちの場所には48スレッドもありました！</font><font style="vertical-align: inherit;">サーバーの負荷は平均的で、問題なく約20スレッドを取得できました。</font><font style="vertical-align: inherit;">RAMも十分でした：384ギガバイトも！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、コマンドは並列化する必要がありました。</font></font><br>
<br>
<pre><code class="plaintext hljs">for ((i=1; i&lt;1628991; i=$((i+1)) )); do psql -U my_user -d my_database  -c "SELECT * FROM ws_log_smevlog where id=$i" &gt;/dev/null || echo $i; done</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは美しくエレガントなスクリプトを書くことができましたが、並列化する最も速い方法を選択しました。手動で範囲0-1628991を100,000レコードの間隔に分割し、フォームの16個のコマンドを個別に実行します。</font></font><br>
<br>
<pre><code class="plaintext hljs">for ((i=N; i&lt;M; i=$((i+1)) )); do psql -U my_user -d my_database  -c "SELECT * FROM ws_log_smevlog where id=$i" &gt;/dev/null || echo $i; done</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、それだけではありません。</font><font style="vertical-align: inherit;">理論的には、データベースへの接続には、ある程度の時間とシステムリソースもかかります。</font><font style="vertical-align: inherit;">1,628,991を接続することはあまり合理的ではありませんでした。</font><font style="vertical-align: inherit;">したがって、1つの接続ではなく1つの接続で1000行を抽出してみましょう。</font><font style="vertical-align: inherit;">その結果、チームは次のように変わりました。</font></font><br>
<br>
<pre><code class="plaintext hljs">for ((i=N; i&lt;M; i=$((i+1000)) )); do psql -U my_user -d my_database  -c "SELECT * FROM ws_log_smevlog where id&gt;=$i and id&lt;$((i+1000))" &gt;/dev/null || echo $i; done</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
tmuxセッションで16個のウィンドウを開き、次のコマンドを実行します。</font></font><br>
<blockquote><pre><code class="plaintext hljs">1) for ((i=0; i&lt;100000; i=$((i+1000)) )); do psql -U my_user -d my_database  -c "SELECT * FROM ws_log_smevlog where id&gt;=$i and id&lt;$((i+1000))" &gt;/dev/null || echo $i; done<font></font>
2) for ((i=100000; i&lt;200000; i=$((i+1000)) )); do psql -U my_user -d my_database  -c "SELECT * FROM ws_log_smevlog where id&gt;=$i and id&lt;$((i+1000))" &gt;/dev/null || echo $i; done<font></font>
…<font></font>
15) for ((i=1400000; i&lt;1500000; i=$((i+1000)) )); do psql -U my_user -d my_database -c "SELECT * FROM ws_log_smevlog where id&gt;=$i and id&lt;$((i+1000))" &gt;/dev/null || echo $i; done<font></font>
16) for ((i=1500000; i&lt;1628991; i=$((i+1000)) )); do psql -U my_user -d my_database  -c "SELECT * FROM ws_log_smevlog where id&gt;=$i and id&lt;$((i+1000))" &gt;/dev/null || echo $i; done</code></pre></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">翌日、最初の結果が出ました！</font><font style="vertical-align: inherit;">つまり（値XXXとZZZは保持されていません）：</font></font><br>
<br>
<pre><code class="plaintext hljs">ERROR:  missing chunk number 0 for toast value 37837571 in pg_toast_106070<font></font>
829000<font></font>
ERROR:  missing chunk number 0 for toast value XXX in pg_toast_106070<font></font>
829000<font></font>
ERROR:  missing chunk number 0 for toast value ZZZ in pg_toast_106070<font></font>
146000</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、3行にエラーが含まれていることを意味します。</font><font style="vertical-align: inherit;">最初と2番目の問題レコードのIDは829,000〜830,000で、3番目のIDは146,000〜147,000でした。次に、問題レコードの正確なID値を見つける必要がありました。</font><font style="vertical-align: inherit;">これを行うには、手順1で問題のあるレコードの範囲を調べ、IDを特定します。</font></font><br>
<blockquote><pre><code class="plaintext hljs">for ((i=829000; i&lt;830000; i=$((i+1)) )); do psql -U my_user -d my_database -c "SELECT * FROM ws_log_smevlog where id=$i" &gt;/dev/null || echo $i; done<font></font>
829417<font></font>
ERROR:  unexpected chunk number 2 (expected 0) for toast value 37837843 in pg_toast_106070<font></font>
829449<font></font>
for ((i=146000; i&lt;147000; i=$((i+1)) )); do psql -U my_user -d my_database -c "SELECT * FROM ws_log_smevlog where id=$i" &gt;/dev/null || echo $i; done<font></font>
829417<font></font>
ERROR:  unexpected chunk number ZZZ (expected 0) for toast value XXX in pg_toast_106070<font></font>
146911</code></pre></blockquote><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ハッピーエンド</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題のあるラインが見つかりました。</font><font style="vertical-align: inherit;">psqlを介してデータベースに入り、それらを削除しようとします。</font></font><br>
<br>
<pre><code class="plaintext hljs">my_database=# delete from ws_log_smevlog where id=829417;<font></font>
DELETE 1<font></font>
my_database=# delete from ws_log_smevlog where id=829449;<font></font>
DELETE 1<font></font>
my_database=# delete from ws_log_smevlog where id=146911;<font></font>
DELETE 1</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
驚いたことに、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zero_damaged_pa​​ges</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">オプションを指定しなくても、エントリは問題なく削除されました</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、データベースに接続し、</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM FULLを作成し</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（これを行う必要はなかったと思います）、最後に</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pg_dump</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用してバックアップを正常に削除しました</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ダンプにエラーなしでスターが付けられました！</font><font style="vertical-align: inherit;">問題はそのような愚かな方法で解決されました。</font><font style="vertical-align: inherit;">喜びに限界はありませんでした。多くの失敗の後、私たちはなんとか解決策を見つけました！</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">謝辞と結論</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、実際のP​​ostgresデータベースを復元する初めての経験です。</font><font style="vertical-align: inherit;">私はこの経験を長い間覚えています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に、PostgresProにロシア語に翻訳されたドキュメント</font><font style="vertical-align: inherit;">と、問題の分析に大いに役立つ</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">完全に無料のオンラインコース</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に感謝</font><font style="vertical-align: inherit;">します。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja477230/index.html">教育ソフトウェアの歴史：学生向けの最初のパソコン、教育ゲーム、ソフトウェア</a></li>
<li><a href="../ja477234/index.html">Мышь, поставившая крест на проводных собратьях</a></li>
<li><a href="../ja477236/index.html">米国の裁判所、州がネットワークの中立性を取り戻すことを許可</a></li>
<li><a href="../ja477238/index.html">カルマに加えて：スタックオーバーフローが批判される理由と、コミュニティの毒性について多くの人が不満を言う理由</a></li>
<li><a href="../ja477242/index.html">ServiceDeskの選択方法。パート3</a></li>
<li><a href="../ja477250/index.html">では、電卓でWindows 10を実行したいですか？はい</a></li>
<li><a href="../ja477252/index.html">ビジネスインキュベーターとアクセラレーターの開発方法：Thomas Edisonの研究室からY Combinatorまで</a></li>
<li><a href="../ja477254/index.html">XSS、CSRF、フラッシュ認証。r0ot-mi Webによる問題解決—クライアント。パート2</a></li>
<li><a href="../ja477256/index.html">ソユーズロケットでのOneWebの最初の本格的な打ち上げは、アンガラロケットの打ち上げと同様に、来年延期されます</a></li>
<li><a href="../ja477262/index.html">Promobot社のAndroid。外からの眺め</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>