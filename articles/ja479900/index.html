<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👌🏽 🧘🏼 👩‍👦 ゲーム会社の顧客指向のデータレイク 🙏🏼 🏕️ 👩🏼‍🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ソース
 
 こんにちは、Habr！私の名前はMaxim Pchelinです。MyGames（Mail.ru Groupのゲーム部門）でBI-DWHの開発を率いています。この記事では、HighLoad ++ Moscow 2019でのDina Safinaとの話し合いに基づいて、クライアント指向のD...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>ゲーム会社の顧客指向のデータレイク</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/479900/"><img src="https://habrastorage.org/webt/ic/em/yw/icemywxszsrmzmrife7stz9ltpg.jpeg"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ソース</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
こんにちは、Habr！</font><font style="vertical-align: inherit;">私の名前はMaxim Pchelinです。MyGames（Mail.ru Groupのゲーム部門）でBI-DWHの開発を率いています。</font><font style="vertical-align: inherit;">この記事では、HighLoad ++ Moscow 2019でのDina Safinaとの話し合いに基づいて、クライアント指向のDataLakeストレージを構築した方法と理由について説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
記事は3つのパートで構成されています。</font><font style="vertical-align: inherit;">最初に、DataLakeを実装することにした理由を説明します。</font><font style="vertical-align: inherit;">第2部では、ストレージが機能し、データで満たされるようにするために使用するテクノロジーとソリューションについて説明します。</font><font style="vertical-align: inherit;">そして第3部では、サービスの品質を向上させるために私たちが何をしているのかを説明します。</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DataLakeに私たちをもたらしたもの</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たち</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MyGames</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はBI-DWH部門で働いており、データアナリスト用のリポジトリとビジネスユーザー（マネージャー、マーケティング担当者、ゲーム開発者など）向けの定期的なレポートサービスの2つのカテゴリのサービスを提供しています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">なぜそのような非標準のストレージなのですか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、BI-DWHはDataLakeストレージの実装を意味するものではないため、これを一般的なソリューションと呼ぶことはできません。そして、そのようなサービスはどのように構築されますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、会社にはプロジェクトがあります-私たちの場合、これはゲームです。プロジェクトには、ほとんどの場合データベースにデータを書き込むロギングシステムがあります。このベースの上に、将来の分析のための集計、メトリック、およびその他のエンティティのためのストアフロントが作成されます。シンプルなSQLクエリやExcelスプレッドシートからDSやML向けのJupyter Notebookまでの定期的なレポートやアドホック分析システムは、適切なBIツールを使用してストアフロントに基づいて構築されています。システム全体が1つの開発チームによってサポートされています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その会社で別の会社が生まれたとしましょう。その下に別の開発チームとインフラストラクチャがあることは魅力的ですが、費用がかかります。したがって、プロジェクトを「フックアップ」する必要があります。これは、データベースレベル、ストアフロントレベル、または少なくとも表示レベルで、さまざまな方法で実行できます。問題は解決されました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして、会社が3番目のプロジェクトを持っているなら？ 「共有」はすでにうまく終了していない可能性があります。リソースまたはアクセス権の割り当てに問題がある可能性があります。たとえば、プロジェクトの1つは、最初の2つのプロジェクトについて何も知る必要がない外部チームによって行われます。状況はより危険になっています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3つのプロジェクトではなく、もっと多くのプロジェクトがあると想像してください。そして、たまたまこれはまさに私たちのケースです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MyGamesはMail.ru Groupの最大の部門の1つであり、ポートフォリオには150のプロジェクトがあります。さらに、それらはすべて非常に異なります。独自の開発であり、ロシアでの運用のために購入しました。 PC、Xbox、プレイステーション、iOS、Androidなど、さまざまなプラットフォームで動作します。これらのプロジェクトは、世界中の10のオフィスで開発され、何百人もの意思決定者がいます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/6y/33/c5/6y33c5pfbswcdiqeikzuptzbs9k.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これはビジネスに最適ですが、BI-DWHチームのタスクが複雑になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちのゲームでは、多くのプレイヤーアクションがログに記録されます。彼がゲームに参加したとき、どこでどのようにレベルを獲得したか、誰とどのくらい成功したか、何をどの通貨で購入したかです。ゲームごとにこのすべてのデータを収集する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、企業がプロジェクトに関する質問への回答を受け取るために必要です。</font><font style="vertical-align: inherit;">アクションの開始後、先週何が起こりましたか？</font><font style="vertical-align: inherit;">来月の収益またはゲームサーバー容量の使用についての私たちの予測は何ですか？</font><font style="vertical-align: inherit;">これらの予測に影響を与えるために何ができますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MyGamesがプロジェクトに開発パラダイムを課さないことが重要です。</font><font style="vertical-align: inherit;">各ゲームスタジオは、より効率的であると見なしてデータを記録します。</font><font style="vertical-align: inherit;">一部のプロジェクトはクライアント側でログを生成し、サーバー側でログを生成します。</font><font style="vertical-align: inherit;">RDBMSを使用して収集するプロジェクトもあれば、Kafka、Elasticsearch、Hadoop、Tarantool、Redisなどのまったく異なるツールを使用するプロジェクトもあります。</font><font style="vertical-align: inherit;">そして、リポジトリにアップロードするために、これらのデータのソースを利用します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのBI-DWHに何が欲しいですか？</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、毎日の運用タスクと戦略的タスクの両方を解決するために、BI-DWH部門からすべてのBIゲームからデータを受け取りたいと考えています。レベルの最後にひどいモンスターを生む命の数から始まり、企業内のリソースを適切に割り当てる方法で終わる：どのプロジェクトがより多くの開発者を提供するか、誰がマーケティング予算を割り当てるか。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
信頼性も期待されます。私たちは大きな会社で働いており、「昨日働いていたが、今日はシステムが整っており、何かを考え出せば1週間しか上がらない」という原則では生きられない。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
彼らは私たちからの節約を望んでいます。鉄を購入するか、人を雇うことで、すべての問題を解決したいと思います。しかし、私たちは商業組織であり、それを買う余裕はありません。私たちは会社を利益にしようとします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重要なのは、彼らは私たちに顧客重視を求めているということです。この場合のクライアントは、私たちの消費者、顧客、マネージャ、アナリストなどです。私たちはゲームに適応し、顧客が私たちと協力するのに便利な方法で作業する必要があります。たとえば、場合によっては、アジア市場でプロジェクトを運営のために購入すると、ゲームと一緒に中国語の名前のベースを取得できます。そして、中国語でこれらの拠点のドキュメント。中国語を理解しているETL開発者を探すか、ゲームのデータのダウンロードを拒否することもできますが、代わりに、チームと私は会議室に閉じ込め、時間をかけてプレイを始めます。ゲームに出入りし、購入し、撃ち、死ぬ。そして、このテーブルまたはそのテーブルに何がいつ表示されるかを確認します。次に、ドキュメントを作成し、それに基づいてETLを構築します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、エッジを感じることが重要です。 50人のDAUを持つゲームのユニークなログを掘り下げる場合、近くのDAUが500,000のプロジェクトを支援する必要があるときは、許容できない贅沢です。したがって、もちろん、カスタムソリューションの構築に多くの労力を費やすことができますが、それはビジネスで本当に必要な場合に限られます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ただし、開発者、特に初心者がこの方法で適応する必要があると聞くとすぐに、決してそうしたくないと望んでいます。どの開発者も、理想的なアーキテクチャを作りたいと思っています。決して変更せず、Habrでそれに関する記事を書いてください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、ゲームへの適応をやめるとどうなりますか？単一の入力APIにデータを送信するように要求し始めたとしますか？結果は1つになります-誰もが分散し始めます。</font></font><br>
<br>
<ul>
<li>     BI-DWH ,    .            .<br>
</li>
<li>      BI-DWH,       .      ,   .<br>
</li>
<li>    —         ,    . <br>
</li>
</ul><br>
<h3>     -?</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
150のプロジェクトはたくさんあります。すべての人にすぐにソリューションを実装するのは長すぎます。ビジネスは、最初の結果が表示されるまで1年も待ちません。したがって、最大の収益をもたらす3つのプロジェクトを取り、それらの最初のプロトタイプを実装しました。それらから主要なデータを収集し、最も人気のあるメトリック（DAU、MAU、収益、登録、保持、および少しの経済性と予測）を備えた基本的なダッシュボードを作成したいと考えました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これには、プロジェクト自体のゲームベースを使用できませんでした。第一に、これは複数のデータベースからのデータを組み合わせる必要があるため、クロスデザイン分析をより困難にします。次に、ゲーム自体がこれらのデータベースの上で動作します。これは、マスターとレプリカが過負荷にならないようにするために重要です。最後に、すべてのゲームは、ある時点で、データベースで不要なすべてのデータ履歴を削除します。これは、分析には受け入れられません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、唯一のオプションは、分析に必要なすべてを1か所に集めることです。</font><font style="vertical-align: inherit;">この時点で、リレーショナルデータベースやプレーンテキストリポジトリが適していました。</font><font style="vertical-align: inherit;">BIを台無しにして、ダッシュボードを作成します。</font><font style="vertical-align: inherit;">このようなソリューションの組み合わせには多くのオプションがあります。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/vx/1e/hm/vx1ehmdjxzv-nimt1x3_ivm3sd8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、後で他の150ゲームすべてをカバーする必要があることを理解しました。</font><font style="vertical-align: inherit;">おそらく、いくつかのクラスターリレーショナルデータベースは、生成された大量のデータを処理できます。</font><font style="vertical-align: inherit;">しかし、ソースは完全に異なるシステムにあるだけでなく、非常に異なるデータ構造も持っています。</font><font style="vertical-align: inherit;">リレーショナル構造、Data Vaultなどに出会います。</font><font style="vertical-align: inherit;">複雑で面倒なトリックがなければ、これらすべてを1つのデータベースに入れることはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、DataLakeを構築する必要があることがわかりました。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DataLakeの実装</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、DataLakeストレージは構造化されていないデータを格納できるため、私たちの条件に適しています。</font><font style="vertical-align: inherit;">DataLakeは、RDBMSからJSON（KafkaまたはMongoから出荷されるテーブル）まで、あらゆる種類のソースの単一のエントリポイントになることができます。</font><font style="vertical-align: inherit;">その結果、DataLakeは、さまざまなコンシューマー（SQL、Python、R、Sparkなど）のインターフェースに基づいて実装されたクロスデザイン分析の基礎になることができます。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hadoopに切り替える</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DataLakeでは、明白なソリューションであるHadoopを選択しました。具体的には、Clouderaからのアセンブリです。 Hadoopを使用すると、非構造化データを操作でき、データノードを追加することで簡単に拡張できます。さらに、この製品はよく研究されているため、発生した質問に対する回答はStackoverflowで見つけることができ、研究開発にリソースを費やすことはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hadoopを実装した後、最初の単一ストレージの次の図を取得しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/95/fn/2u/95fn2uesgfvlgfqrxdohrfnltsa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データは少数のソースからHadoopで収集され、次にいくつかのインターフェースがピットインされました：アドホック分析用のBIツールとサービス。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
さらに予期せぬ出来事が発生しました。Hadoopはすばらしい動きを見せ、データがストアに流れ込んだ消費者は古い分析システムを放棄し、仕事に毎日新しい製品を使い始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし問題が発生しました。あなたがやればやるほど、彼らはあなたからもっと欲しがります。</font><font style="vertical-align: inherit;">すぐに、すでにHadoopに統合されているプロジェクトは、より多くのデータを要求し始めました。</font><font style="vertical-align: inherit;">そして、まだ追加されていないプロジェクトは、それを求め始めました。</font><font style="vertical-align: inherit;">安定性に対する要求は急激に高まり始めました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
同時に、単純にチームを直線的に増やすことは合理的ではありません。</font><font style="vertical-align: inherit;">2人のDWH開発者が2つのプロジェクトに対処する場合、4つのプロジェクトでは、さらに2人の開発者を雇うことはできません。</font><font style="vertical-align: inherit;">したがって、最初に私たちは別の方法で行きました。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プロセス確立</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リソースが限られている場合、最も安価なソリューションはプロセスを調整することです。</font><font style="vertical-align: inherit;">さらに、大企業では、ストレージアーキテクチャを考案して実装するだけでは不可能です。</font><font style="vertical-align: inherit;">膨大な数の人と交渉する必要があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">まず、分析にリソースを割り当てるビジネス担当者と。</font><font style="vertical-align: inherit;">ビジネスに利益をもたらす顧客からのタスクのみを実装する必要があることを証明する必要があります。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">また、アナリストと交渉して、アナリストが提供するサービス（システム分析、ビジネス分析、テスト）と引き換えに何かを与える必要もあります。</font><font style="vertical-align: inherit;">たとえば、データソースのシステム分析をアナリストに提供しました。</font><font style="vertical-align: inherit;">もちろん、彼らは幸せではありませんが、それ以外の場合は誰もそれを行うことはできません。</font></font><br>
</li>
<li>        :  SLA     .     ,   ,       ,      . <br>
</li>
<li>       :     ,     ,   ,    ,       . <br>
</li>
<li>        . ,       ,       DevOps-. <br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で、そのようなバージョンのリポジトリーが設定されたすべての目標を満たしていれば、記事を終えることができます。</font><font style="vertical-align: inherit;">しかし、これはそうではありません。</font><font style="vertical-align: inherit;">どうして？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hadoopが登場する前は、5つのプロジェクトのデータと統計を提供できました。</font><font style="vertical-align: inherit;">Hadoopの実装により、チームを増やすことなく、10のプロジェクトをカバーすることができました。</font><font style="vertical-align: inherit;">プロセスを確立した後、私たちのチームはすでに15のプロジェクトに貢献しています。</font><font style="vertical-align: inherit;">すばらしいですが、150のプロジェクトがあります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">気流の実装</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、Cronを使用してソースからデータを収集しました。 2つのプロジェクトは正常です。 10-痛いけど大丈夫。ただし、現在、約12,000のプロセスが読み込まれ、150のプロジェクトからDataLakeに読み込まれます。 Cronはもはや適切ではありません。これを行うには、データダウンロードストリームを管理するための強力なツールが必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちはオープンソースのタスクマネージャーAirflowを選びました。彼はAirbnbの腸で生まれ、その後アパッチに転勤しました。これは、コード駆動型ETL用のツールです。つまり、Pythonでスクリプトを記述し、DAG（有向非巡回グラフ）に変換します。 DAGは、タスク間の依存関係を維持するのに最適です。まだロードされていないデータを使用してストアフロントを構築することはできません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Airflowには優れたエラーハンドラがあります。</font><font style="vertical-align: inherit;">プロセスがクラッシュするか、ネットワークに問題がある場合、ディスパッチャは指定された回数だけプロセスを再起動します。</font><font style="vertical-align: inherit;">たとえば、ソースのテーブルが変更されたなど、多くの失敗がある場合は、通知メッセージが届きます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Airflowには優れたUIがあります。実行中のプロセス、正常に完了したプロセス、またはエラーが発生したプロセスを表示します。</font><font style="vertical-align: inherit;">エラーが発生してタスクが落ちた場合は、インターフェイスからタスクを再起動し、コードにアクセスすることなく、監視を通じてプロセスを制御できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カスタマイズ可能なAirflow。オペレーターの上に構築されています。これらは特定のソースを操作するためのプラグインです。</font><font style="vertical-align: inherit;">一部のオペレーターはそのまま使用でき、多くのオペレーターがAirflowコミュニティーを作成しています。</font><font style="vertical-align: inherit;">必要に応じて、独自の演算子を作成できます。このためのインターフェースは非常に簡単です。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">気流をどのように使用しますか？ </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、PostgreSQLからHadoopにテーブルをロードする必要があります。タスク</font></font><code>sql_sensor_battle_log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、昨日のデータが必要かどうかを確認します。存在する場合、タスク</font></font><code>load_stg_data_from_battle_log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">はPGからデータを取得し、Hadoopに追加します。最後に、</font></font><code>load_oda_data_from_battle_log</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">初期処理を実行します。たとえば、Unix Timeから人間が読める時間に変換します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような一連のタスクでは、データは1つのソースの1つのエンティティから取得され</font><font style="vertical-align: inherit;">
ます。つまり</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/347/38d/4af/34738d4afc911f105891070f97f90097.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、1つのソースから必要なすべてのエンティティから</font><font style="vertical-align: inherit;">取得され</font></font><br>
<br>
<img src="https://habrastorage.org/webt/bs/2i/ne/bs2ines-6me7a6f677u7rc4wgac.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。DAGはこのダウンロードセットです。現時点では、生データの読み込み、処理、変換、ストアフロントの作成を行うDAGが250個あります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新された統合ストレージスキームは次のとおりです。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/a4/9m/ag/a49magbaiqyrtasd2awg6mqnjmk.jpeg"><br>
<br>
<ol>
<li>  Airflow         —  400 .     (  ),   :   ,  API.  Airflow       12  ,       150 . <br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dina Safina（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://habr.com/ru/company/mailru/blog/344398/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）とYura Emelyanov（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://habr.com/ru/company/mailru/blog/）</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font><font style="vertical-align: inherit;">Airflowの</font><font style="vertical-align: inherit;">詳細について記事を書いています</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">339392 /</font></a><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">また、Telegram（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://t.me/ruairflow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）の</font><font style="vertical-align: inherit;">Airflowコミュニティに参加して</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ください</font></a><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ドキュメントの助けを借りてAirflowに関する多くの質問を解決できますが、場合によってはより多くのカスタムリクエストが表示されます。AirflowをDockerにパックする方法、3日目が機能しない理由などすべてです。</font><font style="vertical-align: inherit;">これはこのコミュニティで回答できます。</font></font><br>
</li>
</ol><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DataLakeで何を改善するか</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この時点で、DWH開発者はすべての準備が整っていると確信しているので、落ち着くことができます。</font><font style="vertical-align: inherit;">残念ながら、または幸運にも、DataLakeにはまだ改善すべき点があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">データ品質</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DataLakeには多数のテーブルがあるため、データ品質が最初に低下します。</font><font style="vertical-align: inherit;">たとえば、支払いのテーブルを見てみましょう。</font><font style="vertical-align: inherit;">user_id、金額、支払い日時が含まれます。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/998/c18/2df/998c182df294a894a55c0c7822eead23.png" width="400"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
毎日約1万回の支払いが発生します</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/42a/a6c/2e4/42aa6c2e48be1417dc2fd4e228d55a34.png" width="400"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。テーブルに入ると、1日あたり28のエントリしかテーブルに届きません。</font><font style="vertical-align: inherit;">はい、user_idはすべて空です。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b97/1ff/429/b971ff429ea1fa66d17d3d556727b56f.png" width="200"></div><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6b5/055/af6/6b5055af6affe4417834ee051947e57c.png" width="400"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソースで何かが突然壊れた場合、Airflowのおかげですぐにそれを知ることができます。</font><font style="vertical-align: inherit;">しかし、正式にデータがあり、正しい形式であっても、その内訳についてはすぐにはわかりませんし、すでにデータの利用者からもわかりません。</font><font style="vertical-align: inherit;">自分の手で5000テーブルをチェックするのは現実的ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを防ぐために、独自のデータ品質管理（DQ）システムを開発しました。</font><font style="vertical-align: inherit;">リポジトリへの主要なダウンロードを毎日監視します。行数の急激な変化を追跡し、空のフィールドを探し、データの重複をチェックします。</font><font style="vertical-align: inherit;">システムは、アナリストからのカスタムチェックも適用します。</font><font style="vertical-align: inherit;">これに基づいて、彼女は何がどこで問題があったかについてメールに通知を送信します。</font><font style="vertical-align: inherit;">アナリストはプロジェクトに行って、たとえばデータが少なすぎる理由を見つけ、その理由を取り除き、データをリロードします。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ダウンロードを優先する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DataLakeにデータをロードするタスクの数が増えると、優先順位の競合がすぐに発生します。</font><font style="vertical-align: inherit;">通常の状況：それほど重要ではないプロジェクトでは、夜間にダウンロードですべてのリソースを消費し、トップマネジメントのメトリックを計算するために必要なテーブルには、稼働日の初めまでにロードする時間がありません。</font><font style="vertical-align: inherit;">これにはいくつかの方法で対処します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">キーのダウンロードの監視。</font><font style="vertical-align: inherit;">Airflowには独自のSLAシステムがあり、すべてのキーが時間どおりに来たかどうかを判断できます。</font><font style="vertical-align: inherit;">一部のデータが読み込まれていない場合は、ユーザーよりも数時間早くこのことを確認し、修正する時間があります。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">優先順位の設定。</font><font style="vertical-align: inherit;">これを行うには、Airflowキューと優先システムを使用します。</font><font style="vertical-align: inherit;">これにより、DAGの読み込み順序と、DAG内の並列プロセスの数を決定できます。</font><font style="vertical-align: inherit;">上位管理指標のデータをダウンロードする前に、四半期に1回分析されるログをアップロードしても意味がありません。</font></font><br>
</li>
</ul><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">夜間バッチの継続時間の監視</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
バッチ保管があります。</font><font style="vertical-align: inherit;">夜間は作成中です。毎日のバッチを処理するのに十分な夜があることを確認することが重要です。</font><font style="vertical-align: inherit;">さもなければ、勤務時間中、アナリストは仕事のための十分なストレージリソースを持っていません。</font><font style="vertical-align: inherit;">この問題は、いくつかの方法で定期的に解決しています。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">逆スケーリング。</font><font style="vertical-align: inherit;">すべてのデータを出荷するのではなく、アナリストが必要とするものだけを出荷します。</font><font style="vertical-align: inherit;">ロードされたすべてのテーブルを監視し、そのうちの1つが6か月間使用されない場合、そのロードを無効にします。</font></font><br>
</li>
<li> .   ,     ,     ,   -  Hadoop. <br>
</li>
<li>  Airflow.   ,             . <br>
</li>
<li>  .  ,     ,      5 .     ,      2 .  -       ,         . <br>
</li>
</ul><br>
<h3>  </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
稼働日の開始に向けてリポジトリの準備を完了する時間を確保するだけでなく、その後のリソースの可用性を監視することも重要です。</font><font style="vertical-align: inherit;">これにより、時間の経過とともに問題が発生する可能性があります。</font><font style="vertical-align: inherit;">まず、その理由は、アナリストが次善のクエリを作成するためです。</font><font style="vertical-align: inherit;">繰り返しになりますが、アナリスト自身もますます増えています。</font><font style="vertical-align: inherit;">この場合の最も簡単なことは、ハードウェアの容量を増やすことです。</font><font style="vertical-align: inherit;">ただし、最適化されていないリクエストは、利用可能なすべてのリソースを消費します。</font><font style="vertical-align: inherit;">つまり、遅かれ早かれ、大きな利益なしに鉄にお金を使い始めるでしょう。</font><font style="vertical-align: inherit;">したがって、他のいくつかのアプローチを使用します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引用：私たちはユーザーに少なくとも少しのリソースを残します。</font><font style="vertical-align: inherit;">はい、リクエストはゆっくりと実行されますが、少なくとも実行されます。</font></font><br>
</li>
<li>  :     ,      Hadoop       .…      ,     -  ,        .       ,      .         ,    .      . <br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">自発的強制ユーザートレーニング。</font><font style="vertical-align: inherit;">アナリストの仕事は、高品質のクエリをリポジトリに書き込むことではありません。</font><font style="vertical-align: inherit;">彼らの仕事はビジネスの質問に答えることです。</font><font style="vertical-align: inherit;">そして、私たち自身-リポジトリチーム-以外には、アナリストの要求の質を気にする人はいません。</font><font style="vertical-align: inherit;">したがって、私たちはFAQとプレゼンテーションを作成し、アナリスト向けに講義を行い、DataLakeをどのように使用できるか、およびどのようにできないかを説明します。</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実際、データを利用可能にすることに時間をかけることは、データを記入することよりもはるかに重要です。</font><font style="vertical-align: inherit;">データはストレージにあるが利用できない場合、ビジネスの観点からはまだそこにあり、ダウンロードするための努力はすでに費やされています。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アーキテクチャの柔軟性</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構築されたDataLakeの柔軟性を忘れないでください。また、入力要素を変更するときにアーキテクチャを変更することを恐れないでください。どのデータをストレージにアップロードする必要があるか、誰がどのように使用するかです。私たちは、私たちのアーキテクチャが常に変更されないままであることを信じていません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
たとえば、新しいモバイルゲームを立ち上げました。彼女はクライアントからJSONをNginxに書き込み、NginxはデータをKafkaにスローし、Sparkを使用してそれを解析してHadoopに入れます。すべてが機能し、タスクは閉じています。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/mj/2i/cq/mj2icqljg45ckemxfjwjp1idafy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
数か月が経過し、倉庫では夜間バッチのすべてのプロセスの実行時間が長くなり始めました。問題の解明に着手しました。ゲームの「ショット」、50倍のデータが生成され、SparkはJSON分析に対応できず、ストレージリソースの半分を引き出すことが判明しました。最初は、すべてのデータが1つのKafkaトピックに送信され、Sparkはそれらを異なるエンティティにソートしました。ゲームデベロッパーに、クライアント上のデータをさまざまなエンティティと共有し、それらを別々のKafkaトピックに注ぐよう依頼しました。それは簡単になりましたが、長い間ではありませんでした。次に、毎日のJSON分析から時間単位に切り替えることにしました。しかし、貯蔵施設は夜間だけでなく、24時間体制で建設され始めました。そのような試みの後、この問題を解決するために、Sparkを放棄してClickHouseを実装しました。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wv/xw/bo/wvxwbo1pgsxynb8u3lif75uttfw.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データを瞬時にテーブルに分解する優れたJSON解析エンジンを備えています。</font><font style="vertical-align: inherit;">最初にKafkaからClickHouseに情報を送信し、そこからHadoopで受け取ります。</font><font style="vertical-align: inherit;">これで問題は完全に解決しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、DataLakeリポジトリで動物園システムを繁殖させないようにしていますが、特定のタスクでは、最も適切なテクノロジーを選択するようにしています。</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">それは価値がありました？</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
品質管理システムであるHadoopを導入し、Airflowに対応し、ビジネスプロセスを確立する価値はありましたか？</font><font style="vertical-align: inherit;">もちろんそれは価値がありました：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ビジネスは、単一のサービスで利用可能なすべてのプロジェクトの情報を更新しました。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちのシステムのユーザーは、ゲームデザイナーからマネージャーまで、直感のみに基づいて決定を行うのをやめ、データドリブンアプローチに切り替えました。 </font></font><br>
</li>
<li>     ,      rocket science.       ,   ,  ,  . ,       BI-DWH.<br>
</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja479888/index.html">高速復元力のある圧縮（続き）</a></li>
<li><a href="../ja479890/index.html">モノのインターネットの概念を実装する際の問題とタスク</a></li>
<li><a href="../ja479892/index.html">Gradleプラグイン、分散システムでのマルチスレッド化、モニタリングの自動化について：Yandex.Money metapのビデオ</a></li>
<li><a href="../ja479894/index.html">Hyper-VからVMware、またはその逆：仮想ディスクの変換</a></li>
<li><a href="../ja479898/index.html">裸の真実</a></li>
<li><a href="../ja479902/index.html">IntelliJ IDEA 2019.3：パフォーマンスの最適化と品質の向上</a></li>
<li><a href="../ja479904/index.html">NFCとは何ですか？基本を更新しますか？</a></li>
<li><a href="../ja479906/index.html">FinTech業界の概要：2019年末の最も有望な金融技術</a></li>
<li><a href="../ja479908/index.html">AppleのAR / VRが残酷な現実に直面した方法</a></li>
<li><a href="../ja479910/index.html">tcpserverとnetcatを使用してKubernetesポッドまたはコンテナーでトンネルを開く方法</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>