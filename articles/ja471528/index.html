<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤾 👊🏽 🐺 docker swarmを使用してアプリをデプロイする ✉️ 🐩 🥋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="私たちが取り組んでいるオンラインビデオコンテンツの推奨システムは、クローズドな商用開発で​​あり、技術的には独自のオープンソースコンポーネントのマルチコンポーネントクラスタです。この記事の目的は、限られた時間内にプロセスの既存のワークフローを中断することなく、ステージングプラットフォームでのdock...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>docker swarmを使用してアプリをデプロイする</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471528/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちが取り組んでいるオンラインビデオコンテンツの推奨システムは、クローズドな商用開発で​​あり、技術的には独自のオープンソースコンポーネントのマルチコンポーネントクラスタです。</font><font style="vertical-align: inherit;">この記事の目的は、限られた時間内にプロセスの既存のワークフローを中断することなく、ステージングプラットフォームでのdocker swarm clusteringシステムの導入について説明することです。</font><font style="vertical-align: inherit;">あなたの注意に向けて提示される物語は2つの部分に分かれています。</font><font style="vertical-align: inherit;">最初の部分ではdocker swarmを使用する前のCI / CDについて説明し、2番目の部分では実装プロセスについて説明します。</font><font style="vertical-align: inherit;">最初の部分を読むことに興味がない人は、安全に次の部分に進むことができます。</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パートI</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
遠く離れた年には、CI / CDプロセスをできるだけ早く構成する必要がありました。</font><font style="vertical-align: inherit;">条件の1つは、</font><font style="vertical-align: inherit;">いくつかの理由により</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">開発されたコンポーネントの</font><i><font style="vertical-align: inherit;">デプロイに</font></i><font style="vertical-align: inherit;"> Dockerを使用しないことでした</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">本番環境でのコンポーネントのより信頼性が高く安定した動作のため（つまり、実際には、仮想化を使用しないという要件）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要な開発者はDockerを使用したくありませんでした（奇妙ですが、それだけでした）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">イデオロギー上の理由からR＆D管理</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MVPのインフラストラクチャ、スタック、およびサンプルの初期要件は次のとおりです。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debianを搭載した4つのIntel®X5650サーバー（完全に開発用のさらに強力なマシン）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カスタムコンポーネントの開発はC ++、Python3で実行されます</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サードパーティが使用する主なツール：Kafka、Clickhouse、Airflow、Redis、Grafana、Postgresql、Mysqlなど</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パイプラインコンポーネントのアセンブリとデバッグおよびリリースのための個別のテスト</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
初期段階で解決すべき最初の問題の1つは、カスタムコンポーネントを任意の環境（CI / CD）にデプロイする方法です。 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サードパーティのコンポーネントは、体系的にインストールして体系的に更新することを決定しました。 C ++またはPythonで開発されたカスタムアプリケーションは、いくつかの方法で展開できます。たとえば、システムパッケージの作成、収集したイメージのリポジトリへの送信、およびサーバーへのその後のインストール。不明な理由により、別の方法が選択されました。つまり、CIを使用して、実行可能アプリケーションファイルがコンパイルされ、仮想プロジェクト環境が作成され、requirements.txtからpyモジュールがインストールされ、これらすべてのアーティファクトが構成、スクリプト、および付随するアプリケーション環境とともにサーバーに送信されます。次に、管理者権限のない仮想ユーザーからアプリケーションが起動されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
CI / CDシステムとしてGitlab-CIが選択されました。結果のパイプラインは次のようになります。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/460/406/c27/460406c27d873dc28928ac3ba901f903.png" alt="画像"><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構造的に、gitlab-ci.ymlは次のようになりました</font></font></b><div class="spoiler_text"><pre><code class="xml hljs">---<font></font>
variables:<font></font>
  #     ,   <font></font>
  CMAKE_CPUTYPE: "westmere"<font></font>
<font></font>
  DEBIAN: "MYREGISTRY:5000/debian:latest"<font></font>
<font></font>
before_script:<font></font>
  - eval $(ssh-agent -s)<font></font>
  - ssh-add <span class="hljs-tag">&lt;<span class="hljs-name">(echo</span> "$<span class="hljs-attr">SSH_PRIVATE_KEY</span>")
  <span class="hljs-attr">-</span> <span class="hljs-attr">mkdir</span> <span class="hljs-attr">-p</span> ~/<span class="hljs-attr">.ssh</span> &amp;&amp; <span class="hljs-attr">echo</span> <span class="hljs-attr">-e</span> "<span class="hljs-attr">Host</span> *\<span class="hljs-attr">n</span>\<span class="hljs-attr">tStrictHostKeyChecking</span> <span class="hljs-attr">no</span>\<span class="hljs-attr">n</span>\<span class="hljs-attr">n</span>" &gt;</span> ~/.ssh/config<font></font>
<font></font>
stages:<font></font>
  - build<font></font>
  - testing<font></font>
  - deploy<font></font>
<font></font>
debug.debian:<font></font>
  stage: build<font></font>
  image: $DEBIAN<font></font>
  script:<font></font>
    - cd builds/release &amp;&amp; ./build.sh<font></font>
    paths:<font></font>
      - bin/<font></font>
      - builds/release/bin/<font></font>
    when: always<font></font>
release.debian:<font></font>
  stage: build<font></font>
  image: $DEBIAN<font></font>
  script:<font></font>
    - cd builds/release &amp;&amp; ./build.sh<font></font>
    paths:<font></font>
      - bin/<font></font>
      - builds/release/bin/<font></font>
    when: always<font></font>
<font></font>
## testing stage<font></font>
tests.codestyle:<font></font>
  stage: testing<font></font>
  image: $DEBIAN<font></font>
  dependencies:<font></font>
    - release.debian<font></font>
  script:<font></font>
    - /bin/bash run_tests.sh -t codestyle -b "${CI_COMMIT_REF_NAME}_codestyle"<font></font>
tests.debug.debian:<font></font>
  stage: testing<font></font>
  image: $DEBIAN<font></font>
  dependencies:<font></font>
    - debug.debian<font></font>
  script:<font></font>
    - /bin/bash run_tests.sh -e codestyle/test_pylint.py -b "${CI_COMMIT_REF_NAME}_debian_debug"<font></font>
  artifacts:<font></font>
    paths:<font></font>
      - run_tests/username/<font></font>
    when: always<font></font>
    expire_in: 1 week<font></font>
tests.release.debian:<font></font>
  stage: testing<font></font>
  image: $DEBIAN<font></font>
  dependencies:<font></font>
    - release.debian<font></font>
  script:<font></font>
    - /bin/bash run_tests.sh -e codestyle/test_pylint.py -b "${CI_COMMIT_REF_NAME}_debian_release"<font></font>
  artifacts:<font></font>
    paths:<font></font>
      - run_tests/username/<font></font>
    when: always<font></font>
    expire_in: 1 week<font></font>
<font></font>
## staging stage<font></font>
deploy_staging:<font></font>
  stage: deploy<font></font>
  environment: staging<font></font>
  image: $DEBIAN<font></font>
  dependencies:<font></font>
    - release.debian<font></font>
  script:<font></font>
    - cd scripts/deploy/ &amp;&amp;<font></font>
        python3 createconfig.py -s $CI_ENVIRONMENT_NAME &amp;&amp;<font></font>
        /bin/bash install_venv.sh -d -r ../../requirements.txt &amp;&amp;<font></font>
        python3 prepare_init.d.py &amp;&amp;<font></font>
        python3 deploy.py -s $CI_ENVIRONMENT_NAME<font></font>
  when: manual<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なすべてのシステムパッケージが既にインストールされ、他の設定が行われている、独自のイメージでアセンブリとテストが行​​われることに注意してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ジョブ内のこれらのスクリプトはそれぞれ独自の方法で興味深いものですが、</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私は確かにそれらについて話すことはしません</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が、</font><font style="vertical-align: inherit;">それぞれの説明にはかなりの時間がかかるため、これは記事の目的ではありません。</font><font style="vertical-align: inherit;">ここでは、展開段階が一連のスクリプト呼び出しで構成されていることに注意します。</font></font><br>
<br>
<ol>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">createconfig.py-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">後続のデプロイメント（プリプロダクション、プロダクション、テストなど）の異なる環境でコンポーネントの設定を含むsettings.iniファイルを作成します</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">install_venv.sh-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">特定のディレクトリにpyコンポーネントの仮想環境を作成し、リモートサーバーにコピーします</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prepare_init.d.py-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テンプレートに基づいてコンポーネントのスタート/ストップスクリプトを準備します</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deploy.py-</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新しいコンポーネントを</font><b><font style="vertical-align: inherit;">解凍</font></b><font style="vertical-align: inherit;">して再起動します</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
時は過ぎた。</font><font style="vertical-align: inherit;">ステージング段階は、プリプロダクションとプロダクションに置き換えられました。</font><font style="vertical-align: inherit;">製品サポートが別の配布キット（CentOS）に追加されました。</font><font style="vertical-align: inherit;">5つのより強力な物理サーバーと12の仮想サーバーが追加されました。</font><font style="vertical-align: inherit;">また、開発者やテスターが作業状態に近い環境でタスクを実行することがますます困難になりました。</font><font style="vertical-align: inherit;">このとき、彼なしではやっていけないことが判明し......</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パートII</font></font></h3><br>
<img src="https://habrastorage.org/getpro/habr/post_images/f0e/673/166/f0e67316667fed0c0d673653419e8b8a.png" alt="画像"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、私たちのクラスターは、</font><font style="vertical-align: inherit;">数十個の個別コンポーネントからの</font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">elseスペクタクル</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">システムを</font><font style="vertical-align: inherit;">表しており、</font><font style="vertical-align: inherit;">Dockerfileは記述されていません。全体としてのみ、特定の環境への展開用に構成できます。私たちの仕事は、リリース前のテストの前にクラスターをステージング環境にデプロイして実行することです。</font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
理論的には、同時に動作する複数のクラスターが存在する可能性があります。タスクが完了した状態または完了に近い状態である場合と同じ数です。サーバーで利用可能な容量により、各サーバーで複数のクラスターを実行できます。各ステージングクラスターは分離する必要があります（ポート、ディレクトリなどに共通部分があってはなりません）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も貴重なリソースは私たちの時間であり、私たちは多くを持っていませんでした。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
より迅速な開始のために、彼らはそのシンプルさとアーキテクチャの柔軟性のためにDocker Swarmを選択しました。</font><font style="vertical-align: inherit;">最初に行ったのは、いくつかのリモートマネージャーサーバーといくつかのノードで作成することでした。</font></font><br>
<br>
<pre><code class="bash hljs">$ docker node ls<font></font>
ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION<font></font>
kilqc94pi2upzvabttikrfr5d     nop-test-1     Ready               Active                                  19.03.2<font></font>
jilwe56pl2zvabupryuosdj78     nop-test-2     Ready               Active                                  19.03.2<font></font>
j5a4yz1kr2xke6b1ohoqlnbq5 *   nop-test-3     Ready               Active              Leader              19.03.2<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ネットワークを作成しました。</font></font><br>
<br>
<pre><code class="bash hljs"><font></font>
$ docker network create --driver overlay --subnet 10.10.10.0/24 nw_swarm<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、CIノードのリモート管理に関して、Gitlab-CIとSwarmノードを接続しました。証明書のインストール、シークレット変数の設定、管理サーバーでのDockerサービスの設定です。</font><font style="vertical-align: inherit;">この</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">により、多くの時間を節約できました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、スタックを作成および破棄するジョブを.gitlab-ci .ymlに追加しました。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">いくつかのジョブが.gitlab-ci .ymlに追加されました</font></font></b><div class="spoiler_text"><pre><code class="xml hljs">## staging stage<font></font>
deploy_staging:<font></font>
  stage: testing<font></font>
  before_script:<font></font>
    - echo "override global 'before_script'"<font></font>
  image: "REGISTRY:5000/docker:latest"<font></font>
  environment: staging<font></font>
  dependencies: []<font></font>
  variables:<font></font>
    DOCKER_CERT_PATH: "/certs"<font></font>
    DOCKER_HOST: tcp://10.50.173.107:2376<font></font>
    DOCKER_TLS_VERIFY: 1<font></font>
    CI_BIN_DEPENDENCIES_JOB: "release.centos.7"<font></font>
  script:<font></font>
    - mkdir -p $DOCKER_CERT_PATH<font></font>
    - echo "$TLSCACERT" &gt; $DOCKER_CERT_PATH/ca.pem<font></font>
    - echo "$TLSCERT" &gt; $DOCKER_CERT_PATH/cert.pem<font></font>
    - echo "$TLSKEY" &gt; $DOCKER_CERT_PATH/key.pem<font></font>
    - docker stack deploy -c docker-compose.yml ${CI_ENVIRONMENT_NAME}_${CI_COMMIT_REF_NAME} --with-registry-auth<font></font>
    - rm -rf $DOCKER_CERT_PATH<font></font>
  when: manual<font></font>
<font></font>
## stop staging stage<font></font>
stop_staging:<font></font>
  stage: testing<font></font>
  before_script:<font></font>
    - echo "override global 'before_script'"<font></font>
  image: "REGISTRY:5000/docker:latest"<font></font>
  environment: staging<font></font>
  dependencies: []<font></font>
  variables:<font></font>
    DOCKER_CERT_PATH: "/certs"<font></font>
    DOCKER_HOST: tcp://10.50.173.107:2376<font></font>
    DOCKER_TLS_VERIFY: 1<font></font>
  script:<font></font>
    - mkdir -p $DOCKER_CERT_PATH<font></font>
    - echo "$TLSCACERT" &gt; $DOCKER_CERT_PATH/ca.pem<font></font>
    - echo "$TLSCERT" &gt; $DOCKER_CERT_PATH/cert.pem<font></font>
    - echo "$TLSKEY" &gt; $DOCKER_CERT_PATH/key.pem<font></font>
    - docker stack rm ${CI_ENVIRONMENT_NAME}_${CI_COMMIT_REF_NAME}<font></font>
    # TODO: need check that stopped<font></font>
  when: manual<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
上記のコードスニペットから、手動のアクションを必要とする2つのボタン（deploy_staging、stop_staging）がパイプラインに追加されたことは明らかです。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2de/e3c/790/2dee3c7907f75f793499665d8a60de8a.png" alt="画像"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スタックの名前はブランチの名前に対応しており、この一意性で十分です。</font><font style="vertical-align: inherit;">スタック内のサービスは、一意のIPアドレス、ポート、ディレクトリなどを受け取ります。</font><font style="vertical-align: inherit;">分離されますが、スタック間で同じです（構成ファイルがすべてのスタックで同じであるため）-これは私たちが達成したことです。</font><font style="vertical-align: inherit;">クラスター</font><font style="vertical-align: inherit;">を記述する</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker-compose.yml</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を使用し</font><b><font style="vertical-align: inherit;">てスタック</font></b><font style="vertical-align: inherit;">（クラスター）をデプロイ</font><b><font style="vertical-align: inherit;">し</font></b><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker-compose.yml</font></font></b><div class="spoiler_text"><pre><code class="xml hljs">---<font></font>
version: '3'<font></font>
<font></font>
services:<font></font>
  userprop:<font></font>
    image: redis:alpine<font></font>
    deploy:<font></font>
      replicas: 1<font></font>
      placement:<font></font>
        constraints: [node.id == kilqc94pi2upzvabttikrfr5d]<font></font>
      restart_policy:<font></font>
        condition: none<font></font>
    networks:<font></font>
      nw_swarm:<font></font>
  celery_bcd:<font></font>
    image: redis:alpine<font></font>
    deploy:<font></font>
      replicas: 1<font></font>
      placement:<font></font>
        constraints: [node.id == kilqc94pi2upzvabttikrfr5d]<font></font>
      restart_policy:<font></font>
        condition: none<font></font>
    networks:<font></font>
      nw_swarm:<font></font>
<font></font>
  schedulerdb:<font></font>
    image: mariadb:latest<font></font>
    environment:<font></font>
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'<font></font>
      MYSQL_DATABASE: schedulerdb<font></font>
      MYSQL_USER: ****<font></font>
      MYSQL_PASSWORD: ****<font></font>
    command: ['--character-set-server=utf8mb4', '--collation-server=utf8mb4_unicode_ci', '--explicit_defaults_for_timestamp=1']<font></font>
    deploy:<font></font>
      replicas: 1<font></font>
      placement:<font></font>
        constraints: [node.id == kilqc94pi2upzvabttikrfr5d]<font></font>
      restart_policy:<font></font>
        condition: none<font></font>
    networks:<font></font>
      nw_swarm:<font></font>
<font></font>
  celerydb:<font></font>
    image: mariadb:latest<font></font>
    environment:<font></font>
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'<font></font>
      MYSQL_DATABASE: celerydb<font></font>
      MYSQL_USER: ****<font></font>
      MYSQL_PASSWORD: ****<font></font>
    deploy:<font></font>
      replicas: 1<font></font>
      placement:<font></font>
        constraints: [node.id == kilqc94pi2upzvabttikrfr5d]<font></font>
      restart_policy:<font></font>
        condition: none<font></font>
    networks:<font></font>
      nw_swarm:<font></font>
<font></font>
  cluster:<font></font>
    image: $CENTOS7<font></font>
    environment:<font></font>
      - CENTOS<font></font>
      - CI_ENVIRONMENT_NAME<font></font>
      - CI_API_V4_URL<font></font>
      - CI_REPOSITORY_URL<font></font>
      - CI_PROJECT_ID<font></font>
      - CI_PROJECT_URL<font></font>
      - CI_PROJECT_PATH<font></font>
      - CI_PROJECT_NAME<font></font>
      - CI_COMMIT_REF_NAME<font></font>
      - CI_BIN_DEPENDENCIES_JOB<font></font>
    command: &gt;<font></font>
      sudo -u myusername -H /bin/bash -c ". /etc/profile &amp;&amp;<font></font>
        mkdir -p /storage1/$CI_COMMIT_REF_NAME/$CI_PROJECT_NAME &amp;&amp;<font></font>
        cd /storage1/$CI_COMMIT_REF_NAME/$CI_PROJECT_NAME &amp;&amp;<font></font>
            git clone -b $CI_COMMIT_REF_NAME $CI_REPOSITORY_URL . &amp;&amp;<font></font>
            curl $CI_API_V4_URL/projects/$CI_PROJECT_ID/jobs/artifacts/$CI_COMMIT_REF_NAME/download?job=$CI_BIN_DEPENDENCIES_JOB -o artifacts.zip &amp;&amp;<font></font>
            unzip artifacts.zip ;<font></font>
        cd /storage1/$CI_COMMIT_REF_NAME/$CI_PROJECT_NAME/scripts/deploy/ &amp;&amp;<font></font>
            python3 createconfig.py -s $CI_ENVIRONMENT_NAME &amp;&amp;<font></font>
            /bin/bash install_venv.sh -d -r ../../requirements.txt &amp;&amp;<font></font>
            python3 prepare_init.d.py &amp;&amp;<font></font>
            python3 deploy.py -s $CI_ENVIRONMENT_NAME"<font></font>
    deploy:<font></font>
      replicas: 1<font></font>
      placement:<font></font>
        constraints: [node.id == kilqc94pi2upzvabttikrfr5d]<font></font>
      restart_policy:<font></font>
        condition: none<font></font>
    tty: true<font></font>
    stdin_open: true<font></font>
    networks:<font></font>
      nw_swarm:<font></font>
<font></font>
networks:<font></font>
  nw_swarm:<font></font>
    external: true<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで、コンポーネントが1つのネットワーク（nw_swarm）によって接続され、相互にアクセス可能であることがわかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
システムコンポーネント（redis、mysqlに基づく）は、カスタムコンポーネントの共通プールから分離されています（計画では、カスタムはサービスとして分割されます）。</font><font style="vertical-align: inherit;">クラスターの展開段階は、1つの大きな構成済みイメージへのCMD転送のようであり、全体として、実質的にパートIで説明した展開と変わりません。違いを強調します。</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">git clone</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ...-デプロイに必要なファイルを取得します（createconfig.py、install_venv.shなど）。</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">curl ... &amp;&amp; unzip</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ...-アセンブリアーティファクトをダウンロードして解凍します（コンパイル済みユーティリティ）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まだ説明されていない問題が1つだけあります。Webインターフェースを持つコンポーネントは、開発者のブラウザーからアクセスできません。</font><font style="vertical-align: inherit;">したがって、リバースプロキシを使用してこの問題を解決します</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。.gitlab-ci.ymlで、クラスタースタックをデプロイした後、バランサーデプロイメント行を追加します（コミットすると、構成のみを更新します（テンプレートを使用して新しいnginx構成ファイルを作成します：/ etc / nginx / conf.d / $ {CI_COMMIT_REF_NAME} .conf）-コードdocker-compose-nginx.ymlを参照）</font></font><br>
<br>
<pre><code class="xml hljs">    - docker stack deploy -c docker-compose-nginx.yml ${CI_ENVIRONMENT_NAME} --with-registry-auth
</code></pre><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docker-compose-nginx.yml</font></font></b><div class="spoiler_text"><pre><code class="xml hljs">---<font></font>
version: '3'<font></font>
<font></font>
services:<font></font>
  nginx:<font></font>
    image: nginx:latest<font></font>
    environment:<font></font>
      CI_COMMIT_REF_NAME: ${CI_COMMIT_REF_NAME}<font></font>
      NGINX_CONFIG: |-<font></font>
            server {<font></font>
                listen 8080;<font></font>
                server_name staging_${CI_COMMIT_REF_NAME}_cluster.dev;<font></font>
<font></font>
                location / {<font></font>
                    proxy_pass http://staging_${CI_COMMIT_REF_NAME}_cluster:8080;<font></font>
                }<font></font>
            }<font></font>
            server {<font></font>
                listen 5555;<font></font>
                server_name staging_${CI_COMMIT_REF_NAME}_cluster.dev;<font></font>
<font></font>
                location / {<font></font>
                    proxy_pass http://staging_${CI_COMMIT_REF_NAME}_cluster:5555;<font></font>
                }<font></font>
            }<font></font>
    volumes:<font></font>
      - /tmp/staging/nginx:/etc/nginx/conf.d<font></font>
    command:<font></font>
      /bin/bash -c "echo -e \"$$NGINX_CONFIG\" &gt; /etc/nginx/conf.d/${CI_COMMIT_REF_NAME}.conf;<font></font>
        nginx -g \"daemon off;\";<font></font>
        /etc/init.d/nginx reload"<font></font>
    ports:<font></font>
      - 8080:8080<font></font>
      - 5555:5555<font></font>
      - 3000:3000<font></font>
      - 443:443<font></font>
      - 80:80<font></font>
    deploy:<font></font>
      replicas: 1<font></font>
      placement:<font></font>
        constraints: [node.id == kilqc94pi2upzvabttikrfr5d]<font></font>
      restart_policy:<font></font>
        condition: none<font></font>
    networks:<font></font>
      nw_swarm:<font></font>
<font></font>
networks:<font></font>
  nw_swarm:<font></font>
    external: true<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
開発用コンピューターでは、/ etc /ホストを更新します。</font><font style="vertical-align: inherit;">私たちは、nginxのURLを設定します</font><font style="vertical-align: inherit;">
ので、孤立ステージングクラスタの展開が実装されており、開発者は今ではそれらを実行することができます</font><s><font style="vertical-align: inherit;">任意の</font></s><font style="vertical-align: inherit;">タスクをテストするために十分な量。</font><font style="vertical-align: inherit;">
今後の計画：</font></font><br>
<br>
<code>10.50.173.106 staging_BRANCH-1831_cluster.dev<br>
</code><br><font style="vertical-align: inherit;"></font><s><font style="vertical-align: inherit;"></font></s><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンポーネントをサービスとして分離する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべてのDockerfileを作成する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スタック内の負荷の少ないノードを自動的に検出します</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（記事のようにIDを使用するのではなく）名前パターンでノードを設定する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">スタックが破壊されていることのチェックを追加</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...</font></font></li>
</ul><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">記事に</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
感謝し</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja471516/index.html">Intel 665p-96層QLC NANDを搭載したSSD</a></li>
<li><a href="../ja471518/index.html">2019年のAppleは2000年のLinuxです</a></li>
<li><a href="../ja471520/index.html">本「Pythonでの古典的なコンピュータサイエンスのタスク」</a></li>
<li><a href="../ja471522/index.html">アスコジア。プラグアンドプレイの自動プロビジョニングの仕組み</a></li>
<li><a href="../ja471524/index.html">Googleの評価者向けの指示の完全な翻訳</a></li>
<li><a href="../ja471530/index.html">GitLabはCI / CDおよびKubernetesへの異常な道を歩みました</a></li>
<li><a href="../ja471532/index.html">さようならPCB; こんにちはシリコン相互接続</a></li>
<li><a href="../ja471536/index.html">Google洪水予測：内部の様子</a></li>
<li><a href="../ja471538/index.html">モバイルアプリケーションのアイデアから投資家が投資するMVPまで</a></li>
<li><a href="../ja471542/index.html">OCRテキスト認識</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>