<!doctype html>
<html class="no-js" lang="id">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍🍳 👩🏿‍🤝‍👨🏻 🤛 Cara membangun akselerator roket untuk skrip PowerCLI  🥩 🦊 👨‍👨‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cepat atau lambat, administrator sistem VMware dapat mengotomatiskan tugas-tugas rutin. Semuanya dimulai dari baris perintah, kemudian datang PowerShe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Cara membangun akselerator roket untuk skrip PowerCLI </h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dataline/blog/498628/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cepat atau lambat, administrator sistem VMware dapat mengotomatiskan tugas-tugas rutin. </font><font style="vertical-align: inherit;">Semuanya dimulai dari baris perintah, kemudian datang PowerShell atau VMware PowerCLI. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Misalkan Anda sudah menguasai PowerShell sedikit lebih jauh daripada memulai ISE dan menggunakan cmdlet standar dari modul yang bekerja dengan semacam sihir. </font><font style="vertical-align: inherit;">Ketika Anda mulai menghitung ratusan mesin virtual, Anda akan menemukan bahwa skrip yang membantu pada skala kecil bekerja terasa lebih lambat pada yang besar.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam situasi ini, 2 alat akan membantu:</font></font><br>
<br>
<ul>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PowerShell Runspaces</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - sebuah pendekatan yang memungkinkan Anda untuk memparalelasikan eksekusi proses di utas terpisah;&nbsp;</font></font></li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get-View</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adalah fungsi dasar PowerCLI, analog dari Get-WMIObject di Windows. </font><font style="vertical-align: inherit;">Cmdlet ini tidak menyeret objek yang terkait dengannya, tetapi menerima informasi dalam bentuk objek sederhana dengan tipe data sederhana. </font><font style="vertical-align: inherit;">Dalam banyak kasus, itu keluar lebih cepat.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selanjutnya, saya akan berbicara secara singkat tentang setiap alat dan menunjukkan contoh penggunaan. </font><font style="vertical-align: inherit;">Kami akan menganalisis skrip tertentu dan melihat kapan seseorang bekerja paling baik, kapan yang kedua. </font><font style="vertical-align: inherit;">Pergilah!</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xp/2q/fe/xp2qfe2m-lyc8feedka2nyhc2sq.jpeg"><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tahap Pertama: Runspace</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jadi, Runspace dirancang untuk pemrosesan tugas paralel di luar modul utama. </font><font style="vertical-align: inherit;">Tentu saja, Anda dapat memulai proses lain yang akan memakan sebagian memori, prosesor, dll. Jika skrip Anda berjalan dalam beberapa menit dan menghabiskan satu gigabyte memori, Anda mungkin tidak akan memerlukan Runspace. </font><font style="vertical-align: inherit;">Tetapi untuk skrip pada puluhan ribu objek itu diperlukan.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anda dapat memulai pengembangan dari sini:&nbsp; </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mulai Menggunakan PowerShell Runspaces: Bagian 1</font></font></a></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apa yang memberi manfaat bagi Runspace:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mempercepat dengan membatasi daftar perintah yang dapat dieksekusi,</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tugas paralel</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keamanan.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ini adalah contoh dari internet ketika Runspace membantu:</font></font><br>
<blockquote>«    –   ,     vSphere.  vCenter     ,      .  ,        PowerShell.<br>
 ,     VMware      vCenter          .&nbsp;&nbsp;<br>
  PowerShell runspaces,    ESXi          Runspace     .   PowerShell   ,        ,     ». <br>
<br>
<i>: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">How to Show Virtual Machine I/O on an ESXi Dashboard</a></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dalam kasus di bawah ini, Runspace tidak lagi dalam bisnis:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“Saya mencoba menulis skrip yang mengumpulkan banyak data dari VM dan, jika perlu, menulis data baru. </font><font style="vertical-align: inherit;">Masalahnya adalah ada banyak VM, dan butuh 5-8 detik untuk satu mesin. ”&nbsp;</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sumber: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multithreading PowerCLI dengan RunspacePool</font></font></a></i></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View diperlukan di sini, mari beralih ke sana.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tahap kedua: Get-View</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk memahami manfaat Get-View, ingat bagaimana cmdlet bekerja secara umum.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cmdlet diperlukan untuk mendapatkan informasi dengan mudah tanpa harus mempelajari buku referensi API dan menemukan kembali roda. Apa yang di masa lalu ditulis dalam seratus atau dua baris kode, PowerShell memungkinkan Anda untuk melakukan satu perintah. Untuk kenyamanan ini kami membayar kecepatan. Di dalam cmdlet itu sendiri, tidak ada sihir: naskah yang sama, tetapi dari tingkat yang lebih rendah, ditulis oleh tangan-tangan terampil seorang master dari India yang cerah. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang, untuk perbandingan dengan Get-View, ambil cmdlet Get-VM: ia mengakses mesin virtual dan mengembalikan objek komposit, yaitu, melampirkan objek terkait lainnya ke dalamnya: VMHost, Datastore, dll.&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View di tempatnya tidak mengacaukan apa pun ke objek yang dikembalikan. </font><font style="vertical-align: inherit;">Selain itu, ini memungkinkan Anda untuk secara kaku menunjukkan informasi apa yang kami butuhkan, yang akan memfasilitasi objek pada output. </font><font style="vertical-align: inherit;">Pada Windows Server pada umumnya, dan pada Hyper-V pada khususnya, cmdlet Get-WMIObject adalah analog langsung - idenya persis sama. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-View tidak nyaman dalam operasi rutin pada fitur titik. </font><font style="vertical-align: inherit;">Tetapi ketika menyangkut ribuan dan puluhan ribu objek, ia tidak memiliki harga.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Baca lebih lanjut di Blog VMware: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pengantar Get-View</font></font></a></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang saya akan menunjukkan semuanya pada kasus nyata.&nbsp;</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami menulis skrip untuk menurunkan VM</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Suatu kali kolega saya meminta saya untuk mengoptimalkan skripnya. </font><font style="vertical-align: inherit;">Tugasnya adalah rutinitas normal: temukan semua VM dengan parameter duplikat cloud.uuid (ya, ini dimungkinkan ketika kloning VM di vCloud Director).&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Solusi jelas yang terlintas dalam pikiran:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dapatkan daftar semua VM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entah bagaimana menguraikan daftar.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Versi aslinya adalah skrip sederhana:</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-CloudUUID1</span></span> {
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vms</span> = <span class="hljs-built_in">Get-VM</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   ,     2 :    Cloud UUID.</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     PS-   VM  UUID</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vm</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vms</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span> = <span class="hljs-string">""</span> | <span class="hljs-built_in">select</span> VM,UUID<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span>.VM = <span class="hljs-variable">$vm</span>.name
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$table</span>.UUID = (<span class="hljs-variable">$vm</span> | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> cloud.uuid).Value<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span> += <span class="hljs-variable">$table</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<span class="hljs-comment">#   </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$report</span><font></font>
}<font></font>
<span class="hljs-comment">#     </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Semuanya sangat sederhana dan jelas. Itu ditulis dalam beberapa menit dengan rehat kopi. Kencangkan filternya, dan selesai. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi mengukur waktu: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iz/xb/i-/izxbi-_-xo9odcuouzqan83vd1o.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/kv/xy/fb/kvxyfb7lj5asvvkm3nuebjljcx0.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 menit 47 detik</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> saat memproses hampir 10k VM. Bonus adalah kurangnya filter dan kebutuhan untuk mengurutkan hasilnya secara manual. Jelas, skrip meminta optimasi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ransepses adalah yang pertama datang untuk menyelamatkan ketika Anda perlu mendapatkan metrik host dengan vCenter pada satu waktu atau Anda perlu memproses puluhan ribu objek. Mari kita lihat apa yang akan diberikan oleh pendekatan ini. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mengaktifkan kecepatan pertama: PowerShell Runspaces</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hal pertama yang terlintas dalam pikiran untuk skrip ini adalah untuk mengeksekusi loop tidak secara seri, tetapi dalam utas paralel, mengumpulkan semua data dalam satu objek dan memfilternya.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tetapi ada masalah: PowerCLI tidak akan mengizinkan kami membuka banyak sesi independen ke vCenter dan akan membuat kesalahan lucu:</font></font><br>
<br>
<pre><code class="plaintext hljs">You have modified the global:DefaultVIServer and global:DefaultVIServers system variables. This is not allowed. Please reset them to $null and reconnect to the vSphere server.</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Untuk mengatasinya, Anda harus terlebih dahulu meneruskan informasi sesi ke aliran. </font><font style="vertical-align: inherit;">Kami ingat bahwa PowerShell berfungsi dengan objek yang dapat dikirimkan sebagai parameter ke setidaknya fungsi, setidaknya ke ScriptBlock. </font><font style="vertical-align: inherit;">Mari kita lewati sesi sebagai objek yang melewati $ global: DefaultVIServers (Connect-VIServer dengan kunci -NotDefault):</font></font><br>
<br>
<pre><code class="powershell hljs"><span class="hljs-variable">$ConnectionString</span> = <span class="hljs-selector-tag">@</span>()
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vCenter</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vCenters</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-AllLinked</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (<span class="hljs-variable">$er</span>.Message <span class="hljs-operator">-like</span> <span class="hljs-string">"*not part of a linked mode*"</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">else</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang kami menerapkan multithreading melalui Runspace Pools.&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Algoritma adalah sebagai berikut:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dapatkan daftar semua VM.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam utas paralel kami mendapatkan cloud.uuid.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mengumpulkan data dari stream ke satu objek.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami memfilter objek melalui pengelompokan berdasarkan nilai bidang CloudUUID: yang di mana jumlah nilai unik lebih dari 1, dan ada VM yang diinginkan.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hasilnya, kami mendapatkan skrip:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-VMCloudUUID</span></span> {
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">param</span> (<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">string</span>[]]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">ValidateNotNullOrEmpty</span>()]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vCenters</span> = <span class="hljs-selector-tag">@</span>(),<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">int</span>]<span class="hljs-variable">$MaxThreads</span>,<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.PSCredential</span>]<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.Credential</span>()]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span><font></font>
&nbsp;&nbsp;&nbsp;)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#     </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$vCenter</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$vCenters</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-AllLinked</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> (<span class="hljs-variable">$er</span>.Message <span class="hljs-operator">-like</span> <span class="hljs-string">"*not part of a linked mode*"</span>)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">try</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span> += <span class="hljs-built_in">Connect-VIServer</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$vCenter</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span> <span class="hljs-literal">-NotDefault</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-ErrorAction</span> stop <span class="hljs-literal">-WarningAction</span> SilentlyContinue <span class="hljs-literal">-ErrorVariable</span> er<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">catch</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">else</span> {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">throw</span> <span class="hljs-variable">$_</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Global:AllVMs</span> = <span class="hljs-built_in">Get-VM</span> <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment"># !</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ISS</span> = [<span class="hljs-type">system.management.automation.runspaces.initialsessionstate</span>]::CreateDefault()
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span> = [<span class="hljs-type">runspacefactory</span>]::CreateRunspacePool(<span class="hljs-number">1</span>, <span class="hljs-variable">$MaxThreads</span>, <span class="hljs-variable">$ISS</span>, <span class="hljs-variable">$Host</span>)
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.ApartmentState = <span class="hljs-string">"MTA"</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Open()
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Jobs</span> = <span class="hljs-selector-tag">@</span>()<font></font>
<font></font>
<span class="hljs-comment"># ScriptBlock  !)))</span>
<span class="hljs-comment">#      </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$scriptblock</span> = {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">Param</span> (
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$ConnectionString</span>,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$VM</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Data</span> = <span class="hljs-variable">$VM</span> | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> Cloud.uuid <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span> | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Entity.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={<span class="hljs-variable">$_</span>.Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.Entity.PowerState}}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">return</span> <span class="hljs-variable">$Data</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<span class="hljs-comment">#  </span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$VM</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$AllVMs</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$PowershellThread</span> = [<span class="hljs-type">PowerShell</span>]::Create()
<span class="hljs-comment">#  </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddScript(<span class="hljs-variable">$scriptblock</span>)
<span class="hljs-comment">#  ,      </span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddArgument(<span class="hljs-variable">$ConnectionString</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$null</span> = <span class="hljs-variable">$PowershellThread</span>.AddArgument(<span class="hljs-variable">$VM</span>)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$PowershellThread</span>.RunspacePool = <span class="hljs-variable">$RunspacePool</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Handle</span> = <span class="hljs-variable">$PowershellThread</span>.BeginInvoke()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span> = <span class="hljs-string">""</span> | <span class="hljs-built_in">Select-Object</span> Handle, Thread, object
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Handle = <span class="hljs-variable">$Handle</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread = <span class="hljs-variable">$PowershellThread</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Object = <span class="hljs-variable">$VM</span>.ToString()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Jobs</span> += <span class="hljs-variable">$Job</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
<span class="hljs-comment">#  ,     </span>
<span class="hljs-comment">#      </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">While</span> (<span class="hljs-selector-tag">@</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle <span class="hljs-operator">-ne</span> <span class="hljs-variable">$Null</span>}).count <span class="hljs-operator">-gt</span> <span class="hljs-number">0</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Remaining</span> = <span class="hljs-string">"<span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | Where-Object {<span class="hljs-variable">$_</span>.Handle.IsCompleted -eq <span class="hljs-variable">$False</span>}).object)"</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">If</span> (<span class="hljs-variable">$Remaining</span>.Length <span class="hljs-operator">-gt</span> <span class="hljs-number">60</span>) {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Remaining</span> = <span class="hljs-variable">$Remaining</span>.Substring(<span class="hljs-number">0</span>,<span class="hljs-number">60</span>) + <span class="hljs-string">"..."</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">Write-Progress</span> <span class="hljs-literal">-Activity</span> <span class="hljs-string">"Waiting for Jobs - <span class="hljs-variable">$</span>(<span class="hljs-variable">$MaxThreads</span> - <span class="hljs-variable">$</span>(<span class="hljs-variable">$RunspacePool</span>.GetAvailableRunspaces())) of <span class="hljs-variable">$MaxThreads</span> threads running"</span> <span class="hljs-literal">-PercentComplete</span> ((<span class="hljs-variable">$Jobs</span>.count - <span class="hljs-variable">$</span>(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle.IsCompleted <span class="hljs-operator">-eq</span> <span class="hljs-variable">$False</span>}).count)) / <span class="hljs-variable">$Jobs</span>.Count * <span class="hljs-number">100</span>) <span class="hljs-literal">-Status</span> <span class="hljs-string">"<span class="hljs-variable">$</span>(@(<span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | Where-Object {<span class="hljs-variable">$_</span>.Handle.IsCompleted -eq <span class="hljs-variable">$False</span>})).count) remaining - <span class="hljs-variable">$remaining</span>"</span><font></font>
<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">ForEach</span> (<span class="hljs-variable">$Job</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">$</span>(<span class="hljs-variable">$Jobs</span> | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.Handle.IsCompleted <span class="hljs-operator">-eq</span> <span class="hljs-variable">$True</span>})){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread.EndInvoke(<span class="hljs-variable">$Job</span>.Handle)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread.Dispose()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Thread = <span class="hljs-variable">$Null</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Job</span>.Handle = <span class="hljs-variable">$Null</span><font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Close() | <span class="hljs-built_in">Out-Null</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$RunspacePool</span>.Dispose() | <span class="hljs-built_in">Out-Null</span><font></font>
}<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get-CloudUUID2</span></span><font></font>
{<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-function">[<span class="hljs-type">CmdletBinding</span>()]</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">param</span>(<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">string</span>[]]<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">ValidateNotNullOrEmpty</span>()]
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$vCenters</span> = <span class="hljs-selector-tag">@</span>(),<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-built_in">int</span>]<span class="hljs-variable">$MaxThreads</span> = <span class="hljs-number">50</span>,<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.PSCredential</span>]<font></font>
&nbsp;&nbsp;&nbsp;[<span class="hljs-type">System.Management.Automation.Credential</span>()]
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span>)<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span>(!<span class="hljs-variable">$Credential</span>)<font></font>
&nbsp;&nbsp;&nbsp;{<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Credential</span> = <span class="hljs-built_in">Get-Credential</span> <span class="hljs-literal">-Message</span> <span class="hljs-string">"Please enter vCenter credentials."</span><font></font>
&nbsp;&nbsp;&nbsp;}<font></font>
<font></font>
&nbsp;&nbsp;&nbsp;<span class="hljs-comment">#   Get-VMCloudUUID,    </span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$AllCloudVMs</span> = <span class="hljs-built_in">Get-VMCloudUUID</span> <span class="hljs-literal">-vCenters</span> <span class="hljs-variable">$vCenters</span> <span class="hljs-literal">-MaxThreads</span> <span class="hljs-variable">$MaxThreads</span> <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$Credential</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Result</span> = <span class="hljs-variable">$AllCloudVMs</span> | <span class="hljs-built_in">Sort-Object</span> Value | <span class="hljs-built_in">Group-Object</span> <span class="hljs-literal">-Property</span> CloudUUID | <span class="hljs-built_in">Where-Object</span> <span class="hljs-literal">-FilterScript</span> {<span class="hljs-variable">$_</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">1</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-ExpandProperty</span> <span class="hljs-built_in">Group</span>
&nbsp;&nbsp;&nbsp;<span class="hljs-variable">$Result</span>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Keindahan skrip ini adalah dapat digunakan dalam kasus serupa lainnya, cukup dengan mengganti ScriptBlock dan parameter yang akan ditransfer ke aliran. Memanfaatkannya! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mengukur waktu: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d_/hr/ji/d_hrjiq58scxnha1wiknf9jd1zw.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">55 detik.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sudah lebih baik, tetapi masih lebih cepat.&nbsp; </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami beralih ke kecepatan kedua: GetView</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Kami mencari tahu apa yang salah. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama dan jelas: cmdlet Get-VM membutuhkan waktu lama untuk diselesaikan. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kedua: Get-AdvancedOptions cmdlet berjalan lebih lama. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pertama, mari kita berurusan dengan yang kedua.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Get-AdvancedOptions mudah digunakan pada objek VM individual, tetapi sangat lambat saat bekerja dengan banyak objek. </font><font style="vertical-align: inherit;">Kita bisa mendapatkan informasi yang sama dari objek mesin virtual itu sendiri (Get-VM). </font><font style="vertical-align: inherit;">Hanya saja itu terkubur dengan baik di objek ExtensionData. </font><font style="vertical-align: inherit;">Berbekal penyaringan, kami mempercepat proses mendapatkan data yang diperlukan. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dengan gerakan pergelangan tangan, ini adalah:</font></font><br>
<br>
<pre><code class="powershell hljs">
VM | <span class="hljs-built_in">Get-AdvancedSetting</span> <span class="hljs-literal">-Name</span> Cloud.uuid <span class="hljs-literal">-Server</span> <span class="hljs-variable">$ConnectionString</span> | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Entity.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={<span class="hljs-variable">$_</span>.Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.Entity.PowerState}}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Berubah menjadi ini:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-variable">$VM</span> | <span class="hljs-built_in">Where-Object</span> {(<span class="hljs-variable">$_</span>.ExtensionData.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value <span class="hljs-operator">-ne</span> <span class="hljs-variable">$null</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={(<span class="hljs-variable">$_</span>.ExtensionData.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.summary.runtime.powerstate}}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kesimpulannya sama dengan Get-AdvancedOptions, tetapi kerjanya berkali-kali lebih cepat.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sekarang ke Get-VM. Ini tidak dieksekusi dengan cepat, karena berurusan dengan objek yang kompleks. Sebuah pertanyaan logis muncul: mengapa kita membutuhkan informasi tambahan dan sebuah PSObject mengerikan dalam kasus ini, ketika kita hanya perlu nama VM, status dan nilai atribut rumitnya?&nbsp;&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selain itu, rem di muka Get-AdvancedOptions telah meninggalkan skrip. Menggunakan Runspace Pools sekarang tampaknya berlebihan, karena tidak ada lagi kebutuhan untuk memparalelkan tugas lambat dalam aliran dengan squat saat mentransfer sesi. Alatnya bagus, tetapi tidak untuk kasus ini.&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami melihat output dari ExtensionData: tidak lain adalah objek Get-View.&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mari kita sebut teknik kuno dari master PowerShell: satu baris menggunakan filter, macam dan pengelompokan. Semua horor sebelumnya runtuh secara elegan menjadi satu baris dan dieksekusi dalam satu sesi:</font></font><br>
<br>
<pre><code class="powershell hljs">
<span class="hljs-variable">$AllVMs</span> = <span class="hljs-built_in">Get-View</span> <span class="hljs-literal">-viewtype</span> VirtualMachine <span class="hljs-literal">-Property</span> Name,Config.ExtraConfig,summary.runtime.powerstate | <span class="hljs-built_in">Where-Object</span> {(<span class="hljs-variable">$_</span>.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value <span class="hljs-operator">-ne</span> <span class="hljs-variable">$null</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"VMName"</span>;E={<span class="hljs-variable">$_</span>.Name}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"CloudUUID"</span>;E={(<span class="hljs-variable">$_</span>.Config.ExtraConfig | <span class="hljs-built_in">Where-Object</span> {<span class="hljs-variable">$_</span>.key <span class="hljs-operator">-eq</span> <span class="hljs-string">"cloud.uuid"</span>}).Value}},<span class="hljs-selector-tag">@</span>{N=<span class="hljs-string">"PowerState"</span>;E={<span class="hljs-variable">$_</span>.summary.runtime.powerstate}} | <span class="hljs-built_in">Sort-Object</span> CloudUUID | <span class="hljs-built_in">Group-Object</span> <span class="hljs-literal">-Property</span> CloudUUID | <span class="hljs-built_in">Where-Object</span> <span class="hljs-literal">-FilterScript</span> {<span class="hljs-variable">$_</span>.Count <span class="hljs-operator">-gt</span> <span class="hljs-number">1</span>} | <span class="hljs-built_in">Select-Object</span> <span class="hljs-literal">-ExpandProperty</span> <span class="hljs-built_in">Group</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kami mengukur waktu: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iy/x4/7q/iyx47qcshcsbjbglrcwi_zzceps.jpeg"><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9 detik</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> untuk hampir 10k objek dengan penyaringan sesuai dengan kondisi yang diinginkan. </font><font style="vertical-align: inherit;">Baik! </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alih-alih kesimpulan.</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hasil yang dapat diterima secara langsung tergantung pada pilihan alat. </font><font style="vertical-align: inherit;">Seringkali sulit untuk mengatakan dengan pasti apa yang harus dipilih untuk mencapainya. </font><font style="vertical-align: inherit;">Setiap metode akselerasi skrip yang terdaftar baik dalam batas penerapannya. </font><font style="vertical-align: inherit;">Saya harap artikel ini akan membantu Anda dalam tugas yang sulit untuk memahami dasar-dasar otomatisasi proses dan pengoptimalannya dalam infrastruktur Anda. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Penulis berterima kasih kepada semua anggota komune atas bantuan dan dukungan mereka dalam mempersiapkan artikel. </font><font style="vertical-align: inherit;">Bahkan mereka yang cakarnya. </font><font style="vertical-align: inherit;">Dan bahkan yang tidak memiliki kaki, seperti boa constrictor.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id498612/index.html">Jangan memutuskan untuk perancang tugas dari perancang</a></li>
<li><a href="../id498614/index.html">Analisis serangkaian video promosi untuk game Spin Voyage</a></li>
<li><a href="../id498618/index.html">Android di pengontrol industri</a></li>
<li><a href="../id498620/index.html">Menyentuh dunia: biomekanik reseptor kulit manusia</a></li>
<li><a href="../id498624/index.html">[Instruksi] Membuat tes Google (formulir Google)</a></li>
<li><a href="../id498630/index.html">Simulasi fisik ratusan ribu partikel pada Unity + DOTS</a></li>
<li><a href="../id498632/index.html">Peptide untuk mulatto yang indah</a></li>
<li><a href="../id498634/index.html">11 pertanyaan bodoh kepada ahli ortopedi dan tukang pijat tentang bekerja di komputer dan tidak hanya</a></li>
<li><a href="../id498636/index.html">Shader sederhana untuk lampu titik dalam kabut</a></li>
<li><a href="../id498638/index.html">Arcade 3D di browser: bagaimana kami membuat game di React + Redux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>