<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏇🏼 🥓 🤳🏿 管理者権限のサイレント付与 👩🏻‍🍳 🕟 🏴󠁧󠁢󠁳󠁣󠁴󠁿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="すべての金曜日、友達。本日は、リバースエンジニアリングコースの開始前日に翻訳されたさらに別の資料をご紹介します。
 
 
 
 ソーシャルエンジニアリングやサードパーティのエクスプロイトを使用せずにユーザーにアプリケーションを実行させる方法を考えました。さらに、単純に前進して実行可能ファイルの大量感...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>管理者権限のサイレント付与</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/457082/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">すべての金曜日、友達。</font><font style="vertical-align: inherit;">本日は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、リバースエンジニアリング</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コースの開始前日に翻訳されたさらに別の資料をご紹介し</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/cv/me/5s/cvme5snsza_im0wjpdevttzzcz4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ソーシャルエンジニアリングやサードパーティのエクスプロイトを使用せずにユーザーにアプリケーションを実行させる方法を考えました。</font><font style="vertical-align: inherit;">さらに、単純に前進して実行可能ファイルの大量感染を開始することができますが、これは予期しない多くの問題を引き起こす可能性があり、信頼できるサプライヤーからのデジタル署名されたアプリケーションが信頼できないファイルとして表示されることも意味します。</font><font style="vertical-align: inherit;">DLLを1つだけ「キャプチャ」することをお勧めします。</font><font style="vertical-align: inherit;">このメソッドをUAC（ユーザーアカウント制御）をバイパスして呼び出すことはしません。これは、アプリケーションを実行するためのアクセス許可を取得する必要があるためです（ただし、あなたのものは必要ありません）。</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ロードライブラリ</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたはすでにこの概念に精通しているかもしれませんが、それでもそれが何であるかを説明します。</font><font style="vertical-align: inherit;">アプリケーションがDLLのLoadLibraryを呼び出したが、ファイルへのフルパスを提供しなかった場合、システムはまずパスを検索するKnownDllsレジストリキーを確認し、そこにない場合は、アプリケーションが実行されたディレクトリを検索してから、検索します。 system32 / syswow64などのシステムパス。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
dllをアプリケーションと同じディレクトリに配置して、通常ロードされるシステムdllと同じ名前を付けることもできますが、いずれの場合でも、dllは次の要件を満たしている必要があります。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">アプリケーションは、DLLを完全パスではなく名前でダウンロードする必要があります（よくあることです）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なライブラリは、HKLM \ SYSTEM \ CurrentControlSet \ Control \ Session Manager \ KnownDLLsに存在してはなりません。</font></font></li>
<li> dll     (  ,  64-     32-    );</li>
<li>   System32  Syswow64,      .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZeroAccessウイルスは、この方法を使用して「ソーシャルエンジニアリング」を利用し、ユーザーにファイルの実行を強制しました。</font><font style="vertical-align: inherit;">最初に、Adobe Flashインストーラーが公式のインストーラーからダウンロードされ、ボットdllがインストーラーと同じディレクトリに書き込まれ、その後インストーラーが起動しました。</font><font style="vertical-align: inherit;">インストーラーが実行されると、ユーザーアカウント制御は、アプリケーションが「Adobe Systems Incorporated」の信頼できるソースによって提供され、ユーザーがこのアプリケーションをインストールする可能性が最も高いというメッセージを表示します（これにより、悪意のあるボットdllが実行されます）。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/nv/9y/me/nv9ymec9x5znwvun7_kiiihga6a.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">これは実際のFlash Playerアップデートですか？</font><font style="vertical-align: inherit;">またはZeroAccess？</font><font style="vertical-align: inherit;">誰も知らない。</font></font></i><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">侵襲性の少ない方法</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
昇格したアカウント権限を必要とするアプリケーションの90％が配置されているフォルダーがあり、このような権限がなくても書き込み可能なフォルダーがあるとします。まあ、そのようなフォルダが存在し、これがフォルダ</font></font><code> %userprofile%Downloads</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。あなたはおそらく私が何をしているのか理解しています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ほとんどのアプリケーションによって読み込まれ、悪意のあるdllのすべての基準を満たしているdllを見つけることを期待していませんでした。約5分間検索した後、金鉱が見つかりました</font></font><code>dwmapi.dll</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。このライブラリはすべての基準を満たすだけでなく、すべてのインストールファイルをダウンロードしました。次に、独自のdllを作成して名前</font></font><code>“dwmapi.dll”</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を付け、Downloadsフォルダーに配置して、インストールファイルを実行します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8w/qr/2u/8wqr2u8hmdbdwm4nkuzb81leen4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
成功！</font><font style="vertical-align: inherit;">ただし、重要なライブラリを交換したため、インストールを開始するとすぐには機能しませんが、これは簡単に修正できます。</font><font style="vertical-align: inherit;">DLLに感染します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">感染DLLの作成</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初は、新しいセクションヘッダーを追加し、PEヘッダーのNumberOfSectionsフィールドを変更してから、セクションをPEファイルの最後に追加するだけでした。</font><font style="vertical-align: inherit;">最後のセクションヘッダーの直後にリンクされたインポートディレクトリがあり、セクションヘッダーによって上書きされることがわかりました。</font><font style="vertical-align: inherit;">したがって、すべてのPEを最初から復元するアプリケーションを約2時間作成した後、リンクされたインポートディレクトリはインポートされたファイルのダウンロードを高速化するためだけに存在し、上書きできるため、PEヘッダーで単純に無効にできることを誰かが思い出させました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の15分間、CTRL + Zを押したままにして、開始した場所に戻り、愚かさを感じました。</font><font style="vertical-align: inherit;">2行のコードの後、感染者は正常に機能し、次のステップに進むことができました。</font><font style="vertical-align: inherit;">これで、感染者はリンクされたインポートディレクトリを切断して新しいセクションヘッダーで書き換え、PEファイルの最後に新しいセクションを追加し、新しいセクションに対応するようにSizeOfImageを調整してから、新しいセクションを指すようにAddressOfEntryPointを変更します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで必要なのは、そこに配置するコードだけです。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">シェルコード</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
追加したセクションに強制的にシェルコードを実行させるのが明白な選択だったので、再配置とインポートについて心配する必要はありません。</font><font style="vertical-align: inherit;">実際のコードは非常にシンプルで、便利なFASMマクロを使用して記述されています。このコードの仕組みについて簡単に説明します。</font></font><br>
<br>
<ul>
<li> ,  ,  dwmapi.dll   DLL_PROCESS_ATTACH;</li>
<li>  Ldr PEB     Kernel32  Ntdll;</li>
<li>   GetProcAddress    : NtOpenProcessToken, NtQueryInformationToken, NtClose, ExpandEnvironmentStringsA, CreateProcessA;</li>
<li>       ,  ,  ,    ,    UAC;</li>
<li>  cmd.exe,     ;</li>
<li>       dwmapi.dll,     .</li>
</ul><br>
<h2>  </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
操作の最終結果により、dwmapi.dllがシェルコードに感染し、ダウンロードフォルダーに配置されます。ユーザーが管理者権限を必要とするインストーラーをダウンロードして実行すると、コマンドラインが管理者として呼び出されます（Wow64FsRedirectとほとんどの設定はwow64で機能します。32ビットと64ビットのWindowsシステムで同じコードを使用できます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
あなたは私のgithubで完全な感染者とシェルコードを見つけることができます：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">//github.com/MalwareTech/UACElevator</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それで全部です。</font><font style="vertical-align: inherit;">コースでお会いしましょう！</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja457068/index.html">キュー-それは何ですか、なぜ、どのように使用しますか？AWS SQSの機能をご覧ください</a></li>
<li><a href="../ja457070/index.html">段ボールの代わりにTextolite。OFFZONE 2019インタラクティブバッジについて一言</a></li>
<li><a href="../ja457072/index.html">Pythonと.NetでMLを使用して古い問題を解決する方法</a></li>
<li><a href="../ja457074/index.html">開発者の進化：将来どのようなゲームが期待できるか</a></li>
<li><a href="../ja457078/index.html">テレグラムアバターを時計に変える方法</a></li>
<li><a href="../ja457086/index.html">「Swift」と「iOS」/「macOS」の世界における建築パターン「ビルダー」</a></li>
<li><a href="../ja457090/index.html">安全ベビーベッド：JWT</a></li>
<li><a href="../ja457092/index.html">MITER ATT＆CKを勉強しています。モバイルマトリックス：デバイスアクセス。パート5</a></li>
<li><a href="../ja457094/index.html">キューブを操作するときにフィルターを簡単に設定できるExcelアドイン（VBA）</a></li>
<li><a href="../ja457096/index.html">いくつかのアナリストに手を貸します：典型的な銀行業務の自動化のためのAPI Livy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>