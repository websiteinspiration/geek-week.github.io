<!doctype html>
<html class="no-js" lang="es">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍🍳 🎗️ 👋🏻 PostgreSQL Antipatterns: lucha contra las hordas de los "muertos" 😉 🤴🏼 👦🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Las características de los mecanismos internos de PostgreSQL permiten que sea muy rápido en algunas situaciones y no tan rápido en otras. Hoy nos dete...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>PostgreSQL Antipatterns: lucha contra las hordas de los "muertos"</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tensor/blog/491366/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las características de los mecanismos internos de PostgreSQL permiten que sea muy rápido en algunas situaciones y no tan rápido en otras. </font><font style="vertical-align: inherit;">Hoy nos detendremos en un ejemplo clásico de un conflicto entre cómo funciona un DBMS y lo que un desarrollador hace con él: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ACTUALIZACIÓN vs principios de MVCC</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Brevemente trama de un </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excelente artículo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando se modifica una línea con el comando ACTUALIZAR, se realizan dos operaciones: BORRAR e INSERTAR. </font><font style="vertical-align: inherit;">En la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versión actual de la línea</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , xmax se establece igual al número de la transacción que realizó ACTUALIZACIÓN. </font><font style="vertical-align: inherit;">Luego </font><font style="vertical-align: inherit;">se crea </font><font style="vertical-align: inherit;">una </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nueva versión de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> la misma línea; </font><font style="vertical-align: inherit;">su valor xmin coincide con el valor xmax de la versión anterior.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algún tiempo después de la finalización de esta transacción, la versión antigua o nueva, según cuál </font></font><code>COMMIT/ROOLBACK</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, será reconocida como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"muerta" (tuplas muertas)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> al pasar </font></font><code>VACUUM</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por la mesa y limpiarse. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/li/dw/rf/lidwrftvhlmkueb4c8rak38feh4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero esto no sucederá de inmediato, pero los problemas con los "muertos" se pueden adquirir muy rápidamente, con </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la actualización</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> múltiple o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">masiva de registros</font></a><font style="vertical-align: inherit;"> en una tabla grande, y un poco más tarde, ante una situación que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VACUUM no podrá ayudar</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1: me gusta moverlo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Supongamos que su método de lógica de negocios funciona por sí mismo y de repente se da cuenta de que sería necesario actualizar el campo X en algún registro:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> X = &lt;newX&gt; <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Luego, a medida que avanza, descubre que el campo Y también debe actualizarse:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> Y = &lt;newY&gt; <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... y luego también Z - ¿por qué jugar algo?</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> Z = &lt;newZ&gt; <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¿Cuántas versiones de este registro tiene ahora en la base de datos? </font><font style="vertical-align: inherit;">Sí, 4 piezas! </font><font style="vertical-align: inherit;">De estos, uno es relevante, y 3 tendrán que recoger [auto] VACUUM por usted. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
¡No hagas así! </font><font style="vertical-align: inherit;">Utilice la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actualización de todos los campos en una solicitud</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ; casi siempre, la lógica del método se puede cambiar así:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> X = &lt;newX&gt;, Y = &lt;newY&gt;, Z = &lt;newZ&gt; <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span>;</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2: ¡El uso ES DISTINTO DE, Luke!</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, aún quería </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actualizar muchos, muchos registros en la tabla</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (durante el uso de un script o convertidor, por ejemplo). </font><font style="vertical-align: inherit;">Y algo como esto vuela en el guión:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> X = &lt;newX&gt; <span class="hljs-keyword">WHERE</span> pk <span class="hljs-keyword">BETWEEN</span> $<span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> $<span class="hljs-number">2</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aproximadamente en este formulario, se encuentra una consulta con bastante frecuencia y casi siempre para no completar un nuevo campo vacío, sino para corregir algunos errores en los datos. </font><font style="vertical-align: inherit;">Además, la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exactitud de los datos ya existentes no se tiene en cuenta en absoluto</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ¡sino en vano! </font><font style="vertical-align: inherit;">Es decir, el registro se está reescribiendo, incluso si era exactamente lo que quería, ¿por qué? </font><font style="vertical-align: inherit;">Correcto:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> X = &lt;newX&gt; <span class="hljs-keyword">WHERE</span> pk <span class="hljs-keyword">BETWEEN</span> $<span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> $<span class="hljs-number">2</span> <span class="hljs-keyword">AND</span> X <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> &lt;newX&gt;;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muchas personas no son conscientes de la existencia de un operador tan maravilloso, así que aquí hay una hoja de trucos para que </font></font><b><code>IS DISTINCT FROM</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">otros operadores lógicos puedan ayudar:</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/js/a3/ci/jsa3ciwigwxqvlfcpyk0vs-zwqk.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... y un poco sobre operaciones en </font></font><code>ROW()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">expresiones </font><font style="vertical-align: inherit;">complejas </font><font style="vertical-align: inherit;">:</font></font><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/xn/3q/4t/xn3q4tiidkye-tdj7-uebntop7a.png"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 3: Reconoceré a mi querido ... bloqueando</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ejecute </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dos procesos paralelos idénticos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cada uno de los cuales está dirigido a la marca de grabación, que está "en funcionamiento":</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> processing = <span class="hljs-literal">TRUE</span> <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Incluso si estos procesos hacen cosas substancialmente independientes entre sí, pero dentro del marco de una ID, en esta solicitud, el segundo cliente "se bloquea" hasta que se complete la primera transacción. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solución n. ° 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : la tarea se reduce a la anterior. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Simplemente agregue nuevamente </font></font><b><code>IS DISTINCT FROM</code></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">UPDATE</span> tbl <span class="hljs-keyword">SET</span> processing = <span class="hljs-literal">TRUE</span> <span class="hljs-keyword">WHERE</span> pk = $<span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> processing <span class="hljs-keyword">IS</span> <span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">FROM</span> <span class="hljs-literal">TRUE</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
De esta forma, la segunda solicitud simplemente no cambiará nada en la base de datos, ya existe "todo como debería", por lo tanto, no se producirá ningún bloqueo. </font><font style="vertical-align: inherit;">Además, el hecho de la "inexistencia" del registro ya se procesa en el algoritmo aplicado. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decisión número 2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : bloqueos de asesoramiento </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un gran tema para un artículo separado en el que puede leer sobre los </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">métodos de aplicación y el "rastrillo" de los bloqueos de recomendación</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solución # 3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : sin [d] llamadas inteligentes </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero exactamente, exactamente, ¿debería tener un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trabajo simultáneo con el mismo registro</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ? </font><font style="vertical-align: inherit;">¿O aún te equivocaste con los algoritmos de llamadas de lógica de negocios del lado del cliente, por ejemplo? </font><font style="vertical-align: inherit;">¿Y si lo piensas? ..</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es491348/index.html">Pruebas en línea: ¿eres serio?</a></li>
<li><a href="../es491350/index.html">Android mitap en Redmadrobot 30 de abril</a></li>
<li><a href="../es491356/index.html">Big Data al servicio del Ministerio de Salud o cómo las tecnologías modernas ayudan a combatir la enfermedad</a></li>
<li><a href="../es491358/index.html">The Witcher paga con una moneda acuñada: analizamos la canción principal de la serie The Witcher en inglés</a></li>
<li><a href="../es491362/index.html">6 de marzo Java Digest</a></li>
<li><a href="../es491372/index.html">Meetup del sistema operativo de robots: 2020 se llevará a cabo en Moscú del 18 al 19 de abril de 2020</a></li>
<li><a href="../es491376/index.html">Estudio estudio</a></li>
<li><a href="../es491382/index.html">Impuestos sobre la renta de Google en Bielorrusia</a></li>
<li><a href="../es491384/index.html">Seguridad de la información Plataforma automatizada de respuesta a incidentes</a></li>
<li><a href="../es491388/index.html">Aléjese de jQuery a Svelte, por así decirlo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>