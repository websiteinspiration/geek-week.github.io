<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüéì üï• üë©üèΩ‚Äçüé® Como automatizamos a migra√ß√£o de produtos de C # para C ++ üõ∞Ô∏è ü§πüèº üö£üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, Habr. Neste post, falarei sobre como conseguimos organizar um lan√ßamento mensal de bibliotecas para a linguagem C ++, cujo c√≥digo fonte √© desenvo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como automatizamos a migra√ß√£o de produtos de C # para C ++</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/495360/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ol√°, Habr. </font><font style="vertical-align: inherit;">Neste post, falarei sobre como conseguimos organizar um lan√ßamento mensal de bibliotecas para a linguagem C ++, cujo c√≥digo fonte √© desenvolvido em C #. </font><font style="vertical-align: inherit;">N√£o se trata de C ++ gerenciado, ou mesmo de criar uma ponte entre C ++ n√£o gerenciado e o ambiente CLR - trata-se de automatizar a gera√ß√£o de c√≥digo C ++ que repete a API e a funcionalidade do c√≥digo C # original.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escrevemos a infraestrutura necess√°ria para traduzir o c√≥digo entre idiomas e emular as fun√ß√µes da biblioteca .Net, resolvendo um problema que geralmente √© considerado acad√™mico. Isso nos permitiu come√ßar a lan√ßar vers√µes mensais de produtos pr√©-Donets tamb√©m para a linguagem C ++, obtendo o c√≥digo de cada vers√£o da vers√£o correspondente do c√≥digo C #. Ao mesmo tempo, os testes que cobriram o c√≥digo original s√£o portados juntamente com ele e permitem controlar o desempenho da solu√ß√£o resultante, juntamente com testes especialmente escritos em C ++.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, descreverei brevemente a hist√≥ria do nosso projeto e as tecnologias usadas nele. </font><font style="vertical-align: inherit;">Vou abordar apenas as quest√µes da justifica√ß√£o econ√¥mica de passagem, uma vez que o lado t√©cnico √© muito mais interessante para mim. </font><font style="vertical-align: inherit;">Nos artigos a seguir da s√©rie, pretendo abordar t√≥picos como gera√ß√£o de c√≥digo e gerenciamento de mem√≥ria, al√©m de outros, se a comunidade tiver perguntas relevantes.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fundo</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Inicialmente, nossa empresa estava envolvida no lan√ßamento de bibliotecas para a plataforma .Net. </font><font style="vertical-align: inherit;">Essas bibliotecas fornecem principalmente APIs para trabalhar com alguns formatos de arquivo (documentos, tabelas, slides, gr√°ficos) e protocolos (email), ocupando um determinado nicho no mercado para essas solu√ß√µes. </font><font style="vertical-align: inherit;">Todo o desenvolvimento foi realizado em C #.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final dos anos 2000, a empresa decidiu entrar em um novo mercado, come√ßando a lan√ßar produtos similares para Java. O desenvolvimento a partir do zero obviamente exigiria um investimento de recursos compar√°veis ‚Äã‚Äãao desenvolvimento inicial de todos os produtos afetados. A op√ß√£o de agrupar o c√≥digo Donnet em uma camada que traduz chamadas e dados de Java para .Net e vice-versa tamb√©m foi rejeitada por alguns motivos. Em vez disso, foi colocada a quest√£o de saber se √© poss√≠vel, de alguma maneira, migrar completamente o c√≥digo existente para a nova plataforma. Isso foi ainda mais relevante, pois n√£o se tratava de uma promo√ß√£o √∫nica, mas de um lan√ßamento mensal de novos lan√ßamentos de cada produto, sincronizados entre dois idiomas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Foi decidido dividir a decis√£o em duas partes. </font><font style="vertical-align: inherit;">O primeiro - o chamado Porter - converteria a sintaxe do c√≥digo-fonte C # em Java, substituindo simultaneamente os tipos e m√©todos .Net pelos equivalentes das bibliotecas Java. </font><font style="vertical-align: inherit;">A segunda - a Biblioteca - emularia o trabalho daquelas partes da biblioteca .Net para as quais √© dif√≠cil ou imposs√≠vel estabelecer correspond√™ncia direta com Java, atraindo componentes de terceiros dispon√≠veis para isso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A favor da viabilidade principal de tal plano, falou o seguinte:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ideologicamente, as linguagens C # e Java s√£o bastante semelhantes - pelo menos, com a estrutura dos tipos e a organiza√ß√£o do trabalho com mem√≥ria;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tratava-se de portar bibliotecas, n√£o havia necessidade de portar a GUI;</font></font></li>
<li>  ,  , -    ,        System.Net  System.Drawing;</li>
<li>   ,        .Net ( Framework,   Standard   Xamarin),          .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o vou entrar em detalhes, pois eles merecem um artigo separado (e n√£o um). </font><font style="vertical-align: inherit;">S√≥ posso dizer que demorou cerca de dois anos desde o in√≠cio do desenvolvimento at√© o lan√ßamento do primeiro produto Java e, desde ent√£o, o lan√ßamento de produtos Java se tornou uma pr√°tica regular da empresa. </font><font style="vertical-align: inherit;">Durante o desenvolvimento do projeto, o porteiro evoluiu de um utilit√°rio simples que converte texto de acordo com regras estabelecidas, para um gerador de c√≥digo complexo que trabalha com a representa√ß√£o AST do c√≥digo fonte. </font><font style="vertical-align: inherit;">A biblioteca tamb√©m est√° cheia de c√≥digo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O sucesso da dire√ß√£o Java determinou o desejo da empresa de expandir ainda mais para novos mercados e, em 2013, foi levantada a quest√£o sobre o lan√ßamento de produtos para a linguagem C ++ em um cen√°rio semelhante.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Formula√ß√£o do problema</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para garantir o lan√ßamento de vers√µes positivas de produtos, era necess√°rio criar uma estrutura que permitisse obter o c√≥digo C ++ a partir de um c√≥digo C # arbitr√°rio, compil√°-lo, verific√°-lo e entreg√°-lo ao cliente. Tratava-se de bibliotecas com volumes que variavam de v√°rias centenas de milhares a v√°rios milh√µes de linhas (excluindo depend√™ncias).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao mesmo tempo, a experi√™ncia com um porteiro Java foi levada em considera√ß√£o: inicialmente, quando era apenas uma ferramenta simples para converter sintaxes, surgiu naturalmente a pr√°tica de finalizar manualmente o c√≥digo portado. No curto prazo, focado na r√°pida libera√ß√£o de produtos, isso foi relevante, pois permitiu acelerar o processo de desenvolvimento, no entanto, a longo prazo, isso aumentou significativamente os custos de prepara√ß√£o de cada vers√£o, devido √† necessidade de corrigir cada erro de tradu√ß√£o toda vez que ocorre.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Obviamente, essa complexidade era gerenci√°vel - pelo menos transferindo apenas os patches para o c√≥digo Java resultante, que s√£o calculados como a diferen√ßa entre a sa√≠da do porteiro nas pr√≥ximas duas revis√µes do c√≥digo C #. Essa abordagem tornou poss√≠vel corrigir cada linha portada apenas uma vez e no futuro usar o c√≥digo j√° desenvolvido, onde nenhuma altera√ß√£o foi feita. No entanto, ao desenvolver um carregador positivo, o objetivo era livrar-se do est√°gio de corre√ß√£o do c√≥digo portado, em vez de corrigir a pr√≥pria estrutura. Assim, cada erro de convers√£o arbitrariamente raro seria corrigido uma vez no c√≥digo do porter, e essa corre√ß√£o se aplicaria a todas as vers√µes futuras de todos os produtos portados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al√©m do carregador, tamb√©m era necess√°rio o desenvolvimento de uma biblioteca em C ++ que resolvesse os seguintes problemas:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Emula√ß√£o do ambiente .Net na medida em que √© necess√°rio que o c√≥digo portado funcione;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adapta√ß√£o do c√≥digo C # portado √†s realidades do C ++ (estrutura de tipo, gerenciamento de mem√≥ria, outro c√≥digo de servi√ßo);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suavizando as diferen√ßas entre o ‚ÄúC # reescrito‚Äù e o pr√≥prio C ++, para tornar mais f√°cil para os programadores n√£o familiarizados com os paradigmas .Net usarem o c√≥digo portado.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por raz√µes √≥bvias, nenhuma tentativa foi feita para mapear diretamente tipos .Net para tipos da biblioteca padr√£o. </font><font style="vertical-align: inherit;">Em vez disso, decidiu-se sempre usar tipos de sua biblioteca como um substituto para os tipos Donnet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muitos leitores perguntam imediatamente por que eles n√£o usaram implementa√ß√µes existentes como o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mono</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Havia raz√µes para isso.</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao atrair uma biblioteca finalizada, seria poss√≠vel satisfazer apenas o primeiro requisito, mas n√£o o segundo e nem o terceiro.</font></font></li>
<li> Mono   C# ,  ,   ,       .</li>
<li>      (API,  ,   ,   C++,   )   ,     .</li>
<li>    ,    .Net,                  .  ,           ,      .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Teoricamente, essa biblioteca poderia ser convertida em C ++ inteiramente usando uma porta, no entanto, isso exigiria um carregador totalmente funcional no in√≠cio do desenvolvimento, uma vez que, sem uma biblioteca do sistema, a depura√ß√£o de qualquer c√≥digo portado √© imposs√≠vel em princ√≠pio. Al√©m disso, a quest√£o de otimizar o c√≥digo traduzido da biblioteca do sistema seria ainda mais aguda do que o c√≥digo dos produtos portados, j√° que as chamadas para a biblioteca do sistema tendem a se tornar um gargalo. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, decidiu-se desenvolver a biblioteca como um conjunto de adaptadores que fornecem acesso a fun√ß√µes j√° implementadas em bibliotecas de terceiros, mas por meio de uma API do tipo .Net (semelhante ao Java). Isso reduziria o trabalho e usaria componentes C ++ prontos, j√° otimizados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um requisito importante para a estrutura era que o c√≥digo portado tivesse que poder trabalhar como parte dos aplicativos do usu√°rio (no que diz respeito √†s bibliotecas). Isso significava que o modelo de gerenciamento de mem√≥ria deveria ter sido esclarecido para os programadores de C ++, pois n√£o podemos for√ßar o c√≥digo arbitr√°rio do cliente para executar em um ambiente de coleta de lixo. O uso de ponteiros inteligentes foi escolhido como modelo de compromisso. Sobre como conseguimos garantir essa transi√ß√£o (em particular, resolver o problema das refer√™ncias circulares), discutirei em um artigo separado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outro requisito era a capacidade de portar n√£o apenas bibliotecas, mas tamb√©m testes para elas. </font><font style="vertical-align: inherit;">A empresa possui uma alta cultura de cobertura de teste de seus produtos, e a capacidade de executar em C ++ os mesmos testes que foram escritos para o c√≥digo original simplificaria bastante a busca por problemas ap√≥s a tradu√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os requisitos restantes (formato de lan√ßamento, cobertura de teste, tecnologia etc.) diziam respeito principalmente aos m√©todos de trabalho com o projeto e no projeto. </font><font style="vertical-align: inherit;">Eu n√£o vou insistir neles.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hist√≥ria</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de continuar, tenho que dizer algumas palavras sobre a estrutura da empresa. A empresa trabalha remotamente, todas as equipes nela s√£o distribu√≠das. O desenvolvimento de um determinado produto geralmente √© de responsabilidade de uma equipe, unida por idioma (quase sempre) e geografia (principalmente). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O trabalho ativo no projeto come√ßou no outono de 2013. Devido √† estrutura distribu√≠da da empresa, e tamb√©m devido a algumas d√∫vidas sobre o sucesso do desenvolvimento, tr√™s vers√µes do framework foram lan√ßadas imediatamente: duas delas serviam um produto cada, a terceira abrangia tr√™s de uma s√≥ vez. Supunha-se que isso interromperia o desenvolvimento de solu√ß√µes menos eficazes e realocaria os recursos, se necess√°rio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No futuro, mais quatro equipes ingressaram no trabalho na estrutura ‚Äúcomum‚Äù, duas das quais reconsideraram sua decis√£o posteriormente e se recusaram a lan√ßar produtos para C ++. No in√≠cio de 2017, foi tomada uma decis√£o para interromper o desenvolvimento de uma das solu√ß√µes "individuais" e transferir a equipe correspondente para trabalhar com uma estrutura "comum". O desenvolvimento interrompido assumiu o uso do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Boehm GC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> como um meio de gerenciamento de mem√≥ria e continha uma implementa√ß√£o muito mais rica de algumas partes da biblioteca do sistema, que depois foi transferida para a solu√ß√£o "geral".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, dois desenvolvimentos chegaram √† linha de chegada - ou seja, ao lan√ßamento de produtos portados - um ‚Äúindividual‚Äù e um ‚Äúcoletivo‚Äù. Os primeiros lan√ßamentos baseados em nossa estrutura ("comum") ocorreram em fevereiro de 2018. Posteriormente, os lan√ßamentos de todas as seis equipes que usam essa solu√ß√£o se tornaram mensais, e o pr√≥prio framework foi lan√ßado como um produto separado da empresa. At√© a quest√£o foi levantada para torn√°-lo de c√≥digo aberto, mas essa discuss√£o ainda n√£o se desenvolveu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A equipe, que continuou trabalhando de forma independente em uma estrutura semelhante, tamb√©m lan√ßou seu primeiro lan√ßamento em C ++ em 2018.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Os primeiros lan√ßamentos continham vers√µes truncadas dos produtos originais, o que permitiu adiar o trabalho de transmiss√£o de pe√ßas sem import√¢ncia, tanto quanto poss√≠vel. </font><font style="vertical-align: inherit;">Nas libera√ß√µes subsequentes, ocorreu uma adi√ß√£o parcial de funcionalidade (e est√° ocorrendo).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Organiza√ß√£o do trabalho no projeto</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A organiza√ß√£o do trabalho conjunto no projeto por v√°rias equipes conseguiu sofrer mudan√ßas significativas. Inicialmente, foi decidido que uma grande equipe ‚Äúcentral‚Äù seria respons√°vel pelo desenvolvimento, suporte e corre√ß√£o da estrutura, enquanto as pequenas equipes de ‚Äúproduto‚Äù envolvidas no lan√ßamento de produtos finais em C ++ seriam as principais respons√°veis ‚Äã‚Äãpor tentar portar seus c√≥digo e fornecer feedback (informa√ß√µes sobre erros de portabilidade, compila√ß√£o e execu√ß√£o). Esse esquema, no entanto, acabou sendo improdutivo, uma vez que a equipe central estava sobrecarregada com solicita√ß√µes de todas as equipes de "produtos" e n√£o p√¥de seguir em frente at√© que os problemas encontrados fossem resolvidos.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por raz√µes que s√£o amplamente independentes do estado desse desenvolvimento espec√≠fico, foi decidido dissolver a equipe ‚Äúcentral‚Äù e transferir pessoas para as equipes de ‚Äúprodutos‚Äù, que agora eram respons√°veis ‚Äã‚Äãpor fixar a estrutura de acordo com suas necessidades. Nesse caso, cada equipe em si tomaria uma decis√£o sobre usar suas bases comuns ou gerar sua pr√≥pria bifurca√ß√£o do projeto. Essa declara√ß√£o da pergunta era relevante para a estrutura Java, cujo c√≥digo era est√°vel na √©poca, mas era necess√°ria a consolida√ß√£o de esfor√ßos para preencher a biblioteca C ++ o mais r√°pido poss√≠vel, para que as equipes continuassem trabalhando juntas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Essa forma de trabalho tamb√©m teve suas desvantagens, portanto, no futuro, outra reforma foi realizada. A equipe ‚Äúcentral‚Äù foi restaurada, embora em uma composi√ß√£o menor, mas com fun√ß√µes diferentes: agora n√£o era respons√°vel pelo desenvolvimento real do projeto, mas pela organiza√ß√£o do trabalho conjunto. Isso incluiu suporte para o ambiente de IC, organiza√ß√£o de pr√°ticas de solicita√ß√£o de mesclagem, realiza√ß√£o de reuni√µes regulares com participantes do desenvolvimento, documenta√ß√£o de suporte, cobertura de testes, ajuda com solu√ß√µes de arquitetura e solu√ß√£o de problemas, etc. Al√©m disso, a equipe assumiu o trabalho para eliminar a d√≠vida t√©cnica e outras √°reas de uso intensivo de recursos. Nesse modo, o desenvolvimento continua at√© hoje.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, o projeto foi iniciado pelos esfor√ßos de v√°rios (cerca de cinco) desenvolvedores e, na melhor das hip√≥teses, contou com cerca de vinte pessoas. Cerca de dez a quinze pessoas respons√°veis ‚Äã‚Äãpelo desenvolvimento e suporte da estrutura e pelo lan√ßamento de seis produtos portados podem ser considerados um valor est√°vel nos √∫ltimos anos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O autor dessas linhas ingressou na empresa em meados de 2016, come√ßando a trabalhar em uma das equipes que transmitiam seu c√≥digo usando uma solu√ß√£o "comum". No inverno do mesmo ano, quando foi decidido recriar a equipe ‚Äúcentral‚Äù, mudei para a posi√ß√£o de l√≠der da equipe. Assim, minha experi√™ncia no projeto hoje √© de mais de tr√™s anos e meio.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A autonomia das equipes respons√°veis ‚Äã‚Äãpelo lan√ßamento de produtos portados levou ao fato de que, em alguns casos, tornou-se mais f√°cil para os desenvolvedores suplementar o carregador com modos operacionais do que comprometer o modo como ele deveria se comportar por padr√£o. </font><font style="vertical-align: inherit;">Isso explica mais do que voc√™ poderia esperar, o n√∫mero de op√ß√µes dispon√≠veis ao configurar o carregador.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tecnologias</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
√â hora de falar sobre as tecnologias usadas no projeto. O Porter √© um aplicativo de console escrito em C #, pois, dessa forma, √© mais f√°cil incorporar scripts que executam tarefas como "testes de execu√ß√£o de compila√ß√£o de portas". Al√©m disso, existe um componente da GUI que permite alcan√ßar os mesmos objetivos clicando nos bot√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A antiga biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NRefactory</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© respons√°vel por analisar o c√≥digo e resolver a sem√¢ntica </font><font style="vertical-align: inherit;">. Infelizmente, no momento em que o projeto come√ßou, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Roslyn</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ainda n√£o estava dispon√≠vel, embora a migra√ß√£o para ele, √© claro, esteja em nossos planos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Porter usa passarelas de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">madeira AST</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para coletar informa√ß√µes e gerar c√≥digo de sa√≠da C ++. Quando o c√≥digo C ++ √© gerado, a representa√ß√£o AST n√£o √© criada e todo o c√≥digo √© salvo como texto sem formata√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em muitos casos, o carregador precisa de informa√ß√µes adicionais para o ajuste fino. Essa informa√ß√£o √© transmitida a ele na forma de op√ß√µes e atributos. As op√ß√µes se aplicam a todo o projeto imediatamente e permitem definir, por exemplo, os nomes dos membros da macro de exporta√ß√£o das classes ou as defini√ß√µes do pr√©-processador C # usadas na an√°lise de c√≥digo. Os atributos dependem de tipos e entidades e determinam o processamento espec√≠fico a eles (por exemplo, a necessidade de gerar palavras-chave ‚Äúconst‚Äù ou ‚Äúmut√°vel‚Äù para os membros da classe ou exclu√≠-los da portabilidade).</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As classes e estruturas C # s√£o convertidas em classes C ++, seus membros e c√≥digo execut√°vel s√£o convertidos nos equivalentes mais pr√≥ximos. Tipos e m√©todos gen√©ricos s√£o mapeados para modelos C ++. Os links C # s√£o traduzidos em ponteiros inteligentes (fortes ou fracos) definidos na Biblioteca. Mais detalhes sobre os princ√≠pios do carregador ser√£o discutidos em um artigo separado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, o assembly C # original √© convertido em um projeto C ++, que em vez de bibliotecas .Net depende da nossa biblioteca compartilhada. Isso √© mostrado no diagrama a seguir: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/of/d1/s-/ofd1s-pimst_5rrcxzz8t-fh0nq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
cmake √© usado para construir a biblioteca e os projetos portados. Atualmente, os compiladores VS 2017 e 2019 (Windows), GCC e Clang (Linux) s√£o suportados.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como mencionado acima, a maioria de nossas implementa√ß√µes .Net s√£o camadas finas de bibliotecas de terceiros que fazem a maior parte do trabalho. </font><font style="vertical-align: inherit;">Inclui:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Skia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para trabalhar com gr√°ficos;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Botan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para suportar fun√ß√µes de criptografia;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UTI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para trabalhar com strings, codifica√ß√µes e culturas;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Libxml2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para trabalhar com XML;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PCRE2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para trabalhar com express√µes regulares;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zlib</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para implementar fun√ß√µes de compacta√ß√£o;</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Impulso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - para v√°rios prop√≥sitos;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√°rias outras bibliotecas.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O carregador e a biblioteca s√£o abordados em v√°rios testes. </font><font style="vertical-align: inherit;">Os testes da biblioteca usam a estrutura gtest. </font><font style="vertical-align: inherit;">Os testes do Porter s√£o escritos principalmente em NUnit / xUnit e s√£o divididos em v√°rias categorias, certificando que:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a sa√≠da do porteiro nesses arquivos de entrada corresponde ao destino;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a sa√≠da dos programas portados ap√≥s a compila√ß√£o e o lan√ßamento coincide com o destino;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os testes NUnit de projetos de entrada s√£o convertidos com √™xito em testes gtest em projetos portados e passam;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A API Ported Projects funciona com √™xito em C ++;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o impacto de op√ß√µes e atributos individuais no processo de tradu√ß√£o √© o esperado.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Usamos o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitLab</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para armazenar o c√≥digo fonte </font><font style="vertical-align: inherit;">. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jenkins foi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> escolhido como o ambiente de IC </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Os produtos portados est√£o dispon√≠veis como pacotes Nuget e como arquivos de download.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Problemas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Enquanto trabalhamos no projeto, tivemos que enfrentar muitos problemas. </font><font style="vertical-align: inherit;">Alguns deles eram esperados, enquanto outros j√° apareciam no processo. </font><font style="vertical-align: inherit;">Listamos brevemente os principais.</font></font><br>
<br>
<ol>
<li><b>     .Net  C++.</b><br>
  ,   C++    Object,       RTTI.           .Net   STL.</li>
<li><b>   .</b><br>
       ,          ,    . ,  C#     ,   C++ ‚Äî .</li>
<li><b>  .</b><br>
   ‚Äî   .          ,   .   ,            .</li>
<li><b>    .</b><br>
 C++   ,        ,        .</li>
<li><b>    C#.</b><br>
 C#    ,      C++.    ,     :<br>
<br>
<ul>
<li>   ,    ;</li>
<li>   ,       (,       yeild);</li>
<li>,      (,            ,       ,        C#);</li>
<li>,   C++ (,  C#        foreground-).</li>
</ul></li>
<li><b>  .</b><br>
,        .Net  ,          .</li>
<li><b>   .</b><br>
- ,     ,        ¬´¬ª ,     .  ,  ,  ,     ,     using,             -.                 .   ,             .</li>
<li><b> .</b><br>
         ,    ,   ,  ,   ,    /     -          .</li>
<li><b>    .</b><br>
     .       ,           .    ,       ,      ,     .</li>
<li><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dificuldades com a prote√ß√£o da propriedade intelectual. </font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se o c√≥digo C # for facilmente ofuscado por solu√ß√µes in a box, em C ++ voc√™ precisar√° fazer esfor√ßos adicionais, pois muitos membros da classe n√£o podem ser exclu√≠dos dos arquivos de cabe√ßalho sem consequ√™ncias. </font><font style="vertical-align: inherit;">A convers√£o de classes e m√©todos gen√©ricos em modelos tamb√©m cria vulnerabilidades, expondo algoritmos.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apesar disso, o projeto √© muito interessante do ponto de vista t√©cnico. </font><font style="vertical-align: inherit;">Trabalhar nele permite que voc√™ aprenda muito e aprenda muito. </font><font style="vertical-align: inherit;">A natureza acad√™mica da tarefa tamb√©m contribui para isso.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sum√°rio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como parte do projeto, fomos capazes de implementar um sistema que resolve um problema acad√™mico interessante em prol de sua aplica√ß√£o pr√°tica direta. Organizamos uma edi√ß√£o mensal das bibliotecas da empresa em um idioma para o qual elas n√£o foram originalmente projetadas. Verificou-se que a maioria dos problemas √© completamente solucion√°vel e a solu√ß√£o resultante √© confi√°vel e pr√°tica. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em breve, est√° prevista a publica√ß√£o de mais dois artigos. Um deles descrever√° em detalhes, com exemplos, como um carregador funciona e como as constru√ß√µes C # s√£o exibidas em C ++. Em outro discurso, falaremos sobre como conseguimos garantir a compatibilidade de modelos de mem√≥ria de dois idiomas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vou tentar responder √†s perguntas nos coment√°rios. </font><font style="vertical-align: inherit;">Se os leitores mostrarem interesse em outros aspectos de nosso desenvolvimento e as respostas come√ßarem a ir al√©m da correspond√™ncia nos coment√°rios, consideraremos a possibilidade de publicar novos artigos.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt495344/index.html">Unifique-o: como a Lamoda torna seus servi√ßos Go consistentes</a></li>
<li><a href="../pt495346/index.html">Do erro ao alerta com a√ß√µes</a></li>
<li><a href="../pt495350/index.html">Servidor Web dom√©stico ou seu pr√≥prio provedor de hospedagem</a></li>
<li><a href="../pt495354/index.html">Como liberar produtos continuamente em 20 idiomas e n√£o morrer?</a></li>
<li><a href="../pt495356/index.html">Implementando o algoritmo de consenso RAFT para armazenamento KV distribu√≠do em Java</a></li>
<li><a href="../pt495362/index.html">Auto-isolamento e programa: como n√£o enlouquecer em casa e passar um tempo √∫til</a></li>
<li><a href="../pt495364/index.html">Guia de Estilo da API ou n√£o fa√ßa os usu√°rios pensarem</a></li>
<li><a href="../pt495366/index.html">16 tipos de programadores ou desenvolvedores n√£o s√£o os mesmos rob√¥s</a></li>
<li><a href="../pt495368/index.html">N√≥s nos auto-registramos em auto-c√£es que andam em condi√ß√µes de auto-isolamento</a></li>
<li><a href="../pt495370/index.html">P√∫blico √© mau</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>