<!doctype html>
<html class="no-js" lang="pt">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🈵 👨🏻‍🎓 👎🏽 Como o histograma do Prometheus funciona? 👨🏽‍🤝‍👨🏻 💇🏻 🦉</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma tradução do artigo foi preparada antes do início do curso "Monitoramento e registro: Zabbix, Prometheus, ELK" .
 
 
 
 Anteriormente, examinamos u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Como o histograma do Prometheus funciona?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/501978/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma tradução do artigo foi preparada antes do início do curso </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Monitoramento e registro: Zabbix, Prometheus, ELK"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/bb/b2/rl/bbb2rlroxgbryy_noc1mg9urkos.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anteriormente, examinamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um contador</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um medidor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um resumo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Agora vamos falar sobre como o histograma funciona no Prometheus.</font></font><a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O histograma tem algumas semelhanças com o resumo. </font><font style="vertical-align: inherit;">Um histograma é uma combinação de vários contadores. </font><font style="vertical-align: inherit;">Como métricas sumárias, histograma métricas são usados para rastrear indicadores dimensionais de eventos, muitas vezes a sua duração, usando o método </font></font><code>observe</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As ferramentas de cronometragem geralmente são iguais aos boletins. </font><font style="vertical-align: inherit;">O que eles diferem é no processamento de quantis. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A seguir, é apresentado um exemplo de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um formato de exposição</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> marcado com Prometheus </font></font><code>handler</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs"># HELP prometheus_http_request_duration_seconds Histogram of latencies for HTTP requests.<font></font>
# TYPE prometheus_http_request_duration_seconds histogram<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="0.1"} 25547<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="0.2"} 26688<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="0.4"} 27760<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="1"} 28641<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="3"} 28782<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="8"} 28844<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="20"} 28855<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="60"} 28860<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="120"} 28860<font></font>
prometheus_http_request_duration_seconds_bucket{handler="/",le="+Inf"} 28860<font></font>
prometheus_http_request_duration_seconds_sum{handler="/"} 1863.80491025699<font></font>
prometheus_http_request_duration_seconds_count{handler="/"} 28860</code></pre><br>
<code>_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e eles </font></font><code>_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">funcionam exatamente da mesma maneira que no resumo e podem ser usados ​​para obter o tempo médio de execução nos últimos cinco minutos:</font></font><br>
<br>
<pre><code class="xml hljs"> rate(prometheus_http_request_duration_seconds_sum[5m]<font></font>
/<font></font>
  rate(prometheus_http_request_duration_seconds_count[5m])</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No entanto, existem casos muito raros em que ele está </font></font><code>_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ausente, por exemplo, em algumas métricas do exportador MySQLd. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma parte notável do histograma são as séries temporais </font></font><code>_bucket</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que na verdade são a parte do histograma da métrica. Mais especificamente, esses são contadores que formam um histograma cumulativo. </font></font><code>le</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">denotar menor ou igual a. Assim, 26688 solicitações levaram menos que ou igual a 200ms, 27760 solicitações levaram menos que ou igual a 400ms e houve 28860 solicitações no total. Os valores no balde serão monotonicamente não decrescentes e o </font></font><code>+Inf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">balde terá o maior valor. </font></font><code>+Inf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o balde deve estar sempre presente e corresponder ao valor </font></font><code>_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para calcular, digamos, um quantil de 0,9 (o percentil 90), você deve usar:</font></font><br>
<br>
<pre><code class="xml hljs">histogram_quantile(0.9, <font></font>
  rate(prometheus_http_request_duration_seconds_bucket[5m])<font></font>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Uma grande vantagem dos histogramas sobre os resumos é que você pode agregar baldes antes de calcular o quantil - tomando cuidado para não perder o rótulo </font></font><code>le</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="xml hljs">histogram_quantile(0.9, <font></font>
  sum without (handler)(<font></font>
    rate(prometheus_http_request_duration_seconds_bucket[5m])<font></font>
  )<font></font>
)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Além da agregação, os histogramas são mais baratos para o cliente, pois os contadores são rapidamente incrementados. </font><font style="vertical-align: inherit;">Então, por que não usar histogramas sempre? </font><font style="vertical-align: inherit;">Há uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">resposta longa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas a versão resumida é que, com os histogramas, você deve primeiro selecionar seu bucket, e os custos são transferidos do cliente para o próprio Prometheus devido ao número de elementos do bucket. Por padrão, dez depósitos cobrem um serviço Web típico com um atraso que varia de milissegundos a um segundo e, em alguns casos, pode ser necessário alterar isso. Aqui, por exemplo, eles foram redefinidos para controlar melhor as consultas PromQL, que por padrão têm um tempo limite de dois minutos. Ter mais de uma dúzia de bucket-s fornecerá resultados mais precisos, mas também poderá produzir muitas séries temporais. Especialmente em combinação com outras tags.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ao usar um sistema de monitoramento em tempo real como o Prometheus, o objetivo deve ser fornecer valor analítico suficiente para tomar decisões de engenharia com base nele. Por exemplo, saber que o atraso do percentil 90 aumentou 50 ms é mais importante do que saber se ele agora é 562 ms ou 563 ms e, normalmente, dez buckets são suficientes para isso. Se você precisar de uma resposta exata, sempre poderá calculá-la posteriormente em seus registros. Se houver muitos buckets, eles poderão ser descartados durante o processamento dos dados, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conforme mostrado anteriormente</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Em casos mais extremos, você pode ignorar completamente a série de se </font></font><code>_bucket</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">confiar na média de </font></font><code>_sum</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>_count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em conclusão, os histogramas permitem o cálculo agregado de quantis, embora o número de elementos deva ser levado em consideração. </font><font style="vertical-align: inherit;">Lembre-se de que um resumo sem quantis é uma opção mais barata se você não precisar de um histograma.</font></font><br>
<br>
<hr><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mais sobre o curso</font></font></a><br>
<br>
<hr></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt501960/index.html">Escala de pesquisa. Elasticsearch Suas vantagens e requisitos básicos para instalação</a></li>
<li><a href="../pt501964/index.html">Para que servem os computadores industriais?</a></li>
<li><a href="../pt501968/index.html">Modelo de arquitetura MVI na multiplataforma Kotlin, parte 1</a></li>
<li><a href="../pt501970/index.html">O que você precisa para criar uma boa masmorra em RPG?</a></li>
<li><a href="../pt501976/index.html">Como aprender a testar o software</a></li>
<li><a href="../pt501980/index.html">A história de um projeto ou como eu criei 7 anos de PBX baseado em Asterisk e Php</a></li>
<li><a href="../pt501982/index.html">Como transferir um shader de um mecanismo de jogo para o Substance Painter</a></li>
<li><a href="../pt501984/index.html">O que ver em quarentena? Uma seleção de materiais da Technostream (parte 4)</a></li>
<li><a href="../pt501986/index.html">Segredos do incrível sucesso do Apple AirPods</a></li>
<li><a href="../pt501988/index.html">Como a tela da mensagem VK é renderizada?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>