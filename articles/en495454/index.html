<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∂ üêâ üèòÔ∏è Brief Introduction to BPF and eBPF üê† üò∞ üßíüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! We inform you that we are preparing to release the book " Linux Observability with BPF ".
 
 
 As the BPF virtual machine continues to ev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Brief Introduction to BPF and eBPF</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/495454/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello, Habr! </font><font style="vertical-align: inherit;">We inform you that we are preparing to release the book " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux Observability with BPF</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ".</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/pw/bv/rl/pwbvrl5-5goay7zxvi8tb3fisrc.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As the BPF virtual machine continues to evolve and is actively applied in practice, we have translated an article for you that describes its main features and current status.</font></font><br>
<a name="habracut"></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In recent years, programming tools and techniques have begun to gain in popularity, designed to compensate for the limitations of the Linux kernel in cases where high-performance package processing is required. One of the most popular methods of this kind is called </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bypassing the kernel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (kernel bypass) and lets passing network layer cores perform all packet processing from user space. Bypassing the kernel also involves managing the network card from </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user space</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In other words, when working with a network card, we rely on the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user space</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> driver </font><font style="vertical-align: inherit;">.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
By transferring full control over the network card to the program from user space, we reduce the costs associated with the kernel (switching context, processing the network level, interrupts, etc.), which is quite important when working at speeds of 10Gb / s or higher. Kernel bypass plus a combination of other features ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch processing</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) and accurate performance tuning ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NUMA accounting</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CPU isolation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , etc.) correspond to the basics of high-performance network processing in user space. Perhaps a model example of this new approach to package processing is </font><font style="vertical-align: inherit;">Intel's </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DPDK</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data Plane Development Kit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), although there are other well-known tools and techniques, including VPP from Cisco (Vector Packet Processing), Netmap and, of course, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Snabb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The organization of network interactions in user space has a number of disadvantages:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The kernel of the OS is the level of abstraction for hardware resources. </font><font style="vertical-align: inherit;">Because user-space programs have to manage their resources directly, they also have to manage their own hardware. </font><font style="vertical-align: inherit;">This often means that you need to program your own drivers.</font></font></li>
<li>      ,        ,  .        , , ,      .</li>
<li>    ,               .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In essence, when organizing network interactions in user space, increasing productivity is achieved by transferring packet processing from the kernel to user space. XDP does exactly the opposite: moves network programs from user space (filters, converters, routing, etc.) to the kernel area. XDP allows us to perform a network function as soon as the packet arrives at the network interface and before it begins to move up into the network subsystem of the kernel. As a result, packet processing speed increases significantly. However, how does the kernel allow the user to execute their programs in kernel space? Before answering this question, let's look at what BPF is. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF and eBPF</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despite the not-so-clear name BPF (Packet Filtering, Berkeley), it is, in fact, a virtual machine model. </font><font style="vertical-align: inherit;">This virtual machine was originally designed to handle packet filtering, hence the name. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the best known tools using BPF is </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">When capturing packets with, the </font></font><code>tcpdump</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">user can specify an expression to filter packets. </font><font style="vertical-align: inherit;">Only packets matching this expression will be captured. </font><font style="vertical-align: inherit;">For example, the expression ‚Äú </font></font><code>tcp dst port 80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äù applies to all TCP packets arriving at port 80. The compiler can shorten this expression by converting it to BPF bytecode. </font><font style="vertical-align: inherit;">
Here is what the above program basically does:</font></font><br>
<br>
<code>$ sudo tcpdump -d "tcp dst port 80"<br>
(000) ldh [12]<br>
(001) jeq #0x86dd jt 2 jf 6<br>
(002) ldb [20]<br>
(003) jeq #0x6 jt 4 jf 15<br>
(004) ldh [56]<br>
(005) jeq #0x50 jt 14 jf 15<br>
(006) jeq #0x800 jt 7 jf 15<br>
(007) ldb [23]<br>
(008) jeq #0x6 jt 9 jf 15<br>
(009) ldh [20]<br>
(010) jset #0x1fff jt 15 jf 11<br>
(011) ldxb 4*([14]&amp;0xf)<br>
(012) ldh [x + 16]<br>
(013) jeq #0x50 jt 14 jf 15<br>
(014) ret #262144<br>
(015) ret #0</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instruction (000): downloads a packet at offset 12 as a 16-bit word into the battery. </font><font style="vertical-align: inherit;">An offset of 12 corresponds to an ethertype packet.</font></font></li>
<li> (001):      0x86dd,  ,  ethertype-  IPv6.    true,       (002),    ‚Äì   (006).</li>
<li> (006):    0x800 (ethertype-  IPv4).   true,     (007),   ‚Äì   (015).</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And so on, until the packet filtering program returns a result. This is usually a bulean. Returning a non-zero value (instruction (014)) means that the packet has approached, and returning zero (instruction (015)) means that the packet has not arrived. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The BPF virtual machine and its bytecode were proposed by Steve McCann and Van Jacobson in late 1992 when their article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BSD Packet Filter: A New Architecture for Packet Capture at the User Level</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , was first introduced at a Usenix conference in the winter of 1993.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Because BPF is a virtual machine, it defines the environment in which programs run. In addition to the bytecode, it also defines a batch memory model (boot instructions are implicitly applied to the package), registers (A and X; battery and index registers), scratch memory storage, and an implicit program counter. Interestingly, the BPF bytecode was modeled after the Motorola 6502 ISA. As Steve McCann recalled in his </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">plenary talk</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> at Sharkfest '11, he had been familiar with the 6502 build since high school when he programmed in Apple II, and this knowledge influenced his work on designing BPF bytecode.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Support for BPF is implemented in the Linux kernel in version v2.5 and higher, added mainly by the efforts of Jay Schullist. The BPF code remained unchanged until 2011, when Eric Dumazett redid the BPF interpreter to work in JIT mode (Source: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JIT for packet filters</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). After that, the kernel, instead of interpreting the BPF byte code, could directly convert the BPF programs to the target architecture: x86, ARM, MIPS, etc.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Later, in 2014, Alexey Starovoitov proposed a new JIT mechanism for BPF. </font><font style="vertical-align: inherit;">In fact, this new JIT has become the new BPF-based architecture and is called eBPF. </font><font style="vertical-align: inherit;">I think that for some time both virtual machines coexisted, but currently packet filtering is implemented based on eBPF. </font><font style="vertical-align: inherit;">In fact, in many examples of modern documentation, BPF is understood to mean eBPF, and classical BPF is now known as cBPF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
eBPF extends the classic BPF virtual machine in several ways:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Based on modern 64-bit architectures. </font><font style="vertical-align: inherit;">eBPF uses 64-bit registers and increases the number of available registers from 2 (battery and X) to 10. eBPF also provides additional operation codes (BPF_MOV, BPF_JNE, BPF_CALL ...).</font></font></li>
<li>    . BPF      .      ,     ,   . ,   eBPF            . ,   eBPF    tracepoint   kprobe.      eBPF,            .   eBPF    : kernel/bpf.</li>
<li>     .  ‚Äì    ¬´-¬ª,         .  eBPF    .</li>
<li> .  ,   ,      .            .  ,   eBPF    .</li>
<li> .    eBPF  4096 .      eBPF    eBPF-       (     32 ).</li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF: An Example</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
There are several examples for eBPF in the Linux kernel sources. </font><font style="vertical-align: inherit;">They are available at samples / bpf /. </font><font style="vertical-align: inherit;">To compile these examples, simply enter: </font></font><br>
<br>
<code>$ sudo make samples/bpf/</code><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I will not write a new example for eBPF myself, but will use one of the samples available in samples / bpf /. </font><font style="vertical-align: inherit;">I‚Äôll look at some sections of the code and explain how it works. </font><font style="vertical-align: inherit;">As an example, I chose a program </font></font><code>tracex4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, each of the examples in samples / bpf / consists of two files. </font><font style="vertical-align: inherit;">In this case:</font></font><br>
<br>
<ul>
<li><code>tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, contains the source code that must be executed in the kernel as eBPF bytecode.</font></font></li>
<li><code>tracex4_user.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, contains a program from user space.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this case, we need to compile the </font></font><code> tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eBPF into bytecode. </font><font style="vertical-align: inherit;">There is currently </font></font><code>gcc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no server part for eBPF. </font><font style="vertical-align: inherit;">Fortunately, it </font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can issue eBPF bytecode. </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Makefile</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">uses </font></font><code>clang</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to compile </font></font><code>tracex4_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">an object file. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I mentioned above that one of the most interesting features of eBPFs is cards. </font><font style="vertical-align: inherit;">tracex4_kern defines one map:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pair</span> {</span><font></font>
    u64 val;<font></font>
    u64 ip;<font></font>
};  <font></font>
<font></font>
<span class="hljs-function">struct bpf_map_def <span class="hljs-title">SEC</span><span class="hljs-params">(<span class="hljs-string">"maps"</span>)</span> my_map </span>= {<font></font>
    .type = BPF_MAP_TYPE_HASH,<font></font>
    .key_size = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">long</span>),<font></font>
    .value_size = <span class="hljs-keyword">sizeof</span>(struct pair),<font></font>
    .max_entries = <span class="hljs-number">1000000</span>,<font></font>
};</code></pre><br>
<code>BPF_MAP_TYPE_HASH</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- One of the many types of cards offered by eBPF. </font><font style="vertical-align: inherit;">In this case, it's just a hash. </font><font style="vertical-align: inherit;">You may also have noticed an ad </font></font><code>SEC("maps")</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">SEC is a macro used to create a new section of a binary file. </font><font style="vertical-align: inherit;">Actually, the example </font></font><code>tracex4_kern</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">defines two more sections:</font></font><br>
<br>
<pre><code class="cpp hljs">SEC(<span class="hljs-string">"kprobe/kmem_cache_free"</span>)
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bpf_prog1</span><span class="hljs-params">(struct pt_regs *ctx)</span>
</span>{   
    <span class="hljs-keyword">long</span> ptr = PT_REGS_PARM2(ctx);<font></font>
<font></font>
    bpf_map_delete_elem(&amp;my_map, &amp;ptr); <font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}<font></font>
    <font></font>
SEC(<span class="hljs-string">"kretprobe/kmem_cache_alloc_node"</span>) 
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bpf_prog2</span><span class="hljs-params">(struct pt_regs *ctx)</span>
</span>{
    <span class="hljs-keyword">long</span> ptr = PT_REGS_RC(ctx);
    <span class="hljs-keyword">long</span> ip = <span class="hljs-number">0</span>;<font></font>
<font></font>
    <span class="hljs-comment">//  ip-   kmem_cache_alloc_node() </span><font></font>
    BPF_KRETPROBE_READ_RET_IP(ip, ctx);<font></font>
<font></font>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pair</span> <span class="hljs-title">v</span> = {</span><font></font>
        .val = bpf_ktime_get_ns(),<font></font>
        .ip = ip,<font></font>
    };<font></font>
    <font></font>
    bpf_map_update_elem(&amp;my_map, &amp;ptr, &amp;v, BPF_ANY);<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}   </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These two functions allow you to delete an entry from the card ( </font></font><code>kprobe/kmem_cache_free</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) and add a new record ( </font></font><code>kretprobe/kmem_cache_alloc_node</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">to the card </font><font style="vertical-align: inherit;">. All function names written in capital letters correspond to the macros defined in </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">bpf_helpers.h</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If I output a dump of sections of the object file, I should see that these new sections are already defined: </font><font style="vertical-align: inherit;">
Still there </font><font style="vertical-align: inherit;">, the main program. Basically, this program listens to events </font><font style="vertical-align: inherit;">. When such an event occurs, the corresponding eBPF code is executed. The code stores the IP attribute of the object in the map, and then this object is cyclically displayed in the main program. Example: </font><font style="vertical-align: inherit;">
How are the user space program and the eBPF program related? At initialization, it </font><font style="vertical-align: inherit;">loads an object file </font><font style="vertical-align: inherit;">using a function </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<code>$ objdump -h tracex4_kern.o<br>
<br>
tracex4_kern.o: file format elf64-little<br>
<br>
Sections:<br>
Idx Name Size VMA LMA File off Algn<br>
 0 .text 00000000 0000000000000000 0000000000000000 00000040 2**2<br>
 CONTENTS, ALLOC, LOAD, READONLY, CODE<br>
 1 kprobe/kmem_cache_free 00000048 0000000000000000 0000000000000000 00000040 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE<br>
 2 kretprobe/kmem_cache_alloc_node 000000c0 0000000000000000 0000000000000000 00000088 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE<br>
 3 maps 0000001c 0000000000000000 0000000000000000 00000148 2**2<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 4 license 00000004 0000000000000000 0000000000000000 00000164 2**0<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 5 version 00000004 0000000000000000 0000000000000000 00000168 2**2<br>
 CONTENTS, ALLOC, LOAD, DATA<br>
 6 .eh_frame 00000050 0000000000000000 0000000000000000 00000170 2**3<br>
 CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA</code><br>
<br><font style="vertical-align: inherit;"></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">tracex4_user.c</a></code><font style="vertical-align: inherit;"></font><code>kmem_cache_alloc_node</code><font style="vertical-align: inherit;"></font><br>
<br>
<code>$ sudo ./tracex4<br>
obj 0xffff8d6430f60a00 is 2sec old was allocated at ip ffffffff9891ad90<br>
obj 0xffff8d6062ca5e00 is 23sec old was allocated at ip ffffffff98090e8f<br>
obj 0xffff8d5f80161780 is 6sec old was allocated at ip ffffffff98090e8f</code><br>
<br><font style="vertical-align: inherit;"></font><code>tracex4_user.c</code><font style="vertical-align: inherit;"></font><code>tracex4_kern.o</code><font style="vertical-align: inherit;"></font><code>load_bpf_file</code><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> ac, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rlimit</span> <span class="hljs-title">r</span> = {</span>RLIM_INFINITY, RLIM_INFINITY};
    <span class="hljs-keyword">char</span> filename[<span class="hljs-number">256</span>];
    <span class="hljs-keyword">int</span> i;<font></font>
<font></font>
    <span class="hljs-built_in">snprintf</span>(filename, <span class="hljs-keyword">sizeof</span>(filename), <span class="hljs-string">"%s_kern.o"</span>, argv[<span class="hljs-number">0</span>]);<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (setrlimit(RLIMIT_MEMLOCK, &amp;r)) {<font></font>
        perror(<span class="hljs-string">"setrlimit(RLIMIT_MEMLOCK, RLIM_INFINITY)"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (load_bpf_file(filename)) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, bpf_log_buf);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; ; i++) {<font></font>
        print_old_objects(map_fd[<span class="hljs-number">1</span>]);<font></font>
        sleep(<span class="hljs-number">1</span>);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When executed, the </font></font><code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">load_bpf_file</a></code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">probes defined in the eBPF file are added to </font></font><code>/sys/kernel/debug/tracing/kprobe_events</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Now we are listening to these events, and our program can do something when they happen. </font><font style="vertical-align: inherit;">
All other programs in sample / bpf / are structured in a similar way. </font><font style="vertical-align: inherit;">They always have two files:</font></font><br>
<br>
<code>$ sudo cat /sys/kernel/debug/tracing/kprobe_events<br>
p:kprobes/kmem_cache_free kmem_cache_free<br>
r:kprobes/kmem_cache_alloc_node kmem_cache_alloc_node</code><br>
<br><font style="vertical-align: inherit;"></font><br>
<br>
<ul>
<li><code>XXX_kern.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: eBPF program.</font></font></li>
<li><code>XXX_user.c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: main program.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The eBPF program defines the cards and functions associated with the section. </font><font style="vertical-align: inherit;">When the kernel throws an event of a certain type (for example, </font></font><code>tracepoint</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), the bound functions are executed. </font><font style="vertical-align: inherit;">Maps provide data exchange between the kernel program and user space program. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
This article outlined BPF and eBPF. </font><font style="vertical-align: inherit;">I know that today there is a lot of information and resources about eBPF, so I recommend some more materials for further study. I </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
recommend reading:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BPF: the universal in-kernel virtual machine by</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jonathan Corbett. </font><font style="vertical-align: inherit;">An introduction to BPF and how it evolved into eBPF.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">A thorough introduction to eBPF</a>  .    LWN.net.      eBPF           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>.</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">Notes on BPF &amp; eBPF</a>  .      ‚ÄúThe BSD Packet Filter: A New Architecture for User-level Packet Capture‚Äù.        .</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">eBPF, part1: Past, Present and Future</a>  .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="></a>,   .      eBPF,   .</li>
</ul></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en495444/index.html">Arrays in C ++</a></li>
<li><a href="../en495446/index.html">Antigravity is not what you thought</a></li>
<li><a href="../en495448/index.html">Online mitaps for the whole week on back, front, QA, PM, DevOps and a little bit on robots, starting from April 3</a></li>
<li><a href="../en495450/index.html">Debugging heavily loaded Golang applications or how we looked for a problem in Kubernetes that was not there</a></li>
<li><a href="../en495452/index.html">How to prepare a site for load growth</a></li>
<li><a href="../en495456/index.html">Review of 14 fresh plugins for Figma that will help increase productivity while we all</a></li>
<li><a href="../en495458/index.html">How to write code when children run around you and ask: ‚ÄúWhat will you work for?‚Äù</a></li>
<li><a href="../en495460/index.html">A gas bubble 22,000 times the size of the Earth exploded on Uranus</a></li>
<li><a href="../en495462/index.html">.NET Core: x86_64 Intrinsics on Virtual Machines</a></li>
<li><a href="../en495464/index.html">Information message 404 - not only a mistake, but also a holiday</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>