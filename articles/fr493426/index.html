<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèª üÜé ‚¨áÔ∏è Organisation du code dans les microservices et mon approche de l'utilisation de l'architecture hexagonale et du DDD üçÄ üì© üßúüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Dans le Monolith, tout le code doit √™tre dans le m√™me style, et dans diff√©rents microservices, vous pouvez utiliser diff√©rentes approch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Organisation du code dans les microservices et mon approche de l'utilisation de l'architecture hexagonale et du DDD</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/493426/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ak/h6/c_/akh6c_safonprea6vtagzdaoy58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bonjour, Habr! Dans le Monolith, tout le code doit √™tre dans le m√™me style, et dans diff√©rents microservices, vous pouvez utiliser diff√©rentes approches, langages de programmation et frameworks. Pour les microservices simples avec 1 √† 2 contr√¥leurs et 1 √† 10 actions, il n'y a aucun sens particulier √† bloquer les couches d'abstractions. Pour les microservices complexes avec des √©tats diff√©rents et la logique de transition entre eux, au contraire, il vaut mieux ne pas √™tre paresseux au d√©part. Je veux parler de mon exp√©rience de l'organisation du code et de l'utilisation des approches DDD, Ports et Adapters dans les deux cas. Il y a un bref r√©sum√© de l'article: Juin - √©crit le code dans le contr√¥leur. Milieu - √©crit un tas d'abstractions. Senior - sait quand √©crire du code dans le contr√¥leur et quand des abstractions sont n√©cessaires.</font></font><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ici, vous devez imm√©diatement mettre fin aux I - Les ports en C # sont des interfaces ou des r√©sum√©s, et les adaptateurs sont des impl√©mentations concr√®tes (classe, struct). </font><font style="vertical-align: inherit;">Pour r√©f√©rence, je vous recommande de lire cette traduction </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DDD, Hexagonal, Onion, Clean, CQRS ... comment je mets tout cela ensemble</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et cet article sur la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mauvaise conception</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">Clean Architecture</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ici, gardez √† l'esprit que l'approche est d√©crite pour un monolithe grand et complexe. </font><font style="vertical-align: inherit;">Mais je veux parler des variations de cette approche dans les microservices dont 80% sont simples et 20 de complexit√© moyenne ou √©lev√©e.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terminologie</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) Adaptateurs principaux </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Introduisez une interface conviviale pour un </font><font style="vertical-align: inherit;">syst√®me d' </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">appel</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> externe </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Appelez et utilisez les adaptateurs secondaires et la logique. </font><font style="vertical-align: inherit;">Ils disent √† l'application de faire quelque chose. </font><font style="vertical-align: inherit;">L'entr√©e pointe vers votre code. </font><font style="vertical-align: inherit;">Repr√©sentants typiques: ItemsService, CreateItemCommandHandler. </font><font style="vertical-align: inherit;">Utilisez Logic et SecondaryAdapters pour leur travail.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) Adaptateurs secondaires </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fournit une interface √† un </font><font style="vertical-align: inherit;">syst√®me </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">appel√©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> externe </font><font style="vertical-align: inherit;">pratique pour une utilisation par notre syst√®me. </font><font style="vertical-align: inherit;">Il re√ßoit des commandes de l'application. </font><font style="vertical-align: inherit;">Repr√©sentants typiques: ItemsRepository, EmailSender, Logger, DistributedCache. </font><font style="vertical-align: inherit;">Ils utilisent des biblioth√®ques et des cadres comme EntityFramework pour leur travail.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) Logique</font></font></h3><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.1) Entit√©s</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Combinez donn√©es et logique. </font><font style="vertical-align: inherit;">Objets POO typiques. </font><font style="vertical-align: inherit;">Article, argent, utilisateur. </font><font style="vertical-align: inherit;">Il existe √©galement des ValueObjects et des √©v√©nements. </font><font style="vertical-align: inherit;">Seuls les autres objets de la couche Entit√©s sont utilis√©s. </font><font style="vertical-align: inherit;">En th√©orie, cette couche est le c≈ìur de l'application qui ne d√©pend de personne. </font><font style="vertical-align: inherit;">Tout d√©pend de lui.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.2) DomainServices</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Informatique nue. </font><font style="vertical-align: inherit;">Ils sont n√©cessaires pour une logique qui ne peut pas √™tre attach√©e √† une entit√© sp√©cifique. </font><font style="vertical-align: inherit;">Utilisez des entit√©s ou d'autres services de domaine. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N'utilisez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pas d'adaptateurs primaires (ils utilisent toujours eux-m√™mes tous) et d'adaptateurs secondaires. </font><font style="vertical-align: inherit;">Il s'agit g√©n√©ralement de toutes sortes d'AmountCalculator, Validator et plus encore. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le flux d'appels de code doit toujours √™tre dans une direction PrimaryAdapters -&gt; Logic et SecondaryAdapters.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Domaine</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
C'est le domaine pour lequel le syst√®me est d√©velopp√©. </font><font style="vertical-align: inherit;">Par exemple, pour le domaine de la boutique Internet est le commerce √©lectronique.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Contexte born√©</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
BoundedContext est utilis√© pour diviser le syst√®me en parties isol√©es avec une certaine responsabilit√©. L'un des moyens de r√©ussir la conception d'un syst√®me consiste √† y trouver et √† mettre en √©vidence tous ses Contextes Limit√©s. Dans une architecture de microservice, 1 microservice = 1 BoundedContext. Par exemple: une boutique en ligne peut avoir un panier d'achat BoundedContext et BoundedContext travaillant avec des commandes, BoundedContext travaillant avec des fichiers. Et un grand BoundedContext peut √™tre divis√© en petits morceaux √† l'int√©rieur. Par exemple, pour le contexte d√©limit√© du panier de marchandises, vous pouvez effectuer une division dans le contexte de l'ajout de marchandises au panier et dans le contexte de la suppression de marchandises du panier. Dans le monolithe 1, un grand BoundedContext est un module. Ici, il est n√©cessaire de faire remarquer que toutes les entit√©s vivent dans un contexte sp√©cifique, c'est-√†-direArticle du contexte du panier de marchandises et Article du contexte de la vitrine des marchandises, il peut s'agir de classes diff√©rentes avec des champs et des m√©thodes diff√©rents. Dans un monolithe, ils se mappent simplement les uns dans les autres et utilisent certains ItemDto que EF passe pour travailler avec la base de donn√©es et qui ont des champs communs √† tous, c'est-√†-dire si Item du contexte (module) du panier a la propri√©t√© Property1 et Item du contexte de la vitrine des biens ont la propri√©t√© Property2, alors ItemDto aura √† la fois Property1 et Property2. Dans chaque contexte, il y aura son propre r√©f√©rentiel qui extraira l'√©l√©ment, qui est d√©j√† caract√©ristique de ce contexte, de la base de donn√©es. Dans les microservices, c'est facile. Chacun a sa propre base de donn√©es et sa propre essence. Chaque service mondial a ses propres classes. SimplementDans un monolithe, ils se mappent simplement les uns dans les autres et utilisent certains ItemDto que EF passe pour travailler avec la base de donn√©es et qui ont des champs communs √† tous, c'est-√†-dire si Item du contexte (module) du panier a la propri√©t√© Property1 et Item du contexte de la vitrine des biens ont la propri√©t√© Property2, alors ItemDto aura √† la fois Property1 et Property2. Dans chaque contexte, il y aura son propre r√©f√©rentiel qui extraira de la base de donn√©es l'√©l√©ment qui est d√©j√† caract√©ristique de ce contexte. Dans les microservices, c'est facile. Chacun a sa propre base de donn√©es et sa propre essence. Chaque service mondial a ses propres classes. SimplementDans un monolithe, ils se mappent simplement les uns dans les autres et utilisent certains ItemDto que EF passe pour travailler avec la base de donn√©es et qui ont des champs communs √† tous, c'est-√†-dire si Item du contexte (module) du panier a la propri√©t√© Property1 et Item du contexte de la vitrine des biens ont la propri√©t√© Property2, alors ItemDto aura √† la fois Property1 et Property2. Dans chaque contexte, il y aura son propre r√©f√©rentiel qui extraira l'√©l√©ment, qui est d√©j√† caract√©ristique de ce contexte, de la base de donn√©es. Dans les microservices, c'est facile. Chacun a sa propre base de donn√©es et sa propre essence. Chaque service mondial a ses propres classes. SimplementDans chaque contexte, il y aura son propre r√©f√©rentiel qui extraira l'√©l√©ment, qui est d√©j√† caract√©ristique de ce contexte, de la base de donn√©es. Dans les microservices, c'est facile. Chacun a sa propre base de donn√©es et sa propre essence. Chaque service mondial a ses propres classes. SimplementDans chaque contexte, il y aura son propre r√©f√©rentiel qui extraira l'√©l√©ment, qui est d√©j√† caract√©ristique de ce contexte, de la base de donn√©es. Dans les microservices, c'est facile. Chacun a sa propre base de donn√©es et sa propre essence. Chaque service mondial a ses propres classes. Simplement</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rappelez</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">vous</font></b><font style="vertical-align: inherit;"> que Item et ItemsRepository de diff√©rents BoundedContext peuvent √™tre diff√©rents objets avec diff√©rentes m√©thodes et propri√©t√©s. </font><font style="vertical-align: inherit;">Souvent, BoundedContext dans les microservices est viol√© par l'introduction de certaines biblioth√®ques communes. </font><font style="vertical-align: inherit;">Le r√©sultat est une classe qui a plusieurs dizaines de m√©thodes ou propri√©t√©s et chaque microservice utilise 1 √† 2 uniquement dont il a besoin, vous devez donc √™tre prudent avec les biblioth√®ques partag√©es dans les microservices.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√©pendances entre couches</font></font></h3><br>
<img src="https://habrastorage.org/webt/8g/kb/4y/8gkb4yjeoduvybjcxsyo77apjre.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option pour des microservices simples dont la loi de Pareto 80 pour cent</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetez les calques PrimaryAdatapters et SecondaryAdapters. Ne laissez que la couche Logic. Plus pr√©cis√©ment, dans une application ASP.NET typique que nous utilisons - PimaryAdater est Controller et SecondaryAdapter est DbContext d'EF. Si le contr√¥leur devient soudainement trop grand, nous le coupons en morceaux en utilisant partiel. C'est bien mieux que d'√©lever des abstractions inutiles et de passer du temps dessus. Par exemple, Microsoft l'a fait pour le BasketMicrotservice dans l'exemple de son application EShop sur les conteneurs Docker. Oui, √©crivez simplement le code sur le contr√¥leur. N'√©crivez simplement pas de code spaghetti. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Important</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rappelez-vous que la couche Logic reste avec nous et nous utilisons toujours des entit√©s avec leur logique et DomainServices avec leurs calculs et pas seulement √©crire un mur de code spaghetti dans le contr√¥leur. </font><font style="vertical-align: inherit;">Nous jetons simplement le ItemService et le ItemRepository typiques. </font><font style="vertical-align: inherit;">Le bon vieux ItemValidator, ItemMapper, AmountCalculator, etc. dans cet esprit reste toujours avec nous. </font><font style="vertical-align: inherit;">Puisque nous avons toujours la couche Logic, nous pouvons basculer vers une option plus complexe √† tout moment en encapsulant des abstractions suppl√©mentaires avec ItemsService, ItemsRepository.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un service qui calcule le prix final d'un produit avec une remise. </font><font style="vertical-align: inherit;">En th√©orie, il fait partie de la boutique en ligne de domaine et repr√©sente son catalogue de produits BoundedContext. </font><font style="vertical-align: inherit;">Par souci de simplicit√©, j'ai saut√© toute la logique de validation. </font><font style="vertical-align: inherit;">Il peut √™tre d√©crit dans une sorte de ItemValidator et DiscountValidator. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Dossier Logique: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.1) Dossier Entit√©s: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Remise:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Discount</span><font></font>
    {<font></font>
        [<span class="hljs-meta">Key</span>]
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Value { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Argent:</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">Owned</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Money</span><font></font>
    {<font></font>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">decimal</span> Amount { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Money <span class="hljs-title">Apply</span>(<span class="hljs-params">Discount discount</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> amount = Amount * (<span class="hljs-number">1</span> - discount.Value);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Money()<font></font>
            {<font></font>
                Amount = amount<font></font>
            };<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Produit:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Item</span><font></font>
    {<font></font>
        [<span class="hljs-meta">Key</span>]
        <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Money Price { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span> Money();<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1.2) Dossier DomainServices </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Calculateur de prix du </font><font style="vertical-align: inherit;">produit </font><font style="vertical-align: inherit;">, y compris les remises:</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IPriceCalculator</span><font></font>
    {<font></font>
        <span class="hljs-function">Money <span class="hljs-title">WithDiscounts</span>(<span class="hljs-params">Item item, IEnumerable&lt;Discount&gt; discounts</span>)</span>;<font></font>
    }<font></font>
<font></font>
     <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PriceCalculator</span>:<span class="hljs-title">IPriceCalculator</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> Money <span class="hljs-title">WithDiscounts</span>(<span class="hljs-params">Item item, IEnumerable&lt;Discount&gt; discounts</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> discounts.Aggregate(item.Price, (m, d) =&gt; m.Apply(d));<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) DbContext </font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsDbContext</span> : <span class="hljs-title">DbContext</span><font></font>
    {<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsDbContext</span>(<span class="hljs-params">DbContextOptions&lt;ItemsDbContext&gt; options</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">options</span>)</span><font></font>
        {<font></font>
<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Item&gt; Items { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> DbSet&lt;Discount&gt; Discounts { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3) Contr√¥leur</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/items"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPriceCalculator _priceCalculator;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsController</span>(<span class="hljs-params">ItemsDbContext context, IPriceCalculator priceCalculator</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
            _priceCalculator = priceCalculator;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}/price-with-discounts"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _context.Items.FindAsync(id);
            <span class="hljs-keyword">var</span> discounts = <span class="hljs-keyword">await</span> _context.Discounts.ToListAsync();
            <span class="hljs-keyword">return</span> _priceCalculator.WithDiscounts(item, discounts).Amount;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option pour les microservices complexes dont 20% et pour la plupart des monolithes</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ici, nous utilisons une approche standard avec une isolation maximale des couches les unes des autres. </font><font style="vertical-align: inherit;">Ajoutez une classe pour PrimaryAdapter (ItemService) et SecondaryAdapter (ItemRepository). </font><font style="vertical-align: inherit;">Dans le dossier Logic, tout reste comme avant.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1) Dossier SecondaryAdapters</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IItemsRepository</span><font></font>
    {<font></font>
        <span class="hljs-function">Task&lt;Item&gt; <span class="hljs-title">Get</span>(<span class="hljs-params">Guid id</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsRepository</span> : <span class="hljs-title">IItemsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsRepository</span>(<span class="hljs-params">ItemsDbContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;Item&gt; <span class="hljs-title">Get</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _context.Items.FindAsync(id);
            <span class="hljs-keyword">return</span> item;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IDiscountsRepository</span><font></font>
    {<font></font>
        Task&lt;List&lt;Discount&gt;&gt; Get();<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DiscountsRepository</span> : <span class="hljs-title">IDiscountsRepository</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ItemsDbContext _context;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DiscountsRepository</span>(<span class="hljs-params">ItemsDbContext context</span>)</span><font></font>
        {<font></font>
            _context = context;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword">public</span> Task&lt;List&lt;Discount&gt;&gt; Get()<font></font>
        {<font></font>
            <span class="hljs-keyword">return</span> _context.Discounts.ToListAsync();<font></font>
        }<font></font>
    }<font></font>
</code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2) Dossier PrimaryAdapters</font></font><br>
<br>
<pre><code class="cs hljs">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IItemService</span><font></font>
    {<font></font>
        <span class="hljs-function">Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemService</span> : <span class="hljs-title">IItemService</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IItemsRepository _items;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IDiscountsRepository _discounts;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IPriceCalculator _priceCalculator;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemService</span>(<span class="hljs-params">IItemsRepository items, IDiscountsRepository discounts, IPriceCalculator priceCalculator</span>)</span><font></font>
        {<font></font>
            _items = items;<font></font>
            _discounts = discounts;<font></font>
            _priceCalculator = priceCalculator;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> _items.Get(id);
            <span class="hljs-keyword">var</span> discounts = <span class="hljs-keyword">await</span> _discounts.Get();
            <span class="hljs-keyword">return</span> _priceCalculator.WithDiscounts(item, discounts).Amount;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Notre contr√¥leur utilise maintenant notre IItemService</font></font><br>
<br>
<pre><code class="cs hljs">    [<span class="hljs-meta">ApiController</span>]<font></font>
    [<span class="hljs-meta">Route(<span class="hljs-meta-string">"api/v1/items"</span>)</span>]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ItemsController</span> : <span class="hljs-title">ControllerBase</span><font></font>
    {<font></font>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IItemService _service;<font></font>
<font></font>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ItemsController</span>(<span class="hljs-params">IItemService service</span>)</span><font></font>
        {<font></font>
            _service = service;<font></font>
        }<font></font>
<font></font>
        [<span class="hljs-meta">HttpGet(<span class="hljs-meta-string">"{id}/price-with-discounts"</span>)</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">decimal</span>&gt; <span class="hljs-title">GetPriceWithDiscount</span>(<span class="hljs-params">Guid id</span>)</span><font></font>
        {<font></font>
            <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> _service.GetPriceWithDiscount(id);
            <span class="hljs-keyword">return</span> result;<font></font>
        }<font></font>
    }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ajout de beaucoup de code suppl√©mentaire. Au lieu de cela, une flexibilit√© accrue du syst√®me. Il est d√©sormais plus facile de changer le contr√¥leur et g√©n√©ralement ASP.NET Core en autre chose ou de changer DbContext et EntityFramework Core en autre chose ou d'ajouter la mise en cache √† Redis. La premi√®re approche l'emporte dans les microservices simples et les monolithes tr√®s simples et petits. Le second dans tous les autres cas, lorsque vous devrez ajouter et terminer ce code pendant plus d'un an. Eh bien, dans la deuxi√®me approche, en plus de l'√©l√©ment d'entit√© et de la remise, il est utile de cr√©er des DTO distincts qui utiliseront DbContex EF et des DTO s√©par√©s (mod√®les) qu'ASP.NET Controller utilisera, c'est-√†-dire ItemDto et ItemModel. Cela rendra les mod√®les de domaine encore plus ind√©pendants. Et enfin, un exemple d'une application simple que j'ai √©crite en utilisant la 2√®me approche </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TestRuvds</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En fait, il est redondant ici, et toutes ces abstractions sont ici pour un exemple.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemple d'impl√©mentation</font></font></h2><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualServersModule</font></font></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remerciements</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
remercier </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cannes</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AndrewDemb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour les erreurs grammaticales trouv√©es.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr493412/index.html">Jeux avec Wifi sur ESP32</a></li>
<li><a href="../fr493416/index.html">IDA Pro et techniques d'ing√©nierie inverse</a></li>
<li><a href="../fr493418/index.html">Pourquoi l'apprentissage automatique utilise des donn√©es ¬´synth√©tiques¬ª</a></li>
<li><a href="../fr493420/index.html">Ma fa√ßon de pr√©senter Python √† des √©l√®ves du premier cycle du secondaire</a></li>
<li><a href="../fr493424/index.html">Nous impl√©mentons des conversions de code Python</a></li>
<li><a href="../fr493428/index.html">"Nous ne donnerons pas lieu √† des th√©ories du complot." Parlez de conf√©rences ML avec des gens des soci√©t√©s scientifiques et informatiques</a></li>
<li><a href="../fr493430/index.html">Architecture nette pour les applications Web</a></li>
<li><a href="../fr493432/index.html">Pourquoi ne pas commencer une carri√®re dans une petite entreprise non informatique</a></li>
<li><a href="../fr493436/index.html">Programme pour changer les droits d'acc√®s et enregistrer les noms de fichiers / r√©pertoires sur Bash</a></li>
<li><a href="../fr493438/index.html">Afficher les r√©sultats de recherche et les probl√®mes de performances</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>