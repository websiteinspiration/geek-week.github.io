<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤵🏾 👨🏾‍🏭 🐆 Raspberry Pi performance: add ZRAM and change kernel parameters 👩‍🚒 👩🏻‍🤝‍👨🏾 😍</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of weeks ago, I published a review of Pinebook Pro . Since Raspberry Pi 4 is also based on ARM, some of the optimizations mentioned in the pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Raspberry Pi performance: add ZRAM and change kernel parameters</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/504468/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A couple of weeks ago, I published a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">review of Pinebook Pro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Since Raspberry Pi 4 is also based on ARM, some of the optimizations mentioned in the previous article are quite suitable for it. </font><font style="vertical-align: inherit;">I would like to share these tricks and find out if you have the same performance improvements. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After installing Raspberry Pi in my </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">home server room,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I noticed that in times of RAM shortage, it became very unresponsive and even hung. </font><font style="vertical-align: inherit;">To solve this problem, I added ZRAM and made several changes to the kernel parameters.</font></font><br>
<a name="habracut"></a><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZRAM Activation on Raspberry Pi</font></font></h1><br>
<img src="https://habrastorage.org/getpro/habr/post_images/032/270/fb0/032270fb0277cc21b3946def04336dfa.png"><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZRAM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> creates a block storage in RAM with the name / dev / zram0 (or 1, 2, 3, etc.). </font><font style="vertical-align: inherit;">The pages recorded there are compressed and stored in memory. </font><font style="vertical-align: inherit;">This allows for very fast I / O, and also frees up memory due to compression. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Raspberry Pi 4 comes with 1, 2, 4, or 8 GB of RAM. </font><font style="vertical-align: inherit;">I will use the 1 GB model, so adjust the instructions depending on your model. </font><font style="vertical-align: inherit;">With 1 GB of ZRAM, the default swap file (slow!) Will be used less often. </font><font style="vertical-align: inherit;">I used such a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zram-swap</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> script </font><font style="vertical-align: inherit;">for installation and automatic configuration. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Instructions are provided in the repository at the link above. </font><font style="vertical-align: inherit;">Installation:</font></font><br>
<br>
<pre><code class="bash hljs">git <span class="hljs-built_in">clone</span> https://github.com/foundObjects/zram-swap.git
<span class="hljs-built_in">cd</span> zram-swap &amp;&amp; sudo ./install.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want to edit the config:</font></font><br>
<br>
<pre><code class="bash hljs">vi /etc/default/zram-swap</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, you can activate ZRAM by installation </font></font><code>zram-tools</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you use this method, be sure to edit the config</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the file </font></font><code>/etc/default/zramswap</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and install about 1 GB of ZRAM:</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt install zram-tools</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
After installation, you can view the ZRAM repository statistics with the following command:</font></font><br>
<br>
<pre><code class="bash hljs">sudo cat /proc/swaps<font></font>
Filename				Type		Size	Used	Priority<font></font>
/var/swap                               file		102396	0	-2<font></font>
/dev/zram0                              partition	1185368	265472	5<font></font>
pi@raspberrypi:~ $</code></pre><br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adding kernel parameters for better use of ZRAM</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now fix the behavior of the system when the Raspberry Pi switches to swap at the last moment, which often leads to freezes. </font><font style="vertical-align: inherit;">Add a few lines to the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/sysctl.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">and reboot. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These lines 1) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">delay the inevitable exhaustion of memory</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , increasing pressure on the kernel cache, and 2) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">earlier start preparing for memory exhaustion</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , initiating a swap in advance. </font><font style="vertical-align: inherit;">But it will be a much more efficient swap of compressed memory through ZRAM! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Here are the lines to add at the end of the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/sysctl.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> file </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="plaintext hljs">vm.vfs_cache_pressure=500<font></font>
vm.swappiness=100<font></font>
vm.dirty_background_ratio=1<font></font>
vm.dirty_ratio=50</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then we reboot the system or activate the edits with the following command:</font></font><br>
<br>
<pre><code class="bash hljs">sudo sysctl --system</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.vfs_cache_pressure = 500</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> increases the pressure on the cache, which increases the tendency of the kernel to reclaim the memory used to cache directory objects and indexes. You will use less memory for a longer period of time. A sharp drop in productivity is nullified by earlier swaps. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.swappiness = 100</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> increases the parameter how aggressively the kernel will swap pages of memory, since we use ZRAM first. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vm.dirty_background_ratio = 1 &amp; vm.dirty_ratio = 50</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - background processes will start recording immediately after reaching the limit of 1%, but the system will not force synchronous I / O until it reaches dirty_ratio of 50%.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
These four lines (when used with ZRAM) will help improve performance if you </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inevitably</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> run out of RAM and start switching to swap, like mine. Knowing this fact, as well as taking into account memory compression in ZRAM, it is three times better to start this swap in advance. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pressure on the cache helps because we are actually telling the kernel: “Hey, listen, I don’t have extra memory to use for the cache, so please get rid of it as soon as possible and keep only the most frequently used / important data.”</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even with reduced caching, if over time most of the installed memory is occupied, the kernel will start an opportunistic swap much earlier, so that the processor (compression) and swap I / O will not pull to the last and use all the resources at once, when it is too late. </font><font style="vertical-align: inherit;">ZRAM uses a little CPU for compression, but on most systems with a small amount of memory, this affects performance much less than a swap without ZRAM.</font></font><br>
<br>
<h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally</font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Let's look at the result again:</font></font><br>
<br>
<pre><code class="plaintext hljs">pi@raspberrypi:~ $ free -h<font></font>
total used free shared buff/cache available<font></font>
Mem: 926Mi 471Mi 68Mi 168Mi 385Mi 232Mi<font></font>
Swap: 1.2Gi 258Mi 999Mi<font></font>
<font></font>
pi@raspberrypi:~ $ sudo cat /proc/swaps <font></font>
Filename Type Size Used Priority<font></font>
/var/swap file 102396 0 -2<font></font>
/dev/zram0 partition 1185368 264448 5</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
264448 in ZRAM is almost one gigabyte of uncompressed data. </font><font style="vertical-align: inherit;">Everything went to ZRAM and nothing got into the much slower swap file. </font><font style="vertical-align: inherit;">Try these settings yourself, they work on all Raspberry Pi models. </font><font style="vertical-align: inherit;">My unsuitable freezing system has turned into a workable and stable one. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In the near future, I hope to continue and update this article with some results of system testing before and after installing ZRAM. </font><font style="vertical-align: inherit;">Now I just do not have time for this. </font><font style="vertical-align: inherit;">In the meantime, feel free to run your own tests and let us know in the comments. </font><font style="vertical-align: inherit;">The Raspberry Pi 4 is just a beast with such settings. </font><font style="vertical-align: inherit;">Enjoy it!</font></font><br>
<br>
<blockquote><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On this topic:</font></font></b><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux performance: why you almost always need to increase the swap space</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2017)</font></font><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linux performance: almost always increase the swap space. </font><font style="vertical-align: inherit;">Part 2: ZRAM</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (2020)</font></font></li>
</ul></blockquote></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en504454/index.html">Best GitHub repositories for web developers</a></li>
<li><a href="../en504456/index.html">Isolate development environments with LXD containers</a></li>
<li><a href="../en504458/index.html">Installing OpenCV-Python in a virtual environment for super-kettles</a></li>
<li><a href="../en504460/index.html">About David Ogilvy's Ogilvy Book of Advertising</a></li>
<li><a href="../en504464/index.html">How we came up with the TableAdapter and simplified the work with UITableView</a></li>
<li><a href="../en504472/index.html">My Top Free Developer Tools</a></li>
<li><a href="../en504480/index.html">How to find a marketer with whom it will be profitable to work?</a></li>
<li><a href="../en504482/index.html">Ask us: DIT will answer questions</a></li>
<li><a href="../en504484/index.html">IPSec Almighty</a></li>
<li><a href="../en504486/index.html">Process: Creating Vue 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>