<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕺🏼 👲🏻 🧦 用“懒惰”的手为“富人”准备的智能灯，“简单”且方便 🚢 👐 🧓🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="介绍
 他根据arduino控制的LED灯带（称为灯1）在厨房里为水槽，火炉和切割台制作了“现代”照明。这种设计工作了2年，直到“大脑”的功率部分变坏为止。这是再次从“即兴垃圾”（轮子2）重新发明轮子的绝佳机会。没错，这一次的“垃圾”将非常昂贵，并且与Z-wave智能家居兼容。以下是有关使用ZUNo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>用“懒惰”的手为“富人”准备的智能灯，“简单”且方便</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488480/"><img src="https://habrastorage.org/webt/os/hi/gl/oshiglmjknpmabuu6ivivauqzdw.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他根据arduino控制的LED灯带（称为灯1）在厨房里为水槽，火炉和切割台制作了“现代”照明。</font><font style="vertical-align: inherit;">这种设计工作了2年，直到“大脑”的功率部分变坏为止。</font><font style="vertical-align: inherit;">这是再次从“即兴垃圾”（轮子2）重新发明轮子的绝佳机会。</font><font style="vertical-align: inherit;">没错，这一次的“垃圾”将非常昂贵，并且与Z-wave智能家居兼容。</font><font style="vertical-align: inherit;">以下是有关使用ZUNo（用于创建Z-wave设备的与arduino兼容的模块）替换arduino的故事，该代码最大程度地节省了代码，并说明了必要的更改。</font></font><br>
<a name="habracut"></a><br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我出现在那之前发生了什么</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
从前，为了洗碗或做饭，有必要打开水槽上方的灯。</font><font style="vertical-align: inherit;">这是一个重做的台灯。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我不喜欢用湿手按下小开关，因为它已将220伏特的电压切换到白炽灯。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/tl/yz/dq/tlyzdqgfcsedxxsswsqlekygins.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另外，灯泡发出的光主要落在水槽上，但我想更好地照亮饭桌和炉灶。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">目标：</font></font></b><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 使厨房的开/关灯不接触；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 均匀照亮水槽，餐桌和炉灶；</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 通过用LED替换白炽灯泡来节省能源。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
他组装了灯1。灯由一个2米长的铝制盒子和一个用于RGB磁带的扩散器组成。在商店里买了一个盒子和一个扩散器，现成的，有一条胶带，控制单元早就在角落里，在机翼旁等候。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外壳是工业用的（防尘，防水）。由于磁带是12伏，因此电源单元位于220 V至12 V之间，基于TLP250（光耦合器）的用于控制磁带的电流隔离板也以紧凑的设计控制了所有这些arduino。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 我从旧项目中获得了电流隔离。一次，我在床头柜上为迷你吧做背光灯。当门打开时，触摸板记录到容量的变化并打开柔和的微光。也就是说，该板非常适合当前项目，剩下的就是切断所有不必要的东西。板上有一个5伏线性转换器，由ZUNo供电。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
计划用手持托盘将灯打开到超声波测距仪上。他把它装在盖子上，其他所有零件都装进盒子里。全部“可靠地”用热熔胶固定。在测试时，我在电灯开关到控制单元电源旁边的旁边做了一个按钮，用于外部安装。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/r2/dn/tj/r2dntjzjoijyn-g7vk4vdkg-d5y.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
开灯变得更加方便和安全。</font><font style="vertical-align: inherit;">它上下颠倒地固定在厨柜的底部，很难从湿手内部取水。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上一个控制单元的结论</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于我的LED灯带色彩不自然，厨房工作区的照明变得更加均匀宜人，一些产品的颜色也发生了变化。</font><font style="vertical-align: inherit;">例如：由于颜色较亮，胡萝卜似乎更具开胃性。</font><font style="vertical-align: inherit;">但这并没有太大的干扰，我希望它不会造成太大的伤害。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在非接触式开/关的情况下，一切都变得更糟。</font><font style="vertical-align: inherit;">有效。</font><font style="vertical-align: inherit;">但是在关闭状态下5分钟后，LED灯条开始闪烁。</font><font style="vertical-align: inherit;">我没有开始重做光耦合器上的电路，而是保留了一切。</font><font style="vertical-align: inherit;">只有打开和关闭才开始使用新开关。</font><font style="vertical-align: inherit;">每个人都喜欢它的位置和形状。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
经过两年的使用，烹饪过程中分泌的脂肪和其他化合物积聚在体内和体内。</font><font style="vertical-align: inherit;">该噬菌斑通过孔部分地渗入壳体中，以用于电线的进入。</font><font style="vertical-align: inherit;">但是由于身体的光滑表面，该物质凝结成凝胶状物质。</font><font style="vertical-align: inherit;">触感令人愉悦，无味，而且...（我没尝到）。</font><font style="vertical-align: inherit;">我以龙芽的形式拍了些照片。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/jz/fr/ys/jzfrystsmthfk7fy5j_o70kkcfm.jpeg"><br>
<br>
<img src="https://habrastorage.org/webt/ot/br/mg/otbrmglxan7uooc1a1e4n88z9iq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在墙壁上，这种物质变成了可怕的袭击，而不仅仅是洗劫。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变成了什么</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
翻遍垃圾箱后，我发现ZUNo的未完成扩展模块。</font><font style="vertical-align: inherit;">ZUNo是一种类似于arduino的板，用于设计与Z-Wave智能家居兼容的自己的设备。</font><font style="vertical-align: inherit;">它是从arduino环境编程的。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">制造商规格：</font></font></b><div class="spoiler_text"><ul>
<li>28 kB Flash memory for your sketches</li>
<li>2 kB RAM available</li>
<li>Z-Wave RF transmitter at 9.6/40/100 kbps</li>
<li>26 GPIO (overlaps with special hardware controllers)</li>
<li>4 ADC</li>
<li>5 PWM</li>
<li>2 UART</li>
<li>1 USB (serial port)</li>
<li>16 kB EEPROM</li>
<li>1 SPI (master or slave)</li>
<li>4 IR controllers, 1 IR learn capability</li>
<li>1 TRIAC/ZEROX to control dimmer</li>
<li>3 Interrupts</li>
<li>1 Timer 4 MHz</li>
<li>I2C (software)</li>
<li>1-Wire (software)</li>
<li>8x6 Keypad Scanner (software)</li>
<li>2 service LED, 1 service button</li>
<li>1 user test LED</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
扩展模块使ZUNo成为了完整的调试板，在调试了原型之后，它可以用作完整的设备。 </font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来自制造商的一些信息：</font></font></b><div class="spoiler_text"><ul>
<li>One 0-10 V analog output — control industrial dimmers</li>
<li>Up to four PWM or switch outputs (up to 5 A per channel) — control contactors, switches, halogen bulbs or LED strips</li>
<li>Up to eight digital 0/3 V inputs or outputs — connect various low voltage digital senors and actors</li>
<li>Up to four digital 0/3, 0/5 or 0/12 V digital or analog inputs — connect industrial 10 V sensors or any Arduino-compatible sensor</li>
<li>RS485 or UART — for industial meters</li>
<li>OneWire — for DS18B20 or other sensors</li>
</ul><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于我的项目，我需要3个功能强大的晶体管来将12伏切换到LED灯条，并需要一个从12伏到5伏的转换器为ZUNo供电。</font><font style="vertical-align: inherit;">扩展模块外围的其余部分未焊接或测试。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/4j/kr/tt/4jkrtt63ocqqrkugav0nrtfvtn8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在电路的这一部分中，没有足够的二极管用于供电，以防止“极性反转”，并且功率场效应晶体管栅极上的电阻器必须连接到栅极，而不是在限流电阻器的前面。</font><font style="vertical-align: inherit;">我将在结论中写更多有关此的内容。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该扩展模块在Gainta的外壳中提供。</font><font style="vertical-align: inherit;">我以前的控制单元也来自该公司，但是大小不同。</font><font style="vertical-align: inherit;">不幸的是，模块上的紧固件不适合旧外壳，并且我不想钻一个新的外壳，所以我离开了旧外壳。</font><font style="vertical-align: inherit;">将该板“植入”在热熔粘合剂上。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/wm/ls/ah/wmlsahydh07_hxmpqaryl1atchs.jpeg"><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">关于编程Arduino和ZUNo的一些知识</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Z-wave设备必须具有一定数量的类别。类描述设备功能和交互接口。例如，我的灯控制着由三种颜色（红色，绿色，蓝色）组成的LED灯条。这些功能由Switch多级类执行。如果将其添加到草图中，我们可以远程更改一种颜色的亮度。要控制三种颜色，您需要制作该类的三个实例。我不会更详细地讨论这一点。因为按“通道”的概念，常规的类操作对于ZUNo用户是隐藏的。例如，我需要三类Switch多级，因此在代码中应该出现3个Switch多级通道和几个用于无线电控制的回调函数。这个怎么做？您还需要添加Switch基本类，只需按一下按钮（通过网络控制器界面）即可打开和关闭指示灯，而不是每次都配置3个通道。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
您需要访问开发者网站，该网站上提供了</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z-uno.z-wave.me/Reference/ZUNO_SWITCH_MULTILEVEL的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">示例</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ZUNo支持的每个类都有一个描述和一个示例。</font><font style="vertical-align: inherit;">接下来，将建议的功能复制并粘贴到您的草图中。</font><font style="vertical-align: inherit;">现在，在草图中，有3个开关多级通道和6个用于响应无线电命令的回调函数。</font><font style="vertical-align: inherit;">我在Z-Wave类中不是很老练，因此我以前的LED灯带设备在这组类中工作。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通道声明如下：</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">扰流板方向</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">ZUNO_SETUP_CHANNELS(<font></font>
      ZUNO_SWITCH_MULTILEVEL(getRed, setRed),<font></font>
      ZUNO_SWITCH_MULTILEVEL(getGreen, setGreen),<font></font>
      ZUNO_SWITCH_MULTILEVEL(getBlue, setBlue),<font></font>
      ZUNO_SWITCH_BINARY(switch_getter, switch_setter)<font></font>
);</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
添加到网络后，这导致在控制器中生成以下窗口小部件：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/to/-y/if/to-yif5eaf9xkuxdk4t2oxp6ph4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
要调整颜色，必须分别在控制器菜单中打开和配置每种颜色。</font><font style="vertical-align: inherit;">它既不方便又缓慢。</font><font style="vertical-align: inherit;">但是，我很幸运。</font><font style="vertical-align: inherit;">原来我并不孤单。</font><font style="vertical-align: inherit;">他们想到了我们，并创建了频道</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">z-uno.z-wave.me/Reference/ZUNO_SWITCH_COLOR</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">现在，草图中只有一个通道和两个回调函数。</font><font style="vertical-align: inherit;">在控制器菜单中，通过从调色板中进行选择，可以分别对每种颜色以及一次对所有颜色进行颜色设置。</font></font><br>
<br>
<pre><code class="cpp hljs">ZUNO_SETUP_CHANNELS(ZUNO_SWITCH_COLOR(SWITCH_COLOR_FLAGS_RED|SWITCH_COLOR_FLAGS_GREEN|SWITCH_COLOR_FLAGS_BLUE, getterFunction, setterFunction));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
并且在控制器菜单中看起来像这样：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/m3/zn/qk/m3znqkbwue228cttqmqmhggvwxu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
下一个功能通过无线电响应请求。</font><font style="vertical-align: inherit;">可能会要求读取颜色通道之一的状态。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">BYTE <span class="hljs-title">getterFunction</span><span class="hljs-params">(BYTE component)</span> </span>{
  <span class="hljs-keyword">switch</span>(component)<font></font>
  {<font></font>
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_RED:
      <span class="hljs-keyword">return</span> pwmR;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_GREEN:
      <span class="hljs-keyword">return</span> pwmG;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_BLUE:
      <span class="hljs-keyword">return</span> pwmB;
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这是用于从控制器界面设置颜色的功能。</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setterFunction</span><span class="hljs-params">(BYTE component, BYTE newValue)</span> 
</span>{
  <span class="hljs-keyword">switch</span>(component)<font></font>
  {<font></font>
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_RED:<font></font>
      pwmR = newValue;<font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_GREEN:<font></font>
      pwmG = newValue;<font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_BLUE:<font></font>
      pwmB = newValue;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  radio_action = <span class="hljs-number">1</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是将arduino草图转换为ZUNo草图所需的全部代码。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
组装和安装后，所有声明的任务均已完成。</font><font style="vertical-align: inherit;">但是，仍然有使用开关打开灯的习惯（事实证明这很方便）。</font><font style="vertical-align: inherit;">非接触式包含选项也适用。</font><font style="vertical-align: inherit;">在缺点中，我要指出的是，在给控制单元通电后，LED灯会闪烁一秒钟。</font><font style="vertical-align: inherit;">这是由于ZUNo外设的长时间初始化。</font><font style="vertical-align: inherit;">在这一点上，腿是不可预测的。</font><font style="vertical-align: inherit;">我认为，如果将其放在限流电阻之后，则晶体管栅极上的上拉电阻会纠正这种情况。</font><font style="vertical-align: inherit;">如果初始化代码将支路调整到输出并有目的地更改逻辑电平，则可以尝试使用RC滤波器，该滤波器不会通过短脉冲。</font><font style="vertical-align: inherit;">我还没有做过，也许我永远不会做！</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发现</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ZUNo及其扩展模块极大地简化了“家庭技术创造力”。但是，我认为这些产品非常昂贵，如果我在其他地方工作并且Z-Wave设备不在附近，那么我将在ESP8266上进行所有操作。在开发过程中，我学习了一种新的“标准”，用于标记电源中的电线。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sx/c4/4h/sxc44hipyu2ml_agdxtaqthtvrs.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在，不仅地球上标有黑色条纹，而且在我看来是“正极”线。对于扩展模块，这很重要。 5伏LM2594转换器出现故障（芯片和浸入式开关的价格约为200卢布）。我希望在扩展模块的下一版本中将有一个保护二极管，以防止“极性反转”。然后我将检查电源线的极性。另一个缺点与身体有关。外壳看起来不错，但是没有镊子，我无法将电线连接到接线盒。我希望会有一个带有其他接线端子的版本（用于从上方或倾斜角度连接电线）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我不喜欢将照片存储在云服务上，并且经常进行备份。因此，与设计过程和灯1有关的大多数照片都被不可挽回地破坏了。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/zz/wz/ov/zzwzovgton7f2yxvy-2bd4zhucu.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
这就是组装和调试过程的所有剩余内容。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果稍微弯曲一下，看起来背光灯就开始工作了。</font><font style="vertical-align: inherit;">如果拉直，则该框和开关不可见。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ya/qj/hn/yaqjhnpkhd7ge2ohejbp9ywkqpq.jpeg"> <br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZUNo的草图。</font><font style="vertical-align: inherit;">我附上，只是为了确认一切都是基本的</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"EEPROM.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"EEPR.h"</span></span><font></font>
<font></font>
<span class="hljs-keyword">int</span> readPin = <span class="hljs-number">9</span>;
<span class="hljs-keyword">int</span> triggerPin = <span class="hljs-number">10</span>;<font></font>
byte controlState = <span class="hljs-number">0</span>;<font></font>
word lastValue;<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> REDPIN   PWM1     <span class="hljs-comment">// pin connection R </span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> GREENPIN PWM2     <span class="hljs-comment">// pin connection G</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BLUEPIN  PWM3     <span class="hljs-comment">// pin connection B</span></span><font></font>
<font></font>
ZUNO_SETUP_CHANNELS(ZUNO_SWITCH_COLOR(SWITCH_COLOR_FLAGS_RED|SWITCH_COLOR_FLAGS_GREEN|SWITCH_COLOR_FLAGS_BLUE, getterFunction, setterFunction));<font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ON 1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> OFF 0</span>
<span class="hljs-keyword">uint8_t</span> switch_=OFF;<font></font>
<font></font>
<span class="hljs-keyword">uint8_t</span> pwmR=<span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> pwmG=<span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> pwmB=<span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> b_pwmR=<span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> b_pwmG=<span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> b_pwmB=<span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-keyword">enum</span><font></font>
{<font></font>
  DEF_R = <span class="hljs-number">255</span>,<font></font>
  DEF_G = <span class="hljs-number">255</span>,<font></font>
  DEF_B = <span class="hljs-number">255</span><font></font>
};<font></font>
<span class="hljs-keyword">uint8_t</span> radio_action = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> 
</span>{ <font></font>
  init_EEPROM();<font></font>
  Serial.begin();<font></font>
  pinMode(readPin, INPUT);<font></font>
  pinMode(triggerPin, OUTPUT);<font></font>
  digitalWrite(triggerPin, LOW);<font></font>
  pinMode(REDPIN, OUTPUT);<font></font>
  pinMode(GREENPIN, OUTPUT);<font></font>
  pinMode(BLUEPIN, OUTPUT);<font></font>
  analogWrite(REDPIN, pwmR &amp; <span class="hljs-number">0xff</span>);<font></font>
  analogWrite(GREENPIN, pwmG &amp; <span class="hljs-number">0xff</span>);<font></font>
  analogWrite(BLUEPIN, pwmB &amp; <span class="hljs-number">0xff</span>);<font></font>
  <font></font>
} <font></font>
<span class="hljs-keyword">int</span> act=<span class="hljs-number">1</span>;
<span class="hljs-keyword">int</span> actf = <span class="hljs-number">0</span>;
<span class="hljs-keyword">int</span> cnt=<span class="hljs-number">57</span>; <font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span>
</span>{
  <span class="hljs-keyword">int</span> tmp;
  <span class="hljs-comment">// trigger measurement</span><font></font>
  digitalWrite(triggerPin, LOW);<font></font>
  delayMicroseconds(<span class="hljs-number">10</span>);<font></font>
  digitalWrite(triggerPin, HIGH);<font></font>
  delayMicroseconds(<span class="hljs-number">10</span>);<font></font>
  digitalWrite(triggerPin, LOW);<font></font>
  <span class="hljs-comment">// read pulse width</span>
  tmp = pulseIn(readPin, HIGH, <span class="hljs-number">100000</span>);<font></font>
  lastValue = tmp / <span class="hljs-number">58</span>;<font></font>
  Serial.print(<span class="hljs-string">" cm= "</span>);<font></font>
  Serial.println(lastValue);<font></font>
  <span class="hljs-keyword">if</span> (lastValue &lt; <span class="hljs-number">30</span>)<font></font>
  {<font></font>
    cnt++;<font></font>
  }<font></font>
  <span class="hljs-keyword">else</span><font></font>
  {<font></font>
    cnt--;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (cnt &gt; <span class="hljs-number">55</span>)<font></font>
  { <font></font>
    act=<span class="hljs-number">1</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (cnt &gt; <span class="hljs-number">60</span>)<font></font>
    cnt= <span class="hljs-number">60</span>;
  <span class="hljs-keyword">if</span> (cnt &lt; <span class="hljs-number">50</span>)<font></font>
  {<font></font>
    act=<span class="hljs-number">0</span>;<font></font>
    actf=<span class="hljs-number">0</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">if</span> (cnt &lt; <span class="hljs-number">45</span> )<font></font>
    cnt = <span class="hljs-number">45</span>;<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> ((act == <span class="hljs-number">1</span>) &amp;&amp; (actf == <span class="hljs-number">0</span>))<font></font>
  {  <font></font>
    actf = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (switch_ == OFF)<font></font>
    {<font></font>
      switch_=ON;<font></font>
      b_pwmG = pwmG;<font></font>
      b_pwmB = pwmB;<font></font>
      b_pwmR = pwmR;<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span><font></font>
    {<font></font>
      switch_=OFF;<font></font>
      b_pwmR=<span class="hljs-number">0</span>;<font></font>
      b_pwmG=<span class="hljs-number">0</span>;<font></font>
      b_pwmB=<span class="hljs-number">0</span>;<font></font>
    }<font></font>
    analogWrite(REDPIN, b_pwmR &amp; <span class="hljs-number">0xff</span>);<font></font>
    analogWrite(GREENPIN, b_pwmG &amp; <span class="hljs-number">0xff</span>);<font></font>
    analogWrite(BLUEPIN, b_pwmB &amp; <span class="hljs-number">0xff</span>); <font></font>
  } <font></font>
  <font></font>
  Serial.print(<span class="hljs-string">"cnt = "</span>);    <font></font>
  Serial.print(cnt);  <font></font>
  Serial.print(<span class="hljs-string">" || "</span>);    <font></font>
  Serial.print(pwmR);  <font></font>
  Serial.print(<span class="hljs-string">" "</span>);      <font></font>
  Serial.print(pwmG);  <font></font>
  Serial.print(<span class="hljs-string">" "</span>);<font></font>
  Serial.print(pwmB);  <font></font>
  Serial.print(<span class="hljs-string">" "</span>);<font></font>
  Serial.println(<span class="hljs-string">""</span>);
 <span class="hljs-comment">// delay(10);</span><font></font>
<font></font>
 <span class="hljs-keyword">if</span>(radio_action)<font></font>
 {<font></font>
    radio_action = <span class="hljs-number">0</span>;<font></font>
    eepr_save_col();<font></font>
    analogWrite(REDPIN, pwmR &amp; <span class="hljs-number">0xff</span>);<font></font>
    analogWrite(GREENPIN, pwmG &amp; <span class="hljs-number">0xff</span>);<font></font>
    analogWrite(BLUEPIN, pwmB &amp; <span class="hljs-number">0xff</span>);<font></font>
 }<font></font>
}<font></font>
<font></font>
<span class="hljs-function">BYTE <span class="hljs-title">getterFunction</span><span class="hljs-params">(BYTE component)</span> </span>{
  <span class="hljs-keyword">switch</span>(component)<font></font>
  {<font></font>
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_RED:
      <span class="hljs-keyword">return</span> pwmR;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_GREEN:
      <span class="hljs-keyword">return</span> pwmG;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_BLUE:
      <span class="hljs-keyword">return</span> pwmB;
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setterFunction</span><span class="hljs-params">(BYTE component, BYTE newValue)</span> 
</span>{
  <span class="hljs-keyword">switch</span>(component)<font></font>
  {<font></font>
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_RED:<font></font>
      pwmR = newValue;<font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_GREEN:<font></font>
      pwmG = newValue;<font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> SWITCH_COLOR_COMPONENT_BLUE:<font></font>
      pwmB = newValue;<font></font>
      <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
  radio_action = <span class="hljs-number">1</span>;<font></font>
}<font></font>
</code></pre><br>
</div></div></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN488470/index.html">Kim Dotcom：抓住了，网上最通缉的人。第4部分</a></li>
<li><a href="../zh-CN488472/index.html">周末阅读：10种有关音频工具的材料-从苏联汽车收音机到消除噪音的插头</a></li>
<li><a href="../zh-CN488474/index.html">关于色彩，声音和“人群探索”作为一种单独的美丽</a></li>
<li><a href="../zh-CN488476/index.html">特斯拉管线圈</a></li>
<li><a href="../zh-CN488478/index.html">将所有MS SQL Server数据库传输到另一台计算机</a></li>
<li><a href="../zh-CN488482/index.html">对人们来说，鸦片多少钱</a></li>
<li><a href="../zh-CN488484/index.html">SQL启动-Microsoft SQL Server 2019活动</a></li>
<li><a href="../zh-CN488488/index.html">对于OpenBSD。有点高兴</a></li>
<li><a href="../zh-CN488490/index.html">Likbez戴防毒面具。呼吸器对感染病毒有帮助吗？11种呼吸器概述</a></li>
<li><a href="../zh-CN488492/index.html">特斯拉将以20亿美元发行新股</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>