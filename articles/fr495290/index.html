<!doctype html>
<html class="no-js" lang="fr">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙆🏿 👨‍👩‍👧‍👧 👩‍👩‍👧 Explorer la qualité du code du système d'exploitation Zephyr 🎓 👨🏿‍🏫 🚸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous avons récemment déclaré que l'analyseur de code PVS-Studio avait commencé à s'intégrer à PlatformIO. Naturellement, l'équipe de développement de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Explorer la qualité du code du système d'exploitation Zephyr</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/495290/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4ee/aeb/25b/4eeaeb25b1ec54a9016cec031ae97451.png" alt="PVS-Studio et Zephyr"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nous avons récemment déclaré que l'analyseur de code PVS-Studio avait commencé à s'intégrer à PlatformIO. </font><font style="vertical-align: inherit;">Naturellement, l'équipe de développement de PVS-Studio a communiqué avec l'équipe de PlatformIO et ils ont suggéré, par souci d'intérêt, de vérifier le code du système d'exploitation en temps réel Zephyr. </font><font style="vertical-align: inherit;">Pourquoi pas, nous avons pensé, et voici un article sur une telle étude.</font></font><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PlatformIO</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avant de commencer la partie principale de l'article, je voudrais recommander le projet </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PlatformIO</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> aux développeurs de systèmes embarqués </font><font style="vertical-align: inherit;">, ce qui peut leur faciliter la vie. </font><font style="vertical-align: inherit;">Il s'agit d'un outil de programmation de microcontrôleur multiplateforme. </font><font style="vertical-align: inherit;">Le cœur de PlatformIO est un outil en ligne de commande, mais il est recommandé de l'utiliser comme plug-in pour Visual Studio Code. </font><font style="vertical-align: inherit;">Un grand nombre de puces et de cartes mères modernes basées sur celles-ci sont prises en charge. </font><font style="vertical-align: inherit;">Il est capable de télécharger automatiquement les systèmes d'assemblage appropriés et le site possède une grande collection de bibliothèques pour gérer les composants électroniques enfichables.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio est encore peu connu dans le monde des systèmes embarqués, donc juste au cas où, je ferai une introduction pour les nouveaux lecteurs qui ne connaissent pas encore cet outil. </font><font style="vertical-align: inherit;">Nos lecteurs réguliers peuvent passer directement à la section suivante. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un analyseur de code statique qui permet de détecter les erreurs et les vulnérabilités potentielles dans le code des programmes écrits en C, C ++, C # et Java. </font><font style="vertical-align: inherit;">Si nous ne parlons que de C et C ++, les compilateurs suivants sont pris en charge:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les fenêtres </font><font style="vertical-align: inherit;">Visual Studio 2010-2019 C, C ++, C ++ / CLI, C ++ / CX (WinRT)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les fenêtres </font><font style="vertical-align: inherit;">IAR Embedded Workbench, compilateur C / C ++ pour ARM C, C ++</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">les fenêtres </font><font style="vertical-align: inherit;">QNX Momentics, QCC C, C ++</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows / Linux </font><font style="vertical-align: inherit;">Keil µVision, DS-MDK, ARM Compiler 5/6 C, C ++</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Windows / Linux </font><font style="vertical-align: inherit;">Texas Instruments Code Composer Studio, Outils de génération de code ARM C, C ++</font></font></li>
<li>Windows/Linux/macOS. GNU Arm Embedded Toolchain, Arm Embedded GCC compiler, C, C++</li>
<li>Windows/Linux/macOS. Clang C, C++</li>
<li>Linux/macOS. GCC C, C++</li>
<li>Windows. MinGW C, C++</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'analyseur possède son propre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">système de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> classification des </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">avertissements</font></a><font style="vertical-align: inherit;"> , mais si nécessaire, vous pouvez activer l'affichage des alertes selon les normes de codage </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SEI CERT</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MISRA</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vous pouvez rapidement commencer à utiliser régulièrement PVS-Studio, même dans un grand projet hérité. Un mécanisme spécial de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">suppression</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> massive </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">des avertissements est</font></a><font style="vertical-align: inherit;"> prévu à cet effet </font><font style="vertical-align: inherit;">. Tous les avertissements actuels sont considérés comme des dettes techniques et sont masqués, ce qui vous permet de vous concentrer sur les avertissements qui s'appliquent uniquement au code nouveau ou modifié. Cela permet à l'équipe de commencer immédiatement à utiliser l'analyseur quotidiennement dans son travail, et vous pouvez de temps en temps revenir au devoir technique et améliorer le code.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il existe de nombreux autres scénarios d'utilisation de PVS-Studio. </font><font style="vertical-align: inherit;">Par exemple, vous pouvez l'utiliser comme plugin pour SonarQube. </font><font style="vertical-align: inherit;">L'intégration avec des systèmes tels que Travis CI, CircleCI, GitLab CI / CD, etc. est possible. </font><font style="vertical-align: inherit;">Une description plus détaillée de PVS-Studio dépasse le cadre de cet article. </font><font style="vertical-align: inherit;">Par conséquent, je propose de vous familiariser avec l'article, qui contient de nombreux liens utiles, et dans lequel des réponses à de nombreuses questions sont données: " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raisons pour introduire l'analyseur de code statique PVS-Studio dans le processus de développement</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ."</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zéphyr</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Travaillant sur l' </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intégration de PVS-Studio dans PlatformIO</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nos équipes se sont entretenues et ont été invitées à découvrir un projet du monde embarqué, à savoir Zephyr. </font><font style="vertical-align: inherit;">Nous avons aimé l'idée, ce qui a motivé la rédaction de cet article. </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zephyr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un système d'exploitation léger en temps réel conçu pour fonctionner sur des appareils avec des ressources limitées de diverses architectures. </font><font style="vertical-align: inherit;">Le code est distribué sous la licence open source Apache 2.0. </font><font style="vertical-align: inherit;">Fonctionne sur les plateformes suivantes: ARM (Cortex-M0, Cortex-M3, Cortex-M4, Cortex-M23, Cortex-M33, Cortex-R4, Cortex-R5, Cortex-A53), x86, x86-64, ARC, RISC- V, Nios II, Xtensa. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Certaines fonctionnalités:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espace d'adressage unifié. </font><font style="vertical-align: inherit;">Le code d'application spécifique en combinaison avec le noyau personnalisé crée une image monolithique qui est exécutée sur l'appareil.</font></font></li>
<li>  .     ,        .</li>
<li>    .       .</li>
<li>  .     .           .</li>
<li>    : ,  ,  ,     ,     .</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parmi les moments intéressants pour nous, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synopsys</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est impliqué dans le développement du système d'exploitation </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">En 2014, Synopsys a acquis Coverity, qui a produit l'analyseur de code statique du même nom. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il est naturel que dès le début, le développeur Zephyr utilise l'analyseur </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coverity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">L'analyseur est un leader du marché et cela ne peut qu'améliorer la qualité du code du système d'exploitation.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qualité du code Zephyr</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À mon avis, le code du système d'exploitation Zephyr est de qualité. </font><font style="vertical-align: inherit;">Voici ce qui me donne raison de le penser:</font></font><br>
<br>
<ul>
<li> PVS-Studio  122     High  367   Medium.  , ,    560 C/C++ .     .       7810 C/C++   10075  . ,     . ,      ,          .</li>
<li>       .    «» ,   .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L'utilitaire </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SourceMonitor</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , après avoir analysé le code source, a fourni des statistiques selon lesquelles 48% du code sont des commentaires. </font><font style="vertical-align: inherit;">C'est beaucoup et d'après mon expérience, cela indique une grande préoccupation pour la qualité du code, sa compréhensibilité pour les autres développeurs.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lors du développement d'un projet, un analyseur de code statique Coverity est utilisé. </font><font style="vertical-align: inherit;">Très probablement, de ce fait, l'analyseur PVS-Studio, bien qu'il ait trouvé des erreurs dans le projet, ne pouvait pas se montrer clairement, comme cela arrive parfois lors de l'analyse d'autres projets.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sur cette base, je pense que les auteurs du projet se soucient de la qualité et de la fiabilité du code. </font><font style="vertical-align: inherit;">Voyons maintenant quelques avertissements émis par l'analyseur PVS-Studio (version 7.06).</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Semi-faux avertissements</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le code du projet, en raison de son faible niveau, est écrit de manière assez spécifique et avec beaucoup de compilation conditionnelle (#ifdef). Cela génère un grand nombre d'avertissements qui n'indiquent pas une véritable erreur, mais ils ne peuvent pas être appelés simplement faux. Il sera plus facile de clarifier cela avec quelques exemples. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple d'actionnement «semi-faux» N1</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">char_framebuffer</span> <span class="hljs-title">char_fb</span>;</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">cfb_framebuffer_invert</span><span class="hljs-params">(struct device *dev)</span>
</span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">char_framebuffer</span> *<span class="hljs-title">fb</span> = &amp;<span class="hljs-title">char_fb</span>;</span><font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!fb || !fb-&gt;buf) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
  }<font></font>
<font></font>
  fb-&gt;inverted = !fb-&gt;inverted;<font></font>
<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio Warning: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V560</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Une partie de l'expression conditionnelle est toujours fausse </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">:! Fb</font></a><font style="vertical-align: inherit;"> . cfb.c 188 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lors de la prise de l'adresse d'une variable statique, un pointeur non nul est toujours obtenu. Par conséquent, le pointeur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fb est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> toujours non nul et sa vérification n'a pas de sens. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, il est clair que ce n'est pas du tout une erreur, mais simplement un contrôle excessif, qui ne fait pas de mal. De plus, lors de la construction de la version Release, le compilateur la jettera, donc cela ne causera même pas de ralentissement. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un cas similaire, à ma connaissance, relève du concept de fonctionnement de l'analyseur «semi-faux». Formellement, l'analyseur a absolument raison. Et il est préférable de supprimer la vérification inutile supplémentaire du code. Cependant, tout cela est mesquin et de tels avertissements ne sont même pas intéressants à considérer dans le cadre de l'article.</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple d'actionnement «semi-faux» N2</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">hex2char</span><span class="hljs-params">(<span class="hljs-keyword">u8_t</span> x, <span class="hljs-keyword">char</span> *c)</span>
</span>{
  <span class="hljs-keyword">if</span> (x &lt;= <span class="hljs-number">9</span>) {<font></font>
    *c = x + <span class="hljs-string">'0'</span>;<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x &gt;= <span class="hljs-number">10</span> &amp;&amp; x &lt;= <span class="hljs-number">15</span>) {<font></font>
    *c = x - <span class="hljs-number">10</span> + <span class="hljs-string">'a'</span>;<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> -EINVAL;<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avertissement PVS-Studio: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V560</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Une partie de l'expression conditionnelle est toujours vraie: x&gt; = 10. hex.c 31 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'analyseur a de nouveau formellement raison d'affirmer qu'une partie de la condition est toujours vraie. </font><font style="vertical-align: inherit;">Si la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x n'est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pas inférieure / égale à 9, alors il s'avère qu'elle est toujours supérieure / égale à 10. Et le code peut être simplifié:</font></font><br>
<br>
<pre><code class="cpp hljs">} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x &lt;= <span class="hljs-number">15</span>) {</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Encore une fois, il est clair qu'il n'y a pas vraiment d'erreur nuisible ici, et la comparaison supplémentaire est écrite juste pour la beauté du code. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voyons maintenant un exemple plus complexe de N3. </font></font></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">Voyons d'abord</font></i></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
comment la macro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CHECKIF</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> peut être implémentée </font><font style="vertical-align: inherit;">.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(CONFIG_ASSERT_ON_ERRORS)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHECKIF(expr) \
  __ASSERT_NO_MSG(!(expr));   \
  <span class="hljs-meta-keyword">if</span> (0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> defined(CONFIG_NO_RUNTIME_CHECKS)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHECKIF(...) \
  <span class="hljs-meta-keyword">if</span> (0)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHECKIF(expr) \
  <span class="hljs-meta-keyword">if</span> (expr)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selon le mode de compilation du projet, la vérification peut être effectuée ou ignorée. </font><font style="vertical-align: inherit;">Dans notre cas, lors de la vérification du code à l'aide de PVS-Studio, cette implémentation de macro a été sélectionnée:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CHECKIF(expr) \
  <span class="hljs-meta-keyword">if</span> (expr)</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voyons maintenant à quoi cela mène.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">k_queue_append_list</span><span class="hljs-params">(struct k_queue *<span class="hljs-built_in">queue</span>, <span class="hljs-keyword">void</span> *head, <span class="hljs-keyword">void</span> *tail)</span>
</span>{<font></font>
  CHECKIF(head == <span class="hljs-literal">NULL</span> || tail == <span class="hljs-literal">NULL</span>) {
    <span class="hljs-keyword">return</span> -EINVAL;<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">k_spinlock_key_t</span> key = k_spin_lock(&amp;<span class="hljs-built_in">queue</span>-&gt;lock);
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">k_thread</span> *<span class="hljs-title">thread</span> = <span class="hljs-title">NULL</span>;</span>
  <span class="hljs-keyword">if</span> (head != <span class="hljs-literal">NULL</span>) {<font></font>
    thread = z_unpend_first_thread(&amp;<span class="hljs-built_in">queue</span>-&gt;wait_q);<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissement</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
PVS-Studio: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">V547</font></a><font style="vertical-align: inherit;"> [CWE-571] L'expression 'head! = NULL' est toujours vraie. </font><font style="vertical-align: inherit;">queue.c 244 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'analyseur considère que la vérification </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(head! = NULL)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> donne toujours true. </font><font style="vertical-align: inherit;">Et c'est effectivement le cas. </font><font style="vertical-align: inherit;">Si le pointeur de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tête</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> était NULL, alors la fonction cesserait de fonctionner en raison d'une vérification au début de la fonction:</font></font><br>
<br>
<pre><code class="cpp hljs">CHECKIF(head == <span class="hljs-literal">NULL</span> || tail == <span class="hljs-literal">NULL</span>) {
  <span class="hljs-keyword">return</span> -EINVAL;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rappelons qu'ici la macro se développe comme suit:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> (head == <span class="hljs-literal">NULL</span> || tail == <span class="hljs-literal">NULL</span>) {
  <span class="hljs-keyword">return</span> -EINVAL;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, l'analyseur PVS-Studio est juste de son point de vue et émet un avertissement correct. </font><font style="vertical-align: inherit;">Cependant, cette vérification ne peut pas être supprimée. </font><font style="vertical-align: inherit;">Elle est nécessaire. </font><font style="vertical-align: inherit;">Dans un autre scénario, la macro s'ouvrira comme ceci:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span>) {
  <span class="hljs-keyword">return</span> -EINVAL;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et puis revérifier le pointeur est nécessaire. </font><font style="vertical-align: inherit;">Bien sûr, l'analyseur ne générera pas d'avertissement dans cette version de compilation de code. </font><font style="vertical-align: inherit;">Cependant, il donne un avertissement pour la version de débogage de la compilation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'espère que maintenant, les lecteurs savent clairement d'où viennent les avertissements «semi-faux». </font><font style="vertical-align: inherit;">Cependant, il n'y a rien de mal avec eux. </font><font style="vertical-align: inherit;">L'analyseur PVS-Studio fournit divers mécanismes pour supprimer les fausses alertes, qui peuvent être trouvés dans la documentation.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissements de cas</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais avez-vous trouvé quelque chose d'intéressant après tout? </font><font style="vertical-align: inherit;">Ce fut un succès, et maintenant nous allons examiner diverses erreurs. </font><font style="vertical-align: inherit;">En même temps, je tiens à noter immédiatement deux points:</font></font><br>
<br>
<ol>
<li>       .  :   , , ,      Coverity. ,     PVS-Studio  -  ,               . </li>
<li>            . ,             «»      .      ,          .         GitHub,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a> PVS-Studio.</li>
</ol><br>
<b> N1, </b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">gen_prov_ack</span><span class="hljs-params">(struct prov_rx *rx, struct net_buf_simple *buf)</span>
</span>{<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (link.tx.cb &amp;&amp; link.tx.cb) {<font></font>
    link.tx.cb(<span class="hljs-number">0</span>, link.tx.cb_data);<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avertissement PVS-Studio: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V501</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-571] Il existe des sous-expressions identiques à gauche et à droite de l'opérateur '&amp;&amp;': link.tx.cb &amp;&amp; link.tx.cb pb_adv.c 377 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
L'une est vérifiée deux fois la même variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link.tx.cb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Apparemment, c'est une faute de frappe, et la deuxième variable à vérifier devrait être </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">link.tx.cb_data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment N2, </font></font></b><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">débordement du </font></i><b><font style="vertical-align: inherit;">tampon</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Considérons la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">net_hostname_get</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , qui sera utilisée plus tard.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(CONFIG_NET_HOSTNAME_ENABLE)</span>
<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">net_hostname_get</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">net_hostname_get</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">"zephyr"</span>;<font></font>
}<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans mon cas, lors du prétraitement, l'option liée à la branche </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#else</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a été </font><i><font style="vertical-align: inherit;">sélectionnée</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Autrement dit, dans le fichier prétraité, la fonction est implémentée comme ceci:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">net_hostname_get</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
  <span class="hljs-keyword">return</span> <span class="hljs-string">"zephyr"</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction retourne un pointeur sur un tableau de 7 octets (on prend en compte le terminal zéro à la fin de la ligne). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Considérez maintenant le code qui mène à la sortie de la limite du tableau.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">do_net_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{<font></font>
  ....<font></font>
  (<span class="hljs-keyword">void</span>)<span class="hljs-built_in">memcpy</span>(hostname, net_hostname_get(), MAX_HOSTNAME_LEN);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avertissement PVS-Studio: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V512</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-119] Un appel de la fonction 'memcpy' entraînera la sortie du buffer 'net_hostname_get ()'. </font><font style="vertical-align: inherit;">log_backend_net.c 114 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Après le prétraitement, </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MAX_HOSTNAME_LEN est</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> développé comme suit:</font></font><br>
<br>
<pre><code class="cpp hljs">(<span class="hljs-keyword">void</span>)<span class="hljs-built_in">memcpy</span>(hostname, net_hostname_get(),
    <span class="hljs-keyword">sizeof</span>(<span class="hljs-string">"xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx"</span>));</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, lors de la copie de données, un littéral de chaîne dépasse la frontière. </font><font style="vertical-align: inherit;">Il est difficile de prédire comment cela affectera l'exécution du programme, car cela conduit à un comportement indéfini. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment N3, dépassement potentiel du tampon</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">do_write_op_json</span><span class="hljs-params">(struct lwm2m_message *msg)</span>
</span>{
  <span class="hljs-keyword">u8_t</span> value[TOKEN_BUF_LEN];
  <span class="hljs-keyword">u8_t</span> base_name[MAX_RESOURCE_LEN];
  <span class="hljs-keyword">u8_t</span> full_name[MAX_RESOURCE_LEN];<font></font>
  ....<font></font>
  <span class="hljs-comment">/* combine base_name + name */</span>
  <span class="hljs-built_in">snprintf</span>(full_name, TOKEN_BUF_LEN, <span class="hljs-string">"%s%s"</span>, base_name, value);<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avertissement PVS-Studio: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V512</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-119] Un appel de la fonction 'snprintf' entraînera un débordement du tampon 'full_name'. lwm2m_rw_json.c 826 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nous substituons des valeurs de macro, l'image de ce qui se passe ressemble à ceci:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">u8_t</span> value[<span class="hljs-number">64</span>];
<span class="hljs-keyword">u8_t</span> base_name[<span class="hljs-number">20</span>];
<span class="hljs-keyword">u8_t</span> full_name[<span class="hljs-number">20</span>];<font></font>
....<font></font>
<span class="hljs-built_in">snprintf</span>(full_name, <span class="hljs-number">64</span>, <span class="hljs-string">"%s%s"</span>, base_name, value);</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seuls 20 octets sont alloués </font><font style="vertical-align: inherit;">
sous le tampon </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">full_name</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> dans lequel la chaîne est formée. Dans ce cas, les parties à partir desquelles la chaîne est formée sont stockées dans des tampons de 20 et 64 octets. De plus, la constante 64, passée à la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">snprintf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et conçue pour empêcher la baie d'aller à l'étranger, est évidemment trop grosse! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ce code ne conduit pas nécessairement à un débordement de tampon. Peut-être toujours chanceux et les sous-chaînes sont toujours très petites. Cependant, en général, ce code n'est en aucun cas protégé contre le débordement et contient la faille de sécurité classique </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CWE-119</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment N4, l'expression est toujours vraie</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">keys_set</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *name, <span class="hljs-keyword">size_t</span> len_rd, settings_read_cb read_cb,
                    <span class="hljs-keyword">void</span> *cb_arg)</span>
</span>{<font></font>
  ....<font></font>
  <span class="hljs-keyword">size_t</span> len;<font></font>
  ....<font></font>
  len = read_cb(cb_arg, val, <span class="hljs-keyword">sizeof</span>(val));
  <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) {<font></font>
    BT_ERR(<span class="hljs-string">"Failed to read value (err %zu)"</span>, len);
    <span class="hljs-keyword">return</span> -EINVAL;<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissement</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
PVS-Studio: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">V547</font></a><font style="vertical-align: inherit;"> [CWE-570] L'expression 'len &lt;0' est toujours fausse. </font><font style="vertical-align: inherit;">La valeur du type non signé n'est jamais &lt;0. keys.c 312 La </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">len</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a un type non signé et, par conséquent, ne peut pas être inférieure à 0. Par conséquent, le statut d'erreur n'est en aucun cas traité. </font><font style="vertical-align: inherit;">Dans d'autres endroits </font><font style="vertical-align: inherit;">, le type </font><i><font style="vertical-align: inherit;">int</font></i><font style="vertical-align: inherit;"> ou </font><i><font style="vertical-align: inherit;">ssize_t est</font></i><font style="vertical-align: inherit;"> utilisé </font><font style="vertical-align: inherit;">pour stocker le résultat de la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_cb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">
Exemple:</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">int</span> <span class="hljs-title">mesh_x_set</span><span class="hljs-params">(....)</span>
</span>{
 <span class="hljs-keyword">ssize_t</span> len;<font></font>
 len = read_cb(cb_arg, out, read_len);<font></font>
 <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) {<font></font>
 ....<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Remarque. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout </font><font style="vertical-align: inherit;">semble </font><font style="vertical-align: inherit;">aller mal </font><font style="vertical-align: inherit;">avec la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_cb</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Le fait est qu'il est déclaré comme ceci:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">u8_t</span> <span class="hljs-title">read_cb</span><span class="hljs-params">(<span class="hljs-keyword">const</span> struct bt_gatt_attr *attr, <span class="hljs-keyword">void</span> *user_data)</span></span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u8_t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un caractère </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non signé. </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction ne renvoie toujours que des nombres positifs de type caractère </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">non signé</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Si vous mettez cette valeur dans une variable signée de type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ssize_t</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la valeur sera toujours positive. </font><font style="vertical-align: inherit;">Par conséquent, dans d'autres endroits, la vérification de l'état d'erreur ne fonctionne pas non plus. </font><font style="vertical-align: inherit;">Mais je ne me suis pas plongé dans l'étude de cette question. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment N5, quelque chose de très étrange</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">mntpt_prepare</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *mntpt)</span>
</span>{
  <span class="hljs-keyword">char</span> *cpy_mntpt;<font></font>
<font></font>
  cpy_mntpt = k_malloc(<span class="hljs-built_in">strlen</span>(mntpt) + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (cpy_mntpt) {<font></font>
    ((<span class="hljs-keyword">u8_t</span> *)mntpt)[<span class="hljs-built_in">strlen</span>(mntpt)] = <span class="hljs-string">'\0'</span>;
    <span class="hljs-built_in">memcpy</span>(cpy_mntpt, mntpt, <span class="hljs-built_in">strlen</span>(mntpt));<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> cpy_mntpt;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avertissement PVS-Studio: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V575</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-628] La fonction 'memcpy' ne copie pas la chaîne entière. </font><font style="vertical-align: inherit;">Utilisez la fonction 'strcpy / strcpy_s' pour conserver la valeur null du terminal. </font><font style="vertical-align: inherit;">shell.c 427</font></font><br>
<br>
<p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/11e/bb5/367/11ebb53676d77d0d9418b626de856106.png" alt="Code étrange"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Quelqu'un a essayé de créer un analogue de la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">strdup</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais il n'a pas réussi. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Commençons par l'avertissement de l'analyseur. </font><font style="vertical-align: inherit;">Il signale que la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">memcpy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> copie la ligne, mais ne copie pas le terminal zéro, ce qui est très suspect. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il semble que ce terminal 0 soit copié ici:</font></font><br>
<br>
<pre><code class="cpp hljs">((<span class="hljs-keyword">u8_t</span> *)mntpt)[<span class="hljs-built_in">strlen</span>(mntpt)] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mais non! </font><font style="vertical-align: inherit;">Voici une faute de frappe, à cause de laquelle le terminal zéro est copié sur lui-même! </font><font style="vertical-align: inherit;">Notez que l'écriture dans le tableau </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mntpt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pas </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cpy_mntpt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Par conséquent, la fonction </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mntpt_prepare</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> renvoie une chaîne incomplète avec un terminal zéro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En fait, le programmeur voulait écrire comme ceci:</font></font><br>
<br>
<pre><code class="cpp hljs">((<span class="hljs-keyword">u8_t</span> *)cpy_mntpt)[<span class="hljs-built_in">strlen</span>(mntpt)] = <span class="hljs-string">'\0'</span>;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cependant, on ne sait toujours pas pourquoi c'était si compliqué! </font><font style="vertical-align: inherit;">Ce code peut être simplifié avec l'option suivante:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> *<span class="hljs-title">mntpt_prepare</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *mntpt)</span>
</span>{
  <span class="hljs-keyword">char</span> *cpy_mntpt;<font></font>
<font></font>
  cpy_mntpt = k_malloc(<span class="hljs-built_in">strlen</span>(mntpt) + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (cpy_mntpt) {
    <span class="hljs-built_in">strcpy</span>(cpy_mntpt, mntpt);<font></font>
  }<font></font>
  <span class="hljs-keyword">return</span> cpy_mntpt;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment N6, déréférencer un pointeur avant validation</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">bt_mesh_model_publish</span><span class="hljs-params">(struct bt_mesh_model *model)</span>
</span>{<font></font>
  ....<font></font>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bt_mesh_model_pub</span> *<span class="hljs-title">pub</span> = <span class="hljs-title">model</span>-&gt;<span class="hljs-title">pub</span>;</span><font></font>
  ....<font></font>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bt_mesh_msg_ctx</span> <span class="hljs-title">ctx</span> = {</span><font></font>
    .send_rel = pub-&gt;send_rel,<font></font>
  };<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (!pub) {
    <span class="hljs-keyword">return</span> -ENOTSUP;<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avertissement PVS-Studio: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-476] Le pointeur "pub" a été utilisé avant d'être vérifié par rapport à nullptr. </font><font style="vertical-align: inherit;">Vérifiez les lignes: 708, 719. access.c 708 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un </font><font style="vertical-align: inherit;">modèle d'erreur </font><font style="vertical-align: inherit;">très </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">courant</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tout d'abord, le pointeur est déréférencé pour initialiser un membre de la structure:</font></font><br>
<br>
<pre><code class="cpp hljs">.send_rel = pub-&gt;send_rel,</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et ce n'est qu'ensuite que l'on vérifie que ce pointeur peut être nul. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment N7-N9, déréférencement de pointeur avant validation</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">net_tcp_accept</span><span class="hljs-params">(struct net_context *context, <span class="hljs-keyword">net_tcp_accept_cb_t</span> cb,
                   <span class="hljs-keyword">void</span> *user_data)</span>
</span>{<font></font>
  ....<font></font>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcp</span> *<span class="hljs-title">conn</span> = <span class="hljs-title">context</span>-&gt;<span class="hljs-title">tcp</span>;</span><font></font>
  ....<font></font>
  conn-&gt;accept_cb = cb;<font></font>
<font></font>
  <span class="hljs-keyword">if</span> (!conn || conn-&gt;state != TCP_LISTEN) {
    <span class="hljs-keyword">return</span> -EINVAL;<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avertissement PVS-Studio: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-476] Le pointeur 'conn' a été utilisé avant d'être vérifié par rapport à nullptr. </font><font style="vertical-align: inherit;">Vérifiez les lignes: 1071, 1073. tcp2.c 1071 Identique </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
au cas précédent. </font><font style="vertical-align: inherit;">Aucune explication n'est requise ici. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deux autres erreurs de ce type peuvent être vues ici:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 [CWE-476] Le pointeur 'context-&gt; tcp' a été utilisé avant d'être vérifié par rapport à nullptr. </font><font style="vertical-align: inherit;">Vérifiez les lignes: 1512, 1518. tcp.c 1512</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V595 [CWE-476] Le pointeur 'fsm' a été utilisé avant d'être vérifié par rapport à nullptr. </font><font style="vertical-align: inherit;">Vérifiez les lignes: 365, 382. fsm.c 365</font></font></li>
</ul><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment N10, vérification erronée</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">x509_get_subject_alt_name</span><span class="hljs-params">( <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> **p,
                                      <span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> *end,
                                      mbedtls_x509_sequence *subject_alt_name)</span>
</span>{<font></font>
  ....<font></font>
    <span class="hljs-keyword">while</span>( *p &lt; end )<font></font>
    {<font></font>
        <span class="hljs-keyword">if</span>( ( end - *p ) &lt; <span class="hljs-number">1</span> )
            <span class="hljs-keyword">return</span>( MBEDTLS_ERR_X509_INVALID_EXTENSIONS +<font></font>
                    MBEDTLS_ERR_ASN1_OUT_OF_DATA );<font></font>
    ....<font></font>
  }<font></font>
  ....<font></font>
}</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avertissement</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
PVS-Studio: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">V547</font></a><font style="vertical-align: inherit;"> [CWE-570] L'expression '(fin - * p) &lt;1' ​​est toujours fausse. </font><font style="vertical-align: inherit;">x509_crt.c 635 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Examinez de près les conditions:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* p &lt;fin</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(fin - * p) &lt;1</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ils se contredisent. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si (* p &lt;end), alors (end - * p) donnera toujours une valeur de 1 ou plus. </font><font style="vertical-align: inherit;">En général, il y a quelque chose qui ne va pas ici, mais je ne sais pas comment l'épeler correctement. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment N11, code inaccessible</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">uint32_t</span> <span class="hljs-title">lv_disp_get_inactive_time</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">lv_disp_t</span> * disp)</span>
</span>{
    <span class="hljs-keyword">if</span>(!disp) disp = lv_disp_get_default();
    <span class="hljs-keyword">if</span>(!disp) {<font></font>
        LV_LOG_WARN(<span class="hljs-string">"lv_disp_get_inactive_time: no display registered"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">if</span>(disp) <span class="hljs-keyword">return</span> lv_tick_elaps(disp-&gt;last_activity_time);<font></font>
<font></font>
    <span class="hljs-keyword">lv_disp_t</span> * d;
    <span class="hljs-keyword">uint32_t</span> t = UINT32_MAX;<font></font>
    d          = lv_disp_get_next(<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">while</span>(d) {<font></font>
        t = LV_MATH_MIN(t, lv_tick_elaps(d-&gt;last_activity_time));<font></font>
        d = lv_disp_get_next(d);<font></font>
    }<font></font>
<font></font>
    <span class="hljs-keyword">return</span> t;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Avertissement PVS-Studio: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V547</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> [CWE-571] L'expression 'disp' est toujours vraie. lv_disp.c 148 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction se termine si </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est un pointeur nul. Ensuite, au contraire, on vérifie que le pointeur </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">disp</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> n'est </font><font style="vertical-align: inherit;">pas nul (et c'est toujours le cas), et la fonction termine à nouveau son travail. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Par conséquent, une partie du code d'une fonction ne sera jamais contrôlée du tout. </font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment N12, étrange valeur de retour</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">size_t</span> <span class="hljs-title">put_end_tlv</span><span class="hljs-params">(struct lwm2m_output_context *out, <span class="hljs-keyword">u16_t</span> mark_pos,
        <span class="hljs-keyword">u8_t</span> *writer_flags, <span class="hljs-keyword">u8_t</span> writer_flag,
        <span class="hljs-keyword">int</span> tlv_type, <span class="hljs-keyword">int</span> tlv_id)</span>
</span>{
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tlv_out_formatter_data</span> *<span class="hljs-title">fd</span>;</span>
  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">oma_tlv</span> <span class="hljs-title">tlv</span>;</span>
  <span class="hljs-keyword">u32_t</span> len = <span class="hljs-number">0U</span>;<font></font>
<font></font>
  fd = engine_get_out_user_data(out);<font></font>
  <span class="hljs-keyword">if</span> (!fd) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
  }<font></font>
<font></font>
  *writer_flags &amp;= ~writer_flag;<font></font>
<font></font>
  len = out-&gt;out_cpkt-&gt;offset - mark_pos;<font></font>
<font></font>
  <span class="hljs-comment">/* use stored location */</span><font></font>
  fd-&gt;mark_pos = mark_pos;<font></font>
<font></font>
  <span class="hljs-comment">/* set instance length */</span><font></font>
  tlv_setup(&amp;tlv, tlv_type, tlv_id, len);<font></font>
  len = oma_tlv_put(&amp;tlv, out, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">true</span>) - tlv.length;
  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio Warning: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1001</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La variable 'len' est affectée mais n'est pas utilisée à la fin de la fonction. </font><font style="vertical-align: inherit;">lwm2m_rw_oma_tlv.c 338 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La fonction contient deux </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instructions de retour</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> qui renvoient toutes les deux 0. Il est étrange que la fonction renvoie toujours 0. Il est également étrange que la variable </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">len</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ne soit plus utilisée après l'affectation. </font><font style="vertical-align: inherit;">J'ai un grand soupçon qu'il devrait en fait être écrit comme ceci:</font></font><br>
<br>
<pre><code class="cpp hljs">  len = oma_tlv_put(&amp;tlv, out, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">true</span>) - tlv.length;
  <span class="hljs-keyword">return</span> len;<font></font>
}</code></pre><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fragment N13-N16, erreur de synchronisation</font></font></b><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">nvs_startup</span><span class="hljs-params">(struct nvs_fs *fs)</span>
</span>{<font></font>
  ....<font></font>
  k_mutex_lock(&amp;fs-&gt;nvs_lock, K_FOREVER);<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (fs-&gt;ate_wra == fs-&gt;data_wra &amp;&amp; last_ate.len) {
    <span class="hljs-keyword">return</span> -ESPIPE;<font></font>
  }<font></font>
  ....<font></font>
end:<font></font>
  k_mutex_unlock(&amp;fs-&gt;nvs_lock);<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PVS-Studio Warning: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1020</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La fonction s'est terminée sans appeler la fonction 'k_mutex_unlock'. </font><font style="vertical-align: inherit;">Vérifiez les lignes: 620, 549. nvs.c 620 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il y a une situation où une fonction termine son travail sans déverrouiller le mutex. </font><font style="vertical-align: inherit;">Si je comprends bien, il serait correct d'écrire comme ceci:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">nvs_startup</span><span class="hljs-params">(struct nvs_fs *fs)</span>
</span>{<font></font>
  ....<font></font>
  k_mutex_lock(&amp;fs-&gt;nvs_lock, K_FOREVER);<font></font>
  ....<font></font>
  <span class="hljs-keyword">if</span> (fs-&gt;ate_wra == fs-&gt;data_wra &amp;&amp; last_ate.len) {<font></font>
    rc = -ESPIPE;<font></font>
    <span class="hljs-keyword">goto</span> end;<font></font>
  }<font></font>
  ....<font></font>
end:<font></font>
  k_mutex_unlock(&amp;fs-&gt;nvs_lock);<font></font>
  <span class="hljs-keyword">return</span> rc;<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Trois autres erreurs de ce type:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1020 La fonction s'est terminée sans appeler la fonction 'k_mutex_unlock'. </font><font style="vertical-align: inherit;">Lignes de contrôle: 574, 549. nvs.c 574</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1020 La fonction s'est terminée sans appeler la fonction 'k_mutex_unlock'. </font><font style="vertical-align: inherit;">Vérifiez les lignes: 908, 890. net_context.c 908</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V1020 La fonction s'est terminée sans appeler la fonction 'k_mutex_unlock'. </font><font style="vertical-align: inherit;">Vérifiez les lignes: 1194, 1189. shell.c 1194</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'espère que vous avez aimé. Visitez notre </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blog</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pour en savoir plus sur les vérifications d'autres projets et d'autres publications intéressantes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Utilisez des analyseurs statiques dans votre travail pour réduire le nombre d'erreurs et de vulnérabilités potentielles même au stade de l'écriture de code. La détection précoce des erreurs est particulièrement pertinente pour les systèmes embarqués, la mise à jour de programmes dans lesquels est souvent un processus long et coûteux. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je suggère également de ne pas reporter et d'essayer de vérifier vos projets à l'aide de l'analyseur PVS-Studio. Voir l'article: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comment voir rapidement les avertissements intéressants générés par l'analyseur PVS-Studio pour le code C et C ++?</font></font></a><br>
<br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a></p><div style="text-align:center;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/eb2/f9c/3bb/eb2f9c3bb5f32f39239298d36431961c.png"></a></div><p></p><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si vous souhaitez partager cet article avec un public anglophone, veuillez utiliser le lien vers la traduction: Andrey Karpov. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vérification du code du système d'exploitation Zephyr</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr495274/index.html">Comment réparer les fuites de route</a></li>
<li><a href="../fr495276/index.html">Et démontrer, ou comment nous avons réussi l'audit de durabilité opérationnelle à l'Uptime Institute</a></li>
<li><a href="../fr495278/index.html">Bases de données, cartes, listes de contrôle ou Pourquoi un gestionnaire de connaissances commerciales</a></li>
<li><a href="../fr495280/index.html">Max Patrol SIEM. Présentation du système de gestion des événements de sécurité de l'information</a></li>
<li><a href="../fr495282/index.html">Validation XML à l'aide de XSD, JAXB et Spring Framework</a></li>
<li><a href="../fr495292/index.html">InterSystems IRIS 2020.1 Release</a></li>
<li><a href="../fr495294/index.html">Macros pour un pythoniste. Rapport Yandex</a></li>
<li><a href="../fr495296/index.html">Médecine légale, injection SQL et chat endurci: analyse de la tâche n ° 3 de l'étape en ligne NeoQUEST-2020</a></li>
<li><a href="../fr495298/index.html">Évaluer les options de Monte Carlo Clojure</a></li>
<li><a href="../fr495302/index.html">Comment augmenter les ventes 2,5 fois en 4 mois dans une boutique en ligne - un cas pour la promotion SEO</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>