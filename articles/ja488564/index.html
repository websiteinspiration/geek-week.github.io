<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✍🏾 👩🏽‍🎤 💪🏼 グラフィックスプロセッシングユニット（GPU）での最初のニューラルネットワーク。初心者向けガイド 🤲🏿 🍙 🚋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="この記事では、30分で機械学習環境をセットアップし、画像認識用のニューラルネットワークを作成し、同じネットワークをグラフィックスプロセッシングユニット（GPU）で実行する方法を説明します。
 
 まず、ニューラルネットワークとは何かを定義します。
 
 私たちの場合、これは、生物学的ニューラルネット...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>グラフィックスプロセッシングユニット（GPU）での最初のニューラルネットワーク。初心者向けガイド</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488564/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/wg/sv/g2/wgsvg24lytktztdczee_4rteb28.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事では、30分で機械学習環境をセットアップし、画像認識用のニューラルネットワークを作成し、同じネットワークをグラフィックスプロセッシングユニット（GPU）で実行する方法を説明します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ニューラルネットワークとは何かを定義します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの場合、これは、生物学的ニューラルネットワーク（生物の神経細胞のネットワーク）の編成と機能の原理に基づいて構築された、数学モデルとそのソフトウェアまたはハードウェアの実装です。この概念は、脳で発生するプロセスの研究、およびこれらのプロセスをシミュレートする試みで生まれました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ニューラルネットワークは通常の意味でプログラムされておらず、訓練されています。</font><font style="vertical-align: inherit;">学習能力は、従来のアルゴリズムを超えるニューラルネットワークの主な利点の1つです。</font><font style="vertical-align: inherit;">技術的には、トレーニングはニューロン間の接続の係数を見つけることです。</font><font style="vertical-align: inherit;">学習プロセスでは、ニューラルネットワークは一般化を実行するだけでなく、入力と出力の間の複雑な関係を識別できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
機械学習の観点から見ると、ニューラルネットワークは、パターン認識手法、判別分析、クラスタリング手法、その他の手法の特別なケースです。</font></font><br>
 <br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">装置</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まずは機材を扱いましょう。 Linuxオペレーティングシステムがインストールされたサーバーが必要です。機械学習システムを操作するための機器には、十分に強力で、結果として高価なものが必要です。良い車が手元にない人には、クラウドプロバイダーの提供に注意を払うことをお勧めします。必要なサーバーは迅速にレンタルでき、使用時間に対してのみ支払うことができます。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ニューラルネットワークを作成する必要があるプロジェクトでは、ロシアのクラウドプロバイダーのサーバーを使用します。</font><font style="vertical-align: inherit;">同社は、NVIDIAの強力なTesla V100グラフィックスプロセッシングユニット（GPU）による機械学習専用のレンタルクラウドサーバーを提供しています。</font><font style="vertical-align: inherit;">つまり、GPUを備えたサーバーを使用すると、CPUが計算に使用される同様のコストのサーバー（よく知られている中央処理装置）に比べて、数十倍も効率的（高速）になります。</font><font style="vertical-align: inherit;">これは、計算をより高速に処理するGPUアーキテクチャの詳細により実現されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下で説明する例を実行するために、次のサーバーを数日間購入しました。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 GB SSD</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM 32 GB</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tesla V100 16 Gbプロセッサー（4コア）</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ubuntu 18.04がマシンにインストールされました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">環境を設定する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、作業に必要なすべてのものをサーバーにインストールします。</font><font style="vertical-align: inherit;">私たちの記事は主に初心者向けなので、それらに役立ついくつかのポイントについてお話します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
環境を設定するときの多くの作業は、コマンドラインを介して行われます。</font><font style="vertical-align: inherit;">ほとんどのユーザーはWindowsを動作するOSとして使用しています。</font><font style="vertical-align: inherit;">このOSの標準コンソールでは、多くのことが望まれます。</font><font style="vertical-align: inherit;">したがって、便利な</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cmder /</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツールを使用します</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ミニバージョンをダウンロードして、Cmder.exeを実行します。</font><font style="vertical-align: inherit;">次に、SSH経由でサーバーに接続する必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">ssh root@server-ip-or-hostname</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
server-ip-or-hostnameの代わりに、サーバーのIPアドレスまたはDNS名を指定します。</font><font style="vertical-align: inherit;">次に、パスワードを入力します。接続が成功すると、次のようになります。</font></font><br>
<br>
<pre><code class="bash hljs">Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-74-generic x86_64)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
MLモデルを開発するための主な言語はPythonです。</font><font style="vertical-align: inherit;">Linuxで使用するための最も人気のあるプラットフォームは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anaconda</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーにインストールします。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、ローカルパッケージマネージャーを更新します。</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get update</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
curl（コマンドラインユーティリティ）をインストールします。</font></font><br>
<br>
<pre><code class="bash hljs">sudo apt-get install curl</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anacondaディストリビューションの最新バージョンをダウンロードします。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-built_in">cd</span> /tmp<font></font>
curl –O https://repo.anaconda.com/archive/Anaconda3-2019.10-Linux-x86_64.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インストールを開始します。</font></font><br>
<br>
<pre><code class="bash hljs">bash Anaconda3-2019.10-Linux-x86_64.sh</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インストールプロセス中に、ライセンス契約を確認する必要があります。</font><font style="vertical-align: inherit;">インストールが成功すると、次のようになります。</font></font><br>
<br>
<pre><code class="bash hljs">Thank you <span class="hljs-keyword">for</span> installing Anaconda3!</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
：MLモデルを開発するには、多くのフレームワークが作成されるようになりました、私たちは、最も人気のあると連携</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PyTorch</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tensorflow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
フレームワークを使用すると、開発の速度を上げ、標準のタスクに既製のツールを使用できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この例では、PyTorchを使用します。</font><font style="vertical-align: inherit;">インストールしてください：</font></font><br>
<br>
<pre><code class="bash hljs">conda install pytorch torchvision cudatoolkit=10.1 -c pytorch</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、MLスペシャリストの間で人気のある開発ツールであるJupyter Notebookを起動する必要があります。</font><font style="vertical-align: inherit;">コードを記述して、その実行結果をすぐに確認できます。</font><font style="vertical-align: inherit;">Jupyter NotebookはAnacondaの一部であり、サーバーにすでにインストールされています。</font><font style="vertical-align: inherit;">デスクトップシステムから接続する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、まずポート8080を指定してサーバーでJupyterを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">jupyter notebook --no-browser --port=8080 --allow-root</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、Cmderコンソールで別のタブを開き（上部のメニューは[新しいコンソール]ダイアログです）、ポート8080でSSHを介してサーバーに接続します。</font></font><br>
<br>
<pre><code class="plaintext hljs">ssh -L 8080:localhost:8080 root@server-ip-or-hostname</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初のコマンドを入力すると、ブラウザでJupyterを開くためのリンクが表示されます。</font></font><br>
<br>
<pre><code class="bash hljs">To access the notebook, open this file <span class="hljs-keyword">in</span> a browser:<font></font>
        file:///root/.<span class="hljs-built_in">local</span>/share/jupyter/runtime/nbserver-18788-open.html<font></font>
    Or copy and paste one of these URLs:<font></font>
        http://localhost:8080/?token=cca0bd0b30857821194b9018a5394a4ed2322236f116d311<font></font>
     or http://127.0.0.1:8080/?token=cca0bd0b30857821194b9018a5394a4ed2322236f116d311<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
localhost：8080のリンクを使用します。</font><font style="vertical-align: inherit;">フルパスをコピーして、PCのローカルブラウザのアドレスバーに貼り付けます。</font><font style="vertical-align: inherit;">Jupyter Notebookが開きます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいラップトップを作成してみましょう：New-Notebook-Python 3. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インストールしたすべてのコンポーネントの正しい動作を確認します。</font><font style="vertical-align: inherit;">JupyterにPyTorchコード例を導入し、実行を開始します（[実行]ボタン）：</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> print_function
<span class="hljs-keyword">import</span> torch<font></font>
x = torch.rand(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)<font></font>
print(x)<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果は次のようになり</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ps/o8/su/pso8sugii4txi_beqrbx13nsry8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。同様の結果が得られたら、全員が正しくセットアップされ、ニューラルネットワークの開発を開始できます。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニューラルネットワークを作成する</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
画像認識のためのニューラルネットワークを作成します。</font><font style="vertical-align: inherit;">この</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ガイドを</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ベース</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">として使用し</font></a><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークをトレーニングするために、公に利用可能なCIFAR10データセットを使用します。</font><font style="vertical-align: inherit;">彼はクラスを持っています：「飛行機」、「車」、「鳥」、「猫」、「鹿」、「犬」、「カエル」、「馬」、「船」、「トラック」。</font><font style="vertical-align: inherit;">CIFAR10の画像のサイズは3x32x32、つまり32x32ピクセルの3チャネルカラー画像です。</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/wg/sv/g2/wgsvg24lytktztdczee_4rteb28.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仕事では、作成したPyTorchパッケージを画像の操作に使用します-torchvision。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の手順を順番に実行します。</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレーニングおよびテストデータセットをダウンロードして正規化する</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニューラルネットワークの定義</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレーニングデータに関するネットワークトレーニング</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストデータを使用したネットワークのテスト</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPUトレーニングとテストを繰り返す</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下のすべてのコードは、Jupyter Notebookで実行します。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CIFAR10をダウンロードして正規化する</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jupyterで次のコードをコピーして実行します。</font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torchvision
<span class="hljs-keyword">import</span> torchvision.transforms <span class="hljs-keyword">as</span> transforms<font></font>
<font></font>
transform = transforms.Compose(<font></font>
    [transforms.ToTensor(),<font></font>
     transforms.Normalize((<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>), (<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>))])<font></font>
<font></font>
trainset = torchvision.datasets.CIFAR10(root=<span class="hljs-string">'./data'</span>, train=<span class="hljs-literal">True</span>,<font></font>
                                        download=<span class="hljs-literal">True</span>, transform=transform)<font></font>
trainloader = torch.utils.data.DataLoader(trainset, batch_size=<span class="hljs-number">4</span>,<font></font>
                                          shuffle=<span class="hljs-literal">True</span>, num_workers=<span class="hljs-number">2</span>)<font></font>
<font></font>
testset = torchvision.datasets.CIFAR10(root=<span class="hljs-string">'./data'</span>, train=<span class="hljs-literal">False</span>,<font></font>
                                       download=<span class="hljs-literal">True</span>, transform=transform)<font></font>
testloader = torch.utils.data.DataLoader(testset, batch_size=<span class="hljs-number">4</span>,<font></font>
                                         shuffle=<span class="hljs-literal">False</span>, num_workers=<span class="hljs-number">2</span>)<font></font>
<font></font>
classes = (<span class="hljs-string">'plane'</span>, <span class="hljs-string">'car'</span>, <span class="hljs-string">'bird'</span>, <span class="hljs-string">'cat'</span>,
           <span class="hljs-string">'deer'</span>, <span class="hljs-string">'dog'</span>, <span class="hljs-string">'frog'</span>, <span class="hljs-string">'horse'</span>, <span class="hljs-string">'ship'</span>, <span class="hljs-string">'truck'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
答えは次のようになります。</font></font><br>
<br>
<pre><code class="python hljs">Downloading https://www.cs.toronto.edu/~kriz/cifar<span class="hljs-number">-10</span>-python.tar.gz to ./data/cifar<span class="hljs-number">-10</span>-python.tar.gz<font></font>
Extracting ./data/cifar<span class="hljs-number">-10</span>-python.tar.gz to ./data<font></font>
Files already downloaded <span class="hljs-keyword">and</span> verified</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
チェック用のいくつかのトレーニング画像を導出します。</font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<font></font>
<font></font>
<span class="hljs-comment"># functions to show an image</span><font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">imshow</span>(<span class="hljs-params">img</span>):</span>
    img = img / <span class="hljs-number">2</span> + <span class="hljs-number">0.5</span>     <span class="hljs-comment"># unnormalize</span><font></font>
    npimg = img.numpy()<font></font>
    plt.imshow(np.transpose(npimg, (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>)))<font></font>
    plt.show()<font></font>
<font></font>
<span class="hljs-comment"># get some random training images</span><font></font>
dataiter = iter(trainloader)<font></font>
images, labels = dataiter.next()<font></font>
<font></font>
<span class="hljs-comment"># show images</span><font></font>
imshow(torchvision.utils.make_grid(images))<font></font>
<span class="hljs-comment"># print labels</span>
print(<span class="hljs-string">' '</span>.join(<span class="hljs-string">'%5s'</span> % classes[labels[j]] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)))
</code></pre><br>
<img src="https://habrastorage.org/webt/yy/w4/xw/yyw4xwjhaa6kfy41fvnylvz6qdy.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニューラルネットワークの定義</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、画像認識用のニューラルネットワークがどのように機能するかを見てみましょう。</font><font style="vertical-align: inherit;">これは単純な直接接続ネットワークです。</font><font style="vertical-align: inherit;">入力を受け取り、それをいくつかの層に1つずつ渡し、最後に出力を提供します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/t8/4m/yg/t84mygi1sjuzssoezguistupmeo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちの環境で同様のネットワークを作成しましょう：</font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Net</span>(<span class="hljs-params">nn.Module</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><font></font>
        super(Net, self).__init__()<font></font>
        self.conv1 = nn.Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>)<font></font>
        self.pool = nn.MaxPool2d(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)<font></font>
        self.conv2 = nn.Conv2d(<span class="hljs-number">6</span>, <span class="hljs-number">16</span>, <span class="hljs-number">5</span>)<font></font>
        self.fc1 = nn.Linear(<span class="hljs-number">16</span> * <span class="hljs-number">5</span> * <span class="hljs-number">5</span>, <span class="hljs-number">120</span>)<font></font>
        self.fc2 = nn.Linear(<span class="hljs-number">120</span>, <span class="hljs-number">84</span>)<font></font>
        self.fc3 = nn.Linear(<span class="hljs-number">84</span>, <span class="hljs-number">10</span>)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span>(<span class="hljs-params">self, x</span>):</span><font></font>
        x = self.pool(F.relu(self.conv1(x)))<font></font>
        x = self.pool(F.relu(self.conv2(x)))<font></font>
        x = x.view(<span class="hljs-number">-1</span>, <span class="hljs-number">16</span> * <span class="hljs-number">5</span> * <span class="hljs-number">5</span>)<font></font>
        x = F.relu(self.fc1(x))<font></font>
        x = F.relu(self.fc2(x))<font></font>
        x = self.fc3(x)<font></font>
        <span class="hljs-keyword">return</span> x<font></font>
<font></font>
net = Net()<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
損失関数とオプティマイザも定義します </font></font><br>
<br>
<pre><code class="python hljs">
<span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<font></font>
<font></font>
criterion = nn.CrossEntropyLoss()<font></font>
optimizer = optim.SGD(net.parameters(), lr=<span class="hljs-number">0.001</span>, momentum=<span class="hljs-number">0.9</span>)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレーニングデータに関するネットワークトレーニング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ニューラルネットワークのトレーニングを開始します。</font><font style="vertical-align: inherit;">この後、このコードを実行すると、作業が完了するまでしばらく待つ必要があることに注意してください。</font><font style="vertical-align: inherit;">5分かかりました。</font><font style="vertical-align: inherit;">ネットワーキングには時間がかかります。</font></font><br>
<br>
<pre><code class="python hljs"> <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>):  <span class="hljs-comment"># loop over the dataset multiple times</span><font></font>
<font></font>
    running_loss = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">for</span> i, data <span class="hljs-keyword">in</span> enumerate(trainloader, <span class="hljs-number">0</span>):
        <span class="hljs-comment"># get the inputs; data is a list of [inputs, labels]</span><font></font>
        inputs, labels = data<font></font>
<font></font>
        <span class="hljs-comment"># zero the parameter gradients</span><font></font>
        optimizer.zero_grad()<font></font>
<font></font>
        <span class="hljs-comment"># forward + backward + optimize</span><font></font>
        outputs = net(inputs)<font></font>
        loss = criterion(outputs, labels)<font></font>
        loss.backward()<font></font>
        optimizer.step()<font></font>
<font></font>
        <span class="hljs-comment"># print statistics</span><font></font>
        running_loss += loss.item()<font></font>
        <span class="hljs-keyword">if</span> i % <span class="hljs-number">2000</span> == <span class="hljs-number">1999</span>:    <span class="hljs-comment"># print every 2000 mini-batches</span>
            print(<span class="hljs-string">'[%d, %5d] loss: %.3f'</span> %<font></font>
                  (epoch + <span class="hljs-number">1</span>, i + <span class="hljs-number">1</span>, running_loss / <span class="hljs-number">2000</span>))<font></font>
            running_loss = <span class="hljs-number">0.0</span><font></font>
<font></font>
print(<span class="hljs-string">'Finished Training'</span>)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次の結果が得られ</font></font><br>
<br>
<img src="https://habrastorage.org/webt/sw/05/k2/sw05k2ewk-gu9fiyrv3xncxjaki.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。トレーニング済みモデル</font><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">保存します。</font></font><br>
<br>
<pre><code class="python hljs">PATH = <span class="hljs-string">'./cifar_net.pth'</span>
torch.save(net.state_dict(), PATH)</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">テストデータを使用したネットワークのテスト</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
一連のトレーニングデータを使用してネットワークをトレーニングしました。</font><font style="vertical-align: inherit;">しかし、ネットワークが何かを学習したかどうかを確認する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ニューラルネットワークが出力するクラスラベルを予測し、真実をチェックすることで、これを検証します。</font><font style="vertical-align: inherit;">予測が正しい場合、サンプルを正しい予測のリストに追加します。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストスイートの画像を見てみましょう：</font></font><br>
<br>
<pre><code class="python hljs">dataiter = iter(testloader)<font></font>
images, labels = dataiter.next()<font></font>
<font></font>
<span class="hljs-comment"># print images</span><font></font>
imshow(torchvision.utils.make_grid(images))<font></font>
print(<span class="hljs-string">'GroundTruth: '</span>, <span class="hljs-string">' '</span>.join(<span class="hljs-string">'%5s'</span> % classes[labels[j]] <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)))</code></pre><br>
<img src="https://habrastorage.org/webt/hp/ph/zm/hpphzma6rus04gw-edxsowf1ifu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ニューラルネットワークにこれらの画像の内容を教えてください。</font></font><br>
<br>
<pre><code class="python hljs"><font></font>
net = Net()<font></font>
net.load_state_dict(torch.load(PATH))<font></font>
<font></font>
outputs = net(images)<font></font>
<font></font>
_, predicted = torch.max(outputs, <span class="hljs-number">1</span>)<font></font>
<font></font>
print(<span class="hljs-string">'Predicted: '</span>, <span class="hljs-string">' '</span>.join(<span class="hljs-string">'%5s'</span> % classes[predicted[j]]
                              <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>)))
</code></pre><br>
<img src="https://habrastorage.org/webt/j2/vp/uc/j2vpucdaps0fuci2yg38ip2fbdo.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
結果はかなり良いようです：ネットワークは4つの画像のうち3つを正しく識別しました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
データセット全体でネットワークがどのように機能するかを見てみましょう。</font></font><br>
<br>
<pre><code class="python hljs">
correct = <span class="hljs-number">0</span>
total = <span class="hljs-number">0</span>
<span class="hljs-keyword">with</span> torch.no_grad():
    <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> testloader:<font></font>
        images, labels = data<font></font>
        outputs = net(images)<font></font>
        _, predicted = torch.max(outputs.data, <span class="hljs-number">1</span>)<font></font>
        total += labels.size(<span class="hljs-number">0</span>)<font></font>
        correct += (predicted == labels).sum().item()<font></font>
<font></font>
print(<span class="hljs-string">'Accuracy of the network on the 10000 test images: %d %%'</span> % (
    <span class="hljs-number">100</span> * correct / total))</code></pre><br>
<img src="https://habrastorage.org/webt/fy/i4/cn/fyi4cnkjgimshkhhbsva4udixhw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークは知っていて機能しているようです。</font><font style="vertical-align: inherit;">クラスをランダムに定義した場合、精度は10％になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ネットワークがより適切に定義しているクラスを見てみましょう。</font></font><br>
<br>
<pre><code class="python hljs">class_correct = list(<span class="hljs-number">0.</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>))<font></font>
class_total = list(<span class="hljs-number">0.</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>))
<span class="hljs-keyword">with</span> torch.no_grad():
    <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> testloader:<font></font>
        images, labels = data<font></font>
        outputs = net(images)<font></font>
        _, predicted = torch.max(outputs, <span class="hljs-number">1</span>)<font></font>
        c = (predicted == labels).squeeze()<font></font>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">4</span>):<font></font>
            label = labels[i]<font></font>
            class_correct[label] += c[i].item()<font></font>
            class_total[label] += <span class="hljs-number">1</span><font></font>
<font></font>
<font></font>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<font></font>
    print(<span class="hljs-string">'Accuracy of %5s : %2d %%'</span> % (<font></font>
        classes[i], <span class="hljs-number">100</span> * class_correct[i] / class_total[i]))</code></pre><br>
<img src="https://habrastorage.org/webt/l9/s9/qu/l9s9quxd-lzx2kh7wphxe9-2qzs.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークが車と船を最もよく決定しているようです：71％の精度。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ネットワークは機能しています。</font><font style="vertical-align: inherit;">次に、その作業をグラフィックプロセッサ（GPU）に転送して、何が変わるかを見てみましょう。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPUニューラルネットワークのトレーニング</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、CUDAについて簡単に説明します。</font><font style="vertical-align: inherit;">CUDA（Compute Unified Device Architecture）は、NVIDIAがGPUでの一般的なコンピューティングのために開発した並列コンピューティングプラットフォームです。</font><font style="vertical-align: inherit;">CUDAを使用すると、開発者はGPUの機能を使用してコンピューティングアプリケーションを大幅に高速化できます。</font><font style="vertical-align: inherit;">購入したサーバーには、このプラットフォームがすでにインストールされています。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、GPUを最初に表示されるcudaデバイスとして定義しましょう。</font></font><br>
<br>
<pre><code class="python hljs">device = torch . device ( <span class="hljs-string">"cuda:0"</span> <span class="hljs-keyword">if</span> torch . cuda . is_available () <span class="hljs-keyword">else</span> <span class="hljs-string">"cpu"</span> )
<span class="hljs-comment"># Assuming that we are on a CUDA machine, this should print a CUDA device:</span>
<span class="hljs-keyword">print</span> ( device )</code></pre><br>
<img src="https://habrastorage.org/webt/n2/2k/bf/n22kbfvilr6kn30eel6dfhaose4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ネットワークをGPUに送信します。</font></font><br>
 <br>
<pre><code class="python hljs">net.to(device)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、すべてのステップでGPUに入力と目標を送信する必要があります。</font></font><br>
<br>
<pre><code class="python hljs">inputs, labels = data[<span class="hljs-number">0</span>].to(device), data[<span class="hljs-number">1</span>].to(device)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
GPUですでにネットワークの再トレーニングを実行します。 </font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<font></font>
<font></font>
criterion = nn.CrossEntropyLoss()<font></font>
optimizer = optim.SGD(net.parameters(), lr=<span class="hljs-number">0.001</span>, momentum=<span class="hljs-number">0.9</span>)
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>):  <span class="hljs-comment"># loop over the dataset multiple times</span><font></font>
<font></font>
    running_loss = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">for</span> i, data <span class="hljs-keyword">in</span> enumerate(trainloader, <span class="hljs-number">0</span>):
        <span class="hljs-comment"># get the inputs; data is a list of [inputs, labels]</span>
    inputs, labels = data[<span class="hljs-number">0</span>].to(device), data[<span class="hljs-number">1</span>].to(device)<font></font>
<font></font>
        <span class="hljs-comment"># zero the parameter gradients</span><font></font>
        optimizer.zero_grad()<font></font>
<font></font>
        <span class="hljs-comment"># forward + backward + optimize</span><font></font>
        outputs = net(inputs)<font></font>
        loss = criterion(outputs, labels)<font></font>
        loss.backward()<font></font>
        optimizer.step()<font></font>
<font></font>
        <span class="hljs-comment"># print statistics</span><font></font>
        running_loss += loss.item()<font></font>
        <span class="hljs-keyword">if</span> i % <span class="hljs-number">2000</span> == <span class="hljs-number">1999</span>:    <span class="hljs-comment"># print every 2000 mini-batches</span>
            print(<span class="hljs-string">'[%d, %5d] loss: %.3f'</span> %<font></font>
                  (epoch + <span class="hljs-number">1</span>, i + <span class="hljs-number">1</span>, running_loss / <span class="hljs-number">2000</span>))<font></font>
            running_loss = <span class="hljs-number">0.0</span><font></font>
<font></font>
print(<span class="hljs-string">'Finished Training'</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回は、ネットワークトレーニングに約3分かかりました。</font><font style="vertical-align: inherit;">通常のプロセッサーの同じステージが5分間続いたことを思い出してください。</font><font style="vertical-align: inherit;">私たちのネットワークはそれほど大きくないので、違いは重要ではありません。</font><font style="vertical-align: inherit;">トレーニングに大規模な配列を使用する場合、GPUの速度と従来のプロセッサーの速度の違いが大きくなります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それだけのようです。</font><font style="vertical-align: inherit;">私たちが何とかしてやったこと：</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPUとは何かを調べ、GPUがインストールされているサーバーを選択しました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ニューラルネットワークを作成するためのソフトウェア環境をセットアップします。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">画像認識用のニューラルネットワークを作成してトレーニングしました。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GPUを使用してネットワークのトレーニングを繰り返し、速度が向上しました。</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コメント欄で質問にお答えします。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja488548/index.html">実験：英語で人気のあるテキストを作成する方法を学ぶ方法（および英語を話すHabristsがほとんど読まない理由）</a></li>
<li><a href="../ja488550/index.html">ITの巨人から協同組合を作りたい人</a></li>
<li><a href="../ja488552/index.html">Apple FASおよびペアレンタルコントロールの開発者</a></li>
<li><a href="../ja488558/index.html">Kafka Streamsでアプリケーションの高可用性を確保する</a></li>
<li><a href="../ja488560/index.html">Google Cloud Platformでホスティングする無料のテレグラムボット</a></li>
<li><a href="../ja488566/index.html">QAエンジニアがVisual StudioのAutoTestsとTest ITをリンクして1日を節約した方法</a></li>
<li><a href="../ja488568/index.html">ニューラルネットワークは電子マネーを夢見ていますか？</a></li>
<li><a href="../ja488570/index.html">米国シークレットサービスがサイバーパンクRPGをハッカーの教科書と混同した方法</a></li>
<li><a href="../ja488572/index.html">Unityアナライザーがオープンソースに</a></li>
<li><a href="../ja488574/index.html">学生はSTM32F411のUartドライバーを作成</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>