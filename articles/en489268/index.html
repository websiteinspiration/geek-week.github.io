<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö£üèø üö© üõåüèø Implementation of the process of uploading a file from a container with a browser to a test framework ü¶Ç üèÅ üëÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Automation of End-2-End testing of an integrated information system 
 Part 2-2. Implementing the process of uploading a file from a container with a b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Implementation of the process of uploading a file from a container with a browser to a test framework</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489268/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automation of End-2-End testing of an integrated information system </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Part 2-2. </font><font style="vertical-align: inherit;">Implementing the process of uploading a file from a container with a browser to a test framework. </font><font style="vertical-align: inherit;">Search for the name of the file downloaded by the browser</font></font></h2><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Author: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/en/users/anrad</font></font></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
Hubs: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tags: #autotest, #selenium, #selenoid, #headlessbrowser, #download</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
When we were developing End-2-End autotests for UI, we were faced with the question ‚ÄúHow to get the name of the last loaded file browser from WebDriver? ‚Äù, Google didn‚Äôt get anything quickly. Therefore, I wrote this article, which at the same time told what exactly we had a problem and how we solved it. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
With this article, we continue a series of publications on how we automated the process of manual testing (hereinafter referred to as self-tests) of a large information system (hereinafter referred to as Systems) in one of the large LANIT projects and what came of it. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/9w/wz/lk/9wwzlkncoqwymqxqltqhcxatig0.jpeg" alt="image"><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">source</font></font></i></a><br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The article itself completes the cycle, below is a link to all the previous parts: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Part 1. Organizational and managerial. Why did we need automation. Organization of the development and management process. Organization of use </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Part 2. Technical. Architecture and technical stack. Implementation Details and Technical Surprises </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Part 2-1. Base class implementation for all tests and JUnit RuleChain. </font></font><br>
<br>
<b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That was a year ago. So today it may not be relevant. Write in the comments if you know what an efficient way to process files with multiple selenoid grid servers.</font></font></i></b><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
During the development of ‚Äúautotests‚Äù we had the task of downloading (downloading) files from the system with subsequent analysis of their contents. To ‚Äúupload‚Äù files from the tested system, we use the following solutions:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for the "local" launch mode (launch directly on the working PC) - when the "local" browser is initialized, the name of the temporary local folder is passed to it as a parameter. </font><font style="vertical-align: inherit;">Next, the file is read directly from the local folder for subsequent analysis;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for "remote" mode (via Bamboo) - the file was "taken" from the container with the browser through the Solenoid server feature: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selenoid-host.example.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 4444 / download / {SESSION_ID} / {FILE_NAME}</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Details are described in the documentation. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For both modes, to access the file, you had to know its name. </font><font style="vertical-align: inherit;">This was a surprise. </font><font style="vertical-align: inherit;">The problem of lack of data on the name of the ‚Äúdownload‚Äù file was as follows:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after ‚Äúclicking‚Äù the ‚Äúdownload file‚Äù button, the browser downloaded the file to the appropriate local folder in the container;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in this case, the file name was formed dynamically and, how to determine it in advance, we could not find. </font><font style="vertical-align: inherit;">This was a feature of our test system;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further, this file should be ‚Äúpulled out‚Äù from the container and business verification of its contents should be carried out;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in order to ‚Äúpull out‚Äù the file, you should know its name, but we did not know the name, since the name was generated dynamically and there was no value in the link.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition, the situation was aggravated by the fact that due to the great complexity of some tests, several files could be unloaded during the test as part of different independent test scripts from the composition of the test itself. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The best solution for us was the method in which we determined the last downloaded file. </font><font style="vertical-align: inherit;">There were several ways to do this:</font></font><br>
<ul>
<li>        .        .   ,    ;</li>
<li>    Google Chrome   javascript  chrome://downloads/,      html-.       .<br>
</li>
</ul><br>
<br>
<h3>      <br>
</h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Analyzing the composition of the browser-loaded files for local mode is a trivial task. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For remote mode, you need to use the ‚Äúundocumented‚Äù feature of the server selenoid: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selenoid-host.example.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 4444 / download / {SESSION_ID} displays a list of all successfully downloaded files, where SESSION_ID is a selenoid session ID </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In general, the scheme works fine with one exception: we You need to wait a while until the file is downloaded and appears in the list. The wait can be set through a timeout cycle, however, this way we can not get information about a possible file upload error. We can only determine that the file did not load in this circuit. Therefore, in the end, we settled on the method of determining the file name through the chrome: // downloads / page.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Getting the file name through the chrome: // downloads / page</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This method works equally well in both local and remote mode. </font><font style="vertical-align: inherit;">The scheme of work is quite simple:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">run java script to open the chrome window: // downloads /;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">process data in the window in the usual way. </font><font style="vertical-align: inherit;">Wait until the first file in the list is loaded and determine its name;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">close the chrome: // downloads / window and return the name of the file you are looking for.</font></font></li>
</ul><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We googled the idea of ‚Äã‚Äãusing chrome: // downloads / and, unfortunately, I can‚Äôt provide a link to the source, since it has not been preserved corny. </font><font style="vertical-align: inherit;">The actual implementation of the class for obtaining the file name is given below. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Class to get the name of the downloaded file via chrome: // downloads /</font></font><br>
<pre><code class="java hljs">	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> DOWNLOADS_PAGE_LOAD_TIMEOUT = <span class="hljs-number">5_000</span>;
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> MAX_GET_FILE_NAME_ATTEMPT = <span class="hljs-number">5</span>;<font></font>
 <font></font>
	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getLastDownloadedFilename</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> DownloaderException </span>{<font></font>
        String[] filename = <span class="hljs-keyword">new</span> String[<span class="hljs-number">1</span>];<font></font>
        Exception[] ex = <span class="hljs-keyword">new</span> Exception[<span class="hljs-number">1</span>];<font></font>
        WebDriver driver = WebDriverRunner.getWebDriver();<font></font>
        JavascriptExecutor executor = (JavascriptExecutor) driver;<font></font>
        Utils.driver.openNewTabCheckAndClose(<font></font>
                () -&gt; {<font></font>
                    executor.executeScript(<span class="hljs-string">"window.open('','_blank');"</span>);<font></font>
                },<font></font>
                () -&gt; {<font></font>
                    driver.get(<span class="hljs-string">"chrome://downloads/"</span>);<font></font>
 <font></font>
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_GET_FILE_NAME_ATTEMPT; i++) {<font></font>
                    	ex[<span class="hljs-number">0</span>] = <span class="hljs-keyword">null</span>;<font></font>
                        sleep();<font></font>
                    	<span class="hljs-keyword">try</span> {<font></font>
                        	WebElement element = (WebElement) executor.executeScript(<font></font>
                                    <span class="hljs-string">"return document.querySelector('downloads-manager').shadowRoot.querySelector('downloads-item').shadowRoot.getElementById('file-link')"</span>);<font></font>
                        	filename[<span class="hljs-number">0</span>] = element.getText();<font></font>
                            LOGGER.info(<span class="hljs-string">"Attempt get file name "</span> + i + <span class="hljs-string">". Name = '"</span> + filename[<span class="hljs-number">0</span>] + <span class="hljs-string">"'"</span>);<font></font>
                    	} <span class="hljs-keyword">catch</span> (WebDriverException e) {<font></font>
                        	ex[<span class="hljs-number">0</span>] = e;<font></font>
                            LOGGER.info(<span class="hljs-string">"Failed attempt "</span>+ i + <span class="hljs-string">" to get filename text: "</span> + e.getMessage());
                        	<span class="hljs-keyword">continue</span>;<font></font>
                    	}<font></font>
                    	<span class="hljs-keyword">if</span> (filename[<span class="hljs-number">0</span>] != <span class="hljs-keyword">null</span> &amp;&amp; !filename[<span class="hljs-number">0</span>].isEmpty()) {
                        	 <span class="hljs-comment">//             </span><font></font>
                         	executor.executeScript(<font></font>
                                    <span class="hljs-string">"document.querySelector('downloads-manager').shadowRoot.querySelector('downloads-item').shadowRoot.getElementById('remove').click()"</span>);
                        	<span class="hljs-keyword">break</span>;<font></font>
                    	}<font></font>
                    }<font></font>
                }<font></font>
    	);<font></font>
 <font></font>
    	<span class="hljs-keyword">if</span> (filename[<span class="hljs-number">0</span>] != <span class="hljs-keyword">null</span> &amp;&amp; !filename[<span class="hljs-number">0</span>].isEmpty()) {
            <span class="hljs-keyword">return</span> filename[<span class="hljs-number">0</span>];<font></font>
    	}<font></font>
 <font></font>
    	String message = <span class="hljs-string">"Timeout. Can not get last downloaded file name from chrome://downloads/. File name is '"</span> + filename[<span class="hljs-number">0</span>] + <span class="hljs-string">"'. Exception: "</span> + ex[<span class="hljs-number">0</span>].getMessage();<font></font>
        LOGGER.warning(message);<font></font>
    	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> DownloaderException(message, ex[<span class="hljs-number">0</span>]);<font></font>
	}<font></font>
</code></pre></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en489254/index.html">Does Yandex help spread malware?</a></li>
<li><a href="../en489256/index.html">Foundation Fieldbus Automation Systems</a></li>
<li><a href="../en489258/index.html">How are very long integer types implemented in Python?</a></li>
<li><a href="../en489260/index.html">How to design a large-scale automated system for a large enterprise in seven steps</a></li>
<li><a href="../en489262/index.html">Why it's not easy to give developers freedom of choice</a></li>
<li><a href="../en489270/index.html">WebAuthn in real life</a></li>
<li><a href="../en489272/index.html">Eyes, brain, video quality: reflections on 120fps, 8K, HDR, wands, cones and the ‚Äúsoap opera effect‚Äù</a></li>
<li><a href="../en489274/index.html">Assert messages in tests</a></li>
<li><a href="../en489276/index.html">Blood test for iron - how to control the level, diagnose the reasons why it is important</a></li>
<li><a href="../en489280/index.html">Ping all IPv6 hosts on the channel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>