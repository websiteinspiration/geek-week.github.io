<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦈 👨🏼‍✈️ 🖖🏼 カスタムリファクタリングツール：Swift ➰ ♥️ 🧖🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="どのエンジニアも、作業プロセスを可能な限り最適化するよう努めています。モバイルiOS開発者は、多くの場合、統一された言語構造で作業する必要があります。 Appleは、プログラミングを便利にするために多くの努力を払って開発者ツールを改善しています。言語の強調表示、オートコンプリートメソッド、およびその...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>カスタムリファクタリングツール：Swift</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/460227/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">どのエンジニアも、作業プロセスを可能な限り最適化するよう努めています。モバイルiOS開発者は、多くの場合、統一された言語構造で作業する必要があります。 Appleは、プログラミングを便利にするために多くの努力を払って開発者ツールを改善しています。言語の強調表示、オートコンプリートメソッド、およびその他の多くのIDE機能により、頭の中のアイデアに指を合わせることができます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/4b6/69d/e24/4b669de249e57f8f8d7ad2da21df22a3.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なツールがない場合、エンジニアは何をしますか？確かに、彼は自分ですべてを行います！以前、我々は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">話を</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">今のXcodeを変更し、それはあなたのルールに従って動作させる方法についての話を聞かせて、カスタムツールの作成について。</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JIRA Swift</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
からタスクを取得し、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if let</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を同等の</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ガードlet</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">構成に</font><font style="vertical-align: inherit;">変換するツールを</font><font style="vertical-align: inherit;">作成しました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/d68/6b7/ad5/d686b7ad5d24b87b61df2bb6d87299eb.gif"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
9番目のバージョン以降、Xcodeは、同じSwiftソースファイル内でローカルに、または複数のファイルで発生するメソッドまたはプロパティの名前を変更すると、それらが異なる言語であってもグローバルにコードを変換できる新しいリファクタリングメカニズムを提供します。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカルリファクタリングはSourceKitコンパイラとフレームワークに完全に実装されており、この機能はオープンソースのSwiftリポジトリにあり、C ++で記述されています。</font><font style="vertical-align: inherit;">Xcodeコードベースが閉じているため、グローバルリファクタリングの変更は現在、一般の人々にはアクセスできません。</font><font style="vertical-align: inherit;">したがって、私たちは地元の歴史を詳しく調べ、私たちの経験を繰り返す方法について話します。&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ローカルリファクタリング用の独自のツールを作成するために必要なもの：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++について</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンパイラの基本的な知識</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASTとは何か、およびASTの操作方法を理解する</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">Swift</font></a><font style="vertical-align: inherit;">ソースコード</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ガイド</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">swift / docs / refactoring / SwiftLocalRefactoring.md</font></font></a><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多くの忍耐</font></font><br>
</li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASTについて</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
実践に入る前に、少し理論的な基礎を学びます。 Swiftコンパイラー・アーキテクチャーがどのように機能するかを見てみましょう。コンパイラーは主に、コードを実行可能なマシンコードに変換する役割を果たします。&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/00b/9e7/f23/00b9e7f23d9d1c1b3e02d14905179ef2.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
提示された変換の段階のうち、私たちにとって最も興味深いのは、抽象構文ツリー（AST）の生成です。頂点は演算子であり、葉はそのオペランドです。&nbsp; </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/350/269/29f/35026929fee03914b2689ee5b20fa6f8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構文木はパーサーで使用されます。 ASTは、コードを最適化および生成するためのコンピュータープログラムのコンパイラー/インタープリターの内部表現として使用されます。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ASTが生成された後、解析が実行され、Swift Intermediate Languageに変換された型チェック付きのASTが作成されます。</font><font style="vertical-align: inherit;">SILはLLVM IRに変換、最適化、ダウングレードされ、最終的にはマシンコードにコンパイルされます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リファクタリングツールを作成するには、ASTを理解し、それを使用できる必要があります。</font><font style="vertical-align: inherit;">したがって、ツールは、処理するコードの一部を正しく操作できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ファイルのASTを生成するには、次のコマンドを実行します。swiftc -dump-ast </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MyFile.swift&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は、</font><font style="vertical-align: inherit;">前述の</font><b><font style="vertical-align: inherit;">if let</font></b><font style="vertical-align: inherit;">関数のAST </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コンソールへの出力</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">です。</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/901/276/7b6/9012767b6955ddd58dfc221181e8a70b.png"></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Swift ASTには、主に3つのタイプのノードがあります。&nbsp;</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">宣言（タイプDeclのサブクラス）、&nbsp;</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">式（タイプExprのサブクラス）、&nbsp;</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">演算子（タイプStmtのサブクラス）。&nbsp;</font></font><br>
</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらは、Swift言語自体で使用される3つのエンティティに対応しています。</font><font style="vertical-align: inherit;">関数、構造体、パラメータの名前は宣言です。</font><font style="vertical-align: inherit;">式は、値を返すエンティティです。</font><font style="vertical-align: inherit;">たとえば、関数の呼び出し。</font><font style="vertical-align: inherit;">演算子は、コード実行の制御フローを定義する言語の一部ですが、値を返しません（たとえば、ifまたはdo-catch）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これは、今後の作業でASTについて知っておく必要がある最低限の要件です。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">リファクタリングツールが理論上どのように機能するか</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リファクタリングツールを実装するには、変更するコードの領域に関する特定の情報が必要です。開発者には、データを蓄積する補助エンティティが提供されます。最初のResolvedCursorInfo（カーソルベースのリファクタリング）は、式の先頭にいるかどうかを通知します。もしそうなら、この式の対応するコンパイラオブジェクトが返されます。 2番目のエンティティであるRangeInfo（範囲ベースのリファクタリング）は、元の範囲に関するデータ（たとえば、そこにあるエントリポイントと出口ポイントの数）をカプセル化します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
カーソルベースのリファクタリングは、ソースファイル内のカーソルの場所によってトリガーされます。</font><font style="vertical-align: inherit;">リファクタリングアクションは、リファクタリングメカニズムがIDEで使用可能なアクションを表示し、変換を実行するために使用するメソッドを実装します。</font><font style="vertical-align: inherit;">カーソルに基づくアクションの例：定義へのジャンプ、クイックヘルプなど。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/fce/30f/c9d/fce30fc9de1ab5b473ff9ac14795c462.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
技術的な側面からの通常のアクションを検討してください。&nbsp;</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xcodeエディターから場所を選択すると、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sourcekitd</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（強調表示、コード補完などを行うフレームワーク）に</font><font style="vertical-align: inherit;">リクエストが送信</font><font style="vertical-align: inherit;">され、使用可能なリファクタリングアクションが表示されます。&nbsp;</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用可能な各アクションは、ResolvedCursorInfoオブジェクトによって要求され、このアクションが選択されたコードに適用されるかどうかを確認します。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">適用可能なアクションのリストは、sourcekitdからの応答として返され、Xcodeに表示されます。</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">次に、Xcodeは変更をリファクタリングツールに適用します。</font></font><br>
</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
範囲ベースのリファクタリングは、ソースファイルでコードの連続範囲を選択することによって開始されます。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/670/987/f65/670987f65cedaec71b072c3d2c721315.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、リファクタリングツールは、前述の同様の呼び出しチェーンを通過します。</font><font style="vertical-align: inherit;">違いは、実装すると、入力がResolvedCursorInfoではなくRangeInfoになることです。</font><font style="vertical-align: inherit;">Appleツールキットの例の詳細</font><font style="vertical-align: inherit;">については、興味のある読者は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Refactoring.cpp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">参照してください</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ツールを作成する練習をします。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">トレーニング</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、Swiftコンパイラーをダウンロードしてビルドする必要があります。</font><font style="vertical-align: inherit;">詳細な手順は公式リポジトリ（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readme.md</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）にあります。</font><font style="vertical-align: inherit;">コードのクローン作成の主要なコマンドは次のとおりです。</font></font><br>
<br>
<pre><code class="swift hljs">mkdir swift-source<font></font>
cd swift-source<font></font>
git clone https:<span class="hljs-comment">//github.com/apple/swift.git</span>
./swift/utils/update-checkout --clone</code></pre><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cmakeは</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
、プロジェクトの構造と依存関係を記述するために使用され</font><font style="vertical-align: inherit;">ます。</font><font style="vertical-align: inherit;">これを使用すると、コマンドの1つにより、Xcode（より便利）または忍者（より高速）用のプロジェクトを生成できます。</font></font><br>
<br>
<pre><code class="swift hljs">./utils/build-script --debug --xcode</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または</font></font><br>
<pre><code class="swift hljs">swift/utils/build-script --debug-debuginfo</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイルを成功させるには、最新バージョンのXcodeベータ版（執筆時点では10.2.1）が必要</font><font style="vertical-align: inherit;">です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公式のApple Webサイトから</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">入手できます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">新しいXcodeを使用してプロジェクトをビルドするには、xcode-selectユーティリティを使用してパスを登録する必要があります。</font></font><br>
<br>
<pre><code class="bash hljs">sudo xcode-select -s /Users/username/Xcode.app</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
--xcodeフラグを使用してXcodeのプロジェクトをそれぞれビルドした場合、ビルドフォルダーで数時間のコンパイル（2つより少し多い）の後に、Swift.xcodeprojファイルが見つかります。プロジェクトを開くと、おなじみのXcodeにインデックスとブレークポイントが表示されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しい計測器を作成するには、計測器のロジックを含むコードをファイルlib / IDE / Refactoring.cppに追加し、isApplicableとperformChangeの2つのメソッドを定義する必要があります。最初の方法では、選択したコードのリファクタリングオプションを出力するかどうかを決定します。そして、2番目-選択したコードを変換してリファクタリングを適用する方法。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
準備が完了したら、次の手順を実行します。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツールロジックの開発（開発はいくつかの方法で実行できます-ツールチェーン、忍者、Xcodeを使用。すべてのオプションについては以下で説明します）</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">isApplicableとperformChangeの2つのメソッドを実装します（これらはツールとその操作へのアクセスを担当します）</font></font><br>
</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PRを公式のSwiftリポジトリーに送信する前に、完成したツールを診断およびテストします。</font></font><br>
</li>
</ol><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ツールチェーンを介したツール操作のテスト</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この開発方法は、コンポーネントのアセンブリが長いために多くの時間がかかりますが、結果はXcodeにすぐに表示されます-手動で確認する方法。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
まず、次のコマンドを使用してSwiftツールチェーンを作成します。</font></font><br>
<br>
<pre><code class="plaintext hljs">./utils/build-toolchain some_bundle_id</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ツールチェーンをコンパイルすると、コンパイラと依存関係をコンパイルするよりもさらに時間がかかります。</font><font style="vertical-align: inherit;">出力は、swift-nightly-installフォルダー内のファイルswift-LOCAL-yyyy-mm-dd.xctoolchainであり、Xcodeに転送する必要があります：/ Library / Developer / Toolchains /。</font><font style="vertical-align: inherit;">次に、IDE設定で新しいツールチェーンを選択し、Xcodeを再起動します。&nbsp;</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b67/402/ead/b67402ead1fd1e4470886c8a8ad2f3c2.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ツールが処理するコードを選択し、コンテキストメニューでツールを探します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">忍者を使ったテストによる開発</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
プロジェクトがNinja用にビルドされ、TDDパスを選択した場合、Ninjaを使用したテストによる開発は、ユーザーに適したオプションの1つです。短所-Xcodeによる開発のように、ブレークポイントを設定できません。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
したがって、ユーザーがソースコードでガードコンストラクトを選択すると、新しいツールがXcodeに表示されることを確認する必要があります。既存のtest / refactoring / RefactoringKind / basic.swiftファイルにテストを書き込みます。</font></font><br>
&nbsp;<br>
<pre><code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">testConvertToGuardExpr</span><span class="hljs-params">(idxOpt: Int?)</span></span> {
&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> idx = idxOpt {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-built_in">print</span>(idx)<font></font>
&nbsp;&nbsp;&nbsp;&nbsp;}<font></font>
}<font></font>
<span class="hljs-comment">//     .</span>
<span class="hljs-comment">// RUN: %refactor -source-filename %s -pos=266:3 -end-pos=268:4 | %FileCheck %s -check-prefix=CHECK-CONVERT-TO-GUARD-EXPRESSION</span>
<span class="hljs-comment">// CHECK-CONVERT-TO-GUARD-EXPRESSION: Convert To Guard Expression</span></code></pre><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
266行3列から268行4列までのコードをハイライト表示すると、新しいツールでメニュー項目が表示されることが予想されることを示しています。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">lit.py</font></a></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
スクリプトを使用する</font><font style="vertical-align: inherit;">と、開発サイクルへのフィードバックが速くなります。</font><font style="vertical-align: inherit;">目的のテストスーツを指定できます。</font><font style="vertical-align: inherit;">私たちの場合、このスイートはRefactoringKindになります。</font><font style="vertical-align: inherit;">
その結果、このファイルのみのテストが起動されます。</font><font style="vertical-align: inherit;">それらの実装には数十秒かかります。</font><font style="vertical-align: inherit;">lit.pyの詳細については、後で診断とテストのセクションで説明します。</font><font style="vertical-align: inherit;">
テストは失敗しますが、これはTDDパラダイムでは正常です。</font><font style="vertical-align: inherit;">結局のところ、これまでのところ、ツールのロジックを含む1行のコードを記述していません。&nbsp;</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<br>
<code>./llvm/utils/lit/lit.py -sv ./build/Ninja-RelWithDebInfoAssert/swift-macosx-x86_64/test-macosx-x86_64/refactoring/RefactoringKind/</code><br><font style="vertical-align: inherit;"></font><br><font style="vertical-align: inherit;"></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">デバッグとXcodeによる開発</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
そして最後に、プロジェクトがXcodeでビルドされたときの最後の開発方法です。主な利点は、ブレークポイントを設定してデバッグを制御する機能です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Xcodeでプロジェクトをビルドすると、Swift.xcodeprojファイルがbuild / Xcode-DebugAssert / swift-macosx-x86_64 /フォルダーに作成されます。このファイルを初めて開くときは、スキーマを手動で作成してALL_BUILDを生成し</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/f7d/7cb/458/f7d7cb4587c345d03bc77fc62cd615a9.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
、</font><font style="vertical-align: inherit;">自分でswift-refactorすることを選択することをお勧めします。</font><font style="vertical-align: inherit;">次に、ALL_BUILDを使用してプロジェクトを1回収集し、swift-refactorスキーマを使用します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
リファクタリングツールは、別の実行可能ファイル-swift-refactorにコンパイルされます。このファイルのヘルプは、–helpフラグを使用して表示できます。私たちにとって最も興味深いパラメータは次のとおりです。&nbsp;</font></font><br>
<br>
<pre><code class="swift hljs">-source-filename=&lt;string&gt; <span class="hljs-comment">//  </span><font></font>
<font></font>
-pos=&lt;string&gt; <span class="hljs-comment">//  	</span><font></font>
<font></font>
-end-pos=&lt;string&gt; <span class="hljs-comment">//  	</span><font></font>
<font></font>
-kind <span class="hljs-comment">//  </span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
スキーマで引数として指定できます。</font><font style="vertical-align: inherit;">これで、ツールを開始するときに目的の場所で停止するようにブレークポイントを設定できます。</font><font style="vertical-align: inherit;">通常の方法で</font><font style="vertical-align: inherit;">は、Xcodeコンソールで</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">および</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">po</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドを使用して</font><font style="vertical-align: inherit;">、対応する変数の値を表示します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/329/254/23c/32925423cba91d5951178b9be63a70d5.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IsApplicable実装</font></font></h2>&nbsp;<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
isApplicableメソッドは、選択されたコードフラグメントのASTノードに関する情報とともに、入力でResolvedRangeInfoを受け入れます。</font><font style="vertical-align: inherit;">メソッドの出力では、Xcodeコンテキストメニューにツールを表示するかどうかが決定されます。</font><font style="vertical-align: inherit;">完全なResolvedRangeInfoインターフェイスは、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">include / swift / IDE / Utils.hファイルにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。&nbsp;&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
今回のケースで最も役立つResolvedRangeInfoクラスのフィールドについて考えてみましょう。</font></font><br>
<br>
<ul>
<li>RangeKind —       .    (Invalid),   false.    , , SingleStatement  MultiStatement,   ;<br>
</li>
</ul><br>
<ul>
<li>ContainedNodes —  AST ,     .   ,    ,     if let.        ,     IfStmt (,  AST  statement  if).   condition.   ,         .    (CK_PatternBinding) ,   let.&nbsp;<br>
</li>
</ul><br>
<img src="https://habrastorage.org/getpro/habr/post_images/e7f/ba1/e70/e7fba1e70c05ada9602ba90164c67db8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
isApplicableをテストするには、サンプルコードをファイル</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">test / refactoring / RefactoringKind / basic.swiftに追加し</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。&nbsp;</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/0a1/663/046/0a1663046435877088f58d14329123f5.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストでツールの呼び出しをシミュレートするには、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tools / swift-refactor / swift-refactor.cpp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルに行を追加する必要があります</font><font style="vertical-align: inherit;">。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u=">&nbsp;</a><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/a38/3a9/b3d/a383a9b3d80613dda377d5cd7f43411c.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">performChangeを実装します</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このメソッドは、コンテキストメニューでリファクタリングツールが選択されたときに呼び出されます。</font><font style="vertical-align: inherit;">このメソッドは、isApplicableだけでなく、ResolvedRangeInfoにもアクセスできます。</font><font style="vertical-align: inherit;">ResolvedRangeInfoを使用して、コード変換ツールのロジックを記述します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
静的トークン（言語構文によって規制されている）のコードを生成する場合、tok名前空間のエンティティを使用できます。</font><font style="vertical-align: inherit;">たとえば、guardキーワードの場合、tok :: kw_guardを使用します。</font><font style="vertical-align: inherit;">動的トークン（関数の名前など、開発者によって変更された）の場合、AST要素の配列からそれらを選択する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
変換されたコードが挿入される場所を決定するには、RangeInfo.ContentRange構造を使用して、選択された範囲全体を使用します。</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/893/d2b/c31/893d2bc311ceba6313fad5d474f6ea2e.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">診断とテスト</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ツールの作業を完了する前に、その作業の正しさを再度確認する必要があります。テストは再び私たちを助けます。テストは一度に1つずつ、または使用可能なすべてのスコープで実行できます。 Swiftテストスイート全体を実行する最も簡単な方法は、メインテストスイートを実行するutils / build-scriptで--testコマンドを使用することです。 utils / build-scriptを使用すると、すべてのターゲットが再構築され、デバッグサイクルタイムが大幅に増加する可能性があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイラまたはAPIに大きな変更を加える前に、必ずutils / build-script --validation-test検証テストを実行してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
コンパイラのすべての単体テストを実行する別の方法があります-忍者を通じて、ビルド/プリセット/ swift-macosx-x86_64から忍者チェックスウィフト。約15分かかります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、テストを個別に実行する必要がある場合のオプション。</font><font style="vertical-align: inherit;">LLVMからlit.pyスクリプトを直接呼び出すには、ローカルビルドディレクトリを使用するように構成する必要があります。</font><font style="vertical-align: inherit;">例えば：</font></font><br>
<br>
<pre><code class="swift hljs">% $ {<span class="hljs-type">LLVM_SOURCE_ROOT</span>} /utils/lit/lit.py -sv $ {<span class="hljs-type">SWIFT_BUILD_DIR</span>} / test-macosx-x86_64 / <span class="hljs-type">Parse</span> /</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これにより、64ビットmacOSの 'test / Parse /'ディレクトリでテストが実行されます。</font><font style="vertical-align: inherit;">-svオプションは、テスト実行のインジケーターを提供し、失敗したテストのみの結果を表示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lit.pyには、タイミングテストやレイテンシテストなど、他にもいくつかの便利な機能があります。</font><font style="vertical-align: inherit;">これらの機能やその他の機能は、lit.py -hで表示できます。</font><font style="vertical-align: inherit;">最も有用なものは</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ここにあります</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つのテストを実行するには、次のように記述します。</font></font><br>
<br>
<pre><code class="swift hljs"> ./llvm/utils/lit/lit.py -sv ./build/<span class="hljs-type">Ninja</span>-<span class="hljs-type">RelWithDebInfoAssert</span>/swift-macosx-x86_64/test-macosx-x86_64/refactoring/<span class="hljs-type">RefactoringKind</span>/basic.swift </code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最新のコンパイラの変更を取得する必要がある場合は、すべての依存関係を更新してリベースする必要があります。</font><font style="vertical-align: inherit;">アップグレードするには、。/ utils / update-checkoutを実行します。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">調査結果</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
目標を達成することができました。以前はIDEになかったツールを作成して作業を最適化することでした。 Apple製品を改善してiOSコミュニティ全体の生活を楽にする方法に関するアイデアもお持ちの場合は、カウンターブランディングを気軽に取り入れてください。&nbsp; </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2015年、アップルはSwiftソースコードをパブリックドメインにアップロードしました。これにより、コンパイラーの実装の詳細に飛び込むことが可能になりました。さらに、Xcode 9では、ローカルのリファクタリングツールを追加できます。 C ++とコンパイラデバイスの基本的な知識があれば、お気に入りのIDEがもう少し便利になります。&nbsp;</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
説明した経験は私たちにとって有益でした。開発プロセスを簡略化するツールを作成することに加えて、言語に関する真にハードコアな知識を得ました。</font><font style="vertical-align: inherit;">低レベルのプロセスを備えた半開きのPandoraのボックスを使用すると、毎日のタスクを新しい角度から見ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
得られた知識が開発への理解を深めることを願っています！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この素材は</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@victoriaqb</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -iOS開発者Victoria Kashlina </font><font style="vertical-align: inherit;">と共同で作成され</font><font style="vertical-align: inherit;">ました。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">出典</font></font></h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swiftコンパイラデバイス。</font><font style="vertical-align: inherit;">パート2</font></font></a>&nbsp;<br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Swiftコンパイラベースのツールを構築する方法 </font><font style="vertical-align: inherit;">ステップバイステップガイド&nbsp;</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iOSプロジェクトのSwift ASTをダンプする</font></font></a>&nbsp;<br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sourcekitdストレステスターの紹介</font></font></a><br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">迅速なテスト</font></font></a>&nbsp;<br>
</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[SR-5744] if-letをguard-letに、またはその逆に変換するリファクタリングアクション＃24566</font></font></a><br>
</li>
</ol></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja460213/index.html">チケットをできるだけ安く購入する方法、または動的価格設定を監視してヒットする方法</a></li>
<li><a href="../ja460215/index.html">コンピュータ科学者はテスト知識の範囲を拡大します</a></li>
<li><a href="../ja460221/index.html">初心者のITスペシャリストである場合に質問する方法</a></li>
<li><a href="../ja460223/index.html">ウェブや銀行からiOS開発まで：Apiqaプログラマーの個人的な経験</a></li>
<li><a href="../ja460225/index.html">立ち仕事、脊椎の健康、個人の有効性のための机について</a></li>
<li><a href="../ja460231/index.html">OpenGear-帯域外管理を備えたコンソールサーバーを使用してビジネスのダウンタイムを削減</a></li>
<li><a href="../ja460233/index.html">ゲームCities：Skylinesはチューリング完全であることがわかりました。4ビットの加算器を作成します</a></li>
<li><a href="../ja460237/index.html">EBay詐欺師（1つの不正行為の話）</a></li>
<li><a href="../ja460239/index.html">NextGen Firewallを自分で完全に無料で自宅に戻す方法</a></li>
<li><a href="../ja460247/index.html">ELFのレシピ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>