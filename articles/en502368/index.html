<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöï üè´ üë©‚Äçüë©‚Äçüëß‚Äçüëß We pump the treadmill üé∑ üë®üèΩ‚Äçü§ù‚Äçüë®üèº üíµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I decided on a very strange purchase for myself. Yes, I bought a treadmill. 
 
 
 
 And soon the realization came to me that there was not e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>We pump the treadmill</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/502368/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recently, I decided on a very strange purchase for myself. </font><font style="vertical-align: inherit;">Yes, I bought a treadmill. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/iw/er/bm/iwerbme5xz1jbn_rah5ihonnyv4.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And soon the realization came to me that there was not enough detailed statistics like when riding a bike. </font><font style="vertical-align: inherit;">In the case of a bicycle, the application on the phone writes my speed, heart rate, cadence, and lift. </font><font style="vertical-align: inherit;">It is very curious to control all these parameters during training, to be able to look at charts and compare your results from time to time. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So I decided to do something similar with the treadmill: connect it to a smartphone or tablet in order to collect and display statistics.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As usual, my story is in the form of a traditional text article, and through video. </font><font style="vertical-align: inherit;">As you like more.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Video</font></font></h2><br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/ChTILq0P7Ok" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Article</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Design</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Even at the moment when I was collecting the treadmill, I noticed that the remote control and the running belt itself connected only four wires. Apparently, some of them are used to power the console, because the canvas itself is connected to the 220 volt network, and the remaining wires are needed to transmit control signals in the opposite direction - from the console to the canvas, they control the speed and angle of the track. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I connected the oscilloscope parallel to these wires, trying different combinations. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, I found out that everything was about the same as I expected. One of the wires is ground, and another is 12 volt power. The rest transmit digital data.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In one of them, the signal changes when switching speed and angle. </font><font style="vertical-align: inherit;">This is exactly what I need! </font><font style="vertical-align: inherit;">The signal amplitude is about four volts. </font><font style="vertical-align: inherit;">But the protocol doesn‚Äôt look like something standard, and the signal is very noisy, when the track is on, you need to filter it somehow. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/gm/nu/wq/gmnuwqpcnnxeo0ut0uxqs3wpnk0.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The last wire is just pulses with a constant frequency. </font><font style="vertical-align: inherit;">Apparently, for the console to see the connection to the running belt. </font><font style="vertical-align: inherit;">If you disconnect this wire, the remote control immediately gives an error. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Indications from the pulse sensor on these wires are clearly not transmitted, but it is not necessary. </font><font style="vertical-align: inherit;">It is better to connect a separate chest sensor, which I have been using for a long time when riding a bicycle. </font><font style="vertical-align: inherit;">In addition, it turned out that the heart rate sensor on the treadmill itself is lying a lot, underestimating the readings.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Device assembly</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
So, the next task is to assemble a board that connects in parallel to these wires, reads the current readings of the speed and angle, and somehow transfers them wirelessly to a tablet or smartphone. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Once again, I decided to use the Onion Omega2 single-board computer. He must do an excellent job. It is only necessary to lower the supply voltage to 3.3 volts and filter the data from interference. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To reduce the voltage, I now use these ready-made boards with a DC-DC converter. They cost some penny, can withstand up to a couple of amperes, and the output voltage is adjusted with a twist. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ac/lj/xo/acljxovuyfsah8j57fccxnxpboi.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the same time, this board has conclusions to solder directly to another board, it is very convenient. The main thing is not to twist the voltage twist after installation in the circuit.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To filter the noise on the data line, I made a regular RC filter: a 2.2 kilo-ohm resistor and a 22 picofarad capacitor. </font><font style="vertical-align: inherit;">This should filter out the high frequency noise, leaving a low frequency signal. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It turned out quite a small scarf. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/0k/bt/2e/0kbt2easvesiu_xpo5hwwr-wyzq.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I connected it to the treadmill wires to see how well the signal is filtered when it is turned on and, apparently, the waveform has become almost perfect.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/i-/dt/jo/i-dtjo2zc2onozxqv1i2ai7alse.jpeg"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kernel module</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
However, it is not so easy to check the performance of iron. As we saw </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
earlier on the oscilloscope, the signals go very fast, and we do not use a microcontroller, but a single-board Omega2 computer with Linux on board. Under Linux, we will not be able to process signals from user space so quickly. But from the core we can! Therefore, it's time to write a Linux kernel module! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To do this, you need to download the Linux kernel sources, in our case this is an OpenWRT assembly for Omega2, and create a directory with the source code of our module in them.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Writing module code is a lot like programming a microcontroller. We also write in C, also everything is low-level, we also work with interrupts and also turn to the GPIO conclusions. Only here, besides all of the above, we are still interacting with user space through a pseudo-file. Thus, our kernel module becomes a kind of adapter between the hardware and ordinary applications. Actually, this is called the driver. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At first, I did not know how to decode the signals, so I simply deduced their duration. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/v2/qg/ou/v2qgouholyhcstqxsph1nkjyfyy.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It soon became clear that the signals were encoded with high-level duration. It is either 600 microseconds long or 1200 microseconds long. The low level is always 600 microseconds long except for the initial sequence.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A total of 17 such such drops up and down. </font><font style="vertical-align: inherit;">Apparently, this is 16 bits of data plus the initial sequence. </font><font style="vertical-align: inherit;">I made their decoding, taking as a basis that long high differences are a logical zero, and short ones are a logical unit and I got what happened. </font><font style="vertical-align: inherit;">I immediately saw the data I needed! </font></font><br>
<br>
<img src="https://habrastorage.org/webt/d0/if/oh/d0ifohb7jktcyh6poivdersopr8.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
16 bits are, as you know, two bytes. </font><font style="vertical-align: inherit;">The first byte indicates the type of data being transmitted: the angle of inclination or speed, and the second byte the data itself. </font><font style="vertical-align: inherit;">The driver is extremely simple. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The only driver parameter is the port number.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Module parameters */</span>
<span class="hljs-keyword">static</span> u8 receive_pin = <span class="hljs-number">11</span>;<font></font>
module_param(receive_pin, byte, S_IRUGO);<font></font>
MODULE_PARM_DESC(receive_pin,<span class="hljs-string">"Treadmill receiver pin number (default 11)"</span>);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When initializing, configure it for input and set the interrupt, which will be triggered every time the level on it changes.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Allocate and init the timer */</span>
data_recv_timer = kzalloc(<span class="hljs-keyword">sizeof</span>(struct hrtimer), GFP_KERNEL);
<span class="hljs-keyword">if</span> (!data_recv_timer) {<font></font>
    pr_err(<span class="hljs-string">"treadmill: can't allocate memory for timer\n"</span>);<font></font>
    treadmill_free();<font></font>
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<font></font>
}<font></font>
hrtimer_init(data_recv_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);<font></font>
data_recv_timer-&gt;function = recv_timer_callback;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In this interruption, we first look at the current time. Next, we use this value to calculate how much time has passed since the last interrupt triggered and put it into an array. Of course, we remember the current time for calculation the next time. In addition, you must restart the special timer.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* IRQ fired every rising/falling edge of receiver pin */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">irq_handler_t</span> <span class="hljs-title">treadmill_irq_handler</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> irq,
    <span class="hljs-keyword">void</span> *dev_id, struct pt_regs *regs)</span>
</span>{<font></font>
    u64 now = ktime_to_us(ktime_get_boottime());<font></font>
    u8 value = gpio_get_value(receive_pin);<font></font>
    u64 time_passed;<font></font>
    reset_recv_timer();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> ((timings_pos &amp; <span class="hljs-number">1</span>) == value)<font></font>
    {<font></font>
        time_passed = now - last_time;<font></font>
        <span class="hljs-keyword">if</span> (timings_pos &lt; TIMINGS_BUFFER_SIZE)<font></font>
        {<font></font>
            timings[timings_pos] = time_passed;<font></font>
            timings_pos++;<font></font>
        }<font></font>
        last_time = now;<font></font>
    }<font></font>
<font></font>
    <span class="hljs-comment">/* Announce that the IRQ has been handled correctly */</span>
    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">irq_handler_t</span>) IRQ_HANDLED;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The trick is that if the timer still works, it means that there were no level drops on the pin for a long time, and accordingly it is time to process the collected information. </font><font style="vertical-align: inherit;">In the function that the timer calls, it is checked that there were exactly 34 drops, after which we look at how long each interval was. </font><font style="vertical-align: inherit;">If there is 600 microseconds, then 1200 microseconds, then we take 900 abroad. If the interval is less, then we write one in the result, shifting it by one bit. </font><font style="vertical-align: inherit;">After processing each interval, we send the result to open pseudo-files, thus transferring data to user space.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* Timer */</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> hrtimer_restart <span class="hljs-title">recv_timer_callback</span><span class="hljs-params">(struct hrtimer *timer)</span>
</span>{
    <span class="hljs-keyword">int</span> i, p;<font></font>
    u16 data;<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (timings_pos != <span class="hljs-number">34</span>) {<font></font>
        pr_debug(<span class="hljs-string">"treadmill: invalid edges count: %d"</span>, timings_pos);<font></font>
        timings_pos = <span class="hljs-number">0</span>; 
        <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
    }<font></font>
<font></font>
    data = <span class="hljs-number">0</span>;   
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">2</span>; i &lt; timings_pos; i += <span class="hljs-number">2</span>)<font></font>
    {<font></font>
        data &gt;&gt;= <span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span> (timings[i] &lt; <span class="hljs-number">900</span>) <span class="hljs-comment">// 600us = 1, 1200 us = 0</span>
            data |= <span class="hljs-number">0x8000</span>;<font></font>
    }<font></font>
    <font></font>
    <span class="hljs-keyword">for</span> (p = <span class="hljs-number">0</span>; p &lt; <span class="hljs-number">2</span>; p++) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; treadmill_number_opens; i++) {
            <span class="hljs-keyword">if</span> (!(opened_files[i]-&gt;f_mode &amp; FMODE_READ)) <span class="hljs-keyword">continue</span>;<font></font>
            ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_buffer[<font></font>
                ((struct <span class="hljs-keyword">cfile_t</span>*)opened_files[i]-&gt;private_data)-&gt;receiver_write_pos++<font></font>
                % RECEIVER_BUFFER_SIZE] = (data &gt;&gt; (<span class="hljs-number">8</span> * p)) &amp; <span class="hljs-number">0xFF</span>;<font></font>
        }<font></font>
    };<font></font>
    wake_up_interruptible(&amp;wq_data);<font></font>
<font></font>
    timings_pos = <span class="hljs-number">0</span>; <font></font>
   <font></font>
    <span class="hljs-keyword">return</span> HRTIMER_NORESTART;<font></font>
}<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python server and speed detection</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Then it remains to write a Python script that will read them from the pseudo-file and send them over the network as JSON strings. It would seem that everything is fairly straightforward. However, if everything is simple with the angle of inclination, and the value in the second byte exactly corresponds to the angle of inclination as a percentage, then with speed everything turned out to be much more confusing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A value of 9 corresponds to one kilometer per hour, and a value of 160 corresponds to 18 kilometers per hour. That is, the dependence of data on real speed is not at all obvious. I wrote out all the values ‚Äã‚Äãmanually, drove them into Excel, plotted and got a very uneven curve.</font></font><br>
<br>
<img src="https://habrastorage.org/webt/p0/cp/gt/p0cpgtrosoipnmqnjmfluzntiiu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And there are speeds when the readings on the remote are different, but the data and speed of the track itself remain the same! For example, 5.2 km / h and 5.3 km / h are actually the same speeds. Everywhere cheating. I wonder what speed really is there? Measure it somehow, but leave it for later. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Apart from this transfer of parrots to kilometers per hour, the script turned out to be extremely simple. We read the data from the Linux pseudo-file, decode it, accept network connections and transfer the data to the clients connected over the network as a JSON string.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreadmillServer</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, device = <span class="hljs-string">"/dev/treadmill"</span>, port = <span class="hljs-number">11010</span>, interface = <span class="hljs-string">'0.0.0.0'</span></span>):</span><font></font>
        self._device = device<font></font>
        self._port = port<font></font>
        self._interface = interface<font></font>
        self._working = <span class="hljs-literal">False</span><font></font>
        self._clients = []<font></font>
        self._server_sock = <span class="hljs-literal">None</span>
        self.incline = <span class="hljs-number">0</span>
        self.speed = <span class="hljs-number">0</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">start</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">True</span><font></font>
        self._server_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<font></font>
        self._server_sock.bind((self._interface, self._port))<font></font>
        self._server_sock.listen(<span class="hljs-number">10</span>)<font></font>
        print(<span class="hljs-string">"Listening port"</span>, self._port)<font></font>
        Thread(target=self._port_listener, name=<span class="hljs-string">"Treadmill port listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
        Thread(target=self._device_listener, name=<span class="hljs-string">"Treadmill device listener"</span>, daemon=<span class="hljs-literal">True</span>).start()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stop</span>(<span class="hljs-params">self</span>):</span>
        self._working = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> self._server_sock != <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">try</span>:<font></font>
                self._server_sock.close()<font></font>
            <span class="hljs-keyword">except</span>:
                <span class="hljs-keyword">pass</span>
            self._server_sock = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__del__</span>(<span class="hljs-params">self</span>):</span><font></font>
        self.stop()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_port_listener</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">while</span> self._working <span class="hljs-keyword">and</span> self._server_sock:
            <span class="hljs-keyword">try</span>:<font></font>
                conn, addr = self._server_sock.accept()<font></font>
                print(<span class="hljs-string">'Connected: {0}'</span>.format(addr))<font></font>
                TreadmillClientConnection(self, conn, addr)<font></font>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
                print(<span class="hljs-string">"Error:"</span>, e)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I think no authorization and security are needed here. </font><font style="vertical-align: inherit;">The state of the treadmill is not the kind of data that I would like to protect from hackers. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
We put this script into startup and remove the board inside the treadmill. </font><font style="vertical-align: inherit;">Alas, it only fit in a metal pipe connecting the console to the running belt. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/q9/s3/ab/q9s3abxgl3zhcxxepbj4n46onog.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As you know, metal shields the radio signal, so I brought the Wi-Fi antenna out of the pipe, but under a plastic casing that hides the wires. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/k8/j4/op/k8j4op4zjjbwby41ltcahq_hgxa.jpeg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On this directly ‚Äúsmart‚Äù treadmill is ready. </font><font style="vertical-align: inherit;">She already knows how to distribute statistics over the network. </font><font style="vertical-align: inherit;">It remains only to write a client for her!</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Android client</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
What in my opinion should be such a client. </font><font style="vertical-align: inherit;">This is an Android application that I will run on a tablet or smartphone and put it on top of the display of the treadmill itself, respectively, it should display all the information on the exercises on the screen, replacing the display of the treadmill itself. </font><font style="vertical-align: inherit;">The application should be able to work in the background, so that I can watch the video without any problems while jogging. </font><font style="vertical-align: inherit;">Also, it should keep detailed statistics on runs, synchronizing everything with the cloud and drawing graphs of the dependence of the pulse on speed and angle of inclination. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The heart of such an application should be a service that runs in the background, connects to the treadmill in an endless loop, receives data and decodes them. </font><font style="vertical-align: inherit;">There are no particular difficulties in this.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Heart rate sensor</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The most difficult thing was suddenly working with a heart rate sensor. </font><font style="vertical-align: inherit;">Many pitfalls were discovered. </font><font style="vertical-align: inherit;">I have such a chest heart rate monitor here: </font></font><br>
<br>
<img src="https://habrastorage.org/webt/c5/sy/w1/c5syw10i53ey_zkbcjjrdpmxpzm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I have been using it for a long time when I ride a bicycle. </font><font style="vertical-align: inherit;">It is quite standard, it works on BLE a la Bluetooth Low Enegy, it can be paired with both a phone and a Garmin navigator without any problems. </font><font style="vertical-align: inherit;">I could not even think that working with it from my application would be so unobvious. </font><font style="vertical-align: inherit;">Such sensors have standard GUIDs for different readings. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To start receiving a heart rate, you must first configure your heart rate monitor to periodically send readings. </font><font style="vertical-align: inherit;">I could do this only by studying non-working examples and by typing.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, I wrote a class for working with a heart rate sensor, which automatically tries to connect to it and periodically reports the current heart rate.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Samsung Health SDK</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As for statistics and graphs. </font><font style="vertical-align: inherit;">I decided not to reinvent the wheel, but to use what I already use when riding a bike, namely to somehow make friends with the wonderful Samsung Health app. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Now it will probably look like I'm advertising Samsung again. </font><font style="vertical-align: inherit;">But on a bike, this application has really proven itself really well. </font><font style="vertical-align: inherit;">To my surprise, it connects to all sensors without problems, shows both the cadence and wheel speeds, and dictates the statistics in the headphones, it shows the same statistics with graphs, and gives out achievements, and stores everything in the cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The search showed that Samsung Health has its own SDK, which, although not entirely intelligible, is still documented: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img-developer.samsung.com/onlinedocs/health/android/data/index.html</font></font></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Working with it is essentially working with a database that stores a variety of readings from steps taken and heart rate measurements to blood sugar and sleep phases. </font><font style="vertical-align: inherit;">But now we are interested in records of exercises, which include both scalar values ‚Äã‚Äãlike the type of exercise, time, distance, duration, calories burned, and arrays of live data like the history of heart rate, speed and coordinates. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
All these data must be correctly stored and prepared. </font><font style="vertical-align: inherit;">Some need to be calculated.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Height calculation</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For example, lifting height. </font><font style="vertical-align: inherit;">From the treadmill, we know the angle of climb at each point in time, which is measured in percent. </font><font style="vertical-align: inherit;">The percentage of elevation angle is the ratio of the distance traveled to the climb. </font><font style="vertical-align: inherit;">It turns out that the vertical speed is equal to the usual speed times the slope as a percentage and divided by one hundred. </font><font style="vertical-align: inherit;">Knowing the vertical speed, we can calculate the current height at each moment in time. </font><font style="vertical-align: inherit;">As a result, it must be entered into the current coordinates, despite the fact that during the exercise they do not change and are not taken into account. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In response to this data, the Samsung Health app will show how much I supposedly climbed, as well as the vertical speed at each moment of training.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calorie Counting</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But how to count calories? Moreover, calorie counting is a must for Samsung Health. At the same time, calories burned is a very inaccurate indicator, which depends on many different factors. Not sure if it makes sense to count them. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I did not come up with something of my own and just google the calculator (https://42.195km.net/e/treadsim/) and copied the algorithm from my javascript (https://42.195km.net/e/treadsim/treadsim107 .js). At the entrance, he takes the distance traveled, the angle of elevation and ... weight.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I could set my weight manually, but since we are working with Samsung Health, I can take my current weight from there. </font><font style="vertical-align: inherit;">After all, I use smart scales from Xiaomi, which are synchronized with Google Fit on my phone, Google FIt through a separate application is synchronized with Samsung Health, Samsung Health through the cloud is synchronized with itself on the tablet, where my application is already receiving it.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">App appearance</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Visually, the task of the application is to large-scale display of the main indications: speed, angle, heart rate, distance, calories. It‚Äôs better to do this in white on a black background so that the battery consumption when using the AMOLED screen is minimal, because of course we indicate that when displaying our activity, the screen should be turned on constantly. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ss/qz/6b/ssqz6bqch_3xljgjpbrzba3ykzy.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The buttons are automatically hidden when the treadmill is active. You can start and stop training only at zero speed.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And of course, you need to make support for the ‚Äúpicture in picture‚Äù mode. This is done in just a few lines. You just need to indicate in the manifest that activity supports this mode, and in the code go into it when minimizing the application. As a result, you can watch, for example, YouTube and see treadmill readings in a corner of the screen. It turned out very convenient. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/yt/0c/ls/yt0clswyb0ua3o3x5oopusvy5ie.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
But at this stage I was finally overtaken by the pain of the Android developer, because I already get four different screen sizes: the phone and the tablet are in normal mode and they are also in the ‚Äúpicture in picture‚Äù mode. And it so happened that if I select the normal font size for one screen size, then in other cases everything is too small, then too large.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
When developing for Android, there are several categories of screens, and you can make different settings apply automatically for them, but in my case this was not enough. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As a result, I had to calculate and set the font sizes in the code, which I think is very wrong. </font><font style="vertical-align: inherit;">However, it works perfectly as a result.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Result</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
And here is the result. </font><font style="vertical-align: inherit;">We open the application, wait for the connection with the treadmill and the heart rate sensor, start the training and use the treadmill as usual. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
At the end of the workout, we stop the treadmill. </font><font style="vertical-align: inherit;">Upon reaching zero speed, the button ‚Äúfinish training‚Äù will appear. </font><font style="vertical-align: inherit;">Click it, and the statistics are sent to Samsung Health. </font><font style="vertical-align: inherit;">Open it and see all the data. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/xz/-q/e5/xz-qe5ipelysxlqfmfzayv8m6uc.png"><br>
<br>
<img src="https://habrastorage.org/webt/jn/m9/md/jnm9mdprmuyul2_bcdqbd8clzrc.png"><br>
<br>
<img src="https://habrastorage.org/webt/tg/gh/lx/tgghlxokyu_l7sxghej5fzm1u0s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can see the graph of the pulse, speed and rise, compare your progress at different time intervals, all this is stored in the cloud and is accessible from all devices. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
You can synchronize it with Google Fit. </font><font style="vertical-align: inherit;">The beauty. </font><font style="vertical-align: inherit;">I am pleased with the result. </font><font style="vertical-align: inherit;">Now the main thing is not to throw classes. </font><font style="vertical-align: inherit;">You can add to the functionality of the application so that it resembles training if I am lazy for a long time. </font><font style="vertical-align: inherit;">But I am already too lazy to do this function.</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en502354/index.html">IaaS providers are fighting for the European market - discussing the situation and industry events</a></li>
<li><a href="../en502358/index.html">Implementation of MVP based on ApplicationController and IoC in a WinForms application</a></li>
<li><a href="../en502360/index.html">Grizzly Discharges or Super Drill</a></li>
<li><a href="../en502362/index.html">Learning Event Tracing for Windows: Theory and Practice</a></li>
<li><a href="../en502366/index.html">Compare the work of open source Python - libraries for the recognition of named entities</a></li>
<li><a href="../en502370/index.html">Putting the game "Snake" on the breadboard. Part 1: state machines</a></li>
<li><a href="../en502372/index.html">Problems and principles of customization of the boxed version of Bitrix24</a></li>
<li><a href="../en502374/index.html">FT8 Communication Protocol - How It Works</a></li>
<li><a href="../en502380/index.html">Celery + asyncio</a></li>
<li><a href="../en502382/index.html">Interface Bikes Toxic Grandfather. ‚ÄúLies, threats and blackmail.‚Äù (s1 e6)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>