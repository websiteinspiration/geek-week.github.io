<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçü§ù‚Äçüë®üèø ü¶ê üëßüèº Unsere Erfahrung bei der Entwicklung eines CSI-Treibers in Kubernetes f√ºr Yandex.Cloud ‚èØÔ∏è üö† üöÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir freuen uns, Ihnen mitteilen zu k√∂nnen, dass Flant seinen Beitrag zu den Open Source-Tools f√ºr Kubernetes durch die Ver√∂ffentlichung einer Alpha-Ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Unsere Erfahrung bei der Entwicklung eines CSI-Treibers in Kubernetes f√ºr Yandex.Cloud</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/486190/"><img src="https://habrastorage.org/webt/1y/to/tn/1ytotnf73zepbwfalhzoropf9qa.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir freuen uns, Ihnen mitteilen zu k√∂nnen, dass Flant seinen Beitrag zu den Open Source-Tools f√ºr Kubernetes durch die Ver√∂ffentlichung einer </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alpha-Version des CSI-Treibers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Container Storage Interface) f√ºr Yandex.Cloud erg√§nzt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor wir jedoch zu den Implementierungsdetails √ºbergehen, werden wir die Frage beantworten, warum dies √ºberhaupt erforderlich ist, wenn Yandex bereits √ºber den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Managed Service f√ºr Kubernetes-Service verf√ºgt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einf√ºhrung</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Warum ist das?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In unserem Unternehmen entwickelt sich von Beginn des Betriebs von Kubernetes in der Produktion (d. H. Seit mehreren Jahren) unser eigenes Tool (Deckshaus), das wir √ºbrigens auch bald als Open Source-Projekt zur Verf√ºgung stellen wollen. Mit seiner Hilfe konfigurieren und konfigurieren wir alle unsere Cluster einheitlich. Derzeit gibt es mehr als 100 davon auf den unterschiedlichsten Hardwarekonfigurationen und in allen verf√ºgbaren Cloud-Diensten.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cluster, die Deckhouse verwenden, verf√ºgen √ºber alle f√ºr die Arbeit erforderlichen Komponenten: Balancer, √úberwachung mit praktischen Diagrammen, Metriken und Warnungen, Benutzerauthentifizierung durch externe Anbieter f√ºr den Zugriff auf alle Dashboards usw. </font><font style="vertical-align: inherit;">Es macht keinen Sinn, einen solchen "aufgepumpten" Cluster in eine verwaltete L√∂sung zu integrieren, da dies h√§ufig entweder unm√∂glich ist oder dazu f√ºhrt, dass die H√§lfte der Komponenten deaktiviert werden muss. </font></font><br>
<br>
<i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NB</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Dies ist unsere Erfahrung und sehr spezifisch. </font><font style="vertical-align: inherit;">Wir behaupten keinesfalls, dass jeder unabh√§ngig an der Bereitstellung von Kubernetes-Clustern teilnehmen sollte, anstatt vorgefertigte L√∂sungen zu verwenden. </font><font style="vertical-align: inherit;">√úbrigens haben wir keine wirkliche Erfahrung mit dem Betrieb von Kubernetes von Yandex und werden in diesem Artikel keine Bewertung dieses Dienstes abgeben.</font></font></i><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ist das und f√ºr wen?</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben also bereits √ºber den modernen Speicheransatz in Kubernetes gesprochen: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funktioniert </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">CSI</font></a><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wie kam die Community</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> zu diesem Ansatz </font><font style="vertical-align: inherit;">? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Derzeit haben viele gro√üe Cloud-Dienstanbieter Treiber f√ºr die Verwendung ihrer Cloud-Laufwerke als best√§ndiges Volume in Kubernetes entwickelt. Wenn der Lieferant keinen solchen Treiber hat, aber gleichzeitig alle erforderlichen Funktionen √ºber die API bereitgestellt werden, hindert Sie nichts daran, den Treiber selbst zu implementieren. Und so geschah es mit Yandex.Cloud. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Grundlage f√ºr die Entwicklung haben wir den </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CSI-Treiber f√ºr die DigitalOcean-Cloud</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und einige Ideen aus dem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Treiber f√ºr GCP √ºbernommen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , da die Interaktion mit der API dieser Clouds (Google und Yandex) eine Reihe von √Ñhnlichkeiten aufweist. Insbesondere die API und</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GCP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geben ein Objekt zur√ºck </font></font><code>Operation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um den Status langwieriger Vorg√§nge zu verfolgen (z. B. Erstellen einer neuen Festplatte). </font><font style="vertical-align: inherit;">F√ºr die Interaktion mit der </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Yandex.Cloud-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> API wird das </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Yandex.Cloud Go-SDK verwendet</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Ergebnis der geleisteten Arbeit wird </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf GitHub ver√∂ffentlicht</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und kann f√ºr diejenigen n√ºtzlich sein, die aus irgendeinem Grund ihre eigene Installation von Kubernetes auf virtuellen Yandex.Cloud-Maschinen verwenden (jedoch keinen vorgefertigten verwalteten Cluster) und Festplatten √ºber CSI verwenden (bestellen) m√∂chten.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementierung</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hauptmerkmale</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Derzeit unterst√ºtzt der Treiber die folgenden Funktionen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ordnen von Datentr√§gern in allen Zonen des Clusters gem√§√ü der Topologie der Knoten im Cluster.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Entfernen zuvor bestellter Festplatten;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Offline-Gr√∂√üen√§nderung f√ºr Festplatten (Yandex. Cloud </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unterst√ºtzt nicht die</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Zunahme von Festplatten, die auf einer virtuellen Maschine bereitgestellt werden). </font><font style="vertical-align: inherit;">Informationen zum √Ñndern des Treibers, um die Gr√∂√üe so einfach wie m√∂glich zu √§ndern, finden Sie weiter unten.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In Zukunft ist geplant, Unterst√ºtzung f√ºr das Erstellen und Entfernen von Snapshot-Datentr√§gern zu implementieren.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die Hauptschwierigkeit und ihre √úberwindung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Fehlen der M√∂glichkeit, Festplatten in der Yandex.Cloud-API in Echtzeit zu erweitern, ist eine Einschr√§nkung, die den Gr√∂√üen√§nderungsvorgang f√ºr PV (Persistent Volume) erschwert: In diesem Fall muss der Pod der Anwendung, die die Festplatte verwendet, gestoppt werden. Dies kann zu einem einfachen Vorgang f√ºhren Anwendungen. </font><font style="vertical-align: inherit;">Wenn der CSI-Controller </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
gem√§√ü </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">der CSI-Spezifikation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> meldet, dass er nur die Gr√∂√üe von Datentr√§gern "offline" ( </font></font><code>VolumeExpansion.OFFLINE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">√§ndern kann </font><font style="vertical-align: inherit;">, sollte der Vorgang zum Erh√∂hen des Datentr√§gers folgenderma√üen ablaufen:</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn das Plugin nur √ºber </font></font><code>VolumeExpansion.OFFLINE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erweiterungsm√∂glichkeiten verf√ºgt und das Volume derzeit auf einem Knoten ver√∂ffentlicht oder verf√ºgbar ist, </font></font><code>ControllerExpandVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MUSS NUR nach </font><font style="vertical-align: inherit;">einem der folgenden </font><font style="vertical-align: inherit;">Aufrufe aufgerufen werden:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Plugin ist Controller- </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√§hig und </font></font><code>ControllerUnpublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wurde erfolgreich aufgerufen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ODER ABER</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Plugin verf√ºgt NICHT √ºber Controller- </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Funktionen, das Plugin √ºber Knotenfunktionen </font></font><code>STAGE_UNSTAGE_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>NodeUnstageVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wurde erfolgreich abgeschlossen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ODER ABER</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Plugin verf√ºgt </font></font><code>PUBLISH_UNPUBLISH_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weder </font><font style="vertical-align: inherit;">√ºber Controller- </font><font style="vertical-align: inherit;">noch √ºber Knotenfunktionen </font></font><code>STAGE_UNSTAGE_VOLUME</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und </font></font><code>NodeUnpublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wurde erfolgreich abgeschlossen.</font></font></li>
</ul></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Wesentlichen bedeutet dies, dass die Festplatte vor dem Erh√∂hen von der virtuellen Maschine getrennt werden muss. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Leider </font><font style="vertical-align: inherit;">erf√ºllt </font><font style="vertical-align: inherit;">die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementierung</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> der CSI-Spezifikation durch Sidecar diese Anforderungen nicht:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Im Beiwagen-Container </font></font><code>csi-attacher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, der f√ºr das Vorhandensein der erforderlichen L√ºcke zwischen den Halterungen verantwortlich sein sollte, wird diese Funktionalit√§t bei Offline-Gr√∂√üen√§nderung einfach nicht implementiert. </font><font style="vertical-align: inherit;">Eine Diskussion dar√ºber wurde </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> eingeleitet </font><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ist in diesem Zusammenhang ein Beiwagencontainer? </font><font style="vertical-align: inherit;">Das CSI-Plugin selbst interagiert nicht mit der Kubernetes-API, sondern reagiert nur auf gRPC-Aufrufe, die Sidecar-Container an sie senden. </font><font style="vertical-align: inherit;">Letztere werden </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">von</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> der Kubernetes-Community entwickelt.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In unserem Fall (CSI-Plugin) ist der Vorgang zum Erh√∂hen der Festplatte wie folgt:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir erhalten einen gRPC-Anruf </font></font><code>ControllerExpandVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Wir versuchen, die Festplatte in der API zu vergr√∂√üern, erhalten jedoch eine Fehlermeldung √ºber die Unm√∂glichkeit, den Vorgang auszuf√ºhren, da die Festplatte bereitgestellt ist.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir speichern die Festplattenkennung in einer Karte, die die Festplatten enth√§lt, f√ºr die Sie eine Erh√∂hungsoperation ausf√ºhren m√ºssen. </font><font style="vertical-align: inherit;">Der K√ºrze halber werden wir diese Karte als bezeichnen </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L√∂schen Sie den Pod, der die Festplatte verwendet, manuell. </font><font style="vertical-align: inherit;">Kubernetes wird es neu starten. </font><font style="vertical-align: inherit;">Damit der Datentr√§ger </font></font><code>ControllerPublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vor Abschluss des Erh√∂hungsvorgangs beim Mounten </font><font style="vertical-align: inherit;">keine Zeit zum Mounten ( </font><font style="vertical-align: inherit;">) hat, √ºberpr√ºfen wir, ob dieser Datentr√§ger noch vorhanden ist, </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">und geben einen Fehler zur√ºck.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der CSI-Treiber versucht, die Gr√∂√üen√§nderungsoperation erneut auszuf√ºhren. </font><font style="vertical-align: inherit;">Wenn der Vorgang erfolgreich war, l√∂schen Sie die Festplatte von </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">weil </font><font style="vertical-align: inherit;">Die Festplattenkennung fehlt in </font></font><code>volumeResizeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, sie </font></font><code>ControllerPublishVolume</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ist erfolgreich, die Festplatte ist gemountet, der Pod startet.</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alles sieht einfach aus, aber wie immer gibt es Fallstricke. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Extern-Resizer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist an der Festplattenerweiterung beteiligt </font><font style="vertical-align: inherit;">, die im Falle eines Fehlers w√§hrend des Vorgangs </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eine Warteschlange</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mit einer exponentiellen </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">Verl√§ngerung der</font></a><font style="vertical-align: inherit;"> Timeout-Zeit von bis zu 1000 Sekunden verwendet:</font></font><br>
<br>
<pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DefaultControllerRateLimiter</span><span class="hljs-params">()</span> <span class="hljs-title">RateLimiter</span></span> {
  <span class="hljs-keyword">return</span> NewMaxOfRateLimiter(<font></font>
  NewItemExponentialFailureRateLimiter(<span class="hljs-number">5</span>*time.Millisecond, <span class="hljs-number">1000</span>*time.Second),
  <span class="hljs-comment">// 10 qps, 100 bucket size.  This is only for retry speed and its only the overall factor (not per item)</span>
  &amp;BucketRateLimiter{Limiter: rate.NewLimiter(rate.Limit(<span class="hljs-number">10</span>), <span class="hljs-number">100</span>)},<font></font>
  )<font></font>
}</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies kann periodisch dazu f√ºhren, dass der Vorgang des Erh√∂hens der Scheibe um mehr als 15 Minuten gedehnt wird und somit die Unzug√§nglichkeit des entsprechenden Pods. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die einzige M√∂glichkeit, die es uns erm√∂glichte, die potenziellen Ausfallzeiten ganz einfach und schmerzlos zu reduzieren, war die Verwendung unserer Version des externen Resizers mit einem maximalen Zeitlimit von </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 Sekunden</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
 <br>
<pre><code class="go hljs">workqueue.NewItemExponentialFailureRateLimiter(<span class="hljs-number">5</span>*time.Millisecond, <span class="hljs-number">5</span>*time.Second)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir hielten es nicht f√ºr notwendig, dringend eine Diskussion einzuleiten und einen externen Resizer zu patchen, da Offline-Gr√∂√üen√§nderungsdatentr√§ger ein Atavismus sind, der bald von allen Cloud-Anbietern verschwinden wird.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie fange ich an?</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Treiber wird in Kubernetes Version 1.15 und h√∂her unterst√ºtzt. </font><font style="vertical-align: inherit;">Damit der Fahrer arbeiten kann, m√ºssen die folgenden Anforderungen erf√ºllt sein:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Flag wird </font></font><code>--allow-privileged</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">auf den Wert </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√ºr den API-Server und das Kubelet gesetzt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enthalten </font></font><code>--feature-gates=VolumeSnapshotDataSource=true,KubeletPluginsWatcher=true,CSINodeInfo=true,CSIDriverRegistry=true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√ºr API-Server und Kubelet;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Propagation Mount ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mount Propagation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) sollte im Cluster enthalten sein. </font><font style="vertical-align: inherit;">Bei Verwendung von Docker muss der D√§mon so konfiguriert sein, dass gemeinsam genutzte Bereitstellungen zul√§ssig sind.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle notwendigen Schritte f√ºr die Installation selbst sind </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in README beschrieben</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Bei der Installation werden Objekte in Kubernetes aus Manifesten erstellt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit der Fahrer funktioniert, ben√∂tigen Sie Folgendes:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geben Sie die Kennung des Yandex.Cloud-Katalogverzeichnisses ( </font></font><code>folder-id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">im Manifest an </font><font style="vertical-align: inherit;">( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">siehe Dokumentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">F√ºr die Interaktion mit der Yandex.Cloud-API im CSI-Treiber wird ein Dienstkonto verwendet. </font><font style="vertical-align: inherit;">Im geheimen Manifest m√ºssen Sie die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">autorisierten Schl√ºssel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> an das Dienstkonto √ºbergeben. </font><font style="vertical-align: inherit;">In der Dokumentation wird </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beschrieben,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wie Sie ein Dienstkonto erstellen und die Schl√ºssel abrufen.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">probieren Sie es aus</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und wir freuen uns √ºber Feedback und </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neue Probleme,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wenn Sie auf Probleme sto√üen!</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Weitere Unterst√ºtzung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aus diesem Grund m√∂chten wir darauf hinweisen, dass wir diesen CSI-Treiber nicht aus dem gro√üen Wunsch heraus implementiert haben, Spa√ü beim Schreiben von Anwendungen auf Go zu haben, sondern aufgrund des dringenden Bedarfs innerhalb des Unternehmens. </font><font style="vertical-align: inherit;">Es erscheint nicht ratsam, unsere eigene Implementierung zu unterst√ºtzen. Wenn Yandex Interesse zeigt und beschlie√üt, den Treiber weiterhin zu unterst√ºtzen, werden wir das Repository gerne zur Verf√ºgung stellen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dar√ºber hinaus verf√ºgt Yandex im von Kubernetes verwalteten Cluster wahrscheinlich √ºber eine eigene Implementierung des CSI-Treibers, der in Open Source ver√∂ffentlicht werden kann. </font><font style="vertical-align: inherit;">Diese Entwicklungsoption erscheint uns ebenfalls g√ºnstig - die Community kann den bew√§hrten Treiber des Dienstanbieters und nicht eines Drittunternehmens verwenden.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lesen Sie auch in unserem Blog:</font></font><br>
<br>
<ul>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> Kubernetes CCM (Cloud Controller Manager)  .</a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">     Kubernetes:  Flexvolume  CSI</a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> Container Storage Interface ( Kubernetes   )</a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> Kubernetes-   ?  addon-operator</a>¬ª;</li>
<li> ¬´<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">   Kubernetes (   )</a>¬ª.</li>
</ul></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de486190/">https://habr.com/ru/post/de486190/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de486178/index.html">FOSS News Nr. 1 - √úberpr√ºfung der kostenlosen und Open Source-Nachrichten vom 27. Januar bis 2. Februar 2020</a></li>
<li><a href="../de486180/index.html">Tipps und Quellen zum Erstellen von Anwendungen ohne Server</a></li>
<li><a href="../de486184/index.html">So nutzen Sie die Suche effektiv</a></li>
<li><a href="../de486186/index.html">Katastrophale Wolke: Wie es funktioniert</a></li>
<li><a href="../de486188/index.html">Einf√ºhrung in das PostgreSQL-Wal-G-Backup-System</a></li>
<li><a href="../de486192/index.html">Cyber-Betr√ºger hacken Mobilfunkbetreiber, um die Telefonnummern von Abonnenten zu ermitteln</a></li>
<li><a href="../de486194/index.html">Informationen zu Backups in Proxmox VE</a></li>
<li><a href="../de486198/index.html">Reden ist schwer. Essays zur Kommunikation mit Nicht-Programmierern</a></li>
<li><a href="../de486200/index.html">Docker-Tipps: Reinigen Sie Ihre Maschine von Junk</a></li>
<li><a href="../de486202/index.html">Alpine sammelt Docker-Builds unter Python 50-mal langsamer und Bilder 2-mal schwerer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>