<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí† üë©‚Äçüëß‚Äçüë¶ üå§Ô∏è Why Event Sourcing is the antipattern for microservices interaction ‚ÜñÔ∏è üë©üèø‚Äçüé® üè¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello again. In March, OTUS launches the next stream of the Software Architect course . In anticipation of the start of the course, we have prepared a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Why Event Sourcing is the antipattern for microservices interaction</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/492066/"><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hello again. </font><font style="vertical-align: inherit;">In March, OTUS launches the next stream of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Software Architect</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> course </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In anticipation of the start of the course, we have prepared a translation of useful material for you.</font></font></b></i><br>
<br>
<img src="https://habrastorage.org/webt/xd/n_/ep/xdn_epskg1r3afczrheef2bqbuc.png"><br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recently, event-driven architectures (Event-driven architectures) and, in particular, Event Sourcing (the generation of events) have become widespread. This is driven by the desire to create sustainable and scalable modular systems. In this context, the term ‚Äúmicroservices‚Äù is often used. In my opinion, microservices are just one of the ways to implement a ‚Äú </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bounded Context</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äù. It is very important to correctly define the boundaries of the modules, and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strategic Design</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , described by Eric Evans in Domain Driven Design, </font><font style="vertical-align: inherit;">helps in this </font><font style="vertical-align: inherit;">. It helps you identify / detect modules, boundaries (‚Äúrestricted context‚Äù) and describe how these contexts relate to each other (context map, ContextMap).</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Domain events as the basis of a single language</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although this is not explicitly indicated in Eric Evans' book, domain events contribute very well to DDD concepts. </font><font style="vertical-align: inherit;">Practices such as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Storming</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alberto Brandolini shift the focus of events from the technical to the organizational and business level. </font><font style="vertical-align: inherit;">Here we are not talking about user interface events, such as clicking on a button (ButtonClickedEvent), but about domain events that are part of the subject area. </font><font style="vertical-align: inherit;">They are talked about and understood by experts in the subject area. </font><font style="vertical-align: inherit;">These events are the primary concepts and help to form a single language ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ubiquitous language</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), with which all participants (subject matter experts, developers, etc.) will agree.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Domain events used to communicate between contexts</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Domain events can be used to interact between restricted contexts. </font><font style="vertical-align: inherit;">Suppose we have an online store with three contexts: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Order</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (delivery), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Delivery</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (delivery), </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Invoice</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (account). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Consider the event </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ÄúOrder Accepted‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the context of Order. </font><font style="vertical-align: inherit;">The Invoice context, as well as the Delivery context, are interested in tracking this event, as this event triggers some internal processes in these contexts.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Myth of Weak Connectivity</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Using domain events helps develop loosely coupled modules. </font><font style="vertical-align: inherit;">Individual modules may not be available temporarily. </font><font style="vertical-align: inherit;">But for a domain event, it is absolutely not important whether they are available or not, since the event only describes what happened in the past. </font><font style="vertical-align: inherit;">Other modules decide when to process the event. </font><font style="vertical-align: inherit;">You get a flexible system by default. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to time decoupling, domain events give you another advantage: the order context does not need to know that the context of the invoices and delivery listens to its events. </font><font style="vertical-align: inherit;">In fact, he does not even need to know that these contexts exist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It's great, but the difficulty lies in deciding what data to store in the event?</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The simple answer: Event Sourcing!</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Events are useful, so why not use them to the maximum. </font><font style="vertical-align: inherit;">This is the main idea of </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Sourcing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">You store the state of the unit not through updating its data (CRUD), but through the use of an event stream. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Besides the fact that you can play events and get status, there is another feature of Event Sourcing: you get a complete audit log for free. </font><font style="vertical-align: inherit;">Therefore, when such a log is required, be sure to pay attention to Event Sourcing when choosing a storage strategy.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Sourcing is just a storage tier</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
It may seem strange to you that I immediately switched from domain events to storage, since, obviously, these are concepts of different levels. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... and here's my point: Event Sourcing is a local solution used in only one limited context! Event Sourcing events should not be pulled out into the outside world! Other limited contexts do not need to know about how each other's data is stored, and therefore it doesn‚Äôt matter if some context uses Event Sourcing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you use Event Sourcing globally, then you disclose your storage level. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The data storage method becomes your public API. Each time you make changes to the storage tier, you will have to deal with a change in the public API.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I am sure everyone will agree that it is bad when various limited contexts </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">share data in a (relational) database</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> due to the resulting connectivity. </font><font style="vertical-align: inherit;">But how is this different from Event Sourcing? </font><font style="vertical-align: inherit;">Nothing. </font><font style="vertical-align: inherit;">It doesn‚Äôt matter if you use shared events or shared tables in the database. </font><font style="vertical-align: inherit;">In both cases, you share the storage details.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is an exit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I still argue that domain events are ideal for interacting between limited contexts, but these events should not be related to the events that are used for Event Sourcing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The proposed solution is very simple: no matter what approach you use to store data (CRUD or Event Sourcing), you publish domain events in the global event store. </font><font style="vertical-align: inherit;">These events represent the public API of your context. </font><font style="vertical-align: inherit;">When using Event Sourcing, you store Event Sourcing events in your local store, accessible only for this limited context.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">freedom of choice</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having separate domain events in the public API allows you to model them flexibly. </font><font style="vertical-align: inherit;">You are not limited to a model that is predefined by Event Sourcing. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
There are two options for working with ‚Äúreal-world events‚Äù: an Open Protocol Service and a Public Language (Open Host Service, Published Language) or a Customer / Supplier.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Service with an open protocol and a public language (Open Host Service, Published Language)</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Only one domain event is published that contains all the data that other limited contexts may need. </font><font style="vertical-align: inherit;">In DDD terminology, this can be called an Open Host Service and a Published Language. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/ek/xc/_f/ekxc_f7ekduvi96hyjcs6gqttp8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The onset of the real-world event ‚ÄúOrder Accepted‚Äù leads to the publication of one </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OrderAccepted</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> domain event </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The payload of this event contains all the order data that other restricted contexts might need ... so hopefully the Invoice and Delivery contexts will find all the information they need.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Customer / Supplier</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
For each consumer, separate events are published. It is necessary to coordinate the models of each event with only one consumer; it is not necessary to determine a common shared model. DDD calls this relationship Customer / Supplier. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/3r/15/mh/3r15mhzbwl6gdj_gwg6gnd2k9zm.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The occurrence of real-world events ‚ÄúOrder accepted‚Äù leads to the publication of individual events for each of the consumers: </font></font><code>InvoiceOrderAccepted</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>DeliveryOrderAccepted</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Each domain event contains only the data that is necessary for the recipient context. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I do not want to discuss the pros and cons of these approaches now. I just want to draw attention to the fact that you can choose the number of domain events and the data that they store.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
This is an advantage that you should not underestimate, because you can decide how to develop the API of your limited context without being bound to Event Sourcing events.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Exposing storage parts is a well-known anti-pattern. </font><font style="vertical-align: inherit;">Speaking of storage, we primarily think about database tables, but we saw that the events used for Event Sourcing are just another way to store data. </font><font style="vertical-align: inherit;">Therefore, giving them out is also an anti-pattern. </font></font><br>
<br>
<img src="https://habrastorage.org/webt/1d/9l/r7/1d9lr7adsjtwa4lifypuoukvhaw.png"><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Translation: ‚Äúa good developer like a werewolf is afraid of silver bullets.‚Äù </font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Event Sourcing is a powerful approach if used correctly (locally). </font><font style="vertical-align: inherit;">At first glance it seems that for event-oriented architectures this is a silver bullet, but if you look closely, you can see that this approach can lead to a strong connection ... which of course you do not want.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">References</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In addition to my personal experience, I received a lot of inspiration from various articles and conferences. </font><font style="vertical-align: inherit;">I would like to mention the presentation by Eberhard Wolff ‚ÄúEvent-based Architecture and Implementations with Kafka and Atom‚Äù (event architecture and implementation using Kafka and Atom). </font><font style="vertical-align: inherit;">Especially about </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Event Sourcing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">what events are</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which is very relevant in the context of this post. </font><font style="vertical-align: inherit;">The online store example was also inspired by this talk. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
If you want more information, you can refer to these resources:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Article Christian Stettler </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Domain Events vs. </font><font style="vertical-align: inherit;">Event sourcing</font></font></a> </li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hugo Rocha article </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What they don't tell you about event sourcing</font></font></a></li>
<li>   Greg Young <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=">A Decade of DDD, CQRS, Event Sourcing (CQRS/ES is NOT a top level architecture)</a> </li>
</ul><br>
<b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u="> : ¬´ :   ¬ª</a>.</b></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en492054/index.html">Schr√∂dinger Automators</a></li>
<li><a href="../en492056/index.html">4 examples of iota transfers</a></li>
<li><a href="../en492058/index.html">ROS2 vs ROS1. Installing ROS2 on Ubuntu 18.04</a></li>
<li><a href="../en492060/index.html">How to solve? "ECONNREFUSED - connection refused by server"</a></li>
<li><a href="../en492062/index.html">Golang backend server template - part 1 (HTTP server)</a></li>
<li><a href="../en492068/index.html">S7 Group opens a department ‚ÄúInformation Technologies in Aviation‚Äù at MIPT</a></li>
<li><a href="../en492074/index.html">Gotta go fast. Fast IMAP Email Sync</a></li>
<li><a href="../en492076/index.html">An example of hexagonal architecture in Java</a></li>
<li><a href="../en492078/index.html">The most important and useful materials on the coronavirus COVID-19</a></li>
<li><a href="../en492082/index.html">How to simplify the management of home devices and secure them (share ideas about Kauri Safe Smart Home)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>