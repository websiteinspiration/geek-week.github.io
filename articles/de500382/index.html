<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕢 🐇 🥩 Aviasales API-Integration mit Amazon Kinesis und serverlose Einfachheit 🏤 💯 🎽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo Habr! 
 
 Fliegen Sie gerne Flugzeuge? Ich liebe es, aber aus Gründen der Selbstisolation analysierte ich auch gerne die Flugdaten einer bekannt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Aviasales API-Integration mit Amazon Kinesis und serverlose Einfachheit</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/500382/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo Habr! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fliegen Sie gerne Flugzeuge? </font><font style="vertical-align: inherit;">Ich liebe es, aber aus Gründen der Selbstisolation analysierte ich auch gerne die Flugdaten einer bekannten Ressource - Aviasales. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Heute werden wir die Arbeit von Amazon Kinesis analysieren, ein Streaming-System mit Echtzeitanalyse erstellen, die Amazon DynamoDB NoSQL-Datenbank als Haupt-Data Warehouse festlegen und SMS-Benachrichtigungen für interessante Tickets einrichten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Alle Details unter dem Schnitt! </font><font style="vertical-align: inherit;">Gehen!</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/-n/qn/yn/-nqnynmwzv61pmiq2ocatoxseme.jpeg"></div><br>
<a name="habracut"></a><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einführung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zum Beispiel benötigen wir Zugriff auf </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">die Aviasales-API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Der Zugriff darauf ist kostenlos und Sie müssen sich ohne Einschränkungen nur im Abschnitt "Entwickler" registrieren, um Ihr API-Token für den Zugriff auf Daten zu erhalten.</font></font><br>
<br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Hauptzweck dieses Artikels besteht darin, ein allgemeines Verständnis der Verwendung von Streaming-Informationen in AWS zu vermitteln. Wir stellen nicht in Frage, dass die von der verwendeten API zurückgegebenen Daten nicht unbedingt relevant sind und aus dem Cache übertragen werden, der auf der Suche nach Benutzern der Websites Aviasales.ru und Jetradar.com für generiert wird letzte 48 Stunden. </font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die über die auf dem Herstellercomputer installierte API empfangenen Kinesis-Agent-Flugticketdaten werden automatisch analysiert und über Kinesis Data Analytics in den gewünschten Stream übertragen. </font><font style="vertical-align: inherit;">Eine unverarbeitete Version dieses Streams wird direkt in das Repository geschrieben. </font><font style="vertical-align: inherit;">Die Bereitstellung in der DynamoDB-Speicherung von Rohdaten ermöglicht eine eingehendere Analyse von Tickets mithilfe von BI-Tools wie AWS Quick Sight. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir werden zwei Optionen für die Bereitstellung der gesamten Infrastruktur in Betracht ziehen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handbuch - über die AWS Management Console;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infrastruktur aus Terraform-Code - für faule Automatisierungsingenieure;</font></font></li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Architektur des in Entwicklung befindlichen Systems</font></font></h2><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/vt/ss/mx/vtssmx0accvfcphkjvmzwdf4udg.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verwendete Komponenten:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aviasales-API</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Die von dieser API zurückgegebenen Daten werden für alle nachfolgenden Arbeiten verwendet.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EC2 Producer Instance</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - eine reguläre virtuelle Maschine in der Cloud, auf der der Eingabedatenstrom generiert wird:</font></font><br>
<br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kinesis Agent</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist eine lokal installierte Java-Anwendung, mit der Daten auf einfache Weise erfasst und an Kinesis gesendet werden können (Kinesis Data Streams oder Kinesis Firehose). </font><font style="vertical-align: inherit;">Der Agent überwacht ständig eine Reihe von Dateien in den angegebenen Verzeichnissen und sendet neue Daten an Kinesis.</font></font></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Caller-API-Skript</font></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Ein Python-Skript, das API-Anforderungen stellt und die Antwort in einem Ordner ablegt, den Kinesis Agent überwacht.</font></font></li>
</ul></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><b>Kinesis Data Streams</b></a> —            ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><b>Kinesis Analytics</b></a> —  ,        . Amazon Kinesis Data Analytics              ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><b>AWS Lambda</b></a> — ,        .        ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><b>Amazon DynamoDB</b></a> —    «‑»  ,     10      .   DynamoDB    - ,       . DynamoDB   ,        .       ;</li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><b>Amazon SNS</b></a> —        « — » (Pub/Sub),      ,     . SNS           push-, SMS-   .</li>
</ul><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstausbildung</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um den Datenstrom zu emulieren, habe ich mich entschieden, die von der Aviasales-API zurückgegebenen Flugpreisinformationen zu verwenden. </font><font style="vertical-align: inherit;">Die </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dokumentation enthält eine</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ziemlich umfangreiche Liste verschiedener Methoden. Nehmen Sie eine davon - den „Preiskalender für den Monat“, der die Preise für jeden Tag des Monats zurückgibt, gruppiert nach der Anzahl der Überweisungen. </font><font style="vertical-align: inherit;">Wenn Sie den Suchmonat in der Anfrage nicht übermitteln, werden Informationen für den Monat zurückgegeben, der auf den aktuellen Monat folgt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Also, registrieren Sie sich, holen Sie sich Ihren Token. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beispielanforderung unten:</font></font><br>
<br>
<pre><code class="bash hljs">http://api.travelpayouts.com/v2/prices/month-matrix?currency=rub&amp;origin=LED&amp;destination=HKT&amp;show_to_affiliates=<span class="hljs-literal">true</span>&amp;token=TOKEN_API</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die obige Methode zum Empfangen von Daten von der API mit dem Token in der Anforderung funktioniert, aber ich bevorzuge es, das Zugriffstoken über den Header zu übergeben, daher verwenden wir diese Methode im Skript api_caller.py. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antwortbeispiel:</font></font><br>
<br>
<pre><code class="json hljs">{{
   <span class="hljs-attr">"success"</span>:<span class="hljs-literal">true</span>,
   <span class="hljs-attr">"data"</span>:[{
      <span class="hljs-attr">"show_to_affiliates"</span>:<span class="hljs-literal">true</span>,
      <span class="hljs-attr">"trip_class"</span>:<span class="hljs-number">0</span>,
      <span class="hljs-attr">"origin"</span>:<span class="hljs-string">"LED"</span>,
      <span class="hljs-attr">"destination"</span>:<span class="hljs-string">"HKT"</span>,
      <span class="hljs-attr">"depart_date"</span>:<span class="hljs-string">"2015-10-01"</span>,
      <span class="hljs-attr">"return_date"</span>:<span class="hljs-string">""</span>,
      <span class="hljs-attr">"number_of_changes"</span>:<span class="hljs-number">1</span>,
      <span class="hljs-attr">"value"</span>:<span class="hljs-number">29127</span>,
      <span class="hljs-attr">"found_at"</span>:<span class="hljs-string">"2015-09-24T00:06:12+04:00"</span>,
      <span class="hljs-attr">"distance"</span>:<span class="hljs-number">8015</span>,
      <span class="hljs-attr">"actual"</span>:<span class="hljs-literal">true</span><font></font>
   }]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das obige API-Antwortbeispiel zeigt ein Ticket von St. Petersburg nach Phuk ... Oh, wovon man träumen soll ... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Da ich aus Kasan komme und Phuket "nur von uns träumt", werden wir nach Tickets von St. Petersburg nach Kasan suchen.</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es wird davon ausgegangen, dass Sie bereits ein AWS-Konto haben. </font><font style="vertical-align: inherit;">Ich möchte sofort besonders darauf achten, dass Kinesis und das Versenden von Benachrichtigungen per SMS nicht in der jährlichen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kostenlosen Stufe (kostenlose Nutzung) enthalten sind</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Trotzdem ist es mit ein paar Dollar durchaus möglich, das vorgeschlagene System aufzubauen und damit zu spielen. </font><font style="vertical-align: inherit;">Und vergessen Sie natürlich nicht, alle Ressourcen zu löschen, wenn sie unnötig werden.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Glücklicherweise werden DynamoDb- und Lambda-Funktionen für uns Shareware sein, wenn Sie die monatlichen kostenlosen Limits einhalten. </font><font style="vertical-align: inherit;">Zum Beispiel für DynamoDB: 25 GB Speicher, 25 WCU / RCU und 100 Millionen Anforderungen. </font><font style="vertical-align: inherit;">Und eine Million Anrufe bei Lambda-Funktionen pro Monat.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manuelles Bereitstellungssystem</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einrichten von Kinesis-Datenströmen</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Rufen Sie den Kinesis Data Streams-Dienst auf und erstellen Sie zwei neue Streams, jeweils einen Shard.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Was ist eine Scherbe?</font></font></b>
                        <div class="spoiler_text"> —       Amazon Kinesis.         1 /       2 /.     1000  PUT  .         . ,       .          2 /       4 /    2000  PUT  .<br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je mehr Shards sich in Ihrem Stream befinden, desto höher ist der Durchsatz. </font><font style="vertical-align: inherit;">Im Prinzip werden Streams auf diese Weise durch Hinzufügen von Shards skaliert. </font><font style="vertical-align: inherit;">Aber je mehr Scherben Sie haben, desto höher ist der Preis. </font><font style="vertical-align: inherit;">Jeder Shard kostet 1,5 Cent pro Stunde und zusätzlich 1,4 Cent pro Million PUT-Nutzlasteinheiten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie einen neuen Thread mit dem Namen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">airline_tickets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . 1 Shard reicht dafür aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f8/5p/jg/f85pjg59pxlsbjio2_yzpz1wng4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie nun einen weiteren Stream mit dem Namen </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">special_stream</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4l/_t/eo/4l_teoxvvwv5pablkpfnv-tlnac.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Produzenteneinstellung</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Datenproduzent zum Parsen einer Aufgabe reicht es aus, eine reguläre EC2-Instanz zu verwenden. </font><font style="vertical-align: inherit;">Es muss keine leistungsstarke, teure virtuelle Maschine sein, spot t2.micro ist durchaus geeignet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wichtiger Hinweis: Sie sollten beispielsweise image - Amazon Linux AMI 2018.03.0 verwenden. Daher gibt es weniger Einstellungen, um den Kinesis Agent schnell zu starten. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen Sie zum EC2-Dienst, erstellen Sie eine neue virtuelle Maschine und wählen Sie die gewünschte AMI mit dem Typ t2.micro aus, der in Free Tier enthalten ist:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/3q/rg/gt/3qrggtrxqistnkvgzn0bwkfdvbk.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Damit die neu erstellte virtuelle Maschine mit dem Kinesis-Dienst interagieren kann, müssen Sie ihr das Recht dazu geben. </font><font style="vertical-align: inherit;">Der beste Weg, dies zu tun, besteht darin, eine IAM-Rolle zuzuweisen. </font><font style="vertical-align: inherit;">Wählen Sie daher im Bildschirm Schritt 3: Instanzdetails konfigurieren die </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Option Neue IAM-Rolle erstellen aus</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen von IAM-Rollen für EC2</font></font></b>
                        <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/_p/rm/xv/_prmxvgp0iv148grjwdpunwaela.jpeg"></div><br>
  , ,      EC2     Permissions:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/as/nn/zvasnnl8ootjsr6rojjfhmjtfiw.jpeg"></div><br>
             ,     : AmazonKinesisFullAccess  CloudWatchFullAccess.<br>
<br>
 -     , : EC2-KinesisStreams-FullAccess.  ,     ,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/jh/rj/38/jhrj38s8czngu9ri77mu26lh_o0.jpeg"></div><br>
    ,         :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yn/he/23/ynhe23lg4gfpfbjvlphntvfypyw.jpeg"></div><br>
           . <br>
</div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können standardmäßig die Parameter der Festplatte und auch die Tags belassen (obwohl es empfehlenswert ist, Tags zu verwenden, geben Sie mindestens den Namen der Instanz an und geben Sie die Umgebung an). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt befinden wir uns auf der Registerkarte Schritt 6: Konfigurieren der Sicherheitsgruppe, auf der Sie eine neue erstellen oder Ihre vorhandene Sicherheitsgruppe angeben müssen, mit der Sie über ssh (Port 22) eine Verbindung zur Instanz herstellen können. </font><font style="vertical-align: inherit;">Wählen Sie dort Quelle -&gt; Meine IP und Sie können die Instanz ausführen.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y7/cd/z9/y7cdz9fllra7haynrf6gyu0jkdq.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sobald der Betriebsstatus erreicht ist, können Sie versuchen, über ssh eine Verbindung herzustellen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um mit Kinesis Agent arbeiten zu können, müssen Sie nach einer erfolgreichen Verbindung mit dem Computer die folgenden Befehle in das Terminal eingeben:</font></font><br>
<br>
<pre><code class="bash hljs">sudo yum -y update<font></font>
sudo yum install -y python36 python36-pip<font></font>
sudo /usr/bin/pip-3.6 install --upgrade pip<font></font>
sudo yum install -y aws-kinesis-agent<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie einen Ordner zum Speichern von API-Antworten:</font></font><br>
<br>
<pre><code class="bash hljs">sudo mkdir /var/<span class="hljs-built_in">log</span>/airline_tickets</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bevor Sie den Agenten starten, müssen Sie seine Konfiguration konfigurieren:</font></font><br>
<br>
<pre><code class="bash hljs">sudo vim /etc/aws-kinesis/agent.json</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Inhalt der Datei agent.json sollte folgendermaßen aussehen:</font></font><br>
<br>
<pre><code class="json hljs">{
  <span class="hljs-attr">"cloudwatch.emitMetrics"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">"kinesis.endpoint"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-attr">"firehose.endpoint"</span>: <span class="hljs-string">""</span>,<font></font>
<font></font>
  <span class="hljs-attr">"flows"</span>: [<font></font>
    {<font></font>
      <span class="hljs-attr">"filePattern"</span>: <span class="hljs-string">"/var/log/airline_tickets/*log"</span>,
      <span class="hljs-attr">"kinesisStream"</span>: <span class="hljs-string">"airline_tickets"</span>,
      <span class="hljs-attr">"partitionKeyOption"</span>: <span class="hljs-string">"RANDOM"</span>,
      <span class="hljs-attr">"dataProcessingOptions"</span>: [<font></font>
         {<font></font>
            <span class="hljs-attr">"optionName"</span>: <span class="hljs-string">"CSVTOJSON"</span>,
            <span class="hljs-attr">"customFieldNames"</span>: [<span class="hljs-string">"cost"</span>,<span class="hljs-string">"trip_class"</span>,<span class="hljs-string">"show_to_affiliates"</span>,
                <span class="hljs-string">"return_date"</span>,<span class="hljs-string">"origin"</span>,<span class="hljs-string">"number_of_changes"</span>,<span class="hljs-string">"gate"</span>,<span class="hljs-string">"found_at"</span>,
                <span class="hljs-string">"duration"</span>,<span class="hljs-string">"distance"</span>,<span class="hljs-string">"destination"</span>,<span class="hljs-string">"depart_date"</span>,<span class="hljs-string">"actual"</span>,<span class="hljs-string">"record_id"</span>]<font></font>
         }<font></font>
      ]<font></font>
    }<font></font>
  ]<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie der Konfigurationsdatei entnehmen können, überwacht der Agent Dateien mit der Erweiterung .log im Verzeichnis / var / log / airline_tickets /, analysiert sie und überträgt sie in den Stream airline_tickets. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir starten den Dienst neu und stellen sicher, dass er startet und funktioniert:</font></font><br>
<br>
<pre><code class="bash hljs">sudo service aws-kinesis-agent restart</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Laden Sie nun das Python-Skript herunter, das Daten von der API anfordert:</font></font><br>
<br>
<pre><code class="bash hljs">REPO_PATH=https://raw.githubusercontent.com/igorgorbenko/aviasales_kinesis/master/producer<font></font>
<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/api_caller.py -P /home/ec2-user/<font></font>
wget <span class="hljs-variable">$REPO_PATH</span>/requirements.txt -P /home/ec2-user/<font></font>
sudo chmod a+x /home/ec2-user/api_caller.py<font></font>
sudo /usr/<span class="hljs-built_in">local</span>/bin/pip3 install -r /home/ec2-user/requirements.txt
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Skript api_caller.py fordert Daten von Aviasales an und speichert die empfangene Antwort in dem Verzeichnis, das der Kinesis-Agent scannt. </font><font style="vertical-align: inherit;">Die Implementierung dieses Skripts ist ziemlich Standard, es gibt eine Klasse TicketsApi, mit der Sie die API asynchron abrufen können. </font><font style="vertical-align: inherit;">In dieser Klasse übergeben wir den Header mit dem Token und den Anforderungsparametern:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsApi</span>:</span>
    <span class="hljs-string">"""Api caller class."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, headers</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.base_url = BASE_URL<font></font>
        self.headers = headers<font></font>
<font></font>
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">self, data</span>):</span>
        <span class="hljs-string">"""Get the data from API query."""</span><font></font>
        response_json = {}<font></font>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(headers=self.headers) <span class="hljs-keyword">as</span> session:
            <span class="hljs-keyword">try</span>:<font></font>
                response = <span class="hljs-keyword">await</span> session.get(self.base_url, data=data)<font></font>
                response.raise_for_status()<font></font>
                LOGGER.info(<span class="hljs-string">'Response status %s: %s'</span>,<font></font>
                            self.base_url, response.status)<font></font>
                response_json = <span class="hljs-keyword">await</span> response.json()
            <span class="hljs-keyword">except</span> HTTPError <span class="hljs-keyword">as</span> http_err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! HTTP error occurred: %s'</span>, str(http_err))
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
                LOGGER.error(<span class="hljs-string">'Oops! An error ocurred: %s'</span>, str(err))
            <span class="hljs-keyword">return</span> response_json<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepare_request</span>(<span class="hljs-params">api_token</span>):</span>
    <span class="hljs-string">"""Return the headers and query fot the API request."""</span>
    headers = {<span class="hljs-string">'X-Access-Token'</span>: api_token,
               <span class="hljs-string">'Accept-Encoding'</span>: <span class="hljs-string">'gzip'</span>}<font></font>
<font></font>
    data = FormData()<font></font>
    data.add_field(<span class="hljs-string">'currency'</span>, CURRENCY)<font></font>
    data.add_field(<span class="hljs-string">'origin'</span>, ORIGIN)<font></font>
    data.add_field(<span class="hljs-string">'destination'</span>, DESTINATION)<font></font>
    data.add_field(<span class="hljs-string">'show_to_affiliates'</span>, SHOW_TO_AFFILIATES)<font></font>
    data.add_field(<span class="hljs-string">'trip_duration'</span>, TRIP_DURATION)
    <span class="hljs-keyword">return</span> headers, data<font></font>
<font></font>
<font></font>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span>
    <span class="hljs-string">"""Get run the code."""</span>
    <span class="hljs-keyword">if</span> len(sys.argv) != <span class="hljs-number">2</span>:<font></font>
        print(<span class="hljs-string">'Usage: api_caller.py &lt;your_api_token&gt;'</span>)<font></font>
        sys.exit(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span>
    api_token = sys.argv[<span class="hljs-number">1</span>]<font></font>
    headers, data = prepare_request(api_token)<font></font>
<font></font>
    api = TicketsApi(headers)<font></font>
    response = <span class="hljs-keyword">await</span> api.get_data(data)
    <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'success'</span>, <span class="hljs-literal">None</span>):<font></font>
        LOGGER.info(<span class="hljs-string">'API has returned %s items'</span>, len(response[<span class="hljs-string">'data'</span>]))
        <span class="hljs-keyword">try</span>:<font></font>
            count_rows = log_maker(response)<font></font>
            LOGGER.info(<span class="hljs-string">'%s rows have been saved into %s'</span>,<font></font>
                        count_rows,<font></font>
                        TARGET_FILE)<font></font>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<font></font>
            LOGGER.error(<span class="hljs-string">'Oops! Request result was not saved to file. %s'</span>,<font></font>
                         str(e))<font></font>
    <span class="hljs-keyword">else</span>:<font></font>
        LOGGER.error(<span class="hljs-string">'Oops! API request was unsuccessful %s!'</span>, response)
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Um die korrekten Einstellungen und die Funktionsfähigkeit des Agenten zu testen, führen wir einen Testlauf des Skripts api_caller.py durch:</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/u8/17/rr/u817rrbmcgutepqlpx-aa7k2mo4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und wir sehen uns das Ergebnis der Arbeit in den Protokollen des Agenten und auf der Registerkarte Überwachung im Datenstrom von Airline_Tickets an:</font></font><br>
<br>
<pre><code class="bash hljs">tail -f /var/<span class="hljs-built_in">log</span>/aws-kinesis-agent/aws-kinesis-agent.log</code></pre><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/5r/oy/ep5royv-vndczuzfhaufx2duuau.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/g3/pi/ya/g3piyaltiksnogpxwm0temjdpz4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie Sie sehen, funktioniert alles und der Kinesis Agent sendet erfolgreich Daten an den Stream. </font><font style="vertical-align: inherit;">Konfigurieren Sie nun den Verbraucher.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Einrichten von Kinesis Data Analytics</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kommen wir zur zentralen Komponente des gesamten Systems - erstellen Sie in Kinesis Data Analytics eine neue Anwendung mit dem Namen kinesis_analytics_airlines_app:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dp/0s/4a/dp0s4aesniewnc3j7envuvi2lqa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kinesis Data Analytics ermöglicht die Echtzeitanalyse von Daten aus Kinesis Streams mithilfe von SQL. </font><font style="vertical-align: inherit;">Dies ist ein vollständig automatisch skalierbarer Dienst (im Gegensatz zu Kinesis Streams), der:</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ermöglicht das Erstellen neuer Streams (Output Stream) basierend auf Abfragen der Quelldaten.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stellt einen Stream mit Fehlern bereit, die während des Anwendungsbetriebs aufgetreten sind (Error Stream);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es kann das Eingabedatenschema automatisch bestimmen (es kann bei Bedarf manuell neu definiert werden).</font></font></li>
</ol><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dies ist ein teurer Service - 0,11 USD pro Stunde. Sie sollten ihn daher vorsichtig verwenden und entfernen, wenn Sie die Arbeit abgeschlossen haben.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verbinden Sie die Anwendung mit der Datenquelle:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/2x/sc/g6/2xscg6tquygvrr4dxhjofyxjx-m.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wählen Sie den Stream aus, zu dem Sie eine Verbindung herstellen möchten (airline_tickets):</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/y1/c7/ma/y1c7ma8a_9n3wwwokqleszry-qa.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Nächstes müssen Sie die neue IAM-Rolle anhängen, damit die Anwendung aus dem Stream lesen und in den Stream schreiben kann. </font><font style="vertical-align: inherit;">Dazu reicht es aus, nichts im Zugriffsberechtigungsblock zu ändern:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/dg/96/wq/dg96wq1hgmmd0ouhxpxs8r0tjss.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nun fordern wir die Ermittlung des Datenschemas im Stream an, dazu klicken wir auf die Schaltfläche "Schema erkennen". </font><font style="vertical-align: inherit;">Infolgedessen wird die IAM-Rolle aktualisiert (eine neue wird erstellt) und die Ermittlung des Schemas aus den bereits im Stream eingetroffenen Daten wird gestartet:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5e/co/6r/5eco6ro21kgrevovywr-2ulfysw.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt müssen Sie zum SQL-Editor gehen. </font><font style="vertical-align: inherit;">Wenn Sie auf diese Schaltfläche klicken, wird ein Fenster mit einer Frage zum Starten der Anwendung angezeigt. Wählen Sie aus, was ausgeführt werden soll:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kt/oc/ta/ktoctaokxjgsxbosk5eu8-yw_e0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fügen Sie im SQL-Editorfenster eine so einfache Abfrage ein und klicken Sie auf SQL speichern und ausführen:</font></font><br>
<br>
<pre><code class="sql hljs"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> STREAM <span class="hljs-string">"DESTINATION_SQL_STREAM"</span> (<span class="hljs-string">"cost"</span> <span class="hljs-keyword">DOUBLE</span>, <span class="hljs-string">"gate"</span> <span class="hljs-built_in">VARCHAR</span>(<span class="hljs-number">16</span>));<font></font>
<font></font>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> <span class="hljs-keyword">REPLACE</span> PUMP <span class="hljs-string">"STREAM_PUMP"</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-string">"DESTINATION_SQL_STREAM"</span>
<span class="hljs-keyword">SELECT</span> STREAM <span class="hljs-string">"cost"</span>, <span class="hljs-string">"gate"</span>
<span class="hljs-keyword">FROM</span> <span class="hljs-string">"SOURCE_SQL_STREAM_001"</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-string">"cost"</span> &lt; <span class="hljs-number">5000</span>
    <span class="hljs-keyword">and</span> <span class="hljs-string">"gate"</span> = <span class="hljs-string">'Aeroflot'</span>;
</code></pre><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In relationalen Datenbanken arbeiten Sie mit Tabellen, indem Sie INSERT-Anweisungen verwenden, um Datensätze hinzuzufügen, und eine SELECT-Anweisung, um Daten abzufragen. </font><font style="vertical-align: inherit;">In Amazon Kinesis Data Analytics arbeiten Sie mit Streams (STREAM) und „Pumps“ (PUMP) - fortlaufende Einfügeanforderungen, mit denen Daten aus einem Stream in einer Anwendung in einen anderen Stream eingefügt werden.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In der obigen SQL-Abfrage werden Aeroflot-Tickets zu Preisen unter fünftausend Rubel gesucht. </font><font style="vertical-align: inherit;">Alle Datensätze, die unter diese Bedingungen fallen, werden in den Stream DESTINATION_SQL_STREAM gestellt.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/l7/zk/8l/l7zk8ltrlivhjnmj3u1xcvazwai.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wählen Sie im Zielblock den Stream special_stream und in der Dropdown-Liste Name DESTINATION_SQL_STREAM des Streams in der Anwendung Folgendes aus:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/5r/5s/7r/5r5s7rpwfezpiyjokrby1jkmcly.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als Ergebnis aller Manipulationen sollte sich etwas Ähnliches wie im folgenden Bild herausstellen:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/o3/_b/4co3_blpb57-arskyc7jwsc2d_i.jpeg"></div><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen und Abonnieren des SNS-Themas</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gehen Sie zum Simple Notification Service und erstellen Sie ein neues Thema mit dem Namen Airlines:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/su/ur/zr/suurzrkeqmmm7jk3-j5iuqaiar8.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir abonnieren dieses Thema und geben darin die Handynummer an, an die SMS-Benachrichtigungen gesendet werden:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ep/gc/sz/epgcszgapjrsl4-jhx7vktgi7fi.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen einer Tabelle in DynamoDB</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen Sie in DynamoDB eine gleichnamige Tabelle, um die Rohdaten des Streams "Airline_Tickets" zu speichern. </font><font style="vertical-align: inherit;">Als Primärschlüssel verwenden wir record_id:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/t7/td/4e/t7td4eq2asrdur1arxzbmsuthdk.jpeg"></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen einer Lambda-Kollektorfunktion</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Erstellen wir eine Lambda-Funktion namens Collector, deren Aufgabe es ist, den Stream airline_tickets abzufragen und diese Datensätze in die DynamoDB-Tabelle einzufügen, wenn dort neue Datensätze vorhanden sind. </font><font style="vertical-align: inherit;">Zusätzlich zu den Standardrechten muss dieses Lambda Zugriff haben, um den Kinesis-Datenstrom lesen und in DynamoDB schreiben zu können.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen einer IAM-Rolle für eine Lambda-Kollektorfunktion</font></font></b>
                        <div class="spoiler_text">    IAM      Lambda-TicketsProcessingRole:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/s9/sv/_f/s9sv_fh7p4flqdklnzh5rohd9ws.jpeg"></div><br>
       AmazonKinesisReadOnlyAccess  AmazonDynamoDBFullAccess,     :<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/v0/zy/f_v0zyuhd3h9y5e9tiuurfbpqnq.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/78/db/ge/78dbgeqrxjuuh6rzlqd-k1qdgee.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Lambda sollte durch einen Kinesis-Trigger ausgelöst werden, wenn neue Einträge in den Stream airline_stream gelangen. Sie müssen also einen neuen Trigger hinzufügen:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qt/h0/gg/qth0ggplzpl1afpad4shlgl_tbu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/we/2c/ip/we2cipjv713dvyo10ry4wmyrdi0.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es bleibt, den Code einzufügen und das Lambda zu speichern.</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-string">"""Parsing the stream and inserting into the DynamoDB table."""</span>
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> decimal <span class="hljs-keyword">import</span> Decimal<font></font>
<font></font>
DYNAMO_DB = boto3.resource(<span class="hljs-string">'dynamodb'</span>)<font></font>
TABLE_NAME = <span class="hljs-string">'airline_tickets'</span><font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketsParser</span>:</span>
    <span class="hljs-string">"""Parsing info from the Stream."""</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, table_name, records</span>):</span>
        <span class="hljs-string">"""Init method."""</span><font></font>
        self.table = DYNAMO_DB.Table(table_name)<font></font>
        self.json_data = TicketsParser.get_json_data(records)<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_json_data</span>(<span class="hljs-params">records</span>):</span>
        <span class="hljs-string">"""Return deserialized data from the stream."""</span>
        decoded_record_data = ([base64.b64decode(record[<span class="hljs-string">'kinesis'</span>][<span class="hljs-string">'data'</span>])
                                <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> records])<font></font>
        json_data = ([json.loads(decoded_record)<font></font>
                      <span class="hljs-keyword">for</span> decoded_record <span class="hljs-keyword">in</span> decoded_record_data])
        <span class="hljs-keyword">return</span> json_data<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_item_from_json</span>(<span class="hljs-params">json_item</span>):</span>
        <span class="hljs-string">"""Pre-process the json data."""</span><font></font>
        new_item = {<font></font>
            <span class="hljs-string">'record_id'</span>: json_item.get(<span class="hljs-string">'record_id'</span>),
            <span class="hljs-string">'cost'</span>: Decimal(json_item.get(<span class="hljs-string">'cost'</span>)),
            <span class="hljs-string">'trip_class'</span>: json_item.get(<span class="hljs-string">'trip_class'</span>),
            <span class="hljs-string">'show_to_affiliates'</span>: json_item.get(<span class="hljs-string">'show_to_affiliates'</span>),
            <span class="hljs-string">'origin'</span>: json_item.get(<span class="hljs-string">'origin'</span>),
            <span class="hljs-string">'number_of_changes'</span>: int(json_item.get(<span class="hljs-string">'number_of_changes'</span>)),
            <span class="hljs-string">'gate'</span>: json_item.get(<span class="hljs-string">'gate'</span>),
            <span class="hljs-string">'found_at'</span>: json_item.get(<span class="hljs-string">'found_at'</span>),
            <span class="hljs-string">'duration'</span>: int(json_item.get(<span class="hljs-string">'duration'</span>)),
            <span class="hljs-string">'distance'</span>: int(json_item.get(<span class="hljs-string">'distance'</span>)),
            <span class="hljs-string">'destination'</span>: json_item.get(<span class="hljs-string">'destination'</span>),
            <span class="hljs-string">'depart_date'</span>: json_item.get(<span class="hljs-string">'depart_date'</span>),
            <span class="hljs-string">'actual'</span>: json_item.get(<span class="hljs-string">'actual'</span>)<font></font>
        }<font></font>
        <span class="hljs-keyword">return</span> new_item<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-string">"""Batch insert into the table."""</span>
        <span class="hljs-keyword">with</span> self.table.batch_writer() <span class="hljs-keyword">as</span> batch_writer:
            <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.json_data:<font></font>
                dynamodb_item = TicketsParser.get_item_from_json(item)<font></font>
                batch_writer.put_item(dynamodb_item)<font></font>
<font></font>
        print(<span class="hljs-string">'Has been added '</span>, len(self.json_data), <span class="hljs-string">'items'</span>)<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-string">"""Parse the stream and insert into the DynamoDB table."""</span>
    print(<span class="hljs-string">'Got event:'</span>, event)<font></font>
    parser = TicketsParser(TABLE_NAME, event[<span class="hljs-string">'Records'</span>])<font></font>
    parser.run()<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen eines Lambda-Funktionsbenachrichtigers</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die zweite Lambda-Funktion, die den zweiten Stream (special_stream) überwacht und eine Benachrichtigung an SNS sendet, wird auf die gleiche Weise erstellt. </font><font style="vertical-align: inherit;">Daher muss dieses Lambda Lesezugriff von Kinesis haben und Nachrichten an das angegebene SNS-Thema senden, die dann vom SNS-Dienst an alle Abonnenten dieses Themas (E-Mail, SMS usw.) gesendet werden.</font></font><br>
<br>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erstellen Sie IAM-Rollen</font></font></b>
                        <div class="spoiler_text">  IAM  Lambda-KinesisAlarm   ,         alarm_notifier:<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/zm/fn/ru/zmfnru75p-tp0y1fqzxaoea2xos.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/yp/vp/u0/ypvpu0jl74aak54hl-d4wf7r1kc.jpeg"></div></div>
                    </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dieses Lambda sollte gemäß dem Auslöser für neue Einträge funktionieren, um in den special_stream zu gelangen. Daher müssen Sie den Auslöser genauso konfigurieren wie für das Collector-Lambda. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Zur Vereinfachung der Konfiguration dieses Lambdas führen wir eine neue Umgebungsvariable ein - TOPIC_ARN, in die wir das ANR-Thema (Amazon Recourse Names) von Airlines einfügen:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/43/nn/qf/43nnqfmsnahbfu30k5mqadhbuhi.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und geben Sie den Lambda-Code ein, es ist ganz einfach:</font></font><br>
<br>
<pre><code class="python hljs"><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> os<font></font>
<font></font>
SNS_CLIENT = boto3.client(<span class="hljs-string">'sns'</span>)<font></font>
TOPIC_ARN = os.environ[<span class="hljs-string">'TOPIC_ARN'</span>]<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lambda_handler</span>(<span class="hljs-params">event, context</span>):</span>
    <span class="hljs-keyword">try</span>:<font></font>
        SNS_CLIENT.publish(TopicArn=TOPIC_ARN,<font></font>
                           Message=<span class="hljs-string">'Hi! I have found an interesting stuff!'</span>,<font></font>
                           Subject=<span class="hljs-string">'Airline tickets alarm'</span>)<font></font>
        print(<span class="hljs-string">'Alarm message has been successfully delivered'</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> err:<font></font>
        print(<span class="hljs-string">'Delivery failure'</span>, str(err))
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dies scheint die manuelle Systemkonfiguration abzuschließen. </font><font style="vertical-align: inherit;">Es bleibt nur zu testen und sicherzustellen, dass wir alles richtig konfiguriert haben.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bereitstellung aus Terraform-Code</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notwendige Vorbereitung</font></font></h3><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terraform</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ist ein sehr praktisches Open-Source-Tool zum Bereitstellen der Infrastruktur aus Code. </font><font style="vertical-align: inherit;">Es hat eine eigene Syntax, die leicht zu erlernen ist, und viele Beispiele dafür, wie und was bereitgestellt werden soll. </font><font style="vertical-align: inherit;">Es gibt viele praktische Plugins im Atom- oder Visual Studio-Code-Editor, die die Arbeit mit Terraform erleichtern. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie können das Distributionskit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> herunterladen </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Eine detaillierte Analyse aller Funktionen von Terraform würde den Rahmen dieses Artikels sprengen, daher beschränken wir uns auf die Hauptpunkte.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wie man anfängt</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der vollständige Projektcode befindet sich </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in meinem Repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wir klonen ein Repository für uns. </font><font style="vertical-align: inherit;">Bevor Sie beginnen, müssen Sie sicherstellen, dass Sie AWS CLI installiert und konfiguriert haben </font><font style="vertical-align: inherit;">Terraform sucht in der Datei ~ / .aws / credentials nach Anmeldeinformationen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es wird empfohlen, die gesamte Infrastruktur bereitzustellen, bevor Sie den Befehl plan starten, um zu sehen, was Terraform in der Cloud für uns erstellt:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe plan</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sie werden aufgefordert, eine Telefonnummer einzugeben, um Benachrichtigungen an diese zu senden. </font><font style="vertical-align: inherit;">Zu diesem Zeitpunkt ist dies optional.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/e3/-i/ps/e3-ipsgvy03inzbw_26haktayk4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach der Analyse des Arbeitsplans des Programms können wir mit der Erstellung von Ressourcen beginnen:</font></font><br>
<br>
<pre><code class="bash hljs">terraform.exe apply</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nach dem Senden dieses Befehls werden Sie erneut aufgefordert, eine Telefonnummer einzugeben. Geben Sie "Ja" ein, wenn die Frage zur tatsächlichen Ausführung von Aktionen angezeigt wird. </font><font style="vertical-align: inherit;">Auf diese Weise können Sie die gesamte Infrastruktur erhöhen, alle erforderlichen Einstellungen für EC2 vornehmen, Lambda-Funktionen bereitstellen usw. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Nachdem alle Ressourcen erfolgreich über den Terraform-Code erstellt wurden, müssen Sie auf die Details der Kinesis Analytics-Anwendung eingehen (leider habe ich nicht herausgefunden, wie dies direkt aus dem Code heraus geschehen kann). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Starte die Anwendung:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/ns/qc/qxnsqcjpbkiaradzqomahtxzhnu.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Danach müssen Sie den Stream-Namen in der Anwendung explizit festlegen, indem Sie aus der Dropdown-Liste Folgendes auswählen:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/ki/m5/pl/kim5plwariaz8bp-qo-qonli4yu.jpeg"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/hg/69/kf/hg69kfwwtwhwkzxlpnb7g3k2ctm.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt ist alles bereit zu gehen.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anwendungstests</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unabhängig davon, wie Sie das System manuell oder über den Terraform-Code bereitgestellt haben, funktioniert es genauso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir gehen über SSH zur virtuellen EC2-Maschine, auf der Kinesis Agent installiert ist, und führen das Skript api_caller.py aus</font></font><br>
<br>
<pre><code class="bash hljs">sudo ./api_caller.py TOKEN</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es bleibt noch auf eine SMS an Ihre Nummer zu warten: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/98/ui/mc/98uimcirxv_n6pglm2qz5jtkvf4.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SMS - Nachricht kommt in fast 1 Minute am Telefon an: </font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/kg/u7/dj/kgu7djc9xgex84h349dlpfukivg.jpeg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es bleibt abzuwarten, ob Datensätze in der DynamoDB-Datenbank für eine spätere, detailliertere Analyse gespeichert werden. </font><font style="vertical-align: inherit;">Die Airline_Tickets-Tabelle enthält ungefähr Folgendes:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/dj/vc/gqdjvcmx0q45o_sgqc_l5po_l-c.jpeg"></div><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Laufe der Arbeit wurde ein auf Amazon Kinesis basierendes Online-Datenverarbeitungssystem aufgebaut. </font><font style="vertical-align: inherit;">Wir haben die Optionen für die Verwendung von Kinesis Agent in Verbindung mit Kinesis Data Streams und die Echtzeitanalyse von Kinesis Analytics mithilfe von SQL-Befehlen sowie die Interaktion von Amazon Kinesis mit anderen AWS-Diensten untersucht. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wir haben das oben genannte System auf zwei Arten bereitgestellt: lang genug manuell und schnell aus dem Terraform-Code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der gesamte Quellcode des Projekts ist </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in meinem Repository auf GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> verfügbar. </font><font style="vertical-align: inherit;">Ich empfehle Ihnen, sich damit vertraut zu machen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich bin bereit, den Artikel gerne zu diskutieren, ich warte auf Ihre Kommentare. </font><font style="vertical-align: inherit;">Ich hoffe auf konstruktive Kritik. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wünsche dir Erfolg!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de500364/index.html">Erweiterung des Schullernportals auf Moodle und BigBlueButton</a></li>
<li><a href="../de500368/index.html">Generieren vorhersagbarer Zufallssequenzen: ein anderer Ansatz zur Permutation</a></li>
<li><a href="../de500370/index.html">10 nützliche englischsprachige Podcasts für Programmierer, die es wert sind, 2020 abonniert zu werden</a></li>
<li><a href="../de500378/index.html">Effektive Informationssuche bei der Arbeit</a></li>
<li><a href="../de500380/index.html">Fernverarbeitung personenbezogener Daten: Risiken und mögliche Folgen</a></li>
<li><a href="../de500384/index.html">Die Pioniere von Pixar Studio erhielten den Turing Award und 1 Million US-Dollar</a></li>
<li><a href="../de500386/index.html">Anpassung Ihrer vorhandenen Geschäftslösung an SwiftUI. Teil 2</a></li>
<li><a href="../de500390/index.html">Aktuelle Modelle der sprachlichen Lokalisierung im Bereich IT und digitale Kommunikation. Teil 1</a></li>
<li><a href="../de500396/index.html">Probleme autonomer Zugangskontrollsysteme - wo sie nicht erwartet hatten</a></li>
<li><a href="../de500398/index.html">Remote Marathon Woche 3: Inoperative Prozesse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>