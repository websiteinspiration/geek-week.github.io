<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕴🏼 🤾🏼 🎾 Das Studium eines böswilligen 🎅🏻 👨🏽‍🌾 👨🏽‍🎓</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich bin auf eine kürzlich bösartige Dokumentdatei gestoßen, die mit Phishing-E-Mails gesendet wurde. Ich entschied, dass dies ein guter Grund ist, Rev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Das Studium eines böswilligen</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/489020/"><img src="https://habrastorage.org/webt/ee/hd/a7/eehda7mpejjegq4jc2me1nvupy4.jpeg" alt="Bild"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich bin auf eine kürzlich bösartige Dokumentdatei gestoßen, die mit Phishing-E-Mails gesendet wurde. </font><font style="vertical-align: inherit;">Ich entschied, dass dies ein guter Grund ist, Reverse Engineering zu üben und etwas Neues über Habr zu schreiben. </font><font style="vertical-align: inherit;">Unter der Katze - ein Beispiel für das Parsen eines böswilligen Makro-Droppers und nicht weniger bösartiger DLLs.</font></font><br>
<a name="habracut"></a><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Makro</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sha256 aus der Datei - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">abb052d9b0660f90bcf5fc394db0e16d6edd29f41224f8053ed90a4b8ef1b519</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In der Dokumentdatei selbst befindet sich auf der ersten Seite ein Bild, das darüber informiert, dass diese Datei geschützt ist, und erklärt, wie Makros aktiviert werden. Die Datei enthält zwei große Tabellen mit Zahlen. Zahlen werden in Dezimalform geschrieben, die längsten sind zehnstellig, es gibt sowohl positive als auch negative. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn das Opfer die Ausführung von Makros zulässt (gibt es diejenigen, bei denen diese standardmäßig aktiviert ist?), Wird eine Aktionskette ausgelöst, die letztendlich die Funktion </font><i><font style="vertical-align: inherit;">updateb_network</font></i><font style="vertical-align: inherit;"> ausführt</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hiermit wird das aktuelle Verzeichnis in ein temporäres Verzeichnis geändert und die darin enthaltene Datei "icutils.dll" erstellt, in der die Zahlen aus der ersten Tabelle in einer Reihe als 32-Bit-Ganzzahl mit einem Vorzeichen notiert werden. </font><font style="vertical-align: inherit;">Das Ergebnis ist die richtige DLL. </font><font style="vertical-align: inherit;">Die </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klonfunktion</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wird aus dieser DLL importiert </font><font style="vertical-align: inherit;">:</font></font><br>
<br>
<pre><code class="vbscript hljs">Declare PtrSafe <span class="hljs-keyword">Function</span> clone Lib <span class="hljs-string">"icutils.dll"</span> _<font></font>
(<span class="hljs-keyword">ByVal</span> Saved As <span class="hljs-built_in">String</span>, <span class="hljs-keyword">ByVal</span> <span class="hljs-built_in">Time</span> As Integer) As Boolean</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und es beginnt mit zwei Parametern:</font></font><br>
<br>
<pre><code class="vbscript hljs">R1 = Module1.clone(<span class="hljs-string">"Cream"</span>, <span class="hljs-number">0</span>)</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wenn der </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klon</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aufruf </font><font style="vertical-align: inherit;">False zurückgibt, wird die icutils.dll Datei mit Daten aus der zweiten Tabelle und Klon mit den gleichen Parametern überschrieben wieder aufgerufen wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit Blick auf die Zukunft werde ich sagen, dass die erste DLL 64-Bit ist und nicht auf 32-Bit-Systemen ausgeführt werden kann. </font><font style="vertical-align: inherit;">Somit wählt das Makro die richtige Binärcode-Architektur aus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interessanterweise hat die </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aktualisierte</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion </font><i><font style="vertical-align: inherit;">b_network</font></i><font style="vertical-align: inherit;"> einen Code, der keinen funktionalen Zweck hat:</font></font><br>
<br>
<pre><code class="vbscript hljs"><span class="hljs-keyword">Sub</span> updatedb_network()<font></font>
...<font></font>
<span class="hljs-keyword">Dim</span> query_to_change As Variant
    <span class="hljs-keyword">Set</span> query_to_change = CurrentDb.QueryDefs(<span class="hljs-string">"query_name"</span>)<font></font>
    <font></font>
    query_to_change.SQL = <span class="hljs-string">"SELECT * FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table ORDER BY ID Asc"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE Fashion"</span>
    query_to_change.SQL = <span class="hljs-string">"SELECT Field1, Field2 FROM Table WHERE Field LIKE '"</span> &amp; something &amp; <span class="hljs-string">"'"</span><font></font>
...<font></font>
<span class="hljs-keyword">End</span> <span class="hljs-keyword">Sub</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielleicht ist er hier, um denjenigen, die schnell durch den Code scrollen, einige Zeilen in SQL sehen und denken, dass alles in Ordnung ist, den Anschein einer nützlichen Arbeit zu erwecken? </font><font style="vertical-align: inherit;">Weiß nicht. </font><font style="vertical-align: inherit;">Außerdem haben die meisten Funktionen und Variablen zufällige oder nicht reelle Namen (z. B. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">updateb_network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , das nicht mit der Datenbank oder dem Netzwerk interagiert). </font><font style="vertical-align: inherit;">Obwohl es zum Beispiel die Funktion </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dump_payload gibt</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , die 4 Bytes in icutil.dll speichert. </font><font style="vertical-align: inherit;">In jedem Fall sollte das Vorhandensein der </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Document_Open-</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion sofort darauf hinweisen </font><font style="vertical-align: inherit;">, dass Autoren der Malware sie nicht willkürlich umbenennen können (obwohl sie stattdessen eine andere automatisch gestartete Funktion verwenden können). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Makrofunktionalität ist also mehr oder weniger klar. Es ist Zeit, die DLL zu entladen und mit ihrer Analyse fortzufahren.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Erste DLL</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die erste DLL (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7427cc4b6b659b89552bf727aed332043f4551ca2ee2126cca75fbe1ab8bf114</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) 64-Bit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Liste der importierten Funktionen enthält die Funktionen </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Programmstart), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Erstellen eines Threads in </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einem anderen</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Prozess), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font><i><font style="vertical-align: inherit;">Zuweisen</font></i><font style="vertical-align: inherit;"> eines Speicherblocks in </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">einem anderen</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Prozess), </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Schreiben in den Speicher eines </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">anderen</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Prozesses), die sofort das Einfügen von Code in einen </font><u><font style="vertical-align: inherit;">anderen</font></u><font style="vertical-align: inherit;"> Prozess </font><i><font style="vertical-align: inherit;">vorschlagen</font></i><font style="vertical-align: inherit;"> Prozess. Nun wollen wir sehen, was genau sie mit IDA Free und Ghidra macht.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Haupteinstiegspunkt gibt einfach 1 zurück, macht sonst nichts. Die zweite exportierte Funktion ist der Klon, der vom Makro aufgerufen wird und schädlichen Code enthält. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Parameter, mit denen es aufgerufen wird, scheinen nichts zu beeinflussen. Die Anwendung entschlüsselt zwei Datenblöcke. Der erste 0x78-Datenblock mit folgendem Inhalt (bereits entschlüsselt):</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d&lt;\x04\xe0\x1d\xe6\x00\xde\x01\xa4\x17\xbc\x03x\x01\xe0\x1d\xe2\x16x\x07Qy\xbc\x03@Fx\x07Df\xbc\x03\x89a\xde\x01q\x11\xe0\x1d|Ix\x07D@\xbc\x03\x8a\x01\xde\x01^9\xde\x01\xf2i\xe0\x1d\x95h\xbc\x03\xe4#\xe0\x1d\xab</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der zweite Datenblock ist 0x1D4C lang und enthält ausführbaren Code. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Außerdem werden ein Zeiger auf das Kernel32-Modul, das Ergebnis der </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetTickCount</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> () -Funktion und die Adresse der </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwDelayExecution</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> () </font><font style="vertical-align: inherit;">-Funktion </font><font style="vertical-align: inherit;">von </font><font style="vertical-align: inherit;">Kernel32 in die 0x90-Bytestruktur geschrieben </font><font style="vertical-align: inherit;">. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anschließend wird der Prozess ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) "cmd.exe" erstellt. Mit </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VirtualAllocEx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> werden zwei Puffer zugewiesen: mit RW-Berechtigungen mit einer Länge von 0x108 und mit RWX-Berechtigungen mit einer Länge von 0x1D4C. Der RW-Puffer kopiert den obigen Datenblock und die zuvor erwähnte Struktur mit einer Länge von 0 × 90. Die Struktur schreibt auch einen Zeiger auf den entschlüsselten Datenblock (im Adressraum des untergeordneten Prozesses (cmd.exe)). In RWX wird der Puffer kopiert ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteProcessMemory)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) entschlüsselter Datenblock mit Code. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Anschließend wird im Prozess cmd.exe ein Stream ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateRemoteThread</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) mit einem Einstiegspunkt am Anfang des RWX-Puffers erstellt. Ein Zeiger auf den RW-Puffer wird als Argument übergeben. </font><font style="vertical-align: inherit;">Damit ist die Klonfunktion abgeschlossen. Die Aktion wird im Prozess cmd.exe fortgesetzt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Interessanterweise scheint </font><font style="vertical-align: inherit;">die </font><i><font style="vertical-align: inherit;">Klonfunktion</font></i><font style="vertical-align: inherit;"> wie ein unerreichbarer Code zu sein, der </font><font style="vertical-align: inherit;">die Bibliothek " </font><i><font style="vertical-align: inherit;">WorkPolyhistor</font></i><font style="vertical-align: inherit;"> " </font><font style="vertical-align: inherit;">importiert ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LoadLibraryW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font><font style="vertical-align: inherit;">.</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der in cmd.exe eingefügte Code</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es führt die folgenden Aktionen aus:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">findet die Adressen der notwendigen Funktionen aus </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">kernel32.dll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (seine Adresse wird vom übergeordneten Prozess bezogen)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lasten </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ntdll</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OLE32</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User32 Bibliotheken</font></font></i></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Findet Adressen der erforderlichen Funktionen in diesen Bibliotheken.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist interessant, dass es für die meisten Funktionen im Code keinen Funktionsnamen gibt, sondern nur CRC32 im Auftrag von (alle Funktionsnamen aus der geladenen Bibliothek werden durchsucht, bis eine Funktion mit dem gewünschten CRC32 im Auftrag von vorhanden ist). </font><font style="vertical-align: inherit;">Möglicherweise ist dies ein Schutz gegen das Abrufen der Liste der importierten Funktionen durch das Dienstprogramm "Strings", obwohl es seltsam ist, dass in verschlüsselter Form gespeicherter Code einen solchen Schutz bietet, während die DLL selbst Funktionen einfach nach Namen importiert. </font><font style="vertical-align: inherit;">Insgesamt werden folgende Funktionen erkannt: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
kernel32:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetProcAddress</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek laden</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Globalalloc</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetTempPath </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetFileAttributesW</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateProcessW </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Globalfrei </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GlobalRealloc </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schreibdatei</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CreateFileW (nach Namen gefunden)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Schreibdatei</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Closehandle</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Gettickcount</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ReadFile</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GetfileSize</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ntdll:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RtlCreateUnicodeStringFromAsciiz</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwDelayExecution</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ZwTerminateProcess</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> swprintf</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ole32:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoInitialize (namentlich gefunden)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CoCreateInstance (nach Namen gefunden)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
msvcrt:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rand</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> srand</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nächstes</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> erhält </font><font style="vertical-align: inherit;">der Prozess, der </font><i><font style="vertical-align: inherit;">GetTempPath verwendet,</font></i><font style="vertical-align: inherit;"> den Pfad zum temporären Verzeichnis, erstellt darin eine Datei mit dem Namen 26342235.dat, wobei der Dateiname der vom übergeordneten Prozess empfangene Dezimaldatensatz von TickCount ist und bei jedem neuen Versuch wiederholt wird (d. H. Wenn die Nutzdaten nicht heruntergeladen werden konnten) Beim ersten Versuch wird beim zweiten Versuch eine Datei mit dem Namen 26342236.dat erstellt. </font><font style="vertical-align: inherit;">Danach wird die Wininet-Bibliothek geladen und es gibt Zeiger auf folgende Funktionen:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetCloseHandle (crc32: 0xe5191d24)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState (crc32: 0xf2e5fc0c)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenA (crc32: 0xda16a83d)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetOpenUrlA (crc32: 0x16505e0)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetReadFile (crc32: 0x6cc098f5)</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternetGetConnectedState</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> geprüft , </font><font style="vertical-align: inherit;">ob es ein Netzwerk ist - wenn nicht, die Anwendung die nicht existente Adresse nennt und fällt (wie zum </font><font style="vertical-align: inherit;">Schutz der Adresse bestimmen , </font><font style="vertical-align: inherit;">wo es stellt sich peyload aus der Maschine Netzwerk isoliert verwendet , </font><font style="vertical-align: inherit;">ist der einzige Fall , </font><font style="vertical-align: inherit;">wenn die Anwendung nicht </font><font style="vertical-align: inherit;">normal beendet wird </font><font style="vertical-align: inherit;">, den Rest -. Aus 3 Versuche , wonach cmd.exe mit </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> beendet </font><i><font style="vertical-align: inherit;">wird</font></i><font style="vertical-align: inherit;"> ). Wenn ein Netzwerk vorhanden ist, werden die Nutzdaten mithilfe der gefundenen Funktionen von der vom übergeordneten Prozess (https://pastebin.com/raw/Jyujxy7z) übergebenen URL heruntergeladen und in der zuvor erstellten Datei mit der Erweiterung .dat gespeichert.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Als nächstes wird die Nutzlast aus der .dat-Datei gelesen, dekodiert (base64), mit XOR mit CRC32 von der URL entschlüsselt. Überprüfen Sie, ob die ersten 2 Bytes der entschlüsselten Daten 'MZ' sind. Wenn ja, wird das Ergebnis in einer Datei mit demselben Namen, aber derselben Erweiterung gespeichert. exe</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python-Entschlüsselungscode</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> crc32
<span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt_payload</span>(<span class="hljs-params">payload_b64: bytes, url: str</span>):</span><font></font>
    payload_bin = b64decode(payload_b64.decode())<font></font>
    key = str(crc32(url.encode())).encode()<font></font>
    decrypted = bytearray()<font></font>
    <span class="hljs-keyword">for</span> i, b <span class="hljs-keyword">in</span> enumerate(payload_bin):<font></font>
        decrypted.append(b ^ key[i % len(key)])<font></font>
    <span class="hljs-keyword">return</span> bytes(decrypted)
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mit der Funktion </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProcessW</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> wird die </font><font style="vertical-align: inherit;">gespeicherte Datei gestartet. </font><font style="vertical-align: inherit;">Wenn alles gut geht, wird der Prozess cmd.exe mit </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ZwTerminateProcess beendet</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Wenn etwas schief gelaufen ist (außer dem Fehlen eines Netzwerks), wird alles neu wiederholt, es werden maximal 3 Versuche unternommen, und die Namen der dat- und exe-Dateien werden jedes Mal um 1 erhöht.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zweite DLL</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die zweite DLL (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">006200fcd7cd1e71be6c2ee029c767e3a28f480613e077bf15fadb60a88fdfca</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) 32 Bit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Darin ist die wichtigste bösartige Funktionalität in der </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Klonfunktion</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> implementiert </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es entschlüsselt auch 2 Puffer. </font><font style="vertical-align: inherit;">Der erste Puffer hat eine Größe von 0x78 (120) Bytes, solche Daten werden entschlüsselt und in ihn geschrieben (in entschlüsselter Form):</font></font><br>
<br>
<pre><code class="plaintext hljs">https://pastebin.com/raw/Jyujxy7z\x00\x00\x00\x00\x00\x00\x00\x1e(\xf0\x0e\xc5r\xc0;\x12)\xc0;Jr\xc0;Y4\xbc\x03/Mx\x07\x038\xde\x01\x9e\x05\xe0\x1d#\x08\xbc\x03\xeeU\xf0\x0e\x18{x\x078\x1a\xf0\x0e\xccg\xf0\x0eze\xde\x01\x89&amp;\xe0\x1d\xf6\x1f\xe0\x1d</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist zu sehen, dass am Anfang dieselbe URL wie in der x64-Version ist. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ein zweiter Puffer der Größe 0x4678 Byte wird mit RWX-Berechtigungen zugewiesen. </font><font style="vertical-align: inherit;">Der Code wird darin entschlüsselt, woraufhin eine Funktion mit einem Offset von 0x4639 vom Anfang des Puffers aus aufgerufen wird. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe diesen Code nicht im Detail analysiert. </font><font style="vertical-align: inherit;">Er findet auch Funktionen auf CRC32, startet notepad.exe und fügt dort Code ein, der Nutzdaten von derselben URL auf pastebin herunterlädt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nutzlast mit Pastebin</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die mit Pastebin entschlüsselte Nutzlast ist eine 32-Bit-Exe-Datei (sha256 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9509111de52db3d9a6c06aa2068e14e0128b31e9e45ada7a8936a35ddfaf155f</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Ich habe sie aus </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">Zeitgründen</font></a><font style="vertical-align: inherit;"> noch nicht im Detail zerlegt.</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fazit</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im Allgemeinen hat mich die Malware mit vielen Fehlern ziemlich schlecht geschrieben beeindruckt (ich nenne sie hier nicht absichtlich). </font><font style="vertical-align: inherit;">Als würden sie aufpeitschen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
DLL findet in Speicherfunktionen, die später nirgendwo verwendet werden. </font><font style="vertical-align: inherit;">Möglicherweise wird dieser Code wie ein Makro regelmäßig von Cyberkriminellen neu geschrieben, wenn er von Virenschutzprogrammen erkannt wird, wodurch solche Artefakte im Code verbleiben. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es ist auch interessant, dass in der "DLL" -Version der DLL, die auf der x64-Festplatte "abgelegt" wird, die Namen der "gefährlichen" importierten Funktionen nicht maskiert sind (Sie können sie zumindest als Zeichenfolgen sehen) und in dem Code, der im Speicher entschlüsselt ist und nicht auf die Festplatte passt, sich auf CRC32 befinden Name, nicht nur mit Namen. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Pastebin-Nutzlast wurde einige Tage später entfernt. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KDPV von hier genommen</font></font></a></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de489008/index.html">Routing in komplexen Chatbots mit dem Hobot-Framework</a></li>
<li><a href="../de489010/index.html">Wir teilen die größte Datenschicht in Russland zum Online-Lernen mit Projekten in den Bereichen Linguistik, Personalisierung, Peddesign, ML</a></li>
<li><a href="../de489012/index.html">Google Cloud Spanner: gut, schlecht, böse</a></li>
<li><a href="../de489014/index.html">Das Buch „Perfekter Algorithmus. Gierige Algorithmen und dynamische Programmierung »</a></li>
<li><a href="../de489016/index.html">German Gref: „Wir haben versucht, eine Diskussion über die AGI zu organisieren, und kein einziger Wissenschaftler mit Selbstachtung ist dazu gekommen.“</a></li>
<li><a href="../de489022/index.html">Verwenden von RabbitMQ mit MonsterMQ Teil 2</a></li>
<li><a href="../de489024/index.html">Webix JavaScript-Bibliothek mit den Augen eines Anfängers. Teil 5. Arbeiten Sie mit Daten auf der Benutzerseite</a></li>
<li><a href="../de489026/index.html">Das Ändern der Google AdSense-Algorithmen kann zu Website-Eigentümern und Webmastern führen</a></li>
<li><a href="../de489028/index.html">Über Fernarbeit</a></li>
<li><a href="../de489034/index.html">Die neue mobile UIS-App oder -Rettung für diejenigen, die ein öffentliches Beschaffungswesen suchen?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>