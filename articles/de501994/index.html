<!doctype html>
<html class="no-js" lang="de">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦅 ♑️ 🥔 Orchestrator für MySQL: Warum kann ein fehlersicheres Projekt ohne es nicht erstellt werden? ✌🏻 🧕🏿 🐚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jedes größere Projekt begann mit zwei Servern. Zuerst gab es einen DB-Server, dann wurden Slaves hinzugefügt, um den Messwert zu skalieren. Und hier -...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Orchestrator für MySQL: Warum kann ein fehlersicheres Projekt ohne es nicht erstellt werden?</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/citymobil/blog/501994/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jedes größere Projekt begann mit zwei Servern. </font><font style="vertical-align: inherit;">Zuerst gab es einen DB-Server, dann wurden Slaves hinzugefügt, um den Messwert zu skalieren. </font><font style="vertical-align: inherit;">Und hier - hör auf! </font><font style="vertical-align: inherit;">Ein Meister, aber viele Sklaven; </font><font style="vertical-align: inherit;">Wenn einer der Slaves geht, ist alles in Ordnung, aber wenn der Master geht, ist es schlecht: Ausfallzeiten, Administratoren in der Seife erhöhen den Server. </font><font style="vertical-align: inherit;">Was zu tun ist? </font><font style="vertical-align: inherit;">Reserviere den Meister. </font><font style="vertical-align: inherit;">Mein Kollege Pavel hat bereits einen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artikel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> darüber geschrieben </font><font style="vertical-align: inherit;">, ich werde ihn nicht wiederholen. </font><font style="vertical-align: inherit;">Stattdessen erkläre ich Ihnen, warum Sie definitiv einen Orchestrator für MySQL benötigen!</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Beginnen wir mit der Hauptfrage: "Wie werden wir den Code auf einen neuen Computer umstellen, wenn der Assistent abreist?"</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Das Schema mit VIP (Virtual IP) gefällt mir am besten. Wir werden weiter unten darauf eingehen. </font><font style="vertical-align: inherit;">Es ist das einfachste und offensichtlichste, obwohl es eine offensichtliche Einschränkung hat: Der Master, den wir reservieren werden, muss mit einer neuen Maschine im L2-Segment sein, dh Sie können den zweiten DC vergessen. </font><font style="vertical-align: inherit;">Und auf eine gute Weise, wenn Sie der Regel folgen, dass großes L2 böse ist, weil L2 nur pro Rack und zwischen den Racks L3 ist und ein solches Schema noch mehr Einschränkungen aufweist.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie können einen DNS-Namen im Code registrieren und über / etc / hosts auflösen. </font><font style="vertical-align: inherit;">In der Tat wird es keine Lösung geben. </font><font style="vertical-align: inherit;">Vorteil des Schemas: Es gibt keine Einschränkungseigenschaft für die erste Methode, dh Sie können auch Cross-DCs organisieren. </font><font style="vertical-align: inherit;">Aber dann stellt sich die offensichtliche Frage, wie schnell wir mit Puppet-Ansible die Änderung an / etc / hosts liefern können.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sie können die zweite Methode ein wenig ändern: Auf allen Webservern setzen wir Caching-DNS ein, über das der Code in die Master-Datenbank gelangt. </font><font style="vertical-align: inherit;">Sie können TTL 60 für diesen Eintrag in DNS registrieren. </font><font style="vertical-align: inherit;">Es scheint, dass die Methode bei richtiger Implementierung gut ist.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Schema mit Serviceerkennung unter Verwendung von Consul und etcd.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eine interessante Option mit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxySQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Es ist notwendig, den gesamten Datenverkehr auf MySQL über ProxySQL zu verpacken. ProxySQL kann bestimmen, wer der Master jetzt ist. </font><font style="vertical-align: inherit;">Eine der Optionen für die Verwendung dieses Produkts finden Sie übrigens in meinem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Artikel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Autor von Orchestrator implementierte während der Arbeit an Github zuerst das erste Schema mit VIP und gestaltete es dann mit c consul neu. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Typisches Infrastrukturschema:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/76b/1d1/aa6/76b1d1aa670440b7abab79d7af3e3c4d.png" alt="Bild"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich werde sofort die offensichtlichen Situationen beschreiben, die zu berücksichtigen sind:</font></font><br>
<br>
<ul>
<li>VIP-           .  :  ,    , Orchestrator    failover      ;    ,   VIP   .  .</li>
<li>            .     ifdown,     — ifup vip.       ,    failover       ,    splitbrain.</li>
<li> ,  Orchestrator   ,    VIP /    ,         VIP,    arping  ,   VIP  .</li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alle Slaves sollten read_only = 1 haben, und sobald Sie den Slave zum Master befördern, sollte read_only = 0 sein.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vergessen Sie nicht, dass jeder Slave, den wir dafür ausgewählt haben, ein Master werden kann (Orchestrator hat einen ganzen Präferenzmechanismus, welcher Slave überhaupt als Kandidat für einen neuen Master betrachtet werden sollte, welcher als zweiter und welcher Slave unter keinen Umständen überhaupt ausgewählt werden sollte Meister). </font><font style="vertical-align: inherit;">Wenn der Slave ein Master wird, bleibt die Slave-Last darauf und die Master-Last wird hinzugefügt, dies muss berücksichtigt werden.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Warum brauchen Sie Orchestrator unbedingt, wenn Sie keinen haben?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orchestrator verfügt über eine sehr benutzerfreundliche grafische Oberfläche, die die gesamte Topologie anzeigt (siehe Abbildung unten).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orchestrator kann verfolgen, welche Slaves sich dahinter befinden und wo die Replikation im Allgemeinen unterbrochen ist (wir haben Skripte zum Senden von SMS an Orchestrator).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Orchestrator teilt Ihnen mit, bei welchen Folien ein GTID-Fehler aufgetreten ist.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Orchestrator-Schnittstelle:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f9/44a/bfc/4f944abfc03d26710c2164369c185893.png" alt="Bild"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Was ist ein GTID-Fehler? </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es gibt zwei Grundvoraussetzungen, damit Orchestrator funktioniert:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist erforderlich, dass die Pseudo-GTID auf allen Computern im MySQL-Cluster aktiviert ist. Wir haben die GTID aktiviert.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist notwendig, dass es überall eine Art von Binlogs gibt, die Sie angeben können. </font><font style="vertical-align: inherit;">Wir hatten eine solche Konfiguration, in der Row auf dem Master und auf den meisten Slaves war, und der gemischte Modus blieb historisch auf zwei. </font><font style="vertical-align: inherit;">Infolgedessen wollte Orchestrator diese Slaves einfach nicht mit dem neuen Master verbinden.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Denken Sie daran, dass das Wichtigste an einem Produktionssklaven die Übereinstimmung mit dem Master ist! </font><font style="vertical-align: inherit;">Wenn Sie die globale Transaktions-ID (GTID) sowohl auf dem Master als auch auf dem Slave aktiviert haben, können Sie mit der Funktion gtid_subset herausfinden, ob auf diesen Computern tatsächlich dieselben Datenänderungsanforderungen ausgeführt werden. </font><font style="vertical-align: inherit;">Lesen Sie </font><font style="vertical-align: inherit;">mehr dazu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher zeigt Orchestrator Ihnen durch einen GTID-Fehler an, dass auf dem Slave Transaktionen vorhanden sind, die nicht im Assistenten enthalten sind. </font><font style="vertical-align: inherit;">Warum passiert es?</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read_only = 1 ist auf dem Slave nicht aktiviert, jemand hat eine Verbindung hergestellt und eine Anforderung zur Datenänderung ausgeführt.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Super_read_only = 1 ist auf dem Slave nicht aktiviert, dann ging der Administrator, nachdem er den Server vertauscht hatte, hinein und führte dort eine Anforderung aus.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie beide vorherigen Absätze berücksichtigt haben, gibt es noch einen Trick: In MySQL fällt auch eine Anforderung zum Löschen von Binlogs in das Binlog. Wenn Sie also das erste Mal leeren, wird im Assistenten und auf allen Slaves ein GTID-Fehler angezeigt. </font><font style="vertical-align: inherit;">Wie vermeide ich das? </font><font style="vertical-align: inherit;">In perona-5.7.25-28 wurde die Einstellung binlog_skip_flush_commands = 1 angezeigt, die das Schreiben von Flush in Binlogs verbietet. </font><font style="vertical-align: inherit;">Es gibt einen </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fehler in</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mysql.com </font><font style="vertical-align: inherit;">.</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich fasse alle oben genannten Punkte zusammen. </font><font style="vertical-align: inherit;">Wenn Sie Orchestrator noch nicht im Failover-Modus verwenden möchten, versetzen Sie es in den Überwachungsmodus. </font><font style="vertical-align: inherit;">Dann haben Sie immer eine Karte der Interaktion von MySQL-Maschinen vor Augen und klare Informationen darüber, welche Art von Replikation auf jeder Maschine, ob die Slaves im Rückstand sind und vor allem - wie viel Konsistenz sie mit dem Master haben!</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die offensichtliche Frage lautet: "Wie sollte Orchestrator funktionieren?" Er muss einen neuen Master aus den aktuellen Slaves auswählen und dann alle Slaves wieder mit ihm verbinden (dafür ist GTID gedacht; wenn Sie den alten Mechanismus mit binlog_name und binlog_pos verwenden, ist es einfach unmöglich, den Slave vom aktuellen Master zum neuen zu wechseln!). Bevor Orchestrator zu uns kam, musste ich das alles einmal manuell machen. Der alte Master stürzte aufgrund eines fehlerhaften Adaptec-Controllers ab, er hatte ungefähr 10 Slaves. Ich musste den VIP vom Master auf einen der Slaves übertragen und alle anderen Slaves wieder damit verbinden. Wie viele Konsolen musste ich öffnen, wie viele Befehle musste ich gleichzeitig eingeben ... Ich musste bis 3 Uhr morgens warten, die Last von allen Sklaven entfernen, außer zwei, das erste Auto aus zwei Meistern machen und sofort das zweite Auto daran anschließen.Nehmen Sie daher alle anderen Slaves zum neuen Master und geben Sie die Last zurück. Im Allgemeinen ist der Horror ...</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Wie funktioniert Orchestrator im Failover-Modus? Dies lässt sich am einfachsten am Beispiel einer Situation zeigen, in der wir einen Master zu einer leistungsstärkeren und moderneren Maschine machen wollen als jetzt.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/577/a97/07d/577a9707d589865d8c5318281c418758.png" alt="Bild"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Abbildung zeigt die Mitte des Prozesses. </font><font style="vertical-align: inherit;">Was wurde bisher bereits getan? </font><font style="vertical-align: inherit;">Wir sagten, dass wir eine Art Slave zu einem neuen Master machen wollen, Orchestrator hat gerade damit begonnen, alle anderen Slaves wieder damit zu verbinden, und der neue Master fungiert als Transitmaschine. </font><font style="vertical-align: inherit;">Bei diesem Schema treten keine Fehler auf, alle Slaves funktionieren, Orchestrator entfernt den VIP vom alten Master, überträgt auf den neuen, macht read_only = 0 und vergisst den alten Master. </font><font style="vertical-align: inherit;">Alle! </font><font style="vertical-align: inherit;">Die Ausfallzeit unseres Service ist die VIP-Transferzeit, sie beträgt 2-3 Sekunden. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das ist alles für heute, danke euch allen. </font><font style="vertical-align: inherit;">Bald wird es einen zweiten Artikel über Orchestrator geben. </font><font style="vertical-align: inherit;">In dem berühmten sowjetischen Film "The Garage" sagte ein Held: "Ich würde nicht mit ihm aufklären!" </font><font style="vertical-align: inherit;">Also, Orchestrator, ich würde mit dir zum Scout gehen!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de501984/index.html">Was gibt es in Quarantäne zu sehen? Eine Auswahl von Materialien aus Technostream (Teil 4)</a></li>
<li><a href="../de501986/index.html">Geheimnisse des unglaublichen Erfolgs von Apple AirPods</a></li>
<li><a href="../de501988/index.html">Wie wird der VK-Nachrichtenbildschirm gerendert?</a></li>
<li><a href="../de501990/index.html">Nützlicher Beitrag: 4 Ereignisse, um die Probleme des zweiten Tages in OpenShift zu lösen und Operatoren zu erstellen</a></li>
<li><a href="../de501992/index.html">So organisieren Sie Tests, um Produktfreigaben zu beschleunigen und zu stabilisieren. Teil 1</a></li>
<li><a href="../de501996/index.html">Zen Go (Taschenversion)</a></li>
<li><a href="../de501998/index.html">Teurer Preis für Stile. Yandex-Bericht</a></li>
<li><a href="../de502000/index.html">12 Data Engineering Online-Kurse</a></li>
<li><a href="../de502004/index.html">Kanban-Methode: Verstehen Sie Ihren Prozess als kollektiven Wissensaufbauprozess - Teil 1 (Rezepte)</a></li>
<li><a href="../de502008/index.html">Programmierung für die Massen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>