<!doctype html>
<html class="no-js" lang="ja">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍⚖️ 🚣🏿 😎 彼女が振り返ったのか、またはAWS経由で自分のデータセンターに振り返ったかを確認しました。 🙆🏾 🤗 ♋️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="libreswan、xl2tpdを使用し、少し歪みを付けて、Amazon Linux AMI 2018の無料インスタンスを通じてEC2 Amazon Web Servicesサービスを通じて ホームハイパーバイザーにあるサービスを公開します...
 
 通常、経験のある従来の（IT以外の）ビジネスの...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>彼女が振り返ったのか、またはAWS経由で自分のデータセンターに振り返ったかを確認しました。</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470047/"><img src="https://habrastorage.org/webt/hb/3k/nj/hb3knjstg1kmyhx0g_bzk-r5jiu.jpeg" alt="画像"><br>
<br><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">libreswan</font></a><font style="vertical-align: inherit;">、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">xl2tpd</font></a><font style="vertical-align: inherit;">を使用</font><font style="vertical-align: inherit;">し、少し歪み</font><font style="vertical-align: inherit;">を</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">付けて</font></a><font style="vertical-align: inherit;">、</font><font style="vertical-align: inherit;">Amazon Linux AMI 2018の無料インスタンスを通じて</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EC2 Amazon Web Servicesサービス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を通じて</font><font style="vertical-align: inherit;">
ホームハイパーバイザーにあるサービスを公開します</font><font style="vertical-align: inherit;">...</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通常、経験のある従来の（IT以外の）ビジネスのシステム管理者は、通常、自宅に独自のサーバー仮想化ファームを設置して、ソリューションのヒープを地上でテストします。</font><font style="vertical-align: inherit;">これは、分散型オフィスブランチネットワークのありふれた模倣、高可用性の統合インフラストラクチャのテスト、一部のソリューションの新しいバージョンの展開などです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
外見上は、組み込みのハイパーバイザーとコンシューマーグレードのNASをiSCSIストレージとして（または同じPC上の単純な仮想マシンの形式で）搭載した単純なメモリポンプ式の家庭用PCから、安価な書き込み制御ユニット用に購入した本格的な小型ラックマウントサーバーまでを見ることができます。西部のデータセンターの血統を持ち、ネットワーク接続に同じBU tsiskaを使用し、同じようにファイバーチャネルで立ち往生し、セカンダリマーケットNASで購入しましたが、すでにビジネスクラスです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
もちろん、クラウドへの熱狂の時代では、インフラストラクチャ全体をクラウドデータセンターに簡単に展開できますが、主にコストが原因で、これがまだ常に可能であるとは限りません。テストで利用可能な計画からいくつかの軽量仮想マシンが必要かどうかは関係ありませんが、当番の場合、さまざまなサービスで数十または数百の個別の「仮想マシン」をひねる必要がありますが、いつでも手元にあるようにアーカイブしたいとします。 1年前にconfigs / settingsにねじれたサンプルがありました。または、既存のビジネスサービスの一部を同じMS Azureに転送する前に、ADDSとADFSの間で同じ同期を使用してすべての落とし穴を転送する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合の主な問題は、このすべてのインフラストラクチャを外部に公開（転送）することです。これにより、ユーザーを外部からホームの「サーバーサイト」または独自の「クラウド」サービスに接続したり、サードパーティのサービスと統合したりできるようになります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホーム接続がビジネスの関税のために設計されている場合、この場合、着信要求に問題はなく、IPアドレスはほとんどの場合「ホワイト」で静的であるとよいでしょう。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しかし、通常の「ホーム」プロバイダーが居住地に存在し、さらにプライベートネットワークからのアドレスしか提供できない場合の対処方法。または、それは白いアドレスを与えますが、伝統的に特権（&lt;1024）ポート範囲からのすべての着信を遮断しますか？または、あなたは汚い貧しい学生であり、単に法人のために設計された月額料金を買う余裕がありません。それとも、仮想サーバーの「所有物」をこぶにドラッグして、居住地を変更する必要があることがよくありますか？特別なケースは、CISの外に住んでいる人にも当てはまります。プロバイダーがインターネットに接続するための独自の機器を強制的に提供し、そこに必要なポートの転送を物理的に外部のホーム仮想ファームに構成できない場合です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1つの解決策は、サードパーティのVPNサービスを使用することです。残念ながら、トンネルに関して着信接続の許可を許可するものはほとんどありません。ほとんどの場合、それは別個の有料サービスです。また、この場合、特定の国で外部IPアドレスが存在する状況をテストする場合、外部IPアドレスの選択は非常に制限されます。さらに、原則として、他のVPNサービスクライアントの束が同時にこのアドレスでハングしないという保証はありません。 、または長期間静的であり、これはDNSでサービスサブドメインレコードを設定するために重要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、価値のある（IMHO）は、いくつかの変な方法ですが、ホームハイパーバイザーファームからクラウド内のこの仮想マシンにVPNトンネルを構成する機能を備えた外部クラウドプラットフォームに独自の「仮想」ルーターを展開し、必要な受信接続を外部ネットワークインターフェイスから転送することです。ホームハイパーバイザーサービスへのクラウド。そして理想的には、すべてに対してほとんど何も支払うことはありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最近仕事を失い、暖かく快適な企業のテストファームにアクセスできるようになりましたが、見返りとしてスキルを更新するための多くの自由時間を受け取ったので、ホームハイパーバイザーからのサービスに着信クライアント接続を確認する機会を与えることにしました。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらの行の著者は、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「あらゆる種類のインフラストラクチャの倒錯を愛している」</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、したがって、仮想ルーターとしてLinux用の無料のAmazon Web Services（AWS）EC2 t2.microインスタンスを使用します。AWSの代わりに、VPC（理論上）はデバッグと機能に少し柔軟性を与えます。このVPNバージョンのトポロジーを以下に示します。 ：</font></font><br>
<br>
<img src="https://habrastorage.org/webt/xs/o5/_k/xso5_kg5gwlm9ozy9pj7udiqxuc.png" alt="画像"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここには何が表示されますか？</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AWSにデプロイされたLinux（EC2）には、無料の（年間で月間750時間の作業）仮想マシン（インスタンス）があります。ホームサービスの一部のユーザーからの着信コールはElastic IPの外部ホワイトIPv4アドレスに分類されます。次に、「セキュリティグループ」のインバウンドルールを介して、インスタンスのネットワークインターフェースにマップする必要があるポートを経由し、iptablesを介したこれらのリクエストのパケットはIPSecトンネルを通過します。 Windows 2016の仮想マシン。ルーティングを使用して、RRASはホーム仮想ファーム内の目的のサービスに到達します。一度に3つのNATの存在に特別な注意を払います。1つはAWS Linuxに、もう1つは「オフィスネットワーク」ルーターに、もう1つは暗黙的にホームルーターに存在します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この（私の）ケースでは、Windows Server 2016の下の仮想マシンがルーターの役割を果たし、オフィスネットワークとそのサーバープラットフォームをシミュレートします。MSWAPは、MS ADFSなどを備えた別のマシンと組み合わせてその上に展開されるため、他のOSや他のOSで置き換えることに問題はありません。自家製の作品でも味わえます。ちなみに、Windows RRASでは、逆に状況が複雑になり、さまざまな不快な瞬間（以下について）に対処する必要が生じたため、MS Windows Serverをルーターとして嫌うことを選択した場合、別のオペレーティングシステムでは、おそらくより簡単になります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
AWSアカウントがまだない場合は、最初に作成します。アカウント自体の作成には問題はありません。プラスチックカードの詳細を指定するだけで、そこから1 USDが小切手として引き落とされます（返送されます）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここで言及する必要があるのは2点だけです。</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必ずAWSにアクセスし、IAM（アイデンティティおよびアクセス管理）に移動して、新しいアカウントに対してMFA（多要素認証）を有効にしてください。AWSが推奨しているように、MFAを使用して別のアカウントを作成し、対応する権限の制限に引き続き取り組みます。彼女。</font><font style="vertical-align: inherit;">そうしないと、トロイの木馬がPCからAWS認証情報を盗み、たとえば誰かがあなたの費用で高価な高性能インスタンスプランに略奪するという不愉快な状況に陥る可能性があります...</font></font></li>
<li>        .      ,     «Billing &amp; Cost Management Dashboard».       «Budgets»           .       (alert):      -  .  ,       AWS    «»       .</li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AWS：EC2サービス</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">が必要</font><font style="vertical-align: inherit;">です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最も重要なステップの1つは、仮想マシンをデプロイするAWSリージョン（基本的にはデータセンター）を選択することです。配置は、「仮想ルーター」の地理的な場所に直接影響するため、仮想ルーターを操作するときのネットワーク遅延に影響します。これは重要ですAWSは、リージョン間のライブマイグレーションを提供していません（組み込みの</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AWS Server Migration Service</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、AW​​Sクラウド自体にのみ移行できます）。配置エラーが発生した場合は、目的の場所に新しいインスタンスを再作成する方が簡単です。または、</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">AWS</font></a><font style="vertical-align: inherit;">からイメージ（イメージ、組み込みEC2）を削除する必要があります</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：S3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（ストレージサービス）そして、そこからこのイメージを新しいリージョンのEC2インスタンスにプルします。私の場合、元々</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フランクフルトの</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">地域が選択されていました</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/8c/2s/yh/8c2syhsrly1luamcwjsvbmlnbtg.png" alt="画像"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいインスタンスを作成し、左側</font><font style="vertical-align: inherit;">にある</font><font style="vertical-align: inherit;">[ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">無料枠のみ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]オプションを選択します</font><b><font style="vertical-align: inherit;">。</font></b><font style="vertical-align: inherit;">これにより、画像の提案リストが無料のもののみに制限されます。私が選んだ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「アマゾンのLinux AMI 2018」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以上</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">あるため、AWSでのLinuxディストリビューションについての） 「Amazon Linux 2 AMI」では、Amazonによってアセンブルされたカーネルの性質上、xl2tpdは正しく機能しません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
表示されるリストから、使い慣れた他のLinuxイメージを選択できます。こちらから</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">AWS Marketplaceを</font></a><font style="vertical-align: inherit;">詳しく調べることもできます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代わりの画像を探して、コストに関するコメントを注意深く読んでください。画像自体とコンピューティングリソースは無料で使用できますが、ディスクスペースなどに追加料金を支払う必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
提案されたタイプ</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「t2.micro」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を選択します</font><font style="vertical-align: inherit;">。これは、1 vCPU、1 GBのメモリ、8〜30 GB（SSD /マグネティック）のディスク領域、および750時間の作業を1か月間毎月無料で提供します。 「仮想ルーター」には十分です。空きディスク領域と作業時間はすべてのインスタンスに費やされるため、経済的な問題が発生した場合は、空き容量以外に作成または実行する必要がないことに注意してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
「次へ...」ウィザードをクリックし、3番目のステップではすべてデフォルト値のままにします。4番目では、提案されている8ギガバイトのSSDディスクのデフォルトに同意し、インスタンスは「レビューおよび起動」ボタンで開始します。</font></font><br>
<br>
<img src="https://habrastorage.org/webt/ta/dv/of/tadvofw_fyn1iozzpgvxiwaswla.png"> <br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
メッセージボックスが表示された後SSH経由で接続するための新しいキーペアの作成と、このペアに名前を付け、秘密キーを* .pem形式でダウンロードするという提案。将来的には本当に必要になるので、すぐに安全な場所に保存することをお勧めします。このファイルが失われると、それを使用してインスタンスにリモートで接続できなくなります。 EC2では、既存のインスタンスに対して再生成する方法はありません。唯一の方法は、インスタンスディスクを、アクセスとそれに続くキー編集を行う別のインスタンスに接続することです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
しばらくすると、インスタンスが起動し、内部（プライベート）および外部（パブリック）IPv4アドレスと、2つの対応するDNS名が含まれます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
セキュリティグループをすぐに構成して、</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ex/rh/7y/exrh7yxlnlqsb36u5pdqifxrdb8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要な</font><font style="vertical-align: inherit;">サービスのトラフィックフローを確保します</font><font style="vertical-align: inherit;">。IPSecL2TP VPNトンネルを整理するために受信ポート500、1701、4500 UDP、4500 TCPを開く必要があり、ホームファームサービスを公開するためのHTTPおよびHTTPS、外部からSSHインスタンスへのアクセスが必要でしたインスタンスの作成時に自動的に作成されます。 EC2には基本的に、Webインターフェイスを介した仮想マシンコンソールへの組み込みアクセスは含まれていません。画面を表示する機能しかありません</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/zr/g4/uw/zrg4uw5t3_nihfjq8qaipfwxfkw.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。VPNとSSHを介したアクセスは、ホームIPアドレスからのみ構成することをお勧めします。セキュリティグループ内のルールの順序は重要ではありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我々は無効に推奨しています複数のNATドキュメントAWSを使用しますので、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ネットワークの送信元/宛先チェックを」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">このケースでは</font><font style="vertical-align: inherit;">：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/oa/6m/mg/oa6mmgeh6dyzg6sjxzdj0lkzbne.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我々は、IPSecトンネリングではなく、トランスポートを使用しますので、この設定は、私たちにあまり意味がありませんが、念のためにそれが良いでしょうスイッチを切ります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SSHを介してインスタンスに接続します。接続にSSHグラフィカルクライアント（PuTTYなど）を使用する場合、インスタンスのRMBから呼び出される接続の組み込みヘルプ-&gt;接続が役立ちます</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/dc/tm/s1/dctms1dbkmpble2n5vojwkdq3py.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。AmazonLinuxはRHELとCentOSの血統を維持しているため、yumパッケージマネージャーが使用されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下で説明するすべての操作は、特権の昇格で実行する必要があるため、その前にsudoを実行するか、単にrootとして作業します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初の更新：</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># yum update</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPNサーバーを構成するためのソフトウェアとして、libreswanとxl2tpdを組み合わせて使用​​します。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LibreSwan</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（OpenswanのフォークおよびstrongSwanの類似物）は、VPN IPSecおよびIKE（インターネットキーエクスチェンジ）の人気のある実装です。</font><font style="vertical-align: inherit;">さまざまなタイプのNATとその組み合わせを適切にバイパスできます。これは、IPSecトンネリングを構成するときに特に重要です。</font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xl2tpd</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">も広く使用されています。その主な利点は、接続時にpppを介してクライアント接続パラメーターを認証および送信する組み込み機能（たとえば、IPアドレス、デフォルトのルート設定、dnsサーバーなど）です。これにより、追加のDHCPおよびRadius展開の必要がなくなります単純なタスク。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
xl2tpdは標準のAmazon Linuxリポジトリにないため、EPEL（Enterprise Linuxの追加パッケージ）を有効にする必要があります。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># yum-config-manager --enable epel</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なパッケージをインストールします。</font></font></h3><br>
<pre><code class="bash hljs"><span class="hljs-comment"># yum install libreswan xl2tpd -y</span></code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">カーネルレベルのルーティングを有効にします。</font></font></h3><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/sysctl.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ファイル</font><b><font style="vertical-align: inherit;">に次の</font></b><font style="vertical-align: inherit;">ように記述します。</font></font><br>
<br>
<pre><code class="bash hljs">net.ipv4.ip_forward = 1<font></font>
net.ipv4.conf.all.accept_redirects = 0<font></font>
net.ipv4.conf.all.secure_redirects = 1<font></font>
net.ipv4.conf.all.send_redirects = 0<font></font>
net.ipv4.conf.default.accept_redirects = 0<font></font>
net.ipv4.conf.default.secure_redirects = 0<font></font>
net.ipv4.conf.default.send_redirects = 0<font></font>
net.ipv4.conf.lo.accept_redirects = 0<font></font>
net.ipv4.conf.lo.secure_redirects = 0<font></font>
net.ipv4.conf.lo.send_redirects = 0<font></font>
net.ipv4.conf.eth0.accept_redirects = 0<font></font>
net.ipv4.conf.eth0.secure_redirects = 0<font></font>
net.ipv4.conf.eth0.send_redirects = 0<font></font>
net.ipv4.conf.all.rp_filter = 0<font></font>
net.ipv4.conf.default.rp_filter = 0<font></font>
net.ipv4.conf.eth0.rp_filter = 0<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">再起動しないよう</font><font style="vertical-align: inherit;">
に、現在のセッションで</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rp_filter</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を無効にし</font><b><font style="vertical-align: inherit;">ます</font></b><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># for f in /proc/sys/net/ipv4/conf/*/rp_filter ; do</span>
<span class="hljs-comment">#   echo 0 &gt; $f</span>
<span class="hljs-comment"># done</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
設定を適用し、ルーティングの可用性を確認します。</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment"># sysctl -p /etc/sysctl.conf</span>
<span class="hljs-comment"># cat /proc/sys/net/ipv4/ip_forward</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要なサービスのポートから将来のIPSecトンネルへの（インスタンスのパブリックインターフェイスに関して）着信パケットの転送を確実にする必要があります。</font><font style="vertical-align: inherit;">このため、これらのパケットのNATを</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">解除</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">するだけでなく、</font><b><font style="vertical-align: inherit;">ppp0</font></b><font style="vertical-align: inherit;">インターフェースで</font><font style="vertical-align: inherit;">マスカレードを行う必要があり</font><font style="vertical-align: inherit;">ます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このために</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iptablesの</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">組み込み機能を使用します</font><font style="vertical-align: inherit;">。これは、Amazon Linuxの場合、トラフィックをあらゆる方向に完全に渡すように最初に構成されてい</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。必要なポートをDNATにします。</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment"># iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 80 -j DNAT --to-destination 10.100.0.2:80</span>
<span class="hljs-comment"># iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 443 -j DNAT --to-destination 10.100.0.2:443</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのポートに到着したすべてのパケットをWindowsゲートアドレスに転送します。</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment"># iptables -A FORWARD -p tcp -d 10.100.0.2 --dport 80 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT</span>
<span class="hljs-comment"># iptables -A FORWARD -p tcp -d 10.100.0.2 --dport 443 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これらのパッケージをマスカレードします：</font></font><br>
<pre><code class="bash hljs"><span class="hljs-comment"># iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
iptablesルールを保持して、インスタンスの再起動時にルールが自動的に強化されるようにすることをお勧めします。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># service iptables save</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、インスタンスのネットワークインターフェースeth0から、必要なTCPポートのDNAT（宛先NAT）をIPv4アドレス10.100.0.2の方向に使用します。これは、ホームハイパーバイザーのWindowsゲートのRRASサービスのpppインターフェースのアドレスです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
以下は非常に重要なポイントです。ハイパーバイザー内のサービスはAWSインスタンスから受信したリクエストに応答できる必要があるため、</font><b><font style="vertical-align: inherit;">ppp0</font></b><font style="vertical-align: inherit;">インターフェースでマスカレード（送信者アドレスを置き換える）を提供する必要があります</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">パケットを送信する前のインスタンスの場合、それ以外の場合、応答は完全に異なる方向に進みます。ハイパーバイザーのWindowsゲートウェイからIPSecトンネルを通過して直接デフォルトルーター（ホームルーター）に向かうため、当然ながら、要求していないリソースから送信されたかのように、サービスのクライアント側では破棄されます。 vpnトンネルの入り口にあるパケットヘッダーでマスカレードが使用されている場合、送信者アドレスはインターネット上のどこかのアドレスから</font><font style="vertical-align: inherit;">AWSインスタンスインターフェイスの</font><font style="vertical-align: inherit;">アドレス</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ppp0に</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">変更され</font><font style="vertical-align: inherit;">ます：EC2、つまり私の場合は、10.100.0.1 </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
です。他のLinuxディストリビューションまたは* NIXシステムでiptablesを使用する代わりに、古き良きrinetdを推奨できます。これはすべて、通常</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rinetd.conf構成の</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1行で行われ</font><font style="vertical-align: inherit;">ます。</font></font><br>
<br>
<pre><code class="bash hljs">&lt;ip <span class="hljs-built_in">source</span>&gt; &lt;port <span class="hljs-built_in">source</span>&gt; &lt;ip destination&gt; &lt;port destination&gt;</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、カーネルで有効にする必要があるのは、ルーティング/ NATトラフィックの可能性だけです。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libreswanを調理する時が来ました。</font></font></h3><br><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/ipsec.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ファイルに</font><font style="vertical-align: inherit;">は、/ etc / ipsec.d /からすべて</font><font style="vertical-align: inherit;">の</font><b><font style="vertical-align: inherit;">.conf</font></b><font style="vertical-align: inherit;">ファイル</font><font style="vertical-align: inherit;">をダウンロードするための手順が含まれているため、/ etc / ipsec.d / aws_vpn.confディレクトリに新しい構成ファイルを作成し、それに追加します。</font></font><br>
<br>
<pre><code class="bash hljs">config setup
    <span class="hljs-comment">#      </span>
    <span class="hljs-comment"># plutostderrlog=/var/log/pluto.log</span>
    <span class="hljs-comment"># logfile=/var/log/pluto.log</span>
    <span class="hljs-comment"># plutodebug = all</span>
    <span class="hljs-comment">#  NAT-T -   NAT-</span><font></font>
    nat_traversal=yes<font></font>
    oe=off<font></font>
    protostack=netkey<font></font>
    nhelpers=0<font></font>
    interfaces=%defaultroute<font></font>
<font></font>
conn aws_vpn<font></font>
    <span class="hljs-built_in">type</span>=tunnel<font></font>
    auto=start<font></font>
    forceencaps=yes<font></font>
    pfs=no<font></font>
    fragmentation=yes<font></font>
    authby=secret<font></font>
    left=%defaultroute<font></font>
    <span class="hljs-comment">#   &lt;…&gt;      Elastic IP</span><font></font>
    leftid=&lt;…&gt;<font></font>
    <span class="hljs-comment">#   &lt;…&gt;     (172...)</span><font></font>
    leftsubnet=&lt;…&gt;/32<font></font>
    leftnexthop=%defaultroute<font></font>
    leftprotoport=17/1701<font></font>
    rightprotoport=17/%any<font></font>
    right=%any<font></font>
    rightsubnetwithin=0.0.0.0/0<font></font>
    rightsubnet=vhost:%priv<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
簡単にするために、証明書ではなく共有キー（PSK）に基づくIPSec認証を使用するため、明示的に指定する必要があります。</font><font style="vertical-align: inherit;">ファイル</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/ipsec.secretsに</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">は、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.secretsが/etc/ipsec.d/</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">からすべてのファイルをダウンロードする指示が含まれており</font><font style="vertical-align: inherit;">、新しいファイル</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/ipsec.d/aws_vpn.secrets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font><font style="vertical-align: inherit;">作成</font><font style="vertical-align: inherit;">し、PSK形式でポイントします。</font></font><br>
<br>
<pre><code class="bash hljs">&lt;     172...&gt; %any : PSK <span class="hljs-string">"&lt; PSK&gt;"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例として：</font></font><br>
<br>
<pre><code class="bash hljs">172.31.20.120 %any : PSK <span class="hljs-string">"Pa$<span class="hljs-variable">$w0rd</span>"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ppp接続はIPSecトンネル内で使用され、独自の認証があるため、それ</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
も</font><font style="vertical-align: inherit;">構成し</font><font style="vertical-align: inherit;">ます</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">ユーザー名とパスワードをファイル</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ etc / ppp / chap-secrets</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">に次の形式で入力します。</font></font><br>
<br>
<pre><code class="bash hljs">&lt;user&gt; * &lt;password&gt; *</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例として：</font></font><br>
<br>
<pre><code class="bash hljs">aws_user        *       Pa$<span class="hljs-variable">$w0rd</span>        *</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
pppクライアントに接続するときに、ネットワークインターフェースとそのルーティングテーブルを構成するためのいくつかのオプションを渡すことができます。</font><b><font style="vertical-align: inherit;">/etc/ppp/options.xl2tpd</font></b></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
ファイルで、</font><font style="vertical-align: inherit;">次のオプション</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">を</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">設定します。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment">#  xl2tpd  ip  </span><font></font>
ipcp-accept-local<font></font>
ipcp-accept-remote<font></font>
<span class="hljs-comment">#    defaultroute   Windows-   </span><font></font>
nodefaultroute<font></font>
noccp<font></font>
auth<font></font>
<span class="hljs-comment">#   RRAS  Windows-  mschap-v2  </span><font></font>
require-mschap-v2<font></font>
<span class="hljs-comment">#   MTU  MRU </span><font></font>
mtu 1410<font></font>
mru 1410<font></font>
lock<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
なぜならdns、winsなどのアドレスをクライアントに渡す必要はありません。事-他のすべてのオプションはコメント化する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、構成の説明が必要です。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
VPN接続の標準的な動作は、クライアントテーブルに新しいデフォルトルートをインストールすることです。これにより、VPNからインターネットへのすべてのトラフィックが、VPNサーバーを経由して「送信」されます。私たちの場合、これは間違っています。 Windowsゲートの目標は、ハイパーバイザーの背後にある仮想オフィスネットワークのインターネットへのシミュレーションアクセスを提供し、AWS：EC2を介して内部サービスのリソースを外部に公開することです。そのため、インスタンスを介してすべてのトラフィックをAWS：EC2に送るのは非合理的です。そのため、RRASのVPN接続が（ホームルーターへの）デフォルトルートを変更しないようにする必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
また、正しいMTU値とMRU値を選択することも重要です。IPSecトンネリングを使用しており、ペイロードサイズが大きすぎると、カプセル化の制限に適合せず、断片化が発生し、エラーが発生する可能性が高くなります。</font><font style="vertical-align: inherit;">表示された場合は、まずこれらの値を、たとえば1280に減らしてみてください。特定の構成に示されている値は、Windows VPNクライアントと互換性があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xl2tpdを構成するために残ります</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
構成ファイルxl2tpd </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/xl2tpd/xl2tpd.confで</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必要なすべてを構成します</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs">[global]<font></font>
port=1701<font></font>
ipsec saref = yes<font></font>
; ,     <font></font>
;debug tunnel = yes<font></font>
;debug avp = yes<font></font>
;debug network = yes<font></font>
;debug state = yes<font></font>
;debug tunnel = yes<font></font>
<font></font>
[lns default]<font></font>
name = AWSvpnServer<font></font>
;       ppp<font></font>
ip range = 10.100.0.2-10.100.0.2<font></font>
;    ppp0 AWS:EC2 <font></font>
<span class="hljs-built_in">local</span> ip = 10.100.0.1<font></font>
require authentication = yes<font></font>
require chap = yes<font></font>
refuse pap = yes<font></font>
pppoptfile = /etc/ppp/options.xl2tpd<font></font>
length bit = yes<font></font>
</code></pre><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">私たちが行ったすべてをチェックします</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
私たちは両方のサービスを実行して設定をチェックしようとします：</font></font><br>
<br>
<pre><code class="bash hljs">service ipsec start<font></font>
service xl2tpd start<font></font>
ipsec verify<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サービスはすでに実行されている可能性があり、その場合は単に再起動されます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが順調であれば、ipsec verifyの出力はスクリーンショットのようになり</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/o1/rv/br/o1rvbrchcizb6jn9qewgrj_hrn4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。xl2tpdを-Dスイッチで実行し、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">screen</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ユーティリティを使用してSSHターミナルの別の「ウィンドウ」にぶら下げて対話的にデバッグできます</font><font style="vertical-align: inherit;">。</font></font><br>
<br>
<pre><code class="bash hljs"><span class="hljs-comment"># xl2tpd -D</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この場合、xl2tpdプロセスはバックグラウンドに移行せず、すべてのアクティビティを端末画面に表示します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
問題が発生した場合は、configsのデバッグオプション（コメントを参照）のコメントを外して、システムログと</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/var/log/pluto.log</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイルの内容を確認する必要があります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">また、オプション</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">virtual_private / virtual-private</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ファイル</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/ipsec.conf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">の内容にも注意し</font><font style="vertical-align: inherit;">てください。IPSecを介した通信に使用できるすべてのプライベートネットワークが一覧表示されます。</font><font style="vertical-align: inherit;">何らかの理由で独自のアドレッシングがある場合、たとえば、ホワイトIPv4アドレスの独自のプールを使用する場合は、このパラメーターを変更する必要があります。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最後のステップに進みましょう-WindowsゲートでのRRASサービスの設定とインターネットからのサービスの公開の確認</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ホームハイパーバイザーには、Windows 2012R2以降を実行し、グラフィカル（デスクトップ）モードで展開された仮想マシンがあり、この仮想マシンには2つのネットワークアダプターがあると仮定します。1つはホームネットワークを「検索」し、デフォルトのホームルーターをルートとします。もう1つは仮想ローカル「オフィス」ネットワークになり、外部でサービスが公開されます。サービス自体が必要としない限り、Windowsドメインはオプションです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
サーバーマネージャーまたはPowerShell </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install-WindowsFeature</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">コマンドレットを使用</font><font style="vertical-align: inherit;">して、必要なすべての役割を</font><b><font style="vertical-align: inherit;">インストールし</font></b><font style="vertical-align: inherit;">ます。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/lv/vw/ul/lvvwull1qus2dpgplvaxfvjv_gq.png"><img src="https://habrastorage.org/webt/pc/ag/80/pcag80h9dc8jq6gtim8jbdoeseq.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ここでは、グラフィックスによる役割のインストールを示します。これは、サーバーマネージャーからセットアップウィザードを呼び出して、スケジュールでRRASサービス自体を構成する方がはるかに便利です。これにより、Windows Server 2003の時代からの古き良きインターフェイスが喜ば</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ai/rx/hz/airxhzrmjcbvyopop4rt_rcu4ga.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
れます。サーバーでRMBをクリックし、</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">「ルーティングとリモートアクセスの構成と有効化」</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">、次に手動構成：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/na/gj/bc/nagjbch0d6jxmyjzgywhnqqe17s.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてのDAWを選択し、ウィザードを完了してサービスを開始します。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ku/ir/sq/kuirsqjvnmskwfjrikybcl2kacu.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初に、仮想ローカルエリアネットワークを外部に解放します。 IPv4-&gt; NATに進み、新しいインターフェースを作成します。NATが実装される既存のインターフェースとして、外部インターフェース（インターネットまたはホームネットワーク内にある）を選択し、パブリックとしてマークし、NATを有効にします。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/gk/zh/lx/gkzhlxjyvjsgkhdnfvaqyhcn3xo.png"><img src="https://habrastorage.org/webt/kw/wx/xw/kwwxxw5u1gtezu2moo-3beokuli.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
仮想LANからのトラフィックがどのようにゲートを通過するかを確認します。まだWindowsファイアウォールを構成する必要はありません。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべて問題なければ、AWSインスタンスへのVPN接続のために戦うものを最終的に作成し、サービスの公開を確認します。 RRASスナップインで[ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ネットワークインターフェイス]に移動</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">し、任意の名前で新しいデマンドダイヤルインターフェイスを作成し</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/-v/04/yx/-v04yxa-najhry2evwovvtydsby.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ます。L2TP接続をすぐに選択するため、新しいインターフェイスはVPNの種類を自動的に判別せず、その結果、接続が速くなります。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/jg/mw/xb/jgmwxbg1nzbih2grilgopxrlfv8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
次に、ウィザードで、パブリックアドレスを指定します。クラウド（私の場合はElastic IP）。次の手順では、すべてをそのままにしておきます。サイト間の接続は必要ありません。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/fa/fn/p7/fafnp7fmggqxnbmosjcpdkx1wck.png"><img src="https://habrastorage.org/webt/d1/zc/wm/d1zcwmsgomejupu7if4ynp2rqjk.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ppp接続を構成したユーザーアカウントを指定します（ファイル</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ etc / ppp / chap-secretsで</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。ドメイン名は必要ありません</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/zc/to/ei/zctoei91of_eyji6fncqhgvcii4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。ウィザードは新しい接続を作成します。今はそれを構成するために残ります。アイドルタイムアウト（アイドル時間）を調整し、MS-CHAPv2だけを優先して古いCHAPを削除し、「詳細プロパティ」でPSKキーを指定します（/etc/ipsec.d/aws_vpnでxl2tpdに設定されたもの）。シークレット）とIPv6の削除：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/a0/qf/tf/a0qftfatglil4qkjv-hyn5hzvlc.png"><img src="https://habrastorage.org/webt/ax/hy/hu/axhyhuwgchr9z2vhmel17jjbx1s.png"><img src="https://habrastorage.org/webt/vq/xl/qz/vqxlqzejzpi3rs0i9x0r5ol9fkg.png"><img src="https://habrastorage.org/webt/km/ro/um/kmroumh0brc2_yq3przzb-a7jm8.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
新しいインターフェイスを作成した後、RRASサービス自体のプロパティに移動し、L2TPのIPSecポリシーを有効にして、PSKを指定する必要もあります。 RRASサービスを再起動するように求められます。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/h8/0w/zk/h80wzkz1pfymizhrqruvwrgj9di.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが安全に新しいインターフェースを上げて、仕事を楽しむことができるように思えます。しかし、違います。 AWS：EC2インスタンスの側でNATを使用したため、Windows VPNクライアントはそのようなNat-Traversalノードに接続できません。これは、クライアントバージョン（Windows 10ビルドのこの記事の執筆時点で最新のものまで）とサーバーバージョンの両方に当てはまります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
幸いなことに、この問題を公式ソリューションは、IPSecポリシーのサービス設定、レジストリを編集し、その後、再起動の形で存在している：</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
で</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ます。HKEY_LOCAL_MACHINE \ System \ CurrentControlSet \ Servicesの\ポリシーエージェントは、</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
DWORD（32ビット）の鍵を作成</font></font><br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 2 AssumeUDPEncapsulationContextOnSendRuleを</font></font></b><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
、私たちのWindowsの門を再起動します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
残念ながら、RRASサービスは構成と操作の気まぐれさで有名であり、再起動後も遅延起動を実行します。だから、あなたは再起動後にそれを急ぐことができます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
すべてが正しく行われている場合、接続は5〜10秒以内に機能します。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Windowsゲート自体に必要なリソースを公開する必要があります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
テストでは、Webサーバーの公開を確認します。まず、IPSecトンネルとiptablesルールを確認してください。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
震えている手で、インターネットに接続された任意のPCから確認します。</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ho/yg/c-/hoygc-blrya-dt30hytsmdruezg.png"><img src="https://habrastorage.org/webt/8v/yc/q7/8vycq7c2bsc6dqjcc3t7qzcacje.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
うわー、動作します... </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
必要な役割のインストール中に、「ネイティブ」のMS IISが強制的にインストールされましたが、さらに簡単にしたいのです。</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;">HFS</font></b></a><font style="vertical-align: inherit;">は、Windowsプラットフォームでのこれに適しています。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><b><font style="vertical-align: inherit;"></font></b></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（HTTPファイルサーバー）-無料で、インストールは不要で、特定のページとHTTPヘッダーが表示され、任意のポートで動作できます（デフォルトでは8080なので、この場合は80に再構成する必要があります）。また、コンソールのどこからでも書き込むことができます。接続が発生しました。これは、Windowsプラットフォームで多くのWebリソースの公開をデバッグするのに非常に便利です。</font><font style="vertical-align: inherit;">これを使用するには、最初にMS IISサイトを停止して、組み込みサーバーを必要なポートから解放する必要があります。</font><font style="vertical-align: inherit;">MS IIS管理コンソールをインストールしたくないので（実際、互換性のためにMS IIS 6コンソールが存在しますが、IIS 7+はそれを介して制御できません）、PowerShellを介してこれを実行します。</font></font><br>
<br>
<pre><code class="bash hljs">Stop-WebSite -Name <span class="hljs-string">"Default Web Site"</span></code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
または単にiisreset管理ユーティリティを介して：</font></font><br>
<br>
<pre><code class="bash hljs">iisreset /stop</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
その後、組み込みのWindowsファイアウォールでポート80への着信トラフィックを許可する必要があります。HFS </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
を起動して、次のことを確認します</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/ti/u2/bc/tiu2bcpm3ynhzteryfe9njxvfq4.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
。インターネット上のどこからでも、自宅にあるWebサーバーを任意のハイパーバイザーの仮想マシンとして見ることができます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後の仕上げ：RRASに、このようなすべての要求を外部から仮想オフィスネットワークに転送するように指示します。伝説によれば、別のWebサーバーがあります。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
これを行うには、VPNインターフェイスのIPv4-&gt; NATおよびRMBで再度RRAS管理スナップインに移動します。ここで、[ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">サービスとポート</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]タブを選択</font><font style="vertical-align: inherit;">し、リストでWebサーバーをマークして、リソースを公開する内部仮想ネットワーク内のWebサーバーを指定しますインターネット：</font></font><br>
 <br>
<img src="https://habrastorage.org/webt/d7/bq/jv/d7bqjv0ir3a2l8w4vzxpdax8nra.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
[OK]をクリックすると、すべての準備が整います。チェックします-すべてが正常に動作するはずです。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
このような単純な方法で、サイト、メールサーバー、複雑な統合など、ほとんどすべてのサービスとリソースをすばやく公開できます。当然のことながら、ほとんどの場合、サブドメインを作成して必要なレコードを編集できる独自のDNSドメインが必要です。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LetsEncrypt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">や類似のACME互換サービスの</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">おかげで</font></a><font style="vertical-align: inherit;">、Webリソースの公開にはSSL証明書を使用することをお勧めし</font><font style="vertical-align: inherit;">ます。これらはすべて、完全に無料で、自動更新で実行できます。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
インスタンスを再起動しても、パブリックIPv4アドレスは変更されません-停止した場合のみですが、AWS：EC2で静的IPv4アドレスを使用することをお勧めします。</font><font style="vertical-align: inherit;">インスタンスをオフにしてもインスタンスは割り当てられたままであり、一般的なフリープールに分類されないという意味で静的です。</font><font style="vertical-align: inherit;">もちろん、これは毎回ドメイン内のDNSレコードの再構成に煩わされないようにするために必要であり、キャッシュを使用してTTLをキャンセルする人はいません。</font><font style="vertical-align: inherit;">これには多額の費用がかかり、すでに上記のように</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elastic IP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">と呼ばれてい</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;">ます</font></a><font style="vertical-align: inherit;">。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">プリミティブプロセスの自動化</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最後に、AWSのもう1つの優れた機能であるEC2-デプロイされたインスタンスのクイック構成について触れておきます。 AWSには多くのクイックデプロイオプションがあります：EC2から特別な（そしてかなり複雑ですが非常に強力な）サービスまでですが、最も単純なものがあります</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">下部に新しいインスタンスを作成するためのウィザードのステップ3にあるのが</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ユーザーデータ]</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">フィールド</font><font style="vertical-align: inherit;">です。スクリプトをbashまたはPowerShell（Windowsのインスタンスの場合）に入れることができます。このスクリプトは、インスタンスの作成直後に自動的に実行されます。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
それら。上記のすべてのコマンドと構成をわずかに変更して独自のbashスクリプトを作成し、それを使用してそのような仮想AWS：EC2ルーターをすばやく起動できます。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ja&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">この機能の詳細をご覧ください</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
この記事を読んでいただきありがとうございます。</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ja470027/index.html">VKハッカソン2019（現状のまま）</a></li>
<li><a href="../ja470029/index.html">極度の教育学：長期治療で子供と一緒に働くことについて「教える」</a></li>
<li><a href="../ja470033/index.html">F＃2：FSI環境</a></li>
<li><a href="../ja470035/index.html">妄想ジェネレータ：ニューラルネットワークを使用して任意の言語でテキストを作成します</a></li>
<li><a href="../ja470037/index.html">F＃3：テキストのフォーマット</a></li>
<li><a href="../ja470051/index.html">神経科学：私たちの脳が最もよく機能するとき、テクノロジーがどのようにそれを助けることができるか</a></li>
<li><a href="../ja470055/index.html">Visual Studio for MacでのソリューションレベルのNuGetパッケージ管理の紹介</a></li>
<li><a href="../ja470057/index.html">Visual Studio for Mac：5つのクールな新機能</a></li>
<li><a href="../ja470061/index.html">より少ないコードを記述し、より理解を深める方法</a></li>
<li><a href="../ja470063/index.html">SMSと登録なしのサイバーセマンティクス</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>