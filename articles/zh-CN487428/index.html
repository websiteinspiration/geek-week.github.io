<!doctype html>
<html class="no-js" lang="zh-CN">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛸️ ✒️ 💆🏽 在Yandex.Music机器人客户端的幕后 🥁 🗽 🕴🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="介绍
 哈Ha！再次，我涉及影响Yandex.Music API的第二篇文章。该案已计划并在第一篇文章中提到。
 
 伸手，完成。我认为，今天我将谈论我的Telegram机器人代码库中存在的有趣时刻，这些时刻将自己定位为成熟的音乐客户端。我们还将触摸Yandex音乐识别API。
 
 在逐一介绍特定...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>在Yandex.Music机器人客户端的幕后</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/487428/"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">介绍</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
哈Ha！</font><font style="vertical-align: inherit;">再次，我涉及影响Yandex.Music API的第二篇文章。</font><font style="vertical-align: inherit;">该案已计划并在</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一篇文章中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">提到</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
伸手，完成。</font><font style="vertical-align: inherit;">我认为，今天我将谈论我的Telegram机器人代码库中存在的有趣时刻，这些时刻将自己定位为成熟的音乐客户端。</font><font style="vertical-align: inherit;">我们还将触摸Yandex音乐识别API。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在逐一介绍特定事物的实现之前，有必要对机器人本身及其功能进行一些了解。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">客户端视频演示</font></font></b><div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/YOw9hs8tFg0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在主要部分中，我将讨论以下内容：</font></font><br>
<br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub Pages</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上的站点登录您的帐户</font><font style="vertical-align: inherit;">（为什么和为什么）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据格式，其包装以及在按钮数据中使用。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更新路由，数据版本控制，将上下文放入处理程序中。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">服务：</font></font><ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram中的服务重装轨道。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“订阅”服务接收带有发送下载状态的曲目。</font></font></li>
</ul></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最简单，最优雅的查询缓存实现。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过语音消息识别轨道以及它在机器人中的一般显示方式。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">小笔记。</font></font></li>
</ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果您对至少一点感兴趣-欢迎加入。</font></font><br>
<img src="https://habrastorage.org/webt/uv/4s/a3/uv4sa3pslohuzlmuzrjzteju2dk.png"><a name="habracut"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该漫游器与已登录其帐户的用户一起使用，但没有。</font><font style="vertical-align: inherit;">一切都围绕四个主要服务类别：专辑，艺术家，播放列表和曲目。</font><font style="vertical-align: inherit;">支持所有实体数据，页面选择分页。</font><font style="vertical-align: inherit;">要与他们互动，授权用户可以使用他们的个人菜单，其中包括：智能播放列表，“我喜欢”播放列表以及他们自己的播放列表。</font><font style="vertical-align: inherit;">对于未经授权的用户，搜索可用-将搜索查询作为常规消息发送。</font><font style="vertical-align: inherit;">现在只有一堆干货了：通过直接链接接收曲目和其他对象，接收歌词，喜欢/不喜欢曲目和艺术家的能力，查看相似的曲目，通过语音消息识别曲目等等。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">主要部分</font></font></h2><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.登录到帐户</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初，该机器人没有计划在未经授权的情况下工作，因此，即使在设计过程中，也要通过</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其网站来</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">决定如何进行授权</font><font style="vertical-align: inherit;">。主要论点是安全性和透明度。在任何情况下都绝不想接受明文消息中的用户登录名和密码。并且来自用户计算机的授权是基本的。因此，在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">React</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上写了一个授权站点</font><font style="vertical-align: inherit;">。这是一种授权形式，具有重定向回机器人的重定向。用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Python</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从库中提取了一个带有验证码授权和处理的片段，</font><font style="vertical-align: inherit;">并用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JavaScript</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重写了</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
为了进行授权，将使用接收到的OAuth令牌，该令牌会通过</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">深层链接</font></a><font style="vertical-align: inherit;">传输回机器人</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重定向的最终链接如下所示：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/music_yandex_bot?start={oauth_token}</font></font></i><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
我想要最好的，但是用户没有信任。只有十分之一的用户得到了授权（当时是强制性的）。因此，在进行以下更新时，我不得不解释为什么您应该信任。有关</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTPS的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所有项目</font><font style="vertical-align: inherit;">（仅有关客户端请求和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开放源代码</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的项目）已在网站上发布以进行授权，并在bot的欢迎消息中重复出现。好多了。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
另外，在授权率较低的因素中，事实证明，俄罗斯t.me的镜像无法访问，并且仅支持订阅用户（在注释的第7段中对此进行了详细介绍）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
第一项使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">URI</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tg：//</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">进行了解析</font><font style="vertical-align: inherit;">，并且在紧要关头，已经存在指向镜像的链接（如果自动重定向不起作用并且按钮没有帮助），第二项再次位于项7中。</font></font><br>
<img src="https://habrastorage.org/webt/ez/2_/0j/ez2_0japfosbu9k4bjelikl8x-i.png"><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.数据格式</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于这个机器人，我第一次决定使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NoSQL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> DB- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。理解：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">嵌入</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档时，不</font><i><font style="vertical-align: inherit;">嵌入</font></i><font style="vertical-align: inherit;">时。喜欢与mongoengine一起工作。但是我真的不想在家里存储所有按钮数据，并且客户端</font><font style="vertical-align: inherit;">在数据库中</font><font style="vertical-align: inherit;">只有</font><font style="vertical-align: inherit;">记录</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。我对数据量感到害怕，但是我想购买一台免费的Mongo服务器，其数据存储限制为512 MB。如果数据在多个按钮中匹配，要想很好地重用记录并清除过时的记录，比将所有内容存储在按钮本身中要困难得多。在分析了要存储的数据的大小之后，我得出结论认为它很容易适应。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
起初，我只是使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSON</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但是当他遇到极限时，他很快就拒绝了。在Telegram中，按钮数据的内容在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UTF-8中</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最多不能超过64个字节</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，在朋友的提示下，我开始</font><font style="vertical-align: inherit;">从</font><i><font style="vertical-align: inherit;">struct</font></i><font style="vertical-align: inherit;">模块</font><font style="vertical-align: inherit;">查看</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pack</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。因此，查询的类型就诞生了，原始格式，打包和拆包。现在，它在机器人中的绝对位置得到了广泛使用。</font><font style="vertical-align: inherit;">
格式很简单。第一个字节是类型，第二个字节是版本。其他所有内容都是特定类型的数据。类型存储为Enum，具有</font><i><font style="vertical-align: inherit;">ID</font></i><font style="vertical-align: inherit;">，这是第一个字节。除了</font><i><font style="vertical-align: inherit;">ID之外</font></i><font style="vertical-align: inherit;">，每种类型还具有打包和拆包数据的格式。例如：键入</font><i><font style="vertical-align: inherit;">SHOW_TRACK_MENU</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其格式的值为“ s？”，其中“ s”是轨道的唯一标识符，而“？” -曲目中是否有文字。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在使用的字符串类型的轨道，因为：第一，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">轨道的可以是一个并置</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和专辑</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">轨道通过结肠，其次，它可以是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">所述UUID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。具有</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UUID的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">轨道</font><font style="vertical-align: inherit;">-自加载轨道，仅对下载它们的用户可用。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
例如，由于数据并不总是与格式相对应，因此相同的</font><font style="vertical-align: inherit;">轨道</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以简单地由数字表示，在打包之前必须将其强制转换为格式的类型。在这种情况下，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，在该类中，有一个方法可以对传输的数据进行规范化以进行打包，以免在传递给构造函数时自己做。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
字符串是自给自足的，可以在包装时指示其长度，而在拆箱时可以考虑此长度。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
没有计划支持较早版本，因此如果版本不匹配，则会引发异常。</font><font style="vertical-align: inherit;">在处理更新时（将在下一段中讨论），将调用必要的逻辑。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于Telegram仅使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UTF-8</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因此打包的数据在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base85中进行</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编码</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">是的，我在这里失去了速度，并且在不使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base64的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">情况下节省了最小的空间</font><font style="vertical-align: inherit;">，但是鉴于数据量较小，我认为使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">base85是</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">合适的。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">资源。</font><font style="vertical-align: inherit;">文件callback_data.py</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> struct
<span class="hljs-keyword">import</span> base64<font></font>
<font></font>
<span class="hljs-keyword">from</span> ext.query_types <span class="hljs-keyword">import</span> QueryType<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadDataVersion</span>(<span class="hljs-params">Exception</span>):</span>
    <span class="hljs-keyword">pass</span><font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CallbackData</span>:</span>
    ACTUAL_VERSION = <span class="hljs-number">7</span>
    BASE_FORMAT = <span class="hljs-string">'&lt;BB'</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, type_: QueryType, data=None, version=None</span>):</span><font></font>
        self.type = type_<font></font>
        self.version = version <span class="hljs-keyword">or</span> CallbackData.ACTUAL_VERSION<font></font>
        self.data = data<font></font>
<font></font>
        <span class="hljs-keyword">if</span> self.data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> isinstance(self.data, list):<font></font>
            self.data = [self.data]<font></font>
<font></font>
        <span class="hljs-keyword">if</span> self.data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            self.data = self._normalize_data_to_format(self.data)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f'&lt;CallbackData&gt; Type: <span class="hljs-subst">{self.type}</span> Version: <span class="hljs-subst">{self.version}</span> Data: <span class="hljs-subst">{self.data}</span>'</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_normalize_data_to_format</span>(<span class="hljs-params">self, data, bytes_object=False</span>):</span><font></font>
        normalized_data = data.copy()<font></font>
        <span class="hljs-keyword">for</span> i, c <span class="hljs-keyword">in</span> enumerate(self.type.format):<font></font>
            cast = str<font></font>
            <span class="hljs-keyword">if</span> c.lower() <span class="hljs-keyword">in</span> <span class="hljs-string">'bhilqn'</span>:<font></font>
                cast = int<font></font>
            <span class="hljs-keyword">elif</span> c <span class="hljs-keyword">in</span> <span class="hljs-string">'efd'</span>:<font></font>
                cast = float<font></font>
            <span class="hljs-keyword">elif</span> c == <span class="hljs-string">'?'</span>:<font></font>
                cast = bool<font></font>
<font></font>
            casted = cast(data[i])<font></font>
            <span class="hljs-keyword">if</span> bytes_object <span class="hljs-keyword">and</span> cast == str:<font></font>
                casted = casted.encode(<span class="hljs-string">'utf-8'</span>)<font></font>
            normalized_data[i] = casted<font></font>
<font></font>
        <span class="hljs-keyword">return</span> normalized_data<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode_type</span>(<span class="hljs-params">callback_data</span>):</span>
        decoded = base64.b85decode(callback_data.encode(<span class="hljs-string">'utf-8'</span>))<font></font>
        type_, version = struct.unpack(CallbackData.BASE_FORMAT, decoded[:<span class="hljs-number">2</span>])<font></font>
<font></font>
        <span class="hljs-keyword">if</span> CallbackData.ACTUAL_VERSION != version:
            <span class="hljs-keyword">raise</span> BadDataVersion()<font></font>
<font></font>
        <span class="hljs-keyword">return</span> QueryType(type_), version, decoded<font></font>
<font></font>
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode</span>(<span class="hljs-params">cls, type_, version, decoded</span>):</span>
        start, data = <span class="hljs-number">2</span>, []<font></font>
<font></font>
        <span class="hljs-keyword">if</span> start &lt; len(decoded):<font></font>
            format_iter = iter(type_.format)<font></font>
<font></font>
            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
                <span class="hljs-keyword">if</span> start &gt;= len(decoded):
                    <span class="hljs-keyword">break</span><font></font>
<font></font>
                format_ = next(format_iter, type_.format[<span class="hljs-number">-1</span>])<font></font>
<font></font>
                decode_str = format_ <span class="hljs-keyword">in</span> <span class="hljs-string">'ps'</span>
                <span class="hljs-keyword">if</span> decode_str:
                    <span class="hljs-comment"># struct.calcsize('b') = 1</span>
                    length = list(struct.unpack(<span class="hljs-string">'b'</span>, decoded[start: start + <span class="hljs-number">1</span>]))[<span class="hljs-number">0</span>]<font></font>
                    start += <span class="hljs-number">1</span><font></font>
<font></font>
                    format_ = <span class="hljs-string">f'<span class="hljs-subst">{length}</span><span class="hljs-subst">{format_}</span>'</span><font></font>
<font></font>
                step = struct.calcsize(format_)<font></font>
<font></font>
                unpacked = list(struct.unpack(<span class="hljs-string">f'<span class="hljs-subst">{format_}</span>'</span>, decoded[start: start + step]))
                <span class="hljs-keyword">if</span> decode_str:<font></font>
                    unpacked[<span class="hljs-number">0</span>] = unpacked[<span class="hljs-number">0</span>].decode(<span class="hljs-string">'UTF-8'</span>)<font></font>
<font></font>
                data += unpacked<font></font>
                start += step<font></font>
<font></font>
        <span class="hljs-keyword">return</span> cls(type_, data <span class="hljs-keyword">if</span> data <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>, version)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">encode</span>(<span class="hljs-params">self</span>):</span><font></font>
        encode = struct.pack(self.BASE_FORMAT, self.type.value, self.version)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> self.data <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<font></font>
            format_iter = iter(self.type.format)<font></font>
            normalized_data = self._normalize_data_to_format(self.data, bytes_object=<span class="hljs-literal">True</span>)<font></font>
<font></font>
            <span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> normalized_data:<font></font>
                format_ = next(format_iter, self.type.format[<span class="hljs-number">-1</span>])<font></font>
<font></font>
                <span class="hljs-keyword">if</span> format_ <span class="hljs-keyword">in</span> <span class="hljs-string">'ps'</span>:
                    <span class="hljs-comment">#        .  'b'  </span>
                    <span class="hljs-comment"># -      ,    &gt; 36 </span>
                    encode += struct.pack(<span class="hljs-string">'b'</span>, len(data))<font></font>
                    encode += struct.pack(<span class="hljs-string">f'<span class="hljs-subst">{len(data)}</span><span class="hljs-subst">{format_}</span>'</span>, data)
                <span class="hljs-keyword">else</span>:<font></font>
                    encode += struct.pack(<span class="hljs-string">f'<span class="hljs-subst">{format_}</span>'</span>, data)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> base64.b85encode(encode).decode(<span class="hljs-string">'utf-8'</span>)<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.路由更新和上下文</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该项目使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">python-telegram-bot</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">与</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Telegram Bot API配合使用</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">它已经有一个系统来注册处理程序，以处理已到达的某些类型的更新，用于正则表达式，命令的过滤器等。</font><font style="vertical-align: inherit;">但是，鉴于我自己的数据格式和类型，我必须继承自</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TelegramHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并实现我的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
更新和上下文通过参数传递给每个处理程序。</font><font style="vertical-align: inherit;">在这种情况下，我有自己的上下文，它在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler'e中</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它正在形成，这是：接收用户和/或将用户添加到数据库，检查令牌的相关性以获取对音乐的访问权限，并根据授权状态和订阅的可用性来初始化Yandex.Music客户端。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在我的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Handler'a之外，还有</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更多特定的处理程序，例如</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CallbackQueryHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。有了它，就为某个特定类型的更新（我的类型，具有数据格式）注册了处理程序。为了检查此更新是否适合当前的处理程序，不是解压缩所有数据，而是仅解压缩前两个字节。在此阶段，已确认需要启动回调。仅在需要启动回调的情况下-数据才完全解压缩并作为</font><i><font style="vertical-align: inherit;">kwargs</font></i><font style="vertical-align: inherit;">传输</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">交给最终处理者。</font><font style="vertical-align: inherit;">立即将分析数据发送到</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ChatBase</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
注册是按顺序进行的，并且谁会更早注册的优先级更高（实际上，就像在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Django</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">路由中以及在其他项目中一样）。</font><font style="vertical-align: inherit;">因此，为过时版本注册处理程序是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CallBackQuery</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">处理程序中的第一项</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
处理过时版本的逻辑很简单-告知用户此信息并发送更新的数据（如果可能）。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.服务</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
当机器人在一个控制类中启动时，所有服务都将初始化，然后在机器人（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DJ</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">中的任何地方普遍使用它</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
每个服务都有其自己的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ThreadPoolExecutor，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其中包含一定数量的工作</font><i><font style="vertical-align: inherit;">线程</font></i><font style="vertical-align: inherit;">，这些任务将提交到该工作</font><i><font style="vertical-align: inherit;">线程</font></i><font style="vertical-align: inherit;">中。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在电报中重新加载曲目</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
目前，此服务尚未重写为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">User Bot，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以绕过Telegram中下载文件大小的限制。事实证明，在Yandex.Music中，有超过50 mb的文件-播客。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该服务检查文件大小，如果文件过大，则向用户发出警报。多亏了第5段中描述的缓存系统，这可以检查歌词的可用性和接收情况。曲目也会被缓存。文件的哈希存储在数据库中。如果存在，则发送具有已知缓存的音频。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
如果数据库中没有文件，则会从Yandex.Music接收直接链接。尽管目前，用户无法更改质量设置，但所有设置都设置为标准值。通过用户设置中的比特率和编解码器搜索文件。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
该文件及其封面将以</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tempfile.TemporaryFile（）的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形式下载</font><font style="vertical-align: inherit;">，然后将其上传到Telegram。</font><font style="vertical-align: inherit;">值得注意的是，TG并不总是能够正确识别曲目的持续时间，但我通常对艺术家和标题保持沉默。</font><font style="vertical-align: inherit;">因此，这些数据取自Yandex，幸运的是，可以将它们传输到购物车。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
通过此服务发送音频文件时，将调用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finish_callback（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，通过订阅向服务发出有关下载结束的信号。</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">订阅服务，用于接收曲目并发送下载状态</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
曲目不会立即加载。多个用户可能请求相同的曲目。在这种情况下，首先请求曲目的用户是曲目的发起者和所有者。重新加载一秒钟以上时，下载状态开始：“用户发送语音消息”。要求相同曲目的其他用户是普通订户。它们与所有者一样，每〜4秒发送一次下载状态，以便消息不会中断（状态挂起5秒钟）。所有者的曲目下载完成后，就会</font><font style="vertical-align: inherit;">从上面的服务中</font><font style="vertical-align: inherit;">调用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finish_callback（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。之后，所有订户将从状态列表中删除，并接收下载的曲目。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在体系结构解决方案中，轨道的所有者也是订户，但具有一定的标记，因为发送轨道的方式不同。</font></font><br>
<br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.查询缓存</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
就像我在上一篇文章中提到的那样，对Yandex.Music API的请求非常繁重。曲目列表可以是3或5 mb。而且，只有很多请求。每次更新处理时，至少有2个请求被发送到Yandex：用于初始化客户端和执行特定操作。在某些地方，要收集足够的信息（例如，用于播放列表），您需要请求一个播放列表，接收其曲目，从登录页面获取信息（如果这是一个智能播放列表），并且不要忘记客户端的初始化。通常，在请求数量方面会让人感到恐惧。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我想要一种非常通用的东西，而不是为某些对象（相同的客户端）进行任何类型的存储。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
由于该库允许您在</font><i><font style="vertical-align: inherit;">请求之外</font></i><font style="vertical-align: inherit;">指定自己的实例来执行查询</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后我利用了这一点。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
重点很简单。缓存类本身是一个单例。它只有两个参数：缓存生存期，大小。执行请求时，将调用包装器。他被推翻了。检查缓存是通过冻结的arg和夸脱的哈希值进行的。缓存有时间添加。当检查更新数据的必要性时，要么从</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LimitedSizeDict获得</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据，要么</font><font style="vertical-align: inherit;">发出真实请求并将其添加到缓存中。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
有些请求无法缓存，例如，设置“喜欢” /“不喜欢”。如果用户按以下顺序：“喜欢”，“不喜欢”，“喜欢”，则最终不会发送喜欢的图片。在这种情况下，发送请求时，您需要传递</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">use_cache</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数</font><font style="vertical-align: inherit;">，其值等于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">False</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">实际上，这是唯一不使用缓存的地方。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
因此，我提出了最大胆的请求，以便对其进行缓存。</font><font style="vertical-align: inherit;">我不会尝试将其拆分为小部分，仅在当前页面中才需要。</font><font style="vertical-align: inherit;">我一次完成所有操作，在页面之间切换时，切换速度非常快（与旧方法相比）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
对于我来说，缓存的请求类非常漂亮，并且被简单地集成了。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">资源</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> copy
<span class="hljs-keyword">import</span> time<font></font>
<font></font>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Union
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> OrderedDict<font></font>
<font></font>
<span class="hljs-keyword">import</span> requests<font></font>
<font></font>
<span class="hljs-keyword">from</span> yandex_music.utils.request <span class="hljs-keyword">import</span> Request <span class="hljs-keyword">as</span> YandexMusicRequest<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LimitedSizeDict</span>(<span class="hljs-params">OrderedDict</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span>
        self.size_limit = kwargs.pop(<span class="hljs-string">"size_limit"</span>, <span class="hljs-literal">None</span>)<font></font>
        OrderedDict.__init__(self, *args, **kwargs)<font></font>
        self._check_size_limit()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__setitem__</span>(<span class="hljs-params">self, key, value</span>):</span><font></font>
        OrderedDict.__setitem__(self, key, value)<font></font>
        self._check_size_limit()<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_check_size_limit</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">if</span> self.size_limit <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">while</span> len(self) &gt; self.size_limit:<font></font>
                self.popitem(last=<span class="hljs-literal">False</span>)<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CachedItem</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, response: requests.Response</span>):</span><font></font>
        self.timestamp = time.time()<font></font>
        self.response = response<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cache</span>:</span>
    __singleton: <span class="hljs-string">'Cache'</span> = <span class="hljs-literal">None</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, lifetime: Union[str, int], size: Union[str, int]</span>):</span><font></font>
        Cache.__singleton = self<font></font>
<font></font>
        self.lifetime = int(lifetime) * <span class="hljs-number">60</span><font></font>
        self.size = int(size)<font></font>
<font></font>
        self.storage: LimitedSizeDict = LimitedSizeDict(size_limit=int(size))<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        hash_ = Cache.get_hash(*args, **kwargs)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> self.storage[hash_].response<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span>(<span class="hljs-params">self, response: requests.Response, *args, **kwargs</span>):</span><font></font>
        hash_ = Cache.get_hash(*args, **kwargs)<font></font>
        self.storage.update({hash_: CachedItem(response)})<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">need_to_fetch</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span><font></font>
        hash_ = Cache.get_hash(*args, **kwargs)<font></font>
        cached_item = self.storage.get(hash_)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cached_item:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
        <span class="hljs-keyword">if</span> time.time() - cached_item.timestamp &gt; self.lifetime:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><font></font>
<font></font>
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_instance</span>(<span class="hljs-params">cls</span>) -&gt; 'Cache':</span>
        <span class="hljs-keyword">if</span> cls.__singleton <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> cls.__singleton
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">f'<span class="hljs-subst">{cls.__name__}</span> not initialized'</span>)<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">freeze_dict</span>(<span class="hljs-params">d: dict</span>) -&gt; Union[frozenset, tuple, dict]:</span>
        <span class="hljs-keyword">if</span> isinstance(d, dict):
            <span class="hljs-keyword">return</span> frozenset((key, Cache.freeze_dict(value)) <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> d.items())
        <span class="hljs-keyword">elif</span> isinstance(d, list):
            <span class="hljs-keyword">return</span> tuple(Cache.freeze_dict(value) <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> d)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> d<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_hash</span>(<span class="hljs-params">*args, **kwargs</span>):</span>
        <span class="hljs-keyword">return</span> hash((args, Cache.freeze_dict(kwargs)))<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Request</span>(<span class="hljs-params">YandexMusicRequest</span>):</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_request_wrapper</span>(<span class="hljs-params">self, *args, **kwargs</span>):</span>
        use_cache = kwargs.get(<span class="hljs-string">'use_cache'</span>, <span class="hljs-literal">True</span>)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'use_cache'</span> <span class="hljs-keyword">in</span> kwargs:<font></font>
            kwargs.pop(<span class="hljs-string">'use_cache'</span>)<font></font>
<font></font>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> use_cache:<font></font>
            response = super()._request_wrapper(*args, **copy.deepcopy(kwargs))<font></font>
        <span class="hljs-keyword">elif</span> use_cache <span class="hljs-keyword">and</span> Cache.get_instance().need_to_fetch(*args, **kwargs):<font></font>
            response = super()._request_wrapper(*args, **copy.deepcopy(kwargs))<font></font>
            Cache.get_instance().update(response, *args, **kwargs)<font></font>
        <span class="hljs-keyword">else</span>:<font></font>
            response = Cache.get_instance().get(*args, **kwargs)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> response<font></font>
<font></font>
</code></pre><br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6.语音信息跟踪识别</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
刚开始时，没有想到将其添加到机器人中，但是发生了一个有趣的情况。机器人进行聊天（在机器人的说明中指明）。一段时间后，我注意到人们进入其中并发送带有音乐的语音消息。起初，我认为这是一种新的垃圾邮件，有人在这里开玩笑，在开玩笑。但是，当已经有10个人这样的人并且每个人都在做相同的事情时，我的朋友（由</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">struct</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">暗示的那个人）建议用户驱动Yandex.Music在寻找一种可以识别Yandex音乐的官方机器人，他们在那里看到聊天室，并认真地向它发送语音消息！这只是一个聪明而真实的假设。然后我开玩笑地说，是时候进行识别并在聊天中添加一个机器人了。为了好玩……一段时间之后，就完成了！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
现在介绍</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">API</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。最近，Yandex越来越多地使用Web套接字。我遇到了它们在i.module和i.station管理中的使用。音乐识别服务也可以在其上使用。我在机器人中投放了最低限度的解决方案，但未将实现添加到库中。</font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WS</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">位于以下地址：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wss：//voiceservices.yandex.net/uni.ws</font></font></i><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 
我们只需要两条消息-授权和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">识别</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请求</font><font style="vertical-align: inherit;">。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex本身在其官方应用程序中会在一秒钟或三秒钟内发送短文件。作为响应，您可能需要发送更多数据或结果-是否找到。如果找到结果，则将返回轨道ID。</font><i><font style="vertical-align: inherit;">.OGG</font></i><font style="vertical-align: inherit;">文件</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
发送</font><font style="vertical-align: inherit;">与</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ENCODER = SpeechKit移动SDK v3.28.0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我没有检查它如何与其他编码器一起使用，只是在Telegram记录的文件中进行了更改。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
使用Web插座反转时，有时会发生魔术。</font><font style="vertical-align: inherit;">有时我找不到曲目，但是当我通过识别请求更改消息中的语言时，我找到了。</font><font style="vertical-align: inherit;">或首先找到它，然后停止，尽管文件是相同的。</font><font style="vertical-align: inherit;">我认为曲目的语言是由</font><font style="vertical-align: inherit;">客户端上的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SpeechKit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置的</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我没有这样的机会自己做，而是进行暴力搜索。</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我通过电报的语音消息通过膝盖进行语音识别</font></font></b><div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword">import</span> uuid<font></font>
<font></font>
<span class="hljs-keyword">import</span> lomond<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_auth_data</span>():</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"event"</span>: {
            <span class="hljs-string">"header"</span>: {
                <span class="hljs-string">"messageId"</span>: str(uuid.uuid4()),
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"SynchronizeState"</span>,
                <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"System"</span><font></font>
            },<font></font>
            <span class="hljs-string">"payload"</span>: {
                <span class="hljs-string">"accept_invalid_auth"</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">"auth_token"</span>: <span class="hljs-string">"5983ba91-339e-443c-8452-390fe7d9d308"</span>,
                <span class="hljs-string">"uuid"</span>: str(uuid.uuid4()).replace(<span class="hljs-string">'-'</span>, <span class="hljs-string">''</span>),<font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_asr_data</span>():</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"event"</span>: {
            <span class="hljs-string">"header"</span>: {
                <span class="hljs-string">"messageId"</span>: str(uuid.uuid4()),
                <span class="hljs-string">"name"</span>: <span class="hljs-string">"Recognize"</span>,
                <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"ASR"</span>,
                <span class="hljs-string">"streamId"</span>: <span class="hljs-number">1</span><font></font>
            },<font></font>
            <span class="hljs-string">"payload"</span>: {
                <span class="hljs-string">"advancedASROptions"</span>: {
                    <span class="hljs-string">"manual_punctuation"</span>: <span class="hljs-literal">False</span>,
                    <span class="hljs-string">"partial_results"</span>: <span class="hljs-literal">False</span><font></font>
                },<font></font>
                <span class="hljs-string">"disableAntimatNormalizer"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"format"</span>: <span class="hljs-string">"audio/opus"</span>,
                <span class="hljs-string">"music_request2"</span>: {
                    <span class="hljs-string">"headers"</span>: {
                        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"audio/opus"</span><font></font>
                    }<font></font>
                },<font></font>
                <span class="hljs-string">"punctuation"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"tags"</span>: <span class="hljs-string">"PASS_AUDIO;"</span>,
                <span class="hljs-string">"topic"</span>: <span class="hljs-string">"queries"</span><font></font>
            }<font></font>
        }<font></font>
    }<font></font>
<font></font>
<font></font>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Recognition</span>:</span>
    URI = <span class="hljs-string">'wss://voiceservices.yandex.net/uni.ws'</span>
    LANGS = [<span class="hljs-string">''</span>, <span class="hljs-string">'ru-RU'</span>, <span class="hljs-string">'en-US'</span>]<font></font>
    POLL_DELAY = <span class="hljs-number">0.3</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, binary_data, status_msg</span>):</span><font></font>
        self.status_msg = status_msg<font></font>
        self.websocket = lomond.WebSocket(self.URI)<font></font>
        self.chunks = self.get_chunks_and_replace_encoder(binary_data)<font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_track_id</span>(<span class="hljs-params">self</span>):</span>
        <span class="hljs-keyword">for</span> lang <span class="hljs-keyword">in</span> Recognition.LANGS:<font></font>
            asr_data = get_asr_data()<font></font>
            <span class="hljs-keyword">if</span> lang:<font></font>
                asr_data[<span class="hljs-string">'event'</span>][<span class="hljs-string">'payload'</span>].update({<span class="hljs-string">'lang'</span>: lang})<font></font>
                self.status_msg.edit_text(<span class="hljs-string">f'     <span class="hljs-subst">{lang}</span>...'</span>)
            <span class="hljs-keyword">else</span>:<font></font>
                self.status_msg.edit_text(<span class="hljs-string">f'      ...'</span>)<font></font>
<font></font>
            <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> self.websocket.connect(poll=self.POLL_DELAY):
                <span class="hljs-keyword">if</span> msg.name == <span class="hljs-string">'ready'</span>:<font></font>
                    self.websocket.send_json(get_auth_data())<font></font>
                    self.websocket.send_json(asr_data)<font></font>
<font></font>
                    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> self.chunks:<font></font>
                        self.websocket.send_binary(chunk)<font></font>
<font></font>
                <span class="hljs-keyword">if</span> msg.name == <span class="hljs-string">'text'</span>:<font></font>
                    response = msg.json.get(<span class="hljs-string">'directive'</span>)<font></font>
<font></font>
                    <span class="hljs-keyword">if</span> self.is_valid_response(response):<font></font>
                        self.websocket.close()<font></font>
<font></font>
                        <span class="hljs-keyword">return</span> self.parse_track_id(response)
                    <span class="hljs-keyword">elif</span> self.is_fatal_error(response):<font></font>
                        self.websocket.close()<font></font>
<font></font>
                        <span class="hljs-keyword">break</span><font></font>
<font></font>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_valid_response</span>(<span class="hljs-params">self, response</span>):</span>
        <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'header'</span>, {}).get(<span class="hljs-string">'name'</span>) == <span class="hljs-string">'MusicResult'</span> <span class="hljs-keyword">and</span> \<font></font>
                response.get(<span class="hljs-string">'payload'</span>, {}).get(<span class="hljs-string">'result'</span>) == <span class="hljs-string">'success'</span>:<font></font>
            self.status_msg.edit_text(<span class="hljs-string">f' ,  !'</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">is_fatal_error</span>(<span class="hljs-params">response</span>):</span>
        <span class="hljs-keyword">if</span> response.get(<span class="hljs-string">'header'</span>, {}).get(<span class="hljs-string">'name'</span>) == <span class="hljs-string">'MusicResult'</span> <span class="hljs-keyword">and</span> \<font></font>
                response.get(<span class="hljs-string">'payload'</span>, {}).get(<span class="hljs-string">'result'</span>) == <span class="hljs-string">'music'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_track_id</span>(<span class="hljs-params">response</span>):</span>
        <span class="hljs-keyword">return</span> response[<span class="hljs-string">'payload'</span>][<span class="hljs-string">'data'</span>][<span class="hljs-string">'match'</span>][<span class="hljs-string">'id'</span>]<font></font>
<font></font>
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_chunks_and_replace_encoder</span>(<span class="hljs-params">binary_data</span>):</span><font></font>
        chunks = []<font></font>
<font></font>
        <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> binary_data.split(<span class="hljs-string">b'OggS'</span>)[<span class="hljs-number">1</span>:]:
            <span class="hljs-keyword">if</span> <span class="hljs-string">b'OpusTags'</span> <span class="hljs-keyword">in</span> chunk:<font></font>
                pos = chunk.index(<span class="hljs-string">b'OpusTags'</span>) + <span class="hljs-number">12</span><font></font>
                size = len(chunk)<font></font>
                chunk = chunk[:pos] + <span class="hljs-string">b'#\x00\x00\x00\x00ENCODER=SpeechKit Mobile SDK v3.28.0'</span>
                chunk += <span class="hljs-string">b"\x00"</span> * (size - len(chunk))<font></font>
<font></font>
            chunks.append(<span class="hljs-string">b'\x00\x00\x00\x01OggS'</span> + chunk)<font></font>
<font></font>
        <span class="hljs-keyword">return</span> chunks<font></font>
<font></font>
</code></pre><br>
     ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"> </a>.<br>
</div></div><br>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7.小笔记</font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
最初，只有订阅用户才能使用该漫游器，因为该服务可以在有限的国家/地区使用（无订阅），并且具有漫游器的服务器位于欧洲。通过使用代理执行没有订阅的用户的请求即可解决该问题。代理服务器位于莫斯科。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
可以选择页面，但最多可以选择100个页面（不能添加更多按钮，电报限制）。一些常见的页面请求具有更多页面。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Yandex搜索中，页面上的元素数是硬编码的。多少首曲目，多少个播放列表。有时这甚至与前面显示的数据量不符。页面有变化，元素数量是浮动的。因此，它在机器人中也会跳跃，这不是很漂亮。并结合他们的分页器与他自己的-这样的事情。在其他可能每页请求一定数量元素的地方，一切都很完美。在漫游器中执行搜索后的语音消息为</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t.me/MarshalC/416</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
在Telegram中转发音频时，作者迷失了，并分配给进行转发的人。因此，所有曲目均以机器人用户名的签名发送。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
实施图书馆无线电后我遇到的所有语音消息</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-t.me/MarshalC/422</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（关于轨道链，通过发送大量反馈</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">批处理</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">它，</font><i><font style="vertical-align: inherit;">batch_id</font></i><font style="vertical-align: inherit;">）。</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结论</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尽管事实上这是有关Telegram机器人的另一篇文章，您仍然可以在此处阅读，很可能是因为您对剪切中的一个点感兴趣，这很了不起，</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常感谢</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">！</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
不幸的是，我没有完全打开该机器人的源代码（因为在某些地方我需要重构）。</font><font style="vertical-align: inherit;">本文已描述了很多内容，但是某些方面（例如虚拟键盘及其生成方式）不受影响。</font><font style="vertical-align: inherit;">在大多数情况下，本文中没有的内容只是与我的库一起使用，没有什么有趣的。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
我以它们现在的形式展示了围绕一切旋转的课程。我承认有错误，但是所有这些都可以使用很长时间。在某些地方我喜欢我的代码，在某些地方我不喜欢-这是正常的。不要忘记使用WS进行识别是膝上的解决方案。准备阅读评论中的理性批评。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
尽管甚至在我开始编写库时就已经计划好该机器人，但是我拒绝了这个想法，但是显然我回来了（这很无聊）。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Yandex.Music Bot-一个项目，证明使用该</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库与</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目中</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow"><font style="vertical-align: inherit;">的API配合</font></a><font style="vertical-align: inherit;">使用是合适的</font><font style="vertical-align: inherit;">。</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
非常感谢妈妈，Yana，Sana'a和Glory。</font><font style="vertical-align: inherit;">有人对错误进行校对，有人对提示进行提示，没有这些，本文中的某些内容可能就不存在了，有些人只是在发表前对文章进行评估。</font><font style="vertical-align: inherit;">亚瑟（Arthur）为picci撰写文章，莱德（Lyod）为徽标。</font><font style="vertical-align: inherit;">附</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">言：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，学习后我对分配感到非常尖锐。</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您准备打电话给我-请告诉我应聘简历的发送地址，请面试。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我所有的联系人都在个人资料中。</font><font style="vertical-align: inherit;">时间在燃烧，我希望对你有帮助。</font><font style="vertical-align: inherit;">根据法律规定，我只能在白俄罗斯共和国工作。</font></font><br>
<br>
<b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PPS</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是三篇文章的第二篇，但是毫无丝毫想法，我将有时间针对这个主题以及是否需要做另一个项目。</font><font style="vertical-align: inherit;">我将公开展示他的主题-跨平台客户Yandex.Music。</font></font></div>
      
    </div><p class="reference-to-source js-reference-to-source">Source: https://habr.com/ru/post/undefined/</p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN487418/index.html">什么是SAP？</a></li>
<li><a href="../zh-CN487420/index.html">Sound WarZ。测试MusicDealer扬声器和耳机</a></li>
<li><a href="../zh-CN487422/index.html">Salesforce管理员职责：应该做什么以及何时完成</a></li>
<li><a href="../zh-CN487424/index.html">如何将用户数从1增加到100,000</a></li>
<li><a href="../zh-CN487426/index.html">灵活性决定成功。</a></li>
<li><a href="../zh-CN487430/index.html">创建iOS应用程序需要哪些技能？Yandex报告</a></li>
<li><a href="../zh-CN487432/index.html">遵循DevConf和CfgMgmtCamp的脚步，或者您可以在两周内参加两次国际会议上的演讲者以学到什么</a></li>
<li><a href="../zh-CN487438/index.html">如何从头开始创建IT公司-没有该领域的经验和编程技能？</a></li>
<li><a href="../zh-CN487444/index.html">“边喝咖啡边开帐单并收到付款通知书”-创新使您可以24/7开展业务</a></li>
<li><a href="../zh-CN487446/index.html">公司可以“拥有”颜色吗？</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>