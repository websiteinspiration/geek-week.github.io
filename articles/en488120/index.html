<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-13"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-13');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïó üö≥ üå∂Ô∏è Why is it worth installing a 64-bit OS on the Raspberry Pi4 ü§òüèΩ ‚óºÔ∏è üö¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the benefits of working for a software company is that you often have the opportunity to test new hardware prototypes. However, not in this cas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://geek-week.github.io/index.html"></a>
    <div class="page-header-text">Get best of the week</div>
  </header>
  <section class="page js-page"><h1>Why is it worth installing a 64-bit OS on the Raspberry Pi4</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/488120/"><img src="https://habrastorage.org/getpro/habr/post_images/0cc/a7b/84a/0cca7b84aa3da5d217f72f7d3dc84d1b.jpg" alt="image"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
One of the benefits of working for a software company is that you often have the opportunity to test new hardware prototypes. However, not in this case - I bought a Raspberry Pi4 because it is very cheap! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The Raspberry Pi4 has a quad-core ARM Cortex A72, up to 4 GB of memory and a gigabit Ethernet port - all for only $ 35. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
On Raspberry Pi4 have OS </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Raspbian</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (based on Debian), and finished products library, so I put it in the SD-card to boot faster. I searched syslog and noticed that both the kernel and all user programs were compiled as armv7 - that is, for 32-bit memory.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I know that Raspberry Pi4 supports 64 bits, so I did not want to run a 32-bit OS on it. </font><font style="vertical-align: inherit;">I took another memory card and put Debian on it. </font><font style="vertical-align: inherit;">Debian, containing nothing superfluous, compiled as </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aarch64</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - which means 64-bit memory.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Having downloaded the 64-bit OS, I became interested in how much better it works in 32-bit, so I conducted several tests.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Synthetic speed tests</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The first thing that occurred to me was the old dhrystone test, which has existed since the beginning of time. This program was written in 1988, and it deals with mathematical calculations. It is unlikely to be able to simulate the current load, and we can use it only in order to maintain some kind of connectivity with old hardware and programs. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/698/5f6/083/6985f6083a6d12ec86b7ad6a71c0ee5d.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A modern digest application is better simulated by computing hashes, so I wanted to run a test with SHA1. Unfortunately, the sha1sum utility was compiled without support for libssl or cryptographic kernel functions, so I had to compile it from the source. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To avoid bottlenecks in I / O, I calculate a hash of a 2 GB file with the truncate -s 2GB option, so there was no input or output from the card:</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b20/b3f/738/b20b3f73835d8f9b1e14c92286b7b049.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
SHA1 is a more realistic test than dhrystone, because this algorithm is used in a large number of applications - torrents, git, etc.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RAM</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A 64-bit system provides access to memory of 8 bytes per read / write. </font><font style="vertical-align: inherit;">I wrote a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simple program</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> that places a large buffer - she writes it, and then reads it. </font><font style="vertical-align: inherit;">To guarantee </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">real memory allocation,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I used mlock (). </font><font style="vertical-align: inherit;">In this test, the buffer volume is 2 GB: the 3 GB buffer worked in 64-bit mode, and in the 32-bit mode it generated an ‚Äúout of memory‚Äù error.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/08a/53c/2cd/08a53c2cdc361820aa817cfdd2d6ed02.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Audio encoding</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I noticed that many users of Raspberry Pi4 use a computer as a media center, so I started the task of encoding audio with the two most popular codecs. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I encoded Pink Floyd's ‚ÄúEchoes‚Äù composition because it is a rather long track and you can get measured values ‚Äã‚Äãfrom it. </font><font style="vertical-align: inherit;">To avoid I / O delays, the source and destination file were stored on ramfs:</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/131/58a/8cb/13158a8cb3b7849d02ab52c6881bffd9.png"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b25/7a2/623/b257a26231bf005fddd15715187e516e.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Network speed measurements</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another option for using Raspberry Pi4 is as a VPN or firewall. I do not recommend using such systems for such purposes, but many people still have a slow Internet connection (less than 100 MB), so they may not pay attention to the slow operation of the Raspberry Pi4. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
First question: how much traffic can the Raspberry Pi4 handle? We need to measure the net network power of the computer, without the limitations of physical interfaces, so I started the iperf3 session between the two containers. However, containers exchange data through a pair of veths, and veth speeds up traffic through false offloads.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Unloading the calculation of the IP checksum is done simply by refusing to count it, and offloading the TCP segmentation by refusing from segmenting and reassembling traffic: a large piece of 64K data is simply transferred to memory as is. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To avoid such moments, I forbade unloading with the </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
ethtool </font><font style="vertical-align: inherit;">command </font><font style="vertical-align: inherit;">-K veth0 tx off rx off tso off gro off gso off</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/a26/549/b2c/a26549b2c6ac9a2737f791f317dcf733.png"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firewall</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
The fastest network equipment is capable of - to drop part of the traffic, and the fastest way to do this is through the TC rule. </font><font style="vertical-align: inherit;">In order not to reach the maximum possible speed, I used the minimum Ethernet frame size, 64b. </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/f81/e12/4af/f81e124af378a94ce8c620e3f285d7ac.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Although both systems did not reach the maximum transfer speed (1.5 Mb / s), the 64-bit core showed a slightly higher speed than the 32-bit one. </font><font style="vertical-align: inherit;">If you want to use Raspberry Pi4 as a firewall, be sure to use the 64-bit kernel.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VPN</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Another common use case for Raspberry Pi4 is a VPN server, or rather, OpenVPN. </font><font style="vertical-align: inherit;">I prefer WireGuard, so I checked both programs because they are both easy to install: </font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/467/c2f/a26/467c2fa2634f3568d4574654eb0faaa0.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As expected, OpenVPN is 10 times slower than WireGuard. </font><font style="vertical-align: inherit;">What was not expected was that OpenVPN works at the same speed at 32 and 64 bps. </font><font style="vertical-align: inherit;">WireGuard almost saturates the gigabit port in both cases - perhaps we have reached the NIC limit. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
To find out if WireGuard could work even faster, I ran another test with two containers that didn't use physical Ethernet. </font><font style="vertical-align: inherit;">The only problem was that both the client and the iperf3 server were running on the Raspberry Pi4, loading two cores.</font></font><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/aff/4ec/d3f/aff4ecd3f9ded87dd079827c3d7dfc8b.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As expected, OpenVPN and 32-bit WireGuard, limited by the CPU, performed worse, and 64-bit WireGuard did better.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusions</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I often read statements like ‚Äúit's not worth it‚Äù, ‚Äúyou will win a few milliseconds‚Äù, etc., simply because the Raspberry Pi4 is not a very powerful computer. </font><font style="vertical-align: inherit;">This is not true! </font><font style="vertical-align: inherit;">As any person involved in embedded equipment knows, on slow hardware software optimization is even more important than on fast hardware. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
I already knew that a 64-bit OS would work better on the Raspberry Pi4, but I did not know how much better. </font><font style="vertical-align: inherit;">So I did all these tests. </font><font style="vertical-align: inherit;">I hope you enjoyed it!</font></font></div>
      
    </div>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../en488104/index.html">DBA: Find Useless Indexes</a></li>
<li><a href="../en488108/index.html">SAP HANA Lab in Azure</a></li>
<li><a href="../en488112/index.html">Understanding Iterators in Python</a></li>
<li><a href="../en488116/index.html">Five important lessons about game balance</a></li>
<li><a href="../en488118/index.html">Haxe Winter Status Report</a></li>
<li><a href="../en488122/index.html">$ 1.5 compact airgel, aluminum and paper towel distiller</a></li>
<li><a href="../en488128/index.html">Preferential packages: what is added to the salaries of IT specialists in Armenia?</a></li>
<li><a href="../en488130/index.html">Learn English using Telegram bot</a></li>
<li><a href="../en488134/index.html">Raising CI on github for Android in a day</a></li>
<li><a href="../en488136/index.html">How did the Atlas robot learn to do acrobatic stunts, unbearable for an ordinary person?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter63335242 = new Ya.Metrika({
                  id:63335242,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/63335242" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-13', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Geek Week | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2020</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=i62cJ2037o_BACd40gCrIso3niu0Sjx2sDFYJkeYdRk&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>